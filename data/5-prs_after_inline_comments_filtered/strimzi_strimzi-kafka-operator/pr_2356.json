{"pr_number": 2356, "pr_title": "ST: Improve Connect tests with Connector resource and check values set by\u2026", "pr_createdAt": "2020-01-03T09:32:36Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363114030", "bodyText": "I'm not sure I understand the logic why this is here. It doesn't seem to belong to this cluster and the actual Connect cluster is anyway not ready. I think the test with invalid lbel should be done when the Connect is ready.", "author": "scholzj", "createdAt": "2020-01-05T20:04:59Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -170,40 +173,64 @@ void testKafkaBridgeStatus() {\n     @Test\n     void testKafkaConnectStatus() {\n         String connectUrl = \"http://my-cluster-connect-api.status-cluster-test.svc:8083\";\n-        KafkaConnectResource.kafkaConnect(CLUSTER_NAME, 1).done();\n+        KafkaConnectResource.kafkaConnect(CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata().done();\n         waitForKafkaConnectStatus(\"Ready\");\n+        KafkaConnectorResource.kafkaConnector(CLUSTER_NAME, TOPIC_NAME).done();\n+        waitForKafkaConnectorStatus(CLUSTER_NAME, \"Ready\");\n         assertKafkaConnectStatus(1, connectUrl);\n \n         KafkaConnectResource.replaceKafkaConnectResource(CLUSTER_NAME, kb -> kb.getSpec().setResources(new ResourceRequirementsBuilder()\n                 .addToRequests(\"cpu\", new Quantity(\"100000000m\"))\n                 .build()));\n         waitForKafkaConnectStatus(\"NotReady\");\n \n+        KafkaConnectorResource.replaceKafkaConnectorResource(CLUSTER_NAME,", "originalCommit": "96d7bd000245c97daa847f9d9fbc540ffccac34b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE3NDI1OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363174259", "bodyText": "Connector itself doesn't reflect status of Kafka Connect so I think it doesn't matter where this code is. I can move to test phase, where connect is ready with same results I think. Or I can create completely new test case, but I wanted to save some time during execution.", "author": "Frawless", "createdAt": "2020-01-06T06:40:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE5NDA1MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363194050", "bodyText": "Why does it not reflect it? I do not think there is any guarantee that the connector can be Ready if the Connect is not Ready.\nI understand why saving the time might be nice. But you should do this test when the Connect is Ready. That does not have to be different test case, or? You can just move it few lines up or down.", "author": "scholzj", "createdAt": "2020-01-06T08:17:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNTA1MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363205050", "bodyText": "It's better question for @tombentley. After our last discussion I understood that Connector doesn't reflect connect status atm. Sure, I will change it.", "author": "Frawless", "createdAt": "2020-01-06T08:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNTUwMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363205501", "bodyText": "It doesn't have to reflect Connect status. But there is a clear relationship. The Connector runs inside Connectc, so when Connect is not ready, where would you expect it to run?", "author": "scholzj", "createdAt": "2020-01-06T08:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwODc4OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363208788", "bodyText": "If the connector status is ready then it's very likely that the connect status is ready. If the connector status is not ready then you cannot infer anything about the connect status.", "author": "tombentley", "createdAt": "2020-01-06T09:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIxNDk4NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363214984", "bodyText": "It is more the other direction: Does it make sense to test how new connector deployes when Connect is not ready?", "author": "scholzj", "createdAt": "2020-01-06T09:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzOTAxMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363239012", "bodyText": "Moved to phase when Kafka Connect is ready", "author": "Frawless", "createdAt": "2020-01-06T10:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDA3NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363114075", "bodyText": "Same as above.", "author": "scholzj", "createdAt": "2020-01-05T20:05:47Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -170,40 +173,64 @@ void testKafkaBridgeStatus() {\n     @Test\n     void testKafkaConnectStatus() {\n         String connectUrl = \"http://my-cluster-connect-api.status-cluster-test.svc:8083\";\n-        KafkaConnectResource.kafkaConnect(CLUSTER_NAME, 1).done();\n+        KafkaConnectResource.kafkaConnect(CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata().done();\n         waitForKafkaConnectStatus(\"Ready\");\n+        KafkaConnectorResource.kafkaConnector(CLUSTER_NAME, TOPIC_NAME).done();\n+        waitForKafkaConnectorStatus(CLUSTER_NAME, \"Ready\");\n         assertKafkaConnectStatus(1, connectUrl);\n \n         KafkaConnectResource.replaceKafkaConnectResource(CLUSTER_NAME, kb -> kb.getSpec().setResources(new ResourceRequirementsBuilder()\n                 .addToRequests(\"cpu\", new Quantity(\"100000000m\"))\n                 .build()));\n         waitForKafkaConnectStatus(\"NotReady\");\n \n+        KafkaConnectorResource.replaceKafkaConnectorResource(CLUSTER_NAME,\n+            kc -> kc.getMetadata().setLabels(Collections.singletonMap(\"strimzi.io/cluster\", \"non-existing-connect-cluster\")));\n+        waitForKafkaConnectorStatus(CLUSTER_NAME, \"NotReady\");\n+\n         KafkaConnectResource.replaceKafkaConnectResource(CLUSTER_NAME, kb -> kb.getSpec().setResources(new ResourceRequirementsBuilder()\n                 .addToRequests(\"cpu\", new Quantity(\"10m\"))\n                 .build()));\n         waitForKafkaConnectStatus(\"Ready\");\n         assertKafkaConnectStatus(3, connectUrl);\n+        KafkaConnectorResource.replaceKafkaConnectorResource(CLUSTER_NAME,\n+            kc -> kc.getMetadata().setLabels(Collections.singletonMap(\"strimzi.io/cluster\", CLUSTER_NAME)));\n+        waitForKafkaConnectorStatus(CLUSTER_NAME, \"Ready\");\n     }\n \n     @Test\n     void testKafkaConnectS2IStatus() {\n         String connectS2IUrl = \"http://my-cluster-s2i-connect-api.status-cluster-test.svc:8083\";\n         String connectS2IDeploymentConfigName = CONNECTS2I_CLUSTER_NAME + \"-connect\";\n-        KafkaConnectS2IResource.kafkaConnectS2I(CONNECTS2I_CLUSTER_NAME, CLUSTER_NAME, 1).done();\n+        KafkaConnectS2IResource.kafkaConnectS2I(CONNECTS2I_CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata().done();\n         waitForKafkaConnectS2IStatus(\"Ready\");\n         assertKafkaConnectS2IStatus(1, connectS2IUrl, connectS2IDeploymentConfigName);\n+        KafkaConnectorResource.kafkaConnector(CONNECTS2I_CLUSTER_NAME, TOPIC_NAME).done();\n+        waitForKafkaConnectorStatus(CONNECTS2I_CLUSTER_NAME, \"Ready\");\n \n         KafkaConnectS2IResource.replaceConnectS2IResource(CONNECTS2I_CLUSTER_NAME, kb -> kb.getSpec().setResources(new ResourceRequirementsBuilder()\n                 .addToRequests(\"cpu\", new Quantity(\"100000000m\"))\n                 .build()));\n         waitForKafkaConnectS2IStatus(\"NotReady\");\n \n+        KafkaConnectorResource.replaceKafkaConnectorResource(CONNECTS2I_CLUSTER_NAME,", "originalCommit": "96d7bd000245c97daa847f9d9fbc540ffccac34b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzOTAwMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363239002", "bodyText": "Moved to phase when Kafka Connect is ready", "author": "Frawless", "createdAt": "2020-01-06T10:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDA3NQ=="}], "type": "inlineReview"}, {"oid": "de79ce9e320a2df2d2934d8d1cfdc4bef49a3522", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/de79ce9e320a2df2d2934d8d1cfdc4bef49a3522", "message": "Improve Connect tests with Connector resource and check values set by connector operator via connect api\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-09T10:31:53Z", "type": "commit"}, {"oid": "4f61785f697ec8a93cc93587a2ffa35d6b962a7f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4f61785f697ec8a93cc93587a2ffa35d6b962a7f", "message": "Work in some review comments - move connector status check to phase when connects are rdy\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-09T10:31:53Z", "type": "commit"}, {"oid": "8f0e945cd351fcbd4c06ccf5eb9785ad2d7ac377", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8f0e945cd351fcbd4c06ccf5eb9785ad2d7ac377", "message": "fixup! Work in some review comments - move connector status check to phase when connects are rdy\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-09T10:31:53Z", "type": "commit"}, {"oid": "6137fcd0fb44989234cf9342a6739f3484b84dd5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6137fcd0fb44989234cf9342a6739f3484b84dd5", "message": "Improve connector status checks\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-09T10:31:53Z", "type": "commit"}, {"oid": "9c54d649cf13fbddf949e9922745e423fbb9cfc9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9c54d649cf13fbddf949e9922745e423fbb9cfc9", "message": "Improve connector status checks v2\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-09T10:31:53Z", "type": "commit"}, {"oid": "3b1debe14518aa187544fc75b115d61afa70d1b9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3b1debe14518aa187544fc75b115d61afa70d1b9", "message": "FIx connector state in tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-09T10:31:53Z", "type": "commit"}, {"oid": "9af24f8b096c7857576cd090308ace5b3ed584db", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9af24f8b096c7857576cd090308ace5b3ed584db", "message": "Minor fixes for tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-09T10:31:53Z", "type": "commit"}, {"oid": "8bb6152ac2bf824f850276fd796b3a9e82656794", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8bb6152ac2bf824f850276fd796b3a9e82656794", "message": "fix tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-13T14:55:09Z", "type": "commit"}, {"oid": "8bb6152ac2bf824f850276fd796b3a9e82656794", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8bb6152ac2bf824f850276fd796b3a9e82656794", "message": "fix tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-13T14:55:09Z", "type": "forcePushed"}]}