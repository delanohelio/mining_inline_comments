{"pr_number": 888, "pr_title": "fix(engine): ignore failure of db operation when op for owning entity has failed", "pr_createdAt": "2020-07-07T12:51:00Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/888", "timeline": [{"oid": "343f3968db7e69684045751393d65759c60ddfec", "url": "https://github.com/camunda/camunda-bpm-platform/commit/343f3968db7e69684045751393d65759c60ddfec", "message": "chore(engine): resolve foreign key constraint violation as OLE", "committedDate": "2020-07-07T12:46:48Z", "type": "commit"}, {"oid": "d3f3ef96c15d3b4a1589fc08083efa5c976567b2", "url": "https://github.com/camunda/camunda-bpm-platform/commit/d3f3ef96c15d3b4a1589fc08083efa5c976567b2", "message": "fix", "committedDate": "2020-07-07T13:05:35Z", "type": "commit"}, {"oid": "d72263b48bd82dc73e1a427709eaa5cd7c71b969", "url": "https://github.com/camunda/camunda-bpm-platform/commit/d72263b48bd82dc73e1a427709eaa5cd7c71b969", "message": "test", "committedDate": "2020-07-08T11:34:31Z", "type": "commit"}, {"oid": "944b639dcc0b49291c0e91b17cdf26f479a96330", "url": "https://github.com/camunda/camunda-bpm-platform/commit/944b639dcc0b49291c0e91b17cdf26f479a96330", "message": "adj", "committedDate": "2020-07-08T12:46:54Z", "type": "commit"}, {"oid": "e8444e7f5347caf587a7af5c86a4f1d8504da716", "url": "https://github.com/camunda/camunda-bpm-platform/commit/e8444e7f5347caf587a7af5c86a4f1d8504da716", "message": "adjust test", "committedDate": "2020-07-09T12:18:30Z", "type": "commit"}, {"oid": "52363a916694cebc02f51a5aa490bc6813abc246", "url": "https://github.com/camunda/camunda-bpm-platform/commit/52363a916694cebc02f51a5aa490bc6813abc246", "message": "transaction listener", "committedDate": "2020-07-09T13:45:15Z", "type": "commit"}, {"oid": "1d9eec4db6637b39a26251d324972a5a4ec10a02", "url": "https://github.com/camunda/camunda-bpm-platform/commit/1d9eec4db6637b39a26251d324972a5a4ec10a02", "message": "comment", "committedDate": "2020-07-09T14:35:20Z", "type": "commit"}, {"oid": "a2803dcf435efafabead5dfe6b780e65a9f6a48e", "url": "https://github.com/camunda/camunda-bpm-platform/commit/a2803dcf435efafabead5dfe6b780e65a9f6a48e", "message": "fix test", "committedDate": "2020-07-09T15:43:36Z", "type": "commit"}, {"oid": "b143b413b289e51e639a461cccc6b6361f781273", "url": "https://github.com/camunda/camunda-bpm-platform/commit/b143b413b289e51e639a461cccc6b6361f781273", "message": "try out fix with dependency between operations\n\n- ignore failure of a db operation if an operation for an owning entity\n  has failed", "committedDate": "2020-07-10T16:17:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MTExMQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r453481111", "bodyText": "I will not add them so far. We can add them later if we need it.", "author": "yanavasileva", "createdAt": "2020-07-13T08:30:44Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/entitymanager/operation/DbOperationManager.java", "diffHunk": "@@ -133,9 +135,38 @@ public boolean addOperationPreserveOrder(DbBulkOperation newOperation) {\n     addSortedInserts(flush);\n     // then UPDATEs + DELETEs\n     addSortedModifications(flush);\n+    \n+    resolveDependencies(flush);\n     return flush;\n   }\n \n+  // TODO: resolve is probably not the correct verb\n+  private void resolveDependencies(List<DbOperation> flush) {\n+    for (DbOperation operation : flush) {\n+      if (operation instanceof DbEntityOperation) {\n+        DbEntity entity = ((DbEntityOperation) operation).getEntity();\n+        if (entity instanceof HasDbReferences) {\n+          Map<String, Class> dependentEntities = ((HasDbReferences) entity).getDependentEntities();\n+          \n+          \n+          if (dependentEntities != null) {\n+            dependentEntities.forEach((id, type) -> {\n+              // TODO: also updates and inserts?", "originalCommit": "b143b413b289e51e639a461cccc6b6361f781273", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f927caba5404a25a9221332fe77187737752c76e", "url": "https://github.com/camunda/camunda-bpm-platform/commit/f927caba5404a25a9221332fe77187737752c76e", "message": "chrore(engine): cleanup code", "committedDate": "2020-07-13T09:54:32Z", "type": "commit"}, {"oid": "38525a96e4eaa3cf3615a147c91116c025efa102", "url": "https://github.com/camunda/camunda-bpm-platform/commit/38525a96e4eaa3cf3615a147c91116c025efa102", "message": "chore(test): adjust test", "committedDate": "2020-07-13T12:05:39Z", "type": "commit"}, {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0", "url": "https://github.com/camunda/camunda-bpm-platform/commit/5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0", "message": "chore(engine): adjust failed operations list\n\n* skip test on prefix scenario\n* add operation to failed operation list only if it's marked as failed", "committedDate": "2020-07-13T14:52:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MTM3Ng==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454191376", "bodyText": "Is it possible to pass some contextual info here? E.g. \"parent operation failed\".", "author": "koevskinikola", "createdAt": "2020-07-14T08:28:44Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/EnginePersistenceLogger.java", "diffHunk": "@@ -792,4 +792,9 @@ public void installationIdPropertyFound(String value) {\n         \"100\", \"Installation id property found in the database: {}\", value);\n   }\n \n+  public void ignoreFailureDuePreconditionNotMet() {\n+    logDebug(\n+        \"101\", \"Ignoring operation failure due to unmet precondition\");", "originalCommit": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIwNTE0OA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454205148", "bodyText": "Also which operation this message concerns.", "author": "ThorbenLindhauer", "createdAt": "2020-07-14T08:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MTM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzNzMzMA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454237330", "bodyText": "How does it sound:\nIgnoring database operation failure due to an unmet precondition. Parent database operation failed: 'UPDATE EverLivingJobEntity[1]'", "author": "yanavasileva", "createdAt": "2020-07-14T09:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MTM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzOTM2OA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454239368", "bodyText": "Sounds good. If possible, include_ \"DELETE ByteArray[X]\" as well so the message is self-contained.", "author": "ThorbenLindhauer", "createdAt": "2020-07-14T09:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MTM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIwNzk2OQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454207969", "bodyText": "*determine", "author": "ThorbenLindhauer", "createdAt": "2020-07-14T08:57:14Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/entitymanager/operation/DbOperationManager.java", "diffHunk": "@@ -243,4 +246,28 @@ protected void addSortedModificationsForType(Class<?> type, SortedSet<DbEntityOp\n \n     return opList;\n   }\n+\n+  protected void determinateDependencies(List<DbOperation> flush) {", "originalCommit": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxMDMyNQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454210325", "bodyText": "Let's try to get the wording right to avoid future confusion. I propose we call the parent operation (here: job update) the \"dependency\" and the child operation (here: byte array delete) the \"dependent\" (based on https://english.stackexchange.com/questions/25575/what-is-the-correct-word-for-dependee).", "author": "ThorbenLindhauer", "createdAt": "2020-07-14T09:01:16Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/sql/DbSqlSession.java", "diffHunk": "@@ -184,12 +184,19 @@ protected void bulkOperationPerformed(DbBulkOperation operation, int rowsAffecte\n   }\n \n   protected void entityDeletePerformed(DbEntityOperation operation, int rowsAffected, Exception failure) {\n+    \n     if (failure != null) {\n       operation.setRowsAffected(0);\n       operation.setFailure(failure);\n \n+      DbOperation dependentOperation = operation.getDependentOperation();", "originalCommit": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c00ba2ecb563ca650576d90cf1b90b5fa3516acd", "url": "https://github.com/camunda/camunda-bpm-platform/commit/c00ba2ecb563ca650576d90cf1b90b5fa3516acd", "message": "improve(engine): improve varables naming and log message", "committedDate": "2020-07-14T10:11:58Z", "type": "commit"}]}