{"pr_number": 2695, "pr_title": "Register System.exit for systemDownHandler for LR CorfuRuntime ", "pr_createdAt": "2020-08-10T21:57:17Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2695", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIxMTI0Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#discussion_r468211247", "bodyText": "Can we have a test that verifies that LR is correctly restarted and able to resume?", "author": "annym", "createdAt": "2020-08-10T22:02:47Z", "path": "utils/src/main/java/org/corfudb/utils/lock/states/NoLeaseState.java", "diffHunk": "@@ -90,7 +91,13 @@ private void acquireLease() {\n             if (lockStore.acquire(lock.getLockId())) {\n                 lock.input(LockEvent.LEASE_ACQUIRED);\n             }\n-        } catch (Exception e) {\n+        }\n+        catch (WrongClusterException wce) {", "originalCommit": "3dae7620535e91eda2fc58e54ea724f241add1c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyNzE1NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#discussion_r468227155", "bodyText": "we should log something here also", "author": "pankti-m", "createdAt": "2020-08-10T22:46:45Z", "path": "utils/src/main/java/org/corfudb/utils/lock/LockClient.java", "diffHunk": "@@ -160,7 +161,12 @@ private void monitorLocks() {\n                             log.debug(\"LockClient: lease revoked for lock {}\", lockId.getLockName());\n                             locks.get(lockId).input(LockEvent.LEASE_REVOKED);\n                         }\n-                    } catch (Exception ex) {\n+                    }\n+                    catch (WrongClusterException wce) {\n+                        log.error(\"Lock client {} is connected to a wrong cluster:\", clientId, wce);\n+                        throw wce;\n+                    }\n+                    catch (Exception ex) {", "originalCommit": "3dae7620535e91eda2fc58e54ea724f241add1c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMjc0MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#discussion_r468232741", "bodyText": "Actually, if we re-throw an exception we must not log it.\nIn the other case, we will log the same thrown exceptions on all levels of the application, which dramatically increases log size and make it difficult to read and understand the application logic.\nWould be great if Pavel removes those logs in catch block because they will be handled on a higher level of the stack", "author": "xnull", "createdAt": "2020-08-10T23:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyNzE1NQ=="}], "type": "inlineReview"}, {"oid": "281541d3c2049fb2910ace15c71973015b9cda71", "url": "https://github.com/CorfuDB/CorfuDB/commit/281541d3c2049fb2910ace15c71973015b9cda71", "message": "Invoke systemDownHandler in LR in case of WCE", "committedDate": "2020-08-18T22:50:40Z", "type": "commit"}, {"oid": "281541d3c2049fb2910ace15c71973015b9cda71", "url": "https://github.com/CorfuDB/CorfuDB/commit/281541d3c2049fb2910ace15c71973015b9cda71", "message": "Invoke systemDownHandler in LR in case of WCE", "committedDate": "2020-08-18T22:50:40Z", "type": "forcePushed"}, {"oid": "ea2e6d60ba086d3ca5816826fe934ef65ff61cd0", "url": "https://github.com/CorfuDB/CorfuDB/commit/ea2e6d60ba086d3ca5816826fe934ef65ff61cd0", "message": "Merge branch 'master' into wce-lock", "committedDate": "2020-08-19T02:57:33Z", "type": "commit"}, {"oid": "73230e9a2aba7fad452f6090b32a6aa9b7040dfb", "url": "https://github.com/CorfuDB/CorfuDB/commit/73230e9a2aba7fad452f6090b32a6aa9b7040dfb", "message": "Merge branch 'master' into wce-lock", "committedDate": "2020-08-19T04:06:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NzE0OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#discussion_r472667148", "bodyText": "Codacy found an issue: System.exit() should not be used in J2EE/JEE apps", "author": "corfudb-bot", "createdAt": "2020-08-19T04:12:01Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -312,6 +316,7 @@ private CorfuRuntime getCorfuRuntime() {\n                     .keyStore((String) serverContext.getServerConfig().get(\"--keystore\"))\n                     .ksPasswordFile((String) serverContext.getServerConfig().get(\"--keystore-password-file\"))\n                     .tlsEnabled((Boolean) serverContext.getServerConfig().get(\"--enable-tls\"))\n+                    .systemDownHandler(() -> System.exit(SYSTEM_EXIT_ERROR_CODE))", "originalCommit": "73230e9a2aba7fad452f6090b32a6aa9b7040dfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}