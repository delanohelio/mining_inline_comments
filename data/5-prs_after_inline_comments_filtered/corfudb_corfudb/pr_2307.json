{"pr_number": 2307, "pr_title": "Change checkpoint initialization logic", "pr_createdAt": "2020-01-14T00:19:26Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2307", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2Mjk3OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2307#discussion_r367762979", "bodyText": "Could they be final? Looks we don't change their references.", "author": "zhangn49", "createdAt": "2020-01-17T04:19:11Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/stream/AbstractQueuedStreamView.java", "diffHunk": "@@ -911,6 +913,8 @@ synchronized void seek(long globalAddress) {\n      */\n     @Data\n     static class StreamCheckpoint {\n+        public static StreamCheckpoint UNINITIALIZED = new StreamCheckpoint();\n+        public static StreamCheckpoint INITIALIZED = new StreamCheckpoint();", "originalCommit": "334162d1ea179324f15b3622ffdfb1e905cf2810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMxMjAzMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2307#discussion_r370312030", "bodyText": "Yep.", "author": "vjeko", "createdAt": "2020-01-23T19:29:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2Mjk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2MzgxNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2307#discussion_r367763814", "bodyText": "I see testCheckpointTrim and testSuccessiveCheckpointTrim use these four lines to trim.\nCan we replace them with trim()?", "author": "zhangn49", "createdAt": "2020-01-17T04:23:48Z", "path": "test/src/test/java/org/corfudb/runtime/checkpoint/CheckpointTrimTest.java", "diffHunk": "@@ -174,6 +182,68 @@ public void testSuccessiveCheckpointTrim() throws Exception {\n                 .isEqualTo(\"a\" + (nCheckpoints - 1));\n     }\n \n+    /**\n+     * Verify that the streaming interface can be consumed directly and that\n+     * {@link TrimmedException} is being thrown when linearizable history is lost.\n+     */\n+    @Test\n+    public void rawStreamConsumer() {\n+        final int BATCH_SIZE = 10;\n+        final int CHECKPOINT_SIZE = 3;\n+        final String CHECKPOINT_AUTHOR = \"Author\";\n+        final String tableName = \"test\";\n+        final CorfuTable<Integer, Integer> map = getDefaultRuntime().getObjectsView().build()\n+                .setTypeToken(new TypeToken<CorfuTable<Integer, Integer>>() {})\n+                .setStreamName(tableName)\n+                .open();\n+\n+        final MultiCheckpointWriter<CorfuTable> mcw = new MultiCheckpointWriter();\n+        mcw.addMap(map);\n+\n+        IntStream.range(0, BATCH_SIZE).forEach(idx -> map.put(idx, idx));\n+\n+        // Insert a checkpoint\n+        Token checkpointAddress = mcw.appendCheckpoints(getRuntime(), CHECKPOINT_AUTHOR);\n+\n+        IntStream.range(0, BATCH_SIZE).forEach(idx -> map.put(idx, idx));\n+\n+        // Trim the log in between the checkpoints\n+        trim(checkpointAddress);\n+\n+        CorfuRuntime newRuntime = getNewRuntime(getDefaultNode()).connect();\n+        Map<Integer, Integer> newMap = newRuntime.getObjectsView().build()\n+                .setTypeToken(new TypeToken<SMRMap<Integer, Integer>>() {\n+                })\n+                .setStreamName(tableName)\n+                .open();\n+\n+        IStreamView s = newRuntime.getStreamsView().get(CorfuRuntime.getStreamID(tableName));\n+        s.seek(BATCH_SIZE + CHECKPOINT_SIZE);\n+        // Seek beyond the last trimmed address.\n+        // The first call to remainingUpTo() will load the checkpoint, and the\n+        // second one will fetch the actual data.\n+        Assertions.assertThat(Stream.of(s.remainingUpTo(Long.MAX_VALUE), s.remainingUpTo(Long.MAX_VALUE))\n+                .map(List::size).mapToInt(Integer::intValue).sum())\n+                .isEqualTo(BATCH_SIZE);\n+\n+        trim(mcw.appendCheckpoints(getRuntime(), CHECKPOINT_AUTHOR));\n+        IntStream.range(0, BATCH_SIZE).forEach(idx -> newMap.put(idx, idx));\n+        Assertions.assertThatThrownBy(() -> s.remainingUpTo(Long.MAX_VALUE))\n+                .isInstanceOf(TrimmedException.class);\n+    }\n+\n+    /**\n+     * Given the token, trim the address-space at {@link Token#getSequence()}.\n+     *\n+     * @param token point at which to trim the address space.\n+     */\n+    private void trim(Token token) {\n+        getRuntime().getAddressSpaceView().prefixTrim(token);\n+        getRuntime().getAddressSpaceView().gc();\n+        getRuntime().getAddressSpaceView().invalidateServerCaches();\n+        getRuntime().getAddressSpaceView().invalidateClientCache();\n+    }\n+", "originalCommit": "334162d1ea179324f15b3622ffdfb1e905cf2810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMxMjM1OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2307#discussion_r370312358", "bodyText": "Sounds good.", "author": "vjeko", "createdAt": "2020-01-23T19:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2MzgxNA=="}], "type": "inlineReview"}, {"oid": "f861138442b37a9cde4087e3bb23e5e7403d152e", "url": "https://github.com/CorfuDB/CorfuDB/commit/f861138442b37a9cde4087e3bb23e5e7403d152e", "message": "Change checkpoint initialization logic\n\nThis patch fixes a bug that gets triggers when IStreamView is being\nconsumed directly. When initializing a stream, the condition which\ndictates when a checkpoint should be loaded needs to take into account\nthat a stream has been previously seek-ed to some valid address.", "committedDate": "2020-01-24T22:35:02Z", "type": "forcePushed"}, {"oid": "ec7e344b2b2176127be0b88b4e8e3efd91ec6948", "url": "https://github.com/CorfuDB/CorfuDB/commit/ec7e344b2b2176127be0b88b4e8e3efd91ec6948", "message": "Change checkpoint initialization logic\n\nThis patch fixes a bug that gets triggers when IStreamView is being\nconsumed directly. When initializing a stream, the condition which\ndictates when a checkpoint should be loaded needs to take into account\nthat a stream has been previously seek-ed to some valid address.", "committedDate": "2020-01-24T22:36:09Z", "type": "forcePushed"}, {"oid": "93bfafc1e841b8e337d86ae44213344f07e49f21", "url": "https://github.com/CorfuDB/CorfuDB/commit/93bfafc1e841b8e337d86ae44213344f07e49f21", "message": "Change checkpoint initialization logic\n\nThis patch fixes a bug that gets triggers when IStreamView is being\nconsumed directly. When initializing a stream, the condition which\ndictates when a checkpoint should be loaded needs to take into account\nthat a stream has been previously seek-ed to some valid address.", "committedDate": "2020-01-26T22:54:26Z", "type": "commit"}, {"oid": "93bfafc1e841b8e337d86ae44213344f07e49f21", "url": "https://github.com/CorfuDB/CorfuDB/commit/93bfafc1e841b8e337d86ae44213344f07e49f21", "message": "Change checkpoint initialization logic\n\nThis patch fixes a bug that gets triggers when IStreamView is being\nconsumed directly. When initializing a stream, the condition which\ndictates when a checkpoint should be loaded needs to take into account\nthat a stream has been previously seek-ed to some valid address.", "committedDate": "2020-01-26T22:54:26Z", "type": "forcePushed"}]}