{"pr_number": 2778, "pr_title": "Lr metrics", "pr_createdAt": "2020-09-29T02:37:56Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2778", "timeline": [{"oid": "82be368bfaac2e8d58c79f9790142ffed1b7f9ac", "url": "https://github.com/CorfuDB/CorfuDB/commit/82be368bfaac2e8d58c79f9790142ffed1b7f9ac", "message": "Instrumentation init", "committedDate": "2020-09-22T01:15:56Z", "type": "commit"}, {"oid": "e3c35bcdcbbf6ef55d327fab8693796ea7235ac1", "url": "https://github.com/CorfuDB/CorfuDB/commit/e3c35bcdcbbf6ef55d327fab8693796ea7235ac1", "message": "Continue instrumentation", "committedDate": "2020-09-25T00:17:06Z", "type": "commit"}, {"oid": "29e554b887dfed5f5660e37dd5be22d52bf667dc", "url": "https://github.com/CorfuDB/CorfuDB/commit/29e554b887dfed5f5660e37dd5be22d52bf667dc", "message": "Fixes", "committedDate": "2020-09-29T02:31:08Z", "type": "commit"}, {"oid": "09e4e4f0418abcecb4d8a41ee7a46f5db59dd548", "url": "https://github.com/CorfuDB/CorfuDB/commit/09e4e4f0418abcecb4d8a41ee7a46f5db59dd548", "message": "Fixes", "committedDate": "2020-09-29T02:37:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MTcyOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r496951728", "bodyText": "you would have a race condition here in multi-threaded env", "author": "xnull", "createdAt": "2020-09-29T18:29:36Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package org.corfudb.common.metrics.micrometer;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingMeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingRegistryConfig;\n+import org.slf4j.Logger;\n+\n+import java.time.Duration;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+/**\n+ * A configuration class for a meter (metrics) registry.\n+ */\n+public class MeterRegistryProvider {\n+    private static Optional<MeterRegistry> meterRegistry = Optional.empty();\n+\n+    private MeterRegistryProvider() {\n+\n+    }\n+\n+    /**\n+     * Get the previously configured meter registry.\n+     * If the registry has not been previously configured return an\n+     * empty option.\n+     * @return An optional configured meter registry.\n+     */\n+    public static Optional<MeterRegistry> getInstance() {\n+        return meterRegistry;", "originalCommit": "09e4e4f0418abcecb4d8a41ee7a46f5db59dd548", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac17d91e1a73b6daf4a21bdde73d9648e03f88f2", "url": "https://github.com/CorfuDB/CorfuDB/commit/ac17d91e1a73b6daf4a21bdde73d9648e03f88f2", "message": "Double locking on getInstance", "committedDate": "2020-09-29T19:35:25Z", "type": "commit"}, {"oid": "3f79f29df330faaf52ef9d035ba55d411a45bf3c", "url": "https://github.com/CorfuDB/CorfuDB/commit/3f79f29df330faaf52ef9d035ba55d411a45bf3c", "message": "Unsued imports", "committedDate": "2020-09-29T19:36:50Z", "type": "commit"}, {"oid": "8f0dbd83a4d5a53c1b11844a5b122eeab63ee7f6", "url": "https://github.com/CorfuDB/CorfuDB/commit/8f0dbd83a4d5a53c1b11844a5b122eeab63ee7f6", "message": "Merge branch 'master' into lr-metrics", "committedDate": "2020-09-30T19:08:42Z", "type": "commit"}, {"oid": "cc47951eace8f0745a5488cd1f4df02b023d37c8", "url": "https://github.com/CorfuDB/CorfuDB/commit/cc47951eace8f0745a5488cd1f4df02b023d37c8", "message": "Add metrics to tests, add common tags", "committedDate": "2020-09-30T22:48:34Z", "type": "commit"}, {"oid": "a498a7218a01c6b508683a28cc62239ea5b73248", "url": "https://github.com/CorfuDB/CorfuDB/commit/a498a7218a01c6b508683a28cc62239ea5b73248", "message": "Provide InfluxDb line protocol sink for logging", "committedDate": "2020-10-02T01:33:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0MzUzNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r498643537", "bodyText": "Should we throw an exception here or provide a default value? I'm worried about null", "author": "xnull", "createdAt": "2020-10-02T06:52:49Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/IntervalLoggingConfig.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.corfudb.common.metrics.micrometer;\n+\n+import io.micrometer.core.instrument.logging.LoggingRegistryConfig;\n+import lombok.AllArgsConstructor;\n+\n+import java.time.Duration;\n+\n+/**\n+ * A configuration for the logging meter registry that configures the interval\n+ * between each logging event.\n+ */\n+@AllArgsConstructor\n+public class IntervalLoggingConfig implements LoggingRegistryConfig {\n+\n+    private final Duration intervalBetweenLogs;\n+\n+    @Override\n+    public Duration step() {\n+        return intervalBetweenLogs;\n+    }\n+\n+    @Override\n+    public String get(String key) {", "originalCommit": "a498a7218a01c6b508683a28cc62239ea5b73248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0NjQzMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r498646431", "bodyText": "here is a possible race. Imagine you have two threads\nt1->getInstance()\nt2->getInstance()\nt1-> meterRegistry is not present\nat the  same time\nt12-> meterRegistry is not present ALSO\nt1->creates LoggingMeterRegistry\nt2->creates LoggingMeterRegistry\nPlease take a look https://www.journaldev.com/1377/java-singleton-design-pattern-best-practices-examples\nI would prefer \"Eager initialization\" approach, if possible.\nIf you would like to use your method you need to add an additional check, see \"4. Thread Safe Singleton\"", "author": "xnull", "createdAt": "2020-10-02T07:01:26Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package org.corfudb.common.metrics.micrometer;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingMeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingRegistryConfig;\n+import org.corfudb.common.metrics.micrometer.loggingsink.InfluxLineProtocolLoggingSink;\n+import org.corfudb.common.metrics.micrometer.loggingsink.LoggingSink;\n+import org.slf4j.Logger;\n+\n+import java.time.Duration;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+/**\n+ * A configuration class for a meter (metrics) registry.\n+ */\n+public class MeterRegistryProvider {\n+    private static Optional<MeterRegistry> meterRegistry = Optional.empty();\n+\n+    private MeterRegistryProvider() {\n+\n+    }\n+\n+    /**\n+     * Get the previously configured meter registry.\n+     * If the registry has not been previously configured, create a default logging MeterRegistry\n+     * and return.\n+     * @return An optional configured meter registry.\n+     */\n+    public static Optional<MeterRegistry> getInstance() {\n+        if (!meterRegistry.isPresent()) {", "originalCommit": "a498a7218a01c6b508683a28cc62239ea5b73248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0NzQ0Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r498647443", "bodyText": "It seems to me meterRegistry must be present no matter what.\nIs it better not to use Optional but provide guarantees that MeterRegistry always exists?", "author": "xnull", "createdAt": "2020-10-02T07:04:21Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package org.corfudb.common.metrics.micrometer;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingMeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingRegistryConfig;\n+import org.corfudb.common.metrics.micrometer.loggingsink.InfluxLineProtocolLoggingSink;\n+import org.corfudb.common.metrics.micrometer.loggingsink.LoggingSink;\n+import org.slf4j.Logger;\n+\n+import java.time.Duration;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+/**\n+ * A configuration class for a meter (metrics) registry.\n+ */\n+public class MeterRegistryProvider {\n+    private static Optional<MeterRegistry> meterRegistry = Optional.empty();\n+\n+    private MeterRegistryProvider() {\n+\n+    }\n+\n+    /**\n+     * Get the previously configured meter registry.\n+     * If the registry has not been previously configured, create a default logging MeterRegistry\n+     * and return.\n+     * @return An optional configured meter registry.\n+     */\n+    public static Optional<MeterRegistry> getInstance() {\n+        if (!meterRegistry.isPresent()) {\n+            synchronized (MeterRegistry.class) {\n+                createLoggingMeterRegistry();\n+                return meterRegistry;\n+            }\n+        }\n+        return meterRegistry;\n+    }\n+\n+    /**\n+     * Configure the meter registry of type LoggingMeterRegistry. All the metrics registered\n+     * with this meter registry will be exported in the InfluxDB line protocol format\n+     * (https://docs.influxdata.com/influxdb/v1.8/write_protocols/line_protocol_tutorial/)\n+     * with  the provided loggingInterval frequency.\n+     * @param logger A configured logger.\n+     * @param loggingInterval A duration between log appends for every metric.\n+     * @param localEndpoint A local endpoint to tag every metric with.\n+     */\n+    public static void createLoggingMeterRegistry(Logger logger, Duration loggingInterval,\n+                                                  String localEndpoint) {\n+        InfluxLineProtocolLoggingSink influxLineProtocolLoggingSink =\n+                new InfluxLineProtocolLoggingSink(logger);\n+        createLoggingMeterRegistry(loggingInterval, localEndpoint, influxLineProtocolLoggingSink);\n+    }\n+\n+    /**\n+     * Configure the meter registry of type LoggingMeterRegistry. All the metrics registered\n+     * with this meter registry will be exported via provided logging sink with\n+     * the provided loggingInterval frequency.\n+     * @param sink A configured logging sink.\n+     * @param loggingInterval A duration between log appends for every metric.\n+     * @param localEndpoint A local endpoint to tag every metric with.\n+     */\n+    public static void createLoggingMeterRegistry(Duration loggingInterval,\n+                                                  String localEndpoint,\n+                                                  LoggingSink sink) {\n+        Supplier<Optional<MeterRegistry>> supplier = () -> {\n+            LoggingRegistryConfig config = new IntervalLoggingConfig(loggingInterval);\n+            LoggingMeterRegistry registry = LoggingMeterRegistry.builder(config)\n+                    .loggingSink(sink).build();\n+            registry.config().commonTags(\"endpoint\", localEndpoint);\n+            return Optional.of(registry);\n+        };\n+\n+        create(supplier);\n+    }\n+\n+    /**\n+     * Configure the default registry of type LoggingMeterRegistry.\n+     */\n+    public static void createLoggingMeterRegistry() {\n+        Supplier<Optional<MeterRegistry>> supplier = () -> Optional.of(new LoggingMeterRegistry());\n+        create(supplier);\n+    }\n+\n+    private static synchronized void create(Supplier<Optional<MeterRegistry>> meterRegistrySupplier) {\n+        if (!meterRegistry.isPresent()) {", "originalCommit": "a498a7218a01c6b508683a28cc62239ea5b73248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0NzgwOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r498647808", "bodyText": "please add @NonNull lombok annotation", "author": "xnull", "createdAt": "2020-10-02T07:05:31Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/loggingsink/DefaultLoggingSink.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package org.corfudb.common.metrics.micrometer.loggingsink;\n+\n+import lombok.AllArgsConstructor;\n+import org.slf4j.Logger;\n+\n+/**\n+ * A default logging sink. It prints the line in the default format.\n+ */\n+@AllArgsConstructor\n+public class DefaultLoggingSink implements LoggingSink {\n+    private final Logger logger;", "originalCommit": "a498a7218a01c6b508683a28cc62239ea5b73248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0Nzk0NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r498647944", "bodyText": "please add @nonnull lombok annotation", "author": "xnull", "createdAt": "2020-10-02T07:05:57Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/loggingsink/InfluxLineProtocolLoggingSink.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.corfudb.common.metrics.micrometer.loggingsink;\n+\n+import com.google.common.collect.ImmutableList;\n+import lombok.AllArgsConstructor;\n+import org.corfudb.common.metrics.micrometer.protocoltransformer.LineTransformer;\n+import org.corfudb.common.metrics.micrometer.protocoltransformer.influx.ByteDistSummaryInfluxLineTransformer;\n+import org.corfudb.common.metrics.micrometer.protocoltransformer.influx.CounterInfluxLineTransformer;\n+import org.corfudb.common.metrics.micrometer.protocoltransformer.influx.GaugeInfluxLineTransformer;\n+import org.corfudb.common.metrics.micrometer.protocoltransformer.influx.LongRunningTaskInfluxLineTransformer;\n+import org.corfudb.common.metrics.micrometer.protocoltransformer.influx.TimerInfluxLineTransformer;\n+import org.slf4j.Logger;\n+\n+/**\n+ * This sink prints the lines to the log in the InfluxDb line protocol.\n+ * https://docs.influxdata.com/influxdb/v1.8/write_protocols/line_protocol_tutorial/\n+ */\n+@AllArgsConstructor\n+public class InfluxLineProtocolLoggingSink implements LoggingSink {\n+\n+    private final Logger logger;", "originalCommit": "a498a7218a01c6b508683a28cc62239ea5b73248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0ODMzMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r498648332", "bodyText": "please add @NonNull lombok annotation", "author": "xnull", "createdAt": "2020-10-02T07:07:02Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/protocoltransformer/LineTransformer.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package org.corfudb.common.metrics.micrometer.protocoltransformer;\n+\n+import com.google.common.collect.ImmutableList;\n+import lombok.AllArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Matches and transforms the line with one of the provided matcher transformers.\n+ */\n+@AllArgsConstructor\n+@Slf4j\n+public class LineTransformer {\n+    private final ImmutableList<MatcherTransformer> matcherTransformers;", "originalCommit": "a498a7218a01c6b508683a28cc62239ea5b73248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0OTQwNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r498649407", "bodyText": "please add @NonNull lombok annotation for all String fields", "author": "xnull", "createdAt": "2020-10-02T07:10:05Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/protocoltransformer/influx/InfluxLineProtocolTransformer.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package org.corfudb.common.metrics.micrometer.protocoltransformer.influx;\n+\n+import lombok.AllArgsConstructor;\n+import org.corfudb.common.metrics.micrometer.protocoltransformer.MatcherTransformer;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Matcher transformer that transforms the line into the InfluxDb line protocol.\n+ */\n+public interface InfluxLineProtocolTransformer extends MatcherTransformer {\n+    /**\n+     * Measurement, tagSet and fieldSet.\n+     */\n+    int NUM_GROUPS = 3;\n+\n+    /**\n+     * A definition of the InfluxDb data point.\n+     */\n+    @AllArgsConstructor\n+    class InfluxLineProtocolPoint {\n+        private final String measurement;", "originalCommit": "a498a7218a01c6b508683a28cc62239ea5b73248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MDIyMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r498650222", "bodyText": "ifPresent will work better", "author": "xnull", "createdAt": "2020-10-02T07:12:08Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/InLogEntrySyncState.java", "diffHunk": "@@ -141,7 +154,13 @@ public void onEntry(LogReplicationState from) {\n                 logEntrySender.reset(fsm.getBaseSnapshot(), fsm.getAckedTimestamp());\n             }\n \n-            logEntrySyncFuture = fsm.getLogReplicationFSMWorkers().submit(() -> logEntrySender.send(transitionEventId));\n+            Runnable logEntrySendTask = () -> logEntrySender.send(transitionEventId);\n+\n+            if (senderTimer.isPresent()) {", "originalCommit": "a498a7218a01c6b508683a28cc62239ea5b73248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a97cc60fdc2d1abcf02abb995673209377b749d3", "url": "https://github.com/CorfuDB/CorfuDB/commit/a97cc60fdc2d1abcf02abb995673209377b749d3", "message": "Fixes", "committedDate": "2020-10-02T21:37:42Z", "type": "commit"}, {"oid": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "url": "https://github.com/CorfuDB/CorfuDB/commit/3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "message": "Merge", "committedDate": "2020-10-05T20:52:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk1NTI3Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r499955273", "bodyText": "nit -> white space MeterRegistryProvider{", "author": "annym", "createdAt": "2020-10-06T01:20:23Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package org.corfudb.common.metrics.micrometer;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingMeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingRegistryConfig;\n+import org.corfudb.common.metrics.micrometer.loggingsink.InfluxLineProtocolLoggingSink;\n+import org.corfudb.common.metrics.micrometer.loggingsink.LoggingSink;\n+import org.slf4j.Logger;\n+\n+import java.time.Duration;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+/**\n+ * A configuration class for a meter (metrics) registry.\n+ */\n+public class MeterRegistryProvider {\n+    private static Optional<MeterRegistry> meterRegistry = Optional.empty();\n+\n+    private MeterRegistryProvider() {\n+\n+    }\n+\n+    /**\n+     * Class that initializes the Meter Registry.\n+     */\n+    public static class MeterRegistryInitializer extends MeterRegistryProvider{", "originalCommit": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzMDI4Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r500630286", "bodyText": "No need to pass lockAcquireSample, right? it's a class level variable.", "author": "annym", "createdAt": "2020-10-06T22:24:58Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -529,16 +536,18 @@ public void processLockRelease() {\n         stopLogReplication();\n         // Signal Log Replication Server/Sink to stop receiving messages, leadership loss\n         interClusterReplicationService.getLogReplicationServer().setLeadership(false);\n+        recordLockRelease(lockAcquireSample);", "originalCommit": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzMDkwMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r500630902", "bodyText": "This only keeps metrics around duration of a lock, correct? Is it worth also collecting metrics around how many times the lock is acquired/released?", "author": "annym", "createdAt": "2020-10-06T22:26:41Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -806,4 +814,18 @@ public void shutdown() {\n     private String getLocalHost() {\n         return NodeLocator.parseString(serverContext.getLocalEndpoint()).getHost();\n     }\n+\n+\n+    private Optional<LongTaskTimer.Sample> recordLockAcquire(ClusterRole role) {\n+        return MeterRegistryProvider.getInstance()\n+                .map(registry -> registry.more()", "originalCommit": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk3MDU1Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r501970553", "bodyText": "Added", "author": "PavelZaytsev", "createdAt": "2020-10-08T19:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzMDkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY1Nzk2Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r500657966", "bodyText": "This seems to reflect the duration of sending a message. However, if no data is available this returns right away. So it could gather some incorrect data, right? Let's say the metric collection looks like 10s, 0s, 0s, 0s, 0s... because no further data was found to send.. then it would look like the average is 2s, when in fact those 0s are not valid... Probably the correct place to gather this metric is the sendWithBuffering in the SendBufferManager class or the send method in the CorfuDataSender... let me know your thoughts...", "author": "annym", "createdAt": "2020-10-06T23:49:00Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/InLogEntrySyncState.java", "diffHunk": "@@ -171,4 +191,18 @@ public UUID getTransitionEventId() {\n     public LogReplicationStateType getType() {\n         return LogReplicationStateType.IN_LOG_ENTRY_SYNC;\n     }\n+\n+    private Optional<AtomicLong> configureAcksCounter() {\n+        return MeterRegistryProvider.getInstance()\n+                .map(registry -> registry.gauge(\"logreplication.messages\",\n+                        ImmutableList.of(Tag.of(\"replication.type\", \"logentry\")),\n+                        new AtomicLong(0)));\n+    }\n+\n+    private Optional<Timer> configureSenderTimer() {", "originalCommit": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk3MTEyMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r501971122", "bodyText": "Moved it to sendWithBuffering for both replication types. The timer now starts when the future starts and stops when the future completes exceptionally or with a result.", "author": "PavelZaytsev", "createdAt": "2020-10-08T19:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY1Nzk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MTIyOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r500661228", "bodyText": "I believe this metric is not correct.. If placed here it represents the number of completed Snapshot Sync and not the number of acks for snapshot sync (like the tag indicates)... Consider this case, a snapshot sync which ends up sending 10 different messages, it will reach this point only at the end of the 10 messages being sent, so it won't count the 10 acks, but only after the 10 acks are received. I would suggest to change the name of the metric (as I do believe it is useful) and probably add the ack in the actual place where ACKs are received.. which might be under processAcks in SenderBufferManager", "author": "annym", "createdAt": "2020-10-06T23:59:30Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/InSnapshotSyncState.java", "diffHunk": "@@ -103,6 +117,14 @@ public LogReplicationState processEvent(LogReplicationEvent event) throws Illega\n                 waitSnapshotApplyState.setBaseSnapshotTimestamp(snapshotSender.getBaseSnapshotTimestamp());\n                 fsm.setBaseSnapshot(event.getMetadata().getLastTransferredBaseSnapshot());\n                 fsm.setAckedTimestamp(event.getMetadata().getLastLogEntrySyncedTimestamp());\n+                snapshotSyncAcksCounter.ifPresent(AtomicLong::getAndIncrement);", "originalCommit": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk3MTczNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r501971735", "bodyText": "Changed the metric name to reflect the number of types snapshot sync has occurred and also created a metric that counts acks in processAcks.", "author": "PavelZaytsev", "createdAt": "2020-10-08T19:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MTIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2Mjc1NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r500662755", "bodyText": "I believe we would have the same issue described InLogEntrySyncState here.. the transmit will not reflect accurately the time for sending a snapshot message as it might not send anything at all...", "author": "annym", "createdAt": "2020-10-07T00:04:40Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/InSnapshotSyncState.java", "diffHunk": "@@ -149,9 +171,14 @@ public void onEntry(LogReplicationState from) {\n             if (from != this) {\n                 snapshotSender.reset();\n                 fsm.getAckReader().markSnapshotSyncInfoOngoing(forcedSnapshotSync, transitionEventId);\n-            }\n+                snapshotSyncTimerSample = MeterRegistryProvider.getInstance().map(Timer::start);\n \n-            transmitFuture = fsm.getLogReplicationFSMWorkers().submit(() -> snapshotSender.transmit(transitionEventId));\n+            }\n+            Runnable snapShotSendTask = () -> snapshotSender.transmit(transitionEventId);\n+            if (senderTimer.isPresent()) {\n+                snapShotSendTask = senderTimer.get().wrap(snapShotSendTask);", "originalCommit": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2Mzc4MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r500663781", "bodyText": "By looking at this, maybe another good metric to expose is in average how many opaque entries are sent per message... opaqueEntryList.size()", "author": "annym", "createdAt": "2020-10-07T00:08:19Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/logreader/StreamsLogEntryReader.java", "diffHunk": "@@ -197,12 +204,17 @@ public LogReplicationEntry read(UUID logEntryRequestId) throws TrimmedException\n                 }\n \n                 lastOpaqueEntry = txOpaqueStream.next();\n+                deltaCounter.ifPresent(Counter::increment);\n+\n                 lastOpaqueEntryValid = isValidTransactionEntry(lastOpaqueEntry);\n                 currentProcessedEntryMetadata = new StreamIteratorMetadata(txOpaqueStream.txStream.pos(), lastOpaqueEntryValid);\n             }\n \n             log.trace(\"Generate LogEntryDataMessage size {} with {} entries for maxDataSizePerMsg {}. lastEntry size {}\",\n                     currentMsgSize, opaqueEntryList.size(), maxDataSizePerMsg, lastOpaqueEntry == null ? 0 : currentEntrySize);", "originalCommit": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk3MTk4Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r501971983", "bodyText": "Added the one that counts opaqueEntryList size.", "author": "PavelZaytsev", "createdAt": "2020-10-08T19:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2Mzc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2NTA5Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r500665097", "bodyText": "I believe this count should be after L.209 only if lastOpaqueEntryValid is true... cause if not, we will be counting transaction entries which are not intended to be replicated. For instance, consider 5 entries in the transaction stream, but only 1 is valid (has streams to replicate).. we would be counting 5 deltas when we should really count 1... or maybe we can count both (in different metrics)... to know which proportion of the transaction stream ends up being required for replication (1 out of 5 in this case).. I think that could be a nice way of analyzing the data available... to see how noisy the tx stream can be with regards to the data to be replicated..", "author": "annym", "createdAt": "2020-10-07T00:12:42Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/logreader/StreamsLogEntryReader.java", "diffHunk": "@@ -197,12 +204,17 @@ public LogReplicationEntry read(UUID logEntryRequestId) throws TrimmedException\n                 }\n \n                 lastOpaqueEntry = txOpaqueStream.next();\n+                deltaCounter.ifPresent(Counter::increment);", "originalCommit": "3940b5a7efa8a4c949935bc30e2c1c9cc84d001d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk3MjIxMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r501972213", "bodyText": "Created the one that counts overall and the one that counts only valid ones.", "author": "PavelZaytsev", "createdAt": "2020-10-08T19:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2NTA5Nw=="}], "type": "inlineReview"}, {"oid": "abcba255d32368a4683729acf3a1ddab49ccf438", "url": "https://github.com/CorfuDB/CorfuDB/commit/abcba255d32368a4683729acf3a1ddab49ccf438", "message": "Fixes", "committedDate": "2020-10-08T01:30:37Z", "type": "commit"}, {"oid": "bbe5cec55c28bbf6458bf49acc77db34901a6990", "url": "https://github.com/CorfuDB/CorfuDB/commit/bbe5cec55c28bbf6458bf49acc77db34901a6990", "message": "fix timed send", "committedDate": "2020-10-08T04:18:34Z", "type": "commit"}, {"oid": "9b69d07360a26250f5fa54f10761546aafc0d49c", "url": "https://github.com/CorfuDB/CorfuDB/commit/9b69d07360a26250f5fa54f10761546aafc0d49c", "message": "Some fixes and readme", "committedDate": "2020-10-08T19:42:43Z", "type": "commit"}, {"oid": "9718b948b51b6ac301ad9b6ffa462f6721b33b24", "url": "https://github.com/CorfuDB/CorfuDB/commit/9718b948b51b6ac301ad9b6ffa462f6721b33b24", "message": "Coadacy fixes", "committedDate": "2020-10-08T19:57:25Z", "type": "commit"}, {"oid": "f8cf3bd36908393fa341ea4bbe99f437e6b59ec8", "url": "https://github.com/CorfuDB/CorfuDB/commit/f8cf3bd36908393fa341ea4bbe99f437e6b59ec8", "message": "Merge branch 'master' into lr-metrics", "committedDate": "2020-10-08T20:04:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NTYxMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2778#discussion_r501985612", "bodyText": "Codacy found an issue: The utility class name 'MeterRegistryProvider' doesn't match '[A-Z][a-zA-Z0-9]+(Utils?|Helper|Constants)'", "author": "corfudb-bot", "createdAt": "2020-10-08T20:13:23Z", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package org.corfudb.common.metrics.micrometer;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingMeterRegistry;\n+import io.micrometer.core.instrument.logging.LoggingRegistryConfig;\n+import org.corfudb.common.metrics.micrometer.loggingsink.InfluxLineProtocolLoggingSink;\n+import org.corfudb.common.metrics.micrometer.loggingsink.LoggingSink;\n+import org.slf4j.Logger;\n+\n+import java.time.Duration;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+/**\n+ * A configuration class for a meter (metrics) registry.\n+ */\n+public class MeterRegistryProvider {", "originalCommit": "f8cf3bd36908393fa341ea4bbe99f437e6b59ec8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}