{"pr_number": 2310, "pr_title": "Get rid of a warning during unmap secondary indexes", "pr_createdAt": "2020-01-14T03:29:11Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2310", "timeline": [{"oid": "49c1dd87d34b47c5ff0472c4c6b9475de3b4d07d", "url": "https://github.com/CorfuDB/CorfuDB/commit/49c1dd87d34b47c5ff0472c4c6b9475de3b4d07d", "message": "Decrease log level for unmapIndex in corfu table", "committedDate": "2020-01-14T03:27:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzgwMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2310#discussion_r366153802", "bodyText": "This is not cheap and will be called very frequently. I think we should have a condition on the caller and if a secondary index doesn't exist then shouldn;t be called. Its much cleaner than calling it and \"implementing a no-op\"", "author": "Maithem", "createdAt": "2020-01-14T05:03:01Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/CorfuTable.java", "diffHunk": "@@ -624,7 +624,7 @@ public V merge(K key, V value, BiFunction<? super V, ? super V, ? extends V>\n     @SuppressWarnings(\"unchecked\")\n     protected void unmapSecondaryIndexes(K key, V value) {\n         if (value == null) {\n-            log.warn(\"Attempting to build an index with a null value, skipping.\");\n+            log.trace(\"Attempting to build an index with a null value, skipping.\");", "originalCommit": "49c1dd87d34b47c5ff0472c4c6b9475de3b4d07d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE3MjAzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2310#discussion_r366172033", "bodyText": "It is already there \n  \n    \n      CorfuDB/runtime/src/main/java/org/corfudb/runtime/collections/CorfuTable.java\n    \n    \n         Line 274\n      in\n      671c555\n    \n    \n    \n    \n\n        \n          \n           if (!secondaryIndexes.isEmpty()) { \n        \n    \n  \n\n\nThe if condition checks if an old value is present, if not (which means value == null) then we don't do anything.", "author": "xnull", "createdAt": "2020-01-14T06:40:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM0MzcyMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2310#discussion_r366343720", "bodyText": "Hi\nIf the table has secondary index, the secondaryIndexes is not empty when the table is created. But when secondaryIndexes is not empty, if a new record with key value is created, e.g. in put method, V previous = mainMap.put(key, value); the previous value is null. so the method unmapSecondaryIndexes  is still invoked and the log will be printed. I think it would be better to check value null before invoke unmapSecondaryIndexes.", "author": "muren102", "createdAt": "2020-01-14T13:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ2MjQ1Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2310#discussion_r366462456", "bodyText": "@muren102 unmapSecondaryIndexes called by many methods. If I extract this check from the method I need to add it to all caller methods, which is not so good decision. Can you please explain why calling a method is a problem?", "author": "xnull", "createdAt": "2020-01-14T17:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY1MjQ2OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2310#discussion_r366652468", "bodyText": "Hi\nCalling the method is not a problem. But it may bring lots of trace logs \"Attempting to build an index with a null value, skipping.\"", "author": "muren102", "createdAt": "2020-01-15T01:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY1NTgxMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2310#discussion_r366655812", "bodyText": "I still don't see how it can be a problem. Anyways we decided to get rid of it", "author": "xnull", "createdAt": "2020-01-15T01:21:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzgwMg=="}], "type": "inlineReview"}, {"oid": "ba517f51348047df57dc796fea66e94394d732e1", "url": "https://github.com/CorfuDB/CorfuDB/commit/ba517f51348047df57dc796fea66e94394d732e1", "message": "Merge branch 'master' into corfutable-unmap-warning", "committedDate": "2020-01-14T06:40:30Z", "type": "commit"}, {"oid": "b11aec062da8f6d4f926f7632ccaa5afe0546490", "url": "https://github.com/CorfuDB/CorfuDB/commit/b11aec062da8f6d4f926f7632ccaa5afe0546490", "message": "Get rid of a warning during unmap secondary indexes", "committedDate": "2020-01-14T22:47:23Z", "type": "commit"}, {"oid": "d2cf689a8a7c1b43c607f40c4e74a53e4c273970", "url": "https://github.com/CorfuDB/CorfuDB/commit/d2cf689a8a7c1b43c607f40c4e74a53e4c273970", "message": "Merge branch 'master' into corfutable-unmap-warning", "committedDate": "2020-01-14T22:49:30Z", "type": "commit"}, {"oid": "2788388d15563401a6941d4fe0bb43ce25cb5ab2", "url": "https://github.com/CorfuDB/CorfuDB/commit/2788388d15563401a6941d4fe0bb43ce25cb5ab2", "message": "Merge branch 'master' into corfutable-unmap-warning", "committedDate": "2020-01-15T00:16:54Z", "type": "commit"}]}