{"pr_number": 16679, "pr_title": "Eureka url can not be set from xml config #36", "pr_createdAt": "2020-02-24T04:28:17Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16679", "timeline": [{"oid": "ead0ae1a420b4d868375d1609f34503752884bc3", "url": "https://github.com/hazelcast/hazelcast/commit/ead0ae1a420b4d868375d1609f34503752884bc3", "message": "Eureka url can not be set from xml config #36", "committedDate": "2020-02-24T03:23:48Z", "type": "commit"}, {"oid": "034cb4646a1fce4d3ce4ddbb5442e4823f45801e", "url": "https://github.com/hazelcast/hazelcast/commit/034cb4646a1fce4d3ce4ddbb5442e4823f45801e", "message": "lowecase handler abstraction", "committedDate": "2020-02-24T07:31:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMzE5Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16679#discussion_r383513192", "bodyText": "Can't we simply pass the tag to this metrod from the caller and do the following without the need for the handler?\nString key = cleanNodeName(n, !tag.equals(\"eureka\"));\n\n[...]\n\npublic static String cleanNodeName(final Node node, final boolean shouldLowerCase) {\n[...]\n}\n\nThis seems we put a \"local\" boolean to a hashmap that we lookup for a few lines later in the same cycle, so the handler and the map feel unnecessary here.", "author": "blazember", "createdAt": "2020-02-24T21:04:29Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/MemberDomConfigProcessor.java", "diffHunk": "@@ -1332,18 +1332,25 @@ private void handleAliasedDiscoveryStrategy(WanBatchPublisherConfig publisherCon\n     private void updateConfig(AliasedDiscoveryConfig config, Node node) {\n         NamedNodeMap attributes = node.getAttributes();\n         for (int a = 0; a < attributes.getLength(); a++) {\n-            Node att = attributes.item(a);\n+            Node att = attributes.item(a);            \n             String value = getTextContent(att).trim();\n             if (\"enabled\".equals(lowerCaseInternal(att.getNodeName()))) {\n                 config.setEnabled(getBooleanValue(value));\n             } else if (att.getNodeName().equals(\"connection-timeout-seconds\")) {\n                 config.setProperty(\"connection-timeout-seconds\", value);\n             }\n         }\n+        LowercaseHandler lowerCaseHandler = new LowercaseHandler();\n         for (Node n : childElements(node)) {\n+        \tlowerCaseHandler.put(n.getLocalName(), \"eureka\".equals(n.getParentNode().getLocalName()));\n             String key = cleanNodeName(n);", "originalCommit": "034cb4646a1fce4d3ce4ddbb5442e4823f45801e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxODIwNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16679#discussion_r383618205", "bodyText": "cleanNodeName is being used in a lot of places I wanted to have less impact in the codebase", "author": "omidp", "createdAt": "2020-02-25T01:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMzE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgwMTQxNw==", "url": "https://github.com/hazelcast/hazelcast/pull/16679#discussion_r383801417", "bodyText": "I see your point @omidp. You can keep the change local with overriding the cleanNodeName method like\n    public static String cleanNodeName(final Node node) {\n        return cleanNodeName(node, true);\n    }\n\n    public static String cleanNodeName(final Node node, final boolean shouldLowerCase) {\n        final String nodeName = node.getLocalName();\n        if (nodeName == null) {\n            throw new HazelcastException(\"Local node name is null for \" + node);\n        }\n        return shouldLowerCase ? StringUtil.lowerCaseInternal(nodeName) : nodeName;\n    }\n\nSo no other code needs to be modified and we follow the common logic for eureka config processing as well. I'd prefer this over introducing a helper class and a map.", "author": "blazember", "createdAt": "2020-02-25T10:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMzE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgxNDQ2MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16679#discussion_r383814461", "bodyText": "Ok done", "author": "omidp", "createdAt": "2020-02-25T11:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMzE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNDE1OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16679#discussion_r383514159", "bodyText": "Could you please add an assertion for the two added properties and do the same changes in the YamlConfigBuilderTest too?", "author": "blazember", "createdAt": "2020-02-24T21:06:37Z", "path": "hazelcast/src/test/java/com/hazelcast/config/XMLConfigBuilderTest.java", "diffHunk": "@@ -407,6 +407,8 @@ public void readEurekaConfig() {\n                 + \"            <eureka enabled=\\\"true\\\">\\n\"\n                 + \"                <use-public-ip>true</use-public-ip>\\n\"\n                 + \"                <namespace>hazelcast</namespace>\\n\"\n+                + \"                <shouldUseDns>false</shouldUseDns>\\n\"\n+                + \"\t\t\t\t   <serviceUrl.default>http://localhost:8082/eureka</serviceUrl.default>\\n\"", "originalCommit": "034cb4646a1fce4d3ce4ddbb5442e4823f45801e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxNzg0Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/16679#discussion_r383617843", "bodyText": "Done", "author": "omidp", "createdAt": "2020-02-25T01:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNDE1OQ=="}], "type": "inlineReview"}, {"oid": "cd04bcfa989c06884657bc385021505ee9e019e5", "url": "https://github.com/hazelcast/hazelcast/commit/cd04bcfa989c06884657bc385021505ee9e019e5", "message": "Eureka url can not be set from xml config #36", "committedDate": "2020-02-25T01:50:02Z", "type": "commit"}, {"oid": "3d02d86a5844c31c7651c0f22d3d8a0e0d770639", "url": "https://github.com/hazelcast/hazelcast/commit/3d02d86a5844c31c7651c0f22d3d8a0e0d770639", "message": "overload method for cleanNodename to handle lowercase", "committedDate": "2020-02-25T11:04:52Z", "type": "commit"}, {"oid": "ddda9c4c205e8c1c89650e8369f2b85ac1529191", "url": "https://github.com/hazelcast/hazelcast/commit/ddda9c4c205e8c1c89650e8369f2b85ac1529191", "message": "eureka lowercase bug fix", "committedDate": "2020-02-25T11:11:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAwOTA0NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16679#discussion_r385009045", "bodyText": "Could you please add assertion for serviceUrl.default too?", "author": "blazember", "createdAt": "2020-02-27T09:36:45Z", "path": "hazelcast/src/test/java/com/hazelcast/config/XMLConfigBuilderTest.java", "diffHunk": "@@ -419,6 +421,7 @@ public void readEurekaConfig() {\n         assertTrue(eurekaConfig.isEnabled());\n         assertTrue(eurekaConfig.isUsePublicIp());\n         assertEquals(\"hazelcast\", eurekaConfig.getProperty(\"namespace\"));\n+        assertEquals(\"false\", eurekaConfig.getProperty(\"shouldUseDns\"));", "originalCommit": "ddda9c4c205e8c1c89650e8369f2b85ac1529191", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAxMDEzNw==", "url": "https://github.com/hazelcast/hazelcast/pull/16679#discussion_r385010137", "bodyText": "You can call this method from cleanNodeName(Node) with true, so the duplication can be removed.", "author": "blazember", "createdAt": "2020-02-27T09:38:38Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/DomConfigHelper.java", "diffHunk": "@@ -98,6 +98,14 @@ public static String cleanNodeName(final Node node) {\n         }\n         return StringUtil.lowerCaseInternal(nodeName);\n     }\n+    \n+    public static String cleanNodeName(final Node node, final boolean shouldLowercase) {", "originalCommit": "ddda9c4c205e8c1c89650e8369f2b85ac1529191", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0995f627603164911cfa5469f240b41013b98334", "url": "https://github.com/hazelcast/hazelcast/commit/0995f627603164911cfa5469f240b41013b98334", "message": "code clean up", "committedDate": "2020-02-27T09:46:21Z", "type": "commit"}, {"oid": "914f6934a3a1bf0fc5ff3562480ae0440c22daa3", "url": "https://github.com/hazelcast/hazelcast/commit/914f6934a3a1bf0fc5ff3562480ae0440c22daa3", "message": "fix trailing space", "committedDate": "2020-02-27T10:26:46Z", "type": "commit"}]}