{"pr_number": 17037, "pr_title": "Add CPSubsystem membership and group-availability listeners", "pr_createdAt": "2020-06-02T10:26:55Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17037", "timeline": [{"oid": "e605d52a0d9834d10167929db4df7db5b1d533f0", "url": "https://github.com/hazelcast/hazelcast/commit/e605d52a0d9834d10167929db4df7db5b1d533f0", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-06-03T13:53:37Z", "type": "forcePushed"}, {"oid": "3e566b4aeea3fd401a33c354c53f73d88febc459", "url": "https://github.com/hazelcast/hazelcast/commit/3e566b4aeea3fd401a33c354c53f73d88febc459", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-06-17T12:26:29Z", "type": "forcePushed"}, {"oid": "fe657100180856ae5c66e3d456c51aaafdb44d87", "url": "https://github.com/hazelcast/hazelcast/commit/fe657100180856ae5c66e3d456c51aaafdb44d87", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-06-17T12:48:03Z", "type": "forcePushed"}, {"oid": "c698e69b1e739e43f4714732fb614edc41314c20", "url": "https://github.com/hazelcast/hazelcast/commit/c698e69b1e739e43f4714732fb614edc41314c20", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-06-29T12:23:20Z", "type": "forcePushed"}, {"oid": "d4ea9b0d4021018456c6d45d7a0bf09cc6dc075c", "url": "https://github.com/hazelcast/hazelcast/commit/d4ea9b0d4021018456c6d45d7a0bf09cc6dc075c", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-06-29T13:21:44Z", "type": "forcePushed"}, {"oid": "98a56130999a5281e631bb113c62a9eccdf6f9ca", "url": "https://github.com/hazelcast/hazelcast/commit/98a56130999a5281e631bb113c62a9eccdf6f9ca", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-08-10T10:27:56Z", "type": "forcePushed"}, {"oid": "e551818db3b48c6702f3c339bd020ed52dd60760", "url": "https://github.com/hazelcast/hazelcast/commit/e551818db3b48c6702f3c339bd020ed52dd60760", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-08-25T09:25:41Z", "type": "forcePushed"}, {"oid": "425569efd1a4fd63ad5e2bb3e88e5e92662ca602", "url": "https://github.com/hazelcast/hazelcast/commit/425569efd1a4fd63ad5e2bb3e88e5e92662ca602", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-08-27T10:13:43Z", "type": "commit"}, {"oid": "425569efd1a4fd63ad5e2bb3e88e5e92662ca602", "url": "https://github.com/hazelcast/hazelcast/commit/425569efd1a4fd63ad5e2bb3e88e5e92662ca602", "message": "Add CPSubsystem membership and group-availability listeners\n\n- Added `CPMembershipListener` to get notified when a CP member is added to\nor removed from the CP Subsystem.\n\n- Added `CPGroupAvailabilityListener` to get notified when availability\nof a CP group decreases or it loses the majority completely.", "committedDate": "2020-08-27T10:13:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3MjcxNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17037#discussion_r478372714", "bodyText": "If we throw an exception here, the availability event might be missing.", "author": "petrpleshachkov", "createdAt": "2020-08-27T12:15:16Z", "path": "hazelcast/src/main/java/com/hazelcast/cp/internal/RaftService.java", "diffHunk": "@@ -1336,6 +1380,59 @@ public void applyUnsafeModeState(int partitionId, UnsafeModePartitionState state\n         unsafeModeStates[partitionId].apply(state);\n     }\n \n+    public UUID registerMembershipListener(CPMembershipListener listener) {\n+        return nodeEngine.getEventService().registerListener(SERVICE_NAME, EVENT_TOPIC_MEMBERSHIP, listener).getId();\n+    }\n+\n+    public boolean removeMembershipListener(UUID id) {\n+        return nodeEngine.getEventService().deregisterListener(SERVICE_NAME, EVENT_TOPIC_MEMBERSHIP, id);\n+    }\n+\n+    public UUID registerAvailabilityListener(CPGroupAvailabilityListener listener) {\n+        return nodeEngine.getEventService().registerListener(SERVICE_NAME, EVENT_TOPIC_AVAILABILITY, listener).getId();\n+    }\n+\n+    public boolean removeAvailabilityListener(UUID id) {\n+        return nodeEngine.getEventService().deregisterListener(SERVICE_NAME, EVENT_TOPIC_AVAILABILITY, id);\n+    }\n+\n+    @Override\n+    public void dispatchEvent(Object e, EventListener l) {\n+        long now = Clock.currentTimeMillis();\n+        recentAvailabilityEvents.values().removeIf(expirationTime -> expirationTime < now);\n+\n+        if (e instanceof CPMembershipEvent) {\n+            CPMembershipEvent event = (CPMembershipEvent) e;\n+            CPMembershipListener listener = (CPMembershipListener) l;\n+            switch (event.getType()) {\n+                case ADDED:\n+                    listener.memberAdded(event);\n+                    break;\n+                case REMOVED:\n+                    listener.memberRemoved(event);\n+                    break;\n+                default:\n+                    throw new IllegalArgumentException(\"Unhandled event: \" + event);", "originalCommit": "425569efd1a4fd63ad5e2bb3e88e5e92662ca602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM4NDc5Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17037#discussion_r478384793", "bodyText": "At this point we already know event object is instance of CPMembershipEvent. This default case should be unreachable under normal conditions, it's just for the case we add a new CPMembershipEvent type.", "author": "mdogan", "createdAt": "2020-08-27T12:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3MjcxNA=="}], "type": "inlineReview"}]}