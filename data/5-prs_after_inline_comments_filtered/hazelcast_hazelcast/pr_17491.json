{"pr_number": 17491, "pr_title": "Locate config files using a thread's context classloader", "pr_createdAt": "2020-09-03T18:49:35Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17491", "timeline": [{"oid": "c2a80de62aa33ac9eb1fe3c0a8bf2c969860b884", "url": "https://github.com/hazelcast/hazelcast/commit/c2a80de62aa33ac9eb1fe3c0a8bf2c969860b884", "message": "Locate config files using a thread's context classloader", "committedDate": "2020-09-04T10:45:28Z", "type": "commit"}, {"oid": "c2a80de62aa33ac9eb1fe3c0a8bf2c969860b884", "url": "https://github.com/hazelcast/hazelcast/commit/c2a80de62aa33ac9eb1fe3c0a8bf2c969860b884", "message": "Locate config files using a thread's context classloader", "committedDate": "2020-09-04T10:45:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU4Mzg5Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17491#discussion_r483583896", "bodyText": "Just for the record, as we discussed in private, the default config has to be loaded from the hazelcast.jar always, therefore, Config.class.getClassloader() should be the right one here and TCCL should be used only in the other load methods.", "author": "blazember", "createdAt": "2020-09-04T12:27:55Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/AbstractConfigLocator.java", "diffHunk": "@@ -146,7 +146,7 @@ protected void loadDefaultConfigurationFromClasspath(String defaultConfigFile) {\n \n     protected boolean loadConfigurationFromClasspath(String configFileName) {\n         try {\n-            URL url = Config.class.getClassLoader().getResource(configFileName);\n+            URL url = Thread.currentThread().getContextClassLoader().getResource(configFileName);", "originalCommit": "c2a80de62aa33ac9eb1fe3c0a8bf2c969860b884", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYzNzg5Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17491#discussion_r483637897", "bodyText": "I tested this setup on Quarkus in dev mode and works correctly \ud83d\udc4d", "author": "pivovarit", "createdAt": "2020-09-04T14:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU4Mzg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMxNTk0Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17491#discussion_r484315942", "bodyText": "@pivovarit Could you please update the PR accordingly?", "author": "blazember", "createdAt": "2020-09-07T09:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU4Mzg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMxODQzMQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17491#discussion_r484318431", "bodyText": "It's done already. I think that this comment is just hanging on an outdated change. Check the file:\n\n  \n    \n      hazelcast/hazelcast/src/main/java/com/hazelcast/internal/config/AbstractConfigLocator.java\n    \n    \n        Lines 131 to 138\n      in\n      c2a80de\n    \n    \n    \n    \n\n        \n          \n           configurationUrl = Config.class.getClassLoader().getResource(defaultConfigFile); \n        \n\n        \n          \n            \n        \n\n        \n          \n           if (configurationUrl == null) { \n        \n\n        \n          \n               throw new HazelcastException(String.format(\"Could not find '%s' in the classpath! This may be due to a \" \n        \n\n        \n          \n                       + \"wrong-packaged or corrupted jar file.\", defaultConfigFile)); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           in = Config.class.getClassLoader().getResourceAsStream(defaultConfigFile);", "author": "pivovarit", "createdAt": "2020-09-07T09:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU4Mzg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMyMTA5OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17491#discussion_r484321098", "bodyText": "Ah, I probably commented on the wrong method. This one is loadConfigurationFromClasspath, loadDefaultConfigurationFromClasspath indeed uses Config classloader as exoected.", "author": "blazember", "createdAt": "2020-09-07T09:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU4Mzg5Ng=="}], "type": "inlineReview"}, {"oid": "7fedbbab797d7586444e07ca2740910bf6bd8643", "url": "https://github.com/hazelcast/hazelcast/commit/7fedbbab797d7586444e07ca2740910bf6bd8643", "message": "Add comment explaining the classloader choice in loadDefaultConfiguratinoFromClasspath", "committedDate": "2020-09-09T15:13:33Z", "type": "commit"}, {"oid": "7fedbbab797d7586444e07ca2740910bf6bd8643", "url": "https://github.com/hazelcast/hazelcast/commit/7fedbbab797d7586444e07ca2740910bf6bd8643", "message": "Add comment explaining the classloader choice in loadDefaultConfiguratinoFromClasspath", "committedDate": "2020-09-09T15:13:33Z", "type": "forcePushed"}]}