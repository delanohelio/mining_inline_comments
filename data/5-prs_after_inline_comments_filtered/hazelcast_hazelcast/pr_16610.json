{"pr_number": 16610, "pr_title": "Fixes order problem in client user code deployment", "pr_createdAt": "2020-02-05T09:05:43Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16610", "timeline": [{"oid": "8716a86bc8a9e8d3a7460244f8128a7f679c4c9f", "url": "https://github.com/hazelcast/hazelcast/commit/8716a86bc8a9e8d3a7460244f8128a7f679c4c9f", "message": "Fixes order problem in client user code deployment\n\nThe issue is related to inheritance. If a a ChildClass is configured\nfirst, it was trying to be defined first. It was searching for its\nparent, and failing.\nThe issue is fixed by sorting the class definitions by size\nin ascending order. This way, we will make sure that a parent class\nwill be defined first.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16575\n\n(cherry picked from commit c9b0bcc5bda7773bbd9d5ff037bf0f68920b2db5)", "committedDate": "2020-02-05T13:59:20Z", "type": "forcePushed"}, {"oid": "cb371fccca47695c1f83cc44bcc37ee3039f9547", "url": "https://github.com/hazelcast/hazelcast/commit/cb371fccca47695c1f83cc44bcc37ee3039f9547", "message": "Fixes order problem in client user code deployment\n\nThe issue is related to inheritance. If a a ChildClass is configured\nfirst, it was trying to be defined first. It was searching for its\nparent, and failing.\nThe issue is fixed by sorting the class definitions by size\nin ascending order. This way, we will make sure that a parent class\nwill be defined first.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16575\n\n(cherry picked from commit c9b0bcc5bda7773bbd9d5ff037bf0f68920b2db5)", "committedDate": "2020-02-07T09:58:48Z", "type": "commit"}, {"oid": "cb371fccca47695c1f83cc44bcc37ee3039f9547", "url": "https://github.com/hazelcast/hazelcast/commit/cb371fccca47695c1f83cc44bcc37ee3039f9547", "message": "Fixes order problem in client user code deployment\n\nThe issue is related to inheritance. If a a ChildClass is configured\nfirst, it was trying to be defined first. It was searching for its\nparent, and failing.\nThe issue is fixed by sorting the class definitions by size\nin ascending order. This way, we will make sure that a parent class\nwill be defined first.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16575\n\n(cherry picked from commit c9b0bcc5bda7773bbd9d5ff037bf0f68920b2db5)", "committedDate": "2020-02-07T09:58:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM2MTExMA==", "url": "https://github.com/hazelcast/hazelcast/pull/16610#discussion_r376361110", "bodyText": "would this also do the same?\n        Collections.sort(classes, (c1, c2) -> c1.equals(c2) ? 0 : c1.isAssignableFrom(c2) ? -1 : 1);", "author": "ihsandemir", "createdAt": "2020-02-07T12:15:28Z", "path": "hazelcast-client/src/main/java/com/hazelcast/client/spi/impl/ClientUserCodeDeploymentService.java", "diffHunk": "@@ -66,8 +67,37 @@ public void start() throws IOException, ClassNotFoundException {\n         loadClasses();\n     }\n \n+    public static List<Class> sortByInheritance(List<Class<?>> classList) {\n+        List<Class> sortedList = new LinkedList<Class>();\n+        for (Class aClass : classList) {\n+            boolean isInserted = false;\n+\n+            int index = 0;\n+            for (Class sortedClass : sortedList) {\n+                if (aClass.isAssignableFrom(sortedClass)) {\n+                    sortedList.add(index, aClass);\n+                    isInserted = true;\n+                    break;\n+                }\n+                index++;\n+            }\n+            if (!isInserted) {\n+                sortedList.add(aClass);\n+            }\n+        }\n+        return sortedList;\n+    }\n+\n+\n     private void loadClasses() throws ClassNotFoundException {\n-        for (String className : clientUserCodeDeploymentConfig.getClassNames()) {\n+        List<String> classNames = clientUserCodeDeploymentConfig.getClassNames();\n+        List<Class<?>> classes = new ArrayList<Class<?>>(classNames.size());\n+        for (String className : classNames) {\n+            classes.add(configClassLoader.loadClass(className));\n+        }\n+        List<Class> sortedClasses = sortByInheritance(classes);", "originalCommit": "cb371fccca47695c1f83cc44bcc37ee3039f9547", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3MDYwMw==", "url": "https://github.com/hazelcast/hazelcast/pull/16610#discussion_r376370603", "bodyText": "It is not a correct comparator implementation, because it does not give a total order. See this question and answer\nhttps://stackoverflow.com/questions/50921813/how-to-sort-classes-according-to-their-inheritance-level#comment88888102_50922334", "author": "sancar", "createdAt": "2020-02-07T12:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM2MTExMA=="}], "type": "inlineReview"}, {"oid": "08461a72eff20c47c48674d0ee7d592996dff8db", "url": "https://github.com/hazelcast/hazelcast/commit/08461a72eff20c47c48674d0ee7d592996dff8db", "message": "include jars to sorting", "committedDate": "2020-02-07T16:51:15Z", "type": "commit"}, {"oid": "15d5fc750e26c3d67ef3efbec6b994ad0d3ca1d3", "url": "https://github.com/hazelcast/hazelcast/commit/15d5fc750e26c3d67ef3efbec6b994ad0d3ca1d3", "message": "Fixes order problem in client user code deployment\n\nThe issue is related to inheritance. If a a ChildClass is configured\nfirst, it was trying to be defined first. It was searching for its\nparent, and failing.\nThe issue is fixed by loading the parent class definition when needed,\nfrom bundledClassDefinitions on the server.\n(these are the whole classes send together from the client)\n\nfixes https://github.com/hazelcast/hazelcast/issues/16575\n\n(cherry picked from commit 15fcc573d100cd9454edd43db6da93573c1df687)", "committedDate": "2020-02-10T10:02:05Z", "type": "commit"}]}