{"pr_number": 16613, "pr_title": "Align test code with 4.0.z branch", "pr_createdAt": "2020-02-05T12:10:40Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16613", "timeline": [{"oid": "c6835431a60227193a219bef1b87c8b9b4beaa69", "url": "https://github.com/hazelcast/hazelcast/commit/c6835431a60227193a219bef1b87c8b9b4beaa69", "message": "Align test code with 4.0.z branch", "committedDate": "2020-02-05T12:07:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5NjgxNg==", "url": "https://github.com/hazelcast/hazelcast/pull/16613#discussion_r377596816", "bodyText": "lambda style would be less verbose?", "author": "petrpleshachkov", "createdAt": "2020-02-11T12:11:48Z", "path": "hazelcast/src/test/java/com/hazelcast/cache/eviction/ExtendedCacheExpirationTest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.cache.eviction;\n+\n+import com.hazelcast.cache.CacheTestSupport;\n+import com.hazelcast.cache.HazelcastExpiryPolicy;\n+import com.hazelcast.cache.ICache;\n+import com.hazelcast.config.CacheConfig;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.test.AssertTask;\n+import com.hazelcast.test.HazelcastParallelParametersRunnerFactory;\n+import com.hazelcast.test.OverridePropertyRule;\n+import com.hazelcast.test.TestHazelcastInstanceFactory;\n+import com.hazelcast.test.annotation.ParallelTest;\n+import com.hazelcast.test.annotation.QuickTest;\n+import com.hazelcast.test.backup.BackupAccessor;\n+import com.hazelcast.test.backup.TestBackupUtils;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+\n+import javax.cache.configuration.FactoryBuilder;\n+import javax.cache.expiry.Duration;\n+import javax.cache.expiry.ExpiryPolicy;\n+import java.io.Serializable;\n+import java.util.Collection;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.hazelcast.cache.impl.eviction.CacheClearExpiredRecordsTask.PROP_TASK_PERIOD_SECONDS;\n+import static com.hazelcast.test.OverridePropertyRule.set;\n+import static java.lang.String.valueOf;\n+import static java.util.Arrays.asList;\n+import static org.junit.Assert.assertNull;\n+\n+@RunWith(Parameterized.class)\n+@Parameterized.UseParametersRunnerFactory(HazelcastParallelParametersRunnerFactory.class)\n+@Category({QuickTest.class, ParallelTest.class})\n+public class ExtendedCacheExpirationTest extends CacheTestSupport {\n+\n+    @Rule\n+    public final OverridePropertyRule overrideTaskSecondsRule = set(PROP_TASK_PERIOD_SECONDS,\n+            valueOf(Integer.MAX_VALUE));\n+\n+    @Parameterized.Parameters(name = \"useSyncBackups:{0}\")\n+    public static Collection<Object[]> parameters() {\n+        return asList(new Object[][]{\n+                {true},\n+                {false}\n+        });\n+    }\n+\n+    @Parameterized.Parameter(0)\n+    public boolean useSyncBackups;\n+\n+    private static final int CLUSTER_SIZE = 2;\n+    private final Duration THREE_SECONDS = new Duration(TimeUnit.SECONDS, 3);\n+\n+    protected TestHazelcastInstanceFactory factory;\n+    protected HazelcastInstance[] instances = new HazelcastInstance[3];\n+\n+    @Override\n+    protected HazelcastInstance getHazelcastInstance() {\n+        return instances[0];\n+    }\n+\n+    @Override\n+    protected void onSetup() {\n+        factory = createHazelcastInstanceFactory(CLUSTER_SIZE);\n+        for (int i = 0; i < CLUSTER_SIZE; i++) {\n+            instances[i] = factory.newHazelcastInstance(getConfig());\n+        }\n+    }\n+\n+    @Override\n+    protected Config getConfig() {\n+        return smallInstanceConfig();\n+    }\n+\n+    @Override\n+    protected void onTearDown() {\n+        factory.shutdownAll();\n+    }\n+\n+    @Test\n+    public void test_backupOperationAppliesDefaultExpiryPolicy() {\n+        HazelcastExpiryPolicy defaultExpiryPolicy = new HazelcastExpiryPolicy(THREE_SECONDS,\n+                Duration.ZERO, Duration.ZERO);\n+\n+        CacheConfig cacheConfig = createCacheConfig(defaultExpiryPolicy);\n+        final ICache cache = createCache(cacheConfig);\n+\n+        final int keyCount = 100;\n+\n+        for (int i = 0; i < keyCount; i++) {\n+            cache.put(i, i);\n+        }\n+\n+        // Check if all backup entries have applied the default expiry policy\n+        for (int i = 1; i < CLUSTER_SIZE; i++) {\n+            BackupAccessor backupAccessor = TestBackupUtils.newCacheAccessor(instances, cache.getName(), i);\n+            for (int j = 0; j < keyCount; j++) {\n+                TestBackupUtils.assertExpirationTimeExistsEventually(j, backupAccessor);\n+            }\n+        }\n+\n+        // terminate other nodes than number zero to cause backup promotion at the 0th member\n+        for (int i = 1; i < CLUSTER_SIZE; i++) {\n+            getNode(instances[i]).shutdown(true);\n+        }\n+\n+        assertTrueEventually(new AssertTask() {\n+            @Override\n+            public void run() throws Exception {", "originalCommit": "c6835431a60227193a219bef1b87c8b9b4beaa69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5NzkwOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16613#discussion_r377597909", "bodyText": "3.12.z doesn't support lambda style.", "author": "ahmetmircik", "createdAt": "2020-02-11T12:14:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5NjgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5OTIzMg==", "url": "https://github.com/hazelcast/hazelcast/pull/16613#discussion_r377599232", "bodyText": "Ahh, sorry, didn't notice that this is 3.x.", "author": "petrpleshachkov", "createdAt": "2020-02-11T12:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5NjgxNg=="}], "type": "inlineReview"}]}