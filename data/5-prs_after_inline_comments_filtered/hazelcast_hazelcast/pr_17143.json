{"pr_number": 17143, "pr_title": "Count of number of caches along with wan replication", "pr_createdAt": "2020-06-30T10:19:04Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17143", "timeline": [{"oid": "c2d89a276af76eaf077ebf1d6163a92132a91abe", "url": "https://github.com/hazelcast/hazelcast/commit/c2d89a276af76eaf077ebf1d6163a92132a91abe", "message": "count of number of caches alongwith wan replication", "committedDate": "2020-06-30T10:14:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYyODg4Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17143#discussion_r447628883", "bodyText": "Since there is just 1 item in the map, I think we can set the initial capacity for that map correctly.", "author": "pveentjer", "createdAt": "2020-06-30T12:02:46Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CacheInfoCollector.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.cache.impl.CacheService;\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.core.DistributedObject;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+public class CacheInfoCollector implements MetricsCollector {\n+\n+    Collection<DistributedObject> caches;\n+\n+    @Override\n+    public Map<String, String> computeMetrics(Node hazelcastNode) {\n+\n+        Collection<DistributedObject> distributedObjects = hazelcastNode.hazelcastInstance.getDistributedObjects();\n+        caches = distributedObjects.stream().filter(distributedObject -> distributedObject.getServiceName().\n+                equals(CacheService.SERVICE_NAME)).collect(toList());\n+        Map<String, String> cacheInfo = new HashMap<>();", "originalCommit": "c2d89a276af76eaf077ebf1d6163a92132a91abe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMjExNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17143#discussion_r448212116", "bodyText": "Please make this class package-private (just like the other collector implementations).", "author": "erosb", "createdAt": "2020-07-01T08:44:43Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CacheInfoCollector.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.cache.impl.CacheService;\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.core.DistributedObject;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+public class CacheInfoCollector implements MetricsCollector {", "originalCommit": "c2d89a276af76eaf077ebf1d6163a92132a91abe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMjMyMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17143#discussion_r448212322", "bodyText": "Please make this member private. There is no reason to expose it.", "author": "erosb", "createdAt": "2020-07-01T08:45:03Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CacheInfoCollector.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.cache.impl.CacheService;\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.core.DistributedObject;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+public class CacheInfoCollector implements MetricsCollector {\n+\n+    Collection<DistributedObject> caches;", "originalCommit": "c2d89a276af76eaf077ebf1d6163a92132a91abe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7cadfc95c11a2abea03bdeff78450e551eb3b21b", "url": "https://github.com/hazelcast/hazelcast/commit/7cadfc95c11a2abea03bdeff78450e551eb3b21b", "message": "Improvised WAN relication alongwith code refactor", "committedDate": "2020-07-02T15:33:59Z", "type": "commit"}, {"oid": "ab94d37d66e59d4f6379b5a318da99eef83efed4", "url": "https://github.com/hazelcast/hazelcast/commit/ab94d37d66e59d4f6379b5a318da99eef83efed4", "message": "Add integration test for cache metrics", "committedDate": "2020-07-04T08:57:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0MTE4OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17143#discussion_r450041188", "bodyText": "I think in this case there is no reason to extract this into a separate method. It can go into computeMetrics() , and that will also eliminate the caches field and you can get the cawact metric in a single stream operation chain.", "author": "erosb", "createdAt": "2020-07-06T07:45:28Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CacheInfoCollector.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.cache.impl.CacheService;\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.core.DistributedObject;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+class CacheInfoCollector implements MetricsCollector {\n+\n+    private Collection<DistributedObject> caches;\n+\n+    @Override\n+    public Map<String, String> computeMetrics(Node hazelcastNode) {\n+\n+        Collection<DistributedObject> distributedObjects = hazelcastNode.hazelcastInstance.getDistributedObjects();\n+        caches = distributedObjects.stream().filter(distributedObject -> distributedObject.getServiceName().\n+                equals(CacheService.SERVICE_NAME)).collect(toList());\n+        Map<String, String> cacheInfo = new HashMap<>(1);\n+        cacheInfo.put(\"cawact\", String.valueOf(countCacheWithWANReplication(hazelcastNode)));\n+        return cacheInfo;\n+    }\n+\n+    private long countCacheWithWANReplication(Node node) {", "originalCommit": "ab94d37d66e59d4f6379b5a318da99eef83efed4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63fde5430aa3d0491ea4140dc80b37b14c3c0439", "url": "https://github.com/hazelcast/hazelcast/commit/63fde5430aa3d0491ea4140dc80b37b14c3c0439", "message": "Removed unnecessary separate method", "committedDate": "2020-07-07T09:14:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0ODc4OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17143#discussion_r451348788", "bodyText": "Does this pass checkstyle without the braces?", "author": "erosb", "createdAt": "2020-07-08T07:48:05Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CacheInfoCollector.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.cache.impl.CacheService;\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.core.DistributedObject;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+class CacheInfoCollector implements MetricsCollector {\n+\n+    @Override\n+    public Map<String, String> computeMetrics(Node hazelcastNode) {\n+        Map<String, String> cacheInfo = new HashMap<>(1);\n+\n+        Collection<DistributedObject> distributedObjects = hazelcastNode.hazelcastInstance.getDistributedObjects();\n+        long countCacheWithWANReplication = distributedObjects.stream().filter(distributedObject -> {\n+\n+            if (!distributedObject.getServiceName().equals(CacheService.SERVICE_NAME))\n+                return false;", "originalCommit": "63fde5430aa3d0491ea4140dc80b37b14c3c0439", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM1MDcxNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17143#discussion_r451350715", "bodyText": "This lambda is a bit too lenghty (for readability reasons it is good to keep lambdas small, my personal advice is no more than 3 lines). A complex predicate like this one can be broken up into multiple filter() calls, like first you filter by service name, and in the second you filter by config.wanReplicationRef. Please make this change, then we will examine the code again and refactor in one more iteration.", "author": "erosb", "createdAt": "2020-07-08T07:51:37Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CacheInfoCollector.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.cache.impl.CacheService;\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.core.DistributedObject;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+class CacheInfoCollector implements MetricsCollector {\n+\n+    @Override\n+    public Map<String, String> computeMetrics(Node hazelcastNode) {\n+        Map<String, String> cacheInfo = new HashMap<>(1);\n+\n+        Collection<DistributedObject> distributedObjects = hazelcastNode.hazelcastInstance.getDistributedObjects();\n+        long countCacheWithWANReplication = distributedObjects.stream().filter(distributedObject -> {", "originalCommit": "63fde5430aa3d0491ea4140dc80b37b14c3c0439", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d08de3c7caf2ec76158c31a0d8b685b109c9598f", "url": "https://github.com/hazelcast/hazelcast/commit/d08de3c7caf2ec76158c31a0d8b685b109c9598f", "message": "Refactor complex lambda into multiple filter calls\n\nRemoved redundant filter call\n\nRemoved checkstyle issues", "committedDate": "2020-07-08T10:43:43Z", "type": "commit"}, {"oid": "d08de3c7caf2ec76158c31a0d8b685b109c9598f", "url": "https://github.com/hazelcast/hazelcast/commit/d08de3c7caf2ec76158c31a0d8b685b109c9598f", "message": "Refactor complex lambda into multiple filter calls\n\nRemoved redundant filter call\n\nRemoved checkstyle issues", "committedDate": "2020-07-08T10:43:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTUyMjE5MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17143#discussion_r451522190", "bodyText": "Hello @chanmol1999 thanks for addressing my previous comment. Now if you look at the code, you can see that the lambda is still a little bit long, so we can think a bit about if we can break it up into more smaller strem operations: you can observe that\n\nthe filtering lambda uses only the config of the cache object\nno subsequent stream operation uses the cache object, that the stream operates on\n\nSo given this, first you can use the map() operation to map the cache object to its config, then change the current (second) filter to perform the check on the config, which then will be possible in a one-liner lambda.\nPlease let me know on gitter if anyhting is unclear.", "author": "erosb", "createdAt": "2020-07-08T12:55:25Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CacheInfoCollector.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.cache.impl.CacheService;\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.core.DistributedObject;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+class CacheInfoCollector implements MetricsCollector {\n+\n+    @Override\n+    public Map<String, String> computeMetrics(Node hazelcastNode) {\n+        Map<String, String> cacheInfo = new HashMap<>(1);\n+\n+        Collection<DistributedObject> distributedObjects = hazelcastNode.hazelcastInstance.getDistributedObjects();\n+        long countCacheWithWANReplication = distributedObjects.stream()\n+                .filter(distributedObject -> distributedObject.getServiceName().equals(CacheService.SERVICE_NAME))\n+                .filter(distributedObject -> {", "originalCommit": "d08de3c7caf2ec76158c31a0d8b685b109c9598f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8c901d3aa2468508abad932aa98cb91c5cc71077", "url": "https://github.com/hazelcast/hazelcast/commit/8c901d3aa2468508abad932aa98cb91c5cc71077", "message": "Improved stream filter using map operation\n\nUpdates", "committedDate": "2020-07-08T15:26:03Z", "type": "commit"}, {"oid": "8c901d3aa2468508abad932aa98cb91c5cc71077", "url": "https://github.com/hazelcast/hazelcast/commit/8c901d3aa2468508abad932aa98cb91c5cc71077", "message": "Improved stream filter using map operation\n\nUpdates", "committedDate": "2020-07-08T15:26:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY1MDQxOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17143#discussion_r451650419", "bodyText": "This lambda can be even further simplified into a one-liner expression, no statements, control structures are necessary. Please try to figure out how.", "author": "erosb", "createdAt": "2020-07-08T15:53:30Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CacheInfoCollector.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.cache.impl.CacheService;\n+import com.hazelcast.core.DistributedObject;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+class CacheInfoCollector implements MetricsCollector {\n+\n+    @Override\n+    public Map<String, String> computeMetrics(Node hazelcastNode) {\n+        Map<String, String> cacheInfo = new HashMap<>(1);\n+\n+        Collection<DistributedObject> distributedObjects = hazelcastNode.hazelcastInstance.getDistributedObjects();\n+        long countCacheWithWANReplication = distributedObjects.stream()\n+                .filter(distributedObject -> distributedObject.getServiceName().equals(CacheService.SERVICE_NAME))\n+                .map(distributedObject -> hazelcastNode.getConfig().findCacheConfigOrNull(distributedObject.getName()))\n+                .filter(cacheSimpleConfig -> {", "originalCommit": "8c901d3aa2468508abad932aa98cb91c5cc71077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15f683888ada95959613465e7d215e4a29bfb996", "url": "https://github.com/hazelcast/hazelcast/commit/15f683888ada95959613465e7d215e4a29bfb996", "message": "Modified filter operation", "committedDate": "2020-07-08T16:08:37Z", "type": "commit"}]}