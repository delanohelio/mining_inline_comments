{"pr_number": 16423, "pr_title": "Removed the dependencies on Data from the SplitBrainMergePolicy API", "pr_createdAt": "2020-01-07T15:25:34Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16423", "timeline": [{"oid": "d33446c84cba42c6b57d6ba483f5fc86ceb16255", "url": "https://github.com/hazelcast/hazelcast/commit/d33446c84cba42c6b57d6ba483f5fc86ceb16255", "message": "Removed the dependencies on Data from the SplitBrainMergePolicy API\n\nChanged MergingValue/MergingEntry so that the newly introduced\nmethods getRawValue/Key (which supersede the old getValue/Key)\nreturn the in-memory representation as Object. The deserialized\nvalue can be obtained using getDeserializedValue/Key.\n\nThe merge types in SplitBrainMergeType no longer depend on Data.\nInstead of specifying the in-memory storage type of the keys and\nvalues (Data), they specify the deserialized types. Also, the value\ntype has been removed from the various 'view' interfaces such as\nMergingHits, MergingCreationTime, etc.\n\nThe generic type signature of SplitBrainMergePolicy has changed\nto specify the (deserialized) type of the merging value; the\ntype of merging value object (typically, MergingValue<V>, but it can\nbe a composition like MergingEntry<String, V> & MergingHits); and\nfinally, the return type merge() method (typically Object for merge\npolicies that work with the in-memory storage type).", "committedDate": "2020-01-08T13:35:15Z", "type": "commit"}, {"oid": "9d921ad2bd3ec31268c39f636057a8c6b918cfb6", "url": "https://github.com/hazelcast/hazelcast/commit/9d921ad2bd3ec31268c39f636057a8c6b918cfb6", "message": "Introduced the common super-interface MergingView for\nMergingValue, MergingCosts etc.\n\nFixed MergePolicyValidator#checkRequiredMergeTypeClass\nby using MergingView instead of MergingValue (since\nMergingCosts etc. no longer extend MergingValue).", "committedDate": "2020-01-08T13:35:15Z", "type": "commit"}, {"oid": "4892d77867c09666145615b1b845121a90f1f803", "url": "https://github.com/hazelcast/hazelcast/commit/4892d77867c09666145615b1b845121a90f1f803", "message": "Updated copyright year in MergingView", "committedDate": "2020-01-08T13:38:40Z", "type": "commit"}, {"oid": "4892d77867c09666145615b1b845121a90f1f803", "url": "https://github.com/hazelcast/hazelcast/commit/4892d77867c09666145615b1b845121a90f1f803", "message": "Updated copyright year in MergingView", "committedDate": "2020-01-08T13:38:40Z", "type": "forcePushed"}, {"oid": "0d0caf9f63c038a87128afbf6d1e99cc959eb89f", "url": "https://github.com/hazelcast/hazelcast/commit/0d0caf9f63c038a87128afbf6d1e99cc959eb89f", "message": "Avoid calling toData in [AbstractCache|Default]RecordStore#merge", "committedDate": "2020-01-09T11:40:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI0Mjg2MA==", "url": "https://github.com/hazelcast/hazelcast/pull/16423#discussion_r365242860", "bodyText": "Minor: can you use Data key = (Data) mergingEntry.getRawKey(); instead, same in com.hazelcast.map.impl.recordstore.DefaultRecordStore?", "author": "mmedenjak", "createdAt": "2020-01-10T13:52:35Z", "path": "hazelcast/src/main/java/com/hazelcast/cache/impl/AbstractCacheRecordStore.java", "diffHunk": "@@ -1750,22 +1751,24 @@ public CacheRecord merge(CacheMergeTypes mergingEntry,\n         injectDependencies(mergePolicy);\n \n         boolean merged = false;\n-        Data key = mergingEntry.getKey();\n+        assert mergingEntry instanceof CacheMergingEntryImpl;\n+        CacheMergingEntryImpl<Object, Object> mergingEntryImpl = (CacheMergingEntryImpl<Object, Object>) mergingEntry;\n+        Data key = mergingEntryImpl.getRawKey();", "originalCommit": "0d0caf9f63c038a87128afbf6d1e99cc959eb89f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMxMzY1OA==", "url": "https://github.com/hazelcast/hazelcast/pull/16423#discussion_r365313658", "bodyText": "Done.", "author": "vojtechtoman", "createdAt": "2020-01-10T16:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI0Mjg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5NjIyNw==", "url": "https://github.com/hazelcast/hazelcast/pull/16423#discussion_r365296227", "bodyText": "naming this method as getValue can be clearer?", "author": "ahmetmircik", "createdAt": "2020-01-10T15:43:16Z", "path": "hazelcast/src/main/java/com/hazelcast/spi/merge/MergingValue.java", "diffHunk": "@@ -22,20 +22,19 @@\n  * @param <V> the type of the value\n  * @since 3.10\n  */\n-public interface MergingValue<V> {\n+public interface MergingValue<V> extends MergingView {\n \n     /**\n      * Returns the merging value in the in-memory format of the backing data structure.\n      *\n      * @return the merging value\n      */\n-    V getValue();\n+    Object getRawValue();\n \n     /**\n      * Returns the deserialized merging value.\n      *\n-     * @param <DV> the type of the deserialized value\n      * @return the deserialized merging value\n      */\n-    <DV> DV getDeserializedValue();\n+    V getDeserializedValue();", "originalCommit": "0d0caf9f63c038a87128afbf6d1e99cc959eb89f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5OTE1Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/16423#discussion_r365299156", "bodyText": "Thanks for spotting this. The idea was to implement your suggestion in #16159 (comment) but I clearly remembered it wrong. I will change the method name.", "author": "vojtechtoman", "createdAt": "2020-01-10T15:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5NjIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMxMzcxNg==", "url": "https://github.com/hazelcast/hazelcast/pull/16423#discussion_r365313716", "bodyText": "Done.", "author": "vojtechtoman", "createdAt": "2020-01-10T16:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5NjIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMxNjI5NA==", "url": "https://github.com/hazelcast/hazelcast/pull/16423#discussion_r365316294", "bodyText": "And did the same with MergingEntry#getDeserializedKey. It's getKey now.", "author": "vojtechtoman", "createdAt": "2020-01-10T16:22:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5NjIyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5ODkxOA==", "url": "https://github.com/hazelcast/hazelcast/pull/16423#discussion_r365298918", "bodyText": "minor: using shorter column width makes javaDoc easy to read for me, as in above copyright text.", "author": "ahmetmircik", "createdAt": "2020-01-10T15:48:21Z", "path": "hazelcast/src/main/java/com/hazelcast/spi/merge/MergingView.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.spi.merge;\n+\n+/**\n+ * Marker interface representing a read-only view of a data structure for the merging process after a split-brain.", "originalCommit": "0d0caf9f63c038a87128afbf6d1e99cc959eb89f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMxMzg0Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16423#discussion_r365313842", "bodyText": "Done.", "author": "vojtechtoman", "createdAt": "2020-01-10T16:17:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5ODkxOA=="}], "type": "inlineReview"}, {"oid": "a45c37bafaff96501c439d7dd0bcf592d31ce209", "url": "https://github.com/hazelcast/hazelcast/commit/a45c37bafaff96501c439d7dd0bcf592d31ce209", "message": "Renamed MergingValue#getDeserializedValue to getValue\n\n...and addressed other review comments (javadoc formatting, removed\ninstanceof assertions in [AbstractCache|Default]RecordStore).", "committedDate": "2020-01-10T16:14:05Z", "type": "commit"}, {"oid": "187532245456efbe36d6f6ad120b3a6a9e2c3fa4", "url": "https://github.com/hazelcast/hazelcast/commit/187532245456efbe36d6f6ad120b3a6a9e2c3fa4", "message": "Renamed MergingEntry#getDeserializedKey to getKey", "committedDate": "2020-01-10T16:21:07Z", "type": "commit"}]}