{"pr_number": 17366, "pr_title": "Reduce client results latency", "pr_createdAt": "2020-08-17T15:27:21Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17366", "timeline": [{"oid": "7a5a350c4de2840083e7c1064debd3f00e496f14", "url": "https://github.com/hazelcast/hazelcast/commit/7a5a350c4de2840083e7c1064debd3f00e496f14", "message": "Improve client performance\n\nStart fetching next page as soon as the previous page is ready to\niterate. Before: next page fetch was started after the first row after\nthe current page was requested. Cuts down the time for a query with many\nresult rows by 20% on localhost and more on a network, depending on the\nRTT.", "committedDate": "2020-08-17T12:20:40Z", "type": "commit"}, {"oid": "0dfd0d289cf12985c779352ed8861a67f700f89d", "url": "https://github.com/hazelcast/hazelcast/commit/0dfd0d289cf12985c779352ed8861a67f700f89d", "message": "Reduce client results latency", "committedDate": "2020-08-17T14:00:38Z", "type": "commit"}, {"oid": "3e173a69a9d4448039a499d5ba210facd426d293", "url": "https://github.com/hazelcast/hazelcast/commit/3e173a69a9d4448039a499d5ba210facd426d293", "message": "Reduce client results latency", "committedDate": "2020-08-17T14:16:26Z", "type": "commit"}, {"oid": "500aa994f4b425905f3185fb6a3af323fc700fa7", "url": "https://github.com/hazelcast/hazelcast/commit/500aa994f4b425905f3185fb6a3af323fc700fa7", "message": "Only use the minimum-latency mode if requested", "committedDate": "2020-08-17T15:22:31Z", "type": "commit"}, {"oid": "807210e1db24b7fa5d4fe7dbe5466de697fb359b", "url": "https://github.com/hazelcast/hazelcast/commit/807210e1db24b7fa5d4fe7dbe5466de697fb359b", "message": "Fix checkstyle", "committedDate": "2020-08-17T15:27:09Z", "type": "commit"}, {"oid": "986a2a04501424e92eb6c9adc76aebe4db3fee19", "url": "https://github.com/hazelcast/hazelcast/commit/986a2a04501424e92eb6c9adc76aebe4db3fee19", "message": "Fix test failure and improve the test", "committedDate": "2020-08-18T07:07:46Z", "type": "commit"}, {"oid": "057e19e0970bba6f7ea8465bf807fc08126d0d61", "url": "https://github.com/hazelcast/hazelcast/commit/057e19e0970bba6f7ea8465bf807fc08126d0d61", "message": "Merge branch 'sql' of ssh://github.com/hazelcast/hazelcast into sql", "committedDate": "2020-08-18T07:08:14Z", "type": "commit"}, {"oid": "a2d8814022a43a574b16b5a80d85e5b14b334ff9", "url": "https://github.com/hazelcast/hazelcast/commit/a2d8814022a43a574b16b5a80d85e5b14b334ff9", "message": "Merge branch 'sql' into sql-client-performance\n\n# Conflicts:\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/exec/root/BlockingRootResultConsumer.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/state/QueryClientStateRegistry.java", "committedDate": "2020-08-18T07:09:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk2ODQ5NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r471968495", "bodyText": "I vote for avoiding this asynchrony now. It complicates things while at the same time it is not proven that it brings anything in real use cases. The current implementation has two issues:\n\nIt lacks synchronization on close/cancel. One of the typical use cases is closing the cursor from the other thread, not the same. Even JDBC standard assumes such usage pattern\nWe do not want to have request-response flow at all. In the mid-term, we are going to rework client communication to streaming mode, when multiple responses are sent from the server to the client. This will make the current implementation obsolete. And it is likely to happen very soon.", "author": "devozerov", "createdAt": "2020-08-18T07:24:16Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/client/SqlClientResult.java", "diffHunk": "@@ -49,6 +50,7 @@\n \n     private boolean closed;\n     private boolean iteratorAccessed;\n+    private ClientInvocationFuture pendingPageFuture;", "originalCommit": "a2d8814022a43a574b16b5a80d85e5b14b334ff9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAwNDE1MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r472004151", "bodyText": "I don't agree, but i'm removing this part. It's kind of unrelated to the main issue. Btw, the rest of the close method also isn't thread safe.\nThe benefit is: you don't initiate the round trip after you're done with the previous batch, but you initiate it as you start processing it. Clients with longer RTT and doing non-trivial processing with the rows will benefit the most. Having it will not prevent us to switch to streaming mode in the future.", "author": "viliam-durina", "createdAt": "2020-08-18T08:24:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk2ODQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA2NjcwOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r472066709", "bodyText": "Yes, there definitely benefits for non-trivial processing. And perhaps it is more prevalent in streaming, than in IMDG cases.\nThe \"streaming\" client communication mode I mentioned is likely to work very differently even comparing to the current implementation in master. As the client team explained to me, the protocol is designed in a way to allow for sending chunks of data one after the other from the server without an explicit request from the client. So it is likely that the final implementation of the protocol will send just one request to the server, and then read chunks continuously with some sort of backpressure.\nIt is likely that we will implement that soon because this is a breaking change, and we cannot be in the beta forever.", "author": "devozerov", "createdAt": "2020-08-18T10:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk2ODQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA3MTgyNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r472071824", "bodyText": "Yeah, but why not do simple improvements to the current version?...", "author": "viliam-durina", "createdAt": "2020-08-18T10:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk2ODQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA4ODAyMA==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r472088020", "bodyText": "My concern is that it is not well aligned with the planned protocol and JDBC changes, so it will increase the design and implementation burden.\nMaybe let's merge it to master as is, and prepare the PR for this change separately, and then listen for client team opinion? This way we will merge the main part, where we have a consensus, quickly.", "author": "devozerov", "createdAt": "2020-08-18T10:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk2ODQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk3MTcxOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r471971719", "bodyText": "Can we convert int constants to enum? This will make methods relying on these constants easier to understand and refactor.\nAlso, ResultIterator could be a top-level class.", "author": "devozerov", "createdAt": "2020-08-18T07:29:34Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/AbstractSqlResult.java", "diffHunk": "@@ -17,15 +17,51 @@\n package com.hazelcast.sql.impl;\n \n import com.hazelcast.sql.SqlResult;\n+import com.hazelcast.sql.SqlRow;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Iterator;\n \n public abstract class AbstractSqlResult implements SqlResult {\n \n     public abstract QueryId getQueryId();\n \n     public abstract void closeOnError(QueryException exception);\n \n+    @Nonnull @Override\n+    public abstract ResultIterator<SqlRow> iterator();\n+\n     @Override\n     public void close() {\n         closeOnError(QueryException.cancelledByUser());\n     }\n+\n+    public interface ResultIterator<T> extends Iterator<T> {\n+\n+        /**\n+         * A result value from {@link #hasNextImmediately()} meaning that a next\n+         * item is available immediately.\n+         */\n+        int YES = 2;", "originalCommit": "a2d8814022a43a574b16b5a80d85e5b14b334ff9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAwNjUzMQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r472006531", "bodyText": "fixed", "author": "viliam-durina", "createdAt": "2020-08-18T08:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk3MTcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk3MjUyMA==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r471972520", "bodyText": "Minor: a better name for this would be something like waitForFullBatch.", "author": "devozerov", "createdAt": "2020-08-18T07:30:43Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/exec/root/BlockingRootResultConsumer.java", "diffHunk": "@@ -33,6 +33,9 @@\n     /** Iterator over produced rows. */\n     private final InternalIterator iterator = new InternalIterator();\n \n+    /** Enables {@link ResultIterator#RETRY} result from {@link ResultIterator#hasNextImmediately()} */\n+    private final boolean useMinimumLatency;", "originalCommit": "a2d8814022a43a574b16b5a80d85e5b14b334ff9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAwNTc3MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r472005770", "bodyText": "fixed", "author": "viliam-durina", "createdAt": "2020-08-18T08:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk3MjUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk3NTQ1NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r471975454", "bodyText": "I do not quite understand how it affects IMDG. Consider that the batch is not available immediately for IMDG. Will it stop waiting for results and return a semi-filled batch back to the client?", "author": "devozerov", "createdAt": "2020-08-18T07:35:27Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/state/QueryClientStateRegistry.java", "diffHunk": "@@ -94,24 +94,27 @@ private SqlPage fetchInternal(\n     }\n \n     private static boolean fetchPage(\n-        Iterator<SqlRow> iterator,\n+        ResultIterator<SqlRow> iterator,\n         List<List<Data>> page,\n         int cursorBufferSize,\n         InternalSerializationService serializationService\n     ) {\n-        while (iterator.hasNext()) {\n+        assert cursorBufferSize > 0;\n+\n+        if (!iterator.hasNext()) {\n+            return true;\n+        }\n+\n+        int res;\n+        do {\n             SqlRow row = iterator.next();\n             List<Data> convertedRow = convertRow(row, serializationService);\n \n             page.add(convertedRow);\n+            res = iterator.hasNextImmediately();", "originalCommit": "a2d8814022a43a574b16b5a80d85e5b14b334ff9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAwNjQxNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r472006417", "bodyText": "Yes, if waitForFullBatch is false. For IMDG queries, it's always true, in this case this call will block until next item is availabye. The return value will never be RETRY.", "author": "viliam-durina", "createdAt": "2020-08-18T08:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk3NTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA2Njk5MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17366#discussion_r472066990", "bodyText": "Got it, thanks.", "author": "devozerov", "createdAt": "2020-08-18T10:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk3NTQ1NA=="}], "type": "inlineReview"}, {"oid": "523c6a5649801e2bcad95e1e3f6feba23eb733a0", "url": "https://github.com/hazelcast/hazelcast/commit/523c6a5649801e2bcad95e1e3f6feba23eb733a0", "message": "Revert \"Improve client performance\"\n\nThis reverts commit 7a5a350c4de2840083e7c1064debd3f00e496f14.", "committedDate": "2020-08-18T08:24:47Z", "type": "commit"}, {"oid": "51fafae2871702461ff8d32ae2297864e0f088b4", "url": "https://github.com/hazelcast/hazelcast/commit/51fafae2871702461ff8d32ae2297864e0f088b4", "message": "Renaming", "committedDate": "2020-08-18T08:26:35Z", "type": "commit"}, {"oid": "1143b2050f8c7f355ea794782c7320bdd5c33d83", "url": "https://github.com/hazelcast/hazelcast/commit/1143b2050f8c7f355ea794782c7320bdd5c33d83", "message": "Move ResultIterator to top-level class, return enum", "committedDate": "2020-08-18T08:43:30Z", "type": "commit"}, {"oid": "903248a865af8bd3f1ce4e314aa56ab1a1dc0d9b", "url": "https://github.com/hazelcast/hazelcast/commit/903248a865af8bd3f1ce4e314aa56ab1a1dc0d9b", "message": "Touchups", "committedDate": "2020-08-18T08:57:12Z", "type": "commit"}, {"oid": "6edff63160b1b3b9c52c2d09198337fae31d8e66", "url": "https://github.com/hazelcast/hazelcast/commit/6edff63160b1b3b9c52c2d09198337fae31d8e66", "message": "Fix checkstyle", "committedDate": "2020-08-18T09:59:53Z", "type": "commit"}]}