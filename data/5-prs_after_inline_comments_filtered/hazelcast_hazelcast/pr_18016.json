{"pr_number": 18016, "pr_title": "Support OBJECT type in comparison operators", "pr_createdAt": "2020-12-29T14:04:23Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/18016", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NTYzMw==", "url": "https://github.com/hazelcast/hazelcast/pull/18016#discussion_r549775633", "bodyText": "The check for class should be performed only for operands of OBJECT type since for all other operand types, we know for sure that they are comparable, and of the same type.", "author": "devozerov", "createdAt": "2020-12-29T16:54:16Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/expression/predicate/ComparisonPredicate.java", "diffHunk": "@@ -77,6 +78,13 @@ public Boolean eval(Row row, ExpressionEvalContext context) {\n             return null;\n         }\n \n+        Class<?> leftClass = left.getClass();\n+        Class<?> rightClass = right.getClass();\n+\n+        if (!(left instanceof Comparable && leftClass.equals(rightClass))) {", "originalCommit": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NzQxMA==", "url": "https://github.com/hazelcast/hazelcast/pull/18016#discussion_r549777410", "bodyText": "It is not very obvious from the message what does \"incomparable\" mean. Better messages could be (rough examples):\n\nIf the object is not comparable: Cannot compare OBJECT value because it doesn't implement Comparable interface\nIf objects are of different types: Cannot compare two OBJECT values, because they have different classes", "author": "devozerov", "createdAt": "2020-12-29T16:59:29Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/expression/predicate/ComparisonPredicate.java", "diffHunk": "@@ -77,6 +78,13 @@ public Boolean eval(Row row, ExpressionEvalContext context) {\n             return null;\n         }\n \n+        Class<?> leftClass = left.getClass();\n+        Class<?> rightClass = right.getClass();\n+\n+        if (!(left instanceof Comparable && leftClass.equals(rightClass))) {\n+            throw QueryException.error(\"trying to compare two incomparable objects\");", "originalCommit": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3ODAxNg==", "url": "https://github.com/hazelcast/hazelcast/pull/18016#discussion_r549778016", "bodyText": "We now do not have tests for OBJECT vs non-OBJECT compares.", "author": "devozerov", "createdAt": "2020-12-29T17:00:37Z", "path": "hazelcast-sql-core/src/test/java/com/hazelcast/sql/impl/expression/predicate/ComparisonPredicateIntegrationTest.java", "diffHunk": "@@ -223,7 +224,51 @@ public void testUnsupported() {\n         checkUnsupportedColumnColumn(ExpressionTypes.LOCAL_TIME, ExpressionTypes.allExcept());\n         checkUnsupportedColumnColumn(ExpressionTypes.LOCAL_DATE_TIME, ExpressionTypes.allExcept());\n         checkUnsupportedColumnColumn(ExpressionTypes.OFFSET_DATE_TIME, ExpressionTypes.allExcept());\n-        checkUnsupportedColumnColumn(ExpressionTypes.OBJECT, ExpressionTypes.allExcept());", "originalCommit": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU4MzI1Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/18016#discussion_r555583253", "bodyText": "consider printing the actual class.\nmore diagnostics could be very useful here. for example with Portable object it would be good to know its class/factory IDs.\notherwise it's hard to tell what actually went wrong and how to fix it.", "author": "jerrinot", "createdAt": "2021-01-12T08:15:50Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/expression/predicate/ComparisonPredicate.java", "diffHunk": "@@ -77,6 +79,20 @@ public Boolean eval(Row row, ExpressionEvalContext context) {\n             return null;\n         }\n \n+        if (this.operand1.getType().getTypeFamily() == QueryDataTypeFamily.OBJECT) {\n+            Class<?> leftClass = left.getClass();\n+            Class<?> rightClass = right.getClass();\n+\n+            if (!leftClass.equals(rightClass)) {\n+                throw QueryException.error(\"Cannot compare two OBJECT values, because they have different classes\");", "originalCommit": "204c10d84dfb1fdfeab435fbd765e45d045ad9ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6c5a8306b25438fa2f2d30a5f11caa14b2e01856", "url": "https://github.com/hazelcast/hazelcast/commit/6c5a8306b25438fa2f2d30a5f11caa14b2e01856", "message": "Support OBJECT type in comparison operators", "committedDate": "2021-01-15T11:36:30Z", "type": "commit"}, {"oid": "199549dfada196d2872cf87d8f3d2b2fb0261aaa", "url": "https://github.com/hazelcast/hazelcast/commit/199549dfada196d2872cf87d8f3d2b2fb0261aaa", "message": "fix checkstyle", "committedDate": "2021-01-15T11:36:33Z", "type": "commit"}, {"oid": "c2b67ba9184858586ec06c142fffc24e6efb8b57", "url": "https://github.com/hazelcast/hazelcast/commit/c2b67ba9184858586ec06c142fffc24e6efb8b57", "message": "update test", "committedDate": "2021-01-15T11:36:33Z", "type": "commit"}, {"oid": "5d5b1b6ea84534c5ef412bade2c91c1c1c180b63", "url": "https://github.com/hazelcast/hazelcast/commit/5d5b1b6ea84534c5ef412bade2c91c1c1c180b63", "message": "address review comments", "committedDate": "2021-01-15T11:38:47Z", "type": "commit"}, {"oid": "006b5233cd0a35f2483dcd544e9fab67b4b211f9", "url": "https://github.com/hazelcast/hazelcast/commit/006b5233cd0a35f2483dcd544e9fab67b4b211f9", "message": "added class names in query error messages", "committedDate": "2021-01-15T11:38:49Z", "type": "commit"}, {"oid": "c0730341e5bac89609e658b323ee5a7ab16ae453", "url": "https://github.com/hazelcast/hazelcast/commit/c0730341e5bac89609e658b323ee5a7ab16ae453", "message": "fix tests", "committedDate": "2021-01-15T11:38:50Z", "type": "commit"}, {"oid": "bcefa1fd725661c8712e9565c82f115dc1b15cc3", "url": "https://github.com/hazelcast/hazelcast/commit/bcefa1fd725661c8712e9565c82f115dc1b15cc3", "message": "rebase with master", "committedDate": "2021-01-15T11:50:03Z", "type": "commit"}, {"oid": "bcefa1fd725661c8712e9565c82f115dc1b15cc3", "url": "https://github.com/hazelcast/hazelcast/commit/bcefa1fd725661c8712e9565c82f115dc1b15cc3", "message": "rebase with master", "committedDate": "2021-01-15T11:50:03Z", "type": "forcePushed"}]}