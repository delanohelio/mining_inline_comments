{"pr_number": 17348, "pr_title": "Environment variables/system properties config override mechanism", "pr_createdAt": "2020-08-14T11:40:01Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17348", "timeline": [{"oid": "5097b821478d752d453629dfae93bde35c2fcfcc", "url": "https://github.com/hazelcast/hazelcast/commit/5097b821478d752d453629dfae93bde35c2fcfcc", "message": "Introduce env-based config overrides", "committedDate": "2020-08-14T11:51:20Z", "type": "forcePushed"}, {"oid": "16021d749fa875746bd81d3d1b679fdb2659ab36", "url": "https://github.com/hazelcast/hazelcast/commit/16021d749fa875746bd81d3d1b679fdb2659ab36", "message": "Return value as optional", "committedDate": "2020-08-14T12:23:54Z", "type": "forcePushed"}, {"oid": "90329547cba2de2c5f568c64a5856935ef7a19ff", "url": "https://github.com/hazelcast/hazelcast/commit/90329547cba2de2c5f568c64a5856935ef7a19ff", "message": "Return value as optional", "committedDate": "2020-08-14T12:43:11Z", "type": "forcePushed"}, {"oid": "188187a6b631cea36ffc51cceb404ccdae0000f2", "url": "https://github.com/hazelcast/hazelcast/commit/188187a6b631cea36ffc51cceb404ccdae0000f2", "message": "Return value as optional", "committedDate": "2020-08-14T13:27:28Z", "type": "forcePushed"}, {"oid": "4a4d970913c38359be46b4db48df977719206fa1", "url": "https://github.com/hazelcast/hazelcast/commit/4a4d970913c38359be46b4db48df977719206fa1", "message": "Return value as optional", "committedDate": "2020-08-14T13:56:04Z", "type": "forcePushed"}, {"oid": "9d1a18205506b138720c2b5e48d8293ad574f04c", "url": "https://github.com/hazelcast/hazelcast/commit/9d1a18205506b138720c2b5e48d8293ad574f04c", "message": "Return value as optional", "committedDate": "2020-08-14T14:11:28Z", "type": "forcePushed"}, {"oid": "cc24e257e5bb707183fc2ac017824014b33b59e8", "url": "https://github.com/hazelcast/hazelcast/commit/cc24e257e5bb707183fc2ac017824014b33b59e8", "message": "Return value as optional", "committedDate": "2020-08-14T14:21:59Z", "type": "forcePushed"}, {"oid": "1ba48aa52f13ea4b4c359e8ce5627015ce27f2e4", "url": "https://github.com/hazelcast/hazelcast/commit/1ba48aa52f13ea4b4c359e8ce5627015ce27f2e4", "message": "Introduce env-based config overrides", "committedDate": "2020-08-14T14:37:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyMjAwMA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r471322000", "bodyText": "Consider making it less generic, like to have two methods overwrite(Config config) and overwriteClient(ClientConfig clientConfig). Then, you'd not need these clientConfigProcessor() and memberConfigProcessor() which IMO complicate understanding of the code.", "author": "leszko", "createdAt": "2020-08-17T08:28:04Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.client.config.impl.ClientDomConfigProcessor;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.internal.config.MemberDomConfigProcessor;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.BiConsumer;\n+\n+import static java.lang.String.format;\n+\n+public class ExternalConfigurationOverride<T> {\n+\n+    private static final ILogger LOGGER = Logger.getLogger(ExternalConfigurationOverride.class);\n+\n+    private final Set<ConfigProvider> configProviders;\n+\n+    private final BiConsumer<ConfigProvider, T> configProcessor;\n+\n+    ExternalConfigurationOverride(BiConsumer<ConfigProvider, T> configProcessor, ConfigProvider... providers) {\n+        this.configProcessor = configProcessor;\n+        this.configProviders = new HashSet<>(Arrays.asList(providers));\n+    }\n+\n+    public static ExternalConfigurationOverride<Config> member() {\n+        return new ExternalConfigurationOverride<>(\n+          memberConfigProcessor(),\n+          new EnvConfigProvider(EnvVariablesConfigParser.member()),\n+          new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.member()));\n+    }\n+\n+    public static ExternalConfigurationOverride<ClientConfig> client() {\n+        return new ExternalConfigurationOverride<>(\n+          clientConfigProcessor(),\n+          new EnvConfigProvider(EnvVariablesConfigParser.client()),\n+          new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.client()));\n+    }\n+\n+    public T overwrite(T config) {", "originalCommit": "d78693fc55b21c043a85836d95e07dfd79757d03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM3NjQxMw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r471376413", "bodyText": "I will try to simplify it, what I'm trying to avoid duplicating code responsible for validation, iteration, and application of parsed configs... while making it testable at the same time", "author": "pivovarit", "createdAt": "2020-08-17T10:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyMjAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzNzcwMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r471337702", "bodyText": "I wonder if it's not a too strong assumption that every variable starting from HZ_ is a Hazelcast Configuration. Not sure it's good enough. Maybe we need to parse and check which env variables are really a part of Hazelcast Configuration.\n3 scenarios to consider:\n\nRandom env variable.\n\nStart with a variable: HZ_BLA_BLA=false. You get the following log:\nINFO: Detected external configuration overrides in environment variables:\nbla.bla=false\n\nWhich is later ignored. It can be confusing to users.\n\nOur Docker image default environment variables\nYou don't define any env variables, but you still get the following logs.\n\n$ docker run test\n...\nAug 17, 2020 8:53:31 AM com.hazelcast.internal.config.override.ExternalConfigurationOverride\nINFO: Detected external configuration overrides in environment variables:\nhome=/opt/hazelcast\n\n\nWe currently use HZ_LICENSE_KEY for the Hazelcast Enterprise Docker image\nCheck this: https://github.com/hazelcast/hazelcast-docker#hazelcast-enterprise", "author": "leszko", "createdAt": "2020-08-17T08:56:03Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.client.config.impl.ClientDomConfigProcessor;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.internal.config.MemberDomConfigProcessor;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.BiConsumer;\n+\n+import static java.lang.String.format;\n+\n+public class ExternalConfigurationOverride<T> {\n+\n+    private static final ILogger LOGGER = Logger.getLogger(ExternalConfigurationOverride.class);\n+\n+    private final Set<ConfigProvider> configProviders;\n+\n+    private final BiConsumer<ConfigProvider, T> configProcessor;\n+\n+    ExternalConfigurationOverride(BiConsumer<ConfigProvider, T> configProcessor, ConfigProvider... providers) {\n+        this.configProcessor = configProcessor;\n+        this.configProviders = new HashSet<>(Arrays.asList(providers));\n+    }\n+\n+    public static ExternalConfigurationOverride<Config> member() {\n+        return new ExternalConfigurationOverride<>(\n+          memberConfigProcessor(),\n+          new EnvConfigProvider(EnvVariablesConfigParser.member()),\n+          new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.member()));\n+    }\n+\n+    public static ExternalConfigurationOverride<ClientConfig> client() {\n+        return new ExternalConfigurationOverride<>(\n+          clientConfigProcessor(),\n+          new EnvConfigProvider(EnvVariablesConfigParser.client()),\n+          new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.client()));\n+    }\n+\n+    public T overwrite(T config) {\n+        ConfigValidator.validate(configProviders);\n+\n+        for (ConfigProvider configProvider : configProviders) {\n+            Map<String, String> properties = configProvider.properties();\n+\n+            if (properties.size() > 0) {", "originalCommit": "d78693fc55b21c043a85836d95e07dfd79757d03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM4MDc2MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r471380760", "bodyText": "The problem is that we don't have any way to validate if an entry is a part of the configuration or not. It's like entering a non-existing entry into a YAML file.\nOur configuration is essentially a huge tree used for lookups by individual parsers, validated only by the XML schema.\nNaturally, we can exclude existing config entries (like the Dockerfile ones), but I'm afraid this would need to be done manually at the filtering stage.", "author": "pivovarit", "createdAt": "2020-08-17T10:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzNzcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0MzU5MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r471343591", "bodyText": "Consider changing the name, two options:\n\nName it the same the same as in the *.yaml.* package: ElementAdapter.\nRename it to ConfigOverrideElementAdapter (and maybe rename also ElementAdapter to YamlElementAdapter).\n\nBecause it gets congusing imo.", "author": "leszko", "createdAt": "2020-08-17T09:06:47Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigNodeElementAdapter.java", "diffHunk": "@@ -0,0 +1,382 @@\n+package com.hazelcast.internal.config.override;\n+\n+import org.w3c.dom.Attr;\n+import org.w3c.dom.DOMException;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.NamedNodeMap;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.TypeInfo;\n+import org.w3c.dom.UserDataHandler;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+class ConfigNodeElementAdapter implements Element {", "originalCommit": "d78693fc55b21c043a85836d95e07dfd79757d03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ee1c2fb540902c3e1127d2e979b0425165df8cbc", "url": "https://github.com/hazelcast/hazelcast/commit/ee1c2fb540902c3e1127d2e979b0425165df8cbc", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T08:52:36Z", "type": "forcePushed"}, {"oid": "20ea1a4b22bd9fecba24384ff33496bc948ed4af", "url": "https://github.com/hazelcast/hazelcast/commit/20ea1a4b22bd9fecba24384ff33496bc948ed4af", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T09:53:22Z", "type": "forcePushed"}, {"oid": "dfea0e403e5674acd235f8cc069e58a2cd5cb868", "url": "https://github.com/hazelcast/hazelcast/commit/dfea0e403e5674acd235f8cc069e58a2cd5cb868", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T10:04:36Z", "type": "forcePushed"}, {"oid": "1262f4d61a99271578757c4dcae8931c569286a6", "url": "https://github.com/hazelcast/hazelcast/commit/1262f4d61a99271578757c4dcae8931c569286a6", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T10:12:08Z", "type": "forcePushed"}, {"oid": "c2c082ab2d44181578747785519c8dee535dde8b", "url": "https://github.com/hazelcast/hazelcast/commit/c2c082ab2d44181578747785519c8dee535dde8b", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T10:29:09Z", "type": "forcePushed"}, {"oid": "3715d4bef7a7316dd52f5701c5bf6cc6be6a5c28", "url": "https://github.com/hazelcast/hazelcast/commit/3715d4bef7a7316dd52f5701c5bf6cc6be6a5c28", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T10:54:06Z", "type": "forcePushed"}, {"oid": "50cd4e095bb2ebb915bd7109988f4d5058c8a666", "url": "https://github.com/hazelcast/hazelcast/commit/50cd4e095bb2ebb915bd7109988f4d5058c8a666", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T11:23:42Z", "type": "forcePushed"}, {"oid": "a3ac4bb9415112c12600f5043de4f411bbf895ef", "url": "https://github.com/hazelcast/hazelcast/commit/a3ac4bb9415112c12600f5043de4f411bbf895ef", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T14:28:04Z", "type": "forcePushed"}, {"oid": "114586c217223379355c41d9046d06dbbdd29e08", "url": "https://github.com/hazelcast/hazelcast/commit/114586c217223379355c41d9046d06dbbdd29e08", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.", "committedDate": "2020-08-21T15:08:30Z", "type": "forcePushed"}, {"oid": "1302d5f0ca2f8420d9b59bbab81640badae873cd", "url": "https://github.com/hazelcast/hazelcast/commit/1302d5f0ca2f8420d9b59bbab81640badae873cd", "message": "Use Yaml processors", "committedDate": "2020-08-24T06:22:14Z", "type": "forcePushed"}, {"oid": "3a7c00d0964496776344faf75ba545a41d464645", "url": "https://github.com/hazelcast/hazelcast/commit/3a7c00d0964496776344faf75ba545a41d464645", "message": "Use Yaml processors", "committedDate": "2020-08-24T06:29:23Z", "type": "forcePushed"}, {"oid": "a85b5b6e175f36d4415568dab35e3499ac93a3e3", "url": "https://github.com/hazelcast/hazelcast/commit/a85b5b6e175f36d4415568dab35e3499ac93a3e3", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.\n\nRules for environment variables conversion:\n- each entry needs to be prefixed with either `HZ_` or `HZCLIENT_`\n- each configuration key needs to be uppercased\n- `_` introduces a new configuration level\n- each `-` needs to be ignored\n\nRules for system properties conversion:\n- each entry needs to be prefixed with `hz.` or `hz-client.`\n- each configuration key needs to be lowercased\n\nIf the same configuration key is duplicated, an exception is raised.", "committedDate": "2020-08-24T09:08:28Z", "type": "forcePushed"}, {"oid": "a4be7f7fdc6e4f734b69d0e5dafc8a1b4155b61a", "url": "https://github.com/hazelcast/hazelcast/commit/a4be7f7fdc6e4f734b69d0e5dafc8a1b4155b61a", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.\n\nRules for environment variables conversion:\n- each entry needs to be prefixed with either `HZ_` or `HZCLIENT_`\n- each configuration key needs to be uppercased\n- `_` introduces a new configuration level\n- each `-` needs to be ignored\n\nRules for system properties conversion:\n- each entry needs to be prefixed with `hz.` or `hz-client.`\n- each configuration key needs to be lowercased\n\nIf the same configuration key is duplicated, an exception is raised.", "committedDate": "2020-08-24T09:22:52Z", "type": "forcePushed"}, {"oid": "aba2757fbc7e945b165f5e264eb55bb0b032cb34", "url": "https://github.com/hazelcast/hazelcast/commit/aba2757fbc7e945b165f5e264eb55bb0b032cb34", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.\n\nRules for environment variables conversion:\n- each entry needs to be prefixed with either `HZ_` or `HZCLIENT_`\n- each configuration key needs to be uppercased\n- `_` introduces a new configuration level\n- each `-` needs to be ignored\n\nRules for system properties conversion:\n- each entry needs to be prefixed with `hz.` or `hz-client.`\n- each configuration key needs to be lowercased\n\nIf the same configuration key is duplicated, an exception is raised.", "committedDate": "2020-08-24T10:30:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4MjA3NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475582074", "bodyText": "Does this change mean that from now on the configuration with - and without - is the same. For example, can you now define the following hazelcast.yaml?\nhazelcast:\n  clustername: mycluster\n\nAnd is it exactly the same as:\nhazelcast:\n  cluster-name: mycluster", "author": "leszko", "createdAt": "2020-08-24T12:59:29Z", "path": "hazelcast/src/main/java/com/hazelcast/client/config/impl/ClientDomConfigProcessor.java", "diffHunk": "@@ -216,15 +218,15 @@ private void handleConnectionRetry(Node node, ClientConnectionStrategyConfig str\n         for (Node child : childElements(node)) {\n             String nodeName = cleanNodeName(child);\n             String value = getTextContent(child).trim();\n-            if (initialBackoffMillis.equals(nodeName)) {\n+            if (ConfigUtils.matches(initialBackoffMillis, nodeName)) {", "originalCommit": "aba2757fbc7e945b165f5e264eb55bb0b032cb34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY2NDAxOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475664019", "bodyText": "That's true, but in one of the discussions I heard that it's not a problem and that we might have a JSON schema anyway", "author": "pivovarit", "createdAt": "2020-08-24T14:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4MjA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2NTM0NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480065344", "bodyText": "Hmm, I wonder if it's not an issue when it comes to maintenance and backward-compatibility. Like, this becomes now a valid Hazelcast configuration:\nhazelcast:\n  cluster--name: mycluster\n\nIt's weird, but ok, we can say it's incorrect, but we just didn't validate it. However, these two configurations above, at first glance, both look correct. People may start using them and then at some point... booom, we introduce JSON schema validation.\nWhat do you think? @mmedenjak @jerrinot @Holmistr", "author": "leszko", "createdAt": "2020-08-31T11:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4MjA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5MzczNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480193735", "bodyText": "As mentioned, we can introduce some kind of flag which will disallow such config if a YAML file is provided but matches only when applying config from env variables and sys props. And we can do this after feature freeze or in a patch release.", "author": "mmedenjak", "createdAt": "2020-08-31T15:07:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4MjA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4MzgwNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475583804", "bodyText": "Why don't you use matches here (as in all other cases)?", "author": "leszko", "createdAt": "2020-08-24T13:02:33Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/MemberDomConfigProcessor.java", "diffHunk": "@@ -256,7 +257,8 @@ public void buildConfig(Node rootNode) throws Exception {\n             }\n         }\n \n-        if (occurrenceSet.contains(\"network\") && occurrenceSet.contains(\"advanced-network\")\n+        if (occurrenceSet.contains(\"network\")\n+          && (occurrenceSet.contains(\"advanced-network\") || occurrenceSet.contains(\"advancednetwork\"))", "originalCommit": "aba2757fbc7e945b165f5e264eb55bb0b032cb34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY2MTU1Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475661557", "bodyText": "That's a bit different use-case, but I will rework it", "author": "pivovarit", "createdAt": "2020-08-24T14:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4MzgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4Nzg2Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475587867", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A representation of a single configuration node\n          \n          \n            \n             * A representation of a single configuration node.", "author": "leszko", "createdAt": "2020-08-24T13:09:54Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigNode.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * A representation of a single configuration node", "originalCommit": "aba2757fbc7e945b165f5e264eb55bb0b032cb34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0Mjg5OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475642898", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Validation mechanism used to make sure that external configuration features is legal\n          \n          \n            \n             * Validation mechanism used to make sure that external configuration features is legal.", "author": "leszko", "createdAt": "2020-08-24T14:13:17Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigOverrideValidator.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Validation mechanism used to make sure that external configuration features is legal", "originalCommit": "aba2757fbc7e945b165f5e264eb55bb0b032cb34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0NDk4MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475644981", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * An interface representing a generic configuration source\n          \n          \n            \n             * An interface representing a generic configuration source.", "author": "leszko", "createdAt": "2020-08-24T14:16:06Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigProvider.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.Map;\n+\n+/**\n+ * An interface representing a generic configuration source", "originalCommit": "aba2757fbc7e945b165f5e264eb55bb0b032cb34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0NTA4NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475645084", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns an immutable set of key-value configuration entries\n          \n          \n            \n                 * Returns an immutable set of key-value configuration entries.", "author": "leszko", "createdAt": "2020-08-24T14:16:15Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigProvider.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.Map;\n+\n+/**\n+ * An interface representing a generic configuration source\n+ */\n+interface ConfigProvider {\n+\n+    /**\n+     * Returns an immutable set of key-value configuration entries", "originalCommit": "aba2757fbc7e945b165f5e264eb55bb0b032cb34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY4NjMwOA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475686308", "bodyText": "Nitpicker. We have @mtopolnik for this! :-D", "author": "Holmistr", "createdAt": "2020-08-24T15:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0NTA4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY4ODIwNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475688204", "bodyText": "Would be cheaper to use some non-protein-based static analysis tool :)", "author": "pivovarit", "createdAt": "2020-08-24T15:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0NTA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0NjY5Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475646692", "bodyText": "When would you have whitespace inside an env variable name?", "author": "leszko", "createdAt": "2020-08-24T14:18:41Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/EnvVariablesConfigParser.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * A utility class converting raw input properties into valid config entries\n+ */\n+class EnvVariablesConfigParser {\n+    private static final List<String> EXCLUDED_ENTRIES = Arrays.asList(\n+      \"HZ_HOME\", \"HZ_LICENSE_KEY\");\n+\n+    private final String prefix;\n+    private final String rootNode;\n+\n+    EnvVariablesConfigParser(String prefix, String rootNode) {\n+        this.prefix = prefix;\n+        this.rootNode = rootNode;\n+    }\n+\n+    static EnvVariablesConfigParser client() {\n+        return new EnvVariablesConfigParser(\"HZCLIENT_\", \"hazelcast-client\");\n+    }\n+\n+    static EnvVariablesConfigParser member() {\n+        return new EnvVariablesConfigParser(\"HZ_\", \"hazelcast\");\n+    }\n+\n+    Map<String, String> parse(Map<String, String> env) {\n+        return env.entrySet()\n+          .stream()\n+          .filter(e -> !EXCLUDED_ENTRIES.contains(e.getKey().replace(\" \", \"\")))\n+          .filter(e -> e.getKey().startsWith(prefix))\n+          .collect(toMap(this::processKey, Map.Entry::getValue));\n+    }\n+\n+    private String processKey(Map.Entry<String, String> e) {\n+        return e.getKey()\n+          .replaceFirst(prefix, rootNode + \".\")\n+          .replace(\"_\", \".\")\n+          .replace(\" \", \"\")", "originalCommit": "aba2757fbc7e945b165f5e264eb55bb0b032cb34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY1NzkyOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r475657929", "bodyText": "Hopefully never, but I'm not willing to bid my life on this :) in theory, there are no limits to env names (but in practice, there are)", "author": "pivovarit", "createdAt": "2020-08-24T14:34:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0NjY5Mg=="}], "type": "inlineReview"}, {"oid": "1433369e1765ea7bb228fcef58d33dac92958066", "url": "https://github.com/hazelcast/hazelcast/commit/1433369e1765ea7bb228fcef58d33dac92958066", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.\n\nRules for environment variables conversion:\n- each entry needs to be prefixed with either `HZ_` or `HZCLIENT_`\n- each configuration key needs to be uppercased\n- `_` introduces a new configuration level\n- each `-` needs to be ignored\n\nRules for system properties conversion:\n- each entry needs to be prefixed with `hz.` or `hz-client.`\n- each configuration key needs to be lowercased\n\nIf the same configuration key is duplicated, an exception is raised.", "committedDate": "2020-08-24T15:40:18Z", "type": "commit"}, {"oid": "1433369e1765ea7bb228fcef58d33dac92958066", "url": "https://github.com/hazelcast/hazelcast/commit/1433369e1765ea7bb228fcef58d33dac92958066", "message": "Introduces a mechanism allowing overriding config entries by using system properties or environment variables.\n\nRules for environment variables conversion:\n- each entry needs to be prefixed with either `HZ_` or `HZCLIENT_`\n- each configuration key needs to be uppercased\n- `_` introduces a new configuration level\n- each `-` needs to be ignored\n\nRules for system properties conversion:\n- each entry needs to be prefixed with `hz.` or `hz-client.`\n- each configuration key needs to be lowercased\n\nIf the same configuration key is duplicated, an exception is raised.", "committedDate": "2020-08-24T15:40:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MDEwMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476240102", "bodyText": "Can you also check getEvictionConfig, handleUserCodeDeployment, handleBackupAckToClient, getNearCachePreloaderConfig and handleConnectionStrategy?\nAlso, check out methods in AbstractDomConfigProcessor, there's more there to be covered. Feel free to simplify the code a bit if it makes your life easier.", "author": "mmedenjak", "createdAt": "2020-08-25T07:38:20Z", "path": "hazelcast/src/main/java/com/hazelcast/client/config/impl/ClientDomConfigProcessor.java", "diffHunk": "@@ -198,7 +200,7 @@ private void handleConnectionStrategy(Node node) {\n         }", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA4NTE4OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r482085189", "bodyText": "Can you still check getNearCachePreloaderConfig and handleConnectionStrategy?\nEDIT: Ignore. :)", "author": "mmedenjak", "createdAt": "2020-09-02T13:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MDEwMg=="}], "type": "inlineReview"}, {"oid": "c1fbacd1593bc73fb346526557ed1748ec364eb9", "url": "https://github.com/hazelcast/hazelcast/commit/c1fbacd1593bc73fb346526557ed1748ec364eb9", "message": "Cover configuration lookups in AbstractDomConfigProcessor", "committedDate": "2020-08-25T07:59:18Z", "type": "commit"}, {"oid": "c1fbacd1593bc73fb346526557ed1748ec364eb9", "url": "https://github.com/hazelcast/hazelcast/commit/c1fbacd1593bc73fb346526557ed1748ec364eb9", "message": "Cover configuration lookups in AbstractDomConfigProcessor", "committedDate": "2020-08-25T07:59:18Z", "type": "forcePushed"}, {"oid": "c8ec81a253b46ad01436f66c7e0ff8c75b03546d", "url": "https://github.com/hazelcast/hazelcast/commit/c8ec81a253b46ad01436f66c7e0ff8c75b03546d", "message": "Ignore dashes when looking attributes up", "committedDate": "2020-08-25T08:09:11Z", "type": "commit"}, {"oid": "e87e77028aad6d87d7b915ed441e9a2fac4b925b", "url": "https://github.com/hazelcast/hazelcast/commit/e87e77028aad6d87d7b915ed441e9a2fac4b925b", "message": "Introduce helper DomConfigHelper.getNamedItemNode() and replace direct getNamedItemNode calls", "committedDate": "2020-08-25T08:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4NDQ4MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476284481", "bodyText": "Consider refactoring this to something like:\noverwriteWithProvider(new EnvConfigProvider(EnvVariablesConfigParser.member()), config);\noverwriteWithProvider(new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.member())), config);\n\nYou'd get rid of this generic method and passing function, which imo makes the code less readable. Plus your function may seem like pure, but I guess it's not since it modifies the config object.", "author": "leszko", "createdAt": "2020-08-25T08:49:05Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.client.config.impl.YamlClientDomConfigProcessor;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.internal.config.YamlMemberDomConfigProcessor;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import static com.hazelcast.internal.config.override.PropertiesToNodeConverter.propsToNode;\n+import static java.lang.String.format;\n+\n+/**\n+ * A class used to process external configuration overrides coming from environment variables/system properties,\n+ * and applying them over existing {@link Config}/{@link ClientConfig} configuration\n+ */\n+public class ExternalConfigurationOverride {\n+\n+    private static final ILogger LOGGER = Logger.getLogger(ExternalConfigurationOverride.class);\n+\n+    public Config overwriteMemberConfig(Config config) {\n+        return overwrite(config, (provider, c) -> {", "originalCommit": "e87e77028aad6d87d7b915ed441e9a2fac4b925b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk5NjM3OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r479996378", "bodyText": "The problem is that we need to have access to multiple providers to validate if there are no conflicts(in your example configs from various sources are applied individually) so either we repeat the code responsible for iteration and validation, or we pull it out somehow (what I tried).\nThe method needs to be generic since Config and ClientConfig don't have a common denominator so I needed to play around with generics to make it possible and inject a passing function representing a strategy for applying the config", "author": "pivovarit", "createdAt": "2020-08-31T09:06:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4NDQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA5ODQ4OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480098489", "bodyText": "Check out this.\n    public Config overwriteMemberConfig(Config config) {\n        Map<String, String> properties = prepareProperties(\n                new EnvConfigProvider(EnvVariablesConfigParser.member()),\n                new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.member())\n        );\n\n        if (!properties.isEmpty()) {\n            try {\n                new YamlMemberDomConfigProcessor(true, config)\n                        .buildConfig(new ConfigOverrideElementAdapter(propsToNode(properties)));\n            } catch (Exception e) {\n                throw new InvalidConfigurationException(\"failed to overwrite configuration\", e);\n            }\n        }\n\n        return config;\n    }\n\n\n\n\n    public ClientConfig overwriteClientConfig(ClientConfig config) {\n        Map<String, String> properties = prepareProperties(\n                new EnvConfigProvider(EnvVariablesConfigParser.client()),\n                new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.client())\n        );\n\n        if (!properties.isEmpty()) {\n            try {\n                new YamlClientDomConfigProcessor(true, config)\n                        .buildConfig(new ConfigOverrideElementAdapter(propsToNode(properties)));\n            } catch (Exception e) {\n                throw new InvalidConfigurationException(\"failed to overwrite configuration\", e);\n            }\n        }\n\n        return config;\n    }\n\n    private Map<String, String> prepareProperties(ConfigProvider... providers) {\n        ConfigOverrideValidator.validate(new HashSet<>(Arrays.asList(providers)));\n\n        Map<String, String> properties = new HashMap<>();\n        for (ConfigProvider configProvider : providers) {\n            configProvider.properties().forEach((k, v) -> {\n                LOGGER.info(format(\"Detected external configuration overrides in %s: [%s]\",\n                        configProvider.name(),\n                        k + \"=\" + v));\n                properties.put(k, v);\n            });\n        }\n\n        return properties;\n    }\n\nBut you can keep your version, up to you. I'm fine with both.", "author": "leszko", "createdAt": "2020-08-31T12:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4NDQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4ODgwMA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476288800", "bodyText": "I discovered a weird thing. I tried to run in on Kubernetes and defined the following env variables:\nkubectl run hazelcast --image leszko/hazelcast:ext-config --env=\"HZ_NETWORK_JOIN_KUBERNETES_ENABLED=true\" --env=\"HZ_NETWORK_JOIN_MULTICAST_ENABLED=false\"\n\nAnd I expected it would work exactly the same as if I defined hazelcast.yaml with the following content:\nhazelcast:\n  network:\n    join:\n      kubernetes:\n        enabled: true\n      multicast:\n        enabled: false\n\nHowever, that was not the case. It seems that the config override set some other kubernetes parameters as well, because I got the following exception:\nCaused by: com.hazelcast.config.InvalidConfigurationException: Properties 'service-name' and 'service-label-name' cannot be defined at the same time\n\nLike the config override changed kubernetes.* properties to empty strings instead of passing nulls.\nCould you check?", "author": "leszko", "createdAt": "2020-08-25T08:55:43Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.client.config.impl.YamlClientDomConfigProcessor;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.internal.config.YamlMemberDomConfigProcessor;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import static com.hazelcast.internal.config.override.PropertiesToNodeConverter.propsToNode;\n+import static java.lang.String.format;\n+\n+/**\n+ * A class used to process external configuration overrides coming from environment variables/system properties,\n+ * and applying them over existing {@link Config}/{@link ClientConfig} configuration\n+ */\n+public class ExternalConfigurationOverride {", "originalCommit": "e87e77028aad6d87d7b915ed441e9a2fac4b925b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMyNDk1NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476324954", "bodyText": "I think I have an idea. I must have mistakenly broken it when solving another bug. Thanks!\nThe mechanism is overwriting only the cherry-picked config entries, but leaves what was there already instead of erasing entries that were not provided, and it turns out that defaults are these:\n\n  \n    \n      hazelcast/hazelcast/src/main/resources/hazelcast-default.xml\n    \n    \n        Lines 74 to 79\n      in\n      8f550a9\n    \n    \n    \n    \n\n        \n          \n           <kubernetes enabled=\"false\"> \n        \n\n        \n          \n               <namespace>MY-KUBERNETES-NAMESPACE</namespace> \n        \n\n        \n          \n               <service-name>MY-SERVICE-NAME</service-name> \n        \n\n        \n          \n               <service-label-name>MY-SERVICE-LABEL-NAME</service-label-name> \n        \n\n        \n          \n               <service-label-value>MY-SERVICE-LABEL-VALUE</service-label-value> \n        \n\n        \n          \n           </kubernetes> \n        \n    \n  \n\n\nNot sure if this is a bug or not, but the default config file should not feature these at all?", "author": "pivovarit", "createdAt": "2020-08-25T09:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4ODgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA3MTk4Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480071982", "bodyText": "Yeah, this PR [1] should fix it for kubernetes, but what about all other hazelcast-default.xml configuration parts? In some sense, we may think it's unrelated to this PR, because we just pass whatever was the default. On the other hand, from the user perspective, we introduce a feature that works different that what they may expect.\nFor example, you use the following configuration:\nhazelcast:\n  network:\n    join:\n      multicast:\n        enabled: true\n\nFrom the user's perspective, it should be exactly the same as: HZ_NETWORK_JOIN_MULTICAST_ENABLED=true. But it's not, because the former one has some other attributes predefined. IMO that's not the right behavior.\n#17402", "author": "leszko", "createdAt": "2020-08-31T11:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4ODgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5NTIzNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480195237", "bodyText": "I believe we can address this separately. No point in blocking this really nice feature when users can:\n\u2022 circumvent the issue by adding more config parameters to override the values from hazelcast-default.yaml\n\u2022 fall back to YAML and XML files\nWe'll also clean up the hazelcast-default.xml as we go along, or even switch to using new Config() instead in 5.0.", "author": "mmedenjak", "createdAt": "2020-08-31T15:09:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4ODgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4OTU5Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476289597", "bodyText": "What is this class for?\n\nCould you add javadoc with some explanation?\nCould you add a unit test?", "author": "leszko", "createdAt": "2020-08-25T08:56:57Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/PropertiesToNodeConverter.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.AbstractMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+final class PropertiesToNodeConverter {", "originalCommit": "e87e77028aad6d87d7b915ed441e9a2fac4b925b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEwMDAwNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480100006", "bodyText": "Thanks. Consider adding also some javadocs to private methods. Since they are complex, it may help to understand what they are about. For example, findBootNode(), how does it find the root element? And what is the root element here?", "author": "leszko", "createdAt": "2020-08-31T12:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4OTU5Nw=="}], "type": "inlineReview"}, {"oid": "7e4b2c67939f9d93d1ba17e27a747ce5d58806bb", "url": "https://github.com/hazelcast/hazelcast/commit/7e4b2c67939f9d93d1ba17e27a747ce5d58806bb", "message": "Interpret child nodes as attributes", "committedDate": "2020-08-25T10:45:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMxNTg5Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476315896", "bodyText": "Minor: maybe some javadoc here for future maintainers.", "author": "mmedenjak", "createdAt": "2020-08-25T09:36:38Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.client.config.impl.YamlClientDomConfigProcessor;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.internal.config.YamlMemberDomConfigProcessor;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import static com.hazelcast.internal.config.override.PropertiesToNodeConverter.propsToNode;\n+import static java.lang.String.format;\n+\n+/**\n+ * A class used to process external configuration overrides coming from environment variables/system properties,\n+ * and applying them over existing {@link Config}/{@link ClientConfig} configuration\n+ */\n+public class ExternalConfigurationOverride {\n+\n+    private static final ILogger LOGGER = Logger.getLogger(ExternalConfigurationOverride.class);\n+\n+    public Config overwriteMemberConfig(Config config) {", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMxNjY1OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476316659", "bodyText": "Do we have anywhere the definition of \"legal\"? Maybe add some here as javadoc as well?", "author": "mmedenjak", "createdAt": "2020-08-25T09:37:58Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigOverrideValidator.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Validation mechanism used to make sure that external configuration features is legal.", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMxNzA4NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476317084", "bodyText": "Can we throw InvalidConfigurationException instead?", "author": "mmedenjak", "createdAt": "2020-08-25T09:38:40Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigOverrideValidator.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Validation mechanism used to make sure that external configuration features is legal.\n+ */\n+final class ConfigOverrideValidator {\n+\n+    private static final ILogger LOGGER = Logger.getLogger(ConfigOverrideValidator.class);\n+\n+    private ConfigOverrideValidator() {\n+    }\n+\n+    static void validate(Set<ConfigProvider> providers) {\n+        Set<String> sharedKeys = findDuplicateEntries(providers);\n+        if (!sharedKeys.isEmpty()) {\n+            LOGGER.severe(\"Discovered conflicting entries: \" + String.join(\",\", sharedKeys));\n+            throw new IllegalStateException(\"Discovered conflicting configuration entries\");", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMxNzQ5Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476317492", "bodyText": "Javadoc", "author": "mmedenjak", "createdAt": "2020-08-25T09:39:20Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigProvider.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.Map;\n+\n+/**\n+ * An interface representing a generic configuration source.\n+ */\n+interface ConfigProvider {\n+\n+    /**\n+     * Returns an immutable set of key-value configuration entries.\n+     */\n+    Map<String, String> properties();\n+\n+    String name();", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMyOTIyOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476329229", "bodyText": "Can name be null? If not, maybe some Nonnull annotation and check.", "author": "mmedenjak", "createdAt": "2020-08-25T09:58:32Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigNode.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * A representation of a single generic configuration node.\n+ */\n+class ConfigNode {\n+    private final ConfigNode parent;\n+    private final String name;\n+    private final Map<String, ConfigNode> children = new LinkedHashMap<>();\n+    private String value;\n+\n+    ConfigNode(String name) {", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMzMzk5OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476333999", "bodyText": "RuntimeException seems a bit generic. Can we throw InvalidConfigurationException instead or something extending HazelcastException?", "author": "mmedenjak", "createdAt": "2020-08-25T10:06:57Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.client.config.impl.YamlClientDomConfigProcessor;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.internal.config.YamlMemberDomConfigProcessor;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import static com.hazelcast.internal.config.override.PropertiesToNodeConverter.propsToNode;\n+import static java.lang.String.format;\n+\n+/**\n+ * A class used to process external configuration overrides coming from environment variables/system properties,\n+ * and applying them over existing {@link Config}/{@link ClientConfig} configuration\n+ */\n+public class ExternalConfigurationOverride {\n+\n+    private static final ILogger LOGGER = Logger.getLogger(ExternalConfigurationOverride.class);\n+\n+    public Config overwriteMemberConfig(Config config) {\n+        return overwrite(config, (provider, c) -> {\n+              try {\n+                  new YamlMemberDomConfigProcessor(true, c)\n+                    .buildConfig(new ConfigOverrideElementAdapter(propsToNode(provider.properties())));\n+              } catch (Exception e) {\n+                  throw new RuntimeException(e);\n+              }\n+          },\n+          new EnvConfigProvider(EnvVariablesConfigParser.member()),\n+          new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.member()));\n+    }\n+\n+    public ClientConfig overwriteClientConfig(ClientConfig config) {\n+        return overwrite(config, (provider, c) -> {\n+              try {\n+                  new YamlClientDomConfigProcessor(true, c)\n+                    .buildConfig(new ConfigOverrideElementAdapter(propsToNode(provider.properties())));\n+              } catch (Exception e) {\n+                  throw new RuntimeException(e);", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMzNzY3Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476337673", "bodyText": "Can we print one log statement instead with all of the overrides instead?", "author": "mmedenjak", "createdAt": "2020-08-25T10:13:52Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.client.config.impl.YamlClientDomConfigProcessor;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.internal.config.YamlMemberDomConfigProcessor;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import static com.hazelcast.internal.config.override.PropertiesToNodeConverter.propsToNode;\n+import static java.lang.String.format;\n+\n+/**\n+ * A class used to process external configuration overrides coming from environment variables/system properties,\n+ * and applying them over existing {@link Config}/{@link ClientConfig} configuration\n+ */\n+public class ExternalConfigurationOverride {\n+\n+    private static final ILogger LOGGER = Logger.getLogger(ExternalConfigurationOverride.class);\n+\n+    public Config overwriteMemberConfig(Config config) {\n+        return overwrite(config, (provider, c) -> {\n+              try {\n+                  new YamlMemberDomConfigProcessor(true, c)\n+                    .buildConfig(new ConfigOverrideElementAdapter(propsToNode(provider.properties())));\n+              } catch (Exception e) {\n+                  throw new RuntimeException(e);\n+              }\n+          },\n+          new EnvConfigProvider(EnvVariablesConfigParser.member()),\n+          new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.member()));\n+    }\n+\n+    public ClientConfig overwriteClientConfig(ClientConfig config) {\n+        return overwrite(config, (provider, c) -> {\n+              try {\n+                  new YamlClientDomConfigProcessor(true, c)\n+                    .buildConfig(new ConfigOverrideElementAdapter(propsToNode(provider.properties())));\n+              } catch (Exception e) {\n+                  throw new RuntimeException(e);\n+              }\n+          },\n+          new EnvConfigProvider(EnvVariablesConfigParser.client()),\n+          new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.client()));\n+    }\n+\n+    private <T> T overwrite(T config, BiConsumer<ConfigProvider, T> configProcessor, ConfigProvider... providers) {\n+        ConfigOverrideValidator.validate(new HashSet<>(Arrays.asList(providers)));\n+\n+        for (ConfigProvider configProvider : providers) {\n+            Map<String, String> properties = configProvider.properties();\n+            properties.forEach((k, v) -> {\n+                LOGGER.info(format(\"Detected external configuration overrides in %s: [%s]\",", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDg2NDg1MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480864850", "bodyText": "I assume we want to minimize the number of lines? I came up with something like this:\n\nDetected external configuration overrides in environment variables: [hazelcast.network.join.autodetection.enabled=false,hazelcast.executorservice.custom.poolsize=42,hazelcast.clustername=test,hazelcast.cache.default.keytype.classname=java.lang.Object]", "author": "pivovarit", "createdAt": "2020-09-01T06:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMzNzY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDg3NDM2MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480874360", "bodyText": "Yes, that, and the PR description shows this as an example:\nINFO: Detected external configuration overrides in environment variables: \nhazelcast.network.join.multicast.enabled=false\nhazelcast.network.join.tcpip.enabled=false\nhazelcast.clustername=foo", "author": "mmedenjak", "createdAt": "2020-09-01T06:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMzNzY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMzOTAwNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476339004", "bodyText": "InvalidConfigurationException? Same in rest of class. Also, maybe you can include the conflicting names.", "author": "mmedenjak", "createdAt": "2020-08-25T10:16:23Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/PropertiesToNodeConverter.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.AbstractMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+final class PropertiesToNodeConverter {\n+\n+    private PropertiesToNodeConverter() {\n+    }\n+\n+    static ConfigNode propsToNode(Map<String, String> properties) {\n+        String rootNode = findRootNode(properties);\n+\n+        ConfigNode root = new ConfigNode(rootNode);\n+        for (Map.Entry<String, String> e : properties.entrySet()) {\n+            parseEntry(new AbstractMap.SimpleEntry<>(e.getKey().replaceFirst(rootNode + \".\", \"\"), e.getValue()), root);\n+        }\n+        return root;\n+    }\n+\n+    private static String findRootNode(Map<String, String> properties) {\n+        Set<String> rootNodeNames = properties.keySet().stream()\n+          .map(key -> key.split(\"\\\\.\")[0])\n+          .collect(Collectors.toSet());\n+\n+        if (rootNodeNames.size() > 1) {\n+            throw new IllegalStateException(\"parsed config entries have conflicting root node names\");", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM0MjI4MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476342280", "bodyText": "Minor - maybe this instead?\n .map(key -> {\n              int dotIndex = key.indexOf(\".\");\n              return key.substring(0, dotIndex > 0? dotIndex : key.length());\n          })\n          ```", "author": "mmedenjak", "createdAt": "2020-08-25T10:22:42Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/PropertiesToNodeConverter.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.AbstractMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+final class PropertiesToNodeConverter {\n+\n+    private PropertiesToNodeConverter() {\n+    }\n+\n+    static ConfigNode propsToNode(Map<String, String> properties) {\n+        String rootNode = findRootNode(properties);\n+\n+        ConfigNode root = new ConfigNode(rootNode);\n+        for (Map.Entry<String, String> e : properties.entrySet()) {\n+            parseEntry(new AbstractMap.SimpleEntry<>(e.getKey().replaceFirst(rootNode + \".\", \"\"), e.getValue()), root);\n+        }\n+        return root;\n+    }\n+\n+    private static String findRootNode(Map<String, String> properties) {\n+        Set<String> rootNodeNames = properties.keySet().stream()\n+          .map(key -> key.split(\"\\\\.\")[0])", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM0Mzk2Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476343962", "bodyText": "No need to create an entry as a parameter, I think it can be:\n    private static void parseEntry(String key, String value, ConfigNode root) {\n        ConfigNode last = root;\n        for (String s : key.toLowerCase().split(\"\\\\.\")) {\n            ConfigNode node = last.getChildren().get(s);\n            if (node == null) {\n                node = new ConfigNode(s, last);\n                last.getChildren().put(s, node);\n            }\n            last = node;\n        }\n\n        last.setValue(value);\n    }\n\nAnother alternative is this:\nstatic ConfigNode propsToNode(Map<String, String> properties) {\n        Map<String, List<BiTuple<String[], String>>> propsByRootNode =\n                properties.entrySet().stream()\n                          .map(entry -> BiTuple.of(entry.getKey().split(\"\\\\.\"), entry.getValue()))\n                          .collect(Collectors.groupingBy(e -> e.element1()[0]));\n\n        if (propsByRootNode.size() > 1) {\n            throw new IllegalStateException(\"parsed config entries have conflicting root node names\");\n        }\n        if (propsByRootNode.size() == 0){\n            throw new IllegalStateException(\"No parsed entries found\");\n        }\n\n        Entry<String, List<BiTuple<String[], String>>> rootNodeEntry = propsByRootNode.entrySet().iterator().next();\n\n        ConfigNode root = new ConfigNode(rootNodeEntry.getKey());\n        for (BiTuple<String[], String> e : rootNodeEntry.getValue()) {\n            parseEntry(e.element1, e.element2, root);\n        }\n        return root;\n    }\n\n    private static void parseEntry(String[] keyPath, String value, ConfigNode root) {\n        ConfigNode last = root;\n        for (int i = 1; i < keyPath.length; i++) {\n            ConfigNode node = last.getChildren().get(keyPath[i]);\n            if (node == null) {\n                node = new ConfigNode(keyPath[i], last);\n                last.getChildren().put(keyPath[i], node);\n            }\n            last = node;\n        }\n\n        last.setValue(value);\n    }", "author": "mmedenjak", "createdAt": "2020-08-25T10:26:13Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/PropertiesToNodeConverter.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.AbstractMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+final class PropertiesToNodeConverter {\n+\n+    private PropertiesToNodeConverter() {\n+    }\n+\n+    static ConfigNode propsToNode(Map<String, String> properties) {\n+        String rootNode = findRootNode(properties);\n+\n+        ConfigNode root = new ConfigNode(rootNode);\n+        for (Map.Entry<String, String> e : properties.entrySet()) {\n+            parseEntry(new AbstractMap.SimpleEntry<>(e.getKey().replaceFirst(rootNode + \".\", \"\"), e.getValue()), root);", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NzE0Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476357147", "bodyText": "With the alternative approach, I've asked myself what can happen if the key is equal to the root name. For instance, this case:\nHZ_NETWORK_JOIN=whoops\nHZ_NETWORK_JOIN_TCPIP_ENABLED=false;\nHZ_NETWORK_JOIN_MULTICAST_ENABLED=false", "author": "mmedenjak", "createdAt": "2020-08-25T10:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM0Mzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA4ODEwOA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r482088108", "bodyText": "Any ideas about the above when the key is equal to the root name?", "author": "mmedenjak", "createdAt": "2020-09-02T13:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM0Mzk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM0NTA4OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476345089", "bodyText": "If it can't be null, maybe annotation and check.", "author": "mmedenjak", "createdAt": "2020-08-25T10:28:20Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigOverrideElementAdapter.java", "diffHunk": "@@ -0,0 +1,405 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import org.w3c.dom.Attr;\n+import org.w3c.dom.DOMException;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.NamedNodeMap;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.TypeInfo;\n+import org.w3c.dom.UserDataHandler;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Class adapting {@link ConfigNode}s to {@link Element}.\n+ * <p>\n+ * Used for processing external configuration overrides.\n+ */\n+@SuppressWarnings({\"checkstyle:methodcount\"})\n+class ConfigOverrideElementAdapter implements Element {\n+    private final ConfigNode configNode;\n+\n+    ConfigOverrideElementAdapter(ConfigNode yamlNode) {\n+        this.configNode = yamlNode;", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NDg4OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476354889", "bodyText": "Minor: maybe you can join the \"parser\" and \"provider\" as right now the providers are rather simple. Right now, it looks like you might use different parsers with a single provider but it's not really needed. The provider implementation could both fetch the properties and parse them.", "author": "mmedenjak", "createdAt": "2020-08-25T10:47:22Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ConfigProvider.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import java.util.Map;\n+\n+/**\n+ * An interface representing a generic configuration source.\n+ */\n+interface ConfigProvider {", "originalCommit": "1433369e1765ea7bb228fcef58d33dac92958066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3MDgyNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r476370826", "bodyText": "We'd lose testability. Parsers work on arbitrary sources of data while providers supply parsers with data from System.getEnv/getProperties. Thanks to the separation, I'm able to test the parsing logic without touching System.getEnv/getProperties", "author": "pivovarit", "createdAt": "2020-08-25T11:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NDg4OQ=="}], "type": "inlineReview"}, {"oid": "59be116e6a8f6034197d4bbee3980fae1a30716c", "url": "https://github.com/hazelcast/hazelcast/commit/59be116e6a8f6034197d4bbee3980fae1a30716c", "message": "Review improvements", "committedDate": "2020-08-25T11:41:48Z", "type": "commit"}, {"oid": "4782341d3d83eb712c1e4982e64e58bc0f66125e", "url": "https://github.com/hazelcast/hazelcast/commit/4782341d3d83eb712c1e4982e64e58bc0f66125e", "message": "Merge branch 'master' of github.com:hazelcast/hazelcast into config-override", "committedDate": "2020-08-31T05:50:14Z", "type": "commit"}, {"oid": "56a5ce3ba6a800966700dc9752be61792e54f667", "url": "https://github.com/hazelcast/hazelcast/commit/56a5ce3ba6a800966700dc9752be61792e54f667", "message": "Expand Javadoc documentation", "committedDate": "2020-08-31T07:20:54Z", "type": "commit"}, {"oid": "bcc45ad0bfb69ca2a194f892cbc07b11877f9f34", "url": "https://github.com/hazelcast/hazelcast/commit/bcc45ad0bfb69ca2a194f892cbc07b11877f9f34", "message": "PropertiesToNodeConverterTest", "committedDate": "2020-08-31T07:53:31Z", "type": "commit"}, {"oid": "3dce043ad18c24437baed4789ee1cf310d722ae1", "url": "https://github.com/hazelcast/hazelcast/commit/3dce043ad18c24437baed4789ee1cf310d722ae1", "message": "Remove redundant vars", "committedDate": "2020-08-31T07:56:39Z", "type": "commit"}, {"oid": "824cda386aa900ba0415cc8b607e2fcf977ad5bc", "url": "https://github.com/hazelcast/hazelcast/commit/824cda386aa900ba0415cc8b607e2fcf977ad5bc", "message": "Simplify validateNetworkConfig()", "committedDate": "2020-08-31T08:02:31Z", "type": "commit"}, {"oid": "eaeb344c77f6edc1648655c23314c83b22cc8d07", "url": "https://github.com/hazelcast/hazelcast/commit/eaeb344c77f6edc1648655c23314c83b22cc8d07", "message": "Remove extra line", "committedDate": "2020-08-31T08:02:43Z", "type": "commit"}, {"oid": "17fc85a743a02b8f206d4564087b63ec65a3e8c7", "url": "https://github.com/hazelcast/hazelcast/commit/17fc85a743a02b8f206d4564087b63ec65a3e8c7", "message": "Use namedNode helpers in YamlMemberDomConfigProcessors", "committedDate": "2020-08-31T08:38:46Z", "type": "commit"}, {"oid": "2e8e17f603a0382944a331cb4e3c4828a83752c8", "url": "https://github.com/hazelcast/hazelcast/commit/2e8e17f603a0382944a331cb4e3c4828a83752c8", "message": "Remove unused lines", "committedDate": "2020-08-31T08:40:54Z", "type": "commit"}, {"oid": "716782a53c483328990558c51ea084989e10d63c", "url": "https://github.com/hazelcast/hazelcast/commit/716782a53c483328990558c51ea084989e10d63c", "message": "Expect different exception in tests", "committedDate": "2020-08-31T09:15:11Z", "type": "commit"}, {"oid": "50c41ef44b456c85fd6570a7befee9ae0483050a", "url": "https://github.com/hazelcast/hazelcast/commit/50c41ef44b456c85fd6570a7befee9ae0483050a", "message": "Checkstyle", "committedDate": "2020-08-31T09:51:39Z", "type": "commit"}, {"oid": "e807f11b29e16156147c72abf14e3aa207709a15", "url": "https://github.com/hazelcast/hazelcast/commit/e807f11b29e16156147c72abf14e3aa207709a15", "message": "JavaDoc", "committedDate": "2020-08-31T09:59:27Z", "type": "commit"}, {"oid": "654b14470bb5bcc1cad2dcc1a22a164534adf04e", "url": "https://github.com/hazelcast/hazelcast/commit/654b14470bb5bcc1cad2dcc1a22a164534adf04e", "message": "Refactor PropertiesToNodeConverter", "committedDate": "2020-08-31T10:17:27Z", "type": "commit"}, {"oid": "e4807a47651ed74791ff8e6a9b995784d2437241", "url": "https://github.com/hazelcast/hazelcast/commit/e4807a47651ed74791ff8e6a9b995784d2437241", "message": "Enforce no nulls in ConfigOverrideElementAdapter constructor", "committedDate": "2020-08-31T10:18:42Z", "type": "commit"}, {"oid": "db8f45c91b092286f1f14c3ac5c3cdd8e8fc11ca", "url": "https://github.com/hazelcast/hazelcast/commit/db8f45c91b092286f1f14c3ac5c3cdd8e8fc11ca", "message": "Unused imports", "committedDate": "2020-08-31T10:31:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA5ODY2OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r480098668", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                              throw new InvalidConfigurationException(\"failed to overwrite configuration coming from \" + provider.name());\n          \n          \n            \n                              throw new InvalidConfigurationException(\"failed to overwrite configuration coming from \" + provider.name(), e);", "author": "leszko", "createdAt": "2020-08-31T12:32:50Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.client.config.impl.YamlClientDomConfigProcessor;\n+import com.hazelcast.config.Config;\n+import com.hazelcast.config.InvalidConfigurationException;\n+import com.hazelcast.internal.config.YamlMemberDomConfigProcessor;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import static com.hazelcast.internal.config.override.PropertiesToNodeConverter.propsToNode;\n+import static java.lang.String.format;\n+\n+/**\n+ * A class used to process external configuration overrides coming from environment variables/system properties,\n+ * and applying them over existing {@link Config}/{@link ClientConfig} configuration.\n+ */\n+public class ExternalConfigurationOverride {\n+\n+    private static final ILogger LOGGER = Logger.getLogger(ExternalConfigurationOverride.class);\n+\n+    public Config overwriteMemberConfig(Config config) {\n+        return overwrite(config, (provider, c) -> {\n+              try {\n+                  new YamlMemberDomConfigProcessor(true, c)\n+                    .buildConfig(new ConfigOverrideElementAdapter(propsToNode(provider.properties())));\n+              } catch (Exception e) {\n+                  throw new InvalidConfigurationException(\"failed to overwrite configuration coming from \" + provider.name(), e);\n+              }\n+          },\n+          new EnvConfigProvider(EnvVariablesConfigParser.member()),\n+          new SystemPropertiesConfigProvider(SystemPropertiesConfigParser.member()));\n+    }\n+\n+    public ClientConfig overwriteClientConfig(ClientConfig config) {\n+        return overwrite(config, (provider, c) -> {\n+              try {\n+                  new YamlClientDomConfigProcessor(true, c)\n+                    .buildConfig(new ConfigOverrideElementAdapter(propsToNode(provider.properties())));\n+              } catch (Exception e) {\n+                  throw new InvalidConfigurationException(\"failed to overwrite configuration coming from \" + provider.name());", "originalCommit": "db8f45c91b092286f1f14c3ac5c3cdd8e8fc11ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e17d84dddd4c16022f8ba637e1c92bfeff38a638", "url": "https://github.com/hazelcast/hazelcast/commit/e17d84dddd4c16022f8ba637e1c92bfeff38a638", "message": "Update hazelcast/src/main/java/com/hazelcast/internal/config/override/ExternalConfigurationOverride.java\n\nCo-authored-by: Rafa\u0142 Leszko <rafal@hazelcast.com>", "committedDate": "2020-08-31T13:35:59Z", "type": "commit"}, {"oid": "5e59f945ad0262cdc47b46d5d87c157657fcf7c3", "url": "https://github.com/hazelcast/hazelcast/commit/5e59f945ad0262cdc47b46d5d87c157657fcf7c3", "message": "Merge branch 'master' into config-override", "committedDate": "2020-08-31T15:28:30Z", "type": "commit"}, {"oid": "714ebf03434fe6ab4f9785cffe7310fe499d2863", "url": "https://github.com/hazelcast/hazelcast/commit/714ebf03434fe6ab4f9785cffe7310fe499d2863", "message": "Handle null attributes", "committedDate": "2020-08-31T16:30:39Z", "type": "commit"}, {"oid": "8144d376de94d16ed739027993576d582dbec93f", "url": "https://github.com/hazelcast/hazelcast/commit/8144d376de94d16ed739027993576d582dbec93f", "message": "Merge branch 'config-override' of github.com:pivovarit/hazelcast into config-override", "committedDate": "2020-08-31T16:30:47Z", "type": "commit"}, {"oid": "40ee4a695730b977d4a9970787a5dc30b5d37a06", "url": "https://github.com/hazelcast/hazelcast/commit/40ee4a695730b977d4a9970787a5dc30b5d37a06", "message": "Ensure env set in shouldDisallowConflictingEntries", "committedDate": "2020-09-01T06:00:36Z", "type": "commit"}, {"oid": "157a08d78460e259bd3b2087aa092e5576f9920d", "url": "https://github.com/hazelcast/hazelcast/commit/157a08d78460e259bd3b2087aa092e5576f9920d", "message": "Log overrides at once", "committedDate": "2020-09-01T06:19:34Z", "type": "commit"}, {"oid": "6e7a80bdd425b71eee8d157621266029d188e9c5", "url": "https://github.com/hazelcast/hazelcast/commit/6e7a80bdd425b71eee8d157621266029d188e9c5", "message": "Replace getNamedItem() calls with a helper", "committedDate": "2020-09-01T07:55:48Z", "type": "commit"}, {"oid": "de17085128e2de2bf42e29072bfd0e01e56c9acc", "url": "https://github.com/hazelcast/hazelcast/commit/de17085128e2de2bf42e29072bfd0e01e56c9acc", "message": "Remove unused import", "committedDate": "2020-09-01T07:57:15Z", "type": "commit"}, {"oid": "4644d555d9ee156c8ba354e36c8f6fdfb587f906", "url": "https://github.com/hazelcast/hazelcast/commit/4644d555d9ee156c8ba354e36c8f6fdfb587f906", "message": "Merge branch 'master' into config-override", "committedDate": "2020-09-01T08:49:40Z", "type": "commit"}, {"oid": "8a667a6c67ce618f225b02fb318664ef2e507cf8", "url": "https://github.com/hazelcast/hazelcast/commit/8a667a6c67ce618f225b02fb318664ef2e507cf8", "message": "Checkstyle", "committedDate": "2020-09-01T09:05:44Z", "type": "commit"}, {"oid": "ca11c96248ef86010b14f5d3a18f6133664170d9", "url": "https://github.com/hazelcast/hazelcast/commit/ca11c96248ef86010b14f5d3a18f6133664170d9", "message": "Unused imports", "committedDate": "2020-09-01T09:25:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0NzQ5MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r481047490", "bodyText": "Should there be a test for the case where the env variable name contains \"-\"?", "author": "ihsandemir", "createdAt": "2020-09-01T10:47:44Z", "path": "hazelcast/src/test/java/com/hazelcast/internal/config/override/EnvVariablesClientConfigParserTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.test.HazelcastParallelClassRunner;\n+import com.hazelcast.test.HazelcastTestSupport;\n+import com.hazelcast.test.annotation.QuickTest;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+\n+import java.util.AbstractMap;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+@RunWith(HazelcastParallelClassRunner.class)\n+@Category(QuickTest.class)\n+public class EnvVariablesClientConfigParserTest extends HazelcastTestSupport {\n+\n+    private final EnvVariablesConfigParser envVariablesConfigParser = EnvVariablesConfigParser.client();\n+\n+    @Test\n+    public void shouldParseEntries() {\n+        Map<String, String> entries = new HashMap<>();\n+        entries.put(\"HZCLIENT_CLUSTERNAME\", \"foo\");\n+        entries.put(\"HZCLIENT_NETWORK_JOIN_TCPIP_ENABLED\", \"false\");", "originalCommit": "ca11c96248ef86010b14f5d3a18f6133664170d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA3MzMxNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r481073316", "bodyText": "We'll be documenting the dashless way as the right one since dashes are not supported by most shells in env variable names so it's not really needed", "author": "pivovarit", "createdAt": "2020-09-01T11:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0NzQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0Nzk3Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r481047977", "bodyText": "Question: Do we change anything on the value? For example a value like this: com.hazelcast.listeners.my-listener-class-with-dash", "author": "ihsandemir", "createdAt": "2020-09-01T10:48:43Z", "path": "hazelcast/src/test/java/com/hazelcast/internal/config/override/EnvVariablesClientConfigParserTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.config.override;\n+\n+import com.hazelcast.test.HazelcastParallelClassRunner;\n+import com.hazelcast.test.HazelcastTestSupport;\n+import com.hazelcast.test.annotation.QuickTest;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+\n+import java.util.AbstractMap;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+@RunWith(HazelcastParallelClassRunner.class)\n+@Category(QuickTest.class)\n+public class EnvVariablesClientConfigParserTest extends HazelcastTestSupport {\n+\n+    private final EnvVariablesConfigParser envVariablesConfigParser = EnvVariablesConfigParser.client();\n+\n+    @Test\n+    public void shouldParseEntries() {\n+        Map<String, String> entries = new HashMap<>();\n+        entries.put(\"HZCLIENT_CLUSTERNAME\", \"foo\");\n+        entries.put(\"HZCLIENT_NETWORK_JOIN_TCPIP_ENABLED\", \"false\");", "originalCommit": "ca11c96248ef86010b14f5d3a18f6133664170d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA2NTY2Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r481065666", "bodyText": "No, values don't require any changes", "author": "pivovarit", "createdAt": "2020-09-01T11:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0Nzk3Nw=="}], "type": "inlineReview"}, {"oid": "0ff672c4dcdcacbb25267199b12cb46c55884f4e", "url": "https://github.com/hazelcast/hazelcast/commit/0ff672c4dcdcacbb25267199b12cb46c55884f4e", "message": "Add extra test cases", "committedDate": "2020-09-02T07:23:36Z", "type": "commit"}, {"oid": "3bb8ab1922be1bcaef1689adfc2e311fcc0314e1", "url": "https://github.com/hazelcast/hazelcast/commit/3bb8ab1922be1bcaef1689adfc2e311fcc0314e1", "message": "Introduce a strict mode for config parser", "committedDate": "2020-09-02T12:08:02Z", "type": "commit"}, {"oid": "6b42a81b67ebcb27d95e80a3a9383386cb157ac5", "url": "https://github.com/hazelcast/hazelcast/commit/6b42a81b67ebcb27d95e80a3a9383386cb157ac5", "message": "Add YamlMemberDomConfigProcessor strictness tests", "committedDate": "2020-09-02T12:56:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEwNzA0Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r482107046", "bodyText": "Can you also check handleQueryCache and getCacheMapName, handleEntryListeners and the rest of the class?", "author": "mmedenjak", "createdAt": "2020-09-02T14:20:27Z", "path": "hazelcast/src/main/java/com/hazelcast/client/config/impl/QueryCacheXmlConfigBuilderHelper.java", "diffHunk": "@@ -81,7 +81,7 @@ protected void queryCachePredicateHandler(Node childNode, QueryCacheConfig query\n     protected void queryCacheIndexesHandle(Node n, QueryCacheConfig queryCacheConfig) {\n         for (Node indexNode : childElements(n)) {\n             if (\"index\".equals(cleanNodeName(indexNode))) {\n-                IndexConfig indexConfig = IndexUtils.getIndexConfigFromXml(indexNode, domLevel3);\n+                IndexConfig indexConfig = IndexUtils.getIndexConfigFromXml(indexNode, domLevel3, strict);", "originalCommit": "6b42a81b67ebcb27d95e80a3a9383386cb157ac5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE0MTgwNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17348#discussion_r482141807", "bodyText": "The priority-comparator-class-name is a leftover.", "author": "mmedenjak", "createdAt": "2020-09-02T15:03:33Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/MemberDomConfigProcessor.java", "diffHunk": "@@ -1538,27 +1529,27 @@ void handleQueueNode(Node node, final QueueConfig qConfig) {\n         for (Node n : childElements(node)) {\n             String nodeName = cleanNodeName(n);\n             String value = getTextContent(n).trim();\n-            if (\"max-size\".equals(nodeName)) {\n+            if (matches(\"max-size\", nodeName)) {\n                 qConfig.setMaxSize(getIntegerValue(\"max-size\", value));\n-            } else if (\"backup-count\".equals(nodeName)) {\n+            } else if (matches(\"backup-count\", nodeName)) {\n                 qConfig.setBackupCount(getIntegerValue(\"backup-count\", value));\n-            } else if (\"async-backup-count\".equals(nodeName)) {\n+            } else if (matches(\"async-backup-count\", nodeName)) {\n                 qConfig.setAsyncBackupCount(getIntegerValue(\"async-backup-count\", value));\n-            } else if (\"item-listeners\".equals(nodeName)) {\n+            } else if (matches(\"item-listeners\", nodeName)) {\n                 handleItemListeners(n, itemListenerConfig -> {\n                     qConfig.addItemListenerConfig(itemListenerConfig);\n                     return null;\n                 });\n-            } else if (\"statistics-enabled\".equals(nodeName)) {\n+            } else if (matches(\"statistics-enabled\", nodeName)) {\n                 qConfig.setStatisticsEnabled(getBooleanValue(value));\n-            } else if (\"queue-store\".equals(nodeName)) {\n+            } else if (matches(\"queue-store\", nodeName)) {\n                 QueueStoreConfig queueStoreConfig = createQueueStoreConfig(n);\n                 qConfig.setQueueStoreConfig(queueStoreConfig);\n-            } else if (\"split-brain-protection-ref\".equals(nodeName)) {\n+            } else if (matches(\"split-brain-protection-ref\", nodeName)) {\n                 qConfig.setSplitBrainProtectionName(value);\n-            } else if (\"empty-queue-ttl\".equals(nodeName)) {\n+            } else if (matches(\"empty-queue-ttl\", nodeName)) {\n                 qConfig.setEmptyQueueTtl(getIntegerValue(\"empty-queue-ttl\", value));\n-            } else if (\"merge-policy\".equals(nodeName)) {\n+            } else if (matches(\"merge-policy\", nodeName)) {", "originalCommit": "6b42a81b67ebcb27d95e80a3a9383386cb157ac5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8bea241eb654473b0585ef2df942d876472fc8e8", "url": "https://github.com/hazelcast/hazelcast/commit/8bea241eb654473b0585ef2df942d876472fc8e8", "message": "fix QueryCacheXmlConfigBuilderHelper", "committedDate": "2020-09-02T19:15:37Z", "type": "commit"}, {"oid": "b18fef4a2984482687411a6e3c3527c075e2db4a", "url": "https://github.com/hazelcast/hazelcast/commit/b18fef4a2984482687411a6e3c3527c075e2db4a", "message": "fix QueryCacheYamlConfigBuilderHelper", "committedDate": "2020-09-02T19:22:49Z", "type": "commit"}, {"oid": "8819819d1834a2ea15a04da34c23501d97f18690", "url": "https://github.com/hazelcast/hazelcast/commit/8819819d1834a2ea15a04da34c23501d97f18690", "message": "fix MemberDomConfigProcessor", "committedDate": "2020-09-02T19:47:57Z", "type": "commit"}, {"oid": "3229392bcf1ba6b4903d56c292d6744d472cde77", "url": "https://github.com/hazelcast/hazelcast/commit/3229392bcf1ba6b4903d56c292d6744d472cde77", "message": "fix MemberDomConfigProcessor", "committedDate": "2020-09-02T19:49:51Z", "type": "commit"}]}