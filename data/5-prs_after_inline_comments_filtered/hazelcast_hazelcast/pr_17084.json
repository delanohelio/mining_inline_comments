{"pr_number": 17084, "pr_title": "Fix fragmented message handling", "pr_createdAt": "2020-06-15T12:53:54Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17084", "timeline": [{"oid": "8d15d42b9c9727e76327d43d977bc184abec02e3", "url": "https://github.com/hazelcast/hazelcast/commit/8d15d42b9c9727e76327d43d977bc184abec02e3", "message": "Fix fragmented message handling\n\nBy definition, fragmented messages may have arbitrary number of frames.\nHowever, ClientMessageDecoder was using ClientMessage#createForDecode\nwhich expects a single frame that has no next frame. As the added test\nshows, that assumption generally does not hold. Start frame of the\nfragmented message may have next frames. The fix correctly creates\na client message using the start and end frames of the fragmented\nmessage.", "committedDate": "2020-06-15T12:44:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MTM5Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17084#discussion_r440651397", "bodyText": "Good finding. I think we can make further cleanups. Instead of creating a new message, we put the message directly to builderBySessionIdMap . We just need to dropFragmentationFrame .\n                   ClientMessage message = activeReader.getClientMessage();\n                    message.dropFragmentationFrame();\n                    long fragmentationId = Bits.readLongL(firstFrame.content, FRAGMENTATION_ID_OFFSET);\n                    if (ClientMessage.isFlagSet(flags, BEGIN_FRAGMENT_FLAG)) {\n                        builderBySessionIdMap.put(fragmentationId, message);\n\nWe have a new method on ClientMessage:\n  public void dropFragmentationFrame() {\n        startFrame = startFrame.next;\n    }\n\nand merge method should change accordingly. Dropping the fragmentation logic was there, and feeling wrong to begin with.\n public void merge(ClientMessage fragment) {\n        endFrame.next = fragment.startFrame;\n        endFrame = fragment.endFrame;\n    }\n\n@mdumandag How does that look ?", "author": "sancar", "createdAt": "2020-06-16T07:46:15Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/util/ClientMessageDecoder.java", "diffHunk": "@@ -90,13 +90,14 @@ public HandlerStatus onRead() {\n                     throw new IllegalStateException(\n                             \"Fragmented client messages are not allowed before the client is authenticated.\");\n                 } else {\n-                    ClientMessage.ForwardFrameIterator frameIterator = activeReader.getClientMessage().frameIterator();\n+                    ClientMessage message = activeReader.getClientMessage();\n+                    ClientMessage.ForwardFrameIterator frameIterator = message.frameIterator();\n                     //ignore the fragmentationFrame\n                     frameIterator.next();\n                     ClientMessage.Frame startFrame = frameIterator.next();\n                     long fragmentationId = Bits.readLongL(firstFrame.content, FRAGMENTATION_ID_OFFSET);\n                     if (ClientMessage.isFlagSet(flags, BEGIN_FRAGMENT_FLAG)) {\n-                        builderBySessionIdMap.put(fragmentationId, ClientMessage.createForDecode(startFrame));\n+                        builderBySessionIdMap.put(fragmentationId, new ClientMessage(startFrame, message.getEndFrame()));", "originalCommit": "8d15d42b9c9727e76327d43d977bc184abec02e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzMzk5Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17084#discussion_r440833992", "bodyText": "Thanks for the suggestion. That version looks better.", "author": "mdumandag", "createdAt": "2020-06-16T13:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MTM5Nw=="}], "type": "inlineReview"}, {"oid": "8f006ae421022068180639b80489d19bc13c771d", "url": "https://github.com/hazelcast/hazelcast/commit/8f006ae421022068180639b80489d19bc13c771d", "message": "do not create an extra message while putting it into", "committedDate": "2020-06-16T13:06:09Z", "type": "commit"}]}