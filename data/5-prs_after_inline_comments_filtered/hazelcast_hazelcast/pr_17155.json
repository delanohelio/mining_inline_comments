{"pr_number": 17155, "pr_title": "Nullify owned partitions instead of reloading", "pr_createdAt": "2020-07-01T11:39:33Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17155", "timeline": [{"oid": "4450197045d993810b871e3127c3660518661ce9", "url": "https://github.com/hazelcast/hazelcast/commit/4450197045d993810b871e3127c3660518661ce9", "message": "Nullify owned partitions instead of reloading", "committedDate": "2020-07-01T16:18:29Z", "type": "forcePushed"}, {"oid": "d1dc844babe62b76e6d4b969c743a485529d032d", "url": "https://github.com/hazelcast/hazelcast/commit/d1dc844babe62b76e6d4b969c743a485529d032d", "message": "Fix dependency problem", "committedDate": "2020-07-01T17:40:12Z", "type": "forcePushed"}, {"oid": "d9ee85d9bcaaea38c862697e64ef232cb2179bb3", "url": "https://github.com/hazelcast/hazelcast/commit/d9ee85d9bcaaea38c862697e64ef232cb2179bb3", "message": "Nullify owned partitions instead of reloading", "committedDate": "2020-07-01T19:38:40Z", "type": "forcePushed"}, {"oid": "8d9d5edc8cc3591bae1c620158b1490aea7cf299", "url": "https://github.com/hazelcast/hazelcast/commit/8d9d5edc8cc3591bae1c620158b1490aea7cf299", "message": "Nullify owned partitions instead of reloading", "committedDate": "2020-07-02T13:48:53Z", "type": "forcePushed"}, {"oid": "6003f162a39990264a4aaf5fe75bf2c68179f11b", "url": "https://github.com/hazelcast/hazelcast/commit/6003f162a39990264a4aaf5fe75bf2c68179f11b", "message": "Nullify owned partitions instead of reloading", "committedDate": "2020-07-03T08:52:14Z", "type": "forcePushed"}, {"oid": "787057f06b2e6745d50d39566df35840010d2aa4", "url": "https://github.com/hazelcast/hazelcast/commit/787057f06b2e6745d50d39566df35840010d2aa4", "message": "Nullify owned partitions instead of reloading", "committedDate": "2020-08-17T09:00:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTMyNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17155#discussion_r478375327", "bodyText": "What did we gain with this change? When was it an issue?", "author": "mmedenjak", "createdAt": "2020-08-27T12:19:35Z", "path": "hazelcast/src/main/java/com/hazelcast/map/impl/MapServiceContextImpl.java", "diffHunk": "@@ -483,17 +485,22 @@ public PartitionIdSet getOwnedPartitions() {\n      */\n     @Override\n     public void reloadOwnedPartitions() {\n-        final IPartitionService partitionService = nodeEngine.getPartitionService();\n+        IPartitionService partitionService = nodeEngine.getPartitionService();\n         for (; ; ) {\n-            final PartitionIdSet expected = ownedPartitions.get();\n-            final Collection<Integer> partitions = partitionService.getMemberPartitions(nodeEngine.getThisAddress());\n-            final PartitionIdSet newSet = immutablePartitionIdSet(partitionService.getPartitionCount(), partitions);\n+            PartitionIdSet expected = ownedPartitions.get();\n+            Collection<Integer> partitions = partitionService.getMemberPartitions(nodeEngine.getThisAddress());\n+            PartitionIdSet newSet = immutablePartitionIdSet(partitionService.getPartitionCount(), partitions);\n             if (ownedPartitions.compareAndSet(expected, newSet)) {\n                 return;\n             }\n         }\n     }\n \n+    @Override\n+    public void nullifyOwnedPartitions() {\n+        ownedPartitions.set(null);", "originalCommit": "787057f06b2e6745d50d39566df35840010d2aa4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM5MTUyNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17155#discussion_r478391525", "bodyText": "owned partition list is only needed for map loader. But in current codebase, every partition change triggers owned-partition-list update. This PR makes this update lazy.", "author": "ahmetmircik", "createdAt": "2020-08-27T12:46:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNzEwNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17155#discussion_r478427105", "bodyText": "It's also used in the old query engine, hence this fix -  #11471. Is the PartitionIdSet large in heap consumption?", "author": "mmedenjak", "createdAt": "2020-08-27T13:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ0NjA2Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17155#discussion_r478446063", "bodyText": "A PartitionIdSet wraps a JDK BitSet exposing a Set<Integer> interface along with primitive int methods to avoid (un-)boxing. Its size grows with partition count (1 long is required per 64 partitions -- not taking into account constant overhead of one int + one reference), so:\n\nfor default 271 partitions, size is 40 bytes. For comparison, a HashSet contains a HashMap whose size when empty is 44 bytes (assuming compressed OOPS - 64 bytes otherwise).\nfor 2000 partitions, size is 256 bytes.\nfor 20000 partitions, cost is 2,504 bytes.\n\nAt higher partition counts, a sparse Set<Integer> will be better in terms of memory cost than the current JDK BitSet. We should look into replacing the JDK BitSet with a better variant for high partition counts.", "author": "vbekiaris", "createdAt": "2020-08-27T14:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ2ODA3Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17155#discussion_r478468077", "bodyText": "\ud83d\ude47", "author": "mmedenjak", "createdAt": "2020-08-27T14:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTMyNw=="}], "type": "inlineReview"}, {"oid": "9390cbe1ebb51b00ed6d4d442c39ba409482b4d7", "url": "https://github.com/hazelcast/hazelcast/commit/9390cbe1ebb51b00ed6d4d442c39ba409482b4d7", "message": "Nullify owned partitions instead of reloading", "committedDate": "2020-08-27T14:39:41Z", "type": "commit"}, {"oid": "9390cbe1ebb51b00ed6d4d442c39ba409482b4d7", "url": "https://github.com/hazelcast/hazelcast/commit/9390cbe1ebb51b00ed6d4d442c39ba409482b4d7", "message": "Nullify owned partitions instead of reloading", "committedDate": "2020-08-27T14:39:41Z", "type": "forcePushed"}]}