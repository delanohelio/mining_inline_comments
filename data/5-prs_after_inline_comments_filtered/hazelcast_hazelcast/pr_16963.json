{"pr_number": 16963, "pr_title": "SQL DDL prototype", "pr_createdAt": "2020-05-07T07:27:30Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16963", "timeline": [{"oid": "5924b6283e696e26556da5a6d4d2e508f9d5181b", "url": "https://github.com/hazelcast/hazelcast/commit/5924b6283e696e26556da5a6d4d2e508f9d5181b", "message": "Parse CREATE/DROP TABLE", "committedDate": "2020-04-30T13:41:42Z", "type": "commit"}, {"oid": "48162e6580a9d39884e6779b4d7ac85fa5cc3b22", "url": "https://github.com/hazelcast/hazelcast/commit/48162e6580a9d39884e6779b4d7ac85fa5cc3b22", "message": "Merge branch 'sql' into ddl\n\n# Conflicts:\n#\thazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/OptimizerContext.java", "committedDate": "2020-05-04T06:39:37Z", "type": "commit"}, {"oid": "2a94d1e05af084b4ec5a71c954fe662fd4f5fafd", "url": "https://github.com/hazelcast/hazelcast/commit/2a94d1e05af084b4ec5a71c954fe662fd4f5fafd", "message": "Naming & update interface", "committedDate": "2020-05-04T08:02:42Z", "type": "commit"}, {"oid": "5c88067ca66136354598ac3be5183d4c10647dab", "url": "https://github.com/hazelcast/hazelcast/commit/5c88067ca66136354598ac3be5183d4c10647dab", "message": "Add support for user defined tables", "committedDate": "2020-05-05T12:20:41Z", "type": "commit"}, {"oid": "b519267aae7bf5d586d9e2c3e129d358daa6598b", "url": "https://github.com/hazelcast/hazelcast/commit/b519267aae7bf5d586d9e2c3e129d358daa6598b", "message": "Cleanup", "committedDate": "2020-05-05T12:57:10Z", "type": "commit"}, {"oid": "f9e2610711eb56603ca9124b53e8c8b81c1244bb", "url": "https://github.com/hazelcast/hazelcast/commit/f9e2610711eb56603ca9124b53e8c8b81c1244bb", "message": "Create user defined tables under default schema", "committedDate": "2020-05-06T10:10:47Z", "type": "commit"}, {"oid": "554b9f1e2abce00bc8f0d507391a707e0cd1b0fa", "url": "https://github.com/hazelcast/hazelcast/commit/554b9f1e2abce00bc8f0d507391a707e0cd1b0fa", "message": "Merge branch 'sql' into ddl", "committedDate": "2020-05-06T10:18:06Z", "type": "commit"}, {"oid": "a2bc6afe604281abb35f445635e009028fdc066d", "url": "https://github.com/hazelcast/hazelcast/commit/a2bc6afe604281abb35f445635e009028fdc066d", "message": "Cleanup", "committedDate": "2020-05-06T10:24:52Z", "type": "commit"}, {"oid": "a1d241f0a231dd03ad491057735b206e46b60179", "url": "https://github.com/hazelcast/hazelcast/commit/a1d241f0a231dd03ad491057735b206e46b60179", "message": "Evolving table schema", "committedDate": "2020-05-06T11:22:58Z", "type": "commit"}, {"oid": "89596c3b01fbcde1cee11c3e9ff57b77071b85ae", "url": "https://github.com/hazelcast/hazelcast/commit/89596c3b01fbcde1cee11c3e9ff57b77071b85ae", "message": "Add schema dsitribution test", "committedDate": "2020-05-06T12:03:19Z", "type": "commit"}, {"oid": "814b8e52f7bc8c250b1520f2bdbed4d98cfbfe92", "url": "https://github.com/hazelcast/hazelcast/commit/814b8e52f7bc8c250b1520f2bdbed4d98cfbfe92", "message": "Cleanup", "committedDate": "2020-05-06T12:05:32Z", "type": "commit"}, {"oid": "ec79988d281f09830ae8c58db92b5b2211615421", "url": "https://github.com/hazelcast/hazelcast/commit/ec79988d281f09830ae8c58db92b5b2211615421", "message": "Cleanup", "committedDate": "2020-05-06T13:07:42Z", "type": "commit"}, {"oid": "03549967693f17ec359ab425fcd59cf2e6452e85", "url": "https://github.com/hazelcast/hazelcast/commit/03549967693f17ec359ab425fcd59cf2e6452e85", "message": "Cleanup", "committedDate": "2020-05-06T14:10:42Z", "type": "commit"}, {"oid": "0843cdb221f550cd558c604770dde6e012eb4eac", "url": "https://github.com/hazelcast/hazelcast/commit/0843cdb221f550cd558c604770dde6e012eb4eac", "message": "Cleanup", "committedDate": "2020-05-07T07:22:02Z", "type": "commit"}, {"oid": "9f2ce834e8c1e4da631031bf0261443d7a7e3830", "url": "https://github.com/hazelcast/hazelcast/commit/9f2ce834e8c1e4da631031bf0261443d7a7e3830", "message": "Make checkstyle happy", "committedDate": "2020-05-07T07:52:17Z", "type": "commit"}, {"oid": "361d5ef9e06b039503635b7a50ed5d0a77e5623d", "url": "https://github.com/hazelcast/hazelcast/commit/361d5ef9e06b039503635b7a50ed5d0a77e5623d", "message": "Merge branch 'sql' into ddl\n\n# Conflicts:\n#\thazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/ExecutionConfig.java\n#\thazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/ExecutionContext.java\n#\thazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/opt/SqlOptimizer.java\n#\thazelcast-sql/src/test/java/com/hazelcast/sql/optimizer/support/OptimizerTestSupport.java\n#\thazelcast-sql/src/test/java/com/hazelcast/sql/tpch/TpcHTest.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/SqlServiceImpl.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/optimizer/NoOpSqlOptimizer.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/optimizer/NotImplementedSqlOptimizer.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/parser/NoOpSqlParser.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/schema/SchemaUtils.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/schema/map/ReplicatedMapTableResolver.java", "committedDate": "2020-05-07T10:08:35Z", "type": "commit"}, {"oid": "7724c7c6353744dfe83927a8ebcc402c0f8d8cab", "url": "https://github.com/hazelcast/hazelcast/commit/7724c7c6353744dfe83927a8ebcc402c0f8d8cab", "message": "Address type parsing review comments", "committedDate": "2020-05-07T10:13:00Z", "type": "commit"}, {"oid": "6a53f6ab40870badb262c8fc65ae03a98f04d42a", "url": "https://github.com/hazelcast/hazelcast/commit/6a53f6ab40870badb262c8fc65ae03a98f04d42a", "message": "Make checkstyle happy", "committedDate": "2020-05-07T10:20:52Z", "type": "commit"}, {"oid": "488ef52f954083be43d6b1711e2de2016cb2d467", "url": "https://github.com/hazelcast/hazelcast/commit/488ef52f954083be43d6b1711e2de2016cb2d467", "message": "Make checkstyle happy", "committedDate": "2020-05-07T10:21:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM5ODMyMg==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421398322", "bodyText": "I propose to avoid renames of the central classes unless there is a strong reason to. In this specific case, parsing is a part of optimization process, not vice versa.", "author": "devozerov", "createdAt": "2020-05-07T10:20:36Z", "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/optimizer/SqlOptimizer.java", "diffHunk": "@@ -14,77 +14,50 @@\n  * limitations under the License.\n  */\n \n-package com.hazelcast.sql.impl.calcite;\n+package com.hazelcast.sql.impl.calcite.optimizer;\n \n-import com.hazelcast.cluster.memberselector.MemberSelectors;\n import com.hazelcast.internal.util.collection.PartitionIdSet;\n import com.hazelcast.partition.Partition;\n import com.hazelcast.spi.impl.NodeEngine;\n import com.hazelcast.sql.impl.QueryParameterMetadata;\n+import com.hazelcast.sql.impl.calcite.ExecutionContext;\n import com.hazelcast.sql.impl.calcite.opt.logical.LogicalRel;\n import com.hazelcast.sql.impl.calcite.opt.physical.PhysicalRel;\n import com.hazelcast.sql.impl.calcite.opt.physical.visitor.NodeIdVisitor;\n import com.hazelcast.sql.impl.calcite.opt.physical.visitor.PlanCreateVisitor;\n import com.hazelcast.sql.impl.calcite.opt.physical.visitor.SqlToQueryType;\n import com.hazelcast.sql.impl.calcite.parse.QueryParseResult;\n-import com.hazelcast.sql.impl.optimizer.OptimizationTask;\n-import com.hazelcast.sql.impl.optimizer.SqlOptimizer;\n import com.hazelcast.sql.impl.plan.Plan;\n-import com.hazelcast.sql.impl.schema.TableResolver;\n-import com.hazelcast.sql.impl.schema.map.PartitionedMapTableResolver;\n-import com.hazelcast.sql.impl.schema.map.ReplicatedMapTableResolver;\n import com.hazelcast.sql.impl.type.QueryDataType;\n import org.apache.calcite.rel.RelNode;\n import org.apache.calcite.rel.type.RelDataType;\n \n-import java.util.ArrayList;\n import java.util.Collection;\n import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.UUID;\n \n-/**\n- * Calcite-based SQL optimizer.\n- */\n-@SuppressWarnings(\"checkstyle:ClassDataAbstractionCoupling\")\n-public class CalciteSqlOptimizer implements SqlOptimizer {\n+public class SqlOptimizer {\n     /** Node engine. */\n     private final NodeEngine nodeEngine;\n \n-    public CalciteSqlOptimizer(NodeEngine nodeEngine) {\n+    public SqlOptimizer(NodeEngine nodeEngine) {", "originalCommit": "7724c7c6353744dfe83927a8ebcc402c0f8d8cab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyMDc5OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421420799", "bodyText": "I can avoid renames but it is going to be awkward.\nRegarding what is part of what. I have extracted parsing part from CalciteSqlOptimizer, there is nothing to optimize in DDL statements, thus created SqlParser that is able to convert a sql string into an executable statement, part of that conversion for DQLs is optimization. Not sure how else it could be done.", "author": "gierlachg", "createdAt": "2020-05-07T11:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM5ODMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMDU4OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421400589", "bodyText": "We cannot use empty schema names. A classical object hierarchy is catalog -> schema -> object. Every such an object should have a definitive name for several reasons:\n\nThey need to be displayed somehow in tools that will talk to us through JDBC\nIt should be possible to reach any object from any naming context. With empty schema name, some objects may become unreachable\n\nOther vendors typically have a default schema name PUBLIC or alike.", "author": "devozerov", "createdAt": "2020-05-07T10:24:49Z", "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/schema/HazelcastSchemaUtils.java", "diffHunk": "@@ -65,30 +68,33 @@ public static HazelcastSchema createRootSchema(List<TableResolver> tableResolver\n \n             for (Table table : tables) {\n                 HazelcastTable convertedTable = new HazelcastTable(\n-                    table,\n-                    createTableStatistic(table)\n+                        table,\n+                        createTableStatistic(table)\n                 );\n \n-                Map<String , HazelcastTable> schemaTableMap =\n-                    tableMap.computeIfAbsent(table.getSchemaName(), (k) -> new HashMap<>());\n+                if (table.getSchemaName() == null || table.getSchemaName().isEmpty()) {", "originalCommit": "7724c7c6353744dfe83927a8ebcc402c0f8d8cab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMjQ2OA==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421402468", "bodyText": "I am not very keen on having such methods on public API because it increases complexity for users and we need a common method that handles all query types anyway, because otherwise, we will not be able to integrate JDBC.\nIs there a reason why the existing method or at least re-use of SqlQuery is not applicable for an update operation?", "author": "devozerov", "createdAt": "2020-05-07T10:28:24Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/SqlService.java", "diffHunk": "@@ -49,4 +50,22 @@ default SqlCursor query(String sql, Object... params) {\n      * @return Cursor.\n      */\n     SqlCursor query(SqlQuery query);\n+\n+    /**\n+     * Execute update.\n+     *\n+     * @param sql SQL.\n+     */\n+    default void update(String sql) {", "originalCommit": "7724c7c6353744dfe83927a8ebcc402c0f8d8cab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQxNjYyNA==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421416624", "bodyText": "If we reused existing method SqlCursor query(SqlQuery query) we would need to return SqlCursor from an execution of DDL statement, of course I could return a cursor containing single value of 0 but it just felt cumbersome - that's the thing we were discussing yesterday - I can squeeze DDL into existing method for now if we don't want to make any decision now and postpone the API decision till later.", "author": "gierlachg", "createdAt": "2020-05-07T10:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMjQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwNTAwNg==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421405006", "bodyText": "It is not clear why SELECT is wrapped into a DDL class", "author": "devozerov", "createdAt": "2020-05-07T10:33:07Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/SqlServiceImpl.java", "diffHunk": "@@ -156,84 +164,106 @@ private SqlCursor query0(String sql, List<Object> params, long timeout, int page\n         }\n \n         if (timeout < 0) {\n-            throw QueryException.error(\"Timeout cannot be negative: \" + pageSize);\n+            throw QueryException.error(\"Timeout cannot be negative: \" + timeout);\n         }\n \n         if (pageSize <= 0) {\n             throw QueryException.error(\"Page size must be positive: \" + pageSize);\n         }\n \n         // Execute.\n-        QueryState state;\n-\n         if (QueryUtils.isExplain(sql)) {\n             String unwrappedSql = QueryUtils.unwrapExplain(sql);\n \n             if (unwrappedSql.isEmpty()) {\n                 throw QueryException.error(\"SQL statement to be explained cannot be empty\");\n             }\n \n-            Plan plan = prepare(unwrappedSql);\n+            DqlStatement operation = prepareQuery(unwrappedSql);\n+            return operation.explain(internalService);\n+        } else {\n+            DqlStatement operation = prepareQuery(sql);\n+            return operation.execute(internalService, params0, timeout, pageSize);\n+        }\n+    }\n \n-            state = internalService.executeExplain(plan);\n+    private DqlStatement prepareQuery(String sql) {", "originalCommit": "7724c7c6353744dfe83927a8ebcc402c0f8d8cab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQxNzE2OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421417169", "bodyText": "I'm not sure I follow.", "author": "gierlachg", "createdAt": "2020-05-07T10:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwNTAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwNTg3Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421405872", "bodyText": "As mentioned before, the motivation of the rename is not obvious. This underlying implementation is optimizer, not parser.", "author": "devozerov", "createdAt": "2020-05-07T10:34:38Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/parser/SqlParser.java", "diffHunk": "@@ -14,19 +14,18 @@\n  * limitations under the License.\n  */\n \n-package com.hazelcast.sql.impl.optimizer;\n-\n-import com.hazelcast.sql.impl.plan.Plan;\n+package com.hazelcast.sql.impl.parser;\n \n /**\n- * Optimizer responsible for conversion of SQL string to executable plan.\n+ * Parser responsible for conversion of SQL string to executable statement.\n  */\n-public interface SqlOptimizer {\n+public interface SqlParser {", "originalCommit": "7724c7c6353744dfe83927a8ebcc402c0f8d8cab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea77ee8495ce48a3e31a2b0d559a2b111066e493", "url": "https://github.com/hazelcast/hazelcast/commit/ea77ee8495ce48a3e31a2b0d559a2b111066e493", "message": "Address type parsing review comments", "committedDate": "2020-05-07T10:37:50Z", "type": "commit"}, {"oid": "ba22d0c75626bbeafcdc74c7f291590379e1f4ef", "url": "https://github.com/hazelcast/hazelcast/commit/ba22d0c75626bbeafcdc74c7f291590379e1f4ef", "message": "Make checkstyle happy", "committedDate": "2020-05-07T10:41:55Z", "type": "commit"}, {"oid": "b8a84810b4913aa437ec42caf6534babdd01fb7a", "url": "https://github.com/hazelcast/hazelcast/commit/b8a84810b4913aa437ec42caf6534babdd01fb7a", "message": "Address review comments", "committedDate": "2020-05-07T11:28:35Z", "type": "commit"}, {"oid": "40353b6a5ec48ca60f33b0a0f9f8591c6427fc38", "url": "https://github.com/hazelcast/hazelcast/commit/40353b6a5ec48ca60f33b0a0f9f8591c6427fc38", "message": "Address review comments", "committedDate": "2020-05-07T12:28:59Z", "type": "commit"}, {"oid": "b47b6bfc794d4f2206c6c04f9083ad8c90eddc9b", "url": "https://github.com/hazelcast/hazelcast/commit/b47b6bfc794d4f2206c6c04f9083ad8c90eddc9b", "message": "Address review comments", "committedDate": "2020-05-07T12:51:48Z", "type": "commit"}, {"oid": "16b223994fa553228fb6f102470a0af3e1606abd", "url": "https://github.com/hazelcast/hazelcast/commit/16b223994fa553228fb6f102470a0af3e1606abd", "message": "Merge branch 'sql' into ddl\n\n# Conflicts:\n#\thazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/CalciteSqlOptimizer.java\n#\thazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/OptimizerContext.java", "committedDate": "2020-05-07T12:57:10Z", "type": "commit"}, {"oid": "016bfa3a2c437880ce1074e8c326490486a7bee5", "url": "https://github.com/hazelcast/hazelcast/commit/016bfa3a2c437880ce1074e8c326490486a7bee5", "message": "Merge origin/sql", "committedDate": "2020-05-07T13:07:16Z", "type": "commit"}, {"oid": "d6e3cb4f7f27c8608ee55493e3e8c951e4a5ba8d", "url": "https://github.com/hazelcast/hazelcast/commit/d6e3cb4f7f27c8608ee55493e3e8c951e4a5ba8d", "message": "Exclude generated sources from spotbugs examination", "committedDate": "2020-05-07T13:24:18Z", "type": "commit"}, {"oid": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "url": "https://github.com/hazelcast/hazelcast/commit/724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "message": "Exclude generated calcite sources from spotbugs examination", "committedDate": "2020-05-07T14:08:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NzgxMA==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421657810", "bodyText": "As you mentioned in the TODO, I also do not think that we need it at the moment, given that tables are already exposed.  Moreover, this is not an \"external\" object for the cluster. I would remove it for now and return back if we have any indication that it is needed.", "author": "devozerov", "createdAt": "2020-05-07T17:04:18Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/connector/PartitionedMapConnector.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.connector;\n+\n+import com.hazelcast.sql.impl.extract.GenericQueryTargetDescriptor;\n+import com.hazelcast.sql.impl.extract.QueryPath;\n+import com.hazelcast.sql.impl.schema.ConstantTableStatistics;\n+import com.hazelcast.sql.impl.schema.Table;\n+import com.hazelcast.sql.impl.schema.TableField;\n+import com.hazelcast.sql.impl.schema.TableSchema.Field;\n+import com.hazelcast.sql.impl.schema.map.MapTableField;\n+import com.hazelcast.sql.impl.schema.map.PartitionedMapTable;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.hazelcast.sql.impl.schema.map.PartitionedMapTable.DISTRIBUTION_FIELD_ORDINAL_NONE;\n+import static java.util.Collections.emptyList;\n+import static java.util.stream.Collectors.toList;\n+\n+// TODO: do we want to keep it? maps are auto discovered...", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2NjI1MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421966251", "bodyText": "What about leaving it till we we have some tests on Jet side using IMDG SqlService?", "author": "gierlachg", "createdAt": "2020-05-08T06:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NDcyNw==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421984727", "bodyText": "Could you please clarify what kind of tests you mean? I am not against keeping it for a while, but please note that this connector creates a table that does not expose useful map information, such as indexes and distribution field. Therefore its usage even in tests is questionable.", "author": "devozerov", "createdAt": "2020-05-08T07:17:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NzU4Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421987582", "bodyText": "Something like SchemaTest so we make sure DDL/creating tables works and it is not broken during development of other things.", "author": "gierlachg", "createdAt": "2020-05-08T07:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4ODA1Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421988057", "bodyText": "Got it, thanks.", "author": "devozerov", "createdAt": "2020-05-08T07:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NzgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1ODM4Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421658382", "bodyText": "Minor: we may need table options here in the future, but for the sake of prototyping this is not relevant.", "author": "devozerov", "createdAt": "2020-05-07T17:05:19Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/connector/SqlConnector.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.connector;\n+\n+import com.hazelcast.sql.impl.schema.Table;\n+import com.hazelcast.sql.impl.schema.TableSchema.Field;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+public interface SqlConnector {\n+\n+    Table createTable(\n+            String schemaName,\n+            String name,\n+            List<Field> fields,", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2Mjc2NA==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421962764", "bodyText": "You mean something else than Map<String, String> options ?", "author": "gierlachg", "createdAt": "2020-05-08T06:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1ODM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NTczNA==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421985734", "bodyText": "Sorry, please disregard. I meant field options, not table options. And field options are already present.", "author": "devozerov", "createdAt": "2020-05-08T07:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1ODM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1ODkxNA==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421658914", "bodyText": "As far as I understand, we are supposed to call Jet via some sort of reflection or service discovery here, in order to install more connectors?", "author": "devozerov", "createdAt": "2020-05-07T17:06:13Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/connector/SqlConnectorFactory.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.connector;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public final class SqlConnectorFactory {\n+\n+    // TODO: replace it with connector class and its instantiation ???\n+    // (TableSchemaField, Table, TableField, QueryDataType etc. need to be public then?)\n+    private static final Map<String, SqlConnector> CONNECTORS_BY_TYPE = prepareConnectors();\n+\n+    private SqlConnectorFactory() {\n+    }\n+\n+    private static Map<String, SqlConnector> prepareConnectors() {", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2MjYwMg==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421962602", "bodyText": "That is yet to be decided, we might pass the class name as type while creating the table so we could even accept user defined connectors, however that would require publishing certain classes that are private now - Table, QueryDataType etc.", "author": "gierlachg", "createdAt": "2020-05-08T06:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1ODkxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NzY5Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421987692", "bodyText": "I see. Given that we do not expect more serious code conflicts around the optimizer code base, for now, it may worth trying to add some real connectors (say, Kafka) to see how it to wire them up properly. Having such connectors not only will help us get a better understanding of how to wire them up but also will help us get rid of connectors for cluster-local maps.\nBut maybe it is better to do this separately, to keep PRs more manageable.", "author": "devozerov", "createdAt": "2020-05-08T07:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1ODkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2MTE4Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421661187", "bodyText": "As far as I understand, if we remove local map connectors, these changes are no longer needed, since every map will reside in the predefined schema?\nNevertheless, in future, we may need to allow for certain maps to reside in specific schemas for the sake of convenience (e.g. in multi-tenant applications). But it is not very clear at the moment how to achieve this - through configuration, some DDL commands, an alias, or something else.\nGiven that we do not have concrete requirements to map maps into non-standard schemes for now, perhaps it is better to keep the implementation simple.", "author": "devozerov", "createdAt": "2020-05-07T17:10:04Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/schema/map/PartitionedMapTable.java", "diffHunk": "@@ -41,7 +41,21 @@ public PartitionedMapTable(\n         List<MapTableIndex> indexes,\n         int distributionFieldOrdinal\n     ) {\n-        super(SCHEMA_NAME_PARTITIONED, name, fields, statistics, keyDescriptor, valueDescriptor);\n+        this(SCHEMA_NAME_PARTITIONED, name, fields, statistics, keyDescriptor, valueDescriptor, indexes,\n+                distributionFieldOrdinal);\n+    }\n+\n+    public PartitionedMapTable(", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2MTg4NA==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421661884", "bodyText": "This class defines an external source, so maybe it makes sense to add External to the name for clarity. ExternalTableSchema?", "author": "devozerov", "createdAt": "2020-05-07T17:11:21Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/schema/TableSchema.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.schema;\n+\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.DataSerializable;\n+import com.hazelcast.sql.impl.type.QueryDataType;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * User defined table schema definition.\n+ */\n+public class TableSchema implements DataSerializable {", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2MzYyMw==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421663623", "bodyText": "We skip the system replicated map when resolving objects. I think we need to do the same for other system Jet maps created during job execution. I would propose to follow the same naming as other Jet maps do.\nIdeally, we would like to have some single namespace for all system maps that should not be displayed to the user. I am not sure whether it is possible to rename existing Jet maps due to compatibility constraints.\nIn any case, this is what we should keep in mind for production implementation. Not very important for the prototype.", "author": "devozerov", "createdAt": "2020-05-07T17:14:24Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/schema/Catalog.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.schema;\n+\n+import com.hazelcast.spi.impl.NodeEngine;\n+import com.hazelcast.sql.impl.QueryException;\n+import com.hazelcast.sql.impl.connector.SqlConnector;\n+import com.hazelcast.sql.impl.connector.SqlConnectorFactory;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.hazelcast.sql.impl.QueryUtils.CATALOG;\n+import static com.hazelcast.sql.impl.QueryUtils.SCHEMA_NAME_PUBLIC;\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+\n+public class Catalog implements TableResolver {\n+\n+    // TODO: is it the best/right name?\n+    public static final String CATALOG_MAP_NAME = \"__sql.catalog\";", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2NDY2MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421664661", "bodyText": "Likewise, I would add External here to explicitly denote that this is a resolver for external objects.", "author": "devozerov", "createdAt": "2020-05-07T17:16:08Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/schema/Catalog.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.schema;\n+\n+import com.hazelcast.spi.impl.NodeEngine;\n+import com.hazelcast.sql.impl.QueryException;\n+import com.hazelcast.sql.impl.connector.SqlConnector;\n+import com.hazelcast.sql.impl.connector.SqlConnectorFactory;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.hazelcast.sql.impl.QueryUtils.CATALOG;\n+import static com.hazelcast.sql.impl.QueryUtils.SCHEMA_NAME_PUBLIC;\n+import static java.util.Arrays.asList;\n+import static java.util.Collections.singletonList;\n+import static java.util.stream.Collectors.toList;\n+\n+public class Catalog implements TableResolver {", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2NTYzMg==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421665632", "bodyText": "Minor: it seems that some IDEA quirk kicks in here, adding automatic padding to the files when they are opened. It is better to turn off it to minimize PR scope.", "author": "devozerov", "createdAt": "2020-05-07T17:17:51Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/SqlService.java", "diffHunk": "@@ -26,7 +26,7 @@\n     /**\n      * Execute query.\n      *\n-     * @param sql SQL.\n+     * @param sql    SQL.", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0Nzc2Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421947766", "bodyText": "Minor thought for future: maybe it makes sense to add this \"unparsing\" to QueryDataType itself so that we do not miss something when a new type is added.\nNot relevant for prototyping.", "author": "devozerov", "createdAt": "2020-05-08T05:34:08Z", "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/parse/SqlDataType.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.calcite.parse;\n+\n+import com.hazelcast.sql.impl.type.QueryDataType;\n+import org.apache.calcite.sql.SqlIdentifier;\n+import org.apache.calcite.sql.SqlWriter;\n+import org.apache.calcite.sql.parser.SqlParserPos;\n+\n+public class SqlDataType extends SqlIdentifier {\n+\n+    private final QueryDataType type;\n+\n+    public SqlDataType(QueryDataType type, SqlParserPos pos) {\n+        super(type.toString(), pos);\n+        this.type = type;\n+    }\n+\n+    public QueryDataType type() {\n+        return type;\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"checkstyle:CyclomaticComplexity\")\n+    public void unparse(SqlWriter writer, int leftPrec, int rightPrec) {\n+        if (type == QueryDataType.BOOLEAN) {", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1MDg1Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/16963#discussion_r421950857", "bodyText": "Here we make the purpose of optimization stage fuzzy, because sometimes optimizer does optimization, sometimes it does parsing and execution. I would prefer to retain clear boundaries for component responsibilities so that the optimizer prepares the plan, and then in the SqlServiceImpl we decide how to execute the returned plan. This is needed to ensure that we can evolve the engine easily. For example, consider that in future we will need to implement SQL query statistics or asynchronous query cancellation for JDBC. With a centralized approach, it will be much easier than trying to hook into disparate execution points.\nI do not want to slow down the prototyping due to this comment, so I propose to do the following:\n\nGo on with the current approach for now\nSoon I will switch to API implementation, where I can try to decouple execution from planning in the following way:\n\n\nPlanner return a plan that could be SELECT plan, DDL plan, etc\nThen depending on the plan type, we feed it to a designated handler in the \"core\" module", "author": "devozerov", "createdAt": "2020-05-08T05:45:25Z", "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/SqlServiceImpl.java", "diffHunk": "@@ -174,10 +174,16 @@ private SqlCursor query0(String sql, List<Object> params, long timeout, int page\n             }\n \n             Plan plan = prepare(unwrappedSql);\n+            if (plan == null) {\n+                return new SingleValueSqlCursor(0);\n+            }\n \n             state = internalService.executeExplain(plan);\n         } else {\n             Plan plan = prepare(sql);\n+            if (plan == null) {", "originalCommit": "724a617b7a6218b0b7ca26c077cdf8e02e5ff10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8498319b50698b80dbc9bdf86d7089e54340cbd5", "url": "https://github.com/hazelcast/hazelcast/commit/8498319b50698b80dbc9bdf86d7089e54340cbd5", "message": "Naming", "committedDate": "2020-05-08T06:38:58Z", "type": "commit"}, {"oid": "9a28d52bc61c05d881fd15e69942a548e09d202e", "url": "https://github.com/hazelcast/hazelcast/commit/9a28d52bc61c05d881fd15e69942a548e09d202e", "message": "Naming", "committedDate": "2020-05-08T06:44:04Z", "type": "commit"}, {"oid": "fdf3a307bfd2fcf84cb7c151a505294a278e5cd6", "url": "https://github.com/hazelcast/hazelcast/commit/fdf3a307bfd2fcf84cb7c151a505294a278e5cd6", "message": "Cleanup", "committedDate": "2020-05-08T07:37:52Z", "type": "commit"}]}