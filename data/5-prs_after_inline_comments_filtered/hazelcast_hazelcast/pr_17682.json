{"pr_number": 17682, "pr_title": "Check duplicate fields when building class definition", "pr_createdAt": "2020-10-05T11:30:26Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17682", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU1OTM5Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r499559393", "bodyText": "A style comment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (addedFieldNames.contains(fieldName)) {\n          \n          \n            \n                        throw new HazelcastSerializationException(\"Field with field name : \" + fieldName + \" already exists\");\n          \n          \n            \n                    }\n          \n          \n            \n                    addedFieldNames.add(fieldName);\n          \n          \n            \n                    if (!addedFieldNames.add(fieldName)) {\n          \n          \n            \n                        throw new HazelcastSerializationException(\"Field with field name : \" + fieldName + \" already exists\");\n          \n          \n            \n                    }", "author": "viliam-durina", "createdAt": "2020-10-05T12:26:36Z", "path": "hazelcast/src/main/java/com/hazelcast/nio/serialization/ClassDefinitionBuilder.java", "diffHunk": "@@ -213,7 +341,11 @@ public ClassDefinition build() {\n         return cd;\n     }\n \n-    private void check() {\n+    private void check(String fieldName) {\n+        if (addedFieldNames.contains(fieldName)) {\n+            throw new HazelcastSerializationException(\"Field with field name : \" + fieldName + \" already exists\");\n+        }\n+        addedFieldNames.add(fieldName);", "originalCommit": "344a0b0df7ca238bb43afd5e5bf516ec4371c1c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1e126e5064164a5bace665b26ed0967948bb6ee3", "url": "https://github.com/hazelcast/hazelcast/commit/1e126e5064164a5bace665b26ed0967948bb6ee3", "message": "Check duplicate fields when building class definition\n\nClassDefinitionBuider.addX methods checks if a field\nis already added with same name and\nthrows HazelcastSerializatioException if already added.\n\nfixes https://github.com/hazelcast/hazelcast/issues/17616", "committedDate": "2020-10-05T12:32:11Z", "type": "commit"}, {"oid": "1e126e5064164a5bace665b26ed0967948bb6ee3", "url": "https://github.com/hazelcast/hazelcast/commit/1e126e5064164a5bace665b26ed0967948bb6ee3", "message": "Check duplicate fields when building class definition\n\nClassDefinitionBuider.addX methods checks if a field\nis already added with same name and\nthrows HazelcastSerializatioException if already added.\n\nfixes https://github.com/hazelcast/hazelcast/issues/17616", "committedDate": "2020-10-05T12:32:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2ODU2NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r499568565", "bodyText": "HazelcastSerializationException isn't correct IMO. It should be thrown \"when a problem occurs while serializing/deserializing objects\". This should rather be IllegalStateException.\nBut it's consistent with the same issue 3 lines below...", "author": "viliam-durina", "createdAt": "2020-10-05T12:42:27Z", "path": "hazelcast/src/main/java/com/hazelcast/nio/serialization/ClassDefinitionBuilder.java", "diffHunk": "@@ -213,7 +341,10 @@ public ClassDefinition build() {\n         return cd;\n     }\n \n-    private void check() {\n+    private void check(String fieldName) {\n+        if (!addedFieldNames.add(fieldName)) {\n+            throw new HazelcastSerializationException(\"Field with field name : \" + fieldName + \" already exists\");", "originalCommit": "1e126e5064164a5bace665b26ed0967948bb6ee3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b8d43b7633c7441a129c90553973abacf4a54e8", "url": "https://github.com/hazelcast/hazelcast/commit/7b8d43b7633c7441a129c90553973abacf4a54e8", "message": "address review comments. Javadoc and test update.", "committedDate": "2020-10-06T08:22:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5ODQyNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r500298424", "bodyText": "Forgot to mention one potential problem with this approach. In situation when #addPortableArrayField() or #addPortableField() are invoked with incorrect ClassDefinition definition (with zero classId), the field will be added into the addedFieldNames, while, in fact, it wasn't added due to next failed check. The simplest fix would be to remove the field from addedFieldNames before throwing an IllegalArgumentException in those methods, but there might be more elegant solutions like changing validation order.", "author": "puzpuzpuz", "createdAt": "2020-10-06T13:52:51Z", "path": "hazelcast/src/main/java/com/hazelcast/nio/serialization/ClassDefinitionBuilder.java", "diffHunk": "@@ -213,7 +341,10 @@ public ClassDefinition build() {\n         return cd;\n     }\n \n-    private void check() {\n+    private void check(String fieldName) {\n+        if (!addedFieldNames.add(fieldName)) {", "originalCommit": "7b8d43b7633c7441a129c90553973abacf4a54e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxOTM0NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r500319344", "bodyText": "Good catch. I fixed it.", "author": "sancar", "createdAt": "2020-10-06T14:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5ODQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMzcwNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r500403707", "bodyText": "I'd say it doesn't matter. As soon as the builder throws an exception, it should be considered broken. A code that catches an exception and continue with the builder is very rare I'd say...", "author": "viliam-durina", "createdAt": "2020-10-06T15:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5ODQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2NjM0OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r500766348", "bodyText": "It's normal to keep using the builder after a validation exception was thrown. If we consider the object broken, we must enforce this contract and throw on any subsequent call. A public API shouldn't be based on fuzzy assumptions which only exist in maintainers minds.", "author": "puzpuzpuz", "createdAt": "2020-10-07T06:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5ODQyNA=="}], "type": "inlineReview"}, {"oid": "8086e4af0138f4bcdf8538a36f0a65a8536dba69", "url": "https://github.com/hazelcast/hazelcast/commit/8086e4af0138f4bcdf8538a36f0a65a8536dba69", "message": "fix addPortable/ArrayField", "committedDate": "2020-10-06T14:12:34Z", "type": "commit"}]}