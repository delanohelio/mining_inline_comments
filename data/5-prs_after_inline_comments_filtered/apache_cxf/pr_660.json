{"pr_number": 660, "pr_title": "[CXF-8263] Support SSEs in MP Rest Client 2.0", "pr_createdAt": "2020-04-17T19:28:16Z", "pr_url": "https://github.com/apache/cxf/pull/660", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNTc5MA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410725790", "bodyText": "Should be final as well?", "author": "reta", "createdAt": "2020-04-18T17:24:33Z", "path": "rt/rs/microprofile-client/src/main/java/org/apache/cxf/microprofile/client/sse/SsePublisher.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.cxf.microprofile.client.sse;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import javax.ws.rs.ext.Providers;\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import org.reactivestreams.Publisher;\n+import org.reactivestreams.Subscriber;\n+\n+public class SsePublisher implements Publisher<InboundSseEvent> {\n+\n+    final Executor executor;\n+    final BufferedReader br;\n+    final Providers providers;\n+    final List<SseSubscription> subscriptions = new LinkedList<>();\n+    AtomicBoolean isStarted = new AtomicBoolean(false);", "originalCommit": "c424684ee4242c51c09bc1e24a3f17304a77a0ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0Mjk0Mg==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410742942", "bodyText": "Good catch - will change.", "author": "andymc12", "createdAt": "2020-04-18T19:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNTc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjE5Ng==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410726196", "bodyText": "This is one is a bit tricky. The space after is : is optional (https://www.w3.org/TR/2015/REC-eventsource-20150203/#event-stream-interpretation), both data:  and data: are valid event encodings.", "author": "reta", "createdAt": "2020-04-18T17:28:07Z", "path": "rt/rs/microprofile-client/src/main/java/org/apache/cxf/microprofile/client/sse/SsePublisher.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.cxf.microprofile.client.sse;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import javax.ws.rs.ext.Providers;\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import org.reactivestreams.Publisher;\n+import org.reactivestreams.Subscriber;\n+\n+public class SsePublisher implements Publisher<InboundSseEvent> {\n+\n+    final Executor executor;\n+    final BufferedReader br;\n+    final Providers providers;\n+    final List<SseSubscription> subscriptions = new LinkedList<>();\n+    AtomicBoolean isStarted = new AtomicBoolean(false);\n+\n+    SsePublisher(InputStream is, Executor executor, Providers providers) {\n+        br = new BufferedReader(new InputStreamReader(is));\n+        this.executor = executor;\n+        this.providers = providers;\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super InboundSseEvent> subscriber) {\n+        SseSubscription subscription = new SseSubscription(this, subscriber);\n+        subscriptions.add(subscription);\n+        subscription.fireSubscribe();\n+        start();\n+    }\n+\n+    private void start() {\n+        if (isStarted.compareAndSet(false, true)) {\n+            executor.execute(() -> {\n+                try (BufferedReader br2 = br) {\n+                    SseEventBuilder builder = new SseEventBuilder(providers);\n+                    String line = br.readLine();\n+                    while (line != null && !subscriptions.isEmpty()) {\n+                        if (line.startsWith(\"data: \")) {", "originalCommit": "c424684ee4242c51c09bc1e24a3f17304a77a0ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MjkzMg==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410742932", "bodyText": "Thanks for the link - it sounds like we can probably check for \"data:\" and then left-trim the resulting string.", "author": "andymc12", "createdAt": "2020-04-18T19:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NDIyOQ==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410784229", "bodyText": "Right but it applies to all attributes: id, data, comment, ...", "author": "reta", "createdAt": "2020-04-19T01:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjg5Ng==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410726896", "bodyText": "May be just declare buffer a LinkedList instead of Queue (it is private member anyway) so to eliminate casting?", "author": "reta", "createdAt": "2020-04-18T17:34:02Z", "path": "rt/rs/microprofile-client/src/main/java/org/apache/cxf/microprofile/client/sse/SseSubscription.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.cxf.microprofile.client.sse;\n+\n+import java.util.LinkedList;\n+import java.util.Queue;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import org.apache.cxf.common.util.SystemPropertyAction;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+public class SseSubscription implements Subscription {\n+\n+    private static final int DEFAULT_BUFFER_SIZE = \n+        SystemPropertyAction.getInteger(\"org.apache.cxf.microprofile.client.sse.bufferSize\", 256);\n+    private final SsePublisher publisher;\n+    private final Subscriber<? super InboundSseEvent> subscriber;\n+    private final AtomicLong requested = new AtomicLong();\n+    private final AtomicLong delivered = new AtomicLong();\n+    private final AtomicBoolean completed = new AtomicBoolean();\n+    private final Queue<InboundSseEvent> buffer = new LinkedList<>();\n+    private final AtomicInteger bufferSize = new AtomicInteger(DEFAULT_BUFFER_SIZE);\n+\n+    SseSubscription(SsePublisher publisher, Subscriber<? super InboundSseEvent> subscriber) {\n+        this.publisher = publisher;\n+        this.subscriber = subscriber;\n+    }\n+\n+    @Override\n+    public void request(long n) {\n+        if (n < 1) {\n+            throw new IllegalArgumentException(\"Only postive values are valid - passed-in \" + n);\n+        }\n+        requested.addAndGet(n);\n+        synchronized (buffer) {\n+            InboundSseEvent bufferedEvent = null;\n+            while (delivered.get() < requested.get()\n+                   && (bufferedEvent = ((LinkedList<InboundSseEvent>) buffer).pollFirst()) != null) {", "originalCommit": "c424684ee4242c51c09bc1e24a3f17304a77a0ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MzE5Ng==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410743196", "bodyText": "That was my original design, but Checkstyle prevents using LinkedList as a declared field.  I suppose I could add comments to disable Checkstyle in the code.", "author": "andymc12", "createdAt": "2020-04-18T19:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4NDMyNA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410784324", "bodyText": "\ud83d\udc4d would be probably better since there are too many casts ...", "author": "reta", "createdAt": "2020-04-19T01:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk2OTY2OA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r410969668", "bodyText": "I think the completed condition is missed here (unexpected, due to error fe), no onNext calls are expected in this case.", "author": "reta", "createdAt": "2020-04-19T19:07:26Z", "path": "rt/rs/microprofile-client/src/main/java/org/apache/cxf/microprofile/client/sse/SseSubscription.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.cxf.microprofile.client.sse;\n+\n+import java.util.LinkedList;\n+import java.util.Queue;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import org.apache.cxf.common.util.SystemPropertyAction;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+public class SseSubscription implements Subscription {\n+\n+    private static final int DEFAULT_BUFFER_SIZE = \n+        SystemPropertyAction.getInteger(\"org.apache.cxf.microprofile.client.sse.bufferSize\", 256);\n+    private final SsePublisher publisher;\n+    private final Subscriber<? super InboundSseEvent> subscriber;\n+    private final AtomicLong requested = new AtomicLong();\n+    private final AtomicLong delivered = new AtomicLong();\n+    private final AtomicBoolean completed = new AtomicBoolean();\n+    private final Queue<InboundSseEvent> buffer = new LinkedList<>();\n+    private final AtomicInteger bufferSize = new AtomicInteger(DEFAULT_BUFFER_SIZE);\n+\n+    SseSubscription(SsePublisher publisher, Subscriber<? super InboundSseEvent> subscriber) {\n+        this.publisher = publisher;\n+        this.subscriber = subscriber;\n+    }\n+\n+    @Override\n+    public void request(long n) {\n+        if (n < 1) {\n+            throw new IllegalArgumentException(\"Only postive values are valid - passed-in \" + n);\n+        }\n+        requested.addAndGet(n);\n+        synchronized (buffer) {\n+            InboundSseEvent bufferedEvent = null;\n+            while (delivered.get() < requested.get()", "originalCommit": "c424684ee4242c51c09bc1e24a3f17304a77a0ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de9c97806f0c55fcf5cef66dec10523ec5be11c6", "url": "https://github.com/apache/cxf/commit/de9c97806f0c55fcf5cef66dec10523ec5be11c6", "message": "Code review comments\n\n- Passes Reactive Streams TCK (in MP Rest Client TCK)\n- Use ExecutorService specified when client was built\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-05-12T02:01:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyNjY5MA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r424126690", "bodyText": "Probably not a good idea, exposing CXF internals (see please suggestion for SseMessageBodyReader)", "author": "reta", "createdAt": "2020-05-13T01:44:25Z", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/ProvidersImpl.java", "diffHunk": "@@ -62,4 +62,8 @@ public ProvidersImpl(Message m) {\n     private Type getGenericType(Class<?> type, Type genericType) {\n         return genericType == null ? type : genericType;\n     }\n+\n+    public Message getMessage() {", "originalCommit": "de9c97806f0c55fcf5cef66dec10523ec5be11c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyNzAyNA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r424127024", "bodyText": "CXF has MessageContext contextual extension to get the message context:\n@Context\nprivate MessageContext messageContext;", "author": "reta", "createdAt": "2020-05-13T01:45:51Z", "path": "rt/rs/microprofile-client/src/main/java/org/apache/cxf/microprofile/client/sse/SseMessageBodyReader.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.cxf.microprofile.client.sse;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.concurrent.ExecutorService;\n+\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.GenericType;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.ext.MessageBodyReader;\n+import javax.ws.rs.ext.Providers;\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import org.apache.cxf.jaxrs.impl.ProvidersImpl;\n+import org.apache.cxf.jaxrs.impl.tl.ThreadLocalProviders;\n+import org.apache.cxf.message.Message;\n+import org.apache.cxf.microprofile.client.Utils;\n+import org.reactivestreams.Publisher;\n+\n+@Produces(MediaType.SERVER_SENT_EVENTS)\n+public class SseMessageBodyReader implements MessageBodyReader<Publisher<?>> {\n+\n+    @Context\n+    Providers providers;\n+", "originalCommit": "de9c97806f0c55fcf5cef66dec10523ec5be11c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwNzI1OA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r424507258", "bodyText": "Excellent suggestion - thanks!", "author": "andymc12", "createdAt": "2020-05-13T14:59:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyNzAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyNzIzNw==", "url": "https://github.com/apache/cxf/pull/660#discussion_r424127237", "bodyText": "And you could use messageContext here to check the correct executor :-)", "author": "reta", "createdAt": "2020-05-13T01:46:51Z", "path": "rt/rs/microprofile-client/src/main/java/org/apache/cxf/microprofile/client/sse/SseMessageBodyReader.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.cxf.microprofile.client.sse;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.concurrent.ExecutorService;\n+\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.GenericType;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.ext.MessageBodyReader;\n+import javax.ws.rs.ext.Providers;\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import org.apache.cxf.jaxrs.impl.ProvidersImpl;\n+import org.apache.cxf.jaxrs.impl.tl.ThreadLocalProviders;\n+import org.apache.cxf.message.Message;\n+import org.apache.cxf.microprofile.client.Utils;\n+import org.reactivestreams.Publisher;\n+\n+@Produces(MediaType.SERVER_SENT_EVENTS)\n+public class SseMessageBodyReader implements MessageBodyReader<Publisher<?>> {\n+\n+    @Context\n+    Providers providers;\n+\n+    @Override\n+    public boolean isReadable(Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType) {\n+        return Publisher.class.isAssignableFrom(type) && MediaType.SERVER_SENT_EVENTS_TYPE.isCompatible(mediaType);\n+    }\n+\n+    @Override\n+    public Publisher<?> readFrom(Class<Publisher<?>> type, Type genericType,\n+            Annotation[] annotations, MediaType mediaType, MultivaluedMap<String, String> httpHeaders,\n+            InputStream entityStream) throws IOException, WebApplicationException {\n+        ProvidersImpl providersImpl = (ProvidersImpl) (providers instanceof ThreadLocalProviders\n+            ? ((ThreadLocalProviders)providers).get() : providers);\n+        Message message = providersImpl.getMessage();\n+        ExecutorService executor = Utils.getExecutorService(message);", "originalCommit": "de9c97806f0c55fcf5cef66dec10523ec5be11c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a2bf71c3dd4f24e23bde543655915f5e8f0a26fd", "url": "https://github.com/apache/cxf/commit/a2bf71c3dd4f24e23bde543655915f5e8f0a26fd", "message": "Code review comments\n\n- Passes Reactive Streams TCK (in MP Rest Client TCK)\n- Use ExecutorService specified when client was built\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-05-13T14:58:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0MTA1NA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r424841054", "bodyText": "Sorry, the usage of updateAndGet was \"bothering\" me and now I understand why ... I believe we should rethink the approach, here is the problem:\n    /* ...\n     * @param updateFunction a side-effect-free function\n     * ...\n     */\n    public final long updateAndGet(LongUnaryOperator updateFunction) {\n\nThe updateFunction must be a side-effect-free function (because it could be applied multiple times) but in current implementation it  is not. I have observed interesting races between request and fireEvent, which always are scheduled on different threads, when the value of delivered was changed and updateFunction  was applied multiple times, calling onNext several times.\nDoes it make sense to you?", "author": "reta", "createdAt": "2020-05-14T02:49:41Z", "path": "rt/rs/microprofile-client/src/main/java/org/apache/cxf/microprofile/client/sse/SseSubscription.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.cxf.microprofile.client.sse;\n+\n+import java.util.LinkedList;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import org.apache.cxf.common.util.SystemPropertyAction;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+public class SseSubscription implements Subscription {\n+\n+    private static final int DEFAULT_BUFFER_SIZE = \n+        SystemPropertyAction.getInteger(\"org.apache.cxf.microprofile.client.sse.bufferSize\", 256);\n+    private final SsePublisher publisher;\n+    private final Subscriber<? super InboundSseEvent> subscriber;\n+    private final AtomicLong requested = new AtomicLong();\n+    private final AtomicLong delivered = new AtomicLong();\n+    private final AtomicBoolean completed = new AtomicBoolean();\n+    private final AtomicBoolean canceled = new AtomicBoolean();\n+    //CHECKSTYLE:OFF\n+    private final LinkedList<InboundSseEvent> buffer = new LinkedList<>(); //NOPMD\n+    //CHECKSTYLE:ON\n+    private final AtomicInteger bufferSize = new AtomicInteger(DEFAULT_BUFFER_SIZE);\n+\n+    SseSubscription(SsePublisher publisher, Subscriber<? super InboundSseEvent> subscriber) {\n+        this.publisher = publisher;\n+        this.subscriber = subscriber;\n+    }\n+\n+    @Override\n+    public void request(long n) {\n+        if (canceled.get()) {\n+            return;\n+        }\n+        if (n < 1) {\n+            fireError(new IllegalArgumentException(\"Only positive values may be requested - passed-in \" + n));\n+            return;\n+        }\n+        requested.addAndGet(n);\n+        synchronized (buffer) {\n+            InboundSseEvent bufferedEvent = null;\n+            while (delivered.get() < requested.get()\n+                   && (bufferedEvent = buffer.pollFirst()) != null) {\n+                InboundSseEvent finalEvent = bufferedEvent;\n+                delivered.updateAndGet(l -> {", "originalCommit": "a2bf71c3dd4f24e23bde543655915f5e8f0a26fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY3MDg1NA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r430670854", "bodyText": "It does (and sorry for the slow turnaround) - the main thing I want to ensure is that the call to onNext results in the delivered count being incremented.  I think I can do that with a sync block.", "author": "andymc12", "createdAt": "2020-05-26T19:54:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0MTA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc0MzgwMg==", "url": "https://github.com/apache/cxf/pull/660#discussion_r430743802", "bodyText": "\ud83d\udc4d thanks!", "author": "reta", "createdAt": "2020-05-26T22:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0MTA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0MTIwNQ==", "url": "https://github.com/apache/cxf/pull/660#discussion_r424841205", "bodyText": "Probably needs !canceled.get() && !completed.get() as well ...", "author": "reta", "createdAt": "2020-05-14T02:50:16Z", "path": "rt/rs/microprofile-client/src/main/java/org/apache/cxf/microprofile/client/sse/SseSubscription.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.cxf.microprofile.client.sse;\n+\n+import java.util.LinkedList;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import org.apache.cxf.common.util.SystemPropertyAction;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+public class SseSubscription implements Subscription {\n+\n+    private static final int DEFAULT_BUFFER_SIZE = \n+        SystemPropertyAction.getInteger(\"org.apache.cxf.microprofile.client.sse.bufferSize\", 256);\n+    private final SsePublisher publisher;\n+    private final Subscriber<? super InboundSseEvent> subscriber;\n+    private final AtomicLong requested = new AtomicLong();\n+    private final AtomicLong delivered = new AtomicLong();\n+    private final AtomicBoolean completed = new AtomicBoolean();\n+    private final AtomicBoolean canceled = new AtomicBoolean();\n+    //CHECKSTYLE:OFF\n+    private final LinkedList<InboundSseEvent> buffer = new LinkedList<>(); //NOPMD\n+    //CHECKSTYLE:ON\n+    private final AtomicInteger bufferSize = new AtomicInteger(DEFAULT_BUFFER_SIZE);\n+\n+    SseSubscription(SsePublisher publisher, Subscriber<? super InboundSseEvent> subscriber) {\n+        this.publisher = publisher;\n+        this.subscriber = subscriber;\n+    }\n+\n+    @Override\n+    public void request(long n) {\n+        if (canceled.get()) {\n+            return;\n+        }\n+        if (n < 1) {\n+            fireError(new IllegalArgumentException(\"Only positive values may be requested - passed-in \" + n));\n+            return;\n+        }\n+        requested.addAndGet(n);\n+        synchronized (buffer) {\n+            InboundSseEvent bufferedEvent = null;\n+            while (delivered.get() < requested.get()", "originalCommit": "a2bf71c3dd4f24e23bde543655915f5e8f0a26fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY3NzQxMA==", "url": "https://github.com/apache/cxf/pull/660#discussion_r430677410", "bodyText": "I think I had something similar coded up a while back - but that broke the reactive streams TCK.  IIUC, the subscriber can close or cancel the subscription while the subscription is still sending it requested items.", "author": "andymc12", "createdAt": "2020-05-26T20:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0MTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc0NDAwOQ==", "url": "https://github.com/apache/cxf/pull/660#discussion_r430744009", "bodyText": "Aha I see, looks like an edge, good to know, thanks!", "author": "reta", "createdAt": "2020-05-26T22:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0MTIwNQ=="}], "type": "inlineReview"}, {"oid": "71a636fbe8c634204c6f035c37c6c744861459f0", "url": "https://github.com/apache/cxf/commit/71a636fbe8c634204c6f035c37c6c744861459f0", "message": "Code review comments\n\n- Passes Reactive Streams TCK (in MP Rest Client TCK)\n- Use ExecutorService specified when client was built\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-05-26T19:52:25Z", "type": "forcePushed"}, {"oid": "cb0ece06e7252debc22b430872b5ef55a0fe315b", "url": "https://github.com/apache/cxf/commit/cb0ece06e7252debc22b430872b5ef55a0fe315b", "message": "[CXF-8263] Support SSEs in MP Rest Client 2.0\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-05-26T22:47:42Z", "type": "commit"}, {"oid": "d8c4e429fb5c003d63bd2f28ce376cdc9e06f5ef", "url": "https://github.com/apache/cxf/commit/d8c4e429fb5c003d63bd2f28ce376cdc9e06f5ef", "message": "Review comments\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-05-26T22:47:42Z", "type": "commit"}, {"oid": "b9f65151a91c9c87330c825811548697359402a9", "url": "https://github.com/apache/cxf/commit/b9f65151a91c9c87330c825811548697359402a9", "message": "Code review comments\n\n- Passes Reactive Streams TCK (in MP Rest Client TCK)\n- Use ExecutorService specified when client was built\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-05-26T22:47:42Z", "type": "commit"}, {"oid": "b9f65151a91c9c87330c825811548697359402a9", "url": "https://github.com/apache/cxf/commit/b9f65151a91c9c87330c825811548697359402a9", "message": "Code review comments\n\n- Passes Reactive Streams TCK (in MP Rest Client TCK)\n- Use ExecutorService specified when client was built\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-05-26T22:47:42Z", "type": "forcePushed"}]}