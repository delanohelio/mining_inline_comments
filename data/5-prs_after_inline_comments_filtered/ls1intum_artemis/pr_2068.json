{"pr_number": 2068, "pr_title": "Add build logs to database.", "pr_createdAt": "2020-08-27T16:31:58Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2068", "timeline": [{"oid": "fb09ca938fd1f9459fba842aa1d4163077783d55", "url": "https://github.com/ls1intum/Artemis/commit/fb09ca938fd1f9459fba842aa1d4163077783d55", "message": "Add build logs to database.", "committedDate": "2020-08-27T16:31:13Z", "type": "commit"}, {"oid": "73879b717b7cce2ee46602996febfdda55b85720", "url": "https://github.com/ls1intum/Artemis/commit/73879b717b7cce2ee46602996febfdda55b85720", "message": "Add getter and setter.", "committedDate": "2020-08-27T16:36:56Z", "type": "commit"}, {"oid": "c1f12344395a80240e3cd79db15103aa45d146da", "url": "https://github.com/ls1intum/Artemis/commit/c1f12344395a80240e3cd79db15103aa45d146da", "message": "Add getter and setter for id.", "committedDate": "2020-08-29T09:32:01Z", "type": "commit"}, {"oid": "fc11b3e890c61df0439935a2421454ca5be5e24b", "url": "https://github.com/ls1intum/Artemis/commit/fc11b3e890c61df0439935a2421454ca5be5e24b", "message": "Remove unneeded view.", "committedDate": "2020-08-29T09:40:18Z", "type": "commit"}, {"oid": "0785311dc2d1759ec5fda37abc34e9b5dcf2fee6", "url": "https://github.com/ls1intum/Artemis/commit/0785311dc2d1759ec5fda37abc34e9b5dcf2fee6", "message": "Store logs into database.", "committedDate": "2020-08-29T09:45:25Z", "type": "commit"}, {"oid": "fd0282c455135fa306b55236d9579f8b966557d0", "url": "https://github.com/ls1intum/Artemis/commit/fd0282c455135fa306b55236d9579f8b966557d0", "message": "Rework saving.", "committedDate": "2020-08-31T15:47:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMxNzk0NA==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r480317944", "bodyText": "I am not sure if this is a good approach. In the future, we will have only one programming submission per commit (that was pushed to the remote). Then it could happen that multiple builds add multiple build logs.\nUsers might see the same build errors multiple times then.\nI would suggest that we simply replace all build logs here. In case they are identical, this makes more sense.\nIn case they have changed, the old ones might not be valid any more.", "author": "krusche", "createdAt": "2020-08-31T18:43:08Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BambooService.java", "diffHunk": "@@ -452,7 +452,20 @@ public Result onBuildCompletedNew(ProgrammingExerciseParticipation participation\n             final var hasArtifact = buildResult.getBuild().isArtifact();\n             programmingSubmission.setBuildArtifact(hasArtifact);\n             programmingSubmission.setBuildFailed(result.getResultString().equals(\"No tests found\"));\n-            programmingSubmissionRepository.save(programmingSubmission);\n+\n+            programmingSubmission = programmingSubmissionRepository.save(programmingSubmission);\n+\n+            Optional<ProgrammingSubmission> optionalProgrammingSubmission = programmingSubmissionRepository.findWithEagerBuildLogEntries(programmingSubmission.getId());\n+            if (optionalProgrammingSubmission.isPresent()) {\n+                programmingSubmission = optionalProgrammingSubmission.get();\n+                // Store logs into database. Append logs of multiple jobs.", "originalCommit": "fd0282c455135fa306b55236d9579f8b966557d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMyMTExNw==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r480321117", "bodyText": "I see your point, however this comment is regarding multiple jobs within one build (-> one submission).\nWe currently only use one job but as the bamboo plugin offers a set of jobs, we should take log entries of every job into account.\nSo I suggest to clear the log entries before the for-loop and then adding the log entries of all jobs (although we most likely only have one) to the cleared list.", "author": "sleiss", "createdAt": "2020-08-31T18:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMxNzk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA2MzMwNw==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r481063307", "bodyText": "sounds good, just make sure that the same logs are not added twice ;-)", "author": "krusche", "createdAt": "2020-09-01T11:19:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMxNzk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0OTkzOA==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r481149938", "bodyText": "I've checked that now :)", "author": "sleiss", "createdAt": "2020-09-01T13:46:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMxNzk0NA=="}], "type": "inlineReview"}, {"oid": "53330f12afa5a43a7be570ebcc50b8b52aa302ea", "url": "https://github.com/ls1intum/Artemis/commit/53330f12afa5a43a7be570ebcc50b8b52aa302ea", "message": "Move to changesets into one changeset.", "committedDate": "2020-08-31T18:50:19Z", "type": "commit"}, {"oid": "5a38b4dcc27c6d8c6390e8141617ca6e8c6d7c91", "url": "https://github.com/ls1intum/Artemis/commit/5a38b4dcc27c6d8c6390e8141617ca6e8c6d7c91", "message": "Merge branch 'develop' into feature/store-build-logs", "committedDate": "2020-09-01T12:31:47Z", "type": "commit"}, {"oid": "66cd3fc388a947faf20235dd1ac7216b39b99d07", "url": "https://github.com/ls1intum/Artemis/commit/66cd3fc388a947faf20235dd1ac7216b39b99d07", "message": "Merge remote-tracking branch 'origin/feature/store-build-logs' into feature/store-build-logs", "committedDate": "2020-09-01T12:32:28Z", "type": "commit"}, {"oid": "f73f3483cb8e8fe6007fe51dd424e7bdd5517fc1", "url": "https://github.com/ls1intum/Artemis/commit/f73f3483cb8e8fe6007fe51dd424e7bdd5517fc1", "message": "Store build logs correctly, fetch them if possible & filter them.", "committedDate": "2020-09-01T13:26:47Z", "type": "commit"}, {"oid": "ddaf8b3054419f046555064ae7279d7472ae5f52", "url": "https://github.com/ls1intum/Artemis/commit/ddaf8b3054419f046555064ae7279d7472ae5f52", "message": "Resolve codacy issues. Fix tests.", "committedDate": "2020-09-01T13:45:15Z", "type": "commit"}, {"oid": "de5130d9c12effec1c1b7039283903f18a881d48", "url": "https://github.com/ls1intum/Artemis/commit/de5130d9c12effec1c1b7039283903f18a881d48", "message": "Add test case.", "committedDate": "2020-09-01T19:18:54Z", "type": "commit"}, {"oid": "985952713078d8a70f628ba6ba3bd41a302111cf", "url": "https://github.com/ls1intum/Artemis/commit/985952713078d8a70f628ba6ba3bd41a302111cf", "message": "Add logs to sample payload.", "committedDate": "2020-09-01T19:46:53Z", "type": "commit"}, {"oid": "1921e7483da84afb0b5b85f77a42ef3d996b829d", "url": "https://github.com/ls1intum/Artemis/commit/1921e7483da84afb0b5b85f77a42ef3d996b829d", "message": "Add logs to ModelFactory.", "committedDate": "2020-09-01T20:04:31Z", "type": "commit"}, {"oid": "9a227a1fe8c32afdb69788ed20df561ea1d8c9d1", "url": "https://github.com/ls1intum/Artemis/commit/9a227a1fe8c32afdb69788ed20df561ea1d8c9d1", "message": "Filter logs on insert.", "committedDate": "2020-09-01T20:20:37Z", "type": "commit"}, {"oid": "22f22a2e511fe7d32daacdc0d6f275219c0a665b", "url": "https://github.com/ls1intum/Artemis/commit/22f22a2e511fe7d32daacdc0d6f275219c0a665b", "message": "Merge branch 'develop' into feature/store-build-logs", "committedDate": "2020-09-02T09:01:41Z", "type": "commit"}, {"oid": "c6248b643bca168ec98f22b66f3e92a5d48c0f3a", "url": "https://github.com/ls1intum/Artemis/commit/c6248b643bca168ec98f22b66f3e92a5d48c0f3a", "message": "Merge branch 'develop' into feature/store-build-logs", "committedDate": "2020-09-22T08:09:01Z", "type": "commit"}, {"oid": "2130153ca15389c2bc026c9d25dc8c781fe0fcfd", "url": "https://github.com/ls1intum/Artemis/commit/2130153ca15389c2bc026c9d25dc8c781fe0fcfd", "message": "Merge branch 'develop' into feature/store-build-logs", "committedDate": "2020-09-23T15:57:05Z", "type": "commit"}, {"oid": "5a2faa1a40298a8c6d0dc44be59a5d50f55987c2", "url": "https://github.com/ls1intum/Artemis/commit/5a2faa1a40298a8c6d0dc44be59a5d50f55987c2", "message": "Merge branch 'develop' into feature/store-build-logs", "committedDate": "2020-09-24T09:11:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE4ODgxNg==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494188816", "bodyText": "Maybe it's me but this comment is hard to read", "author": "sascha11110", "createdAt": "2020-09-24T09:57:24Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BambooService.java", "diffHunk": "@@ -452,7 +463,30 @@ public Result onBuildCompletedNew(ProgrammingExerciseParticipation participation\n             final var hasArtifact = buildResult.getBuild().isArtifact();\n             programmingSubmission.setBuildArtifact(hasArtifact);\n             programmingSubmission.setBuildFailed(result.getResultString().equals(\"No tests found\"));\n-            programmingSubmissionRepository.save(programmingSubmission);\n+\n+            programmingSubmission = programmingSubmissionRepository.save(programmingSubmission);\n+\n+            Optional<ProgrammingSubmission> optionalProgrammingSubmission = programmingSubmissionRepository.findWithEagerBuildLogEntriesById(programmingSubmission.getId());\n+            if (optionalProgrammingSubmission.isPresent()) {\n+                programmingSubmission = optionalProgrammingSubmission.get();\n+\n+                List<BuildLogEntry> buildLogEntries = new ArrayList<>();\n+\n+                // Store logs into database. Append logs of multiple jobs.\n+                for (var job : buildResult.getBuild().getJobs()) {\n+                    for (var bambooLog : job.getLogs()) {\n+                        // We have to unescape the HTML as otherwise symbols like '<' are not displayed correctly\n+                        buildLogEntries.add(new BuildLogEntry(bambooLog.getDate(), StringEscapeUtils.unescapeHtml(bambooLog.getLog()), programmingSubmission));\n+                    }\n+                }\n+\n+                // Set logs that as we received new logs and don't want logs to be stored twice", "originalCommit": "5a2faa1a40298a8c6d0dc44be59a5d50f55987c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIwNjczMg==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494206732", "bodyText": "I agree :D Maybe: Set the received logs in order to avoid duplicate entries", "author": "anditurdiu", "createdAt": "2020-09-24T10:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE4ODgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIwNzY1NA==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494207654", "bodyText": "Was probably quite late when I wrote that comment :D Will change it.", "author": "sleiss", "createdAt": "2020-09-24T10:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE4ODgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE5MDAxOQ==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494190019", "bodyText": "I'm not really into our Bamboo / Jenkins setup. But why is there a method retrieveLatestBuildLogsFromJenkins in BambooService.java?", "author": "sascha11110", "createdAt": "2020-09-24T09:59:32Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BambooService.java", "diffHunk": "@@ -831,14 +865,23 @@ private Long calculateScoreForResult(Result result, int skippedTests) {\n         return null;\n     }\n \n+    private List<BuildLogEntry> retrieveLatestBuildLogsFromDatabase(ProgrammingSubmission programmingSubmission) {\n+        Optional<ProgrammingSubmission> optionalProgrammingSubmission = programmingSubmissionRepository.findWithEagerBuildLogEntriesById(programmingSubmission.getId());\n+        if (optionalProgrammingSubmission.isPresent()) {\n+            return optionalProgrammingSubmission.get().getBuildLogEntries();\n+        }\n+\n+        return List.of();\n+    }\n+\n     /**\n-     * Performs a request to the Bamboo REST API to retrieve the build log of the latest build.\n+     * Load the build log from the database.\n+     * Performs a request to the Bamboo REST API to retrieve the build log of the latest build, if the log is not available in the database.\n      *\n      * @param planKey to identify the build logs with.\n      * @return the list of retrieved build logs.\n      */\n-    //TODO: save this on the Artemis server, e.g. in the result class so that Artemis does not need to retrieve it every time\n-    public List<BuildLogEntry> retrieveLatestBuildLogs(String planKey) {\n+    private List<BuildLogEntry> retrieveLatestBuildLogsFromJenkins(String planKey) {", "originalCommit": "5a2faa1a40298a8c6d0dc44be59a5d50f55987c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIxMDYyMQ==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494210621", "bodyText": "Probably some wrong copy pasting :D Changed it.", "author": "sleiss", "createdAt": "2020-09-24T10:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE5MDAxOQ=="}], "type": "inlineReview"}, {"oid": "d6f0655baa4b84bfa26778152e2b67659d1aece0", "url": "https://github.com/ls1intum/Artemis/commit/d6f0655baa4b84bfa26778152e2b67659d1aece0", "message": "Apply feedback.", "committedDate": "2020-09-24T10:35:04Z", "type": "commit"}, {"oid": "950aadb7652c1a1ed8705f69d1bfec560841e2d4", "url": "https://github.com/ls1intum/Artemis/commit/950aadb7652c1a1ed8705f69d1bfec560841e2d4", "message": "Merge remote-tracking branch 'origin/feature/store-build-logs' into feature/store-build-logs", "committedDate": "2020-09-24T10:36:26Z", "type": "commit"}, {"oid": "c00b18adf110e168b32b2c293e31461d8f15e6bf", "url": "https://github.com/ls1intum/Artemis/commit/c00b18adf110e168b32b2c293e31461d8f15e6bf", "message": "Save retrieved build logs.", "committedDate": "2020-09-24T10:54:47Z", "type": "commit"}, {"oid": "e87338cc930a681007b34c6e392c7f4a19580ed9", "url": "https://github.com/ls1intum/Artemis/commit/e87338cc930a681007b34c6e392c7f4a19580ed9", "message": "Import Cache annotation.", "committedDate": "2020-09-24T10:57:52Z", "type": "commit"}, {"oid": "c0ce5b9adc4d884e47321a0a5fba8fb866bbd14a", "url": "https://github.com/ls1intum/Artemis/commit/c0ce5b9adc4d884e47321a0a5fba8fb866bbd14a", "message": "Merge branch 'develop' into feature/store-build-logs", "committedDate": "2020-09-24T11:12:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIyMzA3OQ==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494223079", "bodyText": "Now that this class becomes an entity, you should also take the id into account for equals and for hashCode", "author": "kloessst", "createdAt": "2020-09-24T10:59:34Z", "path": "src/main/java/de/tum/in/www1/artemis/domain/BuildLogEntry.java", "diffHunk": "@@ -33,6 +74,14 @@ public void setLog(String log) {\n         this.log = log;\n     }\n \n+    public ProgrammingSubmission getProgrammingSubmission() {\n+        return programmingSubmission;\n+    }\n+\n+    public void setProgrammingSubmission(ProgrammingSubmission programmingSubmission) {\n+        this.programmingSubmission = programmingSubmission;\n+    }\n+\n     @Override\n     public boolean equals(Object object) {", "originalCommit": "e87338cc930a681007b34c6e392c7f4a19580ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI2Mjc5OA==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494262798", "bodyText": "Thanks, I changed it.", "author": "sleiss", "createdAt": "2020-09-24T12:10:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIyMzA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0MzQwNQ==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494243405", "bodyText": "Why do you fetch the programming submission with build logs here? Could you just use the programmingSubmission from a line above?", "author": "kloessst", "createdAt": "2020-09-24T11:38:17Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BambooService.java", "diffHunk": "@@ -452,7 +470,30 @@ public Result onBuildCompletedNew(ProgrammingExerciseParticipation participation\n             final var hasArtifact = buildResult.getBuild().isArtifact();\n             programmingSubmission.setBuildArtifact(hasArtifact);\n             programmingSubmission.setBuildFailed(result.getResultString().equals(\"No tests found\"));\n-            programmingSubmissionRepository.save(programmingSubmission);\n+\n+            programmingSubmission = programmingSubmissionRepository.save(programmingSubmission);\n+\n+            Optional<ProgrammingSubmission> optionalProgrammingSubmission = programmingSubmissionRepository.findWithEagerBuildLogEntriesById(programmingSubmission.getId());", "originalCommit": "c0ce5b9adc4d884e47321a0a5fba8fb866bbd14a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI2NzYwMA==", "url": "https://github.com/ls1intum/Artemis/pull/2068#discussion_r494267600", "bodyText": "Good catch! I first thought that, in order to set the build logs, they have to be present (i.e. not be a proxy), but as we are only setting them (and not getting), it is not required. I've changed it.", "author": "sleiss", "createdAt": "2020-09-24T12:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0MzQwNQ=="}], "type": "inlineReview"}, {"oid": "d24743718d6018a342918b13cf04d2b23bae19c2", "url": "https://github.com/ls1intum/Artemis/commit/d24743718d6018a342918b13cf04d2b23bae19c2", "message": "Adjust equals & hashCode functions. Remove unnecessary fetch.", "committedDate": "2020-09-24T12:16:22Z", "type": "commit"}]}