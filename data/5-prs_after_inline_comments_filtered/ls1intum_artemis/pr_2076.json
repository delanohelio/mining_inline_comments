{"pr_number": 2076, "pr_title": "Fix an issue with the Jenkins config when importing programming exercises", "pr_createdAt": "2020-08-31T18:35:49Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2076", "timeline": [{"oid": "2cecc803d4ba8cd363a32180f2c66dd3f327b66e", "url": "https://github.com/ls1intum/Artemis/commit/2cecc803d4ba8cd363a32180f2c66dd3f327b66e", "message": "fix an issue with the Jenkins config when importing programming exercises", "committedDate": "2020-08-31T18:26:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMxNjcyOQ==", "url": "https://github.com/ls1intum/Artemis/pull/2076#discussion_r480316729", "bodyText": "@krusche Is it on purpose that this operation (and also the corresponding one for TAs) is no longer within a try-catch?", "author": "sleiss", "createdAt": "2020-08-31T18:40:50Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/gitlab/GitLabService.java", "diffHunk": "@@ -276,20 +276,25 @@ public void createProjectForExercise(ProgrammingExercise programmingExercise) th\n         final var group = new Group().withPath(exercisePath).withName(exerciseName).withVisibility(Visibility.PRIVATE);\n         try {\n             gitlab.getGroupApi().addGroup(group);\n-\n-            final var instructors = userService.getInstructors(programmingExercise.getCourseViaExerciseGroupOrCourseMember());\n-            final var teachingAssistants = userService.getTutors(programmingExercise.getCourseViaExerciseGroupOrCourseMember());\n-            for (final var instructor : instructors) {\n-                final var userId = gitLabUserManagementService.getUserId(instructor.getLogin());\n-                gitLabUserManagementService.addUserToGroups(userId, List.of(programmingExercise), MAINTAINER);\n+        }\n+        catch (GitLabApiException e) {\n+            if (e.getMessage().contains(\"has already been taken\")) {\n+                // ignore this error, because it is not really a problem\n+                log.warn(\"Failed to add group \" + exerciseName + \" due to error: \" + e.getMessage());\n             }\n-            for (final var ta : teachingAssistants) {\n-                final var userId = gitLabUserManagementService.getUserId(ta.getLogin());\n-                gitLabUserManagementService.addUserToGroups(userId, List.of(programmingExercise), GUEST);\n+            else {\n+                throw new GitLabException(\"Unable to create new group for course \" + exerciseName, e);\n             }\n         }\n-        catch (GitLabApiException e) {\n-            throw new GitLabException(\"Unable to create new group for course \" + exerciseName, e);\n+        final var instructors = userService.getInstructors(programmingExercise.getCourseViaExerciseGroupOrCourseMember());\n+        final var teachingAssistants = userService.getTutors(programmingExercise.getCourseViaExerciseGroupOrCourseMember());\n+        for (final var instructor : instructors) {\n+            final var userId = gitLabUserManagementService.getUserId(instructor.getLogin());\n+            gitLabUserManagementService.addUserToGroups(userId, List.of(programmingExercise), MAINTAINER);", "originalCommit": "2cecc803d4ba8cd363a32180f2c66dd3f327b66e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMyNzc5NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2076#discussion_r480327795", "bodyText": "yes, the method gitLabUserManagementService.addUserToGroups(...) itself has a try catch block and does not throw if the user is already part of the group. So I don't think there is a reason to have another try catch here, in particular because the previous catch (which I moved up) only re-threw the exception", "author": "krusche", "createdAt": "2020-08-31T19:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMxNjcyOQ=="}], "type": "inlineReview"}, {"oid": "c04b1cbb052b9ed7f067867ff1013eb5a736d22a", "url": "https://github.com/ls1intum/Artemis/commit/c04b1cbb052b9ed7f067867ff1013eb5a736d22a", "message": "fix codacy issues", "committedDate": "2020-09-01T07:11:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkwODE5Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2076#discussion_r480908197", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "artemis-bot", "createdAt": "2020-09-01T07:16:47Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/jenkins/JenkinsService.java", "diffHunk": "@@ -139,22 +140,67 @@ public void updatePlanRepository(String projectKey, String planName, String repo\n \n         // remove potential username from repo URL. Jenkins uses the Artemis Admin user and will fail if other usernames are in the URL\n         final var repoUrl = vcsRepositoryUrl.replaceAll(\"(https?://)(.*@)(.*)\", \"$1$3\");\n-        final var config = jobXml(projectKey, planName);\n-        final var urlElements = config.getElementsByTagName(\"url\");\n-        if (urlElements.getLength() != 2) {\n+        final var jobXmlDocument = getJobXmlForBuildPlanWith(projectKey, planName);\n+        final var remoteUrlNode = findUserRemoteConfigFor(jobXmlDocument, repoNameInCI);\n+        if (remoteUrlNode == null || remoteUrlNode.getFirstChild() == null) {\n+            throw new IllegalArgumentException(\"Url to replace not found in job xml document\");\n+        }\n+        remoteUrlNode.getFirstChild().setNodeValue(repoUrl);\n+        final var errorMessage = \"Error trying to configure build plan in Jenkins \" + planName;\n+        postXml(jobXmlDocument, String.class, HttpStatus.OK, errorMessage, Endpoint.PLAN_CONFIG, projectKey, planName);\n+    }\n+\n+    private org.w3c.dom.Node findUserRemoteConfigFor(Document jobXmlDocument, String repoNameInCI) {\n+        final var userRemoteConfigs = jobXmlDocument.getElementsByTagName(\"hudson.plugins.git.UserRemoteConfig\");\n+        if (userRemoteConfigs.getLength() != 2) {\n             throw new IllegalArgumentException(\"Configuration of build plans currently only supports a model with two repositories, ASSIGNMENT and TESTS\");\n         }\n+        var firstUserRemoteConfig = userRemoteConfigs.item(0).getChildNodes();\n+        var urlElement = findUrlElement(firstUserRemoteConfig, repoNameInCI);\n+        if (urlElement != null) {\n+            return urlElement;\n+        }\n+        var secondUserRemoteConfig = userRemoteConfigs.item(1).getChildNodes();\n+        urlElement = findUrlElement(secondUserRemoteConfig, repoNameInCI);\n+        if (urlElement != null) {\n+            return urlElement;\n+        }\n+        return null;\n+    }\n+\n+    private org.w3c.dom.Node findUrlElement(NodeList nodeList, String repoNameInCI) {\n+        boolean found = false;\n+        org.w3c.dom.Node urlNode = null;\n+        for (int i = 0; i < nodeList.getLength(); i++) {\n+            var childElement = nodeList.item(i);\n+            if (\"name\".equalsIgnoreCase(childElement.getNodeName())) {\n+                var nameValue = childElement.hasChildNodes() ? childElement.getFirstChild().getNodeValue() : null;\n+                // this name was added recently, so we cannot assume that all job xml files include this name\n+                if (repoNameInCI.equalsIgnoreCase(nameValue)) {\n+                    found = true;\n+                }\n+            }\n+            else if (\"url\".equalsIgnoreCase(childElement.getNodeName())) {\n+                urlNode = childElement;\n+                if (!found) {\n+                    // fallback for old xmls\n+                    var urlValue = childElement.hasChildNodes() ? childElement.getFirstChild().getNodeValue() : null;\n+                    if (urlValue != null && repoNameInCI.equals(ASSIGNMENT_REPO_NAME) && ((urlValue.contains(\"-exercise.git\") || (urlValue.contains(\"-solution.git\"))))) {", "originalCommit": "c04b1cbb052b9ed7f067867ff1013eb5a736d22a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}