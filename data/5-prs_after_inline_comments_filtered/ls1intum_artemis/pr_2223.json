{"pr_number": 2223, "pr_title": "[Enhancement] Manual Result based on Automatic Result + Enable Result score > 100% for all Exercises types", "pr_createdAt": "2020-10-18T00:55:43Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2223", "timeline": [{"oid": "fd5e0e9ce3a2b10c5235c6d7fa486c21cf5bc2b1", "url": "https://github.com/ls1intum/Artemis/commit/fd5e0e9ce3a2b10c5235c6d7fa486c21cf5bc2b1", "message": "connect automatic feedback to manual result", "committedDate": "2020-10-17T23:28:20Z", "type": "commit"}, {"oid": "bd5044f7c941c354218db8b68756c3bfb59a73fb", "url": "https://github.com/ls1intum/Artemis/commit/bd5044f7c941c354218db8b68756c3bfb59a73fb", "message": "add also test case names to result dialog", "committedDate": "2020-10-17T23:28:55Z", "type": "commit"}, {"oid": "45490d821e57a5b7ef8516e0fe3e375260f48f67", "url": "https://github.com/ls1intum/Artemis/commit/45490d821e57a5b7ef8516e0fe3e375260f48f67", "message": "make the check on server instead of client", "committedDate": "2020-10-18T00:50:04Z", "type": "commit"}, {"oid": "7872f3ac9663ebc5dcf05084c0b528f0bfc2408d", "url": "https://github.com/ls1intum/Artemis/commit/7872f3ac9663ebc5dcf05084c0b528f0bfc2408d", "message": "set feedback positive if credits are positive", "committedDate": "2020-10-18T00:50:32Z", "type": "commit"}, {"oid": "b032269d18a09bfbc8bc5db16210c5d15aef980f", "url": "https://github.com/ls1intum/Artemis/commit/b032269d18a09bfbc8bc5db16210c5d15aef980f", "message": "run spotless", "committedDate": "2020-10-18T00:52:15Z", "type": "commit"}, {"oid": "36228cb384ce789a388034d26d7bd311c482af32", "url": "https://github.com/ls1intum/Artemis/commit/36228cb384ce789a388034d26d7bd311c482af32", "message": "try to fix client tests", "committedDate": "2020-10-18T01:53:30Z", "type": "commit"}, {"oid": "8df9aff915ef47a372f67146ca5b4d4710de8645", "url": "https://github.com/ls1intum/Artemis/commit/8df9aff915ef47a372f67146ca5b4d4710de8645", "message": "try to fix server tests", "committedDate": "2020-10-18T02:14:54Z", "type": "commit"}, {"oid": "6757078d77833be621075dcea68c1ed2fa3ab78d", "url": "https://github.com/ls1intum/Artemis/commit/6757078d77833be621075dcea68c1ed2fa3ab78d", "message": "run spotless", "committedDate": "2020-10-18T02:16:50Z", "type": "commit"}, {"oid": "708b041777d57b6a9b628a5987af2684997d9f8c", "url": "https://github.com/ls1intum/Artemis/commit/708b041777d57b6a9b628a5987af2684997d9f8c", "message": "improve test coverage", "committedDate": "2020-10-18T19:15:13Z", "type": "commit"}, {"oid": "2a6c28af326e50696c82f5060a3d06748680db38", "url": "https://github.com/ls1intum/Artemis/commit/2a6c28af326e50696c82f5060a3d06748680db38", "message": "Merge branch 'develop' into enhancement/programming-assessment/manual-result-based-on-automatic", "committedDate": "2020-10-18T20:32:24Z", "type": "commit"}, {"oid": "6b2b6a565e6ceded8b9445029439223ac7af89b9", "url": "https://github.com/ls1intum/Artemis/commit/6b2b6a565e6ceded8b9445029439223ac7af89b9", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into enhancement/programming-assessment/manual-result-based-on-automatic", "committedDate": "2020-10-20T11:21:21Z", "type": "commit"}, {"oid": "f45a80873ff92f76c5d518b28d8f0207f7cb6e36", "url": "https://github.com/ls1intum/Artemis/commit/f45a80873ff92f76c5d518b28d8f0207f7cb6e36", "message": "move calculation for structuredGradingInstruction to own service and enable results > 100% for all exercise types", "committedDate": "2020-10-20T13:47:14Z", "type": "commit"}, {"oid": "92ec6b6c755ed5352a1109490c8c4db711fd671d", "url": "https://github.com/ls1intum/Artemis/commit/92ec6b6c755ed5352a1109490c8c4db711fd671d", "message": "add own calculation for the total score for programming exercises", "committedDate": "2020-10-20T13:48:28Z", "type": "commit"}, {"oid": "5c69805343b0f6cb10688da58f096b919b444f91", "url": "https://github.com/ls1intum/Artemis/commit/5c69805343b0f6cb10688da58f096b919b444f91", "message": "check if bonus points are null", "committedDate": "2020-10-20T13:55:04Z", "type": "commit"}, {"oid": "a899d305e3fec55065f15de73932204e8d59e4ce", "url": "https://github.com/ls1intum/Artemis/commit/a899d305e3fec55065f15de73932204e8d59e4ce", "message": "include right calculation also for client", "committedDate": "2020-10-20T16:58:17Z", "type": "commit"}, {"oid": "632a06313bb448aefcdd6d5545f167e29689eaa6", "url": "https://github.com/ls1intum/Artemis/commit/632a06313bb448aefcdd6d5545f167e29689eaa6", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into enhancement/programming-assessment/manual-result-based-on-automatic", "committedDate": "2020-10-20T16:58:28Z", "type": "commit"}, {"oid": "5889e0944d4e3de20d04b8501bf41b2d397c2985", "url": "https://github.com/ls1intum/Artemis/commit/5889e0944d4e3de20d04b8501bf41b2d397c2985", "message": "cap total score to max score also in client", "committedDate": "2020-10-21T07:41:04Z", "type": "commit"}, {"oid": "22ffdc2e91cebaadbfd5368b5c4a35d8c071bb6f", "url": "https://github.com/ls1intum/Artemis/commit/22ffdc2e91cebaadbfd5368b5c4a35d8c071bb6f", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into enhancement/programming-assessment/manual-result-based-on-automatic\n\n# Conflicts:\n#\tsrc/main/java/de/tum/in/www1/artemis/service/TextAssessmentService.java\n#\tsrc/main/webapp/app/exercises/programming/assess/code-editor-tutor-assessment-container.component.ts\n#\tsrc/main/webapp/app/exercises/programming/assess/code-editor-tutor-assessment-inline-feedback.component.ts", "committedDate": "2020-10-21T11:21:12Z", "type": "commit"}, {"oid": "c86b42ead0b4122f21d48e8a296b4cd08ac31adf", "url": "https://github.com/ls1intum/Artemis/commit/c86b42ead0b4122f21d48e8a296b4cd08ac31adf", "message": "fix sgi bug for sever", "committedDate": "2020-10-21T12:03:22Z", "type": "commit"}, {"oid": "db6517d2f721584dedaed74ce26159a7bc54d37d", "url": "https://github.com/ls1intum/Artemis/commit/db6517d2f721584dedaed74ce26159a7bc54d37d", "message": "take SGI into account on client score calculation and extract calculation for SGI into own method", "committedDate": "2020-10-21T12:11:28Z", "type": "commit"}, {"oid": "abd38c0a46fb20495ae1b143592f763689f95ca4", "url": "https://github.com/ls1intum/Artemis/commit/abd38c0a46fb20495ae1b143592f763689f95ca4", "message": "cap the totalScore also to max points + bonus points for the other exercises types", "committedDate": "2020-10-21T12:29:31Z", "type": "commit"}, {"oid": "89ae3de1bda2949846838d0db7cdbeab134a75a0", "url": "https://github.com/ls1intum/Artemis/commit/89ae3de1bda2949846838d0db7cdbeab134a75a0", "message": "fix issue witch SGI calculation on client", "committedDate": "2020-10-21T14:23:46Z", "type": "commit"}, {"oid": "fbb4065a8f8b4660ce9589953e99ba9c1239fbc7", "url": "https://github.com/ls1intum/Artemis/commit/fbb4065a8f8b4660ce9589953e99ba9c1239fbc7", "message": "fix wrong selection of general feedback", "committedDate": "2020-10-21T15:46:46Z", "type": "commit"}, {"oid": "c18787069a2323f0599310f23fd6b03a4ef373c6", "url": "https://github.com/ls1intum/Artemis/commit/c18787069a2323f0599310f23fd6b03a4ef373c6", "message": "update also manual result when grading of automatic tests or SCA is changed", "committedDate": "2020-10-21T15:47:28Z", "type": "commit"}, {"oid": "61a7d41769e0772ebd2208e74146cbac01dddb8a", "url": "https://github.com/ls1intum/Artemis/commit/61a7d41769e0772ebd2208e74146cbac01dddb8a", "message": "run spotless", "committedDate": "2020-10-21T15:52:40Z", "type": "commit"}, {"oid": "35dc1f1606d322509b3a4609490852b0c5beb082", "url": "https://github.com/ls1intum/Artemis/commit/35dc1f1606d322509b3a4609490852b0c5beb082", "message": "try to fix test", "committedDate": "2020-10-21T18:38:30Z", "type": "commit"}, {"oid": "97efe7a5bd666a0cfba6444e5499d152859ceaf4", "url": "https://github.com/ls1intum/Artemis/commit/97efe7a5bd666a0cfba6444e5499d152859ceaf4", "message": "change manual result from manual to semi_automatic on server", "committedDate": "2020-10-21T20:03:30Z", "type": "commit"}, {"oid": "d9ed480fc005d5bacd75c8125e8ca976951e9581", "url": "https://github.com/ls1intum/Artemis/commit/d9ed480fc005d5bacd75c8125e8ca976951e9581", "message": "change manual result type from manual to semi_automatic on client", "committedDate": "2020-10-21T20:08:20Z", "type": "commit"}, {"oid": "318ba05939521b9a4c64acacd551c83db4cea847", "url": "https://github.com/ls1intum/Artemis/commit/318ba05939521b9a4c64acacd551c83db4cea847", "message": "run prettier and spotless", "committedDate": "2020-10-21T20:09:32Z", "type": "commit"}, {"oid": "be28c49959961e86b686a19aeed7c0f95b41a75a", "url": "https://github.com/ls1intum/Artemis/commit/be28c49959961e86b686a19aeed7c0f95b41a75a", "message": "fix wrong test", "committedDate": "2020-10-22T05:38:28Z", "type": "commit"}, {"oid": "bb12e038ebf9a07c7e9cd317164c3c3f4206c505", "url": "https://github.com/ls1intum/Artemis/commit/bb12e038ebf9a07c7e9cd317164c3c3f4206c505", "message": "try to fix issue with deleting manual feedback after reevaulate configure grading", "committedDate": "2020-10-22T08:00:37Z", "type": "commit"}, {"oid": "f173cd3ed34f0378196d3275d34f107eaa97ca8c", "url": "https://github.com/ls1intum/Artemis/commit/f173cd3ed34f0378196d3275d34f107eaa97ca8c", "message": "fix nullpointer and extend test", "committedDate": "2020-10-22T23:20:08Z", "type": "commit"}, {"oid": "bec1e9c8118a3e2cb2b45518e136f65cc6b9d5dc", "url": "https://github.com/ls1intum/Artemis/commit/bec1e9c8118a3e2cb2b45518e136f65cc6b9d5dc", "message": "fix docu issue", "committedDate": "2020-10-22T23:51:04Z", "type": "commit"}, {"oid": "82b9296bb7b63b279e4c91f4b96440f20161fa4b", "url": "https://github.com/ls1intum/Artemis/commit/82b9296bb7b63b279e4c91f4b96440f20161fa4b", "message": "fix issue that unreferenced and general feedback was deleted\nfix issue with wrong result string for manual results", "committedDate": "2020-10-22T23:53:46Z", "type": "commit"}, {"oid": "16e12c5ff588012b3d0d32847ea4253072dac348", "url": "https://github.com/ls1intum/Artemis/commit/16e12c5ff588012b3d0d32847ea4253072dac348", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into enhancement/programming-assessment/manual-result-based-on-automatic\n\n# Conflicts:\n#\tsrc/main/java/de/tum/in/www1/artemis/domain/Feedback.java", "committedDate": "2020-10-22T23:57:07Z", "type": "commit"}, {"oid": "447bac7c726dd3a7b89cb24c27aedf1d0baaa5ea", "url": "https://github.com/ls1intum/Artemis/commit/447bac7c726dd3a7b89cb24c27aedf1d0baaa5ea", "message": "fix another nullpointer\nset proper result score pro manual result\nrun spotless and small fixes", "committedDate": "2020-10-23T02:30:49Z", "type": "commit"}, {"oid": "bd4298ea81049ccbd401b6148c664b2830ddda46", "url": "https://github.com/ls1intum/Artemis/commit/bd4298ea81049ccbd401b6148c664b2830ddda46", "message": "fix failing tests", "committedDate": "2020-10-23T02:40:39Z", "type": "commit"}, {"oid": "6bc7ee731f3201a765dedc357951feec148231e4", "url": "https://github.com/ls1intum/Artemis/commit/6bc7ee731f3201a765dedc357951feec148231e4", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into enhancement/programming-assessment/manual-result-based-on-automatic", "committedDate": "2020-10-23T11:32:18Z", "type": "commit"}, {"oid": "937ff12c443c01281612b5a5bc32be34c63f2377", "url": "https://github.com/ls1intum/Artemis/commit/937ff12c443c01281612b5a5bc32be34c63f2377", "message": "fix nullpointers", "committedDate": "2020-10-23T12:44:07Z", "type": "commit"}, {"oid": "c076d793dc2fce5a048f20e023987d66d8391892", "url": "https://github.com/ls1intum/Artemis/commit/c076d793dc2fce5a048f20e023987d66d8391892", "message": "move setup automatic feedback to handleFeedback()", "committedDate": "2020-10-23T12:44:44Z", "type": "commit"}, {"oid": "8be9d136740c9f65ca1c353001f03a04b6a22be0", "url": "https://github.com/ls1intum/Artemis/commit/8be9d136740c9f65ca1c353001f03a04b6a22be0", "message": "fix issue with not updating result", "committedDate": "2020-10-23T13:45:39Z", "type": "commit"}, {"oid": "f017857d71ba3f86ecc6cc3f805a47fb584d100b", "url": "https://github.com/ls1intum/Artemis/commit/f017857d71ba3f86ecc6cc3f805a47fb584d100b", "message": "improve code quality on server", "committedDate": "2020-10-23T14:10:14Z", "type": "commit"}, {"oid": "4c0e9dbc9192c581a4785137ecadd31e30d6feb8", "url": "https://github.com/ls1intum/Artemis/commit/4c0e9dbc9192c581a4785137ecadd31e30d6feb8", "message": "improve code quality client", "committedDate": "2020-10-23T14:28:44Z", "type": "commit"}, {"oid": "48bfb1af34b64604d31b976d70447e77daf32037", "url": "https://github.com/ls1intum/Artemis/commit/48bfb1af34b64604d31b976d70447e77daf32037", "message": "run spotless", "committedDate": "2020-10-23T14:30:41Z", "type": "commit"}, {"oid": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "url": "https://github.com/ls1intum/Artemis/commit/4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "message": "remove not needed imports", "committedDate": "2020-10-23T14:43:14Z", "type": "commit"}, {"oid": "a29a9fa85de40e079514bb4472e8fb6a0c8a4255", "url": "https://github.com/ls1intum/Artemis/commit/a29a9fa85de40e079514bb4472e8fb6a0c8a4255", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into enhancement/programming-assessment/manual-result-based-on-automatic", "committedDate": "2020-10-23T14:44:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3Nzg4Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r510977882", "bodyText": "Could this be simplified to return this.type != FeedbackType.AUTOMATIC. The null case is already covered by the second conditional.", "author": "kloessst", "createdAt": "2020-10-23T15:48:25Z", "path": "src/main/java/de/tum/in/www1/artemis/domain/Feedback.java", "diffHunk": "@@ -226,6 +226,17 @@ public boolean isStaticCodeAnalysisFeedback() {\n         return this.text != null && this.text.startsWith(STATIC_CODE_ANALYSIS_FEEDBACK_IDENTIFIER) && this.type == FeedbackType.AUTOMATIC;\n     }\n \n+    /**\n+     * Checks whether the feedback is not an automatically generated feedback (test cases or SCA). We check for\n+     * manual (FeedbackType.MANUAL), unreferenced (FeedbackType.MANUAL_UNREFERENCED) and general (null) feedback.\n+     *\n+     * @return true if the it is not an automatically generated feedback else false\n+     */\n+    @JsonIgnore\n+    public boolean isNotAutomaticFeedback() {\n+        return this.type == null || this.type != FeedbackType.AUTOMATIC;", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5NjU0NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511096545", "bodyText": "You are right, then I will remove this and just do this.type != FeedbackType.AUTOMATIC.", "author": "fde312", "createdAt": "2020-10-23T19:16:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3Nzg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwNjk3Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511106973", "bodyText": "Done in 217c9f209", "author": "fde312", "createdAt": "2020-10-23T19:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3Nzg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4Mzk3Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r510983976", "bodyText": "Why do you expect that one more result is updated? I don't see where the setup was changed.", "author": "kloessst", "createdAt": "2020-10-23T15:58:24Z", "path": "src/test/java/de/tum/in/www1/artemis/programmingexercise/ProgrammingExerciseGradingServiceTest.java", "diffHunk": "@@ -420,7 +423,7 @@ public void shouldReEvaluateScoreOfTheCorrectResults() throws Exception {\n         // re-evaluate\n         final var endpoint = ProgrammingExerciseGradingResource.RE_EVALUATE.replace(\"{exerciseId}\", programmingExercise.getId().toString());\n         final var response = request.putWithResponseBody(ROOT + endpoint, \"{}\", Integer.class, HttpStatus.OK);\n-        assertThat(response).isEqualTo(6);\n+        assertThat(response).isEqualTo(7);", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTExODM1OQ==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511118359", "bodyText": "The createTestParticipations method creates a manual result. See line ProgrammingExerciseGradingServiceTest:572. Therefore the REST Call returns the size of 7.", "author": "fde312", "createdAt": "2020-10-23T19:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4Mzk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxMzk2NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511013965", "bodyText": "Could you use feedback.type == FeedbackType.AUTOMATIC instead of a double negation.", "author": "kloessst", "createdAt": "2020-10-23T16:51:52Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseGradingService.java", "diffHunk": "@@ -453,7 +483,7 @@ private void removeAllTestCaseFeedbackAndSetScoreToZero(Result result, List<Feed\n      * @return true if there is no feedback for a given test.\n      */\n     private Predicate<ProgrammingExerciseTestCase> wasNotExecuted(Result result) {\n-        return testCase -> result.getFeedbacks().stream().noneMatch(feedback -> feedback.getText().equals(testCase.getTestName()));\n+        return testCase -> result.getFeedbacks().stream().noneMatch(feedback -> !feedback.isNotAutomaticFeedback() && feedback.getText().equals(testCase.getTestName()));", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwNzY0Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511107642", "bodyText": "Done in 217c9f209", "author": "fde312", "createdAt": "2020-10-23T19:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxMzk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyMzEwNQ==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511023105", "bodyText": "I think I've seen this exact calculation also in the client gradingCriterionService. Could this be unified somehow? I guess it was always like this.", "author": "kloessst", "createdAt": "2020-10-23T17:09:30Z", "path": "src/main/java/de/tum/in/www1/artemis/service/AssessmentService.java", "diffHunk": "@@ -232,34 +239,11 @@ public double calculateTotalScore(Double calculatedScore, Double maxScore) {\n      */\n     public Double calculateTotalScore(List<Feedback> assessments) {\n         double totalScore = 0.0;\n-\n         var gradingInstructions = new HashMap<Long, Integer>(); // { instructionId: noOfEncounters }\n+\n         for (Feedback feedback : assessments) {\n             if (feedback.getGradingInstruction() != null) {\n-                if (gradingInstructions.get(feedback.getGradingInstruction().getId()) != null) {\n-                    // We Encountered this grading instruction before\n-                    var maxCount = feedback.getGradingInstruction().getUsageCount();\n-                    var encounters = gradingInstructions.get(feedback.getGradingInstruction().getId());\n-                    if (maxCount > 0) {\n-                        if (encounters >= maxCount) {\n-                            // the structured grading instruction was applied on assessment models more often that the usageCount limit allows so we don't sum the feedback credit\n-                            gradingInstructions.put(feedback.getGradingInstruction().getId(), encounters + 1);\n-                        }\n-                        else {\n-                            // the usageCount limit was not exceeded yet so we add the credit and increase the nrOfEncounters counter\n-                            gradingInstructions.put(feedback.getGradingInstruction().getId(), encounters + 1);\n-                            totalScore += feedback.getGradingInstruction().getCredits();\n-                        }\n-                    }\n-                    else {\n-                        totalScore += feedback.getCredits();\n-                    }\n-                }\n-                else {\n-                    // First time encountering the grading instruction\n-                    gradingInstructions.put(feedback.getGradingInstruction().getId(), 1);\n-                    totalScore += feedback.getCredits();\n-                }\n+                totalScore = gradingCriterionService.computeTotalScore(feedback, totalScore, gradingInstructions);", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTExOTgxNw==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511119817", "bodyText": "See general comment.", "author": "fde312", "createdAt": "2020-10-23T19:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyMzEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyMzU1Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511023553", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public double computeTotalScore(Feedback feedback, double totalScore, HashMap<Long, Integer> gradingInstructions) {\n          \n          \n            \n                public double computeTotalScore(Feedback feedback, double totalScore, Map<Long, Integer> gradingInstructions) {", "author": "kloessst", "createdAt": "2020-10-23T17:10:24Z", "path": "src/main/java/de/tum/in/www1/artemis/service/GradingCriterionService.java", "diffHunk": "@@ -46,4 +48,39 @@ public GradingCriterion findOne(long gradingCriterionId) {\n         return gradingCriterionRepository.findByExerciseIdWithEagerGradingCriteria(exerciseId);\n     }\n \n+    /**\n+     * Calculates the score over all feedback elements that were set using structured grading instructions (SGI)\n+     * @param feedback feedback element that was set by SGI\n+     * @param totalScore totalScore which is summed up. Starts from 0.0\n+     * @param gradingInstructions empty grading instruction Map to collect the used gradingInstructions\n+     * @return calculated total score from feedback elements set by SGI\n+     */\n+    public double computeTotalScore(Feedback feedback, double totalScore, HashMap<Long, Integer> gradingInstructions) {", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyNDY5Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511024697", "bodyText": "If the parameter totalScore is always zero, then it doesn't make sense to have it as a parameter. I would suggest to remove it from the signature and provide it as a local variable.", "author": "kloessst", "createdAt": "2020-10-23T17:12:36Z", "path": "src/main/java/de/tum/in/www1/artemis/service/GradingCriterionService.java", "diffHunk": "@@ -46,4 +48,39 @@ public GradingCriterion findOne(long gradingCriterionId) {\n         return gradingCriterionRepository.findByExerciseIdWithEagerGradingCriteria(exerciseId);\n     }\n \n+    /**\n+     * Calculates the score over all feedback elements that were set using structured grading instructions (SGI)\n+     * @param feedback feedback element that was set by SGI\n+     * @param totalScore totalScore which is summed up. Starts from 0.0\n+     * @param gradingInstructions empty grading instruction Map to collect the used gradingInstructions\n+     * @return calculated total score from feedback elements set by SGI\n+     */\n+    public double computeTotalScore(Feedback feedback, double totalScore, HashMap<Long, Integer> gradingInstructions) {", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTExMTE5Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511111197", "bodyText": "No, it is also summed up from the Class where it is called from. Fixed the description", "author": "fde312", "createdAt": "2020-10-23T19:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyNDY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyODcyMA==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511028720", "bodyText": "It seems a bit off to calculate the score again for manual assessments in this method. The method should just update the result String and do nothing else.", "author": "kloessst", "createdAt": "2020-10-23T17:20:23Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseGradingService.java", "diffHunk": "@@ -419,10 +438,21 @@ private double calculateStaticCodeAnalysisPenalty(List<Feedback> staticCodeAnaly\n      * @param successfulTestCases test cases with positive feedback.\n      * @param allTests of the given programming exercise.\n      */\n-    private void updateResultString(Result result, Set<ProgrammingExerciseTestCase> successfulTestCases, Set<ProgrammingExerciseTestCase> allTests) {\n-        // Create a new result string that reflects passed, failed & not executed test cases.\n-        String newResultString = successfulTestCases.size() + \" of \" + allTests.size() + \" passed\";\n-        result.setResultString(newResultString);\n+    private void updateResultString(Result result, Set<ProgrammingExerciseTestCase> successfulTestCases, Set<ProgrammingExerciseTestCase> allTests, ProgrammingExercise exercise) {\n+        if (result.getAssessmentType() == AssessmentType.AUTOMATIC) {\n+            // Create a new result string that reflects passed, failed & not executed test cases.\n+            String newResultString = successfulTestCases.size() + \" of \" + allTests.size() + \" passed\";\n+            result.setResultString(newResultString);\n+        }\n+        else {\n+            // Calculate different scores for totalScore calculation and set resultString for manual results\n+            double maxScore = exercise.getMaxScore();\n+            double bonusPoints = Optional.ofNullable(exercise.getBonusPoints()).orElse(0.0);\n+            double calculatedScore = programmingAssessmentService.calculateTotalScore(result.getFeedbacks());\n+            double totalScore = programmingAssessmentService.calculateTotalScore(calculatedScore, maxScore + bonusPoints);", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTExMzU3OQ==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511113579", "bodyText": "The problem was that the result score calculation just included the automatic feedback, so it was falsely calculated in case of a manual result. Therefore I recalculated it like it is done for the Assessment.", "author": "fde312", "createdAt": "2020-10-23T19:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyODcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyOTQ5OA==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511029498", "bodyText": "Double negation. Could probably check for FeedbackType.AUTOMATIC", "author": "kloessst", "createdAt": "2020-10-23T17:21:53Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseGradingService.java", "diffHunk": "@@ -325,7 +343,8 @@ private void updateScore(Result result, Set<ProgrammingExerciseTestCase> success\n                 double testPoints = testWeight / weightSum * programmingExercise.getMaxScore();\n                 double testPointsWithBonus = testPoints + test.getBonusPoints();\n                 // update credits of related feedback\n-                result.getFeedbacks().stream().filter(fb -> fb.getText().equals(test.getTestName())).findFirst().ifPresent(feedback -> feedback.setCredits(testPointsWithBonus));\n+                result.getFeedbacks().stream().filter(fb -> !fb.isNotAutomaticFeedback() && fb.getText().equals(test.getTestName())).findFirst()", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwNzQ5OQ==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511107499", "bodyText": "Done in 217c9f209", "author": "fde312", "createdAt": "2020-10-23T19:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyOTQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyOTkzMw==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511029933", "bodyText": "Double negation. Could probably check for FeedbackType.AUTOMATIC", "author": "kloessst", "createdAt": "2020-10-23T17:22:43Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseGradingService.java", "diffHunk": "@@ -295,8 +313,8 @@ private void createFeedbackForNotExecutedTests(Result result, Set<ProgrammingExe\n      */\n     private void removeFeedbacksForAfterDueDateTests(Result result, Set<ProgrammingExerciseTestCase> testCasesForCurrentDate) {\n         // Find feedback which is not associated with test cases for the current date. Does not remove static code analysis feedback\n-        List<Feedback> feedbacksToFilterForCurrentDate = result.getFeedbacks().stream().filter(\n-                feedback -> !feedback.isStaticCodeAnalysisFeedback() && testCasesForCurrentDate.stream().noneMatch(testCase -> testCase.getTestName().equals(feedback.getText())))\n+        List<Feedback> feedbacksToFilterForCurrentDate = result.getFeedbacks().stream().filter(feedback -> !feedback.isStaticCodeAnalysisFeedback()\n+                && !feedback.isNotAutomaticFeedback() && testCasesForCurrentDate.stream().noneMatch(testCase -> testCase.getTestName().equals(feedback.getText())))", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwNzM2MQ==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511107361", "bodyText": "Done in 217c9f209", "author": "fde312", "createdAt": "2020-10-23T19:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAyOTkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTg3Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511031872", "bodyText": "Maybe we need a bigger refactoring here. Instead of having an all in one updateResult method which gets more and more complex because it has to handle all kinds of different feedback, we create a updateManualResult method. This could also solve the problem that updateResultString triggers yet another calculation for the manual case. This might be out of scope of this PR.", "author": "kloessst", "createdAt": "2020-10-23T17:26:32Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseGradingService.java", "diffHunk": "@@ -215,6 +219,17 @@ public Result updateResult(Result result, ProgrammingExercise exercise, boolean\n                 updatedResults.add(result);\n             }\n         }\n+\n+        // Update also manual results\n+        List<StudentParticipation> participationsWithManualResult = participationService.findByExerciseIdWithManualResultAndFeedbacks(exercise.getId());\n+        for (StudentParticipation studentParticipation : participationsWithManualResult) {\n+            Result result = studentParticipation.findLatestResult();\n+            if (result != null) {\n+                updateResult(testCases, testCasesForCurrentDate, result, exercise);", "originalCommit": "4d51dab7e46ca17920d0fae634ca2d852e9a4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTExOTcxMg==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511119712", "bodyText": "I think that @schultek wanted to adapt the calculation anyways. Maybe we can do the refactoring then or in a follow up after that :)", "author": "fde312", "createdAt": "2020-10-23T19:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTg3Mg=="}], "type": "inlineReview"}, {"oid": "a10860365e3567de7d63a6e11f7204497b12c6d9", "url": "https://github.com/ls1intum/Artemis/commit/a10860365e3567de7d63a6e11f7204497b12c6d9", "message": "add tests", "committedDate": "2020-10-23T19:06:48Z", "type": "commit"}, {"oid": "217c9f209465e531e173695486fcce6aa75917d0", "url": "https://github.com/ls1intum/Artemis/commit/217c9f209465e531e173695486fcce6aa75917d0", "message": "remove not needed method and do simple check", "committedDate": "2020-10-23T19:27:46Z", "type": "commit"}, {"oid": "11aec7ef1b0258c9329c25dfbe2fdedd641eccc6", "url": "https://github.com/ls1intum/Artemis/commit/11aec7ef1b0258c9329c25dfbe2fdedd641eccc6", "message": "try to make codacy happy", "committedDate": "2020-10-23T19:47:33Z", "type": "commit"}, {"oid": "8ba7b822efc2c6c2be1af79dd71843ff235110d7", "url": "https://github.com/ls1intum/Artemis/commit/8ba7b822efc2c6c2be1af79dd71843ff235110d7", "message": "apply spotless", "committedDate": "2020-10-23T19:48:14Z", "type": "commit"}, {"oid": "1ac7a287d5f910a43ed8ffa68c2fe1930efde01f", "url": "https://github.com/ls1intum/Artemis/commit/1ac7a287d5f910a43ed8ffa68c2fe1930efde01f", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into enhancement/programming-assessment/manual-result-based-on-automatic", "committedDate": "2020-10-23T19:49:56Z", "type": "commit"}, {"oid": "1ba184164ade361bb0764bf59730d7240918f0d6", "url": "https://github.com/ls1intum/Artemis/commit/1ba184164ade361bb0764bf59730d7240918f0d6", "message": "add test", "committedDate": "2020-10-23T22:55:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM2MDY4OA==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511360688", "bodyText": "You should cap this again to maxPoints, as you did in the tutor-assessment-container line 442", "author": "schultek", "createdAt": "2020-10-24T09:25:09Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ProgrammingAssessmentService.java", "diffHunk": "@@ -61,7 +68,50 @@ public Result submitManualAssessment(long resultId) {\n         Result result = resultRepository.findWithEagerSubmissionAndFeedbackAndAssessorById(resultId)\n                 .orElseThrow(() -> new EntityNotFoundException(\"No result for the given resultId could be found\"));\n \n-        Double calculatedScore = calculateTotalScore(result.getFeedbacks());\n+        Double calculatedScore = calculateTotalScore(result);\n         return submitResult(result, result.getParticipation().getExercise(), calculatedScore);\n     }\n+\n+    /**\n+     * Calculates the total score for programming exercises.\n+     * @param result with information about feedback and exercise\n+     * @return calculated totalScore\n+     */\n+    private Double calculateTotalScore(Result result) {\n+        double totalScore = 0.0;\n+        double scoreAutomaticTests = 0.0;\n+        ProgrammingExercise programmingExercise = (ProgrammingExercise) result.getParticipation().getExercise();\n+        List<Feedback> assessments = result.getFeedbacks();\n+        var gradingInstructions = new HashMap<Long, Integer>(); // { instructionId: noOfEncounters }\n+\n+        for (Feedback feedback : assessments) {\n+            if (feedback.getGradingInstruction() != null) {\n+                totalScore = gradingCriterionService.computeTotalScore(feedback, totalScore, gradingInstructions);\n+            }\n+            else {\n+                /*\n+                 * In case no structured grading instruction was applied on the assessment model we just sum the feedback credit. We differentiate between automatic test and\n+                 * automatic SCA feedback (automatic test feedback has to be capped)\n+                 */\n+                if (feedback.getType() == FeedbackType.AUTOMATIC && !feedback.isStaticCodeAnalysisFeedback()) {\n+                    scoreAutomaticTests += feedback.getCredits();\n+                }\n+                else {\n+                    totalScore += feedback.getCredits();\n+                }\n+            }\n+        }\n+        /** Calculated score from automatic test feedbacks, is capped to max points + bonus points,\n+        * see also see {@link ProgrammingExerciseGradingService#updateScore} */\n+        double maxPoints = programmingExercise.getMaxScore() + Optional.ofNullable(programmingExercise.getBonusPoints()).orElse(0.0);\n+        if (scoreAutomaticTests > maxPoints) {\n+            scoreAutomaticTests = maxPoints;\n+        }\n+        totalScore += scoreAutomaticTests;\n+        // Make sure to not give negative points\n+        if (totalScore < 0) {\n+            totalScore = 0;\n+        }", "originalCommit": "1ba184164ade361bb0764bf59730d7240918f0d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQyMDQyMQ==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511420421", "bodyText": "@schultek This is done, but in the submitResult call which is done in line 72 (after this calculation). Then in the submitResult call we call a different calculateTotalScore method see AssessementService.java:227 and there we cap it to the maxScore.", "author": "fde312", "createdAt": "2020-10-24T12:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM2MDY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ2MTE2Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2223#discussion_r511461163", "bodyText": "Ok", "author": "schultek", "createdAt": "2020-10-24T13:49:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM2MDY4OA=="}], "type": "inlineReview"}, {"oid": "3a12928d5f9a0227da72b5f1f7d34b83e35f5450", "url": "https://github.com/ls1intum/Artemis/commit/3a12928d5f9a0227da72b5f1f7d34b83e35f5450", "message": "cap also negative scores for other exercise types", "committedDate": "2020-10-24T13:54:20Z", "type": "commit"}, {"oid": "10ae5ddb75367d3c957a0ef42a693a52d7b9d176", "url": "https://github.com/ls1intum/Artemis/commit/10ae5ddb75367d3c957a0ef42a693a52d7b9d176", "message": "improve test coverage", "committedDate": "2020-10-24T16:47:15Z", "type": "commit"}, {"oid": "a81d59631a14b65233ceb0509fa0d0d340d415f7", "url": "https://github.com/ls1intum/Artemis/commit/a81d59631a14b65233ceb0509fa0d0d340d415f7", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into enhancement/programming-assessment/manual-result-based-on-automatic\n\n# Conflicts:\n#\tsrc/test/java/de/tum/in/www1/artemis/util/DatabaseUtilService.java", "committedDate": "2020-10-24T16:51:44Z", "type": "commit"}, {"oid": "3ff7e7f161dc3a38cc08b28f5ceaf9f3ca261cd8", "url": "https://github.com/ls1intum/Artemis/commit/3ff7e7f161dc3a38cc08b28f5ceaf9f3ca261cd8", "message": "run spotless", "committedDate": "2020-10-24T17:31:15Z", "type": "commit"}, {"oid": "175c40e2c789dcae280dc9aa2a694c9c1e805194", "url": "https://github.com/ls1intum/Artemis/commit/175c40e2c789dcae280dc9aa2a694c9c1e805194", "message": "try to fix failing of tests", "committedDate": "2020-10-24T18:35:53Z", "type": "commit"}, {"oid": "24c20ccea3fa1ea35459d9b39f05fbd18d00b4f1", "url": "https://github.com/ls1intum/Artemis/commit/24c20ccea3fa1ea35459d9b39f05fbd18d00b4f1", "message": "forgot to remove test", "committedDate": "2020-10-24T19:17:28Z", "type": "commit"}, {"oid": "10128b6597b1c7723b5f48bac0d1d58c9d0c1df4", "url": "https://github.com/ls1intum/Artemis/commit/10128b6597b1c7723b5f48bac0d1d58c9d0c1df4", "message": "Merge branch 'develop' into enhancement/programming-assessment/manual-result-based-on-automatic", "committedDate": "2020-10-24T20:25:33Z", "type": "commit"}, {"oid": "0ccd7c6ebc3ea7dee25456bb6aab500f80234452", "url": "https://github.com/ls1intum/Artemis/commit/0ccd7c6ebc3ea7dee25456bb6aab500f80234452", "message": "Merge branch 'develop' into enhancement/programming-assessment/manual-result-based-on-automatic", "committedDate": "2020-10-24T20:26:24Z", "type": "commit"}]}