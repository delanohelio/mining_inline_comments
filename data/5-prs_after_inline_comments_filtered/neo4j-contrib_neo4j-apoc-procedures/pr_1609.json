{"pr_number": 1609, "pr_title": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type", "pr_createdAt": "2020-07-30T07:59:12Z", "pr_url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNjcxMA==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r464316710", "bodyText": "need to update description", "author": "jexp", "createdAt": "2020-08-03T10:02:08Z", "path": "src/main/java/apoc/refactor/rename/Rename.java", "diffHunk": "@@ -61,27 +63,52 @@\n \t */\n \t@Procedure(mode = Mode.WRITE)\n \t@Description(\"apoc.refactor.rename.type(oldType, newType, [rels]) | rename all relationships with type 'oldType' to 'newType'. If 'rels' is provided renaming is applied to this set only\")", "originalCommit": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNzM3Mw==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r497537373", "bodyText": "done", "author": "conker84", "createdAt": "2020-09-30T14:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNjcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNjk1Ng==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r464316956", "bodyText": "perhaps move to Periodic.java or Util.java?", "author": "jexp", "createdAt": "2020-08-03T10:02:42Z", "path": "src/main/java/apoc/refactor/rename/Rename.java", "diffHunk": "@@ -61,27 +63,52 @@\n \t */\n \t@Procedure(mode = Mode.WRITE)\n \t@Description(\"apoc.refactor.rename.type(oldType, newType, [rels]) | rename all relationships with type 'oldType' to 'newType'. If 'rels' is provided renaming is applied to this set only\")\n-\tpublic Stream<BatchAndTotalResultWithInfo> type(@Name(\"oldType\") String oldType, @Name(\"newType\") String newType, @Name(value = \"rels\", defaultValue = \"[]\") List<Relationship> rels) {\n+\tpublic Stream<BatchAndTotalResultWithInfo> type(@Name(\"oldType\") String oldType,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(\"newType\") String newType,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(value = \"rels\", defaultValue = \"[]\") List<Relationship> rels,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(value = \"config\", defaultValue = \"{}\") Map<String, Object> config) {\n \t\trels = rels.stream().map(r -> Util.rebind(tx, r)).collect(Collectors.toList());\n-\t\tList<Long> relIds = rels.stream().map(r -> r.getId()).collect(Collectors.toList());\n \t\tString cypherIterate = rels != null && ! rels.isEmpty() ?\n \t\t\t\t\"UNWIND $rels AS oldRel WITH oldRel WHERE type(oldRel)=\\\"\"+oldType+\"\\\" RETURN oldRel,startNode(oldRel) as a,endNode(oldRel) as b\" :\n \t\t\t\t\"MATCH (a)-[oldRel:`\"+oldType+\"`]->(b) RETURN oldRel,a,b\";\n \t\tString cypherAction = \"CREATE(a)-[newRel:`\"+newType+\"`]->(b)\"+ \"SET newRel+=oldRel DELETE oldRel\";\n-\t\tMap<String, Object> parameters = MapUtil.map(\"batchSize\", 100000, \"parallel\", true, \"iterateList\", true, \"params\", MapUtil.map(\"rels\", rels));\n+\t\tfinal Map<String, Object> params = MapUtil.map(\"rels\", rels);\n+\t\tMap<String, Object> parameters = getPeriodicConfig(config, params);\n \t\treturn getResultOfBatchAndTotalWithInfo(newPeriodic().iterate(cypherIterate, cypherAction, parameters), db, null, oldType, null);\n \t}\n \n+\t@NotNull", "originalCommit": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzODkxOQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r497538919", "bodyText": "I prefer to leave it here because the defaults are custom defined in this procedure", "author": "conker84", "createdAt": "2020-09-30T14:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNjk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNzE0NA==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r464317144", "bodyText": "adjust description", "author": "jexp", "createdAt": "2020-08-03T10:03:02Z", "path": "src/main/java/apoc/refactor/rename/Rename.java", "diffHunk": "@@ -61,27 +63,52 @@\n \t */\n \t@Procedure(mode = Mode.WRITE)\n \t@Description(\"apoc.refactor.rename.type(oldType, newType, [rels]) | rename all relationships with type 'oldType' to 'newType'. If 'rels' is provided renaming is applied to this set only\")\n-\tpublic Stream<BatchAndTotalResultWithInfo> type(@Name(\"oldType\") String oldType, @Name(\"newType\") String newType, @Name(value = \"rels\", defaultValue = \"[]\") List<Relationship> rels) {\n+\tpublic Stream<BatchAndTotalResultWithInfo> type(@Name(\"oldType\") String oldType,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(\"newType\") String newType,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(value = \"rels\", defaultValue = \"[]\") List<Relationship> rels,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(value = \"config\", defaultValue = \"{}\") Map<String, Object> config) {\n \t\trels = rels.stream().map(r -> Util.rebind(tx, r)).collect(Collectors.toList());\n-\t\tList<Long> relIds = rels.stream().map(r -> r.getId()).collect(Collectors.toList());\n \t\tString cypherIterate = rels != null && ! rels.isEmpty() ?\n \t\t\t\t\"UNWIND $rels AS oldRel WITH oldRel WHERE type(oldRel)=\\\"\"+oldType+\"\\\" RETURN oldRel,startNode(oldRel) as a,endNode(oldRel) as b\" :\n \t\t\t\t\"MATCH (a)-[oldRel:`\"+oldType+\"`]->(b) RETURN oldRel,a,b\";\n \t\tString cypherAction = \"CREATE(a)-[newRel:`\"+newType+\"`]->(b)\"+ \"SET newRel+=oldRel DELETE oldRel\";\n-\t\tMap<String, Object> parameters = MapUtil.map(\"batchSize\", 100000, \"parallel\", true, \"iterateList\", true, \"params\", MapUtil.map(\"rels\", rels));\n+\t\tfinal Map<String, Object> params = MapUtil.map(\"rels\", rels);\n+\t\tMap<String, Object> parameters = getPeriodicConfig(config, params);\n \t\treturn getResultOfBatchAndTotalWithInfo(newPeriodic().iterate(cypherIterate, cypherAction, parameters), db, null, oldType, null);\n \t}\n \n+\t@NotNull\n+\tprivate Map<String, Object> getPeriodicConfig(@Name(value = \"config\", defaultValue = \"{}\") Map<String, Object> config, Map<String, Object> params) {\n+\t\tif (config == null) {\n+\t\t\tconfig = Collections.emptyMap();\n+\t\t}\n+\t\tfinal int batchSize = Util.toInteger(config.getOrDefault(\"batchSize\", 100000));\n+\t\tfinal int concurrency = Util.toInteger(config.getOrDefault(\"concurrency\", 50));\n+\t\tfinal int retries = Util.toInteger(config.getOrDefault(\"retries\", 0));\n+\t\tfinal boolean parallel = Util.toBoolean(config.getOrDefault(\"parallel\", true));\n+\t\tfinal String batchMode = config.getOrDefault(\"batchMode\", \"BATCH\").toString();\n+\t\treturn MapUtil.map(\"batchSize\", batchSize,\n+\t\t\t\t\"retries\", retries,\n+\t\t\t\t\"parallel\", parallel,\n+\t\t\t\t\"batchMode\", batchMode,\n+\t\t\t\t\"concurrency\", concurrency,\n+\t\t\t\t\"params\", params);\n+\t}\n+\n \t/**\n \t * Rename property of a node by creating a new one and deleting the old.\n \t */\n \t@Procedure(mode = Mode.WRITE)\n \t@Description(\"apoc.refactor.rename.nodeProperty(oldName, newName, [nodes]) | rename all node's property from 'oldName' to 'newName'. If 'nodes' is provided renaming is applied to this set only\")", "originalCommit": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzODk3NQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r497538975", "bodyText": "done", "author": "conker84", "createdAt": "2020-09-30T14:07:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNzE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNzIzMg==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r464317232", "bodyText": "description", "author": "jexp", "createdAt": "2020-08-03T10:03:13Z", "path": "src/main/java/apoc/refactor/rename/Rename.java", "diffHunk": "@@ -90,11 +117,15 @@\n \t */\n \t@Procedure(mode = Mode.WRITE)", "originalCommit": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzOTAxOQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r497539019", "bodyText": "done", "author": "conker84", "createdAt": "2020-09-30T14:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNzIzMg=="}], "type": "inlineReview"}, {"oid": "d7f0def9372522e9255c0a5541f894710aa40ef1", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d7f0def9372522e9255c0a5541f894710aa40ef1", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type", "committedDate": "2020-09-30T14:00:34Z", "type": "forcePushed"}, {"oid": "45ec81c4eb209ba1d45d2af5374c32fdf6af9be6", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/45ec81c4eb209ba1d45d2af5374c32fdf6af9be6", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type", "committedDate": "2020-09-30T14:04:53Z", "type": "forcePushed"}, {"oid": "82ccdc879649d8159ea44f1e784a6fbecc3fa828", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/82ccdc879649d8159ea44f1e784a6fbecc3fa828", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type", "committedDate": "2020-09-30T14:05:08Z", "type": "commit"}, {"oid": "82ccdc879649d8159ea44f1e784a6fbecc3fa828", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/82ccdc879649d8159ea44f1e784a6fbecc3fa828", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type", "committedDate": "2020-09-30T14:05:08Z", "type": "forcePushed"}]}