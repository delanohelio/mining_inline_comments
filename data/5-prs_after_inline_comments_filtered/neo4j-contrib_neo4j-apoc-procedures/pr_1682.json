{"pr_number": 1682, "pr_title": "Handle Optional.empty() function descriptions", "pr_createdAt": "2020-10-06T16:27:16Z", "pr_url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682", "timeline": [{"oid": "7b7582073a2cea0b206510781f8fb00143f62cbc", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/7b7582073a2cea0b206510781f8fb00143f62cbc", "message": "Handle Optional.empty() function descriptions\n\nThis handles loading a stored APOC custom state where\na function or procedure had an Optional.empty() description.\n\nJackson serialized those to {\"present::false}, which then broke\nApocs assumptions about the schema here.\n\nThis makes it so we handle any in-the-wild incarnations of this,\nand modifies our write path to always ensure the value is a string", "committedDate": "2020-10-06T16:25:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NDcwOQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682#discussion_r500474709", "bodyText": "should probably return null as well", "author": "jexp", "createdAt": "2020-10-06T17:31:08Z", "path": "src/main/java/apoc/custom/CypherProcedures.java", "diffHunk": "@@ -565,6 +566,18 @@ private void restoreProcedures() {\n             clearQueryCaches(api);\n         }\n \n+        private String parseStoredDescription(Object rawDescription) {\n+            // Description was changed to be an Optional in the Neo4j internal API. Optional.None serialized to\n+            // JSON objects in various stores around the world; hence, deal with this value not being a string\n+            if(rawDescription instanceof String) {\n+                if(\"null\".equals(rawDescription)) {\n+                    return null;\n+                }\n+                return (String)rawDescription;\n+            }\n+            return \"\";", "originalCommit": "7b7582073a2cea0b206510781f8fb00143f62cbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4MzgxOA==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682#discussion_r500483818", "bodyText": "sorry I overlooked this b/c it was too far on the right :) can you use .orElse(null) so that we're consistent? in the 2 places?", "author": "jexp", "createdAt": "2020-10-06T17:46:42Z", "path": "src/main/java/apoc/custom/CypherProcedures.java", "diffHunk": "@@ -589,7 +602,7 @@ public void unavailable() {\n         }\n \n         public static Map<String, Object> storeFunction(GraphDatabaseAPI api, UserFunctionSignature signature, String statement, boolean forceSingle) {\n-            Map<String, Object> data = map(\"statement\", statement, \"forceSingle\", forceSingle, \"signature\", signature.toString(), \"description\", signature.description());\n+            Map<String, Object> data = map(\"statement\", statement, \"forceSingle\", forceSingle, \"signature\", signature.toString(), \"description\", signature.description().orElse(\"\"));", "originalCommit": "8aa81ec278410dcb8d0f66b98bc6ed32c7ffce79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4OTE2NQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682#discussion_r500489165", "bodyText": "\ud83d\udc4d", "author": "jakewins", "createdAt": "2020-10-06T17:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4MzgxOA=="}], "type": "inlineReview"}, {"oid": "344fb9c1234d1bf212067a15f567e0cc4f7e48f6", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/344fb9c1234d1bf212067a15f567e0cc4f7e48f6", "message": "Fix review comments on handling Optional.empty()\n\nStandardize on null for strings that were serialized to maps.", "committedDate": "2020-10-06T17:53:12Z", "type": "commit"}, {"oid": "344fb9c1234d1bf212067a15f567e0cc4f7e48f6", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/344fb9c1234d1bf212067a15f567e0cc4f7e48f6", "message": "Fix review comments on handling Optional.empty()\n\nStandardize on null for strings that were serialized to maps.", "committedDate": "2020-10-06T17:53:12Z", "type": "forcePushed"}]}