{"pr_number": 1628, "pr_title": "support both, single command or list of commands for apoc.systemdb.execute", "pr_createdAt": "2020-08-21T15:12:32Z", "pr_url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1628", "timeline": [{"oid": "e1c6c8b2497f1ebc7cbc689c811d528001afbff4", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/e1c6c8b2497f1ebc7cbc689c811d528001afbff4", "message": "fixes 1627: support both, a single command or a list of commands for apoc.systemdb.execute", "committedDate": "2020-08-21T15:11:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNjg4MQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1628#discussion_r474836881", "bodyText": "should there be some explicit call to roll back on errors?", "author": "eastlondoner", "createdAt": "2020-08-21T17:39:33Z", "path": "full/src/main/java/apoc/systemdb/SystemDb.java", "diffHunk": "@@ -63,9 +64,23 @@ public NodesAndRelationshipsResult(List<Node> nodes, List<Relationship> relation\n     }\n \n     @Procedure\n-    public Stream<RowResult> execute(@Name(\"DDL command\") String command, @Name(value=\"params\", defaultValue = \"{}\") Map<String ,Object> params) {\n+    public Stream<RowResult> execute(@Name(\"DDL commands, either a string or a list of strings\") Object ddlStringOrList, @Name(value=\"params\", defaultValue = \"{}\") Map<String ,Object> params) {\n         Util.checkAdmin(securityContext,\"apoc.systemdb.execute\");\n-        return withSystemDbTransaction(tx -> tx.execute(command, params).stream().map(map -> new RowResult(map)));\n+\n+        List<String> commands;\n+        if (ddlStringOrList instanceof String) {\n+            commands = Collections.singletonList((String)ddlStringOrList);\n+        } else if (ddlStringOrList instanceof List) {\n+            commands = (List<String>) ddlStringOrList;\n+        } else {\n+            throw new IllegalArgumentException(\"don't know how to handle \" + ddlStringOrList + \". Supply either a string or a list of strings\");\n+        }\n+\n+        Transaction tx = apocConfig.getSystemDb().beginTx();  // we can't use try-with-resources otherwise tx gets closed too early\n+        return commands.stream().flatMap(command -> tx.execute(command, params).stream().map(RowResult::new)).onClose(() -> {\n+            tx.commit();\n+            tx.close();\n+        });", "originalCommit": "e1c6c8b2497f1ebc7cbc689c811d528001afbff4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyMjcyNw==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1628#discussion_r479622727", "bodyText": "rollback happens automatically if tx.execute fails. I've added a check to only do tx.commit if the tx is still open, see below.", "author": "sarmbruster", "createdAt": "2020-08-29T07:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNjg4MQ=="}], "type": "inlineReview"}, {"oid": "81d552d644ed3c566af099edfbb6ba24aa8491b8", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/81d552d644ed3c566af099edfbb6ba24aa8491b8", "message": "don't commit once tx has failed", "committedDate": "2020-08-29T07:48:30Z", "type": "commit"}]}