{"pr_number": 4563, "pr_title": "Keep loading on the All Episodes tab even if items are filtered out", "pr_createdAt": "2020-10-20T10:27:30Z", "pr_url": "https://github.com/AntennaPod/AntennaPod/pull/4563", "timeline": [{"oid": "85b897c7d778ae70d837ae0c2a9e7b4252ea8945", "url": "https://github.com/AntennaPod/AntennaPod/commit/85b897c7d778ae70d837ae0c2a9e7b4252ea8945", "message": "Filter the All Episodes tab via SQL Query\n\nFixes #4414", "committedDate": "2020-11-06T01:03:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYzODgyNw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4563#discussion_r518638827", "bodyText": "Why does the method need to be renamed? I would just keep the old name and update the other uses (which are only tests). That way, we can reduce code duplication.", "author": "ByteHamster", "createdAt": "2020-11-06T09:51:02Z", "path": "app/src/main/java/de/danoeh/antennapod/fragment/AllEpisodesFragment.java", "diffHunk": "@@ -105,13 +105,12 @@ protected boolean shouldUpdatedItemRemainInList(FeedItem item) {\n     @NonNull\n     @Override\n     protected List<FeedItem> loadData() {\n-        return feedItemFilter.filter(DBReader.getRecentlyPublishedEpisodes(0, page * EPISODES_PER_PAGE));\n+        return DBReader.getRecentlyPublishedEpisodesFiltered(0, page * EPISODES_PER_PAGE, feedItemFilter);", "originalCommit": "85b897c7d778ae70d837ae0c2a9e7b4252ea8945", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0MzM4Mw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4563#discussion_r518643383", "bodyText": "I think it would be better to move this to its own class. That allows to make the filter object only a data store object without any program logic. AntennaPod's code is pretty mixed up and every object has access to everything else. For example, FeedItems perform database queries. I think we should try to make components of the app as decoupled as possible (and later maybe even move to different modules). This method would fit better into the de.danoeh.antennapod.core.storage package.", "author": "ByteHamster", "createdAt": "2020-11-06T09:58:48Z", "path": "core/src/main/java/de/danoeh/antennapod/core/feed/FeedItemFilter.java", "diffHunk": "@@ -78,6 +80,45 @@ public FeedItemFilter(String[] properties) {\n                     break;\n             }\n         }\n+\n+        mQuery = makeQuery();\n+    }\n+\n+    private String makeQuery() {", "originalCommit": "85b897c7d778ae70d837ae0c2a9e7b4252ea8945", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0Mzk5NQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4563#discussion_r518643995", "bodyText": "That can later be simplified when using a join for the queue items. Does not have to be done in this PR, though.", "author": "ByteHamster", "createdAt": "2020-11-06T09:59:50Z", "path": "core/src/main/java/de/danoeh/antennapod/core/feed/FeedItemFilter.java", "diffHunk": "@@ -78,6 +80,45 @@ public FeedItemFilter(String[] properties) {\n                     break;\n             }\n         }\n+\n+        mQuery = makeQuery();\n+    }\n+\n+    private String makeQuery() {\n+        // The keys used within this method, but explicitly combined with their table\n+        String keyRead = PodDBAdapter.TABLE_NAME_FEED_ITEMS + \".\" + PodDBAdapter.KEY_READ;\n+        String keyPosition = PodDBAdapter.TABLE_NAME_FEED_MEDIA + \".\" + PodDBAdapter.KEY_POSITION;\n+        String keyDownloaded = PodDBAdapter.TABLE_NAME_FEED_MEDIA + \".\" + PodDBAdapter.KEY_DOWNLOADED;\n+        String keyMediaId = PodDBAdapter.TABLE_NAME_FEED_MEDIA + \".\" + PodDBAdapter.KEY_ID;\n+        String keyItemId = PodDBAdapter.TABLE_NAME_FEED_ITEMS + \".\" + PodDBAdapter.KEY_ID;\n+        String keyFeedItem = PodDBAdapter.KEY_FEEDITEM;\n+        String tableQueue = PodDBAdapter.TABLE_NAME_QUEUE;\n+        String tableFavorites = PodDBAdapter.TABLE_NAME_FAVORITES;\n+\n+        List<String> statements = new ArrayList<>();\n+        if (showPlayed)        statements.add(keyRead + \" = 1 \");\n+        if (showUnplayed)      statements.add(\" NOT \" + keyRead + \" = 1 \"); // Match \"New\" items (read = -1) as well\n+        if (showPaused)        statements.add(\" (\" + keyPosition + \" NOT NULL AND \" + keyPosition + \" > 0 \" + \") \");\n+        if (showNotPaused)     statements.add(\" (\" + keyPosition + \" IS NULL OR \" + keyPosition + \" = 0 \" + \") \");\n+        if (showQueued)        statements.add(keyItemId + \" IN (SELECT \" + keyFeedItem + \" FROM \" + tableQueue + \") \");", "originalCommit": "85b897c7d778ae70d837ae0c2a9e7b4252ea8945", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NTg3Ng==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4563#discussion_r518645876", "bodyText": "I can conform to the Checkstyle rules if desired but i really think that the cascade of if statements profits in readability if each of them fits onto one line.\n\nReadability was probably the cause of the goto fail bug, too. I would prefer to always use braces, even if it makes the code a bit longer.", "author": "ByteHamster", "createdAt": "2020-11-06T10:03:03Z", "path": "core/src/main/java/de/danoeh/antennapod/core/feed/FeedItemFilter.java", "diffHunk": "@@ -78,6 +80,45 @@ public FeedItemFilter(String[] properties) {\n                     break;\n             }\n         }\n+\n+        mQuery = makeQuery();\n+    }\n+\n+    private String makeQuery() {\n+        // The keys used within this method, but explicitly combined with their table\n+        String keyRead = PodDBAdapter.TABLE_NAME_FEED_ITEMS + \".\" + PodDBAdapter.KEY_READ;\n+        String keyPosition = PodDBAdapter.TABLE_NAME_FEED_MEDIA + \".\" + PodDBAdapter.KEY_POSITION;\n+        String keyDownloaded = PodDBAdapter.TABLE_NAME_FEED_MEDIA + \".\" + PodDBAdapter.KEY_DOWNLOADED;\n+        String keyMediaId = PodDBAdapter.TABLE_NAME_FEED_MEDIA + \".\" + PodDBAdapter.KEY_ID;\n+        String keyItemId = PodDBAdapter.TABLE_NAME_FEED_ITEMS + \".\" + PodDBAdapter.KEY_ID;\n+        String keyFeedItem = PodDBAdapter.KEY_FEEDITEM;\n+        String tableQueue = PodDBAdapter.TABLE_NAME_QUEUE;\n+        String tableFavorites = PodDBAdapter.TABLE_NAME_FAVORITES;\n+\n+        List<String> statements = new ArrayList<>();\n+        if (showPlayed)        statements.add(keyRead + \" = 1 \");", "originalCommit": "85b897c7d778ae70d837ae0c2a9e7b4252ea8945", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cdf59a1c8e99720fd737fcbcc1f5ac1eb5252890", "url": "https://github.com/AntennaPod/AntennaPod/commit/cdf59a1c8e99720fd737fcbcc1f5ac1eb5252890", "message": "Merge branch 'develop' into fix_episodes_list_item_loading_b", "committedDate": "2021-01-22T10:07:40Z", "type": "commit"}, {"oid": "f610ceffc2a257d5e43e5b1d728284fc2800c42c", "url": "https://github.com/AntennaPod/AntennaPod/commit/f610ceffc2a257d5e43e5b1d728284fc2800c42c", "message": "Split up filter model and database handling", "committedDate": "2021-01-22T14:09:43Z", "type": "commit"}]}