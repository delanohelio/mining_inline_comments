{"pr_number": 4077, "pr_title": "Bundle a modern Security Provider (Conscrypt) in the Free builds.", "pr_createdAt": "2020-04-26T14:46:14Z", "pr_url": "https://github.com/AntennaPod/AntennaPod/pull/4077", "timeline": [{"oid": "420d32363e4512b929fb2ee86ec4a0ba4e2f99f2", "url": "https://github.com/AntennaPod/AntennaPod/commit/420d32363e4512b929fb2ee86ec4a0ba4e2f99f2", "message": "Fixed circle static-analysis error\n\nNo code changes, but formatting with comments around else statements\nneeded to be clearer, also some whitespaces should have been avoided...", "committedDate": "2020-04-26T15:02:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5MzI5NA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4077#discussion_r426193294", "bodyText": "Are you sure that this does not break anything? Podcast publishers use pretty horrible setups sometimes (invalid xml, broken certificates, duplicate or changing GUIDs, old tls versions (?)) and users then blame AntennaPod for that. What are the default protocols if we did not call this at all?", "author": "ByteHamster", "createdAt": "2020-05-16T21:36:34Z", "path": "core/src/main/java/de/danoeh/antennapod/core/service/download/AntennapodHttpClient.java", "diffHunk": "@@ -260,7 +286,15 @@ public Socket createSocket(InetAddress var1, int var2, InetAddress var3, int var\n         }\n \n         private void configureSocket(SSLSocket s) {\n-            s.setEnabledProtocols(new String[] { \"TLSv1.2\", \"TLSv1.1\", \"TLSv1\" } );\n+            if (Flavors.FLAVOR == Flavors.FREE) {\n+                // Free flavor (bundles modern conscrypt): TLSv1.3 and modern cipher suites are\n+                // guaranteed. Protocols older than TLSv1.2 are now deprecated and can be disabled.\n+                s.setEnabledProtocols(new String[] { \"TLSv1.3\", \"TLSv1.2\" });", "originalCommit": "420d32363e4512b929fb2ee86ec4a0ba4e2f99f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3Njk4Ng==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4077#discussion_r426876986", "bodyText": "As long as\nsslContext = SSLContext.getInstance(\"TLSv1.3\");\n\ngets run, TLSv1.3 and TLSv1.2 should be supported on all devices without setEnabledProtocols()... I think. My experiments so far indicates this (on the devices I've tested) but I can't guarantee it. What other protocols are enabled seems to vary by platform and doesn't have a specific default(?). I think SSL3 gets enabled by default on older devices unless explicitly disabled (like this).\nApart form just ensuring that TLSv1.3 and TLSv1.2 are enabled (inspired by the original reason for this class: to enable TLSv1.2 on KitKat), my main reason for this was to ensure old protocols are not enabled. This includes SSL3, TLS1 and TLS1.1. For the same reason I removed enabling of the two old cipher suites (TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA and TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA) when Conscrypt is bundled - they are insecure and not needed any more.\nI understand your concern. If there is a chance a podcast out there still doesn't support TLSv1.2, this could be a problem. But I've read Firefox, Chrome/Chromium and Safari have or are dropping support for TLS1.1 (and older) this year. But if that's not enough to force server administrators to support modern protocols, it makes me think that maybe we should re-enable SSLv3? I mean, maybe there's a podcast server out there that doesn't even support TLS at all? (I did not mean this in a sarcastic way: someone could be listening to a really old podcast on an old server that they found without ever visiting it with a browser).\nDo you know some way to try finding podcasts that might not support TLSv1.2? Obviously the ones I'm listening to works, but that's an insignificant subset of all podcasts out there...", "author": "Slinger", "createdAt": "2020-05-18T20:31:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5MzI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNDY0Mg==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4077#discussion_r427404642", "bodyText": "Do you know some way to try finding podcasts that might not support TLSv1.2?\n\nNot really :/ One could ask the gpodder developers: They crawl podcasts anyway. They have not been too active in the last few months and I do not want to cause them additional work, though.\n\nI've read Firefox, Chrome/Chromium and Safari have or are dropping support for TLS1.1 (and older) this year\n\nOkay, let's remove it and see if users complain.", "author": "ByteHamster", "createdAt": "2020-05-19T15:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5MzI5NA=="}], "type": "inlineReview"}, {"oid": "1168155840321bbdab36ed0a1e304eb1e618c3d5", "url": "https://github.com/AntennaPod/AntennaPod/commit/1168155840321bbdab36ed0a1e304eb1e618c3d5", "message": "Fixed circle static-analysis error\n\nNo code changes, but formatting with comments around else statements\nneeded to be clearer, also some whitespaces should have been avoided...", "committedDate": "2020-06-20T09:15:45Z", "type": "forcePushed"}, {"oid": "eb3f362c0c9905b8ca75e2ba7da235e2764862a2", "url": "https://github.com/AntennaPod/AntennaPod/commit/eb3f362c0c9905b8ca75e2ba7da235e2764862a2", "message": "Removed comment about automatically choosing Conscrypt version\n\nThere are drawbacks to using conscryptVersion = \"latest.release\",\nhopefully the version will be kept up to date manually instead.", "committedDate": "2020-07-04T14:21:32Z", "type": "forcePushed"}, {"oid": "9f12c4c41f533e5048136065d71982c0b149783a", "url": "https://github.com/AntennaPod/AntennaPod/commit/9f12c4c41f533e5048136065d71982c0b149783a", "message": "Removed comment about automatically choosing Conscrypt version\n\nThere are drawbacks to using conscryptVersion = \"latest.release\",\nhopefully the version will be kept up to date manually instead.", "committedDate": "2020-07-04T19:53:13Z", "type": "forcePushed"}, {"oid": "f0b685de9ecef46afbfdcf35a879ecfd64e986f5", "url": "https://github.com/AntennaPod/AntennaPod/commit/f0b685de9ecef46afbfdcf35a879ecfd64e986f5", "message": "Removed comment about automatically choosing Conscrypt version\n\nThere are drawbacks to using conscryptVersion = \"latest.release\",\nhopefully the version will be kept up to date manually instead.", "committedDate": "2020-09-20T11:40:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwODgzMA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4077#discussion_r495808830", "bodyText": "Could this be fixed by using freeImplementation \"org.conscrypt:conscrypt-android:$conscryptVersion\" instead of using the free build hack? I am not sure if that hack is even needed anymore but that's out of scope for your PR :) I created #4457 for that.", "author": "ByteHamster", "createdAt": "2020-09-28T09:32:23Z", "path": "core/src/free/java/de/danoeh/antennapod/core/ClientConfig.java", "diffHunk": "@@ -1,6 +1,16 @@\n package de.danoeh.antennapod.core;\n \n import android.content.Context;\n+import java.security.Security;\n+\n+/*\n+ * If you get an error here (\"package org.conscrypt does not exist\"), you are probably doing a free\n+ * build and didn't pass \"-PfreeBuild\" to gradle (e.g. \"./gradlew assembleFreeRelease -PfreeBuild\").\n+ *\n+ * If you are doing a non-free build using \"assembleRelease\" or \"assembleDebug\" and get this error,\n+ * use \"assemblePlayRelease\" or \"assemblePlayDebug\" instead (e.g. \"./gradlew assemblePlayRelease\").", "originalCommit": "f0b685de9ecef46afbfdcf35a879ecfd64e986f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0NDczNQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4077#discussion_r497444735", "bodyText": "Interesting! If you think the \"-PfreeBuild\" hack can be removed in master (if it's reliable enough for the 2.0.0 release) then I'll be happy to change my PR accordingly.\nThat reminds me, if it gets changed the circleci goals and F-Droid build meta should then be updated as well. I remember when I first worked on this PR and naively tried to figure out how to \"use the Java preprocessor\"... it took some time to find the -PfreeBuild  used for the f-droid meta (but not circleci I meant: assembleRelease instead of assemblePlayRelease in circleci). That's why I wrote the comment above, telling others to use it (and adding it to circleci). It'd be great if it can be banished altogether.\nNow Java just needs a preprocessor so all those \"duplicate\" Free/Play files can be joined together. \ud83d\ude04", "author": "Slinger", "createdAt": "2020-09-30T11:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwODgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4NTMyNw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4077#discussion_r497585327", "bodyText": "Yeah, that comment is pretty useful. Though, making it \"just work\" would be even better than a comment :) I think Android Studio automatically selects the free flavour by default, so every new contributor would be suspended by this.\n\nIf you think the \"-PfreeBuild\" hack can be removed in master\n\nMy idea would be to still use -PfreeBuild for the proprietary dependencies and to only use freeImplementation for conscrypt. As far as I understood the reason for originally adding the hack is that Gradle sometimes builds other flavours in addition to the one you actually need. On F-Droid's build machine without the proprietary libraries, this then causes issues. The other way around (loading conscrypt unneccessarily) does not hurt that much. This still needs to be confirmed but I am pretty sure that when using freeImplementation, conscrypt does not end up in the final play build. Even if the Gradle error was still there, it would only affect the build and not the final apk.", "author": "ByteHamster", "createdAt": "2020-09-30T15:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwODgzMA=="}], "type": "inlineReview"}, {"oid": "4c24d1c29a726a67eabf86a9f9866e5daeca4ae8", "url": "https://github.com/AntennaPod/AntennaPod/commit/4c24d1c29a726a67eabf86a9f9866e5daeca4ae8", "message": "Bundle Conscrypt security provider for Free builds\n\nThis fixes protocol and cipher errors on older versions of android\nwithout requiring Google API/Services (which are non-free) to replace\nthe security provider from the OS. No changes are made to Play builds.\n\nThe value of conscryptVersion in build.gradle should be updated\nregularly to keep the bundled version of conscrypt up to date (or\nchanged to \"latest.release\", which will cause issues with verifying\nreproducible builds).\n\nFixes: #2814 (for users of free builds)", "committedDate": "2020-09-30T11:52:31Z", "type": "commit"}, {"oid": "3f0420544a87a974a04b957606a2ace8f9b96e47", "url": "https://github.com/AntennaPod/AntennaPod/commit/3f0420544a87a974a04b957606a2ace8f9b96e47", "message": "Updated circleci debug and release jobs to explicitly build Play flavors\n\nChanged the gradlew build targets assembleRelease to assemblePlayRelease\nand assembleDebug to assemblePlayDebug, because the old targets causes\nfiles for the free builds to get compiled when not needed. It's\nunnecessary and also done without -PfreeBuild which gives build errors.\n\nThese are also the targets used in makeRelease.sh, so the workflow\nshould better match the expected.", "committedDate": "2020-09-30T11:52:31Z", "type": "commit"}, {"oid": "4f86047a24bdfd1cdb730487f828d5b24331d6d4", "url": "https://github.com/AntennaPod/AntennaPod/commit/4f86047a24bdfd1cdb730487f828d5b24331d6d4", "message": "Enable TLSv1.3 and harden protocols and cipher suites for Free builds\n\nThe Free build bundles a modern Conscrypt which means TLSv1.3 is always\nguaranteed no matter android version. So it can always be enabled. Since\nit also provides modern cipher suites, there is no need to enable older\nprotocols than TLSv1.2 (that is: SSLv3, TLSv1.0 and TLSv1.1 which are\nall now deprecated).\n\nAnd the support for modern cipher suites also means there is no need to\nexplicitly enable the following (obsolete+unsafe) ciphers suites:\n * TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA\n * TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA\non Android API < 21 (Android < 5.0).\n\nNo changes are made to the Play builds (since the available security\nprovider can't be guaranteed to support modern protocols and cipher\nsuites).", "committedDate": "2020-09-30T11:52:31Z", "type": "commit"}, {"oid": "3271d7628fd62d3e26c150ae26fc095d24c6fa37", "url": "https://github.com/AntennaPod/AntennaPod/commit/3271d7628fd62d3e26c150ae26fc095d24c6fa37", "message": "Fixed circle static-analysis error\n\nNo code changes, but formatting with comments around else statements\nneeded to be clearer, also some whitespaces should have been avoided...", "committedDate": "2020-09-30T11:52:31Z", "type": "commit"}, {"oid": "30268d73d1a309467b2d183ec276fd4ff672b386", "url": "https://github.com/AntennaPod/AntennaPod/commit/30268d73d1a309467b2d183ec276fd4ff672b386", "message": "Cleaned up string to println in core/build.gradle\n\nVariable can be used and gets replaced directly in the string without\nusing '+' to concatenate strings.", "committedDate": "2020-09-30T11:52:31Z", "type": "commit"}, {"oid": "468acab8f45bc076806fe7f6bfde3585526f19ca", "url": "https://github.com/AntennaPod/AntennaPod/commit/468acab8f45bc076806fe7f6bfde3585526f19ca", "message": "Removed comment about automatically choosing Conscrypt version\n\nThere are drawbacks to using conscryptVersion = \"latest.release\",\nhopefully the version will be kept up to date manually instead.", "committedDate": "2020-09-30T11:52:31Z", "type": "commit"}, {"oid": "468acab8f45bc076806fe7f6bfde3585526f19ca", "url": "https://github.com/AntennaPod/AntennaPod/commit/468acab8f45bc076806fe7f6bfde3585526f19ca", "message": "Removed comment about automatically choosing Conscrypt version\n\nThere are drawbacks to using conscryptVersion = \"latest.release\",\nhopefully the version will be kept up to date manually instead.", "committedDate": "2020-09-30T11:52:31Z", "type": "forcePushed"}, {"oid": "06d212b911af1ce54e03c63bad69b99e938cb430", "url": "https://github.com/AntennaPod/AntennaPod/commit/06d212b911af1ce54e03c63bad69b99e938cb430", "message": "Use freeImplementation for including conscrypt in Free builds.\n\nThis removes the need for the -PfreeBuild flag to gradle, and makes\nassemblePlay and assembleDebug build all flavours without errors again.\nChanged circleci config back accordingly and removed comment about\n-PfreeBuild. Based on #4457.", "committedDate": "2020-10-02T12:39:02Z", "type": "commit"}]}