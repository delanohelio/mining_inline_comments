{"pr_number": 3864, "pr_title": "FL 0-Downtime PoC", "pr_createdAt": "2020-11-18T21:39:38Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3864", "timeline": [{"oid": "07080b85208cb256d5de88683d6d9ce6cab32c58", "url": "https://github.com/telstra/open-kilda/commit/07080b85208cb256d5de88683d6d9ce6cab32c58", "message": "FL 0-Downtime PoC", "committedDate": "2020-11-19T13:47:29Z", "type": "forcePushed"}, {"oid": "720f64f05788c04d3ec971991d1a19d347fe8ed7", "url": "https://github.com/telstra/open-kilda/commit/720f64f05788c04d3ec971991d1a19d347fe8ed7", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-11-27T11:48:15Z", "type": "forcePushed"}, {"oid": "4adf0516542c591c0a1b23f1432d57d4d067f628", "url": "https://github.com/telstra/open-kilda/commit/4adf0516542c591c0a1b23f1432d57d4d067f628", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-11-28T08:11:49Z", "type": "forcePushed"}, {"oid": "22633e108a31687488aaa42b49574354624c205f", "url": "https://github.com/telstra/open-kilda/commit/22633e108a31687488aaa42b49574354624c205f", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-11-28T10:33:53Z", "type": "forcePushed"}, {"oid": "e75f6aa60631a02b69e82f5effa784c85336117b", "url": "https://github.com/telstra/open-kilda/commit/e75f6aa60631a02b69e82f5effa784c85336117b", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-03T06:20:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIyMzgwNQ==", "url": "https://github.com/telstra/open-kilda/pull/3864#discussion_r535223805", "bodyText": "We have race condition here.\nTimeline:\n\nwe initialize watchDog and call subscribe\nwatch dog run new thread, read ZK and call handle()\nzkStateTracker still and handle() fails because of NPE\nWe initialize zkStateTracker in main thread", "author": "niksv", "createdAt": "2020-12-03T13:23:56Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/kafka/ZooKeeperHandler.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.floodlight.kafka;\n+\n+import org.openkilda.bluegreen.LifeCycleObserver;\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.Signal;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+import org.openkilda.bluegreen.ZkWriter;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.KeeperException;\n+\n+import java.io.IOException;\n+import java.util.UUID;\n+\n+@Slf4j\n+public class ZooKeeperHandler implements Runnable, LifeCycleObserver {\n+\n+    public static final String ZK_COMPONENT_NAME = \"floodlight\";\n+\n+    @Getter\n+    private volatile LifecycleEvent event;\n+\n+    private ZkStateTracker zkStateTracker;\n+\n+    private long messageId = 0;\n+    private boolean awaitingShutdown = false;\n+\n+    public ZooKeeperHandler(String id, String serviceName, String connectionString) {\n+        try {\n+            ZkWatchDog watchDog = ZkWatchDog.builder().id(id).serviceName(serviceName)\n+                    .connectionString(connectionString).build();\n+            watchDog.subscribe(this);\n+\n+            ZkWriter zkWriter = ZkWriter.builder().id(id).serviceName(serviceName)\n+                    .connectionString(connectionString).build();\n+            zkStateTracker = new ZkStateTracker(zkWriter);", "originalCommit": "e75f6aa60631a02b69e82f5effa784c85336117b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2OTA4NA==", "url": "https://github.com/telstra/open-kilda/pull/3864#discussion_r536169084", "bodyText": "fixed", "author": "niksv", "createdAt": "2020-12-04T15:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIyMzgwNQ=="}], "type": "inlineReview"}, {"oid": "83cc76acc892f17485067cb8f1a16ce3e1fc1a07", "url": "https://github.com/telstra/open-kilda/commit/83cc76acc892f17485067cb8f1a16ce3e1fc1a07", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-04T15:11:48Z", "type": "forcePushed"}, {"oid": "c89d37acb444d81dbb40d062b226261167d87606", "url": "https://github.com/telstra/open-kilda/commit/c89d37acb444d81dbb40d062b226261167d87606", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-07T09:32:54Z", "type": "forcePushed"}, {"oid": "7ae2758b33d5e071ac755be59198fc7530b1d87b", "url": "https://github.com/telstra/open-kilda/commit/7ae2758b33d5e071ac755be59198fc7530b1d87b", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-08T06:15:54Z", "type": "forcePushed"}, {"oid": "8dc62288668df1259329f393eb20260de89634bf", "url": "https://github.com/telstra/open-kilda/commit/8dc62288668df1259329f393eb20260de89634bf", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-09T08:51:08Z", "type": "forcePushed"}, {"oid": "0c44280785a8125de049abcc0960d51bcfb0e2f3", "url": "https://github.com/telstra/open-kilda/commit/0c44280785a8125de049abcc0960d51bcfb0e2f3", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-09T11:47:44Z", "type": "forcePushed"}, {"oid": "c8548d265eafb2adcc7f4acdbcf9c39ad1bb7619", "url": "https://github.com/telstra/open-kilda/commit/c8548d265eafb2adcc7f4acdbcf9c39ad1bb7619", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-09T12:29:20Z", "type": "forcePushed"}, {"oid": "fc0a9886669550dc1e42a2be9d2b2dab3cfc56c6", "url": "https://github.com/telstra/open-kilda/commit/fc0a9886669550dc1e42a2be9d2b2dab3cfc56c6", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-11T14:29:41Z", "type": "forcePushed"}, {"oid": "faa57cecbca0c8b5198dfdcf7dedc5c6d1ba9af0", "url": "https://github.com/telstra/open-kilda/commit/faa57cecbca0c8b5198dfdcf7dedc5c6d1ba9af0", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-11T14:47:09Z", "type": "forcePushed"}, {"oid": "442619ed5577277a8154bafa1852edb8f0f33afe", "url": "https://github.com/telstra/open-kilda/commit/442619ed5577277a8154bafa1852edb8f0f33afe", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-17T12:34:16Z", "type": "forcePushed"}, {"oid": "2734593053cf59d629ca4db410032fa537d25f12", "url": "https://github.com/telstra/open-kilda/commit/2734593053cf59d629ca4db410032fa537d25f12", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-21T19:24:55Z", "type": "forcePushed"}, {"oid": "1a3d3883c7c6a913cad39b6aebbe5f00aa338e24", "url": "https://github.com/telstra/open-kilda/commit/1a3d3883c7c6a913cad39b6aebbe5f00aa338e24", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-23T06:06:02Z", "type": "forcePushed"}, {"oid": "614cd0b37c625291da5578162cb6233b71b81bb4", "url": "https://github.com/telstra/open-kilda/commit/614cd0b37c625291da5578162cb6233b71b81bb4", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-25T09:56:30Z", "type": "forcePushed"}, {"oid": "909c551f86b99701a9d7d81fd46e3ba9d8e56f3c", "url": "https://github.com/telstra/open-kilda/commit/909c551f86b99701a9d7d81fd46e3ba9d8e56f3c", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-25T13:28:30Z", "type": "forcePushed"}, {"oid": "2e930f02622837c805edc5f2ce0136c17b0e2542", "url": "https://github.com/telstra/open-kilda/commit/2e930f02622837c805edc5f2ce0136c17b0e2542", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-28T09:03:24Z", "type": "forcePushed"}, {"oid": "7d2f01494d592be4d5128f38f339a3ca77557678", "url": "https://github.com/telstra/open-kilda/commit/7d2f01494d592be4d5128f38f339a3ca77557678", "message": "Floodlight zero-downtime upgrade", "committedDate": "2020-12-28T09:36:13Z", "type": "forcePushed"}, {"oid": "9177cec9ec8418f4f239701dbb096fdbbbfb3ad0", "url": "https://github.com/telstra/open-kilda/commit/9177cec9ec8418f4f239701dbb096fdbbbfb3ad0", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-01-11T08:07:14Z", "type": "forcePushed"}, {"oid": "8a665416b29ec13ebb74dadf3daa9ea6017fc6a9", "url": "https://github.com/telstra/open-kilda/commit/8a665416b29ec13ebb74dadf3daa9ea6017fc6a9", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-01-12T09:28:28Z", "type": "forcePushed"}, {"oid": "0e8db4f2f71a84b9979f37372a23b5d4ad8a18f9", "url": "https://github.com/telstra/open-kilda/commit/0e8db4f2f71a84b9979f37372a23b5d4ad8a18f9", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-01-14T11:10:43Z", "type": "forcePushed"}, {"oid": "136786beb16f798c2c96d960750841d135d6b6ef", "url": "https://github.com/telstra/open-kilda/commit/136786beb16f798c2c96d960750841d135d6b6ef", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-01-15T10:07:43Z", "type": "forcePushed"}, {"oid": "cf33c2bf5b8994120d9c213c5a0ba342f076bff1", "url": "https://github.com/telstra/open-kilda/commit/cf33c2bf5b8994120d9c213c5a0ba342f076bff1", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-01-15T10:53:35Z", "type": "forcePushed"}, {"oid": "ffb13993f1a88ad9ea12f599631ce69901accfb1", "url": "https://github.com/telstra/open-kilda/commit/ffb13993f1a88ad9ea12f599631ce69901accfb1", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-01-15T11:33:10Z", "type": "forcePushed"}, {"oid": "6dc80a977992a5514e179ea2a2c7566aeb3ab18a", "url": "https://github.com/telstra/open-kilda/commit/6dc80a977992a5514e179ea2a2c7566aeb3ab18a", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-01-27T08:09:51Z", "type": "forcePushed"}, {"oid": "292b6562a40fbcc7a8066a21c1248f29051a40cb", "url": "https://github.com/telstra/open-kilda/commit/292b6562a40fbcc7a8066a21c1248f29051a40cb", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-01-29T06:01:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwNjkzOA==", "url": "https://github.com/telstra/open-kilda/pull/3864#discussion_r567506938", "bodyText": "I believe it should be final.", "author": "sergii-iakovenko", "createdAt": "2021-02-01T00:06:31Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/kafka/Consumer.java", "diffHunk": "@@ -51,6 +59,12 @@\n     private final KafkaUtilityService kafkaUtilityService;\n     private final ISwitchManager switchManager; // HACK alert.. adding to facilitate safeSwitchTick()\n \n+    private final Set<Future<?>> tasks = new HashSet<>();\n+\n+    private final ZooKeeperService zkService;\n+    private LifecycleEvent deferedShutdownEvent;\n+    private AtomicBoolean active = new AtomicBoolean(false);", "originalCommit": "292b6562a40fbcc7a8066a21c1248f29051a40cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwNzM3Mw==", "url": "https://github.com/telstra/open-kilda/pull/3864#discussion_r567507373", "bodyText": "This one should be final too.", "author": "sergii-iakovenko", "createdAt": "2021-02-01T00:09:13Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/service/kafka/KafkaProducerService.java", "diffHunk": "@@ -41,15 +47,23 @@\n     private Producer<String, String> producer;\n     private final ObjectMapper jsonObjectMapper = new ObjectMapper();\n \n+    private ZooKeeperService zkService;\n+    private AtomicBoolean active = new AtomicBoolean(false);", "originalCommit": "292b6562a40fbcc7a8066a21c1248f29051a40cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwNzk0Ng==", "url": "https://github.com/telstra/open-kilda/pull/3864#discussion_r567507946", "bodyText": "Please, consider a one of existing retry solution which support delays / backing off. E.g. FailSafe", "author": "sergii-iakovenko", "createdAt": "2021-02-01T00:13:51Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/service/zookeeper/ZooKeeperService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.floodlight.service.zookeeper;\n+\n+import org.openkilda.bluegreen.LifeCycleObserver;\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.Signal;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.floodlight.KafkaChannel;\n+import org.openkilda.floodlight.service.IService;\n+import org.openkilda.floodlight.service.kafka.KafkaUtilityService;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+import net.floodlightcontroller.core.module.FloodlightModuleContext;\n+import net.floodlightcontroller.core.module.FloodlightModuleException;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.UUID;\n+\n+@Slf4j\n+public class ZooKeeperService implements IService, LifeCycleObserver {\n+\n+    public static final String ZK_COMPONENT_NAME = \"floodlight\";\n+    public static final int ZK_CONNECTION_ATTEMPTS = 10;\n+\n+\n+    private final Set<ZooKeeperEventObserver> observers = new HashSet<>();\n+\n+    @Getter\n+    private ZkStateTracker zooKeeperStateTracker;\n+    private ZkWriter zkWriter;\n+    private ZkWatchDog watchDog;\n+\n+    private LifecycleEvent event;\n+\n+    private long messageId = 0;\n+\n+    @Override\n+    public void setup(FloodlightModuleContext moduleContext) throws FloodlightModuleException {\n+        KafkaChannel kafkaChannel = moduleContext.getServiceImpl(KafkaUtilityService.class).getKafkaChannel();\n+        String region = kafkaChannel.getRegion();\n+        String connectionString = kafkaChannel.getConfig().getZooKeeperConnectString();\n+        zkWriter = ZkWriter.builder().id(region).serviceName(ZK_COMPONENT_NAME)\n+                .connectionString(connectionString).build();\n+        zooKeeperStateTracker = new ZkStateTracker(zkWriter);\n+\n+        watchDog = ZkWatchDog.builder().id(region).serviceName(ZK_COMPONENT_NAME)\n+                .connectionString(connectionString).build();\n+        watchDog.subscribe(this);\n+    }\n+\n+    /**\n+     * Connects to zookeeper.\n+     */\n+    public void initZookeeper() {\n+        zkWriter.init();\n+        watchDog.init();\n+\n+        for (int i = 1; i <= ZK_CONNECTION_ATTEMPTS", "originalCommit": "292b6562a40fbcc7a8066a21c1248f29051a40cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTIxNjY1OQ==", "url": "https://github.com/telstra/open-kilda/pull/3864#discussion_r569216659", "bodyText": "fixed", "author": "niksv", "createdAt": "2021-02-03T08:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwNzk0Ng=="}], "type": "inlineReview"}, {"oid": "d04c613aa4acefc1c2c94c75c7237675ac6ef264", "url": "https://github.com/telstra/open-kilda/commit/d04c613aa4acefc1c2c94c75c7237675ac6ef264", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-02-03T07:06:12Z", "type": "forcePushed"}, {"oid": "8fe041e7356e8b9819c15d8918d6e83f42d9770b", "url": "https://github.com/telstra/open-kilda/commit/8fe041e7356e8b9819c15d8918d6e83f42d9770b", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-02-03T07:44:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTIwMDgzMQ==", "url": "https://github.com/telstra/open-kilda/pull/3864#discussion_r569200831", "bodyText": "why each attempt is error but final message \"we failed to connect\" is warn?\nMaybe attempts  should be warn and final message is error. Or even both should be error", "author": "niksv", "createdAt": "2021-02-03T08:00:49Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/service/zookeeper/ZooKeeperService.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.floodlight.service.zookeeper;\n+\n+import org.openkilda.bluegreen.LifeCycleObserver;\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.Signal;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.floodlight.KafkaChannel;\n+import org.openkilda.floodlight.service.IService;\n+import org.openkilda.floodlight.service.kafka.KafkaUtilityService;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+import net.floodlightcontroller.core.module.FloodlightModuleContext;\n+import net.floodlightcontroller.core.module.FloodlightModuleException;\n+import net.jodah.failsafe.Failsafe;\n+import net.jodah.failsafe.RetryPolicy;\n+import net.jodah.failsafe.SyncFailsafe;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n+\n+@Slf4j\n+public class ZooKeeperService implements IService, LifeCycleObserver {\n+\n+    public static final String ZK_COMPONENT_NAME = \"floodlight\";\n+    public static final int ZK_CONNECTION_ATTEMPTS = 10;\n+\n+\n+    private final Set<ZooKeeperEventObserver> observers = new HashSet<>();\n+\n+    @Getter\n+    private ZkStateTracker zooKeeperStateTracker;\n+    private ZkWriter zkWriter;\n+    private ZkWatchDog watchDog;\n+\n+    private LifecycleEvent event;\n+\n+    private long messageId = 0;\n+\n+    @Override\n+    public void setup(FloodlightModuleContext moduleContext) throws FloodlightModuleException {\n+        KafkaChannel kafkaChannel = moduleContext.getServiceImpl(KafkaUtilityService.class).getKafkaChannel();\n+        String region = kafkaChannel.getRegion();\n+        String connectionString = kafkaChannel.getConfig().getZooKeeperConnectString();\n+        zkWriter = ZkWriter.builder().id(region).serviceName(ZK_COMPONENT_NAME)\n+                .connectionString(connectionString).build();\n+        zooKeeperStateTracker = new ZkStateTracker(zkWriter);\n+\n+        watchDog = ZkWatchDog.builder().id(region).serviceName(ZK_COMPONENT_NAME)\n+                .connectionString(connectionString).build();\n+        watchDog.subscribe(this);\n+    }\n+\n+    /**\n+     * Connects to zookeeper.\n+     */\n+    public void initZookeeper() {\n+        zkWriter.init();\n+        watchDog.init();\n+\n+        RetryPolicy retryPolicy = new RetryPolicy()\n+                .retryOn(IllegalStateException.class)\n+                .withDelay(100, TimeUnit.MILLISECONDS)\n+                .withMaxRetries(ZK_CONNECTION_ATTEMPTS);\n+\n+        SyncFailsafe failsafe = Failsafe.with(retryPolicy)\n+                .onRetry(e -> log.error(\"Failed to init zk clients, retrying...\", e))\n+                .onRetriesExceeded(e -> log.warn(\"Failure in zookeeper initialization. No more retries\", e));", "originalCommit": "8fe041e7356e8b9819c15d8918d6e83f42d9770b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTIwMjQ2OA==", "url": "https://github.com/telstra/open-kilda/pull/3864#discussion_r569202468", "bodyText": "we want to add force read after connection. Are we sure that 10 attempts is enough? I don't know how may retries we need. But in Interceptors we have infinite retries", "author": "niksv", "createdAt": "2021-02-03T08:03:59Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/service/zookeeper/ZooKeeperService.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.floodlight.service.zookeeper;\n+\n+import org.openkilda.bluegreen.LifeCycleObserver;\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.Signal;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.floodlight.KafkaChannel;\n+import org.openkilda.floodlight.service.IService;\n+import org.openkilda.floodlight.service.kafka.KafkaUtilityService;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+import net.floodlightcontroller.core.module.FloodlightModuleContext;\n+import net.floodlightcontroller.core.module.FloodlightModuleException;\n+import net.jodah.failsafe.Failsafe;\n+import net.jodah.failsafe.RetryPolicy;\n+import net.jodah.failsafe.SyncFailsafe;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n+\n+@Slf4j\n+public class ZooKeeperService implements IService, LifeCycleObserver {\n+\n+    public static final String ZK_COMPONENT_NAME = \"floodlight\";\n+    public static final int ZK_CONNECTION_ATTEMPTS = 10;\n+\n+\n+    private final Set<ZooKeeperEventObserver> observers = new HashSet<>();\n+\n+    @Getter\n+    private ZkStateTracker zooKeeperStateTracker;\n+    private ZkWriter zkWriter;\n+    private ZkWatchDog watchDog;\n+\n+    private LifecycleEvent event;\n+\n+    private long messageId = 0;\n+\n+    @Override\n+    public void setup(FloodlightModuleContext moduleContext) throws FloodlightModuleException {\n+        KafkaChannel kafkaChannel = moduleContext.getServiceImpl(KafkaUtilityService.class).getKafkaChannel();\n+        String region = kafkaChannel.getRegion();\n+        String connectionString = kafkaChannel.getConfig().getZooKeeperConnectString();\n+        zkWriter = ZkWriter.builder().id(region).serviceName(ZK_COMPONENT_NAME)\n+                .connectionString(connectionString).build();\n+        zooKeeperStateTracker = new ZkStateTracker(zkWriter);\n+\n+        watchDog = ZkWatchDog.builder().id(region).serviceName(ZK_COMPONENT_NAME)\n+                .connectionString(connectionString).build();\n+        watchDog.subscribe(this);\n+    }\n+\n+    /**\n+     * Connects to zookeeper.\n+     */\n+    public void initZookeeper() {\n+        zkWriter.init();\n+        watchDog.init();\n+\n+        RetryPolicy retryPolicy = new RetryPolicy()\n+                .retryOn(IllegalStateException.class)\n+                .withDelay(100, TimeUnit.MILLISECONDS)\n+                .withMaxRetries(ZK_CONNECTION_ATTEMPTS);", "originalCommit": "8fe041e7356e8b9819c15d8918d6e83f42d9770b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ca117107eb4936971f1424d4a3269246a67a5ab5", "url": "https://github.com/telstra/open-kilda/commit/ca117107eb4936971f1424d4a3269246a67a5ab5", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-02-03T08:13:34Z", "type": "forcePushed"}, {"oid": "2ca6762be231019bd47f48b0ccd52c571c9a69df", "url": "https://github.com/telstra/open-kilda/commit/2ca6762be231019bd47f48b0ccd52c571c9a69df", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-02-03T08:25:16Z", "type": "forcePushed"}, {"oid": "58f8529953c95b7688c07f8d988b79f309178e42", "url": "https://github.com/telstra/open-kilda/commit/58f8529953c95b7688c07f8d988b79f309178e42", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-02-03T08:29:05Z", "type": "commit"}, {"oid": "58f8529953c95b7688c07f8d988b79f309178e42", "url": "https://github.com/telstra/open-kilda/commit/58f8529953c95b7688c07f8d988b79f309178e42", "message": "Floodlight zero-downtime upgrade", "committedDate": "2021-02-03T08:29:05Z", "type": "forcePushed"}]}