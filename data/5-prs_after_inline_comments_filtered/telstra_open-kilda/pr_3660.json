{"pr_number": 3660, "pr_title": "Fix link deleting in the Network topology", "pr_createdAt": "2020-07-25T13:41:49Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3660", "timeline": [{"oid": "aad060dddf7b0de8e5e0c9f614d1c7d119e5275a", "url": "https://github.com/telstra/open-kilda/commit/aad060dddf7b0de8e5e0c9f614d1c7d119e5275a", "message": "Fixed link deleting in Network topology.", "committedDate": "2020-07-27T06:57:13Z", "type": "forcePushed"}, {"oid": "e3e37ad4756cba3ea5013841b8a24c9cc05e32e9", "url": "https://github.com/telstra/open-kilda/commit/e3e37ad4756cba3ea5013841b8a24c9cc05e32e9", "message": "Fixed link deleting in Network topology.", "committedDate": "2020-07-27T09:10:43Z", "type": "forcePushed"}, {"oid": "29b47743cfff451d4c04c020f94b1477c81f1a68", "url": "https://github.com/telstra/open-kilda/commit/29b47743cfff451d4c04c020f94b1477c81f1a68", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-28T08:20:25Z", "type": "forcePushed"}, {"oid": "e1ef7c720141de10397f4dbd38cea0f69475b002", "url": "https://github.com/telstra/open-kilda/commit/e1ef7c720141de10397f4dbd38cea0f69475b002", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-28T08:24:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5NTk0Ng==", "url": "https://github.com/telstra/open-kilda/pull/3660#discussion_r462095946", "bodyText": "Em... you reuse setup command to remove data. As for me such code reuse... makes more harm than good. At least you will have an extreme mess in logs - there is no person who will treat the message \"Uni-ISL service receive SETUP request for {}\" as \"remove\" of uni-isl data.\nOne more even bigger issue here - you \"clean\" uniIsl without any checks... IslFsm can reject or postpone removal, but you remove any way to communicate to it in advance, so all ISL clean logic becomes corrupted. You must clean data in cascade and only when the current step is done you can go to the next step.\nSo - only IslFsm/service can call further cleanup when it has done with its own cleanup. The easiest way here is to make the switch to the exhausted discovery mode from the Isl side as part of the removal process.", "author": "surabujin", "createdAt": "2020-07-29T07:30:58Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/speaker/SpeakerRouter.java", "diffHunk": "@@ -157,7 +163,12 @@ private void proxySpeaker(Tuple input, InfoData payload) throws PipelineExceptio\n             emit(STREAM_PORT_ID, input, makePortTuple(\n                     new UpdatePortPropertiesCommand((UpdatePortPropertiesRequest) payload)));\n         } else if (payload instanceof DeactivateIslInfoData) {\n-            emit(STREAM_ISL_ID, input, makeIslTuple(input, new IslDeleteCommand((DeactivateIslInfoData) payload)));\n+            DeactivateIslInfoData data = (DeactivateIslInfoData) payload;\n+            emit(STREAM_ISL_ID, input, makeIslTuple(input, new IslDeleteCommand(data)));\n+            emit(STREAM_UNI_ISL_ID, input,\n+                    makeUniIslTuple(input, new UniIslSetupCommand(new Endpoint(data.getSource()))));", "originalCommit": "e1ef7c720141de10397f4dbd38cea0f69475b002", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyNzI5Ng==", "url": "https://github.com/telstra/open-kilda/pull/3660#discussion_r462827296", "bodyText": "You're right. I've added the switch to exhausted mode to ISL FSM.", "author": "dpoltavets", "createdAt": "2020-07-30T08:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5NTk0Ng=="}], "type": "inlineReview"}, {"oid": "7f126ba46100ec84760d1ae7a551ff546cad1b86", "url": "https://github.com/telstra/open-kilda/commit/7f126ba46100ec84760d1ae7a551ff546cad1b86", "message": "Fix link deleting in the Network topology", "committedDate": "2020-07-30T08:09:06Z", "type": "forcePushed"}, {"oid": "d9c79f4217661afbab068a45730609b63ca8c539", "url": "https://github.com/telstra/open-kilda/commit/d9c79f4217661afbab068a45730609b63ca8c539", "message": "Fix link deleting in the Network topology", "committedDate": "2020-07-30T08:10:32Z", "type": "forcePushed"}, {"oid": "7e26cc9e7f071e291b0ec8c065b61ccbaf56c92e", "url": "https://github.com/telstra/open-kilda/commit/7e26cc9e7f071e291b0ec8c065b61ccbaf56c92e", "message": "Fix link deleting in the Network topology", "committedDate": "2020-07-30T09:35:20Z", "type": "forcePushed"}, {"oid": "96c46219c89b2aadcd62d3faa4240acdda5d789a", "url": "https://github.com/telstra/open-kilda/commit/96c46219c89b2aadcd62d3faa4240acdda5d789a", "message": "Fix link deleting in the Network topology", "committedDate": "2020-07-30T12:24:08Z", "type": "forcePushed"}, {"oid": "71f95896e3b8afb35d57490cdf06a2cab3e0a330", "url": "https://github.com/telstra/open-kilda/commit/71f95896e3b8afb35d57490cdf06a2cab3e0a330", "message": "Fix link deleting in the Network topology", "committedDate": "2020-07-30T12:51:55Z", "type": "commit"}, {"oid": "71f95896e3b8afb35d57490cdf06a2cab3e0a330", "url": "https://github.com/telstra/open-kilda/commit/71f95896e3b8afb35d57490cdf06a2cab3e0a330", "message": "Fix link deleting in the Network topology", "committedDate": "2020-07-30T12:51:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY4MjQ0Mw==", "url": "https://github.com/telstra/open-kilda/pull/3660#discussion_r463682443", "bodyText": "Why auxiliary mode controlled via bfdManger but exaustem mode controlled directly by Islsm?", "author": "surabujin", "createdAt": "2020-07-31T15:35:27Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/IslFsm.java", "diffHunk": "@@ -342,6 +343,11 @@ private void sendInstallMultiTable(IIslCarrier carrier, Endpoint ingress, Endpoi\n         }\n     }\n \n+    private void sendEnableExhaustedPollMode(IIslCarrier carrier) {\n+        carrier.exhaustedPollModeUpdateRequest(reference.getSource(), true);", "originalCommit": "71f95896e3b8afb35d57490cdf06a2cab3e0a330", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}