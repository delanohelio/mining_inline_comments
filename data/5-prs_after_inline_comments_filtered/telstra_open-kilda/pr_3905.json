{"pr_number": 3905, "pr_title": "Stats topology zero-downtime upgrade", "pr_createdAt": "2020-12-04T11:07:51Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3905", "timeline": [{"oid": "b3f71af725745851ac3d45bb3e723b4c04e7fe62", "url": "https://github.com/telstra/open-kilda/commit/b3f71af725745851ac3d45bb3e723b4c04e7fe62", "message": "Stats topology zero-downtime upgrade", "committedDate": "2020-12-17T07:52:19Z", "type": "forcePushed"}, {"oid": "e788be7a617f7d5f653bf5c11b0ade425be8d0cc", "url": "https://github.com/telstra/open-kilda/commit/e788be7a617f7d5f653bf5c11b0ade425be8d0cc", "message": "Stats topology zero-downtime upgrade", "committedDate": "2020-12-18T05:23:10Z", "type": "forcePushed"}, {"oid": "68d2c520ca5642e710347bb69fa8b2140823c63a", "url": "https://github.com/telstra/open-kilda/commit/68d2c520ca5642e710347bb69fa8b2140823c63a", "message": "Stats topology zero-downtime upgrade", "committedDate": "2020-12-23T12:53:25Z", "type": "forcePushed"}, {"oid": "e22506d9e1087c58094d732d3bbbabda130c4457", "url": "https://github.com/telstra/open-kilda/commit/e22506d9e1087c58094d732d3bbbabda130c4457", "message": "Stats topology zero-downtime upgrade", "committedDate": "2020-12-28T11:05:01Z", "type": "forcePushed"}, {"oid": "6f9c845753aca5f0bfb05822344820cdf6e8d30d", "url": "https://github.com/telstra/open-kilda/commit/6f9c845753aca5f0bfb05822344820cdf6e8d30d", "message": "Stats topology zero-downtime upgrade", "committedDate": "2020-12-30T11:23:38Z", "type": "forcePushed"}, {"oid": "e8afdbed29eef288f1ae81d21ef8f569c717648c", "url": "https://github.com/telstra/open-kilda/commit/e8afdbed29eef288f1ae81d21ef8f569c717648c", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-01-14T10:35:24Z", "type": "forcePushed"}, {"oid": "4f2e9c463ddd59701ca66aa7b285cdef421707d0", "url": "https://github.com/telstra/open-kilda/commit/4f2e9c463ddd59701ca66aa7b285cdef421707d0", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-01-14T11:56:28Z", "type": "forcePushed"}, {"oid": "86ba819d4489c924acdf5feb7e9166d28c1e7465", "url": "https://github.com/telstra/open-kilda/commit/86ba819d4489c924acdf5feb7e9166d28c1e7465", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-01-20T13:11:10Z", "type": "forcePushed"}, {"oid": "5cd87cf678e62bdcba0f44e68393409854e384f0", "url": "https://github.com/telstra/open-kilda/commit/5cd87cf678e62bdcba0f44e68393409854e384f0", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-01-25T20:38:22Z", "type": "forcePushed"}, {"oid": "96404499cb38fe74ec413b8674ff1c891547d048", "url": "https://github.com/telstra/open-kilda/commit/96404499cb38fe74ec413b8674ff1c891547d048", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-01-27T08:21:17Z", "type": "forcePushed"}, {"oid": "a0cfd321270798f842576a146f8ed5513c926fd1", "url": "https://github.com/telstra/open-kilda/commit/a0cfd321270798f842576a146f8ed5513c926fd1", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-01-29T06:09:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwOTIyMg==", "url": "https://github.com/telstra/open-kilda/pull/3905#discussion_r567509222", "bodyText": "Does it make sense to introduce a dedicated \"build\" method instead of repeating \"getZkTopoName(), getConfig().getBlueGreenMode()\" each time?", "author": "sergii-iakovenko", "createdAt": "2021-02-01T00:22:52Z", "path": "src-java/stats-topology/stats-storm-topology/src/main/java/org/openkilda/wfm/topology/stats/StatsTopology.java", "diffHunk": "@@ -139,23 +146,30 @@ public StormTopology createTopology() {\n         declareBolt(builder,\n                 new TickBolt(topologyConfig.getStatisticsRequestInterval()), TICK_BOLT.name());\n \n-        declareBolt(builder, new StatsRequesterBolt(persistenceManager), STATS_REQUESTER_BOLT.name())\n-                .shuffleGrouping(TICK_BOLT.name());\n+        declareBolt(builder, new StatsRequesterBolt(persistenceManager, ZooKeeperSpout.SPOUT_ID),\n+                STATS_REQUESTER_BOLT.name())\n+                .shuffleGrouping(TICK_BOLT.name())\n+                .allGrouping(ZooKeeperSpout.SPOUT_ID);\n \n-        declareBolt(builder, buildKafkaBolt(topologyConfig.getSpeakerTopic()), STATS_KILDA_SPEAKER_BOLT.name())\n+        declareBolt(builder, buildKafkaBolt(topologyConfig.getSpeakerTopic(), getZkTopoName(),\n+                getConfig().getBlueGreenMode()), STATS_KILDA_SPEAKER_BOLT.name())", "originalCommit": "a0cfd321270798f842576a146f8ed5513c926fd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwOTQxMw==", "url": "https://github.com/telstra/open-kilda/pull/3905#discussion_r567509413", "bodyText": "Why not write \"if (!active) { return; }\"? This will improve readability.", "author": "sergii-iakovenko", "createdAt": "2021-02-01T00:24:26Z", "path": "src-java/stats-topology/stats-storm-topology/src/main/java/org/openkilda/wfm/topology/stats/bolts/SpeakerBolt.java", "diffHunk": "@@ -52,41 +56,48 @@\n     private static final String TABLE_STATS_STREAM = StatsStreamType.TABLE_STATS.toString();\n     private static final String PACKET_IN_OUT_STATS_STREAM = StatsStreamType.PACKET_IN_OUT_STATS.toString();\n \n+    public SpeakerBolt(String lifeCycleEventSourceComponent) {\n+        super(lifeCycleEventSourceComponent);\n+    }\n+\n     @Override\n     protected void handleInput(Tuple tuple) throws Exception {\n         logger.debug(\"Ingoing tuple: {}\", tuple);\n \n-        Message message = pullValue(tuple, MessageKafkaTranslator.FIELD_ID_PAYLOAD, Message.class);\n-        if (!(message instanceof InfoMessage)) {\n-            return;\n-        }\n-        InfoMessage infoMessage = (InfoMessage) message;\n-        final InfoData data = infoMessage.getData();\n-        if (data instanceof PortStatsData) {\n-            logger.debug(\"Port stats message: {}\", infoMessage);\n-            emitWithContext(PORT_STATS_STREAM, tuple, new Values(infoMessage));\n-        } else if (data instanceof MeterConfigStatsData) {\n-            logger.debug(\"Meter config stats message: {}\", infoMessage);\n-            emitWithContext(METER_CFG_STATS_STREAM, tuple, new Values(infoMessage));\n-        } else if (data instanceof MeterStatsData) {\n-            logger.debug(\"Meter stats message: {}\", infoMessage);\n-            emitWithContext(CACHE_STREAM, tuple, new Values(data));\n-        } else if (data instanceof FlowStatsData) {\n-            logger.debug(\"Flow stats message: {}\", infoMessage);\n-            ImmutablePair<FlowStatsData, FlowStatsData> splitData =\n-                    splitSystemRuleStatsAndFlowStats((FlowStatsData) data);\n-\n-            emitWithContext(SYSTEM_RULES_STATS_STREAM, tuple, new Values(splitData.getKey()));\n-            emitWithContext(CACHE_STREAM, tuple, new Values(splitData.getValue()));\n-        } else if (data instanceof SwitchTableStatsData) {\n-            logger.debug(\"Table stats message: {}\", infoMessage);\n-            emitWithContext(TABLE_STATS_STREAM, tuple, new Values(data));\n-        } else if (data instanceof GetPacketInOutStatsResponse) {\n-            logger.debug(\"Packet in out stats message: {}\", infoMessage);\n-            emitWithContext(PACKET_IN_OUT_STATS_STREAM, tuple, new Values(data));\n-        } else {\n-            //FIXME (ncherevko): we might receive few unexpected messages here, need to fix it and uncomment below line\n-            //unhandledInput(tuple);\n+        if (active) {", "originalCommit": "a0cfd321270798f842576a146f8ed5513c926fd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwOTczOA==", "url": "https://github.com/telstra/open-kilda/pull/3905#discussion_r567509738", "bodyText": "Can such logic of building ZK node names be shared and reusable?", "author": "sergii-iakovenko", "createdAt": "2021-02-01T00:26:51Z", "path": "src-java/stats-topology/stats-storm-topology/src/test/java/org/openkilda/wfm/topology/stats/StatsTopologyTest.java", "diffHunk": "@@ -163,6 +172,16 @@ public static void setupOnce() throws Exception {\n         sleep(TOPOLOGY_START_TIMEOUT);\n     }\n \n+    private static void setStartSignal() throws IOException, KeeperException, InterruptedException {\n+        ZooKeeper zooKeeper = new ZooKeeper(\"localhost\", 3000, event -> { });\n+\n+        setNode(zooKeeper, \"/kilda\", \"\");", "originalCommit": "a0cfd321270798f842576a146f8ed5513c926fd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "20001b1cda98d115d58681e71d121a2e8a6749ea", "url": "https://github.com/telstra/open-kilda/commit/20001b1cda98d115d58681e71d121a2e8a6749ea", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-02-03T13:04:11Z", "type": "forcePushed"}, {"oid": "88c7db4624018bf2583ac287cdbb022b256d82f0", "url": "https://github.com/telstra/open-kilda/commit/88c7db4624018bf2583ac287cdbb022b256d82f0", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-02-05T09:16:00Z", "type": "commit"}, {"oid": "88c7db4624018bf2583ac287cdbb022b256d82f0", "url": "https://github.com/telstra/open-kilda/commit/88c7db4624018bf2583ac287cdbb022b256d82f0", "message": "Stats topology zero-downtime upgrade", "committedDate": "2021-02-05T09:16:00Z", "type": "forcePushed"}]}