{"pr_number": 3579, "pr_title": "Add `status_info` field to Flow", "pr_createdAt": "2020-06-30T14:41:56Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3579", "timeline": [{"oid": "75d4f0e037123451bd1cdd7cc266f00b99e72c8f", "url": "https://github.com/telstra/open-kilda/commit/75d4f0e037123451bd1cdd7cc266f00b99e72c8f", "message": "Added `status_info` field to Flow", "committedDate": "2020-07-01T09:05:00Z", "type": "forcePushed"}, {"oid": "81cd0596cc0e9899eeddba8f5253832cdcad65fa", "url": "https://github.com/telstra/open-kilda/commit/81cd0596cc0e9899eeddba8f5253832cdcad65fa", "message": "Added `status_info` field to Flow", "committedDate": "2020-07-01T12:11:45Z", "type": "forcePushed"}, {"oid": "8f12ea2308fe6816d50438b9dacc1b91a4d3c84a", "url": "https://github.com/telstra/open-kilda/commit/8f12ea2308fe6816d50438b9dacc1b91a4d3c84a", "message": "Added `status_info` field to Flow", "committedDate": "2020-07-02T08:59:58Z", "type": "forcePushed"}, {"oid": "2ddb0a4a2e69763b43a2dd25f22c02ae75e17e73", "url": "https://github.com/telstra/open-kilda/commit/2ddb0a4a2e69763b43a2dd25f22c02ae75e17e73", "message": "Added `status_info` field to Flow", "committedDate": "2020-07-02T11:07:04Z", "type": "forcePushed"}, {"oid": "138dfdc593c286bd669e86546d4b6515789cad44", "url": "https://github.com/telstra/open-kilda/commit/138dfdc593c286bd669e86546d4b6515789cad44", "message": "Added `status_info` field to Flow", "committedDate": "2020-07-02T11:26:33Z", "type": "commit"}, {"oid": "138dfdc593c286bd669e86546d4b6515789cad44", "url": "https://github.com/telstra/open-kilda/commit/138dfdc593c286bd669e86546d4b6515789cad44", "message": "Added `status_info` field to Flow", "committedDate": "2020-07-02T11:26:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5NjUyMw==", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449396523", "bodyText": "Is the statusInfo supposed to bring light on \"what goes wrong?\"? There is 0 info about what goes wrong.", "author": "surabujin", "createdAt": "2020-07-03T06:21:35Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/create/action/HandleNotCreatedFlowAction.java", "diffHunk": "@@ -43,7 +45,7 @@ public HandleNotCreatedFlowAction(PersistenceManager persistenceManager,\n     public void perform(State from, State to, Event event, FlowCreateContext context, FlowCreateFsm stateMachine) {\n         String flowId = stateMachine.getFlowId();\n         dashboardLogger.onFlowStatusUpdate(flowId, FlowStatus.DOWN);\n-        flowRepository.updateStatus(flowId, FlowStatus.DOWN);\n+        flowRepository.updateStatus(flowId, FlowStatus.DOWN, format(\"Failed to create flow %s\", flowId));", "originalCommit": "138dfdc593c286bd669e86546d4b6515789cad44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQyMDI0Mg==", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449420242", "bodyText": "To see what went wrong, we have history. When setting the task, I realized that this field is needed for filtering.", "author": "dpoltavets", "createdAt": "2020-07-03T07:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5NjUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5OTExNA==", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449399114", "bodyText": "Can't understand. I have doubts about this approach.", "author": "surabujin", "createdAt": "2020-07-03T06:29:39Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/reroute/actions/RevertFlowStatusAction.java", "diffHunk": "@@ -36,13 +36,20 @@ public RevertFlowStatusAction(PersistenceManager persistenceManager) {\n     @Override\n     protected void perform(State from, State to, Event event, FlowRerouteContext context, FlowRerouteFsm stateMachine) {\n         String flowId = stateMachine.getFlowId();\n-        FlowStatus originalStatus = stateMachine.getOriginalFlowStatus();\n-        if (originalStatus != null) {\n-            log.debug(\"Reverting the flow status of {} to {}\", flowId, originalStatus);\n+        FlowStatus originalFlowStatus = stateMachine.getOriginalFlowStatus();\n+        FlowStatus newFlowStatus = stateMachine.getNewFlowStatus();\n+        if (originalFlowStatus != null) {\n+            log.debug(\"Reverting the flow status of {} to {}\", flowId, originalFlowStatus);\n \n-            flowRepository.updateStatus(flowId, originalStatus);\n+            String flowStatusInfo = FlowStatus.DEGRADED.equals(originalFlowStatus)", "originalCommit": "138dfdc593c286bd669e86546d4b6515789cad44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMDc3MA==", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449400770", "bodyText": "Why do we need to update statusInfo in cases when there where no actual status update? Why we calculate statusInfo separately from status itself? I.e. the code wich set some status to the flow, know why it has decided to set exactly this status... so it should set statusInfo field too.", "author": "surabujin", "createdAt": "2020-07-03T06:34:33Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/reroute/actions/UpdateFlowStatusAction.java", "diffHunk": "@@ -49,12 +50,25 @@ protected void perform(State from, State to, Event event, FlowRerouteContext con\n             FlowStatus flowStatus = flow.computeFlowStatus();\n             if (flowStatus != flow.getStatus()) {\n                 dashboardLogger.onFlowStatusUpdate(flowId, flowStatus);\n-                flowRepository.updateStatus(flowId, flowStatus);\n+                flowRepository.updateStatus(flowId, flowStatus, getFlowStatusInfo(flowStatus, stateMachine));\n+            } else if (FlowStatus.DEGRADED.equals(flowStatus)) {", "originalCommit": "138dfdc593c286bd669e86546d4b6515789cad44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxNjM5Mg==", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449416392", "bodyText": "In the current implementation, the state DEGRADED can only be if the protected path was not found. This status (DEGRADED) can be set earlier. And because of this, we will not update statusInfo.", "author": "dpoltavets", "createdAt": "2020-07-03T07:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMDc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNDc4Mg==", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449404782", "bodyText": "How it is possible? If the flow is the \"target\" for rerouting, how it can be in UP state?", "author": "surabujin", "createdAt": "2020-07-03T06:45:21Z", "path": "src-java/reroute-topology/reroute-storm-topology/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "diffHunk": "@@ -102,7 +102,12 @@ public void rerouteAffectedFlows(MessageSender sender, String correlationId, Rer\n             Flow flow = entry.getFlow();\n             Boolean sendRerouteRequest = transactionManager.doInTransaction(() -> {\n                 boolean flowPathFound = updateFlowPathsStateForFlow(switchId, port, entry.getAffectedPaths());\n-                flowRepository.updateStatusSafe(flow.getFlowId(), flow.computeFlowStatus());\n+                FlowStatus flowStatus = flow.computeFlowStatus();\n+                String flowStatusInfo = null;\n+                if (!FlowStatus.UP.equals(flowStatus)) {", "originalCommit": "138dfdc593c286bd669e86546d4b6515789cad44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxODgwNA==", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449418804", "bodyText": "Before that, we update the paths statuses and compute the flow status.", "author": "dpoltavets", "createdAt": "2020-07-03T07:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNDc4Mg=="}], "type": "inlineReview"}]}