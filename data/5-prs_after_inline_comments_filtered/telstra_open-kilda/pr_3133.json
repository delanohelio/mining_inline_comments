{"pr_number": 3133, "pr_title": "Reroute affected flows on switch up event", "pr_createdAt": "2020-01-21T16:07:58Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3133", "timeline": [{"oid": "c2578665b6e50a561aed114c12a3a0887f56036e", "url": "https://github.com/telstra/open-kilda/commit/c2578665b6e50a561aed114c12a3a0887f56036e", "message": "Reroute affected flows on switch up event", "committedDate": "2020-01-21T16:59:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4MzQ3Nw==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369383477", "bodyText": "There is RerouteAffectedFlows class in the same package, why not to extend it instead?", "author": "timofei-durakov", "createdAt": "2020-01-22T06:06:16Z", "path": "services/src/messaging/src/main/java/org/openkilda/messaging/command/reroute/RerouteAffectedFlowsRequest.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/* Copyright 2018 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.messaging.command.reroute;\n+\n+import org.openkilda.messaging.command.CommandData;\n+import org.openkilda.model.SwitchId;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.PropertyNamingStrategy.SnakeCaseStrategy;\n+import com.fasterxml.jackson.databind.annotation.JsonNaming;\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NonNull;\n+\n+@Data\n+@EqualsAndHashCode(callSuper = false)\n+@JsonNaming(SnakeCaseStrategy.class)\n+@JsonInclude(JsonInclude.Include.NON_NULL)\n+public class RerouteAffectedFlowsRequest extends CommandData {", "originalCommit": "c2578665b6e50a561aed114c12a3a0887f56036e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxMTcxMQ==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369511711", "bodyText": "Renamed class. This two requests should trigger different logic so I guess better to keep them separately.", "author": "rozdy", "createdAt": "2020-01-22T11:41:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4MzQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4NTE0NQ==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369385145", "bodyText": "I would prefer to extend repository with required method and not fetching all flows here.\nP.S. it's fine to filter out flows by segments since we do not interested in single switch flows here(kilda do not attempt to re-route them).", "author": "timofei-durakov", "createdAt": "2020-01-22T06:14:31Z", "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "diffHunk": "@@ -271,6 +296,24 @@ private boolean filterForwardPrimaryPath(FlowPath path) {\n                 );\n     }\n \n+    /**\n+     * Returns map with affected inactive flow and flow pathId set for rerouting.\n+     */\n+    public Map<Flow, Set<PathId>> getAffectedInactiveFlowsForRerouting(SwitchId switchId) {\n+        log.info(\"Get affected inactive flows for switch {}\", switchId);\n+        return flowRepository.findDownFlows().stream()\n+                .filter(f -> f.getPaths().stream()", "originalCommit": "c2578665b6e50a561aed114c12a3a0887f56036e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4NTY5Ng==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369385696", "bodyText": "Also there are no unit-tests", "author": "timofei-durakov", "createdAt": "2020-01-22T06:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4NTE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxMjAwNg==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369512006", "bodyText": "Reworked and added tests.", "author": "rozdy", "createdAt": "2020-01-22T11:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4NTE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4NTI2Mg==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369385262", "bodyText": "2020:-P", "author": "timofei-durakov", "createdAt": "2020-01-22T06:15:07Z", "path": "services/src/messaging/src/main/java/org/openkilda/messaging/command/reroute/RerouteAffectedFlowsRequest.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/* Copyright 2018 Telstra Open Source", "originalCommit": "c2578665b6e50a561aed114c12a3a0887f56036e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxMjA5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369512091", "bodyText": "Fixed :)", "author": "rozdy", "createdAt": "2020-01-22T11:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4NTI2Mg=="}], "type": "inlineReview"}, {"oid": "3af5d5f9fbb7fa595bf5c2d26e3e293533104507", "url": "https://github.com/telstra/open-kilda/commit/3af5d5f9fbb7fa595bf5c2d26e3e293533104507", "message": "Reroute affected flows on switch up event", "committedDate": "2020-01-22T11:37:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTU2OQ==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369525569", "bodyText": "Maybe it should be RerouteAffectedInactiveFlows?", "author": "niksv", "createdAt": "2020-01-22T12:14:05Z", "path": "services/src/messaging/src/main/java/org/openkilda/messaging/command/reroute/RerouteInactiveAffectedFlows.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.messaging.command.reroute;\n+\n+import org.openkilda.messaging.command.CommandData;\n+import org.openkilda.model.SwitchId;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.PropertyNamingStrategy.SnakeCaseStrategy;\n+import com.fasterxml.jackson.databind.annotation.JsonNaming;\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NonNull;\n+\n+@Data\n+@EqualsAndHashCode(callSuper = false)\n+@JsonNaming(SnakeCaseStrategy.class)\n+@JsonInclude(JsonInclude.Include.NON_NULL)\n+public class RerouteInactiveAffectedFlows extends CommandData {", "originalCommit": "3af5d5f9fbb7fa595bf5c2d26e3e293533104507", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5ODQ1NQ==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369598455", "bodyText": "Fixed", "author": "rozdy", "createdAt": "2020-01-22T14:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzMzk4Mg==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369533982", "bodyText": "it can be better. You can optimize it by getting only Flow Paths of Down and Degraded flows by Neo4j.\nTo do it you need to add new method into flowPathRepository. Something like\n\n    @Override\n    public Collection<FlowPath> findInactiveBySegmentSwitch(SwitchId switchId) {\n        Map<String, Object> parameters = ImmutableMap.of(\n                \"switch_id\", switchIdConverter.toGraphProperty(switchId));\n\n        Set<String> pathIds = new HashSet<>();\n        queryForStrings(\"MATCH (ps_src:switch)-[:source]-(ps:path_segment)-[:destination]-(ps_dst:switch)\" +\n                \"WHERE ps_src.name = $switch_id OR ps_dst.name = $switch_id\" +\n                \"MATCH (f:flow)-[:owns]-(fp:flow_path)-[:owns]-(ps)\" +\n                \"WHERE f.status = 'down' or f.status = 'degraded'\" +\n                \"RETURN fp.path_id as path_id\", parameters, \"path_id\").forEach(pathIds::add);\n\n        if (pathIds.isEmpty()) {\n            return emptyList();\n        }\n\n        Filter pathIdsFilter = new Filter(PATH_ID_PROPERTY_NAME, new InOperatorWithNoConverterComparison(pathIds));\n\n        return loadAll(pathIdsFilter);\n    }", "author": "niksv", "createdAt": "2020-01-22T12:34:55Z", "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "diffHunk": "@@ -263,14 +289,25 @@ private boolean filterForwardPrimaryPath(FlowPath path) {\n     public Map<Flow, Set<PathId>> getInactiveFlowsForRerouting() {\n         log.info(\"Get inactive flows\");\n         return flowRepository.findDownFlows().stream()\n-                .collect(Collectors.toMap(Function.identity(),\n+                .collect(toMap(Function.identity(),\n                         flow -> flow.getPaths().stream()\n                         .filter(path -> FlowPathStatus.INACTIVE.equals(path.getStatus()))\n                         .map(FlowPath::getPathId)\n                         .collect(Collectors.toSet()))\n                 );\n     }\n \n+    /**\n+     * Returns affected inactive flow set for rerouting.\n+     */\n+    public Set<Flow> getAffectedInactiveFlowsForRerouting(SwitchId switchId) {\n+        log.info(\"Get affected inactive flows for switch {}\", switchId);\n+        return flowPathRepository.findBySegmentSwitch(switchId).stream()\n+                .map(FlowPath::getFlow)\n+                .filter(f -> f.getStatus() == FlowStatus.DOWN || f.getStatus() == FlowStatus.DEGRADED)", "originalCommit": "3af5d5f9fbb7fa595bf5c2d26e3e293533104507", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5ODUxMw==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369598513", "bodyText": "Reworked", "author": "rozdy", "createdAt": "2020-01-22T14:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzMzk4Mg=="}], "type": "inlineReview"}, {"oid": "5ae508868775560383778af519e082ed505f12a5", "url": "https://github.com/telstra/open-kilda/commit/5ae508868775560383778af519e082ed505f12a5", "message": "Reroute affected flows on switch up event", "committedDate": "2020-01-22T14:40:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkzMjY1Ng==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r369932656", "bodyText": "This method is not used anywhere.", "author": "dpoltavets", "createdAt": "2020-01-23T05:06:32Z", "path": "services/src/kilda-core/kilda-persistence-neo4j/src/main/java/org/openkilda/persistence/repositories/impl/Neo4jFlowPathRepository.java", "diffHunk": "@@ -206,6 +206,27 @@ public Neo4jFlowPathRepository(Neo4jSessionFactory sessionFactory, TransactionMa\n         return loadAll(pathIdsFilter);\n     }\n \n+    @Override\n+    public Collection<FlowPath> findInactiveBySegmentSwitch(SwitchId switchId) {", "originalCommit": "5ae508868775560383778af519e082ed505f12a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA4MTA1Ng==", "url": "https://github.com/telstra/open-kilda/pull/3133#discussion_r370081056", "bodyText": "Fixed", "author": "rozdy", "createdAt": "2020-01-23T12:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkzMjY1Ng=="}], "type": "inlineReview"}, {"oid": "3e70d04b632f8437c51e7e4a3395af368f623736", "url": "https://github.com/telstra/open-kilda/commit/3e70d04b632f8437c51e7e4a3395af368f623736", "message": "Reroute affected flows on switch up event", "committedDate": "2020-01-23T11:06:32Z", "type": "forcePushed"}, {"oid": "885b620915c72364c247f0dd53fb98a42157f45a", "url": "https://github.com/telstra/open-kilda/commit/885b620915c72364c247f0dd53fb98a42157f45a", "message": "Reroute affected flows on switch up event", "committedDate": "2020-01-24T13:28:24Z", "type": "forcePushed"}, {"oid": "71594fe588098dbd78b53c27246e2c86261dee4f", "url": "https://github.com/telstra/open-kilda/commit/71594fe588098dbd78b53c27246e2c86261dee4f", "message": "Reroute affected flows on switch up event", "committedDate": "2020-01-24T13:34:20Z", "type": "forcePushed"}, {"oid": "4097ce3a1dd6c132013ddd8e7462e18de8f44183", "url": "https://github.com/telstra/open-kilda/commit/4097ce3a1dd6c132013ddd8e7462e18de8f44183", "message": "Reroute affected flows on switch up event", "committedDate": "2020-01-24T15:40:20Z", "type": "forcePushed"}, {"oid": "908567380b0ac3d41a31c4f78b90d6f962fe3df2", "url": "https://github.com/telstra/open-kilda/commit/908567380b0ac3d41a31c4f78b90d6f962fe3df2", "message": "add test: Flow is rerouted after switchUp event (#3137)", "committedDate": "2020-01-27T14:17:29Z", "type": "forcePushed"}, {"oid": "cf79003686b24c456a955032b63faa6164d07dd3", "url": "https://github.com/telstra/open-kilda/commit/cf79003686b24c456a955032b63faa6164d07dd3", "message": "add test: Flow is rerouted after switchUp event (#3137)", "committedDate": "2020-01-28T14:56:39Z", "type": "forcePushed"}, {"oid": "f4698f82e37ba84b64ee028e4e0244d4eefee030", "url": "https://github.com/telstra/open-kilda/commit/f4698f82e37ba84b64ee028e4e0244d4eefee030", "message": "Reroute affected flows on switch up event", "committedDate": "2020-01-29T10:28:25Z", "type": "commit"}, {"oid": "5661587e697d72c5c6f5ce32f8c1063574c4791a", "url": "https://github.com/telstra/open-kilda/commit/5661587e697d72c5c6f5ce32f8c1063574c4791a", "message": "add test: Flow is rerouted after switchUp event (#3137)", "committedDate": "2020-01-29T10:28:31Z", "type": "commit"}, {"oid": "5661587e697d72c5c6f5ce32f8c1063574c4791a", "url": "https://github.com/telstra/open-kilda/commit/5661587e697d72c5c6f5ce32f8c1063574c4791a", "message": "add test: Flow is rerouted after switchUp event (#3137)", "committedDate": "2020-01-29T10:28:31Z", "type": "forcePushed"}, {"oid": "4e7ce58685f7f52477fcc2687985c4538db5bf36", "url": "https://github.com/telstra/open-kilda/commit/4e7ce58685f7f52477fcc2687985c4538db5bf36", "message": "improve tests for flow rerouting after switchUp event (#3150)", "committedDate": "2020-01-29T12:34:11Z", "type": "commit"}]}