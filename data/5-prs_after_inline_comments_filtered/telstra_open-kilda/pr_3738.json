{"pr_number": 3738, "pr_title": "Simplify BFD session management", "pr_createdAt": "2020-09-24T13:06:30Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3738", "timeline": [{"oid": "1b970da486b775c284af03d58dba5e37709bbc96", "url": "https://github.com/telstra/open-kilda/commit/1b970da486b775c284af03d58dba5e37709bbc96", "message": "Simplify BFD session management\n\nGet rid of \"conflict\" concept into BFD LCM - existing tools that trach\nerror responses on BFD session requests are cappable to correctly hanlde\nconflicts between existing and planned BFD sessions.\n\nCreate toolset to trach logical port status inside `BfdPortFsm`. It\nsimplify tools responsible for correct handling of incorrecly ordered of\nBfdSessionCreate/Remove resonse and port UP/DOWN responses. There is no\nway to order these FL events(response) on FL side so BfdPortFsm must be\nready to handle them in any order.\n\nIngore \"session is missing\" error(treat it as success) on BFD session\nremove request. So BFD session can be fixed by manual removing it from\nswitch and reenabling it into NB API. Without this fix it will fail\nbecause of error response(session is missing) on a \"remove current\nsession\" request.  # \u041f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u0432\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435 \u043a\u043e\u043c\u043c\u0438\u0442\u0430 \u0434\u043b\u044f \u0432\u0430\u0448\u0438\u0445\n\u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0439. \u0421\u0442\u0440\u043e\u043a\u0438,", "committedDate": "2020-09-24T17:15:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1NzU5Ng==", "url": "https://github.com/telstra/open-kilda/pull/3738#discussion_r495857596", "bodyText": "typo?", "author": "nikitamarchenko", "createdAt": "2020-09-28T11:03:21Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/bfd/BfdAction.java", "diffHunk": "@@ -29,53 +28,48 @@\n abstract class BfdAction {\n     protected Logger log = LoggerFactory.getLogger(getClass());\n \n-    protected LinkStatus linkStatus;\n+    protected final String speakerRequestKey;\n \n-    protected String speakerRequestKey = null;\n-    protected BfdSessionResponse speakerResponse = null;\n     protected boolean haveSpeakerResponse = false;\n+    private ActionResult result;\n \n-    BfdAction(LinkStatus linkStatus) {\n-        this.linkStatus = linkStatus;\n-    }\n-\n-    public Optional<ActionResult> updateLinkStatus(LinkStatus status) {\n-        linkStatus = status;\n-        return evaluateResult();\n+    BfdAction(String requestKey) {\n+        this.speakerRequestKey = requestKey;\n     }\n \n     public final Optional<ActionResult> consumeSpeakerResponse(String requestKey, BfdSessionResponse response) {\n-        if (speakerRequestKey != null && speakerRequestKey.equals(requestKey)) {\n+        if (! haveSpeakerResponse && speakerRequestKey.equals(requestKey)) {\n             haveSpeakerResponse = true;\n-            speakerRequestKey = null;\n-\n-            speakerResponse = response;\n+            result = makeResult(response);\n         }\n \n-        return evaluateResult();\n+        return Optional.ofNullable(result);\n     }\n \n     public abstract String getLogIdentifier();\n \n-    protected abstract Optional<ActionResult> evaluateResult();\n+    protected abstract ActionResult makeResult(BfdSessionResponse response);\n \n     @Value\n     static class ActionResult {\n-        private boolean success;\n+        boolean success;\n \n         /**\n          * Error core (null in case of timeout).", "originalCommit": "1b970da486b775c284af03d58dba5e37709bbc96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3NzUwNg==", "url": "https://github.com/telstra/open-kilda/pull/3738#discussion_r495877506", "bodyText": "yep (fixed)", "author": "surabujin", "createdAt": "2020-09-28T11:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1NzU5Ng=="}], "type": "inlineReview"}, {"oid": "5446fb3c04032e58c3735208fc4fa040cc8ccec8", "url": "https://github.com/telstra/open-kilda/commit/5446fb3c04032e58c3735208fc4fa040cc8ccec8", "message": "Simplify BFD session management\n\nGet rid of the \"conflict\" concept into BFD LCM - existing tools tracking\nerror responses on BFD session requests are capable of correctly handle\nconflicts between existing and planned BFD sessions.\n\nNew toolset to track logical port status inside BfdPortFsm where added.\nIt simplifies tools responsible for the correct handling of incorrectly\nordered BFD session's create/remove responses and port UP/DOWN\nresponses. There is no way to order these FL events(response) on FL side\nso BfdPortFsm must be ready to handle them in any order.\n\nTo be able to fix failed BFD session manually (remove BFD session from\nswitch via switch CLI console) error handling behavior where changed.\nThe \"session is missing\" error not treated as an error for the session's\nremove responses. Removing existing(from BfdPortFsm point of view) BFD\nsession is a mandatory cleanup step. Without this fix, BfdPortFsm can't\ncomplete this cleanup step in cases when BFD session does not exist on\nthe switch.", "committedDate": "2020-09-28T11:44:59Z", "type": "commit"}, {"oid": "5446fb3c04032e58c3735208fc4fa040cc8ccec8", "url": "https://github.com/telstra/open-kilda/commit/5446fb3c04032e58c3735208fc4fa040cc8ccec8", "message": "Simplify BFD session management\n\nGet rid of the \"conflict\" concept into BFD LCM - existing tools tracking\nerror responses on BFD session requests are capable of correctly handle\nconflicts between existing and planned BFD sessions.\n\nNew toolset to track logical port status inside BfdPortFsm where added.\nIt simplifies tools responsible for the correct handling of incorrectly\nordered BFD session's create/remove responses and port UP/DOWN\nresponses. There is no way to order these FL events(response) on FL side\nso BfdPortFsm must be ready to handle them in any order.\n\nTo be able to fix failed BFD session manually (remove BFD session from\nswitch via switch CLI console) error handling behavior where changed.\nThe \"session is missing\" error not treated as an error for the session's\nremove responses. Removing existing(from BfdPortFsm point of view) BFD\nsession is a mandatory cleanup step. Without this fix, BfdPortFsm can't\ncomplete this cleanup step in cases when BFD session does not exist on\nthe switch.", "committedDate": "2020-09-28T11:44:59Z", "type": "forcePushed"}]}