{"pr_number": 3878, "pr_title": "Fix flow loops for single switch flows", "pr_createdAt": "2020-11-27T11:34:10Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3878", "timeline": [{"oid": "f620c2d72cd23825b57ea25ff46962d1a1662fc7", "url": "https://github.com/telstra/open-kilda/commit/f620c2d72cd23825b57ea25ff46962d1a1662fc7", "message": "Fix flow loops for single switch flows", "committedDate": "2020-12-01T08:29:32Z", "type": "forcePushed"}, {"oid": "3d913a1950b348e8895cb115e3474cd14e77db67", "url": "https://github.com/telstra/open-kilda/commit/3d913a1950b348e8895cb115e3474cd14e77db67", "message": "Fix flow loops for single switch flows", "committedDate": "2020-12-01T08:45:53Z", "type": "forcePushed"}, {"oid": "50188b0da85883ef7a622a4b33a0ce9f67226573", "url": "https://github.com/telstra/open-kilda/commit/50188b0da85883ef7a622a4b33a0ce9f67226573", "message": "Fix flow loops for single switch flows", "committedDate": "2020-12-01T11:45:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4Nzg5Mw==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r535387893", "bodyText": "why null? why not empty list?", "author": "niksv", "createdAt": "2020-12-03T16:31:32Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/command/flow/ingress/of/IngressFlowLoopInstallMultiTableFlowModFactory.java", "diffHunk": "@@ -15,18 +15,41 @@\n \n package org.openkilda.floodlight.command.flow.ingress.of;\n \n-import org.openkilda.floodlight.command.flow.ingress.IngressFlowSegmentCommand;\n+import org.openkilda.floodlight.command.flow.ingress.IngressFlowSegmentBase;\n import org.openkilda.floodlight.switchmanager.SwitchManager;\n import org.openkilda.floodlight.utils.OfFlowModAddMultiTableMessageBuilderFactory;\n import org.openkilda.model.SwitchFeature;\n \n import net.floodlightcontroller.core.IOFSwitch;\n+import org.projectfloodlight.openflow.protocol.action.OFAction;\n+import org.projectfloodlight.openflow.protocol.instruction.OFInstruction;\n \n+import java.util.List;\n import java.util.Set;\n \n-public class IngressFlowLoopInstallMultiTableFlowModFactory extends IngressFlowSegmentInstallFlowModFactory {\n+public class IngressFlowLoopInstallMultiTableFlowModFactory extends IngressInstallFlowModFactory {\n     public IngressFlowLoopInstallMultiTableFlowModFactory(\n-            IngressFlowSegmentCommand command, IOFSwitch sw, Set<SwitchFeature> features) {\n+            IngressFlowSegmentBase command, IOFSwitch sw, Set<SwitchFeature> features) {\n         super(new OfFlowModAddMultiTableMessageBuilderFactory(SwitchManager.FLOW_LOOP_PRIORITY), command, sw, features);\n     }\n+\n+    @Override\n+    protected List<OFAction> makeServer42IngressFlowTransformActions(List<Integer> vlanStack) {\n+        return null;", "originalCommit": "50188b0da85883ef7a622a4b33a0ce9f67226573", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4ODAwMA==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r535388000", "bodyText": "same", "author": "niksv", "createdAt": "2020-12-03T16:31:40Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/command/flow/ingress/of/IngressFlowLoopInstallMultiTableFlowModFactory.java", "diffHunk": "@@ -15,18 +15,41 @@\n \n package org.openkilda.floodlight.command.flow.ingress.of;\n \n-import org.openkilda.floodlight.command.flow.ingress.IngressFlowSegmentCommand;\n+import org.openkilda.floodlight.command.flow.ingress.IngressFlowSegmentBase;\n import org.openkilda.floodlight.switchmanager.SwitchManager;\n import org.openkilda.floodlight.utils.OfFlowModAddMultiTableMessageBuilderFactory;\n import org.openkilda.model.SwitchFeature;\n \n import net.floodlightcontroller.core.IOFSwitch;\n+import org.projectfloodlight.openflow.protocol.action.OFAction;\n+import org.projectfloodlight.openflow.protocol.instruction.OFInstruction;\n \n+import java.util.List;\n import java.util.Set;\n \n-public class IngressFlowLoopInstallMultiTableFlowModFactory extends IngressFlowSegmentInstallFlowModFactory {\n+public class IngressFlowLoopInstallMultiTableFlowModFactory extends IngressInstallFlowModFactory {\n     public IngressFlowLoopInstallMultiTableFlowModFactory(\n-            IngressFlowSegmentCommand command, IOFSwitch sw, Set<SwitchFeature> features) {\n+            IngressFlowSegmentBase command, IOFSwitch sw, Set<SwitchFeature> features) {\n         super(new OfFlowModAddMultiTableMessageBuilderFactory(SwitchManager.FLOW_LOOP_PRIORITY), command, sw, features);\n     }\n+\n+    @Override\n+    protected List<OFAction> makeServer42IngressFlowTransformActions(List<Integer> vlanStack) {\n+        return null;\n+    }\n+\n+    @Override\n+    protected List<OFAction> makeTransformActions(List<Integer> vlanStack) {\n+        return null;", "originalCommit": "50188b0da85883ef7a622a4b33a0ce9f67226573", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4ODA4Mw==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r535388083", "bodyText": "why null? why not empty list?", "author": "niksv", "createdAt": "2020-12-03T16:31:46Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/command/flow/ingress/of/IngressFlowLoopInstallMultiTableFlowModFactory.java", "diffHunk": "@@ -15,18 +15,41 @@\n \n package org.openkilda.floodlight.command.flow.ingress.of;\n \n-import org.openkilda.floodlight.command.flow.ingress.IngressFlowSegmentCommand;\n+import org.openkilda.floodlight.command.flow.ingress.IngressFlowSegmentBase;\n import org.openkilda.floodlight.switchmanager.SwitchManager;\n import org.openkilda.floodlight.utils.OfFlowModAddMultiTableMessageBuilderFactory;\n import org.openkilda.model.SwitchFeature;\n \n import net.floodlightcontroller.core.IOFSwitch;\n+import org.projectfloodlight.openflow.protocol.action.OFAction;\n+import org.projectfloodlight.openflow.protocol.instruction.OFInstruction;\n \n+import java.util.List;\n import java.util.Set;\n \n-public class IngressFlowLoopInstallMultiTableFlowModFactory extends IngressFlowSegmentInstallFlowModFactory {\n+public class IngressFlowLoopInstallMultiTableFlowModFactory extends IngressInstallFlowModFactory {\n     public IngressFlowLoopInstallMultiTableFlowModFactory(\n-            IngressFlowSegmentCommand command, IOFSwitch sw, Set<SwitchFeature> features) {\n+            IngressFlowSegmentBase command, IOFSwitch sw, Set<SwitchFeature> features) {\n         super(new OfFlowModAddMultiTableMessageBuilderFactory(SwitchManager.FLOW_LOOP_PRIORITY), command, sw, features);\n     }\n+\n+    @Override\n+    protected List<OFAction> makeServer42IngressFlowTransformActions(List<Integer> vlanStack) {\n+        return null;\n+    }\n+\n+    @Override\n+    protected List<OFAction> makeTransformActions(List<Integer> vlanStack) {\n+        return null;\n+    }\n+\n+    @Override\n+    protected List<OFInstruction> makeMetadataInstructions() {\n+        return null;", "originalCommit": "50188b0da85883ef7a622a4b33a0ce9f67226573", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4OTAxMQ==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r535389011", "bodyText": "As I see this method used as\napplyActions.add(makeOutputAction());\nWill we add null to the list?", "author": "niksv", "createdAt": "2020-12-03T16:32:59Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/command/flow/ingress/of/IngressFlowLoopInstallMultiTableFlowModFactory.java", "diffHunk": "@@ -15,18 +15,41 @@\n \n package org.openkilda.floodlight.command.flow.ingress.of;\n \n-import org.openkilda.floodlight.command.flow.ingress.IngressFlowSegmentCommand;\n+import org.openkilda.floodlight.command.flow.ingress.IngressFlowSegmentBase;\n import org.openkilda.floodlight.switchmanager.SwitchManager;\n import org.openkilda.floodlight.utils.OfFlowModAddMultiTableMessageBuilderFactory;\n import org.openkilda.model.SwitchFeature;\n \n import net.floodlightcontroller.core.IOFSwitch;\n+import org.projectfloodlight.openflow.protocol.action.OFAction;\n+import org.projectfloodlight.openflow.protocol.instruction.OFInstruction;\n \n+import java.util.List;\n import java.util.Set;\n \n-public class IngressFlowLoopInstallMultiTableFlowModFactory extends IngressFlowSegmentInstallFlowModFactory {\n+public class IngressFlowLoopInstallMultiTableFlowModFactory extends IngressInstallFlowModFactory {\n     public IngressFlowLoopInstallMultiTableFlowModFactory(\n-            IngressFlowSegmentCommand command, IOFSwitch sw, Set<SwitchFeature> features) {\n+            IngressFlowSegmentBase command, IOFSwitch sw, Set<SwitchFeature> features) {\n         super(new OfFlowModAddMultiTableMessageBuilderFactory(SwitchManager.FLOW_LOOP_PRIORITY), command, sw, features);\n     }\n+\n+    @Override\n+    protected List<OFAction> makeServer42IngressFlowTransformActions(List<Integer> vlanStack) {\n+        return null;\n+    }\n+\n+    @Override\n+    protected List<OFAction> makeTransformActions(List<Integer> vlanStack) {\n+        return null;\n+    }\n+\n+    @Override\n+    protected List<OFInstruction> makeMetadataInstructions() {\n+        return null;\n+    }\n+\n+    @Override\n+    protected OFAction makeOutputAction() {\n+        return null;", "originalCommit": "50188b0da85883ef7a622a4b33a0ce9f67226573", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwODMxMg==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r535408312", "bodyText": "All these methods are used only to generate regular flow rules. This factory is designed to create loop rules and should not be used for regular flow rules. So it's doesn't matter null or empty lists are used here. Maybe throw UnsupportedOperationException is the better way.", "author": "rozdy", "createdAt": "2020-12-03T16:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4OTAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxMTg2NA==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r535411864", "bodyText": "I do not want to block PR, but I wondering about NPEs. I agree with UnsupportedOperationException idea", "author": "niksv", "createdAt": "2020-12-03T16:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4OTAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQyNTc4NQ==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r535425785", "bodyText": "Fixed.", "author": "rozdy", "createdAt": "2020-12-03T17:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4OTAxMQ=="}], "type": "inlineReview"}, {"oid": "31f1e57efd93a5e1ffc6c3f15cd54393ae9ba0ca", "url": "https://github.com/telstra/open-kilda/commit/31f1e57efd93a5e1ffc6c3f15cd54393ae9ba0ca", "message": "Fix flow loops for single switch flows", "committedDate": "2020-12-03T17:11:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTI2Ng==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r535871266", "bodyText": "should these 4 methods throw unsupported exceptions too?", "author": "niksv", "createdAt": "2020-12-04T06:41:56Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/command/flow/ingress/of/IngressFlowLoopFlowModFactory.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/* Copyright 2019 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.floodlight.command.flow.ingress.of;\n+\n+import org.openkilda.floodlight.command.flow.ingress.IngressFlowLoopCommand;\n+import org.openkilda.floodlight.utils.OfFlowModBuilderFactory;\n+import org.openkilda.model.SwitchFeature;\n+\n+import net.floodlightcontroller.core.IOFSwitch;\n+import org.projectfloodlight.openflow.protocol.action.OFAction;\n+import org.projectfloodlight.openflow.protocol.instruction.OFInstruction;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+abstract class IngressFlowLoopFlowModFactory extends IngressInstallFlowModFactory {\n+    private final IngressFlowLoopCommand command;\n+\n+    public IngressFlowLoopFlowModFactory(\n+            OfFlowModBuilderFactory flowModBuilderFactory, IngressFlowLoopCommand command, IOFSwitch sw,\n+            Set<SwitchFeature> features) {\n+        super(flowModBuilderFactory, command, sw, features);\n+        this.command = command;\n+    }\n+\n+    @Override\n+    protected List<OFAction> makeTransformActions(List<Integer> vlanStack) {\n+        return Collections.emptyList();\n+    }\n+\n+    @Override\n+    protected List<OFAction> makeServer42IngressFlowTransformActions(List<Integer> vlanStack) {\n+        return Collections.emptyList();\n+    }\n+\n+    @Override\n+    protected OFAction makeOutputAction() {\n+        return null;\n+    }\n+\n+    @Override\n+    protected List<OFInstruction> makeMetadataInstructions() {\n+        return Collections.emptyList();", "originalCommit": "31f1e57efd93a5e1ffc6c3f15cd54393ae9ba0ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NzI4OA==", "url": "https://github.com/telstra/open-kilda/pull/3878#discussion_r536057288", "bodyText": "Fixed.", "author": "rozdy", "createdAt": "2020-12-04T12:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3MTI2Ng=="}], "type": "inlineReview"}, {"oid": "9e00d4fb18ca6512c2fa7c9f8169ba58b6e19096", "url": "https://github.com/telstra/open-kilda/commit/9e00d4fb18ca6512c2fa7c9f8169ba58b6e19096", "message": "Fix flow loops for single switch flows", "committedDate": "2020-12-04T12:14:23Z", "type": "commit"}, {"oid": "9e00d4fb18ca6512c2fa7c9f8169ba58b6e19096", "url": "https://github.com/telstra/open-kilda/commit/9e00d4fb18ca6512c2fa7c9f8169ba58b6e19096", "message": "Fix flow loops for single switch flows", "committedDate": "2020-12-04T12:14:23Z", "type": "forcePushed"}]}