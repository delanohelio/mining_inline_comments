{"pr_number": 3873, "pr_title": "Fix flow loops for Q-in-Q", "pr_createdAt": "2020-11-24T14:13:51Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3873", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQwMTIxMg==", "url": "https://github.com/telstra/open-kilda/pull/3873#discussion_r532401212", "bodyText": "This is the method for single VLAN flow, how it can have inner VLAN defined?\nPS Please use FlowEndpoint.isVlanIdSet() method to check definement of vlan id.", "author": "surabujin", "createdAt": "2020-11-30T07:53:20Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/command/flow/ingress/of/IngressFlowModFactory.java", "diffHunk": "@@ -344,15 +344,17 @@ public OFFlowMod makeSingleVlanFlowLoopMessage() {\n         RoutingMetadata metadata = RoutingMetadata.builder()\n                 .outerVlanId(endpoint.getOuterVlanId())\n                 .build(switchFeatures);\n+        Match.Builder matchBuilder = of.buildMatch()\n+                .setExact(MatchField.IN_PORT, OFPort.of(endpoint.getPortNumber()))\n+                .setMasked(MatchField.METADATA,\n+                OFMetadata.of(metadata.getValue()), OFMetadata.of(metadata.getMask()));\n+        if (endpoint.getInnerVlanId() != 0) {", "originalCommit": "080c3265319c20e29b3c6e63593ae18af36f90cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzOTY4Ng==", "url": "https://github.com/telstra/open-kilda/pull/3873#discussion_r532439686", "bodyText": "Fixed.", "author": "rozdy", "createdAt": "2020-11-30T09:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQwMTIxMg=="}], "type": "inlineReview"}, {"oid": "b8347eeddf804114a9678a35b0f4b7c62cf2c53f", "url": "https://github.com/telstra/open-kilda/commit/b8347eeddf804114a9678a35b0f4b7c62cf2c53f", "message": "Fix flow loops for Q-in-Q", "committedDate": "2020-11-30T09:04:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxNTQzMQ==", "url": "https://github.com/telstra/open-kilda/pull/3873#discussion_r532815431", "bodyText": "you will get conflict here with patch about single switch loops", "author": "nikitamarchenko", "createdAt": "2020-11-30T18:38:21Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/validation/FlowValidator.java", "diffHunk": "@@ -110,11 +110,7 @@ public void validate(Flow flow, RequestedFlow requestedFlow, Set<String> bulkUpd\n \n     private void validateFlowLoop(Flow flow, RequestedFlow requestedFlow) throws InvalidFlowException {\n         if (requestedFlow.getLoopSwitchId() != null) {\n-            //todo: fix loops for q-in-q and singe switch loops\n-            if (requestedFlow.getSrcInnerVlan() != 0 || requestedFlow.getDestInnerVlan() != 0) {\n-                throw new InvalidFlowException(\"Loop for Q-in-Q flows is not implemented\",\n-                        ErrorType.NOT_IMPLEMENTED);\n-            }\n+            //todo: fix loops singe switch loops", "originalCommit": "b8347eeddf804114a9678a35b0f4b7c62cf2c53f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE1NDIyOQ==", "url": "https://github.com/telstra/open-kilda/pull/3873#discussion_r533154229", "bodyText": "Rebased patch for single-switch flows on this one", "author": "rozdy", "createdAt": "2020-12-01T08:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxNTQzMQ=="}], "type": "inlineReview"}, {"oid": "cbf16c7ad478a6ed0c3d3a0fe1cdf198e8bc1c3f", "url": "https://github.com/telstra/open-kilda/commit/cbf16c7ad478a6ed0c3d3a0fe1cdf198e8bc1c3f", "message": "Fix flow loops for Q-in-Q", "committedDate": "2020-12-01T08:27:47Z", "type": "commit"}, {"oid": "cbf16c7ad478a6ed0c3d3a0fe1cdf198e8bc1c3f", "url": "https://github.com/telstra/open-kilda/commit/cbf16c7ad478a6ed0c3d3a0fe1cdf198e8bc1c3f", "message": "Fix flow loops for Q-in-Q", "committedDate": "2020-12-01T08:27:47Z", "type": "forcePushed"}, {"oid": "dbbdc1cd373901ec207dd887b1e1b3140761f61c", "url": "https://github.com/telstra/open-kilda/commit/dbbdc1cd373901ec207dd887b1e1b3140761f61c", "message": "add flowLoop endpoint into func test (#3789)\n\n* add flowLoop endpoint into func test\r\n\r\n* add tests for flowLoop\r\n\r\n* adjust flowLoopSpec to work on the stage env\r\n\r\n* unignore qinq and multiTable in flowLoopSpec", "committedDate": "2020-12-01T08:42:46Z", "type": "commit"}]}