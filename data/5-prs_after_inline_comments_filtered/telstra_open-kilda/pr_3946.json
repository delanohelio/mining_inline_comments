{"pr_number": 3946, "pr_title": "Move flow endpoints multitable flag to flow path level", "pr_createdAt": "2020-12-22T14:56:39Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3946", "timeline": [{"oid": "92ec9cb570306580dc53a17292bc791d49b1613a", "url": "https://github.com/telstra/open-kilda/commit/92ec9cb570306580dc53a17292bc791d49b1613a", "message": "Move flow endpoints multitable flag to flow path level", "committedDate": "2020-12-23T20:38:43Z", "type": "forcePushed"}, {"oid": "9c1d3d907eaf5331c2bbcb174a9a0f9c748a9614", "url": "https://github.com/telstra/open-kilda/commit/9c1d3d907eaf5331c2bbcb174a9a0f9c748a9614", "message": "Move flow endpoints multitable flag to flow path level", "committedDate": "2020-12-28T17:55:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NDgzMA==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r549644830", "bodyText": "According to code that fills switchProperties - it is possible to have no switch properties object by some existing switchId... and as result, you will throw NPE here.", "author": "surabujin", "createdAt": "2020-12-29T10:04:15Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/service/FlowPathBuilder.java", "diffHunk": "@@ -153,6 +151,8 @@ public FlowPath buildFlowPath(Flow flow, PathResources pathResources, Path path,\n                 .bandwidth(flow.getBandwidth())\n                 .ignoreBandwidth(flow.isIgnoreBandwidth() || forceToIgnoreBandwidth)\n                 .latency(path.getLatency())\n+                .srcWithMultiTable(switchProperties.get(srcSwitch.getSwitchId()).isMultiTable())", "originalCommit": "9c1d3d907eaf5331c2bbcb174a9a0f9c748a9614", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTU2NQ==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r550271565", "bodyText": "Fixed.", "author": "rozdy", "createdAt": "2020-12-30T17:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NDgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NjQ4Nw==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r549646487", "bodyText": "copy & paste is evil - you can move this chunk in parent class.", "author": "surabujin", "createdAt": "2020-12-29T10:08:50Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/update/actions/RemoveOldRulesAction.java", "diffHunk": "@@ -57,27 +57,35 @@ protected void perform(State from, State to, Event event, FlowUpdateContext cont\n \n         Collection<FlowSegmentRequestFactory> factories = new ArrayList<>();\n \n-        Flow flow = RequestedFlowMapper.INSTANCE.toFlow(stateMachine.getOriginalFlow());", "originalCommit": "9c1d3d907eaf5331c2bbcb174a9a0f9c748a9614", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTYwMA==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r550271600", "bodyText": "Reworked.", "author": "rozdy", "createdAt": "2020-12-30T17:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NjQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NzM5NQ==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r549647395", "bodyText": "I would like to keep this getter (with replaced body), you have all required objects to extract it.", "author": "surabujin", "createdAt": "2020-12-29T10:11:47Z", "path": "src-java/kilda-model/src/main/java/org/openkilda/adapter/FlowDestAdapter.java", "diffHunk": "@@ -36,11 +41,6 @@ public FlowEndpoint getEndpoint() {\n                 trackConnectedDevices.isDstArp() || trackConnectedDevices.isDstSwitchArp());\n     }\n \n-    @Override\n-    public boolean isMultiTableSegment() {", "originalCommit": "9c1d3d907eaf5331c2bbcb174a9a0f9c748a9614", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTY4NQ==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r550271685", "bodyText": "Reworked.", "author": "rozdy", "createdAt": "2020-12-30T17:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NzM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0ODMzNw==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r549648337", "bodyText": "It ruins the original idea - now you can't have getters like isPrimaryEgressPath.", "author": "surabujin", "createdAt": "2020-12-29T10:14:38Z", "path": "src-java/kilda-model/src/main/java/org/openkilda/adapter/FlowDestAdapter.java", "diffHunk": "@@ -18,13 +18,18 @@\n import org.openkilda.model.DetectConnectedDevices;\n import org.openkilda.model.Flow;\n import org.openkilda.model.FlowEndpoint;\n+import org.openkilda.model.FlowPath;\n import org.openkilda.model.PathId;\n \n import lombok.NonNull;\n \n public class FlowDestAdapter extends FlowSideAdapter {\n     public FlowDestAdapter(Flow flow) {\n-        super(flow);\n+        super(flow, flow.getForwardPath());\n+    }\n+\n+    public FlowDestAdapter(Flow flow, FlowPath flowPath) {", "originalCommit": "9c1d3d907eaf5331c2bbcb174a9a0f9c748a9614", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTkzNw==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r550271937", "bodyText": "Original idea restored. Multitable related properties removed from adapters.", "author": "rozdy", "createdAt": "2020-12-30T17:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0ODMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0OTEzMQ==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r549649131", "bodyText": "... extremely messy. And it based on the excess pathPath field. Bad idea, as for me.", "author": "surabujin", "createdAt": "2020-12-29T10:17:08Z", "path": "src-java/kilda-model/src/main/java/org/openkilda/adapter/FlowSideAdapter.java", "diffHunk": "@@ -45,41 +47,45 @@ public static FlowSideAdapter makeIngressAdapter(Flow flow, FlowPath path) {\n      */\n     public static FlowSideAdapter makeEgressAdapter(Flow flow, FlowPath path) {\n         if (path.getCookie().getDirection() == FlowPathDirection.FORWARD) {\n-            return new FlowDestAdapter(flow);\n+            return new FlowDestAdapter(flow, path);\n         } else {\n-            return new FlowSourceAdapter(flow);\n+            return new FlowSourceAdapter(flow, path);\n         }\n     }\n \n     /**\n      * Determine flow side by switchId and produce corresponding side-adapter.\n      */\n-    public static FlowSideAdapter makeAdapter(SwitchId switchId, Flow flow) {\n+    public static FlowSideAdapter makeAdapter(SwitchId switchId, Flow flow, FlowPath flowPath) {\n         if (flow.isOneSwitchFlow()) {\n             throw new IllegalArgumentException(\"Unable to determine flow side for one-switch-flow by switch endpoint\");\n         } else if (switchId.equals(flow.getSrcSwitchId())) {\n-            return new FlowSourceAdapter(flow);\n+            return new FlowSourceAdapter(flow, flowPath);\n         } else if (switchId.equals(flow.getDestSwitchId())) {\n-            return new FlowDestAdapter(flow);\n+            return new FlowDestAdapter(flow, flowPath);\n         } else {\n             throw new IllegalArgumentException(String.format(\n                     \"Unable to map switch %s on any flow side of %s\", switchId, flow));\n         }\n     }\n \n-    protected FlowSideAdapter(Flow flow) {\n+    protected FlowSideAdapter(Flow flow, FlowPath flowPath) {\n         this.flow = flow;\n+        this.flowPath = flowPath;\n     }\n \n     public abstract FlowEndpoint getEndpoint();\n \n-    public abstract boolean isMultiTableSegment();\n-\n     public abstract boolean isDetectConnectedDevicesLldp();\n \n     public abstract boolean isDetectConnectedDevicesArp();\n \n     public abstract boolean isPrimaryEgressPath(@NonNull PathId pathId);\n \n     public abstract boolean isLooped();\n+\n+    public boolean isMultiTableSegment() {\n+        return getEndpoint().getSwitchId().equals(flowPath.getSrcSwitchId())", "originalCommit": "9c1d3d907eaf5331c2bbcb174a9a0f9c748a9614", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1MDY2MA==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r549650660", "bodyText": "You must not make such (that this is a forward path) assumptions. At least you must make more checks.", "author": "surabujin", "createdAt": "2020-12-29T10:22:17Z", "path": "src-java/kilda-model/src/main/java/org/openkilda/adapter/FlowSideAdapter.java", "diffHunk": "@@ -45,41 +47,45 @@ public static FlowSideAdapter makeIngressAdapter(Flow flow, FlowPath path) {\n      */\n     public static FlowSideAdapter makeEgressAdapter(Flow flow, FlowPath path) {\n         if (path.getCookie().getDirection() == FlowPathDirection.FORWARD) {\n-            return new FlowDestAdapter(flow);\n+            return new FlowDestAdapter(flow, path);\n         } else {\n-            return new FlowSourceAdapter(flow);\n+            return new FlowSourceAdapter(flow, path);\n         }\n     }\n \n     /**\n      * Determine flow side by switchId and produce corresponding side-adapter.\n      */\n-    public static FlowSideAdapter makeAdapter(SwitchId switchId, Flow flow) {\n+    public static FlowSideAdapter makeAdapter(SwitchId switchId, Flow flow, FlowPath flowPath) {\n         if (flow.isOneSwitchFlow()) {\n             throw new IllegalArgumentException(\"Unable to determine flow side for one-switch-flow by switch endpoint\");\n         } else if (switchId.equals(flow.getSrcSwitchId())) {\n-            return new FlowSourceAdapter(flow);\n+            return new FlowSourceAdapter(flow, flowPath);", "originalCommit": "9c1d3d907eaf5331c2bbcb174a9a0f9c748a9614", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "57f5e28ea5ac3465b0bdd04b8f0dddd759771047", "url": "https://github.com/telstra/open-kilda/commit/57f5e28ea5ac3465b0bdd04b8f0dddd759771047", "message": "Move flow endpoints multitable flag to flow path level", "committedDate": "2020-12-30T17:29:38Z", "type": "forcePushed"}, {"oid": "55bd7fd2a2f0d11930ef8cae22adfef805d1da2b", "url": "https://github.com/telstra/open-kilda/commit/55bd7fd2a2f0d11930ef8cae22adfef805d1da2b", "message": "Move flow endpoints multitable flag to flow path level", "committedDate": "2021-01-04T10:59:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIwMTQ5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r558201491", "bodyText": "Why direct request via path object? As for me, request via flowSide is more flexible.", "author": "surabujin", "createdAt": "2021-01-15T10:22:11Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/service/SpeakerFlowSegmentRequestBuilder.java", "diffHunk": "@@ -277,11 +277,11 @@ private FlowSegmentRequestFactory makeIngressSegmentRequest(\n         return IngressFlowSegmentRequestFactory.builder()\n                 .messageContext(messageContext)\n                 .metadata(makeMetadata(path, ensureEqualMultiTableFlag(\n-                        flowSide.isMultiTableSegment(), segmentSide.isMultiTable(),\n-                        String.format(\"First flow(id:%s, path:%s) segment and flow level multi-table flag values are \"\n-                                              + \"incompatible to each other - flow(%s) != segment(%s)\",\n+                        path.isSrcWithMultiTable(), segmentSide.isMultiTable(),", "originalCommit": "55bd7fd2a2f0d11930ef8cae22adfef805d1da2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODMzMTQzMA==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r558331430", "bodyText": "Because I removed multitable-related info from adapter level. After this changes flow may have multiple paths with different multitable mode on the same endpoint so from flow level we can't get this info in a simple way.", "author": "rozdy", "createdAt": "2021-01-15T14:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIwMTQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTc1NzI0OA==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r559757248", "bodyText": "By design and implementation, BaseFlowRuleRemovalAction is supposed to be used with any FSM which extends FlowProcessingFsm. But this method requires FlowPathSwappingFsm to be provided. Can we align with initial design?", "author": "sergii-iakovenko", "createdAt": "2021-01-18T19:15:38Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/common/actions/BaseFlowRuleRemovalAction.java", "diffHunk": "@@ -235,4 +238,16 @@ protected PathContext buildPathContextForRemovalIngressOnly(SwitchId switchId) {\n                 .server42MacAddress(switchProperties.getServer42MacAddress())\n                 .build();\n     }\n+\n+    protected Flow getOriginalFlowWithPaths(FlowPathSwappingFsm stateMachine, RequestedFlow originalFlow) {", "originalCommit": "55bd7fd2a2f0d11930ef8cae22adfef805d1da2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzcyMzc1OQ==", "url": "https://github.com/telstra/open-kilda/pull/3946#discussion_r583723759", "bodyText": "Reworked.", "author": "rozdy", "createdAt": "2021-02-26T15:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTc1NzI0OA=="}], "type": "inlineReview"}, {"oid": "34ea3b69e1afc16be29f957e3f62efb2eaed0069", "url": "https://github.com/telstra/open-kilda/commit/34ea3b69e1afc16be29f957e3f62efb2eaed0069", "message": "Move flow endpoints multitable flag to flow path level", "committedDate": "2021-02-26T14:17:40Z", "type": "forcePushed"}, {"oid": "770a3f729e3744803ddb7cafea004446db278635", "url": "https://github.com/telstra/open-kilda/commit/770a3f729e3744803ddb7cafea004446db278635", "message": "Move flow endpoints multitable flag to flow path level", "committedDate": "2021-03-03T10:45:24Z", "type": "commit"}, {"oid": "770a3f729e3744803ddb7cafea004446db278635", "url": "https://github.com/telstra/open-kilda/commit/770a3f729e3744803ddb7cafea004446db278635", "message": "Move flow endpoints multitable flag to flow path level", "committedDate": "2021-03-03T10:45:24Z", "type": "forcePushed"}]}