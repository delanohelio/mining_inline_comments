{"pr_number": 3604, "pr_title": "Implementation of smart discovery feature.", "pr_createdAt": "2020-07-07T10:32:36Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3604", "timeline": [{"oid": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "url": "https://github.com/telstra/open-kilda/commit/b2eb2746c9ee06246b320884bc2a1673b3787f7f", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-07T11:03:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NTUyMw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r451395523", "bodyText": "I think it can be replaced by\nreturn discoveryData.stream().allMatch(IslEndpointBfdStatus::isEnabled);", "author": "niksv", "createdAt": "2020-07-08T09:06:01Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/DiscoveryBfdMonitor.java", "diffHunk": "@@ -88,4 +88,19 @@ public void actualUpdate(IslFsmEvent event, IslFsmContext context) {\n     public void actualFlush(Endpoint endpoint, Isl persistentView) {\n         // there is no BFD related fields in ISL\n     }\n+\n+    /**\n+     * Returns true if BFD is enabled, otherwise returns false.\n+     */\n+    public boolean bfdIsEnabled() {\n+        boolean isEnabled = true;\n+\n+        for (Iterator<IslEndpointBfdStatus> it = discoveryData.stream().iterator(); it.hasNext(); ) {\n+            IslEndpointBfdStatus entry = it.next();\n+\n+            isEnabled &= entry.isEnabled();\n+        }\n+\n+        return isEnabled;", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwNzA5OQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452807099", "bodyText": "em... is the evaluateStatus do the same? You can call it from here and \"resolve\" Optional to make the simple boolean results.", "author": "surabujin", "createdAt": "2020-07-10T12:18:17Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/DiscoveryBfdMonitor.java", "diffHunk": "@@ -88,4 +88,19 @@ public void actualUpdate(IslFsmEvent event, IslFsmContext context) {\n     public void actualFlush(Endpoint endpoint, Isl persistentView) {\n         // there is no BFD related fields in ISL\n     }\n+\n+    /**\n+     * Returns true if BFD is enabled, otherwise returns false.\n+     */\n+    public boolean bfdIsEnabled() {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MDQ5Ng==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454340496", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwNzA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwOTA5Nw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452809097", "bodyText": "...\nmake a \"dedicated\" field for DiscoveryBfdMonitor into IslFsm. Put DiscoveryBfdMonitor instance into monitorsByPriority and int this dedicatedfield (same instance i.e. you will have only one instance of DiscoveryBfdMonitor). So you will have a clear obvious way to operate with DiscoveryBfdMonitor from any point in code.", "author": "surabujin", "createdAt": "2020-07-10T12:22:46Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/IslFsm.java", "diffHunk": "@@ -153,19 +157,31 @@ public void operationalEnter(IslFsmState from, IslFsmState to, IslFsmEvent event\n \n     public void operationalExit(IslFsmState from, IslFsmState to, IslFsmEvent event, IslFsmContext context) {\n         bfdManager.disable(context.getOutput());\n+        bfdSlowDiscoveryManager.disable(context.getOutput());\n     }\n \n     public void updateMonitorsAction(IslFsmState from, IslFsmState to, IslFsmEvent event, IslFsmContext context) {\n         boolean isSyncRequired = false;\n+        boolean bfdIsEnabled = false;\n         for (DiscoveryMonitor<?> entry : monitorsByPriority) {\n             isSyncRequired |= entry.update(event, context);\n+\n+            if (entry instanceof DiscoveryBfdMonitor) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MDYwOA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454340608", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwOTA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMTA5NQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452811095", "bodyText": "You produce a lot of bfdSlowDiscoveryManager.enable notifications now. This is not critical, but not optimal... also it can cause unexpected race conditions on the consumer side. If this code will be placed inside } else if (isSyncRequired) { - it will solve this issue (one more check will be required inside usableEnter to cover all possible scenarios).", "author": "surabujin", "createdAt": "2020-07-10T12:26:59Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/IslFsm.java", "diffHunk": "@@ -153,19 +157,31 @@ public void operationalEnter(IslFsmState from, IslFsmState to, IslFsmEvent event\n \n     public void operationalExit(IslFsmState from, IslFsmState to, IslFsmEvent event, IslFsmContext context) {\n         bfdManager.disable(context.getOutput());\n+        bfdSlowDiscoveryManager.disable(context.getOutput());\n     }\n \n     public void updateMonitorsAction(IslFsmState from, IslFsmState to, IslFsmEvent event, IslFsmContext context) {\n         boolean isSyncRequired = false;\n+        boolean bfdIsEnabled = false;\n         for (DiscoveryMonitor<?> entry : monitorsByPriority) {\n             isSyncRequired |= entry.update(event, context);\n+\n+            if (entry instanceof DiscoveryBfdMonitor) {\n+                bfdIsEnabled = ((DiscoveryBfdMonitor) entry).bfdIsEnabled();\n+            }\n         }\n \n         if (evaluateStatus()) {\n             fireBecomeStateEvent(context);\n         } else if (isSyncRequired) {\n             fire(IslFsmEvent._FLUSH);\n         }\n+\n+        if (bfdIsEnabled) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MDY5OQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454340699", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMTA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxNzk4OA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452817988", "bodyText": "Why for you make strict connection relation between BFD and \"slowDiscovery\" (still bad name... this is not whole discovery, this is only one kind of discovery... we already use term 'poll' or 'discovery poll' for this packet out/in process so we should try to reuse this term here) mode? You are switching poll` mode. Yes you use BFD status as a trigger for this switch, but there is no any other connections between these processes. Perhaps there will be more tirggers or we will change it from BFD to some other.\nI am trying to say - you need a name for new poll mode. And based on this name you can build API that manages this mode.", "author": "surabujin", "createdAt": "2020-07-10T12:41:38Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/IIslCarrier.java", "diffHunk": "@@ -32,4 +32,8 @@\n     void islDefaultRulesInstall(Endpoint source, Endpoint destination);\n \n     void islDefaultRulesDelete(Endpoint source, Endpoint destination);\n+\n+    void bfdSlowDiscoveryEnableRequest(Endpoint endpoint);", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MDgyMQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454340821", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:05:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxNzk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxODk1NQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452818955", "bodyText": "One more time - not discovery - discoveryPoll or simple poll or some other name for this mode, that includes term 'poll'.", "author": "surabujin", "createdAt": "2020-07-10T12:43:34Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/IUniIslCarrier.java", "diffHunk": "@@ -36,4 +36,8 @@ void notifyIslUp(Endpoint endpoint, IslReference reference,\n     void notifyIslRoundTripStatus(IslReference reference, RoundTripStatus roundTripStatus);\n \n     void notifyBfdStatus(Endpoint endpoint, IslReference reference, BfdStatus status);\n+\n+    void slowDiscoveryEnableRequest(Endpoint endpoint);", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MDg5OQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454340899", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxODk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzcxNg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452823716", "bodyText": "else if ?", "author": "surabujin", "createdAt": "2020-07-10T12:52:56Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkUniIslService.java", "diffHunk": "@@ -140,6 +146,9 @@ private void handleDiscoveryFail(Endpoint endpoint, IslDownReason downReason) {\n         if (isIslReferenceUsable(reference)) {\n             carrier.notifyIslDown(endpoint, reference, downReason);\n         }\n+        if (reference.isIncomplete()) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MDk4OQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454340989", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyNjQ4NA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452826484", "bodyText": "I would like to have one object that represents each UnitIsl entry. Up till now, the IslReference was enough, but now you need to create some object to store IslRefence and this \"poll-mode-state\".", "author": "surabujin", "createdAt": "2020-07-10T12:58:16Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkUniIslService.java", "diffHunk": "@@ -32,6 +32,7 @@\n @Slf4j\n public class NetworkUniIslService {\n     private final Map<Endpoint, IslReference> endpointData = new HashMap<>();\n+    private final Map<Endpoint, Boolean> slowDiscoveryEnabled = new HashMap<>();", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MTM4Nw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454341387", "bodyText": "This map has been removed", "author": "dpoltavets", "createdAt": "2020-07-14T13:06:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyNjQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyODUyNA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452828524", "bodyText": "You don't need it here... here is a \"normal\" not fist discovery poll notification proxied into ISL. You need to produce such mode switching only on \"isl\" changes... i.e. somewhere below line 87 endpointData.put(endpoint, effectiveReference);.", "author": "surabujin", "createdAt": "2020-07-10T13:02:07Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkUniIslService.java", "diffHunk": "@@ -66,6 +68,7 @@ public void uniIslDiscovery(Endpoint endpoint, IslInfoData speakerDiscoveryEvent\n         IslDataHolder islData = new IslDataHolder(speakerDiscoveryEvent);\n         if (reference.equals(effectiveReference)) {\n             carrier.notifyIslUp(endpoint, reference, islData);\n+            sendSlowDiscoveryDisableRequest(endpoint);", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MTU4NQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454341585", "bodyText": "Removed", "author": "dpoltavets", "createdAt": "2020-07-14T13:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyODUyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzMDQyMw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r452830423", "bodyText": "... why direct set, not via sendSlowDiscoveryDisableRequest(endpoint) wrapper?", "author": "surabujin", "createdAt": "2020-07-10T13:05:45Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkUniIslService.java", "diffHunk": "@@ -77,10 +80,12 @@ public void uniIslDiscovery(Endpoint endpoint, IslInfoData speakerDiscoveryEvent\n \n         if (!effectiveReference.isSelfLoop()) {\n             carrier.notifyIslUp(endpoint, effectiveReference, islData);\n+            sendSlowDiscoveryDisableRequest(endpoint);\n         } else {\n             log.error(\"Self looped ISL discovery received: {}\", effectiveReference);\n         }\n         endpointData.put(endpoint, effectiveReference);\n+        slowDiscoveryEnabled.putIfAbsent(endpoint, false);", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MTgzOA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454341838", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzMDQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MjkzNQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453482935", "bodyText": "You must produce at leas \"info\" level log message informing about poll mode change for specific endpoint.", "author": "surabujin", "createdAt": "2020-07-13T08:34:01Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -73,27 +84,75 @@ public void removeWatch(Endpoint endpoint) {\n         endpoints.remove(endpoint);\n     }\n \n+    /**\n+     * Handle update slow discovery flag request.\n+     */\n+    public void updateSlowDiscoveryFlag(Endpoint endpoint, boolean isEnabled) {\n+        log.debug(\"Watch-list service receive update slow discovery flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MTk0Nw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454341947", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MjkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgzNzc3Mw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455837773", "bodyText": "Be more specific - log.info(\"Discovery poll mode for endpoint {} update - slow mode requested({}), endpoint, context)...", "author": "surabujin", "createdAt": "2020-07-16T14:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MjkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MzEzNA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453483134", "bodyText": "Same issue with logs here.", "author": "surabujin", "createdAt": "2020-07-13T08:34:19Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -73,27 +84,75 @@ public void removeWatch(Endpoint endpoint) {\n         endpoints.remove(endpoint);\n     }\n \n+    /**\n+     * Handle update slow discovery flag request.\n+     */\n+    public void updateSlowDiscoveryFlag(Endpoint endpoint, boolean isEnabled) {\n+        log.debug(\"Watch-list service receive update slow discovery flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->\n+                endpointContext.toBuilder().slowDiscoveryEnabled(isEnabled).build());\n+    }\n+\n+    @VisibleForTesting\n+    void updateBfdSlowDiscoveryFlag(Endpoint endpoint, boolean isEnabled, long currentTime) {\n+        log.debug(\"Watch-list service receive update slow discovery flag to {} for BFD enabled case request for {}\",\n+                isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MjAwNg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454342006", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MzEzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MzMyOA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453483328", "bodyText": "Is true here means that \"slow-poll-discovery-mode\" is activated or deactivated? Why we are forcing new discovery requests to emit here? And why it is done for all inflight requests? I.e. you are forsing new discovery requests for all endpoints, not only endpoint mentioned into this update.", "author": "surabujin", "createdAt": "2020-07-13T08:34:39Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -73,27 +84,75 @@ public void removeWatch(Endpoint endpoint) {\n         endpoints.remove(endpoint);\n     }\n \n+    /**\n+     * Handle update slow discovery flag request.\n+     */\n+    public void updateSlowDiscoveryFlag(Endpoint endpoint, boolean isEnabled) {\n+        log.debug(\"Watch-list service receive update slow discovery flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->\n+                endpointContext.toBuilder().slowDiscoveryEnabled(isEnabled).build());\n+    }\n+\n+    @VisibleForTesting\n+    void updateBfdSlowDiscoveryFlag(Endpoint endpoint, boolean isEnabled, long currentTime) {\n+        log.debug(\"Watch-list service receive update slow discovery flag to {} for BFD enabled case request for {}\",\n+                isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->\n+                endpointContext.toBuilder().bfdSlowDiscoveryEnabled(isEnabled).build());\n+\n+        if (!isEnabled) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MzY2Mg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454343662", "bodyText": "Added comment. This is used to restart discovery using default interval value when BFD is turned off.", "author": "dpoltavets", "createdAt": "2020-07-14T13:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MzMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5Mzk2Mw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453493963", "bodyText": "BfdManager utility was created as an attempt to not include into IslFsm \"generic\" method used from the service layer. There is 2 point where we need to manage BFD state - the first is IslFsm and the second is NetworkIslService. So need to add bfd management methods inside IslFsm (bad from FSM point of view) or make some other ... tool. That how BfdManager apper.\nThere is no any reason to make BfdSlowDiscoveryManager. So you should merge it inside BfdManager or perform corresponding discovery-poll-mode change request from IslFsm.", "author": "surabujin", "createdAt": "2020-07-13T08:50:58Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/isl/BfdSlowDiscoveryManager.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/* Copyright 2019 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.network.storm.bolt.isl;\n+\n+import org.openkilda.wfm.share.model.IslReference;\n+import org.openkilda.wfm.topology.network.service.IIslCarrier;\n+\n+public class BfdSlowDiscoveryManager {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NDU2MQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454344561", "bodyText": "It has been merged with BfdManager", "author": "dpoltavets", "createdAt": "2020-07-14T13:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5Mzk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NTYzNQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453495635", "bodyText": "em... bad/unexpected place to filter requests... sender and consumer do not know anything about it. The most correct solution - the consumer must be ready to repeated requests.", "author": "surabujin", "createdAt": "2020-07-13T08:53:42Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/isl/BfdSlowDiscoveryManager.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/* Copyright 2019 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.network.storm.bolt.isl;\n+\n+import org.openkilda.wfm.share.model.IslReference;\n+import org.openkilda.wfm.topology.network.service.IIslCarrier;\n+\n+public class BfdSlowDiscoveryManager {\n+    private final IslReference reference;\n+\n+    private boolean lastCommandIsEnable;\n+\n+    public BfdSlowDiscoveryManager(IslReference reference) {\n+        this.reference = reference;\n+    }\n+\n+    /**\n+     * Send enable slow discovery request in case when BFD becomes active.\n+     */\n+    public void enable(IIslCarrier carrier) {\n+        if (!lastCommandIsEnable) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NDk2NA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454344964", "bodyText": "This filter has been removed", "author": "dpoltavets", "createdAt": "2020-07-14T13:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NTYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NjczNA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453496734", "bodyText": "use '-' insdead ot '.'... The '.' is used for common suffixes - '.encoder', '.decoder' etc and ... only into spout/bolt names, not stream names.", "author": "surabujin", "createdAt": "2020-07-13T08:55:26Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/isl/IslHandler.java", "diffHunk": "@@ -75,6 +78,10 @@\n     public static final Fields STREAM_SPEAKER_RULES_FIELDS = new Fields(\n             KafkaEncoder.FIELD_ID_KEY, FIELD_ID_COMMAND, FIELD_ID_CONTEXT);\n \n+    public static final String STREAM_WATCH_LIST_ID = \"watch.list\";", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NTA1NA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454345054", "bodyText": "Renamed", "author": "dpoltavets", "createdAt": "2020-07-14T13:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5NjczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5OTE4OQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453499189", "bodyText": "Perhaps we can have enabled/disabled as an argument?", "author": "surabujin", "createdAt": "2020-07-13T08:59:18Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/isl/IslHandler.java", "diffHunk": "@@ -164,6 +172,16 @@ public void islDefaultRulesDelete(Endpoint source, Endpoint destination) {\n                 new SpeakerRulesIslRemoveCommand(keyFactory.next(), source, destination)));\n     }\n \n+    @Override\n+    public void bfdSlowDiscoveryEnableRequest(Endpoint endpoint) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NTMwMg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454345302", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5OTE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwMTM2OQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453501369", "bodyText": "... incorrect pattern usage. The makeSomethingTuple provide API to format tuple for specific stream. These methods are responsible for correct fields ordering and correct value types into produced tuples.\nYou don't have a \"watcher-list-bfd-slow-dicovery\" stream.", "author": "surabujin", "createdAt": "2020-07-13T09:02:20Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/isl/IslHandler.java", "diffHunk": "@@ -182,6 +200,11 @@ private Values makeStatusUpdateTuple(IslStatusUpdateNotification payload) {\n         return new Values(null, payload, getCommandContext());\n     }\n \n+    private Values makeWatchListBfdSlowDiscoveryTuple(Endpoint endpoint, boolean enableSlowDiscovery) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NTQwMw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454345403", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:12:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwMTM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwMTc4Mw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453501783", "bodyText": "same about '.' usage", "author": "surabujin", "createdAt": "2020-07-13T09:02:58Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/uniisl/UniIslHandler.java", "diffHunk": "@@ -51,9 +53,15 @@\n     public static final String FIELD_ID_ISL_SOURCE = SpeakerRouter.FIELD_ID_ISL_SOURCE;\n     public static final String FIELD_ID_ISL_DEST = SpeakerRouter.FIELD_ID_ISL_DEST;\n     public static final String FIELD_ID_COMMAND = SpeakerRouter.FIELD_ID_COMMAND;\n+    public static final String FIELD_ID_DATAPATH = PortHandler.FIELD_ID_DATAPATH;\n+    public static final String FIELD_ID_PORT_NUMBER = PortHandler.FIELD_ID_PORT_NUMBER;\n \n     public static final Fields STREAM_FIELDS = SpeakerRouter.STREAM_ISL_FIELDS;\n \n+    public static final String STREAM_WATCH_LIST_ID = \"watch.list\";", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NTQ5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454345491", "bodyText": "Renamed", "author": "dpoltavets", "createdAt": "2020-07-14T13:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwMTc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwMjExMQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453502111", "bodyText": "Same about streams.", "author": "surabujin", "createdAt": "2020-07-13T09:03:28Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/uniisl/UniIslHandler.java", "diffHunk": "@@ -122,11 +130,26 @@ public void notifyBfdStatus(Endpoint endpoint, IslReference reference, BfdStatus\n         emit(getCurrentTuple(), makeDefaultTuple(new IslBfdStatusUpdateCommand(endpoint, reference, status)));\n     }\n \n+    @Override\n+    public void slowDiscoveryEnableRequest(Endpoint endpoint) {\n+        emit(STREAM_WATCH_LIST_ID, getCurrentTuple(), makeWatchListSlowDiscoveryTuple(endpoint, true));\n+    }\n+\n+    @Override\n+    public void slowDiscoveryDisableRequest(Endpoint endpoint) {\n+        emit(STREAM_WATCH_LIST_ID, getCurrentTuple(), makeWatchListSlowDiscoveryTuple(endpoint, false));\n+    }\n+\n     private Values makeDefaultTuple(IslCommand command) {\n         IslReference reference = command.getReference();\n         return new Values(reference.getSource(), reference.getDest(), command, getCommandContext());\n     }\n \n+    private Values makeWatchListSlowDiscoveryTuple(Endpoint endpoint, boolean enableSlowDiscovery) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NTU2MQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454345561", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwMjExMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwMzMyNA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r453503324", "bodyText": "Same question about enabled/disabled argument.", "author": "surabujin", "createdAt": "2020-07-13T09:05:27Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/uniisl/UniIslHandler.java", "diffHunk": "@@ -122,11 +130,26 @@ public void notifyBfdStatus(Endpoint endpoint, IslReference reference, BfdStatus\n         emit(getCurrentTuple(), makeDefaultTuple(new IslBfdStatusUpdateCommand(endpoint, reference, status)));\n     }\n \n+    @Override\n+    public void slowDiscoveryEnableRequest(Endpoint endpoint) {", "originalCommit": "b2eb2746c9ee06246b320884bc2a1673b3787f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NTY2Nw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r454345667", "bodyText": "Fixed", "author": "dpoltavets", "createdAt": "2020-07-14T13:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwMzMyNA=="}], "type": "inlineReview"}, {"oid": "785cc3fb673246d46793331531dfad310d2fb104", "url": "https://github.com/telstra/open-kilda/commit/785cc3fb673246d46793331531dfad310d2fb104", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-14T12:59:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgyMzQ4MA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455823480", "bodyText": "bfd monitor ... bfd is enabled... too many \"bfd\", as for me. isEnabled() ... no isOperational() should be enoug.", "author": "surabujin", "createdAt": "2020-07-16T14:20:21Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/IslFsm.java", "diffHunk": "@@ -165,6 +169,10 @@ public void updateMonitorsAction(IslFsmState from, IslFsmState to, IslFsmEvent e\n             fireBecomeStateEvent(context);\n         } else if (isSyncRequired) {\n             fire(IslFsmEvent._FLUSH);\n+\n+            if (discoveryBfdMonitor.bfdIsEnabled()) {", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMTc2MA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456401760", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-07-17T12:10:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgyMzQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgyNDgyNg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455824826", "bodyText": "No... the idea here is to reset internal monitor state (ISL can reenter operational state), so you must not use any global monitor instances, you must create all of them here.", "author": "surabujin", "createdAt": "2020-07-16T14:22:16Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/IslFsm.java", "diffHunk": "@@ -135,7 +138,7 @@ public void operationalEnter(IslFsmState from, IslFsmState to, IslFsmEvent event\n         monitorsByPriority = ImmutableList.of(\n                 new DiscoveryMovedMonitor(reference),\n                 new DiscoveryPortStatusMonitor(reference),\n-                new DiscoveryBfdMonitor(reference),\n+                discoveryBfdMonitor,", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMTg5OA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456401898", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-07-17T12:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgyNDgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgyOTk0OQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455829949", "bodyText": "I have doubts regarding this call here - bfdManager.disable(carrier) will trigger BFD removal process and at the end, it will trigger bfdManager.disableUnhurriedPoll inside IslFsm in managed manner... This call here is a \"fire and forget\" approach... it should work in most cases, but in some cases, it can lead to extremely unexpected results.\nCan we try to not put it here?", "author": "surabujin", "createdAt": "2020-07-16T14:29:16Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkIslService.java", "diffHunk": "@@ -176,6 +176,7 @@ public void bfdEnableDisable(IslReference reference, IslBfdFlagUpdated payload)\n             bfdManager.enable(carrier);\n         } else {\n             bfdManager.disable(carrier);\n+            bfdManager.disableUnhurriedPoll(carrier);", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMjI0NQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456402245", "bodyText": "You are right. This call has been removed.", "author": "dpoltavets", "createdAt": "2020-07-17T12:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgyOTk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgzMzAwMw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455833003", "bodyText": "... is just one fail response enough to switch endpoint into \"slow\" poll mode? I thought there should be series of time window without response for this.", "author": "surabujin", "createdAt": "2020-07-16T14:32:34Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkUniIslService.java", "diffHunk": "@@ -139,6 +140,8 @@ private void handleDiscoveryFail(Endpoint endpoint, IslDownReason downReason) {\n         IslReference reference = lookupEndpointData(endpoint);\n         if (isIslReferenceUsable(reference)) {\n             carrier.notifyIslDown(endpoint, reference, downReason);\n+        } else if (reference.isIncomplete()) {\n+            carrier.slowPollUpdateRequest(endpoint, true);", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMzI3Mg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456403272", "bodyText": "This is enough for our case (for ports not belonging to ISL). This has been tested and works as expected.", "author": "dpoltavets", "createdAt": "2020-07-17T12:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgzMzAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0MzY0NA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455843644", "bodyText": "Perhaps we should stop doing anything if there is no such endpoint in our endpoints map?", "author": "surabujin", "createdAt": "2020-07-16T14:46:40Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -73,27 +84,74 @@ public void removeWatch(Endpoint endpoint) {\n         endpoints.remove(endpoint);\n     }\n \n+    /**\n+     * Handle update slow discovery poll flag request.\n+     */\n+    public void updateSlowPoll(Endpoint endpoint, boolean isEnabled) {\n+        log.info(\"Watch-list service receive update slow poll flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->\n+                endpointContext.toBuilder().slowPollEnabled(isEnabled).build());\n+    }\n+\n+    @VisibleForTesting\n+    void updateUnhurriedPoll(Endpoint endpoint, boolean isEnabled, long currentTime) {\n+        log.info(\"Watch-list service receive update unhurried poll flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMzgwOQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456403809", "bodyText": "Yes, we should not. Added additional check.", "author": "dpoltavets", "createdAt": "2020-07-17T12:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0MzY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0NDY5NA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455844694", "bodyText": "define some method capable to calculate timeout from endpoint or EndpointContext instance.", "author": "surabujin", "createdAt": "2020-07-16T14:48:02Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -73,27 +84,74 @@ public void removeWatch(Endpoint endpoint) {\n         endpoints.remove(endpoint);\n     }\n \n+    /**\n+     * Handle update slow discovery poll flag request.\n+     */\n+    public void updateSlowPoll(Endpoint endpoint, boolean isEnabled) {\n+        log.info(\"Watch-list service receive update slow poll flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->\n+                endpointContext.toBuilder().slowPollEnabled(isEnabled).build());\n+    }\n+\n+    @VisibleForTesting\n+    void updateUnhurriedPoll(Endpoint endpoint, boolean isEnabled, long currentTime) {\n+        log.info(\"Watch-list service receive update unhurried poll flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->\n+                endpointContext.toBuilder().unhurriedPollEnabled(isEnabled).build());\n+\n+        if (!isEnabled) { // when another mechanism used to determine ISL status is disabled\n+            for (Set<Endpoint> e : timeouts.values()) {\n+                e.remove(endpoint);\n+            }\n+\n+            carrier.discoveryRequest(endpoint, currentTime);", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMzk2NQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456403965", "bodyText": "This method has been added.", "author": "dpoltavets", "createdAt": "2020-07-17T12:15:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0NDY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2ODQ2NQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457368465", "bodyText": "Why you are doing such timeout's reset during switch from auxiliary to generic mode, but don't do for exhausted to generic?", "author": "surabujin", "createdAt": "2020-07-20T13:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0NDY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0NTc1NQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455845755", "bodyText": "Why we are not doing same actions on disabling \"slow\" mode?", "author": "surabujin", "createdAt": "2020-07-16T14:49:27Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -73,27 +84,74 @@ public void removeWatch(Endpoint endpoint) {\n         endpoints.remove(endpoint);\n     }\n \n+    /**\n+     * Handle update slow discovery poll flag request.\n+     */\n+    public void updateSlowPoll(Endpoint endpoint, boolean isEnabled) {\n+        log.info(\"Watch-list service receive update slow poll flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->\n+                endpointContext.toBuilder().slowPollEnabled(isEnabled).build());\n+    }\n+\n+    @VisibleForTesting\n+    void updateUnhurriedPoll(Endpoint endpoint, boolean isEnabled, long currentTime) {\n+        log.info(\"Watch-list service receive update unhurried poll flag to {} request for {}\", isEnabled, endpoint);\n+        endpoints.computeIfPresent(endpoint, (e, endpointContext) ->\n+                endpointContext.toBuilder().unhurriedPollEnabled(isEnabled).build());\n+\n+        if (!isEnabled) { // when another mechanism used to determine ISL status is disabled", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwNTI3Mg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456405272", "bodyText": "This is not necessary for our case (for ports not belonging to ISL). If we need to use this mode for other cases, it is not difficult to fix it.", "author": "dpoltavets", "createdAt": "2020-07-17T12:18:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0NTc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0NzI3Ng==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455847276", "bodyText": "(nip) As for me WatchListEntry is a more suitable name.", "author": "surabujin", "createdAt": "2020-07-16T14:51:30Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -104,4 +162,20 @@ public void tick() {\n     private long now() {\n         return System.nanoTime();\n     }\n+\n+    private void addTimeouts(Set<Endpoint> renew, long key) {\n+        if (!renew.isEmpty()) {\n+            timeouts.computeIfAbsent(key, mappingFunction -> new HashSet<>())\n+                    .addAll(renew);\n+        }\n+    }\n+\n+    @Getter\n+    @NoArgsConstructor\n+    @AllArgsConstructor\n+    @Builder(toBuilder = true)\n+    private static class EndpointContext {", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwNTQyNQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456405425", "bodyText": "Renamed.", "author": "dpoltavets", "createdAt": "2020-07-17T12:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0NzI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1MDYzOQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455850639", "bodyText": "Check for possible loops produced by this stream. Perhaps we must not tie it to getCurrentTuple().", "author": "surabujin", "createdAt": "2020-07-16T14:55:52Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/isl/IslHandler.java", "diffHunk": "@@ -164,6 +172,12 @@ public void islDefaultRulesDelete(Endpoint source, Endpoint destination) {\n                 new SpeakerRulesIslRemoveCommand(keyFactory.next(), source, destination)));\n     }\n \n+    @Override\n+    public void unhurriedPollUpdateRequest(Endpoint endpoint, boolean enableUnhurriedPoll) {\n+        WatchListCommand command = new WatchListUnhurriedPollUpdateCommand(endpoint, enableUnhurriedPoll);\n+        emit(STREAM_POLL_ID, getCurrentTuple(), makePollTuple(command));", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwNjA1Mg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456406052", "bodyText": "This anchor has been removed in this place.", "author": "dpoltavets", "createdAt": "2020-07-17T12:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1MDYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1MTA0Nw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r455851047", "bodyText": "Same here, regarding loops.", "author": "surabujin", "createdAt": "2020-07-16T14:56:26Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/uniisl/UniIslHandler.java", "diffHunk": "@@ -122,11 +130,22 @@ public void notifyBfdStatus(Endpoint endpoint, IslReference reference, BfdStatus\n         emit(getCurrentTuple(), makeDefaultTuple(new IslBfdStatusUpdateCommand(endpoint, reference, status)));\n     }\n \n+    @Override\n+    public void slowPollUpdateRequest(Endpoint endpoint, boolean enableSlowPoll) {\n+        WatchListCommand command = new WatchListSlowPollUpdateCommand(endpoint, enableSlowPoll);\n+        emit(STREAM_POLL_ID, getCurrentTuple(), makePollTuple(command));", "originalCommit": "785cc3fb673246d46793331531dfad310d2fb104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwNjA5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r456406091", "bodyText": "This anchor has been removed in this place.", "author": "dpoltavets", "createdAt": "2020-07-17T12:20:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1MTA0Nw=="}], "type": "inlineReview"}, {"oid": "68571b65ba32ce3d405d2ae69bfd0f7dea3939e8", "url": "https://github.com/telstra/open-kilda/commit/68571b65ba32ce3d405d2ae69bfd0f7dea3939e8", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-17T11:41:48Z", "type": "forcePushed"}, {"oid": "0e71cd0bef68f9f782cee3711a1fc600c91a1081", "url": "https://github.com/telstra/open-kilda/commit/0e71cd0bef68f9f782cee3711a1fc600c91a1081", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-20T06:34:59Z", "type": "forcePushed"}, {"oid": "419e2e16e14221fe8575cd1841e22e805294cd22", "url": "https://github.com/telstra/open-kilda/commit/419e2e16e14221fe8575cd1841e22e805294cd22", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-20T08:21:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0NTM4MQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457345381", "bodyText": "It is definitely excess.", "author": "surabujin", "createdAt": "2020-07-20T12:40:13Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/IslFsm.java", "diffHunk": "@@ -112,6 +113,8 @@ public IslFsm(Clock clock, PersistenceManager persistenceManager, NetworkTopolog\n         this.reference = reference;\n         this.bfdManager = bfdManager;\n \n+        this.discoveryBfdMonitor = new DiscoveryBfdMonitor(reference);", "originalCommit": "419e2e16e14221fe8575cd1841e22e805294cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4OTMxNA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457889314", "bodyText": "Removed.", "author": "dpoltavets", "createdAt": "2020-07-21T07:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0NTM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0OTE1MQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457349151", "bodyText": "I would like to make something like:\nboolean isBfdOperationalNow = discoveryBfdMonitor.isOperational():\n// ... update monitros status\nif (!isBfdOperationalNow && discoveryBfdMonitor.isOperational()) {  // on top level, not inside `isSyncrequired` branch\n    // emit swict poll mode request\n}\n\nThe current approarch will work too. But there are a lot of cases when monitors will want to sync it state into DB. And on each such event starting at the moment when BFD become operational you will produce poll mode change request. It is not bad, but it is excess and it is relatively easy way to avoid it.", "author": "surabujin", "createdAt": "2020-07-20T12:45:00Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/IslFsm.java", "diffHunk": "@@ -165,6 +170,10 @@ public void updateMonitorsAction(IslFsmState from, IslFsmState to, IslFsmEvent e\n             fireBecomeStateEvent(context);\n         } else if (isSyncRequired) {\n             fire(IslFsmEvent._FLUSH);\n+\n+            if (discoveryBfdMonitor.isOperational()) {", "originalCommit": "419e2e16e14221fe8575cd1841e22e805294cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5MDEwMg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457890102", "bodyText": "Good point. Fixed.", "author": "dpoltavets", "createdAt": "2020-07-21T07:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0OTE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NTM0Ng==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457355346", "bodyText": "Why it is here? updateMonitorsAction(...) should handle all cases. Is there any specific cases not covered there?", "author": "surabujin", "createdAt": "2020-07-20T12:53:11Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/isl/IslFsm.java", "diffHunk": "@@ -225,6 +234,10 @@ public void usableEnter(IslFsmState from, IslFsmState to, IslFsmEvent event, Isl\n         flushTransaction();\n         sendBfdEnable(context.getOutput());\n \n+        if (discoveryBfdMonitor.isOperational()) {", "originalCommit": "419e2e16e14221fe8575cd1841e22e805294cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5MDMyMw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457890323", "bodyText": "Removed.", "author": "dpoltavets", "createdAt": "2020-07-21T07:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NTM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NzUwNw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457357507", "bodyText": "may we call it auxiliaryPollModeUpdateRequest ? Because we change the poll mode, not poll itself.", "author": "surabujin", "createdAt": "2020-07-20T12:56:08Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/IIslCarrier.java", "diffHunk": "@@ -32,4 +32,6 @@\n     void islDefaultRulesInstall(Endpoint source, Endpoint destination);\n \n     void islDefaultRulesDelete(Endpoint source, Endpoint destination);\n+\n+    void auxiliaryPollUpdateRequest(Endpoint endpoint, boolean enableAuxiliaryPoll);", "originalCommit": "419e2e16e14221fe8575cd1841e22e805294cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5MDQxMg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457890412", "bodyText": "Renamed.", "author": "dpoltavets", "createdAt": "2020-07-21T07:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NzUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1Nzg5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457357891", "bodyText": "same here - it is poll mode.", "author": "surabujin", "createdAt": "2020-07-20T12:56:40Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/IUniIslCarrier.java", "diffHunk": "@@ -36,4 +36,6 @@ void notifyIslUp(Endpoint endpoint, IslReference reference,\n     void notifyIslRoundTripStatus(IslReference reference, RoundTripStatus roundTripStatus);\n \n     void notifyBfdStatus(Endpoint endpoint, IslReference reference, BfdStatus status);\n+\n+    void exhaustedPollUpdateRequest(Endpoint endpoint, boolean enableExhaustedPoll);", "originalCommit": "419e2e16e14221fe8575cd1841e22e805294cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5MDQ0NQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457890445", "bodyText": "Renamed.", "author": "dpoltavets", "createdAt": "2020-07-21T07:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1Nzg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3NTg5Mw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457375893", "bodyText": "You can reuse calculateTimeout() method here if you replace sets renewGeneric, renewExhausted and renewAuxiliary with map Map<Endpoint, WatchListEntry> renew. Benefits from here - single point of responsibility for delay calculation i.e. only calculateTimeout() will know how to do it and only it will need to be changed when the set of poll modes will be updated.", "author": "surabujin", "createdAt": "2020-07-20T13:20:55Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -73,27 +84,72 @@ public void removeWatch(Endpoint endpoint) {\n         endpoints.remove(endpoint);\n     }\n \n+    /**\n+     * Handle update slow discovery poll flag request.\n+     */\n+    public void updateExhaustedPoll(Endpoint endpoint, boolean enable) {\n+        log.info(\"Discovery poll mode for endpoint {} update - exhausted mode requested (enable: '{}')\",\n+                endpoint, enable);\n+        endpoints.computeIfPresent(endpoint,\n+                (e, watchListEntry) -> watchListEntry.toBuilder().exhaustedPollEnabled(enable).build());\n+    }\n+\n+    @VisibleForTesting\n+    void updateAuxiliaryPoll(Endpoint endpoint, boolean enable, long currentTime) {\n+        log.info(\"Discovery poll mode for endpoint {} update - auxiliary mode requested (enable: '{}')\",\n+                endpoint, enable);\n+        WatchListEntry watchListEntry = endpoints.computeIfPresent(endpoint,\n+                (e, listEntry) -> listEntry.toBuilder().auxiliaryPollEnabled(enable).build());\n+\n+        if (watchListEntry != null && !enable) { // when another mechanism used to determine ISL status is disabled\n+            for (Set<Endpoint> e : timeouts.values()) {\n+                e.remove(endpoint);\n+            }\n+\n+            carrier.discoveryRequest(endpoint, currentTime);\n+            addTimeouts(Collections.singleton(endpoint), currentTime + calculateTimeout(endpoint));\n+        }\n+    }\n+\n+    /**\n+     * Handle update slow discovery flag request for BFD enabled case.\n+     */\n+    public void updateAuxiliaryPoll(Endpoint endpoint, boolean enable) {\n+        updateAuxiliaryPoll(endpoint, enable, now());\n+    }\n+\n     /**\n      * Consume timer tick.\n      */\n-    public void tick(long tickTime) {\n+    @VisibleForTesting\n+    void tick(long tickTime) {\n         SortedMap<Long, Set<Endpoint>> range = timeouts.subMap(0L, tickTime + 1);\n         if (!range.isEmpty()) {\n-            HashSet<Endpoint> renew = new HashSet<>();\n+            Set<Endpoint> renewGeneric = new HashSet<>();\n+            Set<Endpoint> renewExhausted = new HashSet<>();\n+            Set<Endpoint> renewAuxiliary = new HashSet<>();\n+\n             for (Set<Endpoint> e : range.values()) {\n                 for (Endpoint ee : e) {\n-                    if (endpoints.contains(ee)) {\n+                    WatchListEntry watchListEntry = endpoints.get(ee);\n+                    if (watchListEntry != null) {\n                         carrier.discoveryRequest(ee, tickTime);\n-                        renew.add(ee);\n+\n+                        if (watchListEntry.isAuxiliaryPollEnabled()) {\n+                            renewAuxiliary.add(ee);\n+                        } else if (watchListEntry.isExhaustedPollEnabled()) {\n+                            renewExhausted.add(ee);\n+                        } else {\n+                            renewGeneric.add(ee);\n+                        }\n                     }\n                 }\n             }\n             range.clear();\n-            if (!renew.isEmpty()) {\n-                long key = tickTime + tickPeriod;\n-                timeouts.computeIfAbsent(key, mappingFunction -> new HashSet<>())\n-                        .addAll(renew);\n-            }\n+\n+            addTimeouts(renewGeneric, tickTime + genericTickPeriod);", "originalCommit": "419e2e16e14221fe8575cd1841e22e805294cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5MDU1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457890553", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-07-21T07:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3NTg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM4NDYxMA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457384610", "bodyText": "Add a comment describing why we do not link produced tuple to the current tuple i.e. why we do not use the anchor. Without the comment, someone can think this is a typo/mistake.", "author": "surabujin", "createdAt": "2020-07-20T13:30:38Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/storm/bolt/isl/IslHandler.java", "diffHunk": "@@ -164,6 +172,12 @@ public void islDefaultRulesDelete(Endpoint source, Endpoint destination) {\n                 new SpeakerRulesIslRemoveCommand(keyFactory.next(), source, destination)));\n     }\n \n+    @Override\n+    public void auxiliaryPollUpdateRequest(Endpoint endpoint, boolean enableAuxiliaryPoll) {\n+        WatchListCommand command = new WatchListAuxiliaryPollUpdateCommand(endpoint, enableAuxiliaryPoll);\n+        emit(STREAM_POLL_ID, makePollTuple(command));", "originalCommit": "419e2e16e14221fe8575cd1841e22e805294cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5MDYzMw==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r457890633", "bodyText": "Added.", "author": "dpoltavets", "createdAt": "2020-07-21T07:25:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM4NDYxMA=="}], "type": "inlineReview"}, {"oid": "cfe926d59a4b1bfa6a7a617345198a36ab7650f7", "url": "https://github.com/telstra/open-kilda/commit/cfe926d59a4b1bfa6a7a617345198a36ab7650f7", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-21T06:43:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY5NTI1Ng==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r458695256", "bodyText": "You need to do it only if renew.put(enpoint, watchlistEntry) == null now you can produce 2 request for single endpoint.", "author": "surabujin", "createdAt": "2020-07-22T10:30:45Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -73,27 +83,59 @@ public void removeWatch(Endpoint endpoint) {\n         endpoints.remove(endpoint);\n     }\n \n+    @VisibleForTesting\n+    void updateExhaustedPollMode(Endpoint endpoint, boolean enable, long currentTime) {\n+        log.info(\"Discovery poll mode for endpoint {} update - exhausted mode requested (enable: '{}')\",\n+                endpoint, enable);\n+        WatchListEntry watchListEntry = endpoints.computeIfPresent(endpoint,\n+                (e, listEntry) -> listEntry.toBuilder().exhaustedPollEnabled(enable).build());\n+\n+        if (watchListEntry != null && !enable) { // when ISL belonging to this endpoint was found\n+            reloadEndpointTimeout(endpoint, currentTime);\n+        }\n+    }\n+\n+    public void updateExhaustedPollMode(Endpoint endpoint, boolean enable) {\n+        updateExhaustedPollMode(endpoint, enable, now());\n+    }\n+\n+    @VisibleForTesting\n+    void updateAuxiliaryPollMode(Endpoint endpoint, boolean enable, long currentTime) {\n+        log.info(\"Discovery poll mode for endpoint {} update - auxiliary mode requested (enable: '{}')\",\n+                endpoint, enable);\n+        WatchListEntry watchListEntry = endpoints.computeIfPresent(endpoint,\n+                (e, listEntry) -> listEntry.toBuilder().auxiliaryPollEnabled(enable).build());\n+\n+        if (watchListEntry != null && !enable) { // when another mechanism used to determine ISL status is disabled\n+            reloadEndpointTimeout(endpoint, currentTime);\n+        }\n+    }\n+\n+    public void updateAuxiliaryPollMode(Endpoint endpoint, boolean enable) {\n+        updateAuxiliaryPollMode(endpoint, enable, now());\n+    }\n+\n     /**\n      * Consume timer tick.\n      */\n-    public void tick(long tickTime) {\n+    @VisibleForTesting\n+    void tick(long tickTime) {\n         SortedMap<Long, Set<Endpoint>> range = timeouts.subMap(0L, tickTime + 1);\n         if (!range.isEmpty()) {\n-            HashSet<Endpoint> renew = new HashSet<>();\n-            for (Set<Endpoint> e : range.values()) {\n-                for (Endpoint ee : e) {\n-                    if (endpoints.contains(ee)) {\n-                        carrier.discoveryRequest(ee, tickTime);\n-                        renew.add(ee);\n+            Map<Endpoint, WatchListEntry> renew = new HashMap<>();\n+\n+            for (Set<Endpoint> endpointSet : range.values()) {\n+                for (Endpoint endpoint : endpointSet) {\n+                    WatchListEntry watchListEntry = endpoints.get(endpoint);\n+                    if (watchListEntry != null) {\n+                        carrier.discoveryRequest(endpoint, tickTime);", "originalCommit": "cfe926d59a4b1bfa6a7a617345198a36ab7650f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwMjA5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r458702091", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-07-22T10:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY5NTI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY5NjUyOA==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r458696528", "bodyText": "It will be better if we key will be renamed in something like timeoutAt.", "author": "surabujin", "createdAt": "2020-07-22T10:33:09Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/service/NetworkWatchListService.java", "diffHunk": "@@ -104,4 +146,40 @@ public void tick() {\n     private long now() {\n         return System.nanoTime();\n     }\n+\n+    private void addTimeout(Endpoint endpoint, long key) {", "originalCommit": "cfe926d59a4b1bfa6a7a617345198a36ab7650f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwMjIwMg==", "url": "https://github.com/telstra/open-kilda/pull/3604#discussion_r458702202", "bodyText": "Renamed.", "author": "dpoltavets", "createdAt": "2020-07-22T10:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY5NjUyOA=="}], "type": "inlineReview"}, {"oid": "a920284f19527bcfaa7cd6685a6d2ce984c8a8b9", "url": "https://github.com/telstra/open-kilda/commit/a920284f19527bcfaa7cd6685a6d2ce984c8a8b9", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-22T10:42:58Z", "type": "forcePushed"}, {"oid": "e7c4e072887c5d36e6364269464a55c1029a124c", "url": "https://github.com/telstra/open-kilda/commit/e7c4e072887c5d36e6364269464a55c1029a124c", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-23T05:05:44Z", "type": "forcePushed"}, {"oid": "1b55947c766bc0934543389c6a4455fd941d93e0", "url": "https://github.com/telstra/open-kilda/commit/1b55947c766bc0934543389c6a4455fd941d93e0", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-23T09:31:05Z", "type": "forcePushed"}, {"oid": "402230b57261632bb03d53263e019a360c844d04", "url": "https://github.com/telstra/open-kilda/commit/402230b57261632bb03d53263e019a360c844d04", "message": "Implementation of smart discovery feature.", "committedDate": "2020-07-30T12:51:05Z", "type": "commit"}, {"oid": "291de8fc40fb9405dd0ae70f86c07a0d99bd8abe", "url": "https://github.com/telstra/open-kilda/commit/291de8fc40fb9405dd0ae70f86c07a0d99bd8abe", "message": "add/refactor tests for smart discovery (#3635)", "committedDate": "2020-07-30T12:51:05Z", "type": "commit"}, {"oid": "291de8fc40fb9405dd0ae70f86c07a0d99bd8abe", "url": "https://github.com/telstra/open-kilda/commit/291de8fc40fb9405dd0ae70f86c07a0d99bd8abe", "message": "add/refactor tests for smart discovery (#3635)", "committedDate": "2020-07-30T12:51:05Z", "type": "forcePushed"}]}