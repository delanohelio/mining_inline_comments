{"pr_number": 3910, "pr_title": "Handle deserialization messages in KafkaVersioning", "pr_createdAt": "2020-12-08T15:21:49Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3910", "timeline": [{"oid": "4d391d584f4ee63f572daf79bf1e929b9d3362e7", "url": "https://github.com/telstra/open-kilda/commit/4d391d584f4ee63f572daf79bf1e929b9d3362e7", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-09T08:09:07Z", "type": "forcePushed"}, {"oid": "d1165e76c4f8bda894bb0683cd4925c15a1b77bd", "url": "https://github.com/telstra/open-kilda/commit/d1165e76c4f8bda894bb0683cd4925c15a1b77bd", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-09T14:36:14Z", "type": "forcePushed"}, {"oid": "a370d26afb2d567f57e31d06d08b6ce8ed9eaa95", "url": "https://github.com/telstra/open-kilda/commit/a370d26afb2d567f57e31d06d08b6ce8ed9eaa95", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-10T07:23:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MTc5NQ==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r540071795", "bodyText": "too abstract", "author": "surabujin", "createdAt": "2020-12-10T10:55:44Z", "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/error/DeserializationErrorMessage.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/* Copyright 2017 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.messaging.error;\n+\n+import static org.openkilda.messaging.Utils.CORRELATION_ID;\n+import static org.openkilda.messaging.Utils.PAYLOAD;\n+import static org.openkilda.messaging.Utils.TIMESTAMP;\n+\n+import org.openkilda.bluegreen.kafka.DeserializationError;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+\n+@JsonSerialize\n+@JsonInclude(JsonInclude.Include.NON_NULL)\n+public class DeserializationErrorMessage extends ErrorMessage implements DeserializationError {\n+\n+    @JsonCreator\n+    public DeserializationErrorMessage(@JsonProperty(PAYLOAD) final ErrorData data,\n+                                       @JsonProperty(TIMESTAMP) final long timestamp,\n+                                       @JsonProperty(CORRELATION_ID) final String correlationId) {\n+        super(data, timestamp, correlationId);\n+    }\n+\n+    @Override\n+    public String getDeserializationErrorMessage() {\n+        return String.format(\"ErrorData: %s, timestamp: %d, correlationId %s\",", "originalCommit": "a370d26afb2d567f57e31d06d08b6ce8ed9eaa95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODgzOTUxNg==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r548839516", "bodyText": "fixed", "author": "niksv", "createdAt": "2020-12-25T09:08:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MTc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MjA1Mg==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r540072052", "bodyText": "too abstract", "author": "surabujin", "createdAt": "2020-12-10T10:56:08Z", "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/error/DeserializationErrorAbstractMessage.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.messaging.error;\n+\n+import org.openkilda.bluegreen.kafka.DeserializationError;\n+\n+import lombok.EqualsAndHashCode;\n+import lombok.Value;\n+\n+@Value\n+@EqualsAndHashCode(callSuper = true)\n+public class DeserializationErrorAbstractMessage extends ErrorAbstractMessage implements DeserializationError {\n+\n+    public DeserializationErrorAbstractMessage(String errorMessage, String errorDescription) {\n+        super(errorMessage, errorDescription);\n+    }\n+\n+    @Override\n+    public String getDeserializationErrorMessage() {\n+        return String.format(\"Error message: %s, Error description: %s\", getErrorMessage(), getErrorDescription());", "originalCommit": "a370d26afb2d567f57e31d06d08b6ce8ed9eaa95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODgzOTcxMQ==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r548839711", "bodyText": "fixed", "author": "niksv", "createdAt": "2020-12-25T09:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MjA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MjU2NA==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r540072564", "bodyText": "Better remove/replace @Value", "author": "surabujin", "createdAt": "2020-12-10T10:56:48Z", "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/error/ErrorAbstractMessage.java", "diffHunk": "@@ -20,12 +20,14 @@\n \n import lombok.EqualsAndHashCode;\n import lombok.Value;\n+import lombok.experimental.NonFinal;\n \n /**\n  * Class represents error abstract message.\n  */\n @Value\n @EqualsAndHashCode(callSuper = false)\n+@NonFinal", "originalCommit": "a370d26afb2d567f57e31d06d08b6ce8ed9eaa95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg0MTAyNA==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r548841024", "bodyText": "fixed", "author": "niksv", "createdAt": "2020-12-25T09:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MjU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MzM3MA==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r540073370", "bodyText": "too abstract", "author": "surabujin", "createdAt": "2020-12-10T10:57:59Z", "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/info/DeserializationErrorInfoData.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.messaging.info;\n+\n+import org.openkilda.bluegreen.kafka.DeserializationError;\n+\n+import lombok.EqualsAndHashCode;\n+import lombok.Value;\n+\n+@Value\n+@EqualsAndHashCode(callSuper = true)\n+public class DeserializationErrorInfoData extends ErrorInfoData implements DeserializationError {\n+\n+    public DeserializationErrorInfoData(String errorMessage, String errorDescription) {\n+        super(errorMessage, errorDescription);\n+    }\n+\n+    @Override\n+    public String getDeserializationErrorMessage() {\n+        return String.format(\"Error message: %s, Error description: %s\", getErrorMessage(), getErrorDescription());", "originalCommit": "a370d26afb2d567f57e31d06d08b6ce8ed9eaa95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg0MTAzNw==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r548841037", "bodyText": "fixed", "author": "niksv", "createdAt": "2020-12-25T09:17:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MzM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA4MTU3MQ==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r540081571", "bodyText": "Why are you analyzing data here?\nIf this record have passed checkRecordVersion() it will be seen to main code and it will / should react property. You do not report anything if record do not pass checkRecordVersion()... I can't say right now is it correct or not.", "author": "surabujin", "createdAt": "2020-12-10T11:10:43Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/kafka/interceptors/VersioningConsumerInterceptor.java", "diffHunk": "@@ -61,6 +63,12 @@ public VersioningConsumerInterceptor() {\n             for (ConsumerRecord<K, V> record : records.records(partition)) {\n                 if (checkRecordVersion(record)) {\n                     filteredRecords.add(record);\n+\n+                    if (record.value() instanceof DeserializationError) {", "originalCommit": "a370d26afb2d567f57e31d06d08b6ce8ed9eaa95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg0MzAyMA==", "url": "https://github.com/telstra/open-kilda/pull/3910#discussion_r548843020", "bodyText": "let me describe the problem. We have 2 versions of kilda: blue and green.\nFor example we added/deleted/changed new field in some message in green version.\nHere is the problem: kafka firstly deserialize a message and only then run interceptor and check version.\nit mean that messages with different kilda will log deserialization error.\nHow we can fix it? just by changing log level because such messaged are false posotive.\nBut what if we really have a deserialization problem inside one Kilda version. For example green network sent to green router some invalid message? we will just miss error log.\nSo I added this analyzation here to log error ONLY for messaged with right kafka version. Because messages with wrong kafka version will have false positive errors.", "author": "niksv", "createdAt": "2020-12-25T09:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA4MTU3MQ=="}], "type": "inlineReview"}, {"oid": "d3da7b76794fb645d1d45f8fbe4436169913e089", "url": "https://github.com/telstra/open-kilda/commit/d3da7b76794fb645d1d45f8fbe4436169913e089", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-11T11:24:30Z", "type": "forcePushed"}, {"oid": "6a5a6b855d7e3f5b5defa8323ba8409b06b477d1", "url": "https://github.com/telstra/open-kilda/commit/6a5a6b855d7e3f5b5defa8323ba8409b06b477d1", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-11T12:52:37Z", "type": "forcePushed"}, {"oid": "595b3c50a9e53dbf519cdc5bfc25fb8434d4e3c4", "url": "https://github.com/telstra/open-kilda/commit/595b3c50a9e53dbf519cdc5bfc25fb8434d4e3c4", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-17T07:32:55Z", "type": "forcePushed"}, {"oid": "2c3ba3a46c818b8a07d64ae9eb406d3a5c89a0d2", "url": "https://github.com/telstra/open-kilda/commit/2c3ba3a46c818b8a07d64ae9eb406d3a5c89a0d2", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-17T12:28:18Z", "type": "forcePushed"}, {"oid": "2afaaba907ce5d203a51f2b33ef6e31d20db2ebf", "url": "https://github.com/telstra/open-kilda/commit/2afaaba907ce5d203a51f2b33ef6e31d20db2ebf", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-21T19:04:05Z", "type": "forcePushed"}, {"oid": "4ac36c724bfa1dbc8cd81d5f491c268e177070a1", "url": "https://github.com/telstra/open-kilda/commit/4ac36c724bfa1dbc8cd81d5f491c268e177070a1", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-21T19:19:27Z", "type": "forcePushed"}, {"oid": "d286fcaf989e33a530bad8ceb3802d370ae9e41d", "url": "https://github.com/telstra/open-kilda/commit/d286fcaf989e33a530bad8ceb3802d370ae9e41d", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-23T05:30:52Z", "type": "forcePushed"}, {"oid": "71dc7ddd682723d845af855d763256a15b346d88", "url": "https://github.com/telstra/open-kilda/commit/71dc7ddd682723d845af855d763256a15b346d88", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-25T09:30:02Z", "type": "forcePushed"}, {"oid": "17823fe3223d2f70853d87765f1bce9d3d736c48", "url": "https://github.com/telstra/open-kilda/commit/17823fe3223d2f70853d87765f1bce9d3d736c48", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-25T09:57:10Z", "type": "commit"}, {"oid": "17823fe3223d2f70853d87765f1bce9d3d736c48", "url": "https://github.com/telstra/open-kilda/commit/17823fe3223d2f70853d87765f1bce9d3d736c48", "message": "Handle deserialization messages in KafkaVersioning", "committedDate": "2020-12-25T09:57:10Z", "type": "forcePushed"}]}