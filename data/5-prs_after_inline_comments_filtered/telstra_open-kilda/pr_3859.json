{"pr_number": 3859, "pr_title": "Zero downtime", "pr_createdAt": "2020-11-18T15:55:11Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3859", "timeline": [{"oid": "33ff97d9f0b4bf8eb2eddd8a714bab476e770836", "url": "https://github.com/telstra/open-kilda/commit/33ff97d9f0b4bf8eb2eddd8a714bab476e770836", "message": "Shared storm components for zero downtime", "committedDate": "2020-11-18T21:11:24Z", "type": "forcePushed"}, {"oid": "84cf0502f83c3562287c2946ace489083f5816a2", "url": "https://github.com/telstra/open-kilda/commit/84cf0502f83c3562287c2946ace489083f5816a2", "message": "Shared storm components for zero downtime", "committedDate": "2020-11-24T10:31:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2NDQ1Ng==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r529464456", "bodyText": "What it received 2 events during waiting?\n\nZK send event1\nwe store it into event field\nZK send event2\nwe store it into event field\nSomeone ask spout to pull message.\nwe send only event2 because we replaced event1 on step 4\n\nI think we need synchronized queue here", "author": "niksv", "createdAt": "2020-11-24T11:11:48Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperSpout.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifeCycleObserver;\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.Signal;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+import org.openkilda.wfm.AbstractBolt;\n+import org.openkilda.wfm.CommandContext;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.storm.spout.SpoutOutputCollector;\n+import org.apache.storm.task.TopologyContext;\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.topology.base.BaseRichSpout;\n+import org.apache.storm.tuple.Fields;\n+import org.apache.storm.tuple.Values;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.UUID;\n+\n+@Slf4j\n+public class ZooKeeperSpout extends BaseRichSpout implements LifeCycleObserver {\n+    public static final String BOLT_ID = \"zookeeper.spout\";\n+    public static final String FIELD_ID_LIFECYCLE_EVENT = \"lifecycle.event\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+\n+    private ZkWatchDog watchDog;\n+    private SpoutOutputCollector collector;\n+    private LifecycleEvent event;\n+    private boolean newEvent = false;\n+    private long messageId = 0;\n+\n+\n+    public ZooKeeperSpout(String id, String serviceName, String connectionString) {\n+        this.id = id;\n+        this.serviceName = serviceName;\n+        this.connectionString = connectionString;\n+    }\n+\n+    @Override\n+    public void open(Map conf, TopologyContext context, SpoutOutputCollector collector) {\n+        this.collector = collector;\n+        try {\n+            this.watchDog = ZkWatchDog.builder().id(id).serviceName(serviceName)\n+                    .connectionString(connectionString).build();\n+            watchDog.subscribe(this);\n+        } catch (IOException e) {\n+            log.error(\"Failed to init ZooKeeper with connection string: {} received: {} \", connectionString,\n+                    e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void nextTuple() {\n+        if (event != null && newEvent) {", "originalCommit": "84cf0502f83c3562287c2946ace489083f5816a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2NTU2OA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r529465568", "bodyText": "should event and newEvent be volatile or have syncronized access because we have 2 threads here (one for handle() and one for nextTupple())?", "author": "niksv", "createdAt": "2020-11-24T11:13:36Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperSpout.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifeCycleObserver;\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.Signal;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+import org.openkilda.wfm.AbstractBolt;\n+import org.openkilda.wfm.CommandContext;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.storm.spout.SpoutOutputCollector;\n+import org.apache.storm.task.TopologyContext;\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.topology.base.BaseRichSpout;\n+import org.apache.storm.tuple.Fields;\n+import org.apache.storm.tuple.Values;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.UUID;\n+\n+@Slf4j\n+public class ZooKeeperSpout extends BaseRichSpout implements LifeCycleObserver {\n+    public static final String BOLT_ID = \"zookeeper.spout\";\n+    public static final String FIELD_ID_LIFECYCLE_EVENT = \"lifecycle.event\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+\n+    private ZkWatchDog watchDog;\n+    private SpoutOutputCollector collector;\n+    private LifecycleEvent event;\n+    private boolean newEvent = false;", "originalCommit": "84cf0502f83c3562287c2946ace489083f5816a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUwMjk4NA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r529502984", "bodyText": "I guess it should be.", "author": "dpoltavets", "createdAt": "2020-11-24T12:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2NTU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwNDk1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r530804953", "bodyText": "I've changed logic here, field is replaced with a queue", "author": "timofei-durakov", "createdAt": "2020-11-26T06:50:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2NTU2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2NzQ2NQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r529467465", "bodyText": "nit: 2 empty lines", "author": "niksv", "createdAt": "2020-11-24T11:16:49Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkClient.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.experimental.SuperBuilder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.CreateMode;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.Watcher;\n+import org.apache.zookeeper.Watcher.Event.KeeperState;\n+import org.apache.zookeeper.ZooDefs.Ids;\n+import org.apache.zookeeper.ZooKeeper;\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+\n+@SuperBuilder\n+@Slf4j\n+public abstract class ZkClient implements Watcher {\n+    private static final String ROOT = \"/\";\n+    private static final int DEFAULT_SESSION_TIMEOUT = 30000;\n+\n+    protected String id;\n+    protected String serviceName;\n+    protected ZooKeeper zookeeper;\n+    private final String connectionString;\n+    private final int sessionTimeout;\n+\n+    public ZkClient(String id, String serviceName, String connectionString,\n+                    int sessionTimeout) throws IOException {\n+        if (sessionTimeout == 0) {\n+            sessionTimeout = DEFAULT_SESSION_TIMEOUT;\n+        }\n+        this.serviceName = serviceName;\n+        this.id = id;\n+        this.zookeeper = getZk();\n+        this.connectionString = connectionString;\n+        this.sessionTimeout = sessionTimeout;\n+    }\n+\n+    void initWatch() {\n+\n+    }\n+\n+    String getPaths(String... paths) {\n+        return Paths.get(ROOT, paths).toString();\n+    }\n+\n+    boolean refreshConnection(KeeperState state) throws IOException {\n+        if (state == KeeperState.Disconnected || state == KeeperState.Expired) {\n+            zookeeper = getZk();\n+            initWatch();\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    protected ZooKeeper getZk() throws IOException {\n+        return new ZooKeeper(connectionString, sessionTimeout, this);\n+    }\n+\n+    protected void ensureZNode(String... path) throws KeeperException, InterruptedException {\n+        String nodePath = getPaths(path);\n+        if (zookeeper.exists(nodePath, false) == null) {\n+            try {\n+                zookeeper.create(nodePath, \"\".getBytes(),\n+                        Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n+            } catch (Exception e) {\n+                // pass\n+            }\n+        }\n+        if (zookeeper.exists(nodePath, false) == null) {\n+            String message = String.format(\"Zk node %s still does not exists\", nodePath);\n+            log.error(message);\n+            throw new IllegalStateException(message);\n+        }\n+    }\n+\n+    void validateNodes() throws KeeperException, InterruptedException {\n+        ensureZNode(serviceName);\n+        ensureZNode(serviceName, id);\n+    }\n+\n+}\n+\n+", "originalCommit": "84cf0502f83c3562287c2946ace489083f5816a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2ODgwNw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r529468807", "bodyText": "nit: empty lines", "author": "niksv", "createdAt": "2020-11-24T11:19:05Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {\n+\n+    private static final String SIGNAL = \"signal\";\n+    @VisibleForTesting\n+    protected String signalPath;\n+    private Signal signal;\n+\n+    @VisibleForTesting\n+    Set<LifeCycleObserver> observers = new HashSet<>();\n+\n+    @Builder\n+    public ZkWatchDog(String id, String serviceName, String connectionString,\n+                      int sessionTimeout, Signal signal) throws IOException {\n+        super(id, serviceName, connectionString, sessionTimeout);\n+\n+        signalPath = getPaths(serviceName, id, SIGNAL);\n+        if (signal == null) {\n+            signal = Signal.NONE;\n+        }\n+        this.signal = signal;\n+        initWatch();\n+    }\n+\n+    @Override\n+    void validateNodes() throws KeeperException, InterruptedException {\n+        super.validateNodes();\n+        ensureZNode(serviceName, id, SIGNAL);\n+    }\n+\n+\n+    @VisibleForTesting\n+    void checkSignal() throws KeeperException, InterruptedException {\n+        zookeeper.getData(signalPath, this, this, null);\n+    }\n+\n+    @Override\n+    void initWatch() {\n+        try {\n+            validateNodes();\n+            checkSignal();\n+        } catch (KeeperException e) {\n+            log.error(e.getMessage(), e);\n+        } catch (InterruptedException e) {\n+            log.error(e.getMessage(), e);\n+        }\n+    }\n+\n+\n+    @Override\n+    public void subscribe(LifeCycleObserver observer) {\n+        observers.add(observer);\n+    }\n+\n+    @Override\n+    public void unsubscribe(LifeCycleObserver observer) {\n+        if (observers.contains(observer)) {\n+            observers.remove(observer);\n+        }\n+    }\n+\n+    @Override\n+    public void process(WatchedEvent event) {\n+        log.info(\"Received event: {}\", event);\n+        try {\n+            if (!refreshConnection(event.getState()) && signalPath.equals(event.getPath())) {\n+                checkSignal();\n+            }\n+        } catch (IOException e) {\n+            log.error(\"Failed to read zk event: {}\", e.getMessage(), e);\n+        } catch (InterruptedException e) {\n+            log.error(\"Zk event interrupted: {}\", e.getMessage(), e);\n+        } catch (KeeperException e) {\n+            log.error(\"Zk keeper error: {}\", e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {\n+        log.debug(\"Received result on path: {}\", path);\n+        if (signalPath.equals(path) && data != null && data.length > 0) {\n+            String signalString = new String(data);\n+            try {\n+                signal = Signal.valueOf(signalString);\n+                notifyObservers();\n+            } catch (Exception e) {\n+                log.error(\"Received unknown signal: {}\", signalString, e);\n+            }\n+        }\n+    }\n+\n+    protected void notifyObservers() {\n+        for (LifeCycleObserver observer : observers) {\n+            observer.handle(signal);\n+        }\n+    }\n+\n+}\n+\n+\n+", "originalCommit": "84cf0502f83c3562287c2946ace489083f5816a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fac6383b43aec597d8607f1267ed966396651cc0", "url": "https://github.com/telstra/open-kilda/commit/fac6383b43aec597d8607f1267ed966396651cc0", "message": "Shared storm components for zero downtime", "committedDate": "2020-11-25T07:34:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyNDQzNw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r530324437", "bodyText": "Please put this at the end of the constructor. Or pass parameters as arguments. Otherwise, we get NPE.", "author": "dpoltavets", "createdAt": "2020-11-25T12:06:11Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkClient.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.experimental.SuperBuilder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.CreateMode;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.Watcher;\n+import org.apache.zookeeper.Watcher.Event.KeeperState;\n+import org.apache.zookeeper.ZooDefs.Ids;\n+import org.apache.zookeeper.ZooKeeper;\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+\n+@SuperBuilder\n+@Slf4j\n+public abstract class ZkClient implements Watcher {\n+    private static final String ROOT = \"/\";\n+    private static final int DEFAULT_SESSION_TIMEOUT = 30000;\n+\n+    protected String id;\n+    protected String serviceName;\n+    protected ZooKeeper zookeeper;\n+    private final String connectionString;\n+    private final int sessionTimeout;\n+\n+    public ZkClient(String id, String serviceName, String connectionString,\n+                    int sessionTimeout) throws IOException {\n+        if (sessionTimeout == 0) {\n+            sessionTimeout = DEFAULT_SESSION_TIMEOUT;\n+        }\n+        this.serviceName = serviceName;\n+        this.id = id;\n+        this.zookeeper = getZk();", "originalCommit": "fac6383b43aec597d8607f1267ed966396651cc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4eebe147fb735f540492706fb599c88f904c9ac7", "url": "https://github.com/telstra/open-kilda/commit/4eebe147fb735f540492706fb599c88f904c9ac7", "message": "Shared storm components for zero downtime", "committedDate": "2020-11-25T12:11:14Z", "type": "forcePushed"}, {"oid": "f9d3eae6b522cad71a278bcef6bce4fc1361a339", "url": "https://github.com/telstra/open-kilda/commit/f9d3eae6b522cad71a278bcef6bce4fc1361a339", "message": "Shared storm components for zero downtime", "committedDate": "2020-11-26T06:44:17Z", "type": "forcePushed"}, {"oid": "41efcd4f747c16e14d9bac4289de4b5b298d152d", "url": "https://github.com/telstra/open-kilda/commit/41efcd4f747c16e14d9bac4289de4b5b298d152d", "message": "Shared storm components for zero downtime", "committedDate": "2020-11-26T06:51:34Z", "type": "forcePushed"}, {"oid": "a80705d91d6096ba7643d905a16de1f81ca824ef", "url": "https://github.com/telstra/open-kilda/commit/a80705d91d6096ba7643d905a16de1f81ca824ef", "message": "Shared storm components for zero downtime", "committedDate": "2020-11-27T11:01:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3NjkwMQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r531576901", "bodyText": "It's counter or control?", "author": "rozdy", "createdAt": "2020-11-27T12:34:36Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/TopologyState.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifecycleEvent;\n+\n+import lombok.Builder;\n+import lombok.Data;\n+\n+import java.util.UUID;\n+\n+@Data\n+@Builder\n+public class TopologyState {\n+    private UUID uuid;\n+    private long cntr;", "originalCommit": "a80705d91d6096ba7643d905a16de1f81ca824ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMjgzNw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r532002837", "bodyText": "removed this class, left over from one of the previous PoCs", "author": "timofei-durakov", "createdAt": "2020-11-28T08:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3NjkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3OTg1OQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r531579859", "bodyText": "Why do we need double increment for message id here?", "author": "rozdy", "createdAt": "2020-11-27T12:40:58Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperSpout.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifeCycleObserver;\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.Signal;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+import org.openkilda.wfm.AbstractBolt;\n+import org.openkilda.wfm.CommandContext;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.storm.spout.SpoutOutputCollector;\n+import org.apache.storm.task.TopologyContext;\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.topology.base.BaseRichSpout;\n+import org.apache.storm.tuple.Fields;\n+import org.apache.storm.tuple.Values;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Queue;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+@Slf4j\n+public class ZooKeeperSpout extends BaseRichSpout implements LifeCycleObserver {\n+    public static final String BOLT_ID = \"zookeeper.spout\";\n+    public static final String FIELD_ID_LIFECYCLE_EVENT = \"lifecycle.event\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+    private Queue<Signal> signals;\n+\n+    private ZkWatchDog watchDog;\n+    private SpoutOutputCollector collector;\n+    private long messageId = 0;\n+\n+\n+    public ZooKeeperSpout(String id, String serviceName, String connectionString) {\n+        this.id = id;\n+        this.serviceName = serviceName;\n+        this.connectionString = connectionString;\n+    }\n+\n+    @Override\n+    public void open(Map conf, TopologyContext context, SpoutOutputCollector collector) {\n+        this.collector = collector;\n+        this.signals = new ConcurrentLinkedQueue<>();\n+        try {\n+            this.watchDog = ZkWatchDog.builder().id(id).serviceName(serviceName)\n+                    .connectionString(connectionString).build();\n+            watchDog.subscribe(this);\n+        } catch (IOException e) {\n+            log.error(\"Failed to init ZooKeeper with connection string: {} received: {} \", connectionString,\n+                    e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void nextTuple() {\n+        Signal signal = signals.poll();\n+        if (signal != null) {\n+            LifecycleEvent event = LifecycleEvent.builder()\n+                    .signal(signal)\n+                    .uuid(UUID.randomUUID())\n+                    .messageId(messageId++).build();\n+            collector.emit(new Values(event, new CommandContext()), messageId++);", "originalCommit": "a80705d91d6096ba7643d905a16de1f81ca824ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMjc4Nw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r532002787", "bodyText": "it's a common practice as far as I understand, it allows storm to maintain emitted tuples", "author": "timofei-durakov", "createdAt": "2020-11-28T08:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3OTg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NTAyMg==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r531585022", "bodyText": "Have you tried Curator framework instead of raw ZK client? https://curator.apache.org/", "author": "rozdy", "createdAt": "2020-11-27T12:52:36Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkClient.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.experimental.SuperBuilder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.CreateMode;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.Watcher;\n+import org.apache.zookeeper.Watcher.Event.KeeperState;\n+import org.apache.zookeeper.ZooDefs.Ids;\n+import org.apache.zookeeper.ZooKeeper;\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+\n+@SuperBuilder\n+@Slf4j\n+public abstract class ZkClient implements Watcher {\n+    private static final String ROOT = \"/\";\n+    private static final int DEFAULT_SESSION_TIMEOUT = 30000;\n+\n+    protected String id;\n+    protected String serviceName;\n+    protected ZooKeeper zookeeper;\n+    private final String connectionString;\n+    private final int sessionTimeout;\n+\n+    public ZkClient(String id, String serviceName, String connectionString,\n+                    int sessionTimeout) throws IOException {\n+        if (sessionTimeout == 0) {\n+            sessionTimeout = DEFAULT_SESSION_TIMEOUT;\n+        }\n+        this.serviceName = serviceName;\n+        this.id = id;\n+        this.connectionString = connectionString;\n+        this.sessionTimeout = sessionTimeout;\n+        this.zookeeper = getZk();\n+    }\n+\n+    void initWatch() {\n+\n+    }\n+\n+    String getPaths(String... paths) {\n+        return Paths.get(ROOT, paths).toString();\n+    }\n+\n+    boolean refreshConnection(KeeperState state) throws IOException {\n+        if (state == KeeperState.Disconnected || state == KeeperState.Expired) {\n+            zookeeper = getZk();\n+            initWatch();\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    protected ZooKeeper getZk() throws IOException {\n+        return new ZooKeeper(connectionString, sessionTimeout, this);\n+    }\n+\n+    protected void ensureZNode(String... path) throws KeeperException, InterruptedException {\n+        String nodePath = getPaths(path);\n+        if (zookeeper.exists(nodePath, false) == null) {\n+            try {\n+                zookeeper.create(nodePath, \"\".getBytes(),\n+                        Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);", "originalCommit": "a80705d91d6096ba7643d905a16de1f81ca824ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMjk1MA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r532002950", "bodyText": "I've checked, well, curator is very cool for complex problems like here https://curator.apache.org/curator-recipes/index.html\nnot sure our case is the one", "author": "timofei-durakov", "createdAt": "2020-11-28T08:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NTAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3ODcwMg==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535178702", "bodyText": "exists + create - classical race condition.", "author": "surabujin", "createdAt": "2020-12-03T12:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NTAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NTk2Mg==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r531585962", "bodyText": "Please use active++ for similarity", "author": "rozdy", "createdAt": "2020-11-27T12:54:45Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkStateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.UUID;\n+\n+@Slf4j\n+public class ZkStateTracker {\n+    private ZkWriter zooKeeperWriter;\n+    UUID shutdownUuid;\n+    UUID startUuid;\n+    int active;\n+\n+    public ZkStateTracker(ZkWriter zooKeeperWriter) {\n+        this.zooKeeperWriter = zooKeeperWriter;\n+    }\n+\n+    /**\n+     * Process new lifecycle event.\n+     */\n+    public void processLifecycleEvent(LifecycleEvent event) {\n+        if (Signal.START == event.getSignal()) {\n+            shutdownUuid = null;\n+            handleStart(event);\n+        } else if (Signal.SHUTDOWN == event.getSignal()) {\n+            handleShutdown(event);\n+            startUuid = null;\n+        }\n+        zooKeeperWriter.setState(active);\n+    }\n+\n+    private void handleStart(LifecycleEvent event) {\n+        if (startUuid != null) {\n+            if (startUuid.equals(event.getUuid())) {\n+                active++;\n+\n+            } else {\n+                startUuid = event.getUuid();\n+                active = 1;\n+            }\n+        } else {\n+            startUuid = event.getUuid();\n+            active += 1;", "originalCommit": "a80705d91d6096ba7643d905a16de1f81ca824ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NjMzMg==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r531586332", "bodyText": "Add more details to error message please", "author": "rozdy", "createdAt": "2020-11-27T12:55:37Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkStateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.UUID;\n+\n+@Slf4j\n+public class ZkStateTracker {\n+    private ZkWriter zooKeeperWriter;\n+    UUID shutdownUuid;\n+    UUID startUuid;\n+    int active;\n+\n+    public ZkStateTracker(ZkWriter zooKeeperWriter) {\n+        this.zooKeeperWriter = zooKeeperWriter;\n+    }\n+\n+    /**\n+     * Process new lifecycle event.\n+     */\n+    public void processLifecycleEvent(LifecycleEvent event) {\n+        if (Signal.START == event.getSignal()) {\n+            shutdownUuid = null;\n+            handleStart(event);\n+        } else if (Signal.SHUTDOWN == event.getSignal()) {\n+            handleShutdown(event);\n+            startUuid = null;\n+        }\n+        zooKeeperWriter.setState(active);\n+    }\n+\n+    private void handleStart(LifecycleEvent event) {\n+        if (startUuid != null) {\n+            if (startUuid.equals(event.getUuid())) {\n+                active++;\n+\n+            } else {\n+                startUuid = event.getUuid();\n+                active = 1;\n+            }\n+        } else {\n+            startUuid = event.getUuid();\n+            active += 1;\n+        }\n+    }\n+\n+    private void handleShutdown(LifecycleEvent event) {\n+        if (shutdownUuid != null) {\n+            if (shutdownUuid.equals(event.getUuid())) {\n+                active--;\n+            } else {\n+                log.error(\"new uuid\");", "originalCommit": "a80705d91d6096ba7643d905a16de1f81ca824ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NzM1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r531587353", "bodyText": "You can use pipe for exceptions here", "author": "rozdy", "createdAt": "2020-11-27T12:57:52Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {\n+\n+    private static final String SIGNAL = \"signal\";\n+    @VisibleForTesting\n+    protected String signalPath;\n+    private Signal signal;\n+\n+    @VisibleForTesting\n+    Set<LifeCycleObserver> observers = new HashSet<>();\n+\n+    @Builder\n+    public ZkWatchDog(String id, String serviceName, String connectionString,\n+                      int sessionTimeout, Signal signal) throws IOException {\n+        super(id, serviceName, connectionString, sessionTimeout);\n+\n+        signalPath = getPaths(serviceName, id, SIGNAL);\n+        if (signal == null) {\n+            signal = Signal.NONE;\n+        }\n+        this.signal = signal;\n+        initWatch();\n+    }\n+\n+    @Override\n+    void validateNodes() throws KeeperException, InterruptedException {\n+        super.validateNodes();\n+        ensureZNode(serviceName, id, SIGNAL);\n+    }\n+\n+\n+    @VisibleForTesting\n+    void checkSignal() throws KeeperException, InterruptedException {\n+        zookeeper.getData(signalPath, this, this, null);\n+    }\n+\n+    @Override\n+    void initWatch() {\n+        try {\n+            validateNodes();\n+            checkSignal();\n+        } catch (KeeperException e) {\n+            log.error(e.getMessage(), e);\n+        } catch (InterruptedException e) {\n+            log.error(e.getMessage(), e);", "originalCommit": "a80705d91d6096ba7643d905a16de1f81ca824ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5NDUyMg==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535194522", "bodyText": "As far as I understand it sleeps into checkSignal call... what should happen when we exit this \"wait\" or when we exit initWatch (by happy or by error path)?..\nLooks extremely messy, can we move all processing into process method?", "author": "surabujin", "createdAt": "2020-12-03T12:40:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NzM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4ODE1NQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r531588155", "bodyText": "This check isn't required", "author": "rozdy", "createdAt": "2020-11-27T12:59:34Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {\n+\n+    private static final String SIGNAL = \"signal\";\n+    @VisibleForTesting\n+    protected String signalPath;\n+    private Signal signal;\n+\n+    @VisibleForTesting\n+    Set<LifeCycleObserver> observers = new HashSet<>();\n+\n+    @Builder\n+    public ZkWatchDog(String id, String serviceName, String connectionString,\n+                      int sessionTimeout, Signal signal) throws IOException {\n+        super(id, serviceName, connectionString, sessionTimeout);\n+\n+        signalPath = getPaths(serviceName, id, SIGNAL);\n+        if (signal == null) {\n+            signal = Signal.NONE;\n+        }\n+        this.signal = signal;\n+        initWatch();\n+    }\n+\n+    @Override\n+    void validateNodes() throws KeeperException, InterruptedException {\n+        super.validateNodes();\n+        ensureZNode(serviceName, id, SIGNAL);\n+    }\n+\n+\n+    @VisibleForTesting\n+    void checkSignal() throws KeeperException, InterruptedException {\n+        zookeeper.getData(signalPath, this, this, null);\n+    }\n+\n+    @Override\n+    void initWatch() {\n+        try {\n+            validateNodes();\n+            checkSignal();\n+        } catch (KeeperException e) {\n+            log.error(e.getMessage(), e);\n+        } catch (InterruptedException e) {\n+            log.error(e.getMessage(), e);\n+        }\n+    }\n+\n+\n+    @Override\n+    public void subscribe(LifeCycleObserver observer) {\n+        observers.add(observer);\n+    }\n+\n+    @Override\n+    public void unsubscribe(LifeCycleObserver observer) {\n+        if (observers.contains(observer)) {", "originalCommit": "a80705d91d6096ba7643d905a16de1f81ca824ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMjk5OQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r532002999", "bodyText": "let it be here", "author": "timofei-durakov", "createdAt": "2020-11-28T08:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4ODE1NQ=="}], "type": "inlineReview"}, {"oid": "0aaa49782d66ca1b52627f652714a690402abb07", "url": "https://github.com/telstra/open-kilda/commit/0aaa49782d66ca1b52627f652714a690402abb07", "message": "Shared storm components for zero downtime", "committedDate": "2020-11-28T07:54:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxOTI0OA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r532819248", "bodyText": "prefer to up level to error", "author": "nikitamarchenko", "createdAt": "2020-11-30T18:45:06Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/AbstractBolt.java", "diffHunk": "@@ -104,6 +109,18 @@ protected void dispatch(Tuple input) throws Exception {\n \n     protected abstract void handleInput(Tuple input) throws Exception;\n \n+    protected void handleLifeCycleEvent(LifecycleEvent event) {\n+        if (Signal.START.equals(event.getSignal())) {\n+            active = true;\n+            emit(ZkStreams.ZK.toString(), currentTuple, new Values(event, commandContext));\n+        } else if (Signal.SHUTDOWN.equals(event.getSignal())) {\n+            active = false;\n+            emit(ZkStreams.ZK.toString(), currentTuple, new Values(event, commandContext));\n+        } else {\n+            log.info(\"Unsupported signal received: {}\", event.getSignal());", "originalCommit": "0aaa49782d66ca1b52627f652714a690402abb07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MjYzMQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r533392631", "bodyText": "fixed", "author": "timofei-durakov", "createdAt": "2020-12-01T13:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxOTI0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMDgzMw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r532820833", "bodyText": "log null as error", "author": "nikitamarchenko", "createdAt": "2020-11-30T18:47:39Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperBolt.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.wfm.AbstractBolt;\n+\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.tuple.Tuple;\n+import org.apache.zookeeper.KeeperException;\n+\n+import java.io.IOException;\n+\n+public class ZooKeeperBolt extends AbstractBolt {\n+    public static final String BOLT_ID = \"zookeeper.bolt\";\n+    public static final String FIELD_ID_STATE = \"lifecycle.state\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+    private ZkWriter zkWriter;\n+    private ZkStateTracker zkStateTracker;\n+\n+    public ZooKeeperBolt(String id, String serviceName, String connectionString) {\n+        this.id = id;\n+        this.serviceName = serviceName;\n+        this.connectionString = connectionString;\n+    }\n+\n+    @Override\n+    protected void handleInput(Tuple input) throws Exception {\n+        try {\n+            LifecycleEvent event = (LifecycleEvent) input.getValueByField(FIELD_ID_STATE);\n+            if (event != null) {\n+                zkStateTracker.processLifecycleEvent(event);\n+            }", "originalCommit": "0aaa49782d66ca1b52627f652714a690402abb07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MjY3Mw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r533392673", "bodyText": "fixed", "author": "timofei-durakov", "createdAt": "2020-12-01T13:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMDgzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMTc0Mw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r532821743", "bodyText": "do we plan reconnect it?", "author": "nikitamarchenko", "createdAt": "2020-11-30T18:49:16Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperBolt.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.wfm.AbstractBolt;\n+\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.tuple.Tuple;\n+import org.apache.zookeeper.KeeperException;\n+\n+import java.io.IOException;\n+\n+public class ZooKeeperBolt extends AbstractBolt {\n+    public static final String BOLT_ID = \"zookeeper.bolt\";\n+    public static final String FIELD_ID_STATE = \"lifecycle.state\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+    private ZkWriter zkWriter;\n+    private ZkStateTracker zkStateTracker;\n+\n+    public ZooKeeperBolt(String id, String serviceName, String connectionString) {\n+        this.id = id;\n+        this.serviceName = serviceName;\n+        this.connectionString = connectionString;\n+    }\n+\n+    @Override\n+    protected void handleInput(Tuple input) throws Exception {\n+        try {\n+            LifecycleEvent event = (LifecycleEvent) input.getValueByField(FIELD_ID_STATE);\n+            if (event != null) {\n+                zkStateTracker.processLifecycleEvent(event);\n+            }\n+\n+        } catch (Exception e) {\n+            log.error(\"failed to process event: {}\", e.getMessage(), e);\n+        }\n+\n+    }\n+\n+    @Override\n+    protected void init() {\n+        try {\n+            zkWriter = ZkWriter.builder().id(id).serviceName(serviceName)\n+                .connectionString(connectionString).build();\n+            zkStateTracker = new ZkStateTracker(zkWriter);\n+        } catch (IOException | InterruptedException | KeeperException e) {\n+            log.error(\"Failed to init ZooKeeper with connection string: {}, received: {} \", connectionString,", "originalCommit": "0aaa49782d66ca1b52627f652714a690402abb07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5Mjc2NA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r533392764", "bodyText": "yes, added", "author": "timofei-durakov", "createdAt": "2020-12-01T13:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMTc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyNDM2Mw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r532824363", "bodyText": "add error log here", "author": "nikitamarchenko", "createdAt": "2020-11-30T18:53:46Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkClient.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.experimental.SuperBuilder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.CreateMode;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.Watcher;\n+import org.apache.zookeeper.Watcher.Event.KeeperState;\n+import org.apache.zookeeper.ZooDefs.Ids;\n+import org.apache.zookeeper.ZooKeeper;\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+\n+@SuperBuilder\n+@Slf4j\n+public abstract class ZkClient implements Watcher {\n+    private static final String ROOT = \"/\";\n+    private static final int DEFAULT_SESSION_TIMEOUT = 30000;\n+\n+    protected String id;\n+    protected String serviceName;\n+    protected ZooKeeper zookeeper;\n+    private final String connectionString;\n+    private final int sessionTimeout;\n+\n+    public ZkClient(String id, String serviceName, String connectionString,\n+                    int sessionTimeout) throws IOException {\n+        if (sessionTimeout == 0) {\n+            sessionTimeout = DEFAULT_SESSION_TIMEOUT;\n+        }\n+        this.serviceName = serviceName;\n+        this.id = id;\n+        this.connectionString = connectionString;\n+        this.sessionTimeout = sessionTimeout;\n+        this.zookeeper = getZk();\n+    }\n+\n+    void initWatch() {\n+\n+    }\n+\n+    String getPaths(String... paths) {\n+        return Paths.get(ROOT, paths).toString();\n+    }\n+\n+    boolean refreshConnection(KeeperState state) throws IOException {\n+        if (state == KeeperState.Disconnected || state == KeeperState.Expired) {\n+            zookeeper = getZk();\n+            initWatch();\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    protected ZooKeeper getZk() throws IOException {\n+        return new ZooKeeper(connectionString, sessionTimeout, this);\n+    }\n+\n+    protected void ensureZNode(String... path) throws KeeperException, InterruptedException {\n+        String nodePath = getPaths(path);\n+        if (zookeeper.exists(nodePath, false) == null) {\n+            try {\n+                zookeeper.create(nodePath, \"\".getBytes(),\n+                        Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n+            } catch (Exception e) {\n+                // pass", "originalCommit": "0aaa49782d66ca1b52627f652714a690402abb07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MjgzNw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r533392837", "bodyText": "done", "author": "timofei-durakov", "createdAt": "2020-12-01T13:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyNDM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEwNjYxMA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r533106610", "bodyText": "If you will get any exception in notifyObservers(); you will log (for example)\nReceived unknown signal: START\"\nBut START is a valid signal", "author": "niksv", "createdAt": "2020-12-01T06:47:06Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {\n+\n+    private static final String SIGNAL = \"signal\";\n+    @VisibleForTesting\n+    protected String signalPath;\n+    private Signal signal;\n+\n+    @VisibleForTesting\n+    Set<LifeCycleObserver> observers = new HashSet<>();\n+\n+    @Builder\n+    public ZkWatchDog(String id, String serviceName, String connectionString,\n+                      int sessionTimeout, Signal signal) throws IOException {\n+        super(id, serviceName, connectionString, sessionTimeout);\n+\n+        signalPath = getPaths(serviceName, id, SIGNAL);\n+        if (signal == null) {\n+            signal = Signal.NONE;\n+        }\n+        this.signal = signal;\n+        initWatch();\n+    }\n+\n+    @Override\n+    void validateNodes() throws KeeperException, InterruptedException {\n+        super.validateNodes();\n+        ensureZNode(serviceName, id, SIGNAL);\n+    }\n+\n+\n+    @VisibleForTesting\n+    void checkSignal() throws KeeperException, InterruptedException {\n+        zookeeper.getData(signalPath, this, this, null);\n+    }\n+\n+    @Override\n+    void initWatch() {\n+        try {\n+            validateNodes();\n+            checkSignal();\n+        } catch (KeeperException | InterruptedException e) {\n+            log.error(e.getMessage(), e);\n+        }\n+    }\n+\n+\n+    @Override\n+    public void subscribe(LifeCycleObserver observer) {\n+        observers.add(observer);\n+    }\n+\n+    @Override\n+    public void unsubscribe(LifeCycleObserver observer) {\n+        if (observers.contains(observer)) {\n+            observers.remove(observer);\n+        }\n+    }\n+\n+    @Override\n+    public void process(WatchedEvent event) {\n+        log.info(\"Received event: {}\", event);\n+        try {\n+            if (!refreshConnection(event.getState()) && signalPath.equals(event.getPath())) {\n+                checkSignal();\n+            }\n+        } catch (IOException e) {\n+            log.error(\"Failed to read zk event: {}\", e.getMessage(), e);\n+        } catch (InterruptedException e) {\n+            log.error(\"Zk event interrupted: {}\", e.getMessage(), e);\n+        } catch (KeeperException e) {\n+            log.error(\"Zk keeper error: {}\", e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {\n+        log.debug(\"Received result on path: {}\", path);\n+        if (signalPath.equals(path) && data != null && data.length > 0) {\n+            String signalString = new String(data);\n+            try {\n+                signal = Signal.valueOf(signalString);\n+                notifyObservers();\n+            } catch (Exception e) {\n+                log.error(\"Received unknown signal: {}\", signalString, e);", "originalCommit": "0aaa49782d66ca1b52627f652714a690402abb07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5Mjk1OA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r533392958", "bodyText": "changed", "author": "timofei-durakov", "createdAt": "2020-12-01T13:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEwNjYxMA=="}], "type": "inlineReview"}, {"oid": "3b3d88730b21113ea03d970f574d740f317346b7", "url": "https://github.com/telstra/open-kilda/commit/3b3d88730b21113ea03d970f574d740f317346b7", "message": "Shared storm components for zero downtime", "committedDate": "2020-12-01T12:08:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTEzNjIxNA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535136214", "bodyText": "You are breaking stream responsibilities. In your implementation, the code emitting event in the stream do not relate with the code responsible for creating that stream with specific name and set of fields.\nDelegate message emmitting into abstract method or define/create required stream(s) into this abstract bolt.", "author": "surabujin", "createdAt": "2020-12-03T11:31:28Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/AbstractBolt.java", "diffHunk": "@@ -104,6 +109,18 @@ protected void dispatch(Tuple input) throws Exception {\n \n     protected abstract void handleInput(Tuple input) throws Exception;\n \n+    protected void handleLifeCycleEvent(LifecycleEvent event) {\n+        if (Signal.START.equals(event.getSignal())) {\n+            active = true;\n+            emit(ZkStreams.ZK.toString(), currentTuple, new Values(event, commandContext));", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0NDkxNg==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535244916", "bodyText": "I'll do a refactoring of all bolts in kilda in a separate pr, since they are not calling super.declareOutputFields() and declared this stream as a one of abstract bolts", "author": "timofei-durakov", "createdAt": "2020-12-03T13:54:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTEzNjIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTEzNzc1MA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535137750", "bodyText": "Is it supposed to call AbstractBolt.handleLifeCycleEvent or it's overloaded version? If so, then routing must be done inside AbstractBolt.dispatch.", "author": "surabujin", "createdAt": "2020-12-03T11:32:58Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/hubandspoke/HubBolt.java", "diffHunk": "@@ -57,14 +57,24 @@ public HubBolt(Config config) {\n \n     @Override\n     protected void handleInput(Tuple input) throws Exception {\n-        if (hubConfig.getRequestSenderComponent().equals(input.getSourceComponent())) {\n+        if (input.getSourceComponent().equals(hubConfig.getLifeCycleEventComponent())) {", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE0NDgwOA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535144808", "bodyText": "em... will it really work in case of one the catcher exception (IOException | InterruptedException | KeeperException)? I see NPE here.", "author": "surabujin", "createdAt": "2020-12-03T11:40:17Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperBolt.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.wfm.AbstractBolt;\n+\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.tuple.Tuple;\n+import org.apache.zookeeper.KeeperException;\n+\n+import java.io.IOException;\n+\n+public class ZooKeeperBolt extends AbstractBolt {\n+    public static final String BOLT_ID = \"zookeeper.bolt\";\n+    public static final String FIELD_ID_STATE = \"lifecycle.state\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+    private ZkWriter zkWriter;\n+    private ZkStateTracker zkStateTracker;\n+\n+    public ZooKeeperBolt(String id, String serviceName, String connectionString) {\n+        this.id = id;\n+        this.serviceName = serviceName;\n+        this.connectionString = connectionString;\n+    }\n+\n+    @Override\n+    protected void handleInput(Tuple input) throws Exception {\n+        if (zkWriter == null) {\n+            initZk();\n+        }\n+        try {\n+            LifecycleEvent event = (LifecycleEvent) input.getValueByField(FIELD_ID_STATE);\n+            if (event != null) {\n+                zkStateTracker.processLifecycleEvent(event);\n+            } else {\n+                log.error(\"Received null value as a lifecycle-event\");\n+            }\n+\n+        } catch (Exception e) {\n+            log.error(\"Failed to process event: {}\", e.getMessage(), e);\n+        }\n+\n+    }\n+\n+    @Override\n+    protected void init() {\n+        initZk();\n+    }\n+\n+    private void initZk() {\n+        try {\n+            zkWriter = ZkWriter.builder().id(id).serviceName(serviceName)\n+                    .connectionString(connectionString).build();\n+        } catch (IOException | InterruptedException | KeeperException e) {\n+            log.error(\"Failed to init ZooKeeper with connection string: {}, received: {} \", connectionString,\n+                    e.getMessage(), e);\n+        }\n+        zkStateTracker = new ZkStateTracker(zkWriter);", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE0NzU4Ng==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535147586", "bodyText": "It must be transient.\nAnd zkStateTracker too.", "author": "surabujin", "createdAt": "2020-12-03T11:42:51Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperBolt.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.wfm.AbstractBolt;\n+\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.tuple.Tuple;\n+import org.apache.zookeeper.KeeperException;\n+\n+import java.io.IOException;\n+\n+public class ZooKeeperBolt extends AbstractBolt {\n+    public static final String BOLT_ID = \"zookeeper.bolt\";\n+    public static final String FIELD_ID_STATE = \"lifecycle.state\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+    private ZkWriter zkWriter;", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE0OTEwOA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535149108", "bodyText": "You check the availability of zkWriter but use zkStateTracker only. You must check the availability of zkStateTracker or both of them.", "author": "surabujin", "createdAt": "2020-12-03T11:44:21Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperBolt.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.wfm.AbstractBolt;\n+\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.tuple.Tuple;\n+import org.apache.zookeeper.KeeperException;\n+\n+import java.io.IOException;\n+\n+public class ZooKeeperBolt extends AbstractBolt {\n+    public static final String BOLT_ID = \"zookeeper.bolt\";\n+    public static final String FIELD_ID_STATE = \"lifecycle.state\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+    private ZkWriter zkWriter;\n+    private ZkStateTracker zkStateTracker;\n+\n+    public ZooKeeperBolt(String id, String serviceName, String connectionString) {\n+        this.id = id;\n+        this.serviceName = serviceName;\n+        this.connectionString = connectionString;\n+    }\n+\n+    @Override\n+    protected void handleInput(Tuple input) throws Exception {\n+        if (zkWriter == null) {", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE1MzUzOQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535153539", "bodyText": "Add comment somewhere about the class purpose. I didn't get that it is something like KafkaBolt (but for zookeeper) at first.", "author": "surabujin", "createdAt": "2020-12-03T11:48:50Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/zk/ZooKeeperBolt.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.share.zk;\n+\n+import org.openkilda.bluegreen.LifecycleEvent;\n+import org.openkilda.bluegreen.ZkStateTracker;\n+import org.openkilda.bluegreen.ZkWriter;\n+import org.openkilda.wfm.AbstractBolt;\n+\n+import org.apache.storm.topology.OutputFieldsDeclarer;\n+import org.apache.storm.tuple.Tuple;\n+import org.apache.zookeeper.KeeperException;\n+\n+import java.io.IOException;\n+\n+public class ZooKeeperBolt extends AbstractBolt {\n+    public static final String BOLT_ID = \"zookeeper.bolt\";\n+    public static final String FIELD_ID_STATE = \"lifecycle.state\";\n+\n+    public static final String FIELD_ID_CONTEXT = AbstractBolt.FIELD_ID_CONTEXT;\n+    private String id;\n+    private String serviceName;\n+    private String connectionString;\n+    private ZkWriter zkWriter;\n+    private ZkStateTracker zkStateTracker;\n+\n+    public ZooKeeperBolt(String id, String serviceName, String connectionString) {\n+        this.id = id;\n+        this.serviceName = serviceName;\n+        this.connectionString = connectionString;\n+    }\n+\n+    @Override\n+    protected void handleInput(Tuple input) throws Exception {\n+        if (zkWriter == null) {\n+            initZk();\n+        }\n+        try {\n+            LifecycleEvent event = (LifecycleEvent) input.getValueByField(FIELD_ID_STATE);\n+            if (event != null) {\n+                zkStateTracker.processLifecycleEvent(event);\n+            } else {\n+                log.error(\"Received null value as a lifecycle-event\");\n+            }\n+\n+        } catch (Exception e) {\n+            log.error(\"Failed to process event: {}\", e.getMessage(), e);\n+        }\n+\n+    }\n+\n+    @Override\n+    protected void init() {\n+        initZk();\n+    }\n+\n+    private void initZk() {\n+        try {\n+            zkWriter = ZkWriter.builder().id(id).serviceName(serviceName)\n+                    .connectionString(connectionString).build();\n+        } catch (IOException | InterruptedException | KeeperException e) {\n+            log.error(\"Failed to init ZooKeeper with connection string: {}, received: {} \", connectionString,\n+                    e.getMessage(), e);\n+        }\n+        zkStateTracker = new ZkStateTracker(zkWriter);\n+    }\n+\n+    @Override\n+    public void declareOutputFields(OutputFieldsDeclarer declarer) {", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2OTEyMA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535169120", "bodyText": "Will we have this message in ELK?", "author": "surabujin", "createdAt": "2020-12-03T12:06:17Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/topology/AbstractTopology.java", "diffHunk": "@@ -97,10 +102,11 @@ protected AbstractTopology(LaunchEnvironment env, Class<T> topologyConfigClass)\n \n         topologyConfig = configurationProvider.getConfiguration(topologyConfigClass);\n         kafkaConfig = configurationProvider.getConfiguration(KafkaConfig.class);\n-\n+        zookeeperConfig = configurationProvider.getConfiguration(ZookeeperConfig.class);\n         logger.debug(\"Topology built {}: kafka={}, parallelism={}, workers={}\",\n                 topologyName, kafkaConfig.getHosts(), topologyConfig.getParallelism(),\n                 topologyConfig.getWorkers());\n+        logger.info(\"Starting topology {} in {} mode\", topologyName, topologyConfig.getBlueGreenMode());", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1MTk0MQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535251941", "bodyText": "no, as expected", "author": "timofei-durakov", "createdAt": "2020-12-03T14:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2OTEyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3MzAzMg==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535173032", "bodyText": "Why we need it?", "author": "surabujin", "createdAt": "2020-12-03T12:10:12Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/WatchDog.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+public interface WatchDog {", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1MzQyMQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535253421", "bodyText": "as discussed it's removed", "author": "timofei-durakov", "createdAt": "2020-12-03T14:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3MzAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MjAzOA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535182038", "bodyText": "Our style check does not allow 2 capital letter in a row... so it or do not work for this module or have different/incorrect settings.", "author": "surabujin", "createdAt": "2020-12-03T12:19:47Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkClient.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.experimental.SuperBuilder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.CreateMode;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.Watcher;\n+import org.apache.zookeeper.Watcher.Event.KeeperState;\n+import org.apache.zookeeper.ZooDefs.Ids;\n+import org.apache.zookeeper.ZooKeeper;\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+\n+@SuperBuilder\n+@Slf4j\n+public abstract class ZkClient implements Watcher {\n+    private static final String ROOT = \"/\";\n+    private static final int DEFAULT_SESSION_TIMEOUT = 30000;\n+\n+    protected String id;\n+    protected String serviceName;\n+    protected ZooKeeper zookeeper;\n+    private final String connectionString;\n+    private final int sessionTimeout;\n+\n+    public ZkClient(String id, String serviceName, String connectionString,\n+                    int sessionTimeout) throws IOException {\n+        if (sessionTimeout == 0) {\n+            sessionTimeout = DEFAULT_SESSION_TIMEOUT;\n+        }\n+        this.serviceName = serviceName;\n+        this.id = id;\n+        this.connectionString = connectionString;\n+        this.sessionTimeout = sessionTimeout;\n+        this.zookeeper = getZk();\n+    }\n+\n+    void initWatch() {\n+\n+    }\n+\n+    String getPaths(String... paths) {\n+        return Paths.get(ROOT, paths).toString();\n+    }\n+\n+    boolean refreshConnection(KeeperState state) throws IOException {\n+        if (state == KeeperState.Disconnected || state == KeeperState.Expired) {\n+            zookeeper = getZk();\n+            initWatch();\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    protected ZooKeeper getZk() throws IOException {\n+        return new ZooKeeper(connectionString, sessionTimeout, this);\n+    }\n+\n+    protected void ensureZNode(String... path) throws KeeperException, InterruptedException {", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4NDYxNQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535184615", "bodyText": "Extremely confusing error message. I can't imagine what it supposed to mean.", "author": "surabujin", "createdAt": "2020-12-03T12:23:50Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkStateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.UUID;\n+\n+@Slf4j\n+public class ZkStateTracker {\n+    private ZkWriter zooKeeperWriter;\n+    UUID shutdownUuid;\n+    UUID startUuid;\n+    int active;\n+\n+    public ZkStateTracker(ZkWriter zooKeeperWriter) {\n+        this.zooKeeperWriter = zooKeeperWriter;\n+    }\n+\n+    /**\n+     * Process new lifecycle event.\n+     */\n+    public void processLifecycleEvent(LifecycleEvent event) {\n+        if (Signal.START == event.getSignal()) {\n+            shutdownUuid = null;\n+            handleStart(event);\n+        } else if (Signal.SHUTDOWN == event.getSignal()) {\n+            handleShutdown(event);\n+            startUuid = null;\n+        }\n+        zooKeeperWriter.setState(active);\n+    }\n+\n+    private void handleStart(LifecycleEvent event) {\n+        if (startUuid != null) {\n+            if (startUuid.equals(event.getUuid())) {\n+                active++;\n+\n+            } else {\n+                startUuid = event.getUuid();\n+                active = 1;\n+            }\n+        } else {\n+            startUuid = event.getUuid();\n+            active++;\n+        }\n+    }\n+\n+    private void handleShutdown(LifecycleEvent event) {\n+        if (shutdownUuid != null) {\n+            if (shutdownUuid.equals(event.getUuid())) {\n+                active--;\n+            } else {\n+                log.error(\"Received new uuid: {}, expected: {}\", event.getUuid(), shutdownUuid);", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4NTAyMQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535185021", "bodyText": "Is it allowed to become negative?", "author": "surabujin", "createdAt": "2020-12-03T12:24:26Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkStateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.UUID;\n+\n+@Slf4j\n+public class ZkStateTracker {\n+    private ZkWriter zooKeeperWriter;\n+    UUID shutdownUuid;\n+    UUID startUuid;\n+    int active;\n+\n+    public ZkStateTracker(ZkWriter zooKeeperWriter) {\n+        this.zooKeeperWriter = zooKeeperWriter;\n+    }\n+\n+    /**\n+     * Process new lifecycle event.\n+     */\n+    public void processLifecycleEvent(LifecycleEvent event) {\n+        if (Signal.START == event.getSignal()) {\n+            shutdownUuid = null;\n+            handleStart(event);\n+        } else if (Signal.SHUTDOWN == event.getSignal()) {\n+            handleShutdown(event);\n+            startUuid = null;\n+        }\n+        zooKeeperWriter.setState(active);\n+    }\n+\n+    private void handleStart(LifecycleEvent event) {\n+        if (startUuid != null) {\n+            if (startUuid.equals(event.getUuid())) {\n+                active++;\n+\n+            } else {\n+                startUuid = event.getUuid();\n+                active = 1;\n+            }\n+        } else {\n+            startUuid = event.getUuid();\n+            active++;\n+        }\n+    }\n+\n+    private void handleShutdown(LifecycleEvent event) {\n+        if (shutdownUuid != null) {\n+            if (shutdownUuid.equals(event.getUuid())) {\n+                active--;\n+            } else {\n+                log.error(\"Received new uuid: {}, expected: {}\", event.getUuid(), shutdownUuid);\n+            }\n+        } else {\n+            shutdownUuid = event.getUuid();\n+            active--;", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4NjIxNQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535186215", "bodyText": "From lombok docs for SuperBuilder:\nAll classes in the hierarchy must be annotated with @SuperBuilder.", "author": "surabujin", "createdAt": "2020-12-03T12:26:21Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4Njk1Ng==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535186956", "bodyText": "Why for you allow to not fill any number of constructor arguments (while only one argument checks that it have meaningful value)?", "author": "surabujin", "createdAt": "2020-12-03T12:27:30Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {\n+\n+    private static final String SIGNAL = \"signal\";\n+    @VisibleForTesting\n+    protected String signalPath;\n+    private Signal signal;\n+\n+    @VisibleForTesting\n+    Set<LifeCycleObserver> observers = new HashSet<>();\n+\n+    @Builder", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI2ODA2NA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535268064", "bodyText": "checked, maybe get back to that later, since it's stop compiling", "author": "timofei-durakov", "createdAt": "2020-12-03T14:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4Njk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4ODk2MA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535188960", "bodyText": "Rearrange initWatch() calls to be a part of successful ZK connection processing. Now... it called at least in each(?) constructor of ZkClient and in some way during reconnects.\nPS Maybe it would be renamed in something like postConnect.", "author": "surabujin", "createdAt": "2020-12-03T12:31:03Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {\n+\n+    private static final String SIGNAL = \"signal\";\n+    @VisibleForTesting\n+    protected String signalPath;\n+    private Signal signal;\n+\n+    @VisibleForTesting\n+    Set<LifeCycleObserver> observers = new HashSet<>();\n+\n+    @Builder\n+    public ZkWatchDog(String id, String serviceName, String connectionString,\n+                      int sessionTimeout, Signal signal) throws IOException {\n+        super(id, serviceName, connectionString, sessionTimeout);\n+\n+        signalPath = getPaths(serviceName, id, SIGNAL);\n+        if (signal == null) {\n+            signal = Signal.NONE;\n+        }\n+        this.signal = signal;\n+        initWatch();", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5MDE3MA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535190170", "bodyText": "may be waitSignal()?", "author": "surabujin", "createdAt": "2020-12-03T12:33:00Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {\n+\n+    private static final String SIGNAL = \"signal\";\n+    @VisibleForTesting\n+    protected String signalPath;\n+    private Signal signal;\n+\n+    @VisibleForTesting\n+    Set<LifeCycleObserver> observers = new HashSet<>();\n+\n+    @Builder\n+    public ZkWatchDog(String id, String serviceName, String connectionString,\n+                      int sessionTimeout, Signal signal) throws IOException {\n+        super(id, serviceName, connectionString, sessionTimeout);\n+\n+        signalPath = getPaths(serviceName, id, SIGNAL);\n+        if (signal == null) {\n+            signal = Signal.NONE;\n+        }\n+        this.signal = signal;\n+        initWatch();\n+    }\n+\n+    @Override\n+    void validateNodes() throws KeeperException, InterruptedException {\n+        super.validateNodes();\n+        ensureZNode(serviceName, id, SIGNAL);\n+    }\n+\n+\n+    @VisibleForTesting\n+    void checkSignal() throws KeeperException, InterruptedException {", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI3MzQ2MQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535273461", "bodyText": "changed to subscribeSignal", "author": "timofei-durakov", "createdAt": "2020-12-03T14:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5MDE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5NTU2NA==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535195564", "bodyText": "Merge all these exception handlers - all of them do the same (exact issue will be visible via logger exception instance).", "author": "surabujin", "createdAt": "2020-12-03T12:41:38Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+\n+package org.openkilda.bluegreen;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.Builder;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.zookeeper.AsyncCallback.DataCallback;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.data.Stat;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class ZkWatchDog extends ZkClient implements WatchDog, DataCallback {\n+\n+    private static final String SIGNAL = \"signal\";\n+    @VisibleForTesting\n+    protected String signalPath;\n+    private Signal signal;\n+\n+    @VisibleForTesting\n+    Set<LifeCycleObserver> observers = new HashSet<>();\n+\n+    @Builder\n+    public ZkWatchDog(String id, String serviceName, String connectionString,\n+                      int sessionTimeout, Signal signal) throws IOException {\n+        super(id, serviceName, connectionString, sessionTimeout);\n+\n+        signalPath = getPaths(serviceName, id, SIGNAL);\n+        if (signal == null) {\n+            signal = Signal.NONE;\n+        }\n+        this.signal = signal;\n+        initWatch();\n+    }\n+\n+    @Override\n+    void validateNodes() throws KeeperException, InterruptedException {\n+        super.validateNodes();\n+        ensureZNode(serviceName, id, SIGNAL);\n+    }\n+\n+\n+    @VisibleForTesting\n+    void checkSignal() throws KeeperException, InterruptedException {\n+        zookeeper.getData(signalPath, this, this, null);\n+    }\n+\n+    @Override\n+    void initWatch() {\n+        try {\n+            validateNodes();\n+            checkSignal();\n+        } catch (KeeperException | InterruptedException e) {\n+            log.error(e.getMessage(), e);\n+        }\n+    }\n+\n+\n+    @Override\n+    public void subscribe(LifeCycleObserver observer) {\n+        observers.add(observer);\n+    }\n+\n+    @Override\n+    public void unsubscribe(LifeCycleObserver observer) {\n+        if (observers.contains(observer)) {\n+            observers.remove(observer);\n+        }\n+    }\n+\n+    @Override\n+    public void process(WatchedEvent event) {\n+        log.info(\"Received event: {}\", event);\n+        try {\n+            if (!refreshConnection(event.getState()) && signalPath.equals(event.getPath())) {\n+                checkSignal();\n+            }\n+        } catch (IOException e) {", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5OTY4Nw==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535199687", "bodyText": "Why you do not add a corresponding argument here? Because of the builder, it can be added without change of the caller side.", "author": "surabujin", "createdAt": "2020-12-03T12:48:02Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/bolts/FlowCreateHubBolt.java", "diffHunk": "@@ -172,7 +172,7 @@ public void declareOutputFields(OutputFieldsDeclarer declarer) {\n         public FlowCreateConfig(String requestSenderComponent, String workerComponent, int timeoutMs, boolean autoAck,\n                                 int flowCreationRetriesLimit, int pathAllocationRetriesLimit,\n                                 int pathAllocationRetryDelay, int speakerCommandRetriesLimit) {\n-            super(requestSenderComponent, workerComponent, timeoutMs, autoAck);\n+            super(requestSenderComponent, workerComponent, null, timeoutMs, autoAck);", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIwMDE5OQ==", "url": "https://github.com/telstra/open-kilda/pull/3859#discussion_r535200199", "bodyText": "It is not actually a host... this is more URL than a host.", "author": "surabujin", "createdAt": "2020-12-03T12:48:49Z", "path": "src-java/kilda-configuration/src/main/java/org/openkilda/config/ZookeeperConfig.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/* Copyright 2019 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.config;\n+\n+import com.sabre.oss.conf4j.annotation.Configuration;\n+import com.sabre.oss.conf4j.annotation.Key;\n+\n+@Configuration\n+@Key(\"zookeeper\")\n+public interface ZookeeperConfig {\n+    @Key(\"hosts\")\n+    String getHosts();", "originalCommit": "3b3d88730b21113ea03d970f574d740f317346b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de79546ea68d46a67c7bf69026c17aebfc18b64a", "url": "https://github.com/telstra/open-kilda/commit/de79546ea68d46a67c7bf69026c17aebfc18b64a", "message": "Shared storm components for zero downtime", "committedDate": "2020-12-03T14:39:17Z", "type": "forcePushed"}, {"oid": "242ad1f4237be3359cb85a98952f74ffff065dc1", "url": "https://github.com/telstra/open-kilda/commit/242ad1f4237be3359cb85a98952f74ffff065dc1", "message": "Blue-Green library for kilda", "committedDate": "2020-12-03T14:41:54Z", "type": "commit"}, {"oid": "242ad1f4237be3359cb85a98952f74ffff065dc1", "url": "https://github.com/telstra/open-kilda/commit/242ad1f4237be3359cb85a98952f74ffff065dc1", "message": "Blue-Green library for kilda", "committedDate": "2020-12-03T14:41:54Z", "type": "forcePushed"}]}