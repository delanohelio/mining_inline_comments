{"pr_number": 3645, "pr_title": "Update test framework to allow 2+ management floodlights for switch", "pr_createdAt": "2020-07-20T15:41:45Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3645", "timeline": [{"oid": "08ce9bbaf1779e99b9314943f90647e42593944e", "url": "https://github.com/telstra/open-kilda/commit/08ce9bbaf1779e99b9314943f90647e42593944e", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-07-21T08:16:14Z", "type": "forcePushed"}, {"oid": "556deaf511e60f68dba8bd43f33a1aa69371423d", "url": "https://github.com/telstra/open-kilda/commit/556deaf511e60f68dba8bd43f33a1aa69371423d", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-07-23T11:26:45Z", "type": "forcePushed"}, {"oid": "b9a26316dc72e1670e19ad4e94cefd6423bad38b", "url": "https://github.com/telstra/open-kilda/commit/b9a26316dc72e1670e19ad4e94cefd6423bad38b", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-07-24T09:30:09Z", "type": "forcePushed"}, {"oid": "376668280f04fafeb186c3357c1ed525df22b567", "url": "https://github.com/telstra/open-kilda/commit/376668280f04fafeb186c3357c1ed525df22b567", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-07-27T12:27:54Z", "type": "forcePushed"}, {"oid": "16a9eb1a1bc2b4d20a77baf57d9fc215c70e1587", "url": "https://github.com/telstra/open-kilda/commit/16a9eb1a1bc2b4d20a77baf57d9fc215c70e1587", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-07-27T13:15:39Z", "type": "forcePushed"}, {"oid": "e93e3c14414d85dc8d7dd8da8687fc5da810be62", "url": "https://github.com/telstra/open-kilda/commit/e93e3c14414d85dc8d7dd8da8687fc5da810be62", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-07-28T13:39:08Z", "type": "forcePushed"}, {"oid": "bbac873030404624c62352632b5e7fe209570977", "url": "https://github.com/telstra/open-kilda/commit/bbac873030404624c62352632b5e7fe209570977", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-08-04T15:16:20Z", "type": "forcePushed"}, {"oid": "c8e68b2e0e47a4734c5012f3ace0936aa60e3ff3", "url": "https://github.com/telstra/open-kilda/commit/c8e68b2e0e47a4734c5012f3ace0936aa60e3ff3", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-08-06T09:24:20Z", "type": "forcePushed"}, {"oid": "35ed52bef8b96a0c8b33a39341a25b1cd641bfaa", "url": "https://github.com/telstra/open-kilda/commit/35ed52bef8b96a0c8b33a39341a25b1cd641bfaa", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-08-07T11:43:22Z", "type": "forcePushed"}, {"oid": "96ca12b9ccec76cd114082389d53a7e09eb64c57", "url": "https://github.com/telstra/open-kilda/commit/96ca12b9ccec76cd114082389d53a7e09eb64c57", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-08-07T14:31:06Z", "type": "forcePushed"}, {"oid": "8fd7e2c903dfbcd38e3f4bb5eca1b332e3146168", "url": "https://github.com/telstra/open-kilda/commit/8fd7e2c903dfbcd38e3f4bb5eca1b332e3146168", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-08-08T16:22:44Z", "type": "forcePushed"}, {"oid": "985622c91545826dbf31e19ed1c347f2683a42db", "url": "https://github.com/telstra/open-kilda/commit/985622c91545826dbf31e19ed1c347f2683a42db", "message": "Update test framework to allow 2+ management floodlights for switch", "committedDate": "2020-08-10T15:24:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ4ODY2Nw==", "url": "https://github.com/telstra/open-kilda/pull/3645#discussion_r468488667", "bodyText": "looks like it is removed from confd/vars/main.yml", "author": "andriidovhan", "createdAt": "2020-08-11T10:43:43Z", "path": "src-java/testing/atdd-staging/src/main/java/org/openkilda/atdd/staging/config/TopologyConfig.java", "diffHunk": "@@ -35,7 +35,7 @@\n     @Value(\"file:${topology.definition.file:topology.yaml}\")\n     private Resource topologyDefinitionFile;\n \n-    @Value(\"#{'${floodlight.controllers.management.openflow}'.split(',').get(0)}\")\n+    @Value(\"#{'${floodlight.openflow}'.split(',').get(0)}\")\n     private String managementController;\n \n     @Value(\"#{'${floodlight.controllers.stat.openflow}'.split(',').get(0)}\")", "originalCommit": "985622c91545826dbf31e19ed1c347f2683a42db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ5MTQwNQ==", "url": "https://github.com/telstra/open-kilda/pull/3645#discussion_r468491405", "bodyText": "you can also remove List<String> controllerHosts", "author": "andriidovhan", "createdAt": "2020-08-11T10:49:15Z", "path": "src-java/testing/atdd-staging/src/main/java/org/openkilda/atdd/staging/config/TopologyConfig.java", "diffHunk": "@@ -55,7 +55,6 @@ public TopologyDefinition topologyDefinition() throws IOException {\n         List<String> controllerHosts = Arrays.asList(managementController, statController);", "originalCommit": "985622c91545826dbf31e19ed1c347f2683a42db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUyNDMxOQ==", "url": "https://github.com/telstra/open-kilda/pull/3645#discussion_r468524319", "bodyText": "probably would be better to call this variable as  swAddress ?", "author": "andriidovhan", "createdAt": "2020-08-11T11:56:03Z", "path": "src-java/testing/test-library/src/main/java/org/openkilda/testing/service/lockkeeper/LockKeeperVirtualImpl.java", "diffHunk": "@@ -184,41 +194,52 @@ public void unblockFloodlightAccess(String region, FloodlightResourceAddress add\n     @Override\n     public void shapeSwitchesTraffic(List<Switch> switches, TrafficControlData tcData) {\n         log.debug(\"Add traffic control rules for switches {}\",\n-                switches.stream().map(Switch::getDpId).collect(Collectors.toList()));\n+                switches.stream().map(Switch::getDpId).collect(toList()));\n         List<FloodlightResourceAddress> swResources = switches.stream()\n-                .map(sw -> LockKeeperService.toFlResource(sw, mgmtManager)).collect(Collectors.toList());\n+                .flatMap(sw -> sw.getRegions().stream().map(region -> {\n+                    Floodlight fl = flHelper.getFlByRegion(region);\n+                    String swInfo = fl.getFloodlightService().getSwitches().stream().filter(s ->", "originalCommit": "985622c91545826dbf31e19ed1c347f2683a42db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1NDU3Mw==", "url": "https://github.com/telstra/open-kilda/pull/3645#discussion_r468554573", "bodyText": "floodlght.modes is missed", "author": "andriidovhan", "createdAt": "2020-08-11T12:51:02Z", "path": "src-java/testing/test-library/src/main/java/org/openkilda/testing/config/DefaultServiceConfig.java", "diffHunk": "@@ -85,30 +87,34 @@ public RestTemplate traffExamRestTemplate() {\n     public Map<String, RestTemplate> lockKeeperRestTemplates(\n             @Value(\"${lockkeeper.port}\") Integer lockKeeperPort,\n             @Value(\"#{'${floodlight.regions}'.split(',')}\") List<String> regions,\n-            @Value(\"#{'${floodlight.controllers.management.endpoints}'.split(',')}\") List<String> mgmtFloodlights) {\n+            @Value(\"#{'${floodlight.endpoints}'.split(',')}\") List<String> flEndpoints) {\n         Map<String, RestTemplate> result = new HashMap<>();\n-        for (int i = 0; i < mgmtFloodlights.size(); i++) {\n-            String lockKeeperEndpoint = mgmtFloodlights.get(i)\n+        for (int i = 0; i < flEndpoints.size(); i++) {\n+            String lockKeeperEndpoint = flEndpoints.get(i)\n                     .replaceFirst(\"(.*):\\\\d+\", \"$1:\" + lockKeeperPort);\n             result.put(regions.get(i), buildLoggingRestTemplate(lockKeeperEndpoint));\n         }\n         return result;\n     }\n \n-    @Bean(name = \"managementFloodlights\")\n-    public List<FloodlightService> managementFloodlights(\n-            @Value(\"#{'${floodlight.controllers.management.endpoints}'.split(',')}\") List<String> mgmtFloodlights) {\n-        List<FloodlightService> services = new ArrayList<>();\n-        mgmtFloodlights.forEach(f -> services.add(new FloodlightServiceImpl(f)));\n-        return services;\n-    }\n-\n-    @Bean(name = \"statsFloodlights\")\n-    public List<FloodlightService> statsFloodlights(\n-            @Value(\"#{'${floodlight.controllers.stat.endpoints}'.split(',')}\") List<String> mgmtFloodlights) {\n-        List<FloodlightService> services = new ArrayList<>();\n-        mgmtFloodlights.forEach(f -> services.add(new FloodlightServiceImpl(f)));\n-        return services;\n+    @Bean\n+    public List<Floodlight> floodlights(@Value(\"#{'${floodlight.openflows}'.split(',')}\") List<String> openflows,\n+                                        @Value(\"#{'${floodlight.endpoints}'.split(',')}\") List<String> endpoints,\n+                                        @Value(\"#{'${floodlight.containers}'.split(',')}\") List<String> containers,\n+                                        @Value(\"#{'${floodlight.regions}'.split(',')}\") List<String> regions,\n+                                        @Value(\"#{'${floodlight.modes}'.split(',')}\") List<String> modes) {\n+        if (openflows.size() != endpoints.size() || openflows.size() != containers.size()\n+                || openflows.size() != regions.size()) {", "originalCommit": "985622c91545826dbf31e19ed1c347f2683a42db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cef52fad231aa1f8bf9fd5c935c2569b4ae4373f", "url": "https://github.com/telstra/open-kilda/commit/cef52fad231aa1f8bf9fd5c935c2569b4ae4373f", "message": "Update test framework to allow 2+ floodlights for switch", "committedDate": "2020-08-12T12:19:35Z", "type": "forcePushed"}, {"oid": "badbb3c9d4ea574dbf94c0a94c1ba1b05f24a094", "url": "https://github.com/telstra/open-kilda/commit/badbb3c9d4ea574dbf94c0a94c1ba1b05f24a094", "message": "Update test framework to allow 2+ floodlights for switch", "committedDate": "2020-08-12T12:36:53Z", "type": "forcePushed"}, {"oid": "981b6fd14c277adb8b715e4a7b92a7c546457cf3", "url": "https://github.com/telstra/open-kilda/commit/981b6fd14c277adb8b715e4a7b92a7c546457cf3", "message": "Update test framework to allow 2+ floodlights for switch", "committedDate": "2020-08-13T10:09:14Z", "type": "commit"}, {"oid": "981b6fd14c277adb8b715e4a7b92a7c546457cf3", "url": "https://github.com/telstra/open-kilda/commit/981b6fd14c277adb8b715e4a7b92a7c546457cf3", "message": "Update test framework to allow 2+ floodlights for switch", "committedDate": "2020-08-13T10:09:14Z", "type": "forcePushed"}]}