{"pr_number": 3341, "pr_title": "[NCL-5812] Fix lazy loading workarounds", "pr_createdAt": "2020-10-06T15:25:40Z", "pr_url": "https://github.com/project-ncl/pnc/pull/3341", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM4OTAwOA==", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r500389008", "bodyText": "Don't mind the cast here, it is for this prototype only. I would add the method to the root interface.", "author": "janinko", "createdAt": "2020-10-06T15:26:59Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductMilestoneProviderImpl.java", "diffHunk": "@@ -113,28 +113,19 @@ public ProductMilestoneProviderImpl(\n     @Override\n     public ProductMilestone update(String id, ProductMilestone restEntity) {\n         validateBeforeUpdating(id, restEntity);\n-\n         org.jboss.pnc.model.ProductMilestone milestoneInDb = repository.queryById(Integer.valueOf(id));\n-        org.jboss.pnc.model.ProductMilestone milestoneRestDb = mapper.toEntity(restEntity);\n-\n         // we can't modify milestone if it's already released\n         if (milestoneInDb.getEndDate() != null) {\n             log.info(\"Milestone is already closed: no more modifications allowed\");\n             throw new RepositoryViolationException(\"Milestone is already closed! No more modifications allowed\");\n         }\n \n         log.debug(\"Updating milestone for id: {}\", id);\n-        milestoneRestDb.setId(Integer.valueOf(id));\n-\n-        // make sure that user cannot set the 'endDate' via the REST API\n-        // this should only be set after the release process is successful\n-        milestoneRestDb.setEndDate(milestoneInDb.getEndDate());\n-        // Make sure that user cannot change the product release of the milestone. This is set on release creation.\n-        milestoneRestDb.setProductRelease(milestoneInDb.getProductRelease());\n+        ((ProductMilestoneMapper) mapper).mergeEntity(restEntity, milestoneInDb);", "originalCommit": "75f2e91d2490926fa78a10e432e2ddb51f3ddc0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5MzgzNw==", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r500393837", "bodyText": "productVersion is updatable=false", "author": "janinko", "createdAt": "2020-10-06T15:31:59Z", "path": "mapper/src/main/java/org/jboss/pnc/mapper/api/ProductMilestoneMapper.java", "diffHunk": "@@ -42,6 +43,23 @@\n     @Mapping(target = \"performedBuilds\", ignore = true)\n     ProductMilestone toEntity(org.jboss.pnc.dto.ProductMilestone dtoEntity);\n \n+    /**\n+     * Merges DTO entity into database entity.\n+     *\n+     * @param dtoEntity DTO entity to be converted.\n+     * @param target\n+     */\n+    @Mapping(target = \"id\", ignore = true)\n+    // make sure that user cannot set the 'endDate' via the REST API\n+    // this should only be set after the release process is successful\n+    @Mapping(target = \"endDate\", ignore = true)\n+    @Mapping(target = \"productVersion\", ignore = true)", "originalCommit": "75f2e91d2490926fa78a10e432e2ddb51f3ddc0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8", "url": "https://github.com/project-ncl/pnc/commit/7c80c8e866aa3ff4d916df963da01dd9dec0b7e8", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems", "committedDate": "2020-10-29T18:05:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ2NzQ2NA==", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r514467464", "bodyText": "MWAHAHA", "author": "janinko", "createdAt": "2020-10-29T18:11:54Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/GroupConfigurationProviderImpl.java", "diffHunk": "@@ -78,19 +78,13 @@ public GroupConfiguration getSpecific(String id) {\n     }\n \n     @Override\n-    public GroupConfiguration update(String id, GroupConfiguration restEntity) {\n-        validateBeforeUpdating(id, restEntity);\n-        log.debug(\"Updating entity: \" + restEntity);\n-        BuildConfigurationSet dbEntity = repository.queryById(Integer.valueOf(id));\n+    protected void validateBeforeUpdating(String id, GroupConfiguration restEntity) {\n+        super.validateBeforeUpdating(id, restEntity);\n+\n+        BuildConfigurationSet dbEntity = findInDB(id);\n         if (dbEntity.isArchived()) {\n             throw new RepositoryViolationException(\"The Group Config \" + id + \" is already deleted.\");\n         }\n-        // DO NOT REMOVE - Triggers the inizialization of LAZY collections (fixes NCL-5804)", "originalCommit": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0OTAxMg==", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r514949012", "bodyText": "clap clap", "author": "vibe13", "createdAt": "2020-10-30T08:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ2NzQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1MDM3Mg==", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r514950372", "bodyText": "are these leftovers logs for debugging? you may want to remove them?", "author": "vibe13", "createdAt": "2020-10-30T08:53:56Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java", "diffHunk": "@@ -152,9 +122,33 @@ protected void validateBeforeSaving(ProductVersion restEntity) {\n     protected void validateBeforeUpdating(String id, ProductVersion restEntity) {\n         super.validateBeforeUpdating(id, restEntity);\n \n+        validateVersionChange(id, restEntity);\n+        validateGroupConfigsBeforeUpdating(id, restEntity);\n+    }\n+\n+    private void validateVersionChange(String id, ProductVersion restEntity) throws InvalidEntityException {\n+        org.jboss.pnc.model.ProductVersion entityInDb = findInDB(id);\n+        boolean changingVersion = !entityInDb.getVersion().equals(restEntity.getVersion());\n+        if (changingVersion) {\n+            boolean hasClosedMilestone = entityInDb.getProductMilestones()\n+                    .stream()\n+                    .anyMatch(milestone -> milestone.getEndDate() != null);\n+            if (hasClosedMilestone) {\n+                throw new InvalidEntityException(\n+                        \"Cannot change version due to having closed milestone. Product version id: \" + id);\n+            }\n+        }\n+    }\n+\n+    private void validateGroupConfigsBeforeUpdating(String id, ProductVersion restEntity)\n+            throws InvalidEntityException, NumberFormatException, ConflictedEntryException {\n         if (restEntity.getGroupConfigs() != null) {\n             for (String groupConfigId : restEntity.getGroupConfigs().keySet()) {\n+                log.warn(\"Checking group config: \" + groupConfigId);", "originalCommit": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b3acc980beeb39a2d93ec8a10271489b68b699e", "url": "https://github.com/project-ncl/pnc/commit/2b3acc980beeb39a2d93ec8a10271489b68b699e", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems", "committedDate": "2020-11-02T10:24:28Z", "type": "forcePushed"}, {"oid": "6d890cead88315e47d5b51b38655d0184350b71b", "url": "https://github.com/project-ncl/pnc/commit/6d890cead88315e47d5b51b38655d0184350b71b", "message": "Move AbstractArtifactMapper", "committedDate": "2020-11-02T10:35:50Z", "type": "commit"}, {"oid": "93b46e339d223122ffbd46b3b64cc8bfb2c3f30e", "url": "https://github.com/project-ncl/pnc/commit/93b46e339d223122ffbd46b3b64cc8bfb2c3f30e", "message": "[NCL-5812] Add UpdatableEntityMapper with updateEntiy method to update JPA entity", "committedDate": "2020-11-02T10:35:50Z", "type": "commit"}, {"oid": "c0291359dba9db6bfda56c190952f3d3a8d10b8d", "url": "https://github.com/project-ncl/pnc/commit/c0291359dba9db6bfda56c190952f3d3a8d10b8d", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems", "committedDate": "2020-11-02T10:55:50Z", "type": "commit"}, {"oid": "c0291359dba9db6bfda56c190952f3d3a8d10b8d", "url": "https://github.com/project-ncl/pnc/commit/c0291359dba9db6bfda56c190952f3d3a8d10b8d", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems", "committedDate": "2020-11-02T10:55:50Z", "type": "forcePushed"}]}