{"pr_number": 874, "pr_title": "Improve Gateway logout endpoint error handling", "pr_createdAt": "2020-09-29T12:21:36Z", "pr_url": "https://github.com/zowe/api-layer/pull/874", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1MTc5MA==", "url": "https://github.com/zowe/api-layer/pull/874#discussion_r496751790", "bodyText": "I think this is causing some problem on the error handling. I've tried to intentionally pass an invalid token via Cookie (I deleted part of the token) and call the /logout endpoint. On master it returns 400 with TokenFormatNotValidException exception, which is the expected behaviour. Now it returns 500 with:\n{\n    \"messages\": [\n        {\n            \"messageType\": \"ERROR\",\n            \"messageNumber\": \"ZWEAG100E\",\n            \"messageContent\": \"Authentication exception: 'Error while logging out token' for URL '/api/v1/gateway/auth/logout'\",\n            \"messageKey\": \"org.zowe.apiml.security.generic\"\n        }\n    ]\n}\n\nIt is because authenticationService.invalidateJwtToken(token, true); is throwing TokenNotValidException and you are catching a generic Exception e that will throw this message, which is not correct in this case. It should rather return 400 with TokenFormatNotValidException, based on how it was before.\nTherefore I think you can add a catch:\n } catch (TokenNotValidException e) {\n                failure.onAuthenticationFailure(request, response, new TokenFormatNotValidException(e.getMessage()));\n            }\n\nand keep the last generic catch to catch other possible exception such as ServiceNotAccessibleException", "author": "taban03", "createdAt": "2020-09-29T14:13:22Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/security/config/JWTLogoutHandler.java", "diffHunk": "@@ -34,21 +36,27 @@\n     public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) {\n         Optional<String> token = authenticationService.getJwtTokenFromRequest(request);\n         try {\n-            checkJwtTokenFormat(failure, request, response, token);\n+            if (token.isPresent()) {\n+                invalidateJwtToken(failure, request, response, token.get());\n+            } else {\n+                failure.onAuthenticationFailure(request, response, new TokenNotProvidedException(\"The token you are trying to logout is not present in the header\"));\n+            }\n         } catch (ServletException e) {\n             log.error(\"The response cannot be written during the logout exception handler: {}\", e.getMessage());\n         }\n     }\n \n-    private void checkJwtTokenFormat(FailedAuthenticationHandler failure, HttpServletRequest request, HttpServletResponse response, Optional<String> token) throws ServletException {\n-        if (token.isPresent()) {\n+    private void invalidateJwtToken(FailedAuthenticationHandler failure, HttpServletRequest request, HttpServletResponse response, String token) throws ServletException {\n+        if (authenticationService.isInvalidated(token)) {\n+            failure.onAuthenticationFailure(request, response, new TokenNotValidException(\"The token you are trying to logout is not valid\"));\n+        } else {\n             try {\n-                authenticationService.invalidateJwtToken(token.get(), true);\n-            } catch (TokenNotValidException e) {\n-                failure.onAuthenticationFailure(request, response, new TokenFormatNotValidException(e.getMessage()));\n+                authenticationService.invalidateJwtToken(token, true);\n+            } catch (TokenFormatNotValidException e) {\n+                failure.onAuthenticationFailure(request, response, e);\n+            } catch (Exception e) {\n+                failure.onAuthenticationFailure(request, response, new AuthenticationTokenException(\"Error while logging out token\"));", "originalCommit": "e110034b828275165a88313a6e347fc20f40bb2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4MDM4OQ==", "url": "https://github.com/zowe/api-layer/pull/874#discussion_r496880389", "bodyText": "Added TokenNotValidException catch that returns TokenFormatNotValidException, and included AuthenticationException catch as well as generic Exception catch to provide error handling for a specific instance of AuthenticationException as well as handle any other errors that happen (like ServiceNotAccessibleException).", "author": "CarsonCook", "createdAt": "2020-09-29T16:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1MTc5MA=="}], "type": "inlineReview"}, {"oid": "894198fb10474f2adbc39c1314f7c5044ea9df85", "url": "https://github.com/zowe/api-layer/commit/894198fb10474f2adbc39c1314f7c5044ea9df85", "message": "Reject already invalidated token on logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "1b8b95253dfd99c45a5fa88b7ef109db34d39c0b", "url": "https://github.com/zowe/api-layer/commit/1b8b95253dfd99c45a5fa88b7ef109db34d39c0b", "message": "Unit test reject already invalidated token on logout\n:\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "00724713074f7daaf7de33b9a4e7b52f6fbe6bee", "url": "https://github.com/zowe/api-layer/commit/00724713074f7daaf7de33b9a4e7b52f6fbe6bee", "message": "Update for integration tests for 401 on double logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "9473906e2d9d5d6a4d1b2c557881ed4366a93b62", "url": "https://github.com/zowe/api-layer/commit/9473906e2d9d5d6a4d1b2c557881ed4366a93b62", "message": "Add generic exception handling for gw logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "2f6c5b80712c39fc2ca0e12e353043e7fb8db23b", "url": "https://github.com/zowe/api-layer/commit/2f6c5b80712c39fc2ca0e12e353043e7fb8db23b", "message": "Fix code smell\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "71041cfe3e2f074910041f20739ab66db5ac0fe0", "url": "https://github.com/zowe/api-layer/commit/71041cfe3e2f074910041f20739ab66db5ac0fe0", "message": "Fix zaas double logout error code\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "72fafd15ec60770fa4648e98993bfd34e0235f7c", "url": "https://github.com/zowe/api-layer/commit/72fafd15ec60770fa4648e98993bfd34e0235f7c", "message": "Fix typos\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "e063a784fb7433fd5ef915be950caa39b78fc7cc", "url": "https://github.com/zowe/api-layer/commit/e063a784fb7433fd5ef915be950caa39b78fc7cc", "message": "Fix back to sending 400 on mangled token\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "c852b680bb96f1e1ba42327a3b8895ea0fb28850", "url": "https://github.com/zowe/api-layer/commit/c852b680bb96f1e1ba42327a3b8895ea0fb28850", "message": "Return 401 on generic error in gw logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "commit"}, {"oid": "c852b680bb96f1e1ba42327a3b8895ea0fb28850", "url": "https://github.com/zowe/api-layer/commit/c852b680bb96f1e1ba42327a3b8895ea0fb28850", "message": "Return 401 on generic error in gw logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>", "committedDate": "2020-10-02T07:29:17Z", "type": "forcePushed"}, {"oid": "57db81d95f9cbed4904db416bb1a45507f8c0a1a", "url": "https://github.com/zowe/api-layer/commit/57db81d95f9cbed4904db416bb1a45507f8c0a1a", "message": "Merge branch 'master' into carsoncook/gh831/errorHandlingGWLogout", "committedDate": "2020-10-05T07:33:15Z", "type": "commit"}, {"oid": "e880cc46c612e291dc5b30a6317c9441bb49755b", "url": "https://github.com/zowe/api-layer/commit/e880cc46c612e291dc5b30a6317c9441bb49755b", "message": "Remove the test which should verify the validity of the second token after logout.\n  - The tokens produced by zOSMF are the same and as such the logout on one means the other doesn't work.\nThe same goes for the second logout. The first logout already invalidates properly the first token.\n\nSigned-off-by: Jakub Balhar <jakub.balhar@broadcom.com>", "committedDate": "2020-10-05T15:04:02Z", "type": "commit"}]}