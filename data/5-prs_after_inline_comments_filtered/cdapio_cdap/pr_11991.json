{"pr_number": 11991, "pr_title": "CDAP-16239 include context in plugin config creation error", "pr_createdAt": "2020-03-23T21:50:06Z", "pr_url": "https://github.com/cdapio/cdap/pull/11991", "timeline": [{"oid": "99e37ff16c17a3cba44bbe19a11de7270c1ab0d4", "url": "https://github.com/cdapio/cdap/commit/99e37ff16c17a3cba44bbe19a11de7270c1ab0d4", "message": "CDAP-16239 include context in plugin config creation error\n\nWhen the plugin config cannot be created because there are\nmissing properties or invalid properties, include which properties\nare invalid in the error message.\n\nAlso fixed a bug where a given property with a null value was\nincorrectly not counted as a missing property.", "committedDate": "2020-03-24T00:23:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU4MDAzNA==", "url": "https://github.com/cdapio/cdap/pull/11991#discussion_r403580034", "bodyText": "It's better to include the plugin name as well.", "author": "chtyim", "createdAt": "2020-04-04T23:48:54Z", "path": "cdap-api/src/main/java/io/cdap/cdap/api/plugin/InvalidPluginConfigException.java", "diffHunk": "@@ -57,4 +57,26 @@ public InvalidPluginConfigException(String message, Set<String> missingPropertie\n   public Set<InvalidPluginProperty> getInvalidProperties() {\n     return invalidProperties;\n   }\n+\n+  private static String generateErrorMessage(String baseMessage, Set<String> missingProperties,", "originalCommit": "99e37ff16c17a3cba44bbe19a11de7270c1ab0d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU4MTY0MA==", "url": "https://github.com/cdapio/cdap/pull/11991#discussion_r403581640", "bodyText": "Also, invalid property is caused by an exception when trying to set the field. So it'll be good if this exception can carry those as suppressed causes.", "author": "chtyim", "createdAt": "2020-04-04T23:52:31Z", "path": "cdap-api/src/main/java/io/cdap/cdap/api/plugin/InvalidPluginConfigException.java", "diffHunk": "@@ -57,4 +57,26 @@ public InvalidPluginConfigException(String message, Set<String> missingPropertie\n   public Set<InvalidPluginProperty> getInvalidProperties() {\n     return invalidProperties;\n   }\n+\n+  private static String generateErrorMessage(String baseMessage, Set<String> missingProperties,\n+                                             Set<InvalidPluginProperty> invalidProperties) {\n+    if (missingProperties.isEmpty() && invalidProperties.isEmpty()) {\n+      return baseMessage;\n+    }\n+\n+    StringBuilder errorMessage = new StringBuilder(baseMessage);\n+    if (missingProperties.size() == 1) {\n+      errorMessage.append(String.format(\" Required property '%s' is missing.\", missingProperties.iterator().next()));\n+    } else if (missingProperties.size() > 1) {\n+      errorMessage.append(String.format(\" Required properties '%s' are missing.\",\n+                                        String.join(\", \", missingProperties)));\n+    }\n+\n+    for (InvalidPluginProperty invalidProperty : invalidProperties) {\n+      errorMessage.append(String.format(\" '%s' is invalid: %s.\",\n+                                        invalidProperty.getName(), invalidProperty.getErrorMessage()));", "originalCommit": "99e37ff16c17a3cba44bbe19a11de7270c1ab0d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk2NDc2OA==", "url": "https://github.com/cdapio/cdap/pull/11991#discussion_r405964768", "bodyText": "A better wait is to use map:\ninvalidProperties.stream()\n  .map(InvalidPluginProperty::getCause)\n  .filter(Objects::nonNull)\n  .forEach(this::addSuppressed)", "author": "chtyim", "createdAt": "2020-04-09T05:30:59Z", "path": "cdap-api/src/main/java/io/cdap/cdap/api/plugin/InvalidPluginConfigException.java", "diffHunk": "@@ -27,20 +27,23 @@\n  * the property type specified by the PluginConfig is incompatible with the value provided in the PluginProperties.\n  */\n public class InvalidPluginConfigException extends RuntimeException {\n-  private Set<String> missingProperties;\n-  private Set<InvalidPluginProperty> invalidProperties;\n+  private final Set<String> missingProperties;\n+  private final Set<InvalidPluginProperty> invalidProperties;\n \n   public InvalidPluginConfigException(String message, Throwable cause) {\n     super(message, cause);\n     this.missingProperties = Collections.emptySet();\n     this.invalidProperties = Collections.emptySet();\n   }\n \n-  public InvalidPluginConfigException(String message, Set<String> missingProperties,\n+  public InvalidPluginConfigException(PluginClass pluginClass, Set<String> missingProperties,\n                                       Set<InvalidPluginProperty> invalidProperties) {\n-    super(message);\n+    super(generateErrorMessage(pluginClass, missingProperties, invalidProperties));\n     this.missingProperties = Collections.unmodifiableSet(new HashSet<>(missingProperties));\n     this.invalidProperties = Collections.unmodifiableSet(new HashSet<>(invalidProperties));\n+    invalidProperties.stream()\n+      .filter(p -> p.getCause() != null)", "originalCommit": "b86a1305aab5de3195d496080ec38baa7aa53e7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9812a37e1c91c1c03812d0e7e66d4075946d0947", "url": "https://github.com/cdapio/cdap/commit/9812a37e1c91c1c03812d0e7e66d4075946d0947", "message": "CDAP-16239 include context in plugin config creation error\n\nWhen the plugin config cannot be created because there are\nmissing properties or invalid properties, include which properties\nare invalid in the error message.\n\nAlso fixed a bug where a given property with a null value was\nincorrectly not counted as a missing property.", "committedDate": "2020-04-09T07:59:17Z", "type": "commit"}, {"oid": "9812a37e1c91c1c03812d0e7e66d4075946d0947", "url": "https://github.com/cdapio/cdap/commit/9812a37e1c91c1c03812d0e7e66d4075946d0947", "message": "CDAP-16239 include context in plugin config creation error\n\nWhen the plugin config cannot be created because there are\nmissing properties or invalid properties, include which properties\nare invalid in the error message.\n\nAlso fixed a bug where a given property with a null value was\nincorrectly not counted as a missing property.", "committedDate": "2020-04-09T07:59:17Z", "type": "forcePushed"}]}