{"pr_number": 11956, "pr_title": "Shutdown SystemAppManagement when BootstrapService is shutting down", "pr_createdAt": "2020-03-13T18:08:15Z", "pr_url": "https://github.com/cdapio/cdap/pull/11956", "timeline": [{"oid": "56f350937f4f7cca1cdbd53d22a844c2f47ea543", "url": "https://github.com/cdapio/cdap/commit/56f350937f4f7cca1cdbd53d22a844c2f47ea543", "message": "Shutdown SystemAppManagement when BootstrapService is shutting down", "committedDate": "2020-03-13T18:05:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5NjE1NQ==", "url": "https://github.com/cdapio/cdap/pull/11956#discussion_r392396155", "bodyText": "it's possible this isn't started yet since it's started asynchronously. I'm not sure if it will throw an error if you try stopping a service that isn't running. Can you check the behavior?\nThere is also a race here where this line completes, then the thread starts the service before the executor service is shutdown. It's better to do this after the executorService is shutdown, since we know nothing will try to start it at that point.", "author": "albertshau", "createdAt": "2020-03-13T18:19:50Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/bootstrap/BootstrapService.java", "diffHunk": "@@ -102,6 +102,7 @@ protected void startUp() {\n   @Override\n   protected void shutDown() throws Exception {\n     LOG.info(\"Stopping {}\", getClass().getSimpleName());\n+    this.systemAppManagementService.stopAndWait();", "originalCommit": "56f350937f4f7cca1cdbd53d22a844c2f47ea543", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzMTMxOQ==", "url": "https://github.com/cdapio/cdap/pull/11956#discussion_r392431319", "bodyText": "Documentation for stop() says \"If the service has already been stopped, this method returns immediately without taking action.\" stopandwait() waits till service is \"stopped\" so my assumption is it should be no-op is service is already stopped or not started.\nAlso moved line according to your suggestion.", "author": "pandyajay10", "createdAt": "2020-03-13T19:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5NjE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ2ODM1Mw==", "url": "https://github.com/cdapio/cdap/pull/11956#discussion_r392468353", "bodyText": "It starts out in the NEW state though, which is different than a terminal state. Can you verify that it is indeed a no-op?", "author": "albertshau", "createdAt": "2020-03-13T20:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5NjE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ3Mjg3MA==", "url": "https://github.com/cdapio/cdap/pull/11956#discussion_r392472870", "bodyText": "Yes for New state it is a no-op. From documentation, \"If this is Service.State.NEW, it is terminated without having been started nor stopped\".", "author": "pandyajay10", "createdAt": "2020-03-13T20:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5NjE1NQ=="}], "type": "inlineReview"}, {"oid": "dc67d2141ac761bd1f38bb9bc4103ff7477be016", "url": "https://github.com/cdapio/cdap/commit/dc67d2141ac761bd1f38bb9bc4103ff7477be016", "message": "Shutdown SystemAppManagement when BootstrapService is shutting down", "committedDate": "2020-03-13T19:35:09Z", "type": "commit"}]}