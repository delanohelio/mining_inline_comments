{"pr_number": 12803, "pr_title": "(CDAP-17332) Enabling writing bytes read/written metrics in Spark", "pr_createdAt": "2020-10-12T21:07:44Z", "pr_url": "https://github.com/cdapio/cdap/pull/12803", "timeline": [{"oid": "b142e8d0cb0fdc95f0a97e37395982e207886db3", "url": "https://github.com/cdapio/cdap/commit/b142e8d0cb0fdc95f0a97e37395982e207886db3", "message": "(CDAP-17332) Enabling writing bytes read/written metrics in Spark\n\n- Sends values written to MR Counter for bytes read/written to Spark metrics\n- Rewrite the OutputMetrics in Spark to ignore setting bytes written to 0\n-- This is to prevent task metrics being overwritten", "committedDate": "2020-10-12T21:12:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA0OTIzMA==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505049230", "bodyText": "why is this needed? Is it getting serialized/deserialized somewhere?", "author": "albertshau", "createdAt": "2020-10-14T23:05:00Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/batch/BasicInputFormatProvider.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.batch;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.cdap.cdap.api.data.batch.InputFormatProvider;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * An {@link InputFormatProvider} that simply take a class name and a set of configurations.\n+ */\n+public class BasicInputFormatProvider implements InputFormatProvider {\n+\n+  private final String inputFormatClassName;\n+  private final Map<String, String> configuration;\n+\n+  public BasicInputFormatProvider(String inputFormatClassName, Map<String, String> configuration) {\n+    this.inputFormatClassName = inputFormatClassName;\n+    this.configuration = ImmutableMap.copyOf(configuration);\n+  }\n+\n+  public BasicInputFormatProvider() {", "originalCommit": "b142e8d0cb0fdc95f0a97e37395982e207886db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA2NDM0MQ==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505064341", "bodyText": "This class was extracted from an existing inner class. I see there is a Json serializer using it.", "author": "chtyim", "createdAt": "2020-10-14T23:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA0OTIzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1MDE2OA==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505050168", "bodyText": "should we return an unmodifiable map?", "author": "albertshau", "createdAt": "2020-10-14T23:06:19Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/batch/BasicOutputFormatProvider.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.batch;\n+\n+import io.cdap.cdap.api.data.batch.OutputFormatProvider;\n+\n+import java.util.Map;\n+\n+/**\n+ * An {@link OutputFormatProvider} that simply take a class name and a set of configurations.\n+ */\n+public class BasicOutputFormatProvider implements OutputFormatProvider {\n+\n+  private final String outputFormatClassName;\n+  private final Map<String, String> outputFormatConfiguration;\n+\n+  public BasicOutputFormatProvider(String outputFormatClassName, Map<String, String> outputFormatConfiguration) {\n+    this.outputFormatClassName = outputFormatClassName;\n+    this.outputFormatConfiguration = outputFormatConfiguration;\n+  }\n+\n+  @Override\n+  public String getOutputFormatClassName() {\n+    return outputFormatClassName;\n+  }\n+\n+  @Override\n+  public Map<String, String> getOutputFormatConfiguration() {\n+    return outputFormatConfiguration;", "originalCommit": "b142e8d0cb0fdc95f0a97e37395982e207886db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA2NzgwNw==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505067807", "bodyText": "good call", "author": "chtyim", "createdAt": "2020-10-14T23:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1MDE2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NjQzMg==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505056432", "bodyText": "would be good to add comments here too on why it's not needed for files", "author": "albertshau", "createdAt": "2020-10-14T23:15:18Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/io/TrackingOutputFormat.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.spark.io;\n+\n+import io.cdap.cdap.etl.batch.DelegatingOutputFormat;\n+import org.apache.hadoop.mapreduce.OutputCommitter;\n+import org.apache.hadoop.mapreduce.OutputFormat;\n+import org.apache.hadoop.mapreduce.RecordWriter;\n+import org.apache.hadoop.mapreduce.TaskAttemptContext;\n+import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;\n+\n+import java.io.IOException;\n+\n+/**\n+ * An {@link OutputFormat} that enables metrics tracking through {@link TaskAttemptContext} counters to Spark metrics.\n+ *\n+ * @param <K> type of key to write\n+ * @param <V> type of value to write\n+ */\n+public class TrackingOutputFormat<K, V> extends DelegatingOutputFormat<K, V> {\n+\n+  @Override\n+  public RecordWriter<K, V> getRecordWriter(TaskAttemptContext context) throws IOException, InterruptedException {\n+    OutputFormat<K, V> delegate = getDelegate(context.getConfiguration());\n+\n+    if (delegate instanceof FileOutputFormat) {", "originalCommit": "b142e8d0cb0fdc95f0a97e37395982e207886db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA2OTA4OQ==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505069089", "bodyText": "done", "author": "chtyim", "createdAt": "2020-10-14T23:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NjQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1ODM1NA==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505058354", "bodyText": "It may also be useful to track how many splits an input format generates.", "author": "albertshau", "createdAt": "2020-10-14T23:18:13Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/io/TrackingInputFormat.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.spark.io;\n+\n+import io.cdap.cdap.etl.batch.DelegatingInputFormat;\n+import org.apache.hadoop.mapreduce.InputFormat;\n+import org.apache.hadoop.mapreduce.InputSplit;\n+import org.apache.hadoop.mapreduce.RecordReader;\n+import org.apache.hadoop.mapreduce.TaskAttemptContext;\n+import org.apache.hadoop.mapreduce.lib.input.CombineFileSplit;\n+import org.apache.hadoop.mapreduce.lib.input.FileSplit;\n+\n+import java.io.IOException;\n+\n+/**\n+ * An {@link InputFormat} that enables metrics tracking through {@link TaskAttemptContext} counters to Spark metrics.\n+ *\n+ * @param <K> type of key to read\n+ * @param <V> type of value to read\n+ */\n+public class TrackingInputFormat<K, V> extends DelegatingInputFormat<K, V> {", "originalCommit": "b142e8d0cb0fdc95f0a97e37395982e207886db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA3MDU4OA==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505070588", "bodyText": "Spark doesn't have a metrics for that directly. It does track number of tasks per stage though.", "author": "chtyim", "createdAt": "2020-10-14T23:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1ODM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1OTg3NQ==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505059875", "bodyText": "nit: overwritting -> overwriting\nAlso curious, when does something call setBytesWritten(0) after setting it to a non-zero value? Is this just a Spark bug?", "author": "albertshau", "createdAt": "2020-10-14T23:20:13Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/classloader/SparkClassRewriter.java", "diffHunk": "@@ -224,10 +225,57 @@ public SparkClassRewriter(Function<String, InputStream> resourceLookup, boolean\n       // Rewrite Spark DiskStore class and classes in the network package for Netty 4.1 compatibility\n       return rewriteSparkNetworkClass(input);\n     }\n+    if (className.equals(SPARK_OUTPUT_METRICS.getClassName())) {\n+      // Rewrite the Spark OutputMetrics to skip overwriting bytes written metrics with 0.\n+      return rewriteOutputMetrics(SPARK_OUTPUT_METRICS, input);\n+    }\n \n     return null;\n   }\n \n+  /**\n+   * Rewrites the OutputMetrics#setBytesWritten method to skip recording zero (0) value to avoid overwritting", "originalCommit": "b142e8d0cb0fdc95f0a97e37395982e207886db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA2NTI3Nw==", "url": "https://github.com/cdapio/cdap/pull/12803#discussion_r505065277", "bodyText": "Spark does it by blinding calling setBytesWritten using FileSystem statistics. It is asymmetric in Spark in how it implements bytes read (which only applies to file inputs) and bytes written (which blindly set).", "author": "chtyim", "createdAt": "2020-10-14T23:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1OTg3NQ=="}], "type": "inlineReview"}, {"oid": "31c2f8cc276d721f773213507acc0188a3037169", "url": "https://github.com/cdapio/cdap/commit/31c2f8cc276d721f773213507acc0188a3037169", "message": "(CDAP-17332) Enabling writing bytes read/written metrics in Spark\n\n- Sends values written to MR Counter for bytes read/written to Spark metrics\n- Rewrite the OutputMetrics in Spark to ignore setting bytes written to 0\n-- This is to prevent task metrics being overwritten", "committedDate": "2020-10-14T23:36:55Z", "type": "commit"}, {"oid": "31c2f8cc276d721f773213507acc0188a3037169", "url": "https://github.com/cdapio/cdap/commit/31c2f8cc276d721f773213507acc0188a3037169", "message": "(CDAP-17332) Enabling writing bytes read/written metrics in Spark\n\n- Sends values written to MR Counter for bytes read/written to Spark metrics\n- Rewrite the OutputMetrics in Spark to ignore setting bytes written to 0\n-- This is to prevent task metrics being overwritten", "committedDate": "2020-10-14T23:36:55Z", "type": "forcePushed"}]}