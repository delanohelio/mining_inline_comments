{"pr_number": 12137, "pr_title": "(CDAP-16730) Set correct -xmx for pods in k8s to run programs", "pr_createdAt": "2020-05-01T05:56:26Z", "pr_url": "https://github.com/cdapio/cdap/pull/12137", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2OTQ5Mg==", "url": "https://github.com/cdapio/cdap/pull/12137#discussion_r418469492", "bodyText": "We have two keys in the cdap-site.xml to control non-heap memory, twill.java.heap.memory.ratio and twill.java.reserved.memory.mb. You can get those through the MasterEnvironmentContext.getConfigurations() method. You can refer to the org.apache.twill.internal.utils.Resources.computeMaxHeapSize method on how it computes the xmx.", "author": "chtyim", "createdAt": "2020-05-01T09:00:08Z", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillPreparer.java", "diffHunk": "@@ -87,6 +87,7 @@\n   private static final String CPU_MULTIPLIER = \"master.environment.k8s.container.cpu.multiplier\";\n   private static final String MEMORY_MULTIPLIER = \"master.environment.k8s.container.memory.multiplier\";\n   private static final String DEFAULT_MULTIPLIER = \"1.0\";\n+  private static final double MEMORY_MAX_HEAP_SIZE_FRACTION = 0.8;", "originalCommit": "5eb4b1912383931535cc9537969b2f6a41367b93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODg4NTA2NQ==", "url": "https://github.com/cdapio/cdap/pull/12137#discussion_r418885065", "bodyText": "Done. Added twill as dependency and uses the util function directly.", "author": "wyzhang", "createdAt": "2020-05-02T04:26:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2OTQ5Mg=="}], "type": "inlineReview"}, {"oid": "320fb687b88e5f9e127310774c5f8840b741fff8", "url": "https://github.com/cdapio/cdap/commit/320fb687b88e5f9e127310774c5f8840b741fff8", "message": "address comments", "committedDate": "2020-05-02T04:06:41Z", "type": "forcePushed"}, {"oid": "5a9524c709018a83582d9e85acba7e4482fa1750", "url": "https://github.com/cdapio/cdap/commit/5a9524c709018a83582d9e85acba7e4482fa1750", "message": "(CDAP-16730) Set correct -xmx for pods in k8s to run programs\n\nBug:\nWe have introduced a multiplier to determine the actual CPU and RAM\nto request for creating the pod to run a program. But we fail to\nset the correct -xmx based on the RAM requested for the pod.\n\nThis change\n- Set memory requested to be memory * multiplier\n- Set xmx using org.apache.twill.internal.utils.Resources.computeMaxHeapSiz\n  based on the memory request size", "committedDate": "2020-05-02T07:34:57Z", "type": "commit"}, {"oid": "5a9524c709018a83582d9e85acba7e4482fa1750", "url": "https://github.com/cdapio/cdap/commit/5a9524c709018a83582d9e85acba7e4482fa1750", "message": "(CDAP-16730) Set correct -xmx for pods in k8s to run programs\n\nBug:\nWe have introduced a multiplier to determine the actual CPU and RAM\nto request for creating the pod to run a program. But we fail to\nset the correct -xmx based on the RAM requested for the pod.\n\nThis change\n- Set memory requested to be memory * multiplier\n- Set xmx using org.apache.twill.internal.utils.Resources.computeMaxHeapSiz\n  based on the memory request size", "committedDate": "2020-05-02T07:34:57Z", "type": "forcePushed"}]}