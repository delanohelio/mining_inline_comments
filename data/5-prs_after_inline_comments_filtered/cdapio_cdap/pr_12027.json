{"pr_number": 12027, "pr_title": "Add a config to disallow creating new profile via REST endpoint", "pr_createdAt": "2020-04-01T01:03:44Z", "pr_url": "https://github.com/cdapio/cdap/pull/12027", "timeline": [{"oid": "e94e529b80ade39bbc30a91ba6455315e747c071", "url": "https://github.com/cdapio/cdap/commit/e94e529b80ade39bbc30a91ba6455315e747c071", "message": "(CDAP-16353) Add a config to disallow creating new profile via REST endpoint", "committedDate": "2020-04-01T01:05:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzMTQ0OA==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r401331448", "bodyText": "Wrong import? We shouldn't be using this class.", "author": "chtyim", "createdAt": "2020-04-01T03:11:07Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/profile/ProfileService.java", "diffHunk": "@@ -17,11 +17,13 @@\n package io.cdap.cdap.internal.profile;\n \n import com.google.common.annotations.VisibleForTesting;\n+import com.sun.tools.internal.jxc.ap.Const;", "originalCommit": "e94e529b80ade39bbc30a91ba6455315e747c071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NTIxNg==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r401355216", "bodyText": "Removed.", "author": "wyzhang", "createdAt": "2020-04-01T04:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzMTQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzMTgzOA==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r401331838", "bodyText": "No need to use String.format. Also, the message is better as \"Compute profile creation is not allowed\".", "author": "chtyim", "createdAt": "2020-04-01T03:12:46Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/profile/ProfileService.java", "diffHunk": "@@ -142,10 +148,13 @@ public Profile getProfile(ProfileId profileId, Map<String, String> overrides) th\n    *\n    * @param profileId the id of the profile to save\n    * @param profile the information of the profile\n-   * @throws MethodNotAllowedException if trying to update the Native profile\n+   * @throws MethodNotAllowedException if trying to update the Native profile or creating new profile when disallowed.\n    */\n   public void saveProfile(ProfileId profileId, Profile profile) throws MethodNotAllowedException {\n     TransactionRunners.run(transactionRunner, context -> {\n+      if (!cConf.getBoolean(Constants.Profile.CREATION_ALLOWED, true)) {\n+        throw new MethodNotAllowedException(String.format(\"Creating new profile is disabled\"));", "originalCommit": "e94e529b80ade39bbc30a91ba6455315e747c071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NTM4Mg==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r401355382", "bodyText": "Done. Fixed", "author": "wyzhang", "createdAt": "2020-04-01T04:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzMTgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5ODAwNA==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r401798004", "bodyText": "We usually put defaults in cdap-defaults.xml, after which the default value here doesn't need to be given.", "author": "albertshau", "createdAt": "2020-04-01T17:47:25Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/profile/ProfileService.java", "diffHunk": "@@ -142,10 +147,13 @@ public Profile getProfile(ProfileId profileId, Map<String, String> overrides) th\n    *\n    * @param profileId the id of the profile to save\n    * @param profile the information of the profile\n-   * @throws MethodNotAllowedException if trying to update the Native profile\n+   * @throws MethodNotAllowedException if trying to update the Native profile or creating new profile when disallowed.\n    */\n   public void saveProfile(ProfileId profileId, Profile profile) throws MethodNotAllowedException {\n     TransactionRunners.run(transactionRunner, context -> {\n+      if (!cConf.getBoolean(Constants.Profile.CREATION_ALLOWED, true)) {", "originalCommit": "260c8ed554363a5f9c994a48617d51c273cbfe03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5OTI0MQ==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r401799241", "bodyText": "also, this method handles both creates and updates. If we only want to block creation it needs to be handled differently. If we want to block creation and updates, then we should change the configuration property name and the error message.\nI would think that we want to block updates as well, otherwise users can just change the existing profile.", "author": "albertshau", "createdAt": "2020-04-01T17:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5ODAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MDQzNA==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r401990434", "bodyText": "Done.", "author": "wyzhang", "createdAt": "2020-04-02T00:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5ODAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1NTc2MA==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r402055760", "bodyText": "private final", "author": "albertshau", "createdAt": "2020-04-02T05:14:26Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/profile/ProfileService.java", "diffHunk": "@@ -60,12 +61,16 @@\n  */\n public class ProfileService {\n   private static final Logger LOG = LoggerFactory.getLogger(ProfileService.class);\n+  private CConfiguration cConf;", "originalCommit": "089de265b5bc43f1633bca641f01f9b98048d8ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2MTA2Mw==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r402661063", "bodyText": "Done", "author": "wyzhang", "createdAt": "2020-04-02T23:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1NTc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1NjU1OA==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r402056558", "bodyText": "nit: updating -> update", "author": "albertshau", "createdAt": "2020-04-02T05:17:23Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/profile/ProfileService.java", "diffHunk": "@@ -142,10 +147,13 @@ public Profile getProfile(ProfileId profileId, Map<String, String> overrides) th\n    *\n    * @param profileId the id of the profile to save\n    * @param profile the information of the profile\n-   * @throws MethodNotAllowedException if trying to update the Native profile\n+   * @throws MethodNotAllowedException if trying to update the Native profile or creating a new profile when disallowed.\n    */\n   public void saveProfile(ProfileId profileId, Profile profile) throws MethodNotAllowedException {\n     TransactionRunners.run(transactionRunner, context -> {\n+      if (!cConf.getBoolean(Constants.Profile.CREATION_AND_UPDATE_DISALLOWED)) {\n+        throw new MethodNotAllowedException(\"Compute profile creation and updating are not allowed\");", "originalCommit": "089de265b5bc43f1633bca641f01f9b98048d8ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2MzE5Mw==", "url": "https://github.com/cdapio/cdap/pull/12027#discussion_r402663193", "bodyText": "Done", "author": "wyzhang", "createdAt": "2020-04-03T00:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1NjU1OA=="}], "type": "inlineReview"}, {"oid": "360adcabbfa379af14ed8b19123e5a7de46ce763", "url": "https://github.com/cdapio/cdap/commit/360adcabbfa379af14ed8b19123e5a7de46ce763", "message": "(CDAP-16353) Add an option to enable/disable creating new or updating existing profile", "committedDate": "2020-04-03T04:09:15Z", "type": "commit"}, {"oid": "360adcabbfa379af14ed8b19123e5a7de46ce763", "url": "https://github.com/cdapio/cdap/commit/360adcabbfa379af14ed8b19123e5a7de46ce763", "message": "(CDAP-16353) Add an option to enable/disable creating new or updating existing profile", "committedDate": "2020-04-03T04:09:15Z", "type": "forcePushed"}]}