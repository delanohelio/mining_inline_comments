{"pr_number": 12797, "pr_title": "(CDAP-17323) Skip network checking logic for Existing Dataproc", "pr_createdAt": "2020-10-06T22:03:46Z", "pr_url": "https://github.com/cdapio/cdap/pull/12797", "timeline": [{"oid": "a44d894870960f2c251ece120c97acce46263dca", "url": "https://github.com/cdapio/cdap/commit/a44d894870960f2c251ece120c97acce46263dca", "message": "(CDAP-17323) Skip network checking logic for Existing Dataproc", "committedDate": "2020-10-06T21:34:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzMTE1NA==", "url": "https://github.com/cdapio/cdap/pull/12797#discussion_r500631154", "bodyText": "Should we add it to @throws? Also I'd reformulate \"This shouldn't happen\" as it may happen, it's just a client that can't create clusters.", "author": null, "createdAt": "2020-10-06T22:27:14Z", "path": "cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java", "diffHunk": "@@ -314,6 +336,13 @@ ClusterOperationMetadata createCluster(String name, String imageVersion, Map<Str\n                                          boolean privateInstance)\n     throws RetryableProvisionException, InterruptedException, IOException {\n \n+    if (network == null) {\n+      // This shouldn't happen as the fromConf method should already check.\n+      // This is to guard against programmatic bug that this client was created without network information and\n+      // yet being used to create cluster.\n+      throw new IllegalArgumentException(\"Missing network information\");", "originalCommit": "a44d894870960f2c251ece120c97acce46263dca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzMzg0Mg==", "url": "https://github.com/cdapio/cdap/pull/12797#discussion_r500633842", "bodyText": "This is a package private class which is only used privately by the provisioner. This is just a simple check to fail early in test in case someone wrote a buggy code within this package.", "author": "chtyim", "createdAt": "2020-10-06T22:34:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzMTE1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzNDM1MQ==", "url": "https://github.com/cdapio/cdap/pull/12797#discussion_r500634351", "bodyText": "This is more like an assert that shouldn't be declared as part of the API contract.", "author": "chtyim", "createdAt": "2020-10-06T22:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzMTE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0NzkyOA==", "url": "https://github.com/cdapio/cdap/pull/12797#discussion_r500647928", "bodyText": "Do we need to pass network explicitly? since it's a member variable and should already be available in isInternalIpOnly right?", "author": "sagarkapare", "createdAt": "2020-10-06T23:15:58Z", "path": "cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java", "diffHunk": "@@ -648,7 +677,7 @@ void updateClusterLabels(String clusterName,\n    * @param sshRuntimeMonitor {@code true} if SSH is used for runtime monitoring\n    * @return {@code true} for pribvate IP only Dataproc cluster\n    */\n-  private boolean isInternalIPOnly(boolean privateInstance, boolean sshRuntimeMonitor) {\n+  private boolean isInternalIPOnly(Network network, boolean privateInstance, boolean sshRuntimeMonitor) {", "originalCommit": "a44d894870960f2c251ece120c97acce46263dca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2Njg2OA==", "url": "https://github.com/cdapio/cdap/pull/12797#discussion_r500666868", "bodyText": "This change is intentional since the field can be null. So instead of checking for null everywhere, we only check it once in the createCluster method so that these methods calls would never receive null for network.", "author": "chtyim", "createdAt": "2020-10-07T00:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0NzkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0ODM5NQ==", "url": "https://github.com/cdapio/cdap/pull/12797#discussion_r500648395", "bodyText": "Similarly here no need to pass network explicitly to the method.", "author": "sagarkapare", "createdAt": "2020-10-06T23:17:30Z", "path": "cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/provisioner/dataproc/DataprocClient.java", "diffHunk": "@@ -701,7 +730,7 @@ private boolean isInternalIPOnly(boolean privateInstance, boolean sshRuntimeMoni\n    * @return a {@link Collection} of tags that need to be added to the VM to have those firewall rules applies\n    * @throws IOException If failed to discover those firewall rules\n    */\n-  private List<String> getFirewallTargetTags(boolean useInternalIP) throws IOException {\n+  private List<String> getFirewallTargetTags(Network network, boolean useInternalIP) throws IOException {", "originalCommit": "a44d894870960f2c251ece120c97acce46263dca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2NjkyNQ==", "url": "https://github.com/cdapio/cdap/pull/12797#discussion_r500666925", "bodyText": "Same reason as above.", "author": "chtyim", "createdAt": "2020-10-07T00:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0ODM5NQ=="}], "type": "inlineReview"}]}