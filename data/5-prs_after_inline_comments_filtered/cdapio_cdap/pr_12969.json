{"pr_number": 12969, "pr_title": "[CDAP-17466] Authentication functionality for CDAP on Kubernetes setup", "pr_createdAt": "2020-12-20T22:24:02Z", "pr_url": "https://github.com/cdapio/cdap/pull/12969", "timeline": [{"oid": "aaa465910fed4afeff95fab47e97270055860843", "url": "https://github.com/cdapio/cdap/commit/aaa465910fed4afeff95fab47e97270055860843", "message": "[CDAP-17466] Implementation", "committedDate": "2020-12-18T21:30:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjE1MQ==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502151", "bodyText": "Please follow the naming convention to use \"authentication\".", "author": "chtyim", "createdAt": "2021-01-10T03:01:42Z", "path": "cdap-common/src/main/java/io/cdap/cdap/common/conf/Constants.java", "diffHunk": "@@ -122,6 +122,7 @@\n     public static final String EXPLORE_HTTP_USER_SERVICE = \"explore.service\";\n     public static final String MESSAGING_SERVICE = \"messaging.service\";\n     public static final String RUNTIME = \"runtime\";\n+    public static final String AUTHENTICATION = \"Authentication\";", "originalCommit": "aaa465910fed4afeff95fab47e97270055860843", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjI2Mw==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502263", "bodyText": "Generally the long arguments are aligned like this in the rest of the code base:\nprotected List<Module> getServiceModules(MasterEnvironment masterEnv, \n                                         EnvironmentOptions options, \n                                         CConfiguration cConf) {", "author": "chtyim", "createdAt": "2021-01-10T03:03:22Z", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(", "originalCommit": "aaa465910fed4afeff95fab47e97270055860843", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjQ1Mg==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502452", "bodyText": "Remove unnecessary empty lines", "author": "chtyim", "createdAt": "2021-01-10T03:05:11Z", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+", "originalCommit": "aaa465910fed4afeff95fab47e97270055860843", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjQ5MA==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502490", "bodyText": "Ideally in k8s environment, we should use ZK for the key store, but instead using k8s secrets. Please open a follow up JIRA for that change. We'll need to update the MasterEnvironment to provide an abstraction for secure store.", "author": "chtyim", "createdAt": "2021-01-10T03:05:44Z", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);", "originalCommit": "aaa465910fed4afeff95fab47e97270055860843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxMjQ2NQ==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560512465", "bodyText": "Created - https://cdap.atlassian.net/browse/CDAP-17618", "author": "edvinas-maciulis", "createdAt": "2021-01-19T21:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjY2OQ==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502669", "bodyText": "So if it fails to connect to ZK, there is just logging but not failing the pod? Is that an intended behavior?", "author": "chtyim", "createdAt": "2021-01-10T03:07:32Z", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());", "originalCommit": "aaa465910fed4afeff95fab47e97270055860843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxOTYzNA==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560519634", "bodyText": "Added System.exit(1).", "author": "edvinas-maciulis", "createdAt": "2021-01-19T21:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjgxNw==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502817", "bodyText": "It's not good to assume that the ZKClientService is a singleton binding.", "author": "chtyim", "createdAt": "2021-01-10T03:09:28Z", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);", "originalCommit": "aaa465910fed4afeff95fab47e97270055860843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxODI4Nw==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560518287", "bodyText": "ZKClientModule defines it as a singleton. I do understand that it is done in separate place.\nInjector does not provide a way to access all instances - I have been researching in that space. Is the code bellow is the way you are thinking all instances should be retrieved?\n     for (Key<?> key : injector.getAllBindings().keySet()) {\n          if (YourInterface.class.isAssignableFrom(key.getTypeLiteral().getRawType())) {\n           YourInterface yourInterface = (YourInterface) injector.getInstance(key);\n           allYourInterfaces.add(yourInterface);\n      }\n\nisAssignableFrom method matches all subclasses - in this situation we could just use ==\nSource: https://stackoverflow.com/questions/6085200/how-to-get-all-implementors-subclasses-of-an-interface-with-guice/40558788\nIs that how you see it?", "author": "edvinas-maciulis", "createdAt": "2021-01-19T21:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAzNjU1OQ==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r562036559", "bodyText": "What I meant was instead of relying on the binding being singleton,  it is better to just get the instance once and hold the instance in a field so that it is for sure it is the same instance.", "author": "chtyim", "createdAt": "2021-01-21T16:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwNTM3OQ==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r563205379", "bodyText": "Thanks, makes sense. I have updated code.", "author": "edvinas-maciulis", "createdAt": "2021-01-23T22:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjg2MA==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502860", "bodyText": "Same as above", "author": "chtyim", "createdAt": "2021-01-10T03:09:58Z", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);", "originalCommit": "aaa465910fed4afeff95fab47e97270055860843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxODU2Mg==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560518562", "bodyText": "Will address depending on the outcome from above", "author": "edvinas-maciulis", "createdAt": "2021-01-19T21:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwNTM5MA==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r563205390", "bodyText": "Updated. Thanks!", "author": "edvinas-maciulis", "createdAt": "2021-01-23T22:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMzA2OA==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554503068", "bodyText": "I don't quite get the idea of this service. It seems like both the ZKClientService and the ExternalAuthenticationServer has been started/stopped twice since they are also added in line 134, 135", "author": "chtyim", "createdAt": "2021-01-10T03:13:24Z", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {", "originalCommit": "aaa465910fed4afeff95fab47e97270055860843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxNTU2MQ==", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560515561", "bodyText": "Good point, updated.", "author": "edvinas-maciulis", "createdAt": "2021-01-19T21:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMzA2OA=="}], "type": "inlineReview"}, {"oid": "4e2a9edbc992b81735a958d871bdfa87f3346ae4", "url": "https://github.com/cdapio/cdap/commit/4e2a9edbc992b81735a958d871bdfa87f3346ae4", "message": "Update as per PR review comments", "committedDate": "2021-01-19T21:49:14Z", "type": "commit"}, {"oid": "6382c0ef9ed0e551fa441d301ea3b27a4620e60f", "url": "https://github.com/cdapio/cdap/commit/6382c0ef9ed0e551fa441d301ea3b27a4620e60f", "message": "removed unnecessary code", "committedDate": "2021-01-20T14:56:44Z", "type": "commit"}, {"oid": "efbd2dca4c8c4e7756d972361d06484dbc6808d9", "url": "https://github.com/cdapio/cdap/commit/efbd2dca4c8c4e7756d972361d06484dbc6808d9", "message": "[CDAP-17466] added missing test Keystore file", "committedDate": "2021-01-23T21:51:20Z", "type": "commit"}, {"oid": "e960c5966c33af9a355bb6efdf94ad22537f34f1", "url": "https://github.com/cdapio/cdap/commit/e960c5966c33af9a355bb6efdf94ad22537f34f1", "message": "[CDAP-17466] holding onto ZKClientService and AuthenticationServer instances - later we are sure that we are stopping the instances we started", "committedDate": "2021-01-23T22:07:29Z", "type": "commit"}]}