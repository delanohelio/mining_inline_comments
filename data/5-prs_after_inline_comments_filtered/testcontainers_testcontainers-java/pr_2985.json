{"pr_number": 2985, "pr_title": "Add a rootless Docker strategy", "pr_createdAt": "2020-07-09T16:54:38Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2985", "timeline": [{"oid": "00b6437822678c928fd2952395c1162687787e20", "url": "https://github.com/testcontainers/testcontainers-java/commit/00b6437822678c928fd2952395c1162687787e20", "message": "Add a rootless Docker strategy", "committedDate": "2020-07-09T16:54:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4OTQyNw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452389427", "bodyText": "Slightly pedantic point, but I'm assuming we'll have to make the 1000 reflect the current user's uid. I guess this may become more necessary once testing rootless with cloud CI.", "author": "rnorth", "createdAt": "2020-07-09T17:50:05Z", "path": "core/src/main/java/org/testcontainers/dockerclient/RootlessDockerClientProviderStrategy.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package org.testcontainers.dockerclient;\n+\n+import org.apache.commons.lang.SystemUtils;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ *\n+ * @deprecated this class is used by the SPI and should not be used directly\n+ */\n+@Deprecated\n+public final class RootlessDockerClientProviderStrategy extends DockerClientProviderStrategy {\n+    protected static final String DOCKER_SOCK_PATH = \"/run/user/1000/docker.sock\";", "originalCommit": "00b6437822678c928fd2952395c1162687787e20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MDM1Mw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452390353", "bodyText": "I'd be inclined to add a new method to the TransportConfig object to perform this logic.\nI'll start that change in #1771, as it's going to be necessary there, but FYI.", "author": "rnorth", "createdAt": "2020-07-09T17:51:48Z", "path": "core/src/main/java/org/testcontainers/utility/ResourceReaper.java", "diffHunk": "@@ -70,13 +74,34 @@ private ResourceReaper() {\n         dockerClient = DockerClientFactory.instance().client();\n     }\n \n-    @SneakyThrows(InterruptedException.class)\n+    /**\n+     *\n+     * @deprecated not for public usage\n+     */\n+    @Deprecated\n     public static String start(String hostIpAddress, DockerClient client) {\n+        return start(hostIpAddress, client, null);\n+    }\n+\n+    /**\n+     *\n+     * @deprecated not for public usage\n+     */\n+    @Deprecated\n+    @SneakyThrows(InterruptedException.class)\n+    public static String start(String hostIpAddress, DockerClient client, @Nullable TransportConfig transportConfig) {\n         String ryukImage = TestcontainersConfiguration.getInstance().getRyukImage();\n         DockerClientFactory.instance().checkAndPullImage(client, ryukImage);\n \n+        String socketPath = \"//var/run/docker.sock\";\n+        if (transportConfig != null) {\n+            URI dockerHost = transportConfig.getDockerHost();\n+            if (\"unix\".equals(dockerHost.getScheme())) {\n+                socketPath = dockerHost.getRawPath();\n+            }\n+        }", "originalCommit": "00b6437822678c928fd2952395c1162687787e20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MTcxMA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452651710", "bodyText": "@rnorth I am not sure whether this logic belongs to TransportConfig. Could you please elaborate why you want it there? :)", "author": "bsideup", "createdAt": "2020-07-10T06:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MDM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc0NzE0Mw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452747143", "bodyText": "In practice I'm not finding it fits there either \ud83d\ude04\nThe strategy class works better", "author": "rnorth", "createdAt": "2020-07-10T09:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MDM1Mw=="}], "type": "inlineReview"}, {"oid": "62cdd1a5bc21ef72c372bc6d4bd37b97e823b729", "url": "https://github.com/testcontainers/testcontainers-java/commit/62cdd1a5bc21ef72c372bc6d4bd37b97e823b729", "message": "Use `XDG_RUNTIME_DIR`, add CI", "committedDate": "2020-07-10T06:42:21Z", "type": "commit"}, {"oid": "e1d8f5ac28f3e9d1a5f02c3685f4bd0bc0f8c03a", "url": "https://github.com/testcontainers/testcontainers-java/commit/e1d8f5ac28f3e9d1a5f02c3685f4bd0bc0f8c03a", "message": "run all `core` tests with Rootless Docker", "committedDate": "2020-07-10T10:18:14Z", "type": "commit"}, {"oid": "0b13156d114342df6a501126516c1029e97d0831", "url": "https://github.com/testcontainers/testcontainers-java/commit/0b13156d114342df6a501126516c1029e97d0831", "message": "Fix local compose", "committedDate": "2020-07-10T11:47:45Z", "type": "commit"}, {"oid": "fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12", "url": "https://github.com/testcontainers/testcontainers-java/commit/fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12", "message": "fix `docker-credential-fake`", "committedDate": "2020-07-10T11:56:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1MzI3Nw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452853277", "bodyText": "\ud83d\ude02 for our tests, could we do this using the host socket URI?", "author": "rnorth", "createdAt": "2020-07-10T13:45:41Z", "path": "core/src/test/java/org/testcontainers/containers/GenericContainerTest.java", "diffHunk": "@@ -21,6 +24,9 @@\n \n     @Test\n     public void shouldReportOOMAfterWait() {\n+        Info info = DockerClientFactory.instance().client().infoCmd().exec();\n+        // Poor man's rootless Docker detection :D", "originalCommit": "fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NDA2MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r453354060", "bodyText": "I didn't want to do string matching, especially given that the feature is experimental and may change the socket location.\nApparently, Docker returns rootless security capability from the info endpoint, just docker-java does not expose it (yet). I will add it to docker-java, so that we can remove this workaround, okay? :)", "author": "bsideup", "createdAt": "2020-07-12T19:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1MzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MzMyOQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r453853329", "bodyText": "Cool, I was wondering if that would be the case. Let's not hold up this PR for the change in docker-java, though - it's OK as-is.", "author": "rnorth", "createdAt": "2020-07-13T18:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1MzI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MTk0MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452861940", "bodyText": "Do we want this to be the highest priority? I'd put this lower than UnixSocketClientProviderStrategy, at least after #1771 is merged (so that DOCKER_HOST is always respected, non-rootless-docker is tried first, and automatically configured rootless docker is tried last of all)", "author": "rnorth", "createdAt": "2020-07-10T13:59:58Z", "path": "core/src/main/java/org/testcontainers/dockerclient/RootlessDockerClientProviderStrategy.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.testcontainers.dockerclient;\n+\n+import com.sun.jna.Library;\n+import com.sun.jna.Native;\n+import org.apache.commons.lang.SystemUtils;\n+\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ *\n+ * @deprecated this class is used by the SPI and should not be used directly\n+ */\n+@Deprecated\n+public final class RootlessDockerClientProviderStrategy extends DockerClientProviderStrategy {\n+\n+    public static final int PRIORITY = EnvironmentAndSystemPropertyClientProviderStrategy.PRIORITY + 20;", "originalCommit": "fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2NDkxNg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452864916", "bodyText": "I didn't want rootless DOCKER_HOST to take precedence (because we need to override the host ip) but yeah, I see what you mean.\nI will make it have lower priority, but ensure that EnvAndSysPropsStrategy does not detect rootless host that easily", "author": "bsideup", "createdAt": "2020-07-10T14:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MTk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1ODE4OQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r453358189", "bodyText": "update:\nwith overridable host, it is no longer a problem when EnvAndSysPropsStrategy detects the rootless DOCKER_HOST", "author": "bsideup", "createdAt": "2020-07-12T20:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MTk0MA=="}], "type": "inlineReview"}, {"oid": "5ae6ef64ffbd4b8f4b71645275ea73dd6cfeebfd", "url": "https://github.com/testcontainers/testcontainers-java/commit/5ae6ef64ffbd4b8f4b71645275ea73dd6cfeebfd", "message": "debug", "committedDate": "2020-07-10T14:09:23Z", "type": "commit"}, {"oid": "dd7cc6fb3fc3948d69261b95269f9ec0eabc14f4", "url": "https://github.com/testcontainers/testcontainers-java/commit/dd7cc6fb3fc3948d69261b95269f9ec0eabc14f4", "message": "Use `Native.loadLibrary` for better compatibility with JNA 4.x", "committedDate": "2020-07-10T15:09:10Z", "type": "commit"}, {"oid": "53f5a4246681e2f0c57bb32a17fe32bfaaba6826", "url": "https://github.com/testcontainers/testcontainers-java/commit/53f5a4246681e2f0c57bb32a17fe32bfaaba6826", "message": "Merge branch 'master' into rootless_docker", "committedDate": "2020-07-11T19:06:03Z", "type": "commit"}, {"oid": "59761964e48decf20ba34638ff877b7d23cf9392", "url": "https://github.com/testcontainers/testcontainers-java/commit/59761964e48decf20ba34638ff877b7d23cf9392", "message": "change the priority and remove hardcoded \"localhost\"", "committedDate": "2020-07-11T19:07:48Z", "type": "commit"}, {"oid": "72ad8d23f0aad462c886bc28b83f2d5dd367c758", "url": "https://github.com/testcontainers/testcontainers-java/commit/72ad8d23f0aad462c886bc28b83f2d5dd367c758", "message": "Merge branch 'master' into rootless_docker", "committedDate": "2020-07-12T16:23:30Z", "type": "commit"}, {"oid": "8dc8c7942114897e6aa07c46e5b82911ccb5641c", "url": "https://github.com/testcontainers/testcontainers-java/commit/8dc8c7942114897e6aa07c46e5b82911ccb5641c", "message": "make `UnixSocketClientProviderStrategy` work on Mac (again :D)", "committedDate": "2020-07-12T16:32:52Z", "type": "commit"}, {"oid": "f7f1a081fc4f2ccb44216fa6313668ba3d92a894", "url": "https://github.com/testcontainers/testcontainers-java/commit/f7f1a081fc4f2ccb44216fa6313668ba3d92a894", "message": "Allow overriding host's Docker socket", "committedDate": "2020-07-12T16:33:19Z", "type": "commit"}, {"oid": "7ff171f81178d21aae8e4f7a8d0801a70aad156d", "url": "https://github.com/testcontainers/testcontainers-java/commit/7ff171f81178d21aae8e4f7a8d0801a70aad156d", "message": "Document the overrides", "committedDate": "2020-07-12T16:41:41Z", "type": "commit"}, {"oid": "b9ffae3b5c5d0984dace5d68273b030545ce9f97", "url": "https://github.com/testcontainers/testcontainers-java/commit/b9ffae3b5c5d0984dace5d68273b030545ce9f97", "message": "add a new line", "committedDate": "2020-07-12T16:45:18Z", "type": "commit"}, {"oid": "cb01cc87e91ccca06551ebbf80588910c4b6b22f", "url": "https://github.com/testcontainers/testcontainers-java/commit/cb01cc87e91ccca06551ebbf80588910c4b6b22f", "message": "Mention `DOCKER_HOST` as well", "committedDate": "2020-07-13T20:44:09Z", "type": "commit"}, {"oid": "8b1e44001602cf3f90aca0a3e9ca231383119dd1", "url": "https://github.com/testcontainers/testcontainers-java/commit/8b1e44001602cf3f90aca0a3e9ca231383119dd1", "message": "fix the DOCKER_HOST link", "committedDate": "2020-07-14T09:25:07Z", "type": "commit"}, {"oid": "17f531f289b310dca2d63700590470fce328e2b8", "url": "https://github.com/testcontainers/testcontainers-java/commit/17f531f289b310dca2d63700590470fce328e2b8", "message": "Add examples", "committedDate": "2020-07-15T08:42:56Z", "type": "commit"}]}