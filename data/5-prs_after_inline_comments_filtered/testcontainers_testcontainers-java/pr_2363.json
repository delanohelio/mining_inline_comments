{"pr_number": 2363, "pr_title": "Fix internal port check when other ports are opened as well on the target container", "pr_createdAt": "2020-02-18T15:39:04Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2363", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEzNjQzNg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2363#discussion_r381136436", "bodyText": "You can keep @Rule if you move the container creation to constructor (JUnit supports parameterized constructors if I remember correctly)", "author": "bsideup", "createdAt": "2020-02-19T08:22:26Z", "path": "core/src/test/java/org/testcontainers/containers/wait/internal/InternalCommandPortListeningCheckTest.java", "diffHunk": "@@ -1,25 +1,53 @@\n package org.testcontainers.containers.wait.internal;\n \n import com.google.common.collect.ImmutableSet;\n-import org.junit.Rule;\n+import org.junit.After;\n+import org.junit.Before;\n import org.junit.Test;\n-import org.testcontainers.containers.BindMode;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n \n+import static java.util.Arrays.asList;\n import static org.rnorth.visibleassertions.VisibleAssertions.assertFalse;\n import static org.rnorth.visibleassertions.VisibleAssertions.assertTrue;\n \n+@RunWith(Parameterized.class)\n public class InternalCommandPortListeningCheckTest {\n \n-    // Linking a custom configuration into the container so that nginx is listening on port 8080. This is necessary to prove\n-    // that the command formatting uses the correct casing for hexadecimal numbers (i.e. 1F90 and not 1f90).\n-    @Rule\n-    public GenericContainer nginx = new GenericContainer<>(\"nginx:1.9.4\")\n-            .withClasspathResourceMapping(\"nginx_on_8080.conf\", \"/etc/nginx/conf.d/default.conf\", BindMode.READ_ONLY);\n+    @Parameterized.Parameter\n+    public String dockerfile;\n+\n+    @Parameterized.Parameters(name = \"{index} - {0}\")\n+    public static Iterable<Object[]> data() {\n+        return asList(\n+            new Object[][]{\n+                {\"internal-port-check-dockerfile/Dockerfile-tcp\"},\n+                {\"internal-port-check-dockerfile/Dockerfile-nc\"},\n+                {\"internal-port-check-dockerfile/Dockerfile-bash\"},\n+            });\n+    }\n+\n+    public GenericContainer container;\n+\n+    @Before\n+    public void setUp() {\n+        container = new GenericContainer(new ImageFromDockerfile()", "originalCommit": "82be9da934c481a6474a3cef6045eece99c02cdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEzOTM5OQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2363#discussion_r381139399", "bodyText": "Tried this already and it results in NullPointerException due to dockerfile being null", "author": "codablock", "createdAt": "2020-02-19T08:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEzNjQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEzOTczMg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2363#discussion_r381139732", "bodyText": "it is of course null because it's a field. You need to delete the field and replace it with constructor's parameter", "author": "bsideup", "createdAt": "2020-02-19T08:29:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEzNjQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0NTc5Mg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2363#discussion_r381145792", "bodyText": "Hmm ok after some trial and error I figured out how to use a @Rule here. Hope it's actually what you referred to.", "author": "codablock", "createdAt": "2020-02-19T08:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEzNjQzNg=="}], "type": "inlineReview"}, {"oid": "592cc2defb75dabd6fd377b6182926fc5ab118ab", "url": "https://github.com/testcontainers/testcontainers-java/commit/592cc2defb75dabd6fd377b6182926fc5ab118ab", "message": "Check for bash existence instead of only mentioning it in a comment", "committedDate": "2020-02-19T08:31:22Z", "type": "forcePushed"}, {"oid": "97f1695e7a371d94e8cd05682254db7361a4fbcd", "url": "https://github.com/testcontainers/testcontainers-java/commit/97f1695e7a371d94e8cd05682254db7361a4fbcd", "message": "Wait a few seconds for InternalCommandPortListeningCheck to pass", "committedDate": "2020-02-19T21:31:15Z", "type": "forcePushed"}, {"oid": "b6c1b7f328f5bdd26fd5f0176b03a02470ae5575", "url": "https://github.com/testcontainers/testcontainers-java/commit/b6c1b7f328f5bdd26fd5f0176b03a02470ae5575", "message": "Remove redundant execCreateCmd call\n\nThis one is never used and probably causes some garbage on the docker side.", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "1c7aeee7da16e1b6bed4e3165862ed12f3b9f495", "url": "https://github.com/testcontainers/testcontainers-java/commit/1c7aeee7da16e1b6bed4e3165862ed12f3b9f495", "message": "Allow leading zeros in /proc/net/tcp* when doing internal port listen check\n\nWhen at least one process is listening for a port that is significantly\nhigher then the port we're checking, this check will fail as the checked\nport will contain leading zeros in the output of \"cat /proc/net/tcp\".\n\nThis commit fixes this by changing the grep to \":0*XXX\".", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "0ace0ebf245bd8b9e7e325ae8c074e4883e2d9f3", "url": "https://github.com/testcontainers/testcontainers-java/commit/0ace0ebf245bd8b9e7e325ae8c074e4883e2d9f3", "message": "Surround grep parameter with '\n\nOtherwise unnecessary shell expansion is tried", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "d22fa3e52691287272aa67dac7b43e0da1031b25", "url": "https://github.com/testcontainers/testcontainers-java/commit/d22fa3e52691287272aa67dac7b43e0da1031b25", "message": "Refactor/Rewrite InternalCommandPortListeningCheckTest to test all possible checks\n\nThis commit refactors InternalCommandPortListeningCheckTest to work with\n3 different nginx based containers, each being able to only succeed one of\nthe 3 tests performed in InternalCommandPortListeningCheck. Each test is\nnow executed agains all 3 containers to ensure that all tests work as\nexpected.", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "ee4e92c6fdcd50aa2688ba0c9136f0d2913983b3", "url": "https://github.com/testcontainers/testcontainers-java/commit/ee4e92c6fdcd50aa2688ba0c9136f0d2913983b3", "message": "Add test for low+high ports\n\nThis test should fail without the leading zeros fix found a few commits\nbefore this one.", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "365a9b0192c9884e6c19800c9ae1b9ac2d9d5add", "url": "https://github.com/testcontainers/testcontainers-java/commit/365a9b0192c9884e6c19800c9ae1b9ac2d9d5add", "message": "Check for bash existence instead of only mentioning it in a comment", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "885df869c1ad96a2e207f0235b18fda2f5f13dd7", "url": "https://github.com/testcontainers/testcontainers-java/commit/885df869c1ad96a2e207f0235b18fda2f5f13dd7", "message": "Rename nginx_on_8080.conf to nginx.conf\n\nIt's not only port 8080 anymore, so better not have it in the name.", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "4df12fc59bd3dfaf9cd6dea340f2c68c3e1351b5", "url": "https://github.com/testcontainers/testcontainers-java/commit/4df12fc59bd3dfaf9cd6dea340f2c68c3e1351b5", "message": "Make container a @Rule again by moving initialization into contructor", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "df6c38abf512161f24abc0b75e1bbe1f75b4d34b", "url": "https://github.com/testcontainers/testcontainers-java/commit/df6c38abf512161f24abc0b75e1bbe1f75b4d34b", "message": "Wait a few seconds for InternalCommandPortListeningCheck to pass", "committedDate": "2020-02-24T13:26:40Z", "type": "commit"}, {"oid": "df6c38abf512161f24abc0b75e1bbe1f75b4d34b", "url": "https://github.com/testcontainers/testcontainers-java/commit/df6c38abf512161f24abc0b75e1bbe1f75b4d34b", "message": "Wait a few seconds for InternalCommandPortListeningCheck to pass", "committedDate": "2020-02-24T13:26:40Z", "type": "forcePushed"}]}