{"pr_number": 9240, "pr_title": "Merging the scope-role mappings when updating the role permissions (from Admin portal)", "pr_createdAt": "2020-08-21T15:02:59Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9240", "timeline": [{"oid": "2f1f0eeacc5ae60edf6305664cd3dd34f60af94d", "url": "https://github.com/wso2/carbon-apimgt/commit/2f1f0eeacc5ae60edf6305664cd3dd34f60af94d", "message": "Modify updateTenantConfOfRoleScopeMapping function to merge mappings", "committedDate": "2020-08-21T14:22:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NjQ3OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#discussion_r475066478", "bodyText": "Assigning newTenantConfScopesArray into mergedTenantConfScopesArray will just keep references.\nAfter adding an element to mergedTenantConfScopesArray, that will also appear in newTenantConfScopesArray.\nShould we take a copy and assign instead?\neg:\nJsonElement newTenantConfScopes = new JsonParser().parse(newScopeRoleJson.toJSONString());", "author": "malinthaprasan", "createdAt": "2020-08-22T09:06:51Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -11525,28 +11527,68 @@ public static void updateTenantConfOfRoleScopeMapping(JSONObject newScopeRoleJso\n         } catch (UserStoreException e) {\n             APIUtil.handleException(\"Couldn't read tenant configuration from user-store\", e);\n         }\n-        //Here we are removing RESTAPIScopes from the existing tenant-conf\n-        // Adding new RESTAPIScopes to the existing tenant-conf.\n+        JsonElement existingTenantConfScopes = existingTenantConfObject.get(APIConstants.REST_API_SCOPES_CONFIG);\n+        JsonElement newTenantConfScopes = new JsonParser().parse(newScopeRoleJson.toJSONString());\n+        JsonObject mergedTenantConfScopes = mergeTenantConfScopes(existingTenantConfScopes, newTenantConfScopes);\n+\n+        // Removing the old RESTAPIScopes config from the existing tenant-conf\n         existingTenantConfObject.remove(APIConstants.REST_API_SCOPES_CONFIG);\n-        JsonElement jsonElement = new JsonParser().parse(newScopeRoleJson.toJSONString());\n-        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, jsonElement);\n-        try {\n-            ObjectMapper mapper = new ObjectMapper();\n-            String formattedTenantConf = mapper.writerWithDefaultPrettyPrinter()\n-                    .writeValueAsString(existingTenantConfObject.toString());\n-            APIUtil.updateTenantConf(existingTenantConfObject.toString(), tenantDomain);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n-            }\n-        } catch (JsonProcessingException e) {\n-            throw new APIManagementException(\"Error while formatting tenant-conf.json of tenant\", e);\n+        // Adding the merged RESTAPIScopes config to the tenant-conf\n+        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, mergedTenantConfScopes);\n+\n+        // Prettify the tenant-conf\n+        Gson gson = new GsonBuilder().setPrettyPrinting().create();\n+        String formattedTenantConf = gson.toJson(existingTenantConfObject);\n+\n+        APIUtil.updateTenantConf(formattedTenantConf, tenantDomain);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n         }\n         // Invalidate Cache\n         Caching.getCacheManager(APIConstants.API_MANAGER_CACHE_MANAGER)\n                 .getCache(APIConstants.REST_API_SCOPE_CACHE)\n                 .put(tenantDomain, null);\n     }\n \n+    /**\n+     * Merge the existing and new scope-role mappings (RESTAPIScopes config) in the tenant-conf\n+     *\n+     * @param existingTenantConfScopes Existing (old) scope-role mappings\n+     * @param newTenantConfScopes      Modified (new) scope-role mappings\n+     */\n+    public static JsonObject mergeTenantConfScopes(JsonElement existingTenantConfScopes, JsonElement newTenantConfScopes) {\n+        JsonArray existingTenantConfScopesArray = (JsonArray) existingTenantConfScopes.getAsJsonObject().\n+                get(APIConstants.REST_API_SCOPE);\n+        JsonArray newTenantConfScopesArray = (JsonArray) newTenantConfScopes.getAsJsonObject().\n+                get(APIConstants.REST_API_SCOPE);\n+        JsonArray mergedTenantConfScopesArray = newTenantConfScopesArray;", "originalCommit": "2f1f0eeacc5ae60edf6305664cd3dd34f60af94d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA4MDI5OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#discussion_r475080299", "bodyText": "Fixed via e4ae8e8", "author": "wasuradananjith", "createdAt": "2020-08-22T11:19:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NjQ3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NjU2MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#discussion_r475066560", "bodyText": "See the previous comment regarding this line(11584) and 11575", "author": "malinthaprasan", "createdAt": "2020-08-22T09:07:48Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -11525,28 +11527,68 @@ public static void updateTenantConfOfRoleScopeMapping(JSONObject newScopeRoleJso\n         } catch (UserStoreException e) {\n             APIUtil.handleException(\"Couldn't read tenant configuration from user-store\", e);\n         }\n-        //Here we are removing RESTAPIScopes from the existing tenant-conf\n-        // Adding new RESTAPIScopes to the existing tenant-conf.\n+        JsonElement existingTenantConfScopes = existingTenantConfObject.get(APIConstants.REST_API_SCOPES_CONFIG);\n+        JsonElement newTenantConfScopes = new JsonParser().parse(newScopeRoleJson.toJSONString());\n+        JsonObject mergedTenantConfScopes = mergeTenantConfScopes(existingTenantConfScopes, newTenantConfScopes);\n+\n+        // Removing the old RESTAPIScopes config from the existing tenant-conf\n         existingTenantConfObject.remove(APIConstants.REST_API_SCOPES_CONFIG);\n-        JsonElement jsonElement = new JsonParser().parse(newScopeRoleJson.toJSONString());\n-        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, jsonElement);\n-        try {\n-            ObjectMapper mapper = new ObjectMapper();\n-            String formattedTenantConf = mapper.writerWithDefaultPrettyPrinter()\n-                    .writeValueAsString(existingTenantConfObject.toString());\n-            APIUtil.updateTenantConf(existingTenantConfObject.toString(), tenantDomain);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n-            }\n-        } catch (JsonProcessingException e) {\n-            throw new APIManagementException(\"Error while formatting tenant-conf.json of tenant\", e);\n+        // Adding the merged RESTAPIScopes config to the tenant-conf\n+        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, mergedTenantConfScopes);\n+\n+        // Prettify the tenant-conf\n+        Gson gson = new GsonBuilder().setPrettyPrinting().create();\n+        String formattedTenantConf = gson.toJson(existingTenantConfObject);\n+\n+        APIUtil.updateTenantConf(formattedTenantConf, tenantDomain);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n         }\n         // Invalidate Cache\n         Caching.getCacheManager(APIConstants.API_MANAGER_CACHE_MANAGER)\n                 .getCache(APIConstants.REST_API_SCOPE_CACHE)\n                 .put(tenantDomain, null);\n     }\n \n+    /**\n+     * Merge the existing and new scope-role mappings (RESTAPIScopes config) in the tenant-conf\n+     *\n+     * @param existingTenantConfScopes Existing (old) scope-role mappings\n+     * @param newTenantConfScopes      Modified (new) scope-role mappings\n+     */\n+    public static JsonObject mergeTenantConfScopes(JsonElement existingTenantConfScopes, JsonElement newTenantConfScopes) {\n+        JsonArray existingTenantConfScopesArray = (JsonArray) existingTenantConfScopes.getAsJsonObject().\n+                get(APIConstants.REST_API_SCOPE);\n+        JsonArray newTenantConfScopesArray = (JsonArray) newTenantConfScopes.getAsJsonObject().\n+                get(APIConstants.REST_API_SCOPE);\n+        JsonArray mergedTenantConfScopesArray = newTenantConfScopesArray;\n+\n+        // Iterating the existing (old) scope-role mappings\n+        for (int i = 0; i < existingTenantConfScopesArray.size(); i++) {\n+            JsonObject existingScopeRoleMapping = existingTenantConfScopesArray.get(i).getAsJsonObject();\n+            String existingScopeName = existingScopeRoleMapping.get(APIConstants.REST_API_SCOPE_NAME).getAsString();\n+            Boolean isExist = false;\n+            // Iterating the modified (new) scope-role mappings and add the old scope mappings\n+            // if those are not present in the list (merging)\n+            for (int j = 0; j < newTenantConfScopesArray.size(); j++) {\n+                JsonObject newScopeRoleMapping = newTenantConfScopesArray.get(j).getAsJsonObject();\n+                String newScopeName = newScopeRoleMapping.get(APIConstants.REST_API_SCOPE_NAME).getAsString();\n+                if (StringUtils.equals(existingScopeName, newScopeName)) {\n+                    // If a particular mapping is already there, skip it\n+                    isExist = true;\n+                    break;\n+                }\n+            }\n+            // If the particular old mapping does not exist in the new list, add it to the new list\n+            if (!isExist) {\n+                mergedTenantConfScopesArray.add(existingTenantConfScopesArray.get(i));", "originalCommit": "2f1f0eeacc5ae60edf6305664cd3dd34f60af94d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA4MDMyNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#discussion_r475080325", "bodyText": "Fixed via e4ae8e8", "author": "wasuradananjith", "createdAt": "2020-08-22T11:19:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NjU2MA=="}], "type": "inlineReview"}, {"oid": "e4ae8e86470316815eaf552cd929bd3dc958062c", "url": "https://github.com/wso2/carbon-apimgt/commit/e4ae8e86470316815eaf552cd929bd3dc958062c", "message": "Take a copy of the newTenantConfScopesArray properly", "committedDate": "2020-08-22T11:17:10Z", "type": "commit"}, {"oid": "fc9e710358bca075f31257c8f24dba8427f8a185", "url": "https://github.com/wso2/carbon-apimgt/commit/fc9e710358bca075f31257c8f24dba8427f8a185", "message": "Modify java doc comments and restructure loops", "committedDate": "2020-08-25T09:24:51Z", "type": "commit"}, {"oid": "fc9e710358bca075f31257c8f24dba8427f8a185", "url": "https://github.com/wso2/carbon-apimgt/commit/fc9e710358bca075f31257c8f24dba8427f8a185", "message": "Modify java doc comments and restructure loops", "committedDate": "2020-08-25T09:24:51Z", "type": "forcePushed"}]}