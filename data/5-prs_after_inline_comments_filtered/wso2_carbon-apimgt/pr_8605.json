{"pr_number": 8605, "pr_title": "Added REST API to validate a given user has a particular scope.", "pr_createdAt": "2020-05-29T05:04:42Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8605", "timeline": [{"oid": "54737c9c8d5c1290da972c783a5f248ef8e3ca44", "url": "https://github.com/wso2/carbon-apimgt/commit/54737c9c8d5c1290da972c783a5f248ef8e3ca44", "message": "Added REST API to validate the scope.", "committedDate": "2020-05-29T03:39:35Z", "type": "commit"}, {"oid": "774875487fc29e0396e2c0c67324cfd2561eaf37", "url": "https://github.com/wso2/carbon-apimgt/commit/774875487fc29e0396e2c0c67324cfd2561eaf37", "message": "Modified scope name as path parameter.", "committedDate": "2020-05-29T19:10:03Z", "type": "commit"}, {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8", "url": "https://github.com/wso2/carbon-apimgt/commit/3343b30ba7de5360c87229c7a0c33c89d11348b8", "message": "Corrected the cURL request sample.", "committedDate": "2020-05-29T19:18:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjQ1Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433046457", "bodyText": "add username in the log", "author": "tgtshanika", "createdAt": "2020-06-01T05:23:47Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SettingsApiServiceImpl.java", "diffHunk": "@@ -51,4 +55,38 @@ public Response settingsGet(MessageContext messageContext) {\n         }\n         return null;\n     }\n+\n+    /**\n+     * Get all scopes of a user\n+     *\n+     * @param username Search query\n+     * @return Scope list\n+     */\n+    @Override\n+    public Response settingsScopesScopeGet(String username, String scopeName, MessageContext messageContext) {\n+        String[] userRoles;\n+        ScopeSettingsDTO scopeSettingsDTO = new ScopeSettingsDTO();\n+        ErrorDTO errorDTO = new ErrorDTO();\n+\n+        try {\n+            if (APIUtil.isUserExist(username) && APIUtil.getRESTAPIScopesForTenant(MultitenantUtils\n+                    .getTenantDomain(username)).containsKey(scopeName)) {\n+                userRoles = APIUtil.getListOfRoles(username);\n+                SettingsMappingUtil settingsMappingUtil = new SettingsMappingUtil();\n+\n+                if (settingsMappingUtil.GetRoleScopeList(userRoles, username).contains(scopeName)) {\n+                    scopeSettingsDTO.setName(scopeName);\n+                }\n+            } else {\n+                errorDTO.setCode(404l);\n+                errorDTO.description(\"Username or Scope does not exist\");\n+                errorDTO.setMessage(\"Not Found\");\n+                return Response.ok().entity(errorDTO).build();\n+            }\n+        } catch (APIManagementException e) {\n+            String errorMessage = \"Error when getting the list of scopes\";", "originalCommit": "3343b30ba7de5360c87229c7a0c33c89d11348b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYzODk4MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433638980", "bodyText": "Fixed with 5510d27", "author": "Meruja", "createdAt": "2020-06-02T06:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjczOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433046739", "bodyText": "We are retrieving the scopes twice.", "author": "tgtshanika", "createdAt": "2020-06-01T05:25:08Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "diffHunk": "@@ -67,4 +71,27 @@ public SettingsDTO fromSettingstoDTO(Boolean isUserAvailable) throws APIManageme\n         }\n         return scopeList;\n     }\n+\n+    public List<String> GetRoleScopeList(String[] userRoles, String username) {\n+        List<String> userRoleList;\n+        List<String> authorizedScopes = new ArrayList<>();\n+\n+        if (userRoles == null || userRoles.length == 0) {\n+            userRoles = new String[0];\n+        }\n+\n+        userRoleList = Arrays.asList(userRoles);\n+        Map<String, String> scopeRoleMapping =\n+                APIUtil.getRESTAPIScopesForTenant(MultitenantUtils.getTenantDomain(username));", "originalCommit": "3343b30ba7de5360c87229c7a0c33c89d11348b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYzODkxMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433638913", "bodyText": "Fixed with 5510d27", "author": "Meruja", "createdAt": "2020-06-02T06:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NzAyNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433047025", "bodyText": "possible NPE?", "author": "tgtshanika", "createdAt": "2020-06-01T05:26:24Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "diffHunk": "@@ -67,4 +71,27 @@ public SettingsDTO fromSettingstoDTO(Boolean isUserAvailable) throws APIManageme\n         }\n         return scopeList;\n     }\n+\n+    public List<String> GetRoleScopeList(String[] userRoles, String username) {\n+        List<String> userRoleList;\n+        List<String> authorizedScopes = new ArrayList<>();\n+\n+        if (userRoles == null || userRoles.length == 0) {\n+            userRoles = new String[0];\n+        }\n+\n+        userRoleList = Arrays.asList(userRoles);\n+        Map<String, String> scopeRoleMapping =\n+                APIUtil.getRESTAPIScopesForTenant(MultitenantUtils.getTenantDomain(username));\n+        Iterator<Map.Entry<String, String>> iterator = scopeRoleMapping.entrySet().iterator();", "originalCommit": "3343b30ba7de5360c87229c7a0c33c89d11348b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEwOTQ3Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433109472", "bodyText": "Since we are getting all the scopes from the tenant and extract the scopes that mapped with the user's roles. There would be scope for all roles as per scopeIssuer. In this case, we won't get NPE.", "author": "Meruja", "createdAt": "2020-06-01T08:35:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NzAyNQ=="}], "type": "inlineReview"}, {"oid": "5510d27701692c0e352ff2194d6a95d43c49d3ea", "url": "https://github.com/wso2/carbon-apimgt/commit/5510d27701692c0e352ff2194d6a95d43c49d3ea", "message": "Corrected review comments.", "committedDate": "2020-06-02T05:57:52Z", "type": "commit"}]}