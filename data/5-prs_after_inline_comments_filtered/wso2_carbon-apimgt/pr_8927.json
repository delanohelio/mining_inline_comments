{"pr_number": 8927, "pr_title": "Add Database Functionality for Tenant Theme Import Export", "pr_createdAt": "2020-07-05T07:40:10Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8927", "timeline": [{"oid": "d3ccd5b9b2004b161bea73ea02b9fdc7518327f2", "url": "https://github.com/wso2/carbon-apimgt/commit/d3ccd5b9b2004b161bea73ea02b9fdc7518327f2", "message": "Modify tenant theme add and update methods", "committedDate": "2020-07-06T07:17:47Z", "type": "forcePushed"}, {"oid": "c50817bed7c88a3de4fd5df672104223201738ac", "url": "https://github.com/wso2/carbon-apimgt/commit/c50817bed7c88a3de4fd5df672104223201738ac", "message": "Modify tenant theme add and update methods", "committedDate": "2020-07-07T04:29:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNjk1Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8927#discussion_r450606957", "bodyText": "Shall we propagate the \"e\" object as well? Otherwise, the stacktrace will be swallowed.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new APIManagementException(e.getMessage(),\n          \n          \n            \n                                ExceptionCodes.from(ExceptionCodes.TENANT_THEME_IMPORT_FAILED, tenantDomain, e.getMessage()));\n          \n          \n            \n                        throw new APIManagementException(e.getMessage(), e,\n          \n          \n            \n                                ExceptionCodes.from(ExceptionCodes.TENANT_THEME_IMPORT_FAILED, tenantDomain, e.getMessage()));", "author": "malinthaprasan", "createdAt": "2020-07-07T04:40:45Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/TenantThemeApiServiceImpl.java", "diffHunk": "@@ -16,43 +16,98 @@\n  */\n package org.wso2.carbon.apimgt.rest.api.admin.v1.impl;\n \n+import org.apache.commons.io.FileUtils;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.apimgt.api.APIManagementException;\n \n import org.apache.cxf.jaxrs.ext.multipart.Attachment;\n import org.apache.cxf.jaxrs.ext.MessageContext;\n+import org.wso2.carbon.apimgt.api.ExceptionCodes;\n+import org.wso2.carbon.apimgt.impl.APIAdminImpl;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.utils.APIUtil;\n import org.wso2.carbon.apimgt.rest.api.admin.v1.TenantThemeApiService;\n import org.wso2.carbon.apimgt.rest.api.admin.v1.utils.RestApiAdminUtils;\n+import org.wso2.carbon.apimgt.rest.api.util.RestApiConstants;\n import org.wso2.carbon.apimgt.rest.api.util.utils.RestApiUtil;\n+import org.wso2.carbon.utils.multitenancy.MultitenantConstants;\n \n+import java.io.File;\n+import java.io.IOException;\n import java.io.InputStream;\n \n+import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.Response;\n \n public class TenantThemeApiServiceImpl implements TenantThemeApiService {\n \n     private static final Log log = LogFactory.getLog(TenantThemeApiServiceImpl.class);\n+    private static final String TENANT_THEMES_EXPORT_DIR_PREFIX = \"exported-tenant-themes\";\n \n     /**\n-     * Import an Tenant Theme for a particular tenant by uploading an archive file.\n+     * Import a Tenant Theme for a particular tenant by uploading an archive file.\n      *\n      * @param fileInputStream content relevant to the tenant theme\n      * @param fileDetail      file details as Attachment\n+     * @param messageContext\n      * @return Theme import response\n+     * @throws APIManagementException if an error occurs when importing a tenant theme\n      */\n     @Override\n-    public Response tenantThemeImportPost(InputStream fileInputStream, Attachment fileDetail,\n-                                          MessageContext messageContext) {\n+    public Response importTenantTheme(InputStream fileInputStream, Attachment fileDetail, MessageContext messageContext)\n+            throws APIManagementException {\n \n         String tenantDomain = RestApiUtil.getLoggedInUserTenantDomain();\n+        if (MultitenantConstants.SUPER_TENANT_DOMAIN_NAME.equals(tenantDomain)) {\n+            String errorMessage = \"Super Tenant \" + MultitenantConstants.SUPER_TENANT_DOMAIN_NAME +\n+                    \" is not allowed to import a tenant theme\";\n+            throw new APIManagementException(errorMessage,\n+                    ExceptionCodes.from(ExceptionCodes.TENANT_THEME_IMPORT_NOT_ALLOWED,\n+                            MultitenantConstants.SUPER_TENANT_DOMAIN_NAME));\n+        }\n+\n         try {\n-            RestApiAdminUtils.deployTenantTheme(fileInputStream, tenantDomain);\n+            RestApiAdminUtils.importTenantTheme(fileInputStream, tenantDomain);\n             return Response.status(Response.Status.OK).entity(\"Theme imported successfully\").build();\n-        } catch (APIManagementException e) {\n-            String errorMessage = \"Error while importing tenant theme for tenant \" + tenantDomain;\n-            RestApiUtil.handleInternalServerError(errorMessage, e, log);\n+        } catch (IOException e) {\n+            throw new APIManagementException(e.getMessage(),\n+                    ExceptionCodes.from(ExceptionCodes.TENANT_THEME_IMPORT_FAILED, tenantDomain, e.getMessage()));", "originalCommit": "c50817bed7c88a3de4fd5df672104223201738ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNzA2Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8927#discussion_r450607066", "bodyText": "Please fix this in other places as well.", "author": "malinthaprasan", "createdAt": "2020-07-07T04:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNjk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MDgzMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8927#discussion_r450990830", "bodyText": "Fixed with 5c1474f", "author": "hisanhunais", "createdAt": "2020-07-07T16:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNjk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNzkxMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8927#discussion_r450607910", "bodyText": "Did we test this with larger files around several MBs?\nFor the safe-side we can retrieve the theme from the Database without resetting and reusing the stream.", "author": "malinthaprasan", "createdAt": "2020-07-07T04:45:08Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/RestApiAdminUtils.java", "diffHunk": "@@ -156,35 +164,62 @@ public static String constructMissingThrottleObjectErrorMessage(Enum<?> typeEnum\n     }\n \n     /**\n-     * Extract the content of the provided tenant theme archive\n+     * Import the content of the provided tenant theme archive to the file system and the database\n      *\n-     * @param themeFile    content relevant to the tenant theme\n-     * @param tenantDomain tenant to which the theme is imported\n-     * @throws APIManagementException if an error occurs while importing tenant theme\n+     * @param themeContentInputStream content relevant to the tenant theme\n+     * @param tenantDomain            tenant to which the theme is imported\n+     * @throws APIManagementException if an error occurs while importing the tenant theme\n+     * @throws IOException            if an error occurs while performing file or directory related operations\n      */\n-    public static void deployTenantTheme(InputStream themeFile, String tenantDomain) throws APIManagementException {\n+    public static void importTenantTheme(InputStream themeContentInputStream, String tenantDomain)\n+            throws APIManagementException, IOException {\n \n         ZipInputStream zipInputStream = null;\n         byte[] buffer = new byte[1024];\n+        InputStream existingTenantTheme = null;\n+        ByteArrayInputStream themeContent = null;\n+        File tenantThemeDirectory;\n+        File backupDirectory = null;\n \n-        String outputFolder = \"repository\" + File.separator + \"deployment\" + File.separator + \"server\"\n-                + File.separator + \"jaggeryapps\" + File.separator + \"devportal\" + File.separator + \"site\"\n-                + File.separator + \"public\" + File.separator + \"tenant_themes\" + File.separator + tenantDomain;\n+        int tenantId = APIUtil.getTenantIdFromTenantDomain(tenantDomain);\n \n         try {\n-            //create output directory if it does not exist\n-            File folder = new File(outputFolder);\n-            if (!folder.exists()) {\n-                if (!folder.mkdirs()) {\n+            //convert InputStream to ByteArrayInputStream to be able to read the tenant theme content twice\n+            ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+            IOUtils.copy(themeContentInputStream, baos);\n+            byte[] bytes = baos.toByteArray();\n+            themeContent = new ByteArrayInputStream(bytes);\n+\n+            APIAdmin apiAdmin = new APIAdminImpl();\n+            //add or update the tenant theme in the database\n+            if (apiAdmin.isTenantThemeExist(tenantId)) {\n+                existingTenantTheme = apiAdmin.getTenantTheme(tenantId);\n+                apiAdmin.updateTenantTheme(tenantId, themeContent);\n+            } else {\n+                apiAdmin.addTenantTheme(tenantId, themeContent);\n+            }\n+            //reset the InputStream to the initial position since it was completely read when adding to the database\n+            themeContent.reset();", "originalCommit": "c50817bed7c88a3de4fd5df672104223201738ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MDQ0Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8927#discussion_r450990442", "bodyText": "Fixed with b2a2a0d", "author": "hisanhunais", "createdAt": "2020-07-07T16:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNzkxMA=="}], "type": "inlineReview"}, {"oid": "8f2d6c10c3e9d2304aa8948e9495dc3a425b2b87", "url": "https://github.com/wso2/carbon-apimgt/commit/8f2d6c10c3e9d2304aa8948e9495dc3a425b2b87", "message": "Get the theme from db to import it to the file system", "committedDate": "2020-07-07T10:25:21Z", "type": "forcePushed"}, {"oid": "474ab7d0f0815d06977f4213bfa91ac3469f46e5", "url": "https://github.com/wso2/carbon-apimgt/commit/474ab7d0f0815d06977f4213bfa91ac3469f46e5", "message": "Add tenant theme import export resource definitions", "committedDate": "2020-07-07T16:19:54Z", "type": "commit"}, {"oid": "66b3546dbe53b9fb67611089f023b0ea0a50189e", "url": "https://github.com/wso2/carbon-apimgt/commit/66b3546dbe53b9fb67611089f023b0ea0a50189e", "message": "Create Tenant Theme model", "committedDate": "2020-07-07T16:19:54Z", "type": "commit"}, {"oid": "ff3e11cdbe70ab0195ac65afd1213c2d8c7f9da7", "url": "https://github.com/wso2/carbon-apimgt/commit/ff3e11cdbe70ab0195ac65afd1213c2d8c7f9da7", "message": "Create tables to store tenant themes", "committedDate": "2020-07-07T16:19:54Z", "type": "commit"}, {"oid": "3ab7d9110c4a451202afd67344cf7bf688b40451", "url": "https://github.com/wso2/carbon-apimgt/commit/3ab7d9110c4a451202afd67344cf7bf688b40451", "message": "Add database queries for tenant theme", "committedDate": "2020-07-07T16:19:54Z", "type": "commit"}, {"oid": "d1b6216beac2821a59488028705d0b1088e31fdb", "url": "https://github.com/wso2/carbon-apimgt/commit/d1b6216beac2821a59488028705d0b1088e31fdb", "message": "Add tenant theme database implementations", "committedDate": "2020-07-07T16:19:54Z", "type": "commit"}, {"oid": "948fb62038d82906651cc2bbce5b2394c035025f", "url": "https://github.com/wso2/carbon-apimgt/commit/948fb62038d82906651cc2bbce5b2394c035025f", "message": "Add tenant theme REST API layer implementations", "committedDate": "2020-07-07T16:19:54Z", "type": "commit"}, {"oid": "8db4b29a63253c5b03d8ff10c75b8c9180695a3f", "url": "https://github.com/wso2/carbon-apimgt/commit/8db4b29a63253c5b03d8ff10c75b8c9180695a3f", "message": "Improve tenant theme import export implementations", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "2f9f48cbe1bdb378d7d412acace69fa17545e9ae", "url": "https://github.com/wso2/carbon-apimgt/commit/2f9f48cbe1bdb378d7d412acace69fa17545e9ae", "message": "Remove Tenant Theme model", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "ead73bcf5221e98d1f5355218fbf2df92b721d2d", "url": "https://github.com/wso2/carbon-apimgt/commit/ead73bcf5221e98d1f5355218fbf2df92b721d2d", "message": "Handle exceptions related to tenant theme import export", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "c5b80643a4273c328e312b53f321cd79db495265", "url": "https://github.com/wso2/carbon-apimgt/commit/c5b80643a4273c328e312b53f321cd79db495265", "message": "Add functionality to delete tenant theme from database", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "c8131a2f30f822da876f91fdffd66ac1ce374d91", "url": "https://github.com/wso2/carbon-apimgt/commit/c8131a2f30f822da876f91fdffd66ac1ce374d91", "message": "Revamp tenant theme related admin impl methods", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "4ed4603b99cd6765fa9b4c94a70801fc6795152d", "url": "https://github.com/wso2/carbon-apimgt/commit/4ed4603b99cd6765fa9b4c94a70801fc6795152d", "message": "Handle error scenarios related to tenant theme import", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "17b48827f9caa355285cd20fa475d8a3634c1127", "url": "https://github.com/wso2/carbon-apimgt/commit/17b48827f9caa355285cd20fa475d8a3634c1127", "message": "Modify THEME column data type in mysql database", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "3213764a7738c7026b3daf9659ddba0d413ce90d", "url": "https://github.com/wso2/carbon-apimgt/commit/3213764a7738c7026b3daf9659ddba0d413ce90d", "message": "Add limit to attachments sizes sent through the request", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "f32af04bfed6d8781ad41fb9030d2438ab3eac2b", "url": "https://github.com/wso2/carbon-apimgt/commit/f32af04bfed6d8781ad41fb9030d2438ab3eac2b", "message": "Fix error in method which deletes tenant theme from db", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "6d4b100435a4ba4ffa02f7d90fe952a534aea02c", "url": "https://github.com/wso2/carbon-apimgt/commit/6d4b100435a4ba4ffa02f7d90fe952a534aea02c", "message": "Break down import tenant theme method as add and update", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "f8e7fa7ef96e470f15cdec9512c5f2154ab2f1b0", "url": "https://github.com/wso2/carbon-apimgt/commit/f8e7fa7ef96e470f15cdec9512c5f2154ab2f1b0", "message": "Add revert operation for tenant theme import functionality", "committedDate": "2020-07-07T16:19:55Z", "type": "commit"}, {"oid": "a12776b42ad36b8039cf3c139611830f5f2736b4", "url": "https://github.com/wso2/carbon-apimgt/commit/a12776b42ad36b8039cf3c139611830f5f2736b4", "message": "Add and improve java doc comments related to tenant themes", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "54d57a1ccfe845735bd82b99b93cfc500250a2b1", "url": "https://github.com/wso2/carbon-apimgt/commit/54d57a1ccfe845735bd82b99b93cfc500250a2b1", "message": "Modify request attachment size limit to 10MB", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "8e8be4bb5bb9754c99c32ffc2e5d90f59aa9de70", "url": "https://github.com/wso2/carbon-apimgt/commit/8e8be4bb5bb9754c99c32ffc2e5d90f59aa9de70", "message": "Add null check before deleting backup directory", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "84aa1cf2529ed4ac361ce9cdc365ea14fc65214f", "url": "https://github.com/wso2/carbon-apimgt/commit/84aa1cf2529ed4ac361ce9cdc365ea14fc65214f", "message": "Improve tenant theme related error descriptions", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "bd7fefff350557106e40ad818042cb5de28f6673", "url": "https://github.com/wso2/carbon-apimgt/commit/bd7fefff350557106e40ad818042cb5de28f6673", "message": "Move import tenant theme to db codes to RestApiAdminUtils.java", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "f15c57e810c12048cd8cd47535f00754062512f2", "url": "https://github.com/wso2/carbon-apimgt/commit/f15c57e810c12048cd8cd47535f00754062512f2", "message": "Modify tenant theme add and update methods", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "5c1474fe6566ea5d341158fd530da08ab4e6af0b", "url": "https://github.com/wso2/carbon-apimgt/commit/5c1474fe6566ea5d341158fd530da08ab4e6af0b", "message": "Propagate exception object from REST API Layer", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "b2a2a0d1edec4d4fc2ccab24e2751b55fc9b3789", "url": "https://github.com/wso2/carbon-apimgt/commit/b2a2a0d1edec4d4fc2ccab24e2751b55fc9b3789", "message": "Get the theme from db to import it to the file system", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "d01997e074a81cfbb9434b5783c0bbaa0e28225e", "url": "https://github.com/wso2/carbon-apimgt/commit/d01997e074a81cfbb9434b5783c0bbaa0e28225e", "message": "Add 413 response code to theme import resource definition", "committedDate": "2020-07-07T16:19:56Z", "type": "commit"}, {"oid": "d01997e074a81cfbb9434b5783c0bbaa0e28225e", "url": "https://github.com/wso2/carbon-apimgt/commit/d01997e074a81cfbb9434b5783c0bbaa0e28225e", "message": "Add 413 response code to theme import resource definition", "committedDate": "2020-07-07T16:19:56Z", "type": "forcePushed"}]}