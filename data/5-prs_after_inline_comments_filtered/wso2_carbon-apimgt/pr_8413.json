{"pr_number": 8413, "pr_title": "Message Fix Fix Mediation Policies (xml_validator) failing with Global Mediation Extensions with FULL log", "pr_createdAt": "2020-04-17T05:43:26Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8413", "timeline": [{"oid": "cd2e263248421eabdcfcbb1b16229d4e606da1b8", "url": "https://github.com/wso2/carbon-apimgt/commit/cd2e263248421eabdcfcbb1b16229d4e606da1b8", "message": "fix null inputstream when log full", "committedDate": "2020-04-17T05:39:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM5MzIxNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8413#discussion_r496393214", "bodyText": "Shall we fix the formatting issue here?", "author": "npamudika", "createdAt": "2020-09-29T04:47:13Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/utils/GatewayUtils.java", "diffHunk": "@@ -422,24 +423,38 @@ public static boolean handleThreat(org.apache.synapse.MessageContext messageCont\n         if (pipe != null) {\n             bufferedInputStream = new BufferedInputStream(pipe.getInputStream());\n         }\n+        inputStreamMap = new HashMap<>();\n+        String contentType = axis2MC.getProperty(ThreatProtectorConstants.CONTENT_TYPE).toString();\n+\n         if (bufferedInputStream != null) {\n-            ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n-            byte[] buffer = new byte[requestBufferSize];\n-            int length;\n-            while ((length = bufferedInputStream.read(buffer)) > -1) {\n-                byteArrayOutputStream.write(buffer, 0, length);\n+            bufferedInputStream.mark(0);\n+            if (bufferedInputStream.read() != -1){", "originalCommit": "cd2e263248421eabdcfcbb1b16229d4e606da1b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA5MTc1OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8413#discussion_r552091758", "bodyText": "Fixed in the latest Version", "author": "Sarangan0219", "createdAt": "2021-01-05T17:47:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM5MzIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM5MzM5Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8413#discussion_r496393396", "bodyText": "Shall we fix the formatting issue here?", "author": "npamudika", "createdAt": "2020-09-29T04:47:27Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/utils/GatewayUtils.java", "diffHunk": "@@ -422,24 +423,38 @@ public static boolean handleThreat(org.apache.synapse.MessageContext messageCont\n         if (pipe != null) {\n             bufferedInputStream = new BufferedInputStream(pipe.getInputStream());\n         }\n+        inputStreamMap = new HashMap<>();\n+        String contentType = axis2MC.getProperty(ThreatProtectorConstants.CONTENT_TYPE).toString();\n+\n         if (bufferedInputStream != null) {\n-            ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n-            byte[] buffer = new byte[requestBufferSize];\n-            int length;\n-            while ((length = bufferedInputStream.read(buffer)) > -1) {\n-                byteArrayOutputStream.write(buffer, 0, length);\n+            bufferedInputStream.mark(0);\n+            if (bufferedInputStream.read() != -1){\n+                bufferedInputStream.reset();\n+                ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n+                byte[] buffer = new byte[requestBufferSize];\n+                int length;\n+                while ((length = bufferedInputStream.read(buffer)) > -1) {\n+                    byteArrayOutputStream.write(buffer, 0, length);\n+                }\n+                byteArrayOutputStream.flush();\n+                inputStreamSchema = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());\n+                inputStreamXml = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());\n+                inputStreamOriginal = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());\n+                inputStreamJSON = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());\n+            } else {\n+                String payload;\n+                if (ThreatProtectorConstants.APPLICATION_JSON.equals(contentType)){", "originalCommit": "cd2e263248421eabdcfcbb1b16229d4e606da1b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA5MTk2MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8413#discussion_r552091961", "bodyText": "Fixed in the latest Versions", "author": "Sarangan0219", "createdAt": "2021-01-05T17:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM5MzM5Ng=="}], "type": "inlineReview"}]}