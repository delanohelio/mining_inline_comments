{"pr_number": 8753, "pr_title": "improve certificate as a file in key manager creation", "pr_createdAt": "2020-06-15T12:02:31Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8753", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyNzg4MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8753#discussion_r440127880", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-15T12:05:44Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -10796,6 +10806,27 @@ public static KeyManagerConfigurationDTO getAndSetDefaultKeyManagerConfiguration\n                 APIConstants.KeyManager.CLAIM_MAPPING)){\n             keyManagerConfigurationDTO.addProperty(APIConstants.KeyManager.CLAIM_MAPPING, getDefaultClaimMappings());\n         }\n+        if (!keyManagerConfigurationDTO.getAdditionalProperties().containsKey(APIConstants.KeyManager.CERTIFICATE_TYPE)){", "originalCommit": "3c38102c3f7ccf96deb6921daade400dc2a3240f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyODA3Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8753#discussion_r440128076", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-15T12:06:04Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -10796,6 +10806,27 @@ public static KeyManagerConfigurationDTO getAndSetDefaultKeyManagerConfiguration\n                 APIConstants.KeyManager.CLAIM_MAPPING)){\n             keyManagerConfigurationDTO.addProperty(APIConstants.KeyManager.CLAIM_MAPPING, getDefaultClaimMappings());\n         }\n+        if (!keyManagerConfigurationDTO.getAdditionalProperties().containsKey(APIConstants.KeyManager.CERTIFICATE_TYPE)){\n+            keyManagerConfigurationDTO.addProperty(APIConstants.KeyManager.CERTIFICATE_TYPE,\n+                    APIConstants.KeyManager.CERTIFICATE_TYPE_PEM_FILE);\n+        }\n+        if (!keyManagerConfigurationDTO.getAdditionalProperties().containsKey(APIConstants.KeyManager.CERTIFICATE_VALUE)){", "originalCommit": "3c38102c3f7ccf96deb6921daade400dc2a3240f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyODE0Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8753#discussion_r440128143", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-15T12:06:12Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -10796,6 +10806,27 @@ public static KeyManagerConfigurationDTO getAndSetDefaultKeyManagerConfiguration\n                 APIConstants.KeyManager.CLAIM_MAPPING)){\n             keyManagerConfigurationDTO.addProperty(APIConstants.KeyManager.CLAIM_MAPPING, getDefaultClaimMappings());\n         }\n+        if (!keyManagerConfigurationDTO.getAdditionalProperties().containsKey(APIConstants.KeyManager.CERTIFICATE_TYPE)){\n+            keyManagerConfigurationDTO.addProperty(APIConstants.KeyManager.CERTIFICATE_TYPE,\n+                    APIConstants.KeyManager.CERTIFICATE_TYPE_PEM_FILE);\n+        }\n+        if (!keyManagerConfigurationDTO.getAdditionalProperties().containsKey(APIConstants.KeyManager.CERTIFICATE_VALUE)){\n+            try {\n+                Certificate certificate = CertificateMgtUtils.getInstance()\n+                        .getPublicCertificate(keyManagerConfigurationDTO.getTenantDomain());\n+                String x509certificateContent = null;\n+                if (certificate != null){", "originalCommit": "3c38102c3f7ccf96deb6921daade400dc2a3240f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyODI1MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8753#discussion_r440128251", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-15T12:06:24Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/KeyManagerMappingUtil.java", "diffHunk": "@@ -92,10 +93,19 @@ public static KeyManagerDTO toKeyManagerDTO(KeyManagerConfigurationDTO keyManage\n             keyManagerDTO.setIssuer(issuerElement.getAsString());\n             jsonObject.remove(APIConstants.KeyManager.ISSUER);\n         }\n-        JsonElement jwksEndpointElement = jsonObject.get(APIConstants.KeyManager.JWKS_ENDPOINT);\n-        if (jwksEndpointElement != null) {\n-            keyManagerDTO.setJwksEndpoint(jwksEndpointElement.getAsString());\n-            jsonObject.remove(APIConstants.KeyManager.JWKS_ENDPOINT);\n+        JsonElement certificateValueElement = jsonObject.get(APIConstants.KeyManager.CERTIFICATE_VALUE);\n+        JsonElement certificateTypeElement = jsonObject.get(APIConstants.KeyManager.CERTIFICATE_TYPE);\n+        if (certificateTypeElement != null && certificateValueElement != null) {\n+            KeyManagerCertificatesDTO keyManagerCertificatesDTO = new KeyManagerCertificatesDTO();\n+            keyManagerCertificatesDTO.setValue(certificateValueElement.getAsString());\n+            if (APIConstants.KeyManager.CERTIFICATE_TYPE_JWKS_ENDPOINT.equals(certificateTypeElement.getAsString())){", "originalCommit": "3c38102c3f7ccf96deb6921daade400dc2a3240f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyODMyMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8753#discussion_r440128320", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-15T12:06:33Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/KeyManagerMappingUtil.java", "diffHunk": "@@ -92,10 +93,19 @@ public static KeyManagerDTO toKeyManagerDTO(KeyManagerConfigurationDTO keyManage\n             keyManagerDTO.setIssuer(issuerElement.getAsString());\n             jsonObject.remove(APIConstants.KeyManager.ISSUER);\n         }\n-        JsonElement jwksEndpointElement = jsonObject.get(APIConstants.KeyManager.JWKS_ENDPOINT);\n-        if (jwksEndpointElement != null) {\n-            keyManagerDTO.setJwksEndpoint(jwksEndpointElement.getAsString());\n-            jsonObject.remove(APIConstants.KeyManager.JWKS_ENDPOINT);\n+        JsonElement certificateValueElement = jsonObject.get(APIConstants.KeyManager.CERTIFICATE_VALUE);\n+        JsonElement certificateTypeElement = jsonObject.get(APIConstants.KeyManager.CERTIFICATE_TYPE);\n+        if (certificateTypeElement != null && certificateValueElement != null) {\n+            KeyManagerCertificatesDTO keyManagerCertificatesDTO = new KeyManagerCertificatesDTO();\n+            keyManagerCertificatesDTO.setValue(certificateValueElement.getAsString());\n+            if (APIConstants.KeyManager.CERTIFICATE_TYPE_JWKS_ENDPOINT.equals(certificateTypeElement.getAsString())){\n+                keyManagerCertificatesDTO.setType(KeyManagerCertificatesDTO.TypeEnum.JWKS);\n+            }else if (APIConstants.KeyManager.CERTIFICATE_TYPE_PEM_FILE.equals(certificateTypeElement.getAsString())){", "originalCommit": "3c38102c3f7ccf96deb6921daade400dc2a3240f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyODQxMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8753#discussion_r440128410", "bodyText": "Formatting issue", "author": "mushthaq33", "createdAt": "2020-06-15T12:06:43Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/KeyManagerMappingUtil.java", "diffHunk": "@@ -201,8 +211,16 @@ public static KeyManagerConfigurationDTO toKeyManagerConfigurationDTO(String ten\n         if (StringUtils.isNotEmpty(keyManagerDTO.getIssuer())) {\n             additionalProperties.put(APIConstants.KeyManager.ISSUER, keyManagerDTO.getIssuer());\n         }\n-        if (StringUtils.isNotEmpty(keyManagerDTO.getJwksEndpoint())) {\n-            additionalProperties.put(APIConstants.KeyManager.JWKS_ENDPOINT, keyManagerDTO.getJwksEndpoint());\n+        if (keyManagerDTO.getCertificates() != null) {\n+            additionalProperties.put(APIConstants.KeyManager.CERTIFICATE_VALUE,\n+                    keyManagerDTO.getCertificates().getValue());\n+            if (KeyManagerCertificatesDTO.TypeEnum.JWKS.equals(keyManagerDTO.getCertificates().getType())){", "originalCommit": "3c38102c3f7ccf96deb6921daade400dc2a3240f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "100dcaf5961d65fd8b4428f7c053a613beea0829", "url": "https://github.com/wso2/carbon-apimgt/commit/100dcaf5961d65fd8b4428f7c053a613beea0829", "message": "improve certificate as a file in key manager creation", "committedDate": "2020-06-15T12:07:03Z", "type": "forcePushed"}, {"oid": "ddc077267a893197b9250d0679322a8096a90be8", "url": "https://github.com/wso2/carbon-apimgt/commit/ddc077267a893197b9250d0679322a8096a90be8", "message": "improve certificate as a file in key manager creation", "committedDate": "2020-06-15T12:08:56Z", "type": "commit"}, {"oid": "ddc077267a893197b9250d0679322a8096a90be8", "url": "https://github.com/wso2/carbon-apimgt/commit/ddc077267a893197b9250d0679322a8096a90be8", "message": "improve certificate as a file in key manager creation", "committedDate": "2020-06-15T12:08:56Z", "type": "forcePushed"}]}