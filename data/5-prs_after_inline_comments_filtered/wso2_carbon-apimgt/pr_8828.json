{"pr_number": 8828, "pr_title": "Expose DB Oprations as a Webservice in Artifact synchronizer feature", "pr_createdAt": "2020-06-24T15:56:22Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8828", "timeline": [{"oid": "5db8788fa189e1744cb1583c7f18f506835635dc", "url": "https://github.com/wso2/carbon-apimgt/commit/5db8788fa189e1744cb1583c7f18f506835635dc", "message": "exposing DB opeartions as web service", "committedDate": "2020-06-23T19:19:33Z", "type": "commit"}, {"oid": "5dfb31422cfe8e0226733f2ed53f65eca8df48e7", "url": "https://github.com/wso2/carbon-apimgt/commit/5dfb31422cfe8e0226733f2ed53f65eca8df48e7", "message": "Added resources for NFS", "committedDate": "2020-06-24T09:04:14Z", "type": "commit"}, {"oid": "ceffa4b19e96c7179fe17c12692c36682a82d788", "url": "https://github.com/wso2/carbon-apimgt/commit/ceffa4b19e96c7179fe17c12692c36682a82d788", "message": "Refractor saving and retrieving", "committedDate": "2020-06-24T14:13:33Z", "type": "commit"}, {"oid": "9ddbff92955f3a1838bd6b2ddbd8bfe52362b70c", "url": "https://github.com/wso2/carbon-apimgt/commit/9ddbff92955f3a1838bd6b2ddbd8bfe52362b70c", "message": "remove unused imports", "committedDate": "2020-06-24T14:15:34Z", "type": "commit"}, {"oid": "0bdba4b52a116ac713d2d520f1b975fa72e56db1", "url": "https://github.com/wso2/carbon-apimgt/commit/0bdba4b52a116ac713d2d520f1b975fa72e56db1", "message": "remove unecessary exceptions", "committedDate": "2020-06-24T14:17:17Z", "type": "commit"}, {"oid": "a3dc8a6b97f1e02ef6074cb2e6c31ac133cb5cc4", "url": "https://github.com/wso2/carbon-apimgt/commit/a3dc8a6b97f1e02ef6074cb2e6c31ac133cb5cc4", "message": "remove unused imports", "committedDate": "2020-06-24T14:18:33Z", "type": "commit"}, {"oid": "d294521f569cb4c35f11ce5f4058e3bd22c6c21e", "url": "https://github.com/wso2/carbon-apimgt/commit/d294521f569cb4c35f11ce5f4058e3bd22c6c21e", "message": "add resources in dataservice", "committedDate": "2020-06-24T15:53:45Z", "type": "commit"}, {"oid": "54e35dc8e7bab44f6f0c3add14bec5d6c642fd82", "url": "https://github.com/wso2/carbon-apimgt/commit/54e35dc8e7bab44f6f0c3add14bec5d6c642fd82", "message": "add resource for isAPIPublished", "committedDate": "2020-06-24T17:20:39Z", "type": "commit"}, {"oid": "e4eb0c1b4247e5b51eddd2cfd927332a668d5b42", "url": "https://github.com/wso2/carbon-apimgt/commit/e4eb0c1b4247e5b51eddd2cfd927332a668d5b42", "message": "merge upstream", "committedDate": "2020-06-24T19:10:58Z", "type": "commit"}, {"oid": "1ec3da288d6168a76a85004bf9e5d40991f7b1a5", "url": "https://github.com/wso2/carbon-apimgt/commit/1ec3da288d6168a76a85004bf9e5d40991f7b1a5", "message": "add liecene header", "committedDate": "2020-06-24T19:13:38Z", "type": "commit"}, {"oid": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "url": "https://github.com/wso2/carbon-apimgt/commit/59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "message": "edit parameter definitions", "committedDate": "2020-06-25T04:28:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3ODY0Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445678647", "bodyText": "Formatting issues", "author": "1akshitha", "createdAt": "2020-06-25T16:17:33Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +56,93 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n-            }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction +\"&gatewayLabel=\"+ endcodedgatewayLabel;", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MDc4Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445780783", "bodyText": "d953b96", "author": "Sarangan0219", "createdAt": "2020-06-25T19:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3ODY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3ODc5NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445678795", "bodyText": "formatting issue", "author": "1akshitha", "createdAt": "2020-06-25T16:17:46Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +56,93 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n-            }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction +\"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            return EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client \" ;", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc3OTcxOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445779718", "bodyText": "c16f1ec", "author": "Sarangan0219", "createdAt": "2020-06-25T19:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3ODc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3OTAxOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445679019", "bodyText": "formatting issue", "author": "1akshitha", "createdAt": "2020-06-25T16:18:08Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +56,93 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n-            }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction +\"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            return EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client \" ;\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n         }\n-        return gatewayRuntimeArtifacts;\n     }\n \n     @Override\n     public List<String> retrieveAllArtifacts(String label) throws ArtifactSynchronizerException {\n         List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n         try {\n-            List<ByteArrayInputStream> baip = apiMgtDAO.getAllGatewayPublishedAPIArtifacts(label);\n-            for (ByteArrayInputStream byteStream :baip){\n-                byte[] bytes = ByteStreams.toByteArray(byteStream);\n-                String  gatewayRuntimeArtifacts = new String(bytes);\n-                gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX + System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(label, APIConstants.DigestAuthConstants.CHARSET);", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc3NzAxNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445777014", "bodyText": "0007abb", "author": "Sarangan0219", "createdAt": "2020-06-25T19:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3OTAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3OTE1OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445679159", "bodyText": "formatting issue", "author": "1akshitha", "createdAt": "2020-06-25T16:18:20Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +56,93 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n-            }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction +\"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            return EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client \" ;\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n         }\n-        return gatewayRuntimeArtifacts;\n     }\n \n     @Override\n     public List<String> retrieveAllArtifacts(String label) throws ArtifactSynchronizerException {\n         List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n         try {\n-            List<ByteArrayInputStream> baip = apiMgtDAO.getAllGatewayPublishedAPIArtifacts(label);\n-            for (ByteArrayInputStream byteStream :baip){\n-                byte[] bytes = ByteStreams.toByteArray(byteStream);\n-                String  gatewayRuntimeArtifacts = new String(bytes);\n-                gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX + System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(label, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.GATEAY_SYNAPSE_ARTIFACTS\n+                    + \"?gatewayLabel=\"+ endcodedgatewayLabel;", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MDczOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445780738", "bodyText": "d953b96", "author": "Sarangan0219", "createdAt": "2020-06-25T19:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3OTE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3OTg1Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445679857", "bodyText": "formatting issue", "author": "1akshitha", "createdAt": "2020-06-25T16:19:27Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +56,93 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n-            }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction +\"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            return EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client \" ;\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n         }\n-        return gatewayRuntimeArtifacts;\n     }\n \n     @Override\n     public List<String> retrieveAllArtifacts(String label) throws ArtifactSynchronizerException {\n         List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n         try {\n-            List<ByteArrayInputStream> baip = apiMgtDAO.getAllGatewayPublishedAPIArtifacts(label);\n-            for (ByteArrayInputStream byteStream :baip){\n-                byte[] bytes = ByteStreams.toByteArray(byteStream);\n-                String  gatewayRuntimeArtifacts = new String(bytes);\n-                gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX + System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(label, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.GATEAY_SYNAPSE_ARTIFACTS\n+                    + \"?gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            String responseString = EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+            JSONObject artifactObject = new JSONObject(responseString);\n+            JSONArray jArray = (JSONArray)artifactObject.get(\"list\");\n+            if (jArray != null) {\n+                for (int i = 0; i < jArray.length(); i++) {\n+                    gatewayRuntimeArtifactsArray.add(jArray.get(i).toString());\n+                }\n             }\n-            if (log.isDebugEnabled()){\n-                log.debug(\"Successfully retrieved Artifacts from DB\");\n+            return gatewayRuntimeArtifactsArray;\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client \" ;", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc3ODQ1Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445778456", "bodyText": "9d9528e", "author": "Sarangan0219", "createdAt": "2020-06-25T19:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3OTg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4MTI3OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445681278", "bodyText": "Better to do a null check before retrieving the entity", "author": "1akshitha", "createdAt": "2020-06-25T16:21:37Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +56,93 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n-            }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction +\"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            return EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client \" ;\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n         }\n-        return gatewayRuntimeArtifacts;\n     }\n \n     @Override\n     public List<String> retrieveAllArtifacts(String label) throws ArtifactSynchronizerException {\n         List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n         try {\n-            List<ByteArrayInputStream> baip = apiMgtDAO.getAllGatewayPublishedAPIArtifacts(label);\n-            for (ByteArrayInputStream byteStream :baip){\n-                byte[] bytes = ByteStreams.toByteArray(byteStream);\n-                String  gatewayRuntimeArtifacts = new String(bytes);\n-                gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX + System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(label, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.GATEAY_SYNAPSE_ARTIFACTS\n+                    + \"?gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            String responseString = EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc3NTc0NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445775744", "bodyText": "0007abb", "author": "Sarangan0219", "createdAt": "2020-06-25T19:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4MTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4MjI2OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445682269", "bodyText": "Can't we use the same line without exceeding the row width?", "author": "1akshitha", "createdAt": "2020-06-25T16:23:06Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +56,93 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n-            }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction +\"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            return EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client \" ;\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n         }\n-        return gatewayRuntimeArtifacts;\n     }\n \n     @Override\n     public List<String> retrieveAllArtifacts(String label) throws ArtifactSynchronizerException {\n         List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n         try {\n-            List<ByteArrayInputStream> baip = apiMgtDAO.getAllGatewayPublishedAPIArtifacts(label);\n-            for (ByteArrayInputStream byteStream :baip){\n-                byte[] bytes = ByteStreams.toByteArray(byteStream);\n-                String  gatewayRuntimeArtifacts = new String(bytes);\n-                gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX + System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(label, APIConstants.DigestAuthConstants.CHARSET);\n+            String path  = APIConstants.GatewayArtifactSynchronizer.GATEAY_SYNAPSE_ARTIFACTS\n+                    + \"?gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            String responseString = EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+            JSONObject artifactObject = new JSONObject(responseString);\n+            JSONArray jArray = (JSONArray)artifactObject.get(\"list\");\n+            if (jArray != null) {\n+                for (int i = 0; i < jArray.length(); i++) {\n+                    gatewayRuntimeArtifactsArray.add(jArray.get(i).toString());\n+                }\n             }\n-            if (log.isDebugEnabled()){\n-                log.debug(\"Successfully retrieved Artifacts from DB\");\n+            return gatewayRuntimeArtifactsArray;\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client \" ;\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n+        }\n+    }\n+\n+    private HttpResponse invokeService(String endpoint) throws IOException, ArtifactSynchronizerException {\n+        HttpGet method = new HttpGet(endpoint);\n+        URL synapseGetURL = new URL(endpoint);\n+        APIManagerConfiguration config = ServiceReferenceHolder.getInstance()\n+                .getAPIManagerConfigurationService().getAPIManagerConfiguration();\n+        String username = config.getFirstProperty(APIConstants.API_KEY_VALIDATOR_USERNAME);\n+        String password = config.getFirstProperty(APIConstants.API_KEY_VALIDATOR_PASSWORD);\n+        byte[] credentials = Base64.encodeBase64((username + \":\" + password).getBytes\n+                (APIConstants.DigestAuthConstants.CHARSET));\n+        int synapsePort = synapseGetURL .getPort();\n+        String synapseProtocol = synapseGetURL .getProtocol();\n+        method.setHeader(\"Authorization\", \"Basic \" + new String(credentials,\n+                APIConstants.DigestAuthConstants.CHARSET));", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc3NTYzNw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445775637", "bodyText": "Nope . It is exceeding the limit", "author": "Sarangan0219", "createdAt": "2020-06-25T19:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4MjI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4NjU1Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445686556", "bodyText": "Can't we add this method to APIUtil and use it by both DBSaver and DBretriever?", "author": "1akshitha", "createdAt": "2020-06-25T16:29:39Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBSaver.java", "diffHunk": "@@ -43,45 +59,122 @@ public void init() throws ArtifactSynchronizerException {\n     public void saveArtifact(String gatewayRuntimeArtifacts, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n \n-        try {\n-            JSONObject artifactObject = new JSONObject(gatewayRuntimeArtifacts);\n-            String apiId = (String) artifactObject.get(\"apiId\");\n-            String apiName = (String) artifactObject.get(\"name\");\n-            String version = (String) artifactObject.get(\"version\");\n-            String tenantDomain = (String) artifactObject.get(\"tenantDomain\");\n-\n-            byte[] gatewayRuntimeArtifactsAsBytes = gatewayRuntimeArtifacts.getBytes();\n-            ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(gatewayRuntimeArtifactsAsBytes);\n-            if (!apiMgtDAO.isAPIDetailsExists(apiId)) {\n-                apiMgtDAO.addGatewayPublishedAPIDetails(apiId, apiName,\n-                        version, tenantDomain);\n-            }\n+        JSONObject artifactObject = new JSONObject(gatewayRuntimeArtifacts);\n+        String apiId = (String) artifactObject.get(\"apiId\");\n+        String apiName = (String) artifactObject.get(\"name\");\n+        String version = (String) artifactObject.get(\"version\");\n+        String tenantDomain = (String) artifactObject.get(\"tenantDomain\");\n+        byte[] bytesEncoded =  Base64.encodeBase64(gatewayRuntimeArtifacts.getBytes());\n+        String bytesEncodedAsString =  new String(bytesEncoded);\n \n-            String dbQuery;\n-            if (apiMgtDAO.isAPIArtifactExists(apiId, gatewayLabel)) {\n-                dbQuery = SQLConstants.UPDATE_API_ARTIFACT;\n-            } else {\n-                dbQuery = SQLConstants.ADD_GW_API_ARTIFACT;\n+        try {\n+            String baseUrl = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String synapsePost = baseUrl + APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS;\n+\n+            JSONObject revokeRequestPayload = new JSONObject();\n+            revokeRequestPayload.put(\"apiId\", apiId);\n+            revokeRequestPayload.put(\"apiName\", apiName);\n+            revokeRequestPayload.put(\"version\", version);\n+            revokeRequestPayload.put(\"tenantDomain\", tenantDomain);\n+            revokeRequestPayload.put(\"gatewayInstruction\", gatewayInstruction);\n+            revokeRequestPayload.put(\"bytesEncodedAsString\", bytesEncodedAsString);\n+            revokeRequestPayload.put(\"gatewayLabel\", URLEncoder.encode(gatewayLabel,\n+                    APIConstants.DigestAuthConstants.CHARSET));\n+            HttpResponse httpResponse = invokeService(synapsePost,revokeRequestPayload);\n+            if (HttpStatus.SC_OK != httpResponse.getStatusLine().getStatusCode()) {\n+                log.error(\"Retrieving artifacts is UnSuccessful. Internal Data Service returned HTTP Status \" +\n+                        \"code : \" + httpResponse.getStatusLine().getStatusCode() );\n+                throw new ArtifactSynchronizerException(\"Error while Saving Artifacts to DB\");\n             }\n-            apiMgtDAO.addGatewayPublishedAPIArtifacts(apiId, gatewayLabel,\n-                    byteArrayInputStream, gatewayRuntimeArtifactsAsBytes.length, gatewayInstruction, dbQuery);\n+        } catch (MalformedURLException e) {\n+            String msg = \"Error while constructing Synapse POST URL\";\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client\";\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n+        }\n+    }\n \n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully saved Artifacts of \" + apiName);\n-            }\n-        } catch (APIManagementException e) {\n-            throw new ArtifactSynchronizerException(\"Error saving Artifacts to the DB\", e);\n+    private HttpResponse invokeService(String endpoint, JSONObject revokeRequestPayload) throws\n+            IOException {\n+        URL synapsePostURL = new URL(endpoint);\n+        APIManagerConfiguration config = ServiceReferenceHolder.getInstance()\n+                .getAPIManagerConfigurationService().getAPIManagerConfiguration();\n+        String username = config.getFirstProperty(APIConstants.API_KEY_VALIDATOR_USERNAME);\n+        String password = config.getFirstProperty(APIConstants.API_KEY_VALIDATOR_PASSWORD);\n+        byte[] credentials = Base64.encodeBase64((username + \":\" + password).getBytes\n+                (APIConstants.DigestAuthConstants.CHARSET));\n+        int synapsePort = synapsePostURL.getPort();\n+        String synapseProtocol = synapsePostURL.getProtocol();\n+        HttpClient httpClient = APIUtil.getHttpClient(synapsePort, synapseProtocol);\n+\n+        if (revokeRequestPayload != null) {\n+             HttpPost method = new HttpPost(endpoint);\n+             method.setHeader(\"Authorization\", \"Basic \" + new String(credentials,\n+                    APIConstants.DigestAuthConstants.CHARSET));\n+             StringEntity requestEntity = new StringEntity(revokeRequestPayload.toString());\n+             requestEntity.setContentType(APIConstants.APPLICATION_JSON_MEDIA_TYPE);\n+             method.setEntity(requestEntity);\n+             return executeHTTPRequest(method, httpClient);\n+\n+        } else {\n+             HttpGet method = new HttpGet(endpoint);\n+             method.setHeader(\"Authorization\", \"Basic \" + new String(credentials,\n+                    APIConstants.DigestAuthConstants.CHARSET));\n+             return executeHTTPRequest(method, httpClient);\n         }\n+    }\n \n+    private HttpResponse executeHTTPRequest(HttpRequestBase method, HttpClient httpClient ) throws IOException {", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc3NDc0Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445774742", "bodyText": "0007abb", "author": "Sarangan0219", "createdAt": "2020-06-25T18:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4NjU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4NzgwMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r445687800", "bodyText": "We should not use DAO outside of Impl component", "author": "1akshitha", "createdAt": "2020-06-25T16:31:25Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/main/java/org/wso2/carbon/apimgt/internal/service/impl/GatewaySynapseArtifactsApiServiceImpl.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package org.wso2.carbon.apimgt.internal.service.impl;\n+\n+import com.google.common.io.ByteStreams;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.dao.ApiMgtDAO;\n+import org.wso2.carbon.apimgt.impl.gatewayartifactsynchronizer.exception.ArtifactSynchronizerException;\n+import org.wso2.carbon.apimgt.internal.service.*;\n+import org.wso2.carbon.apimgt.internal.service.dto.*;\n+\n+import org.apache.cxf.jaxrs.ext.multipart.Attachment;\n+import org.apache.cxf.jaxrs.ext.MessageContext;\n+\n+import org.wso2.carbon.apimgt.internal.service.dto.ErrorDTO;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import java.io.InputStream;\n+\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.SecurityContext;\n+\n+\n+public class GatewaySynapseArtifactsApiServiceImpl implements GatewaySynapseArtifactsApiService {\n+\n+    protected ApiMgtDAO apiMgtDAO = ApiMgtDAO.getInstance();", "originalCommit": "59d2b7e0f765ae6be9d02cbbc659450f0c115d71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0007abb08c126e094b757b72e03eba846516e404", "url": "https://github.com/wso2/carbon-apimgt/commit/0007abb08c126e094b757b72e03eba846516e404", "message": "optimize code", "committedDate": "2020-06-25T18:58:25Z", "type": "commit"}, {"oid": "9d9528ef11995bb33199a1cfa237d56ef7126e7b", "url": "https://github.com/wso2/carbon-apimgt/commit/9d9528ef11995bb33199a1cfa237d56ef7126e7b", "message": "resolve formatting issues", "committedDate": "2020-06-25T19:05:25Z", "type": "commit"}, {"oid": "c16f1ec29fedc0b09ac879a212b7c2f487058783", "url": "https://github.com/wso2/carbon-apimgt/commit/c16f1ec29fedc0b09ac879a212b7c2f487058783", "message": "resolve formatting issues", "committedDate": "2020-06-25T19:08:46Z", "type": "commit"}, {"oid": "d953b96659e219307dfca0117408f74490f2923b", "url": "https://github.com/wso2/carbon-apimgt/commit/d953b96659e219307dfca0117408f74490f2923b", "message": "resolve formatting issues", "committedDate": "2020-06-25T19:10:55Z", "type": "commit"}, {"oid": "997829868f21b2e28987ca4475a3a650d1411d26", "url": "https://github.com/wso2/carbon-apimgt/commit/997829868f21b2e28987ca4475a3a650d1411d26", "message": "add comments in DB files", "committedDate": "2020-06-26T04:25:28Z", "type": "commit"}, {"oid": "197c4407952f0b1ef1982ee330551667fb7d7b7c", "url": "https://github.com/wso2/carbon-apimgt/commit/197c4407952f0b1ef1982ee330551667fb7d7b7c", "message": "resolve H2 DB errors", "committedDate": "2020-06-26T05:45:11Z", "type": "commit"}, {"oid": "380732ae11e0e1a7965f375dedb2951e8cd9be3f", "url": "https://github.com/wso2/carbon-apimgt/commit/380732ae11e0e1a7965f375dedb2951e8cd9be3f", "message": "Merge upstream", "committedDate": "2020-06-29T05:14:01Z", "type": "commit"}, {"oid": "f8ac0e05b94e15a601b30af61bd4cd15dde16ed3", "url": "https://github.com/wso2/carbon-apimgt/commit/f8ac0e05b94e15a601b30af61bd4cd15dde16ed3", "message": "refractor code", "committedDate": "2020-06-29T05:15:15Z", "type": "commit"}, {"oid": "61d0a02639ea99563dd3ec9c2197d33362be8aef", "url": "https://github.com/wso2/carbon-apimgt/commit/61d0a02639ea99563dd3ec9c2197d33362be8aef", "message": "format the code", "committedDate": "2020-06-29T05:18:43Z", "type": "commit"}, {"oid": "6b2a598dd9719ab3dbfb0e2aaeb254fed017a9fd", "url": "https://github.com/wso2/carbon-apimgt/commit/6b2a598dd9719ab3dbfb0e2aaeb254fed017a9fd", "message": "Merge remote-tracking branch 'upstream/master' into dataservice2", "committedDate": "2020-06-29T06:18:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0MjY3MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r447442671", "bodyText": "Formatting issue.", "author": "prasa7", "createdAt": "2020-06-30T06:35:50Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -57,24 +55,23 @@ public GatewayStartupListener() {\n \n     @Override\n     public void completingServerStartup() {\n-\n-        deployArtifactsAtStartup();\n+        startListener();\n     }\n \n-    private static void deployArtifactsAtStartup() {\n-\n+    private boolean  deployArtifactsAtStartup(){", "originalCommit": "61d0a02639ea99563dd3ec9c2197d33362be8aef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ1NDkwNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r447454904", "bodyText": "c49dff9", "author": "Sarangan0219", "createdAt": "2020-06-30T07:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0MjY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0Mjc1OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r447442759", "bodyText": "Formatting issue.", "author": "prasa7", "createdAt": "2020-06-30T06:36:03Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +53,76 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction + \"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            if (httpResponse.getEntity() != null ){", "originalCommit": "61d0a02639ea99563dd3ec9c2197d33362be8aef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ1NDg3MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r447454870", "bodyText": "c49dff9", "author": "Sarangan0219", "createdAt": "2020-06-30T07:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0Mjc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0Mjg2Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r447442862", "bodyText": "Formatting issue", "author": "prasa7", "createdAt": "2020-06-30T06:36:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +53,76 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction + \"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            if (httpResponse.getEntity() != null ){\n+                return EntityUtils.toString(httpResponse.getEntity(), APIConstants.DigestAuthConstants.CHARSET);\n+            } else {\n+                throw new ArtifactSynchronizerException(\"HTTP response is empty\");\n             }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client\";\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n         }\n-        return gatewayRuntimeArtifacts;\n     }\n \n     @Override\n     public List<String> retrieveAllArtifacts(String label) throws ArtifactSynchronizerException {\n         List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n         try {\n-            List<ByteArrayInputStream> baip = apiMgtDAO.getAllGatewayPublishedAPIArtifacts(label);\n-            for (ByteArrayInputStream byteStream :baip){\n-                byte[] bytes = ByteStreams.toByteArray(byteStream);\n-                String  gatewayRuntimeArtifacts = new String(bytes);\n-                gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+            String baseURL = APIConstants.HTTPS_PROTOCOL_URL_PREFIX +\n+                    System.getProperty(APIConstants.KEYMANAGER_HOSTNAME) + \":\" +\n+                    System.getProperty(APIConstants.KEYMANAGER_PORT) + APIConstants.INTERNAL_WEB_APP_EP;\n+            String endcodedgatewayLabel= URLEncoder.encode(label, APIConstants.DigestAuthConstants.CHARSET);\n+            String path = APIConstants.GatewayArtifactSynchronizer.GATEAY_SYNAPSE_ARTIFACTS\n+                    + \"?gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            HttpResponse httpResponse = invokeService(endpoint);\n+            String responseString;\n+            if (httpResponse.getEntity() != null ){", "originalCommit": "61d0a02639ea99563dd3ec9c2197d33362be8aef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ1NDg0Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r447454847", "bodyText": "c49dff9", "author": "Sarangan0219", "createdAt": "2020-06-30T07:02:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0Mjg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0MjkzOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r447442938", "bodyText": "Formatting issue", "author": "prasa7", "createdAt": "2020-06-30T06:36:29Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/main/java/org/wso2/carbon/apimgt/internal/service/impl/GatewaySynapseArtifactsApiServiceImpl.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package org.wso2.carbon.apimgt.internal.service.impl;\n+\n+import com.google.common.io.ByteStreams;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.dao.ApiMgtDAO;\n+import org.wso2.carbon.apimgt.internal.service.GatewaySynapseArtifactsApiService;\n+import org.apache.cxf.jaxrs.ext.MessageContext;\n+import org.wso2.carbon.apimgt.internal.service.dto.SynapseArtifactListDTO;\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.ws.rs.core.Response;\n+\n+\n+\n+public class GatewaySynapseArtifactsApiServiceImpl implements GatewaySynapseArtifactsApiService {\n+\n+    protected ApiMgtDAO apiMgtDAO = ApiMgtDAO.getInstance();\n+\n+    private SynapseArtifactListDTO synapseArtifactListDTOS = new SynapseArtifactListDTO();\n+\n+    public Response gatewaySynapseArtifactsGet(String gatewayLabel, MessageContext messageContext) throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try {\n+            List<ByteArrayInputStream> baip = apiMgtDAO.getAllGatewayPublishedAPIArtifacts(gatewayLabel);\n+            for (ByteArrayInputStream byteStream :baip){", "originalCommit": "61d0a02639ea99563dd3ec9c2197d33362be8aef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ1NDgxOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r447454819", "bodyText": "c49dff9", "author": "Sarangan0219", "createdAt": "2020-06-30T07:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0MjkzOA=="}], "type": "inlineReview"}, {"oid": "c49dff9067cb7a73042b9509252a42134433708f", "url": "https://github.com/wso2/carbon-apimgt/commit/c49dff9067cb7a73042b9509252a42134433708f", "message": "resolve formatting issues", "committedDate": "2020-06-30T06:56:09Z", "type": "commit"}, {"oid": "8b73aa02e4dd3517bf51c8cddc6d5862cc5c7020", "url": "https://github.com/wso2/carbon-apimgt/commit/8b73aa02e4dd3517bf51c8cddc6d5862cc5c7020", "message": "Merge remote-tracking branch 'upstream/master' into dataservice2", "committedDate": "2020-06-30T06:59:12Z", "type": "commit"}, {"oid": "1f4596c17bd00b3cca7f78731b93e631efdc1dc2", "url": "https://github.com/wso2/carbon-apimgt/commit/1f4596c17bd00b3cca7f78731b93e631efdc1dc2", "message": "Add deleted file", "committedDate": "2020-06-30T07:06:23Z", "type": "commit"}, {"oid": "85481f6982117165f23bb143d9fe0179bcd5284c", "url": "https://github.com/wso2/carbon-apimgt/commit/85481f6982117165f23bb143d9fe0179bcd5284c", "message": "remove HTTP call from artifact saver", "committedDate": "2020-06-30T11:57:26Z", "type": "commit"}, {"oid": "2c4883643bd0bf98b114b139883b7a4f791aab5f", "url": "https://github.com/wso2/carbon-apimgt/commit/2c4883643bd0bf98b114b139883b7a4f791aab5f", "message": "edit connection parameters", "committedDate": "2020-06-30T12:52:51Z", "type": "commit"}, {"oid": "9e1430d416c0a901378184b4fc71106de1b11d08", "url": "https://github.com/wso2/carbon-apimgt/commit/9e1430d416c0a901378184b4fc71106de1b11d08", "message": "resolve runtime errors", "committedDate": "2020-06-30T13:42:26Z", "type": "commit"}, {"oid": "50e6358767be9177a39b394da24c7dba8ab8b4ae", "url": "https://github.com/wso2/carbon-apimgt/commit/50e6358767be9177a39b394da24c7dba8ab8b4ae", "message": "Merge remote-tracking branch 'upstream/master' into dataservice2", "committedDate": "2020-06-30T13:46:34Z", "type": "commit"}, {"oid": "4f4e7f6888999a2fbfaa10671e10b373cdb633a1", "url": "https://github.com/wso2/carbon-apimgt/commit/4f4e7f6888999a2fbfaa10671e10b373cdb633a1", "message": "Add method description", "committedDate": "2020-06-30T13:49:49Z", "type": "commit"}, {"oid": "418add1b177e9a65ffdd624330a508bc24ffc8fe", "url": "https://github.com/wso2/carbon-apimgt/commit/418add1b177e9a65ffdd624330a508bc24ffc8fe", "message": "remove unused imports", "committedDate": "2020-06-30T13:51:05Z", "type": "commit"}, {"oid": "3eb2442b90d0dba1078e804b12872d187c592cea", "url": "https://github.com/wso2/carbon-apimgt/commit/3eb2442b90d0dba1078e804b12872d187c592cea", "message": "Merge remote-tracking branch 'upstream/master' into dataservice2", "committedDate": "2020-06-30T22:58:53Z", "type": "commit"}, {"oid": "fa1d7e91c2c6a5256b9f6044ba6769f8dcd5e4e6", "url": "https://github.com/wso2/carbon-apimgt/commit/fa1d7e91c2c6a5256b9f6044ba6769f8dcd5e4e6", "message": "Adding a datasource for artifact synchronizer", "committedDate": "2020-07-01T00:08:26Z", "type": "commit"}, {"oid": "0995807c42bef57c0880810d9d843a589efd2a0c", "url": "https://github.com/wso2/carbon-apimgt/commit/0995807c42bef57c0880810d9d843a589efd2a0c", "message": "Add datasource configs", "committedDate": "2020-07-01T00:13:02Z", "type": "commit"}, {"oid": "baa469568f13eb4416283cfbd9b9905aa69c8d4e", "url": "https://github.com/wso2/carbon-apimgt/commit/baa469568f13eb4416283cfbd9b9905aa69c8d4e", "message": "delete unwanted files", "committedDate": "2020-07-01T00:16:31Z", "type": "commit"}, {"oid": "5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "url": "https://github.com/wso2/carbon-apimgt/commit/5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "message": "Sepearte gatewayDB opeartions", "committedDate": "2020-07-01T01:22:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMDA0NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448520044", "bodyText": "can we bring it to config level", "author": "tharindu1st", "createdAt": "2020-07-01T17:42:21Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -99,4 +98,38 @@ public void invoke() {\n         }\n     }\n \n-}\n+\n+    public void startListener() {\n+        new Thread(this).start();\n+    }\n+\n+    @Override\n+    public void run() {\n+        deployArtifactsInGateway();\n+    }\n+\n+    private void deployArtifactsInGateway() {\n+        long retryDuration = 10000;", "originalCommit": "5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc1Njg2NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448756864", "bodyText": "3540dda", "author": "Sarangan0219", "createdAt": "2020-07-02T05:29:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMDA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMDcxOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448520718", "bodyText": "need private constructot", "author": "tharindu1st", "createdAt": "2020-07-01T17:43:39Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();", "originalCommit": "5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0NzY2MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448747661", "bodyText": "d501401", "author": "Sarangan0219", "createdAt": "2020-07-02T04:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMDcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMTQ2OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448521469", "bodyText": "need to make autocommit false first in connection since it s an insert", "author": "tharindu1st", "createdAt": "2020-07-01T17:45:04Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {", "originalCommit": "5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0Nzc2MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448747761", "bodyText": "d501401", "author": "Sarangan0219", "createdAt": "2020-07-02T04:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMTQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMjIxNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448522215", "bodyText": "fix all the places as above except GET", "author": "tharindu1st", "createdAt": "2020-07-01T17:46:26Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, APIName);\n+            statement.setString(3, version);\n+            statement.setString(4, tenantDomain);\n+            statement.executeUpdate();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();", "originalCommit": "5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0Nzc5Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448747793", "bodyText": "d501401", "author": "Sarangan0219", "createdAt": "2020-07-02T04:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMjIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMjk1Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448522957", "bodyText": "make the query Select 1 and check if rs.next", "author": "tharindu1st", "createdAt": "2020-07-01T17:47:51Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, APIName);\n+            statement.setString(3, version);\n+            statement.setString(4, tenantDomain);\n+            statement.executeUpdate();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(query)) {\n+            statement.setBinaryStream(1, bais, streamLength);\n+            statement.setString(2, gatewayInstruction);\n+            statement.setString(3, APIId);\n+            statement.setString(4, gatewayLabel);\n+            statement.executeUpdate();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_API_ARTIFACT)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            statement.setString(3, gatewayInstruction);\n+            ResultSet rs = statement.executeQuery();\n+            if (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    gatewayRuntimeArtifacts = IOUtils.toString(inputStream, APIConstants.DigestAuthConstants.CHARSET);\n+                } catch (IOException  e){\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \" + APIId, e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts of API with ID \" + APIId, e);\n+        }\n+        return gatewayRuntimeArtifacts;\n+    }\n+\n+    /**\n+     * Retrieve the list of blobs of the APIs for a given label\n+     *\n+     * @param label - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public List<String> getAllGatewayPublishedAPIArtifacts(String label)\n+            throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_ALL_API_ARTIFACT)) {\n+            statement.setString(1, label);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    String gatewayRuntimeArtifacts = IOUtils.toString(inputStream,\n+                            APIConstants.DigestAuthConstants.CHARSET);\n+                    gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+                } catch (IOException  e) {\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \", e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts \" , e);\n+        }\n+        return gatewayRuntimeArtifactsArray;\n+    }\n+\n+    /**\n+     * Check whether the API is published in any of the Gateways\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIPublishedInAnyGateway(String APIId) throws APIManagementException {\n+\n+        int count = 0;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_PUBLISHED_GATEWAYS_FOR_API)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                count = rs.getInt(\"COUNT\");\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed check whether API is published in any gateway \" + APIId, e);\n+        }\n+        return count != 0;\n+    }\n+\n+    /**\n+     * Check whether the API details exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIDetailsExists(String APIId) throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.GET_GATEWAY_PUBLISHED_API_DETAILS)) {\n+            statement.setString(1, APIId);\n+            ResultSet rs = statement.executeQuery();\n+            return rs.next();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to check API details status of API with ID \" + APIId, e);\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Check whether the API artifact for given label exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIArtifactExists(String APIId, String gatewayLabel) throws APIManagementException {\n+\n+        int count = 0;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.CHECK_ARTIFACT_EXISTS)) {", "originalCommit": "5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc2MDM0MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448760341", "bodyText": "6604c7c", "author": "Sarangan0219", "createdAt": "2020-07-02T05:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMjk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMzQ0MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448523441", "bodyText": "APIMgtDBUtil ->GatewayArtifactsMgtDBUtil", "author": "tharindu1st", "createdAt": "2020-07-01T17:48:51Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/GatewayArtifactsMgtDBUtil.java", "diffHunk": "@@ -0,0 +1,167 @@\n+package org.wso2.carbon.apimgt.impl.utils;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.api.APIManagerDatabaseException;\n+import org.wso2.carbon.apimgt.impl.APIManagerConfiguration;\n+import org.wso2.carbon.apimgt.impl.dto.GatewayArtifactSynchronizerProperties;\n+import org.wso2.carbon.apimgt.impl.internal.ServiceReferenceHolder;\n+\n+import javax.naming.Context;\n+import javax.naming.InitialContext;\n+import javax.naming.NamingException;\n+import javax.sql.DataSource;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+\n+public class GatewayArtifactsMgtDBUtil {\n+\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDBUtil.class);\n+    private static volatile DataSource artifactSynchronizerDataSource = null;\n+    private static final String DATA_SOURCE_NAME = \"DataSourceName\";\n+\n+    /**\n+     * Initializes the data source\n+     *\n+     * @throws APIManagementException if an error occurs while loading DB configuration\n+     */\n+    public static void initialize() throws APIManagerDatabaseException {\n+        if (artifactSynchronizerDataSource != null) {\n+            return;\n+        }\n+\n+        synchronized (APIMgtDBUtil.class) {", "originalCommit": "5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0NzgzMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448747831", "bodyText": "d501401", "author": "Sarangan0219", "createdAt": "2020-07-02T04:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMzQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMzYxOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448523618", "bodyText": "do we need this", "author": "tharindu1st", "createdAt": "2020-07-01T17:49:09Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/GatewayArtifactsMgtDBUtil.java", "diffHunk": "@@ -0,0 +1,167 @@\n+package org.wso2.carbon.apimgt.impl.utils;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.api.APIManagerDatabaseException;\n+import org.wso2.carbon.apimgt.impl.APIManagerConfiguration;\n+import org.wso2.carbon.apimgt.impl.dto.GatewayArtifactSynchronizerProperties;\n+import org.wso2.carbon.apimgt.impl.internal.ServiceReferenceHolder;\n+\n+import javax.naming.Context;\n+import javax.naming.InitialContext;\n+import javax.naming.NamingException;\n+import javax.sql.DataSource;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+\n+public class GatewayArtifactsMgtDBUtil {\n+\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDBUtil.class);\n+    private static volatile DataSource artifactSynchronizerDataSource = null;\n+    private static final String DATA_SOURCE_NAME = \"DataSourceName\";\n+\n+    /**\n+     * Initializes the data source\n+     *\n+     * @throws APIManagementException if an error occurs while loading DB configuration\n+     */\n+    public static void initialize() throws APIManagerDatabaseException {\n+        if (artifactSynchronizerDataSource != null) {\n+            return;\n+        }\n+\n+        synchronized (APIMgtDBUtil.class) {\n+            if (artifactSynchronizerDataSource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Initializing data source\");\n+                }\n+                GatewayArtifactSynchronizerProperties gatewayArtifactSynchronizerProperties =\n+                        ServiceReferenceHolder.getInstance().getAPIManagerConfigurationService()\n+                                .getAPIManagerConfiguration().getGatewayArtifactSynchronizerProperties();\n+                String artifactSynchronizerDataSourceName =\n+                        gatewayArtifactSynchronizerProperties.getArtifactSynchronizerDataSource();\n+\n+                if (artifactSynchronizerDataSourceName != null) {\n+                    try {\n+                        Context ctx = new InitialContext();\n+                        artifactSynchronizerDataSource = (DataSource) ctx.lookup(artifactSynchronizerDataSourceName);\n+                    } catch (NamingException e) {\n+                        throw new APIManagerDatabaseException(\"Error while looking up the data \" +\n+                                \"source: \" + artifactSynchronizerDataSourceName, e);\n+                    }\n+                } else {\n+                    log.error(\"AS\" + artifactSynchronizerDataSourceName + \" not defined in api-manager.xml.\");\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Utility method to get a new database connection for gatewayRuntime artifacts\n+     *\n+     * @return Connection\n+     * @throws java.sql.SQLException if failed to get Connection\n+     */\n+    public static Connection getArtifactSynchronizerConnection() throws SQLException {\n+        if (artifactSynchronizerDataSource != null) {\n+            return artifactSynchronizerDataSource.getConnection();\n+        }\n+        throw new SQLException(\"Data source is not configured properly.\");\n+    }\n+\n+    /**\n+     * Utility method to close the connection streams.\n+     * @param preparedStatement PreparedStatement\n+     * @param connection Connection\n+     * @param resultSet ResultSet\n+     */\n+    public static void closeAllConnections(PreparedStatement preparedStatement, Connection connection,", "originalCommit": "5cf907a4fdb46cb9734278c1b8619e04cc1f4b27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0NzkwMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r448747900", "bodyText": "Removed it . d501401", "author": "Sarangan0219", "createdAt": "2020-07-02T04:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMzYxOA=="}], "type": "inlineReview"}, {"oid": "d501401001c713712bb50c42b40aa2afa9326545", "url": "https://github.com/wso2/carbon-apimgt/commit/d501401001c713712bb50c42b40aa2afa9326545", "message": "optimized Db opeartions", "committedDate": "2020-07-02T04:49:36Z", "type": "commit"}, {"oid": "29be66533a9ac23c7f2f9c373d2bcbc0d95c8d56", "url": "https://github.com/wso2/carbon-apimgt/commit/29be66533a9ac23c7f2f9c373d2bcbc0d95c8d56", "message": "remove unused imports", "committedDate": "2020-07-02T04:51:21Z", "type": "commit"}, {"oid": "3540ddaf35c95330c5411a866aaeb384dad47ee3", "url": "https://github.com/wso2/carbon-apimgt/commit/3540ddaf35c95330c5411a866aaeb384dad47ee3", "message": "Add config for gateway deployment retry duration", "committedDate": "2020-07-02T05:28:12Z", "type": "commit"}, {"oid": "6604c7cf1386950cd25886fffa21addbbc595804", "url": "https://github.com/wso2/carbon-apimgt/commit/6604c7cf1386950cd25886fffa21addbbc595804", "message": "modify sql query", "committedDate": "2020-07-02T05:38:50Z", "type": "commit"}, {"oid": "5bd22237441b3f4612408e9272a9de8c9d986429", "url": "https://github.com/wso2/carbon-apimgt/commit/5bd22237441b3f4612408e9272a9de8c9d986429", "message": "Point the default datasource as AM_DB", "committedDate": "2020-07-03T06:53:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMTU2Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449401566", "bodyText": "Any reason why this is in upper case? Uppercase specifically denotes constant names.", "author": "uvindra", "createdAt": "2020-07-03T06:36:41Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUwMzIyNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449503224", "bodyText": "dab8323", "author": "Sarangan0219", "createdAt": "2020-07-03T10:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMTU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNDk4NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449404985", "bodyText": "As a practice its a good idea to call commit on a connection that is returned from the pool before performing a SELECT operation. This ensures that any uncommitted data will not be returned by the DB. The pattern to be used therefore should be,\ntry (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\nconnection.setAutoCommit(false); connection.commit();\nPreparedStatement statement = connection.prepareStatement(\"SELECT ...\")) {\n\n}", "author": "uvindra", "createdAt": "2020-07-03T06:45:59Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Private constructor\n+     */\n+    private GatewayArtifactsMgtDAO () {\n+    }\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+                    statement.setString(1, APIId);\n+                    statement.setString(2, APIName);\n+                    statement.setString(3, version);\n+                    statement.setString(4, tenantDomain);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection.prepareStatement(query)) {\n+                    statement.setBinaryStream(1, bais, streamLength);\n+                    statement.setString(2, gatewayInstruction);\n+                    statement.setString(3, APIId);\n+                    statement.setString(4, gatewayLabel);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyNTkwOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449525908", "bodyText": "e63b7ad", "author": "Sarangan0219", "createdAt": "2020-07-03T11:07:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNDk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNjkzNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449406936", "bodyText": "As a practice its a good idea to call commit on a connection that is returned from the pool before performing a SELECT operation. This ensures that any uncommitted data will not be returned by the DB. The pattern to be used therefore should be,\ntry (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\nconnection.setAutoCommit(false); connection.commit();\nPreparedStatement statement = connection.prepareStatement(\"SELECT ...\")) {\n\n}", "author": "uvindra", "createdAt": "2020-07-03T06:51:18Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Private constructor\n+     */\n+    private GatewayArtifactsMgtDAO () {\n+    }\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+                    statement.setString(1, APIId);\n+                    statement.setString(2, APIName);\n+                    statement.setString(3, version);\n+                    statement.setString(4, tenantDomain);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection.prepareStatement(query)) {\n+                    statement.setBinaryStream(1, bais, streamLength);\n+                    statement.setString(2, gatewayInstruction);\n+                    statement.setString(3, APIId);\n+                    statement.setString(4, gatewayLabel);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_API_ARTIFACT)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            statement.setString(3, gatewayInstruction);\n+            ResultSet rs = statement.executeQuery();\n+            if (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    gatewayRuntimeArtifacts = IOUtils.toString(inputStream, APIConstants.DigestAuthConstants.CHARSET);\n+                } catch (IOException  e){\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \" + APIId, e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts of API with ID \" + APIId, e);\n+        }\n+        return gatewayRuntimeArtifacts;\n+    }\n+\n+    /**\n+     * Retrieve the list of blobs of the APIs for a given label\n+     *\n+     * @param label - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public List<String> getAllGatewayPublishedAPIArtifacts(String label)\n+            throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyNTg2Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449525866", "bodyText": "e63b7ad", "author": "Sarangan0219", "createdAt": "2020-07-03T11:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNjkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNzE4OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449407188", "bodyText": "As a practice its a good idea to call commit on a connection that is returned from the pool before performing a SELECT operation. This ensures that any uncommitted data will not be returned by the DB. The pattern to be used therefore should be,\ntry (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\nconnection.setAutoCommit(false); connection.commit();\nPreparedStatement statement = connection.prepareStatement(\"SELECT ...\")) {\n\n}", "author": "uvindra", "createdAt": "2020-07-03T06:51:52Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Private constructor\n+     */\n+    private GatewayArtifactsMgtDAO () {\n+    }\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+                    statement.setString(1, APIId);\n+                    statement.setString(2, APIName);\n+                    statement.setString(3, version);\n+                    statement.setString(4, tenantDomain);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection.prepareStatement(query)) {\n+                    statement.setBinaryStream(1, bais, streamLength);\n+                    statement.setString(2, gatewayInstruction);\n+                    statement.setString(3, APIId);\n+                    statement.setString(4, gatewayLabel);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_API_ARTIFACT)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            statement.setString(3, gatewayInstruction);\n+            ResultSet rs = statement.executeQuery();\n+            if (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    gatewayRuntimeArtifacts = IOUtils.toString(inputStream, APIConstants.DigestAuthConstants.CHARSET);\n+                } catch (IOException  e){\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \" + APIId, e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts of API with ID \" + APIId, e);\n+        }\n+        return gatewayRuntimeArtifacts;\n+    }\n+\n+    /**\n+     * Retrieve the list of blobs of the APIs for a given label\n+     *\n+     * @param label - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public List<String> getAllGatewayPublishedAPIArtifacts(String label)\n+            throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_ALL_API_ARTIFACT)) {\n+            statement.setString(1, label);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    String gatewayRuntimeArtifacts = IOUtils.toString(inputStream,\n+                            APIConstants.DigestAuthConstants.CHARSET);\n+                    gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+                } catch (IOException  e) {\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \", e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts \" , e);\n+        }\n+        return gatewayRuntimeArtifactsArray;\n+    }\n+\n+    /**\n+     * Check whether the API is published in any of the Gateways\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIPublishedInAnyGateway(String APIId) throws APIManagementException {\n+\n+        int count = 0;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyNTg1MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449525850", "bodyText": "e63b7ad", "author": "Sarangan0219", "createdAt": "2020-07-03T11:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNzE4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNzUyMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449407520", "bodyText": "As a practice its a good idea to call commit on a connection that is returned from the pool before performing a SELECT operation. This ensures that any uncommitted data will not be returned by the DB. The pattern to be used therefore should be,\ntry (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\nconnection.setAutoCommit(false); connection.commit();\nPreparedStatement statement = connection.prepareStatement(\"SELECT ...\")) {\n\n}", "author": "uvindra", "createdAt": "2020-07-03T06:52:41Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Private constructor\n+     */\n+    private GatewayArtifactsMgtDAO () {\n+    }\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+                    statement.setString(1, APIId);\n+                    statement.setString(2, APIName);\n+                    statement.setString(3, version);\n+                    statement.setString(4, tenantDomain);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection.prepareStatement(query)) {\n+                    statement.setBinaryStream(1, bais, streamLength);\n+                    statement.setString(2, gatewayInstruction);\n+                    statement.setString(3, APIId);\n+                    statement.setString(4, gatewayLabel);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_API_ARTIFACT)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            statement.setString(3, gatewayInstruction);\n+            ResultSet rs = statement.executeQuery();\n+            if (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    gatewayRuntimeArtifacts = IOUtils.toString(inputStream, APIConstants.DigestAuthConstants.CHARSET);\n+                } catch (IOException  e){\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \" + APIId, e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts of API with ID \" + APIId, e);\n+        }\n+        return gatewayRuntimeArtifacts;\n+    }\n+\n+    /**\n+     * Retrieve the list of blobs of the APIs for a given label\n+     *\n+     * @param label - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public List<String> getAllGatewayPublishedAPIArtifacts(String label)\n+            throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_ALL_API_ARTIFACT)) {\n+            statement.setString(1, label);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    String gatewayRuntimeArtifacts = IOUtils.toString(inputStream,\n+                            APIConstants.DigestAuthConstants.CHARSET);\n+                    gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+                } catch (IOException  e) {\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \", e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts \" , e);\n+        }\n+        return gatewayRuntimeArtifactsArray;\n+    }\n+\n+    /**\n+     * Check whether the API is published in any of the Gateways\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIPublishedInAnyGateway(String APIId) throws APIManagementException {\n+\n+        int count = 0;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_PUBLISHED_GATEWAYS_FOR_API)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                count = rs.getInt(\"COUNT\");\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed check whether API is published in any gateway \" + APIId, e);\n+        }\n+        return count != 0;\n+    }\n+\n+    /**\n+     * Check whether the API details exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIDetailsExists(String APIId) throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyNTgxOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449525818", "bodyText": "e63b7ad", "author": "Sarangan0219", "createdAt": "2020-07-03T11:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNzUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwOTIyOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449409228", "bodyText": "This should be a \"SELECT 1 .....\" style query since you are only interested in checking if rows exist and are not doing anything with the values of the columns.", "author": "uvindra", "createdAt": "2020-07-03T06:57:11Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Private constructor\n+     */\n+    private GatewayArtifactsMgtDAO () {\n+    }\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+                    statement.setString(1, APIId);\n+                    statement.setString(2, APIName);\n+                    statement.setString(3, version);\n+                    statement.setString(4, tenantDomain);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection.prepareStatement(query)) {\n+                    statement.setBinaryStream(1, bais, streamLength);\n+                    statement.setString(2, gatewayInstruction);\n+                    statement.setString(3, APIId);\n+                    statement.setString(4, gatewayLabel);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_API_ARTIFACT)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            statement.setString(3, gatewayInstruction);\n+            ResultSet rs = statement.executeQuery();\n+            if (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    gatewayRuntimeArtifacts = IOUtils.toString(inputStream, APIConstants.DigestAuthConstants.CHARSET);\n+                } catch (IOException  e){\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \" + APIId, e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts of API with ID \" + APIId, e);\n+        }\n+        return gatewayRuntimeArtifacts;\n+    }\n+\n+    /**\n+     * Retrieve the list of blobs of the APIs for a given label\n+     *\n+     * @param label - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public List<String> getAllGatewayPublishedAPIArtifacts(String label)\n+            throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_ALL_API_ARTIFACT)) {\n+            statement.setString(1, label);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    String gatewayRuntimeArtifacts = IOUtils.toString(inputStream,\n+                            APIConstants.DigestAuthConstants.CHARSET);\n+                    gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+                } catch (IOException  e) {\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \", e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts \" , e);\n+        }\n+        return gatewayRuntimeArtifactsArray;\n+    }\n+\n+    /**\n+     * Check whether the API is published in any of the Gateways\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIPublishedInAnyGateway(String APIId) throws APIManagementException {\n+\n+        int count = 0;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_PUBLISHED_GATEWAYS_FOR_API)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                count = rs.getInt(\"COUNT\");\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed check whether API is published in any gateway \" + APIId, e);\n+        }\n+        return count != 0;\n+    }\n+\n+    /**\n+     * Check whether the API details exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIDetailsExists(String APIId) throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.GET_GATEWAY_PUBLISHED_API_DETAILS)) {", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUxNjg2Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449516867", "bodyText": "dab8323", "author": "Sarangan0219", "createdAt": "2020-07-03T10:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwOTIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMDA2Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449410062", "bodyText": "No need for while loop, doing return rs.next() is sufficient.", "author": "uvindra", "createdAt": "2020-07-03T06:59:18Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Private constructor\n+     */\n+    private GatewayArtifactsMgtDAO () {\n+    }\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+                    statement.setString(1, APIId);\n+                    statement.setString(2, APIName);\n+                    statement.setString(3, version);\n+                    statement.setString(4, tenantDomain);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection.prepareStatement(query)) {\n+                    statement.setBinaryStream(1, bais, streamLength);\n+                    statement.setString(2, gatewayInstruction);\n+                    statement.setString(3, APIId);\n+                    statement.setString(4, gatewayLabel);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_API_ARTIFACT)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            statement.setString(3, gatewayInstruction);\n+            ResultSet rs = statement.executeQuery();\n+            if (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    gatewayRuntimeArtifacts = IOUtils.toString(inputStream, APIConstants.DigestAuthConstants.CHARSET);\n+                } catch (IOException  e){\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \" + APIId, e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts of API with ID \" + APIId, e);\n+        }\n+        return gatewayRuntimeArtifacts;\n+    }\n+\n+    /**\n+     * Retrieve the list of blobs of the APIs for a given label\n+     *\n+     * @param label - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public List<String> getAllGatewayPublishedAPIArtifacts(String label)\n+            throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_ALL_API_ARTIFACT)) {\n+            statement.setString(1, label);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    String gatewayRuntimeArtifacts = IOUtils.toString(inputStream,\n+                            APIConstants.DigestAuthConstants.CHARSET);\n+                    gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+                } catch (IOException  e) {\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \", e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts \" , e);\n+        }\n+        return gatewayRuntimeArtifactsArray;\n+    }\n+\n+    /**\n+     * Check whether the API is published in any of the Gateways\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIPublishedInAnyGateway(String APIId) throws APIManagementException {\n+\n+        int count = 0;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_PUBLISHED_GATEWAYS_FOR_API)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                count = rs.getInt(\"COUNT\");\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed check whether API is published in any gateway \" + APIId, e);\n+        }\n+        return count != 0;\n+    }\n+\n+    /**\n+     * Check whether the API details exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIDetailsExists(String APIId) throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.GET_GATEWAY_PUBLISHED_API_DETAILS)) {\n+            statement.setString(1, APIId);\n+            ResultSet rs = statement.executeQuery();\n+            return rs.next();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to check API details status of API with ID \" + APIId, e);\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Check whether the API artifact for given label exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIArtifactExists(String APIId, String gatewayLabel) throws APIManagementException {\n+\n+        boolean isExist = false;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.CHECK_ARTIFACT_EXISTS)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUxNjgwNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449516804", "bodyText": "dab8323", "author": "Sarangan0219", "createdAt": "2020-07-03T10:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMDA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMDQzNw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449410437", "bodyText": "As a practice its a good idea to call commit on a connection that is returned from the pool before performing a SELECT operation. This ensures that any uncommitted data will not be returned by the DB. The pattern to be used therefore should be,\ntry (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\nconnection.setAutoCommit(false); connection.commit();\nPreparedStatement statement = connection.prepareStatement(\"SELECT ...\")) {\n\n}", "author": "uvindra", "createdAt": "2020-07-03T07:00:22Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO INSTANCE = null;\n+\n+    /**\n+     * Private constructor\n+     */\n+    private GatewayArtifactsMgtDAO () {\n+    }\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (INSTANCE == null) {\n+            INSTANCE = new GatewayArtifactsMgtDAO();\n+        }\n+        return INSTANCE;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+                    statement.setString(1, APIId);\n+                    statement.setString(2, APIName);\n+                    statement.setString(3, version);\n+                    statement.setString(4, tenantDomain);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection.prepareStatement(query)) {\n+                    statement.setBinaryStream(1, bais, streamLength);\n+                    statement.setString(2, gatewayInstruction);\n+                    statement.setString(3, APIId);\n+                    statement.setString(4, gatewayLabel);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_API_ARTIFACT)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            statement.setString(3, gatewayInstruction);\n+            ResultSet rs = statement.executeQuery();\n+            if (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    gatewayRuntimeArtifacts = IOUtils.toString(inputStream, APIConstants.DigestAuthConstants.CHARSET);\n+                } catch (IOException  e){\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \" + APIId, e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts of API with ID \" + APIId, e);\n+        }\n+        return gatewayRuntimeArtifacts;\n+    }\n+\n+    /**\n+     * Retrieve the list of blobs of the APIs for a given label\n+     *\n+     * @param label - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public List<String> getAllGatewayPublishedAPIArtifacts(String label)\n+            throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_ALL_API_ARTIFACT)) {\n+            statement.setString(1, label);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    String gatewayRuntimeArtifacts = IOUtils.toString(inputStream,\n+                            APIConstants.DigestAuthConstants.CHARSET);\n+                    gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+                } catch (IOException  e) {\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \", e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts \" , e);\n+        }\n+        return gatewayRuntimeArtifactsArray;\n+    }\n+\n+    /**\n+     * Check whether the API is published in any of the Gateways\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIPublishedInAnyGateway(String APIId) throws APIManagementException {\n+\n+        int count = 0;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_PUBLISHED_GATEWAYS_FOR_API)) {\n+            statement.setString(1, APIId);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                count = rs.getInt(\"COUNT\");\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed check whether API is published in any gateway \" + APIId, e);\n+        }\n+        return count != 0;\n+    }\n+\n+    /**\n+     * Check whether the API details exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIDetailsExists(String APIId) throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.GET_GATEWAY_PUBLISHED_API_DETAILS)) {\n+            statement.setString(1, APIId);\n+            ResultSet rs = statement.executeQuery();\n+            return rs.next();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to check API details status of API with ID \" + APIId, e);\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Check whether the API artifact for given label exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIArtifactExists(String APIId, String gatewayLabel) throws APIManagementException {\n+\n+        boolean isExist = false;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyNTc2Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449525763", "bodyText": "e63b7ad", "author": "Sarangan0219", "createdAt": "2020-07-03T11:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMDQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxNjA0NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449416044", "bodyText": "Instead of synchronizing the entire class(which leads to locking all methods of the class), it would be better to move this block into a private synchronized method. It would then look like,\npublic static void initialize() throws APIManagerDatabaseException {\n        if (artifactSynchronizerDataSource != null) {\n            return;\n        }\n\n        InitDataSource();\n}\n\nprivate static void InitDataSource() synchronized {\n    .............\n}\n\nThis would ensure that only callers of the initialize() method will have the potential of having to wait in a concurrent scenario, but callers of the getArtifactSynchronizerConnection() method will not be affected by this.", "author": "uvindra", "createdAt": "2020-07-03T07:14:28Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/GatewayArtifactsMgtDBUtil.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.wso2.carbon.apimgt.impl.utils;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.api.APIManagerDatabaseException;\n+import org.wso2.carbon.apimgt.impl.dto.GatewayArtifactSynchronizerProperties;\n+import org.wso2.carbon.apimgt.impl.internal.ServiceReferenceHolder;\n+import javax.naming.Context;\n+import javax.naming.InitialContext;\n+import javax.naming.NamingException;\n+import javax.sql.DataSource;\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+\n+public class GatewayArtifactsMgtDBUtil {\n+\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDBUtil.class);\n+    private static volatile DataSource artifactSynchronizerDataSource = null;\n+\n+    /**\n+     * Initializes the data source\n+     *\n+     * @throws APIManagementException if an error occurs while loading DB configuration\n+     */\n+    public static void initialize() throws APIManagerDatabaseException {\n+        if (artifactSynchronizerDataSource != null) {\n+            return;\n+        }\n+\n+        synchronized (GatewayArtifactsMgtDBUtil.class) {", "originalCommit": "6604c7cf1386950cd25886fffa21addbbc595804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUwMzAzMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449503031", "bodyText": "dab8323", "author": "Sarangan0219", "createdAt": "2020-07-03T10:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxNjA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQzNjIzMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449436230", "bodyText": "password must be a char[]", "author": "bhathiya", "createdAt": "2020-07-03T07:58:34Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBRetriever.java", "diffHunk": "@@ -44,39 +56,76 @@ public void init() throws ArtifactSynchronizerException {\n     @Override\n     public String retrieveArtifact(String APIId, String gatewayLabel, String gatewayInstruction)\n             throws ArtifactSynchronizerException {\n-\n-        String gatewayRuntimeArtifacts;\n+        CloseableHttpResponse httpResponse = null;\n         try {\n-            ByteArrayInputStream byteStream =\n-                    apiMgtDAO.getGatewayPublishedAPIArtifacts(APIId, gatewayLabel, gatewayInstruction);\n-            byte[] bytes = ByteStreams.toByteArray(byteStream);\n-            gatewayRuntimeArtifacts = new String(bytes);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Successfully retrieved Artifact of \" + APIId);\n+            String baseURL = eventHubConfigurationDto.getServiceUrl();\n+            String endcodedgatewayLabel= URLEncoder.encode(gatewayLabel, APIConstants.DigestAuthConstants.CHARSET);\n+            String path = APIConstants.GatewayArtifactSynchronizer.SYNAPSE_ARTIFACTS + \"?apiId=\" + APIId +\n+                    \"&gatewayInstruction=\" + gatewayInstruction + \"&gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            httpResponse = invokeService(endpoint);\n+            String gatewayRuntimeArtifact = null;\n+            if (httpResponse.getEntity() != null ) {\n+                gatewayRuntimeArtifact = EntityUtils.toString(httpResponse.getEntity(),\n+                        APIConstants.DigestAuthConstants.CHARSET);\n+                httpResponse.close();\n+            } else {\n+                throw new ArtifactSynchronizerException(\"HTTP response is empty\");\n             }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact belongs to  \" + APIId + \" from DB\", e);\n+            return gatewayRuntimeArtifact;\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client\";\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n         }\n-        return gatewayRuntimeArtifacts;\n     }\n \n     @Override\n     public List<String> retrieveAllArtifacts(String label) throws ArtifactSynchronizerException {\n         List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        CloseableHttpResponse httpResponse = null;\n         try {\n-            List<ByteArrayInputStream> baip = apiMgtDAO.getAllGatewayPublishedAPIArtifacts(label);\n-            for (ByteArrayInputStream byteStream :baip){\n-                byte[] bytes = ByteStreams.toByteArray(byteStream);\n-                String  gatewayRuntimeArtifacts = new String(bytes);\n-                gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+            String endcodedgatewayLabel= URLEncoder.encode(label, APIConstants.DigestAuthConstants.CHARSET);\n+            String path = APIConstants.GatewayArtifactSynchronizer.GATEAY_SYNAPSE_ARTIFACTS\n+                    + \"?gatewayLabel=\"+ endcodedgatewayLabel;\n+            String endpoint = baseURL + path;\n+            httpResponse = invokeService(endpoint);\n+            String responseString;\n+            if (httpResponse.getEntity() != null ) {\n+                responseString = EntityUtils.toString(httpResponse.getEntity(),\n+                        APIConstants.DigestAuthConstants.CHARSET);\n+                httpResponse.close();\n+            } else {\n+                throw new ArtifactSynchronizerException(\"HTTP response is empty\");\n             }\n-            if (log.isDebugEnabled()){\n-                log.debug(\"Successfully retrieved Artifacts from DB\");\n+            JSONObject artifactObject = new JSONObject(responseString);\n+            JSONArray jArray = (JSONArray)artifactObject.get(\"list\");\n+            if (jArray != null) {\n+                for (int i = 0; i < jArray.length(); i++) {\n+                    gatewayRuntimeArtifactsArray.add(jArray.get(i).toString());\n+                }\n             }\n-        } catch (APIManagementException | IOException e) {\n-            throw new ArtifactSynchronizerException(\"Error retrieving Artifact from DB\", e);\n+            return gatewayRuntimeArtifactsArray;\n+        } catch (IOException e) {\n+            String msg = \"Error while executing the http client\";\n+            log.error(msg, e);\n+            throw new ArtifactSynchronizerException(msg, e);\n         }\n-        return gatewayRuntimeArtifactsArray;\n+    }\n+\n+    private CloseableHttpResponse invokeService(String endpoint) throws IOException {\n+        HttpGet method = new HttpGet(endpoint);\n+        URL url = new URL(endpoint);\n+        String username = eventHubConfigurationDto.getUsername();\n+        String password = eventHubConfigurationDto.getPassword();", "originalCommit": "5bd22237441b3f4612408e9272a9de8c9d986429", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUwMTU4Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449501587", "bodyText": "Yes . But the getPassword() method returns a string (converting char[] --> String)\nhttps://github.com/wso2/carbon-apimgt/blob/master/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dto/EventHubConfigurationDto.java#L90", "author": "Sarangan0219", "createdAt": "2020-07-03T10:09:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQzNjIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzMjk1OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449532959", "bodyText": "we need to change that. @tharindu1st was there any reason not to do that?", "author": "bhathiya", "createdAt": "2020-07-03T11:25:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQzNjIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3ODkyNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r449578926", "bodyText": "we need to change it", "author": "tharindu1st", "createdAt": "2020-07-03T13:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQzNjIzMA=="}], "type": "inlineReview"}, {"oid": "dab832307b308f4cee423710218258ee6b0ed015", "url": "https://github.com/wso2/carbon-apimgt/commit/dab832307b308f4cee423710218258ee6b0ed015", "message": "address review comments", "committedDate": "2020-07-03T08:34:14Z", "type": "commit"}, {"oid": "e63b7ade3ca6bc3c58a5128aa3c1a9c8bd31e264", "url": "https://github.com/wso2/carbon-apimgt/commit/e63b7ade3ca6bc3c58a5128aa3c1a9c8bd31e264", "message": "Commit all changes before accessing DB", "committedDate": "2020-07-03T11:06:17Z", "type": "commit"}, {"oid": "95d56c93e6b56670cfa563cf362dadd389407373", "url": "https://github.com/wso2/carbon-apimgt/commit/95d56c93e6b56670cfa563cf362dadd389407373", "message": "change query name", "committedDate": "2020-07-05T16:32:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA1ODQ2NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r450058465", "bodyText": "Resultset closing missed", "author": "tharindu1st", "createdAt": "2020-07-06T08:19:02Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/GatewayArtifactsMgtDAO.java", "diffHunk": "@@ -0,0 +1,240 @@\n+package org.wso2.carbon.apimgt.impl.dao;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.dao.constants.SQLConstants;\n+import org.wso2.carbon.apimgt.impl.utils.GatewayArtifactsMgtDBUtil;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GatewayArtifactsMgtDAO {\n+    private static final Log log = LogFactory.getLog(GatewayArtifactsMgtDAO.class);\n+    private static GatewayArtifactsMgtDAO gatewayArtifactsMgtDAO = null;\n+\n+    /**\n+     * Private constructor\n+     */\n+    private GatewayArtifactsMgtDAO () {\n+    }\n+\n+    /**\n+     * Method to get the instance of the GatewayArtifactsMgtDAO.\n+     *\n+     * @return {@link GatewayArtifactsMgtDAO} instance\n+     */\n+    public static GatewayArtifactsMgtDAO getInstance() {\n+        if (gatewayArtifactsMgtDAO == null) {\n+            gatewayArtifactsMgtDAO = new GatewayArtifactsMgtDAO();\n+        }\n+        return gatewayArtifactsMgtDAO;\n+    }\n+\n+    /**\n+     * Add details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param APIName      - Name of the API\n+     * @param version      - Version of the API\n+     * @param tenantDomain - Tenant domain of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIDetails(String APIId, String APIName, String version, String tenantDomain)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.ADD_GW_PUBLISHED_API_DETAILS)) {\n+                    statement.setString(1, APIId);\n+                    statement.setString(2, APIName);\n+                    statement.setString(3, version);\n+                    statement.setString(4, tenantDomain);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add API details for \" + APIName, e);\n+        }\n+    }\n+\n+    /**\n+     * Add or update details of the APIs published in the Gateway\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Published gateway's label\n+     * @param bais         - Byte array Input stream of the serializide gatewayAPIDTO\n+     * @param streamLength - Length of the stream\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public void addGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel, ByteArrayInputStream bais,\n+            int streamLength, String gatewayInstruction, String query)\n+            throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection()) {\n+            connection.setAutoCommit(false);\n+                try (PreparedStatement statement = connection.prepareStatement(query)) {\n+                    statement.setBinaryStream(1, bais, streamLength);\n+                    statement.setString(2, gatewayInstruction);\n+                    statement.setString(3, APIId);\n+                    statement.setString(4, gatewayLabel);\n+                    statement.executeUpdate();\n+                }\n+            connection.commit();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to add artifacts for \" + APIId, e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the blob of the API\n+     *\n+     * @param APIId        - UUID of the API\n+     * @param gatewayLabel - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public String getGatewayPublishedAPIArtifacts(String APIId, String gatewayLabel,\n+            String gatewayInstruction)\n+            throws APIManagementException {\n+\n+        String gatewayRuntimeArtifacts = null;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_API_ARTIFACT)) {\n+            connection.setAutoCommit(false);\n+            connection.commit();\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            statement.setString(3, gatewayInstruction);\n+            ResultSet rs = statement.executeQuery();\n+            if (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    gatewayRuntimeArtifacts = IOUtils.toString(inputStream, APIConstants.DigestAuthConstants.CHARSET);\n+                } catch (IOException  e){\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \" + APIId, e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts of API with ID \" + APIId, e);\n+        }\n+        return gatewayRuntimeArtifacts;\n+    }\n+\n+    /**\n+     * Retrieve the list of blobs of the APIs for a given label\n+     *\n+     * @param label - Gateway label of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public List<String> getAllGatewayPublishedAPIArtifacts(String label)\n+            throws APIManagementException {\n+\n+        List<String> gatewayRuntimeArtifactsArray = new ArrayList<>();\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.GET_ALL_API_ARTIFACT)) {\n+            connection.setAutoCommit(false);\n+            connection.commit();\n+            statement.setString(1, label);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                try (InputStream inputStream = rs.getBinaryStream(1)) {\n+                    String gatewayRuntimeArtifacts = IOUtils.toString(inputStream,\n+                            APIConstants.DigestAuthConstants.CHARSET);\n+                    gatewayRuntimeArtifactsArray.add(gatewayRuntimeArtifacts);\n+                } catch (IOException  e) {\n+                    handleException(\"Error in generating gatewayRuntimeArtifacts \", e);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed to get artifacts \" , e);\n+        }\n+        return gatewayRuntimeArtifactsArray;\n+    }\n+\n+    /**\n+     * Check whether the API is published in any of the Gateways\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIPublishedInAnyGateway(String APIId) throws APIManagementException {\n+\n+        int count = 0;\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.GET_PUBLISHED_GATEWAYS_FOR_API)) {\n+            connection.setAutoCommit(false);\n+            connection.commit();\n+            statement.setString(1, APIId);\n+            statement.setString(2, APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_PUBLISH);\n+            ResultSet rs = statement.executeQuery();\n+            while (rs.next()) {\n+                count = rs.getInt(\"COUNT\");\n+            }\n+        } catch (SQLException e) {\n+            handleException(\"Failed check whether API is published in any gateway \" + APIId, e);\n+        }\n+        return count != 0;\n+    }\n+\n+    /**\n+     * Check whether the API details exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIDetailsExists(String APIId) throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection\n+                        .prepareStatement(SQLConstants.CHECK_API_EXISTS)) {\n+            connection.setAutoCommit(false);\n+            connection.commit();\n+            statement.setString(1, APIId);\n+            ResultSet rs = statement.executeQuery();\n+            return rs.next();\n+        } catch (SQLException e) {\n+            handleException(\"Failed to check API details status of API with ID \" + APIId, e);\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Check whether the API artifact for given label exists in the db\n+     *\n+     * @param APIId - UUID of the API\n+     * @throws APIManagementException if an error occurs\n+     */\n+    public boolean isAPIArtifactExists(String APIId, String gatewayLabel) throws APIManagementException {\n+\n+        try (Connection connection = GatewayArtifactsMgtDBUtil.getArtifactSynchronizerConnection();\n+                PreparedStatement statement = connection.prepareStatement(SQLConstants.CHECK_ARTIFACT_EXISTS)) {\n+            connection.setAutoCommit(false);\n+            connection.commit();\n+            statement.setString(1, APIId);\n+            statement.setString(2, gatewayLabel);\n+            ResultSet rs = statement.executeQuery();", "originalCommit": "95d56c93e6b56670cfa563cf362dadd389407373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA4MTYwNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r450081605", "bodyText": "a0f5e81", "author": "Sarangan0219", "createdAt": "2020-07-06T08:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA1ODQ2NQ=="}], "type": "inlineReview"}, {"oid": "a0f5e812a1df57c239ccebc5b7f566ca525443b7", "url": "https://github.com/wso2/carbon-apimgt/commit/a0f5e812a1df57c239ccebc5b7f566ca525443b7", "message": "closing resultsets", "committedDate": "2020-07-06T08:29:57Z", "type": "commit"}, {"oid": "c23f36ec5655e7ca2a6e9df4aee5673d94d3c167", "url": "https://github.com/wso2/carbon-apimgt/commit/c23f36ec5655e7ca2a6e9df4aee5673d94d3c167", "message": "Merge upstream", "committedDate": "2020-07-06T08:33:16Z", "type": "commit"}, {"oid": "686f3a550b65e231198479099a58630a224583ff", "url": "https://github.com/wso2/carbon-apimgt/commit/686f3a550b65e231198479099a58630a224583ff", "message": "Add description in db scripts", "committedDate": "2020-07-06T08:36:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NjU3OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540676579", "bodyText": "I think we can have this declaration in single line.", "author": "VirajSalaka", "createdAt": "2020-12-11T04:09:56Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -99,4 +102,40 @@ public void invoke() {\n         }\n     }\n \n-}\n+\n+    public void startListener() {\n+        new Thread(this).start();\n+    }\n+\n+    @Override\n+    public void run() {\n+        deployArtifactsInGateway();\n+    }\n+\n+    private void deployArtifactsInGateway() {\n+\n+        long retryDuration =", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3Nzg4MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552077880", "bodyText": "Fixed in the latest version https://github.com/wso2/carbon-apimgt/blob/master/components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java#L164", "author": "Sarangan0219", "createdAt": "2021-01-05T17:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NjU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NjY4OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540676689", "bodyText": "new line in the end of file", "author": "VirajSalaka", "createdAt": "2020-12-11T04:10:13Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -99,4 +102,40 @@ public void invoke() {\n         }\n     }\n \n-}\n+\n+    public void startListener() {\n+        new Thread(this).start();\n+    }\n+\n+    @Override\n+    public void run() {\n+        deployArtifactsInGateway();\n+    }\n+\n+    private void deployArtifactsInGateway() {\n+\n+        long retryDuration =\n+                gatewayArtifactSynchronizerProperties.getRetryDuartion();\n+        double reconnectionProgressionFactor = 2.0;\n+        long maxReconnectDuration = 1000 * 60 * 60; // 1 hour\n+\n+        while (true) {\n+            boolean isArtifactsDeployed = deployArtifactsAtStartup();\n+            if (isArtifactsDeployed) {\n+                log.info(\"Synapse Artifacts deployed Successfully in the Gateway\");\n+                break;\n+            } else {\n+                retryDuration = (long) (retryDuration * reconnectionProgressionFactor);\n+                if (retryDuration > maxReconnectDuration) {\n+                    retryDuration = maxReconnectDuration;\n+                }\n+                log.error(\"Unable to deploy synapse artifacts at gateway. Next retry in \" + (retryDuration / 1000)\n+                        + \" seconds\");\n+                try {\n+                    Thread.sleep(retryDuration);\n+                } catch (InterruptedException ignore) {\n+                }\n+            }\n+        }\n+    }\n+}", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4NDcyMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552084723", "bodyText": "9779641", "author": "Sarangan0219", "createdAt": "2021-01-05T17:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NjY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NzUzMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540677533", "bodyText": "new line in the EOF.", "author": "VirajSalaka", "createdAt": "2020-12-11T04:12:51Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/gatewayartifactsynchronizer/DBSaver.java", "diffHunk": "@@ -96,4 +101,4 @@ public String getName() {\n \n         return APIConstants.GatewayArtifactSynchronizer.DB_SAVER_NAME;\n     }\n-}\n+}", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4NDMwNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552084305", "bodyText": "9779641", "author": "Sarangan0219", "createdAt": "2021-01-05T17:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NzUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3Nzc4OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540677789", "bodyText": "Can we get rid of these additional new lines in the middle", "author": "VirajSalaka", "createdAt": "2020-12-11T04:13:46Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/gen/java/org/wso2/carbon/apimgt/internal/service/SynapseArtifactsApi.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package org.wso2.carbon.apimgt.internal.service;\n+\n+import org.wso2.carbon.apimgt.internal.service.dto.ErrorDTO;\n+import org.wso2.carbon.apimgt.internal.service.SynapseArtifactsApiService;\n+import org.wso2.carbon.apimgt.internal.service.impl.SynapseArtifactsApiServiceImpl;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+\n+import javax.ws.rs.*;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.SecurityContext;\n+import javax.inject.Inject;\n+\n+import io.swagger.annotations.*;\n+import java.io.InputStream;\n+\n+import org.apache.cxf.jaxrs.ext.MessageContext;\n+import org.apache.cxf.jaxrs.ext.multipart.Attachment;\n+import org.apache.cxf.jaxrs.ext.multipart.Multipart;\n+\n+import java.util.Map;\n+import java.util.List;\n+import javax.validation.constraints.*;\n+@Path(\"/synapse-artifacts\")\n+\n+@Api(description = \"the synapse-artifacts API\")\n+\n+@Produces({ \"application/json\" })\n+\n+\n+public class SynapseArtifactsApi  {\n+\n+  @Context MessageContext securityContext;\n+\n+SynapseArtifactsApiService delegate = new SynapseArtifactsApiServiceImpl();\n+\n+\n+    @GET\n+    ", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3ODYwNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552078606", "bodyText": "This is an auto generated file. We don't need to modify this.", "author": "Sarangan0219", "createdAt": "2021-01-05T17:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3Nzc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3Nzk4Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540677987", "bodyText": "remove additional new lines", "author": "VirajSalaka", "createdAt": "2020-12-11T04:14:25Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/gen/java/org/wso2/carbon/apimgt/internal/service/dto/SynapseArtifactDTO.java", "diffHunk": "@@ -0,0 +1,202 @@\n+package org.wso2.carbon.apimgt.internal.service.dto;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import javax.validation.constraints.*;\n+\n+\n+import io.swagger.annotations.*;\n+import java.util.Objects;\n+\n+import javax.xml.bind.annotation.*;\n+import org.wso2.carbon.apimgt.rest.api.util.annotations.Scope;\n+\n+\n+", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4MDA4MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552080081", "bodyText": "This is an auto generated file. We don't need to modify this.", "author": "Sarangan0219", "createdAt": "2021-01-05T17:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3Nzk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3ODI0NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540678245", "bodyText": "Import the exact Class rather than using wildcard.", "author": "VirajSalaka", "createdAt": "2020-12-11T04:15:08Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/gen/java/org/wso2/carbon/apimgt/internal/service/GatewaySynapseArtifactsApi.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package org.wso2.carbon.apimgt.internal.service;\n+\n+import org.wso2.carbon.apimgt.internal.service.dto.ErrorDTO;\n+import org.wso2.carbon.apimgt.internal.service.dto.SynapseArtifactListDTO;\n+import org.wso2.carbon.apimgt.internal.service.GatewaySynapseArtifactsApiService;\n+import org.wso2.carbon.apimgt.internal.service.impl.GatewaySynapseArtifactsApiServiceImpl;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+\n+import javax.ws.rs.*;", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4MDE2Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552080167", "bodyText": "This is an auto-generated file. We don't need to modify this.", "author": "Sarangan0219", "createdAt": "2021-01-05T17:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3ODI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3ODMxMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540678311", "bodyText": "Import the exact Class rather than using wildcard.", "author": "VirajSalaka", "createdAt": "2020-12-11T04:15:22Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/gen/java/org/wso2/carbon/apimgt/internal/service/GatewaySynapseArtifactsApiService.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package org.wso2.carbon.apimgt.internal.service;\n+\n+import org.wso2.carbon.apimgt.internal.service.*;", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4MDI0MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552080241", "bodyText": "This is an auto-generated file. We don't need to modify this.", "author": "Sarangan0219", "createdAt": "2021-01-05T17:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3ODMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3ODM0OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540678349", "bodyText": "Import the exact Class rather than using wildcard.", "author": "VirajSalaka", "createdAt": "2020-12-11T04:15:33Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/gen/java/org/wso2/carbon/apimgt/internal/service/SynapseArtifactsApi.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package org.wso2.carbon.apimgt.internal.service;\n+\n+import org.wso2.carbon.apimgt.internal.service.dto.ErrorDTO;\n+import org.wso2.carbon.apimgt.internal.service.SynapseArtifactsApiService;\n+import org.wso2.carbon.apimgt.internal.service.impl.SynapseArtifactsApiServiceImpl;\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+\n+import javax.ws.rs.*;", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4MDI5Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552080297", "bodyText": "This is an auto-generated file. We don't need to modify this.", "author": "Sarangan0219", "createdAt": "2021-01-05T17:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3ODM0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3ODg0NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r540678844", "bodyText": "remove additional new line", "author": "VirajSalaka", "createdAt": "2020-12-11T04:17:07Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/main/java/org/wso2/carbon/apimgt/internal/service/impl/GatewaySynapseArtifactsApiServiceImpl.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package org.wso2.carbon.apimgt.internal.service.impl;\n+\n+import org.wso2.carbon.apimgt.api.APIManagementException;\n+import org.wso2.carbon.apimgt.impl.dao.GatewayArtifactsMgtDAO;\n+import org.wso2.carbon.apimgt.internal.service.GatewaySynapseArtifactsApiService;\n+import org.apache.cxf.jaxrs.ext.MessageContext;\n+import org.wso2.carbon.apimgt.internal.service.dto.SynapseArtifactListDTO;\n+import java.util.List;\n+import javax.ws.rs.core.Response;\n+\n+\n+", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4MTcwNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552081705", "bodyText": "Fixed in the latest version https://github.com/wso2/carbon-apimgt/blob/master/components/apimgt/org.wso2.carbon.apimgt.internal.service/src/main/java/org/wso2/carbon/apimgt/internal/service/impl/GatewaySynapseArtifactsApiServiceImpl.java#L12", "author": "Sarangan0219", "createdAt": "2021-01-05T17:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3ODg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0NDk1MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r551744950", "bodyText": "Rather than using wild card import. use the exact classes.", "author": "RAVEENSR", "createdAt": "2021-01-05T06:45:53Z", "path": "components/apimgt/org.wso2.carbon.apimgt.internal.service/src/gen/java/org/wso2/carbon/apimgt/internal/service/SynapseArtifactsApiService.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package org.wso2.carbon.apimgt.internal.service;\n+\n+import org.wso2.carbon.apimgt.internal.service.*;", "originalCommit": "686f3a550b65e231198479099a58630a224583ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0NTA5Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r551745093", "bodyText": "Fix this issue in other places/files as well.", "author": "RAVEENSR", "createdAt": "2021-01-05T06:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0NDk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4MjM1Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8828#discussion_r552082353", "bodyText": "This is an auto-generated file. We don't need to modify this.", "author": "Sarangan0219", "createdAt": "2021-01-05T17:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0NDk1MA=="}], "type": "inlineReview"}]}