{"pr_number": 8198, "pr_title": "Improvement to support multiple token issuers with Claim Mappings", "pr_createdAt": "2020-02-16T07:16:18Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8198", "timeline": [{"oid": "ec2be93857b2459d3e2ec17548834f1108ecfb6e", "url": "https://github.com/wso2/carbon-apimgt/commit/ec2be93857b2459d3e2ec17548834f1108ecfb6e", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-16T11:32:21Z", "type": "forcePushed"}, {"oid": "5b3b7f99458049c82da26edbe566189da7f8f4b0", "url": "https://github.com/wso2/carbon-apimgt/commit/5b3b7f99458049c82da26edbe566189da7f8f4b0", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-16T17:17:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxNjMwOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r379916309", "bodyText": "Too much information about the underlying implementation is spilled over to the Authenticator. This makes the Authenticator fragile. In the case a different approach to represent JWT is chosen, Authenticator would have to be changed. Consider creating another layer of abstraction. You can either make JWTInfoDto an entity class by adding JWT related methods, or create a new class for handling JWT related stuff.", "author": "jaadds", "createdAt": "2020-02-16T16:41:49Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/apikey/ApiKeyAuthenticator.java", "diffHunk": "@@ -16,6 +16,14 @@\n \n package org.wso2.carbon.apimgt.gateway.handlers.security.apikey;\n \n+import com.nimbusds.jose.JOSEObjectType;\n+import com.nimbusds.jose.JWSHeader;", "originalCommit": "ec2be93857b2459d3e2ec17548834f1108ecfb6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxNjcyNw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r379916727", "bodyText": "These methods too should go into a different entity class, rather than into a Util method. Now the GatewayUtil is coupled with the implementation of the JWT.", "author": "jaadds", "createdAt": "2020-02-16T16:49:02Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/utils/GatewayUtils.java", "diffHunk": "@@ -635,35 +660,12 @@ public static JSONObject validateAPISubscription(String apiContext, String apiVe\n     /**\n      * Verify the JWT token signature.\n      *\n-     * @param splitToken The JWT token which is split into [header, payload, signature]\n+     * @param jwt SignedJwt Token\n      * @param alias      public certificate keystore alias\n      * @return whether the signature is verified or or not\n      * @throws APISecurityException in case of signature verification failure\n      */\n-    public static boolean verifyTokenSignature(String[] splitToken, String alias) throws APISecurityException {\n-\n-        String signatureAlgorithm = null;\n-        // Retrieve signature algorithm from token header\n-        try {\n-            signatureAlgorithm = APIUtil.getSignatureAlgorithm(splitToken);\n-        } catch (APIManagementException e) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Token decryption failure when retrieving signature algorithm. Token: \" +\n-                        getMaskedToken(splitToken), e);\n-            }\n-            log.error(\"Invalid Api Key. Failed to decode the Api Key header.\");\n-            throw new APISecurityException(APISecurityConstants.API_AUTH_INVALID_CREDENTIALS,\n-                    APISecurityConstants.API_AUTH_INVALID_CREDENTIALS_MESSAGE, e);\n-        }\n-\n-        if (StringUtils.isBlank(signatureAlgorithm)) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Signature algorithm not found in the token. Token: \" + getMaskedToken(splitToken));\n-            }\n-            log.error(\"Invalid JWT token. Signature algorithm not found in the token.\");\n-            throw new APISecurityException(APISecurityConstants.API_AUTH_INVALID_CREDENTIALS,\n-                    APISecurityConstants.API_AUTH_INVALID_CREDENTIALS_MESSAGE);\n-        }\n+    public static boolean verifyTokenSignature(SignedJWT jwt, String alias) throws APISecurityException {", "originalCommit": "ec2be93857b2459d3e2ec17548834f1108ecfb6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMTMwMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r379921302", "bodyText": "Improper use of exceptions. This is going to cause performance issues down the line. Better replace it with a logic that checks validity.", "author": "jaadds", "createdAt": "2020-02-16T17:58:24Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/apikey/ApiKeyAuthenticator.java", "diffHunk": "@@ -398,26 +413,24 @@ private String removeApiKeyFromQueryParameters(String queryParam, String apiKey)\n      * @param payload The payload of the JWT token\n      * @return returns true if the JWT token is expired\n      */\n-    private static boolean isJwtTokenExpired(JSONObject payload) {\n-        //if exp claim not in the token, we treat it as infinite validity token.\n-        if (!payload.has(APIConstants.JwtTokenConstants.EXPIRY_TIME)) {\n-            return false;\n-        }\n-        // Check whether the token is expired or not.\n-        long issuedTime = payload.getLong(APIConstants.JwtTokenConstants.ISSUED_TIME) * 1000;\n-        long expiryTime = payload.getLong(APIConstants.JwtTokenConstants.EXPIRY_TIME) * 1000;\n-        long validityPeriod = expiryTime - issuedTime;\n-        long timestampSkew = OAuthServerConfiguration.getInstance().getTimeStampSkewInSeconds()*1000;\n-        long currentTime = System.currentTimeMillis();\n-\n-        //If the expiry time is not a never expiring value\n-        if (expiryTime != Long.MAX_VALUE && (currentTime - timestampSkew) > validityPeriod) {\n-            if ((currentTime - timestampSkew) > expiryTime) {\n+    private static boolean isJwtTokenExpired(JWTClaimsSet payload) {\n+\n+        int timestampSkew = (int) OAuthServerConfiguration.getInstance().getTimeStampSkewInSeconds();\n+\n+        DefaultJWTClaimsVerifier jwtClaimsSetVerifier = new DefaultJWTClaimsVerifier();\n+        jwtClaimsSetVerifier.setMaxClockSkew(timestampSkew);\n+        try {", "originalCommit": "5b3b7f99458049c82da26edbe566189da7f8f4b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "48adc30f8ccb1bc67dcb679667e44d232627d5c3", "url": "https://github.com/wso2/carbon-apimgt/commit/48adc30f8ccb1bc67dcb679667e44d232627d5c3", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-17T06:24:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDExMTMyMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r380111320", "bodyText": "Class name should be singular?", "author": "harsha89", "createdAt": "2020-02-17T10:50:56Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConstants.java", "diffHunk": "@@ -1958,4 +1958,24 @@ private ConfigParameters() {\n \n     public static final String DEFAULT_SCOPE_TYPE = \"OAUTH2\";\n     public static final String DEFAULT_BINDING_TYPE = \"DEFAULT\";\n+\n+    public static class TokenIssuers {", "originalCommit": "48adc30f8ccb1bc67dcb679667e44d232627d5c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDExMzcxOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r380113719", "bodyText": "Better to log woth masked token to give more cality.", "author": "harsha89", "createdAt": "2020-02-17T10:55:47Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java", "diffHunk": "@@ -585,30 +641,39 @@ private void checkTokenWithTheScope(String resource, String resourceScope, JSONO\n      * @param tenantDomain   The tenant domain from which the token cache is retrieved\n      * @throws APISecurityException if the token is expired\n      */\n-    private void checkTokenExpiration(String tokenSignature, JSONObject payload, String tenantDomain) throws APISecurityException {\n-        // Check whether the token is expired or not.\n-        long issuedTime = payload.getLong(APIConstants.JwtTokenConstants.ISSUED_TIME) * 1000;\n-        long expiredTime = payload.getLong(APIConstants.JwtTokenConstants.EXPIRY_TIME) * 1000;\n-        long validityPeriod = expiredTime - issuedTime;\n-        long timestampSkew = OAuthServerConfiguration.getInstance().getTimeStampSkewInSeconds() * 1000;\n-        long currentTime = System.currentTimeMillis();\n-\n-        //If the validity period is not a never expiring value\n-        if (validityPeriod != Long.MAX_VALUE && (currentTime - timestampSkew) > validityPeriod) {\n-            if ((currentTime - timestampSkew) > expiredTime) {\n-                if (isGatewayTokenCacheEnabled) {\n-                    getGatewayTokenCache().remove(tokenSignature);\n-                    getGatewayJWTTokenCache().remove(tokenSignature);\n-                    getInvalidTokenCache().put(tokenSignature, tenantDomain);\n-                }\n-                log.error(\"JWT token is expired\");\n-                throw new APISecurityException(APISecurityConstants.API_AUTH_ACCESS_TOKEN_EXPIRED,\n-                        \"JWT token is expired\");\n+    private void checkTokenExpiration(String tokenSignature, JWTClaimsSet payload, String tenantDomain)\n+            throws APISecurityException {\n+\n+        long timestampSkew = OAuthServerConfiguration.getInstance().getTimeStampSkewInSeconds();\n+\n+        Date now = new Date();\n+        Date exp = payload.getExpirationTime();\n+        if (exp != null && !DateUtils.isAfter(exp, now, timestampSkew)) {\n+            if (isGatewayTokenCacheEnabled) {\n+                getGatewayTokenCache().remove(tokenSignature);\n+                getGatewayJWTTokenCache().remove(tokenSignature);\n+                getInvalidTokenCache().put(tokenSignature, tenantDomain);\n             }\n+            log.error(\"JWT token is expired\");", "originalCommit": "48adc30f8ccb1bc67dcb679667e44d232627d5c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccc4029a76c83f0292a2947d181041fe9823d588", "url": "https://github.com/wso2/carbon-apimgt/commit/ccc4029a76c83f0292a2947d181041fe9823d588", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-17T13:13:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI4MDYzOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r380280639", "bodyText": "120 limit exceeded.", "author": "bhathiya", "createdAt": "2020-02-17T16:36:36Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIManagerConfiguration.java", "diffHunk": "@@ -1120,28 +1124,18 @@ private void setJWTConfiguration(OMElement omElement) {\n                 OMElement gatewayJWTGeneratorImplElement = gatewayJWTConfigurationElement\n                         .getFirstChildWithName(new QName(APIConstants.GATEWAY_JWT_GENERATOR_IMPL));\n                 jwtConfigurationDto.setGatewayJWTGeneratorImpl(gatewayJWTGeneratorImplElement.getText());\n-                OMElement gatewayJWTConfigurationsElement = gatewayJWTConfigurationElement\n-                        .getFirstChildWithName(new QName(APIConstants.GATEWAY_JWT_CONFIGURATION));\n-                if (gatewayJWTConfigurationsElement != null) {\n-                    OMElement claimsElement = gatewayJWTConfigurationsElement\n-                            .getFirstChildWithName(new QName(APIConstants.GATEWAY_JWT_GENERATOR_CLAIM_MAPPING));\n-                    if (claimsElement != null) {\n-                        Iterator claimElements =\n-                                claimsElement.getChildrenWithLocalName(APIConstants.GATEWAY_JWT_GENERATOR_CLAIM);\n-                        while (claimElements.hasNext()) {\n-                            OMElement claim = (OMElement) claimElements.next();\n-                            OMElement remoteClaimElement = claim.getFirstChildWithName(\n-                                    new QName(APIConstants.GATEWAY_JWT_GENERATOR_REMOTE_CLAIM));\n-                            OMElement localClaimElement = claim.getFirstChildWithName(\n-                                    new QName(APIConstants.GATEWAY_JWT_GENERATOR_LOCAL_CLAIM));\n-                            if (remoteClaimElement != null && localClaimElement != null) {\n-                                String remoteClaim = remoteClaimElement.getText();\n-                                String localClaim = localClaimElement.getText();\n-                                if (StringUtils.isNotEmpty(remoteClaim) &&\n-                                        StringUtils.isNotEmpty(localClaim)) {\n-                                    jwtConfigurationDto.getClaimConfigurations().add(new ClaimMappingDto(remoteClaim,\n-                                            localClaim));\n-                                }\n+                OMElement configurationElement =\n+                        gatewayJWTConfigurationElement.getFirstChildWithName(new QName(APIConstants.GATEWAY_JWT_CONFIGURATION));", "originalCommit": "ccc4029a76c83f0292a2947d181041fe9823d588", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3094a86694787760038c103de44d64772766a7c7", "url": "https://github.com/wso2/carbon-apimgt/commit/3094a86694787760038c103de44d64772766a7c7", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-18T05:32:02Z", "type": "forcePushed"}, {"oid": "97af5d894aa3532dcebcbfa3b85b7624bcc44bde", "url": "https://github.com/wso2/carbon-apimgt/commit/97af5d894aa3532dcebcbfa3b85b7624bcc44bde", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-18T11:25:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg3OTgyMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r381879822", "bodyText": "Isn't this redundant?", "author": "jaadds", "createdAt": "2020-02-20T09:31:20Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/transformer/DefaultJWTTransformer.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+package org.wso2.carbon.apimgt.gateway.handlers.security.jwt.transformer;\n+\n+import com.nimbusds.jwt.JWTClaimsSet;\n+import org.wso2.carbon.apimgt.gateway.APIMgtGatewayConstants;\n+import org.wso2.carbon.apimgt.impl.dto.ClaimMappingDto;\n+import org.wso2.carbon.apimgt.impl.dto.JWTConfigurationDto;\n+import org.wso2.carbon.apimgt.impl.dto.TokenIssuerDto;\n+\n+import java.util.Map;\n+\n+\n+public class DefaultJWTTransformer implements JWTTransformer {\n+\n+    private JWTConfigurationDto jwtConfigurationDto;\n+\n+    public DefaultJWTTransformer(JWTConfigurationDto jwtConfigurationDto) {\n+\n+        this.jwtConfigurationDto = jwtConfigurationDto;\n+    }\n+\n+    @Override\n+    public JWTClaimsSet transform(JWTClaimsSet jwtClaimsSet) {\n+\n+        String issuer = jwtClaimsSet.getIssuer();\n+        TokenIssuerDto tokenIssuerDto = jwtConfigurationDto.getTokenIssuerDtoMap().get(issuer);\n+        if (tokenIssuerDto != null) {\n+            Map<String, ClaimMappingDto> claimConfigurations = tokenIssuerDto.getClaimConfigurations();\n+            JWTClaimsSet.Builder jwtBuilder = new JWTClaimsSet.Builder();\n+            for (Map.Entry<String, Object> claimEntry : jwtClaimsSet.getClaims().entrySet()) {\n+                ClaimMappingDto claimMappingDto = claimConfigurations.get(claimEntry.getKey());\n+                String claimKey = claimEntry.getKey();", "originalCommit": "97af5d894aa3532dcebcbfa3b85b7624bcc44bde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1ODI4Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r383258286", "bodyText": "no this was used to transform JWT from one form to another", "author": "tharindu1st", "createdAt": "2020-02-24T13:16:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg3OTgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg4MDY1Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r381880653", "bodyText": "Pass the original exception while constructing the new one.", "author": "jaadds", "createdAt": "2020-02-20T09:32:51Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/apikey/ApiKeyAuthenticator.java", "diffHunk": "@@ -330,14 +342,18 @@ public AuthenticationResponse authenticate(MessageContext synCtx) {\n             }\n \n             if (log.isDebugEnabled()) {\n-                log.debug(\"Api Key signature verification failure. Api Key: \" + GatewayUtils.getMaskedToken(splitToken));\n+                log.debug(\"Api Key signature verification failure. Api Key: \" +\n+                        GatewayUtils.getMaskedToken(splitToken[0]));\n             }\n             log.error(\"Invalid Api Key. Signature verification failed.\");\n             throw new APISecurityException(APISecurityConstants.API_AUTH_INVALID_CREDENTIALS,\n                     APISecurityConstants.API_AUTH_INVALID_CREDENTIALS_MESSAGE);\n \n         } catch (APISecurityException e) {\n             return new AuthenticationResponse(false, isMandatory, true, e.getErrorCode(), e.getMessage());\n+        } catch (ParseException e) {\n+            return new AuthenticationResponse(false, isMandatory, true, APISecurityConstants.API_AUTH_GENERAL_ERROR,", "originalCommit": "97af5d894aa3532dcebcbfa3b85b7624bcc44bde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4MTMyNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r381981326", "bodyText": "Can you please elaborate how this method can be used to register multiple implementations?", "author": "jaadds", "createdAt": "2020-02-20T12:56:53Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/internal/APIHandlerServiceComponent.java", "diffHunk": "@@ -353,5 +360,40 @@ protected void unsetMediationSecurityAdminService(MediationSecurityAdminService\n \n         ServiceReferenceHolder.getInstance().setMediationSecurityAdminService(null);\n     }\n+\n+    @Reference(", "originalCommit": "97af5d894aa3532dcebcbfa3b85b7624bcc44bde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0OTIxNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r382349216", "bodyText": "OK, understood how it works. We may not have to necessarily change the approach, but need to think about the following scenarios;\na. Can the component startup order affect the logic?\nb. How easy is for the developer to write an extension. Now they need to know certain things about OSGI as well.\nWe might not have to address these through code, but at least have to provide a good document around doing b .", "author": "jaadds", "createdAt": "2020-02-21T01:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4MTMyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY4MzQyNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8198#discussion_r383683426", "bodyText": "as discussed this could be resolved", "author": "tharindu1st", "createdAt": "2020-02-25T06:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4MTMyNg=="}], "type": "inlineReview"}, {"oid": "b1ad60a44b0a24552d7bfc89ffd8f8e0725f75b7", "url": "https://github.com/wso2/carbon-apimgt/commit/b1ad60a44b0a24552d7bfc89ffd8f8e0725f75b7", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-24T13:56:54Z", "type": "forcePushed"}, {"oid": "c4c1d67f024ac75c994b5afcf30538d103e424e9", "url": "https://github.com/wso2/carbon-apimgt/commit/c4c1d67f024ac75c994b5afcf30538d103e424e9", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-25T06:39:47Z", "type": "forcePushed"}, {"oid": "6bc0f802eb1b091d96f0b33c67a1eac83af05715", "url": "https://github.com/wso2/carbon-apimgt/commit/6bc0f802eb1b091d96f0b33c67a1eac83af05715", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-25T08:19:26Z", "type": "commit"}, {"oid": "6bc0f802eb1b091d96f0b33c67a1eac83af05715", "url": "https://github.com/wso2/carbon-apimgt/commit/6bc0f802eb1b091d96f0b33c67a1eac83af05715", "message": "Improvement to support multiple token issuers with Claim Mappings", "committedDate": "2020-02-25T08:19:26Z", "type": "forcePushed"}]}