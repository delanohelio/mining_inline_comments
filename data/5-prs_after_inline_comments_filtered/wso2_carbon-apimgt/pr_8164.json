{"pr_number": 8164, "pr_title": "Add support for role mapping in tenant-conf.json ", "pr_createdAt": "2020-02-10T04:04:27Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8164", "timeline": [{"oid": "225811e3b4fb5ffdbb1f0223d27e2fad1ddb3e7a", "url": "https://github.com/wso2/carbon-apimgt/commit/225811e3b4fb5ffdbb1f0223d27e2fad1ddb3e7a", "message": "Add support for role mapping in tenant-conf.json", "committedDate": "2020-02-10T03:56:53Z", "type": "commit"}, {"oid": "f9fd7b606b732efdf08fc48c880be3d1b8a8027e", "url": "https://github.com/wso2/carbon-apimgt/commit/f9fd7b606b732efdf08fc48c880be3d1b8a8027e", "message": "Refactor code", "committedDate": "2020-02-10T04:01:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg2Nzk5MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8164#discussion_r376867990", "bodyText": "Are you trying to do below?\nscopeRoles = String.join(\",\", mappedRoles);", "author": "malinthaprasan", "createdAt": "2020-02-10T04:52:49Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -7225,16 +7281,38 @@ public static JSONObject getTenantDefaultRoles(String tenantDomain) throws APIMa\n     }\n \n     /**\n-     * @param config JSON configuration object with scopes and associated roles\n+     * @param scopesConfig JSON configuration object with scopes and associated roles\n+     * @param roleMappings JSON Configuration object with role mappings\n      * @return Map of scopes which contains scope names and associated role list\n      */\n-    public static Map<String, String> getRESTAPIScopesFromConfig(JSONObject config) {\n+    public static Map<String, String> getRESTAPIScopesFromConfig(JSONObject scopesConfig, JSONObject roleMappings) {\n         Map<String, String> scopes = new HashMap<String, String>();\n-        JSONArray scopesArray = (JSONArray) config.get(\"Scope\");\n+        JSONArray scopesArray = (JSONArray) scopesConfig.get(\"Scope\");\n         for (Object scopeObj : scopesArray) {\n             JSONObject scope = (JSONObject) scopeObj;\n             String scopeName = scope.get(APIConstants.REST_API_SCOPE_NAME).toString();\n             String scopeRoles = scope.get(APIConstants.REST_API_SCOPE_ROLE).toString();\n+            if (roleMappings != null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"REST API scope role mappings exist. Hence proceeding to swap original scope roles \"\n+                            + \"for mapped scope roles.\");\n+                }\n+                //split role list string read using comma separator\n+                List<String> originalRoles = Arrays.asList(scopeRoles.split(\"\\\\s*,\\\\s*\"));\n+                List<String> mappedRoles = new ArrayList<String>();\n+                for (String role : originalRoles) {\n+                    String mappedRole = (String) roleMappings.get(role);\n+                    if (mappedRole != null) {\n+                        if (log.isDebugEnabled()) {\n+                            log.debug(role + \" was mapped to \" + mappedRole);\n+                        }\n+                        mappedRoles.add(mappedRole);\n+                    } else {\n+                        mappedRoles.add(role);\n+                    }\n+                }\n+                scopeRoles = mappedRoles.toString().replace(\"[\", \"\").replace(\"]\", \"\").replace(\" \", \"\");", "originalCommit": "f9fd7b606b732efdf08fc48c880be3d1b8a8027e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg2OTU0Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8164#discussion_r376869546", "bodyText": "yes, fixed with 1bffd03", "author": "msm1992", "createdAt": "2020-02-10T05:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg2Nzk5MA=="}], "type": "inlineReview"}, {"oid": "1bffd034ecf46cff97a7ff824b6b9c71b0754698", "url": "https://github.com/wso2/carbon-apimgt/commit/1bffd034ecf46cff97a7ff824b6b9c71b0754698", "message": "Add review fixes", "committedDate": "2020-02-10T05:01:41Z", "type": "commit"}]}