{"pr_number": 709, "pr_title": "MySQL Client: Unix Domain Socket support", "pr_createdAt": "2020-07-03T13:16:58Z", "pr_url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyMjIwMQ==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r449722201", "bodyText": "Are we going this way which is different from the usage of postgres client(using host+port)?\nThe socket is MySQL specific property, how about keep representing the unix socket path with host field but add additional support for automatically converting socket to host in URL parser?", "author": "BillyYccc", "createdAt": "2020-07-04T00:09:10Z", "path": "vertx-mysql-client/src/main/java/io/vertx/mysqlclient/MySQLConnectOptions.java", "diffHunk": "@@ -544,4 +547,16 @@ public JsonObject toJson() {\n     MySQLConnectOptionsConverter.toJson(this, json);\n     return json;\n   }\n+\n+  @GenIgnore\n+  @Override\n+  public SocketAddress getSocketAddress() {\n+    String path = getProperties().get(\"socket\");\n+    return path != null ? SocketAddress.domainSocketAddress(path) : super.getSocketAddress();\n+  }\n+\n+  @GenIgnore\n+  public boolean isUsingDomainSocket() {\n+    return this.getProperties().containsKey(\"socket\");", "originalCommit": "08081b7bdd77f2c0b14026b027b65ab033294e6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDExNTIwNw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r450115207", "bodyText": "socket is indeed MySQL specific. It is described in our documentation as supported, even if it actually isn't. Perhaps we should support both", "author": "tsegismont", "createdAt": "2020-07-06T09:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyMjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIxNjUxNg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r450216516", "bodyText": "Done", "author": "tsegismont", "createdAt": "2020-07-06T13:22:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyMjIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyMjI5Mg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r449722292", "bodyText": "pgConnection should be renamed in this class", "author": "BillyYccc", "createdAt": "2020-07-04T00:10:10Z", "path": "vertx-mysql-client/src/test/java/io/vertx/mysqlclient/MySQLUnixDomainSocketTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright (c) 2011-2020 Contributors to the Eclipse Foundation\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0, or the Apache License, Version 2.0\n+ * which is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+ */\n+package io.vertx.mysqlclient;\n+\n+import io.vertx.core.Vertx;\n+import io.vertx.core.VertxOptions;\n+import io.vertx.ext.unit.Async;\n+import io.vertx.ext.unit.TestContext;\n+import io.vertx.ext.unit.junit.VertxUnitRunner;\n+import io.vertx.sqlclient.PoolOptions;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.testcontainers.shaded.org.apache.commons.lang.SystemUtils;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assume.assumeTrue;\n+\n+@RunWith(VertxUnitRunner.class)\n+public class MySQLUnixDomainSocketTest {\n+\n+  private static final String unixSocketDirectory = System.getProperty(\"unix.socket.directory\");\n+\n+  private MySQLPool client;\n+  private MySQLConnectOptions options;\n+\n+  @Before\n+  public void before() {\n+    assumeTrue(SystemUtils.IS_OS_UNIX);\n+    options = new MySQLConnectOptions()\n+      .setUser(\"root\")\n+      .setPassword(\"password\");\n+    if (unixSocketDirectory != null && !unixSocketDirectory.isEmpty()) {\n+      options.addProperty(\"socket\", unixSocketDirectory);\n+    }\n+    assumeTrue(options.isUsingDomainSocket());\n+  }\n+\n+  @After\n+  public void after() {\n+    if (client != null) {\n+      client.close();\n+    }\n+  }\n+\n+  @Test\n+  public void uriTest(TestContext context) throws UnsupportedEncodingException {\n+    String path = URLEncoder.encode(options.getProperties().get(\"socket\"), \"UTF-8\");\n+    String uri = \"mysql://root:password@localhost?socket=\" + path;\n+    client = MySQLPool.pool(uri);\n+    client.getConnection(context.asyncAssertSuccess(pgConnection -> pgConnection.close()));", "originalCommit": "08081b7bdd77f2c0b14026b027b65ab033294e6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIxNjYwNA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r450216604", "bodyText": "Done", "author": "tsegismont", "createdAt": "2020-07-06T13:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyMjI5Mg=="}], "type": "inlineReview"}, {"oid": "ec1c9ec75630bd82f9bd3f76ce3673b3dbfc4fb2", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/ec1c9ec75630bd82f9bd3f76ce3673b3dbfc4fb2", "message": "MySQL Client: Unix Domain Socket support\n\nResolves #521\n\nSigned-off-by: Thomas Segismont <tsegismont@gmail.com>", "committedDate": "2020-07-06T13:22:40Z", "type": "commit"}, {"oid": "ec1c9ec75630bd82f9bd3f76ce3673b3dbfc4fb2", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/ec1c9ec75630bd82f9bd3f76ce3673b3dbfc4fb2", "message": "MySQL Client: Unix Domain Socket support\n\nResolves #521\n\nSigned-off-by: Thomas Segismont <tsegismont@gmail.com>", "committedDate": "2020-07-06T13:22:40Z", "type": "forcePushed"}, {"oid": "c4ef0b7e9b9ecfad6c4e39c99ce6436b37bfecd4", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/c4ef0b7e9b9ecfad6c4e39c99ce6436b37bfecd4", "message": "Documentation for MySQL Unix Domain Socket support\n\nSigned-off-by: Thomas Segismont <tsegismont@gmail.com>", "committedDate": "2020-07-06T14:27:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMwNjAwNg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r450306006", "bodyText": "can we get rid of such shaded dependency of TestContainers?", "author": "BillyYccc", "createdAt": "2020-07-06T15:34:27Z", "path": "vertx-mysql-client/src/test/java/io/vertx/mysqlclient/MySQLUnixDomainSocketTest.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright (c) 2011-2020 Contributors to the Eclipse Foundation\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0, or the Apache License, Version 2.0\n+ * which is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+ */\n+package io.vertx.mysqlclient;\n+\n+import io.vertx.core.Vertx;\n+import io.vertx.core.VertxOptions;\n+import io.vertx.ext.unit.Async;\n+import io.vertx.ext.unit.TestContext;\n+import io.vertx.ext.unit.junit.VertxUnitRunner;\n+import io.vertx.sqlclient.PoolOptions;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.testcontainers.shaded.org.apache.commons.lang.SystemUtils;", "originalCommit": "c4ef0b7e9b9ecfad6c4e39c99ce6436b37bfecd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjY2Mw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r450326663", "bodyText": "Done", "author": "tsegismont", "createdAt": "2020-07-06T16:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMwNjAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMwODY4OA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r450308688", "bodyText": "Unix is ambiguous here and we also haven't determined how we test in OS X environment with Docker.", "author": "BillyYccc", "createdAt": "2020-07-06T15:38:29Z", "path": "vertx-mysql-client/src/test/java/io/vertx/mysqlclient/MySQLUnixDomainSocketTest.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright (c) 2011-2020 Contributors to the Eclipse Foundation\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0, or the Apache License, Version 2.0\n+ * which is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+ */\n+package io.vertx.mysqlclient;\n+\n+import io.vertx.core.Vertx;\n+import io.vertx.core.VertxOptions;\n+import io.vertx.ext.unit.Async;\n+import io.vertx.ext.unit.TestContext;\n+import io.vertx.ext.unit.junit.VertxUnitRunner;\n+import io.vertx.sqlclient.PoolOptions;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.testcontainers.shaded.org.apache.commons.lang.SystemUtils;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assume.assumeTrue;\n+\n+@RunWith(VertxUnitRunner.class)\n+public class MySQLUnixDomainSocketTest {\n+\n+  private static final String unixSocketFile = System.getProperty(\"unix.socket.file\");\n+\n+  private MySQLPool client;\n+  private MySQLConnectOptions options;\n+\n+  @Before\n+  public void before() {\n+    assumeTrue(SystemUtils.IS_OS_UNIX);", "originalCommit": "c4ef0b7e9b9ecfad6c4e39c99ce6436b37bfecd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjk4OA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/709#discussion_r450326988", "bodyText": "Yes, I've updated this check Linux only for now", "author": "tsegismont", "createdAt": "2020-07-06T16:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMwODY4OA=="}], "type": "inlineReview"}, {"oid": "e03f505b4d7772883d580002febe0d58dbae03d5", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/e03f505b4d7772883d580002febe0d58dbae03d5", "message": "Automate MySQLUnixDomainSocketTest on Linux\n\nSigned-off-by: Thomas Segismont <tsegismont@gmail.com>", "committedDate": "2020-07-06T16:00:37Z", "type": "commit"}, {"oid": "9df6e45a7506f82163aee90cedd8e96806408d1f", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/9df6e45a7506f82163aee90cedd8e96806408d1f", "message": "Don't use SystemUtils shaded dependency\n\nSigned-off-by: Thomas Segismont <tsegismont@gmail.com>", "committedDate": "2020-07-06T16:06:24Z", "type": "commit"}, {"oid": "89e4eab03a306053d84424b149d29269d3cf8589", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/89e4eab03a306053d84424b149d29269d3cf8589", "message": "Added link to MySQL server socket param documentation\n\nSigned-off-by: Thomas Segismont <tsegismont@gmail.com>", "committedDate": "2020-07-08T10:12:49Z", "type": "commit"}]}