{"pr_number": 8086, "pr_title": "RFC58: count and enrichment endpoints for combined alteration types", "pr_createdAt": "2020-11-25T10:21:43Z", "pr_url": "https://github.com/cBioPortal/cbioportal/pull/8086", "timeline": [{"oid": "514a0f10ca818f899f21c4473e364b40986d2260", "url": "https://github.com/cBioPortal/cbioportal/commit/514a0f10ca818f899f21c4473e364b40986d2260", "message": "Null-object pattern for alteration types request for enrichment an count endpoints", "committedDate": "2020-11-25T10:49:24Z", "type": "forcePushed"}, {"oid": "9d2630e1dc2c1d1b5c4c3f9b59740f9a996cc135", "url": "https://github.com/cBioPortal/cbioportal/commit/9d2630e1dc2c1d1b5c4c3f9b59740f9a996cc135", "message": "Implement map for cna and mutation types, remove exclude VUS germline and tier arguments", "committedDate": "2020-12-15T10:01:13Z", "type": "forcePushed"}, {"oid": "b1959f181ebadee1367efcbe8218e34a7e92f71d", "url": "https://github.com/cBioPortal/cbioportal/commit/b1959f181ebadee1367efcbe8218e34a7e92f71d", "message": "Rework of fusion filtering mechanism", "committedDate": "2020-12-29T08:57:30Z", "type": "forcePushed"}, {"oid": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "url": "https://github.com/cBioPortal/cbioportal/commit/48ed23abb39d061e48f4259b4d44e92aa6d39df8", "message": "Set db.version to 2.12.8", "committedDate": "2021-01-06T09:39:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU0NjAxMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r551546010", "bodyText": "is model/src/main/java/org/cbioportal/model/CNA.java not appropriate? I guess this is a subset of that.", "author": "sheridancbio", "createdAt": "2021-01-04T20:19:00Z", "path": "model/src/main/java/org/cbioportal/model/CopyNumberAlterationEventType.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package org.cbioportal.model;\n+\n+public enum CopyNumberAlterationEventType {", "originalCommit": "b1959f181ebadee1367efcbe8218e34a7e92f71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIwMTczNA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r552201734", "bodyText": "ah ha .. I see that this class came down from the web layer. So it used to specify the web layer argument options to the outside user. Like I said elsewhere in this PR, there is tension because of using the model module to represent types both for the persistence layer interface and also the web layer interface. It seems redundant to have both enums (the full set plus the subset) in the model class. If we wanted to avoid that, I guess we could use the full set as the input type to the API but validate arguments passed in to the API endpoint to make sure no illegal argument arrives. I'm not positive that this is actually an accepted parameter anymore though. If not, then I really recommend we drop the subset enum.", "author": "sheridancbio", "createdAt": "2021-01-05T21:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU0NjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTYzODc5Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555638797", "bodyText": "Ah good catch, I replaced replaced CopyNumberAlterationEventType.java for CNA.java.", "author": "pvannierop", "createdAt": "2021-01-12T09:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU0NjAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU1Mzc0Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r551553746", "bodyText": "I'm unsure about creating this new util package in model. For this enum at least, it seems like it could moved up one level (to model)", "author": "sheridancbio", "createdAt": "2021-01-04T20:34:42Z", "path": "model/src/main/java/org/cbioportal/model/util/QueryElement.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package org.cbioportal.model.util;", "originalCommit": "b1959f181ebadee1367efcbe8218e34a7e92f71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY0MDIwNw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555640207", "bodyText": "I moved QueryElement.java to org.cbioportal.model package.", "author": "pvannierop", "createdAt": "2021-01-12T09:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU1Mzc0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r551564287", "bodyText": "This is a type passed in to service layer and persistence layer calls. It is not received by API endpoints.\nMy opinion (open for discussion) is that the model package should be mainly populated with POJO-like classes which are simple structure definitions without business logic. Plus enums. This class has semantics and functional implementation, which makes me want to suggest moving it out of the model module (perhaps to org.cbioportal.persistence.util) However, it is an argument type which can be passed in to calls to the persistence layer (although not the web layer.)\nEver since we introduced the model module, there has been some ambiguity about what belongs in it ... because it captures models used at both the persistence interface and the web interface. (There are additional web models for the api in the web module (org.cbioportal.web.parameter), but they are not visible to the lower packages in the stack). Perhaps this model module primarily captures the persistence interface parameter data types, many of which are used verbatim in the service and web layers. So ok .. I guess I have talked myself into thinking that this is an appropriate type for the model module. But if it is a datatype (a \"Select\") then I guess it should be in the model package rather than the util package and we should live with it as a non-pojo model.", "author": "sheridancbio", "createdAt": "2021-01-04T20:56:56Z", "path": "model/src/main/java/org/cbioportal/model/util/Select.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package org.cbioportal.model.util;", "originalCommit": "b1959f181ebadee1367efcbe8218e34a7e92f71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY0MTUwMg==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555641502", "bodyText": "I think what I am struggling with here is that the Select class should be used in presistence, service and web modules. Is there a more appropriate location that is a common dependency for these modules?", "author": "pvannierop", "createdAt": "2021-01-12T09:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ0NjYwNw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560446607", "bodyText": "A while back, I tried to capture our module dependencies here : https://docs.google.com/document/d/1r3fJYmtzTj5qCC_xI9SkgI6k8N5TQuHnobmx75WAHa0/edit\nNote .. out of date .. there is no more business module for instance.\nAny class needed for the persistence layer must reside either in the persistence-api module or in the model module. If this is an argument type accepted by the persistence layer api, then it is correct to place it in the model module with the other classes which define the types accepted/delivered by the persistence-api. If we refactored our code base to be more clean, I think I would not share model classes up and down the persistence / service / web layers, but that is a separate discussion. My concern about this class is that it is not a plain/pojo data structure, but it has attached semantics. That is not the case with the bulk of the model module classes. Classes which have semantic functionality probably should be unit tested .. and I see that there is a SelectTest.java class in the core package. We don't need unit tests for the pojo classes in model, but for this class a test makes sense. I just would locate the test class in the same module as the tested class - so I request the test class be relocated to the model module.\nAlso, if this is an argument type accepted by the persistence layer api then I don't consider it a util (which I think of as helper classes which are only used within the module). So I would relocate it into package org.cbioportal.model and out of org.cbioportal.model.util", "author": "sheridancbio", "createdAt": "2021-01-19T19:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDcxODcxNA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560718714", "bodyText": "I do not know what to do here.\nYou proposed solution of moving the SelectTest does not work because unit tests placed in the model module do not run. That is the reason for me putting the SelectTest in the core module.\nWhen following your explanation I understand that the model module is for plain POJO models for the persistence layer. In that case I agree that Select class should not be placed there. But what to do with classes that are shared by basically all modules in the project? The Select class basically is used like java.util.List. Would this justify a new module that is used by all other modules?\nI am open to any alternative solution.", "author": "pvannierop", "createdAt": "2021-01-20T06:59:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk3NjA4MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560976081", "bodyText": "Let's reach out to someone else to give input on this question. I wonder if @kalletlak or @Luke-Sikina have an opinion on the question of where it would be best to locate a class such as Select. (which module, and which package) This is a kind of wrapper class with some utility functions and semantics --- it is a type which is accepted as an argument by functions in the persistence-api interface. It has unit tests, but those are currently (in this PR) located in the core module because the model module currently is not configured to run unit tests. Any ideas on properly locating this class (and its tests)? I've expressed a mixed opinion in this PR but I'm uncertain.", "author": "sheridancbio", "createdAt": "2021-01-20T13:54:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAxOTEyMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r562019120", "bodyText": "Since this a utility used across different module, may be it should be in its own module. which also makes testing easy. I would prefer to have it in a new module(something like utility/utils).", "author": "kalletlak", "createdAt": "2021-01-21T16:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAzMDAzMQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r562030031", "bodyText": "Thank you for the comment @kalletlak. If this were in a separate module, it would need to be added as one of the dependencies for the persistence-api module (in pom.xml)\nAny thoughts on whether it is \"ok\" to be creating a new module to hold classes which have semantics which need testing and also are used in the persistence layer API interface? This is the first such class ... perhaps there will be others to come?", "author": "sheridancbio", "createdAt": "2021-01-21T16:42:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAzMTMxMw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r562031313", "bodyText": "Also note : this relocation may be done after the merge of this PR (as a post-merge refactoring task)", "author": "sheridancbio", "createdAt": "2021-01-21T16:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAzNzA4MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r562037081", "bodyText": "@sheridancbio I think it should be ok to create new module. Also we could move any existing utilities to this new module", "author": "kalletlak", "createdAt": "2021-01-21T16:51:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU3NjQ1Mw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r551576453", "bodyText": "what happens if there are multiple CNA profiles? We only scan the first one? (or maybe this means the first profile connected per sample?)", "author": "sheridancbio", "createdAt": "2021-01-04T21:23:10Z", "path": "web/src/main/java/org/cbioportal/web/StudyViewController.java", "diffHunk": "@@ -276,13 +275,22 @@\n         @Valid @RequestAttribute(required = false, value = \"interceptedStudyViewFilter\") StudyViewFilter interceptedStudyViewFilter) throws StudyNotFoundException {\n \n         List<SampleIdentifier> filteredSampleIdentifiers = studyViewFilterApplier.apply(interceptedStudyViewFilter);\n-        List<MutationCountByGene> result = new ArrayList<>();\n+        List<AlterationCountByGene> result = new ArrayList<>();\n         if (!filteredSampleIdentifiers.isEmpty()) {\n             List<String> studyIds = new ArrayList<>();\n             List<String> sampleIds = new ArrayList<>();\n             studyViewFilterUtil.extractStudyAndSampleIds(filteredSampleIdentifiers, studyIds, sampleIds);\n-            result = mutationService.getSampleCountInMultipleMolecularProfiles(molecularProfileService\n-                .getFirstMutationProfileIds(studyIds, sampleIds), sampleIds, null, true, false);\n+            List<String> profileIdPerSample = molecularProfileService.getFirstDiscreteCNAProfileIds(studyIds, sampleIds);", "originalCommit": "b1959f181ebadee1367efcbe8218e34a7e92f71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY0NDY2MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555644660", "bodyText": "To be honest I do not know. I just followed the logic that was there in the original code:\n           result = mutationService.getSampleCountInMultipleMolecularProfiles(molecularProfileService\n                .getFirstMutationProfileIds(studyIds, sampleIds), sampleIds, null, true, false);", "author": "pvannierop", "createdAt": "2021-01-12T09:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU3NjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ0ODA2OA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560448068", "bodyText": "Ok .. if the business logic is not changed, we don't need to answer the question here. But I hope someone asked this question when the original logic was adopted.", "author": "sheridancbio", "createdAt": "2021-01-19T19:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU3NjQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEzMTk4OQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r552131989", "bodyText": "nice optimization for a common case", "author": "sheridancbio", "createdAt": "2021-01-05T19:01:45Z", "path": "web/src/main/java/org/cbioportal/web/AlterationEnrichmentController.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package org.cbioportal.web;\n+\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.service.AlterationEnrichmentService;\n+import org.cbioportal.service.exception.MolecularProfileNotFoundException;\n+import org.cbioportal.web.config.annotation.InternalApi;\n+import org.cbioportal.web.parameter.*;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.validation.annotation.Validated;\n+import org.springframework.web.bind.annotation.*;\n+import springfox.documentation.annotations.ApiIgnore;\n+\n+import javax.validation.Valid;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+@InternalApi\n+@RestController\n+@Validated\n+@Api(tags = \"Alteration Enrichments\", description = \" \")\n+public class AlterationEnrichmentController {\n+\n+    @Autowired\n+    private AlterationEnrichmentService alterationEnrichmentService;\n+\n+    @PreAuthorize(\"hasPermission(#involvedCancerStudies, 'Collection<CancerStudyId>', 'read')\")\n+    @PostMapping(value = \"/alteration-enrichments/fetch\",\n+        consumes = MediaType.APPLICATION_JSON_VALUE,\n+        produces = MediaType.APPLICATION_JSON_VALUE)\n+    @ApiOperation(\"Fetch alteration enrichments in molecular profiles\")\n+    public ResponseEntity<List<AlterationEnrichment>> fetchAlterationEnrichments(\n+        @ApiIgnore // prevent reference to this attribute in the swagger-ui interface\n+        @RequestAttribute(required = false, value = \"involvedCancerStudies\") Collection<String> involvedCancerStudies,\n+        @ApiIgnore\n+        // prevent reference to this attribute in the swagger-ui interface. this attribute is needed for the @PreAuthorize tag above.\n+        @Valid @RequestAttribute(required = false, value = \"interceptedMolecularProfileCasesGroupFilters\") List<MolecularProfileCasesGroupFilter> interceptedMolecularProfileCasesGroupFilters,\n+        @ApiIgnore\n+        @Valid @RequestAttribute(required = false, value = \"alterationEventTypes\") AlterationEventTypeFilter alterationEventTypes,\n+        @ApiParam(\"Type of the enrichment e.g. SAMPLE or PATIENT\")\n+        @RequestParam(defaultValue = \"SAMPLE\") EnrichmentType enrichmentType,\n+        @ApiParam(required = true, value = \"List of groups containing sample identifiers and list of Alteration Types\")\n+        @Valid @RequestBody(required = false) MolecularProfileCasesGroupAndAlterationTypeFilter groupsAndAlterationTypes) throws MolecularProfileNotFoundException {\n+\n+        Map<String, List<MolecularProfileCaseIdentifier>> groupCaseIdentifierSet = interceptedMolecularProfileCasesGroupFilters.stream()\n+            .collect(Collectors.toMap(MolecularProfileCasesGroupFilter::getName,\n+                MolecularProfileCasesGroupFilter::getMolecularProfileCaseIdentifiers));\n+\n+        Stream<MutationEventType> selectedMutations = alterationEventTypes.getMutationEventTypes().entrySet().stream()\n+            .filter(e -> e.getValue())\n+            .map(e -> e.getKey());\n+        Select<MutationEventType> mutationEventTypes = allOptionsSelected(alterationEventTypes.getMutationEventTypes()) ?", "originalCommit": "a551cd2474c778fd2d4884cc3c4445e5646cae73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE3MTEwMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r552171100", "bodyText": "I see .. this argument type is moving down to be used in the persistence layer", "author": "sheridancbio", "createdAt": "2021-01-05T20:18:04Z", "path": "web/src/main/java/org/cbioportal/web/ExpressionEnrichmentController.java", "diffHunk": "@@ -13,7 +13,7 @@\n import org.cbioportal.service.exception.GenericAssayNotFoundException;\n import org.cbioportal.service.exception.MolecularProfileNotFoundException;\n import org.cbioportal.web.config.annotation.InternalApi;\n-import org.cbioportal.web.parameter.EnrichmentType;", "originalCommit": "a551cd2474c778fd2d4884cc3c4445e5646cae73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE4MDc1MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r552180751", "bodyText": "minor optimization: perhaps the list containing AMP and HOMDEL could be constructed once only as a constant static data member\ne.g. private static final List CNA_TYPES_AMP_AND_HOMDEL=\nCollections.unmodifiableList(Arrays.asList(CopyNumberAlterationEventType.AMP, CopyNumberAlterationEventType.HOMDEL))\nThen it could be reused here each call:\nSelect cnaTypes = Select.byValues(CNA_TYPES_AMP_AND_HOMDEL);\nThis saves the (minor) cost of constructing and passing (and garbage collecting) the list each call to the api.", "author": "sheridancbio", "createdAt": "2021-01-05T20:38:43Z", "path": "web/src/main/java/org/cbioportal/web/StudyViewController.java", "diffHunk": "@@ -349,14 +366,25 @@\n         @ApiIgnore // prevent reference to this attribute in the swagger-ui interface. this attribute is needed for the @PreAuthorize tag above.\n         @Valid @RequestAttribute(required = false, value = \"interceptedStudyViewFilter\") StudyViewFilter interceptedStudyViewFilter) throws StudyNotFoundException {\n \n+        // TODO refactor resolution of sampleids to List<MolecularProfileCaseIdentifier> and share between methods\n         List<SampleIdentifier> filteredSampleIdentifiers = studyViewFilterApplier.apply(interceptedStudyViewFilter);\n         List<CopyNumberCountByGene> result = new ArrayList<>();\n         if (!filteredSampleIdentifiers.isEmpty()) {\n             List<String> studyIds = new ArrayList<>();\n             List<String> sampleIds = new ArrayList<>();\n             studyViewFilterUtil.extractStudyAndSampleIds(filteredSampleIdentifiers, studyIds, sampleIds);\n-            result = discreteCopyNumberService.getSampleCountInMultipleMolecularProfiles(molecularProfileService\n-                .getFirstDiscreteCNAProfileIds(studyIds, sampleIds), sampleIds, null, Arrays.asList(-2, 2), true, false);\n+            List<String> profileIdPerSample = molecularProfileService.getFirstDiscreteCNAProfileIds(studyIds, sampleIds);\n+            List<MolecularProfileCaseIdentifier> caseIdentifiers = new ArrayList<>();\n+            for (int i = 0; i < profileIdPerSample.size(); i++) {\n+                caseIdentifiers.add(new MolecularProfileCaseIdentifier(sampleIds.get(i), profileIdPerSample.get(i)));\n+            }\n+            Select<CopyNumberAlterationEventType> cnaTypes = Select.byValues(Arrays.asList(CopyNumberAlterationEventType.AMP, CopyNumberAlterationEventType.HOMDEL));", "originalCommit": "a551cd2474c778fd2d4884cc3c4445e5646cae73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY1NzA4Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555657086", "bodyText": "Done!", "author": "pvannierop", "createdAt": "2021-01-12T10:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE4MDc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIwMjg4Mg==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r552202882", "bodyText": "Are there any lists in this class?", "author": "sheridancbio", "createdAt": "2021-01-05T21:23:10Z", "path": "web/src/main/java/org/cbioportal/web/parameter/AlterationEventTypeFilter.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.cbioportal.web.parameter;\n+\n+import org.cbioportal.model.CopyNumberAlterationEventType;\n+import org.cbioportal.model.MutationEventType;\n+\n+import java.util.List;", "originalCommit": "a551cd2474c778fd2d4884cc3c4445e5646cae73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY1NzY5MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555657690", "bodyText": "No, I removed obsolete imports.", "author": "pvannierop", "createdAt": "2021-01-12T10:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIwMjg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIxOTYxMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r552219610", "bodyText": "The name of this test says \"AllTypes\", but doesn't this mean that we are testing without CNA amplifications and without missense mutations?", "author": "sheridancbio", "createdAt": "2021-01-05T21:48:51Z", "path": "web/src/test/java/org/cbioportal/web/AlterationEnrichmentControllerTest.java", "diffHunk": "@@ -0,0 +1,291 @@\n+package org.cbioportal.web;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.service.AlterationEnrichmentService;\n+import org.cbioportal.web.parameter.AlterationEventTypeFilter;\n+import org.cbioportal.web.parameter.MolecularProfileCasesGroupAndAlterationTypeFilter;\n+import org.cbioportal.web.parameter.MolecularProfileCasesGroupFilter;\n+import org.hamcrest.Matchers;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mockito;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.http.MediaType;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+import org.springframework.test.context.web.WebAppConfiguration;\n+import org.springframework.test.web.servlet.MockMvc;\n+import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;\n+import org.springframework.test.web.servlet.result.MockMvcResultMatchers;\n+import org.springframework.test.web.servlet.setup.MockMvcBuilders;\n+import org.springframework.web.context.WebApplicationContext;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.mockito.ArgumentMatchers.*;\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@WebAppConfiguration\n+@ContextConfiguration(\"/applicationContext-web-test.xml\")\n+@Configuration\n+public class AlterationEnrichmentControllerTest {\n+\n+    private static final int TEST_ENTREZ_GENE_ID_1 = 1;\n+    private static final String TEST_HUGO_GENE_SYMBOL_1 = \"test_hugo_gene_symbol_1\";\n+    private static final String TEST_CYTOBAND_1 = \"test_cytoband_1\";\n+    private static final int TEST_NUMBER_OF_SAMPLES_ALTERED_IN_SET_1 = 1;\n+    private static final int TEST_NUMBER_OF_SAMPLES_UNALTERED_IN_SET_1 = 1;\n+    private static final BigDecimal TEST_P_VALUE_1 = new BigDecimal(1.1);\n+    private static final int TEST_ENTREZ_GENE_ID_2 = 2;\n+    private static final String TEST_HUGO_GENE_SYMBOL_2 = \"test_hugo_gene_symbol_2\";\n+    private static final String TEST_CYTOBAND_2 = \"test_cytoband_2\";\n+    private static final int TEST_NUMBER_OF_SAMPLES_ALTERED_IN_SET_2 = 2;\n+    private static final int TEST_NUMBER_OF_SAMPLES_UNALTERED_IN_SET_2 = 2;\n+    private static final BigDecimal TEST_P_VALUE_2 = new BigDecimal(2.1);\n+    private static final int TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_1 = 1;\n+    private static final int TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_2 = 1;\n+\n+    @Autowired\n+    private WebApplicationContext wac;\n+\n+    @Autowired\n+    private AlterationEnrichmentService alterationEnrichmentService;\n+\n+    private ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private MockMvc mockMvc;\n+    private ArrayList<AlterationEnrichment> alterationEnrichments;\n+    private AlterationEventTypeFilter eventTypes;\n+\n+    @Bean\n+    public AlterationEnrichmentService alterationEnrichmentService() {\n+        return Mockito.mock(AlterationEnrichmentService.class);\n+    }\n+\n+    private MolecularProfileCasesGroupAndAlterationTypeFilter filter;\n+        \n+    @Before\n+    public void setUp() throws Exception {\n+        Mockito.reset(alterationEnrichmentService);\n+\n+        alterationEnrichments = new ArrayList<>();\n+        AlterationEnrichment alterationEnrichment1 = new AlterationEnrichment();\n+        CountSummary alterationEnrichment1Set1Count = new CountSummary();\n+        CountSummary alterationEnrichment1Set2Count = new CountSummary();\n+        alterationEnrichment1.setEntrezGeneId(TEST_ENTREZ_GENE_ID_1);\n+        alterationEnrichment1.setHugoGeneSymbol(TEST_HUGO_GENE_SYMBOL_1);\n+        alterationEnrichment1.setCytoband(TEST_CYTOBAND_1);\n+        alterationEnrichment1.setpValue(TEST_P_VALUE_1);\n+        alterationEnrichment1Set1Count.setAlteredCount(TEST_NUMBER_OF_SAMPLES_ALTERED_IN_SET_1);\n+        alterationEnrichment1Set1Count.setProfiledCount(TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_1);\n+        alterationEnrichment1Set2Count.setAlteredCount(TEST_NUMBER_OF_SAMPLES_UNALTERED_IN_SET_1);\n+        alterationEnrichment1Set2Count.setProfiledCount(TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_2);\n+        alterationEnrichment1.setCounts(Arrays.asList(alterationEnrichment1Set1Count,alterationEnrichment1Set2Count));\n+        alterationEnrichments.add(alterationEnrichment1);\n+\n+        AlterationEnrichment alterationEnrichment2 = new AlterationEnrichment();\n+        CountSummary alterationEnrichment2Set1Count = new CountSummary();\n+        CountSummary alterationEnrichment2Set2Count = new CountSummary();\n+        alterationEnrichment2.setEntrezGeneId(TEST_ENTREZ_GENE_ID_2);\n+        alterationEnrichment2.setHugoGeneSymbol(TEST_HUGO_GENE_SYMBOL_2);\n+        alterationEnrichment2.setCytoband(TEST_CYTOBAND_2);\n+        alterationEnrichment2.setpValue(TEST_P_VALUE_2);\n+        alterationEnrichment2Set1Count.setAlteredCount(TEST_NUMBER_OF_SAMPLES_ALTERED_IN_SET_2);\n+        alterationEnrichment2Set1Count.setProfiledCount(TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_1);\n+        alterationEnrichment2Set2Count.setAlteredCount(TEST_NUMBER_OF_SAMPLES_UNALTERED_IN_SET_2);\n+        alterationEnrichment2Set2Count.setProfiledCount(TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_2);\n+        alterationEnrichment2.setCounts(Arrays.asList(alterationEnrichment2Set1Count,alterationEnrichment2Set2Count));\n+        alterationEnrichments.add(alterationEnrichment2);\n+\n+        MolecularProfileCaseIdentifier entity1 = new MolecularProfileCaseIdentifier();\n+        entity1.setCaseId(\"test_sample_id_1\");\n+        entity1.setMolecularProfileId(\"test_1_mutations\");\n+        MolecularProfileCaseIdentifier entity2 = new MolecularProfileCaseIdentifier();\n+        entity2.setCaseId(\"test_sample_id_2\");\n+        entity2.setMolecularProfileId(\"test_2_mutations\");\n+\n+        MolecularProfileCasesGroupFilter casesGroup1 = new MolecularProfileCasesGroupFilter();\n+        casesGroup1.setName(\"altered group\");\n+        casesGroup1.setMolecularProfileCaseIdentifiers(Arrays.asList(entity1));\n+\n+        MolecularProfileCasesGroupFilter casesGroup2 = new MolecularProfileCasesGroupFilter();\n+        casesGroup2.setName(\"unaltered group\");\n+        casesGroup2.setMolecularProfileCaseIdentifiers(Arrays.asList(entity2));\n+\n+        filter = new MolecularProfileCasesGroupAndAlterationTypeFilter();\n+        filter.setMolecularProfileCasesGroupFilter(Arrays.asList(casesGroup1,casesGroup2));\n+\n+        eventTypes = new AlterationEventTypeFilter();\n+        Map<MutationEventType, Boolean> mutationEventTypeMap = new HashMap();\n+        mutationEventTypeMap.put(MutationEventType.missense_mutation, true);\n+        Map<CopyNumberAlterationEventType, Boolean> cnaEventTypeMap = new HashMap();\n+        cnaEventTypeMap.put(CopyNumberAlterationEventType.AMP, true);\n+        eventTypes.setMutationEventTypes(mutationEventTypeMap);\n+        eventTypes.setCopyNumberAlterationEventTypes(cnaEventTypeMap);\n+        filter.setAlterationEventTypes(eventTypes);\n+        \n+        mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();\n+        \n+    }\n+\n+    @Test\n+    public void fetchAlterationEnrichments() throws Exception {\n+\n+        when(alterationEnrichmentService.getAlterationEnrichments(\n+            anyMap(),\n+            any(Select.class),\n+            any(Select.class),\n+            any()))\n+            .thenReturn(alterationEnrichments);\n+        \n+        mockMvc.perform(MockMvcRequestBuilders.post(\n+            \"/alteration-enrichments/fetch\")\n+            .accept(MediaType.APPLICATION_JSON)\n+            .contentType(MediaType.APPLICATION_JSON)\n+            .content(objectMapper.writeValueAsString(filter)))\n+            .andExpect(MockMvcResultMatchers.status().isOk())\n+            .andExpect(MockMvcResultMatchers.content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$\", Matchers.hasSize(2)))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[0].entrezGeneId\").value(TEST_ENTREZ_GENE_ID_1))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[0].hugoGeneSymbol\").value(TEST_HUGO_GENE_SYMBOL_1))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[0].cytoband\").value(TEST_CYTOBAND_1))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[0].counts[0].alteredCount\").value(TEST_NUMBER_OF_SAMPLES_ALTERED_IN_SET_1))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[0].counts[1].alteredCount\").value(TEST_NUMBER_OF_SAMPLES_UNALTERED_IN_SET_1))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[0].pValue\").value(TEST_P_VALUE_1))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[0].counts[0].profiledCount\").value(TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_1))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[0].counts[1].profiledCount\").value(TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_2))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[1].entrezGeneId\").value(TEST_ENTREZ_GENE_ID_2))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[1].hugoGeneSymbol\").value(TEST_HUGO_GENE_SYMBOL_2))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[1].cytoband\").value(TEST_CYTOBAND_2))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[1].counts[0].alteredCount\").value(TEST_NUMBER_OF_SAMPLES_ALTERED_IN_SET_2))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[1].counts[1].alteredCount\").value(TEST_NUMBER_OF_SAMPLES_UNALTERED_IN_SET_2))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[1].pValue\").value(TEST_P_VALUE_2))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[1].counts[0].profiledCount\").value(TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_1))\n+            .andExpect(MockMvcResultMatchers.jsonPath(\"$[1].counts[1].profiledCount\").value(TEST_NUMBER_OF_SAMPLES_PROFILED_IN_SET_2));\n+    }\n+\n+    @Test\n+    public void fetchAlterationEnrichmentsAllTypes() throws Exception {\n+\n+        when(alterationEnrichmentService.getAlterationEnrichments(\n+            anyMap(),\n+            any(Select.class),\n+            any(Select.class),\n+            any()))\n+            .thenReturn(alterationEnrichments);\n+        \n+        filter.getAlterationEventTypes().getMutationEventTypes().put(MutationEventType.missense_mutation, false);\n+        filter.getAlterationEventTypes().getCopyNumberAlterationEventTypes().put(CopyNumberAlterationEventType.AMP, false);", "originalCommit": "a551cd2474c778fd2d4884cc3c4445e5646cae73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY4OTg3Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555689877", "bodyText": "Ah man, these tests made no sense after I refactored the code long ago. I have updated the test logic so that it tests the passing of the alteration types and the correct for mation of the caseId structure. Can you please re-review this test file?\nAnd to answer your question: indeed the name was incorrect. The new test names and implementations now correctly match up.", "author": "pvannierop", "createdAt": "2021-01-12T11:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIxOTYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ4NzU5Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560487596", "bodyText": "Ok, looks good. I see the test which filters out missense mutations and HOMDEL alterations (partial filters). \ud83d\udc4d", "author": "sheridancbio", "createdAt": "2021-01-19T20:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIxOTYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjY0NDE2OQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r552644169", "bodyText": "I think we adopted the google java style guidelines, which forbid wildcards with import statements.\n(https://google.github.io/styleguide/javaguide.html#s3.3-import-statements)\nThat's overly restricted .. and I think use of them with built in packages, such as import java.util.* is fine ... but maybe for our own defined classes (which sometimes do have naming clashes across packages) we should be more explicit, showing the individual classes imported. It also can be helpful in terms of documentation ... to see what is connected to the current class. I think there was a similar collapse of web.parameter.* up higher in the code. I think I would prefer if we keep these details for our own packages (even if it is verbose)", "author": "sheridancbio", "createdAt": "2021-01-06T14:07:56Z", "path": "web/src/test/java/org/cbioportal/web/StudyViewControllerTest.java", "diffHunk": "@@ -5,24 +5,10 @@\n import java.util.Collections;\n import java.util.List;\n \n-import org.cbioportal.model.ClinicalAttribute;\n-import org.cbioportal.model.ClinicalData;\n-import org.cbioportal.model.ClinicalDataCount;\n-import org.cbioportal.model.ClinicalDataCountItem;\n-import org.cbioportal.model.CopyNumberCountByGene;\n-import org.cbioportal.model.GenePanelData;\n-import org.cbioportal.model.MolecularProfile;\n-import org.cbioportal.model.MutationCountByGene;\n-import org.cbioportal.model.Sample;\n-import org.cbioportal.service.ClinicalAttributeService;\n-import org.cbioportal.service.ClinicalDataService;\n-import org.cbioportal.service.DiscreteCopyNumberService;\n-import org.cbioportal.service.GenePanelService;\n-import org.cbioportal.service.MolecularProfileService;\n-import org.cbioportal.service.MutationService;\n-import org.cbioportal.service.PatientService;\n-import org.cbioportal.service.SampleService;\n-import org.cbioportal.service.TreatmentService;\n+import org.cbioportal.model.*;", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY5NTIzMQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555695231", "bodyText": "Ah ok, this just happens when I automatically organize imports with IntelliJ. I have removed all wildcards from imports.", "author": "pvannierop", "createdAt": "2021-01-12T11:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjY0NDE2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUwNDMzNA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560504334", "bodyText": "\ud83d\udc4d", "author": "sheridancbio", "createdAt": "2021-01-19T21:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjY0NDE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc1NTQwMg==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r553755402", "bodyText": "rather than accepting any Integer, the event types are now constrained to CopyNumberAlterationEventType, and enrichmentType went from arbitrary string to an enum as well.", "author": "sheridancbio", "createdAt": "2021-01-08T05:52:07Z", "path": "service/src/main/java/org/cbioportal/service/CopyNumberEnrichmentService.java", "diffHunk": "@@ -1,16 +1,14 @@\n package org.cbioportal.service;\n \n-import org.cbioportal.model.AlterationEnrichment;\n+import org.cbioportal.model.*;\n import org.cbioportal.service.exception.MolecularProfileNotFoundException;\n \n import java.util.List;\n import java.util.Map;\n \n-import org.cbioportal.model.MolecularProfileCaseIdentifier;\n-\n public interface CopyNumberEnrichmentService {\n \n-    List<AlterationEnrichment> getCopyNumberEnrichments(\n-            Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets, List<Integer> alterationTypes,\n-            String enrichmentType) throws MolecularProfileNotFoundException;\n+    List<AlterationEnrichment> getCopyNumberEnrichments(Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n+                                                        CopyNumberAlterationEventType copyNumberEventType,", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY5OTU2NQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555699565", "bodyText": "But that is a good thing, or not?", "author": "pvannierop", "createdAt": "2021-01-12T11:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc1NTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ5MDM1NA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560490354", "bodyText": "Yes, this is an improvement. \ud83d\udc4d\n[Some of my comments in PR reviews are only there to document my understanding of the changes while doing the review or going over it again later]", "author": "sheridancbio", "createdAt": "2021-01-19T20:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc1NTQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc2MzI2MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r553763260", "bodyText": "EnrichmentType now chosen from enum", "author": "sheridancbio", "createdAt": "2021-01-08T06:21:42Z", "path": "service/src/main/java/org/cbioportal/service/MutationEnrichmentService.java", "diffHunk": "@@ -1,15 +1,17 @@\n package org.cbioportal.service;\n \n-import java.util.List;\n-import java.util.Map;\n-\n import org.cbioportal.model.AlterationEnrichment;\n+import org.cbioportal.model.EnrichmentType;\n import org.cbioportal.model.MolecularProfileCaseIdentifier;\n import org.cbioportal.service.exception.MolecularProfileNotFoundException;\n \n+import java.util.List;\n+import java.util.Map;\n+\n public interface MutationEnrichmentService {\n \n     List<AlterationEnrichment> getMutationEnrichments(\n-            Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets, String enrichmentType)\n-            throws MolecularProfileNotFoundException;\n+        Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n+        EnrichmentType enrichmentType)", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY5OTc1MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555699751", "bodyText": "Again, but that is a good thing, isn't it?", "author": "pvannierop", "createdAt": "2021-01-12T11:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc2MzI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ5MDU1MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560490550", "bodyText": "\ud83d\udc4d", "author": "sheridancbio", "createdAt": "2021-01-19T20:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc2MzI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkzNTgxOQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r553935819", "bodyText": "replace tab character with 4 space indent", "author": "sheridancbio", "createdAt": "2021-01-08T13:13:28Z", "path": "service/src/main/java/org/cbioportal/service/impl/AlterationCountServiceImpl.java", "diffHunk": "@@ -0,0 +1,220 @@\n+package org.cbioportal.service.impl;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.persistence.AlterationRepository;\n+import org.cbioportal.service.AlterationCountService;\n+import org.cbioportal.service.util.AlterationEnrichmentUtil;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Service\n+public class AlterationCountServiceImpl implements AlterationCountService {\n+\n+    @Autowired\n+    private AlterationRepository alterationRepository;\n+    @Autowired\n+    private AlterationEnrichmentUtil<AlterationCountByGene> alterationEnrichmentUtil;\n+    @Autowired\n+    private AlterationEnrichmentUtil<CopyNumberCountByGene> alterationEnrichmentUtilCna;\n+\n+    @Override\n+\tpublic List<AlterationCountByGene> getSampleAlterationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwMDY4MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555700681", "bodyText": "Done!", "author": "pvannierop", "createdAt": "2021-01-12T11:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkzNTgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0Mzg3MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r553943871", "bodyText": "If we were willing to add a {PATIENT/SAMPLE} argument to these functions (and pass it to the persistence layer calls to the repositories and alterationEnrichmentUtils), we could reduce the 8 functions present here to 4. But in this case  maybe the logic duplication is ok because there is not much here other than the two function calls to the lower level anyway, and there are already a large number of arguments.", "author": "sheridancbio", "createdAt": "2021-01-08T13:30:01Z", "path": "service/src/main/java/org/cbioportal/service/impl/AlterationCountServiceImpl.java", "diffHunk": "@@ -0,0 +1,220 @@\n+package org.cbioportal.service.impl;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.persistence.AlterationRepository;\n+import org.cbioportal.service.AlterationCountService;\n+import org.cbioportal.service.util.AlterationEnrichmentUtil;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Service\n+public class AlterationCountServiceImpl implements AlterationCountService {\n+\n+    @Autowired\n+    private AlterationRepository alterationRepository;\n+    @Autowired\n+    private AlterationEnrichmentUtil<AlterationCountByGene> alterationEnrichmentUtil;\n+    @Autowired\n+    private AlterationEnrichmentUtil<CopyNumberCountByGene> alterationEnrichmentUtilCna;\n+\n+    @Override\n+\tpublic List<AlterationCountByGene> getSampleAlterationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                                 List<Integer> entrezGeneIds,\n+                                                                 boolean includeFrequency,\n+                                                                 boolean includeMissingAlterationsFromGenePanel,\n+                                                                 Select<MutationEventType> mutationEventTypes,\n+                                                                 Select<CopyNumberAlterationEventType> cnaEventTypes,\n+                                                                 QueryElement searchFusions) {\n+        \n+        List<AlterationCountByGene> alterationCountByGenes;\n+        if (molecularProfileCaseIdentifiers.isEmpty()) {\n+            alterationCountByGenes = Collections.emptyList();\n+        } else {\n+            alterationCountByGenes = alterationRepository.getSampleAlterationCounts(\n+                molecularProfileCaseIdentifiers,\n+                entrezGeneIds,\n+                mutationEventTypes,\n+                cnaEventTypes,\n+                searchFusions);\n+            if (includeFrequency) {\n+                alterationEnrichmentUtil.includeFrequencyForSamples(molecularProfileCaseIdentifiers,\n+                    alterationCountByGenes,\n+                    includeMissingAlterationsFromGenePanel);\n+            }\n+        }\n+\n+        return alterationCountByGenes;\n+    }\n+    \n+    @Override\n+    public List<AlterationCountByGene> getPatientAlterationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                                  List<Integer> entrezGeneIds,\n+                                                                  boolean includeFrequency,\n+                                                                  boolean includeMissingAlterationsFromGenePanel,\n+                                                                  Select<MutationEventType> mutationEventTypes,\n+                                                                  Select<CopyNumberAlterationEventType> cnaEventTypes,\n+                                                                  QueryElement searchFusions) {\n+        \n+        List<AlterationCountByGene> alterationCountByGenes;\n+        if (molecularProfileCaseIdentifiers.isEmpty()) {\n+            alterationCountByGenes = Collections.emptyList();\n+        } else {\n+            alterationCountByGenes = alterationRepository.getPatientAlterationCounts(\n+                molecularProfileCaseIdentifiers,\n+                entrezGeneIds,\n+                mutationEventTypes,\n+                cnaEventTypes,\n+                searchFusions);\n+            if (includeFrequency) {\n+                alterationEnrichmentUtil.includeFrequencyForPatients(molecularProfileCaseIdentifiers, alterationCountByGenes, includeMissingAlterationsFromGenePanel);\n+            }\n+        }\n+\n+        return alterationCountByGenes;\n+    }\n+\n+    @Override\n+    public List<AlterationCountByGene> getSampleMutationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                               List<Integer> entrezGeneIds,\n+                                                               boolean includeFrequency,\n+                                                               boolean includeMissingAlterationsFromGenePanel,\n+                                                               Select<MutationEventType> mutationEventTypes) {\n+        return getSampleAlterationCounts(molecularProfileCaseIdentifiers,\n+            entrezGeneIds,\n+            includeFrequency,\n+            includeMissingAlterationsFromGenePanel,\n+            mutationEventTypes,\n+            Select.none(),\n+            QueryElement.INACTIVE\n+        );\n+    }\n+\n+    @Override\n+    public List<AlterationCountByGene> getPatientMutationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                                List<Integer> entrezGeneIds,\n+                                                                boolean includeFrequency,\n+                                                                boolean includeMissingAlterationsFromGenePanel,\n+                                                                Select<MutationEventType> mutationEventTypes) {\n+        return getPatientAlterationCounts(molecularProfileCaseIdentifiers,\n+            entrezGeneIds,\n+            includeFrequency,\n+            includeMissingAlterationsFromGenePanel,\n+            mutationEventTypes,\n+            Select.none(),\n+            QueryElement.INACTIVE\n+        );\n+    }\n+\n+    @Override\n+    public List<AlterationCountByGene> getSampleFusionCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                             List<Integer> entrezGeneIds,\n+                                                             boolean includeFrequency,\n+                                                             boolean includeMissingAlterationsFromGenePanel,\n+                                                             Select<MutationEventType> mutationEventTypes) {\n+        return getSampleAlterationCounts(molecularProfileCaseIdentifiers,\n+            entrezGeneIds,\n+            includeFrequency,\n+            includeMissingAlterationsFromGenePanel,\n+            mutationEventTypes,\n+            Select.none(),\n+            QueryElement.ACTIVE\n+        );\n+    }\n+\n+    @Override\n+    public List<AlterationCountByGene> getPatientFusionCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                              List<Integer> entrezGeneIds,\n+                                                              boolean includeFrequency,\n+                                                              boolean includeMissingAlterationsFromGenePanel,\n+                                                              Select<MutationEventType> mutationEventTypes) {\n+        return getPatientAlterationCounts(molecularProfileCaseIdentifiers,\n+            entrezGeneIds,\n+            includeFrequency,\n+            includeMissingAlterationsFromGenePanel,\n+            mutationEventTypes,\n+            Select.none(),\n+            QueryElement.ACTIVE\n+            );    \n+        }\n+            \n+// -- Should be reinstated when the legacy CNA count endpoint retires            \n+//    @Override\n+//    public List<AlterationCountByGene> getSampleCnaCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+//                                                          List<Integer> entrezGeneIds,\n+//                                                          boolean includeFrequency,\n+//                                                          boolean includeMissingAlterationsFromGenePanel,\n+//                                                          List<CopyNumberAlterationEventType> cnaEventTypes) {\n+//        return getSampleAlterationCounts(molecularProfileCaseIdentifiers,\n+//            entrezGeneIds,\n+//            includeFrequency,\n+//            includeMissingAlterationsFromGenePanel,\n+//            new ArrayList<>(),\n+//            cnaEventTypes,\n+//            false);\n+//    }\n+//\n+//    @Override\n+//    public List<AlterationCountByGene> getPatientCnaCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+//                                                           List<Integer> entrezGeneIds,\n+//                                                           boolean includeFrequency,\n+//                                                           boolean includeMissingAlterationsFromGenePanel,\n+//                                                           List<CopyNumberAlterationEventType> cnaEventTypes) {\n+//        return getPatientAlterationCounts(molecularProfileCaseIdentifiers,\n+//            entrezGeneIds,\n+//            includeFrequency,\n+//            includeMissingAlterationsFromGenePanel,\n+//            new ArrayList<>(),\n+//            cnaEventTypes,\n+//            false);\n+//    }\n+    \n+    @Override\n+    public List<CopyNumberCountByGene> getSampleCnaCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                          List<Integer> entrezGeneIds,\n+                                                          boolean includeFrequency,\n+                                                          boolean includeMissingAlterationsFromGenePanel,\n+                                                          Select<CopyNumberAlterationEventType> cnaEventTypes) {\n+        List<CopyNumberCountByGene> alterationCountByGenes;\n+        if (molecularProfileCaseIdentifiers.isEmpty()) {\n+            alterationCountByGenes = Collections.emptyList();\n+        } else {\n+            alterationCountByGenes = alterationRepository.getSampleCnaCounts(\n+                molecularProfileCaseIdentifiers,\n+                entrezGeneIds,\n+                cnaEventTypes);\n+            if (includeFrequency) {\n+                alterationEnrichmentUtilCna.includeFrequencyForSamples(molecularProfileCaseIdentifiers, alterationCountByGenes, includeMissingAlterationsFromGenePanel);\n+            }\n+        }\n+\n+        return alterationCountByGenes;\n+    }\n+\n+    @Override\n+    public List<CopyNumberCountByGene> getPatientCnaCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwMTM3OA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555701378", "bodyText": "Yes, but what I did here was follow the pattern in the existing code. I propose to leave this for this PR as is and discuss further refactoring for a later time.", "author": "pvannierop", "createdAt": "2021-01-12T11:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0Mzg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ5MTE1Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560491157", "bodyText": "sounds good", "author": "sheridancbio", "createdAt": "2021-01-19T20:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0Mzg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk2NTA2NQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r553965065", "bodyText": "this is an iteration over samples at the service layer so the results are not cached (only the retrievals of individual samples will be cached.) There is potentially a performance issue here on studies / virtual cohorts with large sample counts. Have the involved endpoints been tested on studies with ~100000 samples?", "author": "sheridancbio", "createdAt": "2021-01-08T14:11:38Z", "path": "service/src/main/java/org/cbioportal/service/impl/AlterationEnrichmentServiceImpl.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.cbioportal.service.impl;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.service.AlterationEnrichmentService;\n+import org.cbioportal.service.AlterationCountService;\n+import org.cbioportal.service.util.AlterationEnrichmentUtil;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+@Service\n+public class AlterationEnrichmentServiceImpl implements AlterationEnrichmentService {\n+\n+    @Autowired\n+    private AlterationCountService alterationCountService;\n+    @Autowired\n+    private AlterationEnrichmentUtil<AlterationCountByGene> alterationEnrichmentUtil;\n+\n+    @Override\n+    public List<AlterationEnrichment> getAlterationEnrichments(\n+        Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets, final Select<MutationEventType> mutationEventTypes,\n+        final Select<CopyNumberAlterationEventType> cnaEventTypes, EnrichmentType enrichmentType) {\n+\n+        Map<String, List<AlterationCountByGene>> alterationCountsbyEntrezGeneIdAndGroup = getAlterationCountsbyEntrezGeneIdAndGroup(\n+            molecularProfileCaseSets, mutationEventTypes, cnaEventTypes, enrichmentType);\n+\n+        return alterationEnrichmentUtil.createAlterationEnrichments(alterationCountsbyEntrezGeneIdAndGroup,\n+                molecularProfileCaseSets);\n+    }\n+\n+    public Map<String, List<AlterationCountByGene>> getAlterationCountsbyEntrezGeneIdAndGroup(\n+        Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n+        Select<MutationEventType> mutationEventTypes,\n+        Select<CopyNumberAlterationEventType> cnaEventTypes,\n+        EnrichmentType enrichmentType) {\n+        return molecularProfileCaseSets\n+            .entrySet()\n+            .stream()", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwMjg2NQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555702865", "bodyText": "I have copied this logic from the existing code such as f.i. in MutationEnrichmentServiceImpl.java. I also propose to leave this discussion out of the context of this PR.", "author": "pvannierop", "createdAt": "2021-01-12T11:29:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk2NTA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ5Mjg3Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560492876", "bodyText": "yes, if this was the previous business logic [or based on it] it should not be refactored in this PR. We will be doing a survey of performance bottlenecks in the backend soon ... it will be better to test and improve this pattern at that time if we need to.", "author": "sheridancbio", "createdAt": "2021-01-19T21:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk2NTA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA0ODc2Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r554048766", "bodyText": "this service layer iteration was already present previously - so long as the computational complexity of alterationCountService is equivalent or better than that of discreteCopyNumberService, we should be ok.\nThe performance test github action is only testing the study view endpoints ... if this endpoint is not included there, we should soon expand the performance test github action workflow to include related endpoints.", "author": "sheridancbio", "createdAt": "2021-01-08T16:27:32Z", "path": "service/src/main/java/org/cbioportal/service/impl/CopyNumberEnrichmentServiceImpl.java", "diffHunk": "@@ -1,73 +1,80 @@\n package org.cbioportal.service.impl;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.stream.Collectors;\n-\n-import org.cbioportal.model.AlterationEnrichment;\n-import org.cbioportal.model.CopyNumberCountByGene;\n-import org.cbioportal.model.MolecularProfileCaseIdentifier;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.service.AlterationCountService;\n import org.cbioportal.service.CopyNumberEnrichmentService;\n-import org.cbioportal.service.DiscreteCopyNumberService;\n import org.cbioportal.service.exception.MolecularProfileNotFoundException;\n import org.cbioportal.service.util.AlterationEnrichmentUtil;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n @Service\n public class CopyNumberEnrichmentServiceImpl implements CopyNumberEnrichmentService {\n \n     @Autowired\n-    private DiscreteCopyNumberService discreteCopyNumberService;\n+    private AlterationCountService alterationCountService;\n     @Autowired\n     private AlterationEnrichmentUtil<CopyNumberCountByGene> alterationEnrichmentUtil;\n \n     @Override\n     public List<AlterationEnrichment> getCopyNumberEnrichments(\n-            Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n-            List<Integer> alterationTypes,\n-            String enrichmentType) throws MolecularProfileNotFoundException {\n+        Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n+        CopyNumberAlterationEventType copyNumberEventType,\n+        EnrichmentType enrichmentType) throws MolecularProfileNotFoundException {\n \n-        Map<String, List<CopyNumberCountByGene>> copyNumberCountByGeneAndGroup =\n-                molecularProfileCaseSets\n-                .entrySet()\n-                .stream()\n-                .collect(Collectors.toMap(\n-                        entry -> entry.getKey(),\n-                        entry -> { //set value of each group to list of CopyNumberCountByGene\n-                            \n-                            List<String> molecularProfileIds = new ArrayList<>();\n-                            List<String> sampleIds = new ArrayList<>();\n-    \n-                            entry.getValue().forEach(molecularProfileCase -> {\n-                                molecularProfileIds.add(molecularProfileCase.getMolecularProfileId());\n-                                sampleIds.add(molecularProfileCase.getCaseId());\n-                            });\n-                            \n-                            if (enrichmentType.equals(\"SAMPLE\")) {\n-                                return discreteCopyNumberService\n-                                        .getSampleCountInMultipleMolecularProfiles(molecularProfileIds,\n-                                                sampleIds,\n-                                                null,\n-                                                alterationTypes,\n-                                                true,\n-                                                true);\n-                            } else {\n-                                return discreteCopyNumberService\n-                                        .getPatientCountInMultipleMolecularProfiles(molecularProfileIds,\n-                                                sampleIds,\n-                                                null,\n-                                                alterationTypes,\n-                                                true, \n-                                                true);\n-                            }\n-                        }));\n+        Map<String, List<CopyNumberCountByGene>> copyNumberCountByGeneAndGroup = getCopyNumberCountByGeneAndGroup(\n+            molecularProfileCaseSets,\n+            copyNumberEventType,\n+            enrichmentType);\n \n         return alterationEnrichmentUtil\n-                .createAlterationEnrichments(\n-                        copyNumberCountByGeneAndGroup,\n-                        molecularProfileCaseSets,\n-                        enrichmentType);\n+            .createAlterationEnrichments(\n+                copyNumberCountByGeneAndGroup,\n+                molecularProfileCaseSets);\n+    }\n+\n+    public Map<String, List<CopyNumberCountByGene>> getCopyNumberCountByGeneAndGroup(\n+        Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n+        CopyNumberAlterationEventType copyNumberEventType,\n+        EnrichmentType enrichmentType) {\n+        return molecularProfileCaseSets", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwMzYxNw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555703617", "bodyText": "Ah indeed, see my answer above.", "author": "pvannierop", "createdAt": "2021-01-12T11:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA0ODc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA1NDk5Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r554054997", "bodyText": "here is a place where I think it is perfectly ok to be using the wildcard import form \ud83d\ude03", "author": "sheridancbio", "createdAt": "2021-01-08T16:38:30Z", "path": "service/src/main/java/org/cbioportal/service/impl/DiscreteCopyNumberServiceImpl.java", "diffHunk": "@@ -3,13 +3,16 @@\n import org.cbioportal.model.*;\n import org.cbioportal.model.meta.BaseMeta;\n import org.cbioportal.persistence.DiscreteCopyNumberRepository;\n-import org.cbioportal.service.*;\n+import org.cbioportal.service.DiscreteCopyNumberService;\n+import org.cbioportal.service.MolecularDataService;\n+import org.cbioportal.service.MolecularProfileService;\n import org.cbioportal.service.exception.MolecularProfileNotFoundException;\n-import org.cbioportal.service.util.AlterationEnrichmentUtil;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n-import java.util.*;\n+import java.util.ArrayList;", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwMzc1OA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555703758", "bodyText": "I removed all wildcard imports.", "author": "pvannierop", "createdAt": "2021-01-12T11:31:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA1NDk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ5NTk3OQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560495979", "bodyText": "Ok, thank you. Maybe this is is a topic which is not worth making an issue over, but I appreciate consistent style ... and this also helps us know which package or library is being used for unfamiliar classes (for those of us not using an IDE to link out automatically to source code)", "author": "sheridancbio", "createdAt": "2021-01-19T21:07:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA1NDk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA1Njc2OA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r554056768", "bodyText": "here too (import java.util.* would be fine)\nThe collapsing of our model class imports into a wildcard is something I feel loses some documentation power and could (for very general class names) lead to namespace ambiguities. For example, the \"Select\" class should probably never be imported via wildcard (I think I suggested moving it into the model class perhaps?)", "author": "sheridancbio", "createdAt": "2021-01-08T16:41:44Z", "path": "service/src/main/java/org/cbioportal/service/impl/MutationEnrichmentServiceImpl.java", "diffHunk": "@@ -1,67 +1,71 @@\n package org.cbioportal.service.impl;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.stream.Collectors;\n-\n-import org.cbioportal.model.AlterationEnrichment;\n-import org.cbioportal.model.MolecularProfileCaseIdentifier;\n-import org.cbioportal.model.MutationCountByGene;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.service.AlterationCountService;\n import org.cbioportal.service.MutationEnrichmentService;\n-import org.cbioportal.service.MutationService;\n-import org.cbioportal.service.exception.MolecularProfileNotFoundException;\n import org.cbioportal.service.util.AlterationEnrichmentUtil;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n+import java.util.ArrayList;", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwMzg3NA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555703874", "bodyText": "I removed all wildcard imports.", "author": "pvannierop", "createdAt": "2021-01-12T11:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA1Njc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQ5NjM3NQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560496375", "bodyText": "\ud83d\udc4d", "author": "sheridancbio", "createdAt": "2021-01-19T21:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA1Njc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA2MzU1Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r554063557", "bodyText": "similar to earlier comment -- this is a pre-existing iteration through sample data in the service layer", "author": "sheridancbio", "createdAt": "2021-01-08T16:50:24Z", "path": "service/src/main/java/org/cbioportal/service/impl/MutationEnrichmentServiceImpl.java", "diffHunk": "@@ -1,67 +1,71 @@\n package org.cbioportal.service.impl;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.stream.Collectors;\n-\n-import org.cbioportal.model.AlterationEnrichment;\n-import org.cbioportal.model.MolecularProfileCaseIdentifier;\n-import org.cbioportal.model.MutationCountByGene;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.service.AlterationCountService;\n import org.cbioportal.service.MutationEnrichmentService;\n-import org.cbioportal.service.MutationService;\n-import org.cbioportal.service.exception.MolecularProfileNotFoundException;\n import org.cbioportal.service.util.AlterationEnrichmentUtil;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n @Service\n public class MutationEnrichmentServiceImpl implements MutationEnrichmentService {\n \n     @Autowired\n-    private MutationService mutationService;\n+    private AlterationCountService alterationCountService;\n     @Autowired\n-    private AlterationEnrichmentUtil<MutationCountByGene> alterationEnrichmentUtil;\n+    private AlterationEnrichmentUtil<AlterationCountByGene> alterationEnrichmentUtil;\n \n     @Override\n     public List<AlterationEnrichment> getMutationEnrichments(\n-            Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n-            String enrichmentType)\n-            throws MolecularProfileNotFoundException {\n+        Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n+        EnrichmentType enrichmentType) {\n \n-        Map<String, List<MutationCountByGene>> mutationCountsbyEntrezGeneIdAndGroup =\n-                molecularProfileCaseSets\n-                .entrySet()\n-                .stream()\n-                .collect(Collectors.toMap(\n-                        entry -> entry.getKey(),\n-                        entry -> { //set value of each group to list of MutationCountByGene\n-                            List<String> molecularProfileIds = new ArrayList<>();\n-                            List<String> sampleIds = new ArrayList<>();\n-    \n-                            entry.getValue().forEach(molecularProfileCase -> {\n-                                molecularProfileIds.add(molecularProfileCase.getMolecularProfileId());\n-                                sampleIds.add(molecularProfileCase.getCaseId());\n-                            });\n-    \n-                            if (enrichmentType.equals(\"SAMPLE\")) {\n-                                return mutationService\n-                                        .getSampleCountInMultipleMolecularProfiles(molecularProfileIds,\n-                                                sampleIds,\n-                                                null,\n-                                                true,\n-                                                true);\n-                            } else {\n-                                return mutationService\n-                                        .getPatientCountInMultipleMolecularProfiles(molecularProfileIds,\n-                                                sampleIds,\n-                                                null,\n-                                                true,\n-                                                true);\n-                            }\n-                        }));\n+        Map<String, List<AlterationCountByGene>> mutationCountsbyEntrezGeneIdAndGroup = getMutationCountsbyEntrezGeneIdAndGroup(\n+            molecularProfileCaseSets, enrichmentType);\n \n         return alterationEnrichmentUtil.createAlterationEnrichments(mutationCountsbyEntrezGeneIdAndGroup,\n-                molecularProfileCaseSets, enrichmentType);\n+            molecularProfileCaseSets);\n+    }\n+\n+    public Map<String, List<AlterationCountByGene>> getMutationCountsbyEntrezGeneIdAndGroup(\n+        Map<String, List<MolecularProfileCaseIdentifier>> molecularProfileCaseSets,\n+        EnrichmentType enrichmentType) {\n+        return molecularProfileCaseSets", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwNDA5MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555704090", "bodyText": "Indeed.", "author": "pvannierop", "createdAt": "2021-01-12T11:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA2MzU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA3MDM4NQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r554070385", "bodyText": "I don't see a reference to the Pair class within this code.\nMaybe it is implicit in the molecularProfileCaseIdentifiers?", "author": "sheridancbio", "createdAt": "2021-01-08T16:57:19Z", "path": "service/src/main/java/org/cbioportal/service/util/AlterationEnrichmentUtil.java", "diffHunk": "@@ -5,6 +5,7 @@\n import java.util.function.Function;\n import java.util.stream.Collectors;\n \n+import org.apache.commons.lang3.tuple.Pair;", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwNDk3MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555704971", "bodyText": "Removed!", "author": "pvannierop", "createdAt": "2021-01-12T11:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA3MDM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI0OTU2Mw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555249563", "bodyText": "There is a new style for these @Cacheable annotations, introduced with the recent merge of the redis caching option PR #8252\nWe can help with converting these cacheable annotations to the new style.", "author": "sheridancbio", "createdAt": "2021-01-11T18:21:22Z", "path": "persistence/persistence-api/src/main/java/org/cbioportal/persistence/AlterationRepository.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package org.cbioportal.persistence;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import java.util.List;\n+\n+public interface AlterationRepository {\n+\n+    @Cacheable(cacheNames = \"GeneralRepositoryCache\", condition = \"@cacheEnabledConfig.getEnabled()\")", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTcwNTI0OQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555705249", "bodyText": "Ok, let's discuss this in a call.", "author": "pvannierop", "createdAt": "2021-01-12T11:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI0OTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk2NzkwMg==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560967902", "bodyText": "I have examined the master branch head, and I think the replacement rule would be very straightforward:\npersistence-api class member functions can be annotated with:\n@Cacheable(cacheResolver = \"generalRepositoryCacheResolver\", condition = \"@cacheEnabledConfig.getEnabled()\")\nin place of\n@Cacheable(cacheNames = \"GeneralRepositoryCache\", condition = \"@cacheEnabledConfig.getEnabled()\")\nThis should cover all cases in this PR. There is also a special purpose static repository cache which we are using for holding a small number of items (mainly genes and gene aliases) ... for these functions, the old annotation with cacheNames = \"staticRepositoryCacheOne\" could be adjusted to use cacheResolver = \"staticRepositoryCacheOneResolver\" instead ... but I don't think this static cache is relevant to this PR. In fact, the only change that seems to be needed would be in the current file (AlterationRepository.java). The other changes to the API module simply remove functions.", "author": "sheridancbio", "createdAt": "2021-01-20T13:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI0OTU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1MzkxNA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555253914", "bodyText": "having \"mutationTypes = null\" mean include all, and having \"mutationTypes = new Select()\" mean include none seems non-obvious to me. Ah ... hold on. I see that there is already Static instances of Select<> in the Select template class called ALL and NONE ... so I now think that this comment (and the following line too) is simply out of date.", "author": "sheridancbio", "createdAt": "2021-01-11T18:29:01Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationCountsMapper.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.AlterationCountByGene;\n+import org.cbioportal.model.CopyNumberCountByGene;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+\n+import java.util.List;\n+\n+public interface AlterationCountsMapper {\n+\n+    /**\n+     * Calculate sample-level counts of mutation and discrete CNA alteration events.\n+     * @param internalSampleIds List of internal id's of samples to include in alteration counts.\n+     * @param entrezGeneIds  List of gene ids to get counts for.\n+     * @param mutationTypes  Types of mutations to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts. ", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1Njk5MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555256991", "bodyText": "I see the same issue occurs in other functions in this interface ... so please review/refine the javadoc comments in this file.", "author": "sheridancbio", "createdAt": "2021-01-11T18:34:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1MzkxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTc4MzYxNw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555783617", "bodyText": "All javadoc was updated.", "author": "pvannierop", "createdAt": "2021-01-12T13:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1MzkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1NzQ5OA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555257498", "bodyText": "missing description of return value", "author": "sheridancbio", "createdAt": "2021-01-11T18:35:25Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationCountsMapper.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.AlterationCountByGene;\n+import org.cbioportal.model.CopyNumberCountByGene;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+\n+import java.util.List;\n+\n+public interface AlterationCountsMapper {\n+\n+    /**\n+     * Calculate sample-level counts of mutation and discrete CNA alteration events.\n+     * @param internalSampleIds List of internal id's of samples to include in alteration counts.\n+     * @param entrezGeneIds  List of gene ids to get counts for.\n+     * @param mutationTypes  Types of mutations to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts. \n+     * @param cnaTypes  Types of discrete copy number alteration types to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts.\n+     * @param searchFusions  'ACTIVE': counts are limited to fusion type. 'INACTIVE': counts are limited to non-fusion alterations.'PASS': no filtering on mutation vs fusions (mutation types and cnaTypes are used) \n+     * @return Gene-level counts of (1) the total number of alterations and (2) the number of altered samples.\n+     */\n+    List<AlterationCountByGene> getSampleAlterationCounts(List<Integer> internalSampleIds,\n+                                                          List<Integer> entrezGeneIds,\n+                                                          Select<String> mutationTypes,\n+                                                          Select<Integer> cnaTypes,\n+                                                          QueryElement searchFusions);\n+\n+    /**\n+     * Gets internal sample ids for samples that match (molecularProfileId, sampleId) pair\n+     * Note: Molecular profile id in molecularProfileIds.get(N) corresponds with sample id in sampleIds.get(N)\n+     * @param molecularProfileIds  List of stable id's of molecular profiles to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @param sampleIds List of stable id's of samples to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @return", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTc4NDA5MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555784091", "bodyText": "Added", "author": "pvannierop", "createdAt": "2021-01-12T13:52:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1NzQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1ODkyNQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555258925", "bodyText": "missing return value description", "author": "sheridancbio", "createdAt": "2021-01-11T18:37:58Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationCountsMapper.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.AlterationCountByGene;\n+import org.cbioportal.model.CopyNumberCountByGene;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+\n+import java.util.List;\n+\n+public interface AlterationCountsMapper {\n+\n+    /**\n+     * Calculate sample-level counts of mutation and discrete CNA alteration events.\n+     * @param internalSampleIds List of internal id's of samples to include in alteration counts.\n+     * @param entrezGeneIds  List of gene ids to get counts for.\n+     * @param mutationTypes  Types of mutations to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts. \n+     * @param cnaTypes  Types of discrete copy number alteration types to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts.\n+     * @param searchFusions  'ACTIVE': counts are limited to fusion type. 'INACTIVE': counts are limited to non-fusion alterations.'PASS': no filtering on mutation vs fusions (mutation types and cnaTypes are used) \n+     * @return Gene-level counts of (1) the total number of alterations and (2) the number of altered samples.\n+     */\n+    List<AlterationCountByGene> getSampleAlterationCounts(List<Integer> internalSampleIds,\n+                                                          List<Integer> entrezGeneIds,\n+                                                          Select<String> mutationTypes,\n+                                                          Select<Integer> cnaTypes,\n+                                                          QueryElement searchFusions);\n+\n+    /**\n+     * Gets internal sample ids for samples that match (molecularProfileId, sampleId) pair\n+     * Note: Molecular profile id in molecularProfileIds.get(N) corresponds with sample id in sampleIds.get(N)\n+     * @param molecularProfileIds  List of stable id's of molecular profiles to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @param sampleIds List of stable id's of samples to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @return\n+     */\n+    List<Integer> getSampleInternalIds(List<String> molecularProfileIds,\n+                                       List<String> sampleIds);\n+\n+    /**\n+     * Calculate patient-level counts of mutation and discrete CNA alteration events.\n+     * @param internalPatientIds List of internal id's of patients to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @param entrezGeneIds  List of gene ids to get counts for.\n+     * @param mutationTypes  Types of mutations to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts. \n+     * @param cnaTypes  Types of discrete copy number alteration types to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts.\n+     * @param searchFusions  'ACTIVE': counts are limited to fusion type. 'INACTIVE': counts are limited to non-fusion alterations.'PASS': no filtering on mutation vs fusions (mutation types and cnaTypes are used) \n+     * @return Gene-level counts of (1) the total number of alterations and (2) the number of altered patients.\n+     */\n+    List<AlterationCountByGene> getPatientAlterationCounts(List<Integer> internalPatientIds,\n+                                                           List<Integer> entrezGeneIds,\n+                                                           Select<String> mutationTypes,\n+                                                           Select<Integer> cnaTypes,\n+                                                           QueryElement searchFusions);\n+\n+    /**\n+     * Gets internal sample ids for samples that match (molecularProfileId, sampleId) pair\n+     * Note: Molecular profile id in molecularProfileIds.get(N) corresponds with sample id in sampleIds.get(N)\n+     * @param molecularProfileIds  List of stable id's of molecular profiles to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @param patientIds List of stable id's of patients to include in alteration counts. Forms pairs with patientIds based on array index.\n+     * @return", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTc4NDIyNA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555784224", "bodyText": "Added", "author": "pvannierop", "createdAt": "2021-01-12T13:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1ODkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI2MTIyOQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555261229", "bodyText": "The name of this function sounds (to me) like it is returning internal patient ids (we pass in patients stable ids). Is that true? The comment above says that the function returns internal sample ids for a list of patients. The input is a string, so I am guessing we get patient stable ids (which is why we must pair them with the profile ids)\nI guess we either need to correct the comment above this function, or should consider a function name such as getInternalSampleIdsForPatients()", "author": "sheridancbio", "createdAt": "2021-01-11T18:42:14Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationCountsMapper.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.AlterationCountByGene;\n+import org.cbioportal.model.CopyNumberCountByGene;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+\n+import java.util.List;\n+\n+public interface AlterationCountsMapper {\n+\n+    /**\n+     * Calculate sample-level counts of mutation and discrete CNA alteration events.\n+     * @param internalSampleIds List of internal id's of samples to include in alteration counts.\n+     * @param entrezGeneIds  List of gene ids to get counts for.\n+     * @param mutationTypes  Types of mutations to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts. \n+     * @param cnaTypes  Types of discrete copy number alteration types to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts.\n+     * @param searchFusions  'ACTIVE': counts are limited to fusion type. 'INACTIVE': counts are limited to non-fusion alterations.'PASS': no filtering on mutation vs fusions (mutation types and cnaTypes are used) \n+     * @return Gene-level counts of (1) the total number of alterations and (2) the number of altered samples.\n+     */\n+    List<AlterationCountByGene> getSampleAlterationCounts(List<Integer> internalSampleIds,\n+                                                          List<Integer> entrezGeneIds,\n+                                                          Select<String> mutationTypes,\n+                                                          Select<Integer> cnaTypes,\n+                                                          QueryElement searchFusions);\n+\n+    /**\n+     * Gets internal sample ids for samples that match (molecularProfileId, sampleId) pair\n+     * Note: Molecular profile id in molecularProfileIds.get(N) corresponds with sample id in sampleIds.get(N)\n+     * @param molecularProfileIds  List of stable id's of molecular profiles to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @param sampleIds List of stable id's of samples to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @return\n+     */\n+    List<Integer> getSampleInternalIds(List<String> molecularProfileIds,\n+                                       List<String> sampleIds);\n+\n+    /**\n+     * Calculate patient-level counts of mutation and discrete CNA alteration events.\n+     * @param internalPatientIds List of internal id's of patients to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @param entrezGeneIds  List of gene ids to get counts for.\n+     * @param mutationTypes  Types of mutations to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts. \n+     * @param cnaTypes  Types of discrete copy number alteration types to include in alteration counts. When 'null' all types will be included. When empty list mutations will be excluded from counts.\n+     * @param searchFusions  'ACTIVE': counts are limited to fusion type. 'INACTIVE': counts are limited to non-fusion alterations.'PASS': no filtering on mutation vs fusions (mutation types and cnaTypes are used) \n+     * @return Gene-level counts of (1) the total number of alterations and (2) the number of altered patients.\n+     */\n+    List<AlterationCountByGene> getPatientAlterationCounts(List<Integer> internalPatientIds,\n+                                                           List<Integer> entrezGeneIds,\n+                                                           Select<String> mutationTypes,\n+                                                           Select<Integer> cnaTypes,\n+                                                           QueryElement searchFusions);\n+\n+    /**\n+     * Gets internal sample ids for samples that match (molecularProfileId, sampleId) pair\n+     * Note: Molecular profile id in molecularProfileIds.get(N) corresponds with sample id in sampleIds.get(N)\n+     * @param molecularProfileIds  List of stable id's of molecular profiles to include in alteration counts. Forms pairs with sampleIds based on array index.\n+     * @param patientIds List of stable id's of patients to include in alteration counts. Forms pairs with patientIds based on array index.\n+     * @return\n+     */\n+    List<Integer> getPatientInternalIds(List<String> molecularProfileIds,", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTc4OTI0Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555789246", "bodyText": "Yse, this is true. Comment has been corrected.", "author": "pvannierop", "createdAt": "2021-01-12T14:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI2MTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUwMzIwNQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560503205", "bodyText": "\ud83d\udc4d", "author": "sheridancbio", "createdAt": "2021-01-19T21:19:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI2MTIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI2MzM0MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555263340", "bodyText": "Reiteration of previous comments : I'm generally supportive of using \"import java.util.*\" and yet I also have hesitancy towards collapsing our own class packages into wildcard includes.", "author": "sheridancbio", "createdAt": "2021-01-11T18:46:13Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepository.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.persistence.AlterationRepository;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Repository;\n+\n+import java.util.ArrayList;", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTc4OTU0MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555789541", "bodyText": "Wildcards in imports were all removed.", "author": "pvannierop", "createdAt": "2021-01-12T14:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI2MzM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4MzQ2OQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555283469", "bodyText": "This is kind of a nonsense query case, but it is good to short-circuit it", "author": "sheridancbio", "createdAt": "2021-01-11T19:23:09Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepository.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.persistence.AlterationRepository;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Repository;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Repository\n+public class AlterationMyBatisRepository implements AlterationRepository {\n+\n+    @Autowired\n+    private AlterationCountsMapper alterationCountsMapper;\n+\n+    @Override\n+    public List<AlterationCountByGene> getSampleAlterationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                                 List<Integer> entrezGeneIds,\n+                                                                 final Select<MutationEventType> mutationEventTypes,\n+                                                                 final Select<CopyNumberAlterationEventType> cnaEventTypes,\n+                                                                 QueryElement searchFusions) {\n+\n+        // TODO add test\n+        if (!mutationEventTypes.hasAll() && searchFusions != QueryElement.PASS)\n+            throw new IllegalArgumentException(\"Filtering for mutations vs. fusions and specifying mutation types\" +\n+                \"simultaneously is not permitted.\");\n+\n+        if ((mutationEventTypes.hasNone() && cnaEventTypes.hasNone())", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTc5MDQ2MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555790461", "bodyText": "Yes, this should never occur, but the API permits it, so a short-circuit is justified in my opinion.", "author": "pvannierop", "createdAt": "2021-01-12T14:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4MzQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4NTA4NA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555285084", "bodyText": "molecularProfileCaseIdentifiers inherently indicate the associated profileid; this function call simply unpacks the structures for processing below.", "author": "sheridancbio", "createdAt": "2021-01-11T19:25:52Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepository.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.persistence.AlterationRepository;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Repository;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Repository\n+public class AlterationMyBatisRepository implements AlterationRepository {\n+\n+    @Autowired\n+    private AlterationCountsMapper alterationCountsMapper;\n+\n+    @Override\n+    public List<AlterationCountByGene> getSampleAlterationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                                 List<Integer> entrezGeneIds,\n+                                                                 final Select<MutationEventType> mutationEventTypes,\n+                                                                 final Select<CopyNumberAlterationEventType> cnaEventTypes,\n+                                                                 QueryElement searchFusions) {\n+\n+        // TODO add test\n+        if (!mutationEventTypes.hasAll() && searchFusions != QueryElement.PASS)\n+            throw new IllegalArgumentException(\"Filtering for mutations vs. fusions and specifying mutation types\" +\n+                \"simultaneously is not permitted.\");\n+\n+        if ((mutationEventTypes.hasNone() && cnaEventTypes.hasNone())\n+            || molecularProfileCaseIdentifiers.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        Pair<List<String>, List<String>> caseIdToProfileIdArrays = createCaseIdToProfileIdArrays(molecularProfileCaseIdentifiers);", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTc5Mzg5MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555793891", "bodyText": "After reading your comment I chose to pass List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers directly to the getInternalPatientIds() and getInternalSampleIds() methods.", "author": "pvannierop", "createdAt": "2021-01-12T14:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4NTA4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxMzcyNQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560513725", "bodyText": "ok, if this was unnecessary code then that is good.", "author": "sheridancbio", "createdAt": "2021-01-19T21:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4NTA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4NzE0Mw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555287143", "bodyText": "I made a comment elsewhere about the name of function getPatientInternalIds .. but now I see there actually is a method for getSampleInternalIds() ... so perhaps the call to getPatientInternalIds() was what was intended in the other place and the comment above that code simply needs to be updated?", "author": "sheridancbio", "createdAt": "2021-01-11T19:29:35Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepository.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.persistence.AlterationRepository;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Repository;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Repository\n+public class AlterationMyBatisRepository implements AlterationRepository {\n+\n+    @Autowired\n+    private AlterationCountsMapper alterationCountsMapper;\n+\n+    @Override\n+    public List<AlterationCountByGene> getSampleAlterationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                                 List<Integer> entrezGeneIds,\n+                                                                 final Select<MutationEventType> mutationEventTypes,\n+                                                                 final Select<CopyNumberAlterationEventType> cnaEventTypes,\n+                                                                 QueryElement searchFusions) {\n+\n+        // TODO add test\n+        if (!mutationEventTypes.hasAll() && searchFusions != QueryElement.PASS)\n+            throw new IllegalArgumentException(\"Filtering for mutations vs. fusions and specifying mutation types\" +\n+                \"simultaneously is not permitted.\");\n+\n+        if ((mutationEventTypes.hasNone() && cnaEventTypes.hasNone())\n+            || molecularProfileCaseIdentifiers.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        Pair<List<String>, List<String>> caseIdToProfileIdArrays = createCaseIdToProfileIdArrays(molecularProfileCaseIdentifiers);\n+\n+        List<Integer> internalSampleIds = alterationCountsMapper.getSampleInternalIds(caseIdToProfileIdArrays.getLeft(),", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTgwNzk3MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555807971", "bodyText": "Yes, it was a matter of simply updating the commens.", "author": "pvannierop", "createdAt": "2021-01-12T14:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4NzE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxODQ0OQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560518449", "bodyText": "\ud83d\udc4d", "author": "sheridancbio", "createdAt": "2021-01-19T21:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4NzE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI5Mzc0Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555293747", "bodyText": "Most of our source files end with a newline. I guess it would only have an effect if we concatenated source files for some purpose, but maybe it is cleaner to stay consistent.", "author": "sheridancbio", "createdAt": "2021-01-11T19:42:03Z", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepository.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.cbioportal.persistence.AlterationRepository;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Repository;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Repository\n+public class AlterationMyBatisRepository implements AlterationRepository {\n+\n+    @Autowired\n+    private AlterationCountsMapper alterationCountsMapper;\n+\n+    @Override\n+    public List<AlterationCountByGene> getSampleAlterationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                                 List<Integer> entrezGeneIds,\n+                                                                 final Select<MutationEventType> mutationEventTypes,\n+                                                                 final Select<CopyNumberAlterationEventType> cnaEventTypes,\n+                                                                 QueryElement searchFusions) {\n+\n+        // TODO add test\n+        if (!mutationEventTypes.hasAll() && searchFusions != QueryElement.PASS)\n+            throw new IllegalArgumentException(\"Filtering for mutations vs. fusions and specifying mutation types\" +\n+                \"simultaneously is not permitted.\");\n+\n+        if ((mutationEventTypes.hasNone() && cnaEventTypes.hasNone())\n+            || molecularProfileCaseIdentifiers.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        Pair<List<String>, List<String>> caseIdToProfileIdArrays = createCaseIdToProfileIdArrays(molecularProfileCaseIdentifiers);\n+\n+        List<Integer> internalSampleIds = alterationCountsMapper.getSampleInternalIds(caseIdToProfileIdArrays.getLeft(),\n+            caseIdToProfileIdArrays.getRight());\n+        if (internalSampleIds.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        return alterationCountsMapper.getSampleAlterationCounts(\n+            internalSampleIds,\n+            entrezGeneIds,\n+            createMutationTypeList(mutationEventTypes),\n+            createCnaTypeList(cnaEventTypes),\n+            searchFusions);\n+    }\n+\n+    @Override\n+    public List<AlterationCountByGene> getPatientAlterationCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                                  List<Integer> entrezGeneIds,\n+                                                                  Select<MutationEventType> mutationEventTypes,\n+                                                                  Select<CopyNumberAlterationEventType> cnaEventTypes,\n+                                                                  QueryElement searchFusions) {\n+\n+        if (!mutationEventTypes.hasAll() && searchFusions != QueryElement.PASS)\n+            throw new IllegalArgumentException(\"Filtering for mutations vs. fusions and specifying mutation types\" +\n+                \"simultaneously is not permitted.\");\n+        \n+        if ((mutationEventTypes.hasNone() && cnaEventTypes.hasNone())\n+            || molecularProfileCaseIdentifiers.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        Pair<List<String>, List<String>> caseIdToProfileIdArrays = createCaseIdToProfileIdArrays(molecularProfileCaseIdentifiers);\n+\n+        List<Integer> internalPatientIds = alterationCountsMapper.getPatientInternalIds(caseIdToProfileIdArrays.getLeft(),\n+            caseIdToProfileIdArrays.getRight());\n+        if (internalPatientIds.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        return alterationCountsMapper.getPatientAlterationCounts(\n+            internalPatientIds,\n+            entrezGeneIds,\n+            createMutationTypeList(mutationEventTypes),\n+            createCnaTypeList(cnaEventTypes),\n+            searchFusions);\n+    }\n+\n+    @Override\n+    public List<CopyNumberCountByGene> getSampleCnaCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                          List<Integer> entrezGeneIds,\n+                                                          Select<CopyNumberAlterationEventType> cnaEventTypes) {\n+\n+        if (cnaEventTypes.hasNone()) {\n+            return Collections.emptyList();\n+        }\n+\n+        Pair<List<String>, List<String>> caseIdToProfileIdArrays = createCaseIdToProfileIdArrays(molecularProfileCaseIdentifiers);\n+\n+        List<Integer> internalSampleIds = alterationCountsMapper.getSampleInternalIds(caseIdToProfileIdArrays.getLeft(),\n+            caseIdToProfileIdArrays.getRight());\n+        if (internalSampleIds.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        return alterationCountsMapper.getSampleCnaCounts(\n+            internalSampleIds,\n+            entrezGeneIds,\n+            createCnaTypeList(cnaEventTypes));\n+    }\n+\n+    @Override\n+    public List<CopyNumberCountByGene> getPatientCnaCounts(List<MolecularProfileCaseIdentifier> molecularProfileCaseIdentifiers,\n+                                                           List<Integer> entrezGeneIds,\n+                                                           Select<CopyNumberAlterationEventType> cnaEventTypes) {\n+\n+        if (cnaEventTypes.hasNone()) {\n+            return Collections.emptyList();\n+        }\n+\n+        Pair<List<String>, List<String>> caseIdToProfileIdArrays = createCaseIdToProfileIdArrays(molecularProfileCaseIdentifiers);\n+\n+        return alterationCountsMapper.getPatientCnaCounts(\n+            caseIdToProfileIdArrays.getLeft(),\n+            caseIdToProfileIdArrays.getRight(),\n+            entrezGeneIds,\n+            createCnaTypeList(cnaEventTypes));\n+    }\n+\n+\n+    /**\n+     * Collect profile id and sample id arrays.\n+     *\n+     * @param ids List of MolecularProfileCaseIdentifiers\n+     * @return Pair of profile id/sample id arrays where every index\n+     * represents a profile id/sample id-combination\n+     */\n+    private Pair<List<String>, List<String>> createCaseIdToProfileIdArrays(List<MolecularProfileCaseIdentifier> ids) {\n+        List<String> caseIds = new ArrayList<>();\n+        List<String> profileIds = new ArrayList<>();\n+        ids.forEach(pair -> {\n+            caseIds.add(pair.getCaseId());\n+            profileIds.add(pair.getMolecularProfileId());\n+        });\n+        return Pair.of(profileIds, caseIds);\n+    }\n+\n+    private Select<Integer> createCnaTypeList(final Select<CopyNumberAlterationEventType> cnaEventTypes) {\n+        return cnaEventTypes.map(CopyNumberAlterationEventType::getAlterationType);\n+    }\n+\n+    private Select<String> createMutationTypeList(final Select<MutationEventType> mutationEventTypes) {\n+        return mutationEventTypes.map(MutationEventType::getMutationType);\n+    }\n+\n+}", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTgxMzAxNw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555813017", "bodyText": "Added. It would be great to implement some form of code formatting checking.", "author": "pvannierop", "createdAt": "2021-01-12T14:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI5Mzc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM3ODQ1Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555378456", "bodyText": "import wildcards mentioned previously", "author": "sheridancbio", "createdAt": "2021-01-11T22:23:25Z", "path": "persistence/persistence-mybatis/src/test/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepositoryTest.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Configurable;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4NDM2Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555384366", "bodyText": "The comment should be clarified. If the implementing code is not expected to be deleted soon perhaps a comment in the implementation should describe what combination of arguments must be avoided (non null entrezGeneId list?)", "author": "sheridancbio", "createdAt": "2021-01-11T22:36:26Z", "path": "persistence/persistence-mybatis/src/test/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepositoryTest.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Configurable;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(\"/testContextDatabase.xml\")\n+@Configurable\n+public class AlterationMyBatisRepositoryTest {\n+\n+//    mutation and cna events in testSql.sql\n+//        SAMPLE_ID, ENTREZ_GENE_ID, HUGO_GENE_SYMBOL, GENETIC_PROFILE_ID, MUTATION_TYPE, DRIVER_FILTER, DRIVER_TIERS_FILTER, PATIENT_ID\n+//        1\t    207\tAKT1\t2\t-2\t                Putative_Driver\t    Tier 1  TCGA-A1-A0SB\n+//        2\t    207\tAKT1\t2\t2\t                Putative_Passenger\tTier 2  TCGA-A1-A0SD\n+//        1\t    207\tAKT1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 1  TCGA-A1-A0SB\n+//        2\t    207\tAKT1\t6\tMissense_Mutation\tPutative_Passenger\tTier 2  TCGA-A1-A0SD\n+//        1\t    208\tAKT2\t2\t2\t\t            <null>              <null>  TCGA-A1-A0SB\n+//        3\t    208\tAKT2\t6\tSplice_Site\t        Putative_Passenger\tTier 1  TCGA-A1-A0SE\n+//        6\t    672\tBRCA1\t6\tMissense_Mutation\tPutative_Passenger\tTier 2  TCGA-A1-A0SH\n+//        6\t    672\tBRCA1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 1  TCGA-A1-A0SH\n+//        7\t    672\tBRCA1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 2  TCGA-A1-A0SI\n+//        12\t672\tBRCA1\t6\tSplice_Site\t        Putative_Passenger\tTier 1  TCGA-A1-A0SO\n+//        13\t672\tBRCA1\t6\tSplice_Site\t        Putative_Driver\t    Tier 1  TCGA-A1-A0SP\n+\n+    @Autowired\n+    private AlterationMyBatisRepository alterationMyBatisRepository;\n+\n+    Select<MutationEventType> mutationEventTypes = Select.byValues(Arrays.asList(\n+        MutationEventType.splice_site,\n+        MutationEventType.nonsense_mutation,\n+        MutationEventType.missense_mutation\n+    ));\n+    Select<CopyNumberAlterationEventType> cnaEventTypes = Select.byValues(Arrays.asList(\n+        CopyNumberAlterationEventType.AMP,\n+        CopyNumberAlterationEventType.HOMDEL\n+    ));\n+    List<MolecularProfileCaseIdentifier> sampleIdToProfileId = new ArrayList<>();\n+    List<MolecularProfileCaseIdentifier> patientIdToProfileId = new ArrayList<>();\n+    List<Integer> entrezGeneIds = new ArrayList<>();\n+\n+    @Before\n+    public void setup() {\n+        \n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SE-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SH-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SI-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SO-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SP-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB-01\", \"study_tcga_pub_gistic\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD-01\", \"study_tcga_pub_gistic\"));\n+\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SE\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SH\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SI\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SO\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SP\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB\", \"study_tcga_pub_gistic\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD\", \"study_tcga_pub_gistic\"));\n+        \n+        entrezGeneIds.add(207);\n+        entrezGeneIds.add(208);\n+        entrezGeneIds.add(672);\n+    }\n+\n+    @Test\n+    public void getSampleMutationCount() throws Exception {\n+\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleCnaCount() throws Exception {\n+\n+        mutationEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(2, result.size());\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleMutationAndCnaCount() throws Exception {\n+\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 4, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientMutationCount() throws Exception {\n+\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientCnaCount() throws Exception {\n+\n+        mutationEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(2, result.size());\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientMutationAndCnaCount() throws Exception {\n+\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 4, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleCnaCountLegacy() throws Exception {\n+\n+        // FIXME: whole CNA dedicated endpoint should be removed\n+        entrezGeneIds = null; // only way it works; otherwise it tries to pair up geneids with alteration types with", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDU3NTE4Mw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560575183", "bodyText": "this was done", "author": "sheridancbio", "createdAt": "2021-01-19T23:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4NDM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4NzgwNw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555387807", "bodyText": "It might be worthwhile to add a case with 2 samples belonging to the same sample in the mock test data ... it would give a chance here to put a test in place showing correct behavior for the logic / call chains distinguishing sample counts from patient counts.", "author": "sheridancbio", "createdAt": "2021-01-11T22:44:27Z", "path": "persistence/persistence-mybatis/src/test/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepositoryTest.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Configurable;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(\"/testContextDatabase.xml\")\n+@Configurable\n+public class AlterationMyBatisRepositoryTest {\n+\n+//    mutation and cna events in testSql.sql\n+//        SAMPLE_ID, ENTREZ_GENE_ID, HUGO_GENE_SYMBOL, GENETIC_PROFILE_ID, MUTATION_TYPE, DRIVER_FILTER, DRIVER_TIERS_FILTER, PATIENT_ID\n+//        1\t    207\tAKT1\t2\t-2\t                Putative_Driver\t    Tier 1  TCGA-A1-A0SB\n+//        2\t    207\tAKT1\t2\t2\t                Putative_Passenger\tTier 2  TCGA-A1-A0SD\n+//        1\t    207\tAKT1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 1  TCGA-A1-A0SB\n+//        2\t    207\tAKT1\t6\tMissense_Mutation\tPutative_Passenger\tTier 2  TCGA-A1-A0SD\n+//        1\t    208\tAKT2\t2\t2\t\t            <null>              <null>  TCGA-A1-A0SB\n+//        3\t    208\tAKT2\t6\tSplice_Site\t        Putative_Passenger\tTier 1  TCGA-A1-A0SE\n+//        6\t    672\tBRCA1\t6\tMissense_Mutation\tPutative_Passenger\tTier 2  TCGA-A1-A0SH\n+//        6\t    672\tBRCA1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 1  TCGA-A1-A0SH\n+//        7\t    672\tBRCA1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 2  TCGA-A1-A0SI\n+//        12\t672\tBRCA1\t6\tSplice_Site\t        Putative_Passenger\tTier 1  TCGA-A1-A0SO\n+//        13\t672\tBRCA1\t6\tSplice_Site\t        Putative_Driver\t    Tier 1  TCGA-A1-A0SP\n+\n+    @Autowired\n+    private AlterationMyBatisRepository alterationMyBatisRepository;\n+\n+    Select<MutationEventType> mutationEventTypes = Select.byValues(Arrays.asList(\n+        MutationEventType.splice_site,\n+        MutationEventType.nonsense_mutation,\n+        MutationEventType.missense_mutation\n+    ));\n+    Select<CopyNumberAlterationEventType> cnaEventTypes = Select.byValues(Arrays.asList(\n+        CopyNumberAlterationEventType.AMP,\n+        CopyNumberAlterationEventType.HOMDEL\n+    ));\n+    List<MolecularProfileCaseIdentifier> sampleIdToProfileId = new ArrayList<>();\n+    List<MolecularProfileCaseIdentifier> patientIdToProfileId = new ArrayList<>();\n+    List<Integer> entrezGeneIds = new ArrayList<>();\n+\n+    @Before\n+    public void setup() {\n+        \n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SE-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SH-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SI-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SO-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SP-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB-01\", \"study_tcga_pub_gistic\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD-01\", \"study_tcga_pub_gistic\"));\n+\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SE\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SH\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SI\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SO\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SP\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB\", \"study_tcga_pub_gistic\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD\", \"study_tcga_pub_gistic\"));\n+        \n+        entrezGeneIds.add(207);\n+        entrezGeneIds.add(208);\n+        entrezGeneIds.add(672);\n+    }\n+\n+    @Test\n+    public void getSampleMutationCount() throws Exception {\n+\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleCnaCount() throws Exception {\n+\n+        mutationEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(2, result.size());\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleMutationAndCnaCount() throws Exception {\n+\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 4, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientMutationCount() throws Exception {\n+\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientCnaCount() throws Exception {\n+\n+        mutationEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(2, result.size());\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientMutationAndCnaCount() throws Exception {\n+\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 4, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleCnaCountLegacy() throws Exception {\n+\n+        // FIXME: whole CNA dedicated endpoint should be removed\n+        entrezGeneIds = null; // only way it works; otherwise it tries to pair up geneids with alteration types with\n+        List<CopyNumberCountByGene> result = alterationMyBatisRepository.getSampleCnaCounts(\n+            sampleIdToProfileId, entrezGeneIds, cnaEventTypes);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result207up = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == 2).findFirst().get();\n+        AlterationCountByGene result207down = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == -2).findFirst().get();\n+        AlterationCountByGene result208up = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 1, result207up.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result207down.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208up.getNumberOfAlteredCases());\n+    }\n+    \n+    @Test\n+    public void getPatientCnaCountLegacy() throws Exception {\n+\n+        // FIXME: whole CNA dedicated endpoint should be removed\n+        entrezGeneIds = null; // only way it works; otherwise it tries to pair up geneids with alteration types with\n+        List<CopyNumberCountByGene> result = alterationMyBatisRepository.getPatientCnaCounts(\n+            patientIdToProfileId, entrezGeneIds, cnaEventTypes);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg1MTkzMw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555851933", "bodyText": "Ok, I made it:\n       // FIXME: the CnaCountLegacy endpoint is different from the AlterationCount endpoint\n        // because it returns a single additional value 'cytoband'. It would make sense to \n        // harmonize these endpoints (both or none return 'cytoband') and use the AlterationCount\n        // endpoint for all counts. Discuss...", "author": "pvannierop", "createdAt": "2021-01-12T15:20:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4NzgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTIwOQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555389209", "bodyText": "these tests are good for covering the query argument space. If there are other combinations of arguments which might present an edge case to the mapper logic for including / excluding / selecting terms for the SQL where clause, consider expanding to other permutations.", "author": "sheridancbio", "createdAt": "2021-01-11T22:47:46Z", "path": "persistence/persistence-mybatis/src/test/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepositoryTest.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Configurable;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(\"/testContextDatabase.xml\")\n+@Configurable\n+public class AlterationMyBatisRepositoryTest {\n+\n+//    mutation and cna events in testSql.sql\n+//        SAMPLE_ID, ENTREZ_GENE_ID, HUGO_GENE_SYMBOL, GENETIC_PROFILE_ID, MUTATION_TYPE, DRIVER_FILTER, DRIVER_TIERS_FILTER, PATIENT_ID\n+//        1\t    207\tAKT1\t2\t-2\t                Putative_Driver\t    Tier 1  TCGA-A1-A0SB\n+//        2\t    207\tAKT1\t2\t2\t                Putative_Passenger\tTier 2  TCGA-A1-A0SD\n+//        1\t    207\tAKT1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 1  TCGA-A1-A0SB\n+//        2\t    207\tAKT1\t6\tMissense_Mutation\tPutative_Passenger\tTier 2  TCGA-A1-A0SD\n+//        1\t    208\tAKT2\t2\t2\t\t            <null>              <null>  TCGA-A1-A0SB\n+//        3\t    208\tAKT2\t6\tSplice_Site\t        Putative_Passenger\tTier 1  TCGA-A1-A0SE\n+//        6\t    672\tBRCA1\t6\tMissense_Mutation\tPutative_Passenger\tTier 2  TCGA-A1-A0SH\n+//        6\t    672\tBRCA1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 1  TCGA-A1-A0SH\n+//        7\t    672\tBRCA1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 2  TCGA-A1-A0SI\n+//        12\t672\tBRCA1\t6\tSplice_Site\t        Putative_Passenger\tTier 1  TCGA-A1-A0SO\n+//        13\t672\tBRCA1\t6\tSplice_Site\t        Putative_Driver\t    Tier 1  TCGA-A1-A0SP\n+\n+    @Autowired\n+    private AlterationMyBatisRepository alterationMyBatisRepository;\n+\n+    Select<MutationEventType> mutationEventTypes = Select.byValues(Arrays.asList(\n+        MutationEventType.splice_site,\n+        MutationEventType.nonsense_mutation,\n+        MutationEventType.missense_mutation\n+    ));\n+    Select<CopyNumberAlterationEventType> cnaEventTypes = Select.byValues(Arrays.asList(\n+        CopyNumberAlterationEventType.AMP,\n+        CopyNumberAlterationEventType.HOMDEL\n+    ));\n+    List<MolecularProfileCaseIdentifier> sampleIdToProfileId = new ArrayList<>();\n+    List<MolecularProfileCaseIdentifier> patientIdToProfileId = new ArrayList<>();\n+    List<Integer> entrezGeneIds = new ArrayList<>();\n+\n+    @Before\n+    public void setup() {\n+        \n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SE-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SH-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SI-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SO-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SP-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB-01\", \"study_tcga_pub_gistic\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD-01\", \"study_tcga_pub_gistic\"));\n+\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SE\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SH\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SI\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SO\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SP\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB\", \"study_tcga_pub_gistic\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD\", \"study_tcga_pub_gistic\"));\n+        \n+        entrezGeneIds.add(207);\n+        entrezGeneIds.add(208);\n+        entrezGeneIds.add(672);\n+    }\n+\n+    @Test\n+    public void getSampleMutationCount() throws Exception {\n+\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleCnaCount() throws Exception {\n+\n+        mutationEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(2, result.size());\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleMutationAndCnaCount() throws Exception {\n+\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 4, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientMutationCount() throws Exception {\n+\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientCnaCount() throws Exception {\n+\n+        mutationEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(2, result.size());\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientMutationAndCnaCount() throws Exception {\n+\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 4, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleCnaCountLegacy() throws Exception {\n+\n+        // FIXME: whole CNA dedicated endpoint should be removed\n+        entrezGeneIds = null; // only way it works; otherwise it tries to pair up geneids with alteration types with\n+        List<CopyNumberCountByGene> result = alterationMyBatisRepository.getSampleCnaCounts(\n+            sampleIdToProfileId, entrezGeneIds, cnaEventTypes);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result207up = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == 2).findFirst().get();\n+        AlterationCountByGene result207down = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == -2).findFirst().get();\n+        AlterationCountByGene result208up = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 1, result207up.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result207down.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208up.getNumberOfAlteredCases());\n+    }\n+    \n+    @Test\n+    public void getPatientCnaCountLegacy() throws Exception {\n+\n+        // FIXME: whole CNA dedicated endpoint should be removed\n+        entrezGeneIds = null; // only way it works; otherwise it tries to pair up geneids with alteration types with\n+        List<CopyNumberCountByGene> result = alterationMyBatisRepository.getPatientCnaCounts(\n+            patientIdToProfileId, entrezGeneIds, cnaEventTypes);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result207up = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == 2).findFirst().get();\n+        AlterationCountByGene result207down = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == -2).findFirst().get();\n+        AlterationCountByGene result208up = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 1, result207up.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result207down.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208up.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleAlterationCountsReturnsZeroForMutationsAndCnaSelectorsInNone() {\n+\n+        mutationEventTypes = Select.none();\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(0, result.size());\n+    }\n+\n+    @Test\n+    public void getSampleAlterationCountsReturnsAllForMutationsAndCnaSelectorsInAll() {", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjMwNjg5Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r556306897", "bodyText": "I have added new tests that mainly test behavior for null arguments. I also implemented the Select.java pattern for entrezGeneIds.", "author": "pvannierop", "createdAt": "2021-01-13T07:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk1Mjk5Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r560952997", "bodyText": "\ud83d\udc4d", "author": "sheridancbio", "createdAt": "2021-01-20T13:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTczOA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r555389738", "bodyText": "these 4 tests of illegal argument combinations are great \ud83d\udc4d", "author": "sheridancbio", "createdAt": "2021-01-11T22:49:01Z", "path": "persistence/persistence-mybatis/src/test/java/org/cbioportal/persistence/mybatis/AlterationMyBatisRepositoryTest.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package org.cbioportal.persistence.mybatis;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.util.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Configurable;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(\"/testContextDatabase.xml\")\n+@Configurable\n+public class AlterationMyBatisRepositoryTest {\n+\n+//    mutation and cna events in testSql.sql\n+//        SAMPLE_ID, ENTREZ_GENE_ID, HUGO_GENE_SYMBOL, GENETIC_PROFILE_ID, MUTATION_TYPE, DRIVER_FILTER, DRIVER_TIERS_FILTER, PATIENT_ID\n+//        1\t    207\tAKT1\t2\t-2\t                Putative_Driver\t    Tier 1  TCGA-A1-A0SB\n+//        2\t    207\tAKT1\t2\t2\t                Putative_Passenger\tTier 2  TCGA-A1-A0SD\n+//        1\t    207\tAKT1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 1  TCGA-A1-A0SB\n+//        2\t    207\tAKT1\t6\tMissense_Mutation\tPutative_Passenger\tTier 2  TCGA-A1-A0SD\n+//        1\t    208\tAKT2\t2\t2\t\t            <null>              <null>  TCGA-A1-A0SB\n+//        3\t    208\tAKT2\t6\tSplice_Site\t        Putative_Passenger\tTier 1  TCGA-A1-A0SE\n+//        6\t    672\tBRCA1\t6\tMissense_Mutation\tPutative_Passenger\tTier 2  TCGA-A1-A0SH\n+//        6\t    672\tBRCA1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 1  TCGA-A1-A0SH\n+//        7\t    672\tBRCA1\t6\tNonsense_Mutation\tPutative_Driver\t    Tier 2  TCGA-A1-A0SI\n+//        12\t672\tBRCA1\t6\tSplice_Site\t        Putative_Passenger\tTier 1  TCGA-A1-A0SO\n+//        13\t672\tBRCA1\t6\tSplice_Site\t        Putative_Driver\t    Tier 1  TCGA-A1-A0SP\n+\n+    @Autowired\n+    private AlterationMyBatisRepository alterationMyBatisRepository;\n+\n+    Select<MutationEventType> mutationEventTypes = Select.byValues(Arrays.asList(\n+        MutationEventType.splice_site,\n+        MutationEventType.nonsense_mutation,\n+        MutationEventType.missense_mutation\n+    ));\n+    Select<CopyNumberAlterationEventType> cnaEventTypes = Select.byValues(Arrays.asList(\n+        CopyNumberAlterationEventType.AMP,\n+        CopyNumberAlterationEventType.HOMDEL\n+    ));\n+    List<MolecularProfileCaseIdentifier> sampleIdToProfileId = new ArrayList<>();\n+    List<MolecularProfileCaseIdentifier> patientIdToProfileId = new ArrayList<>();\n+    List<Integer> entrezGeneIds = new ArrayList<>();\n+\n+    @Before\n+    public void setup() {\n+        \n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SE-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SH-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SI-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SO-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SP-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD-01\", \"study_tcga_pub_mutations\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB-01\", \"study_tcga_pub_gistic\"));\n+        sampleIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD-01\", \"study_tcga_pub_gistic\"));\n+\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SE\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SH\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SI\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SO\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SP\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD\", \"study_tcga_pub_mutations\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SB\", \"study_tcga_pub_gistic\"));\n+        patientIdToProfileId.add(new MolecularProfileCaseIdentifier(\"TCGA-A1-A0SD\", \"study_tcga_pub_gistic\"));\n+        \n+        entrezGeneIds.add(207);\n+        entrezGeneIds.add(208);\n+        entrezGeneIds.add(672);\n+    }\n+\n+    @Test\n+    public void getSampleMutationCount() throws Exception {\n+\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleCnaCount() throws Exception {\n+\n+        mutationEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(2, result.size());\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleMutationAndCnaCount() throws Exception {\n+\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 4, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientMutationCount() throws Exception {\n+\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientCnaCount() throws Exception {\n+\n+        mutationEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(2, result.size());\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 2, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 1, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getPatientMutationAndCnaCount() throws Exception {\n+\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getPatientAlterationCounts(\n+            patientIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result672 = result.stream().filter(r -> r.getEntrezGeneId() == 672).findFirst().get();\n+        AlterationCountByGene result207 = result.stream().filter(r -> r.getEntrezGeneId() == 207).findFirst().get();\n+        AlterationCountByGene result208 = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 5, result672.getTotalCount());\n+        Assert.assertEquals((Integer) 4, result672.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 4, result207.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result207.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 2, result208.getTotalCount());\n+        Assert.assertEquals((Integer) 2, result208.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleCnaCountLegacy() throws Exception {\n+\n+        // FIXME: whole CNA dedicated endpoint should be removed\n+        entrezGeneIds = null; // only way it works; otherwise it tries to pair up geneids with alteration types with\n+        List<CopyNumberCountByGene> result = alterationMyBatisRepository.getSampleCnaCounts(\n+            sampleIdToProfileId, entrezGeneIds, cnaEventTypes);\n+\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result207up = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == 2).findFirst().get();\n+        AlterationCountByGene result207down = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == -2).findFirst().get();\n+        AlterationCountByGene result208up = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 1, result207up.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result207down.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208up.getNumberOfAlteredCases());\n+    }\n+    \n+    @Test\n+    public void getPatientCnaCountLegacy() throws Exception {\n+\n+        // FIXME: whole CNA dedicated endpoint should be removed\n+        entrezGeneIds = null; // only way it works; otherwise it tries to pair up geneids with alteration types with\n+        List<CopyNumberCountByGene> result = alterationMyBatisRepository.getPatientCnaCounts(\n+            patientIdToProfileId, entrezGeneIds, cnaEventTypes);\n+\n+        // For testSql.sql there are no more samples per patient for the investigated genes.\n+        // Therefore, patient level counts are the same as the sample level counts.\n+        Assert.assertEquals(3, result.size());\n+        AlterationCountByGene result207up = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == 2).findFirst().get();\n+        AlterationCountByGene result207down = result.stream().filter(r -> r.getEntrezGeneId() == 207 && r.getAlteration() == -2).findFirst().get();\n+        AlterationCountByGene result208up = result.stream().filter(r -> r.getEntrezGeneId() == 208).findFirst().get();\n+        Assert.assertEquals((Integer) 1, result207up.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result207down.getNumberOfAlteredCases());\n+        Assert.assertEquals((Integer) 1, result208up.getNumberOfAlteredCases());\n+    }\n+\n+    @Test\n+    public void getSampleAlterationCountsReturnsZeroForMutationsAndCnaSelectorsInNone() {\n+\n+        mutationEventTypes = Select.none();\n+        cnaEventTypes = Select.none();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(0, result.size());\n+    }\n+\n+    @Test\n+    public void getSampleAlterationCountsReturnsAllForMutationsAndCnaSelectorsInAll() {\n+\n+        mutationEventTypes = Select.all();\n+        cnaEventTypes = Select.all();\n+        List<AlterationCountByGene> result = alterationMyBatisRepository.getSampleAlterationCounts(\n+            sampleIdToProfileId, entrezGeneIds, mutationEventTypes, cnaEventTypes, QueryElement.PASS);\n+\n+        Assert.assertEquals(3, result.size());\n+    }\n+\n+    @Test(expected = IllegalArgumentException.class)", "originalCommit": "48ed23abb39d061e48f4259b4d44e92aa6d39df8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7e3d3cea1270bb3d6343851480e04ab9997d848b", "url": "https://github.com/cBioPortal/cbioportal/commit/7e3d3cea1270bb3d6343851480e04ab9997d848b", "message": "Impl. Alterations enrichment endpoint", "committedDate": "2021-01-21T06:43:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA3MjU5MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r562072591", "bodyText": "I just noticed this in the latest squash of the code. I think this was the attempt to address the previous comment I made, but this is in the wrong place. This should remain as cacheResover = \"generalRepositoryCacheResolver\". Up above in class AlterationRepository, the annotation there should change to match this. (Use cacheResolver = \"generalRepositoryCacheResolver\").  We should no longer be using explicit cacheNames.", "author": "sheridancbio", "createdAt": "2021-01-21T17:39:23Z", "path": "persistence/persistence-api/src/main/java/org/cbioportal/persistence/MutationRepository.java", "diffHunk": "@@ -42,27 +42,7 @@ MutationMeta getMetaMutationsInMultipleMolecularProfiles(List<String> molecularP\n     MutationMeta fetchMetaMutationsInMolecularProfile(String molecularProfileId, List<String> sampleIds,\n                                                       List<Integer> entrezGeneIds);\n \n-    @Cacheable(cacheResolver = \"generalRepositoryCacheResolver\", condition = \"@cacheEnabledConfig.getEnabled()\")\n-    List<MutationCountByGene> getSampleCountByEntrezGeneIdsAndSampleIds(String molecularProfileId,\n-                                                                        List<String> sampleIds,\n-                                                                        List<Integer> entrezGeneIds);\n-\n-    @Cacheable(cacheResolver = \"generalRepositoryCacheResolver\", condition = \"@cacheEnabledConfig.getEnabled()\")\n-    List<MutationCountByGene> getSampleCountInMultipleMolecularProfiles(List<String> molecularProfileIds,\n-                                                                        List<String> sampleIds,\n-                                                                        List<Integer> entrezGeneIds);\n-    \n-    @Cacheable(cacheResolver = \"generalRepositoryCacheResolver\", condition = \"@cacheEnabledConfig.getEnabled()\")\n-    List<MutationCountByGene> getSampleCountInMultipleMolecularProfilesForFusions(List<String> molecularProfileIds,\n-                                                                        List<String> sampleIds,\n-                                                                        List<Integer> entrezGeneIds);\n-\n-    @Cacheable(cacheResolver = \"generalRepositoryCacheResolver\", condition = \"@cacheEnabledConfig.getEnabled()\")\n-    List<MutationCountByGene> getPatientCountInMultipleMolecularProfiles(List<String> molecularProfileIds,\n-                                                                         List<String> patientIds,\n-                                                                         List<Integer> entrezGeneIds);\n-\n-    @Cacheable(cacheResolver = \"generalRepositoryCacheResolver\", condition = \"@cacheEnabledConfig.getEnabled()\")\n+    @Cacheable(cacheNames = \"generalRepositoryCacheResolver\", condition = \"@cacheEnabledConfig.getEnabled()\")", "originalCommit": "7e3d3cea1270bb3d6343851480e04ab9997d848b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjQzOTc0NA==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r562439744", "bodyText": "Ah, I missed the different name for the parameter. Ok, corrected and squashed.", "author": "pvannierop", "createdAt": "2021-01-22T07:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA3MjU5MQ=="}], "type": "inlineReview"}, {"oid": "1b48291fd8442d2fdb60e955e8f54ababee0da2e", "url": "https://github.com/cBioPortal/cbioportal/commit/1b48291fd8442d2fdb60e955e8f54ababee0da2e", "message": "Impl. Alterations enrichment endpoint", "committedDate": "2021-01-22T07:37:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjcxODYzNg==", "url": "https://github.com/cBioPortal/cbioportal/pull/8086#discussion_r562718636", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Cacheable(cacheNames = \"GeneralRepositoryCache\", condition = \"@cacheEnabledConfig.getEnabled()\")\n          \n          \n            \n                @Cacheable(cacheResolver = \"generalRepositoryCacheResolver\", condition = \"@cacheEnabledConfig.getEnabled()\")", "author": "sheridancbio", "createdAt": "2021-01-22T15:41:16Z", "path": "persistence/persistence-api/src/main/java/org/cbioportal/persistence/AlterationRepository.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package org.cbioportal.persistence;\n+\n+import org.cbioportal.model.*;\n+import org.cbioportal.model.QueryElement;\n+import org.cbioportal.model.util.Select;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import java.util.List;\n+\n+public interface AlterationRepository {\n+\n+    @Cacheable(cacheNames = \"GeneralRepositoryCache\", condition = \"@cacheEnabledConfig.getEnabled()\")", "originalCommit": "1b48291fd8442d2fdb60e955e8f54ababee0da2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b315ee1304dcb87618df726da9d182e6f538f4f9", "url": "https://github.com/cBioPortal/cbioportal/commit/b315ee1304dcb87618df726da9d182e6f538f4f9", "message": "Impl. Alterations enrichment endpoint", "committedDate": "2021-01-22T16:30:32Z", "type": "commit"}, {"oid": "b315ee1304dcb87618df726da9d182e6f538f4f9", "url": "https://github.com/cBioPortal/cbioportal/commit/b315ee1304dcb87618df726da9d182e6f538f4f9", "message": "Impl. Alterations enrichment endpoint", "committedDate": "2021-01-22T16:30:32Z", "type": "forcePushed"}]}