{"pr_number": 7569, "pr_title": "Disconnect gene panel code (importer) from business module.", "pr_createdAt": "2020-06-02T15:18:40Z", "pr_url": "https://github.com/cBioPortal/cbioportal/pull/7569", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTQyMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434001420", "bodyText": "rs is declared to null but never set again", "author": "kalletlak", "createdAt": "2020-06-02T16:10:57Z", "path": "core/src/main/java/org/mskcc/cbio/portal/dao/DaoGenePanel.java", "diffHunk": "@@ -57,28 +53,132 @@ public static GenePanel getGenePanelByStableId(String stableId) {\n         PreparedStatement pstmt = null;\n         ResultSet rs = null;\n         try {\n-            con = JdbcUtil.getDbConnection(DaoCancerStudy.class);\n+            con = JdbcUtil.getDbConnection(DaoGenePanel.class);\n             pstmt = con.prepareStatement(\"SELECT * FROM gene_panel\");\n             rs = pstmt.executeQuery();\n             genePanelMap = extractGenePanelMap(rs);\n         } catch (SQLException e) {\n             e.printStackTrace();\n+        } catch (DaoException e) {\n+            e.printStackTrace();\n         } finally {\n-            JdbcUtil.closeAll(DaoCancerStudy.class, con, pstmt, rs);\n+            JdbcUtil.closeAll(DaoGenePanel.class, con, pstmt, rs);\n         }\n         return genePanelMap;\n     }\n \n-    private static Map<String, GenePanel> extractGenePanelMap(ResultSet rs) throws SQLException {\n+    private static Map<String, GenePanel> extractGenePanelMap(ResultSet rs) throws DaoException {\n         Map<String, GenePanel> genePanelMap = new HashMap<>();\n-        while(rs.next()) {\n-            GenePanel gp = new GenePanel();\n-            gp.setInternalId(rs.getInt(\"INTERNAL_ID\"));\n-            gp.setStableId(rs.getString(\"STABLE_ID\"));\n-            gp.setDescription(rs.getString(\"DESCRIPTION\"));\n-            genePanelMap.put(gp.getStableId(), gp);\n+        try {\n+            while(rs.next()) {\n+                GenePanel gp = new GenePanel();\n+                gp.setInternalId(rs.getInt(\"INTERNAL_ID\"));\n+                gp.setStableId(rs.getString(\"STABLE_ID\"));\n+                gp.setDescription(rs.getString(\"DESCRIPTION\"));\n+                gp.setGenes(extractGenePanelGenes(gp.getInternalId()));\n+                genePanelMap.put(gp.getStableId(), gp);\n+            }\n+        }\n+        catch (SQLException e) {\n+            throw new DaoException(e);\n         }\n         return genePanelMap;\n     }\n \n+    private static Set<CanonicalGene> extractGenePanelGenes(Integer genePanelId) throws DaoException {\n+        Connection con = null;\n+        PreparedStatement pstmt = null;\n+        ResultSet rs = null;\n+        HashSet<CanonicalGene> toReturn = new HashSet<CanonicalGene>();\n+        try {\n+            con = JdbcUtil.getDbConnection(DaoGenePanel.class);\n+            pstmt = con.prepareStatement(\"SELECT * FROM gene_panel_list where INTERNAL_ID = ?\");\n+            pstmt.setInt(1, genePanelId);\n+            pstmt.executeUpdate();\n+            DaoGeneOptimized daoGeneOpt = DaoGeneOptimized.getInstance();\n+            while (rs.next()) {", "originalCommit": "cf92ea92e35d1fbc5f11cb349bd10b0c8b400e38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMjI3Mg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434002272", "bodyText": "may be rs = pstmt.executeQuery() at line 97", "author": "kalletlak", "createdAt": "2020-06-02T16:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA4MzkyOA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434083928", "bodyText": "Good catch, fixed!", "author": "n1zea144", "createdAt": "2020-06-02T18:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxNjA4Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434016087", "bodyText": "I think we can remove daoGeneOptimized parameter and declared it inside getGenes method", "author": "kalletlak", "createdAt": "2020-06-02T16:34:10Z", "path": "core/src/main/java/org/mskcc/cbio/portal/scripts/ImportGenePanel.java", "diffHunk": "@@ -92,39 +90,31 @@ public void importData() throws Exception {\n         Properties properties = new Properties();\n         properties.load(new FileInputStream(genePanelFile));\n \n-        GenePanelRepositoryLegacy genePanelRepositoryLegacy = (GenePanelRepositoryLegacy)SpringUtil.getApplicationContext().getBean(\"genePanelRepositoryLegacy\");\n+        DaoGeneOptimized daoGeneOptimized = DaoGeneOptimized.getInstance();\n \n         String stableId = getPropertyValue(\"stable_id\", properties, true);\n         String description = getPropertyValue(\"description\", properties, false);\n-        Set<Integer> genes = getGenes(\"gene_list\", properties, genePanelRepositoryLegacy);\n+        Set<CanonicalGene> canonicalGenes = getGenes(\"gene_list\", properties, daoGeneOptimized);", "originalCommit": "cf92ea92e35d1fbc5f11cb349bd10b0c8b400e38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA4NDIwOA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434084208", "bodyText": "Yes, we can.", "author": "n1zea144", "createdAt": "2020-06-02T18:18:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxNjA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMTYwMg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434021602", "bodyText": "may be a comment explaining why just one gene is added to canonicalGenes", "author": "kalletlak", "createdAt": "2020-06-02T16:42:40Z", "path": "core/src/main/java/org/mskcc/cbio/portal/scripts/ImportGenePanel.java", "diffHunk": "@@ -143,39 +133,37 @@ private static String getPropertyValue(String propertyName, Properties propertie\n         return propertyValue;\n     }\n \n-    private static Set<Integer> getGenes(String propertyName, Properties properties, GenePanelRepositoryLegacy genePanelRepositoryLegacy) {\n+    private static Set<CanonicalGene> getGenes(String propertyName, Properties properties, DaoGeneOptimized daoGeneOptimized) {\n         String propertyValue = properties.getProperty(propertyName).trim();\n         if (propertyValue == null || propertyValue.length() == 0) {\n             throw new IllegalArgumentException(propertyName + \" is not specified.\");\n         }\n \n-        Set<Integer> geneIds = new HashSet<>();\n+        Set<CanonicalGene> canonicalGenes = new HashSet<CanonicalGene>();\n         String[] genes = propertyValue.split(\"\\t\");\n         for (String panelGene : genes) {\n-            Gene gene = null;\n             try {\n-                Integer geneId = Integer.parseInt(panelGene);\n-                gene = genePanelRepositoryLegacy.getGeneByEntrezGeneId(geneId);\n-                if (gene != null) {\n-                    geneIds.add(geneId);\n+                Long geneId = Long.parseLong(panelGene);\n+                CanonicalGene canonicalGene = daoGeneOptimized.getGene(geneId);\n+                if (canonicalGene != null) {\n+                    canonicalGenes.add(canonicalGene);\n                 }\n                 else {\n-                    throw new RuntimeException(\"Could not find gene in the database: \" + String.valueOf(geneId));\n+                    ProgressMonitor.logWarning(\"Could not find gene in the database: \" + String.valueOf(geneId));\n                 }\n             }\n             catch (NumberFormatException e) {\n-                gene = genePanelRepositoryLegacy.getGeneByHugoSymbol(panelGene);\n-                if (gene == null) {\n-                    gene = genePanelRepositoryLegacy.getGeneByAlias(panelGene);\n+                List<CanonicalGene> canonicalGenesList = daoGeneOptimized.getGene(panelGene, true);\n+                if (canonicalGenesList != null && !canonicalGenesList.isEmpty()) {\n+                    canonicalGenes.add(canonicalGenesList.get(0));", "originalCommit": "cf92ea92e35d1fbc5f11cb349bd10b0c8b400e38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA4NDMxNg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434084316", "bodyText": "Done.", "author": "n1zea144", "createdAt": "2020-06-02T18:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMTYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMjQzMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434022430", "bodyText": "any reason to return empty set when condition fails?", "author": "kalletlak", "createdAt": "2020-06-02T16:44:04Z", "path": "core/src/main/java/org/mskcc/cbio/portal/scripts/ImportGenePanel.java", "diffHunk": "@@ -143,39 +133,37 @@ private static String getPropertyValue(String propertyName, Properties propertie\n         return propertyValue;\n     }\n \n-    private static Set<Integer> getGenes(String propertyName, Properties properties, GenePanelRepositoryLegacy genePanelRepositoryLegacy) {\n+    private static Set<CanonicalGene> getGenes(String propertyName, Properties properties, DaoGeneOptimized daoGeneOptimized) {\n         String propertyValue = properties.getProperty(propertyName).trim();\n         if (propertyValue == null || propertyValue.length() == 0) {\n             throw new IllegalArgumentException(propertyName + \" is not specified.\");\n         }\n \n-        Set<Integer> geneIds = new HashSet<>();\n+        Set<CanonicalGene> canonicalGenes = new HashSet<CanonicalGene>();\n         String[] genes = propertyValue.split(\"\\t\");\n         for (String panelGene : genes) {\n-            Gene gene = null;\n             try {\n-                Integer geneId = Integer.parseInt(panelGene);\n-                gene = genePanelRepositoryLegacy.getGeneByEntrezGeneId(geneId);\n-                if (gene != null) {\n-                    geneIds.add(geneId);\n+                Long geneId = Long.parseLong(panelGene);\n+                CanonicalGene canonicalGene = daoGeneOptimized.getGene(geneId);\n+                if (canonicalGene != null) {\n+                    canonicalGenes.add(canonicalGene);\n                 }\n                 else {\n-                    throw new RuntimeException(\"Could not find gene in the database: \" + String.valueOf(geneId));\n+                    ProgressMonitor.logWarning(\"Could not find gene in the database: \" + String.valueOf(geneId));\n                 }\n             }\n             catch (NumberFormatException e) {\n-                gene = genePanelRepositoryLegacy.getGeneByHugoSymbol(panelGene);\n-                if (gene == null) {\n-                    gene = genePanelRepositoryLegacy.getGeneByAlias(panelGene);\n+                List<CanonicalGene> canonicalGenesList = daoGeneOptimized.getGene(panelGene, true);\n+                if (canonicalGenesList != null && !canonicalGenesList.isEmpty()) {\n+                    canonicalGenes.add(canonicalGenesList.get(0));\n                 }\n-\n-                if (gene != null) {\n-                    geneIds.add(gene.getEntrezGeneId());\n+                else {\n+                    ProgressMonitor.logWarning(\"Could not find gene in the database: \" + panelGene);\n                 }\n             }\n         }\n \n-        return geneIds;\n+        return (canonicalGenes.size() == genes.length) ? canonicalGenes : Collections.emptySet();", "originalCommit": "cf92ea92e35d1fbc5f11cb349bd10b0c8b400e38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA4NDgyOA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434084828", "bodyText": "True, maybe null is more appropriate.", "author": "n1zea144", "createdAt": "2020-06-02T18:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMjQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzNDYzOQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434034639", "bodyText": "missing indentation 67-69", "author": "kalletlak", "createdAt": "2020-06-02T17:03:50Z", "path": "core/src/test/java/org/mskcc/cbio/portal/dao/TestDaoGenePanel.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2020 Memorial Sloan-Kettering Cancer Center.\n+ *\n+ * This library is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF MERCHANTABILITY OR FITNESS\n+ * FOR A PARTICULAR PURPOSE. The software and documentation provided hereunder\n+ * is on an \"as is\" basis, and Memorial Sloan-Kettering Cancer Center has no\n+ * obligations to provide maintenance, support, updates, enhancements or\n+ * modifications. In no event shall Memorial Sloan-Kettering Cancer Center be\n+ * liable to any party for direct, indirect, special, incidental or\n+ * consequential damages, including lost profits, arising out of the use of this\n+ * software and its documentation, even if Memorial Sloan-Kettering Cancer\n+ * Center has been advised of the possibility of such damage.\n+ */\n+\n+/*\n+ * This file is part of cBioPortal.\n+ *\n+ * cBioPortal is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as\n+ * published by the Free Software Foundation, either version 3 of the\n+ * License.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+package org.mskcc.cbio.portal.dao;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mskcc.cbio.portal.dao.*;\n+import org.mskcc.cbio.portal.model.*;\n+\n+import org.springframework.test.annotation.Rollback;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import static org.junit.Assert.*;\n+\n+import java.util.*;\n+\n+/**\n+ * JUnit Tests for DaoGenePanel.\n+ */\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations = { \"classpath:/applicationContext-dao.xml\" })\n+@Rollback\n+@Transactional\n+public class TestDaoGenePanel {\n+\n+    /**\n+     * Tests DaoGenePanel.addGenePanel().\n+     * @throws DaoException Database Error.\n+     */\n+\t@Test\n+    public void testAddGenePanel() throws DaoException {\n+\n+\t\tCanonicalGene brca1 = DaoGeneOptimized.getInstance().getGene(\"BRCA1\");", "originalCommit": "cf92ea92e35d1fbc5f11cb349bd10b0c8b400e38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEwMTA5Mg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434101092", "bodyText": "Fixed.", "author": "n1zea144", "createdAt": "2020-06-02T18:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzNDYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzNTAxMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434035010", "bodyText": "missing indentation. even at line 65-68", "author": "kalletlak", "createdAt": "2020-06-02T17:04:33Z", "path": "core/src/test/java/org/mskcc/cbio/portal/dao/TestDaoSampleProfile.java", "diffHunk": "@@ -55,18 +56,29 @@\n public class TestDaoSampleProfile {\n \n \tCancerStudy study;\n+    GenePanel genePanel;", "originalCommit": "cf92ea92e35d1fbc5f11cb349bd10b0c8b400e38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEwMTQwMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7569#discussion_r434101400", "bodyText": "Fixed.", "author": "n1zea144", "createdAt": "2020-06-02T18:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzNTAxMA=="}], "type": "inlineReview"}, {"oid": "c41a4c170973f7f0d55c3054b57708dab342d25b", "url": "https://github.com/cBioPortal/cbioportal/commit/c41a4c170973f7f0d55c3054b57708dab342d25b", "message": "Disconnect gene panel code from business module.", "committedDate": "2020-06-02T18:37:41Z", "type": "forcePushed"}, {"oid": "2e0994c88086af906fb1c2b8ae67bab2f2a91137", "url": "https://github.com/cBioPortal/cbioportal/commit/2e0994c88086af906fb1c2b8ae67bab2f2a91137", "message": "Disconnect gene panel code from business module.", "committedDate": "2020-06-02T18:43:07Z", "type": "forcePushed"}, {"oid": "a17267d1e0f0c3a50d31335c46ae5589c16390ff", "url": "https://github.com/cBioPortal/cbioportal/commit/a17267d1e0f0c3a50d31335c46ae5589c16390ff", "message": "Disconnect gene panel code from business module.", "committedDate": "2020-06-03T17:07:03Z", "type": "commit"}, {"oid": "a17267d1e0f0c3a50d31335c46ae5589c16390ff", "url": "https://github.com/cBioPortal/cbioportal/commit/a17267d1e0f0c3a50d31335c46ae5589c16390ff", "message": "Disconnect gene panel code from business module.", "committedDate": "2020-06-03T17:07:03Z", "type": "forcePushed"}]}