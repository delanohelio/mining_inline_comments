{"pr_number": 3917, "pr_title": "Commands-Test should also run with JAVA_HOME", "pr_createdAt": "2020-04-15T11:02:25Z", "pr_url": "https://github.com/bndtools/bnd/pull/3917", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3ODI2MQ==", "url": "https://github.com/bndtools/bnd/pull/3917#discussion_r408778261", "bodyText": "aQute.lib.io.IO.JAVA_HOME is a static holding the location of the JAVA_HOME folder. Please use it. Also, this should be done in a @BeforeEach method rather than a static method since this is JUnit 5 test case. The @BeforeEach method can set a field with the proper java command path which is then referenced from the test methods.", "author": "bjhargrave", "createdAt": "2020-04-15T11:42:01Z", "path": "aQute.libg/test/aQute/libg/command/CommandTest.java", "diffHunk": "@@ -2,24 +2,31 @@\n \n import static org.assertj.core.api.Assertions.assertThat;\n \n+import java.util.Optional;\n+\n import org.junit.jupiter.api.Test;\n \n public class CommandTest {\n+\tprivate static String java() {\n+\t\treturn Optional.ofNullable(System.getenv(\"JAVA_HOME\"))", "originalCommit": "2ab54094d5a84d47181fa97aab4712b6c8743d3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4Mzc1Mw==", "url": "https://github.com/bndtools/bnd/pull/3917#discussion_r408783753", "bodyText": "What is the benefit to use @BeforeEach and not @BeforeAll?", "author": "stbischof", "createdAt": "2020-04-15T11:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3ODI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4Nzc2Mw==", "url": "https://github.com/bndtools/bnd/pull/3917#discussion_r408787763", "bodyText": "BeforeEach is instance based and not class based. Unless we have a real need for static initialization, we should avoid it.", "author": "bjhargrave", "createdAt": "2020-04-15T12:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3ODI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgyNTY5OA==", "url": "https://github.com/bndtools/bnd/pull/3917#discussion_r408825698", "bodyText": "I just added IO.getJavaExecutablePath(String name) to master. So you can rebase and then just do\nc.add(IO.getJavaExecutablePath(\"java\"));\nThis also means you wont need the BeforeEach!", "author": "bjhargrave", "createdAt": "2020-04-15T13:05:54Z", "path": "aQute.libg/test/aQute/libg/command/CommandTest.java", "diffHunk": "@@ -2,24 +2,45 @@\n \n import static org.assertj.core.api.Assertions.assertThat;\n \n+import java.io.File;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n public class CommandTest {\n+\tprivate String java = null;\n+\n+\t@BeforeEach\n+\tvoid init() {\n+\n+\t\tjava = Optional.ofNullable(\n+\t\t\taQute.lib.io.IO.JAVA_HOME)\n+\t\t\t.map(h -> h.toPath()\n+\t\t\t\t.resolve(\"bin\")\n+\t\t\t\t.resolve(\"java\"))\n+\t\t\t.map(Path::toFile)\n+\t\t\t.filter(File::exists)\n+\t\t\t.filter(File::isFile)\n+\t\t\t.map(File::toString)\n+\t\t\t.orElse(\"java\");\n+\t}\n \n \t@Test\n \tpublic void testSimple() throws Exception {\n \t\tCommand c = new Command();\n-\t\tc.add(\"java\");\n+\t\tc.add(java);", "originalCommit": "5cfa731fa24fe73b36ef424b39016cdd1c4357d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg2MTM2Mg==", "url": "https://github.com/bndtools/bnd/pull/3917#discussion_r408861362", "bodyText": "done", "author": "stbischof", "createdAt": "2020-04-15T13:55:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgyNTY5OA=="}], "type": "inlineReview"}, {"oid": "c4703bb69263427b4a1c109e22e16757929236e1", "url": "https://github.com/bndtools/bnd/commit/c4703bb69263427b4a1c109e22e16757929236e1", "message": "Commands-Test should also run with JAVA_HOME\n\nSigned-off-by: Stefan Bischof <stbischof@bipolis.org>", "committedDate": "2020-04-15T13:48:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4NTMyNg==", "url": "https://github.com/bndtools/bnd/pull/3917#discussion_r408885326", "bodyText": "I just realized that this will fail if the absolute path string contains a space since the full string is parsed by spaces (This is why no one should really use the full command string). So for this test method, you will need to revert to the prior state (using simple java command) and delete the final assert on the execute method. We have confirmed the execution works in testSimple and this method confirms the full argument parsing, so we can avoid the assert on the execute here.", "author": "bjhargrave", "createdAt": "2020-04-15T14:27:42Z", "path": "aQute.libg/test/aQute/libg/command/CommandTest.java", "diffHunk": "@@ -4,22 +4,24 @@\n \n import org.junit.jupiter.api.Test;\n \n+import aQute.lib.io.IO;\n+\n public class CommandTest {\n \n \t@Test\n \tpublic void testSimple() throws Exception {\n \t\tCommand c = new Command();\n-\t\tc.add(\"java\");\n+\t\tc.add(IO.getJavaExecutablePath(\"java\"));\n \t\tc.add(\"-Dx=\\\"foo bar\\\"\");\n \t\tc.add(\"-version\");\n-\t\tassertThat(c.getArguments()).containsExactly(\"java\", \"-Dx=\\\"foo bar\\\"\", \"-version\");\n+\t\tassertThat(c.getArguments()).containsExactly(IO.getJavaExecutablePath(\"java\"), \"-Dx=\\\"foo bar\\\"\", \"-version\");\n \t\tassertThat(c.execute(System.out, System.err)).isZero();\n \t}\n \n \t@Test\n \tpublic void testFull() throws Exception {\n-\t\tCommand c = new Command(\"java -Dx=\\\"foo bar\\\" -version\");\n-\t\tassertThat(c.getArguments()).containsExactly(\"java\", \"-Dx=\\\"foo bar\\\"\", \"-version\");\n+\t\tCommand c = new Command(IO.getJavaExecutablePath(\"java\") + \" -Dx=\\\"foo bar\\\" -version\");", "originalCommit": "c4703bb69263427b4a1c109e22e16757929236e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNTc4MQ==", "url": "https://github.com/bndtools/bnd/pull/3917#discussion_r408925781", "bodyText": "next try. thank you for review", "author": "stbischof", "createdAt": "2020-04-15T15:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4NTMyNg=="}], "type": "inlineReview"}, {"oid": "e9b31ecef5b3fa24cdc30f11fe2449fc1eea0564", "url": "https://github.com/bndtools/bnd/commit/e9b31ecef5b3fa24cdc30f11fe2449fc1eea0564", "message": "Commands-Test should also run with JAVA_HOME\n\nSigned-off-by: Stefan Bischof <stbischof@bipolis.org>", "committedDate": "2020-04-15T15:56:48Z", "type": "commit"}, {"oid": "e9b31ecef5b3fa24cdc30f11fe2449fc1eea0564", "url": "https://github.com/bndtools/bnd/commit/e9b31ecef5b3fa24cdc30f11fe2449fc1eea0564", "message": "Commands-Test should also run with JAVA_HOME\n\nSigned-off-by: Stefan Bischof <stbischof@bipolis.org>", "committedDate": "2020-04-15T15:56:48Z", "type": "forcePushed"}]}