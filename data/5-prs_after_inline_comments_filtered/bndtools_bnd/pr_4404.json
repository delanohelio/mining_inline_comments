{"pr_number": 4404, "pr_title": "[bndtools] Gracefully handle missing cnf", "pr_createdAt": "2020-11-10T11:42:46Z", "pr_url": "https://github.com/bndtools/bnd/pull/4404", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMTU4Nw==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r520631587", "bodyText": "You now call markers.deleteMarkers(\"*\") twice if you get an exception on Central.getProject(myProject).", "author": "bjhargrave", "createdAt": "2020-11-10T15:03:33Z", "path": "bndtools.builder/src/org/bndtools/builder/BndtoolsBuilder.java", "diffHunk": "@@ -113,15 +112,21 @@\n \t\t\t\t\t.getDynamicReferences();\n \t\t\t}\n \n-\t\t\tif (model == null) {\n-\t\t\t\ttry {\n-\t\t\t\t\tmodel = Central.getProject(myProject);\n-\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tmarkers.deleteMarkers(\"*\");\n-\t\t\t\t}\n-\t\t\t\tif (model == null)\n-\t\t\t\t\treturn noreport();\n+\t\t\tProject ourModel = null;\n+\t\t\ttry {\n+\t\t\t\tourModel = Central.getProject(myProject);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");\n \t\t\t}\n+\t\t\tif (ourModel == null) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");", "originalCommit": "595170a3e19cf2cb8aa6165d578c38be544a9c9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAyMjc3MQ==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r521022771", "bodyText": "Fixed.", "author": "kriegfrj", "createdAt": "2020-11-11T02:08:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMTU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMzM3Nw==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r520633377", "bodyText": "Should this not be cnf.isOpen()?", "author": "bjhargrave", "createdAt": "2020-11-10T15:05:54Z", "path": "bndtools.builder/src/org/bndtools/builder/MarkerSupport.java", "diffHunk": "@@ -98,7 +98,7 @@ private void deleteCnfMarkersForThisProject(String markerType) throws CoreExcept\n \t\tIProject cnf = ResourcesPlugin.getWorkspace()\n \t\t\t.getRoot()\n \t\t\t.getProject(\"cnf\");\n-\t\tif (cnf != null) {\n+\t\tif (cnf != null && cnf.exists()) {", "originalCommit": "595170a3e19cf2cb8aa6165d578c38be544a9c9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxNjY3OA==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r520916678", "bodyText": "I don't know enough about Eclipse's marker handling to know the answer to this question. Checking for existence was sufficient to stop the NPE from happening in the enclosing code if the cnf project was missing. But checking for openness is probably not a bad idea.", "author": "kriegfrj", "createdAt": "2020-11-10T22:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMzM3Nw=="}], "type": "inlineReview"}, {"oid": "08c6ac9f060d5b33edc4524e2d61b614ba1d651a", "url": "https://github.com/bndtools/bnd/commit/08c6ac9f060d5b33edc4524e2d61b614ba1d651a", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>", "committedDate": "2020-11-11T02:07:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMzNDI5Nw==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r521334297", "bodyText": "It does seem a bit presumptuous of us (Bndtools) to remove the error markers of another builder, no? I am not sure we should do this.", "author": "bjhargrave", "createdAt": "2020-11-11T12:47:28Z", "path": "bndtools.builder/src/org/bndtools/builder/BndtoolsBuilder.java", "diffHunk": "@@ -113,16 +118,57 @@\n \t\t\t\t\t.getDynamicReferences();\n \t\t\t}\n \n-\t\t\tif (model == null) {\n-\t\t\t\ttry {\n-\t\t\t\t\tmodel = Central.getProject(myProject);\n-\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\tProject ourModel = null;\n+\t\t\ttry {\n+\t\t\t\tourModel = Central.getProject(myProject);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\t\t// If the cnf project is missing there will likely be a myriad\n+\t\t\t\t// of Java problems. These do nothing but clutter the error\n+\t\t\t\t// output and make it hard to find the real problem in the\n+\t\t\t\t// problem log.\n+\t\t\t\tmyProject.deleteMarkers(IJavaModelMarker.JAVA_MODEL_PROBLEM_MARKER, true, IResource.DEPTH_INFINITE);", "originalCommit": "08c6ac9f060d5b33edc4524e2d61b614ba1d651a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3NDIwMA==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r521374200", "bodyText": "I suppose i could try and see if we can coerce the JavaBuilder to do it itself under these conditions, eg by failing the BndClasspathContainer somehow.", "author": "kriegfrj", "createdAt": "2020-11-11T13:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMzNDI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4ODEwMg==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r521388102", "bodyText": "I don't think that is a good idea or possible either. The Java builder's errors are real. They are compilation failures. And they are the responsibility of the Java builder to manage.", "author": "bjhargrave", "createdAt": "2020-11-11T14:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMzNDI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg4NTYxNg==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r521885616", "bodyText": "I disagree, but rather than hold up this PR over this issue (which is not directly related to the original problem)  I have removed the offending lines for now so that we can get it merged. We can discuss this further at another time.", "author": "kriegfrj", "createdAt": "2020-11-12T07:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMzNDI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMzNDcyNA==", "url": "https://github.com/bndtools/bnd/pull/4404#discussion_r521334724", "bodyText": "It does seem a bit presumptuous of us (Bndtools) to remove the error markers of another builder, no? I am not sure we should do this.", "author": "bjhargrave", "createdAt": "2020-11-11T12:48:19Z", "path": "bndtools.builder/src/org/bndtools/builder/BndtoolsBuilder.java", "diffHunk": "@@ -113,16 +118,57 @@\n \t\t\t\t\t.getDynamicReferences();\n \t\t\t}\n \n-\t\t\tif (model == null) {\n-\t\t\t\ttry {\n-\t\t\t\t\tmodel = Central.getProject(myProject);\n-\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\tProject ourModel = null;\n+\t\t\ttry {\n+\t\t\t\tourModel = Central.getProject(myProject);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\t\t// If the cnf project is missing there will likely be a myriad\n+\t\t\t\t// of Java problems. These do nothing but clutter the error\n+\t\t\t\t// output and make it hard to find the real problem in the\n+\t\t\t\t// problem log.\n+\t\t\t\tmyProject.deleteMarkers(IJavaModelMarker.JAVA_MODEL_PROBLEM_MARKER, true, IResource.DEPTH_INFINITE);\n+\t\t\t\tlogger.logError(\"Exception while trying to fetch bnd project for \" + myProject.getName(), e);\n+\t\t\t\tmarkers.createMarker(null, IMarker.SEVERITY_ERROR, \"Exception while trying to fetch bnd project: \" + e,\n+\t\t\t\t\tBndtoolsConstants.MARKER_BND_PATH_PROBLEM);\n+\t\t\t\treturn noreport();\n+\t\t\t}\n+\t\t\tif (ourModel == null) {\n+\t\t\t\tmarkers.deleteMarkers(\"*\");\n+\t\t\t\t// If the cnf project is missing there will likely be a myriad\n+\t\t\t\t// of Java problems. These do nothing but clutter the error\n+\t\t\t\t// output and make it hard to find the real problem in the\n+\t\t\t\t// problem log.\n+\t\t\t\tmyProject.deleteMarkers(IJavaModelMarker.JAVA_MODEL_PROBLEM_MARKER, true, IResource.DEPTH_INFINITE);", "originalCommit": "08c6ac9f060d5b33edc4524e2d61b614ba1d651a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "95b761cabdc5045e65d514e065602f6aaa4e392f", "url": "https://github.com/bndtools/bnd/commit/95b761cabdc5045e65d514e065602f6aaa4e392f", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>", "committedDate": "2020-11-12T07:11:53Z", "type": "forcePushed"}, {"oid": "4fb86a478f95a4e3d3483240cec8f9ae9eac2c60", "url": "https://github.com/bndtools/bnd/commit/4fb86a478f95a4e3d3483240cec8f9ae9eac2c60", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>", "committedDate": "2020-11-12T07:28:07Z", "type": "commit"}, {"oid": "4fb86a478f95a4e3d3483240cec8f9ae9eac2c60", "url": "https://github.com/bndtools/bnd/commit/4fb86a478f95a4e3d3483240cec8f9ae9eac2c60", "message": "[bndtools] Gracefully handle missing cnf\n\nWithout this fix, Bndtools generates an NPE during building if the\ncnf project is missing and continues to fail building even after\nthe cnf project is added (fixes #4401).\n\nAs a side effect, also introduces an error marker if the Bnd\nproject is not inside the Bnd workspace (fixes #4203).\n\nSigned-off-by: Fr Jeremy Krieg <fr.jkrieg@greekwelfaresa.org.au>", "committedDate": "2020-11-12T07:28:07Z", "type": "forcePushed"}]}