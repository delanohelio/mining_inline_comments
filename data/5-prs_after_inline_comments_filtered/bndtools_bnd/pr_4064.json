{"pr_number": 4064, "pr_title": "bndtools: use LaunchUtils to create the bndrun used in command execut\u2026", "pr_createdAt": "2020-05-17T03:04:15Z", "pr_url": "https://github.com/bndtools/bnd/pull/4064", "timeline": [{"oid": "5bb60c92a0b79c458a9bb727bc8e0c67dcd47580", "url": "https://github.com/bndtools/bnd/commit/5bb60c92a0b79c458a9bb727bc8e0c67dcd47580", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>", "committedDate": "2020-05-17T03:49:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI2MTUxMw==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426261513", "bodyText": "This seems like a perfect place for a memoizier to get lazy initialization and it will properly handle the synchronization for at-most-once initialization.", "author": "bjhargrave", "createdAt": "2020-05-17T13:26:57Z", "path": "bndtools.core/src/bndtools/command/BndrunFilesParameterValues.java", "diffHunk": "@@ -33,25 +31,21 @@\n \n \t@Override\n \tpublic Map getParameterValues() {\n-\t\tWorkspace ws = Central.getWorkspaceIfPresent();\n+\t\tif (bndrunFilesMap != null) {", "originalCommit": "5bb60c92a0b79c458a9bb727bc8e0c67dcd47580", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI2NzgwNQ==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426267805", "bodyText": "yeah we should, I'll try my hand at it.", "author": "rotty3000", "createdAt": "2020-05-17T14:27:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI2MTUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3MjczMg==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426272732", "bodyText": "check it now!", "author": "rotty3000", "createdAt": "2020-05-17T15:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI2MTUxMw=="}], "type": "inlineReview"}, {"oid": "217a2befc452c8243050f75828d414d11c3bde1e", "url": "https://github.com/bndtools/bnd/commit/217a2befc452c8243050f75828d414d11c3bde1e", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>", "committedDate": "2020-05-17T15:15:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3MzQ1Mw==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426273453", "bodyText": "Perhaps you don't want to add the listener in the supplier since you will get an additional listener every time reset is called and the new memoized is initialized. Then each listener will further call reset...\nI think you just need to add the listener in the constructor.", "author": "bjhargrave", "createdAt": "2020-05-17T15:24:12Z", "path": "bndtools.core/src/bndtools/command/BndrunFilesParameterValues.java", "diffHunk": "@@ -21,44 +23,40 @@\n import org.eclipse.core.runtime.CoreException;\n import org.eclipse.core.runtime.IPath;\n \n-import aQute.bnd.build.Workspace;\n-import bndtools.central.Central;\n+import aQute.lib.memoize.Memoize;\n \n public class BndrunFilesParameterValues implements IParameterValues {\n \n \tstatic final String BNDRUN_FILE = \"bnd.command.bndrunFile\";\n \n-\tprivate static Map<String, String> bndrunFilesMap;\n-\tprivate static IResourceChangeListener\tlistener\t= new InvalidateMapListener();\n+\tprivate IResourceChangeListener\t\t\t\t\tlistener\t= new InvalidateMapListener();\n+\tprivate volatile Supplier<Map<String, String>>\tbndrunFilesMap;\n+\n+\tpublic BndrunFilesParameterValues() {\n+\t\tbndrunFilesMap = reset();\n+\t}\n+\n+\tSupplier<Map<String, String>> reset() {\n+\t\treturn Memoize.referenceSupplier(() -> {\n+\t\t\tMap<String, String> map = Arrays.stream(ResourcesPlugin.getWorkspace()\n+\t\t\t\t.getRoot()\n+\t\t\t\t.getProjects())\n+\t\t\t\t.filter(IProject::isOpen)\n+\t\t\t\t.map(this::findBndrunFiles)\n+\t\t\t\t.flatMap(Collection::stream)\n+\t\t\t\t.map(IResource::getFullPath)\n+\t\t\t\t.collect(toMap(IPath::toPortableString, IPath::toPortableString));\n+\n+\t\t\tResourcesPlugin.getWorkspace()", "originalCommit": "217a2befc452c8243050f75828d414d11c3bde1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3Mzg2MQ==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426273861", "bodyText": "fixed", "author": "rotty3000", "createdAt": "2020-05-17T15:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3MzQ1Mw=="}], "type": "inlineReview"}, {"oid": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "url": "https://github.com/bndtools/bnd/commit/a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>", "committedDate": "2020-05-17T15:28:09Z", "type": "commit"}, {"oid": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "url": "https://github.com/bndtools/bnd/commit/a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "message": "bndtools: use LaunchUtils to create the bndrun used in command executions and support m2e\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>", "committedDate": "2020-05-17T15:28:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzU3NA==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426303574", "bodyText": "Hey @rotty3000   Thanks for wiring this up with Maven support!\nWhy did you want to predicate this on being a bndProject.  Will that match maven projects?", "author": "gamerson", "createdAt": "2020-05-17T20:50:58Z", "path": "bndtools.core/src/bndtools/command/BndResolveHandler.java", "diffHunk": "@@ -37,13 +37,13 @@ public Object execute(ExecutionEvent event) throws ExecutionException {\n \t\t\tpublic IStatus runInWorkspace(IProgressMonitor monitor) throws CoreException {\n \t\t\t\tIStatus status = Status.OK_STATUS;\n \t\t\t\ttry {\n-\t\t\t\t\tBndrun bndrun = Bndrun.createBndrun(Central.getWorkspace(), new File(bndrunFile.getLocationURI()));\n-\t\t\t\t\tProject bndProject = Central.getProject(project);\n-\t\t\t\t\tbndrun.setBase(bndProject.getBase());\n+\t\t\t\t\tBndrun bndrun = (Bndrun) LaunchUtils.createRun(bndrunFile, RunMode.LAUNCH);\n \n \t\t\t\t\tbndrun.resolve(false, true);\n \n-\t\t\t\t\tbndrunFile.refreshLocal(IResource.DEPTH_ONE, monitor);\n+\t\t\t\t\tif (Central.isBndProject(project)) {", "originalCommit": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwNDQ5Mg==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426304492", "bodyText": "Because in M2E these files are already being monitored and would result in an infinite loop if I added this other propagation.", "author": "rotty3000", "createdAt": "2020-05-17T21:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzc3OQ==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426303779", "bodyText": "By changing this to non-static, every command that shared this ParameterValues map is going to recalculate.  So right now we have 2 commands but in the future we may want more.  I don't think this is a huge performance hit right now, but if we have N commands, then there will be N copies of this class and N copies of the bndrunFilesMap.  Do y'all think that will be an issue?  Maybe not since there will not be an abundance of bndfiles usually.", "author": "gamerson", "createdAt": "2020-05-17T20:53:18Z", "path": "bndtools.core/src/bndtools/command/BndrunFilesParameterValues.java", "diffHunk": "@@ -21,44 +22,37 @@\n import org.eclipse.core.runtime.CoreException;\n import org.eclipse.core.runtime.IPath;\n \n-import aQute.bnd.build.Workspace;\n-import bndtools.central.Central;\n+import aQute.lib.memoize.Memoize;\n \n public class BndrunFilesParameterValues implements IParameterValues {\n \n \tstatic final String BNDRUN_FILE = \"bnd.command.bndrunFile\";\n \n-\tprivate static Map<String, String> bndrunFilesMap;\n-\tprivate static IResourceChangeListener\tlistener\t= new InvalidateMapListener();\n+\tprivate IResourceChangeListener\t\t\t\t\tlistener\t= new InvalidateMapListener();\n+\tprivate volatile Supplier<Map<String, String>>\tbndrunFilesMap;", "originalCommit": "a5e8bdb38cf6c6c21bdc67066a89b561fff4f2fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwNDU3OA==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426304578", "bodyText": "Got it! I can turn it back into static.", "author": "rotty3000", "createdAt": "2020-05-17T21:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5NzcxMA==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426797710", "bodyText": "Hey Ray, It seems the bndrunFilesMap didn't get switched back to static.  Change of plans?", "author": "gamerson", "createdAt": "2020-05-18T17:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwMzg1Mw==", "url": "https://github.com/bndtools/bnd/pull/4064#discussion_r426803853", "bodyText": "No sorry, will do momentarily!", "author": "rotty3000", "createdAt": "2020-05-18T18:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzc3OQ=="}], "type": "inlineReview"}]}