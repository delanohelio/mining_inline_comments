{"pr_number": 4151, "pr_title": "Insert Menu for plugins and Syntax based values", "pr_createdAt": "2020-06-09T13:00:51Z", "pr_url": "https://github.com/bndtools/bnd/pull/4151", "timeline": [{"oid": "10948260e0d405d93cf6cf7487cf98b16bd69f0e", "url": "https://github.com/bndtools/bnd/commit/10948260e0d405d93cf6cf7487cf98b16bd69f0e", "message": "[plugins] Updated BndPlugin annotation to support capabilities\n\nTo be able to insert plugins, this patch adds support to the\n(so far mostly unused) BndPlugin annotation we've applied to the\nbnd internal plugins.\n\nThis adds a Capability defined in the InternalPluginNamespace.\n\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>", "committedDate": "2020-06-09T12:53:30Z", "type": "commit"}, {"oid": "edc4051eec6d43a2085dc712f6d2ab45f8d8db61", "url": "https://github.com/bndtools/bnd/commit/edc4051eec6d43a2085dc712f6d2ab45f8d8db61", "message": "[insert] Adds a number of insert menus\n\n- Insert plugin based on the bndplugin annotation\n- Syntax based\n  - Insert instruction example\n  - Insert header\n  - Insert macro\n\nThis patch uses the Internal Plugin Namespace to find\nthe name and optional configuration of the plugins. It\nthen adds the plugin to the existing -plugin or creates\na new one. This is done using BndEditModel so it should\nfollow all the rules\n\nWhile being there, I also added insert menus based \non the Syntax class. \n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>", "committedDate": "2020-06-09T12:58:25Z", "type": "commit"}, {"oid": "da295869db3c15fe15bd7d3f86dbfd81bea87dbe", "url": "https://github.com/bndtools/bnd/commit/da295869db3c15fe15bd7d3f86dbfd81bea87dbe", "message": "[plugins] Added hide to plugins \n\nSome plugins are internal (I think) and should not\nshow on the insert menu.\n\n\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>", "committedDate": "2020-06-09T12:59:21Z", "type": "commit"}, {"oid": "59f4224b085c058abee7da7c8feddfe99d86da87", "url": "https://github.com/bndtools/bnd/commit/59f4224b085c058abee7da7c8feddfe99d86da87", "message": "removed duplicate file\n\nSigned-off-by: Peter Kriens <Peter.Kriens@aqute.biz>", "committedDate": "2020-06-09T12:59:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzMjQ5Mg==", "url": "https://github.com/bndtools/bnd/pull/4151#discussion_r437432492", "bodyText": "Isn't configuration.getAnnotation(ObjectClassDefinition.class) always null since ObjectClassDefinition is class retention and thus not visible at runtime?", "author": "bjhargrave", "createdAt": "2020-06-09T13:47:32Z", "path": "bndtools.core/src/bndtools/central/InternalPluginTracker.java", "diffHunk": "@@ -0,0 +1,135 @@\n+package bndtools.central;\n+\n+import java.lang.reflect.Method;\n+import java.util.Formatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+import java.util.stream.Collectors;\n+\n+import org.osgi.framework.Bundle;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.BundleEvent;\n+import org.osgi.framework.wiring.BundleRevision;\n+import org.osgi.resource.Capability;\n+import org.osgi.service.metatype.annotations.AttributeDefinition;\n+import org.osgi.service.metatype.annotations.ObjectClassDefinition;\n+import org.osgi.util.tracker.BundleTracker;\n+\n+import aQute.bnd.annotation.plugin.InternalPluginDefinition;\n+import aQute.bnd.annotation.plugin.InternalPluginNamespace;\n+import aQute.bnd.osgi.Processor;\n+\n+public class InternalPluginTracker extends BundleTracker<List<InternalPluginDefinition>> {\n+\n+\tpublic InternalPluginTracker(BundleContext context) {\n+\t\tsuper(context, Bundle.ACTIVE + Bundle.STARTING, null);\n+\t}\n+\n+\t@Override\n+\tpublic List<InternalPluginDefinition> addingBundle(Bundle bundle, BundleEvent event) {\n+\t\tBundleRevision revision = bundle.adapt(BundleRevision.class);\n+\t\tList<Capability> capabilities = revision.getCapabilities(InternalPluginNamespace.NAMESPACE);\n+\t\tif (capabilities.isEmpty())\n+\t\t\treturn null;\n+\n+\t\treturn capabilities.stream()\n+\t\t\t.map(cap -> capToDef(bundle, cap))\n+\t\t\t.filter(Objects::nonNull)\n+\t\t\t.collect(Collectors.toList());\n+\t}\n+\n+\tprivate InternalPluginDefinition capToDef(Bundle bundle, Capability cap) {\n+\n+\t\ttry {\n+\t\t\tString name = (String) cap.getAttributes()\n+\t\t\t\t.get(InternalPluginNamespace.NAME_A);\n+\t\t\tString key = (String) cap.getAttributes()\n+\t\t\t\t.get(InternalPluginNamespace.IMPLEMENTATION_A);\n+\n+\t\t\tClass<?> implementation = name == null ? null : bundle.loadClass(key);\n+\t\t\tkey = (String) cap.getAttributes()\n+\t\t\t\t.get(InternalPluginNamespace.PARAMETERS_A);\n+\t\t\tClass<?> configuration = key == null ? null : bundle.loadClass(key);\n+\n+\t\t\tObject value = cap.getAttributes()\n+\t\t\t\t.get(\"hide\");\n+\t\t\tboolean hide = value != null && Processor.isTrue(value.toString());\n+\n+\t\t\treturn new InternalPluginDefinition() {\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic String getTemplate() {\n+\t\t\t\t\treturn InternalPluginTracker.getTemplate(name, implementation, configuration);\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic String getName() {\n+\t\t\t\t\treturn name;\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic Class<?> getImplementation() {\n+\t\t\t\t\treturn implementation;\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic Optional<Class<?>> getParameters() {\n+\t\t\t\t\treturn Optional.ofNullable(configuration);\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic boolean isHidden() {\n+\t\t\t\t\treturn hide;\n+\t\t\t\t}\n+\t\t\t};\n+\t\t} catch (ClassNotFoundException e) {\n+\t\t\treturn null;\n+\t\t}\n+\t}\n+\n+\tstatic String getTemplate(String name, Class<?> implementation, Class<?> configuration) {\n+\t\ttry (Formatter sb = new Formatter()) {\n+\t\t\tObjectClassDefinition od = configuration != null ? configuration.getAnnotation(ObjectClassDefinition.class)", "originalCommit": "edc4051eec6d43a2085dc712f6d2ab45f8d8db61", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzMjk1MQ==", "url": "https://github.com/bndtools/bnd/pull/4151#discussion_r437432951", "bodyText": "Same here, this would also always be null, no?", "author": "bjhargrave", "createdAt": "2020-06-09T13:47:56Z", "path": "bndtools.core/src/bndtools/central/InternalPluginTracker.java", "diffHunk": "@@ -0,0 +1,135 @@\n+package bndtools.central;\n+\n+import java.lang.reflect.Method;\n+import java.util.Formatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+import java.util.stream.Collectors;\n+\n+import org.osgi.framework.Bundle;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.BundleEvent;\n+import org.osgi.framework.wiring.BundleRevision;\n+import org.osgi.resource.Capability;\n+import org.osgi.service.metatype.annotations.AttributeDefinition;\n+import org.osgi.service.metatype.annotations.ObjectClassDefinition;\n+import org.osgi.util.tracker.BundleTracker;\n+\n+import aQute.bnd.annotation.plugin.InternalPluginDefinition;\n+import aQute.bnd.annotation.plugin.InternalPluginNamespace;\n+import aQute.bnd.osgi.Processor;\n+\n+public class InternalPluginTracker extends BundleTracker<List<InternalPluginDefinition>> {\n+\n+\tpublic InternalPluginTracker(BundleContext context) {\n+\t\tsuper(context, Bundle.ACTIVE + Bundle.STARTING, null);\n+\t}\n+\n+\t@Override\n+\tpublic List<InternalPluginDefinition> addingBundle(Bundle bundle, BundleEvent event) {\n+\t\tBundleRevision revision = bundle.adapt(BundleRevision.class);\n+\t\tList<Capability> capabilities = revision.getCapabilities(InternalPluginNamespace.NAMESPACE);\n+\t\tif (capabilities.isEmpty())\n+\t\t\treturn null;\n+\n+\t\treturn capabilities.stream()\n+\t\t\t.map(cap -> capToDef(bundle, cap))\n+\t\t\t.filter(Objects::nonNull)\n+\t\t\t.collect(Collectors.toList());\n+\t}\n+\n+\tprivate InternalPluginDefinition capToDef(Bundle bundle, Capability cap) {\n+\n+\t\ttry {\n+\t\t\tString name = (String) cap.getAttributes()\n+\t\t\t\t.get(InternalPluginNamespace.NAME_A);\n+\t\t\tString key = (String) cap.getAttributes()\n+\t\t\t\t.get(InternalPluginNamespace.IMPLEMENTATION_A);\n+\n+\t\t\tClass<?> implementation = name == null ? null : bundle.loadClass(key);\n+\t\t\tkey = (String) cap.getAttributes()\n+\t\t\t\t.get(InternalPluginNamespace.PARAMETERS_A);\n+\t\t\tClass<?> configuration = key == null ? null : bundle.loadClass(key);\n+\n+\t\t\tObject value = cap.getAttributes()\n+\t\t\t\t.get(\"hide\");\n+\t\t\tboolean hide = value != null && Processor.isTrue(value.toString());\n+\n+\t\t\treturn new InternalPluginDefinition() {\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic String getTemplate() {\n+\t\t\t\t\treturn InternalPluginTracker.getTemplate(name, implementation, configuration);\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic String getName() {\n+\t\t\t\t\treturn name;\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic Class<?> getImplementation() {\n+\t\t\t\t\treturn implementation;\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic Optional<Class<?>> getParameters() {\n+\t\t\t\t\treturn Optional.ofNullable(configuration);\n+\t\t\t\t}\n+\n+\t\t\t\t@Override\n+\t\t\t\tpublic boolean isHidden() {\n+\t\t\t\t\treturn hide;\n+\t\t\t\t}\n+\t\t\t};\n+\t\t} catch (ClassNotFoundException e) {\n+\t\t\treturn null;\n+\t\t}\n+\t}\n+\n+\tstatic String getTemplate(String name, Class<?> implementation, Class<?> configuration) {\n+\t\ttry (Formatter sb = new Formatter()) {\n+\t\t\tObjectClassDefinition od = configuration != null ? configuration.getAnnotation(ObjectClassDefinition.class)\n+\t\t\t\t: null;\n+\n+\t\t\tMap<String, Method> used = new TreeMap<>();\n+\t\t\tif (configuration != null) {\n+\t\t\t\tfor (Method m : configuration.getMethods()) {\n+\n+\t\t\t\t\tif (m.getDeclaringClass() != configuration)\n+\t\t\t\t\t\tcontinue;\n+\n+\t\t\t\t\tDeprecated deprecated = m.getAnnotation(Deprecated.class);\n+\t\t\t\t\tif (deprecated != null)\n+\t\t\t\t\t\tcontinue;\n+\n+\t\t\t\t\tif (used.containsKey(m.getName()))\n+\t\t\t\t\t\tcontinue;\n+\t\t\t\t\tused.put(m.getName(), m);\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\tsb.format(\"%s\", implementation.getName());\n+\n+\t\t\tfor (Method m : used.values()) {\n+\t\t\t\tString description = \"\";\n+\t\t\t\tString deflt = \"\";\n+\t\t\t\tboolean required = true;\n+\n+\t\t\t\tAttributeDefinition ad = m.getAnnotation(AttributeDefinition.class);", "originalCommit": "edc4051eec6d43a2085dc712f6d2ab45f8d8db61", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}