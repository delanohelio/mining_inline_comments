{"pr_number": 1122, "pr_title": "vnext sample appservice", "pr_createdAt": "2020-03-19T08:26:01Z", "pr_url": "https://github.com/Azure/azure-libraries-for-java/pull/1122", "timeline": [{"oid": "3bb6095b4d86fdfc33ccfac2cad9ccdbfa7668ba", "url": "https://github.com/Azure/azure-libraries-for-java/commit/3bb6095b4d86fdfc33ccfac2cad9ccdbfa7668ba", "message": "move sample", "committedDate": "2020-03-12T04:23:20Z", "type": "commit"}, {"oid": "d425a65cd1a37ce6b3dd6f3e3e41e1a29490b8e4", "url": "https://github.com/Azure/azure-libraries-for-java/commit/d425a65cd1a37ce6b3dd6f3e3e41e1a29490b8e4", "message": "use sdkContext", "committedDate": "2020-03-13T02:40:35Z", "type": "commit"}, {"oid": "60337fff2f58ec7481f4ca59ddc3ec3cdf2cabc2", "url": "https://github.com/Azure/azure-libraries-for-java/commit/60337fff2f58ec7481f4ca59ddc3ec3cdf2cabc2", "message": "Merge branch 'vnext' into vnext_sample_appservice", "committedDate": "2020-03-17T02:58:42Z", "type": "commit"}, {"oid": "c6d3daf195df638b5efd4debafb4427d9693482b", "url": "https://github.com/Azure/azure-libraries-for-java/commit/c6d3daf195df638b5efd4debafb4427d9693482b", "message": "simple syntax migration", "committedDate": "2020-03-18T08:55:35Z", "type": "commit"}, {"oid": "eafcffb8ba89095d628e0edffe6966215a1abb8c", "url": "https://github.com/Azure/azure-libraries-for-java/commit/eafcffb8ba89095d628e0edffe6966215a1abb8c", "message": "update tests", "committedDate": "2020-03-18T08:58:20Z", "type": "commit"}, {"oid": "760fca90c9c26cbdde85bdb33906ac09765e5f1d", "url": "https://github.com/Azure/azure-libraries-for-java/commit/760fca90c9c26cbdde85bdb33906ac09765e5f1d", "message": "more fixes", "committedDate": "2020-03-19T02:08:03Z", "type": "commit"}, {"oid": "75404d9964437def8d4c2ba382b3f3f3c7f861bc", "url": "https://github.com/Azure/azure-libraries-for-java/commit/75404d9964437def8d4c2ba382b3f3f3c7f861bc", "message": "Merge branch 'vnext' into vnext_sample_appservice", "committedDate": "2020-03-19T02:16:03Z", "type": "commit"}, {"oid": "089eae72f051730bb33932f55efc68d84fe33228", "url": "https://github.com/Azure/azure-libraries-for-java/commit/089eae72f051730bb33932f55efc68d84fe33228", "message": "update keyvault client", "committedDate": "2020-03-19T02:24:07Z", "type": "commit"}, {"oid": "ed192b9cd98e4a8852c52b39ac14aa209d7dc4ef", "url": "https://github.com/Azure/azure-libraries-for-java/commit/ed192b9cd98e4a8852c52b39ac14aa209d7dc4ef", "message": "update storage client", "committedDate": "2020-03-19T05:11:38Z", "type": "commit"}, {"oid": "ff303083fb347b292558b284d7377e7fbbb1dc66", "url": "https://github.com/Azure/azure-libraries-for-java/commit/ff303083fb347b292558b284d7377e7fbbb1dc66", "message": "test pass for them", "committedDate": "2020-03-19T06:36:17Z", "type": "commit"}, {"oid": "68bcf3ae525d515a61c9cea28223e065035dfd6b", "url": "https://github.com/Azure/azure-libraries-for-java/commit/68bcf3ae525d515a61c9cea28223e065035dfd6b", "message": "appservice sample pass and recorded", "committedDate": "2020-03-19T08:00:33Z", "type": "commit"}, {"oid": "d83982af0c32df2298fd1e9292945e5b179704f5", "url": "https://github.com/Azure/azure-libraries-for-java/commit/d83982af0c32df2298fd1e9292945e5b179704f5", "message": "revert pom", "committedDate": "2020-03-19T08:24:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg1OTQ3MA==", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1122#discussion_r394859470", "bodyText": "@xccc-msft this is migrate to latest storage blob client. might be helpful if you need migrate in compute.", "author": "weidongxu-microsoft", "createdAt": "2020-03-19T08:28:44Z", "path": "azure-samples/src/main/java/com/azure/management/appservice/samples/ManageLinuxWebAppStorageAccountConnection.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Copyright (c) Microsoft Corporation. All rights reserved.\n+ * Licensed under the MIT License. See License.txt in the project root for\n+ * license information.\n+ */\n+\n+package com.azure.management.appservice.samples;\n+\n+import com.azure.management.Azure;\n+import com.azure.management.appservice.ConnectionStringType;\n+import com.azure.management.appservice.PricingTier;\n+import com.azure.management.appservice.WebApp;\n+import com.azure.management.resources.fluentcore.arm.Region;\n+import com.azure.management.resources.fluentcore.utils.SdkContext;\n+import com.azure.management.samples.Utils;\n+import com.azure.management.storage.StorageAccount;\n+import com.azure.core.http.policy.HttpLogOptions;\n+import com.azure.core.http.policy.HttpLogDetailLevel;\n+import com.azure.storage.blob.BlobClient;\n+import com.azure.storage.blob.BlobContainerClient;\n+import com.azure.storage.blob.BlobContainerClientBuilder;\n+import com.azure.storage.blob.models.BlobAccessPolicy;\n+import com.azure.storage.blob.models.BlobSignedIdentifier;\n+import com.azure.storage.blob.models.PublicAccessType;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.time.OffsetDateTime;\n+import java.util.Collections;\n+\n+\n+/**\n+ * Azure App Service basic sample for managing web apps.\n+ *  - Create a storage account and upload a couple blobs\n+ *  - Create a web app that contains the connection string to the storage account\n+ *  - Deploy a Tomcat application that reads from the storage account\n+ *  - Clean up\n+ */\n+public final class ManageLinuxWebAppStorageAccountConnection {\n+\n+    /**\n+     * Main function which runs the actual sample.\n+     * @param azure instance of the azure client\n+     * @return true if sample runs successfully\n+     */\n+    public static boolean runSample(Azure azure) {\n+        // New resources\n+        final String suffix         = \".azurewebsites.net\";\n+        final String app1Name       = azure.sdkContext().randomResourceName(\"webapp1-\", 20);\n+        final String app1Url        = app1Name + suffix;\n+        final String storageName    = azure.sdkContext().randomResourceName(\"jsdkstore\", 20);\n+        final String containerName  = azure.sdkContext().randomResourceName(\"jcontainer\", 20);\n+        final String rgName         = azure.sdkContext().randomResourceName(\"rg1NEMV_\", 24);\n+\n+        try {\n+\n+            //============================================================\n+            // Create a storage account for the web app to use\n+\n+            System.out.println(\"Creating storage account \" + storageName + \"...\");\n+\n+            StorageAccount storageAccount = azure.storageAccounts().define(storageName)\n+                    .withRegion(Region.US_WEST)\n+                    .withNewResourceGroup(rgName)\n+                    .create();\n+\n+            String accountKey = storageAccount.getKeys().get(0).getValue();\n+\n+            String connectionString = String.format(\"DefaultEndpointsProtocol=https;AccountName=%s;AccountKey=%s\",\n+                    storageAccount.name(), accountKey);\n+\n+            System.out.println(\"Created storage account \" + storageAccount.name());\n+\n+            //============================================================\n+            // Upload a few files to the storage account blobs\n+\n+            System.out.println(\"Uploading 2 blobs to container \" + containerName + \"...\");\n+\n+            BlobContainerClient container = setUpStorageAccount(connectionString, containerName);\n+            uploadFileToContainer(container, \"helloworld.war\", ManageLinuxWebAppStorageAccountConnection.class.getResource(\"/helloworld.war\").getPath());\n+            uploadFileToContainer(container, \"install_apache.sh\", ManageLinuxWebAppStorageAccountConnection.class.getResource(\"/install_apache.sh\").getPath());\n+\n+            System.out.println(\"Uploaded 2 blobs to container \" + container.getBlobContainerName());\n+\n+            //============================================================\n+            // Create a web app with a new app service plan\n+\n+            System.out.println(\"Creating web app \" + app1Name + \"...\");\n+\n+            WebApp app1 = azure.webApps().define(app1Name)\n+                    .withRegion(Region.US_WEST)\n+                    .withExistingResourceGroup(rgName)\n+                    .withNewLinuxPlan(PricingTier.STANDARD_S1)\n+                    .withPublicDockerHubImage(\"tomcat:8-jre8\")\n+                    .withStartUpCommand(\"/bin/bash -c \\\"sed -ie 's/appBase=\\\\\\\"webapps\\\\\\\"/appBase=\\\\\\\"\\\\\\\\/home\\\\\\\\/site\\\\\\\\/wwwroot\\\\\\\\/webapps\\\\\\\"/g' conf/server.xml && catalina.sh run\\\"\")\n+                    .withConnectionString(\"storage.connectionString\", connectionString, ConnectionStringType.CUSTOM)\n+                    .withAppSetting(\"storage.containerName\", containerName)\n+                    .withAppSetting(\"PORT\", \"8080\")\n+                    .create();\n+\n+            System.out.println(\"Created web app \" + app1.name());\n+            Utils.print(app1);\n+\n+            //============================================================\n+            // Deploy a web app that connects to the storage account\n+            // Source code: https://github.com/jianghaolu/azure-samples-blob-explorer\n+\n+            System.out.println(\"Deploying azure-samples-blob-traverser.war to \" + app1Name + \" through FTP...\");\n+\n+            Utils.uploadFileToWebApp(app1.getPublishingProfile(), \"azure-samples-blob-traverser.war\", ManageLinuxWebAppStorageAccountConnection.class.getResourceAsStream(\"/azure-samples-blob-traverser.war\"));\n+\n+            System.out.println(\"Deployment azure-samples-blob-traverser.war to web app \" + app1.name() + \" completed\");\n+            Utils.print(app1);\n+\n+            // warm up\n+            System.out.println(\"Warming up \" + app1Url + \"/azure-samples-blob-traverser...\");\n+            Utils.curl(\"http://\" + app1Url + \"/azure-samples-blob-traverser/\");\n+            SdkContext.sleep(5000);\n+            System.out.println(\"CURLing \" + app1Url + \"/azure-samples-blob-traverser...\");\n+            System.out.println(Utils.curl(\"http://\" + app1Url + \"/azure-samples-blob-traverser/\"));\n+\n+            return true;\n+        } catch (Exception e) {\n+            System.err.println(e.getMessage());\n+            e.printStackTrace();\n+        } finally {\n+            try {\n+                System.out.println(\"Deleting Resource Group: \" + rgName);\n+                azure.resourceGroups().beginDeleteByName(rgName);\n+                System.out.println(\"Deleted Resource Group: \" + rgName);\n+            } catch (NullPointerException npe) {\n+                System.out.println(\"Did not create any resources in Azure. No clean up is necessary\");\n+            } catch (Exception g) {\n+                g.printStackTrace();\n+            }\n+        }\n+        return false;\n+    }\n+    /**\n+     * Main entry point.\n+     * @param args the parameters\n+     */\n+    public static void main(String[] args) {\n+\n+        try {\n+\n+            //=============================================================\n+            // Authenticate\n+\n+            final File credFile = new File(System.getenv(\"AZURE_AUTH_LOCATION\"));\n+\n+            Azure azure = Azure.configure()\n+                    .withLogOptions(new HttpLogOptions().setLogLevel(HttpLogDetailLevel.BASIC))\n+                    .authenticate(credFile)\n+                    .withDefaultSubscription();\n+\n+            // Print selected subscription\n+            System.out.println(\"Selected subscription: \" + azure.subscriptionId());\n+\n+            runSample(azure);\n+        } catch (Exception e) {\n+            System.out.println(e.getMessage());\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    private static BlobContainerClient setUpStorageAccount(String connectionString, String containerName) {\n+        BlobContainerClient blobContainerClient = new BlobContainerClientBuilder()\n+                .connectionString(connectionString)\n+                .containerName(containerName)\n+                .buildClient();\n+\n+        blobContainerClient.create();\n+\n+        BlobSignedIdentifier identifier = new BlobSignedIdentifier()\n+                .setId(\"webapp\")\n+                .setAccessPolicy(new BlobAccessPolicy()\n+                        .setStartsOn(OffsetDateTime.now())\n+                        .setExpiresOn(OffsetDateTime.now().plusDays(7))\n+                        .setPermissions(\"rl\"));\n+\n+        blobContainerClient.setAccessPolicy(PublicAccessType.CONTAINER, Collections.singletonList(identifier));\n+\n+        return blobContainerClient;\n+    }\n+\n+    private static void uploadFileToContainer(BlobContainerClient blobContainerClient, String fileName, String filePath) {\n+        BlobClient blobClient = blobContainerClient.getBlobClient(fileName);\n+        File file = new File(fileName);\n+        try (InputStream is = new FileInputStream(file)) {\n+            blobClient.upload(is, file.length());\n+        } catch (IOException e) {\n+            System.out.println(e.getMessage());\n+            e.printStackTrace();\n+        }\n+    }\n+}", "originalCommit": "d83982af0c32df2298fd1e9292945e5b179704f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c936ab03883ad97c42d6539d48f3ac6f29bbb565", "url": "https://github.com/Azure/azure-libraries-for-java/commit/c936ab03883ad97c42d6539d48f3ac6f29bbb565", "message": "fix server issue", "committedDate": "2020-03-19T09:02:14Z", "type": "commit"}, {"oid": "ffb1bff7f932772f5ad2772802ab37910c7db574", "url": "https://github.com/Azure/azure-libraries-for-java/commit/ffb1bff7f932772f5ad2772802ab37910c7db574", "message": "minor change", "committedDate": "2020-03-20T02:07:46Z", "type": "commit"}, {"oid": "5605555db6c8c6806cb4e2d9c9c3f5d0bc41de6d", "url": "https://github.com/Azure/azure-libraries-for-java/commit/5605555db6c8c6806cb4e2d9c9c3f5d0bc41de6d", "message": "fix bug", "committedDate": "2020-03-20T04:20:07Z", "type": "commit"}, {"oid": "0fd4759115c9abb5154afbd3a5ea05134a9d02e8", "url": "https://github.com/Azure/azure-libraries-for-java/commit/0fd4759115c9abb5154afbd3a5ea05134a9d02e8", "message": "fix bug", "committedDate": "2020-03-20T04:22:20Z", "type": "commit"}, {"oid": "0c41997e729acfeb391ff6ab644416fa7514e622", "url": "https://github.com/Azure/azure-libraries-for-java/commit/0c41997e729acfeb391ff6ab644416fa7514e622", "message": "fix bug", "committedDate": "2020-03-20T04:27:19Z", "type": "commit"}, {"oid": "f05d12644d47461c8ae9a16723d30e958e86da4c", "url": "https://github.com/Azure/azure-libraries-for-java/commit/f05d12644d47461c8ae9a16723d30e958e86da4c", "message": "fix sample error, linux need to use _ instead of ., modified war", "committedDate": "2020-03-20T06:33:57Z", "type": "commit"}, {"oid": "312224d3bbae3f5779b3c4d7d8df14ebae0c0e49", "url": "https://github.com/Azure/azure-libraries-for-java/commit/312224d3bbae3f5779b3c4d7d8df14ebae0c0e49", "message": "fix bug", "committedDate": "2020-03-20T07:58:33Z", "type": "commit"}, {"oid": "4b8f0e68904f150bf880b0903b39065d7bbcf846", "url": "https://github.com/Azure/azure-libraries-for-java/commit/4b8f0e68904f150bf880b0903b39065d7bbcf846", "message": "Merge branch 'vnext' into vnext_sample_appservice", "committedDate": "2020-03-23T03:48:51Z", "type": "commit"}, {"oid": "404af2b5bd6e7aa4888b77ea7e91d3c7cfb1c440", "url": "https://github.com/Azure/azure-libraries-for-java/commit/404af2b5bd6e7aa4888b77ea7e91d3c7cfb1c440", "message": "use built-in image", "committedDate": "2020-03-23T05:01:35Z", "type": "commit"}]}