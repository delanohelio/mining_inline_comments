{"pr_number": 2152, "pr_title": "SOLR-14034: remove deprecated min_rf references", "pr_createdAt": "2020-12-17T09:17:47Z", "pr_url": "https://github.com/apache/lucene-solr/pull/2152", "timeline": [{"oid": "dfea13589d7a352433da5e4ba3ebffcddbbc1798", "url": "https://github.com/apache/lucene-solr/commit/dfea13589d7a352433da5e4ba3ebffcddbbc1798", "message": "Removed min_rf and MIN_REPFACT parameter references", "committedDate": "2020-12-17T00:14:24Z", "type": "commit"}, {"oid": "72dea2e333832ca561f41c92b042ac398296d5b3", "url": "https://github.com/apache/lucene-solr/commit/72dea2e333832ca561f41c92b042ac398296d5b3", "message": "Added SOLR-14034 to CHANGES.txt", "committedDate": "2020-12-21T23:00:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyODc3Nw==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r547328777", "bodyText": "Suggest to also remove the Integer minRf = null; at line 696 above.", "author": "cpoerschke", "createdAt": "2020-12-22T15:06:04Z", "path": "solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java", "diffHunk": "@@ -716,7 +716,6 @@ protected RouteException getRouteException(SolrException.ErrorCode serverError,\n         if (rf == null || routeRf < rf)\n           rf = routeRf;\n       }\n-      minRf = (Integer)header.get(UpdateRequest.MIN_REPFACT);", "originalCommit": "72dea2e333832ca561f41c92b042ac398296d5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNzMxNA==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r547337314", "bodyText": "Hi @trdillon - thanks for opening this pull request!\nOkay, I think I see it now, so your https://issues.apache.org/jira/browse/SOLR-14034?focusedCommentId=17223427&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17223427 question is about this sort of test change here i.e. whether or not minRf should remain an unused sendDoc argument or whether or not it should be removed. I'm thinking here in HttpPartitionTest removal makes sense (haven't yet looked at ReplicationFactorTest). What do you think?", "author": "cpoerschke", "createdAt": "2020-12-22T15:21:25Z", "path": "solr/core/src/test/org/apache/solr/cloud/HttpPartitionTest.java", "diffHunk": "@@ -548,9 +548,6 @@ protected int sendDoc(int docId, Integer minRf, SolrClient solrClient, String co\n     doc.addField(\"a_t\", \"hello\" + docId);\n \n     UpdateRequest up = new UpdateRequest();\n-    if (minRf != null) {\n-      up.setParam(UpdateRequest.MIN_REPFACT, String.valueOf(minRf));\n-    }", "originalCommit": "72dea2e333832ca561f41c92b042ac398296d5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2MTkxNw==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r547561917", "bodyText": "@cpoerschke Thanks for all your help with this one.\nsendDoc seems OK to remove from HttpPartitionTest as it's only passed minRf as an argument, but in ReplicationFactorTest it is passed expectedRf as an argument in addDocs:\n\n  \n    \n      lucene-solr/solr/core/src/test/org/apache/solr/cloud/ReplicationFactorTest.java\n    \n    \n         Line 417\n      in\n      98f12f4\n    \n    \n    \n    \n\n        \n          \n           sendDoc(idList[0], expectedRf); \n        \n    \n  \n\n\nsendDocsWithRetry  is implemented here and used in a few different test classes (DistributedVersionInfoTest, LeaderFailoverAfterPartitionTest and ForceLeaderTest) with minRf as an argument:\n\n  \n    \n      lucene-solr/solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase.java\n    \n    \n         Line 941\n      in\n      98f12f4\n    \n    \n    \n    \n\n        \n          \n           protected static int sendDocsWithRetry(CloudSolrClient cloudClient, String collection, List<SolrInputDocument> batch, int minRf, int maxRetries, int waitBeforeRetry) throws Exception { \n        \n    \n  \n\n\nBut it's also implemented using expectedRfDBQ and expectedRf in ReplicationFactorTest:\n\n\n  \n    \n      lucene-solr/solr/core/src/test/org/apache/solr/cloud/ReplicationFactorTest.java\n    \n    \n         Line 230\n      in\n      98f12f4\n    \n    \n    \n    \n\n        \n          \n           sendDocsWithRetry(batch, expectedRfDBQ, 5, 1); \n        \n    \n  \n\n\n\n  \n    \n      lucene-solr/solr/core/src/test/org/apache/solr/cloud/ReplicationFactorTest.java\n    \n    \n         Line 427\n      in\n      98f12f4\n    \n    \n    \n    \n\n        \n          \n           sendDocsWithRetry(batch, expectedRf, retries, 1); \n        \n    \n  \n\n\n\nI wasn't sure how to proceed with this as looking at the tests it seems that expectedRf is relied upon quite often.", "author": "trdillon", "createdAt": "2020-12-22T23:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNzMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyNDA2MQ==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r548124061", "bodyText": "Thanks for the code pointers and detailed explanation!\nHow about we scope this pull request to remove minRf in almost all code paths i.e. sendDoc gets its unused argument removed in both the replication factor and http partition tests but sendDocsWithRetry remains unchanged for now since as you say it's used in other test classes too?\nIt appears that the minRf argument in sendDocsWithRetry is indeed unused already but it might be clearer to tidy that up in a separate follow-up pull request rather than mix it in here at this time.", "author": "cpoerschke", "createdAt": "2020-12-23T18:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNzMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk0ODM5NA==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r549948394", "bodyText": "It appears that the minRf argument in sendDocsWithRetry is indeed unused already but it might be clearer to tidy that up in a separate follow-up pull request rather than mix it in here at this time.\n\nI'm wondering if it would be better for this method to actually start using this parameter, and retry in the case of minRf not achieved? This is not something that was being done in this method, but may help improve some of the tests using it. I don't think such a change should be done in this PR, but maybe lets not remove the parameter yet then. WDYT?", "author": "tflobbe", "createdAt": "2020-12-30T06:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNzMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5MTAxNg==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r550191016", "bodyText": "I'm wondering if it would be better for this method to actually start using this parameter, ...\n\nAh, yes, I agree, if it's a case of a not-yet-used parameter then keeping it and starting to use it makes sense. Removal would only be for no-longer-used parameter cases. Good catch!", "author": "cpoerschke", "createdAt": "2020-12-30T13:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNzMxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0Mjk5Mg==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r547342992", "bodyText": "How about also removing the minRf argument here since it's now no longer used?", "author": "cpoerschke", "createdAt": "2020-12-22T15:31:12Z", "path": "solr/core/src/test/org/apache/solr/cloud/ReplicationFactorTest.java", "diffHunk": "@@ -461,38 +447,24 @@ protected void doDelete(UpdateRequest req, String msg, int expectedRf, int retri\n \n   protected int sendDoc(int docId, int minRf) throws Exception {\n     UpdateRequest up = new UpdateRequest();\n-    boolean minRfExplicit = maybeAddMinRfExplicitly(minRf, up);\n     SolrInputDocument doc = new SolrInputDocument();\n     doc.addField(id, String.valueOf(docId));\n     doc.addField(\"a_t\", \"hello\" + docId);\n     up.add(doc);\n-    return runAndGetAchievedRf(up, minRfExplicit, minRf);\n+    return runAndGetAchievedRf(up, minRf);\n   }\n   \n-  private int runAndGetAchievedRf(UpdateRequest up, boolean minRfExplicit, int minRf) throws SolrServerException, IOException {", "originalCommit": "72dea2e333832ca561f41c92b042ac398296d5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0NDUxNQ==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r547344515", "bodyText": "Looks like assertMinRfInResponse is now also unused then, if so suggest to remove it also.", "author": "cpoerschke", "createdAt": "2020-12-22T15:33:54Z", "path": "solr/core/src/test/org/apache/solr/cloud/ReplicationFactorTest.java", "diffHunk": "@@ -461,38 +447,24 @@ protected void doDelete(UpdateRequest req, String msg, int expectedRf, int retri\n \n   protected int sendDoc(int docId, int minRf) throws Exception {\n     UpdateRequest up = new UpdateRequest();\n-    boolean minRfExplicit = maybeAddMinRfExplicitly(minRf, up);\n     SolrInputDocument doc = new SolrInputDocument();\n     doc.addField(id, String.valueOf(docId));\n     doc.addField(\"a_t\", \"hello\" + docId);\n     up.add(doc);\n-    return runAndGetAchievedRf(up, minRfExplicit, minRf);\n+    return runAndGetAchievedRf(up, minRf);\n   }\n   \n-  private int runAndGetAchievedRf(UpdateRequest up, boolean minRfExplicit, int minRf) throws SolrServerException, IOException {\n+  private int runAndGetAchievedRf(UpdateRequest up, int minRf) throws SolrServerException, IOException {\n     NamedList<Object> response = cloudClient.request(up);\n-    if (minRfExplicit) {\n-      assertMinRfInResponse(minRf, response);\n-    }\n     return cloudClient.getMinAchievedReplicationFactor(cloudClient.getDefaultCollection(), response);\n   }\n \n   private void assertMinRfInResponse(int minRf, NamedList<Object> response) {\n-    Object minRfFromResponse = response.findRecursive(\"responseHeader\", UpdateRequest.MIN_REPFACT);\n+    Object minRfFromResponse = response.findRecursive(\"responseHeader\");\n     assertNotNull(\"Expected min_rf header in the response\", minRfFromResponse);\n     assertEquals(\"Unexpected min_rf in response\", ((Integer)minRfFromResponse).intValue(), minRf);\n   }", "originalCommit": "72dea2e333832ca561f41c92b042ac398296d5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77e7316dbd45860aa59dca5e1dfad7eb23da98e3", "url": "https://github.com/apache/lucene-solr/commit/77e7316dbd45860aa59dca5e1dfad7eb23da98e3", "message": "Remove assertMinRfInResponse and minRf references", "committedDate": "2020-12-22T22:57:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEwMTkzMg==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r548101932", "bodyText": "Alright, so with maybeAddMinRfExplicitly gone and the minRf argument in runAndGetAchievedRf gone the minRf argument of sendDoc becomes unused, right? I wonder how the code would work out if sendDoc had its minRf argument taken away too? Bit like peeling an onion this here i.e. multiple layers (but it hopefully won't make anyone cry).", "author": "cpoerschke", "createdAt": "2020-12-23T18:07:43Z", "path": "solr/core/src/test/org/apache/solr/cloud/ReplicationFactorTest.java", "diffHunk": "@@ -461,38 +447,18 @@ protected void doDelete(UpdateRequest req, String msg, int expectedRf, int retri\n \n   protected int sendDoc(int docId, int minRf) throws Exception {\n     UpdateRequest up = new UpdateRequest();\n-    boolean minRfExplicit = maybeAddMinRfExplicitly(minRf, up);\n     SolrInputDocument doc = new SolrInputDocument();\n     doc.addField(id, String.valueOf(docId));\n     doc.addField(\"a_t\", \"hello\" + docId);\n     up.add(doc);\n-    return runAndGetAchievedRf(up, minRfExplicit, minRf);\n+    return runAndGetAchievedRf(up);", "originalCommit": "77e7316dbd45860aa59dca5e1dfad7eb23da98e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzOTE4Mg==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r548939182", "bodyText": "The tests for ReplicationFactorTest and HttpPartitionTest passed on my end after removing the minRf argument from sendDoc. I committed the ReplicationFactorTest changes separately as it meant removing the expectedRf argument from the sendDoc call in addDocs and I wasn't sure if this was OK, even though the test still passed.", "author": "trdillon", "createdAt": "2020-12-26T03:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEwMTkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE4OTgzNA==", "url": "https://github.com/apache/lucene-solr/pull/2152#discussion_r550189834", "bodyText": "I appreciate you committing the changes separately, thanks. The ReplicationFactorTest change looks good to me.", "author": "cpoerschke", "createdAt": "2020-12-30T13:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEwMTkzMg=="}], "type": "inlineReview"}, {"oid": "e109454193a8711e6e7adad2ee0d0a2878603f24", "url": "https://github.com/apache/lucene-solr/commit/e109454193a8711e6e7adad2ee0d0a2878603f24", "message": "Remove minRf argument from sendDoc", "committedDate": "2020-12-26T03:19:23Z", "type": "commit"}, {"oid": "babf2c82717a113231b793cbc776806e3569239f", "url": "https://github.com/apache/lucene-solr/commit/babf2c82717a113231b793cbc776806e3569239f", "message": "Remove minRf argument from sendDoc in ReplicationFactorTest", "committedDate": "2020-12-26T03:21:18Z", "type": "commit"}]}