{"pr_number": 1327, "pr_title": "SOLR-13942: /api/cluster/zk/* to fetch raw ZK data", "pr_createdAt": "2020-03-06T12:14:45Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1327", "timeline": [{"oid": "94bdfaaf163441b2241269340ac109d6a750f440", "url": "https://github.com/apache/lucene-solr/commit/94bdfaaf163441b2241269340ac109d6a750f440", "message": "SOLR-13942: /api/cluster/zk/* to fetch raw ZK data", "committedDate": "2020-03-06T12:14:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjU3NA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389306574", "bodyText": "The name of this class is not very representative. Also, all ZooKeeper handlers are called ZooKeeper..., we should keep that for consistency", "author": "tflobbe", "createdAt": "2020-03-07T19:38:11Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZkRead.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+@EndPoint(path = \"/cluster/zk/*\",\n+    method = SolrRequest.METHOD.GET,\n+    permission = COLL_READ_PERM)\n+public class ZkRead {", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjU5Mg==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389306592", "bodyText": "Do we need to keep the CoreContainer? is the zkClient enough?", "author": "tflobbe", "createdAt": "2020-03-07T19:38:30Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZkRead.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+@EndPoint(path = \"/cluster/zk/*\",\n+    method = SolrRequest.METHOD.GET,\n+    permission = COLL_READ_PERM)\n+public class ZkRead {\n+  private final CoreContainer coreContainer;", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxODg3Nw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395418877", "bodyText": "The zkclient may get closed or recreated. Always safer to get the current one", "author": "noblepaul", "createdAt": "2020-03-20T02:53:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc5ODkxMw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395798913", "bodyText": "Ah, true. The problem is that, by requiring the CoreContainer you are making this much more difficult to test (which is why I guess you are starting a Solr cluster just to test this handler). Maybe there is a way to improve the design to improve tests", "author": "tflobbe", "createdAt": "2020-03-20T17:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5NDM5Mw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400494393", "bodyText": "Have you given any thoughts to this? It's unfortunate to have a feature that has so little (nothing really) to do with other parts of Solr to have to start a full SolrCloud cluster to be able to test.", "author": "tflobbe", "createdAt": "2020-03-30T21:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMTE4Mw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r405921183", "bodyText": "We should probably  support a Supplier<ZkClient>.", "author": "noblepaul", "createdAt": "2020-04-09T02:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjY3MQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389306671", "bodyText": "you mean \"s\" or s? Also, the idea here is that we'll add an error per child?", "author": "tflobbe", "createdAt": "2020-03-07T19:39:24Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZkRead.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+@EndPoint(path = \"/cluster/zk/*\",\n+    method = SolrRequest.METHOD.GET,\n+    permission = COLL_READ_PERM)\n+public class ZkRead {\n+  private final CoreContainer coreContainer;\n+\n+  public ZkRead(CoreContainer coreContainer) {\n+    this.coreContainer = coreContainer;\n+  }\n+\n+  @Command\n+  public void get(SolrQueryRequest req, SolrQueryResponse rsp) {\n+    String path = req.getPathTemplateValues().get(\"*\");\n+    if (path == null || path.isEmpty()) path = \"/\";\n+    byte[] d = null;\n+    try {\n+      List<String> l = coreContainer.getZkController().getZkClient().getChildren(path, null, false);\n+      if (l != null && !l.isEmpty()) {\n+        String prefix = path.endsWith(\"/\") ? path : path + \"/\";\n+\n+        rsp.add(path, (MapWriter) ew -> {\n+          for (String s : l) {\n+            try {\n+              Stat stat = coreContainer.getZkController().getZkClient().exists(prefix + s, null, false);\n+              ew.put(s, (MapWriter) ew1 -> {\n+                ew1.put(\"version\", stat.getVersion());\n+                ew1.put(\"aversion\", stat.getAversion());\n+                ew1.put(\"children\", stat.getNumChildren());\n+                ew1.put(\"ctime\", stat.getCtime());\n+                ew1.put(\"cversion\", stat.getCversion());\n+                ew1.put(\"czxid\", stat.getCzxid());\n+                ew1.put(\"ephemeralOwner\", stat.getEphemeralOwner());\n+                ew1.put(\"mtime\", stat.getMtime());\n+                ew1.put(\"mzxid\", stat.getMzxid());\n+                ew1.put(\"pzxid\", stat.getPzxid());\n+                ew1.put(\"dataLength\", stat.getDataLength());\n+              });\n+            } catch (Exception e) {\n+              ew.put(\"s\", Collections.singletonMap(\"error\", e.getMessage()));", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxOTAyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395419029", "bodyText": "good catch. it was supposed to be s", "author": "noblepaul", "createdAt": "2020-03-20T02:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjcxNg==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389306716", "bodyText": "Why are you catching Exception here? instead of a subclass? Also, exists throws interrupted exception, you should interrupt (and break)", "author": "tflobbe", "createdAt": "2020-03-07T19:40:32Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZkRead.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+@EndPoint(path = \"/cluster/zk/*\",\n+    method = SolrRequest.METHOD.GET,\n+    permission = COLL_READ_PERM)\n+public class ZkRead {\n+  private final CoreContainer coreContainer;\n+\n+  public ZkRead(CoreContainer coreContainer) {\n+    this.coreContainer = coreContainer;\n+  }\n+\n+  @Command\n+  public void get(SolrQueryRequest req, SolrQueryResponse rsp) {\n+    String path = req.getPathTemplateValues().get(\"*\");\n+    if (path == null || path.isEmpty()) path = \"/\";\n+    byte[] d = null;\n+    try {\n+      List<String> l = coreContainer.getZkController().getZkClient().getChildren(path, null, false);\n+      if (l != null && !l.isEmpty()) {\n+        String prefix = path.endsWith(\"/\") ? path : path + \"/\";\n+\n+        rsp.add(path, (MapWriter) ew -> {\n+          for (String s : l) {\n+            try {\n+              Stat stat = coreContainer.getZkController().getZkClient().exists(prefix + s, null, false);\n+              ew.put(s, (MapWriter) ew1 -> {\n+                ew1.put(\"version\", stat.getVersion());\n+                ew1.put(\"aversion\", stat.getAversion());\n+                ew1.put(\"children\", stat.getNumChildren());\n+                ew1.put(\"ctime\", stat.getCtime());\n+                ew1.put(\"cversion\", stat.getCversion());\n+                ew1.put(\"czxid\", stat.getCzxid());\n+                ew1.put(\"ephemeralOwner\", stat.getEphemeralOwner());\n+                ew1.put(\"mtime\", stat.getMtime());\n+                ew1.put(\"mzxid\", stat.getMzxid());\n+                ew1.put(\"pzxid\", stat.getPzxid());\n+                ew1.put(\"dataLength\", stat.getDataLength());\n+              });\n+            } catch (Exception e) {", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxOTU1NQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395419555", "bodyText": "does it even matter?\nWhy interrupt the thread when this thread is not doing anything at all. This is the qtp thread. Interrupting it makes no sense", "author": "noblepaul", "createdAt": "2020-03-20T02:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4NDg1Mw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395784853", "bodyText": "This try/catch is inside a loop that makes requests to ZooKeeper. So you are saying that if the thread is interruped (shutdown, or in tests for example) the plan is to swallow that interruption and continue processing (doing requests to ZooKeeper for every child this zkpath has, with sleeps/retries), and the intention of that is to add an \"exception\" to one (just one) of the elements in the tree in the response?\nRegarding other exceptions, lets say you are getting back a SessionExpiredException, the plan is to continue iterating over all the child docs and continue adding node -> KeeperException.SessionExpiredException?\nI think the proper handling of most these exceptions is to stop processing and return an error. If you get a NoNodeException, then yes, that could be added in the response if you want, but doing a blind catch (Exception e) is a bad idea.", "author": "tflobbe", "createdAt": "2020-03-20T17:24:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE2NDg1Nw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r396164857", "bodyText": "Please take a look at the latest\n\nNoNodeException returns with a 404\nOther Exceptions return with 500\n\nThis is supposed to just fail fast if there is a problem. It does not need to be any more sophisticated than that", "author": "noblepaul", "createdAt": "2020-03-23T00:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5MzkxNg==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400493916", "bodyText": "This is still a problem in your latest code", "author": "tflobbe", "createdAt": "2020-03-30T21:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxMjcwNA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400712704", "bodyText": "must be fixed now", "author": "noblepaul", "createdAt": "2020-03-31T07:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3NDI1Ng==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r401974256", "bodyText": "Is not yet fixed in the list case", "author": "tflobbe", "createdAt": "2020-04-01T23:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyNDA1MA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r405924050", "bodyText": "public void list(SolrQueryRequest req, SolrQueryResponse rsp) {\n      String path = req.getPathTemplateValues().get(\"*\");\n      if (path == null || path.isEmpty()) path = \"/\";\n      try {\n        List<String> l = coreContainer.getZkController().getZkClient().getChildren(path, null, false);\n        String prefix = path.endsWith(\"/\") ? path : path + \"/\";\n        rsp.add(path, (MapWriter) ew -> {\n          for (String s : l) {\n            Stat stat = null;\n            try {\n              stat = coreContainer.getZkController().getZkClient().exists(prefix + s, null, false);\n            } catch (Exception e) {\n              throw new RuntimeException(e);\n            }\n            printStat(ew, s, stat);\n          }\n        });\n      } catch (KeeperException.NoNodeException e) {\n        throw new SolrException(SolrException.ErrorCode.NOT_FOUND, \"No such node :\"+ path);\n      } catch (Exception e) {\n        rsp.add(CONTENT, new ContentStreamBase.StringStream(Utils.toJSONString(Collections.singletonMap(\"error\", e.getMessage()))));\n      } finally {\n        RequestHandlerUtils.addExperimentalFormatWarning(rsp);\n      }\n    }\n\nIf there is an exception you will see a 500 error in this code. Am I missing something?", "author": "noblepaul", "createdAt": "2020-04-09T02:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc2NA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389306764", "bodyText": "Why is this needed?", "author": "tflobbe", "createdAt": "2020-03-07T19:40:57Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZkRead.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+@EndPoint(path = \"/cluster/zk/*\",\n+    method = SolrRequest.METHOD.GET,\n+    permission = COLL_READ_PERM)\n+public class ZkRead {\n+  private final CoreContainer coreContainer;\n+\n+  public ZkRead(CoreContainer coreContainer) {\n+    this.coreContainer = coreContainer;\n+  }\n+\n+  @Command\n+  public void get(SolrQueryRequest req, SolrQueryResponse rsp) {\n+    String path = req.getPathTemplateValues().get(\"*\");\n+    if (path == null || path.isEmpty()) path = \"/\";\n+    byte[] d = null;\n+    try {\n+      List<String> l = coreContainer.getZkController().getZkClient().getChildren(path, null, false);\n+      if (l != null && !l.isEmpty()) {\n+        String prefix = path.endsWith(\"/\") ? path : path + \"/\";\n+\n+        rsp.add(path, (MapWriter) ew -> {\n+          for (String s : l) {\n+            try {\n+              Stat stat = coreContainer.getZkController().getZkClient().exists(prefix + s, null, false);\n+              ew.put(s, (MapWriter) ew1 -> {\n+                ew1.put(\"version\", stat.getVersion());\n+                ew1.put(\"aversion\", stat.getAversion());\n+                ew1.put(\"children\", stat.getNumChildren());\n+                ew1.put(\"ctime\", stat.getCtime());\n+                ew1.put(\"cversion\", stat.getCversion());\n+                ew1.put(\"czxid\", stat.getCzxid());\n+                ew1.put(\"ephemeralOwner\", stat.getEphemeralOwner());\n+                ew1.put(\"mtime\", stat.getMtime());\n+                ew1.put(\"mzxid\", stat.getMzxid());\n+                ew1.put(\"pzxid\", stat.getPzxid());\n+                ew1.put(\"dataLength\", stat.getDataLength());\n+              });\n+            } catch (Exception e) {\n+              ew.put(\"s\", Collections.singletonMap(\"error\", e.getMessage()));\n+            }\n+          }\n+        });\n+\n+      } else {\n+        d = coreContainer.getZkController().getZkClient().getData(path, null, null, false);\n+        if (d == null || d.length == 0) {\n+          rsp.add(path, null);\n+          return;\n+        }\n+\n+        Map<String, String> map = new HashMap<>(1);\n+        map.put(WT, \"raw\");\n+        map.put(OMIT_HEADER, \"true\");\n+        req.setParams(SolrParams.wrapDefaults(new MapSolrParams(map), req.getParams()));", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxOTkzNQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395419935", "bodyText": "This is important if we are ever writing out raw content that comes from ZK. We should not use any of the ResponseWriter in Solr", "author": "noblepaul", "createdAt": "2020-03-20T02:59:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwMDAyMw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395800023", "bodyText": "Is this only the case for the situation where we write the data? what about the case of the child nodes? can those requests be written in other response formats? If this is the only format that's allowed, should we fail if another format is requested?", "author": "tflobbe", "createdAt": "2020-03-20T17:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMDEzNw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r405920137", "bodyText": "no if you are requesting data , you should expect raw data. it will not honour the wt param. If you request  /api/cluster/zk/list you will get response in any format that you ask for javabin , xml , json", "author": "noblepaul", "createdAt": "2020-04-09T02:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyNDIyMg==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r405924222", "bodyText": "yes, for list operations , you can get data in any format", "author": "noblepaul", "createdAt": "2020-04-09T02:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389306787", "bodyText": "Same as above, we probably don't need to catch all exceptions, just the ones being thrown. And the same thing with interruption", "author": "tflobbe", "createdAt": "2020-03-07T19:41:24Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZkRead.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+@EndPoint(path = \"/cluster/zk/*\",\n+    method = SolrRequest.METHOD.GET,\n+    permission = COLL_READ_PERM)\n+public class ZkRead {\n+  private final CoreContainer coreContainer;\n+\n+  public ZkRead(CoreContainer coreContainer) {\n+    this.coreContainer = coreContainer;\n+  }\n+\n+  @Command\n+  public void get(SolrQueryRequest req, SolrQueryResponse rsp) {\n+    String path = req.getPathTemplateValues().get(\"*\");\n+    if (path == null || path.isEmpty()) path = \"/\";\n+    byte[] d = null;\n+    try {\n+      List<String> l = coreContainer.getZkController().getZkClient().getChildren(path, null, false);\n+      if (l != null && !l.isEmpty()) {\n+        String prefix = path.endsWith(\"/\") ? path : path + \"/\";\n+\n+        rsp.add(path, (MapWriter) ew -> {\n+          for (String s : l) {\n+            try {\n+              Stat stat = coreContainer.getZkController().getZkClient().exists(prefix + s, null, false);\n+              ew.put(s, (MapWriter) ew1 -> {\n+                ew1.put(\"version\", stat.getVersion());\n+                ew1.put(\"aversion\", stat.getAversion());\n+                ew1.put(\"children\", stat.getNumChildren());\n+                ew1.put(\"ctime\", stat.getCtime());\n+                ew1.put(\"cversion\", stat.getCversion());\n+                ew1.put(\"czxid\", stat.getCzxid());\n+                ew1.put(\"ephemeralOwner\", stat.getEphemeralOwner());\n+                ew1.put(\"mtime\", stat.getMtime());\n+                ew1.put(\"mzxid\", stat.getMzxid());\n+                ew1.put(\"pzxid\", stat.getPzxid());\n+                ew1.put(\"dataLength\", stat.getDataLength());\n+              });\n+            } catch (Exception e) {\n+              ew.put(\"s\", Collections.singletonMap(\"error\", e.getMessage()));\n+            }\n+          }\n+        });\n+\n+      } else {\n+        d = coreContainer.getZkController().getZkClient().getData(path, null, null, false);\n+        if (d == null || d.length == 0) {\n+          rsp.add(path, null);\n+          return;\n+        }\n+\n+        Map<String, String> map = new HashMap<>(1);\n+        map.put(WT, \"raw\");\n+        map.put(OMIT_HEADER, \"true\");\n+        req.setParams(SolrParams.wrapDefaults(new MapSolrParams(map), req.getParams()));\n+\n+\n+        rsp.add(CONTENT, new ContentStreamBase.ByteArrayStream(d, null,\n+            d[0] == '{' ? CommonParams.JSON_MIME : BinaryResponseParser.BINARY_CONTENT_TYPE));\n+\n+      }\n+\n+    } catch (Exception e) {", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxOTk4NA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395419984", "bodyText": "it does not matter in this case", "author": "noblepaul", "createdAt": "2020-03-20T03:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4NDk2Nw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395784967", "bodyText": "It does. See my comment above", "author": "tflobbe", "createdAt": "2020-03-20T17:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4NjUzOQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395786539", "bodyText": "Also, wouldn't this be returning 200 OK for error cases?", "author": "tflobbe", "createdAt": "2020-03-20T17:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM2ODcxOA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r396368718", "bodyText": "this is fixed", "author": "noblepaul", "createdAt": "2020-03-23T11:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjg1Mg==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389306852", "bodyText": "This test doesn't belong in ZookeeperStatusHandlerTest", "author": "tflobbe", "createdAt": "2020-03-07T19:42:30Z", "path": "solr/core/src/test/org/apache/solr/handler/admin/ZookeeperStatusHandlerTest.java", "diffHunk": "@@ -74,6 +78,39 @@ public void tearDown() throws Exception {\n     super.tearDown();\n   }\n \n+  @Test\n+  public void testZkread() throws Exception {", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU1NTk3MA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389555970", "bodyText": "That's true. ZKStatusHandler is the handler that pulls 4LW status from ZK TCP API, which is a completely different handler :)", "author": "janhoy", "createdAt": "2020-03-09T09:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjg1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNjg4MA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389306880", "bodyText": "nit. Fix spaces", "author": "tflobbe", "createdAt": "2020-03-07T19:42:56Z", "path": "solr/core/src/test/org/apache/solr/handler/admin/ZookeeperStatusHandlerTest.java", "diffHunk": "@@ -74,6 +78,39 @@ public void tearDown() throws Exception {\n     super.tearDown();\n   }\n \n+  @Test\n+  public void testZkread() throws Exception {\n+    URL baseUrl = cluster.getJettySolrRunner(0).getBaseUrl();\n+    String basezk = baseUrl.toString().replace(\"/solr\", \"/api\") + \"/cluster/zk\";\n+\n+    try(  HttpSolrClient client = new HttpSolrClient.Builder(baseUrl.toString()).build()) {", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNzA5MA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389307090", "bodyText": "Should we consider the case where znodes have data and children?", "author": "tflobbe", "createdAt": "2020-03-07T19:45:54Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZkRead.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+@EndPoint(path = \"/cluster/zk/*\",\n+    method = SolrRequest.METHOD.GET,\n+    permission = COLL_READ_PERM)\n+public class ZkRead {\n+  private final CoreContainer coreContainer;\n+\n+  public ZkRead(CoreContainer coreContainer) {\n+    this.coreContainer = coreContainer;\n+  }\n+\n+  @Command\n+  public void get(SolrQueryRequest req, SolrQueryResponse rsp) {\n+    String path = req.getPathTemplateValues().get(\"*\");\n+    if (path == null || path.isEmpty()) path = \"/\";\n+    byte[] d = null;\n+    try {\n+      List<String> l = coreContainer.getZkController().getZkClient().getChildren(path, null, false);\n+      if (l != null && !l.isEmpty()) {\n+        String prefix = path.endsWith(\"/\") ? path : path + \"/\";\n+\n+        rsp.add(path, (MapWriter) ew -> {\n+          for (String s : l) {\n+            try {\n+              Stat stat = coreContainer.getZkController().getZkClient().exists(prefix + s, null, false);\n+              ew.put(s, (MapWriter) ew1 -> {\n+                ew1.put(\"version\", stat.getVersion());\n+                ew1.put(\"aversion\", stat.getAversion());\n+                ew1.put(\"children\", stat.getNumChildren());\n+                ew1.put(\"ctime\", stat.getCtime());\n+                ew1.put(\"cversion\", stat.getCversion());\n+                ew1.put(\"czxid\", stat.getCzxid());\n+                ew1.put(\"ephemeralOwner\", stat.getEphemeralOwner());\n+                ew1.put(\"mtime\", stat.getMtime());\n+                ew1.put(\"mzxid\", stat.getMzxid());\n+                ew1.put(\"pzxid\", stat.getPzxid());\n+                ew1.put(\"dataLength\", stat.getDataLength());\n+              });\n+            } catch (Exception e) {\n+              ew.put(\"s\", Collections.singletonMap(\"error\", e.getMessage()));\n+            }\n+          }\n+        });\n+\n+      } else {", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMDI1NQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395420255", "bodyText": "fixing it. you can explicitly request for the node data using a param leaf=true", "author": "noblepaul", "createdAt": "2020-03-20T03:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNzA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNzMwNA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r389307304", "bodyText": "why make things so complicated? cant you just put some static text? what are you trying to achieve with this randomization?", "author": "tflobbe", "createdAt": "2020-03-07T19:48:56Z", "path": "solr/core/src/test/org/apache/solr/handler/admin/ZookeeperStatusHandlerTest.java", "diffHunk": "@@ -74,6 +78,39 @@ public void tearDown() throws Exception {\n     super.tearDown();\n   }\n \n+  @Test\n+  public void testZkread() throws Exception {\n+    URL baseUrl = cluster.getJettySolrRunner(0).getBaseUrl();\n+    String basezk = baseUrl.toString().replace(\"/solr\", \"/api\") + \"/cluster/zk\";\n+\n+    try(  HttpSolrClient client = new HttpSolrClient.Builder(baseUrl.toString()).build()) {\n+      Object o = Utils.executeGET(client.getHttpClient(),\n+          basezk + \"/security.json\",\n+          Utils.JSONCONSUMER );\n+      assertNotNull(o);\n+      o = Utils.executeGET(client.getHttpClient(),\n+          basezk + \"/configs\",\n+          Utils.JSONCONSUMER );\n+      assertEquals(\"0\", String.valueOf(getObjectByPath(o,true, split(\":/configs:_default:dataLength\",':'))));\n+      assertEquals(\"0\", String.valueOf(getObjectByPath(o,true, split(\":/configs:conf:dataLength\",':'))));\n+      byte[] bytes = new byte[1024*5];\n+      for (int i = 0; i < bytes.length; i++) {\n+        bytes[i] = (byte) random().nextInt(128);", "originalCommit": "94bdfaaf163441b2241269340ac109d6a750f440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMTAxMA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395421010", "bodyText": "this was the easiest way to create a byte[] .  could use anything else. But this code was simpler", "author": "noblepaul", "createdAt": "2020-03-20T03:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNzMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4OTg4Ng==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395789886", "bodyText": "Wait, can't you do \"this is some test content\".getBytes(StandardCharsets.UTF_8);?", "author": "tflobbe", "createdAt": "2020-03-20T17:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNzMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5NDk4MQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400494981", "bodyText": "This is still unresolved. Can you clarify why we need this random byte array for the test?", "author": "tflobbe", "createdAt": "2020-03-30T21:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNzMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMDMyNQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r405920325", "bodyText": "I wanted a big enough byte[] not a small one.", "author": "noblepaul", "createdAt": "2020-04-09T02:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwNzMwNA=="}], "type": "inlineReview"}, {"oid": "b12076cace8e5e71685f2fe44488bf7ee2fd1e9d", "url": "https://github.com/apache/lucene-solr/commit/b12076cace8e5e71685f2fe44488bf7ee2fd1e9d", "message": "incorporating feedback comments", "committedDate": "2020-03-20T03:33:43Z", "type": "commit"}, {"oid": "1ef0e3df6b3a785124800cb64185f63eb323b49c", "url": "https://github.com/apache/lucene-solr/commit/1ef0e3df6b3a785124800cb64185f63eb323b49c", "message": "moved to a new test class", "committedDate": "2020-03-20T03:37:11Z", "type": "commit"}, {"oid": "5d97d4ad4930ae5937563d595699b618dbc2a30e", "url": "https://github.com/apache/lucene-solr/commit/5d97d4ad4930ae5937563d595699b618dbc2a30e", "message": "merging with master", "committedDate": "2020-03-20T03:39:49Z", "type": "commit"}, {"oid": "880476954343a0ba5d40d2cb9f373a36e645e67b", "url": "https://github.com/apache/lucene-solr/commit/880476954343a0ba5d40d2cb9f373a36e645e67b", "message": "revert changes", "committedDate": "2020-03-20T03:41:47Z", "type": "commit"}, {"oid": "aff748f1bb24f1cd256e91aff2d39b2da804736f", "url": "https://github.com/apache/lucene-solr/commit/aff748f1bb24f1cd256e91aff2d39b2da804736f", "message": "Revert \"merging with master\"\n\nThis reverts commit 5d97d4ad4930ae5937563d595699b618dbc2a30e.\n\nrevert the merge", "committedDate": "2020-03-20T03:43:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4NzQ1MA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395787450", "bodyText": "Handlers of requests are typically called Handler", "author": "tflobbe", "createdAt": "2020-03-20T17:28:50Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZookeeperRead.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+@EndPoint(path = \"/cluster/zk/*\",\n+    method = SolrRequest.METHOD.GET,\n+    permission = COLL_READ_PERM)\n+public class ZookeeperRead {", "originalCommit": "aff748f1bb24f1cd256e91aff2d39b2da804736f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcwNDk0Mw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400704943", "bodyText": "APIs are named as *API", "author": "noblepaul", "createdAt": "2020-03-31T07:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4NzQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc5NzE0Nw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r395797147", "bodyText": "can you fix the compiler warnings?", "author": "tflobbe", "createdAt": "2020-03-20T17:46:46Z", "path": "solr/core/src/test/org/apache/solr/handler/admin/ZookeeperReadTest.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.lang.invoke.MethodHandles;\n+import java.net.URL;\n+import java.util.Map;\n+\n+import org.apache.solr.client.solrj.impl.HttpSolrClient;\n+import org.apache.solr.cloud.SolrCloudTestCase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.zookeeper.CreateMode;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.solr.common.util.StrUtils.split;\n+import static org.apache.solr.common.util.Utils.getObjectByPath;\n+\n+public class ZookeeperReadTest extends SolrCloudTestCase {\n+  private static final Logger log = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  @BeforeClass\n+  public static void setupCluster() throws Exception {\n+    configureCluster(1)\n+        .addConfig(\"conf\", configset(\"cloud-minimal\"))\n+        .configure();\n+  }\n+\n+  @Before\n+  @Override\n+  public void setUp() throws Exception {\n+    super.setUp();\n+  }\n+\n+  @After\n+  @Override\n+  public void tearDown() throws Exception {\n+    super.tearDown();\n+  }\n+\n+  @Test\n+  public void testZkread() throws Exception {\n+    URL baseUrl = cluster.getJettySolrRunner(0).getBaseUrl();\n+    String basezk = baseUrl.toString().replace(\"/solr\", \"/api\") + \"/cluster/zk\";\n+\n+    try (HttpSolrClient client = new HttpSolrClient.Builder(baseUrl.toString()).build()) {\n+      Object o = Utils.executeGET(client.getHttpClient(),\n+          basezk + \"/security.json\",\n+          Utils.JSONCONSUMER);\n+      assertNotNull(o);\n+      o = Utils.executeGET(client.getHttpClient(),\n+          basezk + \"/configs\",\n+          Utils.JSONCONSUMER);\n+      assertEquals(\"0\", String.valueOf(getObjectByPath(o, true, split(\":/configs:_default:dataLength\", ':'))));\n+      assertEquals(\"0\", String.valueOf(getObjectByPath(o, true, split(\":/configs:conf:dataLength\", ':'))));\n+\n+      o = Utils.executeGET(client.getHttpClient(),\n+          basezk + \"/configs?leaf=true\",\n+          Utils.JSONCONSUMER);\n+      assertTrue(((Map)o).containsKey(\"/configs\"));", "originalCommit": "aff748f1bb24f1cd256e91aff2d39b2da804736f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4ODE5Ng==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r396288196", "bodyText": "what are the warnings?", "author": "noblepaul", "createdAt": "2020-03-23T08:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc5NzE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5NjE0NQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400496145", "bodyText": "Isn't your compiler complaining about non-parametrized map?", "author": "tflobbe", "createdAt": "2020-03-30T21:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc5NzE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxMjU2Mg==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400712562", "bodyText": "NO. I couldn't see it. Maybe you can just commit that directly", "author": "noblepaul", "createdAt": "2020-03-31T07:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc5NzE0Nw=="}], "type": "inlineReview"}, {"oid": "df16e04770d4d26887806ff6d3d7b61b6d86c77b", "url": "https://github.com/apache/lucene-solr/commit/df16e04770d4d26887806ff6d3d7b61b6d86c77b", "message": "created 2 paths instead of one /cluster/zk-data and /cluster/zk-list", "committedDate": "2020-03-23T00:13:42Z", "type": "commit"}, {"oid": "88a3ba11cd9c65fc98f3e423f077f493084520be", "url": "https://github.com/apache/lucene-solr/commit/88a3ba11cd9c65fc98f3e423f077f493084520be", "message": "renamed class", "committedDate": "2020-03-26T23:04:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIwMjA5OA==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400202098", "bodyText": "I cannot see that this new permission is used anywhere?\nAnd if the new zk handler is covered by zk-read, should not also existing ZookeeperInfoHandler handler implement PermissionNameProvider and declare the same permission, for consistency?", "author": "janhoy", "createdAt": "2020-03-30T13:44:00Z", "path": "solr/core/src/java/org/apache/solr/security/PermissionNameProvider.java", "diffHunk": "@@ -38,6 +38,7 @@\n     COLL_READ_PERM(\"collection-admin-read\", null),\n     CORE_READ_PERM(\"core-admin-read\", null),\n     CORE_EDIT_PERM(\"core-admin-edit\", null),\n+    ZK_READ_PERM(\"zk-read\", null),", "originalCommit": "88a3ba11cd9c65fc98f3e423f077f493084520be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIwOTkyMw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400209923", "bodyText": "Perhaps you meant to use ZK_READ_PERM here, and also above?", "author": "janhoy", "createdAt": "2020-03-30T13:54:15Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZookeeperReadAPI.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.client.solrj.impl.XMLResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.SolrException;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**\n+ * Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+\n+public class ZookeeperReadAPI {\n+  private final CoreContainer coreContainer;\n+  public final ReadNode readNode = new ReadNode();\n+  public final ListNode listNode = new ListNode();\n+\n+  public ZookeeperReadAPI(CoreContainer coreContainer) {\n+    this.coreContainer = coreContainer;\n+  }\n+\n+  @EndPoint(path = \"/cluster/zk-data/*\",\n+      method = SolrRequest.METHOD.GET,\n+      permission = COLL_READ_PERM)\n+  public class ReadNode {\n+    @Command\n+    public void get(SolrQueryRequest req, SolrQueryResponse rsp) {\n+      String path = req.getPathTemplateValues().get(\"*\");\n+      if (path == null || path.isEmpty()) path = \"/\";\n+      byte[] d = null;\n+      try {\n+        d = coreContainer.getZkController().getZkClient().getData(path, null, null, false);\n+      } catch (KeeperException.NoNodeException e) {\n+        throw new SolrException(SolrException.ErrorCode.NOT_FOUND, \"No such node: \"+ path);\n+      } catch (Exception e) {\n+        throw new SolrException(SolrException.ErrorCode.SERVER_ERROR, \"Unexpected error\", e);\n+      }\n+      if (d == null || d.length == 0) {\n+        rsp.add(path, null);\n+        return;\n+      }\n+\n+      Map<String, String> map = new HashMap<>(1);\n+      map.put(WT, \"raw\");\n+      map.put(OMIT_HEADER, \"true\");\n+      req.setParams(SolrParams.wrapDefaults(new MapSolrParams(map), req.getParams()));\n+\n+      String mime = BinaryResponseParser.BINARY_CONTENT_TYPE;\n+\n+      if (d[0] == '{') mime = CommonParams.JSON_MIME;\n+      if (d[0] == '<' || d[1] == '?') mime = XMLResponseParser.XML_CONTENT_TYPE;\n+      rsp.add(CONTENT, new ContentStreamBase.ByteArrayStream(d, null, mime));\n+\n+    }\n+  }\n+\n+  @EndPoint(path = \"/cluster/zk-ls/*\",\n+      method = SolrRequest.METHOD.GET,\n+      permission = COLL_READ_PERM)", "originalCommit": "88a3ba11cd9c65fc98f3e423f077f493084520be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMjEzNw==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400212137", "bodyText": "lucene.experimental annotation?", "author": "janhoy", "createdAt": "2020-03-30T13:57:11Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZookeeperReadAPI.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.client.solrj.impl.XMLResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.SolrException;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**\n+ * Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+\n+public class ZookeeperReadAPI {", "originalCommit": "88a3ba11cd9c65fc98f3e423f077f493084520be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxNDAyMQ==", "url": "https://github.com/apache/lucene-solr/pull/1327#discussion_r400214021", "bodyText": "@sigram requested in JIRA that the API response is marked as experimental. That can be solved with an extra rsp.add here?", "author": "janhoy", "createdAt": "2020-03-30T13:59:28Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ZookeeperReadAPI.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.handler.admin;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.solr.api.Command;\n+import org.apache.solr.api.EndPoint;\n+import org.apache.solr.client.solrj.SolrRequest;\n+import org.apache.solr.client.solrj.impl.BinaryResponseParser;\n+import org.apache.solr.client.solrj.impl.XMLResponseParser;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.SolrException;\n+import org.apache.solr.common.params.CommonParams;\n+import org.apache.solr.common.params.MapSolrParams;\n+import org.apache.solr.common.params.SolrParams;\n+import org.apache.solr.common.util.ContentStreamBase;\n+import org.apache.solr.common.util.Utils;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.request.SolrQueryRequest;\n+import org.apache.solr.response.SolrQueryResponse;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.data.Stat;\n+\n+import static org.apache.solr.common.params.CommonParams.OMIT_HEADER;\n+import static org.apache.solr.common.params.CommonParams.WT;\n+import static org.apache.solr.response.RawResponseWriter.CONTENT;\n+import static org.apache.solr.security.PermissionNameProvider.Name.COLL_READ_PERM;\n+\n+/**\n+ * Exposes the content of the Zookeeper\n+ * This is an expert feature that exposes the data inside the back end zookeeper.This API may change or\n+ * be removed in future versions.\n+ * This is not a public API. The data that is returned is not guaranteed to remain same\n+ * across releases, as the data stored in Zookeeper may change from time to time.\n+ */\n+\n+public class ZookeeperReadAPI {\n+  private final CoreContainer coreContainer;\n+  public final ReadNode readNode = new ReadNode();\n+  public final ListNode listNode = new ListNode();\n+\n+  public ZookeeperReadAPI(CoreContainer coreContainer) {\n+    this.coreContainer = coreContainer;\n+  }\n+\n+  @EndPoint(path = \"/cluster/zk-data/*\",\n+      method = SolrRequest.METHOD.GET,\n+      permission = COLL_READ_PERM)\n+  public class ReadNode {\n+    @Command\n+    public void get(SolrQueryRequest req, SolrQueryResponse rsp) {\n+      String path = req.getPathTemplateValues().get(\"*\");\n+      if (path == null || path.isEmpty()) path = \"/\";\n+      byte[] d = null;\n+      try {\n+        d = coreContainer.getZkController().getZkClient().getData(path, null, null, false);\n+      } catch (KeeperException.NoNodeException e) {\n+        throw new SolrException(SolrException.ErrorCode.NOT_FOUND, \"No such node: \"+ path);\n+      } catch (Exception e) {\n+        throw new SolrException(SolrException.ErrorCode.SERVER_ERROR, \"Unexpected error\", e);\n+      }\n+      if (d == null || d.length == 0) {\n+        rsp.add(path, null);\n+        return;\n+      }\n+\n+      Map<String, String> map = new HashMap<>(1);\n+      map.put(WT, \"raw\");\n+      map.put(OMIT_HEADER, \"true\");\n+      req.setParams(SolrParams.wrapDefaults(new MapSolrParams(map), req.getParams()));\n+\n+      String mime = BinaryResponseParser.BINARY_CONTENT_TYPE;\n+\n+      if (d[0] == '{') mime = CommonParams.JSON_MIME;\n+      if (d[0] == '<' || d[1] == '?') mime = XMLResponseParser.XML_CONTENT_TYPE;\n+      rsp.add(CONTENT, new ContentStreamBase.ByteArrayStream(d, null, mime));\n+\n+    }\n+  }\n+\n+  @EndPoint(path = \"/cluster/zk-ls/*\",\n+      method = SolrRequest.METHOD.GET,\n+      permission = COLL_READ_PERM)\n+  public class ListNode {\n+    @Command\n+    public void list(SolrQueryRequest req, SolrQueryResponse rsp) {\n+      String path = req.getPathTemplateValues().get(\"*\");", "originalCommit": "88a3ba11cd9c65fc98f3e423f077f493084520be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "591619bf489741d18393df72f8acaa5b4b1ffad5", "url": "https://github.com/apache/lucene-solr/commit/591619bf489741d18393df72f8acaa5b4b1ffad5", "message": "set the right permissions", "committedDate": "2020-03-31T07:55:11Z", "type": "commit"}, {"oid": "bef4dc4f01c59de8284bf6de5cb2a1304209a8a9", "url": "https://github.com/apache/lucene-solr/commit/bef4dc4f01c59de8284bf6de5cb2a1304209a8a9", "message": "added experimental warnings", "committedDate": "2020-03-31T08:00:27Z", "type": "commit"}, {"oid": "c2705797b6e867878070c848952604a46347d12f", "url": "https://github.com/apache/lucene-solr/commit/c2705797b6e867878070c848952604a46347d12f", "message": "paths changed to /cluster/zk/ls & /cluster/zk/data", "committedDate": "2020-03-31T08:04:39Z", "type": "commit"}, {"oid": "cdd60e3c04245cb573977912f9f56a6c0ef18035", "url": "https://github.com/apache/lucene-solr/commit/cdd60e3c04245cb573977912f9f56a6c0ef18035", "message": "Refactored, with better error handling", "committedDate": "2020-04-27T05:44:44Z", "type": "commit"}]}