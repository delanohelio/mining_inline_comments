{"pr_number": 1666, "pr_title": "SOLR-14155: Load all other SolrCore plugins from packages", "pr_createdAt": "2020-07-11T07:52:32Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1666", "timeline": [{"oid": "59053416fcf2115305c768e12f7db45fce042565", "url": "https://github.com/apache/lucene-solr/commit/59053416fcf2115305c768e12f7db45fce042565", "message": "SOLR-14155: Load all other SolrCore plugins from packages", "committedDate": "2020-07-11T07:51:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1ODQxNA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453258414", "bodyText": "Very much needs a javadoc line saying what it is that is being reloaded.  My initial and incorrect thought was the CoreContainer itself.", "author": "dsmiley", "createdAt": "2020-07-12T02:41:08Z", "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -1588,20 +1576,28 @@ private CoreDescriptor reloadCoreDescriptor(CoreDescriptor oldDesc) {\n     return ret;\n   }\n \n+  public void reload(String name) {", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1ODQ1NQ==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453258455", "bodyText": "This is new.  Can you explain why this new ID is needed?", "author": "dsmiley", "createdAt": "2020-07-12T02:41:52Z", "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -1588,20 +1576,28 @@ private CoreDescriptor reloadCoreDescriptor(CoreDescriptor oldDesc) {\n     return ret;\n   }\n \n+  public void reload(String name) {\n+    reload(name, null);\n+  }\n   /**\n    * Recreates a SolrCore.\n    * While the new core is loading, requests will continue to be dispatched to\n    * and processed by the old core\n    *\n    * @param name the name of the SolrCore to reload\n+   * @param coreId The unique identifier of the core", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI4MDA5Ng==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453280096", "bodyText": "It's possible that multiple core reloads are issued in parallel by different components. If a core is already reloaded , it shouldn't try to load it again", "author": "noblepaul", "createdAt": "2020-07-12T07:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1ODQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1ODY1Mg==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453258652", "bodyText": "Is a null name even valid?  Maybe throw IllegalArgumentException if not instead?", "author": "dsmiley", "createdAt": "2020-07-12T02:45:01Z", "path": "solr/core/src/java/org/apache/solr/core/PluginInfo.java", "diffHunk": "@@ -66,27 +66,39 @@ public PluginInfo(String type, Map<String, String> attrs, @SuppressWarnings({\"ra\n    * This checks if it is a package name prefixed classname.\n    * the return value has first = package name and second = class name\n    */\n-  public static Pair<String,String > parseClassName(String name) {\n-    String pkgName = null;\n-    String className = name;\n-    if (name != null) {\n+  public static CName parseClassName(String name) {\n+    return new CName(name);\n+  }\n+\n+  public static class CName {\n+    public final String pkg;\n+    public final String className;\n+\n+    public CName(String name) {\n+      if (name == null) {", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI4MDE2MQ==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453280161", "bodyText": "Well, in the current code there are a few places where class name is passed as null", "author": "noblepaul", "createdAt": "2020-07-12T07:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1ODY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1ODgwNw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453258807", "bodyText": "The code shows null can be returned but javadoc says \"latest\".", "author": "dsmiley", "createdAt": "2020-07-12T02:47:17Z", "path": "solr/core/src/java/org/apache/solr/core/SolrConfig.java", "diffHunk": "@@ -971,6 +974,21 @@ public RequestParams getRequestParams() {\n     return requestParams;\n   }\n \n+  /**\n+   * The version of package that should be loaded for a given package name\n+   * This information is stored in the params.json in the same configset\n+   * If params.json is absent or there is no corresponding version specified for a given package,\n+   * the latest is used", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1OTAwNw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453259007", "bodyText": "If this ID is completely internal to the node (never passed in as a parameter), then can't we just use some AtomicLong?", "author": "dsmiley", "createdAt": "2020-07-12T02:50:04Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -191,6 +175,11 @@\n \n   private String name;\n   private String logid; // used to show what name is set\n+  /**\n+   * A unique id to differentiate multiple instances of the same core\n+   * If we reload a core, the name remains same , but the id will be new\n+   */\n+  public final UUID uniqueId = UUID.randomUUID();", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI4MDIzOA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453280238", "bodyText": "AtomicLong is mutable.", "author": "noblepaul", "createdAt": "2020-07-12T07:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1OTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMwOTg1NA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453309854", "bodyText": "Switched to simple Long it's immutable", "author": "noblepaul", "createdAt": "2020-07-12T12:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1OTAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1OTE2NQ==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453259165", "bodyText": "Can the createHolder method be declared in such a way (with generics) that the cast here isn't needed?", "author": "dsmiley", "createdAt": "2020-07-12T02:51:59Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -626,25 +615,26 @@ public void deleteNonSnapshotIndexFiles(String indexDirPath) throws IOException\n   }\n \n \n+  @SuppressWarnings(\"unchecked\")\n   private void initListeners() {\n     final Class<SolrEventListener> clazz = SolrEventListener.class;\n     final String label = \"Event Listener\";\n     for (PluginInfo info : solrConfig.getPluginInfos(SolrEventListener.class.getName())) {\n       final String event = info.attributes.get(\"event\");\n       if (\"firstSearcher\".equals(event)) {\n-        SolrEventListener obj = createInitInstance(info, clazz, label, null);\n+        PluginHolder<SolrEventListener> obj = (PluginHolder<SolrEventListener>)PackagePluginHolder.createHolder(info, this, SolrEventListener.class, label);", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1OTU0Mw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453259543", "bodyText": "Maybe it's okay but the obj.get() worries me a little.  As a reader of the code here at the caller, it seems suspicious to evaluate a Supplier on a debug log statement.  Maybe it's not necessarily \"safe\" (lazy) and it should only be fetched if really needed.  For a log statement, lets just pass \"obj\" (PluginHolder) and add a decent toString to the PluginHolder?", "author": "dsmiley", "createdAt": "2020-07-12T02:58:20Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -626,25 +615,26 @@ public void deleteNonSnapshotIndexFiles(String indexDirPath) throws IOException\n   }\n \n \n+  @SuppressWarnings(\"unchecked\")\n   private void initListeners() {\n     final Class<SolrEventListener> clazz = SolrEventListener.class;\n     final String label = \"Event Listener\";\n     for (PluginInfo info : solrConfig.getPluginInfos(SolrEventListener.class.getName())) {\n       final String event = info.attributes.get(\"event\");\n       if (\"firstSearcher\".equals(event)) {\n-        SolrEventListener obj = createInitInstance(info, clazz, label, null);\n+        PluginHolder<SolrEventListener> obj = (PluginHolder<SolrEventListener>)PackagePluginHolder.createHolder(info, this, SolrEventListener.class, label);\n         firstSearcherListeners.add(obj);\n-        log.debug(\"[{}] Added SolrEventListener for firstSearcher: [{}]\", logid, obj);\n+        log.debug(\"[{}] Added SolrEventListener for firstSearcher: [{}]\", logid, obj.get());", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MDAyMQ==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453260021", "bodyText": "Can we use a PluginBag instead of List, which is shorter and more consistent with how SolrCore tracks some plugins like SearchComponents, URPs, and RequestHandlers?", "author": "dsmiley", "createdAt": "2020-07-12T03:05:10Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -626,25 +615,26 @@ public void deleteNonSnapshotIndexFiles(String indexDirPath) throws IOException\n   }\n \n \n+  @SuppressWarnings(\"unchecked\")\n   private void initListeners() {\n     final Class<SolrEventListener> clazz = SolrEventListener.class;\n     final String label = \"Event Listener\";\n     for (PluginInfo info : solrConfig.getPluginInfos(SolrEventListener.class.getName())) {\n       final String event = info.attributes.get(\"event\");\n       if (\"firstSearcher\".equals(event)) {\n-        SolrEventListener obj = createInitInstance(info, clazz, label, null);\n+        PluginHolder<SolrEventListener> obj = (PluginHolder<SolrEventListener>)PackagePluginHolder.createHolder(info, this, SolrEventListener.class, label);\n         firstSearcherListeners.add(obj);\n-        log.debug(\"[{}] Added SolrEventListener for firstSearcher: [{}]\", logid, obj);\n+        log.debug(\"[{}] Added SolrEventListener for firstSearcher: [{}]\", logid, obj.get());\n       } else if (\"newSearcher\".equals(event)) {\n-        SolrEventListener obj = createInitInstance(info, clazz, label, null);\n+        PluginHolder<SolrEventListener> obj = (PluginHolder<SolrEventListener>)PackagePluginHolder.createHolder(info, this, SolrEventListener.class, label);\n         newSearcherListeners.add(obj);\n-        log.debug(\"[{}] Added SolrEventListener for newSearcher: [{}]\", logid, obj);\n+        log.debug(\"[{}] Added SolrEventListener for newSearcher: [{}]\", logid, obj.get());\n       }\n     }\n   }\n \n-  final List<SolrEventListener> firstSearcherListeners = new ArrayList<>();\n-  final List<SolrEventListener> newSearcherListeners = new ArrayList<>();\n+  final List<PluginHolder<SolrEventListener>> firstSearcherListeners = new ArrayList<>();", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5NTE1OA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453295158", "bodyText": "It's possible. But the problem is event listeners have no names. PluginBag tracks plugins registered with a name", "author": "noblepaul", "createdAt": "2020-07-12T09:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MDAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MDIxNQ==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453260215", "bodyText": "Moving this constant to SolrConfig seems odd.  If the constant is specific to packages/versions then I think it belongs in the \"pkg\" Java package somewhere.", "author": "dsmiley", "createdAt": "2020-07-12T03:08:01Z", "path": "solr/core/src/java/org/apache/solr/packagemanager/PackageManager.java", "diffHunk": "@@ -250,7 +250,7 @@ private boolean deployPackage(SolrPackageInstance packageInstance, boolean pegTo\n       // Set the package version in the collection's parameters\n       try {\n         SolrCLI.postJsonToSolr(solrClient, PackageUtils.getCollectionParamsPath(collection),\n-            \"{set:{PKG_VERSIONS:{\" + packageInstance.name+\": '\" + (pegToLatest? PackagePluginHolder.LATEST: packageInstance.version)+\"'}}}\");\n+            \"{set:{PKG_VERSIONS:{\" + packageInstance.name+\": '\" + (pegToLatest? SolrConfig.LATEST: packageInstance.version)+\"'}}}\");", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MDU1OQ==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453260559", "bodyText": "needs a comment as to what the \"String\" key is", "author": "dsmiley", "createdAt": "2020-07-12T03:12:46Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageListeners.java", "diffHunk": "@@ -96,15 +97,32 @@ private synchronized void invokeListeners(PackageLoader.Package pkg) {\n \n \n   public interface Listener {\n-    /**Name of the package or null to loisten to all package changes\n+    /**Name of the package or null to listen to all package changes\n      */\n     String packageName();\n \n     PluginInfo pluginInfo();\n \n-    void changed(PackageLoader.Package pkg);\n+    void changed(PackageLoader.Package pkg, Ctx ctx);\n \n     PackageLoader.Package.Version getPackageVersion();\n+    class Ctx {\n+      private Map<String, Runnable > runLater;", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI4MDM5Nw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453280397", "bodyText": "Basically, a unique identifier for a type of action. It's possible that multiple plugins ask for same action (say core reload) . We do not want core reloads to happen multiple times", "author": "noblepaul", "createdAt": "2020-07-12T07:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MDU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MDkyNA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453260924", "bodyText": "Woah; probably needs more thought.  When is \"later\" (after what)?  An Executor should probably be used.  Does this really need to be async?  Maybe \"sometimes\" (some Runnables) so maybe the supplier of the Runnable should handle it by using its own Executor.", "author": "dsmiley", "createdAt": "2020-07-12T03:17:22Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageListeners.java", "diffHunk": "@@ -96,15 +97,32 @@ private synchronized void invokeListeners(PackageLoader.Package pkg) {\n \n \n   public interface Listener {\n-    /**Name of the package or null to loisten to all package changes\n+    /**Name of the package or null to listen to all package changes\n      */\n     String packageName();\n \n     PluginInfo pluginInfo();\n \n-    void changed(PackageLoader.Package pkg);\n+    void changed(PackageLoader.Package pkg, Ctx ctx);\n \n     PackageLoader.Package.Version getPackageVersion();\n+    class Ctx {\n+      private Map<String, Runnable > runLater;\n+      public void runLater(String name,  Runnable runnable  ){\n+        if(runLater == null) runLater = new LinkedHashMap<>();\n+        runLater.put(name, runnable);\n+      }\n+      private void runLaterTasks(){\n+        if(runLater == null) return;\n+        new Thread(() -> runLater.forEach((s, runnable) -> {", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI4MDUxMg==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453280512", "bodyText": "Yeah, I thought through. usually operations such as core reloads are time consuming. This is usually happening in the ZK thread. We do not want to make that thread wait", "author": "noblepaul", "createdAt": "2020-07-12T07:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MDkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MTM3Mg==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453261372", "bodyText": "Why lazy-evaluate the class?  In the issue description, the solrconfig caches were not listed as hot-reloadable, and so I'm surprised to see changes here.", "author": "dsmiley", "createdAt": "2020-07-12T03:24:01Z", "path": "solr/core/src/java/org/apache/solr/search/CacheConfig.java", "diffHunk": "@@ -64,7 +67,7 @@ public CacheConfig() {}\n \n   @SuppressWarnings({\"rawtypes\"})\n   public CacheConfig(Class<? extends SolrCache> clazz, Map<String,String> args, CacheRegenerator regenerator) {\n-    this.clazz = clazz;\n+    this.clazz = () -> clazz;", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI4MDU4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453280587", "bodyText": "The SolrCore is not instantiated and available when SolrConfig is created. So, create it only on demand. if SolrCore is not available, we can't register for a reload", "author": "noblepaul", "createdAt": "2020-07-12T07:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MTM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MTQ4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453261487", "bodyText": "you didn't add casts so this annotation doesn't seem necessary", "author": "dsmiley", "createdAt": "2020-07-12T03:25:27Z", "path": "solr/core/src/java/org/apache/solr/update/UpdateHandler.java", "diffHunk": "@@ -48,25 +46,26 @@\n   protected final SchemaField idField;\n   protected final FieldType idFieldType;\n \n-  protected Vector<SolrEventListener> commitCallbacks = new Vector<>();\n-  protected Vector<SolrEventListener> softCommitCallbacks = new Vector<>();\n-  protected Vector<SolrEventListener> optimizeCallbacks = new Vector<>();\n+  protected Vector<PluginHolder<SolrEventListener>> commitCallbacks = new Vector<>();\n+  protected Vector<PluginHolder<SolrEventListener>> softCommitCallbacks = new Vector<>();\n+  protected Vector<PluginHolder<SolrEventListener>> optimizeCallbacks = new Vector<>();\n \n   protected final UpdateLog ulog;\n \n   protected SolrMetricsContext solrMetricsContext;\n \n+  @SuppressWarnings(\"unchecked\")", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2MTU0Mg==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r453261542", "bodyText": "you may want to auto-format the code in this method; I see some extra spaces and inconsistent use of spaces", "author": "dsmiley", "createdAt": "2020-07-12T03:26:03Z", "path": "solr/core/src/java/org/apache/solr/update/UpdateHandler.java", "diffHunk": "@@ -77,33 +76,35 @@ private void parseEventListeners() {\n    * Call the {@link SolrCoreAware#inform(SolrCore)} on all the applicable registered listeners.\n    */\n   public void informEventListeners(SolrCore core) {\n-    for (SolrEventListener listener: commitCallbacks) {\n-      if (listener instanceof SolrCoreAware) {\n-        ((SolrCoreAware) listener).inform(core);\n+    for (PluginHolder<SolrEventListener>  listener: commitCallbacks) {", "originalCommit": "59053416fcf2115305c768e12f7db45fce042565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ae2dfc69303191a0d030770eaa39a0a6f4b62f13", "url": "https://github.com/apache/lucene-solr/commit/ae2dfc69303191a0d030770eaa39a0a6f4b62f13", "message": "more review commnets incorporated", "committedDate": "2020-07-12T10:01:37Z", "type": "commit"}, {"oid": "fc3599b15ad1545a8801c12ed13b2c8480f99fb3", "url": "https://github.com/apache/lucene-solr/commit/fc3599b15ad1545a8801c12ed13b2c8480f99fb3", "message": "precommit errs", "committedDate": "2020-07-12T12:04:22Z", "type": "commit"}, {"oid": "90516874d8e5621c032a779b7d0a853bf13ee2c4", "url": "https://github.com/apache/lucene-solr/commit/90516874d8e5621c032a779b7d0a853bf13ee2c4", "message": "use proper generics", "committedDate": "2020-07-12T12:14:26Z", "type": "commit"}, {"oid": "9bc2221d59e328068586486d70ef6604ee994864", "url": "https://github.com/apache/lucene-solr/commit/9bc2221d59e328068586486d70ef6604ee994864", "message": "use Long instead of UUID", "committedDate": "2020-07-12T12:21:54Z", "type": "commit"}, {"oid": "f5398927056efb4308c0408d578ed9de47bc9bec", "url": "https://github.com/apache/lucene-solr/commit/f5398927056efb4308c0408d578ed9de47bc9bec", "message": "precommit errs", "committedDate": "2020-07-13T01:47:54Z", "type": "commit"}, {"oid": "3f764ca9af0fd1b98c059db5b13467517b2d4848", "url": "https://github.com/apache/lucene-solr/commit/3f764ca9af0fd1b98c059db5b13467517b2d4848", "message": "cleanup", "committedDate": "2020-07-13T01:58:19Z", "type": "commit"}, {"oid": "a874bfc5e517234b66b6a0630b6e898bbfb9969d", "url": "https://github.com/apache/lucene-solr/commit/a874bfc5e517234b66b6a0630b6e898bbfb9969d", "message": "cleanup", "committedDate": "2020-07-13T02:06:19Z", "type": "commit"}, {"oid": "5d50b47010de970b932c83a524bcb19537903279", "url": "https://github.com/apache/lucene-solr/commit/5d50b47010de970b932c83a524bcb19537903279", "message": "bug fix", "committedDate": "2020-07-13T15:38:57Z", "type": "commit"}, {"oid": "0d6d206fcd846859c01be3fe31b552445ab1c71f", "url": "https://github.com/apache/lucene-solr/commit/0d6d206fcd846859c01be3fe31b552445ab1c71f", "message": "moved some methods to SRL", "committedDate": "2020-07-15T00:40:30Z", "type": "commit"}, {"oid": "74f51561f614834bfd34272f626108dfefd9871f", "url": "https://github.com/apache/lucene-solr/commit/74f51561f614834bfd34272f626108dfefd9871f", "message": "moved some methods to SRL", "committedDate": "2020-07-15T00:41:05Z", "type": "commit"}, {"oid": "84169b9704292f48876c39ccb9fe1e360707c50f", "url": "https://github.com/apache/lucene-solr/commit/84169b9704292f48876c39ccb9fe1e360707c50f", "message": "refactoring", "committedDate": "2020-07-15T04:32:59Z", "type": "commit"}, {"oid": "65cbb8c017d5d11eba2f28951a77a1f2617b79f2", "url": "https://github.com/apache/lucene-solr/commit/65cbb8c017d5d11eba2f28951a77a1f2617b79f2", "message": "more refactoring and reviw comments implemented", "committedDate": "2020-07-16T02:04:44Z", "type": "commit"}, {"oid": "785db2a88ee1560adb4a6155aacc21add85edbba", "url": "https://github.com/apache/lucene-solr/commit/785db2a88ee1560adb4a6155aacc21add85edbba", "message": "more refactoring and reviw comments implemented", "committedDate": "2020-07-16T02:05:27Z", "type": "commit"}, {"oid": "14f9ed6c68f12be2e4d446b9a6bb8985b6b0b246", "url": "https://github.com/apache/lucene-solr/commit/14f9ed6c68f12be2e4d446b9a6bb8985b6b0b246", "message": "more refactoring and reviw comments implemented", "committedDate": "2020-07-16T02:05:41Z", "type": "commit"}, {"oid": "871acb6f791bf78f1772a020bd41e015775f8489", "url": "https://github.com/apache/lucene-solr/commit/871acb6f791bf78f1772a020bd41e015775f8489", "message": "merging w/ master", "committedDate": "2020-07-16T06:27:02Z", "type": "commit"}, {"oid": "e8609111be43142c38f77b843d585fb8fcc218a1", "url": "https://github.com/apache/lucene-solr/commit/e8609111be43142c38f77b843d585fb8fcc218a1", "message": "merging w/ master", "committedDate": "2020-07-16T06:29:26Z", "type": "commit"}, {"oid": "eef0bf5cc255ab945c444e4ec2e1d6c7792a611b", "url": "https://github.com/apache/lucene-solr/commit/eef0bf5cc255ab945c444e4ec2e1d6c7792a611b", "message": "merging w/ master", "committedDate": "2020-07-16T06:33:59Z", "type": "commit"}, {"oid": "6bc50e9ebfb76c291d5b369d708f93ec02355a34", "url": "https://github.com/apache/lucene-solr/commit/6bc50e9ebfb76c291d5b369d708f93ec02355a34", "message": "Merge branch 'master' into jira/solr14155-1", "committedDate": "2020-07-16T06:36:52Z", "type": "commit"}, {"oid": "67ebf1a1fed35247836b872877a4e04f3f11f2c1", "url": "https://github.com/apache/lucene-solr/commit/67ebf1a1fed35247836b872877a4e04f3f11f2c1", "message": "merge errs", "committedDate": "2020-07-16T09:04:08Z", "type": "commit"}, {"oid": "a1be6c6c340420d9dd340d0fb1f7a56984805305", "url": "https://github.com/apache/lucene-solr/commit/a1be6c6c340420d9dd340d0fb1f7a56984805305", "message": "javadocs", "committedDate": "2020-07-16T09:05:16Z", "type": "commit"}, {"oid": "407422803ee49aec91b8c8df1989ebc80ffabe09", "url": "https://github.com/apache/lucene-solr/commit/407422803ee49aec91b8c8df1989ebc80ffabe09", "message": "merge errs", "committedDate": "2020-07-16T09:06:39Z", "type": "commit"}, {"oid": "30dd62dbd4ff0faf6e17c38b75d40046bc8e4476", "url": "https://github.com/apache/lucene-solr/commit/30dd62dbd4ff0faf6e17c38b75d40046bc8e4476", "message": "more cleanup", "committedDate": "2020-07-16T09:18:46Z", "type": "commit"}, {"oid": "44194f94d42787ac405bf3799c18276a95001083", "url": "https://github.com/apache/lucene-solr/commit/44194f94d42787ac405bf3799c18276a95001083", "message": "more cleanup", "committedDate": "2020-07-16T09:28:12Z", "type": "commit"}, {"oid": "fb067145259f1b0da8afcdfb8e13347c20cf376f", "url": "https://github.com/apache/lucene-solr/commit/fb067145259f1b0da8afcdfb8e13347c20cf376f", "message": "more cleanup", "committedDate": "2020-07-16T09:31:14Z", "type": "commit"}, {"oid": "32554578e9abc7d7758338e08ba92313ae6364d2", "url": "https://github.com/apache/lucene-solr/commit/32554578e9abc7d7758338e08ba92313ae6364d2", "message": "more cleanup", "committedDate": "2020-07-16T09:34:44Z", "type": "commit"}, {"oid": "c704a9a8c20eee5cf30fc69e7c6a0c7d2a8503e2", "url": "https://github.com/apache/lucene-solr/commit/c704a9a8c20eee5cf30fc69e7c6a0c7d2a8503e2", "message": "more cleanup", "committedDate": "2020-07-16T14:04:43Z", "type": "commit"}, {"oid": "9d4946a7984af647117ec61284980ea5760f69da", "url": "https://github.com/apache/lucene-solr/commit/9d4946a7984af647117ec61284980ea5760f69da", "message": "cleanup", "committedDate": "2020-07-16T14:53:36Z", "type": "commit"}, {"oid": "9888bc8522f1a682d5a7a114ce8fa8e6f3cce40f", "url": "https://github.com/apache/lucene-solr/commit/9888bc8522f1a682d5a7a114ce8fa8e6f3cce40f", "message": "merging with master", "committedDate": "2020-09-08T03:22:14Z", "type": "commit"}, {"oid": "768c4f5d83ac4e48a2a25fbdbce5e317a00c582f", "url": "https://github.com/apache/lucene-solr/commit/768c4f5d83ac4e48a2a25fbdbce5e317a00c582f", "message": "merging with master", "committedDate": "2020-09-08T04:06:31Z", "type": "commit"}, {"oid": "ecee4975ac3711b9379e6a51c76e591a824a62ba", "url": "https://github.com/apache/lucene-solr/commit/ecee4975ac3711b9379e6a51c76e591a824a62ba", "message": "merging with master", "committedDate": "2020-09-08T04:14:08Z", "type": "commit"}, {"oid": "6f24116e7182570694f5e701bf1ebec247adaf6d", "url": "https://github.com/apache/lucene-solr/commit/6f24116e7182570694f5e701bf1ebec247adaf6d", "message": "merging with trunk", "committedDate": "2021-01-12T06:28:24Z", "type": "commit"}, {"oid": "31080d809c0ee0f11581a3c5d9b1030afa1d6b4f", "url": "https://github.com/apache/lucene-solr/commit/31080d809c0ee0f11581a3c5d9b1030afa1d6b4f", "message": "merging with trunk", "committedDate": "2021-01-12T06:32:45Z", "type": "commit"}, {"oid": "8c292557b38718c3524e4edda67fd82937a9fdb0", "url": "https://github.com/apache/lucene-solr/commit/8c292557b38718c3524e4edda67fd82937a9fdb0", "message": "merging with trunk", "committedDate": "2021-01-12T06:34:42Z", "type": "commit"}, {"oid": "d53e248a3f8636efe8bc36fc562e6635314698b5", "url": "https://github.com/apache/lucene-solr/commit/d53e248a3f8636efe8bc36fc562e6635314698b5", "message": "merging with trunk", "committedDate": "2021-01-12T06:39:33Z", "type": "commit"}, {"oid": "19ec87312a89dc92efd6b160332596794c07b74c", "url": "https://github.com/apache/lucene-solr/commit/19ec87312a89dc92efd6b160332596794c07b74c", "message": "unused imports", "committedDate": "2021-01-12T06:53:24Z", "type": "commit"}, {"oid": "6e7ffac80443adc125f7f89089bbb8522fa13f68", "url": "https://github.com/apache/lucene-solr/commit/6e7ffac80443adc125f7f89089bbb8522fa13f68", "message": "unused imports", "committedDate": "2021-01-12T07:04:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NTcwNg==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r555575706", "bodyText": "NULL_DEREFERENCE:  object theVersion last assigned on line 84 could be null and is dereferenced at line 86.", "author": "sonatype-lift", "createdAt": "2021-01-12T07:59:59Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageListeningClassLoader.java", "diffHunk": "@@ -61,18 +66,25 @@ public PackageListeningClassLoader(CoreContainer coreContainer,\n     @Override\n     public <T> T newInstance(String cname, Class<T> expectedType, String... subpackages) {\n         PluginInfo.ClassName cName = new PluginInfo.ClassName(cname);\n-        if(cName.pkg == null){\n-            return coreResourceLoader.newInstance(cname, expectedType, subpackages);\n+        if(cName.pkg == null) {\n+            return fallbackClassLoader.newInstance(cname, expectedType, subpackages);\n         } else {\n-            PackageLoader.Package.Version version = findPkgVersion(cName);\n+            PackageLoader.Package.Version version = findPackageVersion(cName, true);\n             return applyResourceLoaderAware(version, version.getLoader().newInstance(cName.className, expectedType, subpackages));\n \n         }\n     }\n \n-    private PackageLoader.Package.Version findPkgVersion(PluginInfo.ClassName cName) {\n+\n+    /**\n+     * This looks up for package and also listens for that package if required\n+     * @param cName The class name\n+     */\n+    public PackageLoader.Package.Version findPackageVersion(PluginInfo.ClassName cName, boolean registerListener) {\n         PackageLoader.Package.Version theVersion = coreContainer.getPackageLoader().getPackage(cName.pkg).getLatest(pkgVersionSupplier.apply(cName.pkg));\n-        packageVersions.put(cName.pkg, theVersion.getPkgVersion());\n+        if(registerListener) {\n+            packageVersions.put(cName.pkg, theVersion.getPkgVersion());", "originalCommit": "6f24116e7182570694f5e701bf1ebec247adaf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NTcyNA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r555575724", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method SolrCore(...) indirectly mutates container util.ObjectReleaseTracker.OBJECTS via call to Map.put(...) outside of synchronization.\nReporting because another access to the same memory occurs on a background thread, although this access may not.", "author": "sonatype-lift", "createdAt": "2021-01-12T08:00:01Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -927,7 +929,7 @@ private UpdateHandler createUpdateHandler(String className, UpdateHandler update\n \n   public SolrCore(CoreContainer coreContainer, CoreDescriptor cd, ConfigSet configSet) {\n     this(coreContainer, cd, configSet, null,", "originalCommit": "6f24116e7182570694f5e701bf1ebec247adaf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NTczOA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r555575738", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method SolrCore.createStatsCache() indirectly mutates container core.SolrResourceLoader.classNameCache via call to Map.put(...) outside of synchronization.\nReporting because another access to the same memory occurs on a background thread, although this access may not.", "author": "sonatype-lift", "createdAt": "2021-01-12T08:00:02Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -1443,8 +1445,8 @@ public StatsCache createStatsCache() {\n     final StatsCache cache;\n     PluginInfo pluginInfo = solrConfig.getPluginInfo(StatsCache.class.getName());\n     if (pluginInfo != null && pluginInfo.className != null && pluginInfo.className.length() > 0) {\n-      cache = createInitInstance(pluginInfo, StatsCache.class, null,\n-          LocalStatsCache.class.getName());\n+      cache = resourceLoader.newInstance( pluginInfo, StatsCache.class, true);", "originalCommit": "6f24116e7182570694f5e701bf1ebec247adaf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NTc0Nw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r555575747", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method SolrCore.openNewSearcher(...) indirectly reads with synchronization from container core.SolrResourceLoader.classNameCache via call to Map.get(...). Potentially races with unsynchronized write in method SolrCore.initIndex(...).\nReporting because this access may occur on a background thread.", "author": "sonatype-lift", "createdAt": "2021-01-12T08:00:04Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -2134,12 +2136,12 @@ public IndexFingerprint getIndexFingerprint(SolrIndexSearcher searcher, LeafRead\n           newReader = currentReader;\n         }\n \n-        // for now, turn off caches if this is for a realtime reader \n+        // for now, turn off caches if this is for a realtime reader\n         // (caches take a little while to instantiate)\n         final boolean useCaches = !realtime;\n         final String newName = realtime ? \"realtime\" : \"main\";\n         tmp = new SolrIndexSearcher(this, newIndexDir, getLatestSchema(), newName,", "originalCommit": "6f24116e7182570694f5e701bf1ebec247adaf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NTc1Mw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r555575753", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method SolrResourceLoader.findClass(...) indirectly reads without synchronization from this.coreReloadingClassLoader. Potentially races with write in method SolrResourceLoader.inform(...).\nReporting because another access to the same memory occurs on a background thread, although this access may not.", "author": "sonatype-lift", "createdAt": "2021-01-12T08:00:05Z", "path": "solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java", "diffHunk": "@@ -834,6 +847,47 @@ public void close() throws IOException {\n   public List<SolrInfoBean> getInfoMBeans() {\n     return Collections.unmodifiableList(infoMBeans);\n   }\n+  /**\n+   * Load a class using an appropriate {@link SolrResourceLoader} depending of the package on that class\n+   * @param registerCoreReloadListener register a listener for the package and reload the core if the package is changed.\n+   *                                   Use this sparingly. This will result in core reloads across all the cores in\n+   *                                   all collections using this configset\n+   */\n+  public  <T> Class<? extends T> findClass( PluginInfo info, Class<T>  type, boolean registerCoreReloadListener) {\n+    if(info.cName.pkg == null) return findClass(info.className, type);\n+    return _classLookup(info,", "originalCommit": "6f24116e7182570694f5e701bf1ebec247adaf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NTc2OA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r555575768", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method SolrResourceLoader.inform(...) reads without synchronization from this.coreReloadingClassLoader. Potentially races with write in method SolrResourceLoader.inform(...).\nReporting because this access may occur on a background thread.", "author": "sonatype-lift", "createdAt": "2021-01-12T08:00:06Z", "path": "solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java", "diffHunk": "@@ -654,6 +657,16 @@ public void inform(SolrCore core) {\n     this.config = core.getSolrConfig();\n     this.coreId = core.uniqueId;\n     this.coreContainer = core.getCoreContainer();\n+    SolrCore.Provider coreProvider = core.coreProvider;\n+\n+    this.coreReloadingClassLoader = new PackageListeningClassLoader(core.getCoreContainer(),\n+            this, s -> config.maxPackageVersion(s), null){\n+      @Override\n+      protected void doReloadAction(Ctx ctx) {\n+        coreProvider.reload();\n+      }\n+    };\n+    core.getPackageListeners().addListener(coreReloadingClassLoader, true);", "originalCommit": "6f24116e7182570694f5e701bf1ebec247adaf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NTc3NQ==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r555575775", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method SolrResourceLoader.inform(...) writes to field this.coreReloadingClassLoader outside of synchronization.\nReporting because this access may occur on a background thread.", "author": "sonatype-lift", "createdAt": "2021-01-12T08:00:07Z", "path": "solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java", "diffHunk": "@@ -654,6 +657,16 @@ public void inform(SolrCore core) {\n     this.config = core.getSolrConfig();\n     this.coreId = core.uniqueId;\n     this.coreContainer = core.getCoreContainer();\n+    SolrCore.Provider coreProvider = core.coreProvider;\n+\n+    this.coreReloadingClassLoader = new PackageListeningClassLoader(core.getCoreContainer(),", "originalCommit": "6f24116e7182570694f5e701bf1ebec247adaf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NTc4OA==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r555575788", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method SolrResourceLoader.newInstance(...) indirectly reads without synchronization from this.coreReloadingClassLoader. Potentially races with write in method SolrResourceLoader.inform(...).\nReporting because another access to the same memory occurs on a background thread, although this access may not.", "author": "sonatype-lift", "createdAt": "2021-01-12T08:00:09Z", "path": "solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java", "diffHunk": "@@ -834,6 +847,47 @@ public void close() throws IOException {\n   public List<SolrInfoBean> getInfoMBeans() {\n     return Collections.unmodifiableList(infoMBeans);\n   }\n+  /**\n+   * Load a class using an appropriate {@link SolrResourceLoader} depending of the package on that class\n+   * @param registerCoreReloadListener register a listener for the package and reload the core if the package is changed.\n+   *                                   Use this sparingly. This will result in core reloads across all the cores in\n+   *                                   all collections using this configset\n+   */\n+  public  <T> Class<? extends T> findClass( PluginInfo info, Class<T>  type, boolean registerCoreReloadListener) {\n+    if(info.cName.pkg == null) return findClass(info.className, type);\n+    return _classLookup(info,\n+            (Function<PackageLoader.Package.Version, Class<? extends T>>) ver -> ver.getLoader().findClass(info.cName.className, type), registerCoreReloadListener);\n+\n+  }\n+\n+\n+  private  <T> T _classLookup(PluginInfo info, Function<PackageLoader.Package.Version, T> fun, boolean registerCoreReloadListener ) {\n+    PluginInfo.ClassName cName = info.cName;\n+    if (registerCoreReloadListener) {\n+      if (coreReloadingClassLoader == null) {\n+        throw new SolrException(SolrException.ErrorCode.SERVER_ERROR, \"Core not set\");\n+      }\n+      return fun.apply(coreReloadingClassLoader.findPackageVersion(cName, true));\n+    } else {\n+      return fun.apply(coreReloadingClassLoader.findPackageVersion(cName, false));\n+    }\n+  }\n+\n+  /**\n+   *Create a n instance of a class using an appropriate {@link SolrResourceLoader} depending on the package of that class\n+   * @param registerCoreReloadListener register a listener for the package and reload the core if the package is changed.\n+   *                                   Use this sparingly. This will result in core reloads across all the cores in\n+   *                                   all collections using this configset\n+   */\n+  public <T> T newInstance(PluginInfo info, Class<T> type, boolean registerCoreReloadListener) {\n+    if(info.cName.pkg == null) {\n+      return newInstance(info.cName.className == null?\n+                      type.getName():\n+                      info.cName.className ,\n+              type);\n+    }\n+    return _classLookup( info, version -> version.getLoader().newInstance(info.cName.className, type), registerCoreReloadListener);", "originalCommit": "6f24116e7182570694f5e701bf1ebec247adaf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eeac7dc6497aeca4db74acfbdc2632ca3788be61", "url": "https://github.com/apache/lucene-solr/commit/eeac7dc6497aeca4db74acfbdc2632ca3788be61", "message": "fix the API to show package version", "committedDate": "2021-01-13T07:11:03Z", "type": "commit"}, {"oid": "bde680fe84f372eebb73b4b2bf0f23c776f2e08e", "url": "https://github.com/apache/lucene-solr/commit/bde680fe84f372eebb73b4b2bf0f23c776f2e08e", "message": "added tests", "committedDate": "2021-01-13T11:01:02Z", "type": "commit"}, {"oid": "693cedd14087660251ded93f042b759c79e860cf", "url": "https://github.com/apache/lucene-solr/commit/693cedd14087660251ded93f042b759c79e860cf", "message": "unused imports", "committedDate": "2021-01-13T11:06:02Z", "type": "commit"}, {"oid": "98bff64f123801e27d48a10db84e4a82ad301de3", "url": "https://github.com/apache/lucene-solr/commit/98bff64f123801e27d48a10db84e4a82ad301de3", "message": "unused imports", "committedDate": "2021-01-13T11:07:26Z", "type": "commit"}, {"oid": "abd8d34ca8f2682b7608eb3a9872ae96ea91b11c", "url": "https://github.com/apache/lucene-solr/commit/abd8d34ca8f2682b7608eb3a9872ae96ea91b11c", "message": "CHANGES.txt", "committedDate": "2021-01-13T11:14:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ5MzYzMw==", "url": "https://github.com/apache/lucene-solr/pull/1666#discussion_r556493633", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method SolrResourceLoader.inform(...) indirectly reads without synchronization from this.coreContainer. Potentially races with write in method SolrResourceLoader.initCore(...).\nReporting because this access may occur on a background thread.", "author": "sonatype-lift", "createdAt": "2021-01-13T12:45:38Z", "path": "solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java", "diffHunk": "@@ -645,15 +648,29 @@ static void clearCache() {\n     }\n   }\n \n+  void initCore(SolrCore core) {\n+    this.coreName = core.getName();\n+    this.config = core.getSolrConfig();\n+    this.coreId = core.uniqueId;\n+    this.coreContainer = core.getCoreContainer();\n+    SolrCore.Provider coreProvider = core.coreProvider;\n+\n+    this.coreReloadingClassLoader = new PackageListeningClassLoader(core.getCoreContainer(),\n+            this, s -> config.maxPackageVersion(s), null){\n+      @Override\n+      protected void doReloadAction(Ctx ctx) {\n+        log.info(\"Core reloading classloader issued reload for: {}/{} \", coreName, coreId);\n+        coreProvider.reload();\n+      }\n+    };\n+    core.getPackageListeners().addListener(coreReloadingClassLoader, true);\n+\n+  }\n \n   /**\n    * Tell all {@link SolrCoreAware} instances about the SolrCore\n    */\n   public void inform(SolrCore core) {\n-    this.coreName = core.getName();\n-    this.config = core.getSolrConfig();\n-    this.coreId = core.uniqueId;\n-    this.coreContainer = core.getCoreContainer();\n     if(getSchemaLoader() != null) core.getPackageListeners().addListener(schemaLoader);", "originalCommit": "98bff64f123801e27d48a10db84e4a82ad301de3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}