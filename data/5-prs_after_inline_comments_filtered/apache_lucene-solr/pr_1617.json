{"pr_number": 1617, "pr_title": "LUCENE-8962: Merge small segments on commit", "pr_createdAt": "2020-06-26T14:04:51Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1617", "timeline": [{"oid": "642e56aba85947ba280e30917b61bdf605c0aa51", "url": "https://github.com/apache/lucene-solr/commit/642e56aba85947ba280e30917b61bdf605c0aa51", "message": "Revert \"Revert \"LUCENE-8962\"\"\n\nThis reverts commit 4501b3d3fdbc35af99bde6abe7432cfc5e8b5547.\n\nThis reverts commit 075adac59865b3277adcf86052f2fae3e6d11135.", "committedDate": "2020-06-03T19:17:35Z", "type": "commit"}, {"oid": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "url": "https://github.com/apache/lucene-solr/commit/cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "message": "Fix case where mergeOnCommit would attempt to delete files twice in the presence of deletions", "committedDate": "2020-06-03T19:17:35Z", "type": "commit"}, {"oid": "bf0f7990e919e9f5428ff4546bb936bfe1b13a3e", "url": "https://github.com/apache/lucene-solr/commit/bf0f7990e919e9f5428ff4546bb936bfe1b13a3e", "message": "fix test failures caused by attempt to merge a no-segments merge", "committedDate": "2020-06-12T21:55:26Z", "type": "commit"}, {"oid": "a707bb4f9e0cb4964b56dddd9f1f001a88f7c9d1", "url": "https://github.com/apache/lucene-solr/commit/a707bb4f9e0cb4964b56dddd9f1f001a88f7c9d1", "message": "Merge branch 'master' into jira/lucene-8962", "committedDate": "2020-06-17T21:00:20Z", "type": "commit"}, {"oid": "85a4193223807f40e80b89d26a4ac53b83180178", "url": "https://github.com/apache/lucene-solr/commit/85a4193223807f40e80b89d26a4ac53b83180178", "message": "current state of affairs", "committedDate": "2020-06-17T21:11:54Z", "type": "commit"}, {"oid": "e1fe0d21754f92d4c2a61d43356315a8ab95a129", "url": "https://github.com/apache/lucene-solr/commit/e1fe0d21754f92d4c2a61d43356315a8ab95a129", "message": "LUCENE-9408: roll back only called once enforcement", "committedDate": "2020-06-17T22:12:44Z", "type": "commit"}, {"oid": "4d6bb8f487557d48913b79b8b90386ab3c949279", "url": "https://github.com/apache/lucene-solr/commit/4d6bb8f487557d48913b79b8b90386ab3c949279", "message": "remove debug code", "committedDate": "2020-06-17T22:12:44Z", "type": "commit"}, {"oid": "650da5431ed9803d03cbc46271c1ca8aee42d35e", "url": "https://github.com/apache/lucene-solr/commit/650da5431ed9803d03cbc46271c1ca8aee42d35e", "message": "Ensure we stop adding to the new commit once we stopped waiting.", "committedDate": "2020-06-17T22:12:52Z", "type": "commit"}, {"oid": "d84691652973aff9aa387a1730a9779939541bd5", "url": "https://github.com/apache/lucene-solr/commit/d84691652973aff9aa387a1730a9779939541bd5", "message": "cut over to long for waitOnCommit and default to 0", "committedDate": "2020-06-17T22:20:20Z", "type": "commit"}, {"oid": "9448ff07cc627155dd9e6902971145714270c8b6", "url": "https://github.com/apache/lucene-solr/commit/9448ff07cc627155dd9e6902971145714270c8b6", "message": "remove IndexWriterEvents", "committedDate": "2020-06-17T22:22:30Z", "type": "commit"}, {"oid": "c8e26ebc6499b7c18c3d5d562ae5ddee6245d629", "url": "https://github.com/apache/lucene-solr/commit/c8e26ebc6499b7c18c3d5d562ae5ddee6245d629", "message": "remove dead code", "committedDate": "2020-06-17T22:30:13Z", "type": "commit"}, {"oid": "d4cfc88567744f786c7ea1994969e2abe25e8f11", "url": "https://github.com/apache/lucene-solr/commit/d4cfc88567744f786c7ea1994969e2abe25e8f11", "message": "Merge branch 'master' into jira/lucene-8962", "committedDate": "2020-06-17T22:33:06Z", "type": "commit"}, {"oid": "338478ab66998a24b4e71c79b08ce5c9c96cb988", "url": "https://github.com/apache/lucene-solr/commit/338478ab66998a24b4e71c79b08ce5c9c96cb988", "message": "remove unused import", "committedDate": "2020-06-17T22:40:28Z", "type": "commit"}, {"oid": "d19e1cde9967228d128639d3b5d295bb9afa2d98", "url": "https://github.com/apache/lucene-solr/commit/d19e1cde9967228d128639d3b5d295bb9afa2d98", "message": "apply fixes for review commnets", "committedDate": "2020-06-18T07:27:46Z", "type": "commit"}, {"oid": "0a096f76520f222db335f67db694184276832bf3", "url": "https://github.com/apache/lucene-solr/commit/0a096f76520f222db335f67db694184276832bf3", "message": "fix javadoc", "committedDate": "2020-06-18T07:37:21Z", "type": "commit"}, {"oid": "ea750da32128aaf0b5bdf5c62c7bfa2655b87b4f", "url": "https://github.com/apache/lucene-solr/commit/ea750da32128aaf0b5bdf5c62c7bfa2655b87b4f", "message": "Merge branch 'master' into jira/lucene-8962", "committedDate": "2020-06-24T16:12:37Z", "type": "commit"}, {"oid": "c29875f964deb4cd04d88ac9b357f0fa0e615237", "url": "https://github.com/apache/lucene-solr/commit/c29875f964deb4cd04d88ac9b357f0fa0e615237", "message": "add failing test for carry-over deletes", "committedDate": "2020-06-24T16:14:44Z", "type": "commit"}, {"oid": "a533094c1479e9e350ad7f364e64f6ec362a62d0", "url": "https://github.com/apache/lucene-solr/commit/a533094c1479e9e350ad7f364e64f6ec362a62d0", "message": "pimp test to randomly use soft-deletes which also check if DV updates work accordingly", "committedDate": "2020-06-24T16:23:50Z", "type": "commit"}, {"oid": "189244b60a137626d5029e1e56899da3acb2f340", "url": "https://github.com/apache/lucene-solr/commit/189244b60a137626d5029e1e56899da3acb2f340", "message": "LUCENE-8962: Ensure we don't include fully deleted segments in a commit\n\nIW might drop segments that are merged into a fully deleted segment on the floor\nand deletes the newly created files right away. We should not include these segments\nin a commit since we can't guarantee valid ref-counts on these files.", "committedDate": "2020-06-24T16:27:37Z", "type": "commit"}, {"oid": "ff17e876c61ba5ecfa4a791527c8a73e1d3f8d5c", "url": "https://github.com/apache/lucene-solr/commit/ff17e876c61ba5ecfa4a791527c8a73e1d3f8d5c", "message": "add prototype to preserve atomicity", "committedDate": "2020-06-24T16:27:53Z", "type": "commit"}, {"oid": "d9b12a00ab82a993683788913092bf918367876e", "url": "https://github.com/apache/lucene-solr/commit/d9b12a00ab82a993683788913092bf918367876e", "message": "ensure we actually apply the updates in the test", "committedDate": "2020-06-24T16:28:57Z", "type": "commit"}, {"oid": "2aa937ef156bd461b423d50abcdb4c01c2af9d79", "url": "https://github.com/apache/lucene-solr/commit/2aa937ef156bd461b423d50abcdb4c01c2af9d79", "message": "apply comments from #1601", "committedDate": "2020-06-24T16:50:04Z", "type": "commit"}, {"oid": "09187e8b305c195e57ff81a174cefa548669c70f", "url": "https://github.com/apache/lucene-solr/commit/09187e8b305c195e57ff81a174cefa548669c70f", "message": "Merge branch 'master' into jira/lucene-8962", "committedDate": "2020-06-24T19:33:40Z", "type": "commit"}, {"oid": "179a730006e9d2462ae6e7ded9c8a21bf014a224", "url": "https://github.com/apache/lucene-solr/commit/179a730006e9d2462ae6e7ded9c8a21bf014a224", "message": "add test and infrastructure to ensure readers are closed when merges are aborted", "committedDate": "2020-06-24T20:10:43Z", "type": "commit"}, {"oid": "827334deef23236884c76deeda17e38f1d950725", "url": "https://github.com/apache/lucene-solr/commit/827334deef23236884c76deeda17e38f1d950725", "message": "remove TODO", "committedDate": "2020-06-24T20:11:19Z", "type": "commit"}, {"oid": "976397ad6500764dba5e998b7c4e6c13bb73569b", "url": "https://github.com/apache/lucene-solr/commit/976397ad6500764dba5e998b7c4e6c13bb73569b", "message": "add a test to stress updateing the same doc wiht merge on commit", "committedDate": "2020-06-24T20:40:23Z", "type": "commit"}, {"oid": "5c37d08cafaacd7532089e352255ca303340c5fe", "url": "https://github.com/apache/lucene-solr/commit/5c37d08cafaacd7532089e352255ca303340c5fe", "message": "fix some tests", "committedDate": "2020-06-24T22:53:21Z", "type": "commit"}, {"oid": "206eea3347ef9ed648fff9ba6100de7c8cea1d69", "url": "https://github.com/apache/lucene-solr/commit/206eea3347ef9ed648fff9ba6100de7c8cea1d69", "message": "fix more tests", "committedDate": "2020-06-25T07:11:02Z", "type": "commit"}, {"oid": "e0e2cf61f120209a9b0a4e898795ef4e85b7074d", "url": "https://github.com/apache/lucene-solr/commit/e0e2cf61f120209a9b0a4e898795ef4e85b7074d", "message": "harden closing merge readers", "committedDate": "2020-06-25T08:55:39Z", "type": "commit"}, {"oid": "3bcce44d62823f0d0d37ca5f0bda0ab0e5ef7c71", "url": "https://github.com/apache/lucene-solr/commit/3bcce44d62823f0d0d37ca5f0bda0ab0e5ef7c71", "message": "add comments to explain what the hell we are doing here", "committedDate": "2020-06-25T09:21:38Z", "type": "commit"}, {"oid": "d895593edfda89ed005c61c1aea515132fc53eb9", "url": "https://github.com/apache/lucene-solr/commit/d895593edfda89ed005c61c1aea515132fc53eb9", "message": "rarely wait longer", "committedDate": "2020-06-25T09:24:27Z", "type": "commit"}, {"oid": "4e17717fb2c986fb4e199830df89dfa4012811a7", "url": "https://github.com/apache/lucene-solr/commit/4e17717fb2c986fb4e199830df89dfa4012811a7", "message": "fix test", "committedDate": "2020-06-25T09:35:07Z", "type": "commit"}, {"oid": "8463279b077a0d4d69c5c48efd1c91ee857fcfe2", "url": "https://github.com/apache/lucene-solr/commit/8463279b077a0d4d69c5c48efd1c91ee857fcfe2", "message": "ensure merge readers are dropped from the list", "committedDate": "2020-06-25T10:16:22Z", "type": "commit"}, {"oid": "d9722b339d8851a4ed7a228f996f97f298189be3", "url": "https://github.com/apache/lucene-solr/commit/d9722b339d8851a4ed7a228f996f97f298189be3", "message": "orgnaize imports", "committedDate": "2020-06-25T10:27:56Z", "type": "commit"}, {"oid": "0f3e26c3cedfefb91e01a70011d630aed37ba314", "url": "https://github.com/apache/lucene-solr/commit/0f3e26c3cedfefb91e01a70011d630aed37ba314", "message": "wait forevery in this test", "committedDate": "2020-06-26T06:56:00Z", "type": "commit"}, {"oid": "2a9580b8e3016294232e4eda0824748169a292bb", "url": "https://github.com/apache/lucene-solr/commit/2a9580b8e3016294232e4eda0824748169a292bb", "message": "cleanup after broken merge", "committedDate": "2020-06-26T13:15:48Z", "type": "commit"}, {"oid": "56351688673a7ce35cfa57a3bbdf9bb53a79e3b9", "url": "https://github.com/apache/lucene-solr/commit/56351688673a7ce35cfa57a3bbdf9bb53a79e3b9", "message": "also remove merge from pending", "committedDate": "2020-06-26T13:18:53Z", "type": "commit"}, {"oid": "20e13b062763c54e2b9c0a3e7161109cabd6c842", "url": "https://github.com/apache/lucene-solr/commit/20e13b062763c54e2b9c0a3e7161109cabd6c842", "message": "remove nl", "committedDate": "2020-06-26T13:19:03Z", "type": "commit"}, {"oid": "1bafae889a97850087f5804dc17dc86f555824e5", "url": "https://github.com/apache/lucene-solr/commit/1bafae889a97850087f5804dc17dc86f555824e5", "message": "fix import", "committedDate": "2020-06-26T14:16:12Z", "type": "commit"}, {"oid": "77152e3c38c05f3c960978f491d0677aa2ccb099", "url": "https://github.com/apache/lucene-solr/commit/77152e3c38c05f3c960978f491d0677aa2ccb099", "message": "wordsmithing javadoc", "committedDate": "2020-06-26T16:09:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2OTcyOA==", "url": "https://github.com/apache/lucene-solr/pull/1617#discussion_r446269728", "bodyText": "Hmm is there some (sneaky) reason why we couldn't just do this.mergeReaders = new ArrayList<>(segments.size()); above and then append to that list?  Instead of appending to private ArrayList and then making a copy in the end?", "author": "mikemccand", "createdAt": "2020-06-26T15:56:52Z", "path": "lucene/core/src/java/org/apache/lucene/index/MergePolicy.java", "diffHunk": "@@ -399,6 +416,40 @@ boolean hasFinished() {\n     Optional<Boolean> hasCompletedSuccessfully() {\n       return Optional.ofNullable(mergeCompleted.getNow(null));\n     }\n+\n+\n+    /**\n+     * Called before the merge is committed\n+     */\n+    void onMergeCommit() {\n+    }\n+\n+    /**\n+     * Sets the merge readers for this merge.\n+     */\n+    void initMergeReaders(IOUtils.IOFunction<SegmentCommitInfo, MergeReader> readerFactory) throws IOException {\n+      assert mergeReaders.isEmpty() : \"merge readers must be empty\";\n+      assert mergeCompleted.isDone() == false : \"merge is already done\";\n+      ArrayList<MergeReader> readers = new ArrayList<>(segments.size());\n+      try {\n+        for (final SegmentCommitInfo info : segments) {\n+          // Hold onto the \"live\" reader; we will use this to\n+          // commit merged deletes\n+          readers.add(readerFactory.apply(info));\n+        }\n+      } finally {\n+        // ensure we assign this to close them in the case of an exception\n+        this.mergeReaders = List.copyOf(readers);", "originalCommit": "1bafae889a97850087f5804dc17dc86f555824e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM3OTk0NQ==", "url": "https://github.com/apache/lucene-solr/pull/1617#discussion_r446379945", "bodyText": "I left a comment. I use immutable lists everywhere here it would be fatal if we modify this list outside of OneMerge. I think that justifies the copy.", "author": "s1monw", "createdAt": "2020-06-26T19:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2OTcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI5MzEyMw==", "url": "https://github.com/apache/lucene-solr/pull/1617#discussion_r446293123", "bodyText": "Hmm how did this sneak in?", "author": "mikemccand", "createdAt": "2020-06-26T16:41:49Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriterConfig.java", "diffHunk": "@@ -459,6 +463,27 @@ public IndexWriterConfig setCommitOnClose(boolean commitOnClose) {\n     return this;\n   }\n \n+  /**\n+   * Expert: sets the amount of time to wait for merges returned by MergePolicy.findFullFlushMerges(...).\n+   * If this time is reached, we proceed with the commit based on segments merged up to that point.\n+   * The merges are not cancelled, and will still run to completion independent of the commit\n+   * like normal segment merges. The default is <code>{@value IndexWriterConfig#DEFAULT_MAX_COMMIT_MERGE_WAIT_MILLIS}</code>.\n+   *\n+   * Note: This settings has no effect unless {@link MergePolicy#findFullFlushMerges(MergeTrigger, SegmentInfos, MergePolicy.MergeContext)}\n+   * has an implementation that actually returns merges which by default doesn't return any merges.\n+   */\n+  public IndexWriterConfig setMaxCommitMergeWaitMillis(long maxCommitMergeWaitMillis) {\n+    this.maxCommitMergeWaitMillis = maxCommitMergeWaitMillis;\n+    return this;\n+  }\n+\n+  /** We only allow sorting on these types */\n+  private static final EnumSet<SortField.Type> ALLOWED_INDEX_SORT_TYPES = EnumSet.of(SortField.Type.STRING,", "originalCommit": "77152e3c38c05f3c960978f491d0677aa2ccb099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0OTk5MA==", "url": "https://github.com/apache/lucene-solr/pull/1617#discussion_r446349990", "bodyText": "OK I see this was removed earlier in mainline for LUCENE-9330 -- it must've snuck back in as a merge conflict.\nI'll re-remove now.", "author": "mikemccand", "createdAt": "2020-06-26T18:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI5MzEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM4MDAwMw==", "url": "https://github.com/apache/lucene-solr/pull/1617#discussion_r446380003", "bodyText": "\ud83d\udc4d", "author": "s1monw", "createdAt": "2020-06-26T19:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI5MzEyMw=="}], "type": "inlineReview"}, {"oid": "3d3af907f511f022659b0402e5c150b1247453ff", "url": "https://github.com/apache/lucene-solr/commit/3d3af907f511f022659b0402e5c150b1247453ff", "message": "LUCENE-8962: tweak comments/javadoc, rename one method (onMergeCommit -> onMergeCompleted)", "committedDate": "2020-06-26T17:43:39Z", "type": "commit"}, {"oid": "478fe9c681092f4cf1020a51b7a50fa24eb80db5", "url": "https://github.com/apache/lucene-solr/commit/478fe9c681092f4cf1020a51b7a50fa24eb80db5", "message": "LUCENE-8962: remove ghost EnumSet code", "committedDate": "2020-06-26T18:57:23Z", "type": "commit"}, {"oid": "fbca89687ddcda15badfee1ae01e883295da51c6", "url": "https://github.com/apache/lucene-solr/commit/fbca89687ddcda15badfee1ae01e883295da51c6", "message": "leave comment why we use List.copyOf", "committedDate": "2020-06-26T19:50:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM4MTkwOA==", "url": "https://github.com/apache/lucene-solr/pull/1617#discussion_r446381908", "bodyText": "I am torn if we'd use a double or long here. I think we used double in other places but I do like a discrete value better...", "author": "s1monw", "createdAt": "2020-06-26T19:56:22Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriterConfig.java", "diffHunk": "@@ -459,6 +463,21 @@ public IndexWriterConfig setCommitOnClose(boolean commitOnClose) {\n     return this;\n   }\n \n+  /**\n+   * Expert: sets the amount of time to wait for merges (during {@link IndexWriter#commit}) returned by\n+   * MergePolicy.findFullFlushMerges(...).\n+   * If this time is reached, we proceed with the commit based on segments merged up to that point.\n+   * The merges are not cancelled, and will still run to completion independent of the commit,\n+   * like natural segment merges. The default is <code>{@value IndexWriterConfig#DEFAULT_MAX_COMMIT_MERGE_WAIT_MILLIS}</code>.\n+   *\n+   * Note: This settings has no effect unless {@link MergePolicy#findFullFlushMerges(MergeTrigger, SegmentInfos, MergePolicy.MergeContext)}\n+   * has an implementation that actually returns merges which by default doesn't return any merges.\n+   */\n+  public IndexWriterConfig setMaxCommitMergeWaitMillis(long maxCommitMergeWaitMillis) {", "originalCommit": "fbca89687ddcda15badfee1ae01e883295da51c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8235076e07fd15ebac1a61289e378dde1519047a", "url": "https://github.com/apache/lucene-solr/commit/8235076e07fd15ebac1a61289e378dde1519047a", "message": "fix imports", "committedDate": "2020-06-26T20:02:09Z", "type": "commit"}, {"oid": "5078c3f36c6ce60b747705a1fc12f1a6d3a8e711", "url": "https://github.com/apache/lucene-solr/commit/5078c3f36c6ce60b747705a1fc12f1a6d3a8e711", "message": "fix TestPhraseWildcardQuery", "committedDate": "2020-06-26T20:56:37Z", "type": "commit"}, {"oid": "ae8ac0cba211b0dba497944cf40b526cb697fe65", "url": "https://github.com/apache/lucene-solr/commit/ae8ac0cba211b0dba497944cf40b526cb697fe65", "message": "LUCENE-8962: add some IndexWriter verbosity about what commit-on-merge is doing; fix test case to use deterministic merging", "committedDate": "2020-06-26T23:03:06Z", "type": "commit"}, {"oid": "c368f6dab21a3c29fc952eea582fed4a5a4406ba", "url": "https://github.com/apache/lucene-solr/commit/c368f6dab21a3c29fc952eea582fed4a5a4406ba", "message": "LUCENE-8962: fix TestPhraseWildcardQuery to never merge its two required segments", "committedDate": "2020-06-27T19:29:22Z", "type": "commit"}]}