{"pr_number": 1585, "pr_title": "LUCENE-8962: Allow waiting for all merges in a merge spec", "pr_createdAt": "2020-06-16T20:23:25Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1585", "timeline": [{"oid": "fabf29acc261d7dab256abf63938bf2406d7fc28", "url": "https://github.com/apache/lucene-solr/commit/fabf29acc261d7dab256abf63938bf2406d7fc28", "message": "LUCENE-8962: Allow waiting for all merges in a merge spec\n\nThis change adds infrastructure to allow straight forward waiting\non one or more merges or an entire merge specification. This is\na basis for LUCENE-8962.", "committedDate": "2020-06-16T20:19:59Z", "type": "commit"}, {"oid": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "url": "https://github.com/apache/lucene-solr/commit/c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "message": "remove unused import", "committedDate": "2020-06-16T20:30:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0MDIyNg==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441140226", "bodyText": "What I learned today: CompletableFuture.allOf(....) -- cool, thanks!  So elegant.\nLet me try and return the favor:\nYou can go directly to an array, avoiding toList:\nCompletableFuture<Void> future = CompletableFuture.allOf(merges.stream()\n            .map(m -> m.completable).toArray(CompletableFuture<?>[]::new));\n\nBTW IntelliJ pointed this out and had an automatic replacement when I hovered my cursor over \"collect\".", "author": "dsmiley", "createdAt": "2020-06-16T21:02:49Z", "path": "lucene/core/src/java/org/apache/lucene/index/MergePolicy.java", "diffHunk": "@@ -399,6 +427,23 @@ public String segString(Directory dir) {\n       }\n       return b.toString();\n     }\n+\n+    /**\n+     * Waits if necessary for at most the given time for all merges.\n+     */\n+    boolean await(long timeout, TimeUnit unit) {\n+      try {\n+        CompletableFuture<Void> future = CompletableFuture.allOf(merges.stream()", "originalCommit": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU4MTY1OQ==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441581659", "bodyText": "done thanks", "author": "s1monw", "createdAt": "2020-06-17T14:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0MDIyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0ODA4NQ==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441148085", "bodyText": "In my change, I remember I originally tried handling the InterruptedException while waiting for the CountDownLatch in a similar way, but it caused an intermittent test failure (in TestIndexWriterWithThreads, maybe?) You might run into the same test failure once you start calling this await method from within IndexWriter.\nI was able to get the test passing by rethrowing it wrapped in a ThreadInterruptedException.", "author": "msfroh", "createdAt": "2020-06-16T21:18:42Z", "path": "lucene/core/src/java/org/apache/lucene/index/MergePolicy.java", "diffHunk": "@@ -399,6 +427,23 @@ public String segString(Directory dir) {\n       }\n       return b.toString();\n     }\n+\n+    /**\n+     * Waits if necessary for at most the given time for all merges.\n+     */\n+    boolean await(long timeout, TimeUnit unit) {\n+      try {\n+        CompletableFuture<Void> future = CompletableFuture.allOf(merges.stream()\n+            .map(m -> m.completable).collect(Collectors.toList()).toArray(new CompletableFuture<?>[0]));\n+        future.get(timeout, unit);\n+        return true;\n+      } catch (InterruptedException e) {\n+        Thread.interrupted();", "originalCommit": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU4MTU2MA==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441581560", "bodyText": "done", "author": "s1monw", "createdAt": "2020-06-17T14:18:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0ODA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE3MDMyMA==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441170320", "bodyText": "how about some spaces around the operator==?", "author": "msokolov", "createdAt": "2020-06-16T22:09:48Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -4289,7 +4287,7 @@ private synchronized void mergeFinish(MergePolicy.OneMerge merge) {\n   @SuppressWarnings(\"try\")\n   private synchronized void closeMergeReaders(MergePolicy.OneMerge merge, boolean suppressExceptions) throws IOException {\n     final boolean drop = suppressExceptions == false;\n-    try (Closeable finalizer = merge::mergeFinished) {\n+    try (Closeable finalizer = () -> merge.mergeFinished(suppressExceptions==false)) {", "originalCommit": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU4MTQ4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441581487", "bodyText": "done", "author": "s1monw", "createdAt": "2020-06-17T14:18:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE3MDMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1OTA4NQ==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441559085", "bodyText": "Maybe add javadoc about the lack of thread safety here?  I.e. this could return false and shortly thereafter it becomes true.", "author": "mikemccand", "createdAt": "2020-06-17T13:48:26Z", "path": "lucene/core/src/java/org/apache/lucene/index/MergePolicy.java", "diffHunk": "@@ -362,6 +366,30 @@ public void checkAborted() throws MergeAbortedException {\n     public OneMergeProgress getMergeProgress() {\n       return mergeProgress;\n     }\n+\n+    /**\n+     * Waits for this merge to be completed\n+     * @return true if the merge finished within the specified timeout\n+     */\n+    boolean await(long timeout, TimeUnit timeUnit) {\n+      try {\n+        completable.get(timeout, timeUnit);\n+        return true;\n+      } catch (InterruptedException e) {\n+        Thread.interrupted();\n+        return false;\n+      } catch (ExecutionException | TimeoutException e) {\n+        return false;\n+      }\n+    }\n+\n+    boolean isDone() {", "originalCommit": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1OTE4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441559187", "bodyText": "Javadoc here too?", "author": "mikemccand", "createdAt": "2020-06-17T13:48:35Z", "path": "lucene/core/src/java/org/apache/lucene/index/MergePolicy.java", "diffHunk": "@@ -362,6 +366,30 @@ public void checkAborted() throws MergeAbortedException {\n     public OneMergeProgress getMergeProgress() {\n       return mergeProgress;\n     }\n+\n+    /**\n+     * Waits for this merge to be completed\n+     * @return true if the merge finished within the specified timeout\n+     */\n+    boolean await(long timeout, TimeUnit timeUnit) {\n+      try {\n+        completable.get(timeout, timeUnit);\n+        return true;\n+      } catch (InterruptedException e) {\n+        Thread.interrupted();\n+        return false;\n+      } catch (ExecutionException | TimeoutException e) {\n+        return false;\n+      }\n+    }\n+\n+    boolean isDone() {\n+      return completable.isDone();\n+    }\n+\n+    boolean isCommitted() {\n+      return completable.getNow(Boolean.FALSE);", "originalCommit": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1OTUwOQ==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441559509", "bodyText": "Could we rename the variable to completed or maybe mergeCompleted?", "author": "mikemccand", "createdAt": "2020-06-17T13:49:04Z", "path": "lucene/core/src/java/org/apache/lucene/index/MergePolicy.java", "diffHunk": "@@ -196,6 +200,7 @@ final void setMergeThread(Thread owner) {\n    *\n    * @lucene.experimental */\n   public static class OneMerge {\n+    private final CompletableFuture<Boolean> completable = new CompletableFuture<>();", "originalCommit": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2MTc4OA==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441561788", "bodyText": "Maybe we should (later, in dedicated PR) pull this out into its own java source?", "author": "mikemccand", "createdAt": "2020-06-17T13:52:09Z", "path": "lucene/core/src/java/org/apache/lucene/index/MergePolicy.java", "diffHunk": "@@ -196,6 +200,7 @@ final void setMergeThread(Thread owner) {\n    *\n    * @lucene.experimental */\n   public static class OneMerge {", "originalCommit": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU3NTgyOA==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441575828", "bodyText": "yeah I want to do that anyway", "author": "s1monw", "createdAt": "2020-06-17T14:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2MTc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2Mjk5NQ==", "url": "https://github.com/apache/lucene-solr/pull/1585#discussion_r441562995", "bodyText": "Maybe rename to isCompleted?  committed is overloaded term -- could try to mean its files got fsync'd :)", "author": "mikemccand", "createdAt": "2020-06-17T13:53:47Z", "path": "lucene/core/src/java/org/apache/lucene/index/MergePolicy.java", "diffHunk": "@@ -362,6 +366,30 @@ public void checkAborted() throws MergeAbortedException {\n     public OneMergeProgress getMergeProgress() {\n       return mergeProgress;\n     }\n+\n+    /**\n+     * Waits for this merge to be completed\n+     * @return true if the merge finished within the specified timeout\n+     */\n+    boolean await(long timeout, TimeUnit timeUnit) {\n+      try {\n+        completable.get(timeout, timeUnit);\n+        return true;\n+      } catch (InterruptedException e) {\n+        Thread.interrupted();\n+        return false;\n+      } catch (ExecutionException | TimeoutException e) {\n+        return false;\n+      }\n+    }\n+\n+    boolean isDone() {\n+      return completable.isDone();\n+    }\n+\n+    boolean isCommitted() {", "originalCommit": "c6516ef4e24320bf352d0eed59f5a72d1e0843ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1c151fe424fbb525f02999d26be4ee73654229ea", "url": "https://github.com/apache/lucene-solr/commit/1c151fe424fbb525f02999d26be4ee73654229ea", "message": "apply feeedback", "committedDate": "2020-06-17T14:18:17Z", "type": "commit"}]}