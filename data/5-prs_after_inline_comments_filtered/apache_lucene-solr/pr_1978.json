{"pr_number": 1978, "pr_title": "LUCENE-9524: Fix NPE in SpanWeight#explain when no scoring is require\u2026", "pr_createdAt": "2020-10-13T04:56:52Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1978", "timeline": [{"oid": "f510fc952c383f58e04f80770aedf2615dce80d5", "url": "https://github.com/apache/lucene-solr/commit/f510fc952c383f58e04f80770aedf2615dce80d5", "message": "LUCENE-9524: Fix NPE in SpanWeight#explain when no scoring is required and SpanWeight has null Similarity.SimScorer.", "committedDate": "2020-10-13T04:55:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NzQzNA==", "url": "https://github.com/apache/lucene-solr/pull/1978#discussion_r504977434", "bodyText": "can you assert on the explanation string?", "author": "jpountz", "createdAt": "2020-10-14T21:17:39Z", "path": "lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndex.java", "diffHunk": "@@ -618,4 +622,21 @@ public void testToStringDebug() {\n         \"fields=2, terms=2, positions=3\", mi.toStringDebug());\n   }\n \n+  public void testExplain() throws ParseException, IOException {\n+    String queryString = \"(lorem AND NOT \\\"dolor lorem\\\") OR ipsum\";\n+    String text = \"dolor lorem ipsum\";\n+\n+    Analyzer analyzer = new MockAnalyzer(random());\n+    Query query = new ComplexPhraseQueryParser(\"content\", analyzer).parse(queryString);\n+\n+    MemoryIndex memoryIndex = new MemoryIndex(true);\n+    memoryIndex.addField(\"content\", text, analyzer);\n+\n+    IndexSearcher searcher = memoryIndex.createSearcher();\n+\n+    TopDocs topDocs = searcher.search(query, 1);\n+    ScoreDoc match = topDocs.scoreDocs[0];\n+    searcher.explain(query, match.doc);", "originalCommit": "f510fc952c383f58e04f80770aedf2615dce80d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEyNzc2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1978#discussion_r505127766", "bodyText": "I've tried this and it seems to be a bit more complicated to do. The problem here is that under the current test setup, the new explanation string code will only be exercised when there's a match between the (none-scoring) prohibited clause and the text.  So the matched topDoc that exercised that code path will actually not include that particular explanation as it must have been matching alternative clause instead.\nTherefore, I'm considering two alternatives here. One would be to test SpanWeight#explain directly with null SimScorer; the other would be to setup another test to match span query without scoring, but I tried query with Occur.FILTER and MUST and see there's still a 1.0 boost associated and valid SimScorer. So I'm not sure if the latter approach is something actually achievable / meaningful to implement?", "author": "zacharymorn", "createdAt": "2020-10-15T02:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NzQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NzgyNQ==", "url": "https://github.com/apache/lucene-solr/pull/1978#discussion_r505987825", "bodyText": "I've found a work-around in test and able to test with tighter condition, and assert for explanation message. Could you please let me know if this looks good to you?", "author": "zacharymorn", "createdAt": "2020-10-16T02:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NzQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwOTgyMA==", "url": "https://github.com/apache/lucene-solr/pull/1978#discussion_r505009820", "bodyText": "I don't think this is specific to MemoryIndex, so can you move this test to TestSpansExplanations?", "author": "jpountz", "createdAt": "2020-10-14T22:10:19Z", "path": "lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndex.java", "diffHunk": "@@ -618,4 +622,21 @@ public void testToStringDebug() {\n         \"fields=2, terms=2, positions=3\", mi.toStringDebug());\n   }\n \n+  public void testExplain() throws ParseException, IOException {", "originalCommit": "f510fc952c383f58e04f80770aedf2615dce80d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEyNDUyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1978#discussion_r505124529", "bodyText": "Done", "author": "zacharymorn", "createdAt": "2020-10-15T02:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwOTgyMA=="}], "type": "inlineReview"}, {"oid": "d06473da5f1c5a2ccd0e52dd76a90d0ed8af032d", "url": "https://github.com/apache/lucene-solr/commit/d06473da5f1c5a2ccd0e52dd76a90d0ed8af032d", "message": "LUCENE-9524: Move integration test from TestMemoryIndex to TestSpanExplanations", "committedDate": "2020-10-15T02:18:18Z", "type": "commit"}, {"oid": "9d96fe6a5e177df1d3fcb617cb13cfefb4ff674b", "url": "https://github.com/apache/lucene-solr/commit/9d96fe6a5e177df1d3fcb617cb13cfefb4ff674b", "message": "LUCENE-9524: Use more focused logic for testing null simScorer scenaior, and assert on explanation", "committedDate": "2020-10-16T00:32:52Z", "type": "commit"}, {"oid": "a66a8e13d996da01528b66f1e59f91ff0d736c06", "url": "https://github.com/apache/lucene-solr/commit/a66a8e13d996da01528b66f1e59f91ff0d736c06", "message": "LUCENE-9524: Remove no longer needed dependency", "committedDate": "2020-10-16T12:13:38Z", "type": "commit"}]}