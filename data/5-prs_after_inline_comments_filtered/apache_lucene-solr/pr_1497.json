{"pr_number": 1497, "pr_title": "SOLR-8394: /admin/luke didn't computeindexHeapUsageBytes", "pr_createdAt": "2020-05-07T19:11:51Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1497", "timeline": [{"oid": "af4742ad2fff5a950ce096e1582519fd13720d77", "url": "https://github.com/apache/lucene-solr/commit/af4742ad2fff5a950ce096e1582519fd13720d77", "message": "SOLR-8394: /admin/luke didn't computeindexHeapUsageBytes\nNeeded to call FilterLeafReader.unwrap.", "committedDate": "2020-05-07T19:09:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMDU0Mw==", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r423600543", "bodyText": "I like the first 4 lines (this is rare for me to see a clear stream). But the last 2 lines are less clear, it took me some time to understand why it's needed.", "author": "bruno-roustant", "createdAt": "2020-05-12T09:38:45Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "diffHunk": "@@ -634,17 +635,19 @@ private static long getSegmentsFileLength(IndexCommit commit) {\n \n   /** Returns the sum of RAM bytes used by each segment */\n   private static long getIndexHeapUsed(DirectoryReader reader) {\n-    long indexHeapRamBytesUsed = 0;\n-    for(LeafReaderContext leafReaderContext : reader.leaves()) {\n-      LeafReader leafReader = leafReaderContext.reader();\n-      if (leafReader instanceof SegmentReader) {\n-        indexHeapRamBytesUsed += ((SegmentReader) leafReader).ramBytesUsed();\n-      } else {\n-        // Not supported for any reader that is not a SegmentReader\n-        return -1;\n-      }\n-    }\n-    return indexHeapRamBytesUsed;\n+    return reader.leaves().stream()\n+        .map(LeafReaderContext::reader)\n+        .map(FilterLeafReader::unwrap)\n+        .map(leafReader -> {\n+          if (leafReader instanceof Accountable) {\n+            return ((Accountable) leafReader).ramBytesUsed();\n+          } else {\n+            return -1L; // unsupported\n+          }\n+        })\n+        .mapToLong(Long::longValue)\n+        .reduce(0, (left, right) -> left == -1 || right == -1 ? -1 : left + right);", "originalCommit": "af4742ad2fff5a950ce096e1582519fd13720d77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "525616cd949af1dd12e8231df9e9f4e718519d97", "url": "https://github.com/apache/lucene-solr/commit/525616cd949af1dd12e8231df9e9f4e718519d97", "message": "Merge branch 'master' into solr-8394-lukeIndexHeapUsageBytes", "committedDate": "2020-05-15T18:01:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwOTcwNg==", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r426509706", "bodyText": "can we filter here instead?", "author": "juanka588", "createdAt": "2020-05-18T09:58:32Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "diffHunk": "@@ -634,17 +635,19 @@ private static long getSegmentsFileLength(IndexCommit commit) {\n \n   /** Returns the sum of RAM bytes used by each segment */\n   private static long getIndexHeapUsed(DirectoryReader reader) {\n-    long indexHeapRamBytesUsed = 0;\n-    for(LeafReaderContext leafReaderContext : reader.leaves()) {\n-      LeafReader leafReader = leafReaderContext.reader();\n-      if (leafReader instanceof SegmentReader) {\n-        indexHeapRamBytesUsed += ((SegmentReader) leafReader).ramBytesUsed();\n-      } else {\n-        // Not supported for any reader that is not a SegmentReader\n-        return -1;\n-      }\n-    }\n-    return indexHeapRamBytesUsed;\n+    return reader.leaves().stream()\n+        .map(LeafReaderContext::reader)\n+        .map(FilterLeafReader::unwrap)\n+        .map(leafReader -> {\n+          if (leafReader instanceof Accountable) {", "originalCommit": "525616cd949af1dd12e8231df9e9f4e718519d97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUxMDMyMw==", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r426510323", "bodyText": "or map into accountable returning -1L", "author": "juanka588", "createdAt": "2020-05-18T09:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwOTcwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyOTkyNA==", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r426829924", "bodyText": "Feel free to suggest a code snippet; I'm not sure I get it.\nOne small improvement I see I could make was change the last \"map\" call to be a \"mapToLong\" instead, and then I can remove the last mapToLong.", "author": "dsmiley", "createdAt": "2020-05-18T18:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwOTcwNg=="}], "type": "inlineReview"}]}