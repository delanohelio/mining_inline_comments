{"pr_number": 1848, "pr_title": "LUCENE-9515: Detach DWPT from DefaultIndexingChain", "pr_createdAt": "2020-09-09T08:30:15Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1848", "timeline": [{"oid": "1f373a92853f6df6c4a5640f08d72bdf5a5d3b41", "url": "https://github.com/apache/lucene-solr/commit/1f373a92853f6df6c4a5640f08d72bdf5a5d3b41", "message": "LUCENE-9515: Detach DWPT from DefaultIndexingChain\n\nThis change removes the DWPT dependency from DefaultIndexingChain\nand rather passes on the primitives needed for creating the chain.", "committedDate": "2020-09-09T08:24:37Z", "type": "commit"}, {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9", "url": "https://github.com/apache/lucene-solr/commit/d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9", "message": "fix imports", "committedDate": "2020-09-09T08:51:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5ODYzMA==", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r485498630", "bodyText": "Don't need the = false -- it is java's default already.", "author": "mikemccand", "createdAt": "2020-09-09T10:12:26Z", "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "diffHunk": "@@ -73,21 +78,38 @@\n   // Holds fields seen in each document\n   private PerField[] fields = new PerField[1];\n   private final InfoStream infoStream;\n-\n-  DefaultIndexingChain(DocumentsWriterPerThread docWriter) {\n-    this.docWriter = docWriter;\n-    this.fieldInfos = docWriter.getFieldInfosBuilder();\n-    this.infoStream = docWriter.getIndexWriterConfig().getInfoStream();\n+  private final ByteBlockPool.Allocator byteBlockAllocator;\n+  private final LiveIndexWriterConfig indexWriterConfig;\n+  private final int indexCreatedVersionMajor;\n+  private final Consumer<Throwable> abortingExceptionConsumer;\n+  private boolean hasHitAbortingException = false;", "originalCommit": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5OTg1Mw==", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r485499853", "bodyText": "This was moved from DWPT?\nAhh, no, we forked it from there, ok.", "author": "mikemccand", "createdAt": "2020-09-09T10:14:38Z", "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "diffHunk": "@@ -73,21 +78,38 @@\n   // Holds fields seen in each document\n   private PerField[] fields = new PerField[1];\n   private final InfoStream infoStream;\n-\n-  DefaultIndexingChain(DocumentsWriterPerThread docWriter) {\n-    this.docWriter = docWriter;\n-    this.fieldInfos = docWriter.getFieldInfosBuilder();\n-    this.infoStream = docWriter.getIndexWriterConfig().getInfoStream();\n+  private final ByteBlockPool.Allocator byteBlockAllocator;\n+  private final LiveIndexWriterConfig indexWriterConfig;\n+  private final int indexCreatedVersionMajor;\n+  private final Consumer<Throwable> abortingExceptionConsumer;\n+  private boolean hasHitAbortingException = false;\n+\n+  DefaultIndexingChain(int indexCreatedVersionMajor, SegmentInfo segmentInfo, Directory directory, FieldInfos.Builder fieldInfos, LiveIndexWriterConfig indexWriterConfig,\n+                       Consumer<Throwable> abortingExceptionConsumer) {\n+    this.indexCreatedVersionMajor = indexCreatedVersionMajor;\n+    byteBlockAllocator = new ByteBlockPool.DirectTrackingAllocator(bytesUsed);\n+    IntBlockPool.Allocator intBlockAllocator = new IntBlockAllocator(bytesUsed);\n+    this.indexWriterConfig = indexWriterConfig;\n+    assert segmentInfo.getIndexSort() == indexWriterConfig.getIndexSort();\n+    this.fieldInfos = fieldInfos;\n+    this.infoStream = indexWriterConfig.getInfoStream();\n+    this.abortingExceptionConsumer = abortingExceptionConsumer;\n \n     final TermsHash termVectorsWriter;\n-    if (docWriter.getSegmentInfo().getIndexSort() == null) {\n-      storedFieldsConsumer = new StoredFieldsConsumer(docWriter.codec, docWriter.directory, docWriter.getSegmentInfo());\n-      termVectorsWriter = new TermVectorsConsumer(docWriter);\n+    if (segmentInfo.getIndexSort() == null) {\n+      storedFieldsConsumer = new StoredFieldsConsumer(indexWriterConfig.getCodec(), directory, segmentInfo);\n+      termVectorsWriter = new TermVectorsConsumer(intBlockAllocator, byteBlockAllocator, directory, segmentInfo, indexWriterConfig.getCodec());\n     } else {\n-      storedFieldsConsumer = new SortingStoredFieldsConsumer(docWriter.codec, docWriter.directory, docWriter.getSegmentInfo());\n-      termVectorsWriter = new SortingTermVectorsConsumer(docWriter);\n+      storedFieldsConsumer = new SortingStoredFieldsConsumer(indexWriterConfig.getCodec(), directory, segmentInfo);\n+      termVectorsWriter = new SortingTermVectorsConsumer(intBlockAllocator, byteBlockAllocator, directory, segmentInfo, indexWriterConfig.getCodec());\n     }\n-    termsHash = new FreqProxTermsWriter(docWriter, bytesUsed, termVectorsWriter);\n+    termsHash = new FreqProxTermsWriter(intBlockAllocator, byteBlockAllocator, bytesUsed, termVectorsWriter);\n+  }\n+\n+  private void onAbortingException(Throwable th) {", "originalCommit": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5NzA4NA==", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r487697084", "bodyText": "yeah I just tried to not repeat the assignment of hasHitAbortingException", "author": "s1monw", "createdAt": "2020-09-14T07:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5OTg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NDcwMQ==", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r485644701", "bodyText": "Maybe remove this stale comment :)  FieldCache is long gone!", "author": "mikemccand", "createdAt": "2020-09-09T14:12:41Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -272,7 +273,9 @@ static int getActualMaxDocs() {\n    * and a message is printed to infoStream, if set (see {@link\n    * IndexWriterConfig#setInfoStream(InfoStream)}).\n    */\n-  public final static int MAX_TERM_LENGTH = DocumentsWriterPerThread.MAX_TERM_LENGTH_UTF8;\n+  // if you increase this, you must fix field cache impl for\n+  // getTerms/getTermsIndex requires <= 32768", "originalCommit": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NzYzMQ==", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r485647631", "bodyText": "Ooh good catch (char[] vs byte[]).", "author": "mikemccand", "createdAt": "2020-09-09T14:16:31Z", "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriter.java", "diffHunk": "@@ -1533,7 +1533,7 @@ public void testWickedLongTerm() throws IOException {\n     Directory dir = newDirectory();\n     RandomIndexWriter w = new RandomIndexWriter(random(), dir, new StringSplitAnalyzer());\n \n-    char[] chars = new char[DocumentsWriterPerThread.MAX_TERM_LENGTH_UTF8];\n+    char[] chars = new char[IndexWriter.MAX_TERM_LENGTH];", "originalCommit": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f5b161ca7741d219bb2efd5dfe0a87eb39ed711", "url": "https://github.com/apache/lucene-solr/commit/6f5b161ca7741d219bb2efd5dfe0a87eb39ed711", "message": "apply feedback", "committedDate": "2020-09-14T07:14:50Z", "type": "commit"}, {"oid": "ab9287a2b6fdcf438a43a4e8e64eb644f8119695", "url": "https://github.com/apache/lucene-solr/commit/ab9287a2b6fdcf438a43a4e8e64eb644f8119695", "message": "Merge branch 'master' into detach_dwpt_from_indexing_chain", "committedDate": "2020-09-14T07:21:47Z", "type": "commit"}, {"oid": "f92ca0d55478a20dcbdfcead4fac2930a2e701d9", "url": "https://github.com/apache/lucene-solr/commit/f92ca0d55478a20dcbdfcead4fac2930a2e701d9", "message": "add changes", "committedDate": "2020-09-14T07:26:00Z", "type": "commit"}]}