{"pr_number": 1772, "pr_title": "LUCENE-9473: Ensure merges are stopped during abort merges", "pr_createdAt": "2020-08-21T13:56:54Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1772", "timeline": [{"oid": "97ac24e7c7e7ccf5bffd341d737e88eeb6e300f3", "url": "https://github.com/apache/lucene-solr/commit/97ac24e7c7e7ccf5bffd341d737e88eeb6e300f3", "message": "LUCENE-9473: Ensure merges are stopped during abort merges\n\nWe need to disable merges while we wait for running merges since\nIW calls timed wait on it's lock that releases the monitor for the time\nbeing which allows new merges to be registered unless we disable them.", "committedDate": "2020-08-21T13:55:54Z", "type": "commit"}, {"oid": "69e85559b0b797dba2c8a4c3303e88e9111f0e77", "url": "https://github.com/apache/lucene-solr/commit/69e85559b0b797dba2c8a4c3303e88e9111f0e77", "message": "fix imports", "committedDate": "2020-08-21T13:57:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc1MzcxNA==", "url": "https://github.com/apache/lucene-solr/pull/1772#discussion_r474753714", "bodyText": "I think this closed variable is not used?", "author": "dnhatn", "createdAt": "2020-08-21T15:00:50Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -5728,4 +5735,25 @@ public String toString() {\n       return writer.segString();\n     }\n   }\n+\n+  private class Merges {\n+    boolean closed = false;", "originalCommit": "69e85559b0b797dba2c8a4c3303e88e9111f0e77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1Mzk5OQ==", "url": "https://github.com/apache/lucene-solr/pull/1772#discussion_r474853999", "bodyText": "right! thanks that's a leftover", "author": "s1monw", "createdAt": "2020-08-21T18:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc1MzcxNA=="}], "type": "inlineReview"}, {"oid": "8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619", "url": "https://github.com/apache/lucene-solr/commit/8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619", "message": "remove dead variable", "committedDate": "2020-08-21T18:18:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE3Nzg3NA==", "url": "https://github.com/apache/lucene-solr/pull/1772#discussion_r475177874", "bodyText": "Nice -- this forced merge-on-getReader/commit to be used more often in this test?", "author": "mikemccand", "createdAt": "2020-08-23T06:28:58Z", "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriterDelete.java", "diffHunk": "@@ -300,10 +300,11 @@ public void testDeleteAllSimple() throws IOException {\n     modifier.close();\n     dir.close();\n   }\n-  \n+\n   public void testDeleteAllNoDeadLock() throws IOException, InterruptedException {\n     Directory dir = newDirectory();\n-    final RandomIndexWriter modifier = new RandomIndexWriter(random(), dir); \n+    final RandomIndexWriter modifier = new RandomIndexWriter(random(), dir,\n+        newIndexWriterConfig().setMergePolicy(new MockRandomMergePolicy(random())));", "originalCommit": "8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4NzQ0OA==", "url": "https://github.com/apache/lucene-solr/pull/1772#discussion_r475387448", "bodyText": "no it's really only to make sure we running more random merges since this triggered the issue.", "author": "s1monw", "createdAt": "2020-08-24T07:15:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE3Nzg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE3Nzg4Mg==", "url": "https://github.com/apache/lucene-solr/pull/1772#discussion_r475177882", "bodyText": "Aha, this is the meat of the change!  We need to be able to stop all running merges, but not prevent new merges.\nMaybe add a comment explaining this?  The code looks a little odd to abortMerges to only then merges.enable() in a finally clause.  The finally clause is necessary here because on exception we want to be certain to re-enable merges?  An exception during abortMerges is not tragic for IW right?  I.e. it can resume operations, and maybe not all docs were deleted?", "author": "mikemccand", "createdAt": "2020-08-23T06:29:03Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -2427,7 +2426,13 @@ public long deleteAll() throws IOException {\n           synchronized (this) {\n             try {\n               // Abort any running merges\n-              abortMerges();\n+              try {\n+                abortMerges();\n+                assert merges.areEnabled() == false : \"merges should be disabled - who enabled them?\";\n+                assert mergingSegments.isEmpty() : \"found merging segments but merges are disabled: \" + mergingSegments;\n+              } finally {\n+                merges.enable();", "originalCommit": "8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "74a4b3a64b4edba918f072a84614bb36b927f150", "url": "https://github.com/apache/lucene-solr/commit/74a4b3a64b4edba918f072a84614bb36b927f150", "message": "add comment", "committedDate": "2020-08-24T07:14:27Z", "type": "commit"}]}