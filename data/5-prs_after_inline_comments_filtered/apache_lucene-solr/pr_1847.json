{"pr_number": 1847, "pr_title": "LUCENE-9514: Include TermVectorsWriter in DWPT accounting", "pr_createdAt": "2020-09-09T07:35:32Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1847", "timeline": [{"oid": "edaaaeb1b5fb7fb6187f8e2a3efa648ef1485a18", "url": "https://github.com/apache/lucene-solr/commit/edaaaeb1b5fb7fb6187f8e2a3efa648ef1485a18", "message": "LUCENE-9514: Include TermVectorsWriter in DWPT accounting\n\nTermVectorsWriter might consume some heap space memory that\ncan have a significant impact on decisions made in the IW if\nwriters should be stalled or DWPTs should be flushed if memory\nsettings are small in IWC and flushes are frequent. This change adds\nRAM accounting to the TermVectorsWriter since it's part of the\nDWPT lifecycle and not just present during flush.", "committedDate": "2020-09-09T07:28:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5Mzg1MA==", "url": "https://github.com/apache/lucene-solr/pull/1847#discussion_r485493850", "bodyText": "Ha.", "author": "mikemccand", "createdAt": "2020-09-09T10:04:24Z", "path": "lucene/codecs/src/java/org/apache/lucene/codecs/simpletext/SimpleTextTermVectorsWriter.java", "diffHunk": "@@ -193,4 +189,9 @@ private void write(BytesRef bytes) throws IOException {\n   private void newLine() throws IOException {\n     SimpleTextUtil.writeNewline(out);\n   }\n+\n+  @Override\n+  public long ramBytesUsed() {\n+    return scratch.get().bytes.length;", "originalCommit": "edaaaeb1b5fb7fb6187f8e2a3efa648ef1485a18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5NTI4Ng==", "url": "https://github.com/apache/lucene-solr/pull/1847#discussion_r485495286", "bodyText": "Hmm what is happening here?  Are we using this new accountable member somewhere?  I don't see it in the diffs?  Oh, I see, it is returned in DefaultIndexingChain.getChildResources(), ok!  Maybe add comment above its declaration explaining that our parent/owning DefaultIndexingChain returns/uses it?", "author": "mikemccand", "createdAt": "2020-09-09T10:06:36Z", "path": "lucene/core/src/java/org/apache/lucene/index/StoredFieldsConsumer.java", "diffHunk": "@@ -42,6 +44,7 @@\n   protected void initStoredFieldsWriter() throws IOException {\n     if (writer == null) { // TODO can we allocate this in the ctor? we call start document for every doc anyway\n       this.writer = codec.storedFieldsFormat().fieldsWriter(directory, info, IOContext.DEFAULT);\n+      accountable = writer;", "originalCommit": "edaaaeb1b5fb7fb6187f8e2a3efa648ef1485a18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5NzA0OQ==", "url": "https://github.com/apache/lucene-solr/pull/1847#discussion_r485497049", "bodyText": "Interface members are always static final right?", "author": "mikemccand", "createdAt": "2020-09-09T10:09:37Z", "path": "lucene/core/src/java/org/apache/lucene/util/Accountable.java", "diffHunk": "@@ -41,4 +41,8 @@\n     return Collections.emptyList();\n   }\n \n+  /**\n+   * An accountable that always returns 0\n+   */\n+  Accountable NULL_ACCOUNTABLE = () -> 0;", "originalCommit": "edaaaeb1b5fb7fb6187f8e2a3efa648ef1485a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5NjQ2MQ==", "url": "https://github.com/apache/lucene-solr/pull/1847#discussion_r487696461", "bodyText": "yes", "author": "s1monw", "createdAt": "2020-09-14T07:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5NzA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxNTkzOQ==", "url": "https://github.com/apache/lucene-solr/pull/1847#discussion_r487715939", "bodyText": "To avoid such questions, you can be explicit.", "author": "uschindler", "createdAt": "2020-09-14T07:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5NzA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyMTY5MA==", "url": "https://github.com/apache/lucene-solr/pull/1847#discussion_r487721690", "bodyText": "sure, but do we then initialize all booleans with = false? I thinks it's totally obsolet.", "author": "s1monw", "createdAt": "2020-09-14T07:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5NzA0OQ=="}], "type": "inlineReview"}, {"oid": "226d42cf9b0277c961ad737ce0749b47c02b67ff", "url": "https://github.com/apache/lucene-solr/commit/226d42cf9b0277c961ad737ce0749b47c02b67ff", "message": "Merge branch 'master' into LUCENE-9514", "committedDate": "2020-09-14T07:15:31Z", "type": "commit"}, {"oid": "f262c204b903f44cb397cc77481674dc05ad31fb", "url": "https://github.com/apache/lucene-solr/commit/f262c204b903f44cb397cc77481674dc05ad31fb", "message": "apply feedback", "committedDate": "2020-09-14T07:18:29Z", "type": "commit"}, {"oid": "0d6f928f9ce62adec4d66535a27be24b016d5701", "url": "https://github.com/apache/lucene-solr/commit/0d6f928f9ce62adec4d66535a27be24b016d5701", "message": "add changes", "committedDate": "2020-09-14T07:21:18Z", "type": "commit"}, {"oid": "3addd7df0d1d88cb0b0448e60e57869a8f6e6fe5", "url": "https://github.com/apache/lucene-solr/commit/3addd7df0d1d88cb0b0448e60e57869a8f6e6fe5", "message": "Merge branch 'master' into LUCENE-9514", "committedDate": "2020-09-14T08:08:03Z", "type": "commit"}]}