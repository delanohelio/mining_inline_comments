{"pr_number": 1552, "pr_title": "LUCENE-8962: merge small segments on commit", "pr_createdAt": "2020-06-03T19:50:19Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1552", "timeline": [{"oid": "642e56aba85947ba280e30917b61bdf605c0aa51", "url": "https://github.com/apache/lucene-solr/commit/642e56aba85947ba280e30917b61bdf605c0aa51", "message": "Revert \"Revert \"LUCENE-8962\"\"\n\nThis reverts commit 4501b3d3fdbc35af99bde6abe7432cfc5e8b5547.\n\nThis reverts commit 075adac59865b3277adcf86052f2fae3e6d11135.", "committedDate": "2020-06-03T19:17:35Z", "type": "commit"}, {"oid": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "url": "https://github.com/apache/lucene-solr/commit/cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "message": "Fix case where mergeOnCommit would attempt to delete files twice in the presence of deletions", "committedDate": "2020-06-03T19:17:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU5MjQyMA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r435592420", "bodyText": "Maybe for the last sentence: The merges are not cancelled, and will still run to completion independent of the commit like normal segment merges?\nMaybe also state that this setting has no effect unless the MergePolicy actually returns merges from findFullFlushMerges, which the default merge policy does not?", "author": "mikemccand", "createdAt": "2020-06-04T22:44:06Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriterConfig.java", "diffHunk": "@@ -459,6 +463,31 @@ public IndexWriterConfig setCommitOnClose(boolean commitOnClose) {\n     return this;\n   }\n \n+  /**\n+   * Expert: sets the amount of time to wait for merges returned by MergePolicy.findFullFlushMerges(...).\n+   * If this time is reached, we proceed with the commit based on segments merged up to that point.\n+   * The merges are not cancelled, and may still run to completion independent of the commit.", "originalCommit": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE1MzU3NQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r438153575", "bodyText": "this seems unnecessary?", "author": "s1monw", "createdAt": "2020-06-10T14:12:05Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -4483,6 +4593,7 @@ public int length() {\n         // Merge would produce a 0-doc segment, so we do nothing except commit the merge to remove all the 0-doc segments that we \"merged\":\n         assert merge.info.info.maxDoc() == 0;\n         commitMerge(merge, mergeState);\n+        success = true;", "originalCommit": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5MjAxNw==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439492017", "bodyText": "I think this was a small pre-existing bug.\nI.e. the merge has in fact succeeded on this path.  Before this change we are calling closeMergeReaders twice (once in the line above this, then again on line 4720 below.  Maybe that is harmless, but code-wise I think this path did succeed.\nIf necessary, we could pull this out into its own PR?  But I think it's a good, if subtle, catch.  The merge did succeed in this path.", "author": "mikemccand", "createdAt": "2020-06-12T15:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE1MzU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NzI2Nw==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439647267", "bodyText": "can we fix it in a dedicated PR with a dedicated test? that would also help if we look at the history of the bugfix?", "author": "s1monw", "createdAt": "2020-06-12T21:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE1MzU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5ODY5NQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r440298695", "bodyText": "Phew, I dit some git archaeology (thanks @msokolov for the pointers!) and uncovered the branch commit for this \"merge small segments on commit\" feature where we added this controversial success = true: cab5ef5\n+1 to pull the bugfix out into its own issue; I will open one.\nThe above commit has a dedicated test case, but the problem is that test case (in the above commit) relies on this new feature (it uses the new MergePolicy.findFullFlushMerges).  So we would need a new test case based on clean master branch showing the bug ... it looks like a test that merged 100% deleted segments ought to then incorrectly double-call closeMergedReaders (first with suppressExceptions = false then again with true) due to this missing success = true so it really should be easy to reproduce.  Though, actually I'm surprised none of our random testing uncovered this.  Not sure I full understand the bug yet :)  I will open an issue!", "author": "mikemccand", "createdAt": "2020-06-15T16:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE1MzU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE1NjIzNQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r438156235", "bodyText": "this method is never called in this entire PR. Also the Interface seems to be unused or rather never implemented. I think it should be removed.", "author": "s1monw", "createdAt": "2020-06-10T14:15:41Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriterConfig.java", "diffHunk": "@@ -459,6 +463,31 @@ public IndexWriterConfig setCommitOnClose(boolean commitOnClose) {\n     return this;\n   }\n \n+  /**\n+   * Expert: sets the amount of time to wait for merges returned by MergePolicy.findFullFlushMerges(...).\n+   * If this time is reached, we proceed with the commit based on segments merged up to that point.\n+   * The merges are not cancelled, and may still run to completion independent of the commit.\n+   */\n+  public IndexWriterConfig setMaxCommitMergeWaitSeconds(double maxCommitMergeWaitSeconds) {\n+    this.maxCommitMergeWaitSeconds = maxCommitMergeWaitSeconds;\n+    return this;\n+  }\n+\n+  /**\n+   * Set the callback that gets invoked when IndexWriter performs various actions.\n+   */\n+  public IndexWriterConfig setIndexWriterEvents(IndexWriterEvents indexWriterEvents) {", "originalCommit": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5NTMzNQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439495335", "bodyText": "Yeah for sure if we include it in this PR it should be tested by the PR.\nSee my comment above about this.", "author": "mikemccand", "createdAt": "2020-06-12T15:40:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE1NjIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE2MDExOQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r438160119", "bodyText": "I really don't like this setting. While I am convinced we should be very very careful adding more settings here, we should if possible use a parameter on a method to pass information like this. I personally would feel much better if we had a new method on IW called prepareCommit(double maxCommitMergeWaitSeconds) Maybe we can even go further and also pass a function to select the merges such that we don't need to add more stuff to mergePolicy?", "author": "s1monw", "createdAt": "2020-06-10T14:20:41Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriterConfig.java", "diffHunk": "@@ -459,6 +463,31 @@ public IndexWriterConfig setCommitOnClose(boolean commitOnClose) {\n     return this;\n   }\n \n+  /**\n+   * Expert: sets the amount of time to wait for merges returned by MergePolicy.findFullFlushMerges(...).\n+   * If this time is reached, we proceed with the commit based on segments merged up to that point.\n+   * The merges are not cancelled, and may still run to completion independent of the commit.\n+   */\n+  public IndexWriterConfig setMaxCommitMergeWaitSeconds(double maxCommitMergeWaitSeconds) {", "originalCommit": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5NDk3OA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439494978", "bodyText": "I think @msfroh had considered a separate IndexWriter method before but something went wrong with that approach?\nI don't think this should be a separate method, actually.\nWe have a MergePolicy that governs which merges should happen upon which events/triggers and what this change is adding is a new trigger (on commit) at which merging could conceivably occur.  If we added this method, the implication to fresh eyes would be that the existing prepareCommit will also wait for merges with some default parameter, while this new method lets you change the default.\nAnyway, let's hear from @msfroh if there was some wrinkle on making a dedicated method for this, but I still think that's a messy API.  We should rather use our existing MergePolicy API correctly.", "author": "mikemccand", "createdAt": "2020-06-12T15:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE2MDExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3MTQyMQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r438171421", "bodyText": "I am trying to understand why we need to do any extra work here. What makes this special to any other merge such that we need to do all this work. If this needs to be done only if we include this merged segment in the commit, can't we do it outside of this mergeFinished and only use mergeFinished to signal which merge finished in time etc? Then we also might not need the latch construct and can use a simple callback that we can ignore on the commit end?", "author": "s1monw", "createdAt": "2020-06-10T14:34:11Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -3152,6 +3154,42 @@ public final boolean flushNextBuffer() throws IOException {\n     }\n   }\n \n+  private MergePolicy.OneMerge updateSegmentInfosOnMergeFinish(MergePolicy.OneMerge merge, final SegmentInfos toCommit,\n+                                                                AtomicReference<CountDownLatch> mergeLatchRef) {\n+    return new MergePolicy.OneMerge(merge.segments) {\n+      public void mergeFinished() throws IOException {\n+        super.mergeFinished();\n+        CountDownLatch mergeAwaitLatch = mergeLatchRef.get();\n+        if (mergeAwaitLatch == null) {\n+          // Commit thread timed out waiting for this merge and moved on. No need to manipulate toCommit.\n+          return;\n+        }\n+        if (committed) {\n+          deleter.incRef(this.info.files());", "originalCommit": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5NzM0MQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439497341", "bodyText": "I think @msfroh might remember some context on why he settled on this approach.\nThis is inherently a complex problem: we want to let MergePolicy pick the \"right\" merges to do on commit (the smallish ones).  But, it may pick poorly, or maybe the box is IO starved currently, and so we want to 1) ask MergeScheduler to kick off the merges it had requested, but 2) those merges that complete it time will make it into the commit point, while those that do not will still be allowed to run to completion and be switched in the live SegmentInfos (no wasted work), but will not be in the current commit point.\nAnyway, +1 if we can re-use existing code that \"merges the merged segments\" into a live or the pending commit SegmentInfos.  Maybe we can factor out the common code to reduce the added complexity here?", "author": "mikemccand", "createdAt": "2020-06-12T15:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3MTQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NTk3Nw==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r438175977", "bodyText": "I do wonder if we need all these changes here in such a fragile part of the code. Wouldn't it be possible to simply call maybeMerge(MergePolicy mergePolicy, MergeTrigger trigger, int maxNumSegments) with a MergePolicy wrapper that does all the magic like wrapping segments etc. Then we could pick up the callback idea from above and just wait here until all merges called back? I think we should try to reuse most of the current infrastructure in IW instead of special casing. There was a lot of work put into this to reduce special casing I think we should try hard to reduce it more and try harder to not add any.", "author": "s1monw", "createdAt": "2020-06-10T14:40:02Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -3228,15 +3268,38 @@ private long prepareCommitInternal() throws IOException {\n               // sneak into the commit point:\n               toCommit = segmentInfos.clone();\n \n+              if (anyChanges) {\n+                // Find any merges that can execute on commit (per MergePolicy).\n+                MergePolicy.MergeSpecification mergeSpec =", "originalCommit": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUwMDQyOA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439500428", "bodyText": "I think what makes this tricky is that this is a combination of MergePolicy (to pick the small merges) and MergeScheduler (to run them and await their completion, subject to a time limit) purposes.\nI do not think you can achieve this by just wrapping in MergePolicy, but I agree it would be better if we could find a simpler way to achieve it.", "author": "mikemccand", "createdAt": "2020-06-12T15:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NTk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NzAyNA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439647024", "bodyText": "I tried to showcase this here master...s1monw:LUCENE-8962", "author": "s1monw", "createdAt": "2020-06-12T21:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NTk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5OTAxNQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r440299015", "bodyText": "Thanks @s1monw.  I'll review your new PR.", "author": "mikemccand", "createdAt": "2020-06-15T16:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NTk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NjY1Mw==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r438176653", "bodyText": "what is this used for? Can we use testPoints for it if it's necesary?", "author": "s1monw", "createdAt": "2020-06-10T14:40:49Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -3257,6 +3320,52 @@ private long prepareCommitInternal() throws IOException {\n       } finally {\n         maybeCloseOnTragicEvent();\n       }\n+\n+      if (mergeAwaitLatchRef != null) {\n+        CountDownLatch mergeAwaitLatch = mergeAwaitLatchRef.get();\n+        // If we found and registered any merges above, within the flushLock, then we want to ensure that they\n+        // complete execution. Note that since we released the lock, other merges may have been scheduled. We will\n+        // block until  the merges that we registered complete. As they complete, they will update toCommit to\n+        // replace merged segments with the result of each merge.\n+        config.getIndexWriterEvents().beginMergeOnCommit();\n+        mergeScheduler.merge(mergeSource, MergeTrigger.COMMIT);\n+        long mergeWaitStart = System.nanoTime();\n+        int abandonedCount = 0;\n+        long waitTimeMillis = (long) (config.getMaxCommitMergeWaitSeconds() * 1000.0);\n+        try {\n+          if (mergeAwaitLatch.await(waitTimeMillis, TimeUnit.MILLISECONDS) == false) {\n+            synchronized (this) {\n+              // Need to do this in a synchronized block, to make sure none of our commit merges are currently\n+              // executing mergeFinished (since mergeFinished itself is called from within the IndexWriter lock).\n+              // After we clear the value from mergeAwaitLatchRef, the merges we schedule will still execute as\n+              // usual, but when they finish, they won't attempt to update toCommit or modify segment reference\n+              // counts.\n+              mergeAwaitLatchRef.set(null);\n+              for (MergePolicy.OneMerge commitMerge : commitMerges) {\n+                if (runningMerges.contains(commitMerge) || pendingMerges.contains(commitMerge)) {\n+                  abandonedCount++;\n+                }\n+              }\n+            }\n+          }\n+        } catch (InterruptedException ie) {\n+          throw new ThreadInterruptedException(ie);\n+        } finally {\n+          if (infoStream.isEnabled(\"IW\")) {\n+            infoStream.message(\"IW\", String.format(Locale.ROOT, \"Waited %.1f ms for commit merges\",\n+                (System.nanoTime() - mergeWaitStart)/1_000_000.0));\n+            infoStream.message(\"IW\", \"After executing commit merges, had \" + toCommit.size() + \" segments\");\n+            if (abandonedCount > 0) {\n+              infoStream.message(\"IW\", \"Abandoned \" + abandonedCount + \" commit merges after \" + waitTimeMillis + \" ms\");\n+            }\n+          }\n+          if (abandonedCount > 0) {\n+            config.getIndexWriterEvents().abandonedMergesOnCommit(abandonedCount);", "originalCommit": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4OTQ4MQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439489481", "bodyText": "The idea with this is to be able to track externally to IndexWriter how many merges completed during the commit window, how many did not, how long the commit waited for small merges to finish, etc.  This is useful telemetry for understanding how the feature is actually working in your production cluster.  I don't think we can get the equivalent telemetry by e.g. wrapping MergePolicy or MergeScheduler, because it is IndexWriter that knows how long it will wait and knows which merges made it and which did not.\nI think testPoints only run under assertion, and are really designed for unit tests to do interesting things.  But maybe we could somehow abuse it for this use case?\nI agree it should be tested better if we want to include it here.\nIf it is really controversial then +1 to remove the IndexWriterEvents entirely here and pursue it as a separate issue.  It was useful for us (Amazon product search) to understand how this feature impacts our production clusters, and to help us tune a reasonable timeout value.", "author": "mikemccand", "createdAt": "2020-06-12T15:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NjY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0Njg2MQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439646861", "bodyText": "I think we should detach this discussion if we need metrics on IW from this PR. It distracts from it's actual core change IMO and if'd add metrics then we'd need some more or can consolidate them too. I'd rather have a stats object than a callback here to be honest but again that's a different discussion.", "author": "s1monw", "createdAt": "2020-06-12T21:19:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NjY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3OTc3MA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r440279770", "bodyText": "OK let's remove this part and leave it for another day.  I'll open a separate issue.", "author": "mikemccand", "createdAt": "2020-06-15T15:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NjY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5MjY4Ng==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439492686", "bodyText": "Maybe 5.0 or 10.0 seconds instead?  A \"typical\" commit, writing new Lucene segments and fsyncing many files can often take several seconds, but 30 seems high.", "author": "mikemccand", "createdAt": "2020-06-12T15:36:06Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriterConfig.java", "diffHunk": "@@ -109,6 +110,9 @@\n   \n   /** Default value for whether calls to {@link IndexWriter#close()} include a commit. */\n   public final static boolean DEFAULT_COMMIT_ON_CLOSE = true;\n+\n+  /** Default value for time to wait for merges on commit (when using a {@link MergePolicy} that implements findFullFlushMerges). */\n+  public static final double DEFAULT_MAX_COMMIT_MERGE_WAIT_SECONDS = 30.0;", "originalCommit": "cab5ef5e6f2bdcda59fd669a298ec1377777af9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NjMyNg==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439646326", "bodyText": "maybe 0 as a default and if somebody want's to wait they can set it?", "author": "s1monw", "createdAt": "2020-06-12T21:18:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5MjY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1NzI0MA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r439657240", "bodyText": "The success=true added above was needed in order to fix a test failure caught by @dnhatn 's new unit test (testRandomOperations), so they belong together.", "author": "msokolov", "createdAt": "2020-06-12T21:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5MjY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMwMjE0MA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r440302140", "bodyText": "maybe 0 as a default and if somebody want's to wait they can set it?\n\n+1\nThe feature is already disabled by default anyways (until you implement findFullFlushMerges in your MergePolicy), but making this 0 by default would make it even clearer that the feature is off by default.\n\nThe success=true added above was needed in order to fix a test failure caught by @dnhatn 's new unit test (testRandomOperations), so they belong together.\n\nAhh thanks for the context @msokolov!  However, staring at the code (maybe for not long enough!), it looks like it really ought to be a pre-existing bug, and should be unit-testable without this new feature.  But I am confused why none of our random tests have tripped up on this yet.  I will open a separate Jira issue for this.", "author": "mikemccand", "createdAt": "2020-06-15T16:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5MjY4Ng=="}], "type": "inlineReview"}, {"oid": "bf0f7990e919e9f5428ff4546bb936bfe1b13a3e", "url": "https://github.com/apache/lucene-solr/commit/bf0f7990e919e9f5428ff4546bb936bfe1b13a3e", "message": "fix test failures caused by attempt to merge a no-segments merge", "committedDate": "2020-06-12T21:55:26Z", "type": "commit"}, {"oid": "a707bb4f9e0cb4964b56dddd9f1f001a88f7c9d1", "url": "https://github.com/apache/lucene-solr/commit/a707bb4f9e0cb4964b56dddd9f1f001a88f7c9d1", "message": "Merge branch 'master' into jira/lucene-8962", "committedDate": "2020-06-17T21:00:20Z", "type": "commit"}, {"oid": "85a4193223807f40e80b89d26a4ac53b83180178", "url": "https://github.com/apache/lucene-solr/commit/85a4193223807f40e80b89d26a4ac53b83180178", "message": "current state of affairs", "committedDate": "2020-06-17T21:11:54Z", "type": "commit"}, {"oid": "e1fe0d21754f92d4c2a61d43356315a8ab95a129", "url": "https://github.com/apache/lucene-solr/commit/e1fe0d21754f92d4c2a61d43356315a8ab95a129", "message": "LUCENE-9408: roll back only called once enforcement", "committedDate": "2020-06-17T22:12:44Z", "type": "commit"}, {"oid": "4d6bb8f487557d48913b79b8b90386ab3c949279", "url": "https://github.com/apache/lucene-solr/commit/4d6bb8f487557d48913b79b8b90386ab3c949279", "message": "remove debug code", "committedDate": "2020-06-17T22:12:44Z", "type": "commit"}, {"oid": "650da5431ed9803d03cbc46271c1ca8aee42d35e", "url": "https://github.com/apache/lucene-solr/commit/650da5431ed9803d03cbc46271c1ca8aee42d35e", "message": "Ensure we stop adding to the new commit once we stopped waiting.", "committedDate": "2020-06-17T22:12:52Z", "type": "commit"}, {"oid": "d84691652973aff9aa387a1730a9779939541bd5", "url": "https://github.com/apache/lucene-solr/commit/d84691652973aff9aa387a1730a9779939541bd5", "message": "cut over to long for waitOnCommit and default to 0", "committedDate": "2020-06-17T22:20:20Z", "type": "commit"}, {"oid": "9448ff07cc627155dd9e6902971145714270c8b6", "url": "https://github.com/apache/lucene-solr/commit/9448ff07cc627155dd9e6902971145714270c8b6", "message": "remove IndexWriterEvents", "committedDate": "2020-06-17T22:22:30Z", "type": "commit"}, {"oid": "c8e26ebc6499b7c18c3d5d562ae5ddee6245d629", "url": "https://github.com/apache/lucene-solr/commit/c8e26ebc6499b7c18c3d5d562ae5ddee6245d629", "message": "remove dead code", "committedDate": "2020-06-17T22:30:13Z", "type": "commit"}, {"oid": "d4cfc88567744f786c7ea1994969e2abe25e8f11", "url": "https://github.com/apache/lucene-solr/commit/d4cfc88567744f786c7ea1994969e2abe25e8f11", "message": "Merge branch 'master' into jira/lucene-8962", "committedDate": "2020-06-17T22:33:06Z", "type": "commit"}, {"oid": "338478ab66998a24b4e71c79b08ce5c9c96cb988", "url": "https://github.com/apache/lucene-solr/commit/338478ab66998a24b4e71c79b08ce5c9c96cb988", "message": "remove unused import", "committedDate": "2020-06-17T22:40:28Z", "type": "commit"}, {"oid": "d19e1cde9967228d128639d3b5d295bb9afa2d98", "url": "https://github.com/apache/lucene-solr/commit/d19e1cde9967228d128639d3b5d295bb9afa2d98", "message": "apply fixes for review commnets", "committedDate": "2020-06-18T07:27:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMzMwMA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r442023300", "bodyText": "the last thing that I am afraid about is what if we has a MergeScheduler configured that blocks on this call like SerialMergeScheduler? I think there are multiple options like: documentation, skipping COMMIT merge triggers in SMS, adding a mergeAsync method to MS that has no impl in SMS... I think we should make sure that this is not trappy.", "author": "s1monw", "createdAt": "2020-06-18T07:29:55Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -3255,7 +3302,16 @@ private long prepareCommitInternal() throws IOException {\n       } finally {\n         maybeCloseOnTragicEvent();\n       }\n-     \n+\n+      if (onCommitMerges != null) {\n+        mergeScheduler.merge(mergeSource, MergeTrigger.COMMIT);", "originalCommit": "338478ab66998a24b4e71c79b08ce5c9c96cb988", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA0MzA0MA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r442043040", "bodyText": "Would it be sufficient to document the behavior in the Javadoc for findFullFlushMerges?\nI was assuming that any implementation of findFullFlushMerges would try to return merges that are very likely to complete within whatever timeout someone would reasonably set (e.g. a few seconds). The timeout was intended just as an extra safeguard in case a merge takes longer.\nGiven that lots of IndexWriter operations can have pauses with SerialMergeScheduler (judging by the number of calls to maybeMerge, especially the one from processEvents, in IndexWriter), blocking on this particular merge call doesn't feel like it introduces more risk (especially since it needs to be used in conjunction with a MergePolicy that implements findFullFlushMerges).", "author": "msfroh", "createdAt": "2020-06-18T08:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMzMwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2NzYwOA==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r442167608", "bodyText": "yeah I mean we don't have to do that and I think its rather a rare combination. My problem is that this entire configuration of max wait time is nonsense if SerialMS is used since we block until it has merged them all and potentially a bunch of other merges to a commit / refresh could take quite a long time. On the other hand, as you stated we will call maybeMerge anyway in the commit such that it's not really making any difference and the same is true for getReader so I think we are fine as it is.", "author": "s1monw", "createdAt": "2020-06-18T11:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMzMwMA=="}], "type": "inlineReview"}, {"oid": "0a096f76520f222db335f67db694184276832bf3", "url": "https://github.com/apache/lucene-solr/commit/0a096f76520f222db335f67db694184276832bf3", "message": "fix javadoc", "committedDate": "2020-06-18T07:37:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyNjIyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r442326229", "bodyText": "Oh -- I guess one minor complaint about moving this into prepareCommitInternal is that we won't be able to reuse it (without moving it) if we decide to apply the same logic to IndexWriter.getReader().\nThat said, moving it if/when someone gets around to applying the logic there isn't a big deal. (I think the real work there is reconciling logic from StandardDirectoryReader.open() with logic in IndexWriter.prepareCommitInternal(), since the functionality is kind of duplicated.)", "author": "msfroh", "createdAt": "2020-06-18T15:47:12Z", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -3226,15 +3235,53 @@ private long prepareCommitInternal() throws IOException {\n               // sneak into the commit point:\n               toCommit = segmentInfos.clone();\n \n+              if (anyChanges && maxCommitMergeWaitSeconds > 0) {\n+                SegmentInfos committingSegmentInfos = toCommit;\n+                onCommitMerges = updatePendingMerges(new OneMergeWrappingMergePolicy(config.getMergePolicy(), toWrap ->\n+                    new MergePolicy.OneMerge(toWrap.segments) {\n+                      @Override\n+                      public void mergeFinished(boolean committed) throws IOException {", "originalCommit": "0a096f76520f222db335f67db694184276832bf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQyMjE4NQ==", "url": "https://github.com/apache/lucene-solr/pull/1552#discussion_r442422185", "bodyText": "I like to move stuf once necessary I think we need to adjust it there anyway so we can move it in a followup. ok?", "author": "s1monw", "createdAt": "2020-06-18T18:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyNjIyOQ=="}], "type": "inlineReview"}]}