{"pr_number": 3046, "pr_title": "Metadata identifier for Communities and Collections", "pr_createdAt": "2020-11-10T08:58:58Z", "pr_url": "https://github.com/DSpace/DSpace/pull/3046", "timeline": [{"oid": "1e54484ef50322c93aef9ec473f7bfa89840ee82", "url": "https://github.com/DSpace/DSpace/commit/1e54484ef50322c93aef9ec473f7bfa89840ee82", "message": "[CSTPER-221] Integration Test\n\nThe creation of communities (toplevel and subcommunities) and the\ncreation of collections implies population of dc.identifier.uri\nmetatada.\nWe also prove that the logic doesn't affect the creation of other types\nof entities (eperson).", "committedDate": "2020-10-27T15:26:43Z", "type": "commit"}, {"oid": "36e6a44000d0a04fc4f91c11baa7bf3960f7a4b6", "url": "https://github.com/DSpace/DSpace/commit/36e6a44000d0a04fc4f91c11baa7bf3960f7a4b6", "message": "[CSTPER-221] CommunityRestRepository common code refactoring", "committedDate": "2020-10-27T15:31:15Z", "type": "commit"}, {"oid": "b27d2ba3224c498673f2b3194e03a1f1446cf2dd", "url": "https://github.com/DSpace/DSpace/commit/b27d2ba3224c498673f2b3194e03a1f1446cf2dd", "message": "[CSTPER-221] Handle Providers enhanced for Communities and Collections", "committedDate": "2020-10-27T15:39:26Z", "type": "commit"}, {"oid": "2daad0b98cbb094f520b7f593868d28f1c7b2897", "url": "https://github.com/DSpace/DSpace/commit/2daad0b98cbb094f520b7f593868d28f1c7b2897", "message": "[CSTPER-221] DOI Collection/Community exclusion", "committedDate": "2020-10-27T15:47:05Z", "type": "commit"}, {"oid": "d8b7a78578be51bbb9bd51b92d083a5d7693cdb7", "url": "https://github.com/DSpace/DSpace/commit/d8b7a78578be51bbb9bd51b92d083a5d7693cdb7", "message": "[CSTPER-221] RestMetadata applied without deleting existing ones.", "committedDate": "2020-10-27T15:58:29Z", "type": "commit"}, {"oid": "5968c9ce2a748df54308fe180d0d903462e671be", "url": "https://github.com/DSpace/DSpace/commit/5968c9ce2a748df54308fe180d0d903462e671be", "message": "[CSTPER-221] Tests refined", "committedDate": "2020-10-29T15:44:37Z", "type": "commit"}, {"oid": "e959d70cc71db248905454b8460692969c9ccdfc", "url": "https://github.com/DSpace/DSpace/commit/e959d70cc71db248905454b8460692969c9ccdfc", "message": "[CSTPER-221] Reverted modifications to the register method", "committedDate": "2020-10-29T15:50:44Z", "type": "commit"}, {"oid": "d3c3d30c6c32f32070a1b2c1e7084354c1fd9ef4", "url": "https://github.com/DSpace/DSpace/commit/d3c3d30c6c32f32070a1b2c1e7084354c1fd9ef4", "message": "[CSTPER-221] Versioned handle populate metadata cleanup", "committedDate": "2020-10-29T16:28:40Z", "type": "commit"}, {"oid": "b33cd12ddf8391f0de4d809d763432b62b3233bc", "url": "https://github.com/DSpace/DSpace/commit/b33cd12ddf8391f0de4d809d763432b62b3233bc", "message": "[CSTPER-221] EZIDIdentifierProvider exclusions", "committedDate": "2020-10-29T16:29:05Z", "type": "commit"}, {"oid": "ebab9836183339f95253bf10ce51350682ad9f5d", "url": "https://github.com/DSpace/DSpace/commit/ebab9836183339f95253bf10ce51350682ad9f5d", "message": "[CSTPER-221] Validation check and MetadataConverter merge facility", "committedDate": "2020-10-29T17:51:45Z", "type": "commit"}, {"oid": "28273ce292dacb2631e35c81b8668bba646d61ba", "url": "https://github.com/DSpace/DSpace/commit/28273ce292dacb2631e35c81b8668bba646d61ba", "message": "[CSTPER-221] EZIDIdentifierProvider exclusions", "committedDate": "2020-10-29T17:57:42Z", "type": "commit"}, {"oid": "b878b0a7e0edd8f78918943d1e06f03893f2e16d", "url": "https://github.com/DSpace/DSpace/commit/b878b0a7e0edd8f78918943d1e06f03893f2e16d", "message": "[CSTPER-221] Minor changes and cleanup", "committedDate": "2020-10-30T17:41:04Z", "type": "commit"}, {"oid": "ed01db639265d0d6d3ff58c261889c6bc9e0058c", "url": "https://github.com/DSpace/DSpace/commit/ed01db639265d0d6d3ff58c261889c6bc9e0058c", "message": "[CSTPER-221] MetadataConverter fixed", "committedDate": "2020-11-06T14:55:10Z", "type": "commit"}, {"oid": "dc08f36a9497b78c9f1a5541a30534fd41f1f589", "url": "https://github.com/DSpace/DSpace/commit/dc08f36a9497b78c9f1a5541a30534fd41f1f589", "message": "[CSTPER-221] Fixed Authorization denied during subCommunity creation\n\nWe need to persist the newCommunity before adding the handle metadata\nvalue. The failing test was\n* CommunityRestRepositoryIT.createSubCommunityAuthorizedTest", "committedDate": "2020-11-09T10:48:22Z", "type": "commit"}, {"oid": "572a74afbab428a8cd0283ae799e06407707492f", "url": "https://github.com/DSpace/DSpace/commit/572a74afbab428a8cd0283ae799e06407707492f", "message": "[CSTPER-221] Script Flyway to populate handle metadata\n\nFor existing Collection/Community", "committedDate": "2020-11-09T10:52:10Z", "type": "commit"}, {"oid": "c84608e81f993f0ef805310e21e0dedda3e13d57", "url": "https://github.com/DSpace/DSpace/commit/c84608e81f993f0ef805310e21e0dedda3e13d57", "message": "[CSTPER-221] Collection handle generation after creation", "committedDate": "2020-11-09T16:06:29Z", "type": "commit"}, {"oid": "a0b5cf90751e6fb7e1884ecb00d57713be0303f2", "url": "https://github.com/DSpace/DSpace/commit/a0b5cf90751e6fb7e1884ecb00d57713be0303f2", "message": "[CSTPER-221] Fixed Unit tests", "committedDate": "2020-11-09T16:13:22Z", "type": "commit"}, {"oid": "e279cb3e0532c80c670b02352344eb6721ea905a", "url": "https://github.com/DSpace/DSpace/commit/e279cb3e0532c80c670b02352344eb6721ea905a", "message": "[CSTPER-221] Script Flyway to populate handle metadata\n\nFixed Javadoc.", "committedDate": "2020-11-11T08:28:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3Njg0NA==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r524676844", "bodyText": "Have we fully tested this SQL_INSERT on Postgres and Oracle?  I'm a little nervous about hardcoding this SQL as a string in Java, simply because it means we cannot easily customize it for Postgres vs Oracle as necessary.\nNormally, the process is to provide separate *.sql files under dspace-api/src/main/resources/org/dspace/storage/rdbms/sqlmigration/[db-type]/, rather than hardcoding SQL into Java.\nIf this has not been tested on Oracle, I'd prefer we replace this logic with SQL files, even though I realize that'd require having two INSERT statements in each file (one for community & one for collection)", "author": "tdonohue", "createdAt": "2020-11-16T22:24:51Z", "path": "dspace-api/src/main/java/org/dspace/storage/rdbms/migration/V7_0_2020_10_31__CollectionCommunity_Metadata_Handle.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.storage.rdbms.migration;\n+\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+\n+import org.dspace.handle.service.HandleService;\n+import org.dspace.services.factory.DSpaceServicesFactory;\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.jdbc.core.PreparedStatementSetter;\n+import org.springframework.jdbc.datasource.SingleConnectionDataSource;\n+\n+/**\n+ * Insert a 'dc.idendifier.uri' metadata record for each Community and Collection in the database.\n+ * The value is calculated concatenating the canonicalPrefix extracted from the configuration\n+ * (default is \"http://hdl.handle.net/) and the object's handle suffix stored inside the handle table.\n+ *\n+ * @author Alessandro Martelli (alessandro.martelli at 4science.it)\n+ */\n+public class V7_0_2020_10_31__CollectionCommunity_Metadata_Handle extends BaseJavaMigration {\n+    // Size of migration script run\n+    protected Integer migration_file_size = -1;\n+\n+    @Override\n+    public void migrate(Context context) throws Exception {\n+\n+        HandleService handleService = DSpaceServicesFactory\n+                .getInstance().getServiceManager().getServicesByType(HandleService.class).get(0);\n+\n+        final String prefix = handleService.getCanonicalPrefix();\n+\n+        final String SQL_INSERT = \"insert into metadatavalue \"", "originalCommit": "e279cb3e0532c80c670b02352344eb6721ea905a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2Njg0OA==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r524966848", "bodyText": "We discussed a lot about it with @abollini. We option for a fully java based script since we have to make aware the database of the prefix value from configuration. This means we will still need a Java based script to properly initialize sql. Having said that in my opinion there is no problem in moving the sql part into separate files (and replicating it twice each).", "author": "alemarte", "createdAt": "2020-11-17T08:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3Njg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI0MjMwNw==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r525242307", "bodyText": "@alemarte : To clarify, my concern here is that hardcoding SQL into Java means that the SQL must work on all database types.  So, again, I'm wondering if this SQL has been tested on Oracle?  If we can prove it works for both Postgres & Oracle, then this approach is OK.  Otherwise, we must refactor this to use SQL scripts that are database type specific, as that allows us to customize the SQL per database type.\nI'm a little nervous that this hardcoded SQL may not be cross-database compatible (as it's quite complex), but I hope I'm wrong.  In any case, I'd appreciate it if you could test this on Oracle to ensure it'll work there as well.  If so, then it's fine as-is.  If not, then we need to figure out a different solution that allows the Oracle SQL and Postgres SQL to be different.   One option might be to move to SQL files and use Flyway Placeholders (https://flywaydb.org/documentation/configuration/placeholder) in the SQL to represent the prefix -- but I'm not sure how easy that'd be, as we've not had to use placeholders yet in any other migration.", "author": "tdonohue", "createdAt": "2020-11-17T15:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3Njg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk4ODMyMQ==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r525988321", "bodyText": "@tdonohue I understand your concerns, unfortunately I can't say it works 100% on oracle. I've moved the insert parts into separate files.\nNow, the hard coded queries are listed below:\n\nCREATE TABLE tmp_handleprefix (handleprefix text NOT NULL);\nINSERT INTO tmp_handleprefix (handleprefix) VALUES (?)\n\nPlaceholders can't be used easily since we have no access to the Flyway instance within the migration script.", "author": "alemarte", "createdAt": "2020-11-18T10:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3Njg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3OTA1MQ==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r524679051", "bodyText": "You can remove this logic, as there's no need to reset Configuration values.  They automatically reset after every test.  So, the try/finally can be removed & the getProperty at the top.   Just call setProperty to change the value, and it'll reset automatically.", "author": "tdonohue", "createdAt": "2020-11-16T22:27:00Z", "path": "dspace-api/src/test/java/org/dspace/content/CollectionTest.java", "diffHunk": "@@ -180,6 +191,10 @@ public void testCreateWithValidHandle() throws Exception {\n         // check that collection was created, and that its handle was set to proper value\n         assertThat(\"testCreateWithValidHandle 0\", created, notNullValue());\n         assertThat(\"testCreateWithValidHandle 1\", created.getHandle(), equalTo(\"987654321/100\"));\n+\n+        } finally {\n+            configurationService.setProperty(\"handle.additional.prefixes\", handleAdditionalPrefixes);", "originalCommit": "e279cb3e0532c80c670b02352344eb6721ea905a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDk2MA==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r525994960", "bodyText": "At a first glance, I haven't found anything like a configuration reset. This maybe happens only for IntegrationTests?", "author": "alemarte", "createdAt": "2020-11-18T10:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3OTA1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI1ODU1Mg==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r526258552", "bodyText": "@alemarte : My mistake. You are correct, it seems this configuration reload is only currently enabled for Integration Tests here: https://github.com/DSpace/DSpace/blob/main/dspace-api/src/test/java/org/dspace/AbstractIntegrationTestWithDatabase.java#L192-L193\nSo, you are correct that this code is unfortunately necessary until we add similar logic to the AbstractUnitTest.destroy() method here: https://github.com/DSpace/DSpace/blob/main/dspace-api/src/test/java/org/dspace/AbstractUnitTest.java#L145\nIf you are willing, we could add that code to AbstractUnitTest.destroy() now.  However, if you'd rather keep this PR as-is, I'm OK with this moving forward and we can do a future refactor to remove this logic once AbstractUnitTest properly resets configurations to their defaults.", "author": "tdonohue", "createdAt": "2020-11-18T17:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3OTA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3OTQ3MQ==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r524679471", "bodyText": "Again, remove this logic...configs reset automatically", "author": "tdonohue", "createdAt": "2020-11-16T22:27:24Z", "path": "dspace-api/src/test/java/org/dspace/content/CommunityTest.java", "diffHunk": "@@ -214,6 +227,10 @@ public void testCreateWithValidHandle() throws Exception {\n         // check that community was created, and that its handle was set to proper value\n         assertThat(\"testCreateWithValidHandle 0\", created, notNullValue());\n         assertThat(\"testCreateWithValidHandle 1\", created.getHandle(), equalTo(\"987654321/100c\"));\n+\n+        } finally {\n+            configurationService.setProperty(\"handle.additional.prefixes\", handleAdditionalPrefixes);", "originalCommit": "e279cb3e0532c80c670b02352344eb6721ea905a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "65b69a2b29830c2f00a3dc6b8cd8bdca0faf4892", "url": "https://github.com/DSpace/DSpace/commit/65b69a2b29830c2f00a3dc6b8cd8bdca0faf4892", "message": "[CSTPER-221] Script Flyway to populate handle metadata\n\nMoved to sql files.", "committedDate": "2020-11-18T09:52:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE2MzQ5OA==", "url": "https://github.com/DSpace/DSpace/pull/3046#discussion_r527163498", "bodyText": "@alemarte : Sorry, but I have to admit, I'm not a fan of this new logic to create a temp table to store the configured handle prefix.  I understand the reasoning behind it, but this approach seems more complex than necessary (and I'm also worried about fragility...if something errors out here, I'm worried some sites could end up with an unused tmp_handleprefix table sitting around).\nInstead of trying to save the configuration into the database layer, it seems much easier to just use String variable substitution.  Afterall, you are reading the SQL migration script into a String (see dataMigrateSQL on line 63).   Therefore, why not do something like this:\n// Get SQL script (based on DB type)\nString dataMigrateSQL = MigrationUtils.getResourceAsString(sqlMigrationPath + \"V7.0_2020.10.31__CollectionCommunity_Metadata_Handle.sql\");\n\n// Replace ${handle.canonical.prefix} variable in SQL script with value from Configuration\nMap<String, String> valuesMap = new HashMap<>();\nvaluesMap.put(\"handle.canonical.prefix\", handleService.getCanonicalPrefix());\nStringSubstitutor sub = new StringSubstitutor(valuesMap);\ndataMigrateSQL = sub.replace(dataMigrateSQL);\n\n// Run the resulting script\nDatabaseUtils.executeSql(context.getConnection(), dataMigrateSQL);\n\nTo me, this would be a lot cleaner & easier for other developers to understand.  It'd only require that you add a ${handle.canonical.prefix} placeholder into the SQL scripts where it is necessary.  I'll also note that this same idea has already been used in our FlywayUpgradeUtils class, which uses  similar placeholder variables in the upgradeToFlyway4x.sql script.\nApologies that I didn't suggest this approach sooner, but I had forgotten it until I analyzed your new code.", "author": "tdonohue", "createdAt": "2020-11-19T20:03:19Z", "path": "dspace-api/src/main/java/org/dspace/storage/rdbms/migration/V7_0_2020_10_31__CollectionCommunity_Metadata_Handle.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.storage.rdbms.migration;\n+\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+\n+import org.dspace.handle.service.HandleService;\n+import org.dspace.services.factory.DSpaceServicesFactory;\n+import org.dspace.storage.rdbms.DatabaseUtils;\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.jdbc.core.PreparedStatementSetter;\n+import org.springframework.jdbc.datasource.SingleConnectionDataSource;\n+\n+/**\n+ * Insert a 'dc.idendifier.uri' metadata record for each Community and Collection in the database.\n+ * The value is calculated concatenating the canonicalPrefix extracted from the configuration\n+ * (default is \"http://hdl.handle.net/) and the object's handle suffix stored inside the handle table.\n+ *\n+ * @author Alessandro Martelli (alessandro.martelli at 4science.it)\n+ */\n+public class V7_0_2020_10_31__CollectionCommunity_Metadata_Handle extends BaseJavaMigration {\n+    // Size of migration script run\n+    protected Integer migration_file_size = -1;\n+\n+    @Override\n+    public void migrate(Context context) throws Exception {\n+\n+        HandleService handleService = DSpaceServicesFactory\n+                .getInstance().getServiceManager().getServicesByType(HandleService.class).get(0);\n+\n+        final String prefix = handleService.getCanonicalPrefix();\n+\n+        // Step 1 Preparation (creation of the tmp_handleprefix containing one record with the prefix)\n+        String createTmpTable = \"CREATE TABLE tmp_handleprefix (handleprefix text NOT NULL);\";\n+        DatabaseUtils.executeSql(context.getConnection(), createTmpTable);\n+\n+        // Step 2 Preparation (insertion of the prefix value into tmp_handleprefix)\n+        String insertPrefixSql = \"INSERT INTO tmp_handleprefix (handleprefix) VALUES (?)\";", "originalCommit": "65b69a2b29830c2f00a3dc6b8cd8bdca0faf4892", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "639b63635bb76fb66a76e5989b4fe8e2b026d7f0", "url": "https://github.com/DSpace/DSpace/commit/639b63635bb76fb66a76e5989b4fe8e2b026d7f0", "message": "[CSTPER-221] Script Flyway to populate handle metadata\n\nSql placeholders replacement.", "committedDate": "2020-11-23T08:52:59Z", "type": "commit"}]}