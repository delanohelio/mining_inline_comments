{"pr_number": 2675, "pr_title": "DS-4043 Revisit security layer of submission", "pr_createdAt": "2020-02-17T09:47:38Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2675", "timeline": [{"oid": "5a5ae6d40157b686f3761c297661146e13546795", "url": "https://github.com/DSpace/DSpace/commit/5a5ae6d40157b686f3761c297661146e13546795", "message": "added unit tests for the security layer of the submission", "committedDate": "2020-02-17T08:29:44Z", "type": "commit"}, {"oid": "00c9bcea90bae7024625bc555aacc059c7e50965", "url": "https://github.com/DSpace/DSpace/commit/00c9bcea90bae7024625bc555aacc059c7e50965", "message": "implemented permissionEvaluatorPlugin for workspaceitem", "committedDate": "2020-02-17T08:39:41Z", "type": "commit"}, {"oid": "67b564af7ef1ddef993bc7d51f1aa120ef26921e", "url": "https://github.com/DSpace/DSpace/commit/67b564af7ef1ddef993bc7d51f1aa120ef26921e", "message": "fixed exception for upload method", "committedDate": "2020-02-17T08:43:50Z", "type": "commit"}, {"oid": "4ce509133d5389791e6e134d31ceea48d24880fc", "url": "https://github.com/DSpace/DSpace/commit/4ce509133d5389791e6e134d31ceea48d24880fc", "message": "Merge remote-tracking branch 'origin/master' into revisitSecurityLayerOfSubmission-DS-4043", "committedDate": "2020-02-19T21:18:30Z", "type": "commit"}, {"oid": "edf5e5723318a8292faa92eb054df73347712014", "url": "https://github.com/DSpace/DSpace/commit/edf5e5723318a8292faa92eb054df73347712014", "message": "Fix double check in IT the findBySubmitter must be used", "committedDate": "2020-02-20T17:51:52Z", "type": "commit"}, {"oid": "a19f24bebaea389ccb21f766bc5787005f3bff70", "url": "https://github.com/DSpace/DSpace/commit/a19f24bebaea389ccb21f766bc5787005f3bff70", "message": "Merge branch 'resourcepolicy-DS-4418' of https://github.com/Micheleboychuk/DSpace into revisitSecurityLayerOfSubmission-DS-4043\n\n# Conflicts:\n#\tdspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "committedDate": "2020-03-02T15:43:10Z", "type": "commit"}, {"oid": "e42382b4ab987e87a44a812ddd5d4717944dd6fe", "url": "https://github.com/DSpace/DSpace/commit/e42382b4ab987e87a44a812ddd5d4717944dd6fe", "message": "Merge branch 'revisitSecurityLayerOfSubmission-DS-4043' of https://github.com/Micheleboychuk/DSpace into revisitSecurityLayerOfSubmission-DS-4043\n\n# Conflicts:\n#\tdspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "committedDate": "2020-03-02T16:00:51Z", "type": "commit"}, {"oid": "1fdb728672f346ba48bb5b3293c7eca60d40e3b6", "url": "https://github.com/DSpace/DSpace/commit/1fdb728672f346ba48bb5b3293c7eca60d40e3b6", "message": "Merge branch 'master' of https://github.com/DSpace/DSpace into revisitSecurityLayerOfSubmission-DS-4043", "committedDate": "2020-03-05T09:52:23Z", "type": "commit"}, {"oid": "b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "url": "https://github.com/DSpace/DSpace/commit/b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "message": "DS-4043 Revisit security layer of submission", "committedDate": "2020-03-05T10:18:58Z", "type": "commit"}, {"oid": "b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "url": "https://github.com/DSpace/DSpace/commit/b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "message": "DS-4043 Revisit security layer of submission", "committedDate": "2020-03-05T10:18:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExMzMzOQ==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r389113339", "bodyText": "Tiny thing, this could just be throw new RuntimeException(e);  Since you are not providing a more descriptive error message, there's no reason for the e.getMessage() here.", "author": "tdonohue", "createdAt": "2020-03-06T19:54:44Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/RestResourceController.java", "diffHunk": "@@ -584,9 +585,10 @@ public ResourceSupport findRel(HttpServletRequest request, HttpServletResponse r\n         RestAddressableModel modelObject = null;\n         try {\n             modelObject = repository.upload(request, apiCategory, model, id, uploadfile);\n-        } catch (Exception e) {\n-            log.error(e.getMessage(), e);\n-            return ControllerUtils.toEmptyResponse(HttpStatus.INTERNAL_SERVER_ERROR);\n+        } catch (SQLException | IOException e) {\n+            throw new RuntimeException(e.getMessage(), e);", "originalCommit": "b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1ODgxOQ==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r391658819", "bodyText": "Honestly, I'm not 100% sure here. We usually re-throw exception in this way and you will see that broadly on the source code. According to the javadoc the single constructor will call this one with a little different \"message\", instead than getMessage the toString of the cause will be called.", "author": "abollini", "createdAt": "2020-03-12T14:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExMzMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg0NDcwNQ==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r391844705", "bodyText": "@abollini : The reason I don't like e.getMessage() alone is twofold: (1) it can be null, and (2) it may not always be as informative as e.toString() (toString contains both the message and the classname).   As noted in the JavaDocs of RuntimeException(Throwable cause):\n\nConstructs a new runtime exception with the specified cause and a detail message of (cause==null ? null : cause.toString()) (which typically contains the class and detail message of cause). This constructor is useful for runtime exceptions that are little more than wrappers for other throwables.\n\nSo, if all you want to do is wrap an exception in a RuntimeException, you really should be using throw new RuntimeException(e);  (you are correct, we have a lot of code that doesn't do this right now, but should be updated someday).  However, if you want to provide more contextual information around the error, this could be updated to say something like:\nthrow new RuntimeException(\"Error \" + e.getMessage() + \" uploading file to \" + model + \" with ID= \" +id, e);", "author": "tdonohue", "createdAt": "2020-03-12T19:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExMzMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE1MTY3NQ==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r392151675", "bodyText": "@tdonohue oh yes it makes sense. Thanks to take the time to explain the motivation we will try to stick to this rule at least for all the new code and when touched update existing code as wel", "author": "abollini", "createdAt": "2020-03-13T10:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExMzMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExNDY0NA==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r389114644", "bodyText": "I'd like more information in this comment, as it's a bit vague to me.  Are we giving permission in order to specifically throw a 404 Not Found status code? Or are there other status codes possible here?  If it's just a 404 (which I expect it is), it'd be good to note that in this comment.", "author": "tdonohue", "createdAt": "2020-03-06T19:57:47Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/WorkspaceItemRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import java.sql.SQLException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.WorkspaceItemRest;\n+import org.dspace.app.rest.utils.ContextUtil;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.dspace.core.Context;\n+import org.dspace.eperson.EPerson;\n+import org.dspace.eperson.service.EPersonService;\n+import org.dspace.services.RequestService;\n+import org.dspace.services.model.Request;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * {@link RestPermissionEvaluatorPlugin} class that evaluate READ, WRITE and DELETE permissions over a WorkspaceItem\n+ * \n+ * @author Mykhaylo Boychuk (mykhaylo.boychuk at 4science.it)\n+ */\n+@Component\n+public class WorkspaceItemRestPermissionEvaluatorPlugin extends RestObjectPermissionEvaluatorPlugin {\n+\n+    private static final Logger log = LoggerFactory.getLogger(WorkspaceItemRestPermissionEvaluatorPlugin.class);\n+\n+    @Autowired\n+    private RequestService requestService;\n+\n+    @Autowired\n+    private EPersonService ePersonService;\n+\n+    @Autowired\n+    WorkspaceItemService wis;\n+\n+    @Override\n+    public boolean hasDSpacePermission(Authentication authentication, Serializable targetId, String targetType,\n+            DSpaceRestPermission permission) {\n+\n+        DSpaceRestPermission restPermission = DSpaceRestPermission.convert(permission);\n+        if (!DSpaceRestPermission.READ.equals(restPermission)\n+                && !DSpaceRestPermission.WRITE.equals(restPermission)\n+                && !DSpaceRestPermission.DELETE.equals(restPermission)) {\n+            return false;\n+        }\n+        if (!StringUtils.equalsIgnoreCase(targetType, WorkspaceItemRest.NAME)) {\n+            return false;\n+        }\n+\n+        Request request = requestService.getCurrentRequest();\n+        Context context = ContextUtil.obtainContext(request.getServletRequest());\n+\n+        EPerson ePerson = null;\n+        WorkspaceItem witem = null;\n+        try {\n+            ePerson = ePersonService.findByEmail(context, (String) authentication.getPrincipal());\n+            Integer dsoId = Integer.parseInt(targetId.toString());\n+\n+            // anonymous user\n+            if (ePerson == null) {\n+                return false;\n+            }\n+\n+            witem = wis.find(context, dsoId);\n+\n+             // If the dso is null then we give permission so we can throw another status\n+            // code instead", "originalCommit": "b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY2MzA2MQ==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r391663061", "bodyText": "there is not definitive answer to that as the permission checks are run also during embedding or by other methods that reuse the repository methods (findOne, etc.). The original use case was the one that you not, 404 Not Found\nPlease note that this phrase is used also in other permission evaluator plugins. Should we add here throw another status code instead**, such as the 404 not found**?", "author": "abollini", "createdAt": "2020-03-12T14:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExNDY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg0NjM1Mg==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r391846352", "bodyText": "Ok, this is fine I guess. I do now see that other PermissionEvaluatorPlugin classes contain the same comment.", "author": "tdonohue", "createdAt": "2020-03-12T19:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExNDY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExNjU0Mw==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r389116543", "bodyText": "I think this should be a delete() request, not a get(), as you are testing deletion in this method.\nAlso, we should also be verifying that a Submitter (in this case submitter1) can delete their own WorkspaceItems.", "author": "tdonohue", "createdAt": "2020-03-06T20:01:58Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -347,25 +491,110 @@ public void deleteOneTest() throws Exception {\n                     .withMimeType(\"text/plain\").build();\n         }\n \n-        String token = getAuthToken(admin.getEmail(), password);\n+        context.restoreAuthSystemState();\n+\n+        String token = getAuthToken(eperson.getEmail(), password);\n \n         //Delete the workspaceitem\n         getClient(token).perform(delete(\"/api/submission/workspaceitems/\" + witem.getID()))\n                     .andExpect(status().is(204));\n \n         //Trying to get deleted item should fail with 404\n-        getClient().perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n+        getClient(token).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n                    .andExpect(status().is(404));\n \n         //Trying to get deleted workspaceitem's item should fail with 404\n-        getClient().perform(get(\"/api/core/items/\" + item.getID()))\n+        getClient(token).perform(get(\"/api/core/items/\" + item.getID()))\n                    .andExpect(status().is(404));\n \n         //Trying to get deleted workspaceitem's bitstream should fail with 404\n-        getClient().perform(get(\"/api/core/biststreams/\" + bitstream.getID()))\n+        getClient(token).perform(get(\"/api/core/biststreams/\" + bitstream.getID()))\n                    .andExpect(status().is(404));\n     }\n \n+    @Test\n+    public void deleteOneUnAuthenticatedTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                .withName(\"Parent Community\")\n+                .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, parentCommunity)\n+                .withName(\"Collection 1\")\n+                .build();\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Workspace Item 1\")\n+                .withIssueDate(\"2019-01-01\")\n+                .build();\n+\n+        Item item = witem.getItem();\n+\n+        //Add a bitstream to the item\n+        String bitstreamContent = \"ThisIsSomeDummyText\";\n+        Bitstream bitstream = null;\n+        try (InputStream is = IOUtils.toInputStream(bitstreamContent, CharEncoding.UTF_8)) {\n+            bitstream = BitstreamBuilder\n+                    .createBitstream(context, item, is)\n+                    .withName(\"Bitstream1\")\n+                    .withMimeType(\"text/plain\").build();\n+        }\n+\n+        context.restoreAuthSystemState();\n+\n+        getClient().perform(delete(\"/api/submission/workspaceitems/\" + witem.getID()))\n+                   .andExpect(status().isUnauthorized());\n+    }\n+\n+    @Test\n+    public void deleteOneForbiddenTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson submitter1 = EPersonBuilder.createEPerson(context)\n+                .withEmail(\"submitter1@example.com\")\n+                .withPassword(\"qwerty01\")\n+                .build();\n+        EPerson submitter2 = EPersonBuilder.createEPerson(context)\n+                .withEmail(\"submitter2@example.com\")\n+                .withPassword(\"qwerty02\")\n+                .build();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                .withName(\"Parent Community\")\n+                .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, parentCommunity)\n+                .withName(\"Collection 1\")\n+                .withSubmitterGroup(submitter1)\n+                .build();\n+\n+        context.setCurrentUser(submitter1);\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Workspace Item 1\")\n+                .withIssueDate(\"2020-01-01\")\n+                .build();\n+\n+        Item item = witem.getItem();\n+\n+        //Add a bitstream to the item\n+        String bitstreamContent = \"ThisIsSomeDummyText\";\n+        Bitstream bitstream = null;\n+        try (InputStream is = IOUtils.toInputStream(bitstreamContent, CharEncoding.UTF_8)) {\n+            bitstream = BitstreamBuilder\n+                    .createBitstream(context, item, is)\n+                    .withName(\"Bitstream1\")\n+                    .withMimeType(\"text/plain\").build();\n+        }\n+\n+        context.restoreAuthSystemState();\n+\n+        String tokenSubmitter2 = getAuthToken(submitter2.getEmail(), \"qwerty02\");\n+        getClient(tokenSubmitter2).perform(delete(\"/api/submission/workspaceitems/\" + witem.getID()))\n+                                  .andExpect(status().isForbidden());\n+\n+        String authToken = getAuthToken(admin.getEmail(), password);\n+        getClient(authToken).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))", "originalCommit": "b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY2NDkyMA==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r391664920", "bodyText": "it is intentional, the delete operation is checked two rows above. This get is an extra security check to verify that regardless to the status returned to the client the server has really NOT deleted the workspaceitem", "author": "abollini", "createdAt": "2020-03-12T14:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExNjU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg0ODE1MA==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r391848150", "bodyText": "@abollini : Oh, you are right, I misread this code.  the get() is correct here.\nI also see now that I overlooked that we already have a test to verify that a submitter can delete their own WorkspaceItem (deleteOneTest()).  So, I'll resolve this conversation/comment.", "author": "tdonohue", "createdAt": "2020-03-12T19:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExNjU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExODU4MQ==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r389118581", "bodyText": "Tiny improvement to suggest. Can we actually have submitter2 be the Submitter of a second WorkspaceItem in this test?  That would better verify that the submitter of one WorkspaceItem doesn't have rights to remove another submitter's WorkspaceItem.  Currently, this test seems to just be testing something slightly different -- that someone with authentication rights cannot delete another person's WorkspaceItem.", "author": "tdonohue", "createdAt": "2020-03-06T20:06:34Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -347,25 +491,110 @@ public void deleteOneTest() throws Exception {\n                     .withMimeType(\"text/plain\").build();\n         }\n \n-        String token = getAuthToken(admin.getEmail(), password);\n+        context.restoreAuthSystemState();\n+\n+        String token = getAuthToken(eperson.getEmail(), password);\n \n         //Delete the workspaceitem\n         getClient(token).perform(delete(\"/api/submission/workspaceitems/\" + witem.getID()))\n                     .andExpect(status().is(204));\n \n         //Trying to get deleted item should fail with 404\n-        getClient().perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n+        getClient(token).perform(get(\"/api/submission/workspaceitems/\" + witem.getID()))\n                    .andExpect(status().is(404));\n \n         //Trying to get deleted workspaceitem's item should fail with 404\n-        getClient().perform(get(\"/api/core/items/\" + item.getID()))\n+        getClient(token).perform(get(\"/api/core/items/\" + item.getID()))\n                    .andExpect(status().is(404));\n \n         //Trying to get deleted workspaceitem's bitstream should fail with 404\n-        getClient().perform(get(\"/api/core/biststreams/\" + bitstream.getID()))\n+        getClient(token).perform(get(\"/api/core/biststreams/\" + bitstream.getID()))\n                    .andExpect(status().is(404));\n     }\n \n+    @Test\n+    public void deleteOneUnAuthenticatedTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                .withName(\"Parent Community\")\n+                .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, parentCommunity)\n+                .withName(\"Collection 1\")\n+                .build();\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Workspace Item 1\")\n+                .withIssueDate(\"2019-01-01\")\n+                .build();\n+\n+        Item item = witem.getItem();\n+\n+        //Add a bitstream to the item\n+        String bitstreamContent = \"ThisIsSomeDummyText\";\n+        Bitstream bitstream = null;\n+        try (InputStream is = IOUtils.toInputStream(bitstreamContent, CharEncoding.UTF_8)) {\n+            bitstream = BitstreamBuilder\n+                    .createBitstream(context, item, is)\n+                    .withName(\"Bitstream1\")\n+                    .withMimeType(\"text/plain\").build();\n+        }\n+\n+        context.restoreAuthSystemState();\n+\n+        getClient().perform(delete(\"/api/submission/workspaceitems/\" + witem.getID()))\n+                   .andExpect(status().isUnauthorized());\n+    }\n+\n+    @Test\n+    public void deleteOneForbiddenTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson submitter1 = EPersonBuilder.createEPerson(context)\n+                .withEmail(\"submitter1@example.com\")\n+                .withPassword(\"qwerty01\")\n+                .build();\n+        EPerson submitter2 = EPersonBuilder.createEPerson(context)\n+                .withEmail(\"submitter2@example.com\")\n+                .withPassword(\"qwerty02\")\n+                .build();\n+\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                .withName(\"Parent Community\")\n+                .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, parentCommunity)\n+                .withName(\"Collection 1\")\n+                .withSubmitterGroup(submitter1)\n+                .build();\n+\n+        context.setCurrentUser(submitter1);\n+        WorkspaceItem witem = WorkspaceItemBuilder.createWorkspaceItem(context, col1)\n+                .withTitle(\"Workspace Item 1\")\n+                .withIssueDate(\"2020-01-01\")\n+                .build();\n+\n+        Item item = witem.getItem();\n+\n+        //Add a bitstream to the item\n+        String bitstreamContent = \"ThisIsSomeDummyText\";\n+        Bitstream bitstream = null;\n+        try (InputStream is = IOUtils.toInputStream(bitstreamContent, CharEncoding.UTF_8)) {\n+            bitstream = BitstreamBuilder\n+                    .createBitstream(context, item, is)\n+                    .withName(\"Bitstream1\")\n+                    .withMimeType(\"text/plain\").build();\n+        }\n+\n+        context.restoreAuthSystemState();\n+\n+        String tokenSubmitter2 = getAuthToken(submitter2.getEmail(), \"qwerty02\");", "originalCommit": "b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg2NzM0Nw==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r390867347", "bodyText": "Why is this not based on context.getCurrentUser()?", "author": "benbosman", "createdAt": "2020-03-11T10:14:42Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/WorkspaceItemRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import java.sql.SQLException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.WorkspaceItemRest;\n+import org.dspace.app.rest.utils.ContextUtil;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.dspace.core.Context;\n+import org.dspace.eperson.EPerson;\n+import org.dspace.eperson.service.EPersonService;\n+import org.dspace.services.RequestService;\n+import org.dspace.services.model.Request;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * {@link RestPermissionEvaluatorPlugin} class that evaluate READ, WRITE and DELETE permissions over a WorkspaceItem\n+ * \n+ * @author Mykhaylo Boychuk (mykhaylo.boychuk at 4science.it)\n+ */\n+@Component\n+public class WorkspaceItemRestPermissionEvaluatorPlugin extends RestObjectPermissionEvaluatorPlugin {\n+\n+    private static final Logger log = LoggerFactory.getLogger(WorkspaceItemRestPermissionEvaluatorPlugin.class);\n+\n+    @Autowired\n+    private RequestService requestService;\n+\n+    @Autowired\n+    private EPersonService ePersonService;\n+\n+    @Autowired\n+    WorkspaceItemService wis;\n+\n+    @Override\n+    public boolean hasDSpacePermission(Authentication authentication, Serializable targetId, String targetType,\n+            DSpaceRestPermission permission) {\n+\n+        DSpaceRestPermission restPermission = DSpaceRestPermission.convert(permission);\n+        if (!DSpaceRestPermission.READ.equals(restPermission)\n+                && !DSpaceRestPermission.WRITE.equals(restPermission)\n+                && !DSpaceRestPermission.DELETE.equals(restPermission)) {\n+            return false;\n+        }\n+        if (!StringUtils.equalsIgnoreCase(targetType, WorkspaceItemRest.NAME)) {\n+            return false;\n+        }\n+\n+        Request request = requestService.getCurrentRequest();\n+        Context context = ContextUtil.obtainContext(request.getServletRequest());\n+\n+        EPerson ePerson = null;\n+        WorkspaceItem witem = null;\n+        try {\n+            ePerson = ePersonService.findByEmail(context, (String) authentication.getPrincipal());", "originalCommit": "b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1OTkzNg==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r391659936", "bodyText": "no reason indeed, it should be changed", "author": "abollini", "createdAt": "2020-03-12T14:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg2NzM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3MTM0Nw==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r390871347", "bodyText": "Are you still verifying the findBySubmitter method also works for admins to search for an other submitter (since that test seems to be removed here)", "author": "benbosman", "createdAt": "2020-03-11T10:21:56Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -417,11 +648,9 @@ public void findBySubmitterTest() throws Exception {\n                                       .withIssueDate(\"2016-02-13\")\n                                       .build();\n \n-        // use our admin to retrieve all the workspace by submitter\n-        String token = getAuthToken(admin.getEmail(), password);", "originalCommit": "b838ce4a6e00db203b8d8a67ba294916d5fe25dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNjY1OA==", "url": "https://github.com/DSpace/DSpace/pull/2675#discussion_r393516658", "bodyText": "done, see 5d98bcd#diff-38ba2da3dd74a1027593bbd62d684626R729", "author": "abollini", "createdAt": "2020-03-17T08:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3MTM0Nw=="}], "type": "inlineReview"}, {"oid": "37d5b13dd5573473e6af156c7cae1869d88bad23", "url": "https://github.com/DSpace/DSpace/commit/37d5b13dd5573473e6af156c7cae1869d88bad23", "message": "Merge branch 'revisitSecurityLayerOfSubmission-DS-4043' of https://github.com/Micheleboychuk/DSpace into revisitSecurityLayerOfSubmission-DS-4043", "committedDate": "2020-03-11T13:46:28Z", "type": "commit"}, {"oid": "46e532218c6889484cbfef6845fc3041c85c5e2c", "url": "https://github.com/DSpace/DSpace/commit/46e532218c6889484cbfef6845fc3041c85c5e2c", "message": "Merge branch 'master' into revisitSecurityLayerOfSubmission-DS-4043", "committedDate": "2020-03-12T16:45:50Z", "type": "commit"}, {"oid": "5d98bcd9110365c5f91c646fe9a4d8de3eb3cb37", "url": "https://github.com/DSpace/DSpace/commit/5d98bcd9110365c5f91c646fe9a4d8de3eb3cb37", "message": "Implement community feedback", "committedDate": "2020-03-12T21:21:17Z", "type": "commit"}, {"oid": "676558ad89eb05ffbc82bfb12579df61070f52b7", "url": "https://github.com/DSpace/DSpace/commit/676558ad89eb05ffbc82bfb12579df61070f52b7", "message": "fixed output message of RuntimeException", "committedDate": "2020-03-13T22:05:05Z", "type": "commit"}, {"oid": "8bdd0a3daeb7de6686eda2409ecded53a0baa789", "url": "https://github.com/DSpace/DSpace/commit/8bdd0a3daeb7de6686eda2409ecded53a0baa789", "message": "Merge branch 'master' into revisitSecurityLayerOfSubmission-DS-4043", "committedDate": "2020-03-13T23:45:35Z", "type": "commit"}, {"oid": "8a6246038b768a2cc213befde7f1db38205fc794", "url": "https://github.com/DSpace/DSpace/commit/8a6246038b768a2cc213befde7f1db38205fc794", "message": "fix typo, use the normal user token", "committedDate": "2020-03-16T14:59:47Z", "type": "commit"}]}