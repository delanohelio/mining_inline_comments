{"pr_number": 2762, "pr_title": "Configuration property retrieval Rest endpoint", "pr_createdAt": "2020-05-19T08:41:22Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2762", "timeline": [{"oid": "d8bda5c721e1bedde28f95168d47f1b5d3b61fc2", "url": "https://github.com/DSpace/DSpace/commit/d8bda5c721e1bedde28f95168d47f1b5d3b61fc2", "message": "70471: Add configuration properties endpoint", "committedDate": "2020-05-04T09:19:27Z", "type": "commit"}, {"oid": "f85a5b3c4d8127ff8f9f622e51948171fef76d33", "url": "https://github.com/DSpace/DSpace/commit/f85a5b3c4d8127ff8f9f622e51948171fef76d33", "message": "70603: Make the configuration properties endpoint conform to the contract", "committedDate": "2020-05-04T15:56:14Z", "type": "commit"}, {"oid": "7fcb782230bb5b71a799322e23998d427aac5419", "url": "https://github.com/DSpace/DSpace/commit/7fcb782230bb5b71a799322e23998d427aac5419", "message": "70824: Configuration properties endpoint feedback", "committedDate": "2020-05-11T10:56:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwODkyMg==", "url": "https://github.com/DSpace/DSpace/pull/2762#discussion_r432708922", "bodyText": "You can replace this getArrayProperty().length check with a call to configurationService.hasProperty().  That's the recommended way to determine if a property exists in our configuration.", "author": "tdonohue", "createdAt": "2020-05-29T20:03:19Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/ConfigurationRestRepository.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import javax.annotation.Resource;\n+\n+import org.dspace.app.rest.exception.RepositoryMethodNotImplementedException;\n+import org.dspace.app.rest.model.PropertyRest;\n+import org.dspace.core.Context;\n+import org.dspace.services.ConfigurationService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Page;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.data.rest.webmvc.ResourceNotFoundException;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * This is the repository responsible of exposing configuration properties\n+ */\n+@Component(PropertyRest.CATEGORY + \".\" + PropertyRest.NAME)\n+public class ConfigurationRestRepository extends DSpaceRestRepository<PropertyRest, String> {\n+    @Autowired\n+    private ConfigurationService configurationService;\n+\n+    @Resource(name = \"exposedConfigurationProperties\")\n+    private ArrayList<String> exposedProperties;\n+\n+    /**\n+     * Gets the value of a configuration property if it is exposed via REST\n+     *\n+     * Example:\n+     * <pre>\n+     * {@code\n+     * curl http://<dspace.server.url>/api/config/properties/google.analytics.key\n+     *  -XGET \\\n+     *  -H 'Authorization: Bearer eyJhbGciOiJI...'\n+     * }\n+     * </pre>\n+     *\n+     * @param property\n+     * @return\n+     */\n+    @Override\n+    public PropertyRest findOne(Context context, String property) {\n+        if (!exposedProperties.contains(property) || configurationService.getArrayProperty(property).length == 0) {", "originalCommit": "7fcb782230bb5b71a799322e23998d427aac5419", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxNTMwNg==", "url": "https://github.com/DSpace/DSpace/pull/2762#discussion_r432715306", "bodyText": "As I was reviewing this code, I've just now realized that I'm not sure whether we want a 405 response on the main endpoint (which I know we decided on in the contract).  If this returns a 405, that is more secure, but how will the Client ever know which properties are available?  Do we just need to assume the Client is hardcoded to know what properties are server side properties?\nThis isn't a question we have to resolve in this particular PR, it could be resolved in a followup PR.  But, we might be setting up a problem similar to the one described in DS-4495 by completely hiding the list of configurations from the client side.  Maybe @artlowel should look at this PRs approach to see if it will work for the Angular UI?", "author": "tdonohue", "createdAt": "2020-05-29T20:18:18Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/ConfigurationRestRepository.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import javax.annotation.Resource;\n+\n+import org.dspace.app.rest.exception.RepositoryMethodNotImplementedException;\n+import org.dspace.app.rest.model.PropertyRest;\n+import org.dspace.core.Context;\n+import org.dspace.services.ConfigurationService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Page;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.data.rest.webmvc.ResourceNotFoundException;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * This is the repository responsible of exposing configuration properties\n+ */\n+@Component(PropertyRest.CATEGORY + \".\" + PropertyRest.NAME)\n+public class ConfigurationRestRepository extends DSpaceRestRepository<PropertyRest, String> {\n+    @Autowired\n+    private ConfigurationService configurationService;\n+\n+    @Resource(name = \"exposedConfigurationProperties\")\n+    private ArrayList<String> exposedProperties;\n+\n+    /**\n+     * Gets the value of a configuration property if it is exposed via REST\n+     *\n+     * Example:\n+     * <pre>\n+     * {@code\n+     * curl http://<dspace.server.url>/api/config/properties/google.analytics.key\n+     *  -XGET \\\n+     *  -H 'Authorization: Bearer eyJhbGciOiJI...'\n+     * }\n+     * </pre>\n+     *\n+     * @param property\n+     * @return\n+     */\n+    @Override\n+    public PropertyRest findOne(Context context, String property) {\n+        if (!exposedProperties.contains(property) || configurationService.getArrayProperty(property).length == 0) {\n+            throw new ResourceNotFoundException(\"No such configuration property: \" + property);\n+        }\n+\n+        String[] propertyValues = configurationService.getArrayProperty(property);\n+\n+        PropertyRest propertyRest = new PropertyRest();\n+        propertyRest.setName(property);\n+        propertyRest.setValues(Arrays.asList(propertyValues));\n+\n+        return propertyRest;\n+    }\n+\n+    @Override\n+    public Page<PropertyRest> findAll(Context context, Pageable pageable) {\n+        throw new RepositoryMethodNotImplementedException(\"No implementation found; Method not allowed\", \"\");", "originalCommit": "7fcb782230bb5b71a799322e23998d427aac5419", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc0NDc5Mw==", "url": "https://github.com/DSpace/DSpace/pull/2762#discussion_r433744793", "bodyText": "I don't really see a way past hardcoding the property names we need for a specific feature in the client. E.g. the client side code that needs to configure the google analytics ID needs to know some name for the property it needs from the server. It can't just iterate over the list of all properties until it finds something that looks like a google analytics ID.\nAs long as the property name is the only part of the url we need to hardcode we'll be fine. It's not that different from filling in the UUID in the findById for an item for example. We also don't get the complete HAL link from the server in those cases.\nThe only use case to have the findAll endpoint available I can think of right now would be an overview of the server config for admins, which could be useful, but isn't planned right now as far as I know.", "author": "artlowel", "createdAt": "2020-06-02T09:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxNTMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2Njg2NQ==", "url": "https://github.com/DSpace/DSpace/pull/2762#discussion_r433966865", "bodyText": "@artlowel : Good points, and you are right. I'll flag this comment as resolved, as we can just keep the 405 response here for now.", "author": "tdonohue", "createdAt": "2020-06-02T15:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxNTMwNg=="}], "type": "inlineReview"}, {"oid": "4e61be497ee9981dbd7027283939061fc9ce895c", "url": "https://github.com/DSpace/DSpace/commit/4e61be497ee9981dbd7027283939061fc9ce895c", "message": "71220: Configuration properties endpoint - PR feedback", "committedDate": "2020-06-04T12:04:41Z", "type": "commit"}, {"oid": "24ede371ca5b3b33c98abbbd2e1a164b5df82d86", "url": "https://github.com/DSpace/DSpace/commit/24ede371ca5b3b33c98abbbd2e1a164b5df82d86", "message": "Merge remote-tracking branch 'community/master' into w2p-70471_request-configuration-properties-in-rest", "committedDate": "2020-06-04T13:36:02Z", "type": "commit"}, {"oid": "a7aeb102d4d714c26d9d4a138088cc40f1df1bef", "url": "https://github.com/DSpace/DSpace/commit/a7aeb102d4d714c26d9d4a138088cc40f1df1bef", "message": "71220: Configuration properties endpoint - PR feedback\n\n- fixes after merging with latest master", "committedDate": "2020-06-05T15:28:24Z", "type": "commit"}]}