{"pr_number": 2914, "pr_title": "DS-4514 Additional Providers - Start new submission by uploading a Bibliographic File (using Live Import) ", "pr_createdAt": "2020-08-03T13:37:39Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2914", "timeline": [{"oid": "3c349cb70c775be1d13bbe1109d53bff1aa6e050", "url": "https://github.com/DSpace/DSpace/commit/3c349cb70c775be1d13bbe1109d53bff1aa6e050", "message": "RIS, CSV and TSV live import implementation", "committedDate": "2020-07-06T09:16:08Z", "type": "commit"}, {"oid": "b7949a14d7b230d16ccd12139d3b28836ef7d24d", "url": "https://github.com/DSpace/DSpace/commit/b7949a14d7b230d16ccd12139d3b28836ef7d24d", "message": "Add endnote support and (partial) test", "committedDate": "2020-07-06T14:35:48Z", "type": "commit"}, {"oid": "dc958c9d670082987597932712f5b4203b56c658", "url": "https://github.com/DSpace/DSpace/commit/dc958c9d670082987597932712f5b4203b56c658", "message": "Add support for multiple authors in *sv, complete implementation for RIS\nand Endnote, complete IT", "committedDate": "2020-07-07T22:06:49Z", "type": "commit"}, {"oid": "3f8e68055728405b11ca2dddf52810975b33f139", "url": "https://github.com/DSpace/DSpace/commit/3f8e68055728405b11ca2dddf52810975b33f139", "message": "Add comments", "committedDate": "2020-07-07T23:09:40Z", "type": "commit"}, {"oid": "493ab0f496724c6000d17736a564f4be8824e9bb", "url": "https://github.com/DSpace/DSpace/commit/493ab0f496724c6000d17736a564f4be8824e9bb", "message": "Add license header", "committedDate": "2020-07-07T23:49:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2Mjk3Mg==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r467162972", "bodyText": "Minor spelling typo.  This should be named aggregateData.  As this is an important private method, I'd like to see some JavaDocs (or a basic comment) to describe what this method is doing to \"aggregate\" the data.", "author": "tdonohue", "createdAt": "2020-08-07T17:05:53Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/ris/service/RisImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.ris.service;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Resource;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for RIS files\n+ * Implementations insprider by BTE DataLoader {@link https://github.com/EKT/Biblio-Transformation-Engine/blob/master/bte-io/src/main/java/gr/ekt/bteio/loaders/RISDataLoader.java}\n+ * \n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class RisImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"RISMetadataSource\";\n+    }\n+\n+    protected List<PlainMetadataSourceDto> readData(InputStream inputStream) throws FileSourceException {\n+        return aggreageteData(inputStream);\n+    }\n+\n+    private List<PlainMetadataSourceDto> aggreageteData(InputStream inputStream) throws FileSourceException {", "originalCommit": "493ab0f496724c6000d17736a564f4be8824e9bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2Mzg4Mw==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r467163883", "bodyText": "Same here, this is an important method & I'd like to see JavaDocs to describe it (as it will make it easier to maintain or debug in the future)", "author": "tdonohue", "createdAt": "2020-08-07T17:07:49Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/ris/service/RisImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.ris.service;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Resource;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for RIS files\n+ * Implementations insprider by BTE DataLoader {@link https://github.com/EKT/Biblio-Transformation-Engine/blob/master/bte-io/src/main/java/gr/ekt/bteio/loaders/RISDataLoader.java}\n+ * \n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class RisImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"RISMetadataSource\";\n+    }\n+\n+    protected List<PlainMetadataSourceDto> readData(InputStream inputStream) throws FileSourceException {\n+        return aggreageteData(inputStream);\n+    }\n+\n+    private List<PlainMetadataSourceDto> aggreageteData(InputStream inputStream) throws FileSourceException {\n+        List<PlainMetadataSourceDto> metadata = new ArrayList<>();\n+        List<PlainMetadataKeyValueItem> notAggregatedItems = notAggregatedData(inputStream);\n+        List<PlainMetadataKeyValueItem> aggregatedTmpList = null;\n+        Iterator<PlainMetadataKeyValueItem> itr = notAggregatedItems.iterator();\n+        while (itr.hasNext()) {\n+            PlainMetadataKeyValueItem item = itr.next();\n+            if (\"TY\".equals(item.getKey())) {\n+                if (aggregatedTmpList != null) {\n+                    PlainMetadataSourceDto dto = new PlainMetadataSourceDto();\n+                    dto.setMetadata(new ArrayList<>(aggregatedTmpList));\n+                    metadata.add(dto);\n+                }\n+                aggregatedTmpList = new ArrayList<>();\n+                aggregatedTmpList.add(item);\n+            } else {\n+                if (aggregatedTmpList != null) {\n+                    aggregatedTmpList.add(item);\n+                    // save last iteration metadata\n+                    if (!itr.hasNext()) {\n+                        PlainMetadataSourceDto dto = new PlainMetadataSourceDto();\n+                        dto.setMetadata(new ArrayList<>(aggregatedTmpList));\n+                        metadata.add(dto);\n+                    }\n+                }\n+            }\n+        }\n+        return metadata;\n+    }\n+\n+    private List<PlainMetadataKeyValueItem> notAggregatedData(InputStream inputStream) throws FileSourceException {", "originalCommit": "493ab0f496724c6000d17736a564f4be8824e9bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2NDI2MA==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r467164260", "bodyText": "Can we describe this method in JavaDocs.  I know it's a private method, but it's very important to this class so it'd be good to document it.", "author": "tdonohue", "createdAt": "2020-08-07T17:08:37Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/endnote/service/EndnoteImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.endnote.service;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.metadatamapping.MetadataFieldConfig;\n+import org.dspace.importer.external.metadatamapping.contributor.MetadataContributor;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for Endnote files\n+ *\n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class EndnoteImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"EndnoteMetadataSource\";\n+    }\n+\n+    @Override\n+    protected List<PlainMetadataSourceDto> readData(InputStream fileInpuStream) throws FileSourceException {\n+        List<PlainMetadataSourceDto> list = new ArrayList<>();\n+        try {\n+            int lineForDebug = 3;\n+            List<PlainMetadataKeyValueItem> tokenized = tokenize(fileInpuStream);\n+            List<PlainMetadataKeyValueItem> tmpList = new ArrayList<>();\n+            for (PlainMetadataKeyValueItem item : tokenized) {\n+                if (item.getKey() == null || item.getKey().isEmpty()) {\n+                    throw new FileSourceException(\"Null or empty key expected on line \"\n+                    + lineForDebug + \". Keys cannot be null nor empty\");\n+                }\n+                if (\"EF\".equals(item.getKey())) {\n+                    break;\n+                }\n+                if (\"ER\".equals(item.getKey())) {\n+                    PlainMetadataSourceDto dto = new PlainMetadataSourceDto();\n+                    dto.setMetadata(new ArrayList<>(tmpList));\n+                    list.add(dto);\n+                    tmpList = new ArrayList<>();\n+                } else {\n+                    if (item.getValue() == null || item.getValue().isEmpty()) {\n+                        throw new FileSourceException(\"Null or empty value expected on line \"\n+                        + lineForDebug + \". Value expected\");\n+                    }\n+                    tmpList.add(item);\n+                }\n+                lineForDebug++;\n+            }\n+        } catch (Exception e) {\n+            throw new FileSourceException(\"Error reading file\");\n+        }\n+        return list;\n+    }\n+\n+\n+    private List<PlainMetadataKeyValueItem> tokenize(InputStream fileInpuStream)", "originalCommit": "493ab0f496724c6000d17736a564f4be8824e9bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2NDY1OA==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r467164658", "bodyText": "Please describe this method with JavaDocs, as it's overriding readData to do specific processes for character separated files.  Therefore, we should document what it's doing here.", "author": "tdonohue", "createdAt": "2020-08-07T17:09:26Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/csv/service/CharacterSeparatedImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.csv.service;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import au.com.bytecode.opencsv.CSVReader;\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.metadatamapping.MetadataFieldConfig;\n+import org.dspace.importer.external.metadatamapping.contributor.MetadataContributor;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.MetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+\n+/**\n+ * This class is an implementation of {@link MetadataSource} which extends {@link AbstractPlainMetadataSource}\n+ * in order to parse \"character separated\" files like csv, tsv, etc using the Live Import framework.\n+ * \n+ * @author Pasquale Cavallo\n+ *\n+ */\n+public class CharacterSeparatedImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    private char separator = ',';\n+\n+    private char escapeCharacter = '\"';\n+\n+    private Integer skipLines = 1;\n+\n+    private String importSource = \"CsvMetadataSource\";\n+\n+    /**\n+     * Set the number of lines to skip at the start of the file. This method is suitable,\n+     * for example, to skip file headers.\n+     * \n+     * @param skipLines number of the line at the start of the file to skip.\n+     */\n+    public void setSkipLines(Integer skipLines) {\n+        this.skipLines = skipLines;\n+    }\n+\n+    /**\n+     * \n+     * @return the number of the lines to skip\n+     */\n+    public Integer getSkipLines() {\n+        return skipLines;\n+    }\n+\n+    /**\n+     * Method to inject the separator\n+     * This must be the ASCII integer\n+     * related to the char.\n+     * In example, 9 for tab, 44 for comma\n+     */\n+    public void setSeparator(int separator) {\n+        this.separator = (char)separator;\n+    }\n+\n+    @Override\n+    public String getImportSource() {\n+        return importSource;\n+    }\n+\n+    /**\n+     * Method to set the name of the source\n+     */\n+    public void setImportSource(String importSource) {\n+        this.importSource = importSource;\n+    }\n+\n+    /**\n+     * Method to inject the escape character. This must be the ASCII integer\n+     * related to the char.\n+     * In example, 9 for tab, 44 for comma\n+     * \n+     */\n+    public void setEscapeCharacter(int escapeCharacter) {\n+        this.escapeCharacter = (char)escapeCharacter;\n+    }\n+\n+    @Override\n+    protected List<PlainMetadataSourceDto> readData(InputStream inputStream) throws FileSourceException {", "originalCommit": "493ab0f496724c6000d17736a564f4be8824e9bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2NzM3OQ==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r467167379", "bodyText": "Comment is incorrect here. This isn't a \"bulk create\". There's another incorrect comment on line 977 and 1005 just below this as well.  Please make sure your comments in tests are accurate, otherwise it can be confusing to debug later on.\nThere's a number of these same incorrect comments throughout this entire IT file.  So, you may want to search for \"bulk create\" and replace all those comments that are inaccurate.", "author": "tdonohue", "createdAt": "2020-08-07T17:14:53Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -907,42 +907,660 @@ public void createMultipleWorkspaceItemFromFileTest() throws Exception {\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col1.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n         ;\n \n         // bulk create workspaceitems explicitly in the col2\n         getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n                     .file(bibtexFile)\n-                    .param(\"collection\", col2.getID().toString()))\n+                    .param(\"owningCollection\", col2.getID().toString()))\n                 .andExpect(status().isOk())\n                 .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n+\n+        bibtex.close();\n+    }\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a csv file\n+     *\n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemFromCSVWithOneEntryTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream csv = getClass().getResourceAsStream(\"csv-test.csv\");\n+        final MockMultipartFile csvFile = new MockMultipartFile(\"file\", \"/local/path/csv-test.csv\",\n+            \"text/csv\", csv);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)", "originalCommit": "493ab0f496724c6000d17736a564f4be8824e9bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxNTQ5MQ==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r474815491", "bodyText": "This feedback is not addressed (though it is minor).  Essentially, this entire IT file has a large number of comments that all start with // bulk create   From what I can tell, all of those comments are inaccurate/incorrect, as we are never bulk creating content via live import...we are only creating one WorkspaceItem at a time.   So, it'd be good to either correct all these comments in this IT (there's at least 10 of them) or remove them all.", "author": "tdonohue", "createdAt": "2020-08-21T16:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2NzM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTYxMA==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r467169610", "bodyText": "For all of these fileUpload tests (in this entire IT class), is there a way to cleanup (i.e. delete) the WorkspaceItems you are creating?  It seems like we might be accidentally creating a lot of content here that should be cleaned up after creation.  Maybe we can capture the newly created ID of the WorkspaceItem and use the WorkspaceItemBuilder to delete it?", "author": "tdonohue", "createdAt": "2020-08-07T17:19:37Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -907,42 +907,660 @@ public void createMultipleWorkspaceItemFromFileTest() throws Exception {\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col1.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n         ;\n \n         // bulk create workspaceitems explicitly in the col2\n         getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n                     .file(bibtexFile)\n-                    .param(\"collection\", col2.getID().toString()))\n+                    .param(\"owningCollection\", col2.getID().toString()))\n                 .andExpect(status().isOk())\n                 .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n+\n+        bibtex.close();\n+    }\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a csv file\n+     *\n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemFromCSVWithOneEntryTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream csv = getClass().getResourceAsStream(\"csv-test.csv\");\n+        final MockMultipartFile csvFile = new MockMultipartFile(\"file\", \"/local/path/csv-test.csv\",\n+            \"text/csv\", csv);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(csvFile))", "originalCommit": "493ab0f496724c6000d17736a564f4be8824e9bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "url": "https://github.com/DSpace/DSpace/commit/57ae7ee7f0a47ced61b63125814ef7d266f2a707", "message": "Merge branch 'main' into D4CRIS-960", "committedDate": "2020-08-11T16:13:33Z", "type": "commit"}, {"oid": "6db52f37fd8d8ac4b5be073cd7015c9a26840673", "url": "https://github.com/DSpace/DSpace/commit/6db52f37fd8d8ac4b5be073cd7015c9a26840673", "message": "Add javadoc and comment", "committedDate": "2020-08-12T13:15:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MDc2OA==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469250768", "bodyText": "Could this variable be a leftover from bugfixing, doesn't seem to do anything.", "author": "KevinVdV", "createdAt": "2020-08-12T13:16:20Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/endnote/service/EndnoteImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.endnote.service;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.metadatamapping.MetadataFieldConfig;\n+import org.dspace.importer.external.metadatamapping.contributor.MetadataContributor;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for Endnote files\n+ *\n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class EndnoteImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"EndnoteMetadataSource\";\n+    }\n+\n+    @Override\n+    protected List<PlainMetadataSourceDto> readData(InputStream fileInpuStream) throws FileSourceException {\n+        List<PlainMetadataSourceDto> list = new ArrayList<>();\n+        try {\n+            int lineForDebug = 3;", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgyNjYyNw==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469826627", "bodyText": "It is used by logger on rows 48 and 61, tracks the row number where the error occurs", "author": "pasqualecvl", "createdAt": "2020-08-13T09:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MDc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MTQwNA==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469251404", "bodyText": "Can this exception include the exception as well, same as for: CharacterSeparatedImportMetadataSourceServiceImpl", "author": "KevinVdV", "createdAt": "2020-08-12T13:17:23Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/endnote/service/EndnoteImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.endnote.service;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.metadatamapping.MetadataFieldConfig;\n+import org.dspace.importer.external.metadatamapping.contributor.MetadataContributor;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for Endnote files\n+ *\n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class EndnoteImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"EndnoteMetadataSource\";\n+    }\n+\n+    @Override\n+    protected List<PlainMetadataSourceDto> readData(InputStream fileInpuStream) throws FileSourceException {\n+        List<PlainMetadataSourceDto> list = new ArrayList<>();\n+        try {\n+            int lineForDebug = 3;\n+            List<PlainMetadataKeyValueItem> tokenized = tokenize(fileInpuStream);\n+            List<PlainMetadataKeyValueItem> tmpList = new ArrayList<>();\n+            for (PlainMetadataKeyValueItem item : tokenized) {\n+                if (item.getKey() == null || item.getKey().isEmpty()) {\n+                    throw new FileSourceException(\"Null or empty key expected on line \"\n+                    + lineForDebug + \". Keys cannot be null nor empty\");\n+                }\n+                if (\"EF\".equals(item.getKey())) {\n+                    break;\n+                }\n+                if (\"ER\".equals(item.getKey())) {\n+                    PlainMetadataSourceDto dto = new PlainMetadataSourceDto();\n+                    dto.setMetadata(new ArrayList<>(tmpList));\n+                    list.add(dto);\n+                    tmpList = new ArrayList<>();\n+                } else {\n+                    if (item.getValue() == null || item.getValue().isEmpty()) {\n+                        throw new FileSourceException(\"Null or empty value expected on line \"", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MjEyOA==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469252128", "bodyText": "InputStreamReader & BufferedReader aren't closed.", "author": "KevinVdV", "createdAt": "2020-08-12T13:18:29Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/endnote/service/EndnoteImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.endnote.service;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.metadatamapping.MetadataFieldConfig;\n+import org.dspace.importer.external.metadatamapping.contributor.MetadataContributor;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for Endnote files\n+ *\n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class EndnoteImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"EndnoteMetadataSource\";\n+    }\n+\n+    @Override\n+    protected List<PlainMetadataSourceDto> readData(InputStream fileInpuStream) throws FileSourceException {\n+        List<PlainMetadataSourceDto> list = new ArrayList<>();\n+        try {\n+            int lineForDebug = 3;\n+            List<PlainMetadataKeyValueItem> tokenized = tokenize(fileInpuStream);\n+            List<PlainMetadataKeyValueItem> tmpList = new ArrayList<>();\n+            for (PlainMetadataKeyValueItem item : tokenized) {\n+                if (item.getKey() == null || item.getKey().isEmpty()) {\n+                    throw new FileSourceException(\"Null or empty key expected on line \"\n+                    + lineForDebug + \". Keys cannot be null nor empty\");\n+                }\n+                if (\"EF\".equals(item.getKey())) {\n+                    break;\n+                }\n+                if (\"ER\".equals(item.getKey())) {\n+                    PlainMetadataSourceDto dto = new PlainMetadataSourceDto();\n+                    dto.setMetadata(new ArrayList<>(tmpList));\n+                    list.add(dto);\n+                    tmpList = new ArrayList<>();\n+                } else {\n+                    if (item.getValue() == null || item.getValue().isEmpty()) {\n+                        throw new FileSourceException(\"Null or empty value expected on line \"\n+                        + lineForDebug + \". Value expected\");\n+                    }\n+                    tmpList.add(item);\n+                }\n+                lineForDebug++;\n+            }\n+        } catch (Exception e) {\n+            throw new FileSourceException(\"Error reading file\");\n+        }\n+        return list;\n+    }\n+\n+\n+    private List<PlainMetadataKeyValueItem> tokenize(InputStream fileInpuStream)\n+        throws IOException, FileSourceException {\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(fileInpuStream));", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1MjgzMQ==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469852831", "bodyText": "Those resources will be closed by closing the InputStream in the try-with-resources at ImportService:312", "author": "pasqualecvl", "createdAt": "2020-08-13T10:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MjEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1NTc1Nw==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469255757", "bodyText": "Missing @OverRide annotation.", "author": "KevinVdV", "createdAt": "2020-08-12T13:23:40Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/ris/service/RisImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.ris.service;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Resource;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for RIS files\n+ * Implementations insprider by BTE DataLoader {@link https://github.com/EKT/Biblio-Transformation-Engine/blob/master/bte-io/src/main/java/gr/ekt/bteio/loaders/RISDataLoader.java}\n+ * \n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class RisImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"RISMetadataSource\";\n+    }\n+\n+    protected List<PlainMetadataSourceDto> readData(InputStream inputStream) throws FileSourceException {", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI3MzAzOQ==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469273039", "bodyText": "Could you add some javadocs AND/OR split this up the code below into smaller methods with readable names. I find it hard to understand what the code is doing here in order to process the file.", "author": "KevinVdV", "createdAt": "2020-08-12T13:48:56Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/csv/service/CharacterSeparatedImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.csv.service;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import au.com.bytecode.opencsv.CSVReader;\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.metadatamapping.MetadataFieldConfig;\n+import org.dspace.importer.external.metadatamapping.contributor.MetadataContributor;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.MetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+\n+/**\n+ * This class is an implementation of {@link MetadataSource} which extends {@link AbstractPlainMetadataSource}\n+ * in order to parse \"character separated\" files like csv, tsv, etc using the Live Import framework.\n+ * \n+ * @author Pasquale Cavallo\n+ *\n+ */\n+public class CharacterSeparatedImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    private char separator = ',';\n+\n+    private char escapeCharacter = '\"';\n+\n+    private Integer skipLines = 1;\n+\n+    private String importSource = \"CsvMetadataSource\";\n+\n+    /**\n+     * Set the number of lines to skip at the start of the file. This method is suitable,\n+     * for example, to skip file headers.\n+     * \n+     * @param skipLines number of the line at the start of the file to skip.\n+     */\n+    public void setSkipLines(Integer skipLines) {\n+        this.skipLines = skipLines;\n+    }\n+\n+    /**\n+     * \n+     * @return the number of the lines to skip\n+     */\n+    public Integer getSkipLines() {\n+        return skipLines;\n+    }\n+\n+    /**\n+     * Method to inject the separator\n+     * This must be the ASCII integer\n+     * related to the char.\n+     * In example, 9 for tab, 44 for comma\n+     */\n+    public void setSeparator(int separator) {\n+        this.separator = (char)separator;\n+    }\n+\n+    @Override\n+    public String getImportSource() {\n+        return importSource;\n+    }\n+\n+    /**\n+     * Method to set the name of the source\n+     */\n+    public void setImportSource(String importSource) {\n+        this.importSource = importSource;\n+    }\n+\n+    /**\n+     * Method to inject the escape character. This must be the ASCII integer\n+     * related to the char.\n+     * In example, 9 for tab, 44 for comma\n+     * \n+     */\n+    public void setEscapeCharacter(int escapeCharacter) {\n+        this.escapeCharacter = (char)escapeCharacter;\n+    }\n+\n+    @Override\n+    protected List<PlainMetadataSourceDto> readData(InputStream inputStream) throws FileSourceException {\n+        List<PlainMetadataSourceDto> plainMetadataList = new ArrayList<>();\n+        try (CSVReader csvReader = new CSVReader(new InputStreamReader(inputStream, StandardCharsets.UTF_8),", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI3MzI3Mg==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469273272", "bodyText": "Could you add some javadocs AND/OR split this up the code below into smaller methods with readable names. I find it hard to understand what the code is doing here in order to process the file.", "author": "KevinVdV", "createdAt": "2020-08-12T13:49:18Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/endnote/service/EndnoteImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.endnote.service;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.metadatamapping.MetadataFieldConfig;\n+import org.dspace.importer.external.metadatamapping.contributor.MetadataContributor;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for Endnote files\n+ *\n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class EndnoteImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"EndnoteMetadataSource\";\n+    }\n+\n+    @Override\n+    protected List<PlainMetadataSourceDto> readData(InputStream fileInpuStream) throws FileSourceException {", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI3MzU2Mw==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469273563", "bodyText": "Could you add some javadocs AND/OR split this up the code below into smaller methods with readable names. I find it hard to understand what the code is doing here in order to process the file.", "author": "KevinVdV", "createdAt": "2020-08-12T13:49:38Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/endnote/service/EndnoteImportMetadataSourceServiceImpl.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.endnote.service;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.dspace.importer.external.exception.FileSourceException;\n+import org.dspace.importer.external.metadatamapping.MetadataFieldConfig;\n+import org.dspace.importer.external.metadatamapping.contributor.MetadataContributor;\n+import org.dspace.importer.external.service.components.AbstractPlainMetadataSource;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+/**\n+ * Implements a metadata importer for Endnote files\n+ *\n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ */\n+public class EndnoteImportMetadataSourceServiceImpl extends AbstractPlainMetadataSource {\n+\n+    @Override\n+    public String getImportSource() {\n+        return \"EndnoteMetadataSource\";\n+    }\n+\n+    @Override\n+    protected List<PlainMetadataSourceDto> readData(InputStream fileInpuStream) throws FileSourceException {\n+        List<PlainMetadataSourceDto> list = new ArrayList<>();\n+        try {\n+            int lineForDebug = 3;\n+            List<PlainMetadataKeyValueItem> tokenized = tokenize(fileInpuStream);\n+            List<PlainMetadataKeyValueItem> tmpList = new ArrayList<>();\n+            for (PlainMetadataKeyValueItem item : tokenized) {\n+                if (item.getKey() == null || item.getKey().isEmpty()) {\n+                    throw new FileSourceException(\"Null or empty key expected on line \"\n+                    + lineForDebug + \". Keys cannot be null nor empty\");\n+                }\n+                if (\"EF\".equals(item.getKey())) {\n+                    break;\n+                }\n+                if (\"ER\".equals(item.getKey())) {\n+                    PlainMetadataSourceDto dto = new PlainMetadataSourceDto();\n+                    dto.setMetadata(new ArrayList<>(tmpList));\n+                    list.add(dto);\n+                    tmpList = new ArrayList<>();\n+                } else {\n+                    if (item.getValue() == null || item.getValue().isEmpty()) {\n+                        throw new FileSourceException(\"Null or empty value expected on line \"\n+                        + lineForDebug + \". Value expected\");\n+                    }\n+                    tmpList.add(item);\n+                }\n+                lineForDebug++;\n+            }\n+        } catch (Exception e) {\n+            throw new FileSourceException(\"Error reading file\");\n+        }\n+        return list;\n+    }\n+\n+\n+    private List<PlainMetadataKeyValueItem> tokenize(InputStream fileInpuStream)\n+        throws IOException, FileSourceException {\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(fileInpuStream));\n+        String line;\n+        line = reader.readLine();", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI3OTQwOQ==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469279409", "bodyText": "What is the purpose of this variable ? I assume that when this bean is configured to be used that you want to use the enhance logic, if you don't want to use it one can configure the \"SimpleMetadataContributor\" class in the xml bean setup.", "author": "KevinVdV", "createdAt": "2020-08-12T13:57:32Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/metadatamapping/contributor/EnhancedSimpleMetadataContributor.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.metadatamapping.contributor;\n+\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.util.Collection;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+import au.com.bytecode.opencsv.CSVReader;\n+import org.dspace.importer.external.metadatamapping.MetadatumDTO;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+\n+/**\n+ * This class implements functionalities to handle common situation regarding plain metadata.\n+ * In some scenario, like csv or tsv, the format don't allow lists.\n+ * We can use this MetadataContribut to parse a given plain metadata and split it into\n+ * related list, based on the delimiter. No escape character is present.\n+ * Default values are comma (,) for delimiter, and double quote (\") for escape character\n+ * \n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ *\n+ */\n+public class EnhancedSimpleMetadataContributor extends SimpleMetadataContributor {\n+\n+    private char delimiter = ',';\n+\n+    private char escape = '\"';\n+\n+    private boolean useEnhancer;", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1MjY0MQ==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469852641", "bodyText": "I introduced this variable to have a quick way to disable the enhancer. But you're right, doesn't make so much sense. I'll remove this.", "author": "pasqualecvl", "createdAt": "2020-08-13T10:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI3OTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI4MTIyNQ==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469281225", "bodyText": "Am I correct in understanding that the \"value\" variable here represent a single column in a csv and that we just want to split this column into multiple values based on a splitter. If so why use a CSVReader, StringReader ? Can't we just use StringUtils.split() ? (Less object creation & overhead)", "author": "KevinVdV", "createdAt": "2020-08-12T14:00:01Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/metadatamapping/contributor/EnhancedSimpleMetadataContributor.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.importer.external.metadatamapping.contributor;\n+\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.util.Collection;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+import au.com.bytecode.opencsv.CSVReader;\n+import org.dspace.importer.external.metadatamapping.MetadatumDTO;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataKeyValueItem;\n+import org.dspace.importer.external.service.components.dto.PlainMetadataSourceDto;\n+\n+\n+/**\n+ * This class implements functionalities to handle common situation regarding plain metadata.\n+ * In some scenario, like csv or tsv, the format don't allow lists.\n+ * We can use this MetadataContribut to parse a given plain metadata and split it into\n+ * related list, based on the delimiter. No escape character is present.\n+ * Default values are comma (,) for delimiter, and double quote (\") for escape character\n+ * \n+ * @author Pasquale Cavallo (pasquale.cavallo at 4science dot it)\n+ *\n+ */\n+public class EnhancedSimpleMetadataContributor extends SimpleMetadataContributor {\n+\n+    private char delimiter = ',';\n+\n+    private char escape = '\"';\n+\n+    private boolean useEnhancer;\n+\n+    /**\n+     * This method could be used to set the delimiter used during parse\n+     * If no delimiter is set, comma will be used\n+     */\n+    public void setDelimiter(int delimiter) {\n+        this.delimiter = (char)delimiter;\n+    }\n+\n+    /**\n+     * This method could be used to get the delimiter used in this class\n+     */\n+    public char getDelimiter() {\n+        return delimiter;\n+    }\n+\n+    /**\n+     * Method to inject the escape character.\n+     * This must be the ASCII integer\n+     * related to the char.\n+     * In example, 9 for tab, 44 for comma\n+     * If no escape is set, double quote will be used\n+     */\n+    public void setEscape(int escape) {\n+        this.escape = (char)escape;\n+    }\n+\n+    /**\n+     * Method to get the escape character.\n+     * \n+     */\n+    public char getEscape() {\n+        return escape;\n+    }\n+\n+    /**\n+     * Method to set up the enhancer. If set to false, enhancing will be not used\n+     * In this case, the metadata value will\n+     * As default, it is valued as false\n+     * \n+     */\n+    public void setUseEnhancer(boolean useEnhancer) {\n+        this.useEnhancer = useEnhancer;\n+    }\n+\n+    /**\n+     * \n+     * @return true if the enhancer is set up, false otherwise.\n+     */\n+    public boolean isUseEnhancer() {\n+        return useEnhancer;\n+    }\n+\n+    @Override\n+    public Collection<MetadatumDTO> contributeMetadata(PlainMetadataSourceDto t) {\n+        Collection<MetadatumDTO> values = null;\n+        if (!useEnhancer) {\n+            values = super.contributeMetadata(t);\n+        } else {\n+            values = new LinkedList<>();\n+            for (PlainMetadataKeyValueItem metadatum : t.getMetadata()) {\n+                if (getKey().equals(metadatum.getKey())) {\n+                    String[] splitted = splitToRecord(metadatum.getValue());\n+                    for (String value : splitted) {\n+                        MetadatumDTO dcValue = new MetadatumDTO();\n+                        dcValue.setValue(value);\n+                        dcValue.setElement(getField().getElement());\n+                        dcValue.setQualifier(getField().getQualifier());\n+                        dcValue.setSchema(getField().getSchema());\n+                        values.add(dcValue);\n+                    }\n+                }\n+            }\n+        }\n+        return values;\n+    }\n+\n+    private String[] splitToRecord(String value) {\n+        List<String[]> rows;\n+        try (CSVReader csvReader = new CSVReader(new StringReader(value),", "originalCommit": "57ae7ee7f0a47ced61b63125814ef7d266f2a707", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1NzAyNw==", "url": "https://github.com/DSpace/DSpace/pull/2914#discussion_r469857027", "bodyText": "Yes you're right. The problem with split() method  is that it doesn't have escape. For example, using CSVReader, we could support a list of authors with a record in CSV looks like \"\\\"Surname, Name\\\",\\\"Surname2, Name2\\\"\". (in this case, escape value is double quote, and the value for this reader is \"Surname, Name\", \"Surname2, Name2\".", "author": "pasqualecvl", "createdAt": "2020-08-13T10:33:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI4MTIyNQ=="}], "type": "inlineReview"}, {"oid": "01dac23829c237ecba2e478a3f734554aa4e8da7", "url": "https://github.com/DSpace/DSpace/commit/01dac23829c237ecba2e478a3f734554aa4e8da7", "message": "Javadoc and minor changes", "committedDate": "2020-08-13T13:19:18Z", "type": "commit"}, {"oid": "9051b54259c0e3751d35d61d0f2d17d9a139058c", "url": "https://github.com/DSpace/DSpace/commit/9051b54259c0e3751d35d61d0f2d17d9a139058c", "message": "add exception to logger", "committedDate": "2020-08-13T13:23:04Z", "type": "commit"}, {"oid": "5a8311189b5dea7fbcbb00209fe8538d5705db67", "url": "https://github.com/DSpace/DSpace/commit/5a8311189b5dea7fbcbb00209fe8538d5705db67", "message": "add comments in endnote", "committedDate": "2020-08-13T13:30:47Z", "type": "commit"}, {"oid": "21a31a910bed0219013c3615e9a0d94baccdcabf", "url": "https://github.com/DSpace/DSpace/commit/21a31a910bed0219013c3615e9a0d94baccdcabf", "message": "Update tests", "committedDate": "2020-08-13T14:30:43Z", "type": "commit"}, {"oid": "55901fe1b9f8a8208f540f7ec14d1f8854dc15b5", "url": "https://github.com/DSpace/DSpace/commit/55901fe1b9f8a8208f540f7ec14d1f8854dc15b5", "message": "Use unicode in char separated files import", "committedDate": "2020-08-14T09:20:15Z", "type": "commit"}, {"oid": "42d523639331c5b02dfd6f62572b744a1156e3c6", "url": "https://github.com/DSpace/DSpace/commit/42d523639331c5b02dfd6f62572b744a1156e3c6", "message": "Add MultipleMetadataContributor to support multiple MetadataContributor\nfor each MetadataFieldConfig", "committedDate": "2020-08-27T13:49:33Z", "type": "commit"}, {"oid": "46193ff16ea6c3241db3ac5f97fe7a1375d96b40", "url": "https://github.com/DSpace/DSpace/commit/46193ff16ea6c3241db3ac5f97fe7a1375d96b40", "message": "Enable missing tests", "committedDate": "2020-08-27T14:08:21Z", "type": "commit"}, {"oid": "12d06bb59759743b9a3e4f857f4dae5697264aba", "url": "https://github.com/DSpace/DSpace/commit/12d06bb59759743b9a3e4f857f4dae5697264aba", "message": "Merge branch 'main' into D4CRIS-960", "committedDate": "2020-09-10T14:24:16Z", "type": "commit"}]}