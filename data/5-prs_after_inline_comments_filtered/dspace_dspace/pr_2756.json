{"pr_number": 2756, "pr_title": "[DS-4149] porting XOAI additional indexer", "pr_createdAt": "2020-05-05T11:42:45Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2756", "timeline": [{"oid": "541eae4d37cb9ae32acbfe0008741ab3230f1555", "url": "https://github.com/DSpace/DSpace/commit/541eae4d37cb9ae32acbfe0008741ab3230f1555", "message": "[DS-4149] porting additional indexer OAI", "committedDate": "2020-04-22T11:08:45Z", "type": "commit"}, {"oid": "5238b4a5a1deb25b9948be2dff2d69f404fed99a", "url": "https://github.com/DSpace/DSpace/commit/5238b4a5a1deb25b9948be2dff2d69f404fed99a", "message": "[DS-4149] added licenseCondition element", "committedDate": "2020-05-05T10:55:59Z", "type": "commit"}, {"oid": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "url": "https://github.com/DSpace/DSpace/commit/5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "message": "[DS-4149] resolve checkstyle violations", "committedDate": "2020-05-05T11:36:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk2MDM3Nw==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r420960377", "bodyText": "@tdonohue I would suggest a better description here, can you help me?\nwhat about: OAIItemCompile to add in the xoai document details about the Item CCLicense", "author": "abollini", "createdAt": "2020-05-06T17:21:03Z", "path": "dspace-oai/src/main/java/org/dspace/xoai/app/CCElementAdditional.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.xoai.app;\n+\n+import java.io.IOException;\n+import java.sql.SQLException;\n+import java.util.List;\n+\n+import com.lyncode.xoai.dataprovider.xml.xoai.Element;\n+import com.lyncode.xoai.dataprovider.xml.xoai.Metadata;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.content.Item;\n+import org.dspace.core.Context;\n+import org.dspace.license.CCLookup;\n+import org.dspace.license.factory.LicenseServiceFactory;\n+import org.dspace.license.service.CreativeCommonsService;\n+import org.dspace.xoai.util.ItemUtils;\n+\n+/**\n+ * Utility class to build xml element to support Creative Commons information", "originalCommit": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk2MTI3Mg==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r420961272", "bodyText": "is there a reason for this local cache? why not retrieve the CreativeCommonsService via the factory each time? or eventually, can we use autowiring?", "author": "abollini", "createdAt": "2020-05-06T17:22:29Z", "path": "dspace-oai/src/main/java/org/dspace/xoai/app/CCElementAdditional.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.xoai.app;\n+\n+import java.io.IOException;\n+import java.sql.SQLException;\n+import java.util.List;\n+\n+import com.lyncode.xoai.dataprovider.xml.xoai.Element;\n+import com.lyncode.xoai.dataprovider.xml.xoai.Metadata;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.content.Item;\n+import org.dspace.core.Context;\n+import org.dspace.license.CCLookup;\n+import org.dspace.license.factory.LicenseServiceFactory;\n+import org.dspace.license.service.CreativeCommonsService;\n+import org.dspace.xoai.util.ItemUtils;\n+\n+/**\n+ * Utility class to build xml element to support Creative Commons information\n+ *\n+ */\n+public class CCElementAdditional implements XOAIItemCompilePlugin {\n+\n+    private static Logger log = LogManager.getLogger(CCElementAdditional.class);\n+\n+    private CreativeCommonsService creativeCommonsService;\n+\n+    @Override\n+    public Metadata additionalMetadata(Context context, Metadata metadata, Item item) {\n+\n+        Element other;\n+        List<Element> elements = metadata.getElement();\n+        if (ItemUtils.getElement(elements, \"others\") != null) {\n+            other = ItemUtils.getElement(elements, \"others\");\n+        } else {\n+            other = ItemUtils.create(\"others\");\n+        }\n+        String ccLicense = null;\n+\n+        try {\n+            String licenseURL = getCreativeCommonsService().getLicenseURL(context, item);\n+            if (StringUtils.isNotBlank(licenseURL)) {\n+                CCLookup ccLookup = new CCLookup();\n+                ccLookup.issue(licenseURL);\n+                String licenseName = ccLookup.getLicenseName();\n+                ccLicense = licenseName + \"|||\" + licenseURL;\n+            }\n+        } catch (SQLException | IOException | AuthorizeException e) {\n+            log.error(e.getMessage(), e);\n+        }\n+        other.getField().add(ItemUtils.createValue(\"cc\", ccLicense));\n+        return metadata;\n+    }\n+\n+    public CreativeCommonsService getCreativeCommonsService() {\n+        if (creativeCommonsService == null) {", "originalCommit": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk2MTc1Mg==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r420961752", "bodyText": "is there a reason for this local cache? can we use autowiring?", "author": "abollini", "createdAt": "2020-05-06T17:23:16Z", "path": "dspace-oai/src/main/java/org/dspace/xoai/app/XOAI.java", "diffHunk": "@@ -698,4 +708,21 @@ private static void usage() {\n             System.out.println(\"     -h Shows this text\");\n         }\n     }\n+\n+    /**\n+     * Do any additional content on \"item.compile\" field, depends on the plugins\n+     * \n+     * @return\n+     */\n+    public List<XOAIItemCompilePlugin> getxOAIItemCompilePlugins() {\n+        if (xOAIItemCompilePlugins == null) {", "originalCommit": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk2MzQ0OQ==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r420963449", "bodyText": "javadoc is needed here.\nwhat about:\nThis method allows XOAIItemCompilePlugins to add content to the xoai document generated for the item.\nmetadata: the basic xoai representation of the item that can be manipulated by the plugin\nitem: the dspace item to index", "author": "abollini", "createdAt": "2020-05-06T17:25:46Z", "path": "dspace-oai/src/main/java/org/dspace/xoai/app/XOAIItemCompilePlugin.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.xoai.app;\n+\n+import com.lyncode.xoai.dataprovider.xml.xoai.Metadata;\n+import org.dspace.content.Item;\n+import org.dspace.core.Context;\n+\n+\n+/**\n+ * Used to enrich item.compile field description\n+ *\n+ */\n+public interface XOAIItemCompilePlugin {\n+\n+    public Metadata additionalMetadata(Context context, Metadata metadata, Item item);", "originalCommit": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcwMzM3NQ==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r428703375", "bodyText": "You can add more elements and fields to xoai, you can create a new structure for this specific need avoiding to do this kind of concatenation and further required processing to separate it.", "author": "paulo-graca", "createdAt": "2020-05-21T14:53:42Z", "path": "dspace-oai/src/main/java/org/dspace/xoai/app/CCElementAdditional.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.xoai.app;\n+\n+import java.io.IOException;\n+import java.sql.SQLException;\n+import java.util.List;\n+\n+import com.lyncode.xoai.dataprovider.xml.xoai.Element;\n+import com.lyncode.xoai.dataprovider.xml.xoai.Metadata;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.content.Item;\n+import org.dspace.core.Context;\n+import org.dspace.license.CCLookup;\n+import org.dspace.license.factory.LicenseServiceFactory;\n+import org.dspace.license.service.CreativeCommonsService;\n+import org.dspace.xoai.util.ItemUtils;\n+\n+/**\n+ * Utility class to build xml element to support Creative Commons information\n+ *\n+ */\n+public class CCElementAdditional implements XOAIItemCompilePlugin {\n+\n+    private static Logger log = LogManager.getLogger(CCElementAdditional.class);\n+\n+    private CreativeCommonsService creativeCommonsService;\n+\n+    @Override\n+    public Metadata additionalMetadata(Context context, Metadata metadata, Item item) {\n+\n+        Element other;\n+        List<Element> elements = metadata.getElement();\n+        if (ItemUtils.getElement(elements, \"others\") != null) {\n+            other = ItemUtils.getElement(elements, \"others\");\n+        } else {\n+            other = ItemUtils.create(\"others\");\n+        }\n+        String ccLicense = null;\n+\n+        try {\n+            String licenseURL = getCreativeCommonsService().getLicenseURL(context, item);\n+            if (StringUtils.isNotBlank(licenseURL)) {\n+                CCLookup ccLookup = new CCLookup();\n+                ccLookup.issue(licenseURL);\n+                String licenseName = ccLookup.getLicenseName();\n+                ccLicense = licenseName + \"|||\" + licenseURL;", "originalCommit": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE1NjU1MA==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r640156550", "bodyText": "done", "author": "abollini", "createdAt": "2021-05-26T22:10:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcwMzM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczNTAzMA==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r428735030", "bodyText": "I think the chose naming doesn't help understand what is supposed to do. Since it is supposed to add additional elements why the interface doesn't have that name? Also, if this class is the plugin, I think, for better understanding you could suffix it likewise.", "author": "paulo-graca", "createdAt": "2020-05-21T15:40:02Z", "path": "dspace-oai/src/main/java/org/dspace/xoai/app/CCElementAdditional.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.xoai.app;\n+\n+import java.io.IOException;\n+import java.sql.SQLException;\n+import java.util.List;\n+\n+import com.lyncode.xoai.dataprovider.xml.xoai.Element;\n+import com.lyncode.xoai.dataprovider.xml.xoai.Metadata;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.content.Item;\n+import org.dspace.core.Context;\n+import org.dspace.license.CCLookup;\n+import org.dspace.license.factory.LicenseServiceFactory;\n+import org.dspace.license.service.CreativeCommonsService;\n+import org.dspace.xoai.util.ItemUtils;\n+\n+/**\n+ * Utility class to build xml element to support Creative Commons information\n+ *\n+ */\n+public class CCElementAdditional implements XOAIItemCompilePlugin {", "originalCommit": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE1NjU5Mw==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r640156593", "bodyText": "done", "author": "abollini", "createdAt": "2021-05-26T22:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczNTAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2NjU1MA==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r428766550", "bodyText": "As referred this name is confusing to me. Perhaps with a more detailed description I can help you find a better name.", "author": "paulo-graca", "createdAt": "2020-05-21T16:26:53Z", "path": "dspace-oai/src/main/java/org/dspace/xoai/app/XOAIItemCompilePlugin.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.xoai.app;\n+\n+import com.lyncode.xoai.dataprovider.xml.xoai.Metadata;\n+import org.dspace.content.Item;\n+import org.dspace.core.Context;\n+\n+\n+/**\n+ * Used to enrich item.compile field description\n+ *\n+ */\n+public interface XOAIItemCompilePlugin {", "originalCommit": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE1NjM2OA==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r640156368", "bodyText": "done", "author": "abollini", "createdAt": "2021-05-26T22:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2NjU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3ODEwOQ==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r428778109", "bodyText": "The camel for XOAI abreviation looks weird here xOAIItemCompilePlugin I would prefer to have xoaiItemCompilePlugin.\nBut as referred I'm also not in love with this name since It's not clear to me what it is. Could you call it xoaiExtensionPlugin  or xoaiAdditionalElementPlugin. I have some difficulty in proposing better names. I would need to better understand what the interface helps doing.", "author": "paulo-graca", "createdAt": "2020-05-21T16:46:44Z", "path": "dspace-oai/src/main/java/org/dspace/xoai/app/XOAI.java", "diffHunk": "@@ -455,7 +458,14 @@ private SolrInputDocument index(Item item)\n \n         ByteArrayOutputStream out = new ByteArrayOutputStream();\n         XmlOutputContext xmlContext = XmlOutputContext.emptyContext(out, Second);\n-        retrieveMetadata(context, item).write(xmlContext);\n+        Metadata metadata = retrieveMetadata(context, item);\n+\n+        // Do any additional metadata element, depends on the plugins\n+        for (XOAIItemCompilePlugin xOAIItemCompilePlugin : getxOAIItemCompilePlugins()) {\n+            metadata = xOAIItemCompilePlugin.additionalMetadata(context, metadata, item);", "originalCommit": "5dd25b1c0b74a4d91363b5d93431e73e3a8ebf51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE1NjQ2MQ==", "url": "https://github.com/DSpace/DSpace/pull/2756#discussion_r640156461", "bodyText": "done", "author": "abollini", "createdAt": "2021-05-26T22:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3ODEwOQ=="}], "type": "inlineReview"}, {"oid": "2d2a4a77b2ac250b7869088f3ec079b48b71e45a", "url": "https://github.com/DSpace/DSpace/commit/2d2a4a77b2ac250b7869088f3ec079b48b71e45a", "message": "Merge branch 'main' of https://github.com/DSpace/DSpace into DS-4149_7-x", "committedDate": "2021-05-26T16:19:49Z", "type": "commit"}, {"oid": "abe4e6996a1e00853ed723be014ce6a002468225", "url": "https://github.com/DSpace/DSpace/commit/abe4e6996a1e00853ed723be014ce6a002468225", "message": "cleanup the generation of the oaire:licenseCondition element", "committedDate": "2021-05-26T17:25:35Z", "type": "commit"}, {"oid": "0ad13bdf5fc48416de4e2ed44f7e3b654396f853", "url": "https://github.com/DSpace/DSpace/commit/0ad13bdf5fc48416de4e2ed44f7e3b654396f853", "message": "Fix plugins retrieval and bitstreams url link (issue - 3284)", "committedDate": "2021-05-26T22:08:09Z", "type": "commit"}]}