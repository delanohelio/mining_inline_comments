{"pr_number": 293, "pr_title": "[0.10] Add JSON pointer, patch, and OpenAPI mapper", "pr_createdAt": "2020-02-26T21:12:53Z", "pr_url": "https://github.com/awslabs/smithy/pull/293", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyOTE2MQ==", "url": "https://github.com/awslabs/smithy/pull/293#discussion_r385829161", "bodyText": "s/add/at", "author": "kstich", "createdAt": "2020-02-28T17:35:51Z", "path": "smithy-jsonschema/src/main/java/software/amazon/smithy/jsonschema/SchemaDocument.java", "diffHunk": "@@ -182,46 +146,37 @@ public Schema getRootSchema() {\n      * @return Returns the optionally found schema definition.\n      */\n     public Optional<Schema> getDefinition(String pointer) {\n-        pointer = unescapeJsonSchema(pointer);\n+        String unescaped = NodePointer.unescape(pointer);\n \n-        if (definitions.containsKey(pointer)) {\n-            return Optional.ofNullable(definitions.get(pointer));\n-        } else if (pointer.isEmpty()) {\n-            return Optional.of(getRootSchema());\n+        // Attempt to get the unescaped pointer, as-is.\n+        if (definitions.containsKey(unescaped)) {\n+            return Optional.ofNullable(definitions.get(unescaped));\n         }\n \n-        String prefix = \"\";\n-        String[] refs = pointer.split(\"/\");\n+        List<String> pointerParts = NodePointer.parse(pointer).getParts();\n \n-        for (int position = 0; position < refs.length; position++) {\n-            if (position > 0) {\n-                prefix += \"/\" + refs[position];\n-            } else {\n-                prefix += refs[position];\n-            }\n+        // An empty pointer returns the root schema.\n+        if (pointerParts.isEmpty()) {\n+            return Optional.of(getRootSchema());\n+        }\n+\n+        // Compute the part of the pointer that points add a literal entry in", "originalCommit": "d3479e074f0e946fb6fbf599a9e8ffa28bdaddc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "08c0cd9f33575fe42b9f59f262c1a2aed8879547", "url": "https://github.com/awslabs/smithy/commit/08c0cd9f33575fe42b9f59f262c1a2aed8879547", "message": "Add JSON pointer, patch, and OpenAPI mapper\n\nThis commit adds a new mapper to OpenAPI that allows changing specific\nparts of the generated schema using JSON pointers that inject values\nusing semantics similar to JSON Patch. This approach is preferred over\nstring substitutions because it is more explicit and does not encourage\nmodelers to include placeholders in their models.\n\nThe JSON substitutions mapper now allows for any string to be replaced.\nThis is still basically just as safe since it only replaces exact string\nmatches (it doesn't replace inside of larger strings). Most importantly,\nthe use of placeholder like strings encouraged modelers to include\nplaceholders in their models. By opening up the string to any value, you\ncan now replace whatever was generated from real model values.\n\nTo achieve this, I implemented a JSON Pointer parser and abstraction\nover Node values that also include methods for getting a value from a\nnode by a pointer, and adding/replacing a value in a node using a\npointer (with immutable return values, of course). I was able to\nintegrate this abstraction into SchemaDocument and Schema too. The JSON\nPatch \"add\" operation has been implemented in two ways: 1) we do it just\nlike JSON patch, where attempting to traverse through missing objects\nand arrays causes the change to be ignored 2) we have a mode that\ncreates intermediate objects when needed, allowing this to be used in\nthe JSON Schema SchemaDocument code for generating JSON from an\nin-memory document.\n\nImplementing this change revealed an omission in ArrayNode where bounds\nwere not being checked. For example, attempting to access index -1 would\nraise an exception. This is now fixed and covered in a test case.", "committedDate": "2020-02-28T18:08:40Z", "type": "forcePushed"}, {"oid": "08c0cd9f33575fe42b9f59f262c1a2aed8879547", "url": "https://github.com/awslabs/smithy/commit/08c0cd9f33575fe42b9f59f262c1a2aed8879547", "message": "Add JSON pointer, patch, and OpenAPI mapper\n\nThis commit adds a new mapper to OpenAPI that allows changing specific\nparts of the generated schema using JSON pointers that inject values\nusing semantics similar to JSON Patch. This approach is preferred over\nstring substitutions because it is more explicit and does not encourage\nmodelers to include placeholders in their models.\n\nThe JSON substitutions mapper now allows for any string to be replaced.\nThis is still basically just as safe since it only replaces exact string\nmatches (it doesn't replace inside of larger strings). Most importantly,\nthe use of placeholder like strings encouraged modelers to include\nplaceholders in their models. By opening up the string to any value, you\ncan now replace whatever was generated from real model values.\n\nTo achieve this, I implemented a JSON Pointer parser and abstraction\nover Node values that also include methods for getting a value from a\nnode by a pointer, and adding/replacing a value in a node using a\npointer (with immutable return values, of course). I was able to\nintegrate this abstraction into SchemaDocument and Schema too. The JSON\nPatch \"add\" operation has been implemented in two ways: 1) we do it just\nlike JSON patch, where attempting to traverse through missing objects\nand arrays causes the change to be ignored 2) we have a mode that\ncreates intermediate objects when needed, allowing this to be used in\nthe JSON Schema SchemaDocument code for generating JSON from an\nin-memory document.\n\nImplementing this change revealed an omission in ArrayNode where bounds\nwere not being checked. For example, attempting to access index -1 would\nraise an exception. This is now fixed and covered in a test case.", "committedDate": "2020-02-28T18:08:40Z", "type": "commit"}]}