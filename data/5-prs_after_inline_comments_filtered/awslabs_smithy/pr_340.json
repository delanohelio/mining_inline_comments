{"pr_number": 340, "pr_title": "[0.10] Apply streaming trait directly to shapes", "pr_createdAt": "2020-03-31T23:08:48Z", "pr_url": "https://github.com/awslabs/smithy/pull/340", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4NjA4MA==", "url": "https://github.com/awslabs/smithy/pull/340#discussion_r401286080", "bodyText": "I think breaking this into two methods would make this validator easier to understand -- one method validates that the target is correct and the other that only a single member of a structure can target a streaming blob.", "author": "mtdowling", "createdAt": "2020-04-01T00:13:30Z", "path": "smithy-model/src/main/java/software/amazon/smithy/model/validation/validators/StreamingTraitValidator.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.smithy.model.validation.validators;\n+\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import software.amazon.smithy.model.Model;\n+import software.amazon.smithy.model.shapes.MemberShape;\n+import software.amazon.smithy.model.shapes.OperationShape;\n+import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.model.traits.StreamingTrait;\n+import software.amazon.smithy.model.validation.AbstractValidator;\n+import software.amazon.smithy.model.validation.ValidationEvent;\n+import software.amazon.smithy.utils.OptionalUtils;\n+import software.amazon.smithy.utils.SetUtils;\n+\n+public class StreamingTraitValidator extends AbstractValidator {\n+    @Override\n+    public List<ValidationEvent> validate(Model model) {\n+        Set<ShapeId> topLevelIoShapes = model.shapes(OperationShape.class)\n+                .flatMap(operation -> SetUtils.of(operation.getInput(), operation.getOutput()).stream())\n+                .flatMap(OptionalUtils::stream)\n+                .collect(Collectors.toSet());\n+\n+        Set<MemberShape> streamingMembers = model.shapes(MemberShape.class)\n+                .filter(member -> member.getMemberTrait(model, StreamingTrait.class).isPresent())\n+                .collect(Collectors.toSet());\n+\n+        List<ValidationEvent> events = streamingMembers.stream()", "originalCommit": "0769478f3c6811e7ec6eae3b3cbaeb18c1831081", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4NjU2MQ==", "url": "https://github.com/awslabs/smithy/pull/340#discussion_r401286561", "bodyText": "This one-liner is pretty tricky and even plays with indentation in a non-standard way. It make make this more readable to break this across multiple lines.", "author": "mtdowling", "createdAt": "2020-04-01T00:15:04Z", "path": "smithy-model/src/main/java/software/amazon/smithy/model/validation/validators/StreamingTraitValidator.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.smithy.model.validation.validators;\n+\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import software.amazon.smithy.model.Model;\n+import software.amazon.smithy.model.shapes.MemberShape;\n+import software.amazon.smithy.model.shapes.OperationShape;\n+import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.model.traits.StreamingTrait;\n+import software.amazon.smithy.model.validation.AbstractValidator;\n+import software.amazon.smithy.model.validation.ValidationEvent;\n+import software.amazon.smithy.utils.OptionalUtils;\n+import software.amazon.smithy.utils.SetUtils;\n+\n+public class StreamingTraitValidator extends AbstractValidator {\n+    @Override\n+    public List<ValidationEvent> validate(Model model) {\n+        Set<ShapeId> topLevelIoShapes = model.shapes(OperationShape.class)\n+                .flatMap(operation -> SetUtils.of(operation.getInput(), operation.getOutput()).stream())\n+                .flatMap(OptionalUtils::stream)\n+                .collect(Collectors.toSet());\n+\n+        Set<MemberShape> streamingMembers = model.shapes(MemberShape.class)\n+                .filter(member -> member.getMemberTrait(model, StreamingTrait.class).isPresent())\n+                .collect(Collectors.toSet());\n+\n+        List<ValidationEvent> events = streamingMembers.stream()\n+                .filter(member -> !topLevelIoShapes.contains(member.getContainer()))\n+                .map(member -> error(member, String.format(\n+                        \"The shape %s has the smithy.api#streaming trait, and so may only be targeted by \"\n+                                + \"top-level operation inputs and outputs.\",\n+                        member.getTarget())))\n+                .collect(Collectors.toList());\n+\n+        events.addAll(streamingMembers.stream()", "originalCommit": "0769478f3c6811e7ec6eae3b3cbaeb18c1831081", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "32403cd3e4c929627b467c2590d8815459c5ce33", "url": "https://github.com/awslabs/smithy/commit/32403cd3e4c929627b467c2590d8815459c5ce33", "message": "Apply streaming trait directly to shapes\n\nThis updates the streaming trait to apply directly to shapes instead of\nmembers. This was previously restricted to members because it made the\nmodel easier to validate and grok at a glance. However, keeping it on\nmembers introduces potential errors in code generation. A given blob\ncould have both the streaming trait and the media type trait, for\ninstance. Both of these traits could result in a new type being created,\nbut since the streaming trait is applied to a member that type is\nimplicit. The code generator would have to try to generate a name that\ndoesn't conflict with any existing names, which is very error prone and\nlikely would result in unfortunate names. Moving this trait to the\nshape directly makes the naming concern an explicit part of modeling,\nwhere it will only have to be handled once.\n\nThis also brings the trait in line with the general best practice of\nhaving traits that impact the type generated apply directly to the\nshapes they impact.", "committedDate": "2020-04-02T21:21:57Z", "type": "commit"}, {"oid": "32403cd3e4c929627b467c2590d8815459c5ce33", "url": "https://github.com/awslabs/smithy/commit/32403cd3e4c929627b467c2590d8815459c5ce33", "message": "Apply streaming trait directly to shapes\n\nThis updates the streaming trait to apply directly to shapes instead of\nmembers. This was previously restricted to members because it made the\nmodel easier to validate and grok at a glance. However, keeping it on\nmembers introduces potential errors in code generation. A given blob\ncould have both the streaming trait and the media type trait, for\ninstance. Both of these traits could result in a new type being created,\nbut since the streaming trait is applied to a member that type is\nimplicit. The code generator would have to try to generate a name that\ndoesn't conflict with any existing names, which is very error prone and\nlikely would result in unfortunate names. Moving this trait to the\nshape directly makes the naming concern an explicit part of modeling,\nwhere it will only have to be handled once.\n\nThis also brings the trait in line with the general best practice of\nhaving traits that impact the type generated apply directly to the\nshapes they impact.", "committedDate": "2020-04-02T21:21:57Z", "type": "forcePushed"}]}