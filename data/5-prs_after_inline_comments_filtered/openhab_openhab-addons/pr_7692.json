{"pr_number": 7692, "pr_title": "[openweathermap] bridge / thing handling", "pr_createdAt": "2020-05-18T21:52:54Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7692", "timeline": [{"oid": "52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc", "url": "https://github.com/openhab/openhab-addons/commit/52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc", "message": "[openweathermap] bridge / thing handling\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-05-18T21:49:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NDcyNg==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r426974726", "bodyText": "You should eliminate the requirement for subclasses to have to call super and then exit early. Instead you should just move all the  AbstractOpenWeatherMapHandler.initializeThing logic into AbstractOpenWeatherMapHandler.initialize, make AbstractOpenWeatherMapHandler.initializeThing abstract and only call initializeThing when bridgeHandler != null && bridgeStatus == ThingStatus.ONLINE.", "author": "cpmeister", "createdAt": "2020-05-19T01:13:28Z", "path": "bundles/org.openhab.binding.openweathermap/src/main/java/org/openhab/binding/openweathermap/internal/handler/OpenWeatherMapWeatherAndForecastHandler.java", "diffHunk": "@@ -82,8 +83,11 @@ public OpenWeatherMapWeatherAndForecastHandler(Thing thing) {\n     }\n \n     @Override\n-    public void initialize() {\n-        super.initialize();\n+    protected void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n+        super.initializeThing(bridgeHandler, bridgeStatus);\n+        if (bridgeHandler == null || bridgeStatus != ThingStatus.ONLINE) {\n+            return;\n+        }", "originalCommit": "52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA1NjU5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427056593", "bodyText": "I see what you mean and you're right. I am going to improve that.", "author": "lolodomo", "createdAt": "2020-05-19T06:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NDcyNg=="}], "type": "inlineReview"}, {"oid": "2a1a3b5dedcc78730e44987a6f46f4d685a8957f", "url": "https://github.com/openhab/openhab-addons/commit/2a1a3b5dedcc78730e44987a6f46f4d685a8957f", "message": "Create an abstract method\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-05-19T06:38:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427487106", "bodyText": "Since bridge.getStatus() should reflect the most recently changed status. It should be possible to refactor the logic from bridgeStatusChanged and initialize into initializeThing. Of course we would have to change the name here to avoid naming conflicts with our abstract method.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n          \n          \n            \n                    if (bridgeHandler != null && bridgeStatus != null) {\n          \n          \n            \n                private void initializeThingInternal() {\n          \n          \n            \n                    Bridge bridge = getBridge();\n          \n          \n            \n                    ThingHandler bridgeHandler = bridge != null ? bridge.getHandler() : null;\n          \n          \n            \n                    ThingStatus bridgeStatus = bridge != null ? bridge.getStatus() : null;\n          \n          \n            \n                    if (bridgeHandler != null && bridgeStatus != null) {", "author": "cpmeister", "createdAt": "2020-05-19T17:47:18Z", "path": "bundles/org.openhab.binding.openweathermap/src/main/java/org/openhab/binding/openweathermap/internal/handler/AbstractOpenWeatherMapHandler.java", "diffHunk": "@@ -82,29 +84,50 @@ public AbstractOpenWeatherMapHandler(Thing thing) {\n \n     @Override\n     public void initialize() {\n-        OpenWeatherMapLocationConfiguration config = getConfigAs(OpenWeatherMapLocationConfiguration.class);\n-\n-        boolean configValid = true;\n-        if (StringUtils.trimToNull(config.getLocation()) == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    \"@text/offline.conf-error-missing-location\");\n-            configValid = false;\n+        logger.debug(\"initializing handler for thing {}\", getThing().getUID());\n+        Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            initializeThing(null, null);\n+        } else {\n+            initializeThing(bridge.getHandler(), bridge.getStatus());\n         }\n+    }\n \n-        try {\n-            location = new PointType(config.getLocation());\n-        } catch (IllegalArgumentException e) {\n-            location = null;\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    \"@text/offline.conf-error-parsing-location\");\n-            configValid = false;\n-        }\n+    private void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n+        if (bridgeHandler != null && bridgeStatus != null) {", "originalCommit": "2a1a3b5dedcc78730e44987a6f46f4d685a8957f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyMDkyMA==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427520920", "bodyText": "In this case, you don't use at all the value provided as parameter toi bridgeStatusChanged.\nI don't know how big is the risk to do that.\nBut why would have been provided the bridge status as parameter if it is useless ?", "author": "lolodomo", "createdAt": "2020-05-19T18:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3MDM2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427570363", "bodyText": "The super implementation of bridgeStatusChanged uses that bridge status param just fine. But it doesn't take into account the bridge becoming null like your new code is doing.\nAs will all event handling, sometimes the event handler doesn't care about the event that is getting handled, only that something happened. This is often the case with refresh handlers which don't care what kind of event took place and thus would ignore the event parameter in its handler method.", "author": "cpmeister", "createdAt": "2020-05-19T20:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTAxNg==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427581016", "bodyText": "This is not the usual pattern I have found in different bindings.\nWe could at least provide the bridgeStatus as parameter to the common internal method ?", "author": "lolodomo", "createdAt": "2020-05-19T20:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg=="}], "type": "inlineReview"}, {"oid": "f87846b1d94ce803d20e5cf91e521731c4eeef34", "url": "https://github.com/openhab/openhab-addons/commit/f87846b1d94ce803d20e5cf91e521731c4eeef34", "message": "Only bridgeStatus as parameter for method initializeThing\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-05-19T20:58:46Z", "type": "commit"}]}