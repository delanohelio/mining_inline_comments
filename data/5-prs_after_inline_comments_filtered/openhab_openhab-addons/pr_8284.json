{"pr_number": 8284, "pr_title": "[lcn] Add support for commands from LCN to openHAB", "pr_createdAt": "2020-08-13T09:44:08Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8284", "timeline": [{"oid": "71b1b7ce504efe97a0d5adb32f94509d4390e6fc", "url": "https://github.com/openhab/openhab-addons/commit/71b1b7ce504efe97a0d5adb32f94509d4390e6fc", "message": "[lcn] Add support for commands from LCN to openHAB\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-08-13T09:30:12Z", "type": "commit"}, {"oid": "2900c25a1b04b548261bb13ec93d94fc9d3466d6", "url": "https://github.com/openhab/openhab-addons/commit/2900c25a1b04b548261bb13ec93d94fc9d3466d6", "message": "Add options tag for sendKeys Channel\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-08-27T08:16:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY3MjExMw==", "url": "https://github.com/openhab/openhab-addons/pull/8284#discussion_r479672113", "bodyText": "It looks lik the code depends on the ordering in the enum, which is dangerous. Maybe add an int to the enum. Or in some other way store the range used here in some variable.", "author": "Hilbrand", "createdAt": "2020-08-29T17:36:18Z", "path": "bundles/org.openhab.binding.lcn/src/main/java/org/openhab/binding/lcn/internal/subhandler/LcnModuleHostCommandSubHandler.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.lcn.internal.subhandler;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.lcn.internal.LcnModuleHandler;\n+import org.openhab.binding.lcn.internal.common.LcnChannelGroup;\n+import org.openhab.binding.lcn.internal.common.LcnDefs;\n+import org.openhab.binding.lcn.internal.common.LcnException;\n+import org.openhab.binding.lcn.internal.connection.ModInfo;\n+\n+/**\n+ * Handles 'send key' commands sent to this PCK host.\n+ *\n+ * @author Fabian Wolter - Initial contribution\n+ */\n+@NonNullByDefault\n+public class LcnModuleHostCommandSubHandler extends AbstractLcnModuleSubHandler {\n+    private static final Pattern SEND_KEY_PATTERN = Pattern\n+            .compile(\"\\\\+M(?<hostId>\\\\d{3})(?<segId>\\\\d{3})(?<modId>\\\\d{3})\\\\.STH(?<byte0>\\\\d{3})(?<byte1>\\\\d{3})\");\n+\n+    public LcnModuleHostCommandSubHandler(LcnModuleHandler handler, ModInfo info) {\n+        super(handler, info);\n+    }\n+\n+    @Override\n+    public void handleRefresh(LcnChannelGroup channelGroup, int number) {\n+        // nothing\n+    }\n+\n+    @Override\n+    public void handleStatusMessage(Matcher matcher) throws LcnException {\n+        int keyTableAndActionMask = Integer.parseInt(matcher.group(\"byte0\"));\n+        int keyNumberMask = Integer.parseInt(matcher.group(\"byte1\"));\n+\n+        if ((keyTableAndActionMask & (1 << 6)) == 0) {\n+            return;\n+        }\n+\n+        // PCHK 3.22 supports only the old 'send key' command with key tables A-C\n+        for (int keyTableNumber = 0; keyTableNumber < LcnDefs.KEY_TABLE_COUNT_UNTIL_0C030C0; keyTableNumber++) {\n+            String keyTableName = LcnDefs.KeyTable.values()[keyTableNumber].name();\n+\n+            for (int keyNumber = 0; keyNumber < LcnDefs.KEY_COUNT; keyNumber++) {\n+                int actionRaw = (keyTableAndActionMask >> (keyTableNumber * 2)) & 3;\n+\n+                if (actionRaw > LcnDefs.SendKeyCommand.DONTSEND.ordinal()", "originalCommit": "2900c25a1b04b548261bb13ec93d94fc9d3466d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY3MjM4Nw==", "url": "https://github.com/openhab/openhab-addons/pull/8284#discussion_r479672387", "bodyText": "L is very easily mixed with 1. Maybe use a different, longer name.", "author": "Hilbrand", "createdAt": "2020-08-29T17:39:30Z", "path": "bundles/org.openhab.binding.lcn/src/test/java/org/openhab/binding/lcn/internal/subhandler/LcnModuleHostCommandSubHandlerTest.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.lcn.internal.subhandler;\n+\n+import static org.mockito.Mockito.verify;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.openhab.binding.lcn.internal.common.LcnChannelGroup;\n+\n+/**\n+ * Test class.\n+ *\n+ * @author Fabian Wolter - Initial contribution\n+ */\n+@NonNullByDefault\n+public class LcnModuleHostCommandSubHandlerTest extends AbstractTestLcnModuleSubHandler {\n+    private @NonNullByDefault({}) LcnModuleHostCommandSubHandler l;", "originalCommit": "2900c25a1b04b548261bb13ec93d94fc9d3466d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "00d41435cb02934f7b03057edbba81c32423e690", "url": "https://github.com/openhab/openhab-addons/commit/00d41435cb02934f7b03057edbba81c32423e690", "message": "Add ID to enum and change field name\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-08-30T18:21:21Z", "type": "commit"}]}