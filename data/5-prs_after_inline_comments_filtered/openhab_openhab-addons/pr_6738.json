{"pr_number": 6738, "pr_title": "[mqtt.generic] Allow availabilty topic for generic components", "pr_createdAt": "2020-01-01T18:52:44Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6738", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc0OTIxNg==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362749216", "bodyText": "This is a whitespace only change. Is the ESH formatter in use?", "author": "davidgraeff", "createdAt": "2020-01-03T09:37:30Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/internal/handler/GenericMQTTThingHandler.java", "diffHunk": "@@ -100,14 +100,15 @@ public void dispose() {\n         // Remove all state descriptions of this handler\n         channelStateByChannelUID.forEach((uid, state) -> stateDescProvider.remove(uid));\n         super.dispose();\n-        // there is a design flaw, we can't clean up our stuff because it is needed by the super-class on disposal for unsubscribing\n+        // there is a design flaw, we can't clean up our stuff because it is needed by the super-class on disposal for\n+        // unsubscribing\n         channelStateByChannelUID.clear();\n     }\n \n     @Override\n     public CompletableFuture<Void> unsubscribeAll() {\n-        return CompletableFuture.allOf(channelStateByChannelUID.values().stream().map(ChannelState::stop)\n-                .toArray(CompletableFuture[]::new));\n+        return CompletableFuture.allOf(\n+                channelStateByChannelUID.values().stream().map(ChannelState::stop).toArray(CompletableFuture[]::new));", "originalCommit": "43e607b9600aaa3bc6d10ce62e07e45c7be0ed62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1ODA1Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362858057", "bodyText": "Yes, I tried with all ESH formatter, openHAB formatter (https://www.openhab.org/docs/developer/guidelines.html#java-code) and mvn spotless:apply.\nThey all give me this result.\nI now ran mvn spotless:apply on the project. There are some more WS-only changes...", "author": "jochen314", "createdAt": "2020-01-03T15:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc0OTIxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MDcxMw==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362750713", "bodyText": "I'm not sure if I like the class name. Could be generic thing config, generic binding config and so on. A better name is probably GenericThingConfiguration.", "author": "davidgraeff", "createdAt": "2020-01-03T09:42:39Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/internal/handler/GenericConfiguration.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.mqtt.generic.internal.handler;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+\n+/**\n+ * The {@link GenericMQTTThingHandler} manages Things that are responsible for MQTT components.\n+ * This class contains the necessary configuration for such a Thing handler.\n+ *\n+ * @author Jochen Klein - Initial contribution\n+ */\n+@NonNullByDefault\n+public class GenericConfiguration {", "originalCommit": "43e607b9600aaa3bc6d10ce62e07e45c7be0ed62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MTU3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362751573", "bodyText": "If the correct logic behaviour is covered by tests, I strongly recommend not to log anything. updateThingStatus will already notify the framework and log the new thing status, why add log pressure here as well.", "author": "davidgraeff", "createdAt": "2020-01-03T09:45:55Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/AbstractMQTTThingHandler.java", "diffHunk": "@@ -262,4 +304,73 @@ public void postChannelCommand(ChannelUID channelUID, Command command) {\n     public void setConnection(MqttBrokerConnection connection) {\n         this.connection = connection;\n     }\n+\n+    @Override\n+    public void addAvailabilityTopic(String availability_topic, String payload_available,\n+            String payload_not_available) {\n+        availabilityStates.computeIfAbsent(availability_topic, topic -> {\n+            Value value = new OnOffValue(payload_available, payload_not_available);\n+            ChannelGroupUID groupUID = new ChannelGroupUID(getThing().getUID(), \"availablility\");\n+            ChannelUID channelUID = new ChannelUID(groupUID, UIDUtils.encode(topic));\n+            ChannelState state = new ChannelState(ChannelConfigBuilder.create().withStateTopic(topic).build(),\n+                    channelUID, value, new ChannelStateUpdateListener() {\n+                        @Override\n+                        public void updateChannelState(ChannelUID channelUID, State value) {\n+                            calculateThingStatus();\n+                        }\n+\n+                        @Override\n+                        public void triggerChannel(ChannelUID channelUID, String eventPayload) {\n+                        }\n+\n+                        @Override\n+                        public void postChannelCommand(ChannelUID channelUID, Command value) {\n+                        }\n+                    });\n+            MqttBrokerConnection connection = getConnection();\n+            if (connection != null) {\n+                state.start(connection, scheduler, 0);\n+            }\n+\n+            return state;\n+        });\n+    }\n+\n+    @Override\n+    public void removeAvailabilityTopic(@NonNull String availability_topic) {\n+        availabilityStates.computeIfPresent(availability_topic, (topic, state) -> {\n+            if (connection != null && state != null) {\n+                state.stop();\n+            }\n+            return null;\n+        });\n+    }\n+\n+    @Override\n+    public void clearAllAvailabilityTopics() {\n+        Set<String> topics = new HashSet<>(availabilityStates.keySet());\n+        topics.forEach(t -> removeAvailabilityTopic(t));\n+    }\n+\n+    @Override\n+    public void resetMessageReceived() {\n+        if (messageReceived.getAndSet(false)) {\n+            calculateThingStatus();\n+        }\n+    }\n+\n+    protected void calculateThingStatus() {\n+        final boolean availabilityTopicsSeen;\n+\n+        if (availabilityStates.isEmpty()) {\n+            availabilityTopicsSeen = true;\n+        } else {\n+            availabilityTopicsSeen = availabilityStates.values().stream().allMatch(\n+                    c -> c != null && OnOffType.ON.equals(c.getCache().getChannelState().as(OnOffType.class)));\n+        }\n+        logger.debug(\"thing status {} {} {}\", getThing().getUID(), messageReceived.get(), availabilityTopicsSeen);", "originalCommit": "43e607b9600aaa3bc6d10ce62e07e45c7be0ed62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjgxNTQwMg==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362815402", "bodyText": "just that this updateThingStatus is not calling the framwork directly, but an abstract method, which determins the status. I might ignore one or the other parameter.\nI was for me, well, a debuging help....\nBut I can remove it...", "author": "jochen314", "createdAt": "2020-01-03T13:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MTU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MjIzNw==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362752237", "bodyText": "updateChannelState is called frequently (hot path). This statement will access an atomic variable, which requires cpu cores to ensure cache coherence (expensive!). Is it absolutely necessary to access this variable on each channel state update?", "author": "davidgraeff", "createdAt": "2020-01-03T09:48:14Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/AbstractMQTTThingHandler.java", "diffHunk": "@@ -237,11 +273,17 @@ public void dispose() {\n \n     @Override\n     public void updateChannelState(ChannelUID channelUID, State value) {\n+        if (!messageReceived.getAndSet(true)) {", "originalCommit": "43e607b9600aaa3bc6d10ce62e07e45c7be0ed62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjgxNDMzMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362814331", "bodyText": "Well, we need to keep track, if messages were received (at least for some HA components) to be able to set the thing status.\nWould it be better to schedule this check in another thread?", "author": "jochen314", "createdAt": "2020-01-03T13:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MjIzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkwODQ3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362908479", "bodyText": "At the moment every mqtt Thing or to be more precise every mqtt thing channel pays this cost though and it is not even used at all times, that's my issue with this code.\nScheduling a thread here would be even more costly. I don't have an idea yet.", "author": "davidgraeff", "createdAt": "2020-01-03T18:16:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MjIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MjYwOA==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362752608", "bodyText": "Why \"@nullable\"? Wouldn't it be more easy to make this non nullable?", "author": "davidgraeff", "createdAt": "2020-01-03T09:49:34Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/AbstractMQTTThingHandler.java", "diffHunk": "@@ -61,13 +75,17 @@\n  * @author David Graeff - Initial contribution\n  */\n @NonNullByDefault\n-public abstract class AbstractMQTTThingHandler extends BaseThingHandler implements ChannelStateUpdateListener {\n+public abstract class AbstractMQTTThingHandler extends BaseThingHandler\n+        implements ChannelStateUpdateListener, AvailabilityTracker {\n     private final Logger logger = LoggerFactory.getLogger(AbstractMQTTThingHandler.class);\n     // Timeout for the entire tree parsing and subscription\n     private final int subscribeTimeout;\n \n     protected @Nullable MqttBrokerConnection connection;\n \n+    private AtomicBoolean messageReceived = new AtomicBoolean(false);\n+    private Map<String, @Nullable ChannelState> availabilityStates = new ConcurrentHashMap<>();", "originalCommit": "43e607b9600aaa3bc6d10ce62e07e45c7be0ed62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjgxNzM3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r362817379", "bodyText": "I have 2 problems with Map if the value is @NonNull:\n\nMap.get() is assumed to be @NonNull, which is wrong. So I get warnings when doing a null check. And I do not like doing a contains() first, because that would double the compution time.\nMap.computeIfPresent() will not allow we to return null to remove the element. But this is the best way to do it in an atomic matter. (ConcurrentHashMap does not allow null as key or value)\n\n(edit: Formatting)", "author": "jochen314", "createdAt": "2020-01-03T13:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MjYwOA=="}], "type": "inlineReview"}, {"oid": "d8fbf2df5b14612a4eaa8527f60c0fe23bb77202", "url": "https://github.com/openhab/openhab-addons/commit/d8fbf2df5b14612a4eaa8527f60c0fe23bb77202", "message": "lwt for generic components\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-01-18T18:30:44Z", "type": "commit"}, {"oid": "d8fbf2df5b14612a4eaa8527f60c0fe23bb77202", "url": "https://github.com/openhab/openhab-addons/commit/d8fbf2df5b14612a4eaa8527f60c0fe23bb77202", "message": "lwt for generic components\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-01-18T18:30:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0NTE1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r377745152", "bodyText": "return CompletableFuture.allOf(futures.toArray(new CompletableFuture[futures.size()])).thenRun(this::calculateThingStatus);", "author": "J-N-K", "createdAt": "2020-02-11T16:23:55Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/internal/handler/GenericMQTTThingHandler.java", "diffHunk": "@@ -86,7 +86,7 @@ public GenericMQTTThingHandler(Thing thing, MqttChannelStateDescriptionProvider\n         List<CompletableFuture<@Nullable Void>> futures = channelStateByChannelUID.values().stream()\n                 .map(c -> c.start(connection, scheduler, 0)).collect(Collectors.toList());\n         return CompletableFuture.allOf(futures.toArray(new CompletableFuture[futures.size()])).thenRun(() -> {\n-            updateStatus(ThingStatus.ONLINE, ThingStatusDetail.NONE);\n+            calculateThingStatus();", "originalCommit": "d8fbf2df5b14612a4eaa8527f60c0fe23bb77202", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1MDA2NA==", "url": "https://github.com/openhab/openhab-addons/pull/6738#discussion_r377750064", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return channels.values().parallelStream().map(v -> v.stop()).collect(FutureCollector.allOf());\n          \n          \n            \n                    return channels.values().parallelStream().map(CChannel::stop).collect(FutureCollector.allOf());", "author": "J-N-K", "createdAt": "2020-02-11T16:31:25Z", "path": "bundles/org.openhab.binding.mqtt.homeassistant/src/main/java/org/openhab/binding/mqtt/homeassistant/internal/AbstractComponent.java", "diffHunk": "@@ -150,13 +122,7 @@ public boolean isActive() {\n      *         exceptionally on errors.\n      */\n     public CompletableFuture<@Nullable Void> stop() {\n-        CompletableFuture<@Nullable Void> all = channels.values().parallelStream().map(v -> v.stop())\n-                .collect(FutureCollector.allOf());\n-\n-        if (availablityChannel != null) {\n-            all = all.thenCompose(v -> availablityChannel.stop());\n-        }\n-        return all;\n+        return channels.values().parallelStream().map(v -> v.stop()).collect(FutureCollector.allOf());", "originalCommit": "d8fbf2df5b14612a4eaa8527f60c0fe23bb77202", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5d793c04495aa9e1fc7db7d32155a2bd6fb44dce", "url": "https://github.com/openhab/openhab-addons/commit/5d793c04495aa9e1fc7db7d32155a2bd6fb44dce", "message": "fix feature.xml formatting\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-02-11T22:10:08Z", "type": "commit"}, {"oid": "352402a8032d4d5c1f93901d10ce339ecf513ae1", "url": "https://github.com/openhab/openhab-addons/commit/352402a8032d4d5c1f93901d10ce339ecf513ae1", "message": "make new parameters advanced\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-02-11T22:10:33Z", "type": "commit"}, {"oid": "2385c5e06b44446e01ef64726d8cffe5b757c31e", "url": "https://github.com/openhab/openhab-addons/commit/2385c5e06b44446e01ef64726d8cffe5b757c31e", "message": "replace lambda functions by method references\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-02-11T22:12:46Z", "type": "commit"}]}