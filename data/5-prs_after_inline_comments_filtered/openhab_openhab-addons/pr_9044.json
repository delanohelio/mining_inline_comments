{"pr_number": 9044, "pr_title": "[dsmr] Use ThingHandlerService for discovery", "pr_createdAt": "2020-11-16T17:57:29Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9044", "timeline": [{"oid": "645bcb2382905188e9bdd9259a9463e18a32ff7e", "url": "https://github.com/openhab/openhab-addons/commit/645bcb2382905188e9bdd9259a9463e18a32ff7e", "message": "[dsmr] Use ThingHandlerService for discovery\n\nThis simplifies the DSMRHandlerFactory code so it no longer needs to register and keep track of a discovery service for each bridge.\n\nAlso contains a few other improvements:\n\n* more constructor injection\n* add a few missing @NonNullByDefault on test classes\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-11-16T17:58:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNjY5NQ==", "url": "https://github.com/openhab/openhab-addons/pull/9044#discussion_r525406695", "bodyText": "Surely there is a better way to implement this rather than using static fields? Can ThingServiceHandler osgi wiring support be added to the core?", "author": "cpmeister", "createdAt": "2020-11-17T18:53:30Z", "path": "bundles/org.openhab.binding.dsmr/src/main/java/org/openhab/binding/dsmr/internal/discovery/DSMRI18nProviderTracker.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.dsmr.internal.discovery;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.i18n.LocaleProvider;\n+import org.openhab.core.i18n.TranslationProvider;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+\n+/**\n+ * Tracks the i18n provider dependencies of the {@link DSMRMeterDiscoveryService}. The {@link DSMRMeterDiscoveryService}\n+ * is a {@link ThingHandlerService} so its i18n dependencies cannot be injected using service component annotations.\n+ *\n+ * @author Wouter Born - Initial contribution\n+ */\n+@Component\n+@NonNullByDefault\n+public class DSMRI18nProviderTracker {\n+\n+    static @Nullable TranslationProvider i18nProvider;\n+    static @Nullable LocaleProvider localeProvider;", "originalCommit": "645bcb2382905188e9bdd9259a9463e18a32ff7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1NDcyMw==", "url": "https://github.com/openhab/openhab-addons/pull/9044#discussion_r525454723", "bodyText": "What is the better way with the currently available APIs?", "author": "wborn", "createdAt": "2020-11-17T19:51:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNjY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1OTI1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/9044#discussion_r525459256", "bodyText": "@Hilbrand's suggestion is the only one that comes to mind.", "author": "cpmeister", "createdAt": "2020-11-17T19:55:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNjY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2MjE4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/9044#discussion_r525462185", "bodyText": "Can ThingServiceHandler osgi wiring support be added to the core?\n\nYes, please ... that will be a great enhancement. I would love to have this feature too. And I guess it should be possible because we are doing it in JavaOSGiTest:getService(...) methods too. Don't we?", "author": "cweitkamp", "createdAt": "2020-11-17T19:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNjY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2NjM2NQ==", "url": "https://github.com/openhab/openhab-addons/pull/9044#discussion_r525466365", "bodyText": "After looking into it I've found that you could get those osgi services by using FrameworkUtil.getBundle(...).getBundleContext().getServiceReference().\nI don't know if that is any better though, but it might be preferable to passing around the osgi services in the handlers.", "author": "cpmeister", "createdAt": "2020-11-17T20:00:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNjY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ3MDQ4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/9044#discussion_r525470486", "bodyText": "I considered such trickery but it's not used in other bindings and we always try to reduce the amount of OSGi trickery in add-ons.", "author": "wborn", "createdAt": "2020-11-17T20:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNjY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4MDQxOQ==", "url": "https://github.com/openhab/openhab-addons/pull/9044#discussion_r525180419", "bodyText": "Hmm setting static fields in a constructor doesn't seem really nice... Maybe pass the providers to the bridge from the factory and than when setThingHandler is called in DSMRMeterDiscoveryService get the providers from the bridge passed and set them.", "author": "Hilbrand", "createdAt": "2020-11-17T14:06:51Z", "path": "bundles/org.openhab.binding.dsmr/src/main/java/org/openhab/binding/dsmr/internal/discovery/DSMRI18nProviderTracker.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.dsmr.internal.discovery;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.i18n.LocaleProvider;\n+import org.openhab.core.i18n.TranslationProvider;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+\n+/**\n+ * Tracks the i18n provider dependencies of the {@link DSMRMeterDiscoveryService}. The {@link DSMRMeterDiscoveryService}\n+ * is a {@link ThingHandlerService} so its i18n dependencies cannot be injected using service component annotations.\n+ *\n+ * @author Wouter Born - Initial contribution\n+ */\n+@Component\n+@NonNullByDefault\n+public class DSMRI18nProviderTracker {\n+\n+    static @Nullable TranslationProvider i18nProvider;\n+    static @Nullable LocaleProvider localeProvider;\n+\n+    @Activate\n+    public DSMRI18nProviderTracker(final @Reference TranslationProvider i18nProvider,\n+            final @Reference LocaleProvider localeProvider) {\n+        DSMRI18nProviderTracker.i18nProvider = i18nProvider;\n+        DSMRI18nProviderTracker.localeProvider = localeProvider;", "originalCommit": "645bcb2382905188e9bdd9259a9463e18a32ff7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2MDkxMg==", "url": "https://github.com/openhab/openhab-addons/pull/9044#discussion_r525460912", "bodyText": "Adding it to the bridge results in adding it to the factory too. None of them use these providers  themselves. That's why I opted for this workaround.", "author": "wborn", "createdAt": "2020-11-17T19:56:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4MDQxOQ=="}], "type": "inlineReview"}, {"oid": "565bda42652060ca6fccbed8258f3626f2e2beb0", "url": "https://github.com/openhab/openhab-addons/commit/565bda42652060ca6fccbed8258f3626f2e2beb0", "message": "[dsmr] Use ThingHandlerService for discovery\n\nThis simplifies the DSMRHandlerFactory code so it no longer needs to register and keep track of a discovery service for each bridge.\n\nAlso contains a few other improvements:\n\n* more constructor injection\n* add a few missing @NonNullByDefault on test classes\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-01-03T13:45:04Z", "type": "forcePushed"}, {"oid": "6f7bd0bffa137d76b5824f10a2e3b45ba7089883", "url": "https://github.com/openhab/openhab-addons/commit/6f7bd0bffa137d76b5824f10a2e3b45ba7089883", "message": "[dsmr] Use ThingHandlerService for discovery\n\nThis simplifies the DSMRHandlerFactory code so it no longer needs to register and keep track of a discovery service for each bridge.\n\nAlso contains a few other improvements:\n\n* more constructor injection\n* add a few missing @NonNullByDefault on test classes\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-01-14T09:52:11Z", "type": "forcePushed"}, {"oid": "80cb5738bd7c46cffa3377e65da314fcd15add48", "url": "https://github.com/openhab/openhab-addons/commit/80cb5738bd7c46cffa3377e65da314fcd15add48", "message": "[dsmr] Use ThingHandlerService for discovery\n\nThis simplifies the DSMRHandlerFactory code so it no longer needs to register and keep track of a discovery service for each bridge.\n\nAlso contains a few other improvements:\n\n* more constructor injection\n* add a few missing @NonNullByDefault on test classes\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-01-23T13:02:27Z", "type": "forcePushed"}, {"oid": "095406a0708c507f3d091bfd63d797f2555718e8", "url": "https://github.com/openhab/openhab-addons/commit/095406a0708c507f3d091bfd63d797f2555718e8", "message": "[dsmr] Use ThingHandlerService for discovery\n\nThis simplifies the DSMRHandlerFactory code so it no longer needs to register and keep track of a discovery service for each bridge.\n\nAlso contains a few other improvements:\n\n* more constructor injection\n* add a few missing @NonNullByDefault on test classes\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-03-02T16:01:10Z", "type": "forcePushed"}, {"oid": "6b50e34b8c33764a7256e6672f5306048861793f", "url": "https://github.com/openhab/openhab-addons/commit/6b50e34b8c33764a7256e6672f5306048861793f", "message": "[dsmr] Use ThingHandlerService for discovery\n\nThis simplifies the DSMRHandlerFactory code so it no longer needs to register and keep track of a discovery service for each bridge.\n\nAlso contains a few other improvements:\n\n* more constructor injection\n* add a few missing @NonNullByDefault on test classes\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-03-21T11:10:55Z", "type": "commit"}, {"oid": "6b50e34b8c33764a7256e6672f5306048861793f", "url": "https://github.com/openhab/openhab-addons/commit/6b50e34b8c33764a7256e6672f5306048861793f", "message": "[dsmr] Use ThingHandlerService for discovery\n\nThis simplifies the DSMRHandlerFactory code so it no longer needs to register and keep track of a discovery service for each bridge.\n\nAlso contains a few other improvements:\n\n* more constructor injection\n* add a few missing @NonNullByDefault on test classes\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-03-21T11:10:55Z", "type": "forcePushed"}]}