{"pr_number": 8871, "pr_title": "[Linky] Some enhancements and corrections on the linky binding", "pr_createdAt": "2020-10-26T15:29:30Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8871", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r512609270", "bodyText": "Why do you need a new client for each thing?", "author": "J-N-K", "createdAt": "2020-10-27T11:21:36Z", "path": "bundles/org.openhab.binding.linky/src/main/java/org/openhab/binding/linky/internal/LinkyHandlerFactory.java", "diffHunk": "@@ -69,10 +68,9 @@ public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n     protected @Nullable ThingHandler createHandler(Thing thing) {\n         ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n \n-        if (supportsThingType(thingTypeUID)) {\n-            return new LinkyHandler(thing, localeProvider, gson, httpClient);\n-        }\n-\n-        return null;\n+        return supportsThingType(thingTypeUID)\n+                ? new LinkyHandler(thing, localeProvider, gson,\n+                        httpClientFactory.createHttpClient(thingTypeUID.getAsString().replace(\":\", \"_\")))", "originalCommit": "648368732e9c234a32a81da4bd34af0100f7ef16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYyNDAwNw==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r512624007", "bodyText": "Because the thing may start or stop the client.", "author": "clinique", "createdAt": "2020-10-27T11:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0NDQzOA==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r512644438", "bodyText": "But why not having the client setup, started and stopped in the thing handler factory?\nThere is nothing depending on thing?", "author": "lolodomo", "createdAt": "2020-10-27T12:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI3OTMwNA==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r513279304", "bodyText": "Why would the thing handler factory takes care of that ? It does not know is a given thing is activated or not.", "author": "clinique", "createdAt": "2020-10-28T09:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMzMjY3MA==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r513332670", "bodyText": "It would just allow to create only one HTTP client for the binding and not one for each thing.\nBut this is not very important as 99,9\u2105 of users will define only one thing, so it makes no difference in practice.", "author": "lolodomo", "createdAt": "2020-10-28T10:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUyMDAzMg==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r515520032", "bodyText": "@J-N-K : with the explanation, is it ok for you?", "author": "lolodomo", "createdAt": "2020-10-31T17:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUyODEyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r515528125", "bodyText": "Of course hthe shared client should never be stopped, so this if of course a good reason. But why is it necessary to start/stop the client?", "author": "J-N-K", "createdAt": "2020-10-31T19:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA=="}], "type": "inlineReview"}, {"oid": "d7d73d2a22b53f514af0711ab46d167f4d033534", "url": "https://github.com/openhab/openhab-addons/commit/d7d73d2a22b53f514af0711ab46d167f4d033534", "message": "Some enhancements and corrections on the linky binding\nspotless apply\nAdressing code review comments\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-03T16:39:06Z", "type": "commit"}, {"oid": "d7d73d2a22b53f514af0711ab46d167f4d033534", "url": "https://github.com/openhab/openhab-addons/commit/d7d73d2a22b53f514af0711ab46d167f4d033534", "message": "Some enhancements and corrections on the linky binding\nspotless apply\nAdressing code review comments\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-03T16:39:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgzOTA5OA==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r516839098", "bodyText": "Please check that you have enough data to avoid s potential NPE.", "author": "lolodomo", "createdAt": "2020-11-03T17:30:40Z", "path": "bundles/org.openhab.binding.linky/src/main/java/org/openhab/binding/linky/internal/handler/LinkyHandler.java", "diffHunk": "@@ -167,50 +168,57 @@ public void initialize() {\n     private void updateData() {\n         updatePowerData();\n         updateDailyData();\n+        updateWeeklyData();\n         updateMonthlyData();\n         updateYearlyData();\n     }\n \n     private synchronized void updatePowerData() {\n         if (isLinked(PEAK_POWER) || isLinked(PEAK_TIMESTAMP)) {\n-            Consumption result = cachedPowerData.getValue();\n-            if (result != null) {\n-                updateVAChannel(PEAK_POWER, result.aggregats.days.datas.get(0));\n-                updateState(PEAK_TIMESTAMP, new DateTimeType(result.aggregats.days.periodes.get(0).dateDebut));\n-            }\n+            cachedPowerData.getValue().ifPresent(values -> {\n+                updateVAChannel(PEAK_POWER, values.aggregats.days.datas.get(0));\n+                updateState(PEAK_TIMESTAMP, new DateTimeType(values.aggregats.days.periodes.get(0).dateDebut));\n+            });\n         }\n     }\n \n     /**\n      * Request new dayly/weekly data and updates channels\n      */\n     private synchronized void updateDailyData() {\n-        if (isLinked(YESTERDAY) || isLinked(LAST_WEEK) || isLinked(THIS_WEEK)) {\n-            Consumption result = cachedDaylyData.getValue();\n-            if (result != null) {\n-                Aggregate days = result.aggregats.days;\n-\n+        if (isLinked(YESTERDAY) || isLinked(THIS_WEEK)) {\n+            cachedDailyData.getValue().ifPresent(values -> {\n+                Aggregate days = values.aggregats.days;\n                 int maxValue = days.periodes.size() - 1;\n                 int thisWeekNumber = days.periodes.get(maxValue).dateDebut.get(weekFields.weekOfWeekBasedYear());\n                 double yesterday = days.datas.get(maxValue);\n-                double lastWeek = 0.0;\n-                double thisWeek = 0.0;\n+                double thisWeek = 0.00;\n \n                 for (int i = maxValue; i >= 0; i--) {\n                     int weekNumber = days.periodes.get(i).dateDebut.get(weekFields.weekOfWeekBasedYear());\n                     if (weekNumber == thisWeekNumber) {\n-                        thisWeek += days.datas.get(i);\n-                    } else if (weekNumber == thisWeekNumber - 1) {\n-                        lastWeek += days.datas.get(i);\n+                        Double value = days.datas.get(i);\n+                        thisWeek += !value.isNaN() ? value : 0;\n                     } else {\n                         break;\n                     }\n                 }\n \n                 updateKwhChannel(YESTERDAY, yesterday);\n                 updateKwhChannel(THIS_WEEK, thisWeek);\n-                updateKwhChannel(LAST_WEEK, lastWeek);\n-            }\n+            });\n+        }\n+    }\n+\n+    /**\n+     * Request new weekly data and updates channels\n+     */\n+    private synchronized void updateWeeklyData() {\n+        if (isLinked(LAST_WEEK)) {\n+            cachedDailyData.getValue().ifPresent(values -> {\n+                Aggregate weeks = values.aggregats.weeks;\n+                updateKwhChannel(LAST_WEEK, weeks.datas.get(1));", "originalCommit": "d7d73d2a22b53f514af0711ab46d167f4d033534", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "01b0c19f7d2bd5cacf7e6c34d8d50ab2bbf322fd", "url": "https://github.com/openhab/openhab-addons/commit/01b0c19f7d2bd5cacf7e6c34d8d50ab2bbf322fd", "message": "Adressing potential NPR.\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-04T10:21:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNzU5OA==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r520027598", "bodyText": "I assume this is supposed to be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                updateKwhChannel(LAST_YEAR, Double.NaN);\n          \n          \n            \n                                updateKwhChannel(THIS_YEAR, Double.NaN);", "author": "cpmeister", "createdAt": "2020-11-09T18:29:57Z", "path": "bundles/org.openhab.binding.linky/src/main/java/org/openhab/binding/linky/internal/handler/LinkyHandler.java", "diffHunk": "@@ -237,26 +246,28 @@ private synchronized void updateMonthlyData() {\n      */\n     private synchronized void updateYearlyData() {\n         if (isLinked(LAST_YEAR) || isLinked(THIS_YEAR)) {\n-            Consumption result = cachedYearlyData.getValue();\n-            if (result != null) {\n-                Aggregate years = result.aggregats.years;\n+            cachedYearlyData.getValue().ifPresent(values -> {\n+                Aggregate years = values.aggregats.years;\n                 updateKwhChannel(LAST_YEAR, years.datas.get(0));\n-                updateKwhChannel(THIS_YEAR, years.datas.get(1));\n-            }\n+                if (years.datas.size() > 1) {\n+                    updateKwhChannel(THIS_YEAR, years.datas.get(1));\n+                } else {\n+                    updateKwhChannel(LAST_YEAR, Double.NaN);", "originalCommit": "e0aaa22aa6c771aaca0c27020eddfd93f806b79e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNTMyNw==", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r520035327", "bodyText": "Ooops, nicely found", "author": "clinique", "createdAt": "2020-11-09T18:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNzU5OA=="}], "type": "inlineReview"}, {"oid": "bae7f5000bdc3cb31aff1abb28d3b1a484d58b01", "url": "https://github.com/openhab/openhab-addons/commit/bae7f5000bdc3cb31aff1abb28d3b1a484d58b01", "message": "Code review findings correction\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-09T18:42:16Z", "type": "commit"}, {"oid": "bae7f5000bdc3cb31aff1abb28d3b1a484d58b01", "url": "https://github.com/openhab/openhab-addons/commit/bae7f5000bdc3cb31aff1abb28d3b1a484d58b01", "message": "Code review findings correction\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-09T18:42:16Z", "type": "forcePushed"}, {"oid": "9b13496318c9fddaca74e68ca17f42cdc937eb37", "url": "https://github.com/openhab/openhab-addons/commit/9b13496318c9fddaca74e68ca17f42cdc937eb37", "message": "Pleasing SAT checks\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-10T09:12:43Z", "type": "commit"}, {"oid": "9b13496318c9fddaca74e68ca17f42cdc937eb37", "url": "https://github.com/openhab/openhab-addons/commit/9b13496318c9fddaca74e68ca17f42cdc937eb37", "message": "Pleasing SAT checks\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-10T09:12:43Z", "type": "forcePushed"}, {"oid": "342a222a8c98b2280925dfa57347028d9264b30a", "url": "https://github.com/openhab/openhab-addons/commit/342a222a8c98b2280925dfa57347028d9264b30a", "message": "Merge branch 'main' into Linky_enhabcements", "committedDate": "2020-11-10T09:14:39Z", "type": "commit"}]}