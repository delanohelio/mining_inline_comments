{"pr_number": 8761, "pr_title": "[OpenUV] Correcting representation property", "pr_createdAt": "2020-10-15T17:56:32Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8761", "timeline": [{"oid": "c3ffc8ae40e4f742ba381db4fb083f65d683dc6a", "url": "https://github.com/openhab/openhab-addons/commit/c3ffc8ae40e4f742ba381db4fb083f65d683dc6a", "message": "[OpenUV] Correcting representation property\nRemoving org.apache.commons.stringutils usage\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-15T17:47:10Z", "type": "commit"}, {"oid": "78063a83da004c4b00941ed6b74621e6b961c020", "url": "https://github.com/openhab/openhab-addons/commit/78063a83da004c4b00941ed6b74621e6b961c020", "message": "Corrected\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-15T17:52:06Z", "type": "commit"}, {"oid": "8733c27ca1eb3fc57a931a6c750b74cfc9b7f19d", "url": "https://github.com/openhab/openhab-addons/commit/8733c27ca1eb3fc57a931a6c750b74cfc9b7f19d", "message": "While on it, reviewed completely the binding.\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-15T22:08:32Z", "type": "commit"}, {"oid": "0e141cba6f498ce8447d6809ccbccaaece99e38a", "url": "https://github.com/openhab/openhab-addons/commit/0e141cba6f498ce8447d6809ccbccaaece99e38a", "message": "spotless applied\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-15T22:17:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwNzAzNw==", "url": "https://github.com/openhab/openhab-addons/pull/8761#discussion_r505907037", "bodyText": "You should keep track of this scheduled future so that you can cancel it if the handler gets disposed.", "author": "cpmeister", "createdAt": "2020-10-15T22:48:59Z", "path": "bundles/org.openhab.binding.openuv/src/main/java/org/openhab/binding/openuv/internal/handler/OpenUVBridgeHandler.java", "diffHunk": "@@ -106,62 +94,50 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n \n     private void initiateConnexion() {\n         // Check if the provided api key is valid for use with the OpenUV service\n-        getUVData(\"0\", \"0\", null);\n-    }\n-\n-    public Map<ThingUID, @Nullable ServiceRegistration<?>> getDiscoveryServiceRegs() {\n-        return discoveryServiceRegs;\n-    }\n-\n-    public void setDiscoveryServiceRegs(Map<ThingUID, @Nullable ServiceRegistration<?>> discoveryServiceRegs) {\n-        this.discoveryServiceRegs = discoveryServiceRegs;\n+        getUVData(\"0\", \"0\", \"0\");\n     }\n \n-    @Override\n-    public void handleRemoval() {\n-        // removes the old registration service associated to the bridge, if existing\n-        ServiceRegistration<?> dis = getDiscoveryServiceRegs().get(getThing().getUID());\n-        if (dis != null) {\n-            dis.unregister();\n-        }\n-        super.handleRemoval();\n-    }\n-\n-    public @Nullable OpenUVResult getUVData(String latitude, String longitude, @Nullable String altitude) {\n-        StringBuilder urlBuilder = new StringBuilder(BASE_URL).append(\"?lat=\").append(latitude).append(\"&lng=\")\n-                .append(longitude);\n-\n-        if (altitude != null) {\n-            urlBuilder.append(\"&alt=\").append(altitude);\n-        }\n-        String errorMessage = null;\n+    public @Nullable OpenUVResult getUVData(String latitude, String longitude, String altitude) {\n         try {\n-            String jsonData = HttpUtil.executeUrl(\"GET\", urlBuilder.toString(), header, null, null, REQUEST_TIMEOUT);\n+            String jsonData = HttpUtil.executeUrl(\"GET\", String.format(QUERY_URL, latitude, longitude, altitude),\n+                    header, null, null, REQUEST_TIMEOUT_MS);\n             OpenUVResponse uvResponse = gson.fromJson(jsonData, OpenUVResponse.class);\n             if (uvResponse.getError() == null) {\n                 updateStatus(ThingStatus.ONLINE);\n                 return uvResponse.getResult();\n             } else {\n-                errorMessage = uvResponse.getError();\n+                throw new OpenUVException(uvResponse.getError());\n             }\n         } catch (IOException e) {\n-            errorMessage = e.getMessage();\n+            logger.error(\"Error occured during API query : {}\", e.getMessage());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, e.getMessage());\n+        } catch (OpenUVException e) {\n+            if (e.isQuotaError()) {\n+                LocalDate today = LocalDate.now();\n+                LocalDate tomorrow = today.plusDays(1);\n+                LocalDateTime tomorrowMidnight = tomorrow.atStartOfDay().plusMinutes(2);\n+\n+                String message = \"Quota Exceeded, going OFFLINE for today, will retry at : \"\n+                        + tomorrowMidnight.toString();\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, message);\n+\n+                scheduler.schedule(this::initiateConnexion,\n+                        Duration.between(LocalDateTime.now(), tomorrowMidnight).toMinutes(), TimeUnit.MINUTES);", "originalCommit": "0e141cba6f498ce8447d6809ccbccaaece99e38a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a7745ee576a92fd7c0043f7e5132b157a4ee9576", "url": "https://github.com/openhab/openhab-addons/commit/a7745ee576a92fd7c0043f7e5132b157a4ee9576", "message": "Code review\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-16T04:46:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwOTE2NA==", "url": "https://github.com/openhab/openhab-addons/pull/8761#discussion_r506609164", "bodyText": "You are already setting the thing offline with the error message so you don't need to log it as well.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.error(\"Error occured during API query : {}\", e.getMessage());", "author": "cpmeister", "createdAt": "2020-10-16T17:09:40Z", "path": "bundles/org.openhab.binding.openuv/src/main/java/org/openhab/binding/openuv/internal/handler/OpenUVBridgeHandler.java", "diffHunk": "@@ -106,62 +105,50 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n \n     private void initiateConnexion() {\n         // Check if the provided api key is valid for use with the OpenUV service\n-        getUVData(\"0\", \"0\", null);\n+        getUVData(\"0\", \"0\", \"0\");\n     }\n \n-    public Map<ThingUID, @Nullable ServiceRegistration<?>> getDiscoveryServiceRegs() {\n-        return discoveryServiceRegs;\n-    }\n-\n-    public void setDiscoveryServiceRegs(Map<ThingUID, @Nullable ServiceRegistration<?>> discoveryServiceRegs) {\n-        this.discoveryServiceRegs = discoveryServiceRegs;\n-    }\n-\n-    @Override\n-    public void handleRemoval() {\n-        // removes the old registration service associated to the bridge, if existing\n-        ServiceRegistration<?> dis = getDiscoveryServiceRegs().get(getThing().getUID());\n-        if (dis != null) {\n-            dis.unregister();\n-        }\n-        super.handleRemoval();\n-    }\n-\n-    public @Nullable OpenUVResult getUVData(String latitude, String longitude, @Nullable String altitude) {\n-        StringBuilder urlBuilder = new StringBuilder(BASE_URL).append(\"?lat=\").append(latitude).append(\"&lng=\")\n-                .append(longitude);\n-\n-        if (altitude != null) {\n-            urlBuilder.append(\"&alt=\").append(altitude);\n-        }\n-        String errorMessage = null;\n+    public @Nullable OpenUVResult getUVData(String latitude, String longitude, String altitude) {\n         try {\n-            String jsonData = HttpUtil.executeUrl(\"GET\", urlBuilder.toString(), header, null, null, REQUEST_TIMEOUT);\n+            String jsonData = HttpUtil.executeUrl(\"GET\", String.format(QUERY_URL, latitude, longitude, altitude),\n+                    header, null, null, REQUEST_TIMEOUT_MS);\n             OpenUVResponse uvResponse = gson.fromJson(jsonData, OpenUVResponse.class);\n             if (uvResponse.getError() == null) {\n                 updateStatus(ThingStatus.ONLINE);\n                 return uvResponse.getResult();\n             } else {\n-                errorMessage = uvResponse.getError();\n+                throw new OpenUVException(uvResponse.getError());\n             }\n         } catch (IOException e) {\n-            errorMessage = e.getMessage();\n+            logger.error(\"Error occured during API query : {}\", e.getMessage());", "originalCommit": "a7745ee576a92fd7c0043f7e5132b157a4ee9576", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da5b3ff224d91fc6a9d128fc517aef5e947fe1d6", "url": "https://github.com/openhab/openhab-addons/commit/da5b3ff224d91fc6a9d128fc517aef5e947fe1d6", "message": "Code review enhancement\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-19T09:05:04Z", "type": "commit"}]}