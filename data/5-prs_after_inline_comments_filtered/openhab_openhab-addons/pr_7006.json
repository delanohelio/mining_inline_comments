{"pr_number": 7006, "pr_title": "[tado] assorted upgrades and bug fixes to the binding", "pr_createdAt": "2020-02-13T18:04:37Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7006", "timeline": [{"oid": "f2cad6fecca04b56a9df832c5dc1bf838e13652c", "url": "https://github.com/openhab/openhab-addons/commit/f2cad6fecca04b56a9df832c5dc1bf838e13652c", "message": "Return a defined channel state (off) when api does not return JSON payload\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-02-13T17:33:21Z", "type": "commit"}, {"oid": "b147145a0c68009f6ac617ec4e12c0d336d1b676", "url": "https://github.com/openhab/openhab-addons/commit/b147145a0c68009f6ac617ec4e12c0d336d1b676", "message": "Corrected typing errors in POM dependencies\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-02-13T17:34:05Z", "type": "commit"}, {"oid": "4bd3429a96f4b2b0768f8b1786ed0a8b8bc2db11", "url": "https://github.com/openhab/openhab-addons/commit/4bd3429a96f4b2b0768f8b1786ed0a8b8bc2db11", "message": "Added a pom-aggregator.xml to build the dependency file\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-02-13T17:35:00Z", "type": "commit"}, {"oid": "004420acf555df2c0160afd33424c1c682318790", "url": "https://github.com/openhab/openhab-addons/commit/004420acf555df2c0160afd33424c1c682318790", "message": "Upload the dependency JAR file (just in case)\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-02-13T17:35:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTA3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r379891070", "bodyText": "What's the idea here? If any batteryState is low, set the zoneList to OFF otherwise to ON?\nhomeHandler.getApi().listZones(homeId).forEach(zone -> {\n    try {\n        boolean batteryLow = !zone.getDevices().stream().map(ControlDevice::getBatteryState).anyMatch(s->!(\"NORMAL\".equals(s)));\n        zoneList.put(Long:valueOf(zone.getId()), OnOffType.from(batteryLow));\n    } catch (IOException | ApiException e) {\n        logger.debug(\"Fetch (battery state) zone list exception\", e); \n    }\n}\n\nThis also allows to process other zones if one zone failed (instead of before where processing stops when the first error occurs.", "author": "J-N-K", "createdAt": "2020-02-16T10:06:56Z", "path": "bundles/org.openhab.binding.tado/src/main/java/org/openhab/binding/tado/internal/handler/TadoBatteryChecker.java", "diffHunk": "@@ -57,10 +57,20 @@ private synchronized void refreshZoneList() {\n             Long homeId = homeHandler.getHomeId();\n             if (homeId != null) {\n                 logger.debug(\"Fetching (battery state) zone list for HomeId {}\", homeId);\n+                zoneList.clear();\n                 try {\n-                    zoneList = homeHandler.getApi().listZones(homeId);\n+                    for (Zone zone : homeHandler.getApi().listZones(homeId)) {", "originalCommit": "004420acf555df2c0160afd33424c1c682318790", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxNDEwMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r379914101", "bodyText": "I think I need to give you some background here..\nIn a tado system the Bridge Thing is the home \"HomeId\", and within each Home, there are Things for rooms \"ZoneId\" (for example Living Room Heating). In the majority of cases, each Zone has a single radiator control valve device in it. But the tado system does also allow for each Zone to have more than one radiator control valve; and in that case the two (or more) radiator control valves are slaved together under the single Zone Thing.\nHomeId = \"my address\"\n\u251c\u2500\u2500 ZoneId = \"Kitchen\"\n\u2502   \u251c\u2500\u2500 DeviceID = \"radiator control valve A\"\n\u251c\u2500\u2500 ZoneId = \"Living Room\"\n     \u251c\u2500\u2500 DeviceID = \"radiator control valve B\"\n     \u251c\u2500\u2500 DeviceID = \"radiator control valve C\"\n\nIn the binding, the main API interface is a JSON request to http://something/something/ZoneId=J which fetches Channel information for the Zone like room temperature, set temperature, heating state. The binding polls this JSON request according to the refresh Interval defined in the Configuration Parameters.\nHOWEVER, for the low battery alarm -- unlike the other Channels -- the checking for this alarm is NOT done at Zone level but rather at each radiator control valve device level. So for each device there is a separate JSON request to the API as http://something/something/DeviceId=K which reads the low battery alarm state.\nThe radiator control valve devices are not modelled as Things in the binding. So to bring their low battery alarm state into openHAB it is necessary to poll each device, and amalgamate these alarm values in the common Zone low battery battery alarm Channel (by OR'ing across all the radiator control valve devices in that Zone).\nFurthermore, in the previous build of this binding, the JSON calls for the low battery alarm were not being made according to the polling refresh Interval, but were instead being made immediately every time that the binding requested an update. So this caused far too many unnecessary API calls -- particularly since this Channel only goes into alarm roughly once in 6 months.\nSo in this new build of the binding, I have done two things: a) the polling of JSON request to the radiator control valve devices for their low battery alarm state is no longer made on every refresh request, and b) there is now a Map table that maps between the Zone Ids and the amalgamated low battery alarm states of the radiator control valve devices within that Zone.", "author": "andrewfg", "createdAt": "2020-02-16T16:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxNTY0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r379915647", "bodyText": "I think that is exactly what my code-snippet is doing. It's only another way of doing the same thing.", "author": "J-N-K", "createdAt": "2020-02-16T16:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMzNDczOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r380334739", "bodyText": "Resolved. See comments below..", "author": "andrewfg", "createdAt": "2020-02-17T19:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTIyMA==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r379891220", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    State state = zoneList.get(zoneId);\n          \n          \n            \n                    return zoneList.getorDefault(zoneId, OnOffType.OFF);", "author": "J-N-K", "createdAt": "2020-02-16T10:09:51Z", "path": "bundles/org.openhab.binding.tado/src/main/java/org/openhab/binding/tado/internal/handler/TadoBatteryChecker.java", "diffHunk": "@@ -69,25 +79,8 @@ private synchronized void refreshZoneList() {\n \n     public State getBatteryLowAlarm(long zoneId) {\n         refreshZoneList();\n-        boolean hasBatteryStateValue = false;\n-        if (zoneList != null) {\n-            // logger.debug(\"Fetching battery state for ZoneId {}\", zoneId);\n-            for (Zone zone : zoneList) {\n-                if (zoneId == zone.getId()) {\n-                    for (ControlDevice device : zone.getDevices()) {\n-                        String batteryState = device.getBatteryState();\n-                        if (batteryState != null) {\n-                            if (!batteryState.equals(\"NORMAL\")) {    \n-                                return OnOffType.ON;\n-                            }\n-                            hasBatteryStateValue = true;\n-                        }\n-                    }\n-                    break;\n-                }\n-            }\n-        }\n-        return hasBatteryStateValue ? OnOffType.OFF : UnDefType.UNDEF;\n+        State state = zoneList.get(zoneId);", "originalCommit": "004420acf555df2c0160afd33424c1c682318790", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxOTM2OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r379919369", "bodyText": "or probably default to UndefType.UNDEF as we don't know if ON or OFF is correct.", "author": "J-N-K", "createdAt": "2020-02-16T17:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI1MTk0MA==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r380251940", "bodyText": "Agreed to your two points. I was not aware of the getOrDefault() method, so I definitely learned something useful, thank you.", "author": "andrewfg", "createdAt": "2020-02-17T15:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTIyMA=="}], "type": "inlineReview"}, {"oid": "8d8c62b27e9d1809500f781a211f93fac4d2c876", "url": "https://github.com/openhab/openhab-addons/commit/8d8c62b27e9d1809500f781a211f93fac4d2c876", "message": "Changes suggested in review by @J-N-K\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-02-17T16:17:18Z", "type": "commit"}, {"oid": "a3e6899a4ac0007126027c0698c35605f3140eae", "url": "https://github.com/openhab/openhab-addons/commit/a3e6899a4ac0007126027c0698c35605f3140eae", "message": "Cool code suggested by @J-N-K\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-02-17T19:03:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMzOTI5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r380339299", "bodyText": "Did you remove the stacktrace by intention?", "author": "J-N-K", "createdAt": "2020-02-17T19:26:38Z", "path": "bundles/org.openhab.binding.tado/src/main/java/org/openhab/binding/tado/internal/handler/TadoBatteryChecker.java", "diffHunk": "@@ -57,37 +58,23 @@ private synchronized void refreshZoneList() {\n             Long homeId = homeHandler.getHomeId();\n             if (homeId != null) {\n                 logger.debug(\"Fetching (battery state) zone list for HomeId {}\", homeId);\n+                zoneList.clear();\n                 try {\n-                    zoneList = homeHandler.getApi().listZones(homeId);\n+                    homeHandler.getApi().listZones(homeId).forEach(zone -> {\n+                        boolean batteryLow = !zone.getDevices().stream().map(ControlDevice::getBatteryState)\n+                                .filter(Objects::nonNull).allMatch(s -> s.equals(\"NORMAL\"));\n+                        zoneList.put(Long.valueOf(zone.getId()), OnOffType.from(batteryLow));\n+                    });\n                 } catch (IOException | ApiException e) {\n-                    zoneList = null;\n-                    logger.debug(\"Fetch (battery state) zone list exception\", e);\n+                    logger.debug(\"Fetch (battery state) zone list exception\");", "originalCommit": "a3e6899a4ac0007126027c0698c35605f3140eae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0NzUxNw==", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r380347517", "bodyText": "Yes. :)", "author": "andrewfg", "createdAt": "2020-02-17T19:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMzOTI5OQ=="}], "type": "inlineReview"}, {"oid": "0a6f4dfa57a02b67f589b20e0a64af3577cf824e", "url": "https://github.com/openhab/openhab-addons/commit/0a6f4dfa57a02b67f589b20e0a64af3577cf824e", "message": "Deleted pom aggregator\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>", "committedDate": "2020-02-17T21:32:30Z", "type": "commit"}]}