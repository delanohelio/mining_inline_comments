{"pr_number": 9309, "pr_title": "[bluetooth] Try to make tests more stable No.2", "pr_createdAt": "2020-12-09T18:35:13Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9309", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3NjU0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/9309#discussion_r539576547", "bodyText": "The purpose of this test was to make sure that a composed future got cancelled when the retryFuture got cancelled. Since it possible that the retry future would get cancelled before the composed future was even created it was necessary to wait, or simply sleep, until we know that the composed future was created in another thread so we can attempt to cancel it.\nThe waitForAssert can still return false if the above race condition is not dealt with.\nretryFuture.cancel should also cancel composedFuture before returning so adding any sort of waitForAssert is meaningless since it should have already occurred during the retryFuture.cancel call.", "author": "cpmeister", "createdAt": "2020-12-09T19:15:17Z", "path": "bundles/org.openhab.binding.bluetooth/src/test/java/org/openhab/binding/bluetooth/util/RetryFutureTest.java", "diffHunk": "@@ -151,10 +152,9 @@ void composeWithRetry1Cancel() throws InterruptedException {\n             if (!latch.await(100, TimeUnit.MILLISECONDS)) {\n                 fail(\"Timeout while waiting for latch\");\n             }\n-            Thread.sleep(1);\n             retryFuture.cancel(false);\n \n-            assertTrue(composedFuture.isCancelled());\n+            waitForAssert(() -> assertTrue(composedFuture.isCancelled()));", "originalCommit": "3b9245d422fa5f6a42ac6d9db79259c05f7f5249", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3OTg2MQ==", "url": "https://github.com/openhab/openhab-addons/pull/9309#discussion_r539579861", "bodyText": "The reason for this sleep is to hopefully prevent the very small chance that the retryFuture gets cancelled before the composed future is returned from the function (which in this case would be the very next line of code). Since we know where each thread is in its processing I think that giving a 1 millisecond delay would be more than sufficient to allow the composed future to return before we attempt to cancel the retryFuture.", "author": "cpmeister", "createdAt": "2020-12-09T19:20:21Z", "path": "bundles/org.openhab.binding.bluetooth/src/test/java/org/openhab/binding/bluetooth/util/RetryFutureTest.java", "diffHunk": "@@ -151,10 +152,9 @@ void composeWithRetry1Cancel() throws InterruptedException {\n             if (!latch.await(100, TimeUnit.MILLISECONDS)) {\n                 fail(\"Timeout while waiting for latch\");\n             }\n-            Thread.sleep(1);", "originalCommit": "3b9245d422fa5f6a42ac6d9db79259c05f7f5249", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d24e50bdc852b2497ed524f71290123c3c1453c2", "url": "https://github.com/openhab/openhab-addons/commit/d24e50bdc852b2497ed524f71290123c3c1453c2", "message": "[bluetooth] Try to make tests more stable No.2\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-12-09T21:31:10Z", "type": "commit"}, {"oid": "323bf987f32cd9cba2f3858a28db9941f5b80911", "url": "https://github.com/openhab/openhab-addons/commit/323bf987f32cd9cba2f3858a28db9941f5b80911", "message": "Apply @cpmeister's suggestion\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-12-09T21:33:33Z", "type": "commit"}, {"oid": "323bf987f32cd9cba2f3858a28db9941f5b80911", "url": "https://github.com/openhab/openhab-addons/commit/323bf987f32cd9cba2f3858a28db9941f5b80911", "message": "Apply @cpmeister's suggestion\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-12-09T21:33:33Z", "type": "forcePushed"}, {"oid": "a8a87ca2c1bd8011bd386d35d8cccd04bace3c61", "url": "https://github.com/openhab/openhab-addons/commit/a8a87ca2c1bd8011bd386d35d8cccd04bace3c61", "message": "Remove inheritance from JavaTest\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-12-09T21:35:37Z", "type": "commit"}]}