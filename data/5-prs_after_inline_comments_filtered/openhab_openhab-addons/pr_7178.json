{"pr_number": 7178, "pr_title": "[opensprinkler] Add current draw channel", "pr_createdAt": "2020-03-15T15:51:56Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7178", "timeline": [{"oid": "1ab31874e02cacdbb89dc9f3db9af4eec5509342", "url": "https://github.com/openhab/openhab-addons/commit/1ab31874e02cacdbb89dc9f3db9af4eec5509342", "message": "[opensprinkler] Add current draw channel\n\nThe opensprinkler device, if it has a sensor for it, can display the\ncurrent draw of the device. This information is exposed as a read-only\nchannel with this commit.\n\nFixes #6386\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-03-15T15:50:16Z", "type": "commit"}, {"oid": "f77b979a188eb69daf372005d4d05db85e5bd301", "url": "https://github.com/openhab/openhab-addons/commit/f77b979a188eb69daf372005d4d05db85e5bd301", "message": "Replace whitespace with tabs\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-03-15T15:53:53Z", "type": "commit"}, {"oid": "2276d93cbeab41bcb08d747b5817cd42e36fdd5a", "url": "https://github.com/openhab/openhab-addons/commit/2276d93cbeab41bcb08d747b5817cd42e36fdd5a", "message": "Fix logging parameter\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-03-15T16:00:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5NzI3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r392697270", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns the current voltage draw of all connected zones of the OpenSprinkler device in milliamperes. Given the\n          \n          \n            \n                 * Returns the current draw of all connected zones of the OpenSprinkler device in milliamperes. Given the", "author": "cpmeister", "createdAt": "2020-03-15T18:00:38Z", "path": "bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/api/OpenSprinklerApi.java", "diffHunk": "@@ -90,6 +90,15 @@ public abstract void openStation(int station, BigDecimal duration)\n      */\n     public abstract boolean isRainDetected() throws CommunicationApiException;\n \n+    /**\n+     * Returns the current voltage draw of all connected zones of the OpenSprinkler device in milliamperes. Given the", "originalCommit": "2276d93cbeab41bcb08d747b5817cd42e36fdd5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5NzM5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r392697393", "bodyText": "Primitives should be automatically boxed for you.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                updateState(channel, new QuantityType<ElectricCurrent>(new Integer(getApi().currentDraw()),\n          \n          \n            \n                                updateState(channel, new QuantityType<ElectricCurrent>(getApi().currentDraw(),", "author": "cpmeister", "createdAt": "2020-03-15T18:01:58Z", "path": "bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/handler/OpenSprinklerDeviceHandler.java", "diffHunk": "@@ -36,19 +41,24 @@ public OpenSprinklerDeviceHandler(Thing thing) {\n \n     @Override\n     protected void updateChannel(ChannelUID channel) {\n-        switch (channel.getIdWithoutGroup()) {\n-            case SENSOR_RAIN:\n-                try {\n+        try {\n+            switch (channel.getIdWithoutGroup()) {\n+                case SENSOR_RAIN:\n                     if (getApi().isRainDetected()) {\n                         updateState(channel, OnOffType.ON);\n                     } else {\n                         updateState(channel, OnOffType.OFF);\n                     }\n-                } catch (CommunicationApiException e) {\n-                    logger.debug(\"Could not update rainsensor\", e);\n-                }\n-            default:\n-                logger.debug(\"Not updating unknown channel {}\", channel);\n+                    break;\n+                case SENSOR_CURRENT_DRAW:\n+                    updateState(channel, new QuantityType<ElectricCurrent>(new Integer(getApi().currentDraw()),", "originalCommit": "2276d93cbeab41bcb08d747b5817cd42e36fdd5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9a6b8db75baa8d9e4db5e7c0b83276d28af0447", "url": "https://github.com/openhab/openhab-addons/commit/e9a6b8db75baa8d9e4db5e7c0b83276d28af0447", "message": "Update bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/api/OpenSprinklerApi.java\n\nCo-Authored-By: cpmeister <mistercpp2000@gmail.com>\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>\nSigned-off-by: cpmeister <mistercpp2000@gmail.com>", "committedDate": "2020-03-23T17:26:55Z", "type": "commit"}, {"oid": "4d50a5a2df0d0686b2cdd65cc9d260e615ace9ec", "url": "https://github.com/openhab/openhab-addons/commit/4d50a5a2df0d0686b2cdd65cc9d260e615ace9ec", "message": "Update bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/handler/OpenSprinklerDeviceHandler.java\n\nCo-Authored-By: cpmeister <mistercpp2000@gmail.com>\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>\nSigned-off-by: cpmeister <mistercpp2000@gmail.com>", "committedDate": "2020-03-23T17:28:03Z", "type": "commit"}, {"oid": "5d38f7760d44147758de7077022b72f87c6fa4f6", "url": "https://github.com/openhab/openhab-addons/commit/5d38f7760d44147758de7077022b72f87c6fa4f6", "message": "Conditionally add currentDraw channel\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-03-28T16:02:39Z", "type": "commit"}, {"oid": "be3f002825fadf72ee71eb2bd0166c50d0a2642b", "url": "https://github.com/openhab/openhab-addons/commit/be3f002825fadf72ee71eb2bd0166c50d0a2642b", "message": "Fix checkstyle issues\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-03-28T16:13:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5MzE3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r399693177", "bodyText": "Exceptions should have \"Exception\" as their suffix, but I also think that you could give this a more generic name, like \"MissingSensorException\".", "author": "cpmeister", "createdAt": "2020-03-28T18:22:17Z", "path": "bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/model/NoCurrentDrawSensor.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.opensprinkler.internal.model;\n+\n+/**\n+ * Indicates, that a device is missing a sensor to measure the current draw of itself.\n+ *\n+ * @author Florian Schmidt - Initial contribution\n+ */\n+public class NoCurrentDrawSensor extends Exception {", "originalCommit": "be3f002825fadf72ee71eb2bd0166c50d0a2642b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5NDA0NA==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r399694044", "bodyText": "Why should it have \"Exception\" as a suffix. The name already indicates, that's something exceptional, and it extends Exception, so it's pretty clear, that it's an exception, sin't it? What else should it be? However, if you say so, I'll add exception at the end.\nWhy should the name more generic? The only usage of the exception is, when no sensor for measuring the current draw is present. If it's more generic, the exception probably doesn't transport the intention anymore, isn't it? :/", "author": "FlorianSW", "createdAt": "2020-03-28T18:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5MzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5NDczNg==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r399694736", "bodyText": "Well the xxxException is the naming convention that we follow. Also I suggested that it could be more generic but NoCurrentDrawSensorException works just fine as well. I was only suggesting something more generic in case there are other sensors that may also be detected missing so that they can reuse that custom exception.\nBut once again all I want is to have the name changed to match our naming conventions.", "author": "cpmeister", "createdAt": "2020-03-28T18:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5MzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5NDk2OA==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r399694968", "bodyText": "Understood :) The Exception prefix is added with the last commit. I would change the name to a more generic exception, once we need to have a more generic one. At the moment, there is no other sensor we might miss :)", "author": "FlorianSW", "createdAt": "2020-03-28T18:39:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5MzE3Nw=="}], "type": "inlineReview"}, {"oid": "dc40ab2725c7412426b04d360f88ba5f41a4c56f", "url": "https://github.com/openhab/openhab-addons/commit/dc40ab2725c7412426b04d360f88ba5f41a4c56f", "message": "Comply with naming convention of exceptions\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-03-28T18:34:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzNjQwOA==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r400436408", "bodyText": "Please move this logic to line 86, just before you would need to use it. No reason to create this variable without knowing if you need it or not.", "author": "cpmeister", "createdAt": "2020-03-30T19:21:12Z", "path": "bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/handler/OpenSprinklerDeviceHandler.java", "diffHunk": "@@ -57,4 +72,29 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n         // nothing to do here\n     }\n \n+    @Override\n+    public void updateChannels() {\n+        ChannelUID currentDraw = new ChannelUID(thing.getUID(), \"currentDraw\");\n+        ThingBuilder thingBuilder = editThing();\n+        Channel currentDrawChannel = ChannelBuilder.create(currentDraw, \"Number:ElectricCurrent\")\n+                .withType(new ChannelTypeUID(BINDING_ID, SENSOR_CURRENT_DRAW)).withLabel(\"Current Draw\")\n+                .withDescription(\"Provides the current draw.\").build();", "originalCommit": "dc40ab2725c7412426b04d360f88ba5f41a4c56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ1Mjc3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r403452773", "bodyText": "Done.", "author": "FlorianSW", "createdAt": "2020-04-04T10:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzNjQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ0Mjk0OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r400442949", "bodyText": "Is the current sensor something that can be added or removed in realtime or is it something intrinsic to the device itself? If it can't be changed in realtime it would be better to add the channel during handler initialization so it gets executed only once rather than every time channel values are updated.", "author": "cpmeister", "createdAt": "2020-03-30T19:32:50Z", "path": "bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/handler/OpenSprinklerDeviceHandler.java", "diffHunk": "@@ -57,4 +72,29 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n         // nothing to do here\n     }\n \n+    @Override\n+    public void updateChannels() {", "originalCommit": "dc40ab2725c7412426b04d360f88ba5f41a4c56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0MTQ1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r403341452", "bodyText": "It looks like the design pattern you are using is rather common in other bindings, so disregard this change request.", "author": "cpmeister", "createdAt": "2020-04-03T21:19:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ0Mjk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQzMjIwMw==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r403432203", "bodyText": "Where? IMO this needs to be changed. Thing updates should only be done if the thing really needs chaning. I think in this case it should be done in initialize().", "author": "J-N-K", "createdAt": "2020-04-04T06:21:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ0Mjk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ1Mjg5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r403452896", "bodyText": "Done", "author": "FlorianSW", "createdAt": "2020-04-04T10:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ0Mjk0OQ=="}], "type": "inlineReview"}, {"oid": "393233e6895452f1666ea4eb3b3dcd4537e2db87", "url": "https://github.com/openhab/openhab-addons/commit/393233e6895452f1666ea4eb3b3dcd4537e2db87", "message": "Register channel in initialize\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-04-04T10:18:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ1OTMyNg==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r403459326", "bodyText": "Since you never remove the channel, you could move this to the most upper level.\nif (thing.getChannel == null) {\n   try {\n       getApi.currentDraw();\n\n       ThingBuilder thingBuilder = editThing();\n       Channel currentDrawChannel = ...\n       thingBuilder.withChannel(currentDrawChannel);\n       updateThing(thingBuilder.build());\n   } catch (...) {\n      logger.debug(...);\n   }\n}", "author": "J-N-K", "createdAt": "2020-04-04T11:28:48Z", "path": "bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/handler/OpenSprinklerDeviceHandler.java", "diffHunk": "@@ -68,21 +68,16 @@ protected void updateChannel(ChannelUID channel) {\n     }\n \n     @Override\n-    public void handleCommand(ChannelUID channelUID, Command command) {\n-        // nothing to do here\n-    }\n-\n-    @Override\n-    public void updateChannels() {\n+    public void initialize() {\n         ChannelUID currentDraw = new ChannelUID(thing.getUID(), \"currentDraw\");\n         ThingBuilder thingBuilder = editThing();\n-        Channel currentDrawChannel = ChannelBuilder.create(currentDraw, \"Number:ElectricCurrent\")\n-                .withType(new ChannelTypeUID(BINDING_ID, SENSOR_CURRENT_DRAW)).withLabel(\"Current Draw\")\n-                .withDescription(\"Provides the current draw.\").build();\n         try {\n             getApi().currentDraw();\n \n             if (thing.getChannel(currentDraw) == null) {", "originalCommit": "393233e6895452f1666ea4eb3b3dcd4537e2db87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ5MjY0NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r403492645", "bodyText": "Done", "author": "FlorianSW", "createdAt": "2020-04-04T17:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ1OTMyNg=="}], "type": "inlineReview"}, {"oid": "a0428474430baae7f25d8e2082ba99655dc4527c", "url": "https://github.com/openhab/openhab-addons/commit/a0428474430baae7f25d8e2082ba99655dc4527c", "message": "Implement review comment\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-04-04T17:08:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzUxNDM1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7178#discussion_r403514356", "bodyText": "No need to edit until you know you might need to.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ThingBuilder thingBuilder = editThing();\n          \n          \n            \n                    if (thing.getChannel(currentDraw) == null) {\n          \n          \n            \n                        try {\n          \n          \n            \n                    if (thing.getChannel(currentDraw) == null) {\n          \n          \n            \n                        ThingBuilder thingBuilder = editThing();\n          \n          \n            \n                        try {", "author": "cpmeister", "createdAt": "2020-04-04T20:39:08Z", "path": "bundles/org.openhab.binding.opensprinkler/src/main/java/org/openhab/binding/opensprinkler/internal/handler/OpenSprinklerDeviceHandler.java", "diffHunk": "@@ -36,20 +46,51 @@ public OpenSprinklerDeviceHandler(Thing thing) {\n \n     @Override\n     protected void updateChannel(ChannelUID channel) {\n-        switch (channel.getIdWithoutGroup()) {\n-            case SENSOR_RAIN:\n-                try {\n+        try {\n+            switch (channel.getIdWithoutGroup()) {\n+                case SENSOR_RAIN:\n                     if (getApi().isRainDetected()) {\n                         updateState(channel, OnOffType.ON);\n                     } else {\n                         updateState(channel, OnOffType.OFF);\n                     }\n-                } catch (CommunicationApiException e) {\n-                    logger.debug(\"Could not update rainsensor\", e);\n+                    break;\n+                case SENSOR_CURRENT_DRAW:\n+                    updateState(channel,\n+                            new QuantityType<ElectricCurrent>(getApi().currentDraw(), MILLI(SmartHomeUnits.AMPERE)));\n+                    break;\n+                default:\n+                    logger.debug(\"Not updating unknown channel {}\", channel);\n+            }\n+        } catch (CommunicationApiException | NoCurrentDrawSensorException e) {\n+            logger.debug(\"Could not update {}\", channel, e);\n+        }\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        ChannelUID currentDraw = new ChannelUID(thing.getUID(), \"currentDraw\");\n+        ThingBuilder thingBuilder = editThing();\n+        if (thing.getChannel(currentDraw) == null) {\n+            try {", "originalCommit": "a0428474430baae7f25d8e2082ba99655dc4527c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fa02943c0b5e94caffc9e7bcd123a356a17ec991", "url": "https://github.com/openhab/openhab-addons/commit/fa02943c0b5e94caffc9e7bcd123a356a17ec991", "message": "IMplement review comment\n\nSigned-off-by: Florian <florian.schmidt.welzow@t-online.de>", "committedDate": "2020-04-25T16:06:37Z", "type": "commit"}]}