{"pr_number": 8634, "pr_title": "[modbus] Add convenience class for ThingHandlers", "pr_createdAt": "2020-10-02T17:51:59Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8634", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0OTk2NA==", "url": "https://github.com/openhab/openhab-addons/pull/8634#discussion_r514449964", "bodyText": "huh?", "author": "ssalonen", "createdAt": "2020-10-29T17:45:03Z", "path": "bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.modbus.handler;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.core.thing.Bridge;\n+import org.openhab.core.thing.Thing;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingStatusDetail;\n+import org.openhab.core.thing.binding.BaseThingHandler;\n+import org.openhab.core.thing.binding.BridgeHandler;\n+import org.openhab.io.transport.modbus.ModbusCommunicationInterface;\n+import org.openhab.io.transport.modbus.ModbusFailureCallback;\n+import org.openhab.io.transport.modbus.ModbusReadCallback;\n+import org.openhab.io.transport.modbus.ModbusReadRequestBlueprint;\n+import org.openhab.io.transport.modbus.ModbusWriteCallback;\n+import org.openhab.io.transport.modbus.ModbusWriteRequestBlueprint;\n+import org.openhab.io.transport.modbus.PollTask;\n+\n+/**\n+ * This is a convenience class to interact with the Thing's {@link ModbusCommunicationInterface}.\n+ *\n+ * @author Fabian Wolter - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public abstract class BaseModbusThingHandler extends BaseThingHandler {\n+    private List<PollTask> periodicPollers = new ArrayList<>();\n+    private List<Future<?>> oneTimePollers = new ArrayList<>();\n+    private boolean initialized;\n+\n+    public BaseModbusThingHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    /**\n+     * This method must be invoked in the base class' initialize() method before any other initialization is done.\n+     * It will throw an unchecked exception if the {@link ModbusCommunicationInterface} is not accessible (fail-fast).\n+     * This prevents any further initialization of the Thing. The framework will set the ThingStatus to\n+     * HANDLER_INITIALIZING_ERROR and display an appropriate error message.\n+     */\n+    @Override\n+    public void initialize() {\n+        getModbus();\n+\n+        initialized = true;\n+    }\n+\n+    /**\n+     * Register regularly polled task. The method returns immediately, and the execution of the poll task will happen in\n+     * the background.\n+     *\n+     * One can register only one regular poll task for triplet of (endpoint, request, callback).\n+     *\n+     * @param request request to send\n+     * @param pollPeriodMillis poll interval, in milliseconds\n+     * @param initialDelayMillis initial delay before starting polling, in milliseconds\n+     * @param callback callback to call with data\n+     * @param callback callback to call in case of failure\n+     * @return poll task representing the regular poll\n+     * @throws IllegalStateException when this communication has been closed already\n+     */\n+    public PollTask registerRegularPoll(ModbusReadRequestBlueprint request, long pollPeriodMillis,\n+            long initialDelayMillis, ModbusReadCallback resultCallback,\n+            ModbusFailureCallback<ModbusReadRequestBlueprint> failureCallback) {\n+        checkInitialized();\n+\n+        PollTask task = getModbus().registerRegularPoll(request, pollPeriodMillis, initialDelayMillis, resultCallback,\n+                failureCallback);\n+        periodicPollers.add(task);\n+\n+        return task;\n+    }\n+\n+    /**\n+     * Unregister regularly polled task\n+     *\n+     * If this communication interface is closed already, the method returns immediately with false return value\n+     *\n+     * @param task poll task to unregister\n+     * @return whether poll task was unregistered. Poll task is not unregistered in case of unexpected errors or\n+     *         in the case where the poll task is not registered in the first place\n+     * @throws SBCException", "originalCommit": "662d864aaefab2d0ec87c69be22c427ec8494af8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ1MjkzNQ==", "url": "https://github.com/openhab/openhab-addons/pull/8634#discussion_r514452935", "bodyText": "I can see potential thread safety issues since the methods are not synchronised.\nEither use thread-safe collections or make methods concurrent?", "author": "ssalonen", "createdAt": "2020-10-29T17:49:20Z", "path": "bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.modbus.handler;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.core.thing.Bridge;\n+import org.openhab.core.thing.Thing;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingStatusDetail;\n+import org.openhab.core.thing.binding.BaseThingHandler;\n+import org.openhab.core.thing.binding.BridgeHandler;\n+import org.openhab.io.transport.modbus.ModbusCommunicationInterface;\n+import org.openhab.io.transport.modbus.ModbusFailureCallback;\n+import org.openhab.io.transport.modbus.ModbusReadCallback;\n+import org.openhab.io.transport.modbus.ModbusReadRequestBlueprint;\n+import org.openhab.io.transport.modbus.ModbusWriteCallback;\n+import org.openhab.io.transport.modbus.ModbusWriteRequestBlueprint;\n+import org.openhab.io.transport.modbus.PollTask;\n+\n+/**\n+ * This is a convenience class to interact with the Thing's {@link ModbusCommunicationInterface}.\n+ *\n+ * @author Fabian Wolter - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public abstract class BaseModbusThingHandler extends BaseThingHandler {\n+    private List<PollTask> periodicPollers = new ArrayList<>();", "originalCommit": "662d864aaefab2d0ec87c69be22c427ec8494af8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "48c54397fbde8ec7054d0cb290aab3e9e7a07a73", "url": "https://github.com/openhab/openhab-addons/commit/48c54397fbde8ec7054d0cb290aab3e9e7a07a73", "message": "[modbus] Add convenience class for ThingHandlers\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-11-01T15:54:53Z", "type": "commit"}, {"oid": "45ea109727d4695e1968e04c2bce004e7df2060f", "url": "https://github.com/openhab/openhab-addons/commit/45ea109727d4695e1968e04c2bce004e7df2060f", "message": "Address review findings\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-11-01T15:54:54Z", "type": "commit"}, {"oid": "45ea109727d4695e1968e04c2bce004e7df2060f", "url": "https://github.com/openhab/openhab-addons/commit/45ea109727d4695e1968e04c2bce004e7df2060f", "message": "Address review findings\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-11-01T15:54:54Z", "type": "forcePushed"}, {"oid": "0de60fead099068e573869ae5155f074b771f345", "url": "https://github.com/openhab/openhab-addons/commit/0de60fead099068e573869ae5155f074b771f345", "message": "Address review findings\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-11-01T17:16:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NTM3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/8634#discussion_r516895375", "bodyText": "Perhaps you could open in javadoc briefly how to use this and what the main benefit", "author": "ssalonen", "createdAt": "2020-11-03T19:09:42Z", "path": "bundles/org.openhab.binding.modbus/src/main/java/org/openhab/binding/modbus/handler/BaseModbusThingHandler.java", "diffHunk": "@@ -0,0 +1,212 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.modbus.handler;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.core.thing.Bridge;\n+import org.openhab.core.thing.Thing;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingStatusDetail;\n+import org.openhab.core.thing.binding.BaseThingHandler;\n+import org.openhab.core.thing.binding.BridgeHandler;\n+import org.openhab.io.transport.modbus.ModbusCommunicationInterface;\n+import org.openhab.io.transport.modbus.ModbusFailureCallback;\n+import org.openhab.io.transport.modbus.ModbusReadCallback;\n+import org.openhab.io.transport.modbus.ModbusReadRequestBlueprint;\n+import org.openhab.io.transport.modbus.ModbusWriteCallback;\n+import org.openhab.io.transport.modbus.ModbusWriteRequestBlueprint;\n+import org.openhab.io.transport.modbus.PollTask;\n+import org.openhab.io.transport.modbus.endpoint.ModbusSlaveEndpoint;\n+\n+/**\n+ * This is a convenience class to interact with the Thing's {@link ModbusCommunicationInterface}.\n+ *\n+ * @author Fabian Wolter - Initial contribution\n+ *\n+ */", "originalCommit": "0de60fead099068e573869ae5155f074b771f345", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDMzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/8634#discussion_r516900339", "bodyText": "You're right. I will update the dev documentation, too.", "author": "fwolter", "createdAt": "2020-11-03T19:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NTM3NQ=="}], "type": "inlineReview"}, {"oid": "b331ebf9dbf93954ba2f7bdb3bbacd8001debce8", "url": "https://github.com/openhab/openhab-addons/commit/b331ebf9dbf93954ba2f7bdb3bbacd8001debce8", "message": "Extend dev documentation\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-11-15T19:52:42Z", "type": "commit"}, {"oid": "fc61f890b33afa40bdbff07f3de7f64de73b8214", "url": "https://github.com/openhab/openhab-addons/commit/fc61f890b33afa40bdbff07f3de7f64de73b8214", "message": "Minor change\n\nSigned-off-by: Fabian Wolter <github@fabian-wolter.de>", "committedDate": "2020-11-22T08:52:59Z", "type": "commit"}]}