{"pr_number": 7235, "pr_title": "[influxdb] Added support for InfluxDB 2.0", "pr_createdAt": "2020-03-26T23:23:08Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7235", "timeline": [{"oid": "a1f04fbfb5843a3464277d351b728627f86c1132", "url": "https://github.com/openhab/openhab-addons/commit/a1f04fbfb5843a3464277d351b728627f86c1132", "message": "Add influxdb to bundles pom and minor fixes\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-03-27T18:35:04Z", "type": "forcePushed"}, {"oid": "c640b4b6b2626b2c8ddf0adb7e4d6ca626eaee5e", "url": "https://github.com/openhab/openhab-addons/commit/c640b4b6b2626b2c8ddf0adb7e4d6ca626eaee5e", "message": "Tunning formatter options to work as eclipse\nSolve static code analysis warnings\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-03-31T22:35:19Z", "type": "forcePushed"}, {"oid": "927f0802d3a7887adaa2d457161eb79b5ef478b2", "url": "https://github.com/openhab/openhab-addons/commit/927f0802d3a7887adaa2d457161eb79b5ef478b2", "message": "Initial contribution to InfluxDB 2.0 persistence addon\nThe addon is a complete refactor based on previous work on 1.0 addon\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:03:46Z", "type": "commit"}, {"oid": "4706d58d29766dced488cd56bbfff9f9a33abdd7", "url": "https://github.com/openhab/openhab-addons/commit/4706d58d29766dced488cd56bbfff9f9a33abdd7", "message": "Add influxdb to bundles pom and minor fixes\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:03:46Z", "type": "commit"}, {"oid": "493d75a37e7ae21af4f0d70fd1ecce975b9c97bf", "url": "https://github.com/openhab/openhab-addons/commit/493d75a37e7ae21af4f0d70fd1ecce975b9c97bf", "message": "Fix warning\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:03:46Z", "type": "commit"}, {"oid": "ddd44104ce4a902322022d5590c5bc19f460fb81", "url": "https://github.com/openhab/openhab-addons/commit/ddd44104ce4a902322022d5590c5bc19f460fb81", "message": "Refactor to be able to support several InfluxDB versions that use different clients.\nRepository interface has been refactored removing references to driver objects and code particular to each version is moved to repository and query creator interfaces.\nAdd dependencies for InfluxDB 1 client\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:03:46Z", "type": "commit"}, {"oid": "2183f16a0c697ca8a6d42b6d726322211afa4788", "url": "https://github.com/openhab/openhab-addons/commit/2183f16a0c697ca8a6d42b6d726322211afa4788", "message": "Fix SAT NPE and errors\n\nSigned-off-by: Wouter Born <github@maindrain.net>\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:11:06Z", "type": "commit"}, {"oid": "2b0df8931f9921320ff14f71e867380e79869938", "url": "https://github.com/openhab/openhab-addons/commit/2b0df8931f9921320ff14f71e867380e79869938", "message": "Add license headers and some class comments\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:11:07Z", "type": "commit"}, {"oid": "78a071c863c39fae2ddb7768cc292cd1e789c77c", "url": "https://github.com/openhab/openhab-addons/commit/78a071c863c39fae2ddb7768cc292cd1e789c77c", "message": "Added InfluxDB 1.0 implementation\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:11:07Z", "type": "commit"}, {"oid": "ca92627211c4d5e3218440ae427851a85938b2b8", "url": "https://github.com/openhab/openhab-addons/commit/ca92627211c4d5e3218440ae427851a85938b2b8", "message": "Tunning formatter options to work as eclipse\nSolve static code analysis warnings\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:11:08Z", "type": "commit"}, {"oid": "bd644aa78ea3ad6818f49cfa8a36c1909545e0e9", "url": "https://github.com/openhab/openhab-addons/commit/bd644aa78ea3ad6818f49cfa8a36c1909545e0e9", "message": "Add license header and fix static code analysis warning\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:17:12Z", "type": "commit"}, {"oid": "bd644aa78ea3ad6818f49cfa8a36c1909545e0e9", "url": "https://github.com/openhab/openhab-addons/commit/bd644aa78ea3ad6818f49cfa8a36c1909545e0e9", "message": "Add license header and fix static code analysis warning\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T20:17:12Z", "type": "forcePushed"}, {"oid": "080f31efa81a12a661a00e29723c9781751dedf7", "url": "https://github.com/openhab/openhab-addons/commit/080f31efa81a12a661a00e29723c9781751dedf7", "message": "Rename addon to influxdb overwritting previous one\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T21:34:12Z", "type": "commit"}, {"oid": "c4912e48d61c9226920ef5f89c6ccde8e4726a4e", "url": "https://github.com/openhab/openhab-addons/commit/c4912e48d61c9226920ef5f89c6ccde8e4726a4e", "message": "Some minor fixes after merging name with existing influxdb addon\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-01T21:52:57Z", "type": "commit"}, {"oid": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "url": "https://github.com/openhab/openhab-addons/commit/535708b5a6b698e4eb8afc7d65319fe17a5abff8", "message": "Force checking connection status on connect\nStyle and warning fixes\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-02T21:29:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0NjE5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402646197", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.warn(\"{} {}\", msg, reason.toString());\n          \n          \n            \n                        logger.warn(\"{} {}\", msg, reason);", "author": "cpmeister", "createdAt": "2020-04-02T23:05:40Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBConfiguration.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.StringJoiner;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Contains this addon configurable parameters\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class InfluxDBConfiguration {\n+    public static final String URL_PARAM = \"url\";\n+    public static final String TOKEN_PARAM = \"token\";\n+    public static final String USER_PARAM = \"user\";\n+    public static final String PASSWORD_PARAM = \"password\";\n+    public static final String DATABASE_PARAM = \"db\";\n+    public static final String RETENTION_POLICY_PARAM = \"retentionPolicy\";\n+    public static final String VERSION_PARAM = \"version\";\n+    public static final String REPLACE_UNDERSCORE_PARAM = \"replaceUnderscore\";\n+    public static final String ADD_CATEGORY_TAG_PARAM = \"addCategoryTag\";\n+    public static final String ADD_LABEL_TAG_PARAM = \"addLabelTag\";\n+    public static final String ADD_TYPE_TAG_PARAM = \"addTypeTag\";\n+    public static InfluxDBConfiguration NO_CONFIGURATION = new InfluxDBConfiguration(Collections.emptyMap());\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDBConfiguration.class);\n+    private String url;\n+    private String user;\n+    private String password;\n+    private String token;\n+    private String databaseName;\n+    private String retentionPolicy;\n+    private InfluxDBVersion version;\n+\n+    private boolean replaceUnderscore;\n+    private boolean addCategoryTag;\n+    private boolean addTypeTag;\n+    private boolean addLabelTag;\n+\n+    @SuppressWarnings(\"null\")\n+    public InfluxDBConfiguration(Map<String, @Nullable Object> config) {\n+        url = (String) config.getOrDefault(URL_PARAM, \"http://127.0.0.1:8086\");\n+        user = (String) config.getOrDefault(USER_PARAM, \"openhab\");\n+        password = (String) config.getOrDefault(PASSWORD_PARAM, \"\");\n+        token = (String) config.getOrDefault(TOKEN_PARAM, \"\");\n+        databaseName = (String) config.getOrDefault(DATABASE_PARAM, \"openhab\");\n+        retentionPolicy = (String) config.getOrDefault(RETENTION_POLICY_PARAM, \"autogen\");\n+        version = parseInfluxVersion(config.getOrDefault(VERSION_PARAM, InfluxDBVersion.V1.name()));\n+\n+        replaceUnderscore = getConfigBooleanValue(config, REPLACE_UNDERSCORE_PARAM, false);\n+        addCategoryTag = getConfigBooleanValue(config, ADD_CATEGORY_TAG_PARAM, false);\n+        addLabelTag = getConfigBooleanValue(config, ADD_LABEL_TAG_PARAM, false);\n+        addTypeTag = getConfigBooleanValue(config, ADD_TYPE_TAG_PARAM, false);\n+    }\n+\n+    private static boolean getConfigBooleanValue(Map<String, @Nullable Object> config, String key,\n+            boolean defaultValue) {\n+        Object object = config.get(key);\n+\n+        if (object instanceof Boolean) {\n+            return (Boolean) object;\n+        } else if (object != null) {\n+            return \"true\".equalsIgnoreCase((String) object);\n+        } else {\n+            return defaultValue;\n+        }\n+    }\n+\n+    private InfluxDBVersion parseInfluxVersion(@Nullable Object value) {\n+        try {\n+            return InfluxDBVersion.valueOf((String) value);\n+        } catch (RuntimeException e) {\n+            logger.warn(\"Invalid version {}\", value);\n+            return InfluxDBVersion.UNKNOWN;\n+        }\n+    }\n+\n+    public boolean isValid() {\n+        boolean hasVersion = version != InfluxDBVersion.UNKNOWN;\n+        boolean hasCredentials = false;\n+        if (version == InfluxDBVersion.V1) {\n+            hasCredentials = StringUtils.isNotBlank(user) && StringUtils.isNotBlank(password);\n+        } else if (version == InfluxDBVersion.V2) {\n+            hasCredentials = StringUtils.isNotBlank(token)\n+                    || (StringUtils.isNotBlank(user) && StringUtils.isNotBlank(password));\n+        }\n+        boolean hasDatabase = StringUtils.isNotBlank(databaseName);\n+        boolean hasRetentionPolicy = StringUtils.isNotBlank(retentionPolicy);\n+\n+        boolean valid = hasVersion && hasCredentials && hasDatabase && hasRetentionPolicy;\n+        if (valid) {\n+            return true;\n+        } else {\n+            String msg = \"InfluxDB configuration isn't valid. Addon won't work: \";\n+            StringJoiner reason = new StringJoiner(\",\");\n+            if (!hasVersion) {\n+                reason.add(\"Unknown version\");\n+            } else {\n+                if (!hasCredentials)\n+                    reason.add(\"No credentials\");\n+                if (!hasDatabase)\n+                    reason.add(\"No database name / organization defined\");\n+                if (!hasRetentionPolicy)\n+                    reason.add(\"No retention policy / bucket defined\");\n+            }\n+            logger.warn(\"{} {}\", msg, reason.toString());", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0NjY2NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402646665", "bodyText": "This needs to be run through the formatter. It is missing brackets.", "author": "cpmeister", "createdAt": "2020-04-02T23:07:06Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBConfiguration.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.StringJoiner;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Contains this addon configurable parameters\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class InfluxDBConfiguration {\n+    public static final String URL_PARAM = \"url\";\n+    public static final String TOKEN_PARAM = \"token\";\n+    public static final String USER_PARAM = \"user\";\n+    public static final String PASSWORD_PARAM = \"password\";\n+    public static final String DATABASE_PARAM = \"db\";\n+    public static final String RETENTION_POLICY_PARAM = \"retentionPolicy\";\n+    public static final String VERSION_PARAM = \"version\";\n+    public static final String REPLACE_UNDERSCORE_PARAM = \"replaceUnderscore\";\n+    public static final String ADD_CATEGORY_TAG_PARAM = \"addCategoryTag\";\n+    public static final String ADD_LABEL_TAG_PARAM = \"addLabelTag\";\n+    public static final String ADD_TYPE_TAG_PARAM = \"addTypeTag\";\n+    public static InfluxDBConfiguration NO_CONFIGURATION = new InfluxDBConfiguration(Collections.emptyMap());\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDBConfiguration.class);\n+    private String url;\n+    private String user;\n+    private String password;\n+    private String token;\n+    private String databaseName;\n+    private String retentionPolicy;\n+    private InfluxDBVersion version;\n+\n+    private boolean replaceUnderscore;\n+    private boolean addCategoryTag;\n+    private boolean addTypeTag;\n+    private boolean addLabelTag;\n+\n+    @SuppressWarnings(\"null\")\n+    public InfluxDBConfiguration(Map<String, @Nullable Object> config) {\n+        url = (String) config.getOrDefault(URL_PARAM, \"http://127.0.0.1:8086\");\n+        user = (String) config.getOrDefault(USER_PARAM, \"openhab\");\n+        password = (String) config.getOrDefault(PASSWORD_PARAM, \"\");\n+        token = (String) config.getOrDefault(TOKEN_PARAM, \"\");\n+        databaseName = (String) config.getOrDefault(DATABASE_PARAM, \"openhab\");\n+        retentionPolicy = (String) config.getOrDefault(RETENTION_POLICY_PARAM, \"autogen\");\n+        version = parseInfluxVersion(config.getOrDefault(VERSION_PARAM, InfluxDBVersion.V1.name()));\n+\n+        replaceUnderscore = getConfigBooleanValue(config, REPLACE_UNDERSCORE_PARAM, false);\n+        addCategoryTag = getConfigBooleanValue(config, ADD_CATEGORY_TAG_PARAM, false);\n+        addLabelTag = getConfigBooleanValue(config, ADD_LABEL_TAG_PARAM, false);\n+        addTypeTag = getConfigBooleanValue(config, ADD_TYPE_TAG_PARAM, false);\n+    }\n+\n+    private static boolean getConfigBooleanValue(Map<String, @Nullable Object> config, String key,\n+            boolean defaultValue) {\n+        Object object = config.get(key);\n+\n+        if (object instanceof Boolean) {\n+            return (Boolean) object;\n+        } else if (object != null) {\n+            return \"true\".equalsIgnoreCase((String) object);\n+        } else {\n+            return defaultValue;\n+        }\n+    }\n+\n+    private InfluxDBVersion parseInfluxVersion(@Nullable Object value) {\n+        try {\n+            return InfluxDBVersion.valueOf((String) value);\n+        } catch (RuntimeException e) {\n+            logger.warn(\"Invalid version {}\", value);\n+            return InfluxDBVersion.UNKNOWN;\n+        }\n+    }\n+\n+    public boolean isValid() {\n+        boolean hasVersion = version != InfluxDBVersion.UNKNOWN;\n+        boolean hasCredentials = false;\n+        if (version == InfluxDBVersion.V1) {\n+            hasCredentials = StringUtils.isNotBlank(user) && StringUtils.isNotBlank(password);\n+        } else if (version == InfluxDBVersion.V2) {\n+            hasCredentials = StringUtils.isNotBlank(token)\n+                    || (StringUtils.isNotBlank(user) && StringUtils.isNotBlank(password));\n+        }\n+        boolean hasDatabase = StringUtils.isNotBlank(databaseName);\n+        boolean hasRetentionPolicy = StringUtils.isNotBlank(retentionPolicy);\n+\n+        boolean valid = hasVersion && hasCredentials && hasDatabase && hasRetentionPolicy;\n+        if (valid) {\n+            return true;\n+        } else {\n+            String msg = \"InfluxDB configuration isn't valid. Addon won't work: \";\n+            StringJoiner reason = new StringJoiner(\",\");\n+            if (!hasVersion) {\n+                reason.add(\"Unknown version\");\n+            } else {\n+                if (!hasCredentials)\n+                    reason.add(\"No credentials\");\n+                if (!hasDatabase)\n+                    reason.add(\"No database name / organization defined\");\n+                if (!hasRetentionPolicy)\n+                    reason.add(\"No retention policy / bucket defined\");", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0NzY2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402647666", "bodyText": "Looked like the annotation was flying away there.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Activate\n          \n          \n            \n                /**\n          \n          \n            \n                 * Connect to database when service is activated\n          \n          \n            \n                 */\n          \n          \n            \n                public void activate(final @Nullable Map<String, @Nullable Object> config) {\n          \n          \n            \n                /**\n          \n          \n            \n                 * Connect to database when service is activated\n          \n          \n            \n                 */\n          \n          \n            \n                 @Activate\n          \n          \n            \n                public void activate(final @Nullable Map<String, @Nullable Object> config) {", "author": "cpmeister", "createdAt": "2020-04-02T23:09:57Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/InfluxDBPersistenceService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb;\n+\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.jetbrains.annotations.NotNull;\n+import org.openhab.core.config.core.ConfigurableService;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.persistence.FilterCriteria;\n+import org.openhab.core.persistence.HistoricItem;\n+import org.openhab.core.persistence.PersistenceItemInfo;\n+import org.openhab.core.persistence.PersistenceService;\n+import org.openhab.core.persistence.QueryablePersistenceService;\n+import org.openhab.core.persistence.strategy.PersistenceStrategy;\n+import org.openhab.core.types.State;\n+import org.openhab.persistence.influxdb.internal.FilterCriteriaQueryCreator;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBHistoricItem;\n+import org.openhab.persistence.influxdb.internal.InfluxDBPersistentItemInfo;\n+import org.openhab.persistence.influxdb.internal.InfluxDBRepository;\n+import org.openhab.persistence.influxdb.internal.InfluxDBStateConvertUtils;\n+import org.openhab.persistence.influxdb.internal.InfluxPoint;\n+import org.openhab.persistence.influxdb.internal.InfluxRow;\n+import org.openhab.persistence.influxdb.internal.ItemToStorePointCreator;\n+import org.openhab.persistence.influxdb.internal.RepositoryFactory;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Modified;\n+import org.osgi.service.component.annotations.Reference;\n+import org.osgi.service.component.annotations.ReferenceCardinality;\n+import org.osgi.service.component.annotations.ReferencePolicy;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is the implementation of the InfluxDB {@link PersistenceService}. It persists item values\n+ * using the <a href=\"http://influxdb.org\">InfluxDB time series database. The states (\n+ * {@link State}) of an {@link Item} are persisted by default in a time series with names equal to the name of\n+ * the item.\n+ *\n+ * This addon supports 1.X and 2.X versions, as two versions are incompatible and use different drivers the\n+ * specific code for each version is accessed by {@link InfluxDBRepository} and {@link FilterCriteriaQueryCreator}\n+ * interfaces and specific implementation reside in {@link org.openhab.persistence.influxdb.internal.influx1} and\n+ * {@link org.openhab.persistence.influxdb.internal.influx2} packages\n+ *\n+ * @author Theo Weiss - Initial contribution, rewrite of org.openhab.persistence.influxdb\n+ * @author Joan Pujol Espinar - Addon rewrite refactoring code and adding support for InfluxDB 2.0. Some tag code is\n+ *         based\n+ *         from not integrated branch from Dominik Vorreiter\n+ */\n+@NonNullByDefault\n+@Component(service = { PersistenceService.class,\n+        QueryablePersistenceService.class }, configurationPid = \"org.openhab.influxdb\", property = {\n+                Constants.SERVICE_PID + \"=org.openhab.influxdb\",\n+                ConfigurableService.SERVICE_PROPERTY_DESCRIPTION_URI + \"=persistence:influxdb\",\n+                ConfigurableService.SERVICE_PROPERTY_LABEL + \"=InfluxDB persistence layer\",\n+                ConfigurableService.SERVICE_PROPERTY_CATEGORY + \"=persistence\" })\n+public class InfluxDBPersistenceService implements QueryablePersistenceService {\n+    public static final String SERVICE_NAME = \"influxdb\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDBPersistenceService.class);\n+\n+    // External dependencies\n+    @Nullable\n+    private ItemRegistry itemRegistry;\n+    @Nullable\n+    private MetadataRegistry metadataRegistry;\n+\n+    // Internal dependencies/state\n+    private InfluxDBConfiguration configuration = InfluxDBConfiguration.NO_CONFIGURATION;\n+    @NonNullByDefault({}) // Relax rules because can only be null if component is not active\n+    private ItemToStorePointCreator itemToStorePointCreator;\n+    @NonNullByDefault({}) // Relax rules because can only be null if component is not active\n+    private InfluxDBRepository influxDBRepository;\n+\n+    @Activate\n+    /**\n+     * Connect to database when service is activated\n+     */\n+    public void activate(final @Nullable Map<String, @Nullable Object> config) {", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0Nzg4NA==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402647884", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                private ItemRegistry itemRegistry;\n          \n          \n            \n                @Nullable\n          \n          \n            \n                private MetadataRegistry metadataRegistry;\n          \n          \n            \n                private @Nullable ItemRegistry itemRegistry;\n          \n          \n            \n                private @Nullable MetadataRegistry metadataRegistry;", "author": "cpmeister", "createdAt": "2020-04-02T23:10:40Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/InfluxDBPersistenceService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb;\n+\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.jetbrains.annotations.NotNull;\n+import org.openhab.core.config.core.ConfigurableService;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.persistence.FilterCriteria;\n+import org.openhab.core.persistence.HistoricItem;\n+import org.openhab.core.persistence.PersistenceItemInfo;\n+import org.openhab.core.persistence.PersistenceService;\n+import org.openhab.core.persistence.QueryablePersistenceService;\n+import org.openhab.core.persistence.strategy.PersistenceStrategy;\n+import org.openhab.core.types.State;\n+import org.openhab.persistence.influxdb.internal.FilterCriteriaQueryCreator;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBHistoricItem;\n+import org.openhab.persistence.influxdb.internal.InfluxDBPersistentItemInfo;\n+import org.openhab.persistence.influxdb.internal.InfluxDBRepository;\n+import org.openhab.persistence.influxdb.internal.InfluxDBStateConvertUtils;\n+import org.openhab.persistence.influxdb.internal.InfluxPoint;\n+import org.openhab.persistence.influxdb.internal.InfluxRow;\n+import org.openhab.persistence.influxdb.internal.ItemToStorePointCreator;\n+import org.openhab.persistence.influxdb.internal.RepositoryFactory;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Modified;\n+import org.osgi.service.component.annotations.Reference;\n+import org.osgi.service.component.annotations.ReferenceCardinality;\n+import org.osgi.service.component.annotations.ReferencePolicy;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is the implementation of the InfluxDB {@link PersistenceService}. It persists item values\n+ * using the <a href=\"http://influxdb.org\">InfluxDB time series database. The states (\n+ * {@link State}) of an {@link Item} are persisted by default in a time series with names equal to the name of\n+ * the item.\n+ *\n+ * This addon supports 1.X and 2.X versions, as two versions are incompatible and use different drivers the\n+ * specific code for each version is accessed by {@link InfluxDBRepository} and {@link FilterCriteriaQueryCreator}\n+ * interfaces and specific implementation reside in {@link org.openhab.persistence.influxdb.internal.influx1} and\n+ * {@link org.openhab.persistence.influxdb.internal.influx2} packages\n+ *\n+ * @author Theo Weiss - Initial contribution, rewrite of org.openhab.persistence.influxdb\n+ * @author Joan Pujol Espinar - Addon rewrite refactoring code and adding support for InfluxDB 2.0. Some tag code is\n+ *         based\n+ *         from not integrated branch from Dominik Vorreiter\n+ */\n+@NonNullByDefault\n+@Component(service = { PersistenceService.class,\n+        QueryablePersistenceService.class }, configurationPid = \"org.openhab.influxdb\", property = {\n+                Constants.SERVICE_PID + \"=org.openhab.influxdb\",\n+                ConfigurableService.SERVICE_PROPERTY_DESCRIPTION_URI + \"=persistence:influxdb\",\n+                ConfigurableService.SERVICE_PROPERTY_LABEL + \"=InfluxDB persistence layer\",\n+                ConfigurableService.SERVICE_PROPERTY_CATEGORY + \"=persistence\" })\n+public class InfluxDBPersistenceService implements QueryablePersistenceService {\n+    public static final String SERVICE_NAME = \"influxdb\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDBPersistenceService.class);\n+\n+    // External dependencies\n+    @Nullable\n+    private ItemRegistry itemRegistry;\n+    @Nullable\n+    private MetadataRegistry metadataRegistry;", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0ODA4OA==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402648088", "bodyText": "Doesn't logging this as info have the potential to flood the logs?", "author": "cpmeister", "createdAt": "2020-04-02T23:11:24Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/InfluxDBPersistenceService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb;\n+\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.jetbrains.annotations.NotNull;\n+import org.openhab.core.config.core.ConfigurableService;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.persistence.FilterCriteria;\n+import org.openhab.core.persistence.HistoricItem;\n+import org.openhab.core.persistence.PersistenceItemInfo;\n+import org.openhab.core.persistence.PersistenceService;\n+import org.openhab.core.persistence.QueryablePersistenceService;\n+import org.openhab.core.persistence.strategy.PersistenceStrategy;\n+import org.openhab.core.types.State;\n+import org.openhab.persistence.influxdb.internal.FilterCriteriaQueryCreator;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBHistoricItem;\n+import org.openhab.persistence.influxdb.internal.InfluxDBPersistentItemInfo;\n+import org.openhab.persistence.influxdb.internal.InfluxDBRepository;\n+import org.openhab.persistence.influxdb.internal.InfluxDBStateConvertUtils;\n+import org.openhab.persistence.influxdb.internal.InfluxPoint;\n+import org.openhab.persistence.influxdb.internal.InfluxRow;\n+import org.openhab.persistence.influxdb.internal.ItemToStorePointCreator;\n+import org.openhab.persistence.influxdb.internal.RepositoryFactory;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Modified;\n+import org.osgi.service.component.annotations.Reference;\n+import org.osgi.service.component.annotations.ReferenceCardinality;\n+import org.osgi.service.component.annotations.ReferencePolicy;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is the implementation of the InfluxDB {@link PersistenceService}. It persists item values\n+ * using the <a href=\"http://influxdb.org\">InfluxDB time series database. The states (\n+ * {@link State}) of an {@link Item} are persisted by default in a time series with names equal to the name of\n+ * the item.\n+ *\n+ * This addon supports 1.X and 2.X versions, as two versions are incompatible and use different drivers the\n+ * specific code for each version is accessed by {@link InfluxDBRepository} and {@link FilterCriteriaQueryCreator}\n+ * interfaces and specific implementation reside in {@link org.openhab.persistence.influxdb.internal.influx1} and\n+ * {@link org.openhab.persistence.influxdb.internal.influx2} packages\n+ *\n+ * @author Theo Weiss - Initial contribution, rewrite of org.openhab.persistence.influxdb\n+ * @author Joan Pujol Espinar - Addon rewrite refactoring code and adding support for InfluxDB 2.0. Some tag code is\n+ *         based\n+ *         from not integrated branch from Dominik Vorreiter\n+ */\n+@NonNullByDefault\n+@Component(service = { PersistenceService.class,\n+        QueryablePersistenceService.class }, configurationPid = \"org.openhab.influxdb\", property = {\n+                Constants.SERVICE_PID + \"=org.openhab.influxdb\",\n+                ConfigurableService.SERVICE_PROPERTY_DESCRIPTION_URI + \"=persistence:influxdb\",\n+                ConfigurableService.SERVICE_PROPERTY_LABEL + \"=InfluxDB persistence layer\",\n+                ConfigurableService.SERVICE_PROPERTY_CATEGORY + \"=persistence\" })\n+public class InfluxDBPersistenceService implements QueryablePersistenceService {\n+    public static final String SERVICE_NAME = \"influxdb\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDBPersistenceService.class);\n+\n+    // External dependencies\n+    @Nullable\n+    private ItemRegistry itemRegistry;\n+    @Nullable\n+    private MetadataRegistry metadataRegistry;\n+\n+    // Internal dependencies/state\n+    private InfluxDBConfiguration configuration = InfluxDBConfiguration.NO_CONFIGURATION;\n+    @NonNullByDefault({}) // Relax rules because can only be null if component is not active\n+    private ItemToStorePointCreator itemToStorePointCreator;\n+    @NonNullByDefault({}) // Relax rules because can only be null if component is not active\n+    private InfluxDBRepository influxDBRepository;\n+\n+    @Activate\n+    /**\n+     * Connect to database when service is activated\n+     */\n+    public void activate(final @Nullable Map<String, @Nullable Object> config) {\n+        logger.debug(\"InfluxDB persistence service is being activated\");\n+\n+        if (loadConfiguration(config)) {\n+            itemToStorePointCreator = new ItemToStorePointCreator(configuration, metadataRegistry);\n+            influxDBRepository = createInfluxDBRepository();\n+            influxDBRepository.connect();\n+        } else {\n+            logger.error(\"Cannot load configuration, persistence service wont work\");\n+        }\n+\n+        logger.debug(\"InfluxDB persistence service is now activated\");\n+    }\n+\n+    @NotNull\n+    // Visible for testing\n+    protected InfluxDBRepository createInfluxDBRepository() {\n+        return RepositoryFactory.createRepository(configuration);\n+    }\n+\n+    @Deactivate\n+    /**\n+     * Disconnect from database when service is deactivated\n+     */\n+    public void deactivate() {\n+        logger.debug(\"InfluxDB persistence service deactivated\");\n+        if (influxDBRepository != null) {\n+            influxDBRepository.disconnect();\n+            influxDBRepository = null;\n+        }\n+        if (itemToStorePointCreator != null) {\n+            itemToStorePointCreator = null;\n+        }\n+    }\n+\n+    @Modified\n+    /**\n+     * Rerun deactivation/activation code each time configuration is changed\n+     */\n+    protected void modified(@Nullable Map<String, @Nullable Object> config) {\n+        if (config != null) {\n+            logger.debug(\"Config has been modified will deactivate/activate with new config\");\n+\n+            deactivate();\n+            activate(config);\n+        } else {\n+            logger.warn(\"Null configuration, ignoring\");\n+        }\n+    }\n+\n+    private boolean loadConfiguration(@Nullable Map<String, @Nullable Object> config) {\n+        boolean configurationIsValid;\n+        if (config != null) {\n+            configuration = new InfluxDBConfiguration(config);\n+            configurationIsValid = configuration.isValid();\n+            if (configurationIsValid) {\n+                logger.debug(\"Loaded configuration {}\", config);\n+            } else {\n+                logger.warn(\"Some configuration properties are not valid {}\", config);\n+            }\n+        } else {\n+            configuration = InfluxDBConfiguration.NO_CONFIGURATION;\n+            configurationIsValid = false;\n+            logger.warn(\"Ignoring configuration because it's null\");\n+        }\n+        return configurationIsValid;\n+    }\n+\n+    @Override\n+    public String getId() {\n+        return SERVICE_NAME;\n+    }\n+\n+    @Override\n+    public String getLabel(@Nullable Locale locale) {\n+        return \"InfluxDB persistence layer\";\n+    }\n+\n+    @Override\n+    public Set<PersistenceItemInfo> getItemInfo() {\n+        if (influxDBRepository != null && influxDBRepository.isConnected()) {\n+            return influxDBRepository.getStoredItemsCount().entrySet().stream()\n+                    .map(entry -> new InfluxDBPersistentItemInfo(entry.getKey(), entry.getValue()))\n+                    .collect(Collectors.toSet());\n+        } else {\n+            logger.info(\"getItemInfo ignored, InfluxDB is not yet connected\");\n+            return Collections.emptySet();\n+        }\n+    }\n+\n+    @Override\n+    public void store(Item item) {\n+        store(item, item.getName());\n+    }\n+\n+    @Override\n+    public void store(Item item, @Nullable String alias) {\n+        if (influxDBRepository != null && influxDBRepository.isConnected()) {\n+            InfluxPoint point = itemToStorePointCreator.convert(item, alias);\n+            if (point != null) {\n+                logger.trace(\"Storing item {} in InfluxDB point {}\", item, point);\n+                influxDBRepository.write(point);\n+            } else {\n+                logger.trace(\"Ignoring item {} as is cannot be converted to a InfluxDB point\", item);\n+            }\n+        } else {\n+            logger.info(\"store ignored, InfluxDB is not yet connected\");\n+        }\n+    }\n+\n+    @Override\n+    public Iterable<HistoricItem> query(FilterCriteria filter) {\n+        logger.debug(\"Got a query for historic points!\");\n+\n+        if (influxDBRepository != null && influxDBRepository.isConnected()) {\n+            logger.trace(\n+                    \"Filter: itemname: {}, ordering: {}, state: {},  operator: {}, getBeginDate: {}, getEndDate: {}, getPageSize: {}, getPageNumber: {}\",\n+                    filter.getItemName(), filter.getOrdering().toString(), filter.getState(), filter.getOperator(),\n+                    filter.getBeginDateZoned(), filter.getEndDateZoned(), filter.getPageSize(), filter.getPageNumber());\n+\n+            String query = RepositoryFactory.createQueryCreator(configuration).createQuery(filter,\n+                    configuration.getRetentionPolicy());\n+            List<InfluxRow> results = influxDBRepository.query(query);\n+            return results.stream().map(this::mapRow2HistoricItem).collect(Collectors.toList());\n+        } else {\n+            logger.info(\"query ignored, InfluxDB is not yet connected\");", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0ODUwNA==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402648504", "bodyText": "can these be made final?", "author": "cpmeister", "createdAt": "2020-04-02T23:12:43Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBConfiguration.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.StringJoiner;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Contains this addon configurable parameters\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class InfluxDBConfiguration {\n+    public static final String URL_PARAM = \"url\";\n+    public static final String TOKEN_PARAM = \"token\";\n+    public static final String USER_PARAM = \"user\";\n+    public static final String PASSWORD_PARAM = \"password\";\n+    public static final String DATABASE_PARAM = \"db\";\n+    public static final String RETENTION_POLICY_PARAM = \"retentionPolicy\";\n+    public static final String VERSION_PARAM = \"version\";\n+    public static final String REPLACE_UNDERSCORE_PARAM = \"replaceUnderscore\";\n+    public static final String ADD_CATEGORY_TAG_PARAM = \"addCategoryTag\";\n+    public static final String ADD_LABEL_TAG_PARAM = \"addLabelTag\";\n+    public static final String ADD_TYPE_TAG_PARAM = \"addTypeTag\";\n+    public static InfluxDBConfiguration NO_CONFIGURATION = new InfluxDBConfiguration(Collections.emptyMap());\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDBConfiguration.class);\n+    private String url;\n+    private String user;\n+    private String password;\n+    private String token;\n+    private String databaseName;\n+    private String retentionPolicy;\n+    private InfluxDBVersion version;\n+\n+    private boolean replaceUnderscore;\n+    private boolean addCategoryTag;\n+    private boolean addTypeTag;\n+    private boolean addLabelTag;", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0ODg3MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402648871", "bodyText": "The if block already returns, so using an else here is redundant. Also, less indentation looks better \ud83d\ude04", "author": "cpmeister", "createdAt": "2020-04-02T23:13:52Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBConfiguration.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.StringJoiner;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Contains this addon configurable parameters\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class InfluxDBConfiguration {\n+    public static final String URL_PARAM = \"url\";\n+    public static final String TOKEN_PARAM = \"token\";\n+    public static final String USER_PARAM = \"user\";\n+    public static final String PASSWORD_PARAM = \"password\";\n+    public static final String DATABASE_PARAM = \"db\";\n+    public static final String RETENTION_POLICY_PARAM = \"retentionPolicy\";\n+    public static final String VERSION_PARAM = \"version\";\n+    public static final String REPLACE_UNDERSCORE_PARAM = \"replaceUnderscore\";\n+    public static final String ADD_CATEGORY_TAG_PARAM = \"addCategoryTag\";\n+    public static final String ADD_LABEL_TAG_PARAM = \"addLabelTag\";\n+    public static final String ADD_TYPE_TAG_PARAM = \"addTypeTag\";\n+    public static InfluxDBConfiguration NO_CONFIGURATION = new InfluxDBConfiguration(Collections.emptyMap());\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDBConfiguration.class);\n+    private String url;\n+    private String user;\n+    private String password;\n+    private String token;\n+    private String databaseName;\n+    private String retentionPolicy;\n+    private InfluxDBVersion version;\n+\n+    private boolean replaceUnderscore;\n+    private boolean addCategoryTag;\n+    private boolean addTypeTag;\n+    private boolean addLabelTag;\n+\n+    @SuppressWarnings(\"null\")\n+    public InfluxDBConfiguration(Map<String, @Nullable Object> config) {\n+        url = (String) config.getOrDefault(URL_PARAM, \"http://127.0.0.1:8086\");\n+        user = (String) config.getOrDefault(USER_PARAM, \"openhab\");\n+        password = (String) config.getOrDefault(PASSWORD_PARAM, \"\");\n+        token = (String) config.getOrDefault(TOKEN_PARAM, \"\");\n+        databaseName = (String) config.getOrDefault(DATABASE_PARAM, \"openhab\");\n+        retentionPolicy = (String) config.getOrDefault(RETENTION_POLICY_PARAM, \"autogen\");\n+        version = parseInfluxVersion(config.getOrDefault(VERSION_PARAM, InfluxDBVersion.V1.name()));\n+\n+        replaceUnderscore = getConfigBooleanValue(config, REPLACE_UNDERSCORE_PARAM, false);\n+        addCategoryTag = getConfigBooleanValue(config, ADD_CATEGORY_TAG_PARAM, false);\n+        addLabelTag = getConfigBooleanValue(config, ADD_LABEL_TAG_PARAM, false);\n+        addTypeTag = getConfigBooleanValue(config, ADD_TYPE_TAG_PARAM, false);\n+    }\n+\n+    private static boolean getConfigBooleanValue(Map<String, @Nullable Object> config, String key,\n+            boolean defaultValue) {\n+        Object object = config.get(key);\n+\n+        if (object instanceof Boolean) {\n+            return (Boolean) object;\n+        } else if (object != null) {\n+            return \"true\".equalsIgnoreCase((String) object);\n+        } else {\n+            return defaultValue;\n+        }\n+    }\n+\n+    private InfluxDBVersion parseInfluxVersion(@Nullable Object value) {\n+        try {\n+            return InfluxDBVersion.valueOf((String) value);\n+        } catch (RuntimeException e) {\n+            logger.warn(\"Invalid version {}\", value);\n+            return InfluxDBVersion.UNKNOWN;\n+        }\n+    }\n+\n+    public boolean isValid() {\n+        boolean hasVersion = version != InfluxDBVersion.UNKNOWN;\n+        boolean hasCredentials = false;\n+        if (version == InfluxDBVersion.V1) {\n+            hasCredentials = StringUtils.isNotBlank(user) && StringUtils.isNotBlank(password);\n+        } else if (version == InfluxDBVersion.V2) {\n+            hasCredentials = StringUtils.isNotBlank(token)\n+                    || (StringUtils.isNotBlank(user) && StringUtils.isNotBlank(password));\n+        }\n+        boolean hasDatabase = StringUtils.isNotBlank(databaseName);\n+        boolean hasRetentionPolicy = StringUtils.isNotBlank(retentionPolicy);\n+\n+        boolean valid = hasVersion && hasCredentials && hasDatabase && hasRetentionPolicy;\n+        if (valid) {\n+            return true;\n+        } else {", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAxODkzMw==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403018933", "bodyText": "This one breaks my heart,  I really don't like non-symmetric ifs.\nBut no problem adapting that if this is codebase style.", "author": "lujop", "createdAt": "2020-04-03T13:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0ODg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1NzE5MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403057191", "bodyText": "Keep it as is then, I don't want to break your heart. \ud83d\ude09", "author": "cpmeister", "createdAt": "2020-04-03T14:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0ODg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0OTE2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402649163", "bodyText": "Initial contribution might not be the right description on this file...", "author": "cpmeister", "createdAt": "2020-04-02T23:14:46Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBHistoricItem.java", "diffHunk": "@@ -18,21 +18,26 @@\n import org.eclipse.jdt.annotation.NonNullByDefault;\n import org.openhab.core.persistence.HistoricItem;\n import org.openhab.core.types.State;\n+import org.openhab.core.types.UnDefType;\n \n /**\n- * This is a Java bean used to return historic items from Influxdb.\n+ * Java bean used to return items queries results from InfluxDB.\n  *\n  * @author Theo Weiss - Initial Contribution\n- *\n+ * @author Joan Pujol Espinar - Initial contribution", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1MDQ2NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402650465", "bodyText": "Why is the getter nullable when the field is not?", "author": "cpmeister", "createdAt": "2020-04-02T23:18:48Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBPersistentItemInfo.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import java.util.Date;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.persistence.PersistenceItemInfo;\n+\n+/**\n+ * Java bean used to return information about stored items\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class InfluxDBPersistentItemInfo implements PersistenceItemInfo {\n+    private final String name;\n+    private final Integer count;\n+\n+    public InfluxDBPersistentItemInfo(String name, Integer count) {\n+        this.name = name;\n+        this.count = count;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return name;\n+    }\n+\n+    @Override\n+    @Nullable\n+    public Integer getCount() {", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxNTEzMg==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403315132", "bodyText": "The method is nullable in parent interface and can't change.", "author": "lujop", "createdAt": "2020-04-03T20:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1MDQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1Mjc4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402652783", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    StringBuffer query = new StringBuffer();\n          \n          \n            \n                    StringBuilder query = new StringBuilder();", "author": "cpmeister", "createdAt": "2020-04-02T23:26:03Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/influx1/Influx1FilterCriteriaQueryCreatorImpl.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal.influx1;\n+\n+import java.time.ZonedDateTime;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.core.persistence.FilterCriteria;\n+import org.openhab.persistence.influxdb.internal.FilterCriteriaQueryCreator;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConstants;\n+import org.openhab.persistence.influxdb.internal.InfluxDBStateConvertUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Implementation of {@link FilterCriteriaQueryCreator} for InfluxDB 1.0\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution. Most code has been moved from\n+ *         {@link org.openhab.persistence.influxdb.InfluxDBPersistenceService} where it was in previous version\n+ */\n+@NonNullByDefault\n+public class Influx1FilterCriteriaQueryCreatorImpl implements FilterCriteriaQueryCreator {\n+    private final Logger logger = LoggerFactory.getLogger(Influx1FilterCriteriaQueryCreatorImpl.class);\n+    private final InfluxDBConfiguration configuration;\n+\n+    public Influx1FilterCriteriaQueryCreatorImpl(InfluxDBConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public String createQuery(FilterCriteria filter, String retentionPolicy) {\n+        StringBuffer query = new StringBuffer();", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1MzIyOA==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402653228", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                private final MetadataRegistry metadataRegistry;\n          \n          \n            \n                private final @Nullable MetadataRegistry metadataRegistry;", "author": "cpmeister", "createdAt": "2020-04-02T23:27:25Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/ItemToStorePointCreator.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_CATEGORY_NAME;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_ITEM_NAME;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_LABEL_NAME;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_TYPE_NAME;\n+\n+import java.time.Instant;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.Metadata;\n+import org.openhab.core.items.MetadataKey;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.types.State;\n+import org.openhab.core.types.UnDefType;\n+import org.openhab.persistence.influxdb.InfluxDBPersistenceService;\n+\n+/**\n+ * Logic to create an InfluxDB {@link InfluxPoint} from an openHAB {@link Item}\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ItemToStorePointCreator {\n+    private final InfluxDBConfiguration configuration;\n+    @Nullable\n+    private final MetadataRegistry metadataRegistry;", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NDMwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402654306", "bodyText": "Shouldn't you be looping through the list of accepted command types? Or am I missing something?", "author": "cpmeister", "createdAt": "2020-04-02T23:30:47Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/ItemToStorePointCreator.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_CATEGORY_NAME;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_ITEM_NAME;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_LABEL_NAME;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_TYPE_NAME;\n+\n+import java.time.Instant;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.Metadata;\n+import org.openhab.core.items.MetadataKey;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.types.State;\n+import org.openhab.core.types.UnDefType;\n+import org.openhab.persistence.influxdb.InfluxDBPersistenceService;\n+\n+/**\n+ * Logic to create an InfluxDB {@link InfluxPoint} from an openHAB {@link Item}\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ItemToStorePointCreator {\n+    private final InfluxDBConfiguration configuration;\n+    @Nullable\n+    private final MetadataRegistry metadataRegistry;\n+\n+    public ItemToStorePointCreator(InfluxDBConfiguration configuration, @Nullable MetadataRegistry metadataRegistry) {\n+        this.configuration = configuration;\n+        this.metadataRegistry = metadataRegistry;\n+    }\n+\n+    public @Nullable InfluxPoint convert(Item item, @Nullable String storeAlias) {\n+        if (item.getState() instanceof UnDefType) {\n+            return null;\n+        }\n+\n+        String measurementName = calculateMeasurementName(item, storeAlias);\n+        String itemName = item.getName();\n+        State state = getItemState(item);\n+\n+        Object value = InfluxDBStateConvertUtils.stateToObject(state);\n+\n+        InfluxPoint.Builder point = InfluxPoint.newBuilder(measurementName).withTime(Instant.now()).withValue(value)\n+                .withTag(TAG_ITEM_NAME, itemName);\n+\n+        addPointTags(item, point);\n+\n+        return point.build();\n+    }\n+\n+    @SuppressWarnings(\"null\")\n+    private String calculateMeasurementName(Item item, @Nullable String storeAlias) {\n+        String name;\n+        if (StringUtils.isNotBlank(storeAlias)) {\n+            name = storeAlias;\n+        } else {\n+            name = item.getName();\n+        }\n+\n+        if (configuration.isReplaceUnderscore()) {\n+            name = name.replace('_', '.');\n+        }\n+\n+        return name;\n+    }\n+\n+    private State getItemState(Item item) {\n+        final State state;\n+        final Class<? extends State> desiredConversion = calculateDesiredTypeConversionToStore(item);\n+        if (desiredConversion != null) {\n+            State convertedState = item.getStateAs(desiredConversion);\n+            if (convertedState != null) {\n+                state = convertedState;\n+            } else {\n+                state = item.getState();\n+            }\n+        } else {\n+            state = item.getState();\n+        }\n+        return state;\n+    }\n+\n+    private @Nullable Class<? extends State> calculateDesiredTypeConversionToStore(Item item) {\n+        Class<? extends State> conversion = null;\n+        if (item.getAcceptedCommandTypes().size() > 1) {\n+            if (item.getAcceptedCommandTypes().get(0).isAssignableFrom(State.class)) {\n+                conversion = item.getAcceptedCommandTypes().get(0).asSubclass(State.class);\n+            }", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NDU2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r402654567", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    StringBuffer buf = new StringBuffer();\n          \n          \n            \n                    StringBuilder buf = new StringBuilder();", "author": "cpmeister", "createdAt": "2020-04-02T23:31:41Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBStateConvertUtils.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import java.math.BigDecimal;\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.TimeZone;\n+\n+import org.apache.commons.lang.BooleanUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.items.GroupItem;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemNotFoundException;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.library.items.ColorItem;\n+import org.openhab.core.library.items.ContactItem;\n+import org.openhab.core.library.items.DateTimeItem;\n+import org.openhab.core.library.items.DimmerItem;\n+import org.openhab.core.library.items.LocationItem;\n+import org.openhab.core.library.items.NumberItem;\n+import org.openhab.core.library.items.RollershutterItem;\n+import org.openhab.core.library.items.SwitchItem;\n+import org.openhab.core.library.types.DateTimeType;\n+import org.openhab.core.library.types.DecimalType;\n+import org.openhab.core.library.types.HSBType;\n+import org.openhab.core.library.types.OnOffType;\n+import org.openhab.core.library.types.OpenClosedType;\n+import org.openhab.core.library.types.PercentType;\n+import org.openhab.core.library.types.PointType;\n+import org.openhab.core.library.types.QuantityType;\n+import org.openhab.core.library.types.StringType;\n+import org.openhab.core.types.State;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Conversion logic between openHAB {@link State} types and InfluxDB store types\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution, based on previous work from Theo Weiss and Dominik Vorreiter\n+ */\n+@NonNullByDefault\n+public class InfluxDBStateConvertUtils {\n+    static final String DIGITAL_VALUE_OFF = \"false\"; // Visible for testing\n+    static final String DIGITAL_VALUE_ON = \"true\"; // Visible for testing\n+    private static Logger logger = LoggerFactory.getLogger(InfluxDBStateConvertUtils.class);\n+\n+    /**\n+     * Converts {@link State} to a String suitable for influxdb queries.\n+     *\n+     * @param state to be converted\n+     * @return {@link String} equivalent of the {@link State}\n+     */\n+    public static String stateToString(State state) {\n+        String value;\n+        if (state instanceof DecimalType) {\n+            value = ((DecimalType) state).toBigDecimal().toString();\n+        } else if (state instanceof QuantityType<?>) {\n+            value = ((QuantityType<?>) state).toBigDecimal().toString();\n+        } else if (state instanceof PointType) {\n+            value = point2String((PointType) state);\n+        } else if (state instanceof OnOffType) {\n+            value = state == OnOffType.ON ? DIGITAL_VALUE_ON : DIGITAL_VALUE_OFF;\n+        } else if (state instanceof OpenClosedType) {\n+            value = state == OpenClosedType.OPEN ? DIGITAL_VALUE_ON : DIGITAL_VALUE_OFF;\n+        } else if (state instanceof DateTimeType) {\n+            value = String.valueOf(((DateTimeType) state).getZonedDateTime().toInstant().toEpochMilli());\n+        } else {\n+            value = state.toString();\n+        }\n+        return value;\n+    }\n+\n+    /**\n+     * Converts {@link State} to objects fitting into influxdb values.\n+     *\n+     * @param state to be converted\n+     * @return integer or double value for DecimalType, 0 or 1 for OnOffType and OpenClosedType,\n+     *         integer for DateTimeType, String for all others\n+     */\n+    public static Object stateToObject(State state) {\n+        Object value;\n+        if (state instanceof HSBType) {\n+            value = state.toString();\n+        } else if (state instanceof PointType) {\n+            value = point2String((PointType) state);\n+        } else if (state instanceof DecimalType) {\n+            value = convertBigDecimalToNum(((DecimalType) state).toBigDecimal());\n+        } else if (state instanceof QuantityType<?>) {\n+            value = convertBigDecimalToNum(((QuantityType<?>) state).toBigDecimal());\n+        } else if (state instanceof OnOffType) {\n+            value = state == OnOffType.ON ? Boolean.TRUE : Boolean.FALSE;\n+        } else if (state instanceof OpenClosedType) {\n+            value = state == OpenClosedType.OPEN ? Boolean.TRUE : Boolean.FALSE;\n+        } else if (state instanceof DateTimeType) {\n+            value = ((DateTimeType) state).getZonedDateTime().toInstant().toEpochMilli();\n+        } else {\n+            value = state.toString();\n+        }\n+        return value;\n+    }\n+\n+    /**\n+     * Converts a value to a {@link State} which is suitable for the given {@link Item}. This is\n+     * needed for querying a {@link InfluxDBHistoricItem}.\n+     *\n+     * @param value to be converted to a {@link State}\n+     * @param itemName name of the {@link Item} to get the {@link State} for\n+     * @return the state of the item represented by the itemName parameter, else the string value of\n+     *         the Object parameter\n+     */\n+    public static State objectToState(Object value, String itemName, @Nullable ItemRegistry itemRegistry) {\n+        State state = null;\n+        if (itemRegistry != null) {\n+            try {\n+                Item item = itemRegistry.getItem(itemName);\n+                state = objectToState(value, item);\n+            } catch (ItemNotFoundException e) {\n+                logger.info(\"Could not find item '{}' in registry\", itemName);\n+            }\n+        }\n+\n+        if (state == null) {\n+            state = new StringType(String.valueOf(value));\n+        }\n+\n+        return state;\n+    }\n+\n+    public static State objectToState(Object value, Item itemToSetState) {\n+        String valueStr = String.valueOf(value);\n+\n+        Item item = itemToSetState;\n+        if (item instanceof GroupItem) {\n+            item = ((GroupItem) item).getBaseItem();\n+        }\n+        if (item instanceof ColorItem) {\n+            return new HSBType(valueStr);\n+        } else if (item instanceof LocationItem) {\n+            return new PointType(valueStr);\n+        } else if (item instanceof NumberItem) {\n+            return new DecimalType(valueStr);\n+        } else if (item instanceof DimmerItem) {\n+            return new PercentType(valueStr);\n+        } else if (item instanceof SwitchItem) {\n+            return toBoolean(valueStr) ? OnOffType.ON : OnOffType.OFF;\n+        } else if (item instanceof ContactItem) {\n+            return toBoolean(valueStr) ? OpenClosedType.OPEN : OpenClosedType.CLOSED;\n+        } else if (item instanceof RollershutterItem) {\n+            return new PercentType(valueStr);\n+        } else if (item instanceof DateTimeItem) {\n+            Instant i = Instant.ofEpochMilli(new BigDecimal(valueStr).longValue());\n+            ZonedDateTime z = ZonedDateTime.ofInstant(i, TimeZone.getDefault().toZoneId());\n+            return new DateTimeType(z);\n+        } else {\n+            return new StringType(valueStr);\n+        }\n+    }\n+\n+    private static boolean toBoolean(@Nullable Object object) {\n+        if (object instanceof Boolean) {\n+            return (Boolean) object;\n+        } else if (object != null) {\n+            if (\"1\".equals(object)) {\n+                return true;\n+            } else {\n+                return BooleanUtils.toBoolean(String.valueOf(object));\n+            }\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    private static String point2String(PointType point) {\n+        StringBuffer buf = new StringBuffer();", "originalCommit": "535708b5a6b698e4eb8afc7d65319fe17a5abff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0972d4945a0e1f886b9a04d78f43c5dc3e873b62", "url": "https://github.com/openhab/openhab-addons/commit/0972d4945a0e1f886b9a04d78f43c5dc3e873b62", "message": "Apply suggestions from code review\r\n\r\nApply review suggestions\n\nCo-Authored-By: cpmeister <mistercpp2000@gmail.com>\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-03T20:49:34Z", "type": "commit"}, {"oid": "cd242cbad173cb4854d22734572b4edce80d9390", "url": "https://github.com/openhab/openhab-addons/commit/cd242cbad173cb4854d22734572b4edce80d9390", "message": "PR review fixes\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-03T20:49:34Z", "type": "commit"}, {"oid": "cd242cbad173cb4854d22734572b4edce80d9390", "url": "https://github.com/openhab/openhab-addons/commit/cd242cbad173cb4854d22734572b4edce80d9390", "message": "PR review fixes\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-03T20:49:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1NTk5MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403355991", "bodyText": "Why not use BooleanUtils.toStringTrueFalse instead these constants?", "author": "cpmeister", "createdAt": "2020-04-03T21:57:26Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBStateConvertUtils.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import java.math.BigDecimal;\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.TimeZone;\n+\n+import org.apache.commons.lang.BooleanUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.items.GroupItem;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemNotFoundException;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.library.items.ColorItem;\n+import org.openhab.core.library.items.ContactItem;\n+import org.openhab.core.library.items.DateTimeItem;\n+import org.openhab.core.library.items.DimmerItem;\n+import org.openhab.core.library.items.LocationItem;\n+import org.openhab.core.library.items.NumberItem;\n+import org.openhab.core.library.items.RollershutterItem;\n+import org.openhab.core.library.items.SwitchItem;\n+import org.openhab.core.library.types.DateTimeType;\n+import org.openhab.core.library.types.DecimalType;\n+import org.openhab.core.library.types.HSBType;\n+import org.openhab.core.library.types.OnOffType;\n+import org.openhab.core.library.types.OpenClosedType;\n+import org.openhab.core.library.types.PercentType;\n+import org.openhab.core.library.types.PointType;\n+import org.openhab.core.library.types.QuantityType;\n+import org.openhab.core.library.types.StringType;\n+import org.openhab.core.types.State;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Conversion logic between openHAB {@link State} types and InfluxDB store types\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution, based on previous work from Theo Weiss and Dominik Vorreiter\n+ */\n+@NonNullByDefault\n+public class InfluxDBStateConvertUtils {\n+    static final String DIGITAL_VALUE_OFF = \"false\"; // Visible for testing\n+    static final String DIGITAL_VALUE_ON = \"true\"; // Visible for testing", "originalCommit": "cd242cbad173cb4854d22734572b4edce80d9390", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1ODQxNw==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403358417", "bodyText": "Shouldn't you check for escape characters?", "author": "cpmeister", "createdAt": "2020-04-03T22:04:28Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/influx1/Influx1FilterCriteriaQueryCreatorImpl.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal.influx1;\n+\n+import java.time.ZonedDateTime;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.core.persistence.FilterCriteria;\n+import org.openhab.persistence.influxdb.internal.FilterCriteriaQueryCreator;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConstants;\n+import org.openhab.persistence.influxdb.internal.InfluxDBStateConvertUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Implementation of {@link FilterCriteriaQueryCreator} for InfluxDB 1.0\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution. Most code has been moved from\n+ *         {@link org.openhab.persistence.influxdb.InfluxDBPersistenceService} where it was in previous version\n+ */\n+@NonNullByDefault\n+public class Influx1FilterCriteriaQueryCreatorImpl implements FilterCriteriaQueryCreator {\n+    private final Logger logger = LoggerFactory.getLogger(Influx1FilterCriteriaQueryCreatorImpl.class);\n+    private final InfluxDBConfiguration configuration;\n+\n+    public Influx1FilterCriteriaQueryCreatorImpl(InfluxDBConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public String createQuery(FilterCriteria filter, String retentionPolicy) {\n+        StringBuilder query = new StringBuilder();\n+        query.append(\"select \").append(InfluxDBConstants.COLUMN_VALUE_NAME).append(' ').append(\"from \\\"\")\n+                .append(configuration.getRetentionPolicy()).append(\"\\\".\");\n+\n+        if (filter.getItemName() != null) {\n+            query.append('\"').append(filter.getItemName()).append('\"');", "originalCommit": "cd242cbad173cb4854d22734572b4edce80d9390", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1OTAwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403359006", "bodyText": "What about ordering by ascending?", "author": "cpmeister", "createdAt": "2020-04-03T22:06:19Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/influx1/Influx1FilterCriteriaQueryCreatorImpl.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal.influx1;\n+\n+import java.time.ZonedDateTime;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.core.persistence.FilterCriteria;\n+import org.openhab.persistence.influxdb.internal.FilterCriteriaQueryCreator;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConstants;\n+import org.openhab.persistence.influxdb.internal.InfluxDBStateConvertUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Implementation of {@link FilterCriteriaQueryCreator} for InfluxDB 1.0\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution. Most code has been moved from\n+ *         {@link org.openhab.persistence.influxdb.InfluxDBPersistenceService} where it was in previous version\n+ */\n+@NonNullByDefault\n+public class Influx1FilterCriteriaQueryCreatorImpl implements FilterCriteriaQueryCreator {\n+    private final Logger logger = LoggerFactory.getLogger(Influx1FilterCriteriaQueryCreatorImpl.class);\n+    private final InfluxDBConfiguration configuration;\n+\n+    public Influx1FilterCriteriaQueryCreatorImpl(InfluxDBConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public String createQuery(FilterCriteria filter, String retentionPolicy) {\n+        StringBuilder query = new StringBuilder();\n+        query.append(\"select \").append(InfluxDBConstants.COLUMN_VALUE_NAME).append(' ').append(\"from \\\"\")\n+                .append(configuration.getRetentionPolicy()).append(\"\\\".\");\n+\n+        if (filter.getItemName() != null) {\n+            query.append('\"').append(filter.getItemName()).append('\"');\n+        } else {\n+            query.append(\"/.*/\");\n+        }\n+\n+        logger.trace(\n+                \"Filter: itemname: {}, ordering: {}, state: {},  operator: {}, getBeginDate: {}, getEndDate: {}, getPageSize: {}, getPageNumber: {}\",\n+                filter.getItemName(), filter.getOrdering().toString(), filter.getState(), filter.getOperator(),\n+                filter.getBeginDateZoned(), filter.getEndDateZoned(), filter.getPageSize(), filter.getPageNumber());\n+\n+        if ((filter.getState() != null && filter.getOperator() != null) || filter.getBeginDateZoned() != null\n+                || filter.getEndDateZoned() != null) {\n+            query.append(\" where \");\n+            boolean foundState = false;\n+            boolean foundBeginDate = false;\n+            if (filter.getState() != null && filter.getOperator() != null) {\n+                String value = InfluxDBStateConvertUtils.stateToString(filter.getState());\n+                foundState = true;\n+                query.append(InfluxDBConstants.COLUMN_VALUE_NAME);\n+                query.append(\" \");\n+                query.append(filter.getOperator().toString());\n+                query.append(\" \");\n+                query.append(value);\n+            }\n+\n+            if (filter.getBeginDateZoned() != null) {\n+                foundBeginDate = true;\n+                if (foundState) {\n+                    query.append(\" and\");\n+                }\n+                query.append(\" \");\n+                query.append(InfluxDBConstants.COLUMN_TIME_NAME);\n+                query.append(\" > \");\n+                query.append(getTimeFilter(filter.getBeginDateZoned()));\n+                query.append(\" \");\n+            }\n+\n+            if (filter.getEndDateZoned() != null) {\n+                if (foundState || foundBeginDate) {\n+                    query.append(\" and\");\n+                }\n+                query.append(\" \");\n+                query.append(InfluxDBConstants.COLUMN_TIME_NAME);\n+                query.append(\" < \");\n+                query.append(getTimeFilter(filter.getEndDateZoned()));\n+                query.append(\" \");\n+            }\n+        }\n+\n+        if (filter.getOrdering() == FilterCriteria.Ordering.DESCENDING) {\n+            query.append(String.format(\" ORDER BY %s DESC\", InfluxDBConstants.COLUMN_TIME_NAME));\n+            logger.debug(\"descending ordering \");\n+        }", "originalCommit": "cd242cbad173cb4854d22734572b4edce80d9390", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1OTk4Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403359982", "bodyText": "startEntryNum isn't used in the query? Paging doesn't work?", "author": "cpmeister", "createdAt": "2020-04-03T22:09:12Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/influx1/Influx1FilterCriteriaQueryCreatorImpl.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal.influx1;\n+\n+import java.time.ZonedDateTime;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.core.persistence.FilterCriteria;\n+import org.openhab.persistence.influxdb.internal.FilterCriteriaQueryCreator;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConstants;\n+import org.openhab.persistence.influxdb.internal.InfluxDBStateConvertUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Implementation of {@link FilterCriteriaQueryCreator} for InfluxDB 1.0\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution. Most code has been moved from\n+ *         {@link org.openhab.persistence.influxdb.InfluxDBPersistenceService} where it was in previous version\n+ */\n+@NonNullByDefault\n+public class Influx1FilterCriteriaQueryCreatorImpl implements FilterCriteriaQueryCreator {\n+    private final Logger logger = LoggerFactory.getLogger(Influx1FilterCriteriaQueryCreatorImpl.class);\n+    private final InfluxDBConfiguration configuration;\n+\n+    public Influx1FilterCriteriaQueryCreatorImpl(InfluxDBConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public String createQuery(FilterCriteria filter, String retentionPolicy) {\n+        StringBuilder query = new StringBuilder();\n+        query.append(\"select \").append(InfluxDBConstants.COLUMN_VALUE_NAME).append(' ').append(\"from \\\"\")\n+                .append(configuration.getRetentionPolicy()).append(\"\\\".\");\n+\n+        if (filter.getItemName() != null) {\n+            query.append('\"').append(filter.getItemName()).append('\"');\n+        } else {\n+            query.append(\"/.*/\");\n+        }\n+\n+        logger.trace(\n+                \"Filter: itemname: {}, ordering: {}, state: {},  operator: {}, getBeginDate: {}, getEndDate: {}, getPageSize: {}, getPageNumber: {}\",\n+                filter.getItemName(), filter.getOrdering().toString(), filter.getState(), filter.getOperator(),\n+                filter.getBeginDateZoned(), filter.getEndDateZoned(), filter.getPageSize(), filter.getPageNumber());\n+\n+        if ((filter.getState() != null && filter.getOperator() != null) || filter.getBeginDateZoned() != null\n+                || filter.getEndDateZoned() != null) {\n+            query.append(\" where \");\n+            boolean foundState = false;\n+            boolean foundBeginDate = false;\n+            if (filter.getState() != null && filter.getOperator() != null) {\n+                String value = InfluxDBStateConvertUtils.stateToString(filter.getState());\n+                foundState = true;\n+                query.append(InfluxDBConstants.COLUMN_VALUE_NAME);\n+                query.append(\" \");\n+                query.append(filter.getOperator().toString());\n+                query.append(\" \");\n+                query.append(value);\n+            }\n+\n+            if (filter.getBeginDateZoned() != null) {\n+                foundBeginDate = true;\n+                if (foundState) {\n+                    query.append(\" and\");\n+                }\n+                query.append(\" \");\n+                query.append(InfluxDBConstants.COLUMN_TIME_NAME);\n+                query.append(\" > \");\n+                query.append(getTimeFilter(filter.getBeginDateZoned()));\n+                query.append(\" \");\n+            }\n+\n+            if (filter.getEndDateZoned() != null) {\n+                if (foundState || foundBeginDate) {\n+                    query.append(\" and\");\n+                }\n+                query.append(\" \");\n+                query.append(InfluxDBConstants.COLUMN_TIME_NAME);\n+                query.append(\" < \");\n+                query.append(getTimeFilter(filter.getEndDateZoned()));\n+                query.append(\" \");\n+            }\n+        }\n+\n+        if (filter.getOrdering() == FilterCriteria.Ordering.DESCENDING) {\n+            query.append(String.format(\" ORDER BY %s DESC\", InfluxDBConstants.COLUMN_TIME_NAME));\n+            logger.debug(\"descending ordering \");\n+        }\n+\n+        int limit = (filter.getPageNumber() + 1) * filter.getPageSize();\n+        query.append(\" limit \" + limit);\n+        logger.trace(\"appending limit {}\", limit);\n+\n+        int totalEntriesAffected = ((filter.getPageNumber() + 1) * filter.getPageSize());\n+        int startEntryNum = totalEntriesAffected\n+                - (totalEntriesAffected - (filter.getPageSize() * filter.getPageNumber()));\n+        logger.trace(\"startEntryNum {}\", startEntryNum);", "originalCommit": "cd242cbad173cb4854d22734572b4edce80d9390", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM2MTE2OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403361169", "bodyText": "Create a local variable for valuess.get(i) so you can reuse it.", "author": "cpmeister", "createdAt": "2020-04-03T22:12:46Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/influx1/InfluxDB1RepositoryImpl.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal.influx1;\n+\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.COLUMN_TIME_NAME;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.COLUMN_VALUE_NAME;\n+\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Pong;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBRepository;\n+import org.openhab.persistence.influxdb.internal.InfluxPoint;\n+import org.openhab.persistence.influxdb.internal.InfluxRow;\n+import org.openhab.persistence.influxdb.internal.UnnexpectedConditionException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import retrofit.RetrofitError;\n+\n+/**\n+ * Implementation of {@link InfluxDBRepository} for InfluxDB 1.0\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution. Most code has beenmoved from\n+ *         {@link org.openhab.persistence.influxdb.InfluxDBPersistenceService} where it was in previous version\n+ */\n+@NonNullByDefault\n+public class InfluxDB1RepositoryImpl implements InfluxDBRepository {\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDB1RepositoryImpl.class);\n+    private InfluxDBConfiguration configuration;\n+    @Nullable\n+    private InfluxDB client;\n+\n+    public InfluxDB1RepositoryImpl(InfluxDBConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public boolean isConnected() {\n+        return client != null;\n+    }\n+\n+    @Override\n+    public boolean connect() {\n+        final InfluxDB createdClient = InfluxDBFactory.connect(configuration.getUrl(), configuration.getUser(),\n+                configuration.getPassword());\n+        createdClient.enableBatch(200, 100, TimeUnit.MILLISECONDS);\n+        this.client = createdClient;\n+        return checkConnectionStatus();\n+    }\n+\n+    @Override\n+    public void disconnect() {\n+        this.client = null;\n+    }\n+\n+    @Override\n+    public boolean checkConnectionStatus() {\n+        boolean dbStatus = false;\n+        final InfluxDB currentClient = client;\n+        if (currentClient != null) {\n+            try {\n+                Pong pong = currentClient.ping();\n+                String version = pong.getVersion();\n+                // may be check for version >= 0.9\n+                if (version != null && !version.contains(\"unknown\")) {\n+                    dbStatus = true;\n+                    logger.debug(\"database status is OK, version is {}\", version);\n+                } else {\n+                    logger.warn(\"database ping error, version is: \\\"{}\\\" response time was \\\"{}\\\"\", version,\n+                            pong.getResponseTime());\n+                    dbStatus = false;\n+                }\n+            } catch (RuntimeException e) {\n+                dbStatus = false;\n+                logger.error(\"database connection failed\", e);\n+                handleDatabaseException(e);\n+            }\n+        } else {\n+            logger.warn(\"checkConnection: database is not connected\");\n+        }\n+        return dbStatus;\n+    }\n+\n+    private void handleDatabaseException(Exception e) {\n+        if (e instanceof RetrofitError) {\n+            // e.g. raised if influxdb is not running\n+            logger.warn(\"database connection error {}\", e.getMessage(), e);\n+        } else if (e instanceof RuntimeException) {\n+            // e.g. raised by authentication errors\n+            logger.warn(\"database error: {}\", e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void write(InfluxPoint point) {\n+        final InfluxDB currentClient = this.client;\n+        if (currentClient != null) {\n+            Point clientPoint = convertPointToClientFormat(point);\n+            currentClient.write(configuration.getDatabaseName(), configuration.getRetentionPolicy(), clientPoint);\n+        } else {\n+            logger.warn(\"Write point {} ignored due to client isn't connected\", point);\n+        }\n+    }\n+\n+    private Point convertPointToClientFormat(InfluxPoint point) {\n+        Point.Builder clientPoint = Point.measurement(point.getMeasurementName()).time(point.getTime().toEpochMilli(),\n+                TimeUnit.MILLISECONDS);\n+        setPointValue(point.getValue(), clientPoint);\n+        point.getTags().entrySet().forEach(e -> clientPoint.tag(e.getKey(), e.getValue()));\n+        point.getFields().entrySet().forEach(e -> clientPoint.addField(e.getKey(), e.getValue()));\n+        return clientPoint.build();\n+    }\n+\n+    private void setPointValue(@Nullable Object value, Point.Builder point) {\n+        if (value instanceof String)\n+            point.addField(COLUMN_VALUE_NAME, (String) value);\n+        else if (value instanceof Number)\n+            point.addField(COLUMN_VALUE_NAME, (Number) value);\n+        else if (value instanceof Boolean)\n+            point.addField(COLUMN_VALUE_NAME, (Boolean) value);\n+        else if (value == null)\n+            point.addField(COLUMN_VALUE_NAME, (String) null);\n+        else\n+            throw new UnnexpectedConditionException(\"Not expected value type\");\n+    }\n+\n+    @Override\n+    public List<InfluxRow> query(String query) {\n+        final InfluxDB currentClient = client;\n+        if (currentClient != null) {\n+            Query parsedQuery = new Query(query, configuration.getDatabaseName());\n+            List<QueryResult.Result> results = currentClient.query(parsedQuery, TimeUnit.MILLISECONDS).getResults();\n+            return convertClientResutToRepository(results);\n+        } else {\n+            logger.warn(\"Returning empty list because queryAPI isn't present\");\n+            return Collections.emptyList();\n+        }\n+    }\n+\n+    private List<InfluxRow> convertClientResutToRepository(List<QueryResult.Result> results) {\n+        List<InfluxRow> rows = new ArrayList<>();\n+        for (QueryResult.Result result : results) {\n+            List<QueryResult.Series> seriess = result.getSeries();\n+            if (result.getError() != null) {\n+                logger.warn(\"{}\", result.getError());\n+                continue;\n+            }\n+            if (seriess == null) {\n+                logger.debug(\"query returned no series\");\n+            } else {\n+                for (QueryResult.Series series : seriess) {\n+                    logger.trace(\"series {}\", series.toString());\n+                    String itemName = series.getName();\n+                    List<List<Object>> valuess = series.getValues();\n+                    if (valuess == null) {\n+                        logger.debug(\"query returned no values\");\n+                    } else {\n+                        List<String> columns = series.getColumns();\n+                        logger.trace(\"columns {}\", columns);\n+                        if (columns != null) {\n+                            Integer timestampColumn = null;\n+                            Integer valueColumn = null;\n+                            for (int i = 0; i < columns.size(); i++) {\n+                                String columnName = columns.get(i);\n+                                if (columnName.equals(COLUMN_TIME_NAME)) {\n+                                    timestampColumn = i;\n+                                } else if (columnName.equals(COLUMN_VALUE_NAME)) {\n+                                    valueColumn = i;\n+                                }\n+                            }\n+                            if (valueColumn == null || timestampColumn == null) {\n+                                throw new IllegalStateException(\"missing column\");\n+                            }\n+                            for (int i = 0; i < valuess.size(); i++) {\n+                                Double rawTime = (Double) valuess.get(i).get(timestampColumn);", "originalCommit": "cd242cbad173cb4854d22734572b4edce80d9390", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de6aab161cf73d25dbff057adb5662159df9c60d", "url": "https://github.com/openhab/openhab-addons/commit/de6aab161cf73d25dbff057adb5662159df9c60d", "message": "Refactor InfluxDB 1.0 filter criteria queries using QueryBuilder from driver library\nMake a test for FilterCriteria queries\nFix several issues about FilterCriteria queries\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-05T14:07:08Z", "type": "commit"}, {"oid": "2fea14dc2ff8ae9ad0f8bc5618dececedd1a38e6", "url": "https://github.com/openhab/openhab-addons/commit/2fea14dc2ff8ae9ad0f8bc5618dececedd1a38e6", "message": "Fix formatting issues\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-05T14:20:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4ODQwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403788406", "bodyText": "Is date type supported?", "author": "cpmeister", "createdAt": "2020-04-06T01:25:30Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/influx2/InfluxDB2RepositoryImpl.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal.influx2;\n+\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.COLUMN_TIME_NAME_V2;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.COLUMN_VALUE_NAME_V2;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.FIELD_VALUE_NAME;\n+import static org.openhab.persistence.influxdb.internal.InfluxDBConstants.TAG_ITEM_NAME;\n+\n+import java.time.Instant;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConstants;\n+import org.openhab.persistence.influxdb.internal.InfluxDBRepository;\n+import org.openhab.persistence.influxdb.internal.InfluxPoint;\n+import org.openhab.persistence.influxdb.internal.InfluxRow;\n+import org.openhab.persistence.influxdb.internal.UnnexpectedConditionException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.influxdb.client.InfluxDBClient;\n+import com.influxdb.client.InfluxDBClientFactory;\n+import com.influxdb.client.InfluxDBClientOptions;\n+import com.influxdb.client.QueryApi;\n+import com.influxdb.client.WriteApi;\n+import com.influxdb.client.domain.Ready;\n+import com.influxdb.client.domain.WritePrecision;\n+import com.influxdb.client.write.Point;\n+import com.influxdb.query.FluxTable;\n+\n+/**\n+ * Implementation of {@link InfluxDBRepository} for InfluxDB 2.0\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class InfluxDB2RepositoryImpl implements InfluxDBRepository {\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDB2RepositoryImpl.class);\n+    private InfluxDBConfiguration configuration;\n+    @Nullable\n+    private InfluxDBClient client;\n+    @Nullable\n+    private QueryApi queryAPI;\n+    @Nullable\n+    private WriteApi writeAPI;\n+\n+    public InfluxDB2RepositoryImpl(InfluxDBConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    /**\n+     * Returns if the client has been successfully connected to server\n+     *\n+     * @return True if it's connected, otherwise false\n+     */\n+    @Override\n+    public boolean isConnected() {\n+        return client != null;\n+    }\n+\n+    /**\n+     * Connect to InfluxDB server\n+     *\n+     * @return True if successful, otherwise false\n+     */\n+    @Override\n+    public boolean connect() {\n+        InfluxDBClientOptions.Builder optionsBuilder = InfluxDBClientOptions.builder().url(configuration.getUrl())\n+                .org(configuration.getDatabaseName()).bucket(configuration.getRetentionPolicy());\n+        if (StringUtils.isNotBlank(\"token\")) {\n+            optionsBuilder.authenticateToken(configuration.getTokenAsCharArray());\n+        } else {\n+            optionsBuilder.authenticate(configuration.getUser(), configuration.getPassword().toCharArray());\n+        }\n+        InfluxDBClientOptions clientOptions = optionsBuilder.build();\n+\n+        final InfluxDBClient createdClient = InfluxDBClientFactory.create(clientOptions);\n+        this.client = createdClient;\n+        logger.debug(\"Succesfully connected to InfluxDB. Instance ready={}\", createdClient.ready());\n+        queryAPI = createdClient.getQueryApi();\n+        writeAPI = createdClient.getWriteApi();\n+        return checkConnectionStatus();\n+    }\n+\n+    /**\n+     * Disconnect from InfluxDB server\n+     */\n+    @Override\n+    public void disconnect() {\n+        final InfluxDBClient currentClient = this.client;\n+        if (currentClient != null) {\n+            currentClient.close();\n+        }\n+        this.client = null;\n+    }\n+\n+    /**\n+     * Check if connection is currently ready\n+     *\n+     * @return True if its ready, otherwise false\n+     */\n+    @Override\n+    public boolean checkConnectionStatus() {\n+        final InfluxDBClient currentClient = client;\n+        if (currentClient != null) {\n+            Ready ready = currentClient.ready();\n+            boolean isUp = ready != null && ready.getStatus() == Ready.StatusEnum.READY;\n+            if (isUp) {\n+                logger.debug(\"database status is OK\");\n+            } else {\n+                logger.warn(\"database not ready\");\n+            }\n+            return isUp;\n+        } else {\n+            logger.warn(\"checkConnection: database is not connected\");\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Write point to database\n+     *\n+     * @param point\n+     */\n+    @Override\n+    public void write(InfluxPoint point) {\n+        final WriteApi currentWriteAPI = writeAPI;\n+        if (currentWriteAPI != null) {\n+            currentWriteAPI.writePoint(convertPointToClientFormat(point));\n+        } else {\n+            logger.warn(\"Write point {} ignored due to writeAPI isn't present\", point);\n+        }\n+    }\n+\n+    private Point convertPointToClientFormat(InfluxPoint point) {\n+        Point clientPoint = Point.measurement(point.getMeasurementName()).time(point.getTime(), WritePrecision.MS);\n+        setPointValue(point.getValue(), clientPoint);\n+        point.getTags().entrySet().forEach(e -> clientPoint.addTag(e.getKey(), e.getValue()));\n+        return clientPoint;\n+    }\n+\n+    private void setPointValue(@Nullable Object value, Point point) {\n+        if (value instanceof String) {\n+            point.addField(FIELD_VALUE_NAME, (String) value);\n+        } else if (value instanceof Number) {\n+            point.addField(FIELD_VALUE_NAME, (Number) value);\n+        } else if (value instanceof Boolean) {\n+            point.addField(FIELD_VALUE_NAME, (Boolean) value);\n+        } else if (value == null) {\n+            point.addField(FIELD_VALUE_NAME, (String) null);\n+        } else {", "originalCommit": "2fea14dc2ff8ae9ad0f8bc5618dececedd1a38e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg0MzQ0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403843443", "bodyText": "No:\n\nInfluxDB it's a time series database, and time it's always PK", "author": "lujop", "createdAt": "2020-04-06T05:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4ODQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4OTQwNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403789405", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } else if (object != null) {\n          \n          \n            \n                    } else if (object instanceof String) {", "author": "cpmeister", "createdAt": "2020-04-06T01:31:45Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/internal/InfluxDBConfiguration.java", "diffHunk": "@@ -0,0 +1,193 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb.internal;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.StringJoiner;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Contains this addon configurable parameters\n+ *\n+ * @author Joan Pujol Espinar - Initial contribution\n+ */\n+@NonNullByDefault\n+public class InfluxDBConfiguration {\n+    public static final String URL_PARAM = \"url\";\n+    public static final String TOKEN_PARAM = \"token\";\n+    public static final String USER_PARAM = \"user\";\n+    public static final String PASSWORD_PARAM = \"password\";\n+    public static final String DATABASE_PARAM = \"db\";\n+    public static final String RETENTION_POLICY_PARAM = \"retentionPolicy\";\n+    public static final String VERSION_PARAM = \"version\";\n+    public static final String REPLACE_UNDERSCORE_PARAM = \"replaceUnderscore\";\n+    public static final String ADD_CATEGORY_TAG_PARAM = \"addCategoryTag\";\n+    public static final String ADD_LABEL_TAG_PARAM = \"addLabelTag\";\n+    public static final String ADD_TYPE_TAG_PARAM = \"addTypeTag\";\n+    public static InfluxDBConfiguration NO_CONFIGURATION = new InfluxDBConfiguration(Collections.emptyMap());\n+    private final Logger logger = LoggerFactory.getLogger(InfluxDBConfiguration.class);\n+    private final String url;\n+    private final String user;\n+    private final String password;\n+    private final String token;\n+    private final String databaseName;\n+    private final String retentionPolicy;\n+    private final InfluxDBVersion version;\n+\n+    private final boolean replaceUnderscore;\n+    private final boolean addCategoryTag;\n+    private final boolean addTypeTag;\n+    private final boolean addLabelTag;\n+\n+    @SuppressWarnings(\"null\")\n+    public InfluxDBConfiguration(Map<String, @Nullable Object> config) {\n+        url = (String) config.getOrDefault(URL_PARAM, \"http://127.0.0.1:8086\");\n+        user = (String) config.getOrDefault(USER_PARAM, \"openhab\");\n+        password = (String) config.getOrDefault(PASSWORD_PARAM, \"\");\n+        token = (String) config.getOrDefault(TOKEN_PARAM, \"\");\n+        databaseName = (String) config.getOrDefault(DATABASE_PARAM, \"openhab\");\n+        retentionPolicy = (String) config.getOrDefault(RETENTION_POLICY_PARAM, \"autogen\");\n+        version = parseInfluxVersion(config.getOrDefault(VERSION_PARAM, InfluxDBVersion.V1.name()));\n+\n+        replaceUnderscore = getConfigBooleanValue(config, REPLACE_UNDERSCORE_PARAM, false);\n+        addCategoryTag = getConfigBooleanValue(config, ADD_CATEGORY_TAG_PARAM, false);\n+        addLabelTag = getConfigBooleanValue(config, ADD_LABEL_TAG_PARAM, false);\n+        addTypeTag = getConfigBooleanValue(config, ADD_TYPE_TAG_PARAM, false);\n+    }\n+\n+    private static boolean getConfigBooleanValue(Map<String, @Nullable Object> config, String key,\n+            boolean defaultValue) {\n+        Object object = config.get(key);\n+\n+        if (object instanceof Boolean) {\n+            return (Boolean) object;\n+        } else if (object != null) {", "originalCommit": "2fea14dc2ff8ae9ad0f8bc5618dececedd1a38e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg0NDI3Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r403844276", "bodyText": "Changed, I don't use suggestion because then DCO bot complains about signature", "author": "lujop", "createdAt": "2020-04-06T05:54:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4OTQwNQ=="}], "type": "inlineReview"}, {"oid": "82d81dba9e7debbf1203bed0439135899d4f82ec", "url": "https://github.com/openhab/openhab-addons/commit/82d81dba9e7debbf1203bed0439135899d4f82ec", "message": "PR review fix\n\nSigned-off-by: Joan Pujol <joanpujol@gmail.com>", "committedDate": "2020-04-06T05:54:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4Nzk4MA==", "url": "https://github.com/openhab/openhab-addons/pull/7235#discussion_r407087980", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            ConfigurableService.SERVICE_PROPERTY_LABEL + \"=InfluxDB persistence layer\",\n          \n          \n            \n                            ConfigurableService.SERVICE_PROPERTY_LABEL + \"=InfluxDB Persistence Service\",", "author": "kaikreuzer", "createdAt": "2020-04-11T17:18:42Z", "path": "bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/InfluxDBPersistenceService.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.persistence.influxdb;\n+\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.jetbrains.annotations.NotNull;\n+import org.openhab.core.config.core.ConfigurableService;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.persistence.FilterCriteria;\n+import org.openhab.core.persistence.HistoricItem;\n+import org.openhab.core.persistence.PersistenceItemInfo;\n+import org.openhab.core.persistence.PersistenceService;\n+import org.openhab.core.persistence.QueryablePersistenceService;\n+import org.openhab.core.persistence.strategy.PersistenceStrategy;\n+import org.openhab.core.types.State;\n+import org.openhab.persistence.influxdb.internal.FilterCriteriaQueryCreator;\n+import org.openhab.persistence.influxdb.internal.InfluxDBConfiguration;\n+import org.openhab.persistence.influxdb.internal.InfluxDBHistoricItem;\n+import org.openhab.persistence.influxdb.internal.InfluxDBPersistentItemInfo;\n+import org.openhab.persistence.influxdb.internal.InfluxDBRepository;\n+import org.openhab.persistence.influxdb.internal.InfluxDBStateConvertUtils;\n+import org.openhab.persistence.influxdb.internal.InfluxPoint;\n+import org.openhab.persistence.influxdb.internal.InfluxRow;\n+import org.openhab.persistence.influxdb.internal.ItemToStorePointCreator;\n+import org.openhab.persistence.influxdb.internal.RepositoryFactory;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Modified;\n+import org.osgi.service.component.annotations.Reference;\n+import org.osgi.service.component.annotations.ReferenceCardinality;\n+import org.osgi.service.component.annotations.ReferencePolicy;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is the implementation of the InfluxDB {@link PersistenceService}. It persists item values\n+ * using the <a href=\"http://influxdb.org\">InfluxDB time series database. The states (\n+ * {@link State}) of an {@link Item} are persisted by default in a time series with names equal to the name of\n+ * the item.\n+ *\n+ * This addon supports 1.X and 2.X versions, as two versions are incompatible and use different drivers the\n+ * specific code for each version is accessed by {@link InfluxDBRepository} and {@link FilterCriteriaQueryCreator}\n+ * interfaces and specific implementation reside in {@link org.openhab.persistence.influxdb.internal.influx1} and\n+ * {@link org.openhab.persistence.influxdb.internal.influx2} packages\n+ *\n+ * @author Theo Weiss - Initial contribution, rewrite of org.openhab.persistence.influxdb\n+ * @author Joan Pujol Espinar - Addon rewrite refactoring code and adding support for InfluxDB 2.0. Some tag code is\n+ *         based\n+ *         from not integrated branch from Dominik Vorreiter\n+ */\n+@NonNullByDefault\n+@Component(service = { PersistenceService.class,\n+        QueryablePersistenceService.class }, configurationPid = \"org.openhab.influxdb\", property = {\n+                Constants.SERVICE_PID + \"=org.openhab.influxdb\",\n+                ConfigurableService.SERVICE_PROPERTY_DESCRIPTION_URI + \"=persistence:influxdb\",\n+                ConfigurableService.SERVICE_PROPERTY_LABEL + \"=InfluxDB persistence layer\",", "originalCommit": "82d81dba9e7debbf1203bed0439135899d4f82ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b1b820f215e8a8e2bc68c7e3e4ca2a0c0b1b0d89", "url": "https://github.com/openhab/openhab-addons/commit/b1b820f215e8a8e2bc68c7e3e4ca2a0c0b1b0d89", "message": "Update bundles/org.openhab.persistence.influxdb/src/main/java/org/openhab/persistence/influxdb/InfluxDBPersistenceService.java", "committedDate": "2020-04-11T17:18:48Z", "type": "commit"}, {"oid": "ad506af86b7945595bd8ada9d65eff79dee092d3", "url": "https://github.com/openhab/openhab-addons/commit/ad506af86b7945595bd8ada9d65eff79dee092d3", "message": "Merge branch 'master' into influxdb2clean", "committedDate": "2020-04-11T17:19:51Z", "type": "commit"}]}