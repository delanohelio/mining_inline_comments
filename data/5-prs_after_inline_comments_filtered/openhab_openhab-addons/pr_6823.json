{"pr_number": 6823, "pr_title": "[ecobee] Ecobee binding initial contribution", "pr_createdAt": "2020-01-12T20:30:24Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6823", "timeline": [{"oid": "d6698927922cfcf802bc5b9baf63404515361129", "url": "https://github.com/openhab/openhab-addons/commit/d6698927922cfcf802bc5b9baf63404515361129", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-13T01:28:35Z", "type": "forcePushed"}, {"oid": "3a17ab4d3b10b3d111a4dcadfe164f71bc874a19", "url": "https://github.com/openhab/openhab-addons/commit/3a17ab4d3b10b3d111a4dcadfe164f71bc874a19", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-13T14:21:32Z", "type": "forcePushed"}, {"oid": "85f2ca8c804f3bf07c3387e6d4deb883bc74f786", "url": "https://github.com/openhab/openhab-addons/commit/85f2ca8c804f3bf07c3387e6d4deb883bc74f786", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-13T16:36:55Z", "type": "forcePushed"}, {"oid": "b67405e8d845f30ade6f50116353bfd7dc604fba", "url": "https://github.com/openhab/openhab-addons/commit/b67405e8d845f30ade6f50116353bfd7dc604fba", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-13T18:52:52Z", "type": "forcePushed"}, {"oid": "f4a7d92e0fe81ae0671ca43fd60ceef430fbfab0", "url": "https://github.com/openhab/openhab-addons/commit/f4a7d92e0fe81ae0671ca43fd60ceef430fbfab0", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-13T18:55:53Z", "type": "forcePushed"}, {"oid": "70203dc4ba5df3f850e5383aab17af51064f5e66", "url": "https://github.com/openhab/openhab-addons/commit/70203dc4ba5df3f850e5383aab17af51064f5e66", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-13T20:44:42Z", "type": "forcePushed"}, {"oid": "a392439f8dde6442e8488c55425a4d6fc5b7bcaa", "url": "https://github.com/openhab/openhab-addons/commit/a392439f8dde6442e8488c55425a4d6fc5b7bcaa", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-13T23:34:13Z", "type": "forcePushed"}, {"oid": "e83dabd75e561b1c257bf14a1406d8229554d5ad", "url": "https://github.com/openhab/openhab-addons/commit/e83dabd75e561b1c257bf14a1406d8229554d5ad", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-14T01:04:06Z", "type": "forcePushed"}, {"oid": "e63f073621d319c8814474a28d94455864721cc8", "url": "https://github.com/openhab/openhab-addons/commit/e63f073621d319c8814474a28d94455864721cc8", "message": "Integrate with OHC OAuth service\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-01-17T02:00:32Z", "type": "forcePushed"}, {"oid": "64c3e44e1512561a9d86afe6df452bbf90c5acc6", "url": "https://github.com/openhab/openhab-addons/commit/64c3e44e1512561a9d86afe6df452bbf90c5acc6", "message": "Update to latest snapshot\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-02-26T19:07:47Z", "type": "forcePushed"}, {"oid": "1ba02c4e7ddeeddb93fc228f5f4effadefdb74bd", "url": "https://github.com/openhab/openhab-addons/commit/1ba02c4e7ddeeddb93fc228f5f4effadefdb74bd", "message": "Initial contribution\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:11:32Z", "type": "commit"}, {"oid": "912d1bc639057905442d60acb209769499398f90", "url": "https://github.com/openhab/openhab-addons/commit/912d1bc639057905442d60acb209769499398f90", "message": "Add readwrite indicator to docs\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:11:33Z", "type": "commit"}, {"oid": "66ec8dab0b4e368f371f7497c36829a72f8b7b9d", "url": "https://github.com/openhab/openhab-addons/commit/66ec8dab0b4e368f371f7497c36829a72f8b7b9d", "message": "Integrate with OHC OAuth service\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:11:33Z", "type": "commit"}, {"oid": "2470cdbd6445347de2b040d1b227ffa904123b5c", "url": "https://github.com/openhab/openhab-addons/commit/2470cdbd6445347de2b040d1b227ffa904123b5c", "message": "Small fixes\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:11:33Z", "type": "commit"}, {"oid": "0096982d637e91319e6a28abbe343d6b5caea346", "url": "https://github.com/openhab/openhab-addons/commit/0096982d637e91319e6a28abbe343d6b5caea346", "message": "README updates\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:11:33Z", "type": "commit"}, {"oid": "63bd12237720d31c2b74b83ac5b2096835e9e792", "url": "https://github.com/openhab/openhab-addons/commit/63bd12237720d31c2b74b83ac5b2096835e9e792", "message": "Improve handling of \"common\" API errors\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:11:33Z", "type": "commit"}, {"oid": "6f9d9c04df55fb8881c6a49d9aeafcf93886f562", "url": "https://github.com/openhab/openhab-addons/commit/6f9d9c04df55fb8881c6a49d9aeafcf93886f562", "message": "Update to latest snapshot\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:11:33Z", "type": "commit"}, {"oid": "f80ace88210a297be78b283d51e34a040ae97d69", "url": "https://github.com/openhab/openhab-addons/commit/f80ace88210a297be78b283d51e34a040ae97d69", "message": "Update to 2.5.4\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:13:00Z", "type": "commit"}, {"oid": "f80ace88210a297be78b283d51e34a040ae97d69", "url": "https://github.com/openhab/openhab-addons/commit/f80ace88210a297be78b283d51e34a040ae97d69", "message": "Update to 2.5.4\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-03-19T21:13:00Z", "type": "forcePushed"}, {"oid": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "url": "https://github.com/openhab/openhab-addons/commit/fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "message": "Fix thermostat update url\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-04-03T16:56:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2NDYxMA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r402564610", "bodyText": "Can you change this message to something like:\n\"Awaiting entry of PIN '%s' in MyApps, it expires in %d minutes.\"\nAlso what happens if it's expired?", "author": "robnielsen", "createdAt": "2020-04-02T19:38:19Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/api/EcobeeAuth.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.api;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.lang.exception.ExceptionUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.client.HttpResponseException;\n+import org.eclipse.jetty.client.api.ContentResponse;\n+import org.eclipse.jetty.client.api.Request;\n+import org.eclipse.jetty.http.HttpStatus;\n+import org.eclipse.smarthome.core.auth.client.oauth2.AccessTokenResponse;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthClientService;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthException;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.openhab.binding.ecobee.internal.dto.oauth.AuthorizeResponseDTO;\n+import org.openhab.binding.ecobee.internal.dto.oauth.TokenResponseDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeAccountBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link EcobeeAuth} performs the initial OAuth authorization\n+ * with the Ecobee authorization servers. Once this process is complete, the\n+ * AccessTokenResponse will be imported into the OHC OAuth Client Service.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class EcobeeAuth {\n+\n+    private final Logger logger = LoggerFactory.getLogger(EcobeeAuth.class);\n+\n+    private final EcobeeAccountBridgeHandler bridgeHandler;\n+    private final String apiKey;\n+    private final int apiTimeout;\n+    private final OAuthClientService oAuthClientService;\n+    private final HttpClient httpClient;\n+\n+    private EcobeeAuthState state;\n+\n+    private @Nullable AuthorizeResponseDTO authResponse;\n+\n+    private long pinExpirationTime;\n+\n+    /**\n+     * The authorization code needed to make the first-time request\n+     * of the refresh and access tokens. Obtained from the call to {@code authorize()}.\n+     */\n+    private @Nullable String code;\n+\n+    public EcobeeAuth(EcobeeAccountBridgeHandler bridgeHandler, String apiKey, int apiTimeout,\n+            OAuthClientService oAuthClientService, HttpClient httpClient) {\n+        this.apiKey = apiKey;\n+        this.apiTimeout = apiTimeout;\n+        this.oAuthClientService = oAuthClientService;\n+        this.httpClient = httpClient;\n+        this.bridgeHandler = bridgeHandler;\n+        pinExpirationTime = 0;\n+        state = EcobeeAuthState.NEED_PIN;\n+    }\n+\n+    public void setState(EcobeeAuthState newState) {\n+        if (newState != state) {\n+            logger.debug(\"EcobeeAuth: Change state from {} to {}\", state, newState);\n+            state = newState;\n+        }\n+    }\n+\n+    public boolean isComplete() {\n+        return state == EcobeeAuthState.COMPLETE;\n+    }\n+\n+    public EcobeeAuthState doAuthorization() throws EcobeeAuthException {\n+        switch (state) {\n+            case NEED_PIN:\n+                authorize();\n+                break;\n+            case NEED_TOKEN:\n+                getTokens();\n+                break;\n+            case COMPLETE:\n+                bridgeHandler.updateBridgeStatus(ThingStatus.ONLINE);\n+                break;\n+        }\n+        return state;\n+    }\n+\n+    /**\n+     * Call the Ecobee authorize endpoint to get the authorization code and PIN\n+     * that will be used a) validate the application in the the Ecobee user web portal,\n+     * and b) make the first time request for the access and refresh tokens.\n+     * Warnings are suppressed to avoid the Gson.fromJson warnings.\n+     */\n+    @SuppressWarnings({ \"null\", \"unused\" })\n+    private void authorize() throws EcobeeAuthException {\n+        logger.debug(\"EcobeeAuth: State is {}: Executing step: 'authorize'\", state);\n+        StringBuilder url = new StringBuilder(ECOBEE_AUTHORIZE_URL);\n+        url.append(\"?response_type=ecobeePin\");\n+        url.append(\"&client_id=\").append(apiKey);\n+        url.append(\"&scope=\").append(ECOBEE_SCOPE);\n+\n+        logger.trace(\"EcobeeAuth: Getting authorize URL={}\", url.toString());\n+        String response = executeUrl(\"GET\", url.toString());\n+        logger.trace(\"EcobeeAuth: Auth response: {}\", response);\n+\n+        try {\n+            authResponse = EcobeeApi.getGson().fromJson(response, AuthorizeResponseDTO.class);\n+            if (authResponse == null) {\n+                logger.debug(\"EcobeeAuth: Got null authorize response from Ecobee API\");\n+                setState(EcobeeAuthState.NEED_PIN);\n+            } else {\n+                if (StringUtils.isNotEmpty(authResponse.error)) {\n+                    throw new EcobeeAuthException(authResponse.error + \": \" + authResponse.errorDescription);\n+                }\n+                code = authResponse.code;\n+                writeLogMessage(authResponse.pin, authResponse.expiresIn);\n+                setPinExpirationTime(authResponse.expiresIn.longValue());\n+                updateBridgeStatus();\n+                setState(EcobeeAuthState.NEED_TOKEN);\n+            }\n+        } catch (JsonSyntaxException e) {\n+            logger.info(\"EcobeeAuth: Exception while parsing authorize response: {}\", e.getMessage());\n+            setState(EcobeeAuthState.NEED_PIN);\n+        }\n+    }\n+\n+    /**\n+     * Call the Ecobee token endpoint to get the access and refresh tokens. Once successfully retrieved,\n+     * the access and refresh tokens will be injected into the OHC OAuth service.\n+     * Warnings are suppressed to avoid the Gson.fromJson warnings.\n+     */\n+    @SuppressWarnings({ \"null\", \"unused\" })\n+    private void getTokens() throws EcobeeAuthException {\n+        logger.debug(\"EcobeeAuth: State is {}: Executing step: 'getToken'\", state);\n+        StringBuilder url = new StringBuilder(ECOBEE_TOKEN_URL);\n+        url.append(\"?grant_type=ecobeePin\");\n+        url.append(\"&code=\").append(code);\n+        url.append(\"&client_id=\").append(apiKey);\n+\n+        logger.trace(\"EcobeeAuth: Posting token URL={}\", url.toString());\n+        String response = executeUrl(\"POST\", url.toString());\n+        logger.trace(\"EcobeeAuth: Got a valid token response: {}\", response);\n+\n+        TokenResponseDTO tokenResponse = EcobeeApi.getGson().fromJson(response, TokenResponseDTO.class);\n+        if (tokenResponse == null) {\n+            logger.debug(\"EcobeeAuth: Got null token response from Ecobee API\");\n+            updateBridgeStatus();\n+            setState(isPinExpired() ? EcobeeAuthState.NEED_PIN : EcobeeAuthState.NEED_TOKEN);\n+            return;\n+        }\n+        if (StringUtils.isNotEmpty(tokenResponse.error)) {\n+            throw new EcobeeAuthException(tokenResponse.error + \": \" + tokenResponse.errorDescription);\n+        }\n+        AccessTokenResponse accessTokenResponse = new AccessTokenResponse();\n+        accessTokenResponse.setRefreshToken(tokenResponse.refreshToken);\n+        accessTokenResponse.setAccessToken(tokenResponse.accessToken);\n+        accessTokenResponse.setScope(tokenResponse.scope);\n+        accessTokenResponse.setTokenType(tokenResponse.tokenType);\n+        accessTokenResponse.setExpiresIn(tokenResponse.expiresIn);\n+        try {\n+            logger.debug(\"EcobeeAuth: Importing AccessTokenResponse into oAuthClientService!!!\");\n+            oAuthClientService.importAccessTokenResponse(accessTokenResponse);\n+            bridgeHandler.updateBridgeStatus(ThingStatus.ONLINE);\n+            setState(EcobeeAuthState.COMPLETE);\n+            return;\n+        } catch (OAuthException e) {\n+            logger.info(\"EcobeeAuth: Got OAuthException\", e);\n+            // No other processing needed here\n+        }\n+        updateBridgeStatus();\n+        setState(isPinExpired() ? EcobeeAuthState.NEED_PIN : EcobeeAuthState.NEED_TOKEN);\n+    }\n+\n+    private void writeLogMessage(String pin, Integer expiresIn) {\n+        logger.info(\"#################################################################\");\n+        logger.info(\"# Ecobee: U S E R   I N T E R A C T I O N   R E Q U I R E D !!\");\n+        logger.info(\"# Go to the Ecobee web portal, then:\");\n+        logger.info(\"# Enter PIN '{}' in My Apps within {} minutes.\", pin, expiresIn);\n+        logger.info(\"# NOTE: All API attempts will fail in the meantime.\");\n+        logger.info(\"#################################################################\");\n+    }\n+\n+    private void updateBridgeStatus() {\n+        AuthorizeResponseDTO response = authResponse;\n+        if (response != null) {\n+            bridgeHandler.updateBridgeStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_PENDING,\n+                    String.format(\"Awaiting entry of PIN %s. Expires in %d minutes\", response.pin,", "originalCommit": "f80ace88210a297be78b283d51e34a040ae97d69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIzNTU2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403235567", "bodyText": "I was trying to keep the text short, but your suggestion is better than what I had.\n\nAlso what happens if it's expired?\n\nIt starts the authorization process again from the beginning, which results in a new PIN that expires in 9 minutes. This step will repeat continuously until the PIN code is entered into MyApps within the expiration time period. Unfortunately, the 9 minute expiration cannot be changed...", "author": "mhilbush", "createdAt": "2020-04-03T18:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2NDYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2MjA4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403462086", "bodyText": "I changed it to this, which incorporates your suggestion, and keeps it short and sweet. WDYT?\n\nEnter PIN '%s' in MyApps. PIN expires in %d minutes", "author": "mhilbush", "createdAt": "2020-04-04T12:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2NDYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NTQ5MA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403465490", "bodyText": "Looks better, maybe change second PIN to it? Either way is fine with me.", "author": "robnielsen", "createdAt": "2020-04-04T12:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2NDYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3MTM0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403471347", "bodyText": "I'll leave it as PIN. However unlikely it might be, \"it\" could be interpreted to apply to the PIN or to MyApps.", "author": "mhilbush", "createdAt": "2020-04-04T13:40:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2NDYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3MzMzMw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r402673333", "bodyText": "This should be logger.debug", "author": "robnielsen", "createdAt": "2020-04-03T00:36:40Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/handler/EcobeeAccountBridgeHandler.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.handler;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.CONFIG_THERMOSTAT_ID;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthFactory;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.binding.BaseBridgeHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerService;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.openhab.binding.ecobee.internal.api.EcobeeApi;\n+import org.openhab.binding.ecobee.internal.config.EcobeeAccountConfiguration;\n+import org.openhab.binding.ecobee.internal.discovery.ThermostatDiscoveryService;\n+import org.openhab.binding.ecobee.internal.dto.SelectionDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.ThermostatDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.ThermostatUpdateRequestDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.summary.SummaryResponseDTO;\n+import org.openhab.binding.ecobee.internal.function.FunctionRequest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link EcobeeAccountBridgeHandler} is responsible for managing\n+ * communication with the Ecobee API.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class EcobeeAccountBridgeHandler extends BaseBridgeHandler {\n+\n+    private static final int REFRESH_STARTUP_DELAY_SECONDS = 3;\n+    private static final int REFRESH_INTERVAL_SECONDS = 1;\n+    private static final int DISCOVERY_INTERVAL_SECONDS = 300;\n+    private static final int DISCOVERY_INITIAL_DELAY_SECONDS = 10;\n+    private static final int DEFAULT_REFRESH_INTERVAL_NORMAL_SECONDS = 20;\n+    private static final int DEFAULT_REFRESH_INTERVAL_QUICK_SECONDS = 5;\n+    private static final int DEFAULT_API_TIMEOUT_SECONDS = 20;\n+\n+    private final Logger logger = LoggerFactory.getLogger(EcobeeAccountBridgeHandler.class);\n+\n+    private final OAuthFactory oAuthFactory;\n+    private final HttpClient httpClient;\n+\n+    private @NonNullByDefault({}) EcobeeApi api;\n+    private @NonNullByDefault({}) String apiKey;\n+    private int refreshIntervalNormal;\n+    private int refreshIntervalQuick;\n+    private int apiTimeout;\n+    private boolean discoveryEnabled;\n+    private int discoveryInterval;\n+\n+    private final Map<String, EcobeeThermostatBridgeHandler> thermostatHandlers = new ConcurrentHashMap<>();\n+    private final Set<String> thermostatIds = new CopyOnWriteArraySet<>();\n+\n+    private @Nullable Future<?> refreshThermostatsJob;\n+    private final AtomicInteger refreshThermostatsCounter = new AtomicInteger(REFRESH_STARTUP_DELAY_SECONDS);\n+    private final AtomicInteger discoveryCounter = new AtomicInteger(DISCOVERY_INITIAL_DELAY_SECONDS);\n+    private @Nullable ThermostatDiscoveryService discoveryService;\n+\n+    private @Nullable SummaryResponseDTO previousSummary;\n+\n+    public EcobeeAccountBridgeHandler(final Bridge bridge, OAuthFactory oAuthFactory, HttpClient httpClient) {\n+        super(bridge);\n+        this.oAuthFactory = oAuthFactory;\n+        this.httpClient = httpClient;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"AccountBridge: Initializing\");\n+        apiKey = getConfigAs(EcobeeAccountConfiguration.class).apiKey;\n+\n+        Integer value;\n+        value = getConfigAs(EcobeeAccountConfiguration.class).refreshIntervalNormal;\n+        refreshIntervalNormal = value == null ? DEFAULT_REFRESH_INTERVAL_NORMAL_SECONDS : value;\n+\n+        value = getConfigAs(EcobeeAccountConfiguration.class).refreshIntervalQuick;\n+        refreshIntervalQuick = value == null ? DEFAULT_REFRESH_INTERVAL_QUICK_SECONDS : value;\n+\n+        value = getConfigAs(EcobeeAccountConfiguration.class).apiTimeout;\n+        apiTimeout = (value == null ? DEFAULT_API_TIMEOUT_SECONDS : value) * 1000;\n+\n+        Boolean booleanValue = getConfigAs(EcobeeAccountConfiguration.class).discoveryEnabled;\n+        discoveryEnabled = booleanValue == null ? false : booleanValue.booleanValue();\n+        logger.info(\"AccountBridge: Thermostat and sensor discovery is {}\", discoveryEnabled ? \"enabled\" : \"disabled\");", "originalCommit": "f80ace88210a297be78b283d51e34a040ae97d69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIzNTk3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403235977", "bodyText": "Yep!", "author": "mhilbush", "createdAt": "2020-04-03T18:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3MzMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMDAzNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403320035", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-04-03T20:42:36Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/enums/FanMode.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.enums;\n+\n+import com.google.gson.annotations.SerializedName;\n+\n+/**\n+ * The {@link FanMode} represents the possible fan modes.\n+ *\n+ * @author John Cocula - Initial contribution\n+ * @author Mark Hilbush - Adapt for OH2/3\n+ */\n+public enum FanMode {", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2MjQzMg==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403462432", "bodyText": "Done", "author": "mhilbush", "createdAt": "2020-04-04T12:04:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMDAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMDU3OA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403320578", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-04-03T20:43:18Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/enums/HoldType.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.enums;\n+\n+import com.google.gson.annotations.SerializedName;\n+\n+/**\n+ * The {@link HoldType} represents the possible hold types.\n+ *\n+ * @author John Cocula - Initial contribution\n+ * @author Mark Hilbush - Adapt for OH2/3\n+ */\n+public enum HoldType {", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2MjY5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403462696", "bodyText": "Done", "author": "mhilbush", "createdAt": "2020-04-04T12:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMDU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMjcxNA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403322714", "bodyText": "Maybe set the representation property as well?", "author": "cpmeister", "createdAt": "2020-04-03T20:46:13Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/discovery/ThermostatDiscoveryService.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.discovery;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.config.discovery.DiscoveryService;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerService;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.ThermostatDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeAccountBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link ThermostatDiscoveryService} is responsible for discovering the Ecobee\n+ * thermostats that are associated with the Ecobee Account.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ThermostatDiscoveryService extends AbstractDiscoveryService\n+        implements DiscoveryService, ThingHandlerService {\n+\n+    private final Logger logger = LoggerFactory.getLogger(ThermostatDiscoveryService.class);\n+\n+    private @NonNullByDefault({}) EcobeeAccountBridgeHandler bridgeHandler;\n+\n+    public ThermostatDiscoveryService() {\n+        super(30);\n+    }\n+\n+    @Override\n+    public void setThingHandler(@Nullable ThingHandler handler) {\n+        if (handler instanceof EcobeeAccountBridgeHandler) {\n+            this.bridgeHandler = (EcobeeAccountBridgeHandler) handler;\n+            this.bridgeHandler.setDiscoveryService(this);\n+        }\n+    }\n+\n+    @Override\n+    public @Nullable ThingHandler getThingHandler() {\n+        return bridgeHandler;\n+    }\n+\n+    @Override\n+    public void activate() {\n+        logger.debug(\"ThermostatDiscovery: Activating Ecobee thermostat discovery service for {}\",\n+                bridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"ThermostatDiscovery: Deactivating Ecobee thermostat discovery service for {}\",\n+                bridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THERMOSTAT_BRIDGE_THING_TYPES_UIDS;\n+    }\n+\n+    @Override\n+    public void startBackgroundDiscovery() {\n+        logger.trace(\"ThermostatDiscovery: Performing background discovery scan for {}\",\n+                bridgeHandler.getThing().getUID());\n+        discoverThermostats();\n+    }\n+\n+    @Override\n+    public void startScan() {\n+        logger.debug(\"ThermostatDiscovery: Starting discovery scan for {}\", bridgeHandler.getThing().getUID());\n+        discoverThermostats();\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        super.stopScan();\n+    }\n+\n+    private String buildLabel(String name) {\n+        return String.format(\"Ecobee Thermostat %s\", name);\n+    }\n+\n+    private synchronized void discoverThermostats() {\n+        for (ThermostatDTO thermostat : bridgeHandler.getRegisteredThermostats()) {\n+            String name = thermostat.name;\n+            String identifier = thermostat.identifier;\n+            if (identifier != null && name != null) {\n+                ThingUID thingUID = new ThingUID(UID_THERMOSTAT_BRIDGE, bridgeHandler.getThing().getUID(),\n+                        thermostat.identifier);\n+                thingDiscovered(createDiscoveryResult(thingUID, identifier, name));\n+                logger.trace(\"ThermostatDiscovery: Thermostat with id '{}' and name '{}' added to Inbox with UID '{}'\",\n+                        thermostat.identifier, thermostat.name, thingUID);\n+            }\n+        }\n+    }\n+\n+    private DiscoveryResult createDiscoveryResult(ThingUID thermostatUID, String identifier, String name) {\n+        Map<String, Object> properties = new HashMap<>(0);\n+        properties.put(CONFIG_THERMOSTAT_ID, identifier);\n+        return DiscoveryResultBuilder.create(thermostatUID).withProperties(properties)\n+                .withBridge(bridgeHandler.getThing().getUID()).withLabel(buildLabel(name)).build();", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2Mjk1NA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403462954", "bodyText": "Good idea. Done.", "author": "mhilbush", "createdAt": "2020-04-04T12:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMjcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNDU4Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403324587", "bodyText": "Maybe set the representation property as well?", "author": "cpmeister", "createdAt": "2020-04-03T20:48:41Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/discovery/SensorDiscoveryService.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.discovery;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.config.discovery.DiscoveryService;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerService;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.RemoteSensorDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeThermostatBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link SensorDiscoveryService} is responsible for discovering the Ecobee\n+ * sensors that are assigned to a thermostat.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class SensorDiscoveryService extends AbstractDiscoveryService implements DiscoveryService, ThingHandlerService {\n+\n+    private final Logger logger = LoggerFactory.getLogger(SensorDiscoveryService.class);\n+\n+    private @Nullable EcobeeThermostatBridgeHandler bridgeHandler;\n+\n+    public SensorDiscoveryService() {\n+        super(30);\n+    }\n+\n+    @Override\n+    public void setThingHandler(@Nullable ThingHandler handler) {\n+        if (handler instanceof EcobeeThermostatBridgeHandler) {\n+            ((EcobeeThermostatBridgeHandler) handler).setDiscoveryService(this);\n+            bridgeHandler = (EcobeeThermostatBridgeHandler) handler;\n+        }\n+    }\n+\n+    @Override\n+    public @Nullable ThingHandler getThingHandler() {\n+        return bridgeHandler;\n+    }\n+\n+    @Override\n+    public void activate() {\n+        logger.debug(\"SensorDiscovery: Activating Ecobee sensor discovery service\");\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"SensorDiscovery: Deactivating Ecobee sensor discovery service\");\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_SENSOR_THING_TYPES_UIDS;\n+    }\n+\n+    @Override\n+    public void startBackgroundDiscovery() {\n+        EcobeeThermostatBridgeHandler localBridgeHandler = bridgeHandler;\n+        if (localBridgeHandler == null) {\n+            logger.info(\"SensorDiscovery: Can't perform background discovery because bridgeHandler is null\");\n+            return;\n+        }\n+        logger.debug(\"SensorDiscovery: Performing background discovery scan for {}\",\n+                localBridgeHandler.getThing().getUID());\n+        discoverSensors();\n+    }\n+\n+    @Override\n+    public void startScan() {\n+        EcobeeThermostatBridgeHandler localBridgeHandler = bridgeHandler;\n+        if (localBridgeHandler == null) {\n+            logger.info(\"SensorDiscovery: Can't perform discovery scan because bridgeHandler is null\");\n+            return;\n+        }\n+        logger.debug(\"SensorDiscovery: Starting discovery scan for {}\", localBridgeHandler.getThing().getUID());\n+        discoverSensors();\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        super.stopScan();\n+    }\n+\n+    private String buildLabel(String name) {\n+        return String.format(\"Ecobee Sensor %s\", name);\n+    }\n+\n+    private synchronized void discoverSensors() {\n+        EcobeeThermostatBridgeHandler localBridgeHandler = bridgeHandler;\n+        if (localBridgeHandler == null) {\n+            logger.info(\"SensorDiscovery: Can't discover sensors because bridgeHandler is null\");\n+            return;\n+        }\n+        for (RemoteSensorDTO sensor : localBridgeHandler.getSensors()) {\n+            ThingUID bridgeUID = localBridgeHandler.getThing().getUID();\n+            ThingUID sensorUID = new ThingUID(UID_SENSOR_THING, bridgeUID, sensor.id.replace(\":\", \"-\"));\n+            thingDiscovered(createDiscoveryResult(sensorUID, bridgeUID, sensor));\n+            logger.trace(\"SensorDiscovery: Sensor with id '{}' and name '{}' added to Inbox with UID '{}'\", sensor.id,\n+                    sensor.name, sensorUID);\n+        }\n+    }\n+\n+    private DiscoveryResult createDiscoveryResult(ThingUID sensorUID, ThingUID bridgeUID, RemoteSensorDTO sensor) {\n+        Map<String, Object> properties = new HashMap<>(0);\n+        properties.put(CONFIG_SENSOR_ID, sensor.id);\n+        return DiscoveryResultBuilder.create(sensorUID).withProperties(properties).withBridge(bridgeUID)\n+                .withLabel(buildLabel(sensor.name)).build();", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2MzAxMA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403463010", "bodyText": "Done", "author": "mhilbush", "createdAt": "2020-04-04T12:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNDU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNzI5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403327299", "bodyText": "Would it be better to set a flag here so when the handler eventually does get assigned that it can start discovery at that time?", "author": "cpmeister", "createdAt": "2020-04-03T20:52:07Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/discovery/SensorDiscoveryService.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.discovery;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.config.discovery.DiscoveryService;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerService;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.RemoteSensorDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeThermostatBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link SensorDiscoveryService} is responsible for discovering the Ecobee\n+ * sensors that are assigned to a thermostat.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class SensorDiscoveryService extends AbstractDiscoveryService implements DiscoveryService, ThingHandlerService {\n+\n+    private final Logger logger = LoggerFactory.getLogger(SensorDiscoveryService.class);\n+\n+    private @Nullable EcobeeThermostatBridgeHandler bridgeHandler;\n+\n+    public SensorDiscoveryService() {\n+        super(30);\n+    }\n+\n+    @Override\n+    public void setThingHandler(@Nullable ThingHandler handler) {\n+        if (handler instanceof EcobeeThermostatBridgeHandler) {\n+            ((EcobeeThermostatBridgeHandler) handler).setDiscoveryService(this);\n+            bridgeHandler = (EcobeeThermostatBridgeHandler) handler;\n+        }\n+    }\n+\n+    @Override\n+    public @Nullable ThingHandler getThingHandler() {\n+        return bridgeHandler;\n+    }\n+\n+    @Override\n+    public void activate() {\n+        logger.debug(\"SensorDiscovery: Activating Ecobee sensor discovery service\");\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"SensorDiscovery: Deactivating Ecobee sensor discovery service\");\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_SENSOR_THING_TYPES_UIDS;\n+    }\n+\n+    @Override\n+    public void startBackgroundDiscovery() {\n+        EcobeeThermostatBridgeHandler localBridgeHandler = bridgeHandler;\n+        if (localBridgeHandler == null) {\n+            logger.info(\"SensorDiscovery: Can't perform background discovery because bridgeHandler is null\");", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NTgyMg==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403465822", "bodyText": "This is a good question.\nFirst, it appears that I've implemented the SensorDiscoveryService differently than the ThermostatDiscoveryService. \ud83d\ude1f  In one case, I used @NonNullByDefault({}) in the bridgeHandler declaration. in the other case I made it @Nullable.\nI'm a little unclear about something. In the old way of starting the discovery service, the discovery service was activated at the same time that the handler was created (removal also was handled the same way). That's because the handler factory took care of the creation of the handler AND the discovery service (e.g. see the squeezebox binding). Therefore, the discovery service could be certain that the handler was there when startBackgroundDiscovery was called.\nIt's not clear to me if that's still the case with this new method of activating the discovery service. But isn't that the point of having the discovery service implement the ThingHandlerService interface. Do you know?", "author": "mhilbush", "createdAt": "2020-04-04T12:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNzI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NDUwNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405144505", "bodyText": "Yea, there isn't any reasonable way that this would get called, might be appropriate to throw an InvalidStateException instead. I also think using @NonNullByDefault({}) on the bridge handler field would be an appropriate solution as well.", "author": "cpmeister", "createdAt": "2020-04-07T22:13:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNzI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ0NTEyMg==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405445122", "bodyText": "Done. Used @NonNullByDefault({}).", "author": "mhilbush", "createdAt": "2020-04-08T11:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNzI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzMjE0NA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403332144", "bodyText": "It would be better from a performance standpoint to use the logger for message formatting instead of trying to handle it yourself beforehand since use the logger from the get-go will allow avoiding wasting resources formatting a message that wouldn't get logged anyway due to logging levels.", "author": "cpmeister", "createdAt": "2020-04-03T20:58:30Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/api/EcobeeAuth.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.api;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.lang.exception.ExceptionUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.client.HttpResponseException;\n+import org.eclipse.jetty.client.api.ContentResponse;\n+import org.eclipse.jetty.client.api.Request;\n+import org.eclipse.jetty.http.HttpStatus;\n+import org.eclipse.smarthome.core.auth.client.oauth2.AccessTokenResponse;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthClientService;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthException;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.openhab.binding.ecobee.internal.dto.oauth.AuthorizeResponseDTO;\n+import org.openhab.binding.ecobee.internal.dto.oauth.TokenResponseDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeAccountBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link EcobeeAuth} performs the initial OAuth authorization\n+ * with the Ecobee authorization servers. Once this process is complete, the\n+ * AccessTokenResponse will be imported into the OHC OAuth Client Service.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class EcobeeAuth {\n+\n+    private final Logger logger = LoggerFactory.getLogger(EcobeeAuth.class);\n+\n+    private final EcobeeAccountBridgeHandler bridgeHandler;\n+    private final String apiKey;\n+    private final int apiTimeout;\n+    private final OAuthClientService oAuthClientService;\n+    private final HttpClient httpClient;\n+\n+    private EcobeeAuthState state;\n+\n+    private @Nullable AuthorizeResponseDTO authResponse;\n+\n+    private long pinExpirationTime;\n+\n+    /**\n+     * The authorization code needed to make the first-time request\n+     * of the refresh and access tokens. Obtained from the call to {@code authorize()}.\n+     */\n+    private @Nullable String code;\n+\n+    public EcobeeAuth(EcobeeAccountBridgeHandler bridgeHandler, String apiKey, int apiTimeout,\n+            OAuthClientService oAuthClientService, HttpClient httpClient) {\n+        this.apiKey = apiKey;\n+        this.apiTimeout = apiTimeout;\n+        this.oAuthClientService = oAuthClientService;\n+        this.httpClient = httpClient;\n+        this.bridgeHandler = bridgeHandler;\n+        pinExpirationTime = 0;\n+        state = EcobeeAuthState.NEED_PIN;\n+    }\n+\n+    public void setState(EcobeeAuthState newState) {\n+        if (newState != state) {\n+            logger.debug(\"EcobeeAuth: Change state from {} to {}\", state, newState);\n+            state = newState;\n+        }\n+    }\n+\n+    public boolean isComplete() {\n+        return state == EcobeeAuthState.COMPLETE;\n+    }\n+\n+    public EcobeeAuthState doAuthorization() throws EcobeeAuthException {\n+        switch (state) {\n+            case NEED_PIN:\n+                authorize();\n+                break;\n+            case NEED_TOKEN:\n+                getTokens();\n+                break;\n+            case COMPLETE:\n+                bridgeHandler.updateBridgeStatus(ThingStatus.ONLINE);\n+                break;\n+        }\n+        return state;\n+    }\n+\n+    /**\n+     * Call the Ecobee authorize endpoint to get the authorization code and PIN\n+     * that will be used a) validate the application in the the Ecobee user web portal,\n+     * and b) make the first time request for the access and refresh tokens.\n+     * Warnings are suppressed to avoid the Gson.fromJson warnings.\n+     */\n+    @SuppressWarnings({ \"null\", \"unused\" })\n+    private void authorize() throws EcobeeAuthException {\n+        logger.debug(\"EcobeeAuth: State is {}: Executing step: 'authorize'\", state);\n+        StringBuilder url = new StringBuilder(ECOBEE_AUTHORIZE_URL);\n+        url.append(\"?response_type=ecobeePin\");\n+        url.append(\"&client_id=\").append(apiKey);\n+        url.append(\"&scope=\").append(ECOBEE_SCOPE);\n+\n+        logger.trace(\"EcobeeAuth: Getting authorize URL={}\", url.toString());\n+        String response = executeUrl(\"GET\", url.toString());\n+        logger.trace(\"EcobeeAuth: Auth response: {}\", response);\n+\n+        try {\n+            authResponse = EcobeeApi.getGson().fromJson(response, AuthorizeResponseDTO.class);\n+            if (authResponse == null) {\n+                logger.debug(\"EcobeeAuth: Got null authorize response from Ecobee API\");\n+                setState(EcobeeAuthState.NEED_PIN);\n+            } else {\n+                if (StringUtils.isNotEmpty(authResponse.error)) {\n+                    throw new EcobeeAuthException(authResponse.error + \": \" + authResponse.errorDescription);\n+                }\n+                code = authResponse.code;\n+                writeLogMessage(authResponse.pin, authResponse.expiresIn);\n+                setPinExpirationTime(authResponse.expiresIn.longValue());\n+                updateBridgeStatus();\n+                setState(EcobeeAuthState.NEED_TOKEN);\n+            }\n+        } catch (JsonSyntaxException e) {\n+            logger.info(\"EcobeeAuth: Exception while parsing authorize response: {}\", e.getMessage());\n+            setState(EcobeeAuthState.NEED_PIN);\n+        }\n+    }\n+\n+    /**\n+     * Call the Ecobee token endpoint to get the access and refresh tokens. Once successfully retrieved,\n+     * the access and refresh tokens will be injected into the OHC OAuth service.\n+     * Warnings are suppressed to avoid the Gson.fromJson warnings.\n+     */\n+    @SuppressWarnings({ \"null\", \"unused\" })\n+    private void getTokens() throws EcobeeAuthException {\n+        logger.debug(\"EcobeeAuth: State is {}: Executing step: 'getToken'\", state);\n+        StringBuilder url = new StringBuilder(ECOBEE_TOKEN_URL);\n+        url.append(\"?grant_type=ecobeePin\");\n+        url.append(\"&code=\").append(code);\n+        url.append(\"&client_id=\").append(apiKey);\n+\n+        logger.trace(\"EcobeeAuth: Posting token URL={}\", url.toString());\n+        String response = executeUrl(\"POST\", url.toString());\n+        logger.trace(\"EcobeeAuth: Got a valid token response: {}\", response);\n+\n+        TokenResponseDTO tokenResponse = EcobeeApi.getGson().fromJson(response, TokenResponseDTO.class);\n+        if (tokenResponse == null) {\n+            logger.debug(\"EcobeeAuth: Got null token response from Ecobee API\");\n+            updateBridgeStatus();\n+            setState(isPinExpired() ? EcobeeAuthState.NEED_PIN : EcobeeAuthState.NEED_TOKEN);\n+            return;\n+        }\n+        if (StringUtils.isNotEmpty(tokenResponse.error)) {\n+            throw new EcobeeAuthException(tokenResponse.error + \": \" + tokenResponse.errorDescription);\n+        }\n+        AccessTokenResponse accessTokenResponse = new AccessTokenResponse();\n+        accessTokenResponse.setRefreshToken(tokenResponse.refreshToken);\n+        accessTokenResponse.setAccessToken(tokenResponse.accessToken);\n+        accessTokenResponse.setScope(tokenResponse.scope);\n+        accessTokenResponse.setTokenType(tokenResponse.tokenType);\n+        accessTokenResponse.setExpiresIn(tokenResponse.expiresIn);\n+        try {\n+            logger.debug(\"EcobeeAuth: Importing AccessTokenResponse into oAuthClientService!!!\");\n+            oAuthClientService.importAccessTokenResponse(accessTokenResponse);\n+            bridgeHandler.updateBridgeStatus(ThingStatus.ONLINE);\n+            setState(EcobeeAuthState.COMPLETE);\n+            return;\n+        } catch (OAuthException e) {\n+            logger.info(\"EcobeeAuth: Got OAuthException\", e);\n+            // No other processing needed here\n+        }\n+        updateBridgeStatus();\n+        setState(isPinExpired() ? EcobeeAuthState.NEED_PIN : EcobeeAuthState.NEED_TOKEN);\n+    }\n+\n+    private void writeLogMessage(String pin, Integer expiresIn) {\n+        logger.info(\"#################################################################\");\n+        logger.info(\"# Ecobee: U S E R   I N T E R A C T I O N   R E Q U I R E D !!\");\n+        logger.info(\"# Go to the Ecobee web portal, then:\");\n+        logger.info(\"# Enter PIN '{}' in My Apps within {} minutes.\", pin, expiresIn);\n+        logger.info(\"# NOTE: All API attempts will fail in the meantime.\");\n+        logger.info(\"#################################################################\");\n+    }\n+\n+    private void updateBridgeStatus() {\n+        AuthorizeResponseDTO response = authResponse;\n+        if (response != null) {\n+            bridgeHandler.updateBridgeStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_PENDING,\n+                    String.format(\"Awaiting entry of PIN %s. Expires in %d minutes\", response.pin,\n+                            getMinutesUntilPinExpiration()));\n+\n+        }\n+    }\n+\n+    private void setPinExpirationTime(long expiresIn) {\n+        pinExpirationTime = expiresIn + TimeUnit.MILLISECONDS.toMinutes(System.currentTimeMillis());\n+    }\n+\n+    private long getMinutesUntilPinExpiration() {\n+        return pinExpirationTime - TimeUnit.MILLISECONDS.toMinutes(System.currentTimeMillis());\n+    }\n+\n+    private boolean isPinExpired() {\n+        return getMinutesUntilPinExpiration() <= 0;\n+    }\n+\n+    private @Nullable String executeUrl(String method, String url) {\n+        Request request = httpClient.newRequest(url);\n+        request.timeout(apiTimeout, TimeUnit.MILLISECONDS);\n+        request.method(method);\n+        EcobeeApi.HTTP_HEADERS.forEach((k, v) -> request.header((String) k, (String) v));\n+\n+        String errorMsg;", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NzIwMA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403467200", "bodyText": "Yes, I agree with you in principle. However, in this case, the message formatting is not done in the normal path of execution. Only in exception conditions will this be done, which should be rare. As a result, the performance implication is minimal. WDYT?", "author": "mhilbush", "createdAt": "2020-04-04T12:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzMjE0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE1MTg1MA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405151850", "bodyText": "I think this coding pattern, if done correctly, would not impact performance, but I think it sets a bad example for other developers to try to follow. So I would prefer if it was changed.", "author": "cpmeister", "createdAt": "2020-04-07T22:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzMjE0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ0OTI2NA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405449264", "bodyText": "Fair enough. Done.", "author": "mhilbush", "createdAt": "2020-04-08T11:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzMjE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzMzEyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403333125", "bodyText": "toString is handled for you by the logger.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.trace(\"EcobeeAuth: Posting token URL={}\", url.toString());\n          \n          \n            \n                    logger.trace(\"EcobeeAuth: Posting token URL={}\", url);", "author": "cpmeister", "createdAt": "2020-04-03T21:00:37Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/api/EcobeeAuth.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.api;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.lang.exception.ExceptionUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.client.HttpResponseException;\n+import org.eclipse.jetty.client.api.ContentResponse;\n+import org.eclipse.jetty.client.api.Request;\n+import org.eclipse.jetty.http.HttpStatus;\n+import org.eclipse.smarthome.core.auth.client.oauth2.AccessTokenResponse;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthClientService;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthException;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.openhab.binding.ecobee.internal.dto.oauth.AuthorizeResponseDTO;\n+import org.openhab.binding.ecobee.internal.dto.oauth.TokenResponseDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeAccountBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link EcobeeAuth} performs the initial OAuth authorization\n+ * with the Ecobee authorization servers. Once this process is complete, the\n+ * AccessTokenResponse will be imported into the OHC OAuth Client Service.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class EcobeeAuth {\n+\n+    private final Logger logger = LoggerFactory.getLogger(EcobeeAuth.class);\n+\n+    private final EcobeeAccountBridgeHandler bridgeHandler;\n+    private final String apiKey;\n+    private final int apiTimeout;\n+    private final OAuthClientService oAuthClientService;\n+    private final HttpClient httpClient;\n+\n+    private EcobeeAuthState state;\n+\n+    private @Nullable AuthorizeResponseDTO authResponse;\n+\n+    private long pinExpirationTime;\n+\n+    /**\n+     * The authorization code needed to make the first-time request\n+     * of the refresh and access tokens. Obtained from the call to {@code authorize()}.\n+     */\n+    private @Nullable String code;\n+\n+    public EcobeeAuth(EcobeeAccountBridgeHandler bridgeHandler, String apiKey, int apiTimeout,\n+            OAuthClientService oAuthClientService, HttpClient httpClient) {\n+        this.apiKey = apiKey;\n+        this.apiTimeout = apiTimeout;\n+        this.oAuthClientService = oAuthClientService;\n+        this.httpClient = httpClient;\n+        this.bridgeHandler = bridgeHandler;\n+        pinExpirationTime = 0;\n+        state = EcobeeAuthState.NEED_PIN;\n+    }\n+\n+    public void setState(EcobeeAuthState newState) {\n+        if (newState != state) {\n+            logger.debug(\"EcobeeAuth: Change state from {} to {}\", state, newState);\n+            state = newState;\n+        }\n+    }\n+\n+    public boolean isComplete() {\n+        return state == EcobeeAuthState.COMPLETE;\n+    }\n+\n+    public EcobeeAuthState doAuthorization() throws EcobeeAuthException {\n+        switch (state) {\n+            case NEED_PIN:\n+                authorize();\n+                break;\n+            case NEED_TOKEN:\n+                getTokens();\n+                break;\n+            case COMPLETE:\n+                bridgeHandler.updateBridgeStatus(ThingStatus.ONLINE);\n+                break;\n+        }\n+        return state;\n+    }\n+\n+    /**\n+     * Call the Ecobee authorize endpoint to get the authorization code and PIN\n+     * that will be used a) validate the application in the the Ecobee user web portal,\n+     * and b) make the first time request for the access and refresh tokens.\n+     * Warnings are suppressed to avoid the Gson.fromJson warnings.\n+     */\n+    @SuppressWarnings({ \"null\", \"unused\" })\n+    private void authorize() throws EcobeeAuthException {\n+        logger.debug(\"EcobeeAuth: State is {}: Executing step: 'authorize'\", state);\n+        StringBuilder url = new StringBuilder(ECOBEE_AUTHORIZE_URL);\n+        url.append(\"?response_type=ecobeePin\");\n+        url.append(\"&client_id=\").append(apiKey);\n+        url.append(\"&scope=\").append(ECOBEE_SCOPE);\n+\n+        logger.trace(\"EcobeeAuth: Getting authorize URL={}\", url.toString());\n+        String response = executeUrl(\"GET\", url.toString());\n+        logger.trace(\"EcobeeAuth: Auth response: {}\", response);\n+\n+        try {\n+            authResponse = EcobeeApi.getGson().fromJson(response, AuthorizeResponseDTO.class);\n+            if (authResponse == null) {\n+                logger.debug(\"EcobeeAuth: Got null authorize response from Ecobee API\");\n+                setState(EcobeeAuthState.NEED_PIN);\n+            } else {\n+                if (StringUtils.isNotEmpty(authResponse.error)) {\n+                    throw new EcobeeAuthException(authResponse.error + \": \" + authResponse.errorDescription);\n+                }\n+                code = authResponse.code;\n+                writeLogMessage(authResponse.pin, authResponse.expiresIn);\n+                setPinExpirationTime(authResponse.expiresIn.longValue());\n+                updateBridgeStatus();\n+                setState(EcobeeAuthState.NEED_TOKEN);\n+            }\n+        } catch (JsonSyntaxException e) {\n+            logger.info(\"EcobeeAuth: Exception while parsing authorize response: {}\", e.getMessage());\n+            setState(EcobeeAuthState.NEED_PIN);\n+        }\n+    }\n+\n+    /**\n+     * Call the Ecobee token endpoint to get the access and refresh tokens. Once successfully retrieved,\n+     * the access and refresh tokens will be injected into the OHC OAuth service.\n+     * Warnings are suppressed to avoid the Gson.fromJson warnings.\n+     */\n+    @SuppressWarnings({ \"null\", \"unused\" })\n+    private void getTokens() throws EcobeeAuthException {\n+        logger.debug(\"EcobeeAuth: State is {}: Executing step: 'getToken'\", state);\n+        StringBuilder url = new StringBuilder(ECOBEE_TOKEN_URL);\n+        url.append(\"?grant_type=ecobeePin\");\n+        url.append(\"&code=\").append(code);\n+        url.append(\"&client_id=\").append(apiKey);\n+\n+        logger.trace(\"EcobeeAuth: Posting token URL={}\", url.toString());", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NzI4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403467283", "bodyText": "Fixed", "author": "mhilbush", "createdAt": "2020-04-04T12:55:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzMzEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzMzQ5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403333497", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.trace(\"EcobeeAuth: Getting authorize URL={}\", url.toString());\n          \n          \n            \n                    logger.trace(\"EcobeeAuth: Getting authorize URL={}\", url);", "author": "cpmeister", "createdAt": "2020-04-03T21:01:21Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/api/EcobeeAuth.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.api;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.lang.exception.ExceptionUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.client.HttpResponseException;\n+import org.eclipse.jetty.client.api.ContentResponse;\n+import org.eclipse.jetty.client.api.Request;\n+import org.eclipse.jetty.http.HttpStatus;\n+import org.eclipse.smarthome.core.auth.client.oauth2.AccessTokenResponse;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthClientService;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthException;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.openhab.binding.ecobee.internal.dto.oauth.AuthorizeResponseDTO;\n+import org.openhab.binding.ecobee.internal.dto.oauth.TokenResponseDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeAccountBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link EcobeeAuth} performs the initial OAuth authorization\n+ * with the Ecobee authorization servers. Once this process is complete, the\n+ * AccessTokenResponse will be imported into the OHC OAuth Client Service.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class EcobeeAuth {\n+\n+    private final Logger logger = LoggerFactory.getLogger(EcobeeAuth.class);\n+\n+    private final EcobeeAccountBridgeHandler bridgeHandler;\n+    private final String apiKey;\n+    private final int apiTimeout;\n+    private final OAuthClientService oAuthClientService;\n+    private final HttpClient httpClient;\n+\n+    private EcobeeAuthState state;\n+\n+    private @Nullable AuthorizeResponseDTO authResponse;\n+\n+    private long pinExpirationTime;\n+\n+    /**\n+     * The authorization code needed to make the first-time request\n+     * of the refresh and access tokens. Obtained from the call to {@code authorize()}.\n+     */\n+    private @Nullable String code;\n+\n+    public EcobeeAuth(EcobeeAccountBridgeHandler bridgeHandler, String apiKey, int apiTimeout,\n+            OAuthClientService oAuthClientService, HttpClient httpClient) {\n+        this.apiKey = apiKey;\n+        this.apiTimeout = apiTimeout;\n+        this.oAuthClientService = oAuthClientService;\n+        this.httpClient = httpClient;\n+        this.bridgeHandler = bridgeHandler;\n+        pinExpirationTime = 0;\n+        state = EcobeeAuthState.NEED_PIN;\n+    }\n+\n+    public void setState(EcobeeAuthState newState) {\n+        if (newState != state) {\n+            logger.debug(\"EcobeeAuth: Change state from {} to {}\", state, newState);\n+            state = newState;\n+        }\n+    }\n+\n+    public boolean isComplete() {\n+        return state == EcobeeAuthState.COMPLETE;\n+    }\n+\n+    public EcobeeAuthState doAuthorization() throws EcobeeAuthException {\n+        switch (state) {\n+            case NEED_PIN:\n+                authorize();\n+                break;\n+            case NEED_TOKEN:\n+                getTokens();\n+                break;\n+            case COMPLETE:\n+                bridgeHandler.updateBridgeStatus(ThingStatus.ONLINE);\n+                break;\n+        }\n+        return state;\n+    }\n+\n+    /**\n+     * Call the Ecobee authorize endpoint to get the authorization code and PIN\n+     * that will be used a) validate the application in the the Ecobee user web portal,\n+     * and b) make the first time request for the access and refresh tokens.\n+     * Warnings are suppressed to avoid the Gson.fromJson warnings.\n+     */\n+    @SuppressWarnings({ \"null\", \"unused\" })\n+    private void authorize() throws EcobeeAuthException {\n+        logger.debug(\"EcobeeAuth: State is {}: Executing step: 'authorize'\", state);\n+        StringBuilder url = new StringBuilder(ECOBEE_AUTHORIZE_URL);\n+        url.append(\"?response_type=ecobeePin\");\n+        url.append(\"&client_id=\").append(apiKey);\n+        url.append(\"&scope=\").append(ECOBEE_SCOPE);\n+\n+        logger.trace(\"EcobeeAuth: Getting authorize URL={}\", url.toString());", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NzI5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403467293", "bodyText": "Fixed", "author": "mhilbush", "createdAt": "2020-04-04T12:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzMzQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNDc1MA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403334750", "bodyText": "If name has to be non-null why not just make the parameter non-null instead of @Nullable?", "author": "cpmeister", "createdAt": "2020-04-03T21:03:59Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/function/DeleteVacationFunction.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.function;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+\n+/**\n+ * The delete vacation function deletes a vacation event from a thermostat. This is the\n+ * only way to cancel a vacation event. This method is able to remove vacation\n+ * events not yet started and scheduled in the future.\n+ *\n+ * @author John Cocula - Initial contribution\n+ * @author Mark Hilbush - Adapt for OH2/3\n+ */\n+@NonNullByDefault\n+public final class DeleteVacationFunction extends AbstractFunction {\n+\n+    public DeleteVacationFunction(@Nullable String name) {\n+        super(\"deleteVacation\");\n+        if (name == null) {\n+            throw new IllegalArgumentException(\"name argument is required.\");\n+        }", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2Nzc5OA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403467798", "bodyText": "The DeleteVacationFunction is instantiated when a thing action is executed. Therefore, I was trying to deal with the possibility that the user passed a null value in the call to the deleteVacation thing action. I suppose I could check for null in the deleteVacation method in EcobeeActions. But then I'd likely need to change some/all of the other actions to be consistent. WDYT?", "author": "mhilbush", "createdAt": "2020-04-04T13:01:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNDc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzODUzNg==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403338536", "bodyText": "Please cache your config!", "author": "cpmeister", "createdAt": "2020-04-03T21:12:50Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/handler/EcobeeAccountBridgeHandler.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.handler;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.CONFIG_THERMOSTAT_ID;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthFactory;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.binding.BaseBridgeHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerService;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.openhab.binding.ecobee.internal.api.EcobeeApi;\n+import org.openhab.binding.ecobee.internal.config.EcobeeAccountConfiguration;\n+import org.openhab.binding.ecobee.internal.discovery.ThermostatDiscoveryService;\n+import org.openhab.binding.ecobee.internal.dto.SelectionDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.ThermostatDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.ThermostatUpdateRequestDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.summary.SummaryResponseDTO;\n+import org.openhab.binding.ecobee.internal.function.FunctionRequest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link EcobeeAccountBridgeHandler} is responsible for managing\n+ * communication with the Ecobee API.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class EcobeeAccountBridgeHandler extends BaseBridgeHandler {\n+\n+    private static final int REFRESH_STARTUP_DELAY_SECONDS = 3;\n+    private static final int REFRESH_INTERVAL_SECONDS = 1;\n+    private static final int DISCOVERY_INTERVAL_SECONDS = 300;\n+    private static final int DISCOVERY_INITIAL_DELAY_SECONDS = 10;\n+    private static final int DEFAULT_REFRESH_INTERVAL_NORMAL_SECONDS = 20;\n+    private static final int DEFAULT_REFRESH_INTERVAL_QUICK_SECONDS = 5;\n+    private static final int DEFAULT_API_TIMEOUT_SECONDS = 20;\n+\n+    private final Logger logger = LoggerFactory.getLogger(EcobeeAccountBridgeHandler.class);\n+\n+    private final OAuthFactory oAuthFactory;\n+    private final HttpClient httpClient;\n+\n+    private @NonNullByDefault({}) EcobeeApi api;\n+    private @NonNullByDefault({}) String apiKey;\n+    private int refreshIntervalNormal;\n+    private int refreshIntervalQuick;\n+    private int apiTimeout;\n+    private boolean discoveryEnabled;\n+    private int discoveryInterval;\n+\n+    private final Map<String, EcobeeThermostatBridgeHandler> thermostatHandlers = new ConcurrentHashMap<>();\n+    private final Set<String> thermostatIds = new CopyOnWriteArraySet<>();\n+\n+    private @Nullable Future<?> refreshThermostatsJob;\n+    private final AtomicInteger refreshThermostatsCounter = new AtomicInteger(REFRESH_STARTUP_DELAY_SECONDS);\n+    private final AtomicInteger discoveryCounter = new AtomicInteger(DISCOVERY_INITIAL_DELAY_SECONDS);\n+    private @Nullable ThermostatDiscoveryService discoveryService;\n+\n+    private @Nullable SummaryResponseDTO previousSummary;\n+\n+    public EcobeeAccountBridgeHandler(final Bridge bridge, OAuthFactory oAuthFactory, HttpClient httpClient) {\n+        super(bridge);\n+        this.oAuthFactory = oAuthFactory;\n+        this.httpClient = httpClient;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"AccountBridge: Initializing\");\n+        apiKey = getConfigAs(EcobeeAccountConfiguration.class).apiKey;", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODEzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403468139", "bodyText": "Good catch. Fixed.", "author": "mhilbush", "createdAt": "2020-04-04T13:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzODUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzOTEzNg==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403339136", "bodyText": "Could you explain how this is being used? It isn't entirely clear to me from reading the code...", "author": "cpmeister", "createdAt": "2020-04-03T21:14:07Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/handler/EcobeeAccountBridgeHandler.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.handler;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.CONFIG_THERMOSTAT_ID;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.smarthome.core.auth.client.oauth2.OAuthFactory;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.binding.BaseBridgeHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerService;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.openhab.binding.ecobee.internal.api.EcobeeApi;\n+import org.openhab.binding.ecobee.internal.config.EcobeeAccountConfiguration;\n+import org.openhab.binding.ecobee.internal.discovery.ThermostatDiscoveryService;\n+import org.openhab.binding.ecobee.internal.dto.SelectionDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.ThermostatDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.ThermostatUpdateRequestDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.summary.SummaryResponseDTO;\n+import org.openhab.binding.ecobee.internal.function.FunctionRequest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link EcobeeAccountBridgeHandler} is responsible for managing\n+ * communication with the Ecobee API.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class EcobeeAccountBridgeHandler extends BaseBridgeHandler {\n+\n+    private static final int REFRESH_STARTUP_DELAY_SECONDS = 3;\n+    private static final int REFRESH_INTERVAL_SECONDS = 1;\n+    private static final int DISCOVERY_INTERVAL_SECONDS = 300;\n+    private static final int DISCOVERY_INITIAL_DELAY_SECONDS = 10;\n+    private static final int DEFAULT_REFRESH_INTERVAL_NORMAL_SECONDS = 20;\n+    private static final int DEFAULT_REFRESH_INTERVAL_QUICK_SECONDS = 5;\n+    private static final int DEFAULT_API_TIMEOUT_SECONDS = 20;\n+\n+    private final Logger logger = LoggerFactory.getLogger(EcobeeAccountBridgeHandler.class);\n+\n+    private final OAuthFactory oAuthFactory;\n+    private final HttpClient httpClient;\n+\n+    private @NonNullByDefault({}) EcobeeApi api;\n+    private @NonNullByDefault({}) String apiKey;\n+    private int refreshIntervalNormal;\n+    private int refreshIntervalQuick;\n+    private int apiTimeout;\n+    private boolean discoveryEnabled;\n+    private int discoveryInterval;\n+\n+    private final Map<String, EcobeeThermostatBridgeHandler> thermostatHandlers = new ConcurrentHashMap<>();\n+    private final Set<String> thermostatIds = new CopyOnWriteArraySet<>();\n+\n+    private @Nullable Future<?> refreshThermostatsJob;\n+    private final AtomicInteger refreshThermostatsCounter = new AtomicInteger(REFRESH_STARTUP_DELAY_SECONDS);", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODcxOA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403468718", "bodyText": "Rather than manage multiple scheduled jobs for normal polling, quick polling, and discovery, I have a single job that runs every second. I then use refreshThermostatsCounter and discoveryCounter to control the rate at which thermostat refresh and thermostat discovery will be performed.\nIt's especially useful when I need to flip between the normal refresh interval and the quick refresh interval. This way I'm not constantly starting and stopping scheduled jobs.\nThe overhead of running every second is very low, except when refresh and/or discovery needs to run.", "author": "mhilbush", "createdAt": "2020-04-04T13:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzOTEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0MTEzMA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405141130", "bodyText": "Thanks for explaining it.", "author": "cpmeister", "createdAt": "2020-04-07T22:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzOTEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0MjIwNg==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403342206", "bodyText": "What are you suppressing here?", "author": "cpmeister", "createdAt": "2020-04-03T21:21:21Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/handler/EcobeeSensorThingHandler.java", "diffHunk": "@@ -0,0 +1,193 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.handler;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import org.apache.commons.lang.WordUtils;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.smarthome.core.library.unit.SmartHomeUnits;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.builder.ChannelBuilder;\n+import org.eclipse.smarthome.core.thing.binding.builder.ThingBuilder;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.openhab.binding.ecobee.internal.config.EcobeeSensorConfiguration;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.RemoteSensorCapabilityDTO;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.RemoteSensorDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link EcobeeSensorThingHandler} is responsible for updating the channels associated\n+ * with an Ecobee remote sensor.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class EcobeeSensorThingHandler extends BaseThingHandler {\n+\n+    public static final String CAPABILITY_ADC = \"adc\";\n+    public static final String CAPABILITY_CO2 = \"co2\";\n+    public static final String CAPABILITY_DRY_CONTACT = \"dryContact\";\n+    public static final String CAPABILITY_HUMIDITY = \"humidity\";\n+    public static final String CAPABILITY_OCCUPANCY = \"occupancy\";\n+    public static final String CAPABILITY_TEMPERATURE = \"temperature\";\n+    public static final String CAPABILITY_UNKNOWN = \"unknown\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(EcobeeSensorThingHandler.class);\n+\n+    private @NonNullByDefault({}) String sensorId;\n+\n+    private Map<String, State> stateCache = new ConcurrentHashMap<>();\n+\n+    public EcobeeSensorThingHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        sensorId = getConfigAs(EcobeeSensorConfiguration.class).sensorId;\n+        logger.debug(\"SensorThing: Initializing sensor '{}'\", sensorId);\n+        clearSavedState();\n+        updateStatus(EcobeeUtils.isBridgeOnline(getBridge()) ? ThingStatus.ONLINE : ThingStatus.OFFLINE);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        logger.debug(\"SensorThing: Disposing sensor '{}'\", sensorId);\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(ThingStatusInfo bridgeStatusInfo) {\n+        if (bridgeStatusInfo.getStatus() == ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.ONLINE);\n+        } else {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"null\")", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODI5NA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403468294", "bodyText": "Eclipse complains about a redundant null check on the call stateCache.get(channelUID.getId()).", "author": "mhilbush", "createdAt": "2020-04-04T13:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0MjIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDE4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403350186", "bodyText": "Why aren't any of these casts getting checked beforehand?", "author": "cpmeister", "createdAt": "2020-04-03T21:41:37Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/action/EcobeeActions.java", "diffHunk": "@@ -0,0 +1,783 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.action;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.measure.quantity.Temperature;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.QuantityType;\n+import org.eclipse.smarthome.core.thing.binding.ThingActions;\n+import org.eclipse.smarthome.core.thing.binding.ThingActionsScope;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.EventDTO;\n+import org.openhab.binding.ecobee.internal.enums.AckType;\n+import org.openhab.binding.ecobee.internal.enums.FanMode;\n+import org.openhab.binding.ecobee.internal.enums.HoldType;\n+import org.openhab.binding.ecobee.internal.enums.PlugState;\n+import org.openhab.binding.ecobee.internal.enums.VentilatorMode;\n+import org.openhab.binding.ecobee.internal.function.AcknowledgeFunction;\n+import org.openhab.binding.ecobee.internal.function.ControlPlugFunction;\n+import org.openhab.binding.ecobee.internal.function.CreateVacationFunction;\n+import org.openhab.binding.ecobee.internal.function.DeleteVacationFunction;\n+import org.openhab.binding.ecobee.internal.function.ResetPreferencesFunction;\n+import org.openhab.binding.ecobee.internal.function.ResumeProgramFunction;\n+import org.openhab.binding.ecobee.internal.function.SendMessageFunction;\n+import org.openhab.binding.ecobee.internal.function.SetHoldFunction;\n+import org.openhab.binding.ecobee.internal.function.SetOccupiedFunction;\n+import org.openhab.binding.ecobee.internal.function.UpdateSensorFunction;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeThermostatBridgeHandler;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeUtils;\n+import org.openhab.core.automation.annotation.ActionInput;\n+import org.openhab.core.automation.annotation.ActionOutput;\n+import org.openhab.core.automation.annotation.RuleAction;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link EcobeeActions} defines the thing actions for the Ecobee binding.\n+ *\n+ * @author John Cocula - Initial contribution\n+ * @author Mark Hilbush - Adapted for OH2/3\n+ */\n+@ThingActionsScope(name = \"ecobee\")\n+@NonNullByDefault\n+public class EcobeeActions implements ThingActions {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EcobeeActions.class);\n+\n+    private @Nullable EcobeeThermostatBridgeHandler handler;\n+\n+    public EcobeeActions() {\n+        LOGGER.debug(\"EcobeeActions: EcobeeActions: Actions service created\");\n+    }\n+\n+    @Override\n+    public void setThingHandler(@Nullable ThingHandler handler) {\n+        if (handler instanceof EcobeeThermostatBridgeHandler) {\n+            this.handler = (EcobeeThermostatBridgeHandler) handler;\n+        }\n+    }\n+\n+    @Override\n+    public @Nullable ThingHandler getThingHandler() {\n+        return this.handler;\n+    }\n+\n+    /**\n+     * The acknowledge function allows an alert to be acknowledged.\n+     *\n+     * @see <a\n+     *      href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/Acknowledge.shtml\">Acknowledge\n+     *      </a>\n+     */\n+    @RuleAction(label = \"Acknowledge\", description = \"Acknowledges an alert.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean acknowledge(\n+            @ActionInput(name = \"ackRef\", description = \"The acknowledge ref of alert\") @Nullable String ackRef,\n+            @ActionInput(name = \"ackType\", description = \"The type of acknowledgement. Valid values: accept, decline, defer, unacknowledged\") String ackType,\n+            @ActionInput(name = \"remindMeLater\", description = \"(opt) Whether to remind at a later date, if this is a defer acknowledgement\") @Nullable Boolean remindMeLater) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Acknowledge' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        AcknowledgeFunction function = new AcknowledgeFunction(localHandler.getThermostatId(), ackRef,\n+                AckType.forValue(ackType), remindMeLater);\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean acknowledge(@Nullable ThingActions actions, @Nullable String ackRef, @Nullable String ackType,\n+            @Nullable Boolean remindMeLater) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) (actions.getClass()\n+                    .getDeclaredMethod(\"acknowledge\", String.class, String.class, Boolean.class)\n+                    .invoke(actions, ackRef, ackType, remindMeLater));\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Control the on/off state of a plug by setting a hold on the plug.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/ControlPlug.shtml\">Control\n+     *      Plug</a>\n+     */\n+    @RuleAction(label = \"Control Plug\", description = \"Control the on/off state of a plug by setting a hold on the plug.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean controlPlug(\n+            @ActionInput(name = \"plugName\", description = \"The name of the plug. Ensure each plug has a unique name.\") @Nullable String plugName,\n+            @ActionInput(name = \"plugState\", description = \"The state to put the plug into. Valid values: on, off, resume.\") @Nullable String plugState,\n+            @ActionInput(name = \"startDateTime\", description = \"(opt) The start date/time in thermostat time.\") @Nullable Date startDateTime,\n+            @ActionInput(name = \"endDateTime\", description = \"(opt) The end date/time in thermostat time.\") @Nullable Date endDateTime,\n+            @ActionInput(name = \"holdType\", description = \"(opt) The hold duration type. Valid values: dateTime, nextTransition, indefinite, holdHours.\") @Nullable String holdType,\n+            @ActionInput(name = \"holdHours\", description = \"(opt) The number of hours to hold for, used and required if holdType='holdHours'.\") @Nullable Number holdHours) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Control Plug' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        ControlPlugFunction function = (new ControlPlugFunction(plugName, PlugState.forValue(plugState), startDateTime,\n+                endDateTime, (holdType == null) ? null : HoldType.forValue(holdType),\n+                (holdHours == null) ? null : Integer.valueOf(holdHours.intValue())));\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean controlPlug(@Nullable ThingActions actions, @Nullable String plugName,\n+            @Nullable String plugState, @Nullable Date startDateTime, @Nullable Date endDateTime,\n+            @Nullable String holdType, @Nullable Number holdHours) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) (actions.getClass()\n+                    .getDeclaredMethod(\"controlPlug\", String.class, String.class, Date.class, Date.class, String.class,\n+                            Number.class)\n+                    .invoke(actions, plugName, plugState, startDateTime, endDateTime, holdType, holdHours));\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The create vacation function creates a vacation event on the thermostat.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/CreateVacation.shtml\">Create\n+     *      Vacation</a>\n+     */\n+    @RuleAction(label = \"Create Vacation\", description = \"The create vacation function creates a vacation event on the thermostat.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean createVacation(\n+            @ActionInput(name = \"name\", description = \"The vacation event name. It must be unique.\") @Nullable String name,\n+            @ActionInput(name = \"coolHoldTemp\", description = \"The temperature at which to set the cool vacation hold.\") @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @ActionInput(name = \"heatHoldTemp\", description = \"The temperature at which to set the heat vacation hold.\") @Nullable QuantityType<Temperature> heatHoldTemp,\n+            @ActionInput(name = \"startDateTime\", description = \"(opt) The start date/time in thermostat time.\") @Nullable Date startDateTime,\n+            @ActionInput(name = \"endDateTime\", description = \"(opt) The end date in thermostat time.\") @Nullable Date endDateTime,\n+            @ActionInput(name = \"fan\", description = \"(opt) The fan mode during the vacation. Values: auto, on Default: auto\") @Nullable String fan,\n+            @ActionInput(name = \"fanMinOnTime\", description = \"(opt) The minimum number of minutes to run the fan each hour. Range: 0-60, Default: 0\") @Nullable Number fanMinOnTime) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Create Vacation' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        CreateVacationFunction function = new CreateVacationFunction(name, coolHoldTemp, heatHoldTemp, startDateTime,\n+                endDateTime, (fan == null) ? null : FanMode.forValue(fan),\n+                (fanMinOnTime == null) ? null : Integer.valueOf(fanMinOnTime.intValue()));\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean createVacation(@Nullable ThingActions actions, @Nullable String name,\n+            @Nullable QuantityType<Temperature> coolHoldTemp, @Nullable QuantityType<Temperature> heatHoldTemp,\n+            @Nullable Date startDateTime, @Nullable Date endDateTime, @Nullable String fan,\n+            @Nullable Number fanMinOnTime) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass()\n+                    .getDeclaredMethod(\"createVacation\", String.class, QuantityType.class, QuantityType.class,\n+                            Date.class, Date.class, String.class, Number.class)\n+                    .invoke(actions, name, coolHoldTemp, heatHoldTemp, startDateTime, endDateTime, fan, fanMinOnTime);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The delete vacation function deletes a vacation event from a thermostat.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/DeleteVacation.shtml\">Delete\n+     *      Vacation</a>\n+     */\n+    @RuleAction(label = \"Delete Vacation\", description = \"The delete vacation function deletes a vacation event from a thermostat.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean deleteVacation(\n+            @ActionInput(name = \"name\", description = \"The vacation event name to delete.\") @Nullable String name) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Delete Vacation' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        DeleteVacationFunction function = new DeleteVacationFunction(name);\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean deleteVacation(@Nullable ThingActions actions, @Nullable String name) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"deleteVacation\", String.class).invoke(actions, name);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The reset preferences function sets all of the user configurable settings back to the factory default values.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/ResetPreferences.shtml\">Reset\n+     *      Preferences</a>\n+     */\n+    @RuleAction(label = \"Reset Preferences\", description = \"The reset preferences function sets all of the user configurable settings back to the factory default values.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean resetPreferences() {\n+        LOGGER.debug(\"EcobeeActions: Action 'Reset Preferences' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        ResetPreferencesFunction function = new ResetPreferencesFunction();\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean resetPreferences(@Nullable ThingActions actions) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"resetPreferences\").invoke(actions);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The resume program function removes the currently running event.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/ResumeProgram.shtml\">Resume\n+     *      Program</a>\n+     */\n+    @RuleAction(label = \"Resume Program\", description = \"Removes the currently running event providing the event is not a mandatory demand response event\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean resumeProgram(\n+            @ActionInput(name = \"resumeAll\", description = \"(opt) Should the thermostat be resumed to next event (false) or to its program (true)\") @Nullable Boolean resumeAll) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Resume Program' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        ResumeProgramFunction function = new ResumeProgramFunction(resumeAll);\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean resumeProgram(@Nullable ThingActions actions, @Nullable Boolean resumeAll) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"resumeProgram\", Boolean.class).invoke(actions,\n+                    resumeAll);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The send message function allows an alert message to be sent to the thermostat.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/SendMessage.shtml\">Send\n+     *      Message</a>\n+     */\n+    @RuleAction(label = \"Send Message\", description = \"The send message function allows an alert message to be sent to the thermostat.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean sendMessage(\n+            @ActionInput(name = \"text\", description = \"The message text to send. Text will be truncated to 500 characters if longer\") @Nullable String text) {\n+        LOGGER.debug(\"EcobeeActions: Action 'SendMessage' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        SendMessageFunction function = new SendMessageFunction(text);\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean sendMessage(@Nullable ThingActions actions, @Nullable String text) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"sendMessage\", String.class).invoke(actions, text);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set an indefinite hold using the supplied the cool and heat hold temperatures\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/SetHold.shtml\">Set Hold</a>\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified temperatures.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"coolHoldTemp\", description = \"The temperature at which to set the cool hold.\") @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @ActionInput(name = \"heatHoldTemp\", description = \"The temperature at which to set the heat hold.\") @Nullable QuantityType<Temperature> heatHoldTemp) {\n+        if (coolHoldTemp == null || heatHoldTemp == null) {\n+            throw new IllegalArgumentException(\"hold temperatures cannot be null\");\n+        }\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"coolHoldTemp\", coolHoldTemp);\n+        params.put(\"heatHoldTemp\", heatHoldTemp);\n+        return setHold(params, null, null, null, null);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @Nullable QuantityType<Temperature> heatHoldTemp) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"setHold\", QuantityType.class, QuantityType.class)\n+                    .invoke(actions, coolHoldTemp, heatHoldTemp);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set a hold by providing the cool and heat temperatures and the number of hours.\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold for the specified number of hours.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"coolHoldTemp\", description = \"The temperature at which to set the cool hold.\") @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @ActionInput(name = \"heatHoldTemp\", description = \"The temperature at which to set the heat hold.\") @Nullable QuantityType<Temperature> heatHoldTemp,\n+            @ActionInput(name = \"holdHours\", description = \"The number of hours for the hold.\") @Nullable Number holdHours) {\n+        if (coolHoldTemp == null || heatHoldTemp == null) {\n+            throw new IllegalArgumentException(\"hold temperatures cannot be null\");\n+        }\n+        if (holdHours == null) {\n+            throw new IllegalArgumentException(\"number of hold hours is missing\");\n+        }\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"coolHoldTemp\", coolHoldTemp);\n+        params.put(\"heatHoldTemp\", heatHoldTemp);\n+        params.put(\"holdType\", HoldType.HOLD_HOURS);\n+        params.put(\"holdHours\", Integer.valueOf(holdHours.intValue()));\n+        return setHold(params, null, null, null, null);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @Nullable QuantityType<Temperature> heatHoldTemp, @Nullable Number holdHours) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass()\n+                    .getDeclaredMethod(\"setHold\", QuantityType.class, QuantityType.class, Number.class)\n+                    .invoke(actions, coolHoldTemp, heatHoldTemp, holdHours);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set an indefinite hold using the supplied climateRef\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified climate ref.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"holdClimateRef\", description = \"The holdClimateRef used to set the hold.\") @Nullable String holdClimateRef) {\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        if (holdClimateRef == null || !localHandler.isValidClimateRef(holdClimateRef)) {\n+            throw new IllegalArgumentException(\"hold climate ref is missing or invalid\");\n+        }\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"holdClimateRef\", holdClimateRef);\n+        return setHold(params, null, null, null, null);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable String holdClimateRef) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"setHold\", String.class).invoke(actions,\n+                    holdClimateRef);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set a hold using the supplied climateRef for the supplied number of hours.\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified climate ref.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"holdClimateRef\", description = \"The holdClimateRef used to set the hold.\") @Nullable String holdClimateRef,\n+            @ActionInput(name = \"holdHours\", description = \"The number of hours for the hold.\") @Nullable Number holdHours) {\n+        if (holdHours == null) {\n+            throw new IllegalArgumentException(\"number of hold hours is missing\");\n+        }\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        if (holdClimateRef == null || !localHandler.isValidClimateRef(holdClimateRef)) {\n+            throw new IllegalArgumentException(\"hold climate ref is missing or invalid\");\n+        }\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"holdClimateRef\", holdClimateRef);\n+        params.put(\"holdType\", HoldType.HOLD_HOURS);\n+        params.put(\"holdHours\", Integer.valueOf(holdHours.intValue()));\n+        return setHold(params, null, null, null, null);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable String holdClimateRef,\n+            @Nullable Number holdHours) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"setHold\", String.class, Number.class).invoke(actions,\n+                    holdClimateRef, holdHours);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set a hold\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified temperature or climate ref.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"coolHoldTemp\", description = \"(opt) The temperature at which to set the cool hold.\") @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @ActionInput(name = \"heatHoldTemp\", description = \"(opt) The temperature at which to set the heat hold.\") @Nullable QuantityType<Temperature> heatHoldTemp,\n+            @ActionInput(name = \"holdClimateRef\", description = \"(opt) The Climate to use as reference for setting the coolHoldTemp, heatHoldTemp and fan settings for this hold. If this value is passed the coolHoldTemp and heatHoldTemp are not required.\") @Nullable String holdClimateRef,\n+            @ActionInput(name = \"startDateTime\", description = \"(opt) The start date in thermostat time.\") @Nullable Date startDateTime,\n+            @ActionInput(name = \"endDateTime\", description = \"(opt) The end date in thermostat time.\") @Nullable Date endDateTime,\n+            @ActionInput(name = \"holdType\", description = \"(opt) The hold duration type. Valid values: dateTime, nextTransition, indefinite, holdHours.\") @Nullable String holdType,\n+            @ActionInput(name = \"holdHours\", description = \"(opt) The number of hours to hold for, used and required if holdType='holdHours'.\") @Nullable Number holdHours) {\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        if (coolHoldTemp != null) {\n+            params.put(\"coolHoldTemp\", coolHoldTemp);\n+        }\n+        if (heatHoldTemp != null) {\n+            params.put(\"heatHoldTemp\", heatHoldTemp);\n+        }\n+        if (holdClimateRef != null) {\n+            params.put(\"holdClimateRef\", holdClimateRef);\n+        }\n+        return setHold(params, holdType, holdHours, startDateTime, endDateTime);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @Nullable QuantityType<Temperature> heatHoldTemp, @Nullable String holdClimateRef,\n+            @Nullable Date startDateTime, @Nullable Date endDateTime, @Nullable String holdType,\n+            @Nullable Number holdHours) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass()\n+                    .getDeclaredMethod(\"setHold\", QuantityType.class, QuantityType.class, String.class, Date.class,\n+                            Date.class, String.class, Number.class)\n+                    .invoke(actions, coolHoldTemp, heatHoldTemp, holdClimateRef, startDateTime, endDateTime, holdType,\n+                            holdHours);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set a hold by providing a parameter map\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified event parameters.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"params\", description = \"The map of hold parameters.\") @Nullable Map<String, Object> params,\n+            @ActionInput(name = \"holdType\", description = \"(opt) The hold duration type. Valid values: dateTime, nextTransition, indefinite, holdHours.\") @Nullable String holdType,\n+            @ActionInput(name = \"holdHours\", description = \"(opt) The number of hours to hold for, used and required if holdType='holdHours'.\") @Nullable Number holdHours,\n+            @ActionInput(name = \"startDateTime\", description = \"(opt) The start date in thermostat time.\") @Nullable Date startDateTime,\n+            @ActionInput(name = \"endDateTime\", description = \"(opt) The end date in thermostat time.\") @Nullable Date endDateTime) {\n+        LOGGER.debug(\"EcobeeActions: Action 'SetHold' called\");\n+        if (params == null) {\n+            throw new IllegalArgumentException(\"params cannot be null\");\n+        }\n+        EventDTO event = new EventDTO();\n+        for (String key : params.keySet()) {\n+            Object value = params.get(key);\n+            switch (key) {\n+                case \"isOccupied\":\n+                    event.isOccupied = ((Boolean) value);", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2OTIwNA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403469204", "bodyText": "Good question. I adapted this from the OH1 version of the binding, which didn't do any checking. Seems like the correct approach would be to throw IllegalArgumentException. Agree?", "author": "mhilbush", "createdAt": "2020-04-04T13:17:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3MjIzNA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403472234", "bodyText": "Isn't IllegalArguementException an unchecked exception, or is that not a concern?", "author": "robnielsen", "createdAt": "2020-04-04T13:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NTE1MA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403475150", "bodyText": "I wasn't sure, which is why I was asking.\nMost of the thing actions already call IllegalArgumentException (including this one), so I was assuming it would be ok to call it in this situation as well. In addition, it will cause the rule to fail, which probably is the desired behavior if the action is passed something that it can't deal with.", "author": "mhilbush", "createdAt": "2020-04-04T14:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDE4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDg5Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403350892", "bodyText": "Why is this being done through reflection rather than just casting to a known action class?", "author": "cpmeister", "createdAt": "2020-04-03T21:43:27Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/action/EcobeeActions.java", "diffHunk": "@@ -0,0 +1,783 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.action;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.measure.quantity.Temperature;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.QuantityType;\n+import org.eclipse.smarthome.core.thing.binding.ThingActions;\n+import org.eclipse.smarthome.core.thing.binding.ThingActionsScope;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.EventDTO;\n+import org.openhab.binding.ecobee.internal.enums.AckType;\n+import org.openhab.binding.ecobee.internal.enums.FanMode;\n+import org.openhab.binding.ecobee.internal.enums.HoldType;\n+import org.openhab.binding.ecobee.internal.enums.PlugState;\n+import org.openhab.binding.ecobee.internal.enums.VentilatorMode;\n+import org.openhab.binding.ecobee.internal.function.AcknowledgeFunction;\n+import org.openhab.binding.ecobee.internal.function.ControlPlugFunction;\n+import org.openhab.binding.ecobee.internal.function.CreateVacationFunction;\n+import org.openhab.binding.ecobee.internal.function.DeleteVacationFunction;\n+import org.openhab.binding.ecobee.internal.function.ResetPreferencesFunction;\n+import org.openhab.binding.ecobee.internal.function.ResumeProgramFunction;\n+import org.openhab.binding.ecobee.internal.function.SendMessageFunction;\n+import org.openhab.binding.ecobee.internal.function.SetHoldFunction;\n+import org.openhab.binding.ecobee.internal.function.SetOccupiedFunction;\n+import org.openhab.binding.ecobee.internal.function.UpdateSensorFunction;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeThermostatBridgeHandler;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeUtils;\n+import org.openhab.core.automation.annotation.ActionInput;\n+import org.openhab.core.automation.annotation.ActionOutput;\n+import org.openhab.core.automation.annotation.RuleAction;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link EcobeeActions} defines the thing actions for the Ecobee binding.\n+ *\n+ * @author John Cocula - Initial contribution\n+ * @author Mark Hilbush - Adapted for OH2/3\n+ */\n+@ThingActionsScope(name = \"ecobee\")\n+@NonNullByDefault\n+public class EcobeeActions implements ThingActions {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EcobeeActions.class);\n+\n+    private @Nullable EcobeeThermostatBridgeHandler handler;\n+\n+    public EcobeeActions() {\n+        LOGGER.debug(\"EcobeeActions: EcobeeActions: Actions service created\");\n+    }\n+\n+    @Override\n+    public void setThingHandler(@Nullable ThingHandler handler) {\n+        if (handler instanceof EcobeeThermostatBridgeHandler) {\n+            this.handler = (EcobeeThermostatBridgeHandler) handler;\n+        }\n+    }\n+\n+    @Override\n+    public @Nullable ThingHandler getThingHandler() {\n+        return this.handler;\n+    }\n+\n+    /**\n+     * The acknowledge function allows an alert to be acknowledged.\n+     *\n+     * @see <a\n+     *      href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/Acknowledge.shtml\">Acknowledge\n+     *      </a>\n+     */\n+    @RuleAction(label = \"Acknowledge\", description = \"Acknowledges an alert.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean acknowledge(\n+            @ActionInput(name = \"ackRef\", description = \"The acknowledge ref of alert\") @Nullable String ackRef,\n+            @ActionInput(name = \"ackType\", description = \"The type of acknowledgement. Valid values: accept, decline, defer, unacknowledged\") String ackType,\n+            @ActionInput(name = \"remindMeLater\", description = \"(opt) Whether to remind at a later date, if this is a defer acknowledgement\") @Nullable Boolean remindMeLater) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Acknowledge' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        AcknowledgeFunction function = new AcknowledgeFunction(localHandler.getThermostatId(), ackRef,\n+                AckType.forValue(ackType), remindMeLater);\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean acknowledge(@Nullable ThingActions actions, @Nullable String ackRef, @Nullable String ackType,\n+            @Nullable Boolean remindMeLater) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) (actions.getClass()\n+                    .getDeclaredMethod(\"acknowledge\", String.class, String.class, Boolean.class)\n+                    .invoke(actions, ackRef, ackType, remindMeLater));\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Control the on/off state of a plug by setting a hold on the plug.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/ControlPlug.shtml\">Control\n+     *      Plug</a>\n+     */\n+    @RuleAction(label = \"Control Plug\", description = \"Control the on/off state of a plug by setting a hold on the plug.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean controlPlug(\n+            @ActionInput(name = \"plugName\", description = \"The name of the plug. Ensure each plug has a unique name.\") @Nullable String plugName,\n+            @ActionInput(name = \"plugState\", description = \"The state to put the plug into. Valid values: on, off, resume.\") @Nullable String plugState,\n+            @ActionInput(name = \"startDateTime\", description = \"(opt) The start date/time in thermostat time.\") @Nullable Date startDateTime,\n+            @ActionInput(name = \"endDateTime\", description = \"(opt) The end date/time in thermostat time.\") @Nullable Date endDateTime,\n+            @ActionInput(name = \"holdType\", description = \"(opt) The hold duration type. Valid values: dateTime, nextTransition, indefinite, holdHours.\") @Nullable String holdType,\n+            @ActionInput(name = \"holdHours\", description = \"(opt) The number of hours to hold for, used and required if holdType='holdHours'.\") @Nullable Number holdHours) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Control Plug' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        ControlPlugFunction function = (new ControlPlugFunction(plugName, PlugState.forValue(plugState), startDateTime,\n+                endDateTime, (holdType == null) ? null : HoldType.forValue(holdType),\n+                (holdHours == null) ? null : Integer.valueOf(holdHours.intValue())));\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean controlPlug(@Nullable ThingActions actions, @Nullable String plugName,\n+            @Nullable String plugState, @Nullable Date startDateTime, @Nullable Date endDateTime,\n+            @Nullable String holdType, @Nullable Number holdHours) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) (actions.getClass()\n+                    .getDeclaredMethod(\"controlPlug\", String.class, String.class, Date.class, Date.class, String.class,\n+                            Number.class)\n+                    .invoke(actions, plugName, plugState, startDateTime, endDateTime, holdType, holdHours));\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The create vacation function creates a vacation event on the thermostat.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/CreateVacation.shtml\">Create\n+     *      Vacation</a>\n+     */\n+    @RuleAction(label = \"Create Vacation\", description = \"The create vacation function creates a vacation event on the thermostat.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean createVacation(\n+            @ActionInput(name = \"name\", description = \"The vacation event name. It must be unique.\") @Nullable String name,\n+            @ActionInput(name = \"coolHoldTemp\", description = \"The temperature at which to set the cool vacation hold.\") @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @ActionInput(name = \"heatHoldTemp\", description = \"The temperature at which to set the heat vacation hold.\") @Nullable QuantityType<Temperature> heatHoldTemp,\n+            @ActionInput(name = \"startDateTime\", description = \"(opt) The start date/time in thermostat time.\") @Nullable Date startDateTime,\n+            @ActionInput(name = \"endDateTime\", description = \"(opt) The end date in thermostat time.\") @Nullable Date endDateTime,\n+            @ActionInput(name = \"fan\", description = \"(opt) The fan mode during the vacation. Values: auto, on Default: auto\") @Nullable String fan,\n+            @ActionInput(name = \"fanMinOnTime\", description = \"(opt) The minimum number of minutes to run the fan each hour. Range: 0-60, Default: 0\") @Nullable Number fanMinOnTime) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Create Vacation' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        CreateVacationFunction function = new CreateVacationFunction(name, coolHoldTemp, heatHoldTemp, startDateTime,\n+                endDateTime, (fan == null) ? null : FanMode.forValue(fan),\n+                (fanMinOnTime == null) ? null : Integer.valueOf(fanMinOnTime.intValue()));\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean createVacation(@Nullable ThingActions actions, @Nullable String name,\n+            @Nullable QuantityType<Temperature> coolHoldTemp, @Nullable QuantityType<Temperature> heatHoldTemp,\n+            @Nullable Date startDateTime, @Nullable Date endDateTime, @Nullable String fan,\n+            @Nullable Number fanMinOnTime) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass()\n+                    .getDeclaredMethod(\"createVacation\", String.class, QuantityType.class, QuantityType.class,\n+                            Date.class, Date.class, String.class, Number.class)\n+                    .invoke(actions, name, coolHoldTemp, heatHoldTemp, startDateTime, endDateTime, fan, fanMinOnTime);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The delete vacation function deletes a vacation event from a thermostat.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/DeleteVacation.shtml\">Delete\n+     *      Vacation</a>\n+     */\n+    @RuleAction(label = \"Delete Vacation\", description = \"The delete vacation function deletes a vacation event from a thermostat.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean deleteVacation(\n+            @ActionInput(name = \"name\", description = \"The vacation event name to delete.\") @Nullable String name) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Delete Vacation' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        DeleteVacationFunction function = new DeleteVacationFunction(name);\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean deleteVacation(@Nullable ThingActions actions, @Nullable String name) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"deleteVacation\", String.class).invoke(actions, name);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The reset preferences function sets all of the user configurable settings back to the factory default values.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/ResetPreferences.shtml\">Reset\n+     *      Preferences</a>\n+     */\n+    @RuleAction(label = \"Reset Preferences\", description = \"The reset preferences function sets all of the user configurable settings back to the factory default values.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean resetPreferences() {\n+        LOGGER.debug(\"EcobeeActions: Action 'Reset Preferences' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        ResetPreferencesFunction function = new ResetPreferencesFunction();\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean resetPreferences(@Nullable ThingActions actions) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"resetPreferences\").invoke(actions);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The resume program function removes the currently running event.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/ResumeProgram.shtml\">Resume\n+     *      Program</a>\n+     */\n+    @RuleAction(label = \"Resume Program\", description = \"Removes the currently running event providing the event is not a mandatory demand response event\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean resumeProgram(\n+            @ActionInput(name = \"resumeAll\", description = \"(opt) Should the thermostat be resumed to next event (false) or to its program (true)\") @Nullable Boolean resumeAll) {\n+        LOGGER.debug(\"EcobeeActions: Action 'Resume Program' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        ResumeProgramFunction function = new ResumeProgramFunction(resumeAll);\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean resumeProgram(@Nullable ThingActions actions, @Nullable Boolean resumeAll) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"resumeProgram\", Boolean.class).invoke(actions,\n+                    resumeAll);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * The send message function allows an alert message to be sent to the thermostat.\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/SendMessage.shtml\">Send\n+     *      Message</a>\n+     */\n+    @RuleAction(label = \"Send Message\", description = \"The send message function allows an alert message to be sent to the thermostat.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean sendMessage(\n+            @ActionInput(name = \"text\", description = \"The message text to send. Text will be truncated to 500 characters if longer\") @Nullable String text) {\n+        LOGGER.debug(\"EcobeeActions: Action 'SendMessage' called\");\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        SendMessageFunction function = new SendMessageFunction(text);\n+        return localHandler.actionPerformFunction(function);\n+    }\n+\n+    public static boolean sendMessage(@Nullable ThingActions actions, @Nullable String text) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"sendMessage\", String.class).invoke(actions, text);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set an indefinite hold using the supplied the cool and heat hold temperatures\n+     *\n+     * @see <a href=\"https://www.ecobee.com/home/developer/api/documentation/v1/functions/SetHold.shtml\">Set Hold</a>\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified temperatures.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"coolHoldTemp\", description = \"The temperature at which to set the cool hold.\") @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @ActionInput(name = \"heatHoldTemp\", description = \"The temperature at which to set the heat hold.\") @Nullable QuantityType<Temperature> heatHoldTemp) {\n+        if (coolHoldTemp == null || heatHoldTemp == null) {\n+            throw new IllegalArgumentException(\"hold temperatures cannot be null\");\n+        }\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"coolHoldTemp\", coolHoldTemp);\n+        params.put(\"heatHoldTemp\", heatHoldTemp);\n+        return setHold(params, null, null, null, null);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @Nullable QuantityType<Temperature> heatHoldTemp) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"setHold\", QuantityType.class, QuantityType.class)\n+                    .invoke(actions, coolHoldTemp, heatHoldTemp);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set a hold by providing the cool and heat temperatures and the number of hours.\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold for the specified number of hours.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"coolHoldTemp\", description = \"The temperature at which to set the cool hold.\") @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @ActionInput(name = \"heatHoldTemp\", description = \"The temperature at which to set the heat hold.\") @Nullable QuantityType<Temperature> heatHoldTemp,\n+            @ActionInput(name = \"holdHours\", description = \"The number of hours for the hold.\") @Nullable Number holdHours) {\n+        if (coolHoldTemp == null || heatHoldTemp == null) {\n+            throw new IllegalArgumentException(\"hold temperatures cannot be null\");\n+        }\n+        if (holdHours == null) {\n+            throw new IllegalArgumentException(\"number of hold hours is missing\");\n+        }\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"coolHoldTemp\", coolHoldTemp);\n+        params.put(\"heatHoldTemp\", heatHoldTemp);\n+        params.put(\"holdType\", HoldType.HOLD_HOURS);\n+        params.put(\"holdHours\", Integer.valueOf(holdHours.intValue()));\n+        return setHold(params, null, null, null, null);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @Nullable QuantityType<Temperature> heatHoldTemp, @Nullable Number holdHours) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass()\n+                    .getDeclaredMethod(\"setHold\", QuantityType.class, QuantityType.class, Number.class)\n+                    .invoke(actions, coolHoldTemp, heatHoldTemp, holdHours);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set an indefinite hold using the supplied climateRef\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified climate ref.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"holdClimateRef\", description = \"The holdClimateRef used to set the hold.\") @Nullable String holdClimateRef) {\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        if (holdClimateRef == null || !localHandler.isValidClimateRef(holdClimateRef)) {\n+            throw new IllegalArgumentException(\"hold climate ref is missing or invalid\");\n+        }\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"holdClimateRef\", holdClimateRef);\n+        return setHold(params, null, null, null, null);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable String holdClimateRef) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"setHold\", String.class).invoke(actions,\n+                    holdClimateRef);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set a hold using the supplied climateRef for the supplied number of hours.\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified climate ref.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"holdClimateRef\", description = \"The holdClimateRef used to set the hold.\") @Nullable String holdClimateRef,\n+            @ActionInput(name = \"holdHours\", description = \"The number of hours for the hold.\") @Nullable Number holdHours) {\n+        if (holdHours == null) {\n+            throw new IllegalArgumentException(\"number of hold hours is missing\");\n+        }\n+        EcobeeThermostatBridgeHandler localHandler = handler;\n+        if (localHandler == null) {\n+            LOGGER.info(\"EcobeeActions: Action service ThingHandler is null!\");\n+            return false;\n+        }\n+        if (holdClimateRef == null || !localHandler.isValidClimateRef(holdClimateRef)) {\n+            throw new IllegalArgumentException(\"hold climate ref is missing or invalid\");\n+        }\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"holdClimateRef\", holdClimateRef);\n+        params.put(\"holdType\", HoldType.HOLD_HOURS);\n+        params.put(\"holdHours\", Integer.valueOf(holdHours.intValue()));\n+        return setHold(params, null, null, null, null);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable String holdClimateRef,\n+            @Nullable Number holdHours) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass().getDeclaredMethod(\"setHold\", String.class, Number.class).invoke(actions,\n+                    holdClimateRef, holdHours);\n+        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n+                | InvocationTargetException e) {\n+            LOGGER.info(\"EcobeeActions: Exception getting or invoking method\", e);\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Set a hold\n+     */\n+    @RuleAction(label = \"Set Hold\", description = \"The set hold function sets the thermostat into a hold with the specified temperature or climate ref.\")\n+    public @ActionOutput(name = \"success\", type = \"java.lang.Boolean\") Boolean setHold(\n+            @ActionInput(name = \"coolHoldTemp\", description = \"(opt) The temperature at which to set the cool hold.\") @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @ActionInput(name = \"heatHoldTemp\", description = \"(opt) The temperature at which to set the heat hold.\") @Nullable QuantityType<Temperature> heatHoldTemp,\n+            @ActionInput(name = \"holdClimateRef\", description = \"(opt) The Climate to use as reference for setting the coolHoldTemp, heatHoldTemp and fan settings for this hold. If this value is passed the coolHoldTemp and heatHoldTemp are not required.\") @Nullable String holdClimateRef,\n+            @ActionInput(name = \"startDateTime\", description = \"(opt) The start date in thermostat time.\") @Nullable Date startDateTime,\n+            @ActionInput(name = \"endDateTime\", description = \"(opt) The end date in thermostat time.\") @Nullable Date endDateTime,\n+            @ActionInput(name = \"holdType\", description = \"(opt) The hold duration type. Valid values: dateTime, nextTransition, indefinite, holdHours.\") @Nullable String holdType,\n+            @ActionInput(name = \"holdHours\", description = \"(opt) The number of hours to hold for, used and required if holdType='holdHours'.\") @Nullable Number holdHours) {\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        if (coolHoldTemp != null) {\n+            params.put(\"coolHoldTemp\", coolHoldTemp);\n+        }\n+        if (heatHoldTemp != null) {\n+            params.put(\"heatHoldTemp\", heatHoldTemp);\n+        }\n+        if (holdClimateRef != null) {\n+            params.put(\"holdClimateRef\", holdClimateRef);\n+        }\n+        return setHold(params, holdType, holdHours, startDateTime, endDateTime);\n+    }\n+\n+    public static boolean setHold(@Nullable ThingActions actions, @Nullable QuantityType<Temperature> coolHoldTemp,\n+            @Nullable QuantityType<Temperature> heatHoldTemp, @Nullable String holdClimateRef,\n+            @Nullable Date startDateTime, @Nullable Date endDateTime, @Nullable String holdType,\n+            @Nullable Number holdHours) {\n+        if (actions == null) {\n+            throw new IllegalArgumentException(\"actions cannot be null\");\n+        }\n+        try {\n+            return (Boolean) actions.getClass()\n+                    .getDeclaredMethod(\"setHold\", QuantityType.class, QuantityType.class, String.class, Date.class,\n+                            Date.class, String.class, Number.class)\n+                    .invoke(actions, coolHoldTemp, heatHoldTemp, holdClimateRef, startDateTime, endDateTime, holdType,\n+                            holdHours);", "originalCommit": "fda3ddfeda1320cbec97ff8c03f5fbfda170e4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4NjU0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403386541", "bodyText": "I did this as a short term workaround for this issue. I got tired of restarting openHAB every time I dropped a new version of the binding in addons. As I'm using the binding to control the thermostats in my home, the last thing I want is for the actions to stop working. At some point, when the problem is fixed in core, I'll revert this back to the normal way of doing it.", "author": "mhilbush", "createdAt": "2020-04-03T23:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgwMjI4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r403802289", "bodyText": "Give me sec to experiment before you try it out, I don't want you to waste your time on something I didn't try first.\nEdit: My idea wouldn't work so I removed my post to make sure other don't get the wrong idea. Looks like this ugly workaround is here to stay until a fix is in the core.", "author": "cpmeister", "createdAt": "2020-04-06T02:40:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxMDE0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r404010141", "bodyText": "Thanks for trying another possible solution. I wish there was a less ugly way to deal with this.", "author": "mhilbush", "createdAt": "2020-04-06T11:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM1MzUyNA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r404353524", "bodyText": "Well I found a less ugly way to deal with it but it requires the overhead of making an interface.\n\n    private static @Nullable IEcobeeActions tryCast(ThingActions actions){\n        if(actions.getClass().getName().equals(EcobeeActions.class.getName())){\n            if(actions instanceof IEcobeeActions){\n                return (IEcobeeActions) actions;\n            }else{\n                return (IEcobeeActions) Proxy.newProxyInstance(IEcobeeActions.class.getClassLoader(), new Class[]{IEcobeeActions.class}, \n                        (Object proxy, Method method, Object[] args) -> {\n                            Method m = actions.getClass().getDeclaredMethod(method.getName(), method.getParameterTypes());\n                            return m.invoke(actions, args);\n                        });\n            }\n        }\n        return null;\n    }\n\nThis solution is pretty much the same as what you are already doing it just offloads all of the reflection logic into a java proxy. Since java's built-in proxy api only allows for proxying interfaces, you would need to create an interface (IEcobeeActions in this example) with all the action methods.\nIt would be possible to do away with the interface if we used a proxy library like cglib which can actually handle proxying concrete classes.\nThis is hardly a proper solution but definitely makes the workaround look cleaner. Still don't know if it is worth the overhead of creating an interface, but if we really wanted to we could use cglib to proxy the concrete class directly. But importing a library for the sole purpose of a cleaner workaround is a bit iffy.\nWDYT?", "author": "cpmeister", "createdAt": "2020-04-06T20:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MjI0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r404982242", "bodyText": "@cpmeister Another thing I tried was placing all the reflection stuff in a separate static method. This seems to work for me, since all my actions have very simple returns (Boolean, String, etc).\n    private static <T> Object invokeMethod(ThingActions actions, String name, Class<?>[] classes, Object... args) {\n        if (args.length != classes.length) {\n            throw new IllegalArgumentException(\"Number of args and number of classes don't match\");\n        }\n        try {\n            Method m = actions.getClass().getDeclaredMethod(name, classes);\n            Class<?> returnClass = m.getReturnType();\n            return returnClass.cast(m.invoke(actions, args));\n        } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException\n                | InvocationTargetException e) {\n            throw new UnsupportedOperationException(\"Problem getting or invoking method \" + name);\n        }\n    }\n\nThen the static action methods would invoke it like this.\n    public static boolean acknowledge(@Nullable ThingActions actions, @Nullable String ackRef, @Nullable String ackType,\n            @Nullable Boolean remindMeLater) {\n        if (actions == null) {\n            throw new IllegalArgumentException(\"actions cannot be null\");\n        }\n        Class<?>[] argTypes = { String.class, String.class, Boolean.class };\n        return (Boolean) invokeMethod(actions, \"acknowledge\", argTypes, ackRef, ackType, remindMeLater);\n    }\n\nOr like this if there are no arguments.\n    public static @Nullable String getAlerts(@Nullable ThingActions actions) {\n        if (actions == null) {\n            throw new IllegalArgumentException(\"actions cannot be null\");\n        }\n        Class<?>[] argTypes = {};\n        return (String) invokeMethod(actions, \"getAlerts\", argTypes);\n    }", "author": "mhilbush", "createdAt": "2020-04-07T17:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzMzQ3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405033475", "bodyText": "I hate to see parameter class types being defined for every single action method.\nMy method would allow the code to be checked by the compiler for correctness.\n    public static boolean acknowledge(@Nullable ThingActions actions, @Nullable String ackRef, @Nullable String ackType,\n            @Nullable Boolean remindMeLater) {\n        if (actions == null) {\n            throw new IllegalArgumentException(\"actions cannot be null\");\n        }\n        IEcobeeActions iactions = tryCast(actions);\n        if(iactions != null){\n            return iactions.acknowledge(ackRef, ackType, remindMeLater);\n        }else{\n            throw new IllegalArgumentException(\"actions is not a EcoBeeActions type\");\n        }\n    }\n\nIf you wanted to you could throw these exceptions inside of tryCast to make the code even simpler:\n    public static boolean acknowledge(@Nullable ThingActions actions, @Nullable String ackRef, @Nullable String ackType,\n            @Nullable Boolean remindMeLater) {\n        return tryCast(actions).acknowledge(ackRef, ackType, remindMeLater);\n    }\n\nI think proxies are probably the best workaround, even with the interface overhead which actually has the advantage of exposing the action api in a easy to read format that isn't obscured by annotations.\nThis method also has the ability to easily fall back to using the original ThingActions object directly in the case it is the correct one to begin with.", "author": "cpmeister", "createdAt": "2020-04-07T18:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExMDk1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405110953", "bodyText": "Ah, now I see. Thanks for bearing with me...", "author": "mhilbush", "createdAt": "2020-04-07T21:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MDg5Mg=="}], "type": "inlineReview"}, {"oid": "459b15446d0a5aa574781e2fb921ba1c2fa8a9fa", "url": "https://github.com/openhab/openhab-addons/commit/459b15446d0a5aa574781e2fb921ba1c2fa8a9fa", "message": "Address review feedback\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-04-04T19:42:10Z", "type": "commit"}, {"oid": "4623dea161d151836043485de773c0110b78af2a", "url": "https://github.com/openhab/openhab-addons/commit/4623dea161d151836043485de773c0110b78af2a", "message": "Rework actions\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-04-07T20:54:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzNzgyMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405137821", "bodyText": "This would save quite a few lines of code. Also you should add comment in here about why the use of proxies are even needed in the first place.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static IEcobeeActions tryCast(ThingActions actions) {\n          \n          \n            \n                    if (actions.getClass().getName().equals(EcobeeActions.class.getName())) {\n          \n          \n            \n                private static IEcobeeActions tryCast(@Nullable ThingActions actions) {\n          \n          \n            \n                    if (actions == null) {\n          \n          \n            \n                        throw new IllegalArgumentException(\"actions cannot be null\");\n          \n          \n            \n                    } \n          \n          \n            \n                    if (actions.getClass().getName().equals(EcobeeActions.class.getName())) {", "author": "cpmeister", "createdAt": "2020-04-07T21:57:37Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/action/EcobeeActions.java", "diffHunk": "@@ -79,17 +80,34 @@ public void setThingHandler(@Nullable ThingHandler handler) {\n         return this.handler;\n     }\n \n+    private static IEcobeeActions tryCast(ThingActions actions) {\n+        if (actions.getClass().getName().equals(EcobeeActions.class.getName())) {", "originalCommit": "4623dea161d151836043485de773c0110b78af2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3MTUyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405471529", "bodyText": "This would save quite a few lines of code.\n\nSure does. Good idea.\n\nAlso you should add comment in here about why the use of proxies are even needed in the first place.\n\nAdded documentation. I also added you as the contributor of the proxy approach. Hope that is ok with you.\nAlso, I changed the name of tryCast, but I'm still not sure it's named correctly. I'm happy to change again if you have a better name.", "author": "mhilbush", "createdAt": "2020-04-08T12:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzNzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0MzM0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405143343", "bodyText": "I'm not sure what good setting to 0 would do, but if you want to prevent the map from resizing then setting it to double the expected size works. The make will resize the cache once the fill exceeds 75% so by making the size double what you expect you make sure it won't exceed 50% fill, thus preventing rehashing.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Map<String, Object> properties = new HashMap<>(0);\n          \n          \n            \n                    Map<String, Object> properties = new HashMap<>(2);", "author": "cpmeister", "createdAt": "2020-04-07T22:10:38Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/discovery/SensorDiscoveryService.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.discovery;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.config.discovery.DiscoveryService;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerService;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.RemoteSensorDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeThermostatBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link SensorDiscoveryService} is responsible for discovering the Ecobee\n+ * sensors that are assigned to a thermostat.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class SensorDiscoveryService extends AbstractDiscoveryService implements DiscoveryService, ThingHandlerService {\n+\n+    private final Logger logger = LoggerFactory.getLogger(SensorDiscoveryService.class);\n+\n+    private @Nullable EcobeeThermostatBridgeHandler bridgeHandler;\n+\n+    public SensorDiscoveryService() {\n+        super(30);\n+    }\n+\n+    @Override\n+    public void setThingHandler(@Nullable ThingHandler handler) {\n+        if (handler instanceof EcobeeThermostatBridgeHandler) {\n+            ((EcobeeThermostatBridgeHandler) handler).setDiscoveryService(this);\n+            bridgeHandler = (EcobeeThermostatBridgeHandler) handler;\n+        }\n+    }\n+\n+    @Override\n+    public @Nullable ThingHandler getThingHandler() {\n+        return bridgeHandler;\n+    }\n+\n+    @Override\n+    public void activate() {\n+        logger.debug(\"SensorDiscovery: Activating Ecobee sensor discovery service\");\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"SensorDiscovery: Deactivating Ecobee sensor discovery service\");\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_SENSOR_THING_TYPES_UIDS;\n+    }\n+\n+    @Override\n+    public void startBackgroundDiscovery() {\n+        EcobeeThermostatBridgeHandler localBridgeHandler = bridgeHandler;\n+        if (localBridgeHandler == null) {\n+            logger.info(\"SensorDiscovery: Can't perform background discovery because bridgeHandler is null\");\n+            return;\n+        }\n+        logger.debug(\"SensorDiscovery: Performing background discovery scan for {}\",\n+                localBridgeHandler.getThing().getUID());\n+        discoverSensors();\n+    }\n+\n+    @Override\n+    public void startScan() {\n+        EcobeeThermostatBridgeHandler localBridgeHandler = bridgeHandler;\n+        if (localBridgeHandler == null) {\n+            logger.info(\"SensorDiscovery: Can't perform discovery scan because bridgeHandler is null\");\n+            return;\n+        }\n+        logger.debug(\"SensorDiscovery: Starting discovery scan for {}\", localBridgeHandler.getThing().getUID());\n+        discoverSensors();\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        super.stopScan();\n+    }\n+\n+    private String buildLabel(String name) {\n+        return String.format(\"Ecobee Sensor %s\", name);\n+    }\n+\n+    private synchronized void discoverSensors() {\n+        EcobeeThermostatBridgeHandler localBridgeHandler = bridgeHandler;\n+        if (localBridgeHandler == null) {\n+            logger.info(\"SensorDiscovery: Can't discover sensors because bridgeHandler is null\");\n+            return;\n+        }\n+        for (RemoteSensorDTO sensor : localBridgeHandler.getSensors()) {\n+            ThingUID bridgeUID = localBridgeHandler.getThing().getUID();\n+            ThingUID sensorUID = new ThingUID(UID_SENSOR_THING, bridgeUID, sensor.id.replace(\":\", \"-\"));\n+            thingDiscovered(createDiscoveryResult(sensorUID, bridgeUID, sensor));\n+            logger.trace(\"SensorDiscovery: Sensor with id '{}' and name '{}' added to Inbox with UID '{}'\", sensor.id,\n+                    sensor.name, sensorUID);\n+        }\n+    }\n+\n+    private DiscoveryResult createDiscoveryResult(ThingUID sensorUID, ThingUID bridgeUID, RemoteSensorDTO sensor) {\n+        Map<String, Object> properties = new HashMap<>(0);", "originalCommit": "4623dea161d151836043485de773c0110b78af2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3MjM4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405472389", "bodyText": "It was copy/pasted from somewhere else. Fixed.", "author": "mhilbush", "createdAt": "2020-04-08T12:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0MzM0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NDYxNA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405144614", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Map<String, Object> properties = new HashMap<>(0);\n          \n          \n            \n                    Map<String, Object> properties = new HashMap<>(2);", "author": "cpmeister", "createdAt": "2020-04-07T22:13:40Z", "path": "bundles/org.openhab.binding.ecobee/src/main/java/org/openhab/binding/ecobee/internal/discovery/ThermostatDiscoveryService.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ecobee.internal.discovery;\n+\n+import static org.openhab.binding.ecobee.internal.EcobeeBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.config.discovery.DiscoveryService;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerService;\n+import org.openhab.binding.ecobee.internal.dto.thermostat.ThermostatDTO;\n+import org.openhab.binding.ecobee.internal.handler.EcobeeAccountBridgeHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link ThermostatDiscoveryService} is responsible for discovering the Ecobee\n+ * thermostats that are associated with the Ecobee Account.\n+ *\n+ * @author Mark Hilbush - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ThermostatDiscoveryService extends AbstractDiscoveryService\n+        implements DiscoveryService, ThingHandlerService {\n+\n+    private final Logger logger = LoggerFactory.getLogger(ThermostatDiscoveryService.class);\n+\n+    private @NonNullByDefault({}) EcobeeAccountBridgeHandler bridgeHandler;\n+\n+    public ThermostatDiscoveryService() {\n+        super(30);\n+    }\n+\n+    @Override\n+    public void setThingHandler(@Nullable ThingHandler handler) {\n+        if (handler instanceof EcobeeAccountBridgeHandler) {\n+            this.bridgeHandler = (EcobeeAccountBridgeHandler) handler;\n+            this.bridgeHandler.setDiscoveryService(this);\n+        }\n+    }\n+\n+    @Override\n+    public @Nullable ThingHandler getThingHandler() {\n+        return bridgeHandler;\n+    }\n+\n+    @Override\n+    public void activate() {\n+        logger.debug(\"ThermostatDiscovery: Activating Ecobee thermostat discovery service for {}\",\n+                bridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"ThermostatDiscovery: Deactivating Ecobee thermostat discovery service for {}\",\n+                bridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THERMOSTAT_BRIDGE_THING_TYPES_UIDS;\n+    }\n+\n+    @Override\n+    public void startBackgroundDiscovery() {\n+        logger.trace(\"ThermostatDiscovery: Performing background discovery scan for {}\",\n+                bridgeHandler.getThing().getUID());\n+        discoverThermostats();\n+    }\n+\n+    @Override\n+    public void startScan() {\n+        logger.debug(\"ThermostatDiscovery: Starting discovery scan for {}\", bridgeHandler.getThing().getUID());\n+        discoverThermostats();\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        super.stopScan();\n+    }\n+\n+    private String buildLabel(String name) {\n+        return String.format(\"Ecobee Thermostat %s\", name);\n+    }\n+\n+    private synchronized void discoverThermostats() {\n+        for (ThermostatDTO thermostat : bridgeHandler.getRegisteredThermostats()) {\n+            String name = thermostat.name;\n+            String identifier = thermostat.identifier;\n+            if (identifier != null && name != null) {\n+                ThingUID thingUID = new ThingUID(UID_THERMOSTAT_BRIDGE, bridgeHandler.getThing().getUID(),\n+                        thermostat.identifier);\n+                thingDiscovered(createDiscoveryResult(thingUID, identifier, name));\n+                logger.trace(\"ThermostatDiscovery: Thermostat with id '{}' and name '{}' added to Inbox with UID '{}'\",\n+                        thermostat.identifier, thermostat.name, thingUID);\n+            }\n+        }\n+    }\n+\n+    private DiscoveryResult createDiscoveryResult(ThingUID thermostatUID, String identifier, String name) {\n+        Map<String, Object> properties = new HashMap<>(0);", "originalCommit": "4623dea161d151836043485de773c0110b78af2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3Mjg5OA==", "url": "https://github.com/openhab/openhab-addons/pull/6823#discussion_r405472898", "bodyText": "Fixed.", "author": "mhilbush", "createdAt": "2020-04-08T12:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NDYxNA=="}], "type": "inlineReview"}, {"oid": "ef41b93a76d54569731a3ea0b1ac539dd019b7fd", "url": "https://github.com/openhab/openhab-addons/commit/ef41b93a76d54569731a3ea0b1ac539dd019b7fd", "message": "Address more review feedback\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-04-08T12:11:18Z", "type": "commit"}, {"oid": "b0a26010b2d38cbef2795fb73fdaf6eb5e4c3a68", "url": "https://github.com/openhab/openhab-addons/commit/b0a26010b2d38cbef2795fb73fdaf6eb5e4c3a68", "message": "Merge branch '2.5.x' into ecobee-binding", "committedDate": "2020-04-16T20:17:23Z", "type": "commit"}]}