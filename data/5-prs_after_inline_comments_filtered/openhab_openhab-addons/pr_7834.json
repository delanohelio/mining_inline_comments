{"pr_number": 7834, "pr_title": "[ntp] Clean up", "pr_createdAt": "2020-06-01T23:18:24Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7834", "timeline": [{"oid": "04af19568731c35495b54af1b636326ccb5c8ca0", "url": "https://github.com/openhab/openhab-addons/commit/04af19568731c35495b54af1b636326ccb5c8ca0", "message": "[ntp] Clean up\n\nAdd null annotations\nSuppress one unused configutation setting (locale)\nGet the default timezone from TimeZoneProvider\nMap thing configuration and channel configuration to classes\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-02T07:20:06Z", "type": "commit"}, {"oid": "04af19568731c35495b54af1b636326ccb5c8ca0", "url": "https://github.com/openhab/openhab-addons/commit/04af19568731c35495b54af1b636326ccb5c8ca0", "message": "[ntp] Clean up\n\nAdd null annotations\nSuppress one unused configutation setting (locale)\nGet the default timezone from TimeZoneProvider\nMap thing configuration and channel configuration to classes\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-02T07:20:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MTg3Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434061872", "bodyText": "Why don't you use something like\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @Nullable String hostname;\n          \n          \n            \n                public String hostname = \"0.pool.ntp.org\";\n          \n      \n    \n    \n  \n\nYou can skip the whole logic below then and directly access the fields in the code. If the user sets set parameter, the default is overwritten.", "author": "J-N-K", "createdAt": "2020-06-02T17:49:47Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/config/NtpThingConfiguration.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ntp.internal.config;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+\n+/**\n+ * The {@link NtpThingConfiguration} is responsible for holding\n+ * the thing configuration settings\n+ *\n+ * @author Laurent Garnier - Initial contribution\n+ */\n+@NonNullByDefault\n+public class NtpThingConfiguration {\n+\n+    public static final String HOSTNAME = \"hostname\";\n+    public static final String REFRESH_INTERVAL = \"refreshInterval\";\n+    public static final String REFRESH_NTP = \"refreshNtp\";\n+    public static final String SERVER_PORT = \"serverPort\";\n+    public static final String TIMEZONE = \"timeZone\";\n+\n+    private static final String DEFAULT_SERVER_HOSTNAME = \"0.pool.ntp.org\";\n+    private static final int DEFAULT_REFRESH_INTERVAL = 60;\n+    private static final int DEFAULT_REFRESH_NTP = 30;\n+    private static final int DEFAULT_SERVER_PORT = 123;\n+\n+    public @Nullable String hostname;", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NDIwMg==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434194202", "bodyText": "Ok, fixed.", "author": "lolodomo", "createdAt": "2020-06-02T21:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MTg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MjI3MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434062271", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @Nullable Integer refreshInterval;\n          \n          \n            \n                public int refreshInterval = 60;", "author": "J-N-K", "createdAt": "2020-06-02T17:50:26Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/config/NtpThingConfiguration.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.ntp.internal.config;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+\n+/**\n+ * The {@link NtpThingConfiguration} is responsible for holding\n+ * the thing configuration settings\n+ *\n+ * @author Laurent Garnier - Initial contribution\n+ */\n+@NonNullByDefault\n+public class NtpThingConfiguration {\n+\n+    public static final String HOSTNAME = \"hostname\";\n+    public static final String REFRESH_INTERVAL = \"refreshInterval\";\n+    public static final String REFRESH_NTP = \"refreshNtp\";\n+    public static final String SERVER_PORT = \"serverPort\";\n+    public static final String TIMEZONE = \"timeZone\";\n+\n+    private static final String DEFAULT_SERVER_HOSTNAME = \"0.pool.ntp.org\";\n+    private static final int DEFAULT_REFRESH_INTERVAL = 60;\n+    private static final int DEFAULT_REFRESH_NTP = 30;\n+    private static final int DEFAULT_SERVER_PORT = 123;\n+\n+    public @Nullable String hostname;\n+    public @Nullable Integer refreshInterval;", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NDMwMA==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434194300", "bodyText": "Ok, fixed.", "author": "lolodomo", "createdAt": "2020-06-02T21:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MjI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MzM0NA==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434063344", "bodyText": "Why is this needed at all? It only calls the method it overrides", "author": "J-N-K", "createdAt": "2020-06-02T17:52:24Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/discovery/NtpDiscovery.java", "diffHunk": "@@ -44,12 +48,12 @@ public NtpDiscovery() throws IllegalArgumentException {\n     }\n \n     @Override\n-    protected void activate(Map<String, Object> configProperties) {\n+    protected void activate(@Nullable Map<String, @Nullable Object> configProperties) {", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5MDMxOA==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434190318", "bodyText": "I should refactor this call and rather use injection.", "author": "lolodomo", "createdAt": "2020-06-02T21:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MzM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIyNjIzMg==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434226232", "bodyText": "Constructor injection done.", "author": "lolodomo", "createdAt": "2020-06-02T23:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MzM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2Mzk2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434063962", "bodyText": "This looks wrong. Thomas's last name is \"Eichstaedt-Engelen\", so the spaces arounf the dash are wrong.", "author": "J-N-K", "createdAt": "2020-06-02T17:53:18Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/handler/NtpHandler.java", "diffHunk": "@@ -54,217 +54,183 @@\n  * to one of the channels.\n  *\n  * @author Marcel Verpaalen - Initial contribution OH2 ntp binding\n- * @author Thomas.Eichstaedt-Engelen OH1 ntp binding (getTime routine)\n+ * @author Thomas.Eichstaedt - Engelen OH1 ntp binding (getTime routine)", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NDc1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434194753", "bodyText": "There was a warning on this line but my change was stupid.", "author": "lolodomo", "createdAt": "2020-06-02T21:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2Mzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NTQyOA==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434195428", "bodyText": "Fixed", "author": "lolodomo", "createdAt": "2020-06-02T21:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2Mzk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NDQyMg==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434064422", "bodyText": "Since all values have reasonable defaults, you can skip null checks by using\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private @Nullable NtpThingConfiguration configuration;\n          \n          \n            \n                private NtpThingConfiguration configuration = new NtpThingConfiguration();", "author": "J-N-K", "createdAt": "2020-06-02T17:54:08Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/handler/NtpHandler.java", "diffHunk": "@@ -54,217 +54,183 @@\n  * to one of the channels.\n  *\n  * @author Marcel Verpaalen - Initial contribution OH2 ntp binding\n- * @author Thomas.Eichstaedt-Engelen OH1 ntp binding (getTime routine)\n+ * @author Thomas.Eichstaedt - Engelen OH1 ntp binding (getTime routine)\n  * @author Markus Rathgeb - Add locale provider\n  * @author Erdoan Hadzhiyusein - Adapted the class to work with the new DateTimeType\n+ * @author Laurent Garnier - null annotations, TimeZoneProvider, configuration settings cleanup\n  */\n-\n+@NonNullByDefault\n public class NtpHandler extends BaseThingHandler {\n \n-    private final Logger logger = LoggerFactory.getLogger(NtpHandler.class);\n-\n     /** timeout for requests to the NTP server */\n     private static final int NTP_TIMEOUT = 30000;\n \n     public static final String DATE_PATTERN_WITH_TZ = \"yyyy-MM-dd HH:mm:ss z\";\n+    private static final DateTimeFormatter DATE_FORMATTER_WITH_TZ = DateTimeFormatter.ofPattern(DATE_PATTERN_WITH_TZ);\n \n-    /** for logging purposes */\n-    private final DateFormat SDF = new SimpleDateFormat(DATE_PATTERN_WITH_TZ);\n+    private final Logger logger = LoggerFactory.getLogger(NtpHandler.class);\n \n     /** for publish purposes */\n     private DateTimeFormatter dateTimeFormat = DateTimeFormatter.ofPattern(DATE_PATTERN_WITH_TZ);\n \n-    private final LocaleProvider localeProvider;\n+    private @Nullable NtpThingConfiguration configuration;", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NjQ1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434196452", "bodyText": "Ok, done.", "author": "lolodomo", "createdAt": "2020-06-02T21:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NDQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NTIyOA==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434065228", "bodyText": "Why not use\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    NtpThingConfiguration config = getConfigAs(NtpThingConfiguration.class);\n          \n          \n            \n                    configuration = config;\n          \n          \n            \n                    configuration = getConfigAs(NtpThingConfiguration.class);", "author": "J-N-K", "createdAt": "2020-06-02T17:55:27Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/handler/NtpHandler.java", "diffHunk": "@@ -54,217 +54,183 @@\n  * to one of the channels.\n  *\n  * @author Marcel Verpaalen - Initial contribution OH2 ntp binding\n- * @author Thomas.Eichstaedt-Engelen OH1 ntp binding (getTime routine)\n+ * @author Thomas.Eichstaedt - Engelen OH1 ntp binding (getTime routine)\n  * @author Markus Rathgeb - Add locale provider\n  * @author Erdoan Hadzhiyusein - Adapted the class to work with the new DateTimeType\n+ * @author Laurent Garnier - null annotations, TimeZoneProvider, configuration settings cleanup\n  */\n-\n+@NonNullByDefault\n public class NtpHandler extends BaseThingHandler {\n \n-    private final Logger logger = LoggerFactory.getLogger(NtpHandler.class);\n-\n     /** timeout for requests to the NTP server */\n     private static final int NTP_TIMEOUT = 30000;\n \n     public static final String DATE_PATTERN_WITH_TZ = \"yyyy-MM-dd HH:mm:ss z\";\n+    private static final DateTimeFormatter DATE_FORMATTER_WITH_TZ = DateTimeFormatter.ofPattern(DATE_PATTERN_WITH_TZ);\n \n-    /** for logging purposes */\n-    private final DateFormat SDF = new SimpleDateFormat(DATE_PATTERN_WITH_TZ);\n+    private final Logger logger = LoggerFactory.getLogger(NtpHandler.class);\n \n     /** for publish purposes */\n     private DateTimeFormatter dateTimeFormat = DateTimeFormatter.ofPattern(DATE_PATTERN_WITH_TZ);\n \n-    private final LocaleProvider localeProvider;\n+    private @Nullable NtpThingConfiguration configuration;\n \n-    ScheduledFuture<?> refreshJob;\n+    private @Nullable ScheduledFuture<?> refreshJob;\n \n-    /** NTP host */\n-    private String hostname;\n-    /** NTP server port */\n-    private BigDecimal port;\n-    /** refresh interval */\n-    private BigDecimal refreshInterval;\n-    /** NTP refresh frequency */\n-    private BigDecimal refreshNtp = new BigDecimal(0);\n-    /** Timezone */\n-    private TimeZone timeZone;\n-    /** Locale */\n-    private Locale locale;\n+    private ZoneId defaultTimeZoneId;\n+    private ZoneId timeZoneId;\n \n     /** NTP refresh counter */\n     private int refreshNtpCount = 0;\n     /** NTP system time delta */\n     private long timeOffset;\n \n-    private ChannelUID dateTimeChannelUID;\n-    private ChannelUID stringChannelUID;\n-\n-    public NtpHandler(final Thing thing, final LocaleProvider localeProvider) {\n+    public NtpHandler(final Thing thing, final TimeZoneProvider timeZoneProvider) {\n         super(thing);\n-        this.localeProvider = localeProvider;\n+        this.defaultTimeZoneId = timeZoneProvider.getTimeZone();\n+        this.timeZoneId = defaultTimeZoneId;\n     }\n \n     @Override\n     public void handleCommand(ChannelUID channelUID, Command command) {\n-        // No specific commands tied to this, but we will trigger an update\n-        this.refreshNtpCount = 0;\n-        refreshTimeDate();\n+        if (command == RefreshType.REFRESH) {\n+            logger.debug(\"Refreshing channel '{}' for '{}'.\", channelUID.getId(), getThing().getUID());\n+            refreshTimeDate();\n+        }\n     }\n \n     @Override\n     public void initialize() {\n-        try {\n-            logger.debug(\"Initializing NTP handler for '{}'.\", getThing().getUID());\n+        logger.debug(\"Initializing NTP handler for '{}'.\", getThing().getUID());\n \n-            Configuration config = getThing().getConfiguration();\n-            hostname = config.get(PROPERTY_NTP_SERVER_HOST).toString();\n-            port = (BigDecimal) config.get(PROPERTY_NTP_SERVER_PORT);\n-            refreshInterval = (BigDecimal) config.get(PROPERTY_REFRESH_INTERVAL);\n-            refreshNtp = (BigDecimal) config.get(PROPERTY_REFRESH_NTP);\n-            refreshNtpCount = 0;\n+        NtpThingConfiguration config = getConfigAs(NtpThingConfiguration.class);\n+        configuration = config;", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5Njg4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434196883", "bodyText": "I was to avoid null check warnings due to configuration which was nullable.\nNow that configuration is non null, the local variable can be avoided.", "author": "lolodomo", "createdAt": "2020-06-02T21:54:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5ODU3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434198579", "bodyText": "Local variable removed.", "author": "lolodomo", "createdAt": "2020-06-02T21:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NTIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NTg2OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434065869", "bodyText": "If you use the defaults directly, you can access the fields here  and omit most of the null checks/function calls.", "author": "J-N-K", "createdAt": "2020-06-02T17:56:25Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/handler/NtpHandler.java", "diffHunk": "@@ -54,217 +54,183 @@\n  * to one of the channels.\n  *\n  * @author Marcel Verpaalen - Initial contribution OH2 ntp binding\n- * @author Thomas.Eichstaedt-Engelen OH1 ntp binding (getTime routine)\n+ * @author Thomas.Eichstaedt - Engelen OH1 ntp binding (getTime routine)\n  * @author Markus Rathgeb - Add locale provider\n  * @author Erdoan Hadzhiyusein - Adapted the class to work with the new DateTimeType\n+ * @author Laurent Garnier - null annotations, TimeZoneProvider, configuration settings cleanup\n  */\n-\n+@NonNullByDefault\n public class NtpHandler extends BaseThingHandler {\n \n-    private final Logger logger = LoggerFactory.getLogger(NtpHandler.class);\n-\n     /** timeout for requests to the NTP server */\n     private static final int NTP_TIMEOUT = 30000;\n \n     public static final String DATE_PATTERN_WITH_TZ = \"yyyy-MM-dd HH:mm:ss z\";\n+    private static final DateTimeFormatter DATE_FORMATTER_WITH_TZ = DateTimeFormatter.ofPattern(DATE_PATTERN_WITH_TZ);\n \n-    /** for logging purposes */\n-    private final DateFormat SDF = new SimpleDateFormat(DATE_PATTERN_WITH_TZ);\n+    private final Logger logger = LoggerFactory.getLogger(NtpHandler.class);\n \n     /** for publish purposes */\n     private DateTimeFormatter dateTimeFormat = DateTimeFormatter.ofPattern(DATE_PATTERN_WITH_TZ);\n \n-    private final LocaleProvider localeProvider;\n+    private @Nullable NtpThingConfiguration configuration;\n \n-    ScheduledFuture<?> refreshJob;\n+    private @Nullable ScheduledFuture<?> refreshJob;\n \n-    /** NTP host */\n-    private String hostname;\n-    /** NTP server port */\n-    private BigDecimal port;\n-    /** refresh interval */\n-    private BigDecimal refreshInterval;\n-    /** NTP refresh frequency */\n-    private BigDecimal refreshNtp = new BigDecimal(0);\n-    /** Timezone */\n-    private TimeZone timeZone;\n-    /** Locale */\n-    private Locale locale;\n+    private ZoneId defaultTimeZoneId;\n+    private ZoneId timeZoneId;\n \n     /** NTP refresh counter */\n     private int refreshNtpCount = 0;\n     /** NTP system time delta */\n     private long timeOffset;\n \n-    private ChannelUID dateTimeChannelUID;\n-    private ChannelUID stringChannelUID;\n-\n-    public NtpHandler(final Thing thing, final LocaleProvider localeProvider) {\n+    public NtpHandler(final Thing thing, final TimeZoneProvider timeZoneProvider) {\n         super(thing);\n-        this.localeProvider = localeProvider;\n+        this.defaultTimeZoneId = timeZoneProvider.getTimeZone();\n+        this.timeZoneId = defaultTimeZoneId;\n     }\n \n     @Override\n     public void handleCommand(ChannelUID channelUID, Command command) {\n-        // No specific commands tied to this, but we will trigger an update\n-        this.refreshNtpCount = 0;\n-        refreshTimeDate();\n+        if (command == RefreshType.REFRESH) {\n+            logger.debug(\"Refreshing channel '{}' for '{}'.\", channelUID.getId(), getThing().getUID());\n+            refreshTimeDate();\n+        }\n     }\n \n     @Override\n     public void initialize() {\n-        try {\n-            logger.debug(\"Initializing NTP handler for '{}'.\", getThing().getUID());\n+        logger.debug(\"Initializing NTP handler for '{}'.\", getThing().getUID());\n \n-            Configuration config = getThing().getConfiguration();\n-            hostname = config.get(PROPERTY_NTP_SERVER_HOST).toString();\n-            port = (BigDecimal) config.get(PROPERTY_NTP_SERVER_PORT);\n-            refreshInterval = (BigDecimal) config.get(PROPERTY_REFRESH_INTERVAL);\n-            refreshNtp = (BigDecimal) config.get(PROPERTY_REFRESH_NTP);\n-            refreshNtpCount = 0;\n+        NtpThingConfiguration config = getConfigAs(NtpThingConfiguration.class);\n+        configuration = config;\n \n-            try {\n-                Object timeZoneConfigValue = config.get(PROPERTY_TIMEZONE);\n-                if (timeZoneConfigValue != null) {\n-                    timeZone = TimeZone.getTimeZone(timeZoneConfigValue.toString());\n-                } else {\n-                    timeZone = TimeZone.getDefault();\n-                    logger.debug(\"{} using default TZ '{}', because configuration property '{}' is null.\",\n-                            getThing().getUID(), timeZone, PROPERTY_TIMEZONE);\n-                }\n-            } catch (Exception e) {\n-                timeZone = TimeZone.getDefault();\n-                logger.debug(\"{} using default TZ '{}' due to an occurred exception: \", getThing().getUID(), timeZone,\n-                        e);\n-            }\n+        refreshNtpCount = 0;\n \n+        String timeZoneConfigValue = config.getTimeZone();", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwMDk5NA==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434200994", "bodyText": "I can't define a default for the configuration because the expected default is the timezone provided by the TimeZoneProvider.", "author": "lolodomo", "createdAt": "2020-06-02T22:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NTg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NjE0NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434066145", "bodyText": "Is it necessary to catch Exception here?", "author": "J-N-K", "createdAt": "2020-06-02T17:56:53Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/handler/NtpHandler.java", "diffHunk": "@@ -54,217 +54,183 @@\n  * to one of the channels.\n  *\n  * @author Marcel Verpaalen - Initial contribution OH2 ntp binding\n- * @author Thomas.Eichstaedt-Engelen OH1 ntp binding (getTime routine)\n+ * @author Thomas.Eichstaedt - Engelen OH1 ntp binding (getTime routine)\n  * @author Markus Rathgeb - Add locale provider\n  * @author Erdoan Hadzhiyusein - Adapted the class to work with the new DateTimeType\n+ * @author Laurent Garnier - null annotations, TimeZoneProvider, configuration settings cleanup\n  */\n-\n+@NonNullByDefault\n public class NtpHandler extends BaseThingHandler {\n \n-    private final Logger logger = LoggerFactory.getLogger(NtpHandler.class);\n-\n     /** timeout for requests to the NTP server */\n     private static final int NTP_TIMEOUT = 30000;\n \n     public static final String DATE_PATTERN_WITH_TZ = \"yyyy-MM-dd HH:mm:ss z\";\n+    private static final DateTimeFormatter DATE_FORMATTER_WITH_TZ = DateTimeFormatter.ofPattern(DATE_PATTERN_WITH_TZ);\n \n-    /** for logging purposes */\n-    private final DateFormat SDF = new SimpleDateFormat(DATE_PATTERN_WITH_TZ);\n+    private final Logger logger = LoggerFactory.getLogger(NtpHandler.class);\n \n     /** for publish purposes */\n     private DateTimeFormatter dateTimeFormat = DateTimeFormatter.ofPattern(DATE_PATTERN_WITH_TZ);\n \n-    private final LocaleProvider localeProvider;\n+    private @Nullable NtpThingConfiguration configuration;\n \n-    ScheduledFuture<?> refreshJob;\n+    private @Nullable ScheduledFuture<?> refreshJob;\n \n-    /** NTP host */\n-    private String hostname;\n-    /** NTP server port */\n-    private BigDecimal port;\n-    /** refresh interval */\n-    private BigDecimal refreshInterval;\n-    /** NTP refresh frequency */\n-    private BigDecimal refreshNtp = new BigDecimal(0);\n-    /** Timezone */\n-    private TimeZone timeZone;\n-    /** Locale */\n-    private Locale locale;\n+    private ZoneId defaultTimeZoneId;\n+    private ZoneId timeZoneId;\n \n     /** NTP refresh counter */\n     private int refreshNtpCount = 0;\n     /** NTP system time delta */\n     private long timeOffset;\n \n-    private ChannelUID dateTimeChannelUID;\n-    private ChannelUID stringChannelUID;\n-\n-    public NtpHandler(final Thing thing, final LocaleProvider localeProvider) {\n+    public NtpHandler(final Thing thing, final TimeZoneProvider timeZoneProvider) {\n         super(thing);\n-        this.localeProvider = localeProvider;\n+        this.defaultTimeZoneId = timeZoneProvider.getTimeZone();\n+        this.timeZoneId = defaultTimeZoneId;\n     }\n \n     @Override\n     public void handleCommand(ChannelUID channelUID, Command command) {\n-        // No specific commands tied to this, but we will trigger an update\n-        this.refreshNtpCount = 0;\n-        refreshTimeDate();\n+        if (command == RefreshType.REFRESH) {\n+            logger.debug(\"Refreshing channel '{}' for '{}'.\", channelUID.getId(), getThing().getUID());\n+            refreshTimeDate();\n+        }\n     }\n \n     @Override\n     public void initialize() {\n-        try {\n-            logger.debug(\"Initializing NTP handler for '{}'.\", getThing().getUID());\n+        logger.debug(\"Initializing NTP handler for '{}'.\", getThing().getUID());\n \n-            Configuration config = getThing().getConfiguration();\n-            hostname = config.get(PROPERTY_NTP_SERVER_HOST).toString();\n-            port = (BigDecimal) config.get(PROPERTY_NTP_SERVER_PORT);\n-            refreshInterval = (BigDecimal) config.get(PROPERTY_REFRESH_INTERVAL);\n-            refreshNtp = (BigDecimal) config.get(PROPERTY_REFRESH_NTP);\n-            refreshNtpCount = 0;\n+        NtpThingConfiguration config = getConfigAs(NtpThingConfiguration.class);\n+        configuration = config;\n \n-            try {\n-                Object timeZoneConfigValue = config.get(PROPERTY_TIMEZONE);\n-                if (timeZoneConfigValue != null) {\n-                    timeZone = TimeZone.getTimeZone(timeZoneConfigValue.toString());\n-                } else {\n-                    timeZone = TimeZone.getDefault();\n-                    logger.debug(\"{} using default TZ '{}', because configuration property '{}' is null.\",\n-                            getThing().getUID(), timeZone, PROPERTY_TIMEZONE);\n-                }\n-            } catch (Exception e) {\n-                timeZone = TimeZone.getDefault();\n-                logger.debug(\"{} using default TZ '{}' due to an occurred exception: \", getThing().getUID(), timeZone,\n-                        e);\n-            }\n+        refreshNtpCount = 0;\n \n+        String timeZoneConfigValue = config.getTimeZone();\n+        if (timeZoneConfigValue != null) {\n+            logger.debug(\"{} with timezone '{}' set in configuration setting '{}'\", getThing().getUID(),\n+                    timeZoneConfigValue, NtpThingConfiguration.TIMEZONE);\n             try {\n-                Object localeStringConfigValue = config.get(PROPERTY_LOCALE);\n-                if (localeStringConfigValue != null) {\n-                    locale = new Locale(localeStringConfigValue.toString());\n-                } else {\n-                    locale = localeProvider.getLocale();\n-                    logger.debug(\"{} using default locale '{}', because configuration property '{}' is null.\",\n-                            getThing().getUID(), locale, PROPERTY_LOCALE);\n-                }\n+                timeZoneId = TimeZone.getTimeZone(timeZoneConfigValue).toZoneId();\n             } catch (Exception e) {", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwMTY2NA==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434201664", "bodyText": "You're right, it is not necessary because it returns GMT if the string is invalid.\nFixed.", "author": "lolodomo", "createdAt": "2020-06-02T22:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NjE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NzE1MA==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434067150", "bodyText": "I would prefer to keep the constants here, as that is what is most common in other bindings.", "author": "J-N-K", "createdAt": "2020-06-02T17:58:35Z", "path": "bundles/org.openhab.binding.ntp/src/main/java/org/openhab/binding/ntp/internal/NtpBindingConstants.java", "diffHunk": "@@ -37,14 +37,5 @@\n     public static final String CHANNEL_DATE_TIME = \"dateTime\";\n     public static final String CHANNEL_STRING = \"string\";\n \n-    // Custom Properties\n-    public static final String PROPERTY_NTP_SERVER_HOST = \"hostname\";", "originalCommit": "04af19568731c35495b54af1b636326ccb5c8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwMjQwMg==", "url": "https://github.com/openhab/openhab-addons/pull/7834#discussion_r434202402", "bodyText": "I often saw the constants defined in th econfiguration class too.\nBut ok, I revert.", "author": "lolodomo", "createdAt": "2020-06-02T22:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2NzE1MA=="}], "type": "inlineReview"}, {"oid": "18f34f27fd4b1380d90342e715cdee5310652de5", "url": "https://github.com/openhab/openhab-addons/commit/18f34f27fd4b1380d90342e715cdee5310652de5", "message": "All review comments considered\n\nUse constructor injector for the discovery service\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-02T23:17:16Z", "type": "forcePushed"}, {"oid": "c0e2029de17605075265614185e3bf992d40d027", "url": "https://github.com/openhab/openhab-addons/commit/c0e2029de17605075265614185e3bf992d40d027", "message": "All review comments considered\n\nUse constructor injection for the discovery service\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-02T23:27:08Z", "type": "commit"}, {"oid": "c0e2029de17605075265614185e3bf992d40d027", "url": "https://github.com/openhab/openhab-addons/commit/c0e2029de17605075265614185e3bf992d40d027", "message": "All review comments considered\n\nUse constructor injection for the discovery service\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-02T23:27:08Z", "type": "forcePushed"}, {"oid": "7bf80ae6a2a5edf7e481622062d1c683f27d78c7", "url": "https://github.com/openhab/openhab-addons/commit/7bf80ae6a2a5edf7e481622062d1c683f27d78c7", "message": "Pass ZoneId rather than TimeZoneProvider to the thing handler\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-08T15:58:14Z", "type": "commit"}, {"oid": "4791b0eb84ccb794bfa57b61d4bd0995171b7228", "url": "https://github.com/openhab/openhab-addons/commit/4791b0eb84ccb794bfa57b61d4bd0995171b7228", "message": "Revert to keep TimeZoneProvider on the thing handler\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-09T07:25:44Z", "type": "commit"}, {"oid": "7cc9c724fe3d830ffbeab399710332bef8fd78da", "url": "https://github.com/openhab/openhab-addons/commit/7cc9c724fe3d830ffbeab399710332bef8fd78da", "message": "Use TimeZoneProvider each time the timezone is required\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-09T12:26:44Z", "type": "commit"}, {"oid": "3a6afd5d0886ca001672f30a06e0eea881b171d1", "url": "https://github.com/openhab/openhab-addons/commit/3a6afd5d0886ca001672f30a06e0eea881b171d1", "message": "Call activate in the discovery service constructor\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-10T17:12:46Z", "type": "commit"}]}