{"pr_number": 7299, "pr_title": "[lgwebos] Avoid thing updates when the thing handler is already disposed", "pr_createdAt": "2020-04-05T11:43:38Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7299", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r403704602", "bodyText": "Is there a more direct way of determining if the handler is disposed? Or more importantly, shouldn't this class be disposed along with the handler in the first place?", "author": "cpmeister", "createdAt": "2020-04-05T13:50:01Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java", "diffHunk": "@@ -332,6 +333,10 @@ private void sendMessage(JsonObject json) {\n     @OnWebSocketMessage\n     public void onMessage(String message) {\n         logger.trace(\"Message [in]: {}\", message);\n+        if (this.listener == null) {\n+            logger.debug(\"Message is ignored because the thing handler is already disposed.\");\n+            return;\n+        }", "originalCommit": "01f49900726189f3930bbb49af70926ebfee7de5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcxMjMyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r403712325", "bodyText": "In fact, this is the more direct way I found.\nHere is the code run when the thing handler is disposed:\n        LGWebOSTVSocket s = socket;\n        if (s != null) {\n            s.setListener(null);\n            scheduler.execute(() -> s.disconnect()); // dispose should be none-blocking\n        }\n\nAs you can see, this is done asynchronously. It can happen that messages are received and handled bedore disconnect() is run.\nsetListener is called with the thing handler in thing handler initialize().\nsetListener is called with null in thing handler dispose().", "author": "lolodomo", "createdAt": "2020-04-05T14:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcxNTAyMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r403715021", "bodyText": "The variable is named listener but in fact listener = thingHandler", "author": "lolodomo", "createdAt": "2020-04-05T15:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0NDY0MA==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r403744640", "bodyText": "I'm not sure that s.disconnect() should be called asynchronously as part of disposing. Any essential cleanup should be done immediately because initialize() might be called immediately afterward and any socket resources getting initialized might collide with the socket resources that are getting disposed.\nBut I'm not sure if such a change is within the scope of this PR...", "author": "cpmeister", "createdAt": "2020-04-05T19:14:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NDQ2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r403764462", "bodyText": "@sprehn : can you comment about the asynchronous disconnect please ? The comment looks clear, is s.disconnect() really blocking ? Until what ?\n@cpmeister : yes, the scope of my PR was not to change that but rather avoid having the reconnect job continuing its scenario while the thing handler is already disposed.", "author": "lolodomo", "createdAt": "2020-04-05T22:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzODg1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r405838853", "bodyText": "yes we indeed can make this call synchronous\ns.disconnect enqueues a websocket close, which is asynchronous\nit synchronously sets the state to disconnected", "author": "sprehn", "createdAt": "2020-04-08T21:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NDM4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r405844385", "bodyText": "the lgweostvsocket instance gets disposed\na new instance is created during initialize\ncan you remind me what the issues is that needs to be solved?\nmaybe we should not do setListener(null)", "author": "sprehn", "createdAt": "2020-04-08T22:10:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NDE3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r406044175", "bodyText": "You can read again last @cpmeister message, he explained the problem. It occurs when the thing handler is quickly disposed and initialized again while the first registering process is still running.", "author": "lolodomo", "createdAt": "2020-04-09T08:34:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2NDgwMw==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r406664803", "bodyText": "but we create a new socket each time we initialize. so states should be clean.\nwhat is the issue for end users?", "author": "sprehn", "createdAt": "2020-04-10T08:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNDYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNDYwNw==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r405834607", "bodyText": "Don\u2019t like this change\nthis class should be agnostic to OH types like thing handler and lifecycle\nany response should still be handled properly and definitely not depend on if someone is watching for state changes", "author": "sprehn", "createdAt": "2020-04-08T21:47:52Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java", "diffHunk": "@@ -332,6 +333,10 @@ private void sendMessage(JsonObject json) {\n     @OnWebSocketMessage\n     public void onMessage(String message) {\n         logger.trace(\"Message [in]: {}\", message);\n+        if (this.listener == null) {", "originalCommit": "01f49900726189f3930bbb49af70926ebfee7de5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0MjY0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r406042642", "bodyText": "This class is already linked to OH as you are updating the thing properties and the thing configuration when handling received messages (during the registering process). Of course, we have to avoid that when the thing handler is already disposed.", "author": "lolodomo", "createdAt": "2020-04-09T08:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2NTU3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7299#discussion_r406665577", "bodyText": "there is an interface which thinghandler implements, so there is not dependency\nthe behavior should not change whether or not somebody is whatching. reminds me of schr\u00f6dinger\u2019s cat", "author": "sprehn", "createdAt": "2020-04-10T08:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNDYwNw=="}], "type": "inlineReview"}, {"oid": "ad918d4e3e1224067a7831b7087a6a3ed8d6a3ff", "url": "https://github.com/openhab/openhab-addons/commit/ad918d4e3e1224067a7831b7087a6a3ed8d6a3ff", "message": "[lgwebos] Avoid thing updates when the thing handler is already disposed\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-09T09:32:25Z", "type": "forcePushed"}, {"oid": "88105f925670b54448d553e629cd17d2c909178e", "url": "https://github.com/openhab/openhab-addons/commit/88105f925670b54448d553e629cd17d2c909178e", "message": "[lgwebos] Avoid thing updates when the thing handler is already disposed\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-10T11:03:12Z", "type": "forcePushed"}, {"oid": "935ad8afddcdba5e55a35db472df061dfb9d5819", "url": "https://github.com/openhab/openhab-addons/commit/935ad8afddcdba5e55a35db472df061dfb9d5819", "message": "[lgwebos] Avoid thing updates when the thing handler is already disposed\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-10T11:07:21Z", "type": "commit"}, {"oid": "935ad8afddcdba5e55a35db472df061dfb9d5819", "url": "https://github.com/openhab/openhab-addons/commit/935ad8afddcdba5e55a35db472df061dfb9d5819", "message": "[lgwebos] Avoid thing updates when the thing handler is already disposed\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-10T11:07:21Z", "type": "forcePushed"}, {"oid": "b571162efb14d93f80852290074a48af959dbb45", "url": "https://github.com/openhab/openhab-addons/commit/b571162efb14d93f80852290074a48af959dbb45", "message": "Change of state trigger for stopping the reconection job and starting the keep alive job\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-04-10T11:42:01Z", "type": "commit"}]}