{"pr_number": 7487, "pr_title": "[daikin] Add support for BRP072C42 adapter", "pr_createdAt": "2020-04-27T11:49:49Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7487", "timeline": [{"oid": "6ab6743b694bc4a302b52454d63a30538a48f6ad", "url": "https://github.com/openhab/openhab-addons/commit/6ab6743b694bc4a302b52454d63a30538a48f6ad", "message": "[daikin] Add support for BRP072C42 adapter\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-19T02:16:34Z", "type": "commit"}, {"oid": "af49791e5e89ce9c68ddab9d525c91081402c63d", "url": "https://github.com/openhab/openhab-addons/commit/af49791e5e89ce9c68ddab9d525c91081402c63d", "message": "[daikin] Implement autodiscovery for BRP072C42\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-24T00:43:10Z", "type": "commit"}, {"oid": "49ded0cf4ae5c6f62d4c82d9a84ade757236d355", "url": "https://github.com/openhab/openhab-addons/commit/49ded0cf4ae5c6f62d4c82d9a84ade757236d355", "message": "[daikin] Revert to manually creating HttpClient\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-27T11:38:26Z", "type": "commit"}, {"oid": "c091c3e55cb64dac829a1c59c4db08f421d1ae13", "url": "https://github.com/openhab/openhab-addons/commit/c091c3e55cb64dac829a1c59c4db08f421d1ae13", "message": "[daikin] Code cleanup\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-27T11:49:24Z", "type": "commit"}, {"oid": "86e962909031a860bddf1c84c2eff84b2f1256b9", "url": "https://github.com/openhab/openhab-addons/commit/86e962909031a860bddf1c84c2eff84b2f1256b9", "message": "[daikin] Code cleanup\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-27T12:04:38Z", "type": "commit"}, {"oid": "25f9dd99ef9c8c4c213a3b03af477b7c1e710071", "url": "https://github.com/openhab/openhab-addons/commit/25f9dd99ef9c8c4c213a3b03af477b7c1e710071", "message": "[daikin] Code cleanup\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-27T12:12:09Z", "type": "commit"}, {"oid": "13a148532a0e47dd8aae1045fb0cdefc2a3dfb2f", "url": "https://github.com/openhab/openhab-addons/commit/13a148532a0e47dd8aae1045fb0cdefc2a3dfb2f", "message": "[daikin] Centralise httpClient creation into DaikinWebTargets\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-27T22:21:37Z", "type": "commit"}, {"oid": "13a148532a0e47dd8aae1045fb0cdefc2a3dfb2f", "url": "https://github.com/openhab/openhab-addons/commit/13a148532a0e47dd8aae1045fb0cdefc2a3dfb2f", "message": "[daikin] Centralise httpClient creation into DaikinWebTargets\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-27T22:21:37Z", "type": "forcePushed"}, {"oid": "fd712d38dec63f7922157e74f3c9d677d0f43fa7", "url": "https://github.com/openhab/openhab-addons/commit/fd712d38dec63f7922157e74f3c9d677d0f43fa7", "message": "Merge branch '2.5.x' into daikin-BRP072C42", "committedDate": "2020-04-27T22:26:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc3Njk0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r416776942", "bodyText": "You should still log this", "author": "cpmeister", "createdAt": "2020-04-28T17:02:08Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/handler/DaikinAcUnitHandler.java", "diffHunk": "@@ -131,4 +131,13 @@ protected void changeFanDir(String fanDir) throws DaikinCommunicationException {\n         info.fanMovement = FanMovement.valueOf(fanDir);\n         webTargets.setControlInfo(info);\n     }\n+\n+    @Override\n+    protected void registerUuid(String key) {\n+        try {\n+            webTargets.registerUuid(key);\n+        } catch (Exception e) {\n+            // suppress exceptions", "originalCommit": "fd712d38dec63f7922157e74f3c9d677d0f43fa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgxNzIyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r416817225", "bodyText": "You should also pass e in your constructor as a cause exception.", "author": "cpmeister", "createdAt": "2020-04-28T18:04:20Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/DaikinWebTargets.java", "diffHunk": "@@ -145,13 +192,39 @@ private String invoke(String uri, Map<String, String> params) throws DaikinCommu\n         }\n \n         if (response == null) {\n-            throw new DaikinCommunicationException(\n-                    String.format(\"Daikin controller returned error while invoking %s\", uriWithParams));\n+            throw new DaikinCommunicationException(\"Daikin controller returned error while invoking \" + uriWithParams);\n         }\n \n         return response;\n     }\n \n+    private String executeUrl(String url) throws DaikinCommunicationException {\n+        try {\n+            Request request = httpClient.newRequest(url)\n+                                        .method(HttpMethod.GET)\n+                                        .timeout(TIMEOUT_MS, TimeUnit.MILLISECONDS);\n+            if (uuid != null) {\n+                request.header(\"X-Daikin-uuid\", uuid);\n+                logger.debug(\"Header: X-Daikin-uuid: {}\", uuid);\n+            }\n+            ContentResponse response = request.send();\n+\n+            if (response.getStatus() == HttpStatus.FORBIDDEN_403) {\n+                throw new DaikinCommunicationForbiddenException(\"Daikin controller access denied. Check uuid/key.\");\n+            }\n+\n+            if (response.getStatus() != HttpStatus.OK_200) {\n+                logger.debug(\"Daikin controller HTTP status: {} - {}\", response.getStatus(), response.getReason());\n+            }\n+\n+            return response.getContentAsString();\n+        } catch (DaikinCommunicationException e) {\n+            throw e;\n+        } catch (Exception e) {\n+            throw new DaikinCommunicationException(\"Daikin HTTP error: \" + e.getMessage());", "originalCommit": "fd712d38dec63f7922157e74f3c9d677d0f43fa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgxNzk5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r416817997", "bodyText": "Does DaikinCommunicationException extend an IOException? If not then you don't need to catch it here.", "author": "cpmeister", "createdAt": "2020-04-28T18:05:40Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/DaikinWebTargets.java", "diffHunk": "@@ -136,7 +176,14 @@ private String invoke(String uri, Map<String, String> params) throws DaikinCommu\n         String response;\n         synchronized (this) {\n             try {\n-                response = HttpUtil.executeUrl(\"GET\", uriWithParams, TIMEOUT_MS);\n+                if (httpClient != null) {\n+                    response = executeUrl(uriWithParams);\n+                } else {\n+                    // a fall back method\n+                    response = HttpUtil.executeUrl(\"GET\", uriWithParams, TIMEOUT_MS);\n+                }\n+            } catch (DaikinCommunicationException ex) {\n+                throw ex;", "originalCommit": "fd712d38dec63f7922157e74f3c9d677d0f43fa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgzNzkwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r416837906", "bodyText": "Yes it does", "author": "jimtng", "createdAt": "2020-04-28T18:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgxNzk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgxODg0Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r416818846", "bodyText": "Are these new configs backwards compatible with existing setups?", "author": "cpmeister", "createdAt": "2020-04-28T18:07:01Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/config/DaikinConfiguration.java", "diffHunk": "@@ -16,12 +16,18 @@\n  * Holds configuration data for a Daikin air conditioning unit.\n  *\n  * @author Tim Waterhouse - Initial contribution\n+ * @author Jimmy Tanagra - Add secure, uuid\n  *\n  */\n public class DaikinConfiguration {\n     public static final String HOST = \"host\";\n+    public static final String SECURE = \"secure\";\n+    public static final String UUID = \"uuid\";\n+    public static final String KEY = \"key\";\n \n     public String host;\n-\n+    public Boolean secure;\n+    public String uuid;\n+    public String key;", "originalCommit": "fd712d38dec63f7922157e74f3c9d677d0f43fa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgzOTE5OA==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r416839198", "bodyText": "Yes they are. Existing config especially those using .things file that don't specify these configs will continue to work. The new configs are not required, at least for the existing adapters. They do need to be provided for the new adapter to work, otherwise a CONFIGURATION_ERROR will be issued on thing status.", "author": "jimtng", "createdAt": "2020-04-28T18:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgxODg0Ng=="}], "type": "inlineReview"}, {"oid": "95781edea3a0e5dda63d85f63c3c16914dcd624c", "url": "https://github.com/openhab/openhab-addons/commit/95781edea3a0e5dda63d85f63c3c16914dcd624c", "message": "[daikin] Modify exception\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-28T18:56:05Z", "type": "commit"}, {"oid": "3e35bf70d756612e14ed292ed693d59397a78f20", "url": "https://github.com/openhab/openhab-addons/commit/3e35bf70d756612e14ed292ed693d59397a78f20", "message": "[daikin] Log exception in DaikinAcUnitHandler.java\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-28T19:03:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODQ2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418228466", "bodyText": "You should be creating client instances from the osgi org.eclipse.smarthome.io.net.http.HttpClientFactory service.", "author": "cpmeister", "createdAt": "2020-04-30T19:07:52Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/DaikinWebTargets.java", "diffHunk": "@@ -49,13 +61,29 @@\n     private String getAirbaseZoneInfoUri;\n     private String setAirbaseZoneInfoUri;\n \n+    private String uuid;\n+    private static HttpClient httpClient;\n+\n     private Logger logger = LoggerFactory.getLogger(DaikinWebTargets.class);\n \n-    public DaikinWebTargets(String ipAddress) {\n-        String baseUri = \"http://\" + ipAddress + \"/\";\n+    public DaikinWebTargets(String host, Boolean secure, String uuid) {\n+        if (httpClient == null) {\n+            httpClient = new HttpClient(new SslContextFactory(true));", "originalCommit": "3e35bf70d756612e14ed292ed693d59397a78f20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMyOTI2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418329266", "bodyText": "I tried this. It didn't work because we need \"trust all\" from SslContextFactory. We're dealing with name mismatch - the adapter is accessed using https://192.168.1.x (ip address) and possibly self signed certificate. The Common Name (CN) of the certificate is something like \"0ADF1002341228818192.srv\", so clearly no way to get this name to match without creating a static DNS entry on the user's network. I have even tried httpClient.getSslContextFactory().setTrustAll(true) but that didn't seem to work. So this method of creating a custom HttpClient is the only way that seems to work.", "author": "jimtng", "createdAt": "2020-04-30T22:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MTA3NA==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418361074", "bodyText": "Ok, since you had a good reason to create the client instance yourself I'll allow it.", "author": "cpmeister", "createdAt": "2020-05-01T00:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418228925", "bodyText": "Make this non-static and final.", "author": "cpmeister", "createdAt": "2020-04-30T19:08:43Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/DaikinWebTargets.java", "diffHunk": "@@ -49,13 +61,29 @@\n     private String getAirbaseZoneInfoUri;\n     private String setAirbaseZoneInfoUri;\n \n+    private String uuid;\n+    private static HttpClient httpClient;", "originalCommit": "3e35bf70d756612e14ed292ed693d59397a78f20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMDUzNA==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418330534", "bodyText": "I opted to use static to reduce the number of instances of HttpClient within the binding. Using non-static and final, and creating the HttpClient without using the HttpClientFactory will result in the creation of HttpClient multiple times especially each time the discovery process runs.\nThere is a warning in HttpClientFactory.java (core code) that says in ALL CAPS:\nDO NOT CREATE NEW CLIENTS FOR EACH REQUEST", "author": "jimtng", "createdAt": "2020-04-30T22:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM1NzgzMA==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418357830", "bodyText": "Why not just supply the client instance through the constructor?", "author": "cpmeister", "createdAt": "2020-05-01T00:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MjIyNg==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418362226", "bodyText": "Why not just supply the client instance through the constructor?\n\nI did that at first. There are two places the instances will need to be created: in the handlerfactory service and in the discovery service. I thought I'd simplify the overall complexity by just creating it inside the DaikinWebTargets. In any case, it will still need to be created, not using the HttpClientFactory.\nShould I move back the creation/instantiation into the two services and pass the object through the constructor of DaikinWebTargets?", "author": "jimtng", "createdAt": "2020-05-01T00:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MzgxNw==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418363817", "bodyText": "If we were to move the instantiation to the services, there will be two instances of HttpClient created instead of one.", "author": "jimtng", "createdAt": "2020-05-01T00:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2NjY2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418366666", "bodyText": "You can make your own http client factory service that the discovery service and handler factory service can get a reference to.", "author": "cpmeister", "createdAt": "2020-05-01T00:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3OTAwNw==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418379007", "bodyText": "I would be happy to do this, but I'd like to better understand the problem.\nCould you please clarify: are you suggesting to create a separate osgi service that would create the httpclient, and that you're not referring to org.eclipse.smarthome.io.net.http.HttpClientFactory::createHttpClient()?\nCould you explain what is the reasoning behind this and the benefit over the current approach?", "author": "jimtng", "createdAt": "2020-05-01T01:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NTI2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418385267", "bodyText": "Well your current approach of using a static field makes it unclear what controls the lifecycle of the http client. Openhab runs in an osgi environment so it is exepcted that osgi should control the lifecycle of every service and object, either directly or indirectly. Right now if osgi wants to shut down your binding there is no way for it to shut down your static client instance.\n\nCould you please clarify: are you suggesting to create a separate osgi service that would create the httpclient\n\nI was suggesting that you create a separate service, since it didn't seem appropriate for your handler factory to have references to the discovery service or vice versa. Having an independent service that could be referenced by both seemed like the best approach.\nIf you don't want to create a separate osgi service then you could just have your handler factory manually register the http client factory through the bundle context.\n\nand that you're not referring to org.eclipse.smarthome.io.net.http.HttpClientFactory::createHttpClient()?\n\nNo, I am not suggesting to create your own subclass of org.eclipse.smarthome.io.net.http.HttpClientFactory since you wouldn't want to have any conflicts in the osgi registry. You would need to create your own factory interface instead.", "author": "cpmeister", "createdAt": "2020-05-01T02:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk2MjI4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r418962286", "bodyText": "I've created a separate osgi service for the HttpClient.", "author": "jimtng", "createdAt": "2020-05-02T13:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyODkyNQ=="}], "type": "inlineReview"}, {"oid": "e1c108c0447ab137fe42d56f4120d1f0a1e5492c", "url": "https://github.com/openhab/openhab-addons/commit/e1c108c0447ab137fe42d56f4120d1f0a1e5492c", "message": "[daikin] Fix a typo, add unit, rephrase description in config.xml\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-04-30T22:47:34Z", "type": "commit"}, {"oid": "655260ba80811864c880c5c313b17b763d943bb5", "url": "https://github.com/openhab/openhab-addons/commit/655260ba80811864c880c5c313b17b763d943bb5", "message": "[daikin] Add DaikinHttpClientFactory osgi component\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-05-02T13:55:24Z", "type": "commit"}, {"oid": "e98aeb2d2306b50a9ca1b96c5e76e067861edaab", "url": "https://github.com/openhab/openhab-addons/commit/e98aeb2d2306b50a9ca1b96c5e76e067861edaab", "message": "[daikin] Clean up DaikinWebTargets imports\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-05-02T14:03:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMjUxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419002513", "bodyText": "Just to be safe\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void initialize() {\n          \n          \n            \n                private synchronized void initialize() {", "author": "cpmeister", "createdAt": "2020-05-02T20:13:37Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/DaikinHttpClientFactoryImpl.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.daikin.internal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.util.ssl.SslContextFactory;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Factory class to create Jetty web clients\n+ *\n+ * Some Daikin controllers communicate via https using a custom common name, \n+ * and they are accessed using an ip address.\n+ *\n+ * The core HttpClientFactory creates a HttpClient that will fail because of this.\n+ * This factory creates a HttpClient with SslContextFactory(true)\n+ * which will accept any ssl certificate without checking for common name mismatches.\n+ *\n+ * @author Jimmy Tanagra - Initial contribution\n+ */\n+@Component\n+@NonNullByDefault\n+public class DaikinHttpClientFactoryImpl implements DaikinHttpClientFactory {\n+\n+    private final Logger logger = LoggerFactory.getLogger(DaikinHttpClientFactoryImpl.class);\n+\n+    private @NonNullByDefault({}) HttpClient httpClient;\n+\n+    @Deactivate\n+    protected void deactivate() {\n+        if (httpClient != null) {\n+            try {\n+                httpClient.stop();\n+            } catch (Exception e) {\n+                logger.error(\"error while stopping Daikin http client\", e);\n+                // nothing else we can do here\n+            }\n+            httpClient = null;\n+            logger.debug(\"Daikin http client stopped\");\n+        }\n+    }\n+\n+    @Override\n+    public HttpClient getHttpClient() {\n+        initialize();\n+        return httpClient;\n+    }\n+\n+    private void initialize() {", "originalCommit": "655260ba80811864c880c5c313b17b763d943bb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMjc1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419002756", "bodyText": "The default charset varies from system to system so it is better to specify it yourself instead of using the default.", "author": "cpmeister", "createdAt": "2020-05-02T20:16:11Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/discovery/DaikinACUnitDiscoveryService.java", "diffHunk": "@@ -117,33 +128,54 @@ private Runnable createScanner() {\n \n     private boolean receivePacketAndDiscover(DatagramSocket socket) {\n         try {\n-            // Use a one byte buffer since we don't really care about the contents.\n-            byte[] buffer = new byte[1];\n+            byte[] buffer = new byte[512];\n             DatagramPacket incomingPacket = new DatagramPacket(buffer, buffer.length);\n             socket.setSoTimeout(1000 /* one second */);\n             socket.receive(incomingPacket);\n \n             String host = incomingPacket.getAddress().toString().substring(1);\n-            logger.debug(\"Received packet from {}\", host);\n+            String data = new String(incomingPacket.getData());", "originalCommit": "e98aeb2d2306b50a9ca1b96c5e76e067861edaab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAxNzE3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419017170", "bodyText": "done", "author": "jimtng", "createdAt": "2020-05-02T22:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMjc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA2NjM5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419066396", "bodyText": "I've changed it to US-ASCII", "author": "jimtng", "createdAt": "2020-05-03T08:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMjc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzA0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419003047", "bodyText": "The error logging level should be reserved for issues catastrophic enough to threaten the operation of openHab itself. An error in a binding shouldn't qualify for this. Please read the openHab coding guidelines for expected use of logging in bindings.\nMy general rule for logging levels is:\n\ntrace - used for normal expected execution paths\ndebug - used for unexepected execution paths, but well within normal operation\ninfo - used for notable points in an execution path, like a milestone. (in openhab we try reserve this logging level for the core, so bindings should rarely ever call this.)\nwarn - used for notable unexpected execution paths that a regular user (not just a developer) should be notified of. Warnings should be used to indicate that something not-normal occurred and user intervention is required to resolve. Warnings do not indicate a failure to operate merely an abnormal condition of operation that can still be handled by the binding. Failures in binding operation should be indicated by changing the thing status to offline.\nerror - used to indicate catastrophic program failure. This should be used to indicate a catastrophic failure in openhab's ability to operate. A failure in a binding would never cause openhab as a whole to fail so a failure in a bindings should never log an error. Instead that failure should be indicated by changing the thing status.", "author": "cpmeister", "createdAt": "2020-05-02T20:18:55Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/DaikinHttpClientFactoryImpl.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.daikin.internal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.util.ssl.SslContextFactory;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Factory class to create Jetty web clients\n+ *\n+ * Some Daikin controllers communicate via https using a custom common name, \n+ * and they are accessed using an ip address.\n+ *\n+ * The core HttpClientFactory creates a HttpClient that will fail because of this.\n+ * This factory creates a HttpClient with SslContextFactory(true)\n+ * which will accept any ssl certificate without checking for common name mismatches.\n+ *\n+ * @author Jimmy Tanagra - Initial contribution\n+ */\n+@Component\n+@NonNullByDefault\n+public class DaikinHttpClientFactoryImpl implements DaikinHttpClientFactory {\n+\n+    private final Logger logger = LoggerFactory.getLogger(DaikinHttpClientFactoryImpl.class);\n+\n+    private @NonNullByDefault({}) HttpClient httpClient;\n+\n+    @Deactivate\n+    protected void deactivate() {\n+        if (httpClient != null) {\n+            try {\n+                httpClient.stop();\n+            } catch (Exception e) {\n+                logger.error(\"error while stopping Daikin http client\", e);", "originalCommit": "e98aeb2d2306b50a9ca1b96c5e76e067861edaab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAxNzE5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419017193", "bodyText": "changed to debug", "author": "jimtng", "createdAt": "2020-05-02T22:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzA0Nw=="}], "type": "inlineReview"}, {"oid": "6b83636f48eb36cba4e83f85344da39ac8e70455", "url": "https://github.com/openhab/openhab-addons/commit/6b83636f48eb36cba4e83f85344da39ac8e70455", "message": "[daikin] Specify charset in incoming datagram packet\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-05-02T22:41:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0NDQ4MA==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419044480", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.error(\"Could not start Daikin http client\", e);\n          \n          \n            \n                            logger.debug(\"Could not start Daikin http client\", e);", "author": "cpmeister", "createdAt": "2020-05-03T04:17:10Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/DaikinHttpClientFactoryImpl.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.daikin.internal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.util.ssl.SslContextFactory;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Factory class to create Jetty web clients\n+ *\n+ * Some Daikin controllers communicate via https using a custom common name, \n+ * and they are accessed using an ip address.\n+ *\n+ * The core HttpClientFactory creates a HttpClient that will fail because of this.\n+ * This factory creates a HttpClient with SslContextFactory(true)\n+ * which will accept any ssl certificate without checking for common name mismatches.\n+ *\n+ * @author Jimmy Tanagra - Initial contribution\n+ */\n+@Component\n+@NonNullByDefault\n+public class DaikinHttpClientFactoryImpl implements DaikinHttpClientFactory {\n+\n+    private final Logger logger = LoggerFactory.getLogger(DaikinHttpClientFactoryImpl.class);\n+\n+    private @NonNullByDefault({}) HttpClient httpClient;\n+\n+    @Deactivate\n+    protected void deactivate() {\n+        if (httpClient != null) {\n+            try {\n+                httpClient.stop();\n+                logger.debug(\"Daikin http client stopped\");\n+            } catch (Exception e) {\n+                logger.debug(\"error while stopping Daikin http client\", e);\n+            }\n+            httpClient = null;\n+        }\n+    }\n+\n+    @Override\n+    public HttpClient getHttpClient() {\n+        initialize();\n+        return httpClient;\n+    }\n+\n+    private synchronized void initialize() {\n+        if (httpClient == null) {\n+            httpClient = new HttpClient(new SslContextFactory(true));\n+            try {\n+                httpClient.start();\n+                logger.debug(\"Daikin http client started\");\n+            } catch (Exception e) {\n+                logger.error(\"Could not start Daikin http client\", e);", "originalCommit": "6b83636f48eb36cba4e83f85344da39ac8e70455", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA2NjMyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419066325", "bodyText": "Oops I missed that one. Needed more sleep!", "author": "jimtng", "createdAt": "2020-05-03T08:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0NDQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0NDg2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419044863", "bodyText": "I can understand the hassle of dealing with the null checker, but please don't try to bypass it with @NonNullByDefault({}), it just hides potential concurrency issues.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private @NonNullByDefault({}) HttpClient httpClient;\n          \n          \n            \n                private @Nullable HttpClient httpClient;", "author": "cpmeister", "createdAt": "2020-05-03T04:21:49Z", "path": "bundles/org.openhab.binding.daikin/src/main/java/org/openhab/binding/daikin/internal/DaikinHttpClientFactoryImpl.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.daikin.internal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.util.ssl.SslContextFactory;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Factory class to create Jetty web clients\n+ *\n+ * Some Daikin controllers communicate via https using a custom common name, \n+ * and they are accessed using an ip address.\n+ *\n+ * The core HttpClientFactory creates a HttpClient that will fail because of this.\n+ * This factory creates a HttpClient with SslContextFactory(true)\n+ * which will accept any ssl certificate without checking for common name mismatches.\n+ *\n+ * @author Jimmy Tanagra - Initial contribution\n+ */\n+@Component\n+@NonNullByDefault\n+public class DaikinHttpClientFactoryImpl implements DaikinHttpClientFactory {\n+\n+    private final Logger logger = LoggerFactory.getLogger(DaikinHttpClientFactoryImpl.class);\n+\n+    private @NonNullByDefault({}) HttpClient httpClient;", "originalCommit": "6b83636f48eb36cba4e83f85344da39ac8e70455", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA2NjI2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7487#discussion_r419066262", "bodyText": "I added @NonNullByDefault to all the classes to remove the compile warnings and went through the affected code to adjust accordingly.\nI'm sorry that it would add more things to be reviewed.", "author": "jimtng", "createdAt": "2020-05-03T08:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA0NDg2Mw=="}], "type": "inlineReview"}, {"oid": "316363ca5b73606fafd0760fe8180c49d3083097", "url": "https://github.com/openhab/openhab-addons/commit/316363ca5b73606fafd0760fe8180c49d3083097", "message": "[daikin] Add @NonNullByDefault, Refactor setAirbaseZoneInfo, Change logger.error to debug\n\nSigned-off-by: Jimmy Tanagra <jcode@tanagra.id.au>", "committedDate": "2020-05-03T08:07:38Z", "type": "commit"}]}