{"pr_number": 7744, "pr_title": "[teleinfo] Initial contribution", "pr_createdAt": "2020-05-22T20:29:24Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7744", "timeline": [{"oid": "875a1069681267b2cee8bf4f558d4195b10cbc0e", "url": "https://github.com/openhab/openhab-addons/commit/875a1069681267b2cee8bf4f558d4195b10cbc0e", "message": "Use real name\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "7d9b5196ddc1850359803a3879f105d363e1a77e", "url": "https://github.com/openhab/openhab-addons/commit/7d9b5196ddc1850359803a3879f105d363e1a77e", "message": "Refactor predicate\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "9dddd0ee0c62529ead493c9befb6a281c4e051a9", "url": "https://github.com/openhab/openhab-addons/commit/9dddd0ee0c62529ead493c9befb6a281c4e051a9", "message": "Fix exception message\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "ee9745840b5e82e292802b38eac797eb0c5254c2", "url": "https://github.com/openhab/openhab-addons/commit/ee9745840b5e82e292802b38eac797eb0c5254c2", "message": "Remove catch clause\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "7eed3f75955ce55adb7a6cc8fe85fed567f6d361", "url": "https://github.com/openhab/openhab-addons/commit/7eed3f75955ce55adb7a6cc8fe85fed567f6d361", "message": "Remove useless dataType argument\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "a16006c8b3637d002702b7149e487bde1d47fcb3", "url": "https://github.com/openhab/openhab-addons/commit/a16006c8b3637d002702b7149e487bde1d47fcb3", "message": "Replace StringUtils by native java code\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "c18a0f3e6cd0d7fe4c64e2317dd320b7477cf1a5", "url": "https://github.com/openhab/openhab-addons/commit/c18a0f3e6cd0d7fe4c64e2317dd320b7477cf1a5", "message": "Remove unused method\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "b361df2abd8e4dc25fe25ec9121ab8247cbf86d8", "url": "https://github.com/openhab/openhab-addons/commit/b361df2abd8e4dc25fe25ec9121ab8247cbf86d8", "message": "Replace apache commons method by native method\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "71feaca8c6f15089f54fa87f55e1691f07f55763", "url": "https://github.com/openhab/openhab-addons/commit/71feaca8c6f15089f54fa87f55e1691f07f55763", "message": "Remove trailing whitespaces\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "56bac157d2537813b6335e55b3ecd04ca763dc5a", "url": "https://github.com/openhab/openhab-addons/commit/56bac157d2537813b6335e55b3ecd04ca763dc5a", "message": "Java 8 compatibility\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "dc9a19ee8534ce3a724b2770268e25ec63b4f997", "url": "https://github.com/openhab/openhab-addons/commit/dc9a19ee8534ce3a724b2770268e25ec63b4f997", "message": "Remove useless logging\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "d9ea4d3359333eeb5304749f4de86ed34023e23b", "url": "https://github.com/openhab/openhab-addons/commit/d9ea4d3359333eeb5304749f4de86ed34023e23b", "message": "Remove empty xml file\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "75c6846363f6bb9ad8233f5f4d67c68188cfaf6f", "url": "https://github.com/openhab/openhab-addons/commit/75c6846363f6bb9ad8233f5f4d67c68188cfaf6f", "message": "Update binding author name\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "516ffa4499309d9a6b2ecb20f053dce99cd7b118", "url": "https://github.com/openhab/openhab-addons/commit/516ffa4499309d9a6b2ecb20f053dce99cd7b118", "message": "Replace channel units by %unit%\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "76a4459a42e58a348949c01da8847e5777fe5ea9", "url": "https://github.com/openhab/openhab-addons/commit/76a4459a42e58a348949c01da8847e5777fe5ea9", "message": "Make PTEC value representation more user friendly\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "f193852111af384a8295572af7007a3361e07f50", "url": "https://github.com/openhab/openhab-addons/commit/f193852111af384a8295572af7007a3361e07f50", "message": "Capitalize word in label\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "7f765d86946da2f42fb2aeb2d4addbda8a0e62aa", "url": "https://github.com/openhab/openhab-addons/commit/7f765d86946da2f42fb2aeb2d4addbda8a0e62aa", "message": "Use reference for configuration description\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "dc635fe247db2d1eb2fbe2cb6667dd5f61a95a44", "url": "https://github.com/openhab/openhab-addons/commit/dc635fe247db2d1eb2fbe2cb6667dd5f61a95a44", "message": "Remove serial event listener hack\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "80977d767b6127ce550cf523cf9b6a3358a99196", "url": "https://github.com/openhab/openhab-addons/commit/80977d767b6127ce550cf523cf9b6a3358a99196", "message": "Use configuration description registry\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "7593849f6377d58259c896ad2ce2f06eab997948", "url": "https://github.com/openhab/openhab-addons/commit/7593849f6377d58259c896ad2ce2f06eab997948", "message": "Add new line at the end of file\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "8019a8d397b0d56951490007594b854be49a9090", "url": "https://github.com/openhab/openhab-addons/commit/8019a8d397b0d56951490007594b854be49a9090", "message": "Make loggers non static\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "657c68a4051c7e1016c41be2f42d9734d7f8cb14", "url": "https://github.com/openhab/openhab-addons/commit/657c68a4051c7e1016c41be2f42d9734d7f8cb14", "message": "Reorder static keyword\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "c989ba4d9b3e706efd5f98858b0a7f7b496d1844", "url": "https://github.com/openhab/openhab-addons/commit/c989ba4d9b3e706efd5f98858b0a7f7b496d1844", "message": "Fix @NonNullByDefault warnings\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "5f7744d544565ee2e3eb0bdb83835e1120c498a1", "url": "https://github.com/openhab/openhab-addons/commit/5f7744d544565ee2e3eb0bdb83835e1120c498a1", "message": "Fix @NonNull warning\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "e6f2c4f5a2674384280a87c95ffdd7da976c81d1", "url": "https://github.com/openhab/openhab-addons/commit/e6f2c4f5a2674384280a87c95ffdd7da976c81d1", "message": "Fix static variable name\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "df9af470cc8a8f00d9069b8488196819eaabe671", "url": "https://github.com/openhab/openhab-addons/commit/df9af470cc8a8f00d9069b8488196819eaabe671", "message": "Fix checkstyle warning\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "f1ed10417e98dcbb8915247e1b41f01c4f5cd3cd", "url": "https://github.com/openhab/openhab-addons/commit/f1ed10417e98dcbb8915247e1b41f01c4f5cd3cd", "message": "Fix tests compilation warning\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "9750e1d3bf8ea6106722e1f8214b97c58fc5e1b7", "url": "https://github.com/openhab/openhab-addons/commit/9750e1d3bf8ea6106722e1f8214b97c58fc5e1b7", "message": "Fix @NonNull compilation warning\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "36a23b364105392a2dbe04da88134102fe41cdb2", "url": "https://github.com/openhab/openhab-addons/commit/36a23b364105392a2dbe04da88134102fe41cdb2", "message": "Fix use of deprecated method\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "a1a3c5b7e4cc1fe8dc24612e63d6c4881b4c16a6", "url": "https://github.com/openhab/openhab-addons/commit/a1a3c5b7e4cc1fe8dc24612e63d6c4881b4c16a6", "message": "Open serial port in scheduler thread\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "1942d3fec3880c604dab0a50caa4fd001c046c56", "url": "https://github.com/openhab/openhab-addons/commit/1942d3fec3880c604dab0a50caa4fd001c046c56", "message": "Remove unused field\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "f39dcd5fb7c5f2ff33385db6503f75e0b8cb7472", "url": "https://github.com/openhab/openhab-addons/commit/f39dcd5fb7c5f2ff33385db6503f75e0b8cb7472", "message": "Fix null value check compiler warnings\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "14e607638c4122713f888a341c7413b07d720524", "url": "https://github.com/openhab/openhab-addons/commit/14e607638c4122713f888a341c7413b07d720524", "message": "Fix parameter label\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "1208ccefeb069c5ee34d157a704d58cbe6f05e2e", "url": "https://github.com/openhab/openhab-addons/commit/1208ccefeb069c5ee34d157a704d58cbe6f05e2e", "message": "Complete channels description table\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "18ba53afc12829e3df43f616cd078ee13ecea49b", "url": "https://github.com/openhab/openhab-addons/commit/18ba53afc12829e3df43f616cd078ee13ecea49b", "message": "Use same channel description than in README.md\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "bbb007951fa45ac3b0233f1cfbc34cf1a900236c", "url": "https://github.com/openhab/openhab-addons/commit/bbb007951fa45ac3b0233f1cfbc34cf1a900236c", "message": "Remove degug logging\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "40efff52ee9f3c0f647b7530a6b153ff7ac84eab", "url": "https://github.com/openhab/openhab-addons/commit/40efff52ee9f3c0f647b7530a6b153ff7ac84eab", "message": "Apply spotless formatter\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "08ecb270086d6265dd90df3c7c887356a4bfb27a", "url": "https://github.com/openhab/openhab-addons/commit/08ecb270086d6265dd90df3c7c887356a4bfb27a", "message": "Revert \"Make PTEC value representation more user friendly\"\n\nThis reverts commit 930733718e44088c0e812a7f1c95e4a422f1b167.\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "b8b8b85cb8169544fc62a0f8b808d1257365cd27", "url": "https://github.com/openhab/openhab-addons/commit/b8b8b85cb8169544fc62a0f8b808d1257365cd27", "message": "Use QuantityType to set units to decimal values\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "3f867000326ef2b419abfe0728c22f09f7017b5a", "url": "https://github.com/openhab/openhab-addons/commit/3f867000326ef2b419abfe0728c22f09f7017b5a", "message": "Remove currentPower channels\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "2eba67281418cb9b8e0b6a3aa7fc51fa0f24bc23", "url": "https://github.com/openhab/openhab-addons/commit/2eba67281418cb9b8e0b6a3aa7fc51fa0f24bc23", "message": "Fix typo in README.md\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "486cf674cf529e73524bee68d85d1e5116f7ba68", "url": "https://github.com/openhab/openhab-addons/commit/486cf674cf529e73524bee68d85d1e5116f7ba68", "message": "Make timeout values final and uppercase\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "60c1cad51ca6d74b44e935d5adf4dae3987455b7", "url": "https://github.com/openhab/openhab-addons/commit/60c1cad51ca6d74b44e935d5adf4dae3987455b7", "message": "Add bridge reference in things xml description\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "fccaab81ea1461d8c580557945fb46da13b68c7b", "url": "https://github.com/openhab/openhab-addons/commit/fccaab81ea1461d8c580557945fb46da13b68c7b", "message": "Remove empty lines\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "ed86106e2bf0108e3f25e0ac39d553b6197a9471", "url": "https://github.com/openhab/openhab-addons/commit/ed86106e2bf0108e3f25e0ac39d553b6197a9471", "message": "Capitalize words in label\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "af95d592e7ba475baee5b2ce66a4c19da2238fd2", "url": "https://github.com/openhab/openhab-addons/commit/af95d592e7ba475baee5b2ce66a4c19da2238fd2", "message": "Fix typo in thing label\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "842964081d5b917846f26ff204e204b5024c6e2a", "url": "https://github.com/openhab/openhab-addons/commit/842964081d5b917846f26ff204e204b5024c6e2a", "message": "Use openhab scheduler\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "32387e39e24d46dc95d948688bb2e21bfd95cf30", "url": "https://github.com/openhab/openhab-addons/commit/32387e39e24d46dc95d948688bb2e21bfd95cf30", "message": "Throw exception and remove return statement\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "33db28f58f90facab510e2940c786adfddb8866a", "url": "https://github.com/openhab/openhab-addons/commit/33db28f58f90facab510e2940c786adfddb8866a", "message": "Fix microseconds suffix\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "2dc2f5aa22c2356b8ff56bf0218d5efabd811baf", "url": "https://github.com/openhab/openhab-addons/commit/2dc2f5aa22c2356b8ff56bf0218d5efabd811baf", "message": "Use warn instead of error level\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "e8dce54b71cf0a6d27376c6c9a1baf380316859c", "url": "https://github.com/openhab/openhab-addons/commit/e8dce54b71cf0a6d27376c6c9a1baf380316859c", "message": "Delay status change to UNKNOW\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "d15140f6d2c48c296677a279600ac2cc87d80e92", "url": "https://github.com/openhab/openhab-addons/commit/d15140f6d2c48c296677a279600ac2cc87d80e92", "message": "Activate thread daemon mode\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "9be4d8ebd01d89c7d014a2ff356088334ff4c582", "url": "https://github.com/openhab/openhab-addons/commit/9be4d8ebd01d89c7d014a2ff356088334ff4c582", "message": "Remove useless check\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "344a6d827bb326351420afebbaf5217c79daac89", "url": "https://github.com/openhab/openhab-addons/commit/344a6d827bb326351420afebbaf5217c79daac89", "message": "Fix logger message level\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "0091a515af6c1daa5ed862183a6206d8804866fb", "url": "https://github.com/openhab/openhab-addons/commit/0091a515af6c1daa5ed862183a6206d8804866fb", "message": "Reinterrupt thread when catching InterruptedException\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "5d38d1a3090c3f20931d87467108a9a42cf7de72", "url": "https://github.com/openhab/openhab-addons/commit/5d38d1a3090c3f20931d87467108a9a42cf7de72", "message": "Prevent shutdown of openhab scheduler\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "4fbb6a5d4ad855372a28c97fe78f68524dbd6fb2", "url": "https://github.com/openhab/openhab-addons/commit/4fbb6a5d4ad855372a28c97fe78f68524dbd6fb2", "message": "Fix microsecond suffix\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "9dfa133b817483c40f572c7d398c9c472e845e6f", "url": "https://github.com/openhab/openhab-addons/commit/9dfa133b817483c40f572c7d398c9c472e845e6f", "message": "Remove useless executor service creation\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "438e3a1932da7604822c9753e156dc60d7847ef6", "url": "https://github.com/openhab/openhab-addons/commit/438e3a1932da7604822c9753e156dc60d7847ef6", "message": "Log exception in debug mode instead of warn\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "32b809ec66fec2a043f2f1a99c83e1a2fbbd651e", "url": "https://github.com/openhab/openhab-addons/commit/32b809ec66fec2a043f2f1a99c83e1a2fbbd651e", "message": "Add microseconds suffix\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "ec2a577f810356be62093f72946b0d738855770e", "url": "https://github.com/openhab/openhab-addons/commit/ec2a577f810356be62093f72946b0d738855770e", "message": "Remove commented line\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "ec6ca01abe1a5a272eab40352e67dad531802b86", "url": "https://github.com/openhab/openhab-addons/commit/ec6ca01abe1a5a272eab40352e67dad531802b86", "message": "Add millisecond suffix\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:53Z", "type": "commit"}, {"oid": "b15847c63904df4d72e7ac44e68bfd31c2351966", "url": "https://github.com/openhab/openhab-addons/commit/b15847c63904df4d72e7ac44e68bfd31c2351966", "message": "Add receiver thread join delay\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:54Z", "type": "commit"}, {"oid": "7323b50cb2ce92bd2b40fcdcc9424c284212ce50", "url": "https://github.com/openhab/openhab-addons/commit/7323b50cb2ce92bd2b40fcdcc9424c284212ce50", "message": "Update pom.xml\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:54Z", "type": "commit"}, {"oid": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "url": "https://github.com/openhab/openhab-addons/commit/8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "message": "Update openhab version\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:42:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4OTMxMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480189311", "bodyText": "This looks like this could also be implemented by adding default methods to the TeleinfoReaderListener interface?", "author": "Hilbrand", "createdAt": "2020-08-31T15:00:18Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/TeleinfoReaderListenerAdaptor.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+\n+/**\n+ * The {@link TeleinfoReaderListenerAdaptor} class defines an adaptor at {@link TeleinfoReaderListener} interface.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public abstract class TeleinfoReaderListenerAdaptor implements TeleinfoReaderListener {", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5MDA2MA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480190060", "bodyText": "Can be removed as it's already on the super interface?", "author": "Hilbrand", "createdAt": "2020-08-31T15:01:25Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/TeleinfoReader.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+\n+/**\n+ * The {@link TeleinfoReader} interface defines a mechanism to read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public interface TeleinfoReader extends Closeable {\n+\n+    void open() throws IOException;\n+\n+    @Override\n+    void close() throws IOException;", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5NDIwNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480194205", "bodyText": "It is general suggested to store the configuration in a field. And only read it in initialize(). You can use a configuration data class and read it with getConfigAs() in initialize. If you would need different types of configuration you could add the class as generic to the class interface. Something like TeleinfoAbstractCbemmElectricityMeterHandler<MeterConfig>. At this moment it looks all devices have the same configuration parameters so no need to create different constants or classes than.", "author": "Hilbrand", "createdAt": "2020-08-31T15:08:12Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/cbemm/TeleinfoBaseCbemmElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler.cbemm;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.THING_BASE_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+\n+/**\n+ * The {@link TeleinfoBaseCbemmElectricityMeterHandler} class defines a handler for a BASE CBEMM Electricity Meters\n+ * thing.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ * @author Olivier MARCEAU - Change ADCO property to parameter\n+ */\n+@NonNullByDefault\n+public class TeleinfoBaseCbemmElectricityMeterHandler extends TeleinfoAbstractCbemmElectricityMeterHandler {\n+\n+    public TeleinfoBaseCbemmElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void onFrameReceived(TeleinfoAbstractControllerHandler controllerHandler, Frame frame) {\n+        final FrameCbemmBaseOption frameCbemmBaseOption = (FrameCbemmBaseOption) frame;\n+\n+        String adco = (String) getThing().getConfiguration().get(THING_BASE_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO);", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5NTkxNw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480195917", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!useOpenhabScheduler)\n          \n          \n            \n                        executorService.shutdownNow();\n          \n          \n            \n                    if (!useOpenhabScheduler) {\n          \n          \n            \n                        executorService.shutdownNow();\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nMaybe run mvn spotless:apply?", "author": "Hilbrand", "createdAt": "2020-08-31T15:10:56Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,689 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.dto.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.dto.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConversionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static final long DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US = 33400;\n+    public static final long DEFAULT_TIMEOUT_READING_FRAME_US = 33400;\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader;\n+    private @Nullable String groupLine;\n+    private ExecutorService executorService;\n+    private long waitNextHeaderFrameTimeoutInUs;\n+    private long readingFrameTimeoutInUs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+    private boolean useOpenhabScheduler;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US, DEFAULT_TIMEOUT_READING_FRAME_US, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US, DEFAULT_TIMEOUT_READING_FRAME_US,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInUs,\n+            long readingFrameTimeoutInUs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;\n+        this.readingFrameTimeoutInUs = readingFrameTimeoutInUs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n+        this.executorService = Executors.newFixedThreadPool(2);\n+        this.useOpenhabScheduler = false;\n+\n+        groupLine = null;\n+    }\n+\n+    public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInUs,\n+            long readingFrameTimeoutInUs, boolean autoRepairInvalidADPSgroupLine, ExecutorService executorService) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;\n+        this.readingFrameTimeoutInUs = readingFrameTimeoutInUs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+        this.executorService = executorService;\n+        this.useOpenhabScheduler = true;\n+\n+        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n+\n+        groupLine = null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        logger.debug(\"close() [start]\");\n+        bufferedReader.close();\n+        if (!useOpenhabScheduler)\n+            executorService.shutdownNow();", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5NzUzMw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480197533", "bodyText": "Can you give the thread a name similar to:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    super(\"TeleinfoReceiveThread\");\n          \n          \n            \n                    super(\"OH-binding-TeleinfoReceiveThread\");\n          \n      \n    \n    \n  \n\nAnd preferable also add the thing UID if multiple instances of this class would be running it would be possible to see to which thing this thread is associated.", "author": "Hilbrand", "createdAt": "2020-08-31T15:13:31Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoReceiveThread.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoReceiveThread} class defines a thread to decode and fire Teleinfo frames for Serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoReceiveThread extends Thread {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoReceiveThread.class);\n+\n+    private SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThreadListener listener;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+    private ExecutorService executorService;\n+\n+    public TeleinfoReceiveThread(SerialPort serialPort, final TeleinfoReceiveThreadListener listener,\n+            boolean autoRepairInvalidADPSgroupLine, ExecutorService scheduler) {\n+        super(\"TeleinfoReceiveThread\");", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5Nzg0OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480197849", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.error(\"An error occurred during serial port input stream opening\", e);\n          \n          \n            \n                        logger.warn(\"An error occurred during serial port input stream opening\", e);", "author": "Hilbrand", "createdAt": "2020-08-31T15:14:03Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoReceiveThread.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoReceiveThread} class defines a thread to decode and fire Teleinfo frames for Serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoReceiveThread extends Thread {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoReceiveThread.class);\n+\n+    private SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThreadListener listener;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+    private ExecutorService executorService;\n+\n+    public TeleinfoReceiveThread(SerialPort serialPort, final TeleinfoReceiveThreadListener listener,\n+            boolean autoRepairInvalidADPSgroupLine, ExecutorService scheduler) {\n+        super(\"TeleinfoReceiveThread\");\n+        setDaemon(true);\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+        this.executorService = scheduler;\n+    }\n+\n+    @Override\n+    public void run() {\n+        try (TeleinfoInputStream teleinfoStream = new TeleinfoInputStream(serialPort.getInputStream(),\n+                TeleinfoInputStream.DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US * 100,\n+                TeleinfoInputStream.DEFAULT_TIMEOUT_READING_FRAME_US * 100, autoRepairInvalidADPSgroupLine,\n+                executorService)) {\n+            while (!interrupted()) {\n+                TeleinfoReceiveThreadListener listener = this.listener;\n+                if (listener != null) {\n+                    try {\n+                        Frame nextFrame = teleinfoStream.readNextFrame();\n+                        if (nextFrame != null)\n+                            listener.onFrameReceived(this, nextFrame);\n+                    } catch (InvalidFrameException e) {\n+                        logger.warn(\"Got invalid frame. Detail: \\\"{}\\\"\", e.getLocalizedMessage());\n+                        listener.onInvalidFrameReceived(this, e);\n+                    } catch (TimeoutException e) {\n+                        logger.warn(\"Got timeout during frame reading\", e);\n+                        if (!listener.continueOnReadNextFrameTimeoutException(this, e)) {\n+                            break;\n+                        }\n+                    } catch (IOException e) {\n+                        logger.warn(\"Got I/O exception. Detail: \\\"{}\\\"\", e.getLocalizedMessage(), e);\n+                        listener.onSerialPortInputStreamIOException(this, e);\n+                        break;\n+                    } catch (Exception e) {\n+                        logger.warn(\"Got exception\", e);\n+                    }\n+                }\n+            }\n+        } catch (IOException e) {\n+            logger.error(\"An error occurred during serial port input stream opening\", e);", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5ODU3NA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480198574", "bodyText": "Is someone throwing an Exception or is the a general catch? otherwise change to RuntimException or the specific exceptions.", "author": "Hilbrand", "createdAt": "2020-08-31T15:15:06Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoReceiveThread.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoReceiveThread} class defines a thread to decode and fire Teleinfo frames for Serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoReceiveThread extends Thread {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoReceiveThread.class);\n+\n+    private SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThreadListener listener;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+    private ExecutorService executorService;\n+\n+    public TeleinfoReceiveThread(SerialPort serialPort, final TeleinfoReceiveThreadListener listener,\n+            boolean autoRepairInvalidADPSgroupLine, ExecutorService scheduler) {\n+        super(\"TeleinfoReceiveThread\");\n+        setDaemon(true);\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+        this.executorService = scheduler;\n+    }\n+\n+    @Override\n+    public void run() {\n+        try (TeleinfoInputStream teleinfoStream = new TeleinfoInputStream(serialPort.getInputStream(),\n+                TeleinfoInputStream.DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US * 100,\n+                TeleinfoInputStream.DEFAULT_TIMEOUT_READING_FRAME_US * 100, autoRepairInvalidADPSgroupLine,\n+                executorService)) {\n+            while (!interrupted()) {\n+                TeleinfoReceiveThreadListener listener = this.listener;\n+                if (listener != null) {\n+                    try {\n+                        Frame nextFrame = teleinfoStream.readNextFrame();\n+                        if (nextFrame != null)\n+                            listener.onFrameReceived(this, nextFrame);\n+                    } catch (InvalidFrameException e) {\n+                        logger.warn(\"Got invalid frame. Detail: \\\"{}\\\"\", e.getLocalizedMessage());\n+                        listener.onInvalidFrameReceived(this, e);\n+                    } catch (TimeoutException e) {\n+                        logger.warn(\"Got timeout during frame reading\", e);\n+                        if (!listener.continueOnReadNextFrameTimeoutException(this, e)) {\n+                            break;\n+                        }\n+                    } catch (IOException e) {\n+                        logger.warn(\"Got I/O exception. Detail: \\\"{}\\\"\", e.getLocalizedMessage(), e);\n+                        listener.onSerialPortInputStreamIOException(this, e);\n+                        break;\n+                    } catch (Exception e) {", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMzM0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480203347", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInUs,\n          \n          \n            \n                        long readingFrameTimeoutInUs, boolean autoRepairInvalidADPSgroupLine) {\n          \n          \n            \n                    if (teleinfoInputStream == null) {\n          \n          \n            \n                        throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;\n          \n          \n            \n                    this.readingFrameTimeoutInUs = readingFrameTimeoutInUs;\n          \n          \n            \n                    this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n          \n          \n            \n            \n          \n          \n            \n                    this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n          \n          \n            \n                    this.executorService = Executors.newFixedThreadPool(2);\n          \n          \n            \n                    this.useOpenhabScheduler = false;\n          \n          \n            \n            \n          \n          \n            \n                    groupLine = null;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInUs,\n          \n          \n            \n                        long readingFrameTimeoutInUs, boolean autoRepairInvalidADPSgroupLine, ExecutorService executorService) {\n          \n          \n            \n                    if (teleinfoInputStream == null) {\n          \n          \n            \n                        throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;\n          \n          \n            \n                    this.readingFrameTimeoutInUs = readingFrameTimeoutInUs;\n          \n          \n            \n                    this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n          \n          \n            \n                    this.executorService = executorService;\n          \n          \n            \n                    this.useOpenhabScheduler = true;\n          \n          \n            \n            \n          \n          \n            \n                    this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n          \n          \n            \n            \n          \n          \n            \n                    groupLine = null;\n          \n          \n            \n                }\n          \n          \n            \n                public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInUs,\n          \n          \n            \n                        long readingFrameTimeoutInUs, boolean autoRepairInvalidADPSgroupLine) {\n          \n          \n            \n                    this(teleinfoInputStream, waitNextHeaderFrameTimeoutInUs, readingFrameTimeoutInUs, autoRepairInvalidADPSgroupLine, null);\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInUs,\n          \n          \n            \n                        long readingFrameTimeoutInUs, boolean autoRepairInvalidADPSgroupLine, @Nullable ExecutorService executorService) {\n          \n          \n            \n                    if (teleinfoInputStream == null) {\n          \n          \n            \n                        throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;\n          \n          \n            \n                    this.readingFrameTimeoutInUs = readingFrameTimeoutInUs;\n          \n          \n            \n                    this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n          \n          \n            \n                    if (executorService == null) {\n          \n          \n            \n                        this.executorService = Executors.newFixedThreadPool(2);\n          \n          \n            \n                        this.useOwnScheduler = true;\n          \n          \n            \n                    } else {\n          \n          \n            \n                        this.executorService = executorService;\n          \n          \n            \n                        this.useOwnScheduler = false;\n          \n          \n            \n                   }\n          \n          \n            \n            \n          \n          \n            \n                    this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n          \n          \n            \n            \n          \n          \n            \n                    groupLine = null;\n          \n          \n            \n                }", "author": "Hilbrand", "createdAt": "2020-08-31T15:22:48Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,689 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.dto.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.dto.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConversionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static final long DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US = 33400;\n+    public static final long DEFAULT_TIMEOUT_READING_FRAME_US = 33400;\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader;\n+    private @Nullable String groupLine;\n+    private ExecutorService executorService;\n+    private long waitNextHeaderFrameTimeoutInUs;\n+    private long readingFrameTimeoutInUs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+    private boolean useOpenhabScheduler;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US, DEFAULT_TIMEOUT_READING_FRAME_US, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US, DEFAULT_TIMEOUT_READING_FRAME_US,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInUs,\n+            long readingFrameTimeoutInUs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;\n+        this.readingFrameTimeoutInUs = readingFrameTimeoutInUs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n+        this.executorService = Executors.newFixedThreadPool(2);\n+        this.useOpenhabScheduler = false;\n+\n+        groupLine = null;\n+    }\n+\n+    public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInUs,\n+            long readingFrameTimeoutInUs, boolean autoRepairInvalidADPSgroupLine, ExecutorService executorService) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;\n+        this.readingFrameTimeoutInUs = readingFrameTimeoutInUs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+        this.executorService = executorService;\n+        this.useOpenhabScheduler = true;\n+\n+        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n+\n+        groupLine = null;\n+    }", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkwMTU2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480901563", "bodyText": "I would move this sleep to the reader thread since a sleep should never be done in a scheduled task on the openHAB scheduler. To make sure it's clear this sleep is not associated with this class.", "author": "Hilbrand", "createdAt": "2020-09-01T07:08:08Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT_MS = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+    private static final int RECEIVER_THREAD_JOIN_DELAY_MS = 500;\n+\n+    private SerialPortManager serialPortManager;\n+    private @Nullable SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThread receiveThread;\n+    private @Nullable ScheduledFuture<?> keepAliveThread;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        invalidFrameCounter = 0;\n+\n+        keepAliveThread = scheduler.scheduleWithFixedDelay(() -> {\n+            if (!isInitialized()) {\n+                openSerialPortAndStartReceiving();\n+                updateStatus(ThingStatus.UNKNOWN);\n+            }\n+            logger.debug(\"Check Teleinfo receiveThread status...\");\n+            logger.debug(\"isInitialized() = {}\", isInitialized());\n+            TeleinfoReceiveThread receiveThreadRef = receiveThread;\n+            if (receiveThreadRef != null) {\n+                logger.debug(\"receiveThread.isAlive() = {}\", receiveThreadRef.isAlive());\n+            }\n+            if (isInitialized() && (receiveThreadRef == null || !receiveThreadRef.isAlive())) {\n+                updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                logger.info(\"Try to restart Teleinfo receiving...\");\n+                stopReceivingAndCloseSerialPort();\n+                openSerialPortAndStartReceiving();\n+            }\n+        }, 0, 60, TimeUnit.SECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        ScheduledFuture<?> keepAliveThreadRef = keepAliveThread;\n+        if (keepAliveThreadRef != null) {\n+            keepAliveThreadRef.cancel(true);\n+            keepAliveThread = null;\n+        }\n+        stopReceivingAndCloseSerialPort();\n+\n+        super.dispose();\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void onFrameReceived(TeleinfoReceiveThread receiveThread, Frame frame) {\n+        updateStatus(ThingStatus.ONLINE);\n+        fireOnFrameReceivedEvent(frame);\n+    }\n+\n+    @Override\n+    public void onInvalidFrameReceived(TeleinfoReceiveThread receiveThread, InvalidFrameException error) {\n+        invalidFrameCounter++;\n+        updateState(THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER, new DecimalType(invalidFrameCounter));\n+    }\n+\n+    @Override\n+    public void onSerialPortInputStreamIOException(TeleinfoReceiveThread receiveThread, IOException e) {\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+    }\n+\n+    @Override\n+    public boolean continueOnReadNextFrameTimeoutException(TeleinfoReceiveThread receiveThread, TimeoutException e) {\n+        logger.warn(\"Retry in progress. Next retry in {} seconds...\", SERIAL_PORT_DELAY_RETRY_IN_SECONDS);\n+        updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+        try {\n+            Thread.sleep(SERIAL_PORT_DELAY_RETRY_IN_SECONDS * 1000);\n+            return true;\n+        } catch (InterruptedException e1) {\n+            return false;\n+        }", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkwMzYyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r480903629", "bodyText": "Please implement the registration of the discovery service as a ThingHandlerService. I've a pr on the documentation that explains how to implement it. This is a link to the preview documentation: https://deploy-preview-1262--openhab-docs-preview.netlify.app/docs/developer/bindings/#discovery-that-is-bound-to-a-thing", "author": "Hilbrand", "createdAt": "2020-09-01T07:10:49Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoThingHandlerFactory.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Hashtable;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.config.discovery.DiscoveryService;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.teleinfo.internal.TeleinfoDiscoveryService;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoBaseCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoEjpCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoHcCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoTempoCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoBaseCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoEjpCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoHcCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoTempoCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoBaseCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoEjpCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoHcCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoTempoCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.serial.TeleinfoSerialControllerHandler;\n+import org.osgi.framework.ServiceRegistration;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+/**\n+ * The {@link TeleinfoThingHandlerFactory} is responsible for creating things and thing\n+ * handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+@Component(configurationPid = \"binding.teleinfo\", service = ThingHandlerFactory.class)\n+public class TeleinfoThingHandlerFactory extends BaseThingHandlerFactory {\n+\n+    private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Stream.of(THING_TYPE_SERIAL_CONTROLLER,\n+            THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID)\n+            .collect(Collectors.toSet());\n+\n+    private @NonNullByDefault({}) SerialPortManager serialPortManager;\n+    private Map<ThingUID, ServiceRegistration<?>> discoveryServiceRegs = new HashMap<>();\n+\n+    @Override\n+    public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n+        return SUPPORTED_THING_TYPES_UIDS.contains(thingTypeUID);\n+    }\n+\n+    @Reference\n+    protected void setSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    protected void unsetSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = null;\n+    }\n+\n+    @Override\n+    protected @Nullable ThingHandler createHandler(Thing thing) {\n+        TeleinfoAbstractControllerHandler controller = null;\n+        ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n+\n+        if (THING_TYPE_SERIAL_CONTROLLER.equals(thingTypeUID)) {\n+            controller = new TeleinfoSerialControllerHandler((Bridge) thing, serialPortManager);\n+\n+            TeleinfoDiscoveryService discoveryService = new TeleinfoDiscoveryService(controller, 60);", "originalCommit": "8095684a2036e2fad2bd784d4f778b3a7e4e68ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyOTY0OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r483829649", "bodyText": "@Hilbrand I'm trying to follow the documentation, but the bridge handler is still null when startScan is called. Do I miss something? Have you a working example?\nedit: it seems that the discovery service instance launched by paper ui is not the instance where the bridge handler is set...", "author": "olivierkeke", "createdAt": "2020-09-04T20:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkwMzYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2OTcxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r483869713", "bodyText": "You need to have the 2 interfaces added to the discovery service class as shown in the tutorial.", "author": "Hilbrand", "createdAt": "2020-09-04T22:35:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkwMzYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkyMzQ4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r483923486", "bodyText": "You're right! I forgot to implement DiscoverService.", "author": "olivierkeke", "createdAt": "2020-09-05T07:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkwMzYyOQ=="}], "type": "inlineReview"}, {"oid": "eeda197152553ec369c6cf7fa0cd8a498f1c3ea4", "url": "https://github.com/openhab/openhab-addons/commit/eeda197152553ec369c6cf7fa0cd8a498f1c3ea4", "message": "Improve syntax\n\nCo-authored-by: Hilbrand Bouwkamp <hilbrand@h72.nl>\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T12:12:18Z", "type": "commit"}, {"oid": "4d02251ce94261971fe362e293f204c4817b803f", "url": "https://github.com/openhab/openhab-addons/commit/4d02251ce94261971fe362e293f204c4817b803f", "message": "Reduce log level\n\nCo-authored-by: Hilbrand Bouwkamp <hilbrand@h72.nl>\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T12:12:18Z", "type": "commit"}, {"oid": "8f96bb87cc5b1f4f9426346aed0dedb778eb8df0", "url": "https://github.com/openhab/openhab-addons/commit/8f96bb87cc5b1f4f9426346aed0dedb778eb8df0", "message": "Remove code duplication\n\nCo-authored-by: Hilbrand Bouwkamp <hilbrand@h72.nl>\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T12:12:18Z", "type": "commit"}, {"oid": "f0d347a5122943de89f69c4d702502e863474b67", "url": "https://github.com/openhab/openhab-addons/commit/f0d347a5122943de89f69c4d702502e863474b67", "message": "Clarify property name\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T12:30:42Z", "type": "commit"}, {"oid": "e86810e5c44e52cdd2fb27867e355b3423e5e332", "url": "https://github.com/openhab/openhab-addons/commit/e86810e5c44e52cdd2fb27867e355b3423e5e332", "message": "Remove useless adaptator class\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T12:41:23Z", "type": "commit"}, {"oid": "e97c096df60d5e62f6e6a4cca320765910714bbe", "url": "https://github.com/openhab/openhab-addons/commit/e97c096df60d5e62f6e6a4cca320765910714bbe", "message": "Remove useless override method\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T12:46:57Z", "type": "commit"}, {"oid": "f1aa72bfcb53ba46df2e1c3fcc632572fddb41de", "url": "https://github.com/openhab/openhab-addons/commit/f1aa72bfcb53ba46df2e1c3fcc632572fddb41de", "message": "Use data class to store thing configuration\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T20:02:18Z", "type": "commit"}, {"oid": "89c3312d73701981a7b0a5f8d4cae7989581aa57", "url": "https://github.com/openhab/openhab-addons/commit/89c3312d73701981a7b0a5f8d4cae7989581aa57", "message": "Clarify receiver thread name\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T20:52:55Z", "type": "commit"}, {"oid": "9aa367261bb38551d0a0605c7cbae3e546328fc9", "url": "https://github.com/openhab/openhab-addons/commit/9aa367261bb38551d0a0605c7cbae3e546328fc9", "message": "Fix style warning\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T20:53:29Z", "type": "commit"}, {"oid": "f618a4cccaeb2b2fc16885653d4f44a033126eb4", "url": "https://github.com/openhab/openhab-addons/commit/f618a4cccaeb2b2fc16885653d4f44a033126eb4", "message": "Make DiscoveryService implement ThingHandlerService\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-01T20:55:25Z", "type": "commit"}, {"oid": "929433f6fa5fbb4b651ce17581616754a3fe707d", "url": "https://github.com/openhab/openhab-addons/commit/929433f6fa5fbb4b651ce17581616754a3fe707d", "message": "Use specific Exception type\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-03T19:55:45Z", "type": "commit"}, {"oid": "b0d61622df3eb5fd658a95f3f156e9446bc2cdb7", "url": "https://github.com/openhab/openhab-addons/commit/b0d61622df3eb5fd658a95f3f156e9446bc2cdb7", "message": "Move spleep in reader thread\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-03T20:08:32Z", "type": "commit"}, {"oid": "415f354b15ae61eb05629145bdc1f315b5a7b82f", "url": "https://github.com/openhab/openhab-addons/commit/415f354b15ae61eb05629145bdc1f315b5a7b82f", "message": "Register discovery service\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-05T07:38:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEwMzU1OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r484103558", "bodyText": "This whole method can be removed here as the unregistering of the discovery sevice is handled by the ThingHandlerService now", "author": "Hilbrand", "createdAt": "2020-09-06T19:03:21Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoThingHandlerFactory.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.teleinfo.internal.TeleinfoDiscoveryService;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoBaseCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoEjpCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoHcCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoTempoCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoBaseCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoEjpCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoHcCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoTempoCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoBaseCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoEjpCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoHcCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoTempoCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.serial.TeleinfoSerialControllerHandler;\n+import org.osgi.framework.ServiceRegistration;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+/**\n+ * The {@link TeleinfoThingHandlerFactory} is responsible for creating things and thing\n+ * handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+@Component(configurationPid = \"binding.teleinfo\", service = ThingHandlerFactory.class)\n+public class TeleinfoThingHandlerFactory extends BaseThingHandlerFactory {\n+\n+    private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Stream.of(THING_TYPE_SERIAL_CONTROLLER,\n+            THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID)\n+            .collect(Collectors.toSet());\n+\n+    private @NonNullByDefault({}) SerialPortManager serialPortManager;\n+    private Map<ThingUID, ServiceRegistration<?>> discoveryServiceRegs = new HashMap<>();\n+\n+    @Override\n+    public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n+        return SUPPORTED_THING_TYPES_UIDS.contains(thingTypeUID);\n+    }\n+\n+    @Reference\n+    protected void setSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    protected void unsetSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = null;\n+    }\n+\n+    @Override\n+    protected @Nullable ThingHandler createHandler(Thing thing) {\n+        ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n+\n+        if (THING_TYPE_SERIAL_CONTROLLER.equals(thingTypeUID)) {\n+            return new TeleinfoSerialControllerHandler((Bridge) thing, serialPortManager);\n+        }\n+\n+        if (THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoBaseCbemmElectricityMeterHandler(thing);\n+        } else if (THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoHcCbemmElectricityMeterHandler(thing);\n+        } else if (THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoTempoCbemmElectricityMeterHandler(thing);\n+        } else if (THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoEjpCbemmElectricityMeterHandler(thing);\n+        } else if (THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoBaseCbemmEvoIccElectricityMeterHandler(thing);\n+        } else if (THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoHcCbemmEvoIccElectricityMeterHandler(thing);\n+        } else if (THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoTempoCbemmEvoIccElectricityMeterHandler(thing);\n+        } else if (THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoEjpCbemmEvoIccElectricityMeterHandler(thing);\n+        } else if (THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoBaseCbetmLongElectricityMeterHandler(thing);\n+        } else if (THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoHcCbetmLongElectricityMeterHandler(thing);\n+        } else if (THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoTempoCbetmLongElectricityMeterHandler(thing);\n+        } else if (THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoEjpCbetmLongElectricityMeterHandler(thing);\n+        } else {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + thing.getThingTypeUID());\n+        }\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"null\")\n+    protected synchronized void removeHandler(ThingHandler thingHandler) {", "originalCommit": "415f354b15ae61eb05629145bdc1f315b5a7b82f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEwMzU4MA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r484103580", "bodyText": "This can also be removed. See other comment.", "author": "Hilbrand", "createdAt": "2020-09-06T19:03:41Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoThingHandlerFactory.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.teleinfo.internal.TeleinfoDiscoveryService;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoBaseCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoEjpCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoHcCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoTempoCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoBaseCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoEjpCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoHcCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoTempoCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoBaseCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoEjpCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoHcCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoTempoCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.serial.TeleinfoSerialControllerHandler;\n+import org.osgi.framework.ServiceRegistration;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+/**\n+ * The {@link TeleinfoThingHandlerFactory} is responsible for creating things and thing\n+ * handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+@Component(configurationPid = \"binding.teleinfo\", service = ThingHandlerFactory.class)\n+public class TeleinfoThingHandlerFactory extends BaseThingHandlerFactory {\n+\n+    private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Stream.of(THING_TYPE_SERIAL_CONTROLLER,\n+            THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID)\n+            .collect(Collectors.toSet());\n+\n+    private @NonNullByDefault({}) SerialPortManager serialPortManager;\n+    private Map<ThingUID, ServiceRegistration<?>> discoveryServiceRegs = new HashMap<>();", "originalCommit": "415f354b15ae61eb05629145bdc1f315b5a7b82f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEwMzc3NA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r484103774", "bodyText": "One more comment (since you need to modify this file for the other comment). Can you inject the SerialPortManager in the constuctor. The the field can be final and you can remove the set and unset methods::\n@Ativate`\npublic TeleinfoThingHandlerFactory(@Reference SerialPortManager serialPortManager) {\n...", "author": "Hilbrand", "createdAt": "2020-09-06T19:05:55Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoThingHandlerFactory.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.teleinfo.internal.TeleinfoDiscoveryService;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoBaseCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoEjpCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoHcCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoTempoCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoBaseCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoEjpCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoHcCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoTempoCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoBaseCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoEjpCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoHcCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoTempoCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.serial.TeleinfoSerialControllerHandler;\n+import org.osgi.framework.ServiceRegistration;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+/**\n+ * The {@link TeleinfoThingHandlerFactory} is responsible for creating things and thing\n+ * handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+@Component(configurationPid = \"binding.teleinfo\", service = ThingHandlerFactory.class)\n+public class TeleinfoThingHandlerFactory extends BaseThingHandlerFactory {\n+\n+    private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Stream.of(THING_TYPE_SERIAL_CONTROLLER,\n+            THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID)\n+            .collect(Collectors.toSet());\n+\n+    private @NonNullByDefault({}) SerialPortManager serialPortManager;", "originalCommit": "415f354b15ae61eb05629145bdc1f315b5a7b82f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f658134e2157631d65d5ac2ee8d513643aa0c909", "url": "https://github.com/openhab/openhab-addons/commit/f658134e2157631d65d5ac2ee8d513643aa0c909", "message": "Remove useless discovery service unregistration\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-06T20:03:44Z", "type": "commit"}, {"oid": "f6f251f50225c9b76beeefe197a8fb28d9b7ddbb", "url": "https://github.com/openhab/openhab-addons/commit/f6f251f50225c9b76beeefe197a8fb28d9b7ddbb", "message": "Inject serial port manager in discovery constructor\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-09-06T20:12:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NTA0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441055041", "bodyText": "Can this be removed?", "author": "fwolter", "createdAt": "2020-06-16T18:22:46Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoBindingConstants.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+\n+/**\n+ * The {@link TeleinfoBindingConstants} class defines common constants, which are\n+ * used across the whole binding.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoBindingConstants {\n+\n+    private static final String BINDING_ID = \"teleinfo\";\n+\n+    // List of all Thing Type UIDs\n+    public static final ThingTypeUID THING_TYPE_SERIAL_CONTROLLER = new ThingTypeUID(BINDING_ID, \"serialcontroller\");\n+    public static final String THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER = \"invalidFrameCounter\";\n+    // public static final ThingTypeUID THING_TYPE_REMOTE_IP = new ThingTypeUID(BINDING_ID, \"remoteip\");", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MTk1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441791953", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T19:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NTA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NjEzNw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441056137", "bodyText": "Can this be removed?", "author": "fwolter", "createdAt": "2020-06-16T18:24:25Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MjYxMA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441792610", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T19:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NjEzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1Njk0OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441056948", "bodyText": "Can these messages be replaced by using the debugger or by increasing the framework's log level? See point 4 https://www.openhab.org/docs/developer/guidelines.html#f-logging", "author": "fwolter", "createdAt": "2020-06-16T18:25:47Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgwMjA4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441802085", "bodyText": "TeleinfoDiscoveryService service is actived on demand by the binding, not by the framework. In fact, the discovery service is enabled only if the user has added a Teleinfo Serial Controller thing.\nThis debug messages can help to log this dynamic activation.\nNo?", "author": "nokyyz", "createdAt": "2020-06-17T20:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1Njk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxMDA1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441810053", "bodyText": "Yes, you're right.", "author": "fwolter", "createdAt": "2020-06-17T20:21:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1Njk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NzQ0NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441057445", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (frameSample instanceof FrameAdco == false) {\n          \n          \n            \n                    if (!(frameSample instanceof FrameAdco)) {", "author": "fwolter", "createdAt": "2020-06-16T18:26:39Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        logger.debug(\"Teleinfo discovery: Start {}\", controllerHandler.getThing().getUID());\n+\n+        // Start the search for new devices\n+        controllerHandler.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        logger.debug(\"Teleinfo discovery: Abort {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        logger.debug(\"Teleinfo discovery: Stop {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        detectNewElectricityMeterFromReceivedFrame(frame);\n+    }\n+\n+    private void detectNewElectricityMeterFromReceivedFrame(final Frame frameSample) {\n+        logger.debug(\"New eletricity meter detection from frame {}\", frameSample.getId());\n+        if (frameSample instanceof FrameAdco == false) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgwNTI1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441805252", "bodyText": "Personally, I prefer to see == false that an discrete ! but everyone's taste is different :-)", "author": "nokyyz", "createdAt": "2020-06-17T20:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NzQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1OTE4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441059185", "bodyText": "The representation property must be the name of the property you want to use as representative, not the value.", "author": "fwolter", "createdAt": "2020-06-16T18:29:44Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        logger.debug(\"Teleinfo discovery: Start {}\", controllerHandler.getThing().getUID());\n+\n+        // Start the search for new devices\n+        controllerHandler.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        logger.debug(\"Teleinfo discovery: Abort {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        logger.debug(\"Teleinfo discovery: Stop {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        detectNewElectricityMeterFromReceivedFrame(frame);\n+    }\n+\n+    private void detectNewElectricityMeterFromReceivedFrame(final Frame frameSample) {\n+        logger.debug(\"New eletricity meter detection from frame {}\", frameSample.getId());\n+        if (frameSample instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + frameSample.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) frameSample;\n+\n+        ThingUID thingUID = getThingUID(frameAdco);\n+\n+        final Map<String, Object> properties = getThingProperties(thingUID.getThingTypeUID(), frameAdco);\n+        final String representationProperty = getRepresentationProperty(thingUID.getThingTypeUID(), frameAdco);\n+        DiscoveryResult discoveryResult = DiscoveryResultBuilder.create(thingUID).withProperties(properties)\n+                .withLabel(\"Teleinfo ADCO \" + frameAdco.getAdco()).withThingType(getThingTypeUID(frameAdco))\n+                .withBridge(controllerHandler.getThing().getUID()).withRepresentationProperty(representationProperty)", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1OTUzNw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441059537", "bodyText": "See above", "author": "fwolter", "createdAt": "2020-06-16T18:30:23Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        logger.debug(\"Teleinfo discovery: Start {}\", controllerHandler.getThing().getUID());\n+\n+        // Start the search for new devices\n+        controllerHandler.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        logger.debug(\"Teleinfo discovery: Abort {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        logger.debug(\"Teleinfo discovery: Stop {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        detectNewElectricityMeterFromReceivedFrame(frame);\n+    }\n+\n+    private void detectNewElectricityMeterFromReceivedFrame(final Frame frameSample) {\n+        logger.debug(\"New eletricity meter detection from frame {}\", frameSample.getId());\n+        if (frameSample instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + frameSample.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) frameSample;\n+\n+        ThingUID thingUID = getThingUID(frameAdco);\n+\n+        final Map<String, Object> properties = getThingProperties(thingUID.getThingTypeUID(), frameAdco);\n+        final String representationProperty = getRepresentationProperty(thingUID.getThingTypeUID(), frameAdco);\n+        DiscoveryResult discoveryResult = DiscoveryResultBuilder.create(thingUID).withProperties(properties)\n+                .withLabel(\"Teleinfo ADCO \" + frameAdco.getAdco()).withThingType(getThingTypeUID(frameAdco))\n+                .withBridge(controllerHandler.getThing().getUID()).withRepresentationProperty(representationProperty)\n+                .build();\n+\n+        thingDiscovered(discoveryResult);\n+    }\n+\n+    private ThingUID getThingUID(final Frame teleinfoFrame) {\n+        if (teleinfoFrame instanceof FrameAdco == false) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxMjY0NA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441812644", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T20:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1OTUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MDY3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441060673", "bodyText": "Is there a reason why you don't declare the argument as FrameAdco? Then, the type check and the cast would be obsolete.", "author": "fwolter", "createdAt": "2020-06-16T18:32:24Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        logger.debug(\"Teleinfo discovery: Start {}\", controllerHandler.getThing().getUID());\n+\n+        // Start the search for new devices\n+        controllerHandler.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        logger.debug(\"Teleinfo discovery: Abort {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        logger.debug(\"Teleinfo discovery: Stop {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        detectNewElectricityMeterFromReceivedFrame(frame);\n+    }\n+\n+    private void detectNewElectricityMeterFromReceivedFrame(final Frame frameSample) {\n+        logger.debug(\"New eletricity meter detection from frame {}\", frameSample.getId());\n+        if (frameSample instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + frameSample.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) frameSample;\n+\n+        ThingUID thingUID = getThingUID(frameAdco);\n+\n+        final Map<String, Object> properties = getThingProperties(thingUID.getThingTypeUID(), frameAdco);\n+        final String representationProperty = getRepresentationProperty(thingUID.getThingTypeUID(), frameAdco);\n+        DiscoveryResult discoveryResult = DiscoveryResultBuilder.create(thingUID).withProperties(properties)\n+                .withLabel(\"Teleinfo ADCO \" + frameAdco.getAdco()).withThingType(getThingTypeUID(frameAdco))\n+                .withBridge(controllerHandler.getThing().getUID()).withRepresentationProperty(representationProperty)\n+                .build();\n+\n+        thingDiscovered(discoveryResult);\n+    }\n+\n+    private ThingUID getThingUID(final Frame teleinfoFrame) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxOTU1NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441819555", "bodyText": "Actually, only ADCO frames are supported by the binding. The CJE, ICE2Q, ICE4Q and PMEPMI frames are not yot supported. These 4 frame types are not inherited from FrameAdco class.", "author": "nokyyz", "createdAt": "2020-06-17T20:37:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MDY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MjQ4MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441062481", "bodyText": "You could've used a Visitor to differentiate between the frames. But it's ok...", "author": "fwolter", "createdAt": "2020-06-16T18:35:26Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        logger.debug(\"Teleinfo discovery: Start {}\", controllerHandler.getThing().getUID());\n+\n+        // Start the search for new devices\n+        controllerHandler.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        logger.debug(\"Teleinfo discovery: Abort {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        logger.debug(\"Teleinfo discovery: Stop {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        detectNewElectricityMeterFromReceivedFrame(frame);\n+    }\n+\n+    private void detectNewElectricityMeterFromReceivedFrame(final Frame frameSample) {\n+        logger.debug(\"New eletricity meter detection from frame {}\", frameSample.getId());\n+        if (frameSample instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + frameSample.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) frameSample;\n+\n+        ThingUID thingUID = getThingUID(frameAdco);\n+\n+        final Map<String, Object> properties = getThingProperties(thingUID.getThingTypeUID(), frameAdco);\n+        final String representationProperty = getRepresentationProperty(thingUID.getThingTypeUID(), frameAdco);\n+        DiscoveryResult discoveryResult = DiscoveryResultBuilder.create(thingUID).withProperties(properties)\n+                .withLabel(\"Teleinfo ADCO \" + frameAdco.getAdco()).withThingType(getThingTypeUID(frameAdco))\n+                .withBridge(controllerHandler.getThing().getUID()).withRepresentationProperty(representationProperty)\n+                .build();\n+\n+        thingDiscovered(discoveryResult);\n+    }\n+\n+    private ThingUID getThingUID(final Frame teleinfoFrame) {\n+        if (teleinfoFrame instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + teleinfoFrame.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) teleinfoFrame;\n+\n+        return new ThingUID(getThingTypeUID(teleinfoFrame), frameAdco.getAdco(),\n+                controllerHandler.getThing().getUID().getId());\n+    }\n+\n+    private ThingTypeUID getThingTypeUID(final Frame teleinfoFrame) {\n+        if (teleinfoFrame instanceof FrameCbemmHcOption) {\n+            return THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmBaseOption) {\n+            return THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEjpOption) {\n+            return THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmTempoOption) {\n+            return THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccHcOption) {\n+            return THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccBaseOption) {\n+            return THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccEjpOption) {\n+            return THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccTempoOption) {\n+            return THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongHcOption) {\n+            return THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongBaseOption) {\n+            return THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongEjpOption) {\n+            return THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongTempoOption) {\n+            return THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + teleinfoFrame.getClass());\n+        }\n+    }", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NDYxMA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441064610", "bodyText": "If I see correctly it is always the string \"adco\" put as the property name. Are all these ifs necessary?", "author": "fwolter", "createdAt": "2020-06-16T18:39:05Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        logger.debug(\"Teleinfo discovery: Start {}\", controllerHandler.getThing().getUID());\n+\n+        // Start the search for new devices\n+        controllerHandler.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        logger.debug(\"Teleinfo discovery: Abort {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        logger.debug(\"Teleinfo discovery: Stop {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        detectNewElectricityMeterFromReceivedFrame(frame);\n+    }\n+\n+    private void detectNewElectricityMeterFromReceivedFrame(final Frame frameSample) {\n+        logger.debug(\"New eletricity meter detection from frame {}\", frameSample.getId());\n+        if (frameSample instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + frameSample.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) frameSample;\n+\n+        ThingUID thingUID = getThingUID(frameAdco);\n+\n+        final Map<String, Object> properties = getThingProperties(thingUID.getThingTypeUID(), frameAdco);\n+        final String representationProperty = getRepresentationProperty(thingUID.getThingTypeUID(), frameAdco);\n+        DiscoveryResult discoveryResult = DiscoveryResultBuilder.create(thingUID).withProperties(properties)\n+                .withLabel(\"Teleinfo ADCO \" + frameAdco.getAdco()).withThingType(getThingTypeUID(frameAdco))\n+                .withBridge(controllerHandler.getThing().getUID()).withRepresentationProperty(representationProperty)\n+                .build();\n+\n+        thingDiscovered(discoveryResult);\n+    }\n+\n+    private ThingUID getThingUID(final Frame teleinfoFrame) {\n+        if (teleinfoFrame instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + teleinfoFrame.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) teleinfoFrame;\n+\n+        return new ThingUID(getThingTypeUID(teleinfoFrame), frameAdco.getAdco(),\n+                controllerHandler.getThing().getUID().getId());\n+    }\n+\n+    private ThingTypeUID getThingTypeUID(final Frame teleinfoFrame) {\n+        if (teleinfoFrame instanceof FrameCbemmHcOption) {\n+            return THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmBaseOption) {\n+            return THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEjpOption) {\n+            return THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmTempoOption) {\n+            return THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccHcOption) {\n+            return THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccBaseOption) {\n+            return THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccEjpOption) {\n+            return THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccTempoOption) {\n+            return THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongHcOption) {\n+            return THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongBaseOption) {\n+            return THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongEjpOption) {\n+            return THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongTempoOption) {\n+            return THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + teleinfoFrame.getClass());\n+        }\n+    }\n+\n+    private Map<String, Object> getThingProperties(final ThingTypeUID thingTypeId, final Frame teleinfoFrame) {\n+        Map<String, Object> properties = new HashMap<String, Object>();\n+        if (teleinfoFrame instanceof FrameAdco) {\n+            final FrameAdco frameAdco = (FrameAdco) teleinfoFrame;\n+\n+            if (THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_BASE_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_HC_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_TEMPO_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_EJP_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_BASE_CBETM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_HC_CBETM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_TEMPO_CBETM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_EJP_CBETM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            }", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyNDA2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441824062", "bodyText": "In this case (all constants have \"adco\" string value) you are right. But this IF block allows to prevent the scability.", "author": "nokyyz", "createdAt": "2020-06-17T20:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NDYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2Njc3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441066775", "bodyText": "See above FrameAdco.", "author": "fwolter", "createdAt": "2020-06-16T18:43:01Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        logger.debug(\"Teleinfo discovery: Start {}\", controllerHandler.getThing().getUID());\n+\n+        // Start the search for new devices\n+        controllerHandler.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        logger.debug(\"Teleinfo discovery: Abort {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        logger.debug(\"Teleinfo discovery: Stop {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        detectNewElectricityMeterFromReceivedFrame(frame);\n+    }\n+\n+    private void detectNewElectricityMeterFromReceivedFrame(final Frame frameSample) {\n+        logger.debug(\"New eletricity meter detection from frame {}\", frameSample.getId());\n+        if (frameSample instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + frameSample.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) frameSample;\n+\n+        ThingUID thingUID = getThingUID(frameAdco);\n+\n+        final Map<String, Object> properties = getThingProperties(thingUID.getThingTypeUID(), frameAdco);\n+        final String representationProperty = getRepresentationProperty(thingUID.getThingTypeUID(), frameAdco);\n+        DiscoveryResult discoveryResult = DiscoveryResultBuilder.create(thingUID).withProperties(properties)\n+                .withLabel(\"Teleinfo ADCO \" + frameAdco.getAdco()).withThingType(getThingTypeUID(frameAdco))\n+                .withBridge(controllerHandler.getThing().getUID()).withRepresentationProperty(representationProperty)\n+                .build();\n+\n+        thingDiscovered(discoveryResult);\n+    }\n+\n+    private ThingUID getThingUID(final Frame teleinfoFrame) {\n+        if (teleinfoFrame instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + teleinfoFrame.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) teleinfoFrame;\n+\n+        return new ThingUID(getThingTypeUID(teleinfoFrame), frameAdco.getAdco(),\n+                controllerHandler.getThing().getUID().getId());\n+    }\n+\n+    private ThingTypeUID getThingTypeUID(final Frame teleinfoFrame) {\n+        if (teleinfoFrame instanceof FrameCbemmHcOption) {\n+            return THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmBaseOption) {\n+            return THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEjpOption) {\n+            return THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmTempoOption) {\n+            return THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccHcOption) {\n+            return THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccBaseOption) {\n+            return THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccEjpOption) {\n+            return THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbemmEvolutionIccTempoOption) {\n+            return THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongHcOption) {\n+            return THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongBaseOption) {\n+            return THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongEjpOption) {\n+            return THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else if (teleinfoFrame instanceof FrameCbetmLongTempoOption) {\n+            return THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID;\n+        } else {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + teleinfoFrame.getClass());\n+        }\n+    }\n+\n+    private Map<String, Object> getThingProperties(final ThingTypeUID thingTypeId, final Frame teleinfoFrame) {\n+        Map<String, Object> properties = new HashMap<String, Object>();\n+        if (teleinfoFrame instanceof FrameAdco) {\n+            final FrameAdco frameAdco = (FrameAdco) teleinfoFrame;\n+\n+            if (THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_BASE_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_HC_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_TEMPO_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_EJP_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_BASE_CBETM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_HC_CBETM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_TEMPO_CBETM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            } else if (THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thingTypeId)) {\n+                properties.put(THING_EJP_CBETM_ELECTRICITY_METER_PROPERTY_ADCO, frameAdco.getAdco());\n+            }\n+\n+            return properties;\n+        }\n+\n+        throw new IllegalStateException(\"Teleinfo frame type not supported: \" + teleinfoFrame.getClass());\n+    }\n+\n+    private String getRepresentationProperty(final ThingTypeUID thingTypeId, final Frame teleinfoFrame) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyNjM5Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441826392", "bodyText": "Actually, only ADCO frames are supported by the binding. The CJE, ICE2Q, ICE4Q and PMEPMI frames are not yot supported. These 4 frame types are not inherited from FrameAdco class.", "author": "nokyyz", "createdAt": "2020-06-17T20:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2Njc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2OTc4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441069789", "bodyText": "If I see correctly this list can be modified concurrently from different threads. You could make it synchronized:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private List<TeleinfoControllerHandlerListener> listeners = new ArrayList<>();\n          \n          \n            \n                private List<TeleinfoControllerHandlerListener> listeners = Collections.synchronizedList(new ArrayList<>());", "author": "fwolter", "createdAt": "2020-06-16T18:48:30Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoAbstractControllerHandler.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.binding.BaseBridgeHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+\n+/**\n+ * The {@link TeleinfoAbstractControllerHandler} class defines a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractControllerHandler extends BaseBridgeHandler {\n+\n+    private List<TeleinfoControllerHandlerListener> listeners = new ArrayList<>();", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyNjgwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441826806", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T20:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2OTc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MDU5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441070596", "bodyText": "Syntactical sugar:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (int i = 0; i < listeners.size(); i++) {\n          \n          \n            \n                        TeleinfoControllerHandlerListener listener = listeners.get(i);\n          \n          \n            \n                        listener.onFrameReceived(this, frame);\n          \n          \n            \n                    }\n          \n          \n            \n                    listeners.forEach(l -> l.onFrameReceived(this, frame));", "author": "fwolter", "createdAt": "2020-06-16T18:49:57Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoAbstractControllerHandler.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.binding.BaseBridgeHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+\n+/**\n+ * The {@link TeleinfoAbstractControllerHandler} class defines a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractControllerHandler extends BaseBridgeHandler {\n+\n+    private List<TeleinfoControllerHandlerListener> listeners = new ArrayList<>();\n+\n+    public TeleinfoAbstractControllerHandler(@NonNull Bridge bridge) {\n+        super(bridge);\n+    }\n+\n+    public void addListener(final TeleinfoControllerHandlerListener listener) {\n+        listeners.add(listener);\n+    }\n+\n+    public void removeListener(final TeleinfoControllerHandlerListener listener) {\n+        listeners.remove(listener);\n+    }\n+\n+    protected void fireOnFrameReceivedEvent(final Frame frame) {\n+        for (int i = 0; i < listeners.size(); i++) {\n+            TeleinfoControllerHandlerListener listener = listeners.get(i);\n+            listener.onFrameReceived(this, frame);\n+        }", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyNzI2OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441827268", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T20:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MDU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MTA2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441071067", "bodyText": "Can this message be replaced by using the debugger or by increasing the framework's log level?", "author": "fwolter", "createdAt": "2020-06-16T18:50:49Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoAbstractElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.StringType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoAbstractElectricityMeterHandler} class defines a skeleton for Electricity Meters handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractElectricityMeterHandler extends BaseThingHandler\n+        implements TeleinfoControllerHandlerListener {\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoAbstractElectricityMeterHandler.class);\n+\n+    public TeleinfoAbstractElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Electricity Meter thing handler {}.\", getThing().getUID());", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyOTI1OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441829258", "bodyText": "I don't know if the framework's log allows to log thing UID (?)", "author": "nokyyz", "createdAt": "2020-06-17T20:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MTA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE0OTU4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443149589", "bodyText": "Yes, it does:\n20:13:37.169 [ndlerExecutor-1] INFO  s.event.ThingStatusInfoChangedEvent:53 - 'lcn:module:b827ebfea4bb:17B4196847' changed from UNINITIALIZED (DISABLED) to INITIALIZING", "author": "fwolter", "createdAt": "2020-06-20T18:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MTA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MTQ0OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441071448", "bodyText": "See above", "author": "fwolter", "createdAt": "2020-06-16T18:51:29Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoAbstractElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.StringType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoAbstractElectricityMeterHandler} class defines a skeleton for Electricity Meters handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractElectricityMeterHandler extends BaseThingHandler\n+        implements TeleinfoControllerHandlerListener {\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoAbstractElectricityMeterHandler.class);\n+\n+    public TeleinfoAbstractElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Electricity Meter thing handler {}.\", getThing().getUID());\n+\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+\n+        Bridge bridge = getBridge();\n+        logger.debug(\"bridge = {}\", bridge);\n+        if (bridge != null) {\n+            bridgeStatusChanged(bridge.getStatusInfo());\n+        }\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"Controller status changed to {}.\", bridgeStatusInfo.getStatus());", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NDA0NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441074045", "bodyText": "See above and below.", "author": "fwolter", "createdAt": "2020-06-16T18:56:24Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoAbstractElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.StringType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoAbstractElectricityMeterHandler} class defines a skeleton for Electricity Meters handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractElectricityMeterHandler extends BaseThingHandler\n+        implements TeleinfoControllerHandlerListener {\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoAbstractElectricityMeterHandler.class);\n+\n+    public TeleinfoAbstractElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Electricity Meter thing handler {}.\", getThing().getUID());\n+\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+\n+        Bridge bridge = getBridge();\n+        logger.debug(\"bridge = {}\", bridge);\n+        if (bridge != null) {\n+            bridgeStatusChanged(bridge.getStatusInfo());\n+        }\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"Controller status changed to {}.\", bridgeStatusInfo.getStatus());\n+\n+        if (bridgeStatusInfo.getStatus() != ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+            logger.debug(\"Controller is not online ({})\", bridgeStatusInfo.getStatus());", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NjU5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441076596", "bodyText": "After the the thing status is set to unknown, the framework starts to work with this thing: handleCommand() and dispose() can be invoked (concurrently). In this case I would remove it, since the statements until the ONLINE are executing fast, so setting it to unknown won't have any reasonable effect.", "author": "fwolter", "createdAt": "2020-06-16T19:00:58Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoAbstractElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.StringType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoAbstractElectricityMeterHandler} class defines a skeleton for Electricity Meters handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractElectricityMeterHandler extends BaseThingHandler\n+        implements TeleinfoControllerHandlerListener {\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoAbstractElectricityMeterHandler.class);\n+\n+    public TeleinfoAbstractElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Electricity Meter thing handler {}.\", getThing().getUID());\n+\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+\n+        Bridge bridge = getBridge();\n+        logger.debug(\"bridge = {}\", bridge);\n+        if (bridge != null) {\n+            bridgeStatusChanged(bridge.getStatusInfo());\n+        }\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"Controller status changed to {}.\", bridgeStatusInfo.getStatus());\n+\n+        if (bridgeStatusInfo.getStatus() != ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+            logger.debug(\"Controller is not online ({})\", bridgeStatusInfo.getStatus());\n+            return;\n+        }\n+\n+        logger.debug(\"Controller is ONLINE. Starting Electricity Meter thing initialization\");\n+        updateStatus(ThingStatus.UNKNOWN);", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3ODA4MA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441078080", "bodyText": "getBridge() could return null. Same for getHandler().", "author": "fwolter", "createdAt": "2020-06-16T19:03:40Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoAbstractElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.StringType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoAbstractElectricityMeterHandler} class defines a skeleton for Electricity Meters handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractElectricityMeterHandler extends BaseThingHandler\n+        implements TeleinfoControllerHandlerListener {\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoAbstractElectricityMeterHandler.class);\n+\n+    public TeleinfoAbstractElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Electricity Meter thing handler {}.\", getThing().getUID());\n+\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+\n+        Bridge bridge = getBridge();\n+        logger.debug(\"bridge = {}\", bridge);\n+        if (bridge != null) {\n+            bridgeStatusChanged(bridge.getStatusInfo());\n+        }\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"Controller status changed to {}.\", bridgeStatusInfo.getStatus());\n+\n+        if (bridgeStatusInfo.getStatus() != ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+            logger.debug(\"Controller is not online ({})\", bridgeStatusInfo.getStatus());\n+            return;\n+        }\n+\n+        logger.debug(\"Controller is ONLINE. Starting Electricity Meter thing initialization\");\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        TeleinfoAbstractControllerHandler controllerHandler = (TeleinfoAbstractControllerHandler) getBridge()\n+                .getHandler();", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3ODM3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441078377", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (ThingStatus.ONLINE.equals(status) == false) {\n          \n          \n            \n                    if (!ThingStatus.ONLINE.equals(status)) {", "author": "fwolter", "createdAt": "2020-06-16T19:04:12Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoAbstractElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.StringType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoAbstractElectricityMeterHandler} class defines a skeleton for Electricity Meters handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractElectricityMeterHandler extends BaseThingHandler\n+        implements TeleinfoControllerHandlerListener {\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoAbstractElectricityMeterHandler.class);\n+\n+    public TeleinfoAbstractElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Electricity Meter thing handler {}.\", getThing().getUID());\n+\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+\n+        Bridge bridge = getBridge();\n+        logger.debug(\"bridge = {}\", bridge);\n+        if (bridge != null) {\n+            bridgeStatusChanged(bridge.getStatusInfo());\n+        }\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"Controller status changed to {}.\", bridgeStatusInfo.getStatus());\n+\n+        if (bridgeStatusInfo.getStatus() != ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, ERROR_OFFLINE_CONTROLLER_OFFLINE);\n+            logger.debug(\"Controller is not online ({})\", bridgeStatusInfo.getStatus());\n+            return;\n+        }\n+\n+        logger.debug(\"Controller is ONLINE. Starting Electricity Meter thing initialization\");\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        TeleinfoAbstractControllerHandler controllerHandler = (TeleinfoAbstractControllerHandler) getBridge()\n+                .getHandler();\n+        controllerHandler.addListener(this);\n+        logger.debug(\"Electricity Meter initialization complete.\");\n+        updateStatus(ThingStatus.ONLINE);\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+        // no commands supported\n+    }\n+\n+    protected void updateStatesForBaseFrameOption(@NonNull FrameBaseOption frameBaseOption) {\n+        updateState(CHANNEL_BASE_FRAME_BASE, new DecimalType(frameBaseOption.getBase()));\n+    }\n+\n+    protected void updateStatesForHcFrameOption(@NonNull FrameHcOption frameHcOption) {\n+        updateState(CHANNEL_HC_FRAME_HCHC, new DecimalType(frameHcOption.getHchc()));\n+        updateState(CHANNEL_HC_FRAME_HCHP, new DecimalType(frameHcOption.getHchp()));\n+        updateState(CHANNEL_HC_FRAME_HHPHC, new StringType(frameHcOption.getHhphc().name()));\n+    }\n+\n+    protected void updateStatesForTempoFrameOption(@NonNull FrameTempoOption frameTempoOption) {\n+        updateState(CHANNEL_TEMPO_FRAME_BBRHPJR, new DecimalType(frameTempoOption.getBbrhpjr()));\n+        updateState(CHANNEL_TEMPO_FRAME_BBRHCJR, new DecimalType(frameTempoOption.getBbrhcjr()));\n+        updateState(CHANNEL_TEMPO_FRAME_BBRHPJW, new DecimalType(frameTempoOption.getBbrhpjw()));\n+        updateState(CHANNEL_TEMPO_FRAME_BBRHCJW, new DecimalType(frameTempoOption.getBbrhcjw()));\n+        updateState(CHANNEL_TEMPO_FRAME_BBRHPJB, new DecimalType(frameTempoOption.getBbrhpjb()));\n+        updateState(CHANNEL_TEMPO_FRAME_BBRHCJB, new DecimalType(frameTempoOption.getBbrhcjb()));\n+        updateState(CHANNEL_TEMPO_FRAME_HHPHC, new StringType(frameTempoOption.getHhphc().name()));\n+        updateState(CHANNEL_TEMPO_FRAME_PROGRAMME_CIRCUIT_1,\n+                new StringType(frameTempoOption.getProgrammeCircuit1().name()));\n+        updateState(CHANNEL_TEMPO_FRAME_PROGRAMME_CIRCUIT_2,\n+                new StringType(frameTempoOption.getProgrammeCircuit2().name()));\n+\n+        if (frameTempoOption.getDemain() == null) {\n+            updateState(CHANNEL_TEMPO_FRAME_DEMAIN, UnDefType.NULL);\n+        } else {\n+            updateState(CHANNEL_TEMPO_FRAME_DEMAIN, new StringType(frameTempoOption.getDemain().name()));\n+        }\n+    }\n+\n+    protected void updateStatesForEjpFrameOption(@NonNull FrameEjpOption frameEjpOption) {\n+        updateState(CHANNEL_EJP_FRAME_EJPHN, new DecimalType(frameEjpOption.getEjphn()));\n+        updateState(CHANNEL_EJP_FRAME_EJPHPM, new DecimalType(frameEjpOption.getEjphpm()));\n+\n+        if (frameEjpOption.getPejp() == null) {\n+            updateState(CHANNEL_EJP_FRAME_PEJP, UnDefType.NULL);\n+        } else {\n+            updateState(CHANNEL_EJP_FRAME_PEJP, new DecimalType(frameEjpOption.getPejp()));\n+        }\n+    }\n+\n+    @Override\n+    protected void updateStatus(ThingStatus status, ThingStatusDetail statusDetail, @Nullable String description) {\n+        super.updateStatus(status, statusDetail, description);\n+\n+        if (ThingStatus.ONLINE.equals(status) == false) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzMjMxMA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441832310", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T21:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3ODM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MDYzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441080639", "bodyText": "You could combine the two ifs.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    if (controller != null) {", "author": "fwolter", "createdAt": "2020-06-16T19:08:23Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoThingHandlerFactory.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Hashtable;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.config.discovery.DiscoveryService;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.teleinfo.internal.TeleinfoDiscoveryService;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoBaseCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoEjpCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoHcCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoTempoCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoBaseCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoEjpCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoHcCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoTempoCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoBaseCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoEjpCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoHcCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoTempoCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.serial.TeleinfoSerialControllerHandler;\n+import org.osgi.framework.ServiceRegistration;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+/**\n+ * The {@link TeleinfoThingHandlerFactory} is responsible for creating things and thing\n+ * handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+@Component(configurationPid = \"binding.teleinfo\", service = ThingHandlerFactory.class)\n+public class TeleinfoThingHandlerFactory extends BaseThingHandlerFactory {\n+\n+    private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Stream.of(THING_TYPE_SERIAL_CONTROLLER,\n+            THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID)\n+            .collect(Collectors.toSet());\n+\n+    private @NonNullByDefault({}) SerialPortManager serialPortManager;\n+    private Map<ThingUID, ServiceRegistration<?>> discoveryServiceRegs = new HashMap<>();\n+\n+    @Override\n+    public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n+        return SUPPORTED_THING_TYPES_UIDS.contains(thingTypeUID);\n+    }\n+\n+    @Reference\n+    protected void setSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    protected void unsetSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = null;\n+    }\n+\n+    @Override\n+    protected @Nullable ThingHandler createHandler(Thing thing) {\n+        TeleinfoAbstractControllerHandler controller = null;\n+        ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n+\n+        if (THING_TYPE_SERIAL_CONTROLLER.equals(thingTypeUID)) {\n+            controller = new TeleinfoSerialControllerHandler((Bridge) thing, serialPortManager);\n+        }\n+\n+        if (controller != null) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzNTA3NA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441835074", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T21:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MDYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MjI1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441082256", "bodyText": "You could add a @SuppressWarnings(\"null\") to eliminate the compiler warning.", "author": "fwolter", "createdAt": "2020-06-16T19:11:19Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/TeleinfoThingHandlerFactory.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Hashtable;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.config.discovery.DiscoveryService;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.teleinfo.internal.TeleinfoDiscoveryService;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoBaseCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoEjpCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoHcCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.TeleinfoTempoCbemmElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoBaseCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoEjpCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoHcCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbemm.evoicc.TeleinfoTempoCbemmEvoIccElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoBaseCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoEjpCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoHcCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.handler.cbetm.TeleinfoTempoCbetmLongElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.serial.TeleinfoSerialControllerHandler;\n+import org.osgi.framework.ServiceRegistration;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+/**\n+ * The {@link TeleinfoThingHandlerFactory} is responsible for creating things and thing\n+ * handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+@Component(configurationPid = \"binding.teleinfo\", service = ThingHandlerFactory.class)\n+public class TeleinfoThingHandlerFactory extends BaseThingHandlerFactory {\n+\n+    private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Stream.of(THING_TYPE_SERIAL_CONTROLLER,\n+            THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID, THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID, THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID)\n+            .collect(Collectors.toSet());\n+\n+    private @NonNullByDefault({}) SerialPortManager serialPortManager;\n+    private Map<ThingUID, ServiceRegistration<?>> discoveryServiceRegs = new HashMap<>();\n+\n+    @Override\n+    public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n+        return SUPPORTED_THING_TYPES_UIDS.contains(thingTypeUID);\n+    }\n+\n+    @Reference\n+    protected void setSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    protected void unsetSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = null;\n+    }\n+\n+    @Override\n+    protected @Nullable ThingHandler createHandler(Thing thing) {\n+        TeleinfoAbstractControllerHandler controller = null;\n+        ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n+\n+        if (THING_TYPE_SERIAL_CONTROLLER.equals(thingTypeUID)) {\n+            controller = new TeleinfoSerialControllerHandler((Bridge) thing, serialPortManager);\n+        }\n+\n+        if (controller != null) {\n+            TeleinfoDiscoveryService discoveryService = new TeleinfoDiscoveryService(controller, 60);\n+            discoveryService.activate();\n+\n+            discoveryServiceRegs.put(controller.getThing().getUID(), bundleContext.registerService(\n+                    DiscoveryService.class.getName(), discoveryService, new Hashtable<String, Object>()));\n+\n+            return controller;\n+        }\n+\n+        if (THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoBaseCbemmElectricityMeterHandler(thing);\n+        } else if (THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoHcCbemmElectricityMeterHandler(thing);\n+        } else if (THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoTempoCbemmElectricityMeterHandler(thing);\n+        } else if (THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoEjpCbemmElectricityMeterHandler(thing);\n+        } else if (THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoBaseCbemmEvoIccElectricityMeterHandler(thing);\n+        } else if (THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoHcCbemmEvoIccElectricityMeterHandler(thing);\n+        } else if (THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoTempoCbemmEvoIccElectricityMeterHandler(thing);\n+        } else if (THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoEjpCbemmEvoIccElectricityMeterHandler(thing);\n+        } else if (THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoBaseCbetmLongElectricityMeterHandler(thing);\n+        } else if (THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoHcCbetmLongElectricityMeterHandler(thing);\n+        } else if (THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoTempoCbetmLongElectricityMeterHandler(thing);\n+        } else if (THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID.equals(thing.getThingTypeUID())) {\n+            return new TeleinfoEjpCbetmLongElectricityMeterHandler(thing);\n+        } else {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + thing.getThingTypeUID());\n+        }\n+    }\n+\n+    @Override\n+    protected synchronized void removeHandler(ThingHandler thingHandler) {\n+        if (thingHandler instanceof TeleinfoAbstractControllerHandler) {\n+            ServiceRegistration<?> serviceReg = this.discoveryServiceRegs.get(thingHandler.getThing().getUID());\n+            if (serviceReg != null) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzNTg1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441835853", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T21:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MjI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4Mjg1NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441082855", "bodyText": "Please check the compiler warning.", "author": "fwolter", "createdAt": "2020-06-16T19:12:33Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/cbemm/TeleinfoAbstractCbemmElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler.cbemm;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.core.library.types.DateTimeType;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.StringType;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractElectricityMeterHandler;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemm;\n+\n+/**\n+ * The {@link TeleinfoAbstractCbemmElectricityMeterHandler} class defines a skeleton for CBEMM Electricity Meters\n+ * handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public abstract class TeleinfoAbstractCbemmElectricityMeterHandler extends TeleinfoAbstractElectricityMeterHandler {\n+\n+    public TeleinfoAbstractCbemmElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    protected void updateStatesForCommonCbemmChannels(@NonNull FrameCbemm frame) {\n+        // update common channels\n+        updateState(CHANNEL_CBEMM_ISOUSC, new DecimalType(frame.getIsousc()));\n+        updateState(CHANNEL_CBEMM_PTEC, new StringType(frame.getPtec().name()));\n+        if (frame.getImax() == null) {\n+            updateState(CHANNEL_CBEMM_IMAX, UnDefType.NULL);\n+        } else {\n+            updateState(CHANNEL_CBEMM_IMAX, new DecimalType(frame.getImax()));\n+        }\n+\n+        if (frame.getAdps() == null) {\n+            updateState(CHANNEL_CBEMM_ADPS, UnDefType.NULL);\n+        } else {\n+            updateState(CHANNEL_CBEMM_ADPS, new DecimalType(frame.getAdps()));\n+        }\n+        updateState(CHANNEL_CBEMM_IINST, new DecimalType(frame.getIinst()));\n+\n+        BigDecimal powerFactor = (BigDecimal) getThing().getChannel(CHANNEL_CBEMM_CURRENT_POWER).getConfiguration()", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MzM2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441083363", "bodyText": "Can you use your real name?", "author": "fwolter", "createdAt": "2020-06-16T19:13:27Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/cbemm/TeleinfoBaseCbemmElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler.cbemm;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.THING_BASE_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+\n+/**\n+ * The {@link TeleinfoBaseCbemmElectricityMeterHandler} class defines a handler for a BASE CBEMM Electricity Meters\n+ * thing.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ * @author olivierkeke - Change ADCO property to parameter", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzODEyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441838125", "bodyText": "@olivierkeke", "author": "nokyyz", "createdAt": "2020-06-17T21:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MzM2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgxOTkxMA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r442819910", "bodyText": "OK, done!", "author": "olivierkeke", "createdAt": "2020-06-19T12:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MzM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4NDY3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441084677", "bodyText": "adco can be null. You can handle this easily:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (adco.equalsIgnoreCase(frameCbemmBaseOption.getAdco())) {\n          \n          \n            \n                    if (frameCbemmBaseOption.getAdco().equalsIgnoreCase(adco)) {", "author": "fwolter", "createdAt": "2020-06-16T19:15:46Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/cbemm/TeleinfoBaseCbemmElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler.cbemm;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.THING_BASE_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+\n+/**\n+ * The {@link TeleinfoBaseCbemmElectricityMeterHandler} class defines a handler for a BASE CBEMM Electricity Meters\n+ * thing.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ * @author olivierkeke - Change ADCO property to parameter\n+ */\n+public class TeleinfoBaseCbemmElectricityMeterHandler extends TeleinfoAbstractCbemmElectricityMeterHandler {\n+\n+    public TeleinfoBaseCbemmElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        final FrameCbemmBaseOption frameCbemmBaseOption = (FrameCbemmBaseOption) frame;\n+\n+        String adco = (String) getThing().getConfiguration().get(THING_BASE_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO);\n+        if (adco.equalsIgnoreCase(frameCbemmBaseOption.getAdco())) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0MTE4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441841183", "bodyText": "ADCO property is mandatory, but your suggestion is more strong", "author": "nokyyz", "createdAt": "2020-06-17T21:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4NDY3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4NDk1MA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441084950", "bodyText": "See above and below.", "author": "fwolter", "createdAt": "2020-06-16T19:16:13Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/cbemm/TeleinfoEjpCbemmElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler.cbemm;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.THING_EJP_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+\n+/**\n+ * The {@link TeleinfoEjpCbemmElectricityMeterHandler} class defines a handler for a EJB CBEMM Electricity Meters\n+ * thing.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ * @author olivierkeke - Change ADCO property to parameter\n+ */\n+public class TeleinfoEjpCbemmElectricityMeterHandler extends TeleinfoAbstractCbemmElectricityMeterHandler {\n+\n+    public TeleinfoEjpCbemmElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        final FrameCbemmEjpOption frameCbemmEjpOption = (FrameCbemmEjpOption) frame;\n+\n+        String adco = (String) getThing().getConfiguration().get(THING_EJP_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO);\n+        if (adco.equalsIgnoreCase(frameCbemmEjpOption.getAdco())) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0MTM0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441841343", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T21:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4NDk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4ODUzOA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441088538", "bodyText": "Are you sure this is always of type FrameCbemmBaseOption?", "author": "fwolter", "createdAt": "2020-06-16T19:23:02Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/handler/cbemm/TeleinfoBaseCbemmElectricityMeterHandler.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.handler.cbemm;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.THING_BASE_CBEMM_ELECTRICITY_METER_PROPERTY_ADCO;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+\n+/**\n+ * The {@link TeleinfoBaseCbemmElectricityMeterHandler} class defines a handler for a BASE CBEMM Electricity Meters\n+ * thing.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ * @author olivierkeke - Change ADCO property to parameter\n+ */\n+public class TeleinfoBaseCbemmElectricityMeterHandler extends TeleinfoAbstractCbemmElectricityMeterHandler {\n+\n+    public TeleinfoBaseCbemmElectricityMeterHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        final FrameCbemmBaseOption frameCbemmBaseOption = (FrameCbemmBaseOption) frame;", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NDQwNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441844405", "bodyText": "Yes. The electricity meter broadcasts only one Teleinfo frame type", "author": "nokyyz", "createdAt": "2020-06-17T21:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4ODUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5MTk4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441091986", "bodyText": "Does this have any function? Same for below.", "author": "fwolter", "createdAt": "2020-06-16T19:29:40Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/cbemm/FrameCbemmBaseOption.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.cbemm;\n+\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+\n+/**\n+ * The {@link FrameCbemmBaseOption} class defines a CBEMM Teleinfo frame with Base option.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class FrameCbemmBaseOption extends FrameCbemm implements FrameBaseOption {\n+\n+    private static final long serialVersionUID = 5560141193379363335L;\n+\n+    private int base;\n+\n+    public FrameCbemmBaseOption() {\n+        // default constructor\n+    }", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NTMyMw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441845323", "bodyText": "Javabeans convention", "author": "nokyyz", "createdAt": "2020-06-17T21:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5MTk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5Mzg4OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441093888", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Teleinfo inputStream not null\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"Teleinfo inputStream is null\");", "author": "fwolter", "createdAt": "2020-06-16T19:33:19Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,682 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.UnsupportedEncodingException;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.reader.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.reader.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConvertionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME = 33400;\n+    public static long DEFAULT_TIMEOUT_READING_FRAME = 33400;\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader = null;\n+    private InputStream teleinfoInputStream = null;\n+    private String groupLine = null;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream not null\");", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NzI0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441847243", "bodyText": "\"Teleinfo inputstream not null\" = \"Teleinfo inputstream must not be null\" for me.\nBut Ok for your suggestion", "author": "nokyyz", "createdAt": "2020-06-17T21:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5Mzg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5NDQwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441094406", "bodyText": "You could remove the exception catch clause when using this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, \"ASCII\"));\n          \n          \n            \n                        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));", "author": "fwolter", "createdAt": "2020-06-16T19:34:20Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,682 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.UnsupportedEncodingException;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.reader.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.reader.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConvertionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME = 33400;\n+    public static long DEFAULT_TIMEOUT_READING_FRAME = 33400;\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader = null;\n+    private InputStream teleinfoInputStream = null;\n+    private String groupLine = null;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream not null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        try {\n+            this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, \"ASCII\"));", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NzY0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441847641", "bodyText": "Ok, thanks", "author": "nokyyz", "createdAt": "2020-06-17T21:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5NDQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5NTc0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441095742", "bodyText": "Syntactical sugar\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Future<Void> seekNextHeaderFrameTask = executorService.submit(new Callable<Void>() {\n          \n          \n            \n                        @Override\n          \n          \n            \n                        public Void call() throws Exception {\n          \n          \n            \n                    Future<Void> seekNextHeaderFrameTask = executorService.submit(() -> {", "author": "fwolter", "createdAt": "2020-06-16T19:37:05Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,682 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.UnsupportedEncodingException;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.reader.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.reader.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConvertionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME = 33400;\n+    public static long DEFAULT_TIMEOUT_READING_FRAME = 33400;\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader = null;\n+    private InputStream teleinfoInputStream = null;\n+    private String groupLine = null;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream not null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        try {\n+            this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, \"ASCII\"));\n+            this.teleinfoInputStream = teleinfoInputStream;\n+        } catch (UnsupportedEncodingException e) {\n+            throw new IllegalStateException(e);\n+        }\n+\n+        groupLine = null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        logger.debug(\"close() [start]\");\n+        bufferedReader.close();\n+        executorService.shutdownNow();\n+        super.close();\n+        logger.debug(\"close() [end]\");\n+    }\n+\n+    /**\n+     * Returns the next frame.\n+     *\n+     * @return the next frame or null if end of stream\n+     * @throws InvalidFrameException if the read data from\n+     * @throws TimeoutException if the delay to read a complete frame is expired (33,4 ms) or if the delay to find\n+     *             the\n+     *             header of next frame is expired (33,4 ms)\n+     * @throws IOException\n+     */\n+    public synchronized Frame readNextFrame() throws InvalidFrameException, TimeoutException, IOException {\n+        logger.debug(\"readNextFrame() [start]\");\n+\n+        // seek the next header frame\n+        Future<Void> seekNextHeaderFrameTask = executorService.submit(new Callable<Void>() {\n+            @Override\n+            public Void call() throws Exception {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0ODE3OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441848178", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T21:36:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5NTc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNjg5MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441106891", "bodyText": "Is dataType needed?", "author": "fwolter", "createdAt": "2020-06-16T19:58:11Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,682 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.UnsupportedEncodingException;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.reader.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.reader.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConvertionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME = 33400;\n+    public static long DEFAULT_TIMEOUT_READING_FRAME = 33400;\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader = null;\n+    private InputStream teleinfoInputStream = null;\n+    private String groupLine = null;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream not null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        try {\n+            this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, \"ASCII\"));\n+            this.teleinfoInputStream = teleinfoInputStream;\n+        } catch (UnsupportedEncodingException e) {\n+            throw new IllegalStateException(e);\n+        }\n+\n+        groupLine = null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        logger.debug(\"close() [start]\");\n+        bufferedReader.close();\n+        executorService.shutdownNow();\n+        super.close();\n+        logger.debug(\"close() [end]\");\n+    }\n+\n+    /**\n+     * Returns the next frame.\n+     *\n+     * @return the next frame or null if end of stream\n+     * @throws InvalidFrameException if the read data from\n+     * @throws TimeoutException if the delay to read a complete frame is expired (33,4 ms) or if the delay to find\n+     *             the\n+     *             header of next frame is expired (33,4 ms)\n+     * @throws IOException\n+     */\n+    public synchronized Frame readNextFrame() throws InvalidFrameException, TimeoutException, IOException {\n+        logger.debug(\"readNextFrame() [start]\");\n+\n+        // seek the next header frame\n+        Future<Void> seekNextHeaderFrameTask = executorService.submit(new Callable<Void>() {\n+            @Override\n+            public Void call() throws Exception {\n+                while (!isHeaderFrame(groupLine)) {\n+                    groupLine = bufferedReader.readLine();\n+                    if (logger.isTraceEnabled()) {\n+                        logger.trace(\"groupLine = {}\", groupLine);\n+                    }\n+                    if (groupLine == null) { // end of stream\n+                        logger.trace(\"end of stream reached !\");\n+                        return null;\n+                    }\n+                }\n+\n+                logger.trace(\"header frame found !\");\n+                return null;\n+            }\n+        });\n+        try {\n+            logger.debug(\"seeking the next header frame...\");\n+            logger.trace(\"waitNextHeaderFrameTimeoutInMs = {}\", waitNextHeaderFrameTimeoutInMs);\n+            seekNextHeaderFrameTask.get(waitNextHeaderFrameTimeoutInMs, TimeUnit.MICROSECONDS);\n+\n+            if (groupLine == null) { // end of stream\n+                return null;\n+            }\n+        } catch (InterruptedException e) {\n+            throw new IllegalStateException(e);\n+        } catch (ExecutionException e) {\n+            rethrowTaskExecutionException(e);\n+            return null; // FIXME best way ?\n+        }\n+\n+        Future<Map<Label, Object>> nextFrameFuture = executorService.submit(new Callable<Map<Label, Object>>() {\n+            @Override\n+            public Map<Label, Object> call() throws Exception {\n+                // read label values\n+                Map<Label, Object> frameValues = new HashMap<>();\n+                while ((groupLine = bufferedReader.readLine()) != null && !isHeaderFrame(groupLine)) {\n+                    logger.trace(\"groupLine = {}\", groupLine);\n+\n+                    String[] groupLineTokens = groupLine.split(\"\\\\s\");\n+                    if (groupLineTokens.length != 2 && groupLineTokens.length != 3) {\n+                        final String error = String.format(\"The groupLine '%1$s' is incomplete\", groupLine);\n+                        throw new InvalidFrameException(error);\n+                    }\n+                    String labelStr = groupLineTokens[0];\n+                    String valueString = groupLineTokens[1];\n+\n+                    // verify integrity (through checksum)\n+                    char checksum = (groupLineTokens.length == 3 ? groupLineTokens[2].charAt(0) : ' ');\n+                    char computedChecksum = FrameUtil.computeGroupLineChecksum(labelStr, valueString);\n+                    if (computedChecksum != checksum) {\n+                        logger.trace(\"computedChecksum = {}\", computedChecksum);\n+                        logger.trace(\"checksum = {}\", checksum);\n+                        final String error = String.format(\n+                                \"The groupLine '%s' is corrupted (integrity not checked). Actual checksum: '%s' / Expected checksum: '%s'\",\n+                                groupLine, checksum, computedChecksum);\n+                        throw new InvalidFrameException(error);\n+                    }\n+\n+                    Label label;\n+                    try {\n+                        label = Label.valueOf(labelStr);\n+                    } catch (IllegalArgumentException e) {\n+                        if (autoRepairInvalidADPSgroupLine && labelStr.startsWith(Label.ADPS.name())) {\n+                            // in this hardware issue, label variable is composed by label name and value. E.g: ADPS032\n+                            logger.warn(\"Try to auto repair malformed ADPS groupLine '{}'\", labelStr);\n+                            label = Label.ADPS;\n+                            valueString = labelStr.substring(Label.ADPS.name().length());\n+                        } else {\n+                            final String error = String.format(\"The label '%s' is unknown\", labelStr);\n+                            throw new InvalidFrameException(error);\n+                        }\n+                    }\n+\n+                    Class<?> labelType = label.getType();\n+                    Converter converter = LABEL_VALUE_CONVERTERS.get(labelType);\n+                    if (converter == null) {\n+                        final String error = String.format(\"No converter founded for '%s' label type\", labelType);\n+                        throw new IllegalStateException(error);\n+                    }\n+                    try {\n+                        Object value = converter.convert(valueString);\n+\n+                        frameValues.put(label, value);\n+                    } catch (ConvertionException e) {\n+                        final String error = String.format(\"An error occurred during '%s' value conversion\",\n+                                valueString);\n+                        throw new InvalidFrameException(error, e);\n+                    }\n+                }\n+\n+                return frameValues;\n+            }\n+        });\n+\n+        try {\n+            logger.debug(\"reading data frame...\");\n+            logger.trace(\"readingFrameTimeoutInMs = {}\", readingFrameTimeoutInMs);\n+            Map<Label, Object> frameValues = nextFrameFuture.get(readingFrameTimeoutInMs, TimeUnit.MICROSECONDS);\n+\n+            // build the frame from map values\n+            final Frame frame = buildFrame(frameValues);\n+            frame.setTimestamp(LocalDate.now());\n+            frame.setId(UUID.randomUUID());\n+\n+            logger.debug(\"readNextFrame() [end]\");\n+            return frame;\n+        } catch (InterruptedException e) {\n+            throw new IllegalStateException(e);\n+        } catch (ExecutionException e) {\n+            rethrowTaskExecutionException(e);\n+            return null; // FIXME best way ?\n+        }\n+    }\n+\n+    public long getWaitNextHeaderFrameTimeoutInMs() {\n+        return waitNextHeaderFrameTimeoutInMs;\n+    }\n+\n+    public void setWaitNextHeaderFrameTimeoutInMs(long waitNextHeaderFrameTimeoutInMs) {\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+    }\n+\n+    public long getReadingFrameTimeoutInMs() {\n+        return readingFrameTimeoutInMs;\n+    }\n+\n+    public void setReadingFrameTimeoutInMs(long readingFrameTimeoutInMs) {\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+    }\n+\n+    public boolean isAutoRepairInvalidADPSgroupLine() {\n+        return autoRepairInvalidADPSgroupLine;\n+    }\n+\n+    public void setAutoRepairInvalidADPSgroupLine(boolean autoRepairInvalidADPSgroupLine) {\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+    }\n+\n+    @Override\n+    public int read() throws IOException {\n+        throw new UnsupportedOperationException(\"The 'read()' is not supported\");\n+    }\n+\n+    private boolean isHeaderFrame(final String line) {\n+        // A new teleinfo trame begin with '3' and '2' bytes (END OF TEXT et START OF TEXT)\n+        return (line != null && line.length() > 1 && line.codePointAt(0) == 3 && line.codePointAt(1) == 2);\n+    }\n+\n+    private Frame buildFrame(final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        if (frameValues.containsKey(Label.IINST1)) {\n+            if (frameValues.containsKey(Label.IMAX1)) {\n+                return buildFrameCbetmLong(frameValues);\n+            } else {\n+                return buildFrameCbetmShort(frameValues);\n+            }\n+        } else if (frameValues.containsKey(Label.PAPP)) {\n+            return buildFrameCbemmEvolutionIcc(frameValues);\n+        } else {\n+            return buildFrameCbemm(frameValues);\n+        }\n+    }\n+\n+    private FrameCbetmLong buildFrameCbetmLong(final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmLong(Map<Label, Object>) [start]\");\n+        final FrameCbetmLong frameCbetm;\n+        String optionTarif = getRequiredLabelValue(Label.OPTARIF, String.class, frameValues);\n+        if (\"BASE\".equals(optionTarif)) {\n+            frameCbetm = buildFrameCbetmLongBaseOption(frameValues);\n+        } else if (\"HC..\".equals(optionTarif)) {\n+            frameCbetm = buildFrameCbetmLongHcOption(frameValues);\n+        } else if (\"EJP.\".equals(optionTarif)) {\n+            frameCbetm = buildFrameCbetmLongEjpOption(frameValues);\n+        } else if (optionTarif.startsWith(\"BBR\") && optionTarif.length() == 4) {\n+            ProgrammeCircuit1 prgCircuit1 = convertProgrammeCircuit1(optionTarif.charAt(3));\n+            ProgrammeCircuit2 prgCircuit2 = convertProgrammeCircuit2(optionTarif.charAt(3));\n+            frameCbetm = buildFrameCbetmLongTempoOption(frameValues, prgCircuit1, prgCircuit2);\n+        } else {\n+            final String error = String.format(\"The option Tarif '%s' is not supported\", optionTarif);\n+            throw new InvalidFrameException(error);\n+        }\n+        logger.trace(\"buildFrameCbetmLong(Map<Label, Object>) [end]\");\n+        return frameCbetm;\n+    }\n+\n+    private void setCbetmCommonFrameFields(final FrameCbetmLong frame, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setCbetmCommonFrameFields(Frame, Map<Label, Object>) [start]\");\n+        frame.setAdco(getRequiredLabelValue(Label.ADCO, String.class, frameValues));\n+        frame.setIsousc(getRequiredLabelValue(Label.ISOUSC, Integer.class, frameValues));\n+        frame.setIinst1(getRequiredLabelValue(Label.IINST1, Integer.class, frameValues));\n+        frame.setIinst2(getRequiredLabelValue(Label.IINST2, Integer.class, frameValues));\n+        frame.setIinst3(getRequiredLabelValue(Label.IINST3, Integer.class, frameValues));\n+        frame.setImax1(getRequiredLabelValue(Label.IMAX1, Integer.class, frameValues));\n+        frame.setImax2(getRequiredLabelValue(Label.IMAX2, Integer.class, frameValues));\n+        frame.setImax3(getRequiredLabelValue(Label.IMAX3, Integer.class, frameValues));\n+        frame.setPtec(getRequiredLabelValue(Label.PTEC, Ptec.class, frameValues));\n+        frame.setPmax(getRequiredLabelValue(Label.PMAX, Integer.class, frameValues));\n+        frame.setPapp(getRequiredLabelValue(Label.PAPP, Integer.class, frameValues));\n+        frame.setMotdetat(getRequiredLabelValue(Label.MOTDETAT, String.class, frameValues));\n+        frame.setPpot(getRequiredLabelValue(Label.PPOT, String.class, frameValues));\n+        logger.trace(\"setCbetmCommonFrameFields(Frame, Map<Label, Object>) [end]\");\n+    }\n+\n+    private FrameCbetmLongBaseOption buildFrameCbetmLongBaseOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmBaseOption(Map<Label, Object>) [start]\");\n+        FrameCbetmLongBaseOption frame = new FrameCbetmLongBaseOption();\n+        setCbetmCommonFrameFields(frame, frameValues);\n+        setFrameBaseOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbetmBaseOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbetmLongHcOption buildFrameCbetmLongHcOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmHcOption(Map<Label, Object>) [start]\");\n+        FrameCbetmLongHcOption frame = new FrameCbetmLongHcOption();\n+        setCbetmCommonFrameFields(frame, frameValues);\n+        setFrameHcOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbetmHcOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbetmLongEjpOption buildFrameCbetmLongEjpOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmEjpOption(Map<Label, Object>) [start]\");\n+        FrameCbetmLongEjpOption frame = new FrameCbetmLongEjpOption();\n+        setCbetmCommonFrameFields(frame, frameValues);\n+        setFrameEjpOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbetmEjpOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbetmLongTempoOption buildFrameCbetmLongTempoOption(final Map<Label, Object> frameValues,\n+            ProgrammeCircuit1 prgCircuit1, ProgrammeCircuit2 prgCircuit2) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmTempoOption(Map<Label, Object>) [start]\");\n+        FrameCbetmLongTempoOption frame = new FrameCbetmLongTempoOption();\n+        setCbetmCommonFrameFields(frame, frameValues);\n+        setFrameTempoOptionFields(frame, frameValues, prgCircuit1, prgCircuit2);\n+        logger.trace(\"buildFrameCbetmTempoOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbetmShort buildFrameCbetmShort(final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmShort(Map<Label, Object>) [start]\");\n+        FrameCbetmShort frame = new FrameCbetmShort();\n+        frame.setAdco(getRequiredLabelValue(Label.ADCO, String.class, frameValues));\n+        frame.setIinst1(getRequiredLabelValue(Label.IINST1, Integer.class, frameValues));\n+        frame.setIinst2(getRequiredLabelValue(Label.IINST2, Integer.class, frameValues));\n+        frame.setIinst3(getRequiredLabelValue(Label.IINST3, Integer.class, frameValues));\n+        frame.setAdir1(getOptionalLabelValue(Label.ADIR1, Integer.class, frameValues));\n+        frame.setAdir2(getOptionalLabelValue(Label.ADIR2, Integer.class, frameValues));\n+        frame.setAdir3(getOptionalLabelValue(Label.ADIR3, Integer.class, frameValues));\n+        logger.trace(\"buildFrameCbetmShort(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemm buildFrameCbemm(final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemm(Map<Label, Object>) [start]\");\n+        final FrameCbemm frameCbemm;\n+        String optionTarif = getRequiredLabelValue(Label.OPTARIF, String.class, frameValues);\n+        if (\"BASE\".equals(optionTarif)) {\n+            frameCbemm = buildFrameCbemmBaseOption(frameValues);\n+        } else if (\"HC..\".equals(optionTarif)) {\n+            frameCbemm = buildFrameCbemmHcOption(frameValues);\n+        } else if (\"EJP.\".equals(optionTarif)) {\n+            frameCbemm = buildFrameCbemmEjpOption(frameValues);\n+        } else if (optionTarif.startsWith(\"BBR\") && optionTarif.length() == 4) {\n+            ProgrammeCircuit1 prgCircuit1 = convertProgrammeCircuit1(optionTarif.charAt(3));\n+            ProgrammeCircuit2 prgCircuit2 = convertProgrammeCircuit2(optionTarif.charAt(3));\n+            frameCbemm = buildFrameCbemmTempoOption(frameValues, prgCircuit1, prgCircuit2);\n+        } else {\n+            final String error = String.format(\"The option Tarif '%s' is not supported\", optionTarif);\n+            throw new InvalidFrameException(error);\n+        }\n+        logger.trace(\"buildFrameCbemm(Map<Label, Object>) [end]\");\n+        return frameCbemm;\n+    }\n+\n+    private void setCbemmCommonFrameFields(final FrameCbemm frame, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setCbemmCommonFrameFields(Frame, Map<Label, Object>) [start]\");\n+        frame.setAdco(getRequiredLabelValue(Label.ADCO, String.class, frameValues));\n+        frame.setIsousc(getRequiredLabelValue(Label.ISOUSC, Integer.class, frameValues));\n+        frame.setIinst(getRequiredLabelValue(Label.IINST, Integer.class, frameValues));\n+        frame.setImax(getOptionalLabelValue(Label.IMAX, Integer.class, frameValues));\n+        frame.setPtec(getRequiredLabelValue(Label.PTEC, Ptec.class, frameValues));\n+        frame.setAdps(getOptionalLabelValue(Label.ADPS, Integer.class, frameValues));\n+        frame.setMotdetat(getRequiredLabelValue(Label.MOTDETAT, String.class, frameValues));\n+        logger.trace(\"setCbemmCommonFrameFields(Frame, Map<Label, Object>) [end]\");\n+    }\n+\n+    private FrameCbemmBaseOption buildFrameCbemmBaseOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmBaseOption(Map<Label, Object>) [start]\");\n+        FrameCbemmBaseOption frame = new FrameCbemmBaseOption();\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        setFrameBaseOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmBaseOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmHcOption buildFrameCbemmHcOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmHcOption(Map<Label, Object>) [start]\");\n+        FrameCbemmHcOption frame = new FrameCbemmHcOption();\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        setFrameHcOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmHcOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEjpOption buildFrameCbemmEjpOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEjpOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEjpOption frame = new FrameCbemmEjpOption();\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        setFrameEjpOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmEjpOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmTempoOption buildFrameCbemmTempoOption(final Map<Label, Object> frameValues,\n+            ProgrammeCircuit1 prgCircuit1, ProgrammeCircuit2 prgCircuit2) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmTempoOption(Map<Label, Object>) [start]\");\n+        FrameCbemmTempoOption frame = new FrameCbemmTempoOption();\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        setFrameTempoOptionFields(frame, frameValues, prgCircuit1, prgCircuit2);\n+        logger.trace(\"buildFrameCbemmTempoOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEvolutionIcc buildFrameCbemmEvolutionIcc(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIcc(Map<Label, Object>) [start]\");\n+        final FrameCbemmEvolutionIcc frameCbemmEvoIcc;\n+        String optionTarif = getRequiredLabelValue(Label.OPTARIF, String.class, frameValues);\n+        if (\"BASE\".equals(optionTarif)) {\n+            frameCbemmEvoIcc = buildFrameCbemmEvolutionIccBaseOption(frameValues);\n+        } else if (\"HC..\".equals(optionTarif)) {\n+            frameCbemmEvoIcc = buildFrameCbemmEvolutionIccHcOption(frameValues);\n+        } else if (\"EJP.\".equals(optionTarif)) {\n+            frameCbemmEvoIcc = buildFrameCbemmEvolutionIccEjpOption(frameValues);\n+        } else if (optionTarif.startsWith(\"BBR\") && optionTarif.length() == 4) {\n+            ProgrammeCircuit1 prgCircuit1 = convertProgrammeCircuit1(optionTarif.charAt(3));\n+            ProgrammeCircuit2 prgCircuit2 = convertProgrammeCircuit2(optionTarif.charAt(3));\n+            frameCbemmEvoIcc = buildFrameCbemmEvolutionIccTempoOption(frameValues, prgCircuit1, prgCircuit2);\n+        } else {\n+            final String error = String.format(\"The option Tarif '%s' is not supported\", optionTarif);\n+            throw new InvalidFrameException(error);\n+        }\n+\n+        logger.trace(\"buildFrameCbemmEvolutionIcc(Map<Label, Object>) [end]\");\n+        return frameCbemmEvoIcc;\n+    }\n+\n+    private void setCbemmEvolutionIccCommonFrameFields(final FrameCbemmEvolutionIcc frame,\n+            final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        logger.trace(\"setCbemmEvolutionIccCommonFrameFields(Frame, Map<Label, Object>) [start]\");\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        frame.setPapp(getRequiredLabelValue(Label.PAPP, Integer.class, frameValues));\n+        logger.trace(\"setCbemmEvolutionIccCommonFrameFields(Frame, Map<Label, Object>) [end]\");\n+    }\n+\n+    private FrameCbemmEvolutionIccBaseOption buildFrameCbemmEvolutionIccBaseOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIccBaseOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEvolutionIccBaseOption frame = new FrameCbemmEvolutionIccBaseOption();\n+        setCbemmEvolutionIccCommonFrameFields(frame, frameValues);\n+        setFrameBaseOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmEvolutionIccBaseOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEvolutionIccHcOption buildFrameCbemmEvolutionIccHcOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIccHcOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEvolutionIccHcOption frame = new FrameCbemmEvolutionIccHcOption();\n+        setCbemmEvolutionIccCommonFrameFields(frame, frameValues);\n+        setFrameHcOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmEvolutionIccHcOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEvolutionIccTempoOption buildFrameCbemmEvolutionIccTempoOption(\n+            final Map<Label, Object> frameValues, ProgrammeCircuit1 prgCircuit1, ProgrammeCircuit2 prgCircuit2)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIccTempoOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEvolutionIccTempoOption frame = new FrameCbemmEvolutionIccTempoOption();\n+        setCbemmEvolutionIccCommonFrameFields(frame, frameValues);\n+        setFrameTempoOptionFields(frame, frameValues, prgCircuit1, prgCircuit2);\n+        logger.trace(\"buildFrameCbemmEvolutionIccTempoOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEvolutionIccEjpOption buildFrameCbemmEvolutionIccEjpOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIccEjpOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEvolutionIccEjpOption frame = new FrameCbemmEvolutionIccEjpOption();\n+        setCbemmEvolutionIccCommonFrameFields(frame, frameValues);\n+        setFrameEjpOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmEvolutionIccEjpOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private void setFrameBaseOptionFields(final FrameBaseOption frameBaseOption, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setFrameBaseOptionFields(FrameBaseOption) [start]\");\n+        frameBaseOption.setBase(getRequiredLabelValue(Label.BASE, Integer.class, frameValues));\n+        logger.trace(\"setFrameBaseOptionFields(FrameBaseOption) [end]\");\n+    }\n+\n+    private void setFrameHcOptionFields(final FrameHcOption frameHcOption, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setFrameHcOptionFields(FrameHcOption) [start]\");\n+        frameHcOption.setHchc(getRequiredLabelValue(Label.HCHC, Integer.class, frameValues));\n+        frameHcOption.setHchp(getRequiredLabelValue(Label.HCHP, Integer.class, frameValues));\n+        frameHcOption.setHhphc(getRequiredLabelValue(Label.HHPHC, Hhphc.class, frameValues));\n+        logger.trace(\"setFrameHcOptionFields(FrameHcOption) [end]\");\n+    }\n+\n+    private void setFrameEjpOptionFields(final FrameEjpOption frameEjpOption, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setFrameEjpOptionFields(FrameEjpOption) [start]\");\n+        frameEjpOption.setEjphn(getRequiredLabelValue(Label.EJPHN, Integer.class, frameValues));\n+        frameEjpOption.setEjphpm(getRequiredLabelValue(Label.EJPHPM, Integer.class, frameValues));\n+        frameEjpOption.setPejp(getOptionalLabelValue(Label.PEJP, Integer.class, frameValues));\n+        logger.trace(\"setFrameEjpOptionFields(FrameEjpOption) [end]\");\n+    }\n+\n+    private void setFrameTempoOptionFields(final FrameTempoOption frameTempoOption,\n+            final Map<Label, Object> frameValues, ProgrammeCircuit1 prgCircuit1, ProgrammeCircuit2 prgCircuit2)\n+            throws InvalidFrameException {\n+        logger.trace(\"setFrameTempoOptionFields(FrameTempoOption) [start]\");\n+        frameTempoOption.setBbrhpjr(getRequiredLabelValue(Label.BBRHPJR, Integer.class, frameValues));\n+        frameTempoOption.setBbrhcjr(getRequiredLabelValue(Label.BBRHCJR, Integer.class, frameValues));\n+        frameTempoOption.setBbrhpjw(getRequiredLabelValue(Label.BBRHPJW, Integer.class, frameValues));\n+        frameTempoOption.setBbrhcjw(getRequiredLabelValue(Label.BBRHCJW, Integer.class, frameValues));\n+        frameTempoOption.setBbrhpjb(getRequiredLabelValue(Label.BBRHPJB, Integer.class, frameValues));\n+        frameTempoOption.setBbrhcjb(getRequiredLabelValue(Label.BBRHCJB, Integer.class, frameValues));\n+        frameTempoOption.setDemain(getOptionalLabelValue(Label.DEMAIN, CouleurDemain.class, frameValues));\n+        frameTempoOption.setHhphc(getRequiredLabelValue(Label.HHPHC, Hhphc.class, frameValues));\n+        frameTempoOption.setProgrammeCircuit1(prgCircuit1);\n+        frameTempoOption.setProgrammeCircuit2(prgCircuit2);\n+        logger.trace(\"setFrameTempoOptionFields(FrameTempoOption) [end]\");\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <T> T getRequiredLabelValue(Label label, Class<T> dataType, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        if (!frameValues.containsKey(label)) {\n+            final String error = String.format(\"The required label '%1$s' is missing in frame\", label);\n+            throw new InvalidFrameException(error);\n+        }\n+\n+        return (T) frameValues.get(label);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <T> T getOptionalLabelValue(Label label, Class<T> dataType, final Map<Label, Object> frameValues) {\n+        return (T) frameValues.get(label);\n+    }", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1MTgyMw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441851823", "bodyText": "dataType parameter is used to set the generic return type of function.\nI don't know if there is another solution", "author": "nokyyz", "createdAt": "2020-06-17T21:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNjg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5MzE2MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r442893161", "bodyText": "Seems to work without dataType so I remove that.", "author": "olivierkeke", "createdAt": "2020-06-19T15:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNjg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNzQ5NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441107495", "bodyText": "Since we want to get rid of Apache Commons, can you replace this with native Java code? See #7722. I think this can be done with String.format().", "author": "fwolter", "createdAt": "2020-06-16T19:59:30Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,682 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.UnsupportedEncodingException;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.reader.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.reader.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConvertionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME = 33400;\n+    public static long DEFAULT_TIMEOUT_READING_FRAME = 33400;\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader = null;\n+    private InputStream teleinfoInputStream = null;\n+    private String groupLine = null;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream not null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        try {\n+            this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, \"ASCII\"));\n+            this.teleinfoInputStream = teleinfoInputStream;\n+        } catch (UnsupportedEncodingException e) {\n+            throw new IllegalStateException(e);\n+        }\n+\n+        groupLine = null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        logger.debug(\"close() [start]\");\n+        bufferedReader.close();\n+        executorService.shutdownNow();\n+        super.close();\n+        logger.debug(\"close() [end]\");\n+    }\n+\n+    /**\n+     * Returns the next frame.\n+     *\n+     * @return the next frame or null if end of stream\n+     * @throws InvalidFrameException if the read data from\n+     * @throws TimeoutException if the delay to read a complete frame is expired (33,4 ms) or if the delay to find\n+     *             the\n+     *             header of next frame is expired (33,4 ms)\n+     * @throws IOException\n+     */\n+    public synchronized Frame readNextFrame() throws InvalidFrameException, TimeoutException, IOException {\n+        logger.debug(\"readNextFrame() [start]\");\n+\n+        // seek the next header frame\n+        Future<Void> seekNextHeaderFrameTask = executorService.submit(new Callable<Void>() {\n+            @Override\n+            public Void call() throws Exception {\n+                while (!isHeaderFrame(groupLine)) {\n+                    groupLine = bufferedReader.readLine();\n+                    if (logger.isTraceEnabled()) {\n+                        logger.trace(\"groupLine = {}\", groupLine);\n+                    }\n+                    if (groupLine == null) { // end of stream\n+                        logger.trace(\"end of stream reached !\");\n+                        return null;\n+                    }\n+                }\n+\n+                logger.trace(\"header frame found !\");\n+                return null;\n+            }\n+        });\n+        try {\n+            logger.debug(\"seeking the next header frame...\");\n+            logger.trace(\"waitNextHeaderFrameTimeoutInMs = {}\", waitNextHeaderFrameTimeoutInMs);\n+            seekNextHeaderFrameTask.get(waitNextHeaderFrameTimeoutInMs, TimeUnit.MICROSECONDS);\n+\n+            if (groupLine == null) { // end of stream\n+                return null;\n+            }\n+        } catch (InterruptedException e) {\n+            throw new IllegalStateException(e);\n+        } catch (ExecutionException e) {\n+            rethrowTaskExecutionException(e);\n+            return null; // FIXME best way ?\n+        }\n+\n+        Future<Map<Label, Object>> nextFrameFuture = executorService.submit(new Callable<Map<Label, Object>>() {\n+            @Override\n+            public Map<Label, Object> call() throws Exception {\n+                // read label values\n+                Map<Label, Object> frameValues = new HashMap<>();\n+                while ((groupLine = bufferedReader.readLine()) != null && !isHeaderFrame(groupLine)) {\n+                    logger.trace(\"groupLine = {}\", groupLine);\n+\n+                    String[] groupLineTokens = groupLine.split(\"\\\\s\");\n+                    if (groupLineTokens.length != 2 && groupLineTokens.length != 3) {\n+                        final String error = String.format(\"The groupLine '%1$s' is incomplete\", groupLine);\n+                        throw new InvalidFrameException(error);\n+                    }\n+                    String labelStr = groupLineTokens[0];\n+                    String valueString = groupLineTokens[1];\n+\n+                    // verify integrity (through checksum)\n+                    char checksum = (groupLineTokens.length == 3 ? groupLineTokens[2].charAt(0) : ' ');\n+                    char computedChecksum = FrameUtil.computeGroupLineChecksum(labelStr, valueString);\n+                    if (computedChecksum != checksum) {\n+                        logger.trace(\"computedChecksum = {}\", computedChecksum);\n+                        logger.trace(\"checksum = {}\", checksum);\n+                        final String error = String.format(\n+                                \"The groupLine '%s' is corrupted (integrity not checked). Actual checksum: '%s' / Expected checksum: '%s'\",\n+                                groupLine, checksum, computedChecksum);\n+                        throw new InvalidFrameException(error);\n+                    }\n+\n+                    Label label;\n+                    try {\n+                        label = Label.valueOf(labelStr);\n+                    } catch (IllegalArgumentException e) {\n+                        if (autoRepairInvalidADPSgroupLine && labelStr.startsWith(Label.ADPS.name())) {\n+                            // in this hardware issue, label variable is composed by label name and value. E.g: ADPS032\n+                            logger.warn(\"Try to auto repair malformed ADPS groupLine '{}'\", labelStr);\n+                            label = Label.ADPS;\n+                            valueString = labelStr.substring(Label.ADPS.name().length());\n+                        } else {\n+                            final String error = String.format(\"The label '%s' is unknown\", labelStr);\n+                            throw new InvalidFrameException(error);\n+                        }\n+                    }\n+\n+                    Class<?> labelType = label.getType();\n+                    Converter converter = LABEL_VALUE_CONVERTERS.get(labelType);\n+                    if (converter == null) {\n+                        final String error = String.format(\"No converter founded for '%s' label type\", labelType);\n+                        throw new IllegalStateException(error);\n+                    }\n+                    try {\n+                        Object value = converter.convert(valueString);\n+\n+                        frameValues.put(label, value);\n+                    } catch (ConvertionException e) {\n+                        final String error = String.format(\"An error occurred during '%s' value conversion\",\n+                                valueString);\n+                        throw new InvalidFrameException(error, e);\n+                    }\n+                }\n+\n+                return frameValues;\n+            }\n+        });\n+\n+        try {\n+            logger.debug(\"reading data frame...\");\n+            logger.trace(\"readingFrameTimeoutInMs = {}\", readingFrameTimeoutInMs);\n+            Map<Label, Object> frameValues = nextFrameFuture.get(readingFrameTimeoutInMs, TimeUnit.MICROSECONDS);\n+\n+            // build the frame from map values\n+            final Frame frame = buildFrame(frameValues);\n+            frame.setTimestamp(LocalDate.now());\n+            frame.setId(UUID.randomUUID());\n+\n+            logger.debug(\"readNextFrame() [end]\");\n+            return frame;\n+        } catch (InterruptedException e) {\n+            throw new IllegalStateException(e);\n+        } catch (ExecutionException e) {\n+            rethrowTaskExecutionException(e);\n+            return null; // FIXME best way ?\n+        }\n+    }\n+\n+    public long getWaitNextHeaderFrameTimeoutInMs() {\n+        return waitNextHeaderFrameTimeoutInMs;\n+    }\n+\n+    public void setWaitNextHeaderFrameTimeoutInMs(long waitNextHeaderFrameTimeoutInMs) {\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+    }\n+\n+    public long getReadingFrameTimeoutInMs() {\n+        return readingFrameTimeoutInMs;\n+    }\n+\n+    public void setReadingFrameTimeoutInMs(long readingFrameTimeoutInMs) {\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+    }\n+\n+    public boolean isAutoRepairInvalidADPSgroupLine() {\n+        return autoRepairInvalidADPSgroupLine;\n+    }\n+\n+    public void setAutoRepairInvalidADPSgroupLine(boolean autoRepairInvalidADPSgroupLine) {\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+    }\n+\n+    @Override\n+    public int read() throws IOException {\n+        throw new UnsupportedOperationException(\"The 'read()' is not supported\");\n+    }\n+\n+    private boolean isHeaderFrame(final String line) {\n+        // A new teleinfo trame begin with '3' and '2' bytes (END OF TEXT et START OF TEXT)\n+        return (line != null && line.length() > 1 && line.codePointAt(0) == 3 && line.codePointAt(1) == 2);\n+    }\n+\n+    private Frame buildFrame(final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        if (frameValues.containsKey(Label.IINST1)) {\n+            if (frameValues.containsKey(Label.IMAX1)) {\n+                return buildFrameCbetmLong(frameValues);\n+            } else {\n+                return buildFrameCbetmShort(frameValues);\n+            }\n+        } else if (frameValues.containsKey(Label.PAPP)) {\n+            return buildFrameCbemmEvolutionIcc(frameValues);\n+        } else {\n+            return buildFrameCbemm(frameValues);\n+        }\n+    }\n+\n+    private FrameCbetmLong buildFrameCbetmLong(final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmLong(Map<Label, Object>) [start]\");\n+        final FrameCbetmLong frameCbetm;\n+        String optionTarif = getRequiredLabelValue(Label.OPTARIF, String.class, frameValues);\n+        if (\"BASE\".equals(optionTarif)) {\n+            frameCbetm = buildFrameCbetmLongBaseOption(frameValues);\n+        } else if (\"HC..\".equals(optionTarif)) {\n+            frameCbetm = buildFrameCbetmLongHcOption(frameValues);\n+        } else if (\"EJP.\".equals(optionTarif)) {\n+            frameCbetm = buildFrameCbetmLongEjpOption(frameValues);\n+        } else if (optionTarif.startsWith(\"BBR\") && optionTarif.length() == 4) {\n+            ProgrammeCircuit1 prgCircuit1 = convertProgrammeCircuit1(optionTarif.charAt(3));\n+            ProgrammeCircuit2 prgCircuit2 = convertProgrammeCircuit2(optionTarif.charAt(3));\n+            frameCbetm = buildFrameCbetmLongTempoOption(frameValues, prgCircuit1, prgCircuit2);\n+        } else {\n+            final String error = String.format(\"The option Tarif '%s' is not supported\", optionTarif);\n+            throw new InvalidFrameException(error);\n+        }\n+        logger.trace(\"buildFrameCbetmLong(Map<Label, Object>) [end]\");\n+        return frameCbetm;\n+    }\n+\n+    private void setCbetmCommonFrameFields(final FrameCbetmLong frame, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setCbetmCommonFrameFields(Frame, Map<Label, Object>) [start]\");\n+        frame.setAdco(getRequiredLabelValue(Label.ADCO, String.class, frameValues));\n+        frame.setIsousc(getRequiredLabelValue(Label.ISOUSC, Integer.class, frameValues));\n+        frame.setIinst1(getRequiredLabelValue(Label.IINST1, Integer.class, frameValues));\n+        frame.setIinst2(getRequiredLabelValue(Label.IINST2, Integer.class, frameValues));\n+        frame.setIinst3(getRequiredLabelValue(Label.IINST3, Integer.class, frameValues));\n+        frame.setImax1(getRequiredLabelValue(Label.IMAX1, Integer.class, frameValues));\n+        frame.setImax2(getRequiredLabelValue(Label.IMAX2, Integer.class, frameValues));\n+        frame.setImax3(getRequiredLabelValue(Label.IMAX3, Integer.class, frameValues));\n+        frame.setPtec(getRequiredLabelValue(Label.PTEC, Ptec.class, frameValues));\n+        frame.setPmax(getRequiredLabelValue(Label.PMAX, Integer.class, frameValues));\n+        frame.setPapp(getRequiredLabelValue(Label.PAPP, Integer.class, frameValues));\n+        frame.setMotdetat(getRequiredLabelValue(Label.MOTDETAT, String.class, frameValues));\n+        frame.setPpot(getRequiredLabelValue(Label.PPOT, String.class, frameValues));\n+        logger.trace(\"setCbetmCommonFrameFields(Frame, Map<Label, Object>) [end]\");\n+    }\n+\n+    private FrameCbetmLongBaseOption buildFrameCbetmLongBaseOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmBaseOption(Map<Label, Object>) [start]\");\n+        FrameCbetmLongBaseOption frame = new FrameCbetmLongBaseOption();\n+        setCbetmCommonFrameFields(frame, frameValues);\n+        setFrameBaseOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbetmBaseOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbetmLongHcOption buildFrameCbetmLongHcOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmHcOption(Map<Label, Object>) [start]\");\n+        FrameCbetmLongHcOption frame = new FrameCbetmLongHcOption();\n+        setCbetmCommonFrameFields(frame, frameValues);\n+        setFrameHcOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbetmHcOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbetmLongEjpOption buildFrameCbetmLongEjpOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmEjpOption(Map<Label, Object>) [start]\");\n+        FrameCbetmLongEjpOption frame = new FrameCbetmLongEjpOption();\n+        setCbetmCommonFrameFields(frame, frameValues);\n+        setFrameEjpOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbetmEjpOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbetmLongTempoOption buildFrameCbetmLongTempoOption(final Map<Label, Object> frameValues,\n+            ProgrammeCircuit1 prgCircuit1, ProgrammeCircuit2 prgCircuit2) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmTempoOption(Map<Label, Object>) [start]\");\n+        FrameCbetmLongTempoOption frame = new FrameCbetmLongTempoOption();\n+        setCbetmCommonFrameFields(frame, frameValues);\n+        setFrameTempoOptionFields(frame, frameValues, prgCircuit1, prgCircuit2);\n+        logger.trace(\"buildFrameCbetmTempoOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbetmShort buildFrameCbetmShort(final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbetmShort(Map<Label, Object>) [start]\");\n+        FrameCbetmShort frame = new FrameCbetmShort();\n+        frame.setAdco(getRequiredLabelValue(Label.ADCO, String.class, frameValues));\n+        frame.setIinst1(getRequiredLabelValue(Label.IINST1, Integer.class, frameValues));\n+        frame.setIinst2(getRequiredLabelValue(Label.IINST2, Integer.class, frameValues));\n+        frame.setIinst3(getRequiredLabelValue(Label.IINST3, Integer.class, frameValues));\n+        frame.setAdir1(getOptionalLabelValue(Label.ADIR1, Integer.class, frameValues));\n+        frame.setAdir2(getOptionalLabelValue(Label.ADIR2, Integer.class, frameValues));\n+        frame.setAdir3(getOptionalLabelValue(Label.ADIR3, Integer.class, frameValues));\n+        logger.trace(\"buildFrameCbetmShort(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemm buildFrameCbemm(final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemm(Map<Label, Object>) [start]\");\n+        final FrameCbemm frameCbemm;\n+        String optionTarif = getRequiredLabelValue(Label.OPTARIF, String.class, frameValues);\n+        if (\"BASE\".equals(optionTarif)) {\n+            frameCbemm = buildFrameCbemmBaseOption(frameValues);\n+        } else if (\"HC..\".equals(optionTarif)) {\n+            frameCbemm = buildFrameCbemmHcOption(frameValues);\n+        } else if (\"EJP.\".equals(optionTarif)) {\n+            frameCbemm = buildFrameCbemmEjpOption(frameValues);\n+        } else if (optionTarif.startsWith(\"BBR\") && optionTarif.length() == 4) {\n+            ProgrammeCircuit1 prgCircuit1 = convertProgrammeCircuit1(optionTarif.charAt(3));\n+            ProgrammeCircuit2 prgCircuit2 = convertProgrammeCircuit2(optionTarif.charAt(3));\n+            frameCbemm = buildFrameCbemmTempoOption(frameValues, prgCircuit1, prgCircuit2);\n+        } else {\n+            final String error = String.format(\"The option Tarif '%s' is not supported\", optionTarif);\n+            throw new InvalidFrameException(error);\n+        }\n+        logger.trace(\"buildFrameCbemm(Map<Label, Object>) [end]\");\n+        return frameCbemm;\n+    }\n+\n+    private void setCbemmCommonFrameFields(final FrameCbemm frame, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setCbemmCommonFrameFields(Frame, Map<Label, Object>) [start]\");\n+        frame.setAdco(getRequiredLabelValue(Label.ADCO, String.class, frameValues));\n+        frame.setIsousc(getRequiredLabelValue(Label.ISOUSC, Integer.class, frameValues));\n+        frame.setIinst(getRequiredLabelValue(Label.IINST, Integer.class, frameValues));\n+        frame.setImax(getOptionalLabelValue(Label.IMAX, Integer.class, frameValues));\n+        frame.setPtec(getRequiredLabelValue(Label.PTEC, Ptec.class, frameValues));\n+        frame.setAdps(getOptionalLabelValue(Label.ADPS, Integer.class, frameValues));\n+        frame.setMotdetat(getRequiredLabelValue(Label.MOTDETAT, String.class, frameValues));\n+        logger.trace(\"setCbemmCommonFrameFields(Frame, Map<Label, Object>) [end]\");\n+    }\n+\n+    private FrameCbemmBaseOption buildFrameCbemmBaseOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmBaseOption(Map<Label, Object>) [start]\");\n+        FrameCbemmBaseOption frame = new FrameCbemmBaseOption();\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        setFrameBaseOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmBaseOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmHcOption buildFrameCbemmHcOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmHcOption(Map<Label, Object>) [start]\");\n+        FrameCbemmHcOption frame = new FrameCbemmHcOption();\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        setFrameHcOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmHcOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEjpOption buildFrameCbemmEjpOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEjpOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEjpOption frame = new FrameCbemmEjpOption();\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        setFrameEjpOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmEjpOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmTempoOption buildFrameCbemmTempoOption(final Map<Label, Object> frameValues,\n+            ProgrammeCircuit1 prgCircuit1, ProgrammeCircuit2 prgCircuit2) throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmTempoOption(Map<Label, Object>) [start]\");\n+        FrameCbemmTempoOption frame = new FrameCbemmTempoOption();\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        setFrameTempoOptionFields(frame, frameValues, prgCircuit1, prgCircuit2);\n+        logger.trace(\"buildFrameCbemmTempoOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEvolutionIcc buildFrameCbemmEvolutionIcc(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIcc(Map<Label, Object>) [start]\");\n+        final FrameCbemmEvolutionIcc frameCbemmEvoIcc;\n+        String optionTarif = getRequiredLabelValue(Label.OPTARIF, String.class, frameValues);\n+        if (\"BASE\".equals(optionTarif)) {\n+            frameCbemmEvoIcc = buildFrameCbemmEvolutionIccBaseOption(frameValues);\n+        } else if (\"HC..\".equals(optionTarif)) {\n+            frameCbemmEvoIcc = buildFrameCbemmEvolutionIccHcOption(frameValues);\n+        } else if (\"EJP.\".equals(optionTarif)) {\n+            frameCbemmEvoIcc = buildFrameCbemmEvolutionIccEjpOption(frameValues);\n+        } else if (optionTarif.startsWith(\"BBR\") && optionTarif.length() == 4) {\n+            ProgrammeCircuit1 prgCircuit1 = convertProgrammeCircuit1(optionTarif.charAt(3));\n+            ProgrammeCircuit2 prgCircuit2 = convertProgrammeCircuit2(optionTarif.charAt(3));\n+            frameCbemmEvoIcc = buildFrameCbemmEvolutionIccTempoOption(frameValues, prgCircuit1, prgCircuit2);\n+        } else {\n+            final String error = String.format(\"The option Tarif '%s' is not supported\", optionTarif);\n+            throw new InvalidFrameException(error);\n+        }\n+\n+        logger.trace(\"buildFrameCbemmEvolutionIcc(Map<Label, Object>) [end]\");\n+        return frameCbemmEvoIcc;\n+    }\n+\n+    private void setCbemmEvolutionIccCommonFrameFields(final FrameCbemmEvolutionIcc frame,\n+            final Map<Label, Object> frameValues) throws InvalidFrameException {\n+        logger.trace(\"setCbemmEvolutionIccCommonFrameFields(Frame, Map<Label, Object>) [start]\");\n+        setCbemmCommonFrameFields(frame, frameValues);\n+        frame.setPapp(getRequiredLabelValue(Label.PAPP, Integer.class, frameValues));\n+        logger.trace(\"setCbemmEvolutionIccCommonFrameFields(Frame, Map<Label, Object>) [end]\");\n+    }\n+\n+    private FrameCbemmEvolutionIccBaseOption buildFrameCbemmEvolutionIccBaseOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIccBaseOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEvolutionIccBaseOption frame = new FrameCbemmEvolutionIccBaseOption();\n+        setCbemmEvolutionIccCommonFrameFields(frame, frameValues);\n+        setFrameBaseOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmEvolutionIccBaseOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEvolutionIccHcOption buildFrameCbemmEvolutionIccHcOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIccHcOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEvolutionIccHcOption frame = new FrameCbemmEvolutionIccHcOption();\n+        setCbemmEvolutionIccCommonFrameFields(frame, frameValues);\n+        setFrameHcOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmEvolutionIccHcOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEvolutionIccTempoOption buildFrameCbemmEvolutionIccTempoOption(\n+            final Map<Label, Object> frameValues, ProgrammeCircuit1 prgCircuit1, ProgrammeCircuit2 prgCircuit2)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIccTempoOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEvolutionIccTempoOption frame = new FrameCbemmEvolutionIccTempoOption();\n+        setCbemmEvolutionIccCommonFrameFields(frame, frameValues);\n+        setFrameTempoOptionFields(frame, frameValues, prgCircuit1, prgCircuit2);\n+        logger.trace(\"buildFrameCbemmEvolutionIccTempoOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private FrameCbemmEvolutionIccEjpOption buildFrameCbemmEvolutionIccEjpOption(final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"buildFrameCbemmEvolutionIccEjpOption(Map<Label, Object>) [start]\");\n+        FrameCbemmEvolutionIccEjpOption frame = new FrameCbemmEvolutionIccEjpOption();\n+        setCbemmEvolutionIccCommonFrameFields(frame, frameValues);\n+        setFrameEjpOptionFields(frame, frameValues);\n+        logger.trace(\"buildFrameCbemmEvolutionIccEjpOption(Map<Label, Object>) [end]\");\n+        return frame;\n+    }\n+\n+    private void setFrameBaseOptionFields(final FrameBaseOption frameBaseOption, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setFrameBaseOptionFields(FrameBaseOption) [start]\");\n+        frameBaseOption.setBase(getRequiredLabelValue(Label.BASE, Integer.class, frameValues));\n+        logger.trace(\"setFrameBaseOptionFields(FrameBaseOption) [end]\");\n+    }\n+\n+    private void setFrameHcOptionFields(final FrameHcOption frameHcOption, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setFrameHcOptionFields(FrameHcOption) [start]\");\n+        frameHcOption.setHchc(getRequiredLabelValue(Label.HCHC, Integer.class, frameValues));\n+        frameHcOption.setHchp(getRequiredLabelValue(Label.HCHP, Integer.class, frameValues));\n+        frameHcOption.setHhphc(getRequiredLabelValue(Label.HHPHC, Hhphc.class, frameValues));\n+        logger.trace(\"setFrameHcOptionFields(FrameHcOption) [end]\");\n+    }\n+\n+    private void setFrameEjpOptionFields(final FrameEjpOption frameEjpOption, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        logger.trace(\"setFrameEjpOptionFields(FrameEjpOption) [start]\");\n+        frameEjpOption.setEjphn(getRequiredLabelValue(Label.EJPHN, Integer.class, frameValues));\n+        frameEjpOption.setEjphpm(getRequiredLabelValue(Label.EJPHPM, Integer.class, frameValues));\n+        frameEjpOption.setPejp(getOptionalLabelValue(Label.PEJP, Integer.class, frameValues));\n+        logger.trace(\"setFrameEjpOptionFields(FrameEjpOption) [end]\");\n+    }\n+\n+    private void setFrameTempoOptionFields(final FrameTempoOption frameTempoOption,\n+            final Map<Label, Object> frameValues, ProgrammeCircuit1 prgCircuit1, ProgrammeCircuit2 prgCircuit2)\n+            throws InvalidFrameException {\n+        logger.trace(\"setFrameTempoOptionFields(FrameTempoOption) [start]\");\n+        frameTempoOption.setBbrhpjr(getRequiredLabelValue(Label.BBRHPJR, Integer.class, frameValues));\n+        frameTempoOption.setBbrhcjr(getRequiredLabelValue(Label.BBRHCJR, Integer.class, frameValues));\n+        frameTempoOption.setBbrhpjw(getRequiredLabelValue(Label.BBRHPJW, Integer.class, frameValues));\n+        frameTempoOption.setBbrhcjw(getRequiredLabelValue(Label.BBRHCJW, Integer.class, frameValues));\n+        frameTempoOption.setBbrhpjb(getRequiredLabelValue(Label.BBRHPJB, Integer.class, frameValues));\n+        frameTempoOption.setBbrhcjb(getRequiredLabelValue(Label.BBRHCJB, Integer.class, frameValues));\n+        frameTempoOption.setDemain(getOptionalLabelValue(Label.DEMAIN, CouleurDemain.class, frameValues));\n+        frameTempoOption.setHhphc(getRequiredLabelValue(Label.HHPHC, Hhphc.class, frameValues));\n+        frameTempoOption.setProgrammeCircuit1(prgCircuit1);\n+        frameTempoOption.setProgrammeCircuit2(prgCircuit2);\n+        logger.trace(\"setFrameTempoOptionFields(FrameTempoOption) [end]\");\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <T> T getRequiredLabelValue(Label label, Class<T> dataType, final Map<Label, Object> frameValues)\n+            throws InvalidFrameException {\n+        if (!frameValues.containsKey(label)) {\n+            final String error = String.format(\"The required label '%1$s' is missing in frame\", label);\n+            throw new InvalidFrameException(error);\n+        }\n+\n+        return (T) frameValues.get(label);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <T> T getOptionalLabelValue(Label label, Class<T> dataType, final Map<Label, Object> frameValues) {\n+        return (T) frameValues.get(label);\n+    }\n+\n+    private ProgrammeCircuit1 convertProgrammeCircuit1(char value) {\n+        String prgCircuit1 = computeProgrammeCircuitBinaryValue(value).substring(3, 5);\n+        switch (prgCircuit1) {\n+            case \"01\":\n+                return ProgrammeCircuit1.A;\n+            case \"10\":\n+                return ProgrammeCircuit1.B;\n+            case \"11\":\n+                return ProgrammeCircuit1.C;\n+            default:\n+                final String error = String.format(\"Programme circuit 1 '%s' is unknown\", prgCircuit1);\n+                throw new IllegalStateException(error);\n+        }\n+    }\n+\n+    private ProgrammeCircuit2 convertProgrammeCircuit2(char value) {\n+        String prgCircuit2 = computeProgrammeCircuitBinaryValue(value).substring(5, 8);\n+        switch (prgCircuit2) {\n+            case \"000\":\n+                return ProgrammeCircuit2.P0;\n+            case \"001\":\n+                return ProgrammeCircuit2.P1;\n+            case \"010\":\n+                return ProgrammeCircuit2.P2;\n+            case \"011\":\n+                return ProgrammeCircuit2.P3;\n+            case \"100\":\n+                return ProgrammeCircuit2.P4;\n+            case \"101\":\n+                return ProgrammeCircuit2.P5;\n+            case \"110\":\n+                return ProgrammeCircuit2.P6;\n+            case \"111\":\n+                return ProgrammeCircuit2.P7;\n+            default:\n+                final String error = String.format(\"Programme circuit 2 '%s' is unknown\", prgCircuit2);\n+                throw new IllegalStateException(error);\n+        }\n+    }\n+\n+    private String computeProgrammeCircuitBinaryValue(char value) {\n+        return StringUtils.leftPad(Integer.toBinaryString(value), 8, \"0\");", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1MjQ0NA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441852444", "bodyText": "Ok", "author": "nokyyz", "createdAt": "2020-06-17T21:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNzQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNjU3MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443126571", "bodyText": "Done with String.format(\"%8s\",Integer.toBinaryString(value)).replace(' ', '0')", "author": "olivierkeke", "createdAt": "2020-06-20T12:15:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNzQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzkxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441113915", "bodyText": "Do you want to enforce a timeout of BufferedReader.readLine() with this Callable? Isn't readLine() returning null, instead of blocking when using it with serial interfaces?", "author": "fwolter", "createdAt": "2020-06-16T20:12:36Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,682 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.UnsupportedEncodingException;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.reader.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.reader.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConvertionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME = 33400;\n+    public static long DEFAULT_TIMEOUT_READING_FRAME = 33400;\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader = null;\n+    private InputStream teleinfoInputStream = null;\n+    private String groupLine = null;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME, DEFAULT_TIMEOUT_READING_FRAME,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream not null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        try {\n+            this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, \"ASCII\"));\n+            this.teleinfoInputStream = teleinfoInputStream;\n+        } catch (UnsupportedEncodingException e) {\n+            throw new IllegalStateException(e);\n+        }\n+\n+        groupLine = null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        logger.debug(\"close() [start]\");\n+        bufferedReader.close();\n+        executorService.shutdownNow();\n+        super.close();\n+        logger.debug(\"close() [end]\");\n+    }\n+\n+    /**\n+     * Returns the next frame.\n+     *\n+     * @return the next frame or null if end of stream\n+     * @throws InvalidFrameException if the read data from\n+     * @throws TimeoutException if the delay to read a complete frame is expired (33,4 ms) or if the delay to find\n+     *             the\n+     *             header of next frame is expired (33,4 ms)\n+     * @throws IOException\n+     */\n+    public synchronized Frame readNextFrame() throws InvalidFrameException, TimeoutException, IOException {\n+        logger.debug(\"readNextFrame() [start]\");\n+\n+        // seek the next header frame\n+        Future<Void> seekNextHeaderFrameTask = executorService.submit(new Callable<Void>() {\n+            @Override\n+            public Void call() throws Exception {\n+                while (!isHeaderFrame(groupLine)) {\n+                    groupLine = bufferedReader.readLine();\n+                    if (logger.isTraceEnabled()) {\n+                        logger.trace(\"groupLine = {}\", groupLine);\n+                    }\n+                    if (groupLine == null) { // end of stream\n+                        logger.trace(\"end of stream reached !\");\n+                        return null;\n+                    }\n+                }\n+\n+                logger.trace(\"header frame found !\");\n+                return null;\n+            }\n+        });\n+        try {\n+            logger.debug(\"seeking the next header frame...\");\n+            logger.trace(\"waitNextHeaderFrameTimeoutInMs = {}\", waitNextHeaderFrameTimeoutInMs);\n+            seekNextHeaderFrameTask.get(waitNextHeaderFrameTimeoutInMs, TimeUnit.MICROSECONDS);", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1NDQzOA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441854438", "bodyText": "The Teleinfo protocol defines a timeout between two frames", "author": "nokyyz", "createdAt": "2020-06-17T21:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NTk5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443155993", "bodyText": "If I see correctly the timeout is 33.4ms and you multiplied it with 100. So, the code in the Callable is interrupted after 3.3sec.. But I think the timeout never kicks in, since the timeout of the serial port is set to 250ms in TeleinfoSerialControllerHandler:177. So, you could remove the sumbit()s and execute the code directly.", "author": "fwolter", "createdAt": "2020-06-20T19:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE2MzUwNA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443163504", "bodyText": "The Teleinfo protocol defines this timeout to 33.4ms, but with this default timeout, the binding throws always timeout errors. That's why, I have override the timeout to 3,34 s.\nI had imagined setting this timeout to be configurable so that the user can overload the official timeout (33,4ms), but I am afraid that a new user does not think of modifying this parameter if errors occurred and that the user experience is very bad.\nThe timeout of the serial port (250ms) and this timeout are different. You could receive data between end of frame and start of frame due to, for example, hardware issues. In this case, the timeout of serial port will never be triggered when the delay could be triggered", "author": "nokyyz", "createdAt": "2020-06-20T22:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDU2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443194562", "bodyText": "I agree with you that 33ms is too short for the JVM to handle it correctly and that the timeout shouldn't be configureable by the user. I guess you mean loose contact or so, that the serial port detects data continuously, where is no data. This case should be very rare, since you have a parity bit, so garbage will be dropped at operating system driver level. Is a correct communication possible at all, in this case?", "author": "fwolter", "createdAt": "2020-06-21T08:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMzkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNTI1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441115252", "bodyText": "Typo", "author": "fwolter", "createdAt": "2020-06-16T20:15:20Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/serialport/ConvertionException.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io.serialport;\n+\n+/**\n+ * The {@link ConvertionException} class defines a conversion exception.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class ConvertionException extends Exception {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1NDg0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441854843", "bodyText": "Lol. Ok", "author": "nokyyz", "createdAt": "2020-06-17T21:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNTI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNjQ0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441116441", "bodyText": "Could you add the NonNullByDefault annotation?", "author": "fwolter", "createdAt": "2020-06-16T20:17:39Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/serialport/Label.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io.serialport;\n+\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.reader.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.reader.common.Ptec;\n+\n+/**\n+ * The {@link Label} enum defines all Teleinfo labels and their format.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public enum Label {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1NjQ3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441856477", "bodyText": "@fwolter what benefits of this annotation?", "author": "nokyyz", "createdAt": "2020-06-17T21:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNjQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NjQ2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443156462", "bodyText": "You get free null checks at compile time. In this case you \"see\" (without annotation) that there won't be any null dereferences. However, it doesn't hurt adding it. It's required by the coding guidelines https://www.openhab.org/docs/developer/guidelines.html#null-annotations", "author": "fwolter", "createdAt": "2020-06-20T20:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNjQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExODAwOA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441118008", "bodyText": "Does this work when using more than one bridge with a different serial port? Or with other applications beside openHAB?", "author": "fwolter", "createdAt": "2020-06-16T20:20:43Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/serialport/TeleinfoSerialportReader.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io.serialport;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.UUID;\n+\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.TeleinfoReader;\n+import org.openhab.binding.teleinfo.internal.reader.TeleinfoReaderAdaptor;\n+import org.openhab.binding.teleinfo.internal.reader.TeleinfoReaderListener;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import gnu.io.CommPortIdentifier;\n+import gnu.io.NoSuchPortException;\n+import gnu.io.PortInUseException;\n+import gnu.io.RXTXPort;\n+import gnu.io.SerialPort;\n+import gnu.io.UnsupportedCommOperationException;\n+\n+/**\n+ * The {@link TeleinfoSerialportReader} class defines the Serial port implementation of {@link TeleinfoReader}.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialportReader extends TeleinfoReaderAdaptor {\n+\n+    private static Logger logger = LoggerFactory.getLogger(TeleinfoSerialportReader.class);\n+\n+    private String serialPortName;\n+    private long refreshInterval;\n+\n+    private Timer teleinfoSerialportReaderTimer;\n+    private SerialPort serialPort;\n+    private long waitNextHeaderFrameTimeoutInMs = TeleinfoInputStream.DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME;\n+    private long readingFrameTimeoutInMs = TeleinfoInputStream.DEFAULT_TIMEOUT_READING_FRAME;\n+\n+    public TeleinfoSerialportReader(String serialPortName, long refreshInterval) {\n+        this.serialPortName = serialPortName;\n+        this.refreshInterval = refreshInterval;\n+    }\n+\n+    @Override\n+    public void open() throws IOException {\n+        logger.debug(\"open() [start]\");\n+\n+        CommPortIdentifier portIdentifier;\n+        try {\n+            logger.trace(\"serialPortName = {}\", serialPortName);\n+            System.setProperty(\"gnu.io.rxtx.SerialPorts\", serialPortName); // Workaround to force serial port detection\n+                                                                           // on Linux", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1ODgyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441858825", "bodyText": "This code line is copy-paste from Zwave binding", "author": "nokyyz", "createdAt": "2020-06-17T22:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExODAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NjY1MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443156651", "bodyText": "Can't find it in the zwave binding. Maybe the bug is fixed already. I found this: openhab/openhab-core#805", "author": "fwolter", "createdAt": "2020-06-20T20:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExODAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMzY5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441123697", "bodyText": "This class is never used in your binding?", "author": "fwolter", "createdAt": "2020-06-16T20:31:13Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/serialport/TeleinfoSerialportReader.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io.serialport;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.UUID;\n+\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.TeleinfoReader;\n+import org.openhab.binding.teleinfo.internal.reader.TeleinfoReaderAdaptor;\n+import org.openhab.binding.teleinfo.internal.reader.TeleinfoReaderListener;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import gnu.io.CommPortIdentifier;\n+import gnu.io.NoSuchPortException;\n+import gnu.io.PortInUseException;\n+import gnu.io.RXTXPort;\n+import gnu.io.SerialPort;\n+import gnu.io.UnsupportedCommOperationException;\n+\n+/**\n+ * The {@link TeleinfoSerialportReader} class defines the Serial port implementation of {@link TeleinfoReader}.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialportReader extends TeleinfoReaderAdaptor {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1OTQ3OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441859478", "bodyText": "Deprecated code. To delete", "author": "nokyyz", "createdAt": "2020-06-17T22:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMzY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNTkzMA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441125930", "bodyText": "Can you reference which bug you are working around? e.g. Stackoverflow post.", "author": "fwolter", "createdAt": "2020-06-16T20:35:13Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoReceiveThread.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import java.io.IOException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoReceiveThread} class defines a thread to decode and fire Teleinfo frames for Serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoReceiveThread extends Thread implements SerialPortEventListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoReceiveThread.class);\n+\n+    private SerialPort serialPort;\n+    private TeleinfoReceiveThreadListener listener;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    public TeleinfoReceiveThread(SerialPort serialPort, @NonNull final TeleinfoReceiveThreadListener listener,\n+            boolean autoRepairInvalidADPSgroupLine) {\n+        super(\"TeleinfoReceiveThread\");\n+\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+    }\n+\n+    @Override\n+    public void serialEvent(SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1OTc2MA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441859760", "bodyText": "This code line is copy-paste from Zwave binding. No more information of this issue", "author": "nokyyz", "createdAt": "2020-06-17T22:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1OTA4Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443159087", "bodyText": "If that relates to NeuronRobotics/nrjavaserial#22 it seems to be fixed. @wborn Do you know if this is the workaround for that bug?", "author": "fwolter", "createdAt": "2020-06-20T20:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNjgxNg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441126816", "bodyText": "Can this method be removed?", "author": "fwolter", "createdAt": "2020-06-16T20:36:51Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoReceiveThread.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import java.io.IOException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoReceiveThread} class defines a thread to decode and fire Teleinfo frames for Serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoReceiveThread extends Thread implements SerialPortEventListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoReceiveThread.class);\n+\n+    private SerialPort serialPort;\n+    private TeleinfoReceiveThreadListener listener;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    public TeleinfoReceiveThread(SerialPort serialPort, @NonNull final TeleinfoReceiveThreadListener listener,\n+            boolean autoRepairInvalidADPSgroupLine) {\n+        super(\"TeleinfoReceiveThread\");\n+\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+    }\n+\n+    @Override\n+    public void serialEvent(SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (InterruptedException e) {\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        logger.debug(\"Starting Teleinfo thread: Receive\");\n+        try (TeleinfoInputStream teleinfoStream = new TeleinfoInputStream(serialPort.getInputStream(),\n+                TeleinfoInputStream.DEFAULT_TIMEOUT_WAIT_NEXT_HEADER_FRAME * 100,\n+                TeleinfoInputStream.DEFAULT_TIMEOUT_READING_FRAME * 100, autoRepairInvalidADPSgroupLine)) {\n+            while (!interrupted()) {\n+                try {\n+                    Frame nextFrame = teleinfoStream.readNextFrame();\n+                    listener.onFrameReceived(this, nextFrame);\n+                } catch (InvalidFrameException e) {\n+                    logger.error(\"Got invalid frame. Detail: \\\"{}\\\"\", e.getLocalizedMessage());\n+                    listener.onInvalidFrameReceived(this, e);\n+                } catch (TimeoutException e) {\n+                    logger.error(\"Got timeout during frame reading\", e);\n+                    if (!listener.continueOnReadNextFrameTimeoutException(this, e)) {\n+                        break;\n+                    }\n+                    // skipInputStreamBuffer();\n+                } catch (IOException e) {\n+                    logger.error(\"Got I/O exception. Detail: \\\"{}\\\"\", e.getLocalizedMessage(), e);\n+                    listener.onSerialPortInputStreamIOException(this, e);\n+                    break;\n+                }\n+            }\n+        } catch (IOException e) {\n+            logger.error(\"An error occurred during serial port input stream opening\", e);\n+        }\n+\n+        logger.debug(\"Terminates Teleinfo receive thread\");\n+\n+        serialPort.removeEventListener();\n+    }\n+\n+    public TeleinfoReceiveThreadListener getListener() {\n+        return listener;\n+    }\n+\n+    public void setListener(TeleinfoReceiveThreadListener listener) {\n+        this.listener = listener;\n+    }\n+\n+    @SuppressWarnings(\"null\")\n+    private void skipInputStreamBuffer() throws IOException {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg2MDI3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441860275", "bodyText": "Ok (deprecated code)", "author": "nokyyz", "createdAt": "2020-06-17T22:05:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNjgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNzQ0Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441127446", "bodyText": "See above", "author": "fwolter", "createdAt": "2020-06-16T20:37:58Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyODEwOA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441128108", "bodyText": "This creates a new thread. Can you use openHAB's threadpool instead by using the field scheduler?", "author": "fwolter", "createdAt": "2020-06-16T20:39:14Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");\n+        invalidFrameCounter = 0;\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        openSerialPortAndStartReceiving();\n+\n+        keepAliveThread = new Timer(\"Teleinfo-KeepAliveThread-timer\", true);", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg2MTE4Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441861187", "bodyText": "@fwolter have you an example?", "author": "nokyyz", "createdAt": "2020-06-17T22:08:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyODEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NjgzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443156839", "bodyText": "Sure:\nhttps://github.com/openhab/org.openhab.binding.zwave/blob/2.5.x/src/main/java/org/openhab/binding/zwave/handler/ZWaveSerialHandler.java#L95", "author": "fwolter", "createdAt": "2020-06-20T20:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyODEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE2Mzc0MA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r443163740", "bodyText": "Thanks !", "author": "nokyyz", "createdAt": "2020-06-20T22:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyODEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyODgxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441128813", "bodyText": "Can this be scheduleWithFixedDelay()? See https://www.openhab.org/docs/developer/guidelines.html#e-runtime-behavior", "author": "fwolter", "createdAt": "2020-06-16T20:40:30Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");\n+        invalidFrameCounter = 0;\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        openSerialPortAndStartReceiving();\n+\n+        keepAliveThread = new Timer(\"Teleinfo-KeepAliveThread-timer\", true);\n+        keepAliveThread.scheduleAtFixedRate(new TimerTask() {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyOTQ3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441129475", "bodyText": "This should be debug", "author": "fwolter", "createdAt": "2020-06-16T20:41:55Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");\n+        invalidFrameCounter = 0;\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        openSerialPortAndStartReceiving();\n+\n+        keepAliveThread = new Timer(\"Teleinfo-KeepAliveThread-timer\", true);\n+        keepAliveThread.scheduleAtFixedRate(new TimerTask() {\n+            @Override\n+            public void run() {\n+                logger.debug(\"Check Teleinfo receiveThread status...\");\n+                logger.debug(\"isInitialized() = {}\", isInitialized());\n+                if (receiveThread != null) {\n+                    logger.debug(\"receiveThread.isAlive() = {}\", receiveThread.isAlive());\n+                }\n+                if (isInitialized() && (receiveThread == null || (receiveThread != null && !receiveThread.isAlive()))) {\n+                    updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                    logger.info(\"Try to restart Teleinfo receiving...\");\n+                    stopReceivingAndCloseSerialPort();\n+                    openSerialPortAndStartReceiving();\n+                }\n+            }\n+        }, 60000, 60000);\n+\n+        if (ThingStatus.OFFLINE.equals(getThing().getStatus())) {\n+            logger.info(\"Teleinfo Serial is initialized, but the bridge is currently OFFLINE due to errors\");", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyOTYwMg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441129602", "bodyText": "This is already logged by the framework. See above.", "author": "fwolter", "createdAt": "2020-06-16T20:42:12Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");\n+        invalidFrameCounter = 0;\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        openSerialPortAndStartReceiving();\n+\n+        keepAliveThread = new Timer(\"Teleinfo-KeepAliveThread-timer\", true);\n+        keepAliveThread.scheduleAtFixedRate(new TimerTask() {\n+            @Override\n+            public void run() {\n+                logger.debug(\"Check Teleinfo receiveThread status...\");\n+                logger.debug(\"isInitialized() = {}\", isInitialized());\n+                if (receiveThread != null) {\n+                    logger.debug(\"receiveThread.isAlive() = {}\", receiveThread.isAlive());\n+                }\n+                if (isInitialized() && (receiveThread == null || (receiveThread != null && !receiveThread.isAlive()))) {\n+                    updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                    logger.info(\"Try to restart Teleinfo receiving...\");\n+                    stopReceivingAndCloseSerialPort();\n+                    openSerialPortAndStartReceiving();\n+                }\n+            }\n+        }, 60000, 60000);\n+\n+        if (ThingStatus.OFFLINE.equals(getThing().getStatus())) {\n+            logger.info(\"Teleinfo Serial is initialized, but the bridge is currently OFFLINE due to errors\");\n+        } else {\n+            logger.info(\"Teleinfo Serial is initialized\");", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzMDQ3NA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441130474", "bodyText": "See above. dispose() can be invoked now and will throw a null pointer exception, because keepAliveThread is still null.", "author": "fwolter", "createdAt": "2020-06-16T20:43:52Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");\n+        invalidFrameCounter = 0;\n+        updateStatus(ThingStatus.UNKNOWN);", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzMTY0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441131643", "bodyText": "Apache Commons", "author": "fwolter", "createdAt": "2020-06-16T20:46:02Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");\n+        invalidFrameCounter = 0;\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        openSerialPortAndStartReceiving();\n+\n+        keepAliveThread = new Timer(\"Teleinfo-KeepAliveThread-timer\", true);\n+        keepAliveThread.scheduleAtFixedRate(new TimerTask() {\n+            @Override\n+            public void run() {\n+                logger.debug(\"Check Teleinfo receiveThread status...\");\n+                logger.debug(\"isInitialized() = {}\", isInitialized());\n+                if (receiveThread != null) {\n+                    logger.debug(\"receiveThread.isAlive() = {}\", receiveThread.isAlive());\n+                }\n+                if (isInitialized() && (receiveThread == null || (receiveThread != null && !receiveThread.isAlive()))) {\n+                    updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                    logger.info(\"Try to restart Teleinfo receiving...\");\n+                    stopReceivingAndCloseSerialPort();\n+                    openSerialPortAndStartReceiving();\n+                }\n+            }\n+        }, 60000, 60000);\n+\n+        if (ThingStatus.OFFLINE.equals(getThing().getStatus())) {\n+            logger.info(\"Teleinfo Serial is initialized, but the bridge is currently OFFLINE due to errors\");\n+        } else {\n+            logger.info(\"Teleinfo Serial is initialized\");\n+        }\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        logger.info(\"Teleinfo Serial is stopping...\");\n+        keepAliveThread.cancel();\n+        keepAliveThread = null;\n+        stopReceivingAndCloseSerialPort();\n+        logger.info(\"Teleinfo Serial is stopped\");\n+\n+        super.dispose();\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoReceiveThread receiveThread, @NonNull Frame frame) {\n+        updateStatus(ThingStatus.ONLINE);\n+        fireOnFrameReceivedEvent(frame);\n+    }\n+\n+    @Override\n+    public void onInvalidFrameReceived(@NonNull TeleinfoReceiveThread receiveThread,\n+            @NonNull InvalidFrameException error) {\n+        invalidFrameCounter++;\n+        updateState(THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER, new DecimalType(invalidFrameCounter));\n+    }\n+\n+    @Override\n+    public void onSerialPortInputStreamIOException(@NonNull TeleinfoReceiveThread receiveThread,\n+            @NonNull IOException e) {\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+    }\n+\n+    @Override\n+    public boolean continueOnReadNextFrameTimeoutException(@NonNull TeleinfoReceiveThread receiveThread,\n+            @NonNull TimeoutException e) {\n+        logger.warn(\"Retry in progress. Next retry in {} seconds...\", SERIAL_PORT_DELAY_RETRY_IN_SECONDS);\n+        updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+        try {\n+            Thread.sleep(SERIAL_PORT_DELAY_RETRY_IN_SECONDS * 1000);\n+            return true;\n+        } catch (InterruptedException e1) {\n+            return false;\n+        }\n+    }\n+\n+    private void openSerialPortAndStartReceiving() {\n+        logger.debug(\"startReceiving [start]\");\n+\n+        config = getConfigAs(TeleinfoSerialControllerConfiguration.class);\n+\n+        if (config.serialport == null || StringUtils.isBlank(config.serialport)) {", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzMjc0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441132742", "bodyText": "This should be executed in a scheduler thread, since initialize() is supposed to return fast.", "author": "fwolter", "createdAt": "2020-06-16T20:48:12Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");\n+        invalidFrameCounter = 0;\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        openSerialPortAndStartReceiving();", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNDQwOA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441134408", "bodyText": "Logging to error should only be done if some fatal error has occured. Nevertheless, the framework already logs the state change of the Thing. So, this would result in logging it twice. You could remove it.", "author": "fwolter", "createdAt": "2020-06-16T20:51:28Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private org.eclipse.smarthome.io.transport.serial.SerialPort serialPort;\n+    private TeleinfoReceiveThread receiveThread;\n+    private Timer keepAliveThread;\n+    private @Nullable TeleinfoSerialControllerConfiguration config;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(@NonNull Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.info(\"Initializing Teleinfo Serial controller\");\n+        invalidFrameCounter = 0;\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        openSerialPortAndStartReceiving();\n+\n+        keepAliveThread = new Timer(\"Teleinfo-KeepAliveThread-timer\", true);\n+        keepAliveThread.scheduleAtFixedRate(new TimerTask() {\n+            @Override\n+            public void run() {\n+                logger.debug(\"Check Teleinfo receiveThread status...\");\n+                logger.debug(\"isInitialized() = {}\", isInitialized());\n+                if (receiveThread != null) {\n+                    logger.debug(\"receiveThread.isAlive() = {}\", receiveThread.isAlive());\n+                }\n+                if (isInitialized() && (receiveThread == null || (receiveThread != null && !receiveThread.isAlive()))) {\n+                    updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                    logger.info(\"Try to restart Teleinfo receiving...\");\n+                    stopReceivingAndCloseSerialPort();\n+                    openSerialPortAndStartReceiving();\n+                }\n+            }\n+        }, 60000, 60000);\n+\n+        if (ThingStatus.OFFLINE.equals(getThing().getStatus())) {\n+            logger.info(\"Teleinfo Serial is initialized, but the bridge is currently OFFLINE due to errors\");\n+        } else {\n+            logger.info(\"Teleinfo Serial is initialized\");\n+        }\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        logger.info(\"Teleinfo Serial is stopping...\");\n+        keepAliveThread.cancel();\n+        keepAliveThread = null;\n+        stopReceivingAndCloseSerialPort();\n+        logger.info(\"Teleinfo Serial is stopped\");\n+\n+        super.dispose();\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoReceiveThread receiveThread, @NonNull Frame frame) {\n+        updateStatus(ThingStatus.ONLINE);\n+        fireOnFrameReceivedEvent(frame);\n+    }\n+\n+    @Override\n+    public void onInvalidFrameReceived(@NonNull TeleinfoReceiveThread receiveThread,\n+            @NonNull InvalidFrameException error) {\n+        invalidFrameCounter++;\n+        updateState(THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER, new DecimalType(invalidFrameCounter));\n+    }\n+\n+    @Override\n+    public void onSerialPortInputStreamIOException(@NonNull TeleinfoReceiveThread receiveThread,\n+            @NonNull IOException e) {\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+    }\n+\n+    @Override\n+    public boolean continueOnReadNextFrameTimeoutException(@NonNull TeleinfoReceiveThread receiveThread,\n+            @NonNull TimeoutException e) {\n+        logger.warn(\"Retry in progress. Next retry in {} seconds...\", SERIAL_PORT_DELAY_RETRY_IN_SECONDS);\n+        updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+        try {\n+            Thread.sleep(SERIAL_PORT_DELAY_RETRY_IN_SECONDS * 1000);\n+            return true;\n+        } catch (InterruptedException e1) {\n+            return false;\n+        }\n+    }\n+\n+    private void openSerialPortAndStartReceiving() {\n+        logger.debug(\"startReceiving [start]\");\n+\n+        config = getConfigAs(TeleinfoSerialControllerConfiguration.class);\n+\n+        if (config.serialport == null || StringUtils.isBlank(config.serialport)) {\n+            logger.error(\"Teleinfo port is not set.\");\n+            return;\n+        }\n+\n+        logger.info(\"Connecting to serial port '{}'...\", config.serialport);\n+        String currentOwner = null;\n+        try {\n+            final SerialPortIdentifier portIdentifier = serialPortManager.getIdentifier(config.serialport);\n+            logger.debug(\"portIdentifier = {}\", portIdentifier);\n+            if (portIdentifier == null) {\n+                logger.error(\"No port identifier for '{}'\", config.serialport);\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                        ERROR_OFFLINE_SERIAL_NOT_FOUND);\n+                return;\n+            }\n+            logger.debug(\"Opening portIdentifier\");\n+            currentOwner = portIdentifier.getCurrentOwner();\n+            logger.debug(\"portIdentifier.getCurrentOwner() = {}\", currentOwner);\n+            SerialPort commPort = portIdentifier.open(\"org.openhab.binding.teleinfo\", 5000);\n+            serialPort = commPort;\n+\n+            serialPort.setSerialPortParams(1200, SerialPort.DATABITS_7, SerialPort.STOPBITS_1, SerialPort.PARITY_EVEN);\n+            serialPort.enableReceiveThreshold(1);\n+            serialPort.enableReceiveTimeout(SERIAL_RECEIVE_TIMEOUT);\n+            logger.debug(\"Starting receive thread\");\n+            receiveThread = new TeleinfoReceiveThread(serialPort, this, config.autoRepairInvalidADPSgroupLine);\n+            receiveThread.start();\n+\n+            // RXTX serial port library causes high CPU load\n+            // Start event listener, which will just sleep and slow down event loop\n+            serialPort.addEventListener(receiveThread);\n+            serialPort.notifyOnDataAvailable(true);\n+            logger.info(\"Connected to serial port '{}'\", config.serialport);\n+        } catch (PortInUseException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    ERROR_OFFLINE_SERIAL_INUSE);\n+            logger.error(", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDY0Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r441154646", "bodyText": "Can you fix the usage of deprecated API?", "author": "fwolter", "createdAt": "2020-06-16T21:32:37Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/TeleinfoDiscoveryService.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.smarthome.config.discovery.AbstractDiscoveryService;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResult;\n+import org.eclipse.smarthome.config.discovery.DiscoveryResultBuilder;\n+import org.eclipse.smarthome.core.common.AbstractUID;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoControllerHandlerListener;\n+import org.openhab.binding.teleinfo.internal.reader.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.reader.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.reader.common.FrameAdco;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoDiscoveryService} class is the service to discover a skeleton for controller handlers.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+// @Component(service = DiscoveryService.class, immediate = false, configurationPid = \"discovery.teleinfo\")\n+public class TeleinfoDiscoveryService extends AbstractDiscoveryService implements TeleinfoControllerHandlerListener {\n+\n+    private final static Set<ThingTypeUID> SUPPORTED_THING_TYPES = Stream.of(THING_HC_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_ELECTRICITY_METER_TYPE_UID, THING_HC_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBEMM_EVO_ICC_ELECTRICITY_METER_TYPE_UID, THING_HC_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_BASE_CBETM_ELECTRICITY_METER_TYPE_UID, THING_TEMPO_CBETM_ELECTRICITY_METER_TYPE_UID,\n+            THING_EJP_CBETM_ELECTRICITY_METER_TYPE_UID).collect(Collectors.toSet());\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoDiscoveryService.class);\n+    private final TeleinfoAbstractControllerHandler controllerHandler;\n+\n+    public TeleinfoDiscoveryService(TeleinfoAbstractControllerHandler controllerHandler, int timeout) {\n+        super(timeout);\n+        this.controllerHandler = controllerHandler;\n+    }\n+\n+    @Override\n+    public Set<ThingTypeUID> getSupportedThingTypes() {\n+        return SUPPORTED_THING_TYPES;\n+    }\n+\n+    public void activate() {\n+        logger.debug(\"Teleinfo discovery: Active {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        logger.debug(\"Teleinfo discovery: Deactivate {}\", controllerHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        logger.debug(\"Teleinfo discovery: Start {}\", controllerHandler.getThing().getUID());\n+\n+        // Start the search for new devices\n+        controllerHandler.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void abortScan() {\n+        logger.debug(\"Teleinfo discovery: Abort {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.abortScan();\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        logger.debug(\"Teleinfo discovery: Stop {}\", controllerHandler.getThing().getUID());\n+        controllerHandler.removeListener(this);\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void onFrameReceived(@NonNull TeleinfoAbstractControllerHandler controllerHandler, @NonNull Frame frame) {\n+        detectNewElectricityMeterFromReceivedFrame(frame);\n+    }\n+\n+    private void detectNewElectricityMeterFromReceivedFrame(final Frame frameSample) {\n+        logger.debug(\"New eletricity meter detection from frame {}\", frameSample.getId());\n+        if (frameSample instanceof FrameAdco == false) {\n+            throw new IllegalStateException(\"Teleinfo frame type not supported: \" + frameSample.getClass());\n+        }\n+        final FrameAdco frameAdco = (FrameAdco) frameSample;\n+\n+        ThingUID thingUID = getThingUID(frameAdco);\n+\n+        final Map<String, Object> properties = getThingProperties(thingUID.getThingTypeUID(), frameAdco);", "originalCommit": "5eae65be047b51608937a2ad75000649066aa90e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE2NzQ2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449167462", "bodyText": "Can you make these all upper case and final?", "author": "fwolter", "createdAt": "2020-07-02T17:27:20Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,673 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.dto.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.dto.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConversionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long defaultTimeoutNextHeaderFrame = 33400;\n+    public static long defaultTimeoutReadingFrame = 33400;", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3Mjg1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449172856", "bodyText": "If I understand correctly, the tasks submitted to this executor will only block for 3,3sec.. Then, you should use openHAB's scheduler. The BaseThingHandlers have a scheduler field for this purpose.", "author": "fwolter", "createdAt": "2020-07-02T17:38:04Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,673 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.dto.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.dto.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConversionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long defaultTimeoutNextHeaderFrame = 33400;\n+    public static long defaultTimeoutReadingFrame = 33400;\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader;\n+    private @Nullable String groupLine;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2MTgzNg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449261836", "bodyText": "How can I get a BaseThingHandler at this place?", "author": "olivierkeke", "createdAt": "2020-07-02T20:55:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3Mjg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI4NjkzNw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449286937", "bodyText": "You could use this way: TeleinfoSerialControllerHandler -> TeleinfoReceiveThread -> TeleinfoInputStream", "author": "fwolter", "createdAt": "2020-07-02T22:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3Mjg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc2OTgzMg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449769832", "bodyText": "TeleinfoInputStream must be/stay independent of Openhab classes (= no openhab classes in imports section): this is an API. So, if you want set a different implementation of ExecutorService class (or equivalent), you must define a new constructor or add a setter with an ExecutorService parameter.", "author": "nokyyz", "createdAt": "2020-07-04T12:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3Mjg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNDcyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449914725", "bodyText": "Thanks! Done with a new constructor.", "author": "olivierkeke", "createdAt": "2020-07-05T20:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3Mjg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3MzM5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449173399", "bodyText": "You could make the method return the exception and throw it here. Then, the return can be removed.", "author": "fwolter", "createdAt": "2020-07-02T17:39:12Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,673 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.dto.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.dto.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConversionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long defaultTimeoutNextHeaderFrame = 33400;\n+    public static long defaultTimeoutReadingFrame = 33400;\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader;\n+    private @Nullable String groupLine;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, defaultTimeoutNextHeaderFrame, defaultTimeoutReadingFrame, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, defaultTimeoutNextHeaderFrame, defaultTimeoutReadingFrame,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n+\n+        groupLine = null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        logger.debug(\"close() [start]\");\n+        bufferedReader.close();\n+        executorService.shutdownNow();\n+        super.close();\n+        logger.debug(\"close() [end]\");\n+    }\n+\n+    /**\n+     * Returns the next frame.\n+     *\n+     * @return the next frame or null if end of stream\n+     * @throws InvalidFrameException if the read data from\n+     * @throws TimeoutException if the delay to read a complete frame is expired (33,4 ms) or if the delay to find\n+     *             the\n+     *             header of next frame is expired (33,4 ms)\n+     * @throws IOException\n+     */\n+    public synchronized @Nullable Frame readNextFrame() throws InvalidFrameException, TimeoutException, IOException {\n+\n+        // seek the next header frame\n+        Future<@Nullable Void> seekNextHeaderFrameTask = executorService.submit(() -> {\n+            while (!isHeaderFrame(groupLine)) {\n+                groupLine = bufferedReader.readLine();\n+                if (logger.isTraceEnabled()) {\n+                    logger.trace(\"groupLine = {}\", groupLine);\n+                }\n+                if (groupLine == null) { // end of stream\n+                    logger.trace(\"end of stream reached !\");\n+                    return null;\n+                }\n+            }\n+\n+            logger.trace(\"header frame found !\");\n+            return null;\n+        });\n+        try {\n+            logger.debug(\"seeking the next header frame...\");\n+            logger.trace(\"waitNextHeaderFrameTimeoutInMs = {}\", waitNextHeaderFrameTimeoutInMs);\n+            seekNextHeaderFrameTask.get(waitNextHeaderFrameTimeoutInMs, TimeUnit.MICROSECONDS);\n+\n+            if (groupLine == null) { // end of stream\n+                return null;\n+            }\n+        } catch (InterruptedException e) {\n+            throw new IllegalStateException(e);\n+        } catch (ExecutionException e) {\n+            rethrowTaskExecutionException(e);\n+            return null; // FIXME best way ?", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3MzgwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449173806", "bodyText": "The suffix Ms stands for milliseconds. Us would be microseconds.", "author": "fwolter", "createdAt": "2020-07-02T17:39:56Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,673 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.dto.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.dto.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConversionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long defaultTimeoutNextHeaderFrame = 33400;\n+    public static long defaultTimeoutReadingFrame = 33400;\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader;\n+    private @Nullable String groupLine;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, defaultTimeoutNextHeaderFrame, defaultTimeoutReadingFrame, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, defaultTimeoutNextHeaderFrame, defaultTimeoutReadingFrame,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n+\n+        groupLine = null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        logger.debug(\"close() [start]\");\n+        bufferedReader.close();\n+        executorService.shutdownNow();\n+        super.close();\n+        logger.debug(\"close() [end]\");\n+    }\n+\n+    /**\n+     * Returns the next frame.\n+     *\n+     * @return the next frame or null if end of stream\n+     * @throws InvalidFrameException if the read data from\n+     * @throws TimeoutException if the delay to read a complete frame is expired (33,4 ms) or if the delay to find\n+     *             the\n+     *             header of next frame is expired (33,4 ms)\n+     * @throws IOException\n+     */\n+    public synchronized @Nullable Frame readNextFrame() throws InvalidFrameException, TimeoutException, IOException {\n+\n+        // seek the next header frame\n+        Future<@Nullable Void> seekNextHeaderFrameTask = executorService.submit(() -> {\n+            while (!isHeaderFrame(groupLine)) {\n+                groupLine = bufferedReader.readLine();\n+                if (logger.isTraceEnabled()) {\n+                    logger.trace(\"groupLine = {}\", groupLine);\n+                }\n+                if (groupLine == null) { // end of stream\n+                    logger.trace(\"end of stream reached !\");\n+                    return null;\n+                }\n+            }\n+\n+            logger.trace(\"header frame found !\");\n+            return null;\n+        });\n+        try {\n+            logger.debug(\"seeking the next header frame...\");\n+            logger.trace(\"waitNextHeaderFrameTimeoutInMs = {}\", waitNextHeaderFrameTimeoutInMs);\n+            seekNextHeaderFrameTask.get(waitNextHeaderFrameTimeoutInMs, TimeUnit.MICROSECONDS);", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MDYxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449180613", "bodyText": "Bindings should only log to error if something severe happened, like the detection of a bug in your code. This could be warn or debug. Same for below.", "author": "fwolter", "createdAt": "2020-07-02T17:53:26Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoReceiveThread.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import java.io.IOException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoReceiveThread} class defines a thread to decode and fire Teleinfo frames for Serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoReceiveThread extends Thread {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoReceiveThread.class);\n+\n+    private SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThreadListener listener;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    public TeleinfoReceiveThread(SerialPort serialPort, final TeleinfoReceiveThreadListener listener,\n+            boolean autoRepairInvalidADPSgroupLine) {\n+        super(\"TeleinfoReceiveThread\");\n+\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+    }\n+\n+    @Override\n+    public void run() {\n+        try (TeleinfoInputStream teleinfoStream = new TeleinfoInputStream(serialPort.getInputStream(),\n+                TeleinfoInputStream.defaultTimeoutNextHeaderFrame * 100,\n+                TeleinfoInputStream.defaultTimeoutReadingFrame * 100, autoRepairInvalidADPSgroupLine)) {\n+            while (!interrupted()) {\n+                TeleinfoReceiveThreadListener listener = this.listener;\n+                if (listener != null) {\n+                    try {\n+                        Frame nextFrame = teleinfoStream.readNextFrame();\n+                        if (nextFrame != null)\n+                            listener.onFrameReceived(this, nextFrame);\n+                    } catch (InvalidFrameException e) {\n+                        logger.error(\"Got invalid frame. Detail: \\\"{}\\\"\", e.getLocalizedMessage());", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4NTI1OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449185259", "bodyText": "After the thing status is set to unknown, the framework starts to work with this Thing: handleCommand() and dispose() can be invoked (concurrently). When dispose() is invoked concurrently in this method, before the receiving thread has been created, it won't be stopped. The status should be set to unknown as one of the last actions.", "author": "fwolter", "createdAt": "2020-07-02T18:02:06Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private @Nullable SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThread receiveThread;\n+    private @Nullable ScheduledFuture<?> keepAliveThread;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        invalidFrameCounter = 0;\n+\n+        keepAliveThread = scheduler.scheduleWithFixedDelay(() -> {\n+            if (!isInitialized()) {\n+                updateStatus(ThingStatus.UNKNOWN);", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4NTg5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449185893", "bodyText": "Created threads should be daemon.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n                    setDaemon(true);", "author": "fwolter", "createdAt": "2020-07-02T18:03:30Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoReceiveThread.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import java.io.IOException;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoReceiveThread} class defines a thread to decode and fire Teleinfo frames for Serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoReceiveThread extends Thread {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoReceiveThread.class);\n+\n+    private SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThreadListener listener;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    public TeleinfoReceiveThread(SerialPort serialPort, final TeleinfoReceiveThreadListener listener,\n+            boolean autoRepairInvalidADPSgroupLine) {\n+        super(\"TeleinfoReceiveThread\");\n+", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4NjQwOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449186409", "bodyText": "No harm in cancelling a task that is already cancelled. The if can be removed.", "author": "fwolter", "createdAt": "2020-07-02T18:04:33Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private @Nullable SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThread receiveThread;\n+    private @Nullable ScheduledFuture<?> keepAliveThread;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        invalidFrameCounter = 0;\n+\n+        keepAliveThread = scheduler.scheduleWithFixedDelay(() -> {\n+            if (!isInitialized()) {\n+                updateStatus(ThingStatus.UNKNOWN);\n+                openSerialPortAndStartReceiving();\n+            }\n+            logger.debug(\"Check Teleinfo receiveThread status...\");\n+            logger.debug(\"isInitialized() = {}\", isInitialized());\n+            TeleinfoReceiveThread receiveThreadRef = receiveThread;\n+            if (receiveThreadRef != null) {\n+                logger.debug(\"receiveThread.isAlive() = {}\", receiveThreadRef.isAlive());\n+            }\n+            if (isInitialized() && (receiveThreadRef == null || !receiveThreadRef.isAlive())) {\n+                updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                logger.info(\"Try to restart Teleinfo receiving...\");\n+                stopReceivingAndCloseSerialPort();\n+                openSerialPortAndStartReceiving();\n+            }\n+        }, 0, 60, TimeUnit.SECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        ScheduledFuture<?> keepAliveThreadRef = keepAliveThread;\n+        if (keepAliveThreadRef != null) {\n+            if (!keepAliveThreadRef.isCancelled())", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4NzY2OA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449187668", "bodyText": "See above", "author": "fwolter", "createdAt": "2020-07-02T18:06:58Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private @Nullable SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThread receiveThread;\n+    private @Nullable ScheduledFuture<?> keepAliveThread;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        invalidFrameCounter = 0;\n+\n+        keepAliveThread = scheduler.scheduleWithFixedDelay(() -> {\n+            if (!isInitialized()) {\n+                updateStatus(ThingStatus.UNKNOWN);\n+                openSerialPortAndStartReceiving();\n+            }\n+            logger.debug(\"Check Teleinfo receiveThread status...\");\n+            logger.debug(\"isInitialized() = {}\", isInitialized());\n+            TeleinfoReceiveThread receiveThreadRef = receiveThread;\n+            if (receiveThreadRef != null) {\n+                logger.debug(\"receiveThread.isAlive() = {}\", receiveThreadRef.isAlive());\n+            }\n+            if (isInitialized() && (receiveThreadRef == null || !receiveThreadRef.isAlive())) {\n+                updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                logger.info(\"Try to restart Teleinfo receiving...\");\n+                stopReceivingAndCloseSerialPort();\n+                openSerialPortAndStartReceiving();\n+            }\n+        }, 0, 60, TimeUnit.SECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        ScheduledFuture<?> keepAliveThreadRef = keepAliveThread;\n+        if (keepAliveThreadRef != null) {\n+            if (!keepAliveThreadRef.isCancelled())\n+                keepAliveThreadRef.cancel(true);\n+            keepAliveThread = null;\n+        }\n+        stopReceivingAndCloseSerialPort();\n+\n+        super.dispose();\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void onFrameReceived(TeleinfoReceiveThread receiveThread, Frame frame) {\n+        updateStatus(ThingStatus.ONLINE);\n+        fireOnFrameReceivedEvent(frame);\n+    }\n+\n+    @Override\n+    public void onInvalidFrameReceived(TeleinfoReceiveThread receiveThread, InvalidFrameException error) {\n+        invalidFrameCounter++;\n+        updateState(THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER, new DecimalType(invalidFrameCounter));\n+    }\n+\n+    @Override\n+    public void onSerialPortInputStreamIOException(TeleinfoReceiveThread receiveThread, IOException e) {\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+    }\n+\n+    @Override\n+    public boolean continueOnReadNextFrameTimeoutException(TeleinfoReceiveThread receiveThread, TimeoutException e) {\n+        logger.warn(\"Retry in progress. Next retry in {} seconds...\", SERIAL_PORT_DELAY_RETRY_IN_SECONDS);\n+        updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+        try {\n+            Thread.sleep(SERIAL_PORT_DELAY_RETRY_IN_SECONDS * 1000);\n+            return true;\n+        } catch (InterruptedException e1) {\n+            return false;\n+        }\n+    }\n+\n+    private void openSerialPortAndStartReceiving() {\n+\n+        TeleinfoSerialControllerConfiguration config = getConfigAs(TeleinfoSerialControllerConfiguration.class);\n+\n+        if (config.serialport.trim().isEmpty()) {\n+            logger.error(\"Teleinfo port is not set.\");", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4Nzg4Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449187887", "bodyText": "info should be used very rarely. You could make this debug or trace.", "author": "fwolter", "createdAt": "2020-07-02T18:07:26Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private @Nullable SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThread receiveThread;\n+    private @Nullable ScheduledFuture<?> keepAliveThread;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        invalidFrameCounter = 0;\n+\n+        keepAliveThread = scheduler.scheduleWithFixedDelay(() -> {\n+            if (!isInitialized()) {\n+                updateStatus(ThingStatus.UNKNOWN);\n+                openSerialPortAndStartReceiving();\n+            }\n+            logger.debug(\"Check Teleinfo receiveThread status...\");\n+            logger.debug(\"isInitialized() = {}\", isInitialized());\n+            TeleinfoReceiveThread receiveThreadRef = receiveThread;\n+            if (receiveThreadRef != null) {\n+                logger.debug(\"receiveThread.isAlive() = {}\", receiveThreadRef.isAlive());\n+            }\n+            if (isInitialized() && (receiveThreadRef == null || !receiveThreadRef.isAlive())) {\n+                updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                logger.info(\"Try to restart Teleinfo receiving...\");\n+                stopReceivingAndCloseSerialPort();\n+                openSerialPortAndStartReceiving();\n+            }\n+        }, 0, 60, TimeUnit.SECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        ScheduledFuture<?> keepAliveThreadRef = keepAliveThread;\n+        if (keepAliveThreadRef != null) {\n+            if (!keepAliveThreadRef.isCancelled())\n+                keepAliveThreadRef.cancel(true);\n+            keepAliveThread = null;\n+        }\n+        stopReceivingAndCloseSerialPort();\n+\n+        super.dispose();\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void onFrameReceived(TeleinfoReceiveThread receiveThread, Frame frame) {\n+        updateStatus(ThingStatus.ONLINE);\n+        fireOnFrameReceivedEvent(frame);\n+    }\n+\n+    @Override\n+    public void onInvalidFrameReceived(TeleinfoReceiveThread receiveThread, InvalidFrameException error) {\n+        invalidFrameCounter++;\n+        updateState(THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER, new DecimalType(invalidFrameCounter));\n+    }\n+\n+    @Override\n+    public void onSerialPortInputStreamIOException(TeleinfoReceiveThread receiveThread, IOException e) {\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+    }\n+\n+    @Override\n+    public boolean continueOnReadNextFrameTimeoutException(TeleinfoReceiveThread receiveThread, TimeoutException e) {\n+        logger.warn(\"Retry in progress. Next retry in {} seconds...\", SERIAL_PORT_DELAY_RETRY_IN_SECONDS);\n+        updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+        try {\n+            Thread.sleep(SERIAL_PORT_DELAY_RETRY_IN_SECONDS * 1000);\n+            return true;\n+        } catch (InterruptedException e1) {\n+            return false;\n+        }\n+    }\n+\n+    private void openSerialPortAndStartReceiving() {\n+\n+        TeleinfoSerialControllerConfiguration config = getConfigAs(TeleinfoSerialControllerConfiguration.class);\n+\n+        if (config.serialport.trim().isEmpty()) {\n+            logger.error(\"Teleinfo port is not set.\");\n+            return;\n+        }\n+\n+        logger.info(\"Connecting to serial port '{}'...\", config.serialport);", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4ODQ4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449188489", "bodyText": "The message parameter of updateStatus() is logged by the framework. You could remove the log message.", "author": "fwolter", "createdAt": "2020-07-02T18:08:48Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private @Nullable SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThread receiveThread;\n+    private @Nullable ScheduledFuture<?> keepAliveThread;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        invalidFrameCounter = 0;\n+\n+        keepAliveThread = scheduler.scheduleWithFixedDelay(() -> {\n+            if (!isInitialized()) {\n+                updateStatus(ThingStatus.UNKNOWN);\n+                openSerialPortAndStartReceiving();\n+            }\n+            logger.debug(\"Check Teleinfo receiveThread status...\");\n+            logger.debug(\"isInitialized() = {}\", isInitialized());\n+            TeleinfoReceiveThread receiveThreadRef = receiveThread;\n+            if (receiveThreadRef != null) {\n+                logger.debug(\"receiveThread.isAlive() = {}\", receiveThreadRef.isAlive());\n+            }\n+            if (isInitialized() && (receiveThreadRef == null || !receiveThreadRef.isAlive())) {\n+                updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                logger.info(\"Try to restart Teleinfo receiving...\");\n+                stopReceivingAndCloseSerialPort();\n+                openSerialPortAndStartReceiving();\n+            }\n+        }, 0, 60, TimeUnit.SECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        ScheduledFuture<?> keepAliveThreadRef = keepAliveThread;\n+        if (keepAliveThreadRef != null) {\n+            if (!keepAliveThreadRef.isCancelled())\n+                keepAliveThreadRef.cancel(true);\n+            keepAliveThread = null;\n+        }\n+        stopReceivingAndCloseSerialPort();\n+\n+        super.dispose();\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void onFrameReceived(TeleinfoReceiveThread receiveThread, Frame frame) {\n+        updateStatus(ThingStatus.ONLINE);\n+        fireOnFrameReceivedEvent(frame);\n+    }\n+\n+    @Override\n+    public void onInvalidFrameReceived(TeleinfoReceiveThread receiveThread, InvalidFrameException error) {\n+        invalidFrameCounter++;\n+        updateState(THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER, new DecimalType(invalidFrameCounter));\n+    }\n+\n+    @Override\n+    public void onSerialPortInputStreamIOException(TeleinfoReceiveThread receiveThread, IOException e) {\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+    }\n+\n+    @Override\n+    public boolean continueOnReadNextFrameTimeoutException(TeleinfoReceiveThread receiveThread, TimeoutException e) {\n+        logger.warn(\"Retry in progress. Next retry in {} seconds...\", SERIAL_PORT_DELAY_RETRY_IN_SECONDS);\n+        updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+        try {\n+            Thread.sleep(SERIAL_PORT_DELAY_RETRY_IN_SECONDS * 1000);\n+            return true;\n+        } catch (InterruptedException e1) {\n+            return false;\n+        }\n+    }\n+\n+    private void openSerialPortAndStartReceiving() {\n+\n+        TeleinfoSerialControllerConfiguration config = getConfigAs(TeleinfoSerialControllerConfiguration.class);\n+\n+        if (config.serialport.trim().isEmpty()) {\n+            logger.error(\"Teleinfo port is not set.\");\n+            return;\n+        }\n+\n+        logger.info(\"Connecting to serial port '{}'...\", config.serialport);\n+        String currentOwner = null;\n+        try {\n+            final SerialPortIdentifier portIdentifier = serialPortManager.getIdentifier(config.serialport);\n+            logger.debug(\"portIdentifier = {}\", portIdentifier);\n+            if (portIdentifier == null) {\n+                logger.error(\"No port identifier for '{}'\", config.serialport);\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                        ERROR_OFFLINE_SERIAL_NOT_FOUND);", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4ODg0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449188841", "bodyText": "See above", "author": "fwolter", "createdAt": "2020-07-02T18:09:29Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private @Nullable SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThread receiveThread;\n+    private @Nullable ScheduledFuture<?> keepAliveThread;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        invalidFrameCounter = 0;\n+\n+        keepAliveThread = scheduler.scheduleWithFixedDelay(() -> {\n+            if (!isInitialized()) {\n+                updateStatus(ThingStatus.UNKNOWN);\n+                openSerialPortAndStartReceiving();\n+            }\n+            logger.debug(\"Check Teleinfo receiveThread status...\");\n+            logger.debug(\"isInitialized() = {}\", isInitialized());\n+            TeleinfoReceiveThread receiveThreadRef = receiveThread;\n+            if (receiveThreadRef != null) {\n+                logger.debug(\"receiveThread.isAlive() = {}\", receiveThreadRef.isAlive());\n+            }\n+            if (isInitialized() && (receiveThreadRef == null || !receiveThreadRef.isAlive())) {\n+                updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                logger.info(\"Try to restart Teleinfo receiving...\");\n+                stopReceivingAndCloseSerialPort();\n+                openSerialPortAndStartReceiving();\n+            }\n+        }, 0, 60, TimeUnit.SECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        ScheduledFuture<?> keepAliveThreadRef = keepAliveThread;\n+        if (keepAliveThreadRef != null) {\n+            if (!keepAliveThreadRef.isCancelled())\n+                keepAliveThreadRef.cancel(true);\n+            keepAliveThread = null;\n+        }\n+        stopReceivingAndCloseSerialPort();\n+\n+        super.dispose();\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void onFrameReceived(TeleinfoReceiveThread receiveThread, Frame frame) {\n+        updateStatus(ThingStatus.ONLINE);\n+        fireOnFrameReceivedEvent(frame);\n+    }\n+\n+    @Override\n+    public void onInvalidFrameReceived(TeleinfoReceiveThread receiveThread, InvalidFrameException error) {\n+        invalidFrameCounter++;\n+        updateState(THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER, new DecimalType(invalidFrameCounter));\n+    }\n+\n+    @Override\n+    public void onSerialPortInputStreamIOException(TeleinfoReceiveThread receiveThread, IOException e) {\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+    }\n+\n+    @Override\n+    public boolean continueOnReadNextFrameTimeoutException(TeleinfoReceiveThread receiveThread, TimeoutException e) {\n+        logger.warn(\"Retry in progress. Next retry in {} seconds...\", SERIAL_PORT_DELAY_RETRY_IN_SECONDS);\n+        updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+        try {\n+            Thread.sleep(SERIAL_PORT_DELAY_RETRY_IN_SECONDS * 1000);\n+            return true;\n+        } catch (InterruptedException e1) {\n+            return false;\n+        }\n+    }\n+\n+    private void openSerialPortAndStartReceiving() {\n+\n+        TeleinfoSerialControllerConfiguration config = getConfigAs(TeleinfoSerialControllerConfiguration.class);\n+\n+        if (config.serialport.trim().isEmpty()) {\n+            logger.error(\"Teleinfo port is not set.\");\n+            return;\n+        }\n+\n+        logger.info(\"Connecting to serial port '{}'...\", config.serialport);\n+        String currentOwner = null;\n+        try {\n+            final SerialPortIdentifier portIdentifier = serialPortManager.getIdentifier(config.serialport);\n+            logger.debug(\"portIdentifier = {}\", portIdentifier);\n+            if (portIdentifier == null) {\n+                logger.error(\"No port identifier for '{}'\", config.serialport);\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                        ERROR_OFFLINE_SERIAL_NOT_FOUND);\n+                return;\n+            }\n+            logger.debug(\"Opening portIdentifier\");\n+            currentOwner = portIdentifier.getCurrentOwner();\n+            logger.debug(\"portIdentifier.getCurrentOwner() = {}\", currentOwner);\n+            SerialPort commPort = portIdentifier.open(\"org.openhab.binding.teleinfo\", 5000);\n+            serialPort = commPort;\n+\n+            commPort.setSerialPortParams(1200, SerialPort.DATABITS_7, SerialPort.STOPBITS_1, SerialPort.PARITY_EVEN);\n+            commPort.enableReceiveThreshold(1);\n+            commPort.enableReceiveTimeout(SERIAL_RECEIVE_TIMEOUT);\n+            logger.debug(\"Starting receive thread\");\n+            TeleinfoReceiveThread receiveThread = new TeleinfoReceiveThread(commPort, this,\n+                    config.autoRepairInvalidADPSgroupLine);\n+            this.receiveThread = receiveThread;\n+            receiveThread.start();\n+\n+            logger.info(\"Connected to serial port '{}'\", config.serialport);", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE5MTUwMg==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r449191502", "bodyText": "If I see correctly, you come here when TeleinfoSerialControllerHandler.stopReceivingAndCloseSerialPort() is invoked. The receiving thread needs to be interrupted, then, otherwise join() will block.", "author": "fwolter", "createdAt": "2020-07-02T18:15:12Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,673 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.dto.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.dto.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConversionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static long defaultTimeoutNextHeaderFrame = 33400;\n+    public static long defaultTimeoutReadingFrame = 33400;\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoInputStream.class);\n+    private static final Map<Class<?>, Converter> LABEL_VALUE_CONVERTERS;\n+\n+    private BufferedReader bufferedReader;\n+    private @Nullable String groupLine;\n+    private ExecutorService executorService = Executors.newFixedThreadPool(2);\n+    private long waitNextHeaderFrameTimeoutInMs;\n+    private long readingFrameTimeoutInMs;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+\n+    static {\n+        LABEL_VALUE_CONVERTERS = new HashMap<>();\n+        LABEL_VALUE_CONVERTERS.put(Integer.class, new IntegerConverter());\n+        LABEL_VALUE_CONVERTERS.put(String.class, new StringConverter());\n+        LABEL_VALUE_CONVERTERS.put(Float.class, new FloatConverter());\n+        LABEL_VALUE_CONVERTERS.put(Ptec.class, new PtecConverter());\n+        LABEL_VALUE_CONVERTERS.put(Hhphc.class, new HhphcConverter());\n+        LABEL_VALUE_CONVERTERS.put(CouleurDemain.class, new CouleurDemainConverter());\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream) {\n+        this(teleinfoInputStream, defaultTimeoutNextHeaderFrame, defaultTimeoutReadingFrame, false);\n+    }\n+\n+    public TeleinfoInputStream(final InputStream teleinfoInputStream, boolean autoRepairInvalidADPSgroupLine) {\n+        this(teleinfoInputStream, defaultTimeoutNextHeaderFrame, defaultTimeoutReadingFrame,\n+                autoRepairInvalidADPSgroupLine);\n+    }\n+\n+    public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine) {\n+        if (teleinfoInputStream == null) {\n+            throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n+        }\n+\n+        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+\n+        this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n+\n+        groupLine = null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        logger.debug(\"close() [start]\");\n+        bufferedReader.close();\n+        executorService.shutdownNow();\n+        super.close();\n+        logger.debug(\"close() [end]\");\n+    }\n+\n+    /**\n+     * Returns the next frame.\n+     *\n+     * @return the next frame or null if end of stream\n+     * @throws InvalidFrameException if the read data from\n+     * @throws TimeoutException if the delay to read a complete frame is expired (33,4 ms) or if the delay to find\n+     *             the\n+     *             header of next frame is expired (33,4 ms)\n+     * @throws IOException\n+     */\n+    public synchronized @Nullable Frame readNextFrame() throws InvalidFrameException, TimeoutException, IOException {\n+\n+        // seek the next header frame\n+        Future<@Nullable Void> seekNextHeaderFrameTask = executorService.submit(() -> {\n+            while (!isHeaderFrame(groupLine)) {\n+                groupLine = bufferedReader.readLine();\n+                if (logger.isTraceEnabled()) {\n+                    logger.trace(\"groupLine = {}\", groupLine);\n+                }\n+                if (groupLine == null) { // end of stream\n+                    logger.trace(\"end of stream reached !\");\n+                    return null;\n+                }\n+            }\n+\n+            logger.trace(\"header frame found !\");\n+            return null;\n+        });\n+        try {\n+            logger.debug(\"seeking the next header frame...\");\n+            logger.trace(\"waitNextHeaderFrameTimeoutInMs = {}\", waitNextHeaderFrameTimeoutInMs);\n+            seekNextHeaderFrameTask.get(waitNextHeaderFrameTimeoutInMs, TimeUnit.MICROSECONDS);\n+\n+            if (groupLine == null) { // end of stream\n+                return null;\n+            }\n+        } catch (InterruptedException e) {\n+            throw new IllegalStateException(e);", "originalCommit": "7badcc4ba5eaf14f014e53cb3ada47cfda34bd8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MTY1MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r451781651", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInMs;\n          \n          \n            \n                    this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;", "author": "fwolter", "createdAt": "2020-07-08T19:38:06Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -120,20 +121,30 @@ public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long\n             throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n         }\n \n-        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInMs;", "originalCommit": "c513782b3c5c3a9103f606389b9025408094e390", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MjcxOA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r451782718", "bodyText": "The invocation of this constructor will indirectly create the thread pool in line 129.", "author": "fwolter", "createdAt": "2020-07-08T19:40:21Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -120,20 +121,30 @@ public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long\n             throw new IllegalArgumentException(\"Teleinfo inputStream is null\");\n         }\n \n-        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInMs;\n         this.readingFrameTimeoutInMs = readingFrameTimeoutInMs;\n         this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n \n         this.bufferedReader = new BufferedReader(new InputStreamReader(teleinfoInputStream, StandardCharsets.US_ASCII));\n+        this.executorService = Executors.newFixedThreadPool(2);\n \n         groupLine = null;\n     }\n \n+    public TeleinfoInputStream(final @Nullable InputStream teleinfoInputStream, long waitNextHeaderFrameTimeoutInMs,\n+            long readingFrameTimeoutInMs, boolean autoRepairInvalidADPSgroupLine, ExecutorService executorService) {\n+        this(teleinfoInputStream, waitNextHeaderFrameTimeoutInMs, readingFrameTimeoutInMs,", "originalCommit": "c513782b3c5c3a9103f606389b9025408094e390", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MzMyNA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r451783324", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInMs;\n          \n          \n            \n                    this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInUs;", "author": "fwolter", "createdAt": "2020-07-08T19:41:33Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -256,19 +263,20 @@ public void close() throws IOException {\n \n             return frame;\n         } catch (InterruptedException e) {\n+            logger.warn(\"Got interrupted exception\", e);\n+            Thread.currentThread().interrupt();\n             throw new IllegalStateException(e);\n         } catch (ExecutionException e) {\n-            rethrowTaskExecutionException(e);\n-            return null; // FIXME best way ?\n+            throw rethrowTaskExecutionException(e);\n         }\n     }\n \n     public long getWaitNextHeaderFrameTimeoutInMs() {\n-        return waitNextHeaderFrameTimeoutInMs;\n+        return waitNextHeaderFrameTimeoutInUs;\n     }\n \n     public void setWaitNextHeaderFrameTimeoutInMs(long waitNextHeaderFrameTimeoutInMs) {\n-        this.waitNextHeaderFrameTimeoutInMs = waitNextHeaderFrameTimeoutInMs;\n+        this.waitNextHeaderFrameTimeoutInUs = waitNextHeaderFrameTimeoutInMs;", "originalCommit": "c513782b3c5c3a9103f606389b9025408094e390", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjEwMA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r456616100", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final long DEFAULT_TIMEOUT_NEXT_HEADER_FRAME = 33400;\n          \n          \n            \n                public static final long DEFAULT_TIMEOUT_READING_FRAME = 33400;\n          \n          \n            \n                public static final long DEFAULT_TIMEOUT_NEXT_HEADER_FRAME_US = 33400;\n          \n          \n            \n                public static final long DEFAULT_TIMEOUT_READING_FRAME_US = 33400;", "author": "fwolter", "createdAt": "2020-07-17T18:48:08Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/reader/io/TeleinfoInputStream.java", "diffHunk": "@@ -0,0 +1,689 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.reader.io;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.time.LocalDate;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemm;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.FrameCbemmTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIcc;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbemm.evoicc.FrameCbemmEvolutionIccTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLong;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmLongTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.cbetm.FrameCbetmShort;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameBaseOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameEjpOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameHcOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.CouleurDemain;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit1;\n+import org.openhab.binding.teleinfo.internal.dto.common.FrameTempoOption.ProgrammeCircuit2;\n+import org.openhab.binding.teleinfo.internal.dto.common.Hhphc;\n+import org.openhab.binding.teleinfo.internal.dto.common.Ptec;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.ConversionException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.FrameUtil;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.Label;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.Converter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.CouleurDemainConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.FloatConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.HhphcConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.IntegerConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.PtecConverter;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.converter.StringConverter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * InputStream for Teleinfo {@link Frame} in serial port format.\n+ */\n+/**\n+ * The {@link TeleinfoInputStream} class is an {@link InputStream} to decode/read Teleinfo frames.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoInputStream extends InputStream {\n+\n+    public static final long DEFAULT_TIMEOUT_NEXT_HEADER_FRAME = 33400;\n+    public static final long DEFAULT_TIMEOUT_READING_FRAME = 33400;", "originalCommit": "9a194548d7c0843df63ca92605ac7bdbc913eea9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjU3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r456616573", "bodyText": "Can this be removed?", "author": "fwolter", "createdAt": "2020-07-17T18:49:13Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoReceiveThread.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.reader.io.TeleinfoInputStream;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoReceiveThread} class defines a thread to decode and fire Teleinfo frames for Serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoReceiveThread extends Thread {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoReceiveThread.class);\n+\n+    private SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThreadListener listener;\n+    private boolean autoRepairInvalidADPSgroupLine;\n+    private ExecutorService executorService;\n+\n+    public TeleinfoReceiveThread(SerialPort serialPort, final TeleinfoReceiveThreadListener listener,\n+            boolean autoRepairInvalidADPSgroupLine, ExecutorService scheduler) {\n+        super(\"TeleinfoReceiveThread\");\n+        setDaemon(true);\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        this.autoRepairInvalidADPSgroupLine = autoRepairInvalidADPSgroupLine;\n+        this.executorService = scheduler;\n+    }\n+\n+    @Override\n+    public void run() {\n+        try (TeleinfoInputStream teleinfoStream = new TeleinfoInputStream(serialPort.getInputStream(),\n+                TeleinfoInputStream.DEFAULT_TIMEOUT_NEXT_HEADER_FRAME * 100,\n+                TeleinfoInputStream.DEFAULT_TIMEOUT_READING_FRAME * 100, autoRepairInvalidADPSgroupLine,\n+                executorService)) {\n+            while (!interrupted()) {\n+                TeleinfoReceiveThreadListener listener = this.listener;\n+                if (listener != null) {\n+                    try {\n+                        Frame nextFrame = teleinfoStream.readNextFrame();\n+                        if (nextFrame != null)\n+                            listener.onFrameReceived(this, nextFrame);\n+                    } catch (InvalidFrameException e) {\n+                        logger.warn(\"Got invalid frame. Detail: \\\"{}\\\"\", e.getLocalizedMessage());\n+                        listener.onInvalidFrameReceived(this, e);\n+                    } catch (TimeoutException e) {\n+                        logger.warn(\"Got timeout during frame reading\", e);\n+                        if (!listener.continueOnReadNextFrameTimeoutException(this, e)) {\n+                            break;\n+                        }\n+                        // skipInputStreamBuffer();", "originalCommit": "9a194548d7c0843df63ca92605ac7bdbc913eea9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjgyOA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r456616828", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n          \n          \n            \n                private static final int SERIAL_RECEIVE_TIMEOUT_MS = 250;", "author": "fwolter", "createdAt": "2020-07-17T18:49:49Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;", "originalCommit": "9a194548d7c0843df63ca92605ac7bdbc913eea9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxODc0MA==", "url": "https://github.com/openhab/openhab-addons/pull/7744#discussion_r456618740", "bodyText": "You might want to add a timeout parameter to join() in case something blocks the interrupt.", "author": "fwolter", "createdAt": "2020-07-17T18:53:54Z", "path": "bundles/org.openhab.binding.teleinfo/src/main/java/org/openhab/binding/teleinfo/internal/serial/TeleinfoSerialControllerHandler.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.teleinfo.internal.serial;\n+\n+import static org.openhab.binding.teleinfo.internal.TeleinfoBindingConstants.*;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.teleinfo.internal.dto.Frame;\n+import org.openhab.binding.teleinfo.internal.handler.TeleinfoAbstractControllerHandler;\n+import org.openhab.binding.teleinfo.internal.reader.io.serialport.InvalidFrameException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TeleinfoSerialControllerHandler} class defines a handler for serial controller.\n+ *\n+ * @author Nicolas SIBERIL - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TeleinfoSerialControllerHandler extends TeleinfoAbstractControllerHandler\n+        implements TeleinfoReceiveThreadListener {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TeleinfoSerialControllerHandler.class);\n+\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 250;\n+    private static final int SERIAL_PORT_DELAY_RETRY_IN_SECONDS = 60;\n+\n+    private SerialPortManager serialPortManager;\n+    private @Nullable SerialPort serialPort;\n+    private @Nullable TeleinfoReceiveThread receiveThread;\n+    private @Nullable ScheduledFuture<?> keepAliveThread;\n+    private long invalidFrameCounter = 0;\n+\n+    public TeleinfoSerialControllerHandler(Bridge thing, SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        invalidFrameCounter = 0;\n+\n+        keepAliveThread = scheduler.scheduleWithFixedDelay(() -> {\n+            if (!isInitialized()) {\n+                openSerialPortAndStartReceiving();\n+                updateStatus(ThingStatus.UNKNOWN);\n+            }\n+            logger.debug(\"Check Teleinfo receiveThread status...\");\n+            logger.debug(\"isInitialized() = {}\", isInitialized());\n+            TeleinfoReceiveThread receiveThreadRef = receiveThread;\n+            if (receiveThreadRef != null) {\n+                logger.debug(\"receiveThread.isAlive() = {}\", receiveThreadRef.isAlive());\n+            }\n+            if (isInitialized() && (receiveThreadRef == null || !receiveThreadRef.isAlive())) {\n+                updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+                logger.info(\"Try to restart Teleinfo receiving...\");\n+                stopReceivingAndCloseSerialPort();\n+                openSerialPortAndStartReceiving();\n+            }\n+        }, 0, 60, TimeUnit.SECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        ScheduledFuture<?> keepAliveThreadRef = keepAliveThread;\n+        if (keepAliveThreadRef != null) {\n+            keepAliveThreadRef.cancel(true);\n+            keepAliveThread = null;\n+        }\n+        stopReceivingAndCloseSerialPort();\n+\n+        super.dispose();\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void onFrameReceived(TeleinfoReceiveThread receiveThread, Frame frame) {\n+        updateStatus(ThingStatus.ONLINE);\n+        fireOnFrameReceivedEvent(frame);\n+    }\n+\n+    @Override\n+    public void onInvalidFrameReceived(TeleinfoReceiveThread receiveThread, InvalidFrameException error) {\n+        invalidFrameCounter++;\n+        updateState(THING_SERIAL_CONTROLLER_CHANNEL_INVALID_FRAME_COUNTER, new DecimalType(invalidFrameCounter));\n+    }\n+\n+    @Override\n+    public void onSerialPortInputStreamIOException(TeleinfoReceiveThread receiveThread, IOException e) {\n+        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+    }\n+\n+    @Override\n+    public boolean continueOnReadNextFrameTimeoutException(TeleinfoReceiveThread receiveThread, TimeoutException e) {\n+        logger.warn(\"Retry in progress. Next retry in {} seconds...\", SERIAL_PORT_DELAY_RETRY_IN_SECONDS);\n+        updateStatus(ThingStatus.UNKNOWN, ThingStatusDetail.NONE, ERROR_UNKNOWN_RETRY_IN_PROGRESS);\n+        try {\n+            Thread.sleep(SERIAL_PORT_DELAY_RETRY_IN_SECONDS * 1000);\n+            return true;\n+        } catch (InterruptedException e1) {\n+            return false;\n+        }\n+    }\n+\n+    private void openSerialPortAndStartReceiving() {\n+        TeleinfoSerialControllerConfiguration config = getConfigAs(TeleinfoSerialControllerConfiguration.class);\n+\n+        if (config.serialport.trim().isEmpty()) {\n+            logger.warn(\"Teleinfo port is not set.\");\n+            return;\n+        }\n+\n+        logger.debug(\"Connecting to serial port '{}'...\", config.serialport);\n+        String currentOwner = null;\n+        try {\n+            final SerialPortIdentifier portIdentifier = serialPortManager.getIdentifier(config.serialport);\n+            logger.debug(\"portIdentifier = {}\", portIdentifier);\n+            if (portIdentifier == null) {\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                        ERROR_OFFLINE_SERIAL_NOT_FOUND);\n+                return;\n+            }\n+            logger.debug(\"Opening portIdentifier\");\n+            currentOwner = portIdentifier.getCurrentOwner();\n+            logger.debug(\"portIdentifier.getCurrentOwner() = {}\", currentOwner);\n+            SerialPort commPort = portIdentifier.open(\"org.openhab.binding.teleinfo\", 5000);\n+            serialPort = commPort;\n+\n+            commPort.setSerialPortParams(1200, SerialPort.DATABITS_7, SerialPort.STOPBITS_1, SerialPort.PARITY_EVEN);\n+            commPort.enableReceiveThreshold(1);\n+            commPort.enableReceiveTimeout(SERIAL_RECEIVE_TIMEOUT);\n+            logger.debug(\"Starting receive thread\");\n+            TeleinfoReceiveThread receiveThread = new TeleinfoReceiveThread(commPort, this,\n+                    config.autoRepairInvalidADPSgroupLine, scheduler);\n+            this.receiveThread = receiveThread;\n+            receiveThread.start();\n+\n+            logger.debug(\"Connected to serial port '{}'\", config.serialport);\n+        } catch (PortInUseException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    ERROR_OFFLINE_SERIAL_INUSE);\n+        } catch (UnsupportedCommOperationException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    ERROR_OFFLINE_SERIAL_UNSUPPORTED);\n+        }\n+    }\n+\n+    private void stopReceivingAndCloseSerialPort() {\n+        TeleinfoReceiveThread receiveThreadRef = receiveThread;\n+        if (receiveThreadRef != null) {\n+            receiveThreadRef.interrupt();\n+            try {\n+                receiveThreadRef.join();", "originalCommit": "9a194548d7c0843df63ca92605ac7bdbc913eea9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4c6525bad81cb276cd546349904a095d7722055", "url": "https://github.com/openhab/openhab-addons/commit/d4c6525bad81cb276cd546349904a095d7722055", "message": "Initial commit\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "db5e0bf25a188de0e99c8d83072cdc3502cba23d", "url": "https://github.com/openhab/openhab-addons/commit/db5e0bf25a188de0e99c8d83072cdc3502cba23d", "message": "Add ADPS, HHPHC & lastUpdate channels to HC/HP electricity meter\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "7ff5925a43097cd2bed88faec440f1212d5ddf1a", "url": "https://github.com/openhab/openhab-addons/commit/7ff5925a43097cd2bed88faec440f1212d5ddf1a", "message": "Disable Unused pricing configuration for HC/HP eletricity meter\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "ba3dd23221b30c2965dbcaa8dc33de17c1a678e6", "url": "https://github.com/openhab/openhab-addons/commit/ba3dd23221b30c2965dbcaa8dc33de17c1a678e6", "message": "Review of TeleinfoInputStream class\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "8858b988d603936eab8a5e647efd7fcaffc18b4a", "url": "https://github.com/openhab/openhab-addons/commit/8858b988d603936eab8a5e647efd7fcaffc18b4a", "message": "Add BASE electricity meter support\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "06888ab455f4ced14683fd49f5bc9ece370bf292", "url": "https://github.com/openhab/openhab-addons/commit/06888ab455f4ced14683fd49f5bc9ece370bf292", "message": "Add UML datamodel\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "f7dae511ef9355a06c19160d6a0d321a57fba038", "url": "https://github.com/openhab/openhab-addons/commit/f7dae511ef9355a06c19160d6a0d321a57fba038", "message": "Total refactoring to support Base/HC/Ejp/Tempo CBEMM and\nBase/HC/Ejp/Tempo CBETM teleinfo frames\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "f15c5b946a24f4b7ebd74e7194a653228c92daa9", "url": "https://github.com/openhab/openhab-addons/commit/f15c5b946a24f4b7ebd74e7194a653228c92daa9", "message": "Add unit test for CBETM EJP option\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "573af6354ae35df194a8a8a553f8a5fc09833373", "url": "https://github.com/openhab/openhab-addons/commit/573af6354ae35df194a8a8a553f8a5fc09833373", "message": "Add unit test for CBEMM Tempo option\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "29640444adffc002da384731ea161949b5945250", "url": "https://github.com/openhab/openhab-addons/commit/29640444adffc002da384731ea161949b5945250", "message": "Add ProgrammeCircuit1 and ProgrammeCircuit2 channels to Tempo option\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "5cd09b997b7c94247498110a7937e1a2dfacefd3", "url": "https://github.com/openhab/openhab-addons/commit/5cd09b997b7c94247498110a7937e1a2dfacefd3", "message": "Fix ThingUID constants with OpenHAB XML definitions\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "569fdc9d0bbf6e2b8090b2e3fdec9323f98706e4", "url": "https://github.com/openhab/openhab-addons/commit/569fdc9d0bbf6e2b8090b2e3fdec9323f98706e4", "message": "Update <label> of thing types\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "ad13659792ce6a31ba4317e2437eb9906f8e61bb", "url": "https://github.com/openhab/openhab-addons/commit/ad13659792ce6a31ba4317e2437eb9906f8e61bb", "message": "Add Retry mechanism on fatal errors\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "7dc6f2c5bd51b61f17e865026f07d4324943a4c9", "url": "https://github.com/openhab/openhab-addons/commit/7dc6f2c5bd51b61f17e865026f07d4324943a4c9", "message": "Update \"Retry in progress...\" message (log)\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "4485c34234fc89d7eab743552e6e08627fd26a8e", "url": "https://github.com/openhab/openhab-addons/commit/4485c34234fc89d7eab743552e6e08627fd26a8e", "message": "Improve \"Got invalid frame\" error message and \"The group line seems\ncorrupted\"\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "cfc660915fcc478dc0d99342e625ad181f7b7022", "url": "https://github.com/openhab/openhab-addons/commit/cfc660915fcc478dc0d99342e625ad181f7b7022", "message": "Improve \"The label '%s' is unknown\" error message\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "7f2930be05111c9e6cfe5ff73f0daf369579b058", "url": "https://github.com/openhab/openhab-addons/commit/7f2930be05111c9e6cfe5ff73f0daf369579b058", "message": "Fix https://github.com/nokyyz/openhab2-addons/issues/10 issue\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "f4127230bdc24fbab956279b215dd8880e40e604", "url": "https://github.com/openhab/openhab-addons/commit/f4127230bdc24fbab956279b215dd8880e40e604", "message": "Update info log \"Serial port is initialized\" to \"Teleinfo Serial port is\ninitialized\"\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "bfd039413123b642052bf766e7233d95d03bae52", "url": "https://github.com/openhab/openhab-addons/commit/bfd039413123b642052bf766e7233d95d03bae52", "message": "Message logs improvements\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "8527d35dc811c1509bb7da80f0826e3071107a0b", "url": "https://github.com/openhab/openhab-addons/commit/8527d35dc811c1509bb7da80f0826e3071107a0b", "message": "Fix typo issues\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:49Z", "type": "commit"}, {"oid": "9f57e34d3325340f9ca196478b084e79180a4be5", "url": "https://github.com/openhab/openhab-addons/commit/9f57e34d3325340f9ca196478b084e79180a4be5", "message": "Fix https://github.com/nokyyz/openhab2-addons/issues/7 issue\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "f2f9271af6721be8b4a517b41605233941fe96ed", "url": "https://github.com/openhab/openhab-addons/commit/f2f9271af6721be8b4a517b41605233941fe96ed", "message": "Fix issues from OH code analysis report\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "10d6385d0f4f0ca6500f47aab9926b8dd0561c92", "url": "https://github.com/openhab/openhab-addons/commit/10d6385d0f4f0ca6500f47aab9926b8dd0561c92", "message": "Message logs improvements\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "4af715fbcaaf01d6554ec9990a4951044ba5ba2b", "url": "https://github.com/openhab/openhab-addons/commit/4af715fbcaaf01d6554ec9990a4951044ba5ba2b", "message": "Modify some message logs\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "77aa2f368b7d1d147bbca994b7b98a03205e89d1", "url": "https://github.com/openhab/openhab-addons/commit/77aa2f368b7d1d147bbca994b7b98a03205e89d1", "message": "Modifiy some message logs\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "cdd72db8b0cb00ee8a9398dc091bd59b987a5e50", "url": "https://github.com/openhab/openhab-addons/commit/cdd72db8b0cb00ee8a9398dc091bd59b987a5e50", "message": "Add current owner information in PortInUseException message log\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "766f70f6a3e647997efe9a7f99b7acd6b1cf12de", "url": "https://github.com/openhab/openhab-addons/commit/766f70f6a3e647997efe9a7f99b7acd6b1cf12de", "message": "Fix https://github.com/nokyyz/openhab2-addons/issues/11 issue\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "7c591fdbb4a18d88263a32673d98c16d4115bf89", "url": "https://github.com/openhab/openhab-addons/commit/7c591fdbb4a18d88263a32673d98c16d4115bf89", "message": "Fix typo error\n(TeleinfoReceiveThreadListener#OnSerialPortInputStreamIOException ->\nTeleinfoReceiveThreadListener#onSerialPortInputStreamIOException)\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "73be21c376d2aa902b6887a1277bdf8afb2b89ae", "url": "https://github.com/openhab/openhab-addons/commit/73be21c376d2aa902b6887a1277bdf8afb2b89ae", "message": "Fix https://github.com/nokyyz/openhab2-addons/issues/12\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "a57cf99d4123c335c0ec0964af640a28245d9566", "url": "https://github.com/openhab/openhab-addons/commit/a57cf99d4123c335c0ec0964af640a28245d9566", "message": "Bump parent version to 2.5.4-SNAPSHOT\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "b7551ffa9c1a2b45a2de094e396a32e60f18339c", "url": "https://github.com/openhab/openhab-addons/commit/b7551ffa9c1a2b45a2de094e396a32e60f18339c", "message": "Add missing import\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "9e8846a4077a7243e6d22e3765c7436f3c12ca88", "url": "https://github.com/openhab/openhab-addons/commit/9e8846a4077a7243e6d22e3765c7436f3c12ca88", "message": "update coypright year\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "2406ada8428bdb35392cc0bc88503b4273f72215", "url": "https://github.com/openhab/openhab-addons/commit/2406ada8428bdb35392cc0bc88503b4273f72215", "message": "Apply spotless\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "f0e63aed4ae809cb69bb6a58b04aa7187e08b970", "url": "https://github.com/openhab/openhab-addons/commit/f0e63aed4ae809cb69bb6a58b04aa7187e08b970", "message": "Add missing copyright headers\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "fdb880e7c0aa19b06f952b04b8815d17a7ccb66e", "url": "https://github.com/openhab/openhab-addons/commit/fdb880e7c0aa19b06f952b04b8815d17a7ccb66e", "message": "Initialize channel description table.\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "61b17aaa14a385c2e986793b7abf39c6d0549fec", "url": "https://github.com/openhab/openhab-addons/commit/61b17aaa14a385c2e986793b7abf39c6d0549fec", "message": "Small corrections\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "e7e963089ec6845f559fd5ad5427223190817120", "url": "https://github.com/openhab/openhab-addons/commit/e7e963089ec6845f559fd5ad5427223190817120", "message": "Cosmetic corrections\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "ef852a0a091041f8271e1d138b9510de9696b790", "url": "https://github.com/openhab/openhab-addons/commit/ef852a0a091041f8271e1d138b9510de9696b790", "message": "Initialize full example part\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "e33ff95f5a660b2cd5d8fb3e33b0f8456c23398d", "url": "https://github.com/openhab/openhab-addons/commit/e33ff95f5a660b2cd5d8fb3e33b0f8456c23398d", "message": "Add thing configuration table\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "99ea14ef4d085fb6dcc27d7fccc0c21e74102553", "url": "https://github.com/openhab/openhab-addons/commit/99ea14ef4d085fb6dcc27d7fccc0c21e74102553", "message": "Improve things configuration description\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "e78e018c4fc945127c3ebc6b918caee3c4b672f5", "url": "https://github.com/openhab/openhab-addons/commit/e78e018c4fc945127c3ebc6b918caee3c4b672f5", "message": "improve terminology\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "0510e483fd0f9e2139a738f17db4996fecc69d1d", "url": "https://github.com/openhab/openhab-addons/commit/0510e483fd0f9e2139a738f17db4996fecc69d1d", "message": "Remove copy/paste error\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "9e1f3236a5ec3e9d5326cebf72ac271ef58b19fb", "url": "https://github.com/openhab/openhab-addons/commit/9e1f3236a5ec3e9d5326cebf72ac271ef58b19fb", "message": "replace named by labelled\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "f0989d9abe5949c3a4bf32a5086086eee08c89bd", "url": "https://github.com/openhab/openhab-addons/commit/f0989d9abe5949c3a4bf32a5086086eee08c89bd", "message": "Improve channels table\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "fde6fba3d8d1ad41c71814b56244704450af89d3", "url": "https://github.com/openhab/openhab-addons/commit/fde6fba3d8d1ad41c71814b56244704450af89d3", "message": "Simplify and add three phase in channels table\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "29d36d8ffa98863f922ba255978758b50d6328c0", "url": "https://github.com/openhab/openhab-addons/commit/29d36d8ffa98863f922ba255978758b50d6328c0", "message": "Test for directly edit\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "7e1507571eb7080ec6623b044a0a7a94b07c7c09", "url": "https://github.com/openhab/openhab-addons/commit/7e1507571eb7080ec6623b044a0a7a94b07c7c09", "message": "Supported hardwares chapter updates\n\n- updated title chapter\n- add Base mode for the GCE Electronics USB Teleinfo module\n- typo fix\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "fcab9bcb09d048c326407541758d4b6ff9658ac0", "url": "https://github.com/openhab/openhab-addons/commit/fcab9bcb09d048c326407541758d4b6ff9658ac0", "message": "Correct phase number\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "c31d300caf6fc60c2b8986aaf60db007d6d67a9c", "url": "https://github.com/openhab/openhab-addons/commit/c31d300caf6fc60c2b8986aaf60db007d6d67a9c", "message": "Precise specific ICC evolution channels\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "d54c7ce894e3a382ddb86efcd457f9b8a96f1765", "url": "https://github.com/openhab/openhab-addons/commit/d54c7ce894e3a382ddb86efcd457f9b8a96f1765", "message": "Add things table\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "144f8bf7132346424e34abd408869679fe67c17e", "url": "https://github.com/openhab/openhab-addons/commit/144f8bf7132346424e34abd408869679fe67c17e", "message": "Fix typo\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "b19c31b0aeab3361f6bded7d2318978136a63416", "url": "https://github.com/openhab/openhab-addons/commit/b19c31b0aeab3361f6bded7d2318978136a63416", "message": "Fix missing three phase modes\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "e84e333aa8787ae492740d390985b80236d98ea0", "url": "https://github.com/openhab/openhab-addons/commit/e84e333aa8787ae492740d390985b80236d98ea0", "message": "Introduce modem in intro\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "ff08c8e883f9250b0c5b18ec17868a5ade4acaaa", "url": "https://github.com/openhab/openhab-addons/commit/ff08c8e883f9250b0c5b18ec17868a5ade4acaaa", "message": "Rename electricity meter identifier\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "7280c210cdf7fe2dfdadf58a4ee0bc6d3e58e693", "url": "https://github.com/openhab/openhab-addons/commit/7280c210cdf7fe2dfdadf58a4ee0bc6d3e58e693", "message": "Precise format of adco\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "545c7d2730f288a4297229262faf1ff14611bbc2", "url": "https://github.com/openhab/openhab-addons/commit/545c7d2730f288a4297229262faf1ff14611bbc2", "message": "Correct tested power energy meter model\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "cf7040ad95c9ea277e6c75ca6b3c187254e87f60", "url": "https://github.com/openhab/openhab-addons/commit/cf7040ad95c9ea277e6c75ca6b3c187254e87f60", "message": "Update file configuration example\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:50Z", "type": "commit"}, {"oid": "46858634d8e360cf75b9d0a151c41da07fb43a20", "url": "https://github.com/openhab/openhab-addons/commit/46858634d8e360cf75b9d0a151c41da07fb43a20", "message": "Correct serialport\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "f7400bb89ad7d147c40b5b368e45854f43c7ea5a", "url": "https://github.com/openhab/openhab-addons/commit/f7400bb89ad7d147c40b5b368e45854f43c7ea5a", "message": "Add process to get adco\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "17d7c700575e174146a0b18acfe36835536c97f8", "url": "https://github.com/openhab/openhab-addons/commit/17d7c700575e174146a0b18acfe36835536c97f8", "message": "Re-add mandatory discovery section\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "6ec870b973e15e2aa8a18bfd24214dcbea611a31", "url": "https://github.com/openhab/openhab-addons/commit/6ec870b973e15e2aa8a18bfd24214dcbea611a31", "message": "correct typo\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "ff5dcaf00e9be36c167d161ca151b40d347020e7", "url": "https://github.com/openhab/openhab-addons/commit/ff5dcaf00e9be36c167d161ca151b40d347020e7", "message": "remove item group\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "d6b0cf32e9c8bb9c578b3182df9d0ae3c8e11110", "url": "https://github.com/openhab/openhab-addons/commit/d6b0cf32e9c8bb9c578b3182df9d0ae3c8e11110", "message": "minor fixes\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "d493c0c322e3f5365c889a7596b2c4854fe13f12", "url": "https://github.com/openhab/openhab-addons/commit/d493c0c322e3f5365c889a7596b2c4854fe13f12", "message": "improve example description\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "cd06a453cf87fc6f3c9673a0774c5630d7f588a5", "url": "https://github.com/openhab/openhab-addons/commit/cd06a453cf87fc6f3c9673a0774c5630d7f588a5", "message": "fix typo\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "6aab74099b6e97f99387a6e27ddc64de8b62486a", "url": "https://github.com/openhab/openhab-addons/commit/6aab74099b6e97f99387a6e27ddc64de8b62486a", "message": "Replace adco property by parameter (only for cbemm_evolution_icc_hc_electricitymeter)\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "86d4e789e0efc71d8a53f9fa0d5e6bdfc47d55a9", "url": "https://github.com/openhab/openhab-addons/commit/86d4e789e0efc71d8a53f9fa0d5e6bdfc47d55a9", "message": "Replace adc property by parameter (for all remaining electricity meters)\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "c81bc7c36e2a5a0642e9bd4e81194f6e67152323", "url": "https://github.com/openhab/openhab-addons/commit/c81bc7c36e2a5a0642e9bd4e81194f6e67152323", "message": "Update files author list\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "5d747bd2a92b6af79cb7fae09d8499edf8c3aa79", "url": "https://github.com/openhab/openhab-addons/commit/5d747bd2a92b6af79cb7fae09d8499edf8c3aa79", "message": "Update ADCO channel description\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "d43b8fb0ce98e3f9a989f195ae11b0dc6ad4cf96", "url": "https://github.com/openhab/openhab-addons/commit/d43b8fb0ce98e3f9a989f195ae11b0dc6ad4cf96", "message": "Add pattern for ADCO parameter\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "6857c31c4c5406f1637fecb7ad968f9bfb88eda9", "url": "https://github.com/openhab/openhab-addons/commit/6857c31c4c5406f1637fecb7ad968f9bfb88eda9", "message": "Use OH core version instead of project version\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "28bd2c31da565718189ca5c131d455b4870547e7", "url": "https://github.com/openhab/openhab-addons/commit/28bd2c31da565718189ca5c131d455b4870547e7", "message": "Fix #13 issue (\"Try to repair automatically invalid frame with \"ADPSxxx\"\")\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "d51ae6b065503a576d59f69a7088e61100a10afe", "url": "https://github.com/openhab/openhab-addons/commit/d51ae6b065503a576d59f69a7088e61100a10afe", "message": "Update teleinfo pom.xml version (to '2.5.5-SNAPSHOT')\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "1c2fb2e775eda2245a5e1b64505ee80a439fb9da", "url": "https://github.com/openhab/openhab-addons/commit/1c2fb2e775eda2245a5e1b64505ee80a439fb9da", "message": "Fix Code Analysis Tool error in serialController.xml file (whitespace characters used for indentation)\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "72e6a16c6802e7fdaed7a666e869eab564815ed0", "url": "https://github.com/openhab/openhab-addons/commit/72e6a16c6802e7fdaed7a666e869eab564815ed0", "message": "Fix Code Analysis Tool error in TeleinfoInputStream.java file (\"Count of placeholder(0) is not equal to count of parameter(1)\")\n\nSigned-off-by: Nicolas SIBERIL <nokyyz@yahoo.fr>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "c32df9972faf292339ba44eb1dee111423cdd515", "url": "https://github.com/openhab/openhab-addons/commit/c32df9972faf292339ba44eb1dee111423cdd515", "message": "Remove dependency duplication\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "973182bef18792f9f4d58d406597784c4b326116", "url": "https://github.com/openhab/openhab-addons/commit/973182bef18792f9f4d58d406597784c4b326116", "message": "update teleinfo pom.xml version (to 2.5.6-SNAPSHOT)\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "725be92f70c0309f9b9510c87a2f6da0fcfbf94c", "url": "https://github.com/openhab/openhab-addons/commit/725be92f70c0309f9b9510c87a2f6da0fcfbf94c", "message": "Remove explicit commons lang dependency\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "3d62dd90d4e2a1d92f53873675eb32d51db5124a", "url": "https://github.com/openhab/openhab-addons/commit/3d62dd90d4e2a1d92f53873675eb32d51db5124a", "message": "Refactor predicate\n\nCo-authored-by: Fabian Wolter <github@fabian-wolter.de>\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "32cc48de168965c4f61bba08f083d8ac982be952", "url": "https://github.com/openhab/openhab-addons/commit/32cc48de168965c4f61bba08f083d8ac982be952", "message": "Remove commented lines\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "7735c7e76ac8710bb0aae5d2489ca7b11b66b19e", "url": "https://github.com/openhab/openhab-addons/commit/7735c7e76ac8710bb0aae5d2489ca7b11b66b19e", "message": "Remove commented line\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "31ade44f32959763c724a308c6d420638011ec04", "url": "https://github.com/openhab/openhab-addons/commit/31ade44f32959763c724a308c6d420638011ec04", "message": "Remove commented line\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "aa03cee63a88eadae176595484385aed9b1893d8", "url": "https://github.com/openhab/openhab-addons/commit/aa03cee63a88eadae176595484385aed9b1893d8", "message": "Use property name as representation property\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "ae0080150fa19ff0368eb4bc1a0d3e618b544f4e", "url": "https://github.com/openhab/openhab-addons/commit/ae0080150fa19ff0368eb4bc1a0d3e618b544f4e", "message": "Refactor predicate\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "d7470bf9b2013728667fdcad4e805dc9fcc7b734", "url": "https://github.com/openhab/openhab-addons/commit/d7470bf9b2013728667fdcad4e805dc9fcc7b734", "message": "Change argument type to avoid type check\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "99c1974a4219cf9a18ff71854d73ce768728a10b", "url": "https://github.com/openhab/openhab-addons/commit/99c1974a4219cf9a18ff71854d73ce768728a10b", "message": "Remove unnecessary if\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "99689819fcf8671ecc4d7d2b4ec38a2aa1e7da0a", "url": "https://github.com/openhab/openhab-addons/commit/99689819fcf8671ecc4d7d2b4ec38a2aa1e7da0a", "message": "Make listeners list synchronized\n\nCo-authored-by: Fabian Wolter <github@fabian-wolter.de>\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "a26d8ff39ca028da500fe09919c64e84a04915f1", "url": "https://github.com/openhab/openhab-addons/commit/a26d8ff39ca028da500fe09919c64e84a04915f1", "message": "Syntactical sugar\n\nCo-authored-by: Fabian Wolter <github@fabian-wolter.de>\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "a89b283c5c0a898e0f95a35f0a1f3b1fed00c340", "url": "https://github.com/openhab/openhab-addons/commit/a89b283c5c0a898e0f95a35f0a1f3b1fed00c340", "message": "Remove debug logging\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "d5e9e0bcafbca35ecdbd8e2ba3e96d0a784a855e", "url": "https://github.com/openhab/openhab-addons/commit/d5e9e0bcafbca35ecdbd8e2ba3e96d0a784a855e", "message": "Refactor predicate\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "ed9b4515b1a0c023d503f2c945ccee3d2f2f2a22", "url": "https://github.com/openhab/openhab-addons/commit/ed9b4515b1a0c023d503f2c945ccee3d2f2f2a22", "message": "Combine two if\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "a4921d351bef458f81ac3fa95075aa7a9684c5a3", "url": "https://github.com/openhab/openhab-addons/commit/a4921d351bef458f81ac3fa95075aa7a9684c5a3", "message": "Add annotation to suppress warning\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "3f7ed1df6a742f79ce81033548df2d4d71b626e2", "url": "https://github.com/openhab/openhab-addons/commit/3f7ed1df6a742f79ce81033548df2d4d71b626e2", "message": "Check for null value\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:51Z", "type": "commit"}, {"oid": "875a1069681267b2cee8bf4f558d4195b10cbc0e", "url": "https://github.com/openhab/openhab-addons/commit/875a1069681267b2cee8bf4f558d4195b10cbc0e", "message": "Use real name\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "7d9b5196ddc1850359803a3879f105d363e1a77e", "url": "https://github.com/openhab/openhab-addons/commit/7d9b5196ddc1850359803a3879f105d363e1a77e", "message": "Refactor predicate\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}, {"oid": "483cb03f5a1bc380e78db5993b667529f7a4883b", "url": "https://github.com/openhab/openhab-addons/commit/483cb03f5a1bc380e78db5993b667529f7a4883b", "message": "Inverse equals parameters order\n\nSigned-off-by: Olivier Marceau <hollysaiqs@marceau.ovh>", "committedDate": "2020-08-30T19:33:52Z", "type": "commit"}]}