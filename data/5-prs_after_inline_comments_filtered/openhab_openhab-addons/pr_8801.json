{"pr_number": 8801, "pr_title": "[MeteoAlerte] Update for OH3", "pr_createdAt": "2020-10-19T09:01:19Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8801", "timeline": [{"oid": "8eb9b8d83819d4185ff9706e0240e82e4c5a8af0", "url": "https://github.com/openhab/openhab-addons/commit/8eb9b8d83819d4185ff9706e0240e82e4c5a8af0", "message": "[MeteoAlerte] Update for OH3\nReplaced old gif pictures with svg nicer pictures\nAdded a missing alert report (vague-submersion)\nAdded end of validity report timestamp\nSome code cleansing.\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-19T08:57:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyMDg0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/8801#discussion_r507620847", "bodyText": "Rather UNDEF?", "author": "lolodomo", "createdAt": "2020-10-19T09:56:30Z", "path": "bundles/org.openhab.binding.meteoalerte/src/main/java/org/openhab/binding/meteoalerte/internal/handler/MeteoAlerteHandler.java", "diffHunk": "@@ -133,74 +136,55 @@ private void updateAndPublish() {\n     private void updateChannels(ApiResponse apiResponse) {\n         Arrays.stream(apiResponse.getRecords()).findFirst()\n                 .ifPresent((record) -> record.getResponseFieldDTO().ifPresent(fields -> {\n-                    updateAlertString(WIND, fields.getVent());\n-                    updateAlertString(RAIN, fields.getPluieInondation());\n-                    updateAlertString(STORM, fields.getOrage());\n-                    updateAlertString(FLOOD, fields.getInondation());\n-                    updateAlertString(SNOW, fields.getNeige());\n-                    updateAlertString(HEAT, fields.getCanicule());\n-                    updateAlertString(FREEZE, fields.getGrandFroid());\n-                    updateAlertString(AVALANCHE, fields.getAvalanches());\n-\n-                    fields.getDateInsert().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+                    updateAlert(WIND, fields.getVent());\n+                    updateAlert(RAIN, fields.getPluieInondation());\n+                    updateAlert(STORM, fields.getOrage());\n+                    updateAlert(FLOOD, fields.getInondation());\n+                    updateAlert(SNOW, fields.getNeige());\n+                    updateAlert(HEAT, fields.getCanicule());\n+                    updateAlert(FREEZE, fields.getGrandFroid());\n+                    updateAlert(AVALANCHE, fields.getAvalanches());\n+                    updateAlert(WAVE, fields.getVagueSubmersion());\n                     updateState(COMMENT, new StringType(fields.getVigilanceComment()));\n-                    updateIcon(WIND, fields.getVent());\n-                    updateIcon(RAIN, fields.getPluieInondation());\n-                    updateIcon(STORM, fields.getOrage());\n-                    updateIcon(FLOOD, fields.getInondation());\n-                    updateIcon(SNOW, fields.getNeige());\n-                    updateIcon(HEAT, fields.getCanicule());\n-                    updateIcon(FREEZE, fields.getGrandFroid());\n-                    updateIcon(AVALANCHE, fields.getAvalanches());\n+                    fields.getDateInsert().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+                    fields.getDatePrevue().ifPresent(date -> updateDate(END_TIME, date));\n                 }));\n     }\n \n-    public void updateIcon(String channelId, String value) {\n-        String iconChannelId = channelId + \"-icon\";\n-        if (isLinked(iconChannelId)) {\n-            String pictoName = channelId + (!value.isEmpty() ? \"_\" + value.toLowerCase() : \"\");\n-            byte[] image = getImage(\"picto\" + File.separator + pictoName + \".gif\");\n-            if (image != null) {\n-                RawType picto = new RawType(image, \"image/gif\");\n-                updateState(iconChannelId, picto);\n-            }\n-        }\n-    }\n-\n-    private byte @Nullable [] getImage(String iconPath) {\n-        URL url = FrameworkUtil.getBundle(getClass()).getResource(iconPath);\n-        logger.debug(\"Path to icon image resource is: {}\", url);\n-        try (InputStream in = new BufferedInputStream(url.openStream())) {\n-            ByteArrayOutputStream bos = new ByteArrayOutputStream();\n-            int next = in.read();\n-            while (next > -1) {\n-                bos.write(next);\n-                next = in.read();\n-            }\n-            bos.flush();\n-            return bos.toByteArray();\n+    public @Nullable String getResource(String iconPath) {\n+        Bundle bundle = FrameworkUtil.getBundle(getClass());\n+        try (InputStream stream = bundle.getResource(iconPath).openStream()) {\n+            return new BufferedReader(new InputStreamReader(stream)).lines().collect(Collectors.joining(\"\\n\"));\n         } catch (IOException e) {\n-            logger.debug(\"I/O exception occurred getting image data: {}\", e.getMessage(), e);\n+            logger.warn(\"Unable to load ressource '{}' : {}\", iconPath, e.getMessage());\n         }\n         return null;\n     }\n \n-    public void updateAlertString(String channelId, String value) {\n-        if (!value.isEmpty() && isLinked(channelId)) {\n-            int level = ALERT_LEVELS.indexOf(value);\n-            if (level != -1) {\n-                updateState(channelId, new StringType(Integer.toString(level)));\n-            } else {\n-                updateState(channelId, UnDefType.UNDEF);\n-                logger.warn(\"Value {} is not a valid alert level for channel {}\", value, channelId);\n+    public void updateAlert(String channelId, AlertLevel value) {\n+        String channelIcon = channelId + \"-icon\";\n+        if (value != AlertLevel.UNKNOWN) {\n+            if (isLinked(channelId)) {\n+                updateState(channelId, new StringType(value.name()));\n+            }\n+            if (isLinked(channelIcon)) {\n+                String resource = getResource(String.format(\"picto/%s.svg\", channelId));\n+                if (resource != null) {\n+                    resource = resource.replaceAll(ALERT_COLORS.get(AlertLevel.UNKNOWN), ALERT_COLORS.get(value));\n+                }\n+                updateState(channelIcon,\n+                        resource != null ? new RawType(resource.getBytes(), \"image/svg+xml\") : UnDefType.NULL);", "originalCommit": "8eb9b8d83819d4185ff9706e0240e82e4c5a8af0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyMzQ2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/8801#discussion_r507623466", "bodyText": "UNDEF / NULL... I always have this debate :-) I understood that UNDEF was reserved to the core prior any binding update.", "author": "clinique", "createdAt": "2020-10-19T10:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyMDg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyNDgxMg==", "url": "https://github.com/openhab/openhab-addons/pull/8801#discussion_r507624812", "bodyText": "That is the reverse.\nNULL is the initial value and should be set only by the framework.", "author": "lolodomo", "createdAt": "2020-10-19T10:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyMDg0Nw=="}], "type": "inlineReview"}, {"oid": "b62067a8ac7ce626ab294003cb3a1c18fd6ef16d", "url": "https://github.com/openhab/openhab-addons/commit/b62067a8ac7ce626ab294003cb3a1c18fd6ef16d", "message": "Code review\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-19T10:07:51Z", "type": "commit"}, {"oid": "a7c8223a4642a1322a38a37d536ca977df3c5759", "url": "https://github.com/openhab/openhab-addons/commit/a7c8223a4642a1322a38a37d536ca977df3c5759", "message": "Updating icons so they display nicely in MainUI\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-10-19T10:50:44Z", "type": "commit"}]}