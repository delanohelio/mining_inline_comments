{"pr_number": 7033, "pr_title": "[mqtt.homeassistant] Bugfix in ComponentLight", "pr_createdAt": "2020-02-19T03:22:27Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7033", "timeline": [{"oid": "411cd036513355409e276f9c8d92069226bdf039", "url": "https://github.com/openhab/openhab-addons/commit/411cd036513355409e276f9c8d92069226bdf039", "message": "ixed bugs in ComponentLight and HomeAssistantThingHandler\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>", "committedDate": "2020-02-17T17:52:16Z", "type": "commit"}, {"oid": "0983a397341679b6f8d4db7948d63e98dd086da8", "url": "https://github.com/openhab/openhab-addons/commit/0983a397341679b6f8d4db7948d63e98dd086da8", "message": "ixed bugs in ComponentLight and HomeAssistantThingHandler\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>", "committedDate": "2020-02-17T22:22:53Z", "type": "commit"}, {"oid": "6ed9f5da6c2c1f38fcb451b52c3447b1075593b8", "url": "https://github.com/openhab/openhab-addons/commit/6ed9f5da6c2c1f38fcb451b52c3447b1075593b8", "message": "Merge branch '2.5.x' of https://github.com/mehoekstra/openhab-addons into 2.5.x", "committedDate": "2020-02-17T22:24:19Z", "type": "commit"}, {"oid": "bde8738548b758a70e3b0057a26457d5f58798d7", "url": "https://github.com/openhab/openhab-addons/commit/bde8738548b758a70e3b0057a26457d5f58798d7", "message": "Merge branch '2.5.x' of https://github.com/openhab/openhab-addons into 2.5.x", "committedDate": "2020-02-19T02:29:54Z", "type": "commit"}, {"oid": "1b84cfa14dda179ea29b2fec199114367df8810e", "url": "https://github.com/openhab/openhab-addons/commit/1b84cfa14dda179ea29b2fec199114367df8810e", "message": "rolling back 2 changes", "committedDate": "2020-02-19T02:48:06Z", "type": "commit"}, {"oid": "86b55236406e0bb5edab8366c04c09e4cbab0d90", "url": "https://github.com/openhab/openhab-addons/commit/86b55236406e0bb5edab8366c04c09e4cbab0d90", "message": "rolling back 2 changes\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>", "committedDate": "2020-02-19T03:09:27Z", "type": "commit"}, {"oid": "cf68a416860b8d26e0d7bce668e5366326f7aaea", "url": "https://github.com/openhab/openhab-addons/commit/cf68a416860b8d26e0d7bce668e5366326f7aaea", "message": "Merge branch 'homelight' of https://github.com/mehoekstra/openhab-addons into homelight\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>", "committedDate": "2020-02-19T03:33:38Z", "type": "commit"}, {"oid": "cf68a416860b8d26e0d7bce668e5366326f7aaea", "url": "https://github.com/openhab/openhab-addons/commit/cf68a416860b8d26e0d7bce668e5366326f7aaea", "message": "Merge branch 'homelight' of https://github.com/mehoekstra/openhab-addons into homelight\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>", "committedDate": "2020-02-19T03:33:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMDMxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7033#discussion_r382220313", "bodyText": "Why is only the color channel added?", "author": "J-N-K", "createdAt": "2020-02-20T19:47:09Z", "path": "bundles/org.openhab.binding.mqtt.homeassistant/src/main/java/org/openhab/binding/mqtt/homeassistant/internal/ComponentLight.java", "diffHunk": "@@ -118,7 +118,7 @@ public ComponentLight(CFactory.ComponentConfiguration builder) {\n                 .commandTopic(channelConfiguration.brightness_command_topic, channelConfiguration.retain)//\n                 .build(false);\n \n-        channels.put(switchChannelID, colorChannel);\n+        channels.put(colorChannelID, colorChannel);", "originalCommit": "cf68a416860b8d26e0d7bce668e5366326f7aaea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIzMjU2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7033#discussion_r382232566", "bodyText": "Good question.  I'm not certain as this was designed by @davidgraeff .  Before my change, only the color channel was added, but with the light channel ID.  From my limited experimentation the color channel is the only one that seems to matter.  The OpenHab Color Item in the UI has sliders for color, saturation, and brightness, but in the end the changes are translated into RGB color values and sent to the color channel.", "author": "mehoekstra", "createdAt": "2020-02-20T20:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMDMxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk4NjA3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7033#discussion_r382986070", "bodyText": "Mhm. I did look at the code and channels are always added with their id in buildChannel, in this case channels.put(colorChannelID, colorChannel); is already called in l. 114.\nSince none of the other components call channels.put, this probably is done by intention here. I'm not 100% sure it is a good idea to change that. Are there any problems that arise from the old code?", "author": "J-N-K", "createdAt": "2020-02-23T09:11:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMDMxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQyMzE4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7033#discussion_r383423185", "bodyText": "That is interesting @J-N-K\nI started out just trying to be an OpenHAB user, but found that after my light was discovered (after I realized it needed to take RGB commands), changes made in the Paper UI didn't make it through to the MQTT broker.  And the log file showed warnings \"Channel ... not supported!\".\nWhat I found was that for a MQTT Homeassistant light, after it is discovered a Color item is created in Open HAB and a channel is created between the Color item and the Light Thing.  Then if I change any of the properties of the Color item in the OpenHAB Paper UI (color, brightness etc.) This method is called from line 125 of AbstractMQTTThingHandler in mqtt.generic:\n@Override\npublic void handleCommand(ChannelUID channelUID, Command command) {\n    if (connection == null) {\n        return;\n    }\n\n    final @Nullable ChannelState data = getChannelState(channelUID);\n\n    if (data == null) {\n        logger.warn(\"Channel {} not supported!\", channelUID);\n        return;\n    }\n\nDebugging shows that the result from getChannelState was null, and the channel UID passed in ends with \"#color\".\ngetChannelState is implemented here at line 223 of HomeAssistantThingHander.java\n@SuppressWarnings({ \"null\", \"unused\" })\n@Override\npublic @Nullable ChannelState getChannelState(ChannelUID channelUID) {\n    String groupID = channelUID.getGroupId();\n    if (groupID == null) {\n        return null;\n    }\n    AbstractComponent<?> component;\n    synchronized (haComponents) { // sync whenever discoverComponents is started\n        component = haComponents.get(groupID);\n    }\n    if (component == null) {\n        return null;\n    }\n    CChannel componentChannel = component.channel(channelUID.getIdWithoutGroup());\n    if (componentChannel == null) {\n        return null;\n    }\n\nThe component.channel function is implemented at line 185 in AbstractComponent.java\npublic @Nullable CChannel channel(String channelID) {\n    return channels.get(channelID);\n}\n\nFurther debugging shows that channelUID.getIdWithoutGroup() returns \"color\" and channels.get returns null without my changes, the debugger showed that the channels tree contained only one item labeled \"light\".  So a lookup with the name \"color\" failed.  With my change, registering the \"color\" UID in channels.put, the lookup succeeds and the changes made in the Color Item propagate through properly to the MQTT broker.  I can try some additional debugging to see why the put that you mention doesn't seem to be called.", "author": "mehoekstra", "createdAt": "2020-02-24T18:01:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMDMxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0ODg2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7033#discussion_r383548866", "bodyText": "I haven't had a chance to debug further.  But looking at the implementation in ComponentLight.java, it calls build method passing false.  Thus component.channels.put is not called.  I can't say why it was implemented this way.  Thoughts?  Does the fix belong where I put it, or should the creation of the three channels call .build(true)?", "author": "mehoekstra", "createdAt": "2020-02-24T22:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMDMxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxMzk0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7033#discussion_r384013941", "bodyText": "Interesting. I didn't notice that you can pass true or false to the build. Ok. I think I understood why this is done. The reason is that homeassistant has many different topics where information about this device is posted. We need to create three channels to gather all information, but we do not want to expose them to openHAB, therfore we pass \"addToComponet=false\".\nSo the question is: why do we add the color channel with the id of the switch channel. I think this is wrong. @jochen314, since you did a lot of work in the whole MQTT binding in the last weeks, WDYT? I think the suggested fix sounds correct.", "author": "J-N-K", "createdAt": "2020-02-25T17:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMDMxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEwNjQ1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7033#discussion_r384106453", "bodyText": "This fix looks correct to me.\nI never liked this multiplexing done here and it is on my list to change. But HA is very complex here...", "author": "jochen314", "createdAt": "2020-02-25T20:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMDMxMw=="}], "type": "inlineReview"}]}