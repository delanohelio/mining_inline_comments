{"pr_number": 9320, "pr_title": "[remoteopenhab] Asynchronous reading of big API response", "pr_createdAt": "2020-12-10T19:36:24Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9320", "timeline": [{"oid": "d64b4de48c9b0a9dc645a40d815ad77a611dbc0e", "url": "https://github.com/openhab/openhab-addons/commit/d64b4de48c9b0a9dc645a40d815ad77a611dbc0e", "message": "[remoteopenhab] Asynchronous reading of big API response\n\nFix #9281\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-12-10T19:32:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY2NDQyMA==", "url": "https://github.com/openhab/openhab-addons/pull/9320#discussion_r540664420", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                while (true) {\n          \n          \n            \n                                    int read = input.read(buffer);\n          \n          \n            \n                                    if (read < 0) {\n          \n          \n            \n                                        break;\n          \n          \n            \n                                    }\n          \n          \n            \n                                    responseContent.write(buffer, 0, read);\n          \n          \n            \n                                }\n          \n          \n            \n                                input.transferTo(responseContent);", "author": "cpmeister", "createdAt": "2020-12-11T03:30:14Z", "path": "bundles/org.openhab.binding.remoteopenhab/src/main/java/org/openhab/binding/remoteopenhab/internal/rest/RemoteopenhabRestClient.java", "diffHunk": "@@ -481,15 +489,39 @@ public String executeUrl(HttpMethod httpMethod, String url, String acceptHeader,\n         }\n \n         try {\n-            ContentResponse response = request.send();\n-            int statusCode = response.getStatus();\n-            if (statusCode >= HttpStatus.BAD_REQUEST_400) {\n-                String statusLine = statusCode + \" \" + response.getReason();\n-                throw new RemoteopenhabException(\"HTTP call failed: \" + statusLine);\n+            if (asyncReading) {\n+                InputStreamResponseListener listener = new InputStreamResponseListener();\n+                request.send(listener);\n+                Response response = listener.get(5, TimeUnit.SECONDS);\n+                int statusCode = response.getStatus();\n+                if (statusCode != HttpStatus.OK_200) {\n+                    response.abort(new Exception(response.getReason()));\n+                    String statusLine = statusCode + \" \" + response.getReason();\n+                    throw new RemoteopenhabException(\"HTTP call failed: \" + statusLine);\n+                }\n+                ByteArrayOutputStream responseContent = new ByteArrayOutputStream();\n+                byte[] buffer = new byte[256];\n+                try (InputStream input = listener.getInputStream()) {\n+                    while (true) {\n+                        int read = input.read(buffer);\n+                        if (read < 0) {\n+                            break;\n+                        }\n+                        responseContent.write(buffer, 0, read);\n+                    }", "originalCommit": "d64b4de48c9b0a9dc645a40d815ad77a611dbc0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc1NTUzNA==", "url": "https://github.com/openhab/openhab-addons/pull/9320#discussion_r540755534", "bodyText": "Cool, we have a method to do that.", "author": "lolodomo", "createdAt": "2020-12-11T07:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY2NDQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY2NDg0NA==", "url": "https://github.com/openhab/openhab-addons/pull/9320#discussion_r540664844", "bodyText": "You are wrapping RemoteopenhabException in another RemoteopenhabException?", "author": "cpmeister", "createdAt": "2020-12-11T03:31:35Z", "path": "bundles/org.openhab.binding.remoteopenhab/src/main/java/org/openhab/binding/remoteopenhab/internal/rest/RemoteopenhabRestClient.java", "diffHunk": "@@ -481,15 +489,39 @@ public String executeUrl(HttpMethod httpMethod, String url, String acceptHeader,\n         }\n \n         try {\n-            ContentResponse response = request.send();\n-            int statusCode = response.getStatus();\n-            if (statusCode >= HttpStatus.BAD_REQUEST_400) {\n-                String statusLine = statusCode + \" \" + response.getReason();\n-                throw new RemoteopenhabException(\"HTTP call failed: \" + statusLine);\n+            if (asyncReading) {\n+                InputStreamResponseListener listener = new InputStreamResponseListener();\n+                request.send(listener);\n+                Response response = listener.get(5, TimeUnit.SECONDS);\n+                int statusCode = response.getStatus();\n+                if (statusCode != HttpStatus.OK_200) {\n+                    response.abort(new Exception(response.getReason()));\n+                    String statusLine = statusCode + \" \" + response.getReason();\n+                    throw new RemoteopenhabException(\"HTTP call failed: \" + statusLine);\n+                }\n+                ByteArrayOutputStream responseContent = new ByteArrayOutputStream();\n+                byte[] buffer = new byte[256];\n+                try (InputStream input = listener.getInputStream()) {\n+                    while (true) {\n+                        int read = input.read(buffer);\n+                        if (read < 0) {\n+                            break;\n+                        }\n+                        responseContent.write(buffer, 0, read);\n+                    }\n+                }\n+                return new String(responseContent.toByteArray(), StandardCharsets.UTF_8.name());\n+            } else {\n+                ContentResponse response = request.send();\n+                int statusCode = response.getStatus();\n+                if (statusCode >= HttpStatus.BAD_REQUEST_400) {\n+                    String statusLine = statusCode + \" \" + response.getReason();\n+                    throw new RemoteopenhabException(\"HTTP call failed: \" + statusLine);\n+                }\n+                String encoding = response.getEncoding() != null ? response.getEncoding().replaceAll(\"\\\"\", \"\").trim()\n+                        : StandardCharsets.UTF_8.name();\n+                return new String(response.getContent(), encoding);\n             }\n-            String encoding = response.getEncoding() != null ? response.getEncoding().replaceAll(\"\\\"\", \"\").trim()\n-                    : StandardCharsets.UTF_8.name();\n-            return new String(response.getContent(), encoding);\n         } catch (Exception e) {\n             throw new RemoteopenhabException(e);", "originalCommit": "d64b4de48c9b0a9dc645a40d815ad77a611dbc0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f61e5f24e7c5fa69fa9b52a7f8daa66c2c23f677", "url": "https://github.com/openhab/openhab-addons/commit/f61e5f24e7c5fa69fa9b52a7f8daa66c2c23f677", "message": "Consider review comments\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-12-11T08:04:44Z", "type": "commit"}]}