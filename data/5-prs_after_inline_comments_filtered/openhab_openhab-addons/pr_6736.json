{"pr_number": 6736, "pr_title": "[Telegram] Support data URI scheme for base64 encoded images", "pr_createdAt": "2020-01-01T17:50:50Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6736", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3NzIyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362377225", "bodyText": "The input parameter photoURL must not be assigned to.", "author": "9037568", "createdAt": "2020-01-02T06:07:03Z", "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/bot/TelegramActions.java", "diffHunk": "@@ -341,6 +341,15 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                 // Load image from provided base64 image\n                 logger.debug(\"Photo base64 provided; converting to binary.\");\n                 try {\n+                    if (photoURL.startsWith(\"data:\")) // support data URI scheme\n+                    {\n+                        String[] photoURLParts = photoURL.split(\",\");\n+                        if (photoURLParts.length > 1) {\n+                            photoURL = photoURLParts[1];", "originalCommit": "df9d9cbb1356eb1bb5278ab714d59b2384f92473", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjQ3Njk0NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362476945", "bodyText": "What exactly do you mean with \"must not be assigned to\"? From the functional point of view, such an operation is harmless as it doesn't modify the callers data. Do you want to avoid reusing the photoURL because it is a method input argument? The thing is that the photo URL can be both either a payload (e.g. \"F3A693C...\") or a data URI scheme (\"data:image/png;base64,F3A693C...\"). By removing the header, the photoURL is still in a format that could also come directly from the user and thus still applies to the \"method contract\". I would agree if I would misuse the method argument for any other data.\nAnyway, I can change it, but then I would introduce a new local variable that is either set to the input argument directly or to the photoURLParts[1]. Is that what you have in mind?", "author": "ZzetT", "createdAt": "2020-01-02T13:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3NzIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjU0ODU5NA==", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362548594", "bodyText": "Yes please.", "author": "J-N-K", "createdAt": "2020-01-02T17:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3NzIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjU2MjYyOA==", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362562628", "bodyText": "fixed", "author": "ZzetT", "createdAt": "2020-01-02T17:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3NzIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3ODAzMg==", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362378032", "bodyText": "\"The provided base64 string is not a valid data URI scheme\"", "author": "9037568", "createdAt": "2020-01-02T06:15:21Z", "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/bot/TelegramActions.java", "diffHunk": "@@ -341,6 +341,15 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                 // Load image from provided base64 image\n                 logger.debug(\"Photo base64 provided; converting to binary.\");\n                 try {\n+                    if (photoURL.startsWith(\"data:\")) // support data URI scheme\n+                    {\n+                        String[] photoURLParts = photoURL.split(\",\");\n+                        if (photoURLParts.length > 1) {\n+                            photoURL = photoURLParts[1];\n+                        } else {\n+                            logger.warn(\"The provided base64 string doesn't seem to a be valid data URI schema\");", "originalCommit": "df9d9cbb1356eb1bb5278ab714d59b2384f92473", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjU2MjczMg==", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362562732", "bodyText": "fixed", "author": "ZzetT", "createdAt": "2020-01-02T17:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3ODAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ3OTU1OA==", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r363479558", "bodyText": "Please apply correct formatting. brackets should be on the same line.", "author": "Hilbrand", "createdAt": "2020-01-06T20:57:38Z", "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/bot/TelegramActions.java", "diffHunk": "@@ -341,7 +341,22 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                 // Load image from provided base64 image\n                 logger.debug(\"Photo base64 provided; converting to binary.\");\n                 try {\n-                    InputStream is = Base64.getDecoder().wrap(new ByteArrayInputStream(photoURL.getBytes(\"UTF-8\")));\n+                    final String photoB64Data;\n+                    if (photoURL.startsWith(\"data:\")) // support data URI scheme\n+                    {", "originalCommit": "f1b620fa4844faab5768a69b599f3fd7e89de4d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ3OTk4Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r363479987", "bodyText": "Use StandardCharsets.UTF_8 instead of string", "author": "Hilbrand", "createdAt": "2020-01-06T20:58:43Z", "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/bot/TelegramActions.java", "diffHunk": "@@ -341,7 +341,22 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                 // Load image from provided base64 image\n                 logger.debug(\"Photo base64 provided; converting to binary.\");\n                 try {\n-                    InputStream is = Base64.getDecoder().wrap(new ByteArrayInputStream(photoURL.getBytes(\"UTF-8\")));\n+                    final String photoB64Data;\n+                    if (photoURL.startsWith(\"data:\")) // support data URI scheme\n+                    {\n+                        String[] photoURLParts = photoURL.split(\",\");\n+                        if (photoURLParts.length > 1) {\n+                            photoB64Data = photoURLParts[1];\n+                        } else {\n+                            logger.warn(\"The provided base64 string is not a valid data URI scheme\");\n+                            return false;\n+                        }\n+                    }\n+                    else\n+                    {\n+                        photoB64Data = photoURL;\n+                    }\n+                    InputStream is = Base64.getDecoder().wrap(new ByteArrayInputStream(photoB64Data.getBytes(\"UTF-8\")));", "originalCommit": "f1b620fa4844faab5768a69b599f3fd7e89de4d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce9464a9e0cff430babc42b56175b854571d511f", "url": "https://github.com/openhab/openhab-addons/commit/ce9464a9e0cff430babc42b56175b854571d511f", "message": "support data URI scheme for base64 encoded images\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>", "committedDate": "2020-01-06T21:55:37Z", "type": "commit"}, {"oid": "dec92fbef761ef2ff9646fab3fef33540013e805", "url": "https://github.com/openhab/openhab-addons/commit/dec92fbef761ef2ff9646fab3fef33540013e805", "message": "improved documentation, avoid usage of method input parameter for re-assignment\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>", "committedDate": "2020-01-06T21:55:37Z", "type": "commit"}, {"oid": "5ebfd2e1135cc104a0fbf4dd3e77d83fff9cf21d", "url": "https://github.com/openhab/openhab-addons/commit/5ebfd2e1135cc104a0fbf4dd3e77d83fff9cf21d", "message": "fixed formatting and replaced \"UTF-8\" string by StandardCharsets.UTF_8 enum\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>", "committedDate": "2020-01-06T21:55:48Z", "type": "commit"}, {"oid": "91d7854a66604e5b2626bee8c0f0b23bd6300b7d", "url": "https://github.com/openhab/openhab-addons/commit/91d7854a66604e5b2626bee8c0f0b23bd6300b7d", "message": "removed unnecessary try-catch\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>", "committedDate": "2020-01-06T21:55:48Z", "type": "commit"}, {"oid": "91d7854a66604e5b2626bee8c0f0b23bd6300b7d", "url": "https://github.com/openhab/openhab-addons/commit/91d7854a66604e5b2626bee8c0f0b23bd6300b7d", "message": "removed unnecessary try-catch\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>", "committedDate": "2020-01-06T21:55:48Z", "type": "forcePushed"}]}