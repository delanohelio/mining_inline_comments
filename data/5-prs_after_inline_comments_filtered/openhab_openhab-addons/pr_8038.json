{"pr_number": 8038, "pr_title": "[lgwebos] Improved WebSocket reconnect/disconnect", "pr_createdAt": "2020-06-29T05:55:51Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8038", "timeline": [{"oid": "03ec47271bd434f46272f472d56dd7956c9ed6a5", "url": "https://github.com/openhab/openhab-addons/commit/03ec47271bd434f46272f472d56dd7956c9ed6a5", "message": "[lgwebos] Improved WebSocket reconnect/disconnect\n\nRelated to #8027\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-29T05:50:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwMTU3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/8038#discussion_r447301577", "bodyText": "clients implementation of stop() already handles states. It just adds overhead and may even introduce a bug:\nThere is also a STARTING state, in which stop would not be called, cause isStarted will not return true yet.\nIt also requires that activate and deactivate are never called concurrently - which is probably the case - so no issue.", "author": "sprehn", "createdAt": "2020-06-29T22:45:11Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LGWebOSHandlerFactory.java", "diffHunk": "@@ -95,10 +95,12 @@ protected void activate(ComponentContext componentContext) {\n     @Override\n     protected void deactivate(ComponentContext componentContext) {\n         super.deactivate(componentContext);\n-        try {\n-            this.webSocketClient.stop();\n-        } catch (Exception e) {\n-            logger.warn(\"Unable to to stop websocket client.\", e);\n+        if (this.webSocketClient.isStarted()) {", "originalCommit": "03ec47271bd434f46272f472d56dd7956c9ed6a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNDU2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/8038#discussion_r447314563", "bodyText": "actually not necessary. session will be cleared in onClose", "author": "sprehn", "createdAt": "2020-06-29T23:24:05Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java", "diffHunk": "@@ -185,6 +187,11 @@ public void connect() {\n \n     public void disconnect() {\n         Optional.ofNullable(this.session).ifPresent(s -> s.close());\n+        this.session = null;", "originalCommit": "03ec47271bd434f46272f472d56dd7956c9ed6a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f31b4f7bee1d0a07d35f26e661509cfe8f758ba0", "url": "https://github.com/openhab/openhab-addons/commit/f31b4f7bee1d0a07d35f26e661509cfe8f758ba0", "message": "Review comments considered\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-07-04T14:55:35Z", "type": "commit"}, {"oid": "62a1f151dcd15543208583f73e7a80f16b1cf78f", "url": "https://github.com/openhab/openhab-addons/commit/62a1f151dcd15543208583f73e7a80f16b1cf78f", "message": "Destroy WebSocket client after stopping it\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-07-05T10:35:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2NDQzNQ==", "url": "https://github.com/openhab/openhab-addons/pull/8038#discussion_r449864435", "bodyText": "Are you sure this is safe? Especially if the handler is re-initialized immediately (e.g. due to a configuration update)?", "author": "J-N-K", "createdAt": "2020-07-05T11:05:00Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSTVSocket.java", "diffHunk": "@@ -187,7 +187,6 @@ public void connect() {\n \n     public void disconnect() {\n         Optional.ofNullable(this.session).ifPresent(s -> s.close());\n-        this.session = null;", "originalCommit": "f31b4f7bee1d0a07d35f26e661509cfe8f758ba0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2NjI5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/8038#discussion_r449866299", "bodyText": "I first added this line but the review comment was it was useless so I removed it.", "author": "lolodomo", "createdAt": "2020-07-05T11:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2NDQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcxNjIxNw==", "url": "https://github.com/openhab/openhab-addons/pull/8038#discussion_r451716217", "bodyText": "Destroy means this  instance in webSocketClient cannot be started again.\nSince we create this instance in the constructor it means this is OK as long as activate is never called again after deactivate.\nIf this is assured by the OSGI specification, then it will work. I am not an expert on this OSGI lifecycle.\nthe diagram here suggests that it is possible to run through a cycle of deactivate and activate:\nhttps://www.openhab.org/docs/developer/osgi/osgids.html#component-lifecycle", "author": "sprehn", "createdAt": "2020-07-08T17:38:40Z", "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/LGWebOSHandlerFactory.java", "diffHunk": "@@ -97,6 +97,7 @@ protected void deactivate(ComponentContext componentContext) {\n         super.deactivate(componentContext);\n         try {\n             this.webSocketClient.stop();\n+            this.webSocketClient.destroy();", "originalCommit": "62a1f151dcd15543208583f73e7a80f16b1cf78f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk3NTQxMA==", "url": "https://github.com/openhab/openhab-addons/pull/8038#discussion_r451975410", "bodyText": "Ok, I will remove the destroy and check again the 12 binfings with this new information.", "author": "lolodomo", "createdAt": "2020-07-09T05:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcxNjIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MjMxOA==", "url": "https://github.com/openhab/openhab-addons/pull/8038#discussion_r452652318", "bodyText": "Removed", "author": "lolodomo", "createdAt": "2020-07-10T06:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcxNjIxNw=="}], "type": "inlineReview"}, {"oid": "0bea83345548211751a99ba9fd46105a9dabcd4f", "url": "https://github.com/openhab/openhab-addons/commit/0bea83345548211751a99ba9fd46105a9dabcd4f", "message": "Do not destroy the WebSocket client\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-07-10T06:43:39Z", "type": "commit"}]}