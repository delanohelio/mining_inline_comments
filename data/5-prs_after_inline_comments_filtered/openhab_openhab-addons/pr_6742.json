{"pr_number": 6742, "pr_title": "[upb] UPB Binding initial contribution", "pr_createdAt": "2020-01-02T02:41:05Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6742", "timeline": [{"oid": "460f58aaa097a2d61304673ec922edafd16306c9", "url": "https://github.com/openhab/openhab-addons/commit/460f58aaa097a2d61304673ec922edafd16306c9", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-01-02T02:42:54Z", "type": "forcePushed"}, {"oid": "df50e6516a076d374da1fb7d1ab83ade177c8ada", "url": "https://github.com/openhab/openhab-addons/commit/df50e6516a076d374da1fb7d1ab83ade177c8ada", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-01-05T01:55:53Z", "type": "forcePushed"}, {"oid": "13da44c75d31c92f12834cf1601408fe1cc6c8cf", "url": "https://github.com/openhab/openhab-addons/commit/13da44c75d31c92f12834cf1601408fe1cc6c8cf", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-01-05T04:56:27Z", "type": "forcePushed"}, {"oid": "cbdd3109e8ce737da37cdff0800760c8e91d865b", "url": "https://github.com/openhab/openhab-addons/commit/cbdd3109e8ce737da37cdff0800760c8e91d865b", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-01-05T16:12:01Z", "type": "forcePushed"}, {"oid": "c7bb5ebff65a609265c9aae3f3a1284aea97a214", "url": "https://github.com/openhab/openhab-addons/commit/c7bb5ebff65a609265c9aae3f3a1284aea97a214", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-01-08T02:29:23Z", "type": "forcePushed"}, {"oid": "0f9b2805522650c8650773f5d3d4adff4e2beda8", "url": "https://github.com/openhab/openhab-addons/commit/0f9b2805522650c8650773f5d3d4adff4e2beda8", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-01-08T02:30:03Z", "type": "forcePushed"}, {"oid": "3223e8570df25632fe98d4774c3ad2ee51b89967", "url": "https://github.com/openhab/openhab-addons/commit/3223e8570df25632fe98d4774c3ad2ee51b89967", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-01-08T02:30:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2MDMyMA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r390660320", "bodyText": "Instead of throwing a RuntimeException you should be logging then error and then return immediately.", "author": "cpmeister", "createdAt": "2020-03-10T23:03:14Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,284 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    private volatile WriteRunnable currentWrite = null;\n+    private volatile SerialPort serialPort;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            throw new RuntimeException(e);", "originalCommit": "3223e8570df25632fe98d4774c3ad2ee51b89967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2MjAwMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r390662001", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.error(\"error writing message\", e);\n          \n          \n            \n                            logger.warn(\"error writing message\", e);", "author": "cpmeister", "createdAt": "2020-03-10T23:08:36Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,284 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    private volatile WriteRunnable currentWrite = null;\n+    private volatile SerialPort serialPort;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            throw new RuntimeException(e);\n+        }\n+        serialPort.notifyOnDataAvailable(true);\n+\n+        final byte[] buffer = new byte[256];\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            enterMessageMode();\n+            while (!done) {\n+                try {\n+                    for (int len = -1; (len = in.read(buffer)) >= 0;) {\n+                        addData(buffer, len);\n+                        if (done) {\n+                            break;\n+                        }\n+                    }\n+                } catch (final IOException e) {\n+                    logger.error(\"Exception during receive, exiting thread\", e);\n+                    break;\n+                }\n+            }\n+        } catch (final Exception e) {\n+            logger.error(\"Exception in UPB read thread\", e);\n+        } finally {\n+            logger.info(\"shutting down receive thread\");\n+            shutdownAndAwaitTermination(writeExecutor);\n+            serialPort.removeEventListener();\n+            try {\n+                serialPort.close();\n+            } catch (final Exception e) {\n+                // ignore\n+            }\n+        }\n+        logger.debug(\"UPB read thread stopped\");\n+    }\n+\n+    private void addData(final byte[] data, final int length) {\n+        if (bufferLength + length > buffer.length) {\n+            // buffer overflow, discard entire buffer\n+            bufferLength = 0;\n+        }\n+        System.arraycopy(data, 0, buffer, bufferLength, length);\n+        bufferLength += length;\n+        interpretBuffer();\n+    }\n+\n+    private int findMessageLength(final byte[] buffer, final int bufferLength) {\n+        for (int i = 0; i < bufferLength; i++) {\n+            if (buffer[i] == 13) {\n+                return i;\n+            }\n+        }\n+        return -1;\n+    }\n+\n+    /**\n+     * Attempts to interpret any messages that may be contained in the buffer.\n+     */\n+    private void interpretBuffer() {\n+        int messageLength = findMessageLength(buffer, bufferLength);\n+\n+        while (messageLength != -1) {\n+            final String message = new String(Arrays.copyOfRange(buffer, 0, messageLength), US_ASCII);\n+            logger.debug(\"UPB Message: {}\", message);\n+\n+            final int remainingBuffer = bufferLength - messageLength - 1;\n+            if (remainingBuffer > 0) {\n+                System.arraycopy(buffer, messageLength + 1, buffer, 0, remainingBuffer);\n+            }\n+            bufferLength = remainingBuffer;\n+            handleMessage(UPBMessage.fromString(message));\n+            messageLength = findMessageLength(buffer, bufferLength);\n+        }\n+    }\n+\n+    private void handleMessage(final UPBMessage msg) {\n+        switch (msg.getType()) {\n+            case ACK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(true);\n+                }\n+                break;\n+            case NAK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(false);\n+                }\n+                break;\n+            case ACCEPT:\n+                break;\n+            case ERROR:\n+                logger.warn(\"received ERROR response from PIM\");\n+                break;\n+            default:\n+                // ignore\n+        }\n+        listener.incomingMessage(msg);\n+    }\n+\n+    public CompletionStage<CmdStatus> enqueue(final MessageBuilder msg) {\n+        final CompletableFuture<CmdStatus> completion = new CompletableFuture<>();\n+        final Runnable task = new WriteRunnable(msg.build(), completion);\n+        try {\n+            writeExecutor.execute(task);\n+        } catch (final RejectedExecutionException e) {\n+            completion.completeExceptionally(e);\n+        }\n+        return completion;\n+    }\n+\n+    // puts the PIM is in message mode\n+    private void enterMessageMode() {\n+        try {\n+            serialPort.getOutputStream().write(ENABLE_MESSAGE_MODE_CMD);\n+        } catch (final IOException e) {\n+            logger.error(\"error setting message mode\", e);\n+        }\n+    }\n+\n+    void shutdownAndAwaitTermination(final ExecutorService pool) {\n+        pool.shutdown();\n+        try {\n+            if (!pool.awaitTermination(1, TimeUnit.SECONDS)) {\n+                pool.shutdownNow();\n+                if (!pool.awaitTermination(1, TimeUnit.SECONDS)) {\n+                    logger.error(\"executor did not terminate\");\n+                }\n+            }\n+        } catch (final InterruptedException ie) {\n+            pool.shutdownNow();\n+            Thread.currentThread().interrupt();\n+        }\n+    }\n+\n+    public void terminate() {\n+        done = true;\n+        try {\n+            serialPort.close();\n+        } catch (final Exception e) {\n+            logger.warn(\"failed to close serial port\", e);\n+        }\n+    }\n+\n+    private class WriteRunnable implements Runnable {\n+        private static final int MAX_RETRIES = 3;\n+\n+        private final String msg;\n+        private final CompletableFuture<CmdStatus> completion;\n+\n+        private Boolean ack = null;\n+        private volatile CountDownLatch ackLatch;\n+\n+        public WriteRunnable(final String msg, final CompletableFuture<CmdStatus> completion) {\n+            this.msg = msg;\n+            this.completion = completion;\n+        }\n+\n+        // called by reader thread if on ACK or NAK\n+        public void ackReceived(final boolean ack) {\n+            if (logger.isDebugEnabled()) {\n+                if (ack) {\n+                    logger.debug(\"ACK received\");\n+                } else {\n+                    logger.debug(\"NAK received\");\n+                }\n+            }\n+            this.ack = ack;\n+            ackLatch.countDown();\n+        }\n+\n+        @Override\n+        public void run() {\n+            currentWrite = this;\n+            try {\n+                logger.debug(\"Writing bytes: {}\", msg);\n+                final OutputStream out = serialPort.getOutputStream();\n+                for (int tries = 0; tries < MAX_RETRIES && ack == null; tries++) {\n+                    ackLatch = new CountDownLatch(1);\n+                    out.write(0x14);\n+                    out.write(msg.getBytes(US_ASCII));\n+                    out.write(0x0d);\n+                    final boolean acked = ackLatch.await(ACK_TIMEOUT_MS, MILLISECONDS);\n+                    if (acked) {\n+                        break;\n+                    }\n+                    logger.debug(\"ack timed out, retrying ({} of {})\", tries + 1, MAX_RETRIES);\n+                }\n+                if (ack == null) {\n+                    logger.debug(\"write not acked\");\n+                    completion.complete(CmdStatus.WRITE_FAILED);\n+                } else if (ack) {\n+                    completion.complete(CmdStatus.ACK);\n+                } else {\n+                    completion.complete(CmdStatus.NAK);\n+                }\n+            } catch (final Exception e) {\n+                logger.error(\"error writing message\", e);", "originalCommit": "3223e8570df25632fe98d4774c3ad2ee51b89967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2MjA0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r390662043", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.error(\"serial port is not set\");\n          \n          \n            \n                        logger.warn(\"serial port is not set\");", "author": "cpmeister", "createdAt": "2020-03-10T23:08:46Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile SerialIoThread receiveThread;\n+    private volatile ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.error(\"serial port is not set\");", "originalCommit": "3223e8570df25632fe98d4774c3ad2ee51b89967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2MjExNA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r390662114", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.info(\"Stopped UPB serial handler\");\n          \n          \n            \n                    logger.debug(\"Stopped UPB serial handler\");", "author": "cpmeister", "createdAt": "2020-03-10T23:08:58Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile SerialIoThread receiveThread;\n+    private volatile ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.error(\"serial port is not set\");\n+            return;\n+        }\n+\n+        futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_INIT_DELAY_MS,\n+                TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        if (futSerialPortInit != null) {\n+            futSerialPortInit.cancel(true);\n+        }\n+        futSerialPortInit = null;\n+        if (receiveThread != null) {\n+            receiveThread.terminate();\n+            try {\n+                receiveThread.join(1000);\n+            } catch (final InterruptedException e) {\n+                // ignore\n+            }\n+            receiveThread = null;\n+        }\n+        logger.info(\"Stopped UPB serial handler\");", "originalCommit": "3223e8570df25632fe98d4774c3ad2ee51b89967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2MjU3Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r390662576", "bodyText": "remove this logging statement, the user is already notified through a change in the Thing status.", "author": "cpmeister", "createdAt": "2020-03-10T23:10:27Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile SerialIoThread receiveThread;\n+    private volatile ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.error(\"serial port is not set\");\n+            return;\n+        }\n+\n+        futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_INIT_DELAY_MS,\n+                TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        if (futSerialPortInit != null) {\n+            futSerialPortInit.cancel(true);\n+        }\n+        futSerialPortInit = null;\n+        if (receiveThread != null) {\n+            receiveThread.terminate();\n+            try {\n+                receiveThread.join(1000);\n+            } catch (final InterruptedException e) {\n+                // ignore\n+            }\n+            receiveThread = null;\n+        }\n+        logger.info(\"Stopped UPB serial handler\");\n+        super.dispose();\n+    }\n+\n+    private void openSerialPort(final String portId) {\n+        try {\n+            final SerialPort serialPort = tryOpenSerialPort(portId);\n+            if (serialPort == null) {\n+                futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_RETRY_DELAY_MS,\n+                        TimeUnit.MILLISECONDS);\n+                return;\n+            }\n+            logger.debug(\"Starting receive thread\");\n+            receiveThread = new SerialIoThread(serialPort, this);\n+            receiveThread.setName(\"upb-serial-reader\");\n+            // Once the receiver starts, it may set the PIM status to ONLINE\n+            // so we must ensure all initialization is finished at that point.\n+            receiveThread.start();\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (final Exception e) {\n+            logger.error(\"failed to open serial port\", e);\n+        }\n+    }\n+\n+    private SerialPort tryOpenSerialPort(final String portId) {\n+        logger.info(\"opening serial port {}\", portId);\n+        final SerialPortIdentifier portIdentifier = serialPortManager.getIdentifier(portId);\n+        if (portIdentifier == null) {\n+            logger.error(\"port not found: {}\", portId);", "originalCommit": "3223e8570df25632fe98d4774c3ad2ee51b89967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2MjU5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r390662599", "bodyText": "remove this logging statement, the user is already notified through a change in the Thing status.", "author": "cpmeister", "createdAt": "2020-03-10T23:10:31Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile SerialIoThread receiveThread;\n+    private volatile ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.error(\"serial port is not set\");\n+            return;\n+        }\n+\n+        futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_INIT_DELAY_MS,\n+                TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        if (futSerialPortInit != null) {\n+            futSerialPortInit.cancel(true);\n+        }\n+        futSerialPortInit = null;\n+        if (receiveThread != null) {\n+            receiveThread.terminate();\n+            try {\n+                receiveThread.join(1000);\n+            } catch (final InterruptedException e) {\n+                // ignore\n+            }\n+            receiveThread = null;\n+        }\n+        logger.info(\"Stopped UPB serial handler\");\n+        super.dispose();\n+    }\n+\n+    private void openSerialPort(final String portId) {\n+        try {\n+            final SerialPort serialPort = tryOpenSerialPort(portId);\n+            if (serialPort == null) {\n+                futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_RETRY_DELAY_MS,\n+                        TimeUnit.MILLISECONDS);\n+                return;\n+            }\n+            logger.debug(\"Starting receive thread\");\n+            receiveThread = new SerialIoThread(serialPort, this);\n+            receiveThread.setName(\"upb-serial-reader\");\n+            // Once the receiver starts, it may set the PIM status to ONLINE\n+            // so we must ensure all initialization is finished at that point.\n+            receiveThread.start();\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (final Exception e) {\n+            logger.error(\"failed to open serial port\", e);\n+        }\n+    }\n+\n+    private SerialPort tryOpenSerialPort(final String portId) {\n+        logger.info(\"opening serial port {}\", portId);\n+        final SerialPortIdentifier portIdentifier = serialPortManager.getIdentifier(portId);\n+        if (portIdentifier == null) {\n+            logger.error(\"port not found: {}\", portId);\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    Constants.OFFLINE_SERIAL_EXISTS);\n+            return null;\n+        }\n+\n+        final SerialPort serialPort;\n+        try {\n+            serialPort = portIdentifier.open(\"org.openhab.binding.upb\", 1000);\n+        } catch (final PortInUseException e) {\n+            logger.error(\"cannot open serial port\", e);", "originalCommit": "3223e8570df25632fe98d4774c3ad2ee51b89967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8db15e34bfa328068559a6bbbc65da1046183b20", "url": "https://github.com/openhab/openhab-addons/commit/8db15e34bfa328068559a6bbbc65da1046183b20", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-03-11T01:29:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MzE2MA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395373160", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:23:02Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/PIMHandler.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.binding.BaseBridgeHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.internal.UPBController;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Base class for Powerline Interface Module handlers.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public abstract class PIMHandler extends BaseBridgeHandler implements MessageListener, UPBIoHandler {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA4ODMzMw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r396088333", "bodyText": "I'm adding package-level declarations for this.", "author": "marcusb", "createdAt": "2020-03-22T12:33:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MzE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MzM1OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395373359", "bodyText": "I see no reason for this to be volatile\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private volatile UPBController controller;\n          \n          \n            \n                private UPBController controller;", "author": "cpmeister", "createdAt": "2020-03-19T23:23:42Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/PIMHandler.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.binding.BaseBridgeHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.internal.UPBController;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Base class for Powerline Interface Module handlers.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public abstract class PIMHandler extends BaseBridgeHandler implements MessageListener, UPBIoHandler {\n+\n+    private final Logger logger = LoggerFactory.getLogger(PIMHandler.class);\n+\n+    private volatile UPBController controller;", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3Mzg5OA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395373898", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:25:37Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialIoThread extends Thread implements SerialPortEventListener {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NDAzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395374039", "bodyText": "Might be useful to log the error message.", "author": "cpmeister", "createdAt": "2020-03-19T23:26:09Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    private volatile WriteRunnable currentWrite = null;\n+    private volatile SerialPort serialPort;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            logger.warn(\"serial port setup failed\", e);\n+            return;\n+        }\n+        serialPort.notifyOnDataAvailable(true);\n+\n+        final byte[] buffer = new byte[256];\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            enterMessageMode();\n+            while (!done) {\n+                try {\n+                    for (int len = -1; (len = in.read(buffer)) >= 0;) {\n+                        addData(buffer, len);\n+                        if (done) {\n+                            break;\n+                        }\n+                    }\n+                } catch (final IOException e) {\n+                    logger.warn(\"Exception during receive, exiting thread\", e);\n+                    break;\n+                }\n+            }\n+        } catch (final Exception e) {\n+            logger.warn(\"Exception in UPB read thread\", e);\n+        } finally {\n+            logger.debug(\"shutting down receive thread\");\n+            shutdownAndAwaitTermination(writeExecutor);\n+            serialPort.removeEventListener();\n+            try {\n+                serialPort.close();\n+            } catch (final Exception e) {\n+                // ignore\n+            }\n+        }\n+        logger.debug(\"UPB read thread stopped\");\n+    }\n+\n+    private void addData(final byte[] data, final int length) {\n+        if (bufferLength + length > buffer.length) {\n+            // buffer overflow, discard entire buffer\n+            bufferLength = 0;\n+        }\n+        System.arraycopy(data, 0, buffer, bufferLength, length);\n+        bufferLength += length;\n+        interpretBuffer();\n+    }\n+\n+    private int findMessageLength(final byte[] buffer, final int bufferLength) {\n+        for (int i = 0; i < bufferLength; i++) {\n+            if (buffer[i] == 13) {\n+                return i;\n+            }\n+        }\n+        return -1;\n+    }\n+\n+    /**\n+     * Attempts to interpret any messages that may be contained in the buffer.\n+     */\n+    private void interpretBuffer() {\n+        int messageLength = findMessageLength(buffer, bufferLength);\n+\n+        while (messageLength != -1) {\n+            final String message = new String(Arrays.copyOfRange(buffer, 0, messageLength), US_ASCII);\n+            logger.debug(\"UPB Message: {}\", message);\n+\n+            final int remainingBuffer = bufferLength - messageLength - 1;\n+            if (remainingBuffer > 0) {\n+                System.arraycopy(buffer, messageLength + 1, buffer, 0, remainingBuffer);\n+            }\n+            bufferLength = remainingBuffer;\n+            handleMessage(UPBMessage.fromString(message));\n+            messageLength = findMessageLength(buffer, bufferLength);\n+        }\n+    }\n+\n+    private void handleMessage(final UPBMessage msg) {\n+        switch (msg.getType()) {\n+            case ACK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(true);\n+                }\n+                break;\n+            case NAK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(false);\n+                }\n+                break;\n+            case ACCEPT:\n+                break;\n+            case ERROR:\n+                logger.info(\"received ERROR response from PIM\");", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA5ODM0Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r396098346", "bodyText": "There isn't anything to log, the PIM just sends an error indication.", "author": "marcusb", "createdAt": "2020-03-22T14:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NDAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NjQ4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395376483", "bodyText": "If len=-1 that is supposed to mean it is the end of the stream. Wouldn't this code just endlessly call read on a closed stream then?", "author": "cpmeister", "createdAt": "2020-03-19T23:34:36Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    private volatile WriteRunnable currentWrite = null;\n+    private volatile SerialPort serialPort;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            logger.warn(\"serial port setup failed\", e);\n+            return;\n+        }\n+        serialPort.notifyOnDataAvailable(true);\n+\n+        final byte[] buffer = new byte[256];\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            enterMessageMode();\n+            while (!done) {\n+                try {\n+                    for (int len = -1; (len = in.read(buffer)) >= 0;) {\n+                        addData(buffer, len);\n+                        if (done) {\n+                            break;\n+                        }\n+                    }", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA4OTE2OA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r396089168", "bodyText": "Good catch, rewriting this.", "author": "marcusb", "createdAt": "2020-03-22T12:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NjQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3ODMyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395378329", "bodyText": "I would suggest flushing the stream as well to make sure it gets written.", "author": "cpmeister", "createdAt": "2020-03-19T23:40:55Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    private volatile WriteRunnable currentWrite = null;\n+    private volatile SerialPort serialPort;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            logger.warn(\"serial port setup failed\", e);\n+            return;\n+        }\n+        serialPort.notifyOnDataAvailable(true);\n+\n+        final byte[] buffer = new byte[256];\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            enterMessageMode();\n+            while (!done) {\n+                try {\n+                    for (int len = -1; (len = in.read(buffer)) >= 0;) {\n+                        addData(buffer, len);\n+                        if (done) {\n+                            break;\n+                        }\n+                    }\n+                } catch (final IOException e) {\n+                    logger.warn(\"Exception during receive, exiting thread\", e);\n+                    break;\n+                }\n+            }\n+        } catch (final Exception e) {\n+            logger.warn(\"Exception in UPB read thread\", e);\n+        } finally {\n+            logger.debug(\"shutting down receive thread\");\n+            shutdownAndAwaitTermination(writeExecutor);\n+            serialPort.removeEventListener();\n+            try {\n+                serialPort.close();\n+            } catch (final Exception e) {\n+                // ignore\n+            }\n+        }\n+        logger.debug(\"UPB read thread stopped\");\n+    }\n+\n+    private void addData(final byte[] data, final int length) {\n+        if (bufferLength + length > buffer.length) {\n+            // buffer overflow, discard entire buffer\n+            bufferLength = 0;\n+        }\n+        System.arraycopy(data, 0, buffer, bufferLength, length);\n+        bufferLength += length;\n+        interpretBuffer();\n+    }\n+\n+    private int findMessageLength(final byte[] buffer, final int bufferLength) {\n+        for (int i = 0; i < bufferLength; i++) {\n+            if (buffer[i] == 13) {\n+                return i;\n+            }\n+        }\n+        return -1;\n+    }\n+\n+    /**\n+     * Attempts to interpret any messages that may be contained in the buffer.\n+     */\n+    private void interpretBuffer() {\n+        int messageLength = findMessageLength(buffer, bufferLength);\n+\n+        while (messageLength != -1) {\n+            final String message = new String(Arrays.copyOfRange(buffer, 0, messageLength), US_ASCII);\n+            logger.debug(\"UPB Message: {}\", message);\n+\n+            final int remainingBuffer = bufferLength - messageLength - 1;\n+            if (remainingBuffer > 0) {\n+                System.arraycopy(buffer, messageLength + 1, buffer, 0, remainingBuffer);\n+            }\n+            bufferLength = remainingBuffer;\n+            handleMessage(UPBMessage.fromString(message));\n+            messageLength = findMessageLength(buffer, bufferLength);\n+        }\n+    }\n+\n+    private void handleMessage(final UPBMessage msg) {\n+        switch (msg.getType()) {\n+            case ACK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(true);\n+                }\n+                break;\n+            case NAK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(false);\n+                }\n+                break;\n+            case ACCEPT:\n+                break;\n+            case ERROR:\n+                logger.info(\"received ERROR response from PIM\");\n+                break;\n+            default:\n+                // ignore\n+        }\n+        listener.incomingMessage(msg);\n+    }\n+\n+    public CompletionStage<CmdStatus> enqueue(final MessageBuilder msg) {\n+        final CompletableFuture<CmdStatus> completion = new CompletableFuture<>();\n+        final Runnable task = new WriteRunnable(msg.build(), completion);\n+        try {\n+            writeExecutor.execute(task);\n+        } catch (final RejectedExecutionException e) {\n+            completion.completeExceptionally(e);\n+        }\n+        return completion;\n+    }\n+\n+    // puts the PIM is in message mode\n+    private void enterMessageMode() {\n+        try {\n+            serialPort.getOutputStream().write(ENABLE_MESSAGE_MODE_CMD);", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA5ODQyMg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r396098422", "bodyText": "Pretty sure it's not buffering but I'll add it.", "author": "marcusb", "createdAt": "2020-03-22T14:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3ODMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3ODUzOA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395378538", "bodyText": "make sure to flush after this", "author": "cpmeister", "createdAt": "2020-03-19T23:41:47Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    private volatile WriteRunnable currentWrite = null;\n+    private volatile SerialPort serialPort;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            logger.warn(\"serial port setup failed\", e);\n+            return;\n+        }\n+        serialPort.notifyOnDataAvailable(true);\n+\n+        final byte[] buffer = new byte[256];\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            enterMessageMode();\n+            while (!done) {\n+                try {\n+                    for (int len = -1; (len = in.read(buffer)) >= 0;) {\n+                        addData(buffer, len);\n+                        if (done) {\n+                            break;\n+                        }\n+                    }\n+                } catch (final IOException e) {\n+                    logger.warn(\"Exception during receive, exiting thread\", e);\n+                    break;\n+                }\n+            }\n+        } catch (final Exception e) {\n+            logger.warn(\"Exception in UPB read thread\", e);\n+        } finally {\n+            logger.debug(\"shutting down receive thread\");\n+            shutdownAndAwaitTermination(writeExecutor);\n+            serialPort.removeEventListener();\n+            try {\n+                serialPort.close();\n+            } catch (final Exception e) {\n+                // ignore\n+            }\n+        }\n+        logger.debug(\"UPB read thread stopped\");\n+    }\n+\n+    private void addData(final byte[] data, final int length) {\n+        if (bufferLength + length > buffer.length) {\n+            // buffer overflow, discard entire buffer\n+            bufferLength = 0;\n+        }\n+        System.arraycopy(data, 0, buffer, bufferLength, length);\n+        bufferLength += length;\n+        interpretBuffer();\n+    }\n+\n+    private int findMessageLength(final byte[] buffer, final int bufferLength) {\n+        for (int i = 0; i < bufferLength; i++) {\n+            if (buffer[i] == 13) {\n+                return i;\n+            }\n+        }\n+        return -1;\n+    }\n+\n+    /**\n+     * Attempts to interpret any messages that may be contained in the buffer.\n+     */\n+    private void interpretBuffer() {\n+        int messageLength = findMessageLength(buffer, bufferLength);\n+\n+        while (messageLength != -1) {\n+            final String message = new String(Arrays.copyOfRange(buffer, 0, messageLength), US_ASCII);\n+            logger.debug(\"UPB Message: {}\", message);\n+\n+            final int remainingBuffer = bufferLength - messageLength - 1;\n+            if (remainingBuffer > 0) {\n+                System.arraycopy(buffer, messageLength + 1, buffer, 0, remainingBuffer);\n+            }\n+            bufferLength = remainingBuffer;\n+            handleMessage(UPBMessage.fromString(message));\n+            messageLength = findMessageLength(buffer, bufferLength);\n+        }\n+    }\n+\n+    private void handleMessage(final UPBMessage msg) {\n+        switch (msg.getType()) {\n+            case ACK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(true);\n+                }\n+                break;\n+            case NAK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(false);\n+                }\n+                break;\n+            case ACCEPT:\n+                break;\n+            case ERROR:\n+                logger.info(\"received ERROR response from PIM\");\n+                break;\n+            default:\n+                // ignore\n+        }\n+        listener.incomingMessage(msg);\n+    }\n+\n+    public CompletionStage<CmdStatus> enqueue(final MessageBuilder msg) {\n+        final CompletableFuture<CmdStatus> completion = new CompletableFuture<>();\n+        final Runnable task = new WriteRunnable(msg.build(), completion);\n+        try {\n+            writeExecutor.execute(task);\n+        } catch (final RejectedExecutionException e) {\n+            completion.completeExceptionally(e);\n+        }\n+        return completion;\n+    }\n+\n+    // puts the PIM is in message mode\n+    private void enterMessageMode() {\n+        try {\n+            serialPort.getOutputStream().write(ENABLE_MESSAGE_MODE_CMD);\n+        } catch (final IOException e) {\n+            logger.warn(\"error setting message mode\", e);\n+        }\n+    }\n+\n+    void shutdownAndAwaitTermination(final ExecutorService pool) {\n+        pool.shutdown();\n+        try {\n+            if (!pool.awaitTermination(1, TimeUnit.SECONDS)) {\n+                pool.shutdownNow();\n+                if (!pool.awaitTermination(1, TimeUnit.SECONDS)) {\n+                    logger.warn(\"executor did not terminate\");\n+                }\n+            }\n+        } catch (final InterruptedException ie) {\n+            pool.shutdownNow();\n+            Thread.currentThread().interrupt();\n+        }\n+    }\n+\n+    public void terminate() {\n+        done = true;\n+        try {\n+            serialPort.close();\n+        } catch (final Exception e) {\n+            logger.warn(\"failed to close serial port\", e);\n+        }\n+    }\n+\n+    private class WriteRunnable implements Runnable {\n+        private static final int MAX_RETRIES = 3;\n+\n+        private final String msg;\n+        private final CompletableFuture<CmdStatus> completion;\n+\n+        private Boolean ack = null;\n+        private volatile CountDownLatch ackLatch;\n+\n+        public WriteRunnable(final String msg, final CompletableFuture<CmdStatus> completion) {\n+            this.msg = msg;\n+            this.completion = completion;\n+        }\n+\n+        // called by reader thread if on ACK or NAK\n+        public void ackReceived(final boolean ack) {\n+            if (logger.isDebugEnabled()) {\n+                if (ack) {\n+                    logger.debug(\"ACK received\");\n+                } else {\n+                    logger.debug(\"NAK received\");\n+                }\n+            }\n+            this.ack = ack;\n+            ackLatch.countDown();\n+        }\n+\n+        @Override\n+        public void run() {\n+            currentWrite = this;\n+            try {\n+                logger.debug(\"Writing bytes: {}\", msg);\n+                final OutputStream out = serialPort.getOutputStream();\n+                for (int tries = 0; tries < MAX_RETRIES && ack == null; tries++) {\n+                    ackLatch = new CountDownLatch(1);\n+                    out.write(0x14);\n+                    out.write(msg.getBytes(US_ASCII));\n+                    out.write(0x0d);", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3OTIyMA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395379220", "bodyText": "remove comment", "author": "cpmeister", "createdAt": "2020-03-19T23:44:06Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile SerialIoThread receiveThread;\n+    private volatile ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.warn(\"serial port is not set\");\n+            return;\n+        }\n+\n+        futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_INIT_DELAY_MS,\n+                TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        if (futSerialPortInit != null) {\n+            futSerialPortInit.cancel(true);\n+        }\n+        futSerialPortInit = null;\n+        if (receiveThread != null) {\n+            receiveThread.terminate();\n+            try {\n+                receiveThread.join(1000);\n+            } catch (final InterruptedException e) {\n+                // ignore\n+            }\n+            receiveThread = null;\n+        }\n+        logger.debug(\"Stopped UPB serial handler\");\n+        super.dispose();\n+    }\n+\n+    private void openSerialPort(final String portId) {\n+        try {\n+            final SerialPort serialPort = tryOpenSerialPort(portId);\n+            if (serialPort == null) {\n+                futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_RETRY_DELAY_MS,\n+                        TimeUnit.MILLISECONDS);\n+                return;\n+            }\n+            logger.debug(\"Starting receive thread\");\n+            receiveThread = new SerialIoThread(serialPort, this);\n+            receiveThread.setName(\"upb-serial-reader\");\n+            // Once the receiver starts, it may set the PIM status to ONLINE\n+            // so we must ensure all initialization is finished at that point.\n+            receiveThread.start();\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (final Exception e) {\n+            logger.warn(\"failed to open serial port\", e);\n+        }\n+    }\n+\n+    private SerialPort tryOpenSerialPort(final String portId) {\n+        logger.debug(\"opening serial port {}\", portId);\n+        final SerialPortIdentifier portIdentifier = serialPortManager.getIdentifier(portId);\n+        if (portIdentifier == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    Constants.OFFLINE_SERIAL_EXISTS);\n+            return null;\n+        }\n+\n+        final SerialPort serialPort;\n+        try {\n+            serialPort = portIdentifier.open(\"org.openhab.binding.upb\", 1000);\n+        } catch (final PortInUseException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    Constants.OFFLINE_SERIAL_INUSE);\n+            return null;\n+        }\n+        try {\n+            serialPort.setSerialPortParams(BAUD_RATE, SerialPort.DATABITS_8, SerialPort.STOPBITS_1,\n+                    SerialPort.PARITY_NONE);\n+            serialPort.setFlowControlMode(SerialPort.FLOWCONTROL_NONE);\n+            try {\n+                serialPort.enableReceiveThreshold(1);\n+                serialPort.enableReceiveTimeout(SERIAL_RECEIVE_TIMEOUT);\n+            } catch (final UnsupportedCommOperationException e) {\n+                // ignore - not supported for RFC2217 ports\n+            }\n+        } catch (final UnsupportedCommOperationException e) {\n+            logger.warn(\"cannot open serial port\", e);\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    Constants.OFFLINE_SERIAL_UNSUPPORTED);\n+            return null;\n+        }\n+        logger.debug(\"Serial port is initialized\");\n+        return serialPort;\n+    }\n+\n+    @Override\n+    public CompletionStage<CmdStatus> sendPacket(final MessageBuilder msg) {\n+        if (receiveThread != null) {\n+            return receiveThread.enqueue(msg);\n+        } else {\n+            return exceptionallyCompletedFuture(new IllegalStateException(\"I/O thread not active\"));\n+        }\n+    }\n+\n+    @Override\n+    public void deviceDiscovered(int node) {\n+        // TODO Auto-generated method stub", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA5ODU5MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r396098591", "bodyText": "removed the method", "author": "marcusb", "createdAt": "2020-03-22T14:16:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3OTIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3OTc2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395379762", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:46:14Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialPIMHandler extends PIMHandler {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3OTg5NA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395379894", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:46:44Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingChannel.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+\n+/**\n+ * A channel supported by UPB things.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class UPBThingChannel {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3OTk1NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395379955", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:46:54Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingHandler.java", "diffHunk": "@@ -0,0 +1,277 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handler for things representing devices on an UPB network.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class UPBThingHandler extends BaseThingHandler {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MTA3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395381073", "bodyText": "Why do you need to make keys? Can't you just put the objects in a Set instead of a map?", "author": "cpmeister", "createdAt": "2020-03-19T23:51:10Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/UPBController.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.UPBDevice.DeviceState;\n+import org.openhab.binding.upb.handler.UPBThingHandler;\n+import org.openhab.binding.upb.handler.VirtualThingHandler;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.openhab.binding.upb.internal.message.UPBMessage.Command;\n+import org.openhab.binding.upb.internal.message.UPBMessage.Type;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Controller logic for UPB network communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class UPBController {\n+    private final Logger logger = LoggerFactory.getLogger(UPBController.class);\n+\n+    // Maps of devices and things keyed by (networkId, unitId)\n+    private final ConcurrentHashMap<Integer, UPBDevice> devices = new ConcurrentHashMap<>();\n+    private final ConcurrentHashMap<Integer, UPBThingHandler> things = new ConcurrentHashMap<>();\n+\n+    public void incomingMessage(final UPBMessage msg) {\n+        if (msg.getType() != Type.MESSAGE_REPORT) {\n+            return;\n+        }\n+\n+        final byte networkId = msg.getNetwork();\n+        final byte srcId = msg.getSource();\n+        final byte dstId = msg.getDestination();\n+        final Command cmd = msg.getCommand();\n+        logger.debug(\"received message, network={} src={} dst={} cmd={}\", networkId & 0xff, srcId & 0xff, dstId & 0xff,\n+                cmd);\n+        if (!isValidId(srcId)) {\n+            return;\n+        }\n+        final int srcAddr = mkAddr(networkId, srcId);\n+        final UPBDevice src = devices.getOrDefault(srcAddr, new UPBDevice(networkId, srcId));\n+        src.setState(DeviceState.ALIVE);\n+\n+        final UPBThingHandler thingHnd = things.get(srcAddr);\n+        if (thingHnd == null) {\n+            logger.debug(\"unknown source device {}\", srcId & 0xff);\n+            return;\n+        }\n+\n+        if (msg.getControlWord().isLink() || srcId == dstId) {\n+            thingHnd.onMessageReceived(msg);\n+        }\n+\n+        // link messages are additionally sent to any virtual devices\n+        if (msg.getControlWord().isLink()) {\n+            things.values().stream().filter(hnd -> hnd instanceof VirtualThingHandler)\n+                    .forEach(hnd -> hnd.onMessageReceived(msg));\n+        }\n+    }\n+\n+    private static boolean isValidId(final byte id) {\n+        return id != 0 && id != -1;\n+    }\n+\n+    public UPBDevice getDevice(final byte networkId, final byte unitId) {\n+        return devices.get(mkAddr(networkId, unitId));\n+    }\n+\n+    public void deviceAdded(final ThingHandler childHandler, final Thing childThing) {\n+        if (childHandler instanceof UPBThingHandler) {\n+            final UPBThingHandler hnd = (UPBThingHandler) childHandler;\n+            things.put(mkAddr(hnd.getNetworkId(), hnd.getUnitId()), hnd);\n+        }\n+    }\n+\n+    public void deviceRemoved(final ThingHandler childHandler, final Thing childThing) {\n+        if (childHandler instanceof UPBThingHandler) {\n+            final UPBThingHandler hnd = (UPBThingHandler) childHandler;\n+            things.remove(mkAddr(hnd.getNetworkId(), hnd.getUnitId()), hnd);\n+        }\n+    }\n+\n+    // forms a device lookup key from a network and unit ID\n+    private static int mkAddr(final byte networkId, final byte srcId) {\n+        return networkId << 8 | srcId;\n+    }", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA5ODgxMA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r396098810", "bodyText": "When we receive a message, we need to use the source address to look up the handler for the device.", "author": "marcusb", "createdAt": "2020-03-22T14:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MTA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MTExOQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395381119", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:51:20Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/UPBHandlerFactory.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal;\n+\n+import java.math.BigDecimal;\n+import java.util.Dictionary;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.handler.SerialPIMHandler;\n+import org.openhab.binding.upb.handler.UPBThingHandler;\n+import org.openhab.binding.upb.handler.VirtualThingHandler;\n+import org.osgi.service.component.ComponentContext;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Factory for UPB handlers.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ */\n+@Component(service = ThingHandlerFactory.class, configurationPid = \"binding.upb\")\n+public class UPBHandlerFactory extends BaseThingHandlerFactory {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MTE3MA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395381170", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:51:29Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/UPBController.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.UPBDevice.DeviceState;\n+import org.openhab.binding.upb.handler.UPBThingHandler;\n+import org.openhab.binding.upb.handler.VirtualThingHandler;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.openhab.binding.upb.internal.message.UPBMessage.Command;\n+import org.openhab.binding.upb.internal.message.UPBMessage.Type;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Controller logic for UPB network communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class UPBController {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MTI0OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395381249", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:51:47Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/ControlWord.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+/**\n+ * Copyright (c) 2010-2016, openHAB.org and others.\n+ *\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ */\n+\n+/**\n+ * Model for the first two bytes of UPB messages.\n+ *\n+ * @author cvanorman - Initial contribution\n+ * @since 1.9.0\n+ */\n+public class ControlWord {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MTM1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395381356", "bodyText": "Please add @NonNullByDefault", "author": "cpmeister", "createdAt": "2020-03-19T23:52:13Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/MessageBuilder.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+\n+import org.eclipse.smarthome.core.util.HexUtils;\n+\n+/**\n+ * Builder class for building UPB messages.\n+ *\n+ * @author cvanorman - Initial contribution\n+ * @since 1.9.0\n+ */\n+public final class MessageBuilder {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MjY4Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395382682", "bodyText": "This information should be included in the Type enum.", "author": "cpmeister", "createdAt": "2020-03-19T23:56:51Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/UPBMessage.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map.Entry;\n+\n+import org.eclipse.smarthome.core.util.HexUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Model for a message sent or received from a UPB modem.\n+ *\n+ * @author cvanorman - Initial contribution\n+ * @since 1.9.0\n+ */\n+public class UPBMessage {\n+\n+    /**\n+     * An enum of possible commands.\n+     *\n+     * @author cvanorman\n+     *\n+     */\n+    public enum Command {\n+        ACTIVATE,\n+        DEACTIVATE,\n+        GOTO,\n+        START_FADE,\n+        STOP_FADE,\n+        BLINK,\n+        REPORT_STATE,\n+        STORE_STATE,\n+        DEVICE_STATE,\n+        NONE;\n+\n+        /**\n+         * Gets the protocol byte code for this Command.\n+         *\n+         * @return\n+         */\n+        public byte toByte() {\n+            for (Entry<Integer, Command> e : commandMap.entrySet()) {\n+                if (e.getValue() == this) {\n+                    return e.getKey().byteValue();\n+                }\n+            }\n+\n+            return 0;\n+        }\n+\n+        /**\n+         * Converts a byte value into a Command.\n+         *\n+         * @param value\n+         *                  the byte value.\n+         * @return the Command that is represented by the given byte value.\n+         */\n+        public static Command valueOf(byte value) {\n+            return commandMap.get(value);\n+        }\n+    }\n+\n+    /**\n+     * An enum of possible modem response types.\n+     *\n+     * @author cvanorman\n+     *\n+     */\n+    public enum Type {\n+        ACCEPT,\n+        BUSY,\n+        ERROR,\n+        ACK,\n+        NAK,\n+        MESSAGE_REPORT,\n+        NONE;\n+    }\n+\n+    private static final Logger logger = LoggerFactory.getLogger(UPBMessage.class);\n+\n+    private static HashMap<Integer, Command> commandMap = new HashMap<>();\n+\n+    static {\n+        commandMap.put(0x20, Command.ACTIVATE);\n+        commandMap.put(0x21, Command.DEACTIVATE);\n+        commandMap.put(0x22, Command.GOTO);\n+        commandMap.put(0x23, Command.START_FADE);\n+        commandMap.put(0x24, Command.STOP_FADE);\n+        commandMap.put(0x25, Command.BLINK);\n+        commandMap.put(0x30, Command.REPORT_STATE);\n+        commandMap.put(0x31, Command.STORE_STATE);\n+        commandMap.put(0x86, Command.DEVICE_STATE);\n+    }\n+\n+    private static HashMap<String, Type> typeMap = new HashMap<>();\n+\n+    static {\n+        typeMap.put(\"PA\", Type.ACCEPT);\n+        typeMap.put(\"PB\", Type.BUSY);\n+        typeMap.put(\"PE\", Type.ERROR);\n+        typeMap.put(\"PK\", Type.ACK);\n+        typeMap.put(\"PN\", Type.NAK);\n+        typeMap.put(\"PU\", Type.MESSAGE_REPORT);\n+    }", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MjgzMg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395382832", "bodyText": "This information should be included in the Command enum.", "author": "cpmeister", "createdAt": "2020-03-19T23:57:19Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/UPBMessage.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map.Entry;\n+\n+import org.eclipse.smarthome.core.util.HexUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Model for a message sent or received from a UPB modem.\n+ *\n+ * @author cvanorman - Initial contribution\n+ * @since 1.9.0\n+ */\n+public class UPBMessage {\n+\n+    /**\n+     * An enum of possible commands.\n+     *\n+     * @author cvanorman\n+     *\n+     */\n+    public enum Command {\n+        ACTIVATE,\n+        DEACTIVATE,\n+        GOTO,\n+        START_FADE,\n+        STOP_FADE,\n+        BLINK,\n+        REPORT_STATE,\n+        STORE_STATE,\n+        DEVICE_STATE,\n+        NONE;\n+\n+        /**\n+         * Gets the protocol byte code for this Command.\n+         *\n+         * @return\n+         */\n+        public byte toByte() {\n+            for (Entry<Integer, Command> e : commandMap.entrySet()) {\n+                if (e.getValue() == this) {\n+                    return e.getKey().byteValue();\n+                }\n+            }\n+\n+            return 0;\n+        }\n+\n+        /**\n+         * Converts a byte value into a Command.\n+         *\n+         * @param value\n+         *                  the byte value.\n+         * @return the Command that is represented by the given byte value.\n+         */\n+        public static Command valueOf(byte value) {\n+            return commandMap.get(value);\n+        }\n+    }\n+\n+    /**\n+     * An enum of possible modem response types.\n+     *\n+     * @author cvanorman\n+     *\n+     */\n+    public enum Type {\n+        ACCEPT,\n+        BUSY,\n+        ERROR,\n+        ACK,\n+        NAK,\n+        MESSAGE_REPORT,\n+        NONE;\n+    }\n+\n+    private static final Logger logger = LoggerFactory.getLogger(UPBMessage.class);\n+\n+    private static HashMap<Integer, Command> commandMap = new HashMap<>();\n+\n+    static {\n+        commandMap.put(0x20, Command.ACTIVATE);\n+        commandMap.put(0x21, Command.DEACTIVATE);\n+        commandMap.put(0x22, Command.GOTO);\n+        commandMap.put(0x23, Command.START_FADE);\n+        commandMap.put(0x24, Command.STOP_FADE);\n+        commandMap.put(0x25, Command.BLINK);\n+        commandMap.put(0x30, Command.REPORT_STATE);\n+        commandMap.put(0x31, Command.STORE_STATE);\n+        commandMap.put(0x86, Command.DEVICE_STATE);\n+    }", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MzAzNw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r395383037", "bodyText": "Please put this into its own file", "author": "cpmeister", "createdAt": "2020-03-19T23:57:57Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/UPBMessage.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map.Entry;\n+\n+import org.eclipse.smarthome.core.util.HexUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Model for a message sent or received from a UPB modem.\n+ *\n+ * @author cvanorman - Initial contribution\n+ * @since 1.9.0\n+ */\n+public class UPBMessage {\n+\n+    /**\n+     * An enum of possible commands.\n+     *\n+     * @author cvanorman\n+     *\n+     */\n+    public enum Command {", "originalCommit": "8db15e34bfa328068559a6bbbc65da1046183b20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fc5b6bd9fffe37482a04aa36fcb9c6abb6c90ed2", "url": "https://github.com/openhab/openhab-addons/commit/fc5b6bd9fffe37482a04aa36fcb9c6abb6c90ed2", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-03-22T14:37:33Z", "type": "forcePushed"}, {"oid": "711116ec1fb6836ebc097d2889accfced49fb817", "url": "https://github.com/openhab/openhab-addons/commit/711116ec1fb6836ebc097d2889accfced49fb817", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-03-22T14:45:37Z", "type": "forcePushed"}, {"oid": "18f1ed453e7a7627a77f9ca9db5c04df84997bfa", "url": "https://github.com/openhab/openhab-addons/commit/18f1ed453e7a7627a77f9ca9db5c04df84997bfa", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-03-22T14:46:55Z", "type": "forcePushed"}, {"oid": "78062ee53db1bbdb918e040e02aa00b67c2cf480", "url": "https://github.com/openhab/openhab-addons/commit/78062ee53db1bbdb918e040e02aa00b67c2cf480", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-03-22T14:47:58Z", "type": "forcePushed"}, {"oid": "fb7b099c59604471a972d09cdfacc605bd5352be", "url": "https://github.com/openhab/openhab-addons/commit/fb7b099c59604471a972d09cdfacc605bd5352be", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-03-27T02:45:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NzkzMg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r398977932", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                private volatile WriteRunnable currentWrite;\n          \n          \n            \n                private volatile @Nullable WriteRunnable currentWrite;", "author": "cpmeister", "createdAt": "2020-03-27T00:59:00Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,282 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    @Nullable\n+    private volatile WriteRunnable currentWrite;", "originalCommit": "78062ee53db1bbdb918e040e02aa00b67c2cf480", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3ODE0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r398978142", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                private volatile SerialIoThread receiveThread;\n          \n          \n            \n                private volatile @Nullable SerialIoThread receiveThread;", "author": "cpmeister", "createdAt": "2020-03-27T00:59:46Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    @Nullable\n+    private volatile SerialIoThread receiveThread;", "originalCommit": "78062ee53db1bbdb918e040e02aa00b67c2cf480", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3ODE5NA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r398978194", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                private volatile ScheduledFuture<?> futSerialPortInit;\n          \n          \n            \n                private volatile @Nullable ScheduledFuture<?> futSerialPortInit;", "author": "cpmeister", "createdAt": "2020-03-27T00:59:58Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    @Nullable\n+    private volatile SerialIoThread receiveThread;\n+    @Nullable\n+    private volatile ScheduledFuture<?> futSerialPortInit;", "originalCommit": "78062ee53db1bbdb918e040e02aa00b67c2cf480", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxNzE1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r399517156", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    @Nullable\n          \n          \n            \n                    private Boolean ack;\n          \n          \n            \n                    @Nullable\n          \n          \n            \n                    private volatile CountDownLatch ackLatch;\n          \n          \n            \n                    private @Nullable Boolean ack;\n          \n          \n            \n                    private volatile @Nullable CountDownLatch ackLatch;", "author": "cpmeister", "createdAt": "2020-03-27T20:19:00Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,284 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    @Nullable\n+    private volatile WriteRunnable currentWrite;\n+    private volatile SerialPort serialPort;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            logger.warn(\"serial port setup failed\", e);\n+            return;\n+        }\n+        serialPort.notifyOnDataAvailable(true);\n+\n+        final byte[] buffer = new byte[256];\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            enterMessageMode();\n+            int len;\n+            while (!done && (len = in.read(buffer)) >= 0) {\n+                addData(buffer, len);\n+            }\n+        } catch (final Exception e) {\n+            logger.warn(\"Exception in UPB read thread\", e);\n+        } finally {\n+            logger.debug(\"shutting down receive thread\");\n+            shutdownAndAwaitTermination(writeExecutor);\n+            serialPort.removeEventListener();\n+            try {\n+                serialPort.close();\n+            } catch (final Exception e) {\n+                // ignore\n+            }\n+        }\n+        logger.debug(\"UPB read thread stopped\");\n+    }\n+\n+    private void addData(final byte[] data, final int length) {\n+        if (bufferLength + length > buffer.length) {\n+            // buffer overflow, discard entire buffer\n+            bufferLength = 0;\n+        }\n+        System.arraycopy(data, 0, buffer, bufferLength, length);\n+        bufferLength += length;\n+        interpretBuffer();\n+    }\n+\n+    private int findMessageLength(final byte[] buffer, final int bufferLength) {\n+        for (int i = 0; i < bufferLength; i++) {\n+            if (buffer[i] == 13) {\n+                return i;\n+            }\n+        }\n+        return -1;\n+    }\n+\n+    /**\n+     * Attempts to interpret any messages that may be contained in the buffer.\n+     */\n+    private void interpretBuffer() {\n+        int messageLength = findMessageLength(buffer, bufferLength);\n+\n+        while (messageLength != -1) {\n+            final String message = new String(Arrays.copyOfRange(buffer, 0, messageLength), US_ASCII);\n+            logger.debug(\"UPB Message: {}\", message);\n+\n+            final int remainingBuffer = bufferLength - messageLength - 1;\n+            if (remainingBuffer > 0) {\n+                System.arraycopy(buffer, messageLength + 1, buffer, 0, remainingBuffer);\n+            }\n+            bufferLength = remainingBuffer;\n+            handleMessage(UPBMessage.fromString(message));\n+            messageLength = findMessageLength(buffer, bufferLength);\n+        }\n+    }\n+\n+    private void handleMessage(final UPBMessage msg) {\n+        switch (msg.getType()) {\n+            case ACK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(true);\n+                }\n+                break;\n+            case NAK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(false);\n+                }\n+                break;\n+            case ACCEPT:\n+                break;\n+            case ERROR:\n+                logger.info(\"received ERROR response from PIM\");\n+                break;\n+            default:\n+                // ignore\n+        }\n+        listener.incomingMessage(msg);\n+    }\n+\n+    public CompletionStage<CmdStatus> enqueue(final MessageBuilder msg) {\n+        final CompletableFuture<CmdStatus> completion = new CompletableFuture<>();\n+        final Runnable task = new WriteRunnable(msg.build(), completion);\n+        try {\n+            writeExecutor.execute(task);\n+        } catch (final RejectedExecutionException e) {\n+            completion.completeExceptionally(e);\n+        }\n+        return completion;\n+    }\n+\n+    // puts the PIM is in message mode\n+    private void enterMessageMode() {\n+        try {\n+            serialPort.getOutputStream().write(ENABLE_MESSAGE_MODE_CMD);\n+            serialPort.getOutputStream().flush();\n+        } catch (final IOException e) {\n+            logger.warn(\"error setting message mode\", e);\n+        }\n+    }\n+\n+    void shutdownAndAwaitTermination(final ExecutorService pool) {\n+        pool.shutdown();\n+        try {\n+            if (!pool.awaitTermination(1, TimeUnit.SECONDS)) {\n+                pool.shutdownNow();\n+                if (!pool.awaitTermination(1, TimeUnit.SECONDS)) {\n+                    logger.warn(\"executor did not terminate\");\n+                }\n+            }\n+        } catch (final InterruptedException ie) {\n+            pool.shutdownNow();\n+            Thread.currentThread().interrupt();\n+        }\n+    }\n+\n+    public void terminate() {\n+        done = true;\n+        try {\n+            serialPort.close();\n+        } catch (final Exception e) {\n+            logger.warn(\"failed to close serial port\", e);\n+        }\n+    }\n+\n+    private class WriteRunnable implements Runnable {\n+        private static final int MAX_RETRIES = 3;\n+\n+        private final String msg;\n+        private final CompletableFuture<CmdStatus> completion;\n+\n+        @Nullable\n+        private Boolean ack;\n+        @Nullable\n+        private volatile CountDownLatch ackLatch;", "originalCommit": "fb7b099c59604471a972d09cdfacc605bd5352be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxODkwMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r399518901", "bodyText": "Please use a NamedThreadFactory to make sure that created threads have a name that can be tied to this binding as well as to make sure that those threads are daemon.", "author": "cpmeister", "createdAt": "2020-03-27T20:23:03Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,284 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));", "originalCommit": "fb7b099c59604471a972d09cdfacc605bd5352be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxOTgzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r399519839", "bodyText": "You should create a local variable for currentWrite to prevent threading issues and to satisfy the compile time null checker.", "author": "cpmeister", "createdAt": "2020-03-27T20:25:06Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,284 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH));\n+\n+    private int bufferLength = 0;\n+    @Nullable\n+    private volatile WriteRunnable currentWrite;\n+    private volatile SerialPort serialPort;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            logger.warn(\"serial port setup failed\", e);\n+            return;\n+        }\n+        serialPort.notifyOnDataAvailable(true);\n+\n+        final byte[] buffer = new byte[256];\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            enterMessageMode();\n+            int len;\n+            while (!done && (len = in.read(buffer)) >= 0) {\n+                addData(buffer, len);\n+            }\n+        } catch (final Exception e) {\n+            logger.warn(\"Exception in UPB read thread\", e);\n+        } finally {\n+            logger.debug(\"shutting down receive thread\");\n+            shutdownAndAwaitTermination(writeExecutor);\n+            serialPort.removeEventListener();\n+            try {\n+                serialPort.close();\n+            } catch (final Exception e) {\n+                // ignore\n+            }\n+        }\n+        logger.debug(\"UPB read thread stopped\");\n+    }\n+\n+    private void addData(final byte[] data, final int length) {\n+        if (bufferLength + length > buffer.length) {\n+            // buffer overflow, discard entire buffer\n+            bufferLength = 0;\n+        }\n+        System.arraycopy(data, 0, buffer, bufferLength, length);\n+        bufferLength += length;\n+        interpretBuffer();\n+    }\n+\n+    private int findMessageLength(final byte[] buffer, final int bufferLength) {\n+        for (int i = 0; i < bufferLength; i++) {\n+            if (buffer[i] == 13) {\n+                return i;\n+            }\n+        }\n+        return -1;\n+    }\n+\n+    /**\n+     * Attempts to interpret any messages that may be contained in the buffer.\n+     */\n+    private void interpretBuffer() {\n+        int messageLength = findMessageLength(buffer, bufferLength);\n+\n+        while (messageLength != -1) {\n+            final String message = new String(Arrays.copyOfRange(buffer, 0, messageLength), US_ASCII);\n+            logger.debug(\"UPB Message: {}\", message);\n+\n+            final int remainingBuffer = bufferLength - messageLength - 1;\n+            if (remainingBuffer > 0) {\n+                System.arraycopy(buffer, messageLength + 1, buffer, 0, remainingBuffer);\n+            }\n+            bufferLength = remainingBuffer;\n+            handleMessage(UPBMessage.fromString(message));\n+            messageLength = findMessageLength(buffer, bufferLength);\n+        }\n+    }\n+\n+    private void handleMessage(final UPBMessage msg) {\n+        switch (msg.getType()) {\n+            case ACK:\n+                if (currentWrite != null) {\n+                    currentWrite.ackReceived(true);\n+                }", "originalCommit": "fb7b099c59604471a972d09cdfacc605bd5352be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjQwOA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r399522408", "bodyText": "Why can't you handle refresh?", "author": "cpmeister", "createdAt": "2020-03-27T20:30:50Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/VirtualThingHandler.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Thing handler for a virtual device.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class VirtualThingHandler extends UPBThingHandler {\n+\n+    private final Logger logger = LoggerFactory.getLogger(VirtualThingHandler.class);\n+\n+    public VirtualThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device, defaultNetworkId);\n+    }\n+\n+    @Override\n+    protected void pingDevice() {\n+        // always succeeds for virtual device\n+        updateStatus(ThingStatus.ONLINE);\n+    }\n+\n+    @Override\n+    public void handleCommand(final ChannelUID channelUID, final Command cmd) {\n+        if (controllerHandler == null) {\n+            logger.info(\"DEV {}: received cmd {} but no bridge handler\", unitId, cmd);\n+            return;\n+        }\n+\n+        if (cmd == RefreshType.REFRESH) {\n+            return;", "originalCommit": "fb7b099c59604471a972d09cdfacc605bd5352be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc0MzQ2NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r399743465", "bodyText": "Added a comment. There is no concept of a \"currently active scene\" in UPB as far as I understand it. It's just a command that gets broadcast to all devices in a write-only fashion.", "author": "marcusb", "createdAt": "2020-03-29T04:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMjQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyNTUzNw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r399525537", "bodyText": "Please move this method to below the constructor", "author": "cpmeister", "createdAt": "2020-03-27T20:37:57Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/UPBMessage.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.util.HexUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Model for a message sent or received from a UPB modem.\n+ *\n+ * @author cvanorman - Initial contribution\n+ */\n+@NonNullByDefault\n+public class UPBMessage {\n+\n+    /**\n+     * An enum of possible modem response types.\n+     *\n+     * @author cvanorman\n+     *\n+     */\n+    public enum Type {\n+        ACCEPT,\n+        BUSY,\n+        ERROR,\n+        ACK,\n+        NAK,\n+        MESSAGE_REPORT,\n+        NONE;\n+    }\n+\n+    private static final Logger logger = LoggerFactory.getLogger(UPBMessage.class);\n+\n+    static HashMap<Integer, Command> commandMap = new HashMap<>();\n+\n+    static {\n+        commandMap.put(0x20, Command.ACTIVATE);\n+        commandMap.put(0x21, Command.DEACTIVATE);\n+        commandMap.put(0x22, Command.GOTO);\n+        commandMap.put(0x23, Command.START_FADE);\n+        commandMap.put(0x24, Command.STOP_FADE);\n+        commandMap.put(0x25, Command.BLINK);\n+        commandMap.put(0x30, Command.REPORT_STATE);\n+        commandMap.put(0x31, Command.STORE_STATE);\n+        commandMap.put(0x86, Command.DEVICE_STATE);\n+    }\n+\n+    private static HashMap<String, Type> typeMap = new HashMap<>();\n+\n+    static {\n+        typeMap.put(\"PA\", Type.ACCEPT);\n+        typeMap.put(\"PB\", Type.BUSY);\n+        typeMap.put(\"PE\", Type.ERROR);\n+        typeMap.put(\"PK\", Type.ACK);\n+        typeMap.put(\"PN\", Type.NAK);\n+        typeMap.put(\"PU\", Type.MESSAGE_REPORT);\n+    }\n+\n+    /**\n+     * Converts a hex string into a {@link UPBMessage}.\n+     *\n+     * @param commandString\n+     *                          the string as returned by the modem.\n+     * @return a new UPBMessage.\n+     */\n+    public static UPBMessage fromString(String commandString) {", "originalCommit": "fb7b099c59604471a972d09cdfacc605bd5352be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyNjU5NA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r399526594", "bodyText": "This should be in the Command enum instead.", "author": "cpmeister", "createdAt": "2020-03-27T20:40:22Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/UPBMessage.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.util.HexUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Model for a message sent or received from a UPB modem.\n+ *\n+ * @author cvanorman - Initial contribution\n+ */\n+@NonNullByDefault\n+public class UPBMessage {\n+\n+    /**\n+     * An enum of possible modem response types.\n+     *\n+     * @author cvanorman\n+     *\n+     */\n+    public enum Type {\n+        ACCEPT,\n+        BUSY,\n+        ERROR,\n+        ACK,\n+        NAK,\n+        MESSAGE_REPORT,\n+        NONE;\n+    }\n+\n+    private static final Logger logger = LoggerFactory.getLogger(UPBMessage.class);\n+\n+    static HashMap<Integer, Command> commandMap = new HashMap<>();\n+\n+    static {\n+        commandMap.put(0x20, Command.ACTIVATE);\n+        commandMap.put(0x21, Command.DEACTIVATE);\n+        commandMap.put(0x22, Command.GOTO);\n+        commandMap.put(0x23, Command.START_FADE);\n+        commandMap.put(0x24, Command.STOP_FADE);\n+        commandMap.put(0x25, Command.BLINK);\n+        commandMap.put(0x30, Command.REPORT_STATE);\n+        commandMap.put(0x31, Command.STORE_STATE);\n+        commandMap.put(0x86, Command.DEVICE_STATE);\n+    }", "originalCommit": "fb7b099c59604471a972d09cdfacc605bd5352be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyNzEzMg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r399527132", "bodyText": "I suggest passing in SerialPortManager from the constructor instead, that way you can make this field non-null and final.", "author": "cpmeister", "createdAt": "2020-03-27T20:41:40Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/UPBHandlerFactory.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal;\n+\n+import java.math.BigDecimal;\n+import java.util.Dictionary;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.handler.SerialPIMHandler;\n+import org.openhab.binding.upb.handler.UPBThingHandler;\n+import org.openhab.binding.upb.handler.VirtualThingHandler;\n+import org.osgi.service.component.ComponentContext;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Factory for UPB handlers.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ */\n+@Component(service = ThingHandlerFactory.class, configurationPid = \"binding.upb\")\n+@NonNullByDefault\n+public class UPBHandlerFactory extends BaseThingHandlerFactory {\n+    private final Logger logger = LoggerFactory.getLogger(UPBHandlerFactory.class);\n+\n+    @Nullable\n+    private SerialPortManager serialPortManager;\n+    @Nullable\n+    private Byte networkId;\n+\n+    @Override\n+    protected void activate(final ComponentContext componentContext) {\n+        super.activate(componentContext);\n+        final Dictionary<String, Object> config = componentContext.getProperties();\n+        final BigDecimal nid = (BigDecimal) config.get(Constants.CONFIGURATION_NETWORK_ID);\n+        if (nid != null) {\n+            if (nid.compareTo(BigDecimal.ZERO) < 0 || nid.compareTo(BigDecimal.valueOf(255)) > 0) {\n+                logger.warn(\"invalid network ID {}\", nid);\n+                throw new IllegalArgumentException(\"network ID out of range\");\n+            }\n+            networkId = nid.byteValue();\n+        }\n+    }\n+\n+    @Override\n+    public boolean supportsThingType(final ThingTypeUID thingTypeUID) {\n+        return Constants.BINDING_ID.equals(thingTypeUID.getBindingId());\n+    }\n+\n+    @Override\n+    protected @Nullable ThingHandler createHandler(final Thing thing) {\n+        logger.debug(\"Creating thing {}\", thing.getUID());\n+        final ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n+        if (thingTypeUID.equals(Constants.PIM_UID)) {\n+            assert serialPortManager != null;\n+            return new SerialPIMHandler((Bridge) thing, (@NonNull SerialPortManager) serialPortManager);\n+        } else if (thingTypeUID.equals(Constants.VIRTUAL_DEVICE_UID)) {\n+            return new VirtualThingHandler(thing, networkId);\n+        } else {\n+            return new UPBThingHandler(thing, networkId);\n+        }\n+    }\n+\n+    @Reference\n+    protected void setSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    protected void unsetSerialPortManager(final SerialPortManager serialPortManager) {\n+        this.serialPortManager = null;\n+    }", "originalCommit": "fb7b099c59604471a972d09cdfacc605bd5352be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzODMwNw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r401338307", "bodyText": "Good idea, done.", "author": "marcusb", "createdAt": "2020-04-01T03:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyNzEzMg=="}], "type": "inlineReview"}, {"oid": "07f817e09e73e0bcb2bcf6f312035da6ff58324c", "url": "https://github.com/openhab/openhab-addons/commit/07f817e09e73e0bcb2bcf6f312035da6ff58324c", "message": "Review comments\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-03-30T03:32:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcwMDI3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r402700279", "bodyText": "For example to solve this type of null warning you need to cache the field value into a local variable:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (futSerialPortInit != null) {\n          \n          \n            \n                        futSerialPortInit.cancel(true);\n          \n          \n            \n                    }\n          \n          \n            \n                    futSerialPortInit = null;\n          \n          \n            \n                    ScheduledFuture<?> futSerialPortInit = this.futSerialPortInit;\n          \n          \n            \n                    if (futSerialPortInit != null) {\n          \n          \n            \n                        futSerialPortInit.cancel(true);\n          \n          \n            \n                    }\n          \n          \n            \n                    this.futSerialPortInit = null;\n          \n      \n    \n    \n  \n\nYes it may seem unnecessary to do it like this but the warnings help prevent NPE in a concurrent environment so you should treat what it complains about very seriously with the exception of Map fields which the static analysis seems to have trouble with. If the warning relate to your usage of a Map field just ignore it for now, I'll help you address those later.", "author": "cpmeister", "createdAt": "2020-04-03T02:21:52Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile @Nullable SerialIoThread receiveThread;\n+    private volatile @Nullable ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.warn(\"serial port is not set\");\n+            return;\n+        }\n+\n+        futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_INIT_DELAY_MS,\n+                TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        if (futSerialPortInit != null) {\n+            futSerialPortInit.cancel(true);\n+        }\n+        futSerialPortInit = null;", "originalCommit": "07f817e09e73e0bcb2bcf6f312035da6ff58324c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjczNTE4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r402735189", "bodyText": "Ok, done. It helped clean up the code in some cases.", "author": "marcusb", "createdAt": "2020-04-03T04:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcwMDI3OQ=="}], "type": "inlineReview"}, {"oid": "8c0e324cc4fd035ece9b57cb3dffe1ac5b3b124c", "url": "https://github.com/openhab/openhab-addons/commit/8c0e324cc4fd035ece9b57cb3dffe1ac5b3b124c", "message": "Fix nullability warnings\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-04-03T04:50:51Z", "type": "forcePushed"}, {"oid": "72f86307bc4100abe7f218a4a00ac2a87d6460c1", "url": "https://github.com/openhab/openhab-addons/commit/72f86307bc4100abe7f218a4a00ac2a87d6460c1", "message": "Fix nullability warnings\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-04-03T04:53:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NjA2OA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r402746068", "bodyText": "Maybe instead of having this field, you just lookup the PIMHandler anytime you need it?\nprivate @Nullable PIMHandler getPIMHandler(){\n        final Bridge bridge = getBridge();\n        if (bridge == null) {\n            logger.debug(\"DEV {}: bridge is null!\", unitId);\n            return null;\n        }\n        final PIMHandler bridgeHandler = (PIMHandler) bridge.getHandler();\n        if (bridgeHandler == null) {\n            logger.debug(\"DEV {}: bridge handler is null!\", unitId);\n            return null;\n        }\n        return bridgeHandler;\n}", "author": "cpmeister", "createdAt": "2020-04-03T05:35:49Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingHandler.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handler for things representing devices on an UPB network.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class UPBThingHandler extends BaseThingHandler {\n+    private final Logger logger = LoggerFactory.getLogger(UPBThingHandler.class);\n+    private final @Nullable Byte defaultNetworkId;\n+\n+    protected volatile @Nullable PIMHandler controllerHandler;", "originalCommit": "72f86307bc4100abe7f218a4a00ac2a87d6460c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0ODQ3MA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r402748470", "bodyText": "You should still check if the thingTypeUID is a UPBThingHandler type. Better safe than sorry and I think this method allows null returns for a reason \ud83d\ude15", "author": "cpmeister", "createdAt": "2020-04-03T05:44:48Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/UPBHandlerFactory.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal;\n+\n+import java.math.BigDecimal;\n+import java.util.Dictionary;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.handler.SerialPIMHandler;\n+import org.openhab.binding.upb.handler.UPBThingHandler;\n+import org.openhab.binding.upb.handler.VirtualThingHandler;\n+import org.osgi.service.component.ComponentContext;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Factory for UPB handlers.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ */\n+@Component(service = ThingHandlerFactory.class, configurationPid = \"binding.upb\")\n+@NonNullByDefault\n+public class UPBHandlerFactory extends BaseThingHandlerFactory {\n+    private final Logger logger = LoggerFactory.getLogger(UPBHandlerFactory.class);\n+    private final SerialPortManager serialPortManager;\n+\n+    private @Nullable Byte networkId;\n+\n+    @Activate\n+    public UPBHandlerFactory(@Reference SerialPortManager serialPortManager) {\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    @NonNullByDefault({})\n+    protected void activate(final ComponentContext componentContext) {\n+        super.activate(componentContext);\n+        final Dictionary<String, Object> config = componentContext.getProperties();\n+        final BigDecimal nid = (BigDecimal) config.get(Constants.CONFIGURATION_NETWORK_ID);\n+        if (nid != null) {\n+            if (nid.compareTo(BigDecimal.ZERO) < 0 || nid.compareTo(BigDecimal.valueOf(255)) > 0) {\n+                logger.warn(\"invalid network ID {}\", nid);\n+                throw new IllegalArgumentException(\"network ID out of range\");\n+            }\n+            networkId = nid.byteValue();\n+        }\n+    }\n+\n+    @Override\n+    public boolean supportsThingType(final ThingTypeUID thingTypeUID) {\n+        return Constants.BINDING_ID.equals(thingTypeUID.getBindingId());\n+    }\n+\n+    @Override\n+    protected @Nullable ThingHandler createHandler(final Thing thing) {\n+        logger.debug(\"Creating thing {}\", thing.getUID());\n+        final ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n+        if (thingTypeUID.equals(Constants.PIM_UID)) {\n+            assert serialPortManager != null;\n+            return new SerialPIMHandler((Bridge) thing, serialPortManager);\n+        } else if (thingTypeUID.equals(Constants.VIRTUAL_DEVICE_UID)) {\n+            return new VirtualThingHandler(thing, networkId);\n+        } else {\n+            return new UPBThingHandler(thing, networkId);", "originalCommit": "72f86307bc4100abe7f218a4a00ac2a87d6460c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY0MDE5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r403640199", "bodyText": "This is a catch-all for multiple thing types. Currently there is only the generic and leviton-38a00-1, but I think more types can be added for specific devices. They are all handled by the UPBThingHandler.", "author": "marcusb", "createdAt": "2020-04-05T02:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0ODQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODAyMg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487558022", "bodyText": "I agree with @cpmeister , the behavior should be the same throughout all bindings.", "author": "fwolter", "createdAt": "2020-09-13T17:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0ODQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNjAzOA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r490626038", "bodyText": "done", "author": "marcusb", "createdAt": "2020-09-18T00:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0ODQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1MTYwMg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r402751602", "bodyText": "Shouldn't this change the thing status to OFFLINE?", "author": "cpmeister", "createdAt": "2020-04-03T05:56:06Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingHandler.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handler for things representing devices on an UPB network.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class UPBThingHandler extends BaseThingHandler {\n+    private final Logger logger = LoggerFactory.getLogger(UPBThingHandler.class);\n+    private final @Nullable Byte defaultNetworkId;\n+\n+    protected volatile @Nullable PIMHandler controllerHandler;\n+    protected volatile byte networkId;\n+    protected volatile int unitId;\n+\n+    public UPBThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device);\n+        this.defaultNetworkId = defaultNetworkId;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"initializing UPB thing handler {}\", getThing().getUID());\n+\n+        final BigDecimal val = (BigDecimal) getConfig().get(Constants.CONFIGURATION_NETWORK_ID);\n+        if (val == null) {\n+            // use value from binding config\n+            final Byte defaultNetworkId = this.defaultNetworkId;\n+            if (defaultNetworkId == null) {\n+                logger.warn(\"missing network ID for {}\", getThing().getUID());", "originalCommit": "72f86307bc4100abe7f218a4a00ac2a87d6460c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzYzOTg5MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r403639891", "bodyText": "I think it's better to leave it at UNINITIALIZED as in the other mis-configuration cases.", "author": "marcusb", "createdAt": "2020-04-05T02:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1MTYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc1NTI3Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r403755276", "bodyText": "There is a specific offline description for this though:\nupdateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing network ID\")\nThis is the standard way bindings can notify the user of a misconfiguration issue.", "author": "cpmeister", "createdAt": "2020-04-05T20:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1MTYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwMzYwMw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485903603", "bodyText": "Some more information about allowed states can be found here:\nhttps://www.openhab.org/docs/concepts/things.html#status-details\nThe log should be debug, as the update status already log it.", "author": "Hilbrand", "createdAt": "2020-09-09T20:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1MTYwMg=="}], "type": "inlineReview"}, {"oid": "eaec40bcbfd5cbbed8cd1e368b87afb88801e46a", "url": "https://github.com/openhab/openhab-addons/commit/eaec40bcbfd5cbbed8cd1e368b87afb88801e46a", "message": "Retrieve PIM handler on the fly\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-04-05T02:47:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc1NTQwNA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r403755404", "bodyText": "Can you cache it when you change the value? Or can the scene be changed outside of the binding so caching wouldn't work?", "author": "cpmeister", "createdAt": "2020-04-05T20:52:04Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/VirtualThingHandler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Thing handler for a virtual device.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class VirtualThingHandler extends UPBThingHandler {\n+\n+    private final Logger logger = LoggerFactory.getLogger(VirtualThingHandler.class);\n+\n+    public VirtualThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device, defaultNetworkId);\n+    }\n+\n+    @Override\n+    protected void pingDevice() {\n+        // always succeeds for virtual device\n+        updateStatus(ThingStatus.ONLINE);\n+    }\n+\n+    @Override\n+    public void handleCommand(final ChannelUID channelUID, final Command cmd) {\n+        final PIMHandler pimHandler = getPIMHandler();\n+        if (pimHandler == null) {\n+            logger.info(\"DEV {}: received cmd {} but no bridge handler\", unitId, cmd);\n+            return;\n+        }\n+\n+        if (cmd == RefreshType.REFRESH) {\n+            // there is no way to read the currently active scene", "originalCommit": "eaec40bcbfd5cbbed8cd1e368b87afb88801e46a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc1NjAyMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r403756021", "bodyText": "It might be safer to cast to a Number instead, just to give more flexibility if the core decides to change things down the line.", "author": "cpmeister", "createdAt": "2020-04-05T20:57:30Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/UPBHandlerFactory.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal;\n+\n+import java.math.BigDecimal;\n+import java.util.Dictionary;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandlerFactory;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandler;\n+import org.eclipse.smarthome.core.thing.binding.ThingHandlerFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.handler.SerialPIMHandler;\n+import org.openhab.binding.upb.handler.UPBThingHandler;\n+import org.openhab.binding.upb.handler.VirtualThingHandler;\n+import org.osgi.service.component.ComponentContext;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Factory for UPB handlers.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ */\n+@Component(service = ThingHandlerFactory.class, configurationPid = \"binding.upb\")\n+@NonNullByDefault\n+public class UPBHandlerFactory extends BaseThingHandlerFactory {\n+    private final Logger logger = LoggerFactory.getLogger(UPBHandlerFactory.class);\n+    private final SerialPortManager serialPortManager;\n+\n+    private @Nullable Byte networkId;\n+\n+    @Activate\n+    public UPBHandlerFactory(@Reference SerialPortManager serialPortManager) {\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    @NonNullByDefault({})\n+    protected void activate(final ComponentContext componentContext) {\n+        super.activate(componentContext);\n+        final Dictionary<String, Object> config = componentContext.getProperties();\n+        final BigDecimal nid = (BigDecimal) config.get(Constants.CONFIGURATION_NETWORK_ID);", "originalCommit": "eaec40bcbfd5cbbed8cd1e368b87afb88801e46a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc1NzA5Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r403757092", "bodyText": "I'd rather you set the name from within the SerialIoThread constructor instead. Also make sure that you make the thread daemon.", "author": "cpmeister", "createdAt": "2020-04-05T21:08:02Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile @Nullable SerialIoThread receiveThread;\n+    private volatile @Nullable ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.warn(\"serial port is not set\");\n+            return;\n+        }\n+\n+        futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_INIT_DELAY_MS,\n+                TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        final ScheduledFuture<?> futSerialPortInit = this.futSerialPortInit;\n+        if (futSerialPortInit != null) {\n+            futSerialPortInit.cancel(true);\n+            this.futSerialPortInit = null;\n+        }\n+        final SerialIoThread receiveThread = this.receiveThread;\n+        if (receiveThread != null) {\n+            receiveThread.terminate();\n+            try {\n+                receiveThread.join(1000);\n+            } catch (final InterruptedException e) {\n+                // ignore\n+            }\n+            this.receiveThread = null;\n+        }\n+        logger.debug(\"Stopped UPB serial handler\");\n+        super.dispose();\n+    }\n+\n+    private void openSerialPort(final String portId) {\n+        try {\n+            final SerialPort serialPort = tryOpenSerialPort(portId);\n+            if (serialPort == null) {\n+                futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_RETRY_DELAY_MS,\n+                        TimeUnit.MILLISECONDS);\n+                return;\n+            }\n+            logger.debug(\"Starting receive thread\");\n+            final SerialIoThread receiveThread = new SerialIoThread(serialPort, this);\n+            receiveThread.setName(\"upb-serial-reader\");", "originalCommit": "eaec40bcbfd5cbbed8cd1e368b87afb88801e46a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2MTEzNg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r403761136", "bodyText": "Instead of managing a buffer yourself why not use a ByteArrayOutputStream?\nOr another option would be to use a BufferedInputStream and take advantage of the mark() and reset() methods to parse messages as you encounter the message terminator byte.\nWDYT?", "author": "cpmeister", "createdAt": "2020-04-05T21:46:19Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.NamedThreadFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+    private static final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] buffer = new byte[512];", "originalCommit": "eaec40bcbfd5cbbed8cd1e368b87afb88801e46a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyNzcxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r486727715", "bodyText": "Done, but I think it got more complicated for little benefit...", "author": "marcusb", "createdAt": "2020-09-11T01:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2MTEzNg=="}], "type": "inlineReview"}, {"oid": "c4099b112b6250d3ddaa6e50d8c55fa16b337374", "url": "https://github.com/openhab/openhab-addons/commit/c4099b112b6250d3ddaa6e50d8c55fa16b337374", "message": "Set thread names and ensure daemon threads", "committedDate": "2020-09-09T02:06:58Z", "type": "forcePushed"}, {"oid": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "url": "https://github.com/openhab/openhab-addons/commit/ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "message": "Silence a warning", "committedDate": "2020-09-09T02:14:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NTExNg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485895116", "bodyText": "Could you use the following naming convention for the thread:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    setName(\"upb-serial-reader\");\n          \n          \n            \n                    setName(\"OH-binding-\" + thingUID + \"serial-reader\");\n          \n      \n    \n    \n  \n\nThe postfix serial-reader is maybe not needed it this is the only thread started by this binding. The convention is to easily detect binding started threads.", "author": "Hilbrand", "createdAt": "2020-09-09T20:13:42Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,297 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.NamedThreadFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+    private static final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    // Single-threaded executor for writes that serves to serialize writes.\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH), new NamedThreadFactory(\"upb-serial-writer\", true));\n+    private final SerialPort serialPort;\n+\n+    private int bufferLength = 0;\n+    private volatile @Nullable WriteRunnable currentWrite;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        setName(\"upb-serial-reader\");", "originalCommit": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NjE0OA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485896148", "bodyText": "It's unclear if this is still needed. It seem to have fixed in newer versions of the library. I've had people remove this and they had no problem. So you probably should remove it, and then best test if there is indeed no problem anymore.", "author": "Hilbrand", "createdAt": "2020-09-09T20:15:48Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,297 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.NamedThreadFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+    private static final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    // Single-threaded executor for writes that serves to serialize writes.\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH), new NamedThreadFactory(\"upb-serial-writer\", true));\n+    private final SerialPort serialPort;\n+\n+    private int bufferLength = 0;\n+    private volatile @Nullable WriteRunnable currentWrite;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        setName(\"upb-serial-reader\");\n+        setDaemon(true);\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);", "originalCommit": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzUzOTU5NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487539595", "bodyText": "Did you checked if the endless sleep was still needed? Otherwise I think you should just remove it.", "author": "Hilbrand", "createdAt": "2020-09-13T14:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NjE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NjA1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487556053", "bodyText": "This has been fixed. You can safely remove the entire method.", "author": "fwolter", "createdAt": "2020-09-13T17:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NjE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NzUwMw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485897503", "bodyText": "Can you catch the specific exception (or reduce it to RuntimException). This comment applies to all locations that catch Exception.", "author": "Hilbrand", "createdAt": "2020-09-09T20:18:30Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,297 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.TooManyListenersException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.NamedThreadFactory;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+    private static final byte[] ENABLE_MESSAGE_MODE_CMD = { 0x17, 0x70, 0x02, (byte) 0x8e, 0x0d };\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final byte[] buffer = new byte[512];\n+    private final MessageListener listener;\n+    // Single-threaded executor for writes that serves to serialize writes.\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH), new NamedThreadFactory(\"upb-serial-writer\", true));\n+    private final SerialPort serialPort;\n+\n+    private int bufferLength = 0;\n+    private volatile @Nullable WriteRunnable currentWrite;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        setName(\"upb-serial-reader\");\n+        setDaemon(true);\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        // RXTX serial port library causes high CPU load\n+        // Start event listener, which will just sleep and slow down event loop\n+        try {\n+            serialPort.addEventListener(this);\n+        } catch (final TooManyListenersException e) {\n+            logger.warn(\"serial port setup failed\", e);\n+            return;\n+        }\n+        serialPort.notifyOnDataAvailable(true);\n+\n+        final byte[] buffer = new byte[256];\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            if (in == null) {\n+                // should never happen\n+                throw new IllegalStateException(\"serial port is not readable\");\n+            }\n+            enterMessageMode();\n+            int len;\n+            while (!done && (len = in.read(buffer)) >= 0) {\n+                addData(buffer, len);\n+            }\n+        } catch (final Exception e) {", "originalCommit": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwMDM0NA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485900344", "bodyText": "If there is an exception it means the thread is shutdown. Does this tickle down to the user in form of a status update offline? or does the binding simply stop working without visible indication and only by looking at the log one could find the error and deduce the binding has crashed.", "author": "Hilbrand", "createdAt": "2020-09-09T20:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NzUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwMTMyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485901329", "bodyText": "This should result in a  updateStatus offline, configuration error. The user should not have to look into the log to find out what is wrong.", "author": "Hilbrand", "createdAt": "2020-09-09T20:26:04Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile @Nullable SerialIoThread receiveThread;\n+    private volatile @Nullable ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.warn(\"serial port is not set\");", "originalCommit": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwMjE3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485902175", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.warn(\"cannot open serial port\", e);\n          \n          \n            \n                        logger.debug(\"cannot open serial port\", e);\n          \n      \n    \n    \n  \n\nMessage already set in status, which is also logged.", "author": "Hilbrand", "createdAt": "2020-09-09T20:27:43Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;\n+    private static final int BAUD_RATE = 4800;\n+    private static final int SERIAL_PORT_OPEN_INIT_DELAY_MS = 500;\n+    private static final int SERIAL_PORT_OPEN_RETRY_DELAY_MS = 30_000;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialPIMHandler.class);\n+\n+    private SerialPortManager serialPortManager;\n+    private volatile @Nullable SerialIoThread receiveThread;\n+    private volatile @Nullable ScheduledFuture<?> futSerialPortInit;\n+\n+    public SerialPIMHandler(final Bridge thing, final SerialPortManager serialPortManager) {\n+        super(thing);\n+        this.serialPortManager = serialPortManager;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"Initializing Serial UPB PIM {}.\", getThing().getUID());\n+        super.initialize();\n+\n+        final String portId = (String) getConfig().get(Constants.CONFIGURATION_PORT);\n+        if (portId == null || portId.isEmpty()) {\n+            logger.warn(\"serial port is not set\");\n+            return;\n+        }\n+\n+        futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_INIT_DELAY_MS,\n+                TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        final ScheduledFuture<?> futSerialPortInit = this.futSerialPortInit;\n+        if (futSerialPortInit != null) {\n+            futSerialPortInit.cancel(true);\n+            this.futSerialPortInit = null;\n+        }\n+        final SerialIoThread receiveThread = this.receiveThread;\n+        if (receiveThread != null) {\n+            receiveThread.terminate();\n+            try {\n+                receiveThread.join(1000);\n+            } catch (final InterruptedException e) {\n+                // ignore\n+            }\n+            this.receiveThread = null;\n+        }\n+        logger.debug(\"Stopped UPB serial handler\");\n+        super.dispose();\n+    }\n+\n+    private void openSerialPort(final String portId) {\n+        try {\n+            final SerialPort serialPort = tryOpenSerialPort(portId);\n+            if (serialPort == null) {\n+                futSerialPortInit = scheduler.schedule(() -> openSerialPort(portId), SERIAL_PORT_OPEN_RETRY_DELAY_MS,\n+                        TimeUnit.MILLISECONDS);\n+                return;\n+            }\n+            logger.debug(\"Starting receive thread\");\n+            final SerialIoThread receiveThread = new SerialIoThread(serialPort, this);\n+            this.receiveThread = receiveThread;\n+            // Once the receiver starts, it may set the PIM status to ONLINE\n+            // so we must ensure all initialization is finished at that point.\n+            receiveThread.start();\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (final Exception e) {\n+            logger.warn(\"failed to open serial port\", e);\n+        }\n+    }\n+\n+    private @Nullable SerialPort tryOpenSerialPort(final String portId) {\n+        logger.debug(\"opening serial port {}\", portId);\n+        final SerialPortIdentifier portIdentifier = serialPortManager.getIdentifier(portId);\n+        if (portIdentifier == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    Constants.OFFLINE_SERIAL_EXISTS);\n+            return null;\n+        }\n+\n+        final SerialPort serialPort;\n+        try {\n+            serialPort = portIdentifier.open(\"org.openhab.binding.upb\", 1000);\n+        } catch (final PortInUseException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.OFFLINE.COMMUNICATION_ERROR,\n+                    Constants.OFFLINE_SERIAL_INUSE);\n+            return null;\n+        }\n+        try {\n+            serialPort.setSerialPortParams(BAUD_RATE, SerialPort.DATABITS_8, SerialPort.STOPBITS_1,\n+                    SerialPort.PARITY_NONE);\n+            serialPort.setFlowControlMode(SerialPort.FLOWCONTROL_NONE);\n+            try {\n+                serialPort.enableReceiveThreshold(1);\n+                serialPort.enableReceiveTimeout(SERIAL_RECEIVE_TIMEOUT);\n+            } catch (final UnsupportedCommOperationException e) {\n+                // ignore - not supported for RFC2217 ports\n+            }\n+        } catch (final UnsupportedCommOperationException e) {\n+            logger.warn(\"cannot open serial port\", e);", "originalCommit": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNDgxMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485904811", "bodyText": "The refresh is given for each channel. So calling refreshDeviceState might be a bit of an overload.", "author": "Hilbrand", "createdAt": "2020-09-09T20:32:36Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingHandler.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handler for things representing devices on an UPB network.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class UPBThingHandler extends BaseThingHandler {\n+    private final Logger logger = LoggerFactory.getLogger(UPBThingHandler.class);\n+    private final @Nullable Byte defaultNetworkId;\n+\n+    protected volatile byte networkId;\n+    protected volatile int unitId;\n+\n+    public UPBThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device);\n+        this.defaultNetworkId = defaultNetworkId;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"initializing UPB thing handler {}\", getThing().getUID());\n+\n+        final BigDecimal val = (BigDecimal) getConfig().get(Constants.CONFIGURATION_NETWORK_ID);\n+        if (val == null) {\n+            // use value from binding config\n+            final Byte defaultNetworkId = this.defaultNetworkId;\n+            if (defaultNetworkId == null) {\n+                logger.warn(\"missing network ID for {}\", getThing().getUID());\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing network ID\");\n+                return;\n+            }\n+            networkId = defaultNetworkId.byteValue();\n+        } else if (val.compareTo(BigDecimal.ZERO) < 0 || val.compareTo(BigDecimal.valueOf(255)) > 0) {\n+            logger.warn(\"invalid network ID {} for {}\", val, getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"invalid network ID\");\n+            return;\n+        } else {\n+            networkId = val.byteValue();\n+        }\n+\n+        final BigDecimal cfgUnitId = (BigDecimal) getConfig().get(Constants.CONFIGURATION_UNIT_ID);\n+        if (cfgUnitId == null) {\n+            logger.warn(\"Unit ID is not set in {}\", getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing unit ID\");\n+            return;\n+        }\n+        unitId = cfgUnitId.intValue();\n+        if (unitId < 1 || unitId > 250) {\n+            logger.warn(\"Unit ID ({}) out of range for {}\", cfgUnitId, getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"invalid unit ID\");\n+            return;\n+        }\n+\n+        final Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, Constants.OFFLINE_CTLR_OFFLINE);\n+            return;\n+        }\n+        bridgeStatusChanged(bridge.getStatusInfo());\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(final ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"DEV {}: Controller status is {}\", unitId, bridgeStatusInfo.getStatus());\n+\n+        if (bridgeStatusInfo.getStatus() != ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, Constants.OFFLINE_CTLR_OFFLINE);\n+            return;\n+        }\n+\n+        logger.debug(\"DEV {}: Controller is ONLINE. Starting device initialisation.\", unitId);\n+\n+        final Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            logger.debug(\"DEV {}: bridge is null!\", unitId);\n+            return;\n+        }\n+        final PIMHandler bridgeHandler = (PIMHandler) bridge.getHandler();\n+        if (bridgeHandler == null) {\n+            logger.debug(\"DEV {}: bridge handler is null!\", unitId);\n+            return;\n+        }\n+        updateDeviceStatus(bridgeHandler);\n+        pingDevice();\n+    }\n+\n+    @Override\n+    public void handleCommand(final ChannelUID channelUID, final Command cmd) {\n+        final PIMHandler pimHandler = getPIMHandler();\n+        if (pimHandler == null) {\n+            logger.info(\"DEV {}: received cmd {} but no bridge handler\", unitId, cmd);\n+            return;\n+        }\n+\n+        final MessageBuilder message;\n+        if (cmd == OnOffType.ON) {\n+            message = MessageBuilder.forCommand(ACTIVATE);\n+        } else if (cmd == OnOffType.OFF) {\n+            message = MessageBuilder.forCommand(DEACTIVATE);\n+        } else if (cmd instanceof PercentType) {\n+            message = MessageBuilder.forCommand(GOTO).args(((PercentType) cmd).byteValue());\n+        } else if (cmd == RefreshType.REFRESH) {\n+            refreshDeviceState();", "originalCommit": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzUzOTc1MA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487539750", "bodyText": "refreshDeviceState might still cause multiple calls to the device on refresh. You could use a (org.eclipse..) ExpiringCache with something of 3 seconds timeout to avoid it when the ui calls refresh on all channels.", "author": "Hilbrand", "createdAt": "2020-09-13T14:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNDgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNzE3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485907177", "bodyText": "This author tag should be removed (probably a left over from the old binding)", "author": "Hilbrand", "createdAt": "2020-09-09T20:36:53Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/UPBMessage.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+\n+import java.util.Arrays;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.smarthome.core.util.HexUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Model for a message sent or received from a UPB modem.\n+ *\n+ * @author cvanorman - Initial contribution\n+ */\n+@NonNullByDefault\n+public class UPBMessage {\n+\n+    /**\n+     * An enum of possible modem response types.\n+     *\n+     * @author cvanorman", "originalCommit": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMTQ1OA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r486731458", "bodyText": "It is, this class was brought over from the old binding, so I'm uncomfortable removing the author tag.", "author": "marcusb", "createdAt": "2020-09-11T02:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc5MzA1MA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r486793050", "bodyText": "The author is already on the class so it's no problem removing the tag.", "author": "Hilbrand", "createdAt": "2020-09-11T06:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNzE3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNzk5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r485907999", "bodyText": "Is there a specific  exception to catch or else RuntimeException.", "author": "Hilbrand", "createdAt": "2020-09-09T20:38:30Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/internal/message/UPBMessage.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.internal.message;\n+\n+import java.util.Arrays;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.smarthome.core.util.HexUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Model for a message sent or received from a UPB modem.\n+ *\n+ * @author cvanorman - Initial contribution\n+ */\n+@NonNullByDefault\n+public class UPBMessage {\n+\n+    /**\n+     * An enum of possible modem response types.\n+     *\n+     * @author cvanorman\n+     *\n+     */\n+    public enum Type {\n+        ACCEPT(\"PA\"),\n+        BUSY(\"PB\"),\n+        ERROR(\"PE\"),\n+        ACK(\"PK\"),\n+        NAK(\"PN\"),\n+        MESSAGE_REPORT(\"PU\"),\n+        NONE(\"\");\n+\n+        private final String prefix;\n+\n+        Type(final String prefix) {\n+            this.prefix = prefix;\n+        }\n+\n+        /**\n+         * @return the message prefix string for this type\n+         */\n+        public String prefix() {\n+            return prefix;\n+        }\n+\n+        /**\n+         * Returns the message type for a protocol string prefix.\n+         *\n+         * @param value the prefix string\n+         * @return the message type for the given string\n+         */\n+        public static Type forPrefix(final String value) {\n+            for (final Type t : values()) {\n+                if (t.prefix().equals(value)) {\n+                    return t;\n+                }\n+            }\n+            return NONE;\n+        }\n+    }\n+\n+    private static final Logger logger = LoggerFactory.getLogger(UPBMessage.class);\n+\n+    private final Type type;\n+\n+    private ControlWord controlWord = new ControlWord();\n+    private byte network;\n+    private byte destination;\n+    private byte source;\n+\n+    private Command command = Command.NULL;\n+    private byte[] arguments = new byte[0];\n+\n+    private UPBMessage(final Type type) {\n+        this.type = type;\n+    }\n+\n+    /**\n+     * Converts a hex string into a {@link UPBMessage}.\n+     *\n+     * @param commandString\n+     *            the string as returned by the modem.\n+     * @return a new UPBMessage.\n+     */\n+    public static UPBMessage fromString(String commandString) {\n+        final String prefix = commandString.substring(0, 2);\n+        final UPBMessage msg = new UPBMessage(Type.forPrefix(prefix));\n+\n+        try {\n+            if (commandString.length() > 2) {\n+                byte[] data = HexUtils.hexToBytes(commandString.substring(2));\n+                msg.getControlWord().setBytes(data[0], data[1]);\n+                int index = 2;\n+                msg.setNetwork(data[index++]);\n+                msg.setDestination(data[index++]);\n+                msg.setSource(data[index++]);\n+\n+                byte commandCode = data[index++];\n+                msg.setCommand(Command.valueOf(commandCode));\n+\n+                if (index <= data.length - 1) {\n+                    msg.setArguments(Arrays.copyOfRange(data, index, data.length - 1));\n+                }\n+            }\n+        } catch (Exception e) {", "originalCommit": "ccbdba16a977a3e7ecb2e62b8998fd125908a3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf0b0f6cd2caa6ec9e21b85fa29d2a1cefd82398", "url": "https://github.com/openhab/openhab-addons/commit/bf0b0f6cd2caa6ec9e21b85fa29d2a1cefd82398", "message": "Add missing groupId\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:29:36Z", "type": "forcePushed"}, {"oid": "caecbaece2902d0ff7eb8689c71650764774fa32", "url": "https://github.com/openhab/openhab-addons/commit/caecbaece2902d0ff7eb8689c71650764774fa32", "message": "UPB Binding\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:03Z", "type": "commit"}, {"oid": "7b0b9143b9c4f03ea1ea76efed526d149dfa5049", "url": "https://github.com/openhab/openhab-addons/commit/7b0b9143b9c4f03ea1ea76efed526d149dfa5049", "message": "Review comments\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "0a24bd1ea51007fd361e25b1477f72fcbcddf083", "url": "https://github.com/openhab/openhab-addons/commit/0a24bd1ea51007fd361e25b1477f72fcbcddf083", "message": "Avoid nullability in MessageBuilder\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "1e7ea2af4b6162b6f8a1268a8dfcce5c75e47924", "url": "https://github.com/openhab/openhab-addons/commit/1e7ea2af4b6162b6f8a1268a8dfcce5c75e47924", "message": "Fix nullability warnings\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "aeb5e235dbcecb92e9c9ebce50a62e661298cedb", "url": "https://github.com/openhab/openhab-addons/commit/aeb5e235dbcecb92e9c9ebce50a62e661298cedb", "message": "Capitalization\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "6828adfc6a7c123a37f517403483fd203b1df09b", "url": "https://github.com/openhab/openhab-addons/commit/6828adfc6a7c123a37f517403483fd203b1df09b", "message": "Retrieve PIM handler on the fly\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "481082a1c184eb1de8d3c28bf73487b62eca9262", "url": "https://github.com/openhab/openhab-addons/commit/481082a1c184eb1de8d3c28bf73487b62eca9262", "message": "Set status to OFFLINE on invalid configuration\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "07e3ad0a1dfe035bfa5ce60533a2c2236125ca6b", "url": "https://github.com/openhab/openhab-addons/commit/07e3ad0a1dfe035bfa5ce60533a2c2236125ca6b", "message": "Set thread names and ensure daemon threads\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "9771c3f3fa2fd1a4df76b3297043260948c64a5a", "url": "https://github.com/openhab/openhab-addons/commit/9771c3f3fa2fd1a4df76b3297043260948c64a5a", "message": "Spotless\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "9051c8846e89d0d3c79b90a8734c1a3fdf7505f9", "url": "https://github.com/openhab/openhab-addons/commit/9051c8846e89d0d3c79b90a8734c1a3fdf7505f9", "message": "Silence a warning\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "aab578a3b111205aafa9b2760151e51a81733a13", "url": "https://github.com/openhab/openhab-addons/commit/aab578a3b111205aafa9b2760151e51a81733a13", "message": "Buffered input stream for reading\n\nAlso makes UPBMessage more immutable (stil not completely).x\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "0e8c593ab6b371e05efc0ea51479649064f98391", "url": "https://github.com/openhab/openhab-addons/commit/0e8c593ab6b371e05efc0ea51479649064f98391", "message": "Adjust log levels\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "92f7f1ddd105831d48040b8cedc7c9d56a452745", "url": "https://github.com/openhab/openhab-addons/commit/92f7f1ddd105831d48040b8cedc7c9d56a452745", "message": "Update README\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "52a365b47279abf9efaeb66867770e359f873de3", "url": "https://github.com/openhab/openhab-addons/commit/52a365b47279abf9efaeb66867770e359f873de3", "message": "Do not catch Exception\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "d791d77919330a14331b4a139311628aa16ce0cb", "url": "https://github.com/openhab/openhab-addons/commit/d791d77919330a14331b4a139311628aa16ce0cb", "message": "Remove the switch channel\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "9af57bc01f1b2fe868e7483e01fa888c29ece67e", "url": "https://github.com/openhab/openhab-addons/commit/9af57bc01f1b2fe868e7483e01fa888c29ece67e", "message": "Add missing groupId\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "commit"}, {"oid": "9af57bc01f1b2fe868e7483e01fa888c29ece67e", "url": "https://github.com/openhab/openhab-addons/commit/9af57bc01f1b2fe868e7483e01fa888c29ece67e", "message": "Add missing groupId\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:34:25Z", "type": "forcePushed"}, {"oid": "57ff0dc1caf067048d387d26c09efb7a31dd7c4d", "url": "https://github.com/openhab/openhab-addons/commit/57ff0dc1caf067048d387d26c09efb7a31dd7c4d", "message": "Propagate status if serial thread crashes\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:48:42Z", "type": "commit"}, {"oid": "d9a7ae3968873b5e811fc31e4116831c4149cef7", "url": "https://github.com/openhab/openhab-addons/commit/d9a7ae3968873b5e811fc31e4116831c4149cef7", "message": "Update status on serial port config error\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-11T02:56:36Z", "type": "commit"}, {"oid": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "url": "https://github.com/openhab/openhab-addons/commit/1f2ebb6e62145c8f284fd38a75398632c8b014ae", "message": "Remove extra author tag\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-13T00:20:18Z", "type": "commit"}, {"oid": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "url": "https://github.com/openhab/openhab-addons/commit/1f2ebb6e62145c8f284fd38a75398632c8b014ae", "message": "Remove extra author tag\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-13T00:20:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NTM5MA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487555390", "bodyText": "Is this class not in the internal package intentionally? Same for the others not in internal.", "author": "fwolter", "createdAt": "2020-09-13T17:29:48Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/Constants.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.smarthome.core.thing.ThingTypeUID;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+\n+/**\n+ * Common constants used in the binding.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ */\n+@NonNullByDefault\n+public final class Constants {", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1OTkxMA==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487559910", "bodyText": "This is probably a remnisant of the older version of the binding. Since then we changed to have all files that are used in other projects to be in the internal package. For bindings this means all files should be in the internal package. So yes please move these files to the internal package.", "author": "Hilbrand", "createdAt": "2020-09-13T18:15:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NTM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NjIxMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487556211", "bodyText": "Logging to info should be used rarely. This could be debug or warn.", "author": "fwolter", "createdAt": "2020-09-13T17:37:35Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialIoThread.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import java.io.BufferedInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.NamedThreadFactory;\n+import org.eclipse.smarthome.core.thing.ThingUID;\n+import org.eclipse.smarthome.core.util.HexUtils;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEvent;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortEventListener;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.MessageParseException;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Event loop for serial communications. Handles sending and receiving UPB messages.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialIoThread extends Thread implements SerialPortEventListener {\n+    private static final int WRITE_QUEUE_LENGTH = 128;\n+    private static final int ACK_TIMEOUT_MS = 500;\n+    private static final byte[] ENABLE_MESSAGE_MODE_CMD = \"\\u001770028E\\n\".getBytes(StandardCharsets.US_ASCII);\n+\n+    private static final int MAX_READ_SIZE = 128;\n+    private static final int CR = 13;\n+\n+    private final Logger logger = LoggerFactory.getLogger(SerialIoThread.class);\n+    private final MessageListener listener;\n+    // Single-threaded executor for writes that serves to serialize writes.\n+    private final ExecutorService writeExecutor = new ThreadPoolExecutor(1, 1, 30, TimeUnit.SECONDS,\n+            new LinkedBlockingQueue<>(WRITE_QUEUE_LENGTH), new NamedThreadFactory(\"upb-serial-writer\", true));\n+    private final SerialPort serialPort;\n+\n+    private volatile @Nullable WriteRunnable currentWrite;\n+    private volatile boolean done;\n+\n+    public SerialIoThread(final SerialPort serialPort, final MessageListener listener, final ThingUID thingUID) {\n+        this.serialPort = serialPort;\n+        this.listener = listener;\n+        setName(\"OH-binding-\" + thingUID + \"-serial-reader\");\n+        setDaemon(true);\n+    }\n+\n+    @Override\n+    public void serialEvent(final SerialPortEvent event) {\n+        try {\n+            logger.trace(\"RXTX library CPU load workaround, sleep forever\");\n+            Thread.sleep(Long.MAX_VALUE);\n+        } catch (final InterruptedException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public void run() {\n+        serialPort.disableReceiveTimeout();\n+        enterMessageMode();\n+        try (final InputStream in = serialPort.getInputStream()) {\n+            if (in == null) {\n+                // should never happen\n+                throw new IllegalStateException(\"serial port is not readable\");\n+            }\n+            try (final InputStream bufIn = new BufferedInputStream(in)) {\n+                bufIn.mark(MAX_READ_SIZE);\n+                int b;\n+                int len = 0;\n+                while (!done && (b = bufIn.read()) >= 0) {\n+                    len++;\n+                    if (b == CR) {\n+                        // message terminator read, rewind the stream and parse the buffered message\n+                        try {\n+                            bufIn.reset();\n+                            processBuffer(bufIn, len);\n+                        } catch (final IOException e) {\n+                            logger.warn(\"buffer overrun, dropped long message\", e);\n+                        } finally {\n+                            bufIn.mark(MAX_READ_SIZE);\n+                            len = 0;\n+                        }\n+                    }\n+                }\n+            }\n+        } catch (final IOException e) {\n+            logger.warn(\"Exception in UPB read thread\", e);\n+        } finally {\n+            logger.debug(\"shutting down receive thread\");\n+            shutdownAndAwaitTermination(writeExecutor);\n+            try {\n+                serialPort.close();\n+            } catch (final RuntimeException e) {\n+                // ignore\n+            }\n+        }\n+        logger.debug(\"UPB read thread stopped\");\n+    }\n+\n+    /**\n+     * Attempts to parse a message from the input stream.\n+     *\n+     * @param in the stream to read from\n+     * @param len the number of bytes in the message\n+     */\n+    private void processBuffer(final InputStream in, final int len) {\n+        final byte[] buf = new byte[len];\n+        final int n;\n+        try {\n+            n = in.read(buf);\n+        } catch (final IOException e) {\n+            logger.warn(\"error reading message\", e);\n+            return;\n+        }\n+        if (n < len) {\n+            // should not happen when replaying the buffered input\n+            logger.warn(\"truncated read, expected={} read={}\", len, n);\n+            return;\n+        }\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"UPB Message: {}\", HexUtils.bytesToHex(buf));\n+        }\n+        final UPBMessage msg;\n+        try {\n+            msg = UPBMessage.parse(buf);\n+        } catch (final MessageParseException e) {\n+            logger.warn(\"failed to parse message: {}\", HexUtils.bytesToHex(buf), e);\n+            return;\n+        }\n+        handleMessage(msg);\n+    }\n+\n+    private void handleMessage(final UPBMessage msg) {\n+        final WriteRunnable writeRunnable = currentWrite;\n+        switch (msg.getType()) {\n+            case ACK:\n+                if (writeRunnable != null) {\n+                    writeRunnable.ackReceived(true);\n+                }\n+                break;\n+            case NAK:\n+                if (writeRunnable != null) {\n+                    writeRunnable.ackReceived(false);\n+                }\n+                break;\n+            case ACCEPT:\n+                break;\n+            case ERROR:\n+                logger.info(\"received ERROR response from PIM\");", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NjM2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487556367", "bodyText": "It's good practice to append the unit to the field name e.g. TIMEOUT_SEC.", "author": "fwolter", "createdAt": "2020-09-13T17:39:18Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/SerialPIMHandler.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.io.transport.serial.PortInUseException;\n+import org.eclipse.smarthome.io.transport.serial.SerialPort;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortIdentifier;\n+import org.eclipse.smarthome.io.transport.serial.SerialPortManager;\n+import org.eclipse.smarthome.io.transport.serial.UnsupportedCommOperationException;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Bridge handler responsible for serial PIM communications.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class SerialPIMHandler extends PIMHandler {\n+    private static final int SERIAL_RECEIVE_TIMEOUT = 100;", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NjYzMw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487556633", "bodyText": "Enum members should be all upper case and SNAKE_CASE.", "author": "fwolter", "createdAt": "2020-09-13T17:41:55Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingChannel.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+\n+/**\n+ * A channel supported by UPB things.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class UPBThingChannel {\n+    public enum DataType {\n+        OnOffType,\n+        PercentType", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NjgwMg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487556802", "bodyText": "You could remove the logging statement, as updateStatus() already does the logging. Same for below.", "author": "fwolter", "createdAt": "2020-09-13T17:43:45Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingHandler.java", "diffHunk": "@@ -0,0 +1,287 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handler for things representing devices on an UPB network.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class UPBThingHandler extends BaseThingHandler {\n+    private final Logger logger = LoggerFactory.getLogger(UPBThingHandler.class);\n+    private final @Nullable Byte defaultNetworkId;\n+\n+    protected volatile byte networkId;\n+    protected volatile int unitId;\n+\n+    public UPBThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device);\n+        this.defaultNetworkId = defaultNetworkId;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"initializing UPB thing handler {}\", getThing().getUID());\n+\n+        final BigDecimal val = (BigDecimal) getConfig().get(Constants.CONFIGURATION_NETWORK_ID);\n+        if (val == null) {\n+            // use value from binding config\n+            final Byte defaultNetworkId = this.defaultNetworkId;\n+            if (defaultNetworkId == null) {\n+                logger.debug(\"missing network ID for {}\", getThing().getUID());\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing network ID\");", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NzI5MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487557291", "bodyText": "Child Things are set to OFFLINE by the framework, when the bridge goes offline and vice versa. If I see correctly, you could remove the entire method and invoke updateDeviceStatus() and pingDevice() in initialize().", "author": "fwolter", "createdAt": "2020-09-13T17:47:52Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingHandler.java", "diffHunk": "@@ -0,0 +1,287 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handler for things representing devices on an UPB network.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class UPBThingHandler extends BaseThingHandler {\n+    private final Logger logger = LoggerFactory.getLogger(UPBThingHandler.class);\n+    private final @Nullable Byte defaultNetworkId;\n+\n+    protected volatile byte networkId;\n+    protected volatile int unitId;\n+\n+    public UPBThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device);\n+        this.defaultNetworkId = defaultNetworkId;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"initializing UPB thing handler {}\", getThing().getUID());\n+\n+        final BigDecimal val = (BigDecimal) getConfig().get(Constants.CONFIGURATION_NETWORK_ID);\n+        if (val == null) {\n+            // use value from binding config\n+            final Byte defaultNetworkId = this.defaultNetworkId;\n+            if (defaultNetworkId == null) {\n+                logger.debug(\"missing network ID for {}\", getThing().getUID());\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing network ID\");\n+                return;\n+            }\n+            networkId = defaultNetworkId.byteValue();\n+        } else if (val.compareTo(BigDecimal.ZERO) < 0 || val.compareTo(BigDecimal.valueOf(255)) > 0) {\n+            logger.debug(\"invalid network ID {} for {}\", val, getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"invalid network ID\");\n+            return;\n+        } else {\n+            networkId = val.byteValue();\n+        }\n+\n+        final BigDecimal cfgUnitId = (BigDecimal) getConfig().get(Constants.CONFIGURATION_UNIT_ID);\n+        if (cfgUnitId == null) {\n+            logger.debug(\"Unit ID is not set in {}\", getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing unit ID\");\n+            return;\n+        }\n+        unitId = cfgUnitId.intValue();\n+        if (unitId < 1 || unitId > 250) {\n+            logger.debug(\"Unit ID ({}) out of range for {}\", cfgUnitId, getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"invalid unit ID\");\n+            return;\n+        }\n+\n+        final Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, Constants.OFFLINE_CTLR_OFFLINE);\n+            return;\n+        }\n+        bridgeStatusChanged(bridge.getStatusInfo());\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(final ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"DEV {}: Controller status is {}\", unitId, bridgeStatusInfo.getStatus());\n+\n+        if (bridgeStatusInfo.getStatus() != ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, Constants.OFFLINE_CTLR_OFFLINE);\n+            return;", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYwMjM2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487602362", "bodyText": "If the method is removed, how would updateDeviceStatus() and pingDevice() get called when the bridge goes online again?", "author": "marcusb", "createdAt": "2020-09-14T00:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NzI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwODM3MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487708371", "bodyText": "I just saw, that initialize() is not invoked when the Thing status changes from OFFLINE to ONLINE again. Please ignore my comment.", "author": "fwolter", "createdAt": "2020-09-14T07:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NzI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTkwMjM3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r489902377", "bodyText": "I have verified that this method is needed. Even if I just remove the above call to updateStatus(), the devices never come back online after the bridge comes online. So it seems we cannot rely on the framework updating the status of the child things.", "author": "marcusb", "createdAt": "2020-09-17T02:43:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NzI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NzMxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487557315", "bodyText": "See above. Logging to info.", "author": "fwolter", "createdAt": "2020-09-13T17:48:15Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingHandler.java", "diffHunk": "@@ -0,0 +1,287 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handler for things representing devices on an UPB network.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class UPBThingHandler extends BaseThingHandler {\n+    private final Logger logger = LoggerFactory.getLogger(UPBThingHandler.class);\n+    private final @Nullable Byte defaultNetworkId;\n+\n+    protected volatile byte networkId;\n+    protected volatile int unitId;\n+\n+    public UPBThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device);\n+        this.defaultNetworkId = defaultNetworkId;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"initializing UPB thing handler {}\", getThing().getUID());\n+\n+        final BigDecimal val = (BigDecimal) getConfig().get(Constants.CONFIGURATION_NETWORK_ID);\n+        if (val == null) {\n+            // use value from binding config\n+            final Byte defaultNetworkId = this.defaultNetworkId;\n+            if (defaultNetworkId == null) {\n+                logger.debug(\"missing network ID for {}\", getThing().getUID());\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing network ID\");\n+                return;\n+            }\n+            networkId = defaultNetworkId.byteValue();\n+        } else if (val.compareTo(BigDecimal.ZERO) < 0 || val.compareTo(BigDecimal.valueOf(255)) > 0) {\n+            logger.debug(\"invalid network ID {} for {}\", val, getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"invalid network ID\");\n+            return;\n+        } else {\n+            networkId = val.byteValue();\n+        }\n+\n+        final BigDecimal cfgUnitId = (BigDecimal) getConfig().get(Constants.CONFIGURATION_UNIT_ID);\n+        if (cfgUnitId == null) {\n+            logger.debug(\"Unit ID is not set in {}\", getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing unit ID\");\n+            return;\n+        }\n+        unitId = cfgUnitId.intValue();\n+        if (unitId < 1 || unitId > 250) {\n+            logger.debug(\"Unit ID ({}) out of range for {}\", cfgUnitId, getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"invalid unit ID\");\n+            return;\n+        }\n+\n+        final Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, Constants.OFFLINE_CTLR_OFFLINE);\n+            return;\n+        }\n+        bridgeStatusChanged(bridge.getStatusInfo());\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(final ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"DEV {}: Controller status is {}\", unitId, bridgeStatusInfo.getStatus());\n+\n+        if (bridgeStatusInfo.getStatus() != ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, Constants.OFFLINE_CTLR_OFFLINE);\n+            return;\n+        }\n+\n+        logger.debug(\"DEV {}: Controller is ONLINE. Starting device initialisation.\", unitId);\n+\n+        final Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            logger.debug(\"DEV {}: bridge is null!\", unitId);\n+            return;\n+        }\n+        final PIMHandler bridgeHandler = (PIMHandler) bridge.getHandler();\n+        if (bridgeHandler == null) {\n+            logger.debug(\"DEV {}: bridge handler is null!\", unitId);\n+            return;\n+        }\n+        updateDeviceStatus(bridgeHandler);\n+        pingDevice();\n+    }\n+\n+    @Override\n+    public void handleCommand(final ChannelUID channelUID, final Command cmd) {\n+        final PIMHandler pimHandler = getPIMHandler();\n+        if (pimHandler == null) {\n+            logger.info(\"DEV {}: received cmd {} but no bridge handler\", unitId, cmd);\n+            return;\n+        }\n+\n+        final MessageBuilder message;\n+        if (cmd == OnOffType.ON) {\n+            message = MessageBuilder.forCommand(ACTIVATE);\n+        } else if (cmd == OnOffType.OFF) {\n+            message = MessageBuilder.forCommand(DEACTIVATE);\n+        } else if (cmd instanceof PercentType) {\n+            message = MessageBuilder.forCommand(GOTO).args(((PercentType) cmd).byteValue());\n+        } else if (cmd == RefreshType.REFRESH) {\n+            refreshDeviceState();\n+            return;\n+        } else {\n+            logger.info(\"channel {}: unsupported cmd {}\", channelUID, cmd);", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NzMzNg==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487557336", "bodyText": "See above", "author": "fwolter", "createdAt": "2020-09-13T17:48:28Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/UPBThingHandler.java", "diffHunk": "@@ -0,0 +1,287 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import java.math.BigDecimal;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.thing.Bridge;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.thing.ThingStatusDetail;\n+import org.eclipse.smarthome.core.thing.ThingStatusInfo;\n+import org.eclipse.smarthome.core.thing.binding.BaseThingHandler;\n+import org.eclipse.smarthome.core.thing.type.ChannelTypeUID;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.UPBDevice;\n+import org.openhab.binding.upb.handler.UPBIoHandler.CmdStatus;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handler for things representing devices on an UPB network.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class UPBThingHandler extends BaseThingHandler {\n+    private final Logger logger = LoggerFactory.getLogger(UPBThingHandler.class);\n+    private final @Nullable Byte defaultNetworkId;\n+\n+    protected volatile byte networkId;\n+    protected volatile int unitId;\n+\n+    public UPBThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device);\n+        this.defaultNetworkId = defaultNetworkId;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        logger.debug(\"initializing UPB thing handler {}\", getThing().getUID());\n+\n+        final BigDecimal val = (BigDecimal) getConfig().get(Constants.CONFIGURATION_NETWORK_ID);\n+        if (val == null) {\n+            // use value from binding config\n+            final Byte defaultNetworkId = this.defaultNetworkId;\n+            if (defaultNetworkId == null) {\n+                logger.debug(\"missing network ID for {}\", getThing().getUID());\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing network ID\");\n+                return;\n+            }\n+            networkId = defaultNetworkId.byteValue();\n+        } else if (val.compareTo(BigDecimal.ZERO) < 0 || val.compareTo(BigDecimal.valueOf(255)) > 0) {\n+            logger.debug(\"invalid network ID {} for {}\", val, getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"invalid network ID\");\n+            return;\n+        } else {\n+            networkId = val.byteValue();\n+        }\n+\n+        final BigDecimal cfgUnitId = (BigDecimal) getConfig().get(Constants.CONFIGURATION_UNIT_ID);\n+        if (cfgUnitId == null) {\n+            logger.debug(\"Unit ID is not set in {}\", getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"missing unit ID\");\n+            return;\n+        }\n+        unitId = cfgUnitId.intValue();\n+        if (unitId < 1 || unitId > 250) {\n+            logger.debug(\"Unit ID ({}) out of range for {}\", cfgUnitId, getThing().getUID());\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR, \"invalid unit ID\");\n+            return;\n+        }\n+\n+        final Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, Constants.OFFLINE_CTLR_OFFLINE);\n+            return;\n+        }\n+        bridgeStatusChanged(bridge.getStatusInfo());\n+    }\n+\n+    @Override\n+    public void bridgeStatusChanged(final ThingStatusInfo bridgeStatusInfo) {\n+        logger.debug(\"DEV {}: Controller status is {}\", unitId, bridgeStatusInfo.getStatus());\n+\n+        if (bridgeStatusInfo.getStatus() != ThingStatus.ONLINE) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE, Constants.OFFLINE_CTLR_OFFLINE);\n+            return;\n+        }\n+\n+        logger.debug(\"DEV {}: Controller is ONLINE. Starting device initialisation.\", unitId);\n+\n+        final Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            logger.debug(\"DEV {}: bridge is null!\", unitId);\n+            return;\n+        }\n+        final PIMHandler bridgeHandler = (PIMHandler) bridge.getHandler();\n+        if (bridgeHandler == null) {\n+            logger.debug(\"DEV {}: bridge handler is null!\", unitId);\n+            return;\n+        }\n+        updateDeviceStatus(bridgeHandler);\n+        pingDevice();\n+    }\n+\n+    @Override\n+    public void handleCommand(final ChannelUID channelUID, final Command cmd) {\n+        final PIMHandler pimHandler = getPIMHandler();\n+        if (pimHandler == null) {\n+            logger.info(\"DEV {}: received cmd {} but no bridge handler\", unitId, cmd);\n+            return;\n+        }\n+\n+        final MessageBuilder message;\n+        if (cmd == OnOffType.ON) {\n+            message = MessageBuilder.forCommand(ACTIVATE);\n+        } else if (cmd == OnOffType.OFF) {\n+            message = MessageBuilder.forCommand(DEACTIVATE);\n+        } else if (cmd instanceof PercentType) {\n+            message = MessageBuilder.forCommand(GOTO).args(((PercentType) cmd).byteValue());\n+        } else if (cmd == RefreshType.REFRESH) {\n+            refreshDeviceState();\n+            return;\n+        } else {\n+            logger.info(\"channel {}: unsupported cmd {}\", channelUID, cmd);\n+            return;\n+        }\n+\n+        message.network(networkId).destination(getUnitId());\n+        pimHandler.sendPacket(message).thenAccept(this::updateStatus);\n+    }\n+\n+    public void onMessageReceived(final UPBMessage msg) {\n+        updateStatus(ThingStatus.ONLINE);\n+        if (msg.getControlWord().isLink()) {\n+            handleLinkMessage(msg);\n+        } else {\n+            handleDirectMessage(msg);\n+        }\n+    }\n+\n+    private void handleDirectMessage(final UPBMessage msg) {\n+        final State state;\n+        switch (msg.getCommand()) {\n+            case ACTIVATE:\n+                state = OnOffType.ON;\n+                break;\n+\n+            case DEACTIVATE:\n+                state = OnOffType.OFF;\n+                break;\n+\n+            case GOTO:\n+                if (msg.getArguments().length == 0) {\n+                    logger.info(\"DEV {}: malformed GOTO cmd\", unitId);", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NzUxMw==", "url": "https://github.com/openhab/openhab-addons/pull/6742#discussion_r487557513", "bodyText": "See above. Logging to info. Same for below.", "author": "fwolter", "createdAt": "2020-09-13T17:50:27Z", "path": "bundles/org.openhab.binding.upb/src/main/java/org/openhab/binding/upb/handler/VirtualThingHandler.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.upb.handler;\n+\n+import static org.openhab.binding.upb.internal.message.Command.*;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.thing.Channel;\n+import org.eclipse.smarthome.core.thing.ChannelUID;\n+import org.eclipse.smarthome.core.thing.Thing;\n+import org.eclipse.smarthome.core.thing.ThingStatus;\n+import org.eclipse.smarthome.core.types.Command;\n+import org.eclipse.smarthome.core.types.RefreshType;\n+import org.openhab.binding.upb.Constants;\n+import org.openhab.binding.upb.internal.message.MessageBuilder;\n+import org.openhab.binding.upb.internal.message.UPBMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Thing handler for a virtual device.\n+ *\n+ * @author Marcus Better - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class VirtualThingHandler extends UPBThingHandler {\n+\n+    private final Logger logger = LoggerFactory.getLogger(VirtualThingHandler.class);\n+\n+    public VirtualThingHandler(final Thing device, final @Nullable Byte defaultNetworkId) {\n+        super(device, defaultNetworkId);\n+    }\n+\n+    @Override\n+    protected void pingDevice() {\n+        // always succeeds for virtual device\n+        updateStatus(ThingStatus.ONLINE);\n+    }\n+\n+    @Override\n+    public void handleCommand(final ChannelUID channelUID, final Command cmd) {\n+        final PIMHandler pimHandler = getPIMHandler();\n+        if (pimHandler == null) {\n+            logger.info(\"DEV {}: received cmd {} but no bridge handler\", unitId, cmd);", "originalCommit": "1f2ebb6e62145c8f284fd38a75398632c8b014ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c6010c9cf8b98a84cbb33887cbbbb245bbafeec", "url": "https://github.com/openhab/openhab-addons/commit/4c6010c9cf8b98a84cbb33887cbbbb245bbafeec", "message": "Move all classes into internal package\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:43Z", "type": "commit"}, {"oid": "cb034494f261d764d1a3e573df6f414fc556f9c8", "url": "https://github.com/openhab/openhab-addons/commit/cb034494f261d764d1a3e573df6f414fc556f9c8", "message": "Tweak logging\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:51Z", "type": "commit"}, {"oid": "da8b42acbcfcbbbc8dbac8ecfa9b81cc7e5912f4", "url": "https://github.com/openhab/openhab-addons/commit/da8b42acbcfcbbbc8dbac8ecfa9b81cc7e5912f4", "message": "Remove unused class\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:51Z", "type": "commit"}, {"oid": "57181e6c7a1e0dcf082132e59f48c894c3b6ee3e", "url": "https://github.com/openhab/openhab-addons/commit/57181e6c7a1e0dcf082132e59f48c894c3b6ee3e", "message": "Style fixes\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:52Z", "type": "commit"}, {"oid": "4163ed43d1b13436d250f3d91fb0ee85f8e804a5", "url": "https://github.com/openhab/openhab-addons/commit/4163ed43d1b13436d250f3d91fb0ee85f8e804a5", "message": "Do not refresh device state too often\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:52Z", "type": "commit"}, {"oid": "e745ae048506b4d6804a698a0fe8dd4158011cf7", "url": "https://github.com/openhab/openhab-addons/commit/e745ae048506b4d6804a698a0fe8dd4158011cf7", "message": "Allow serial receive timeout to trigger\n\nWhen a receive timeout is configured, a read() on the serial input\nwill return -1 if the timeout elapses with no data available. We\nshould not treat this as EOF. Also, by waking up the serial thread\nevery 100ms, we can shut it down gracefully.\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:52Z", "type": "commit"}, {"oid": "9ab702da2baf30c9630d2f71ff9adbde54a0b8e5", "url": "https://github.com/openhab/openhab-addons/commit/9ab702da2baf30c9630d2f71ff9adbde54a0b8e5", "message": "Remove serial thread CPU load hack\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:53Z", "type": "commit"}, {"oid": "777cf0e5211f00c539ffc9c808fe96100946227b", "url": "https://github.com/openhab/openhab-addons/commit/777cf0e5211f00c539ffc9c808fe96100946227b", "message": "Use the system.brightness channel type\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:53Z", "type": "commit"}, {"oid": "1758de8120976058e0a2a5140b53133f89cccb80", "url": "https://github.com/openhab/openhab-addons/commit/1758de8120976058e0a2a5140b53133f89cccb80", "message": "Ensure only known thing types are handled\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:53Z", "type": "commit"}, {"oid": "1758de8120976058e0a2a5140b53133f89cccb80", "url": "https://github.com/openhab/openhab-addons/commit/1758de8120976058e0a2a5140b53133f89cccb80", "message": "Ensure only known thing types are handled\n\nSigned-off-by: Marcus Better <marcus@better.se>", "committedDate": "2020-09-18T00:09:53Z", "type": "forcePushed"}]}