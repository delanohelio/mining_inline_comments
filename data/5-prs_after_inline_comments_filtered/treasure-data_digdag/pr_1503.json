{"pr_number": 1503, "pr_title": "Set target_session_id and target_attempt_id when require op is called", "pr_createdAt": "2020-12-16T05:38:26Z", "pr_url": "https://github.com/treasure-data/digdag/pull/1503", "timeline": [{"oid": "fcccedc7d54870d857916e775e3e2452ea99d737", "url": "https://github.com/treasure-data/digdag/commit/fcccedc7d54870d857916e775e3e2452ea99d737", "message": "Set target_session_id and target_attempt_id when require op kicks a new attempt", "committedDate": "2020-12-22T02:50:01Z", "type": "commit"}, {"oid": "e16e7bd336599308c27dd5606eb89bd90eea1349", "url": "https://github.com/treasure-data/digdag/commit/e16e7bd336599308c27dd5606eb89bd90eea1349", "message": "Set target_session_id and target_attempt_id when require op waits for an attempt", "committedDate": "2020-12-22T02:50:01Z", "type": "forcePushed"}, {"oid": "6a9836631335ccf2387577fbe9eaae7b68740148", "url": "https://github.com/treasure-data/digdag/commit/6a9836631335ccf2387577fbe9eaae7b68740148", "message": "Set target_session_id and target_attempt_id when require op waits for an attempt", "committedDate": "2020-12-22T02:51:13Z", "type": "commit"}, {"oid": "6a9836631335ccf2387577fbe9eaae7b68740148", "url": "https://github.com/treasure-data/digdag/commit/6a9836631335ccf2387577fbe9eaae7b68740148", "message": "Set target_session_id and target_attempt_id when require op waits for an attempt", "committedDate": "2020-12-22T02:51:13Z", "type": "forcePushed"}, {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "url": "https://github.com/treasure-data/digdag/commit/e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "message": "Add tests for StateParams of require task", "committedDate": "2020-12-23T05:02:03Z", "type": "commit"}, {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "url": "https://github.com/treasure-data/digdag/commit/e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "message": "Add tests for StateParams of require task", "committedDate": "2020-12-23T05:02:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNTk4OA==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547725988", "bodyText": "May be attemptId.toString() or attemptId.get() is enough ?", "author": "yoyama", "createdAt": "2020-12-23T06:55:08Z", "path": "digdag-tests/src/test/java/acceptance/RequireIT.java", "diffHunk": "@@ -115,6 +118,27 @@ public void testRequire()\n \n         // Verify that the file created by the child workflow is there\n         assertThat(Files.exists(childOutFile), is(true));\n+\n+        CommandStatus attemptTasks = main(\"tasks\",\n+                \"-c\", config.toString(),\n+                \"-e\", server.endpoint(),\n+                String.valueOf(attemptId));", "originalCommit": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2NTEzOA==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547765138", "bodyText": "Agreed. This code follows the existing style.\n\n  \n    \n      digdag/digdag-tests/src/test/java/acceptance/RequireIT.java\n    \n    \n         Line 107\n      in\n      c978727\n    \n    \n    \n    \n\n        \n          \n           String.valueOf(attemptId)); \n        \n    \n  \n\n\nI'm going to fix my code.", "author": "hkdnet", "createdAt": "2020-12-23T07:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNTk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc3MzkwMg==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547773902", "bodyText": "Updated hkdnet@19de2e1", "author": "hkdnet", "createdAt": "2020-12-23T07:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNTk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNjI2MQ==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547726261", "bodyText": "ditto", "author": "yoyama", "createdAt": "2020-12-23T06:55:23Z", "path": "digdag-tests/src/test/java/acceptance/RequireIT.java", "diffHunk": "@@ -115,6 +118,27 @@ public void testRequire()\n \n         // Verify that the file created by the child workflow is there\n         assertThat(Files.exists(childOutFile), is(true));\n+\n+        CommandStatus attemptTasks = main(\"tasks\",\n+                \"-c\", config.toString(),\n+                \"-e\", server.endpoint(),\n+                String.valueOf(attemptId));\n+\n+        List<Config> stateParams = getStateParams(attemptTasks);\n+\n+        // It has 2 tasks, +parent and +parent+require.\n+        assertThat(stateParams.size(), is(2));\n+        Config requireOperatorStateParams = stateParams.get(1);\n+\n+        Id targetAttemptId = requireOperatorStateParams.get(\"target_attempt_id\", Id.class);\n+        CommandStatus targetAttemptStatus = main(\"attempts\",\n+                \"-c\", config.toString(),\n+                \"-e\", server.endpoint(),\n+                String.valueOf(targetAttemptId));", "originalCommit": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzczNjUxNQ==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547736515", "bodyText": "Increase the maximum wait to 60 may be better. We sometimes faces timeout because of CI performance.", "author": "yoyama", "createdAt": "2020-12-23T07:08:08Z", "path": "digdag-tests/src/test/java/acceptance/RequireIT.java", "diffHunk": "@@ -425,4 +449,85 @@ private void prepareForChildWF(Path childOutFile)\n             Files.write(projectDir.resolve(\"child.dig\"), child.getBytes(\"UTF-8\"));\n         }\n     }\n+\n+    @Test\n+    public void testRequireHasTargetSessionIdEvenWhenJustWaiting()\n+            throws Exception\n+    {\n+        // Create new project\n+        CommandStatus initStatus = main(\"init\",\n+                \"-c\", config.toString(),\n+                projectDir.toString());\n+        assertThat(initStatus.errUtf8(), initStatus.code(), is(0));\n+\n+        Path childOutFile = projectDir.resolve(\"child.out\").toAbsolutePath().normalize();\n+        prepareForChildWF(childOutFile);\n+        copyResource(\"acceptance/require/parent.dig\", projectDir.resolve(\"parent.dig\"));\n+\n+        // Push the project\n+        CommandStatus pushStatus = main(\"push\",\n+                \"--project\", projectDir.toString(),\n+                \"require\",\n+                \"-c\", config.toString(),\n+                \"-e\", server.endpoint(),\n+                \"-r\", \"4711\");\n+        assertThat(pushStatus.errUtf8(), pushStatus.code(), is(0));\n+\n+        // Start the child workflow first.\n+        String session = \"2016-01-01\";\n+\n+        Id targetAttemptId;\n+        Id targetSessionId;\n+        {\n+            CommandStatus startStatus = main(\"start\",\n+                    \"-c\", config.toString(),\n+                    \"-e\", server.endpoint(),\n+                    \"require\", \"child\",\n+                    \"--session\", session);\n+            assertThat(startStatus.code(), is(0));\n+            targetAttemptId = getAttemptId(startStatus);\n+            targetSessionId = getSessionId(startStatus);\n+        }\n+\n+        // Start the workflow\n+        Id attemptId;\n+        {\n+            CommandStatus startStatus = main(\"start\",\n+                    \"-c\", config.toString(),\n+                    \"-e\", server.endpoint(),\n+                    \"require\", \"parent\",\n+                    \"--session\", session);\n+            assertThat(startStatus.code(), is(0));\n+            attemptId = getAttemptId(startStatus);\n+        }\n+\n+        // Wait for the attempt to complete\n+        boolean success = false;\n+        for (int i = 0; i < 30; i++) {", "originalCommit": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc3MzEwNg==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547773106", "bodyText": "Thanks. Updated the limits. hkdnet@f00f700", "author": "hkdnet", "createdAt": "2020-12-23T07:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzczNjUxNQ=="}], "type": "inlineReview"}, {"oid": "f00f7002c6049bb42f6cac2a64dfec59a0f4665d", "url": "https://github.com/treasure-data/digdag/commit/f00f7002c6049bb42f6cac2a64dfec59a0f4665d", "message": "Update timeout value to make CI stable", "committedDate": "2020-12-23T07:48:06Z", "type": "commit"}, {"oid": "19de2e155de25ddd34f1e45e75c40457567bac36", "url": "https://github.com/treasure-data/digdag/commit/19de2e155de25ddd34f1e45e75c40457567bac36", "message": "Simplify Id to String conversion", "committedDate": "2020-12-23T07:51:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgwMDM3OQ==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547800379", "bodyText": "I guess the purpose of this test is that we can get correct session_id and attempt_id when the session of the child already exists and require> will not kick by itself. So change the test name may be better.\nIn addition, this implementation does not assure parent will wait for child or not. Because the child workflow is very short and it is not certain whether the status of child is running or stopped when the parent session starts.\nSo 'waiting' is not correct in my understand.", "author": "yoyama", "createdAt": "2020-12-23T08:27:24Z", "path": "digdag-tests/src/test/java/acceptance/RequireIT.java", "diffHunk": "@@ -425,4 +449,85 @@ private void prepareForChildWF(Path childOutFile)\n             Files.write(projectDir.resolve(\"child.dig\"), child.getBytes(\"UTF-8\"));\n         }\n     }\n+\n+    @Test\n+    public void testRequireHasTargetSessionIdEvenWhenJustWaiting()", "originalCommit": "19de2e155de25ddd34f1e45e75c40457567bac36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc3NDc5Mw==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r548774793", "bodyText": "I guess the purpose of this test is that we can get correct session_id and attempt_id when the session of the child already exists and require> will not kick by itself\n\nYes \ud83d\udc4d\n\n'waiting' is not correct in my understand\n\nI misunderstood the behavior, sorry. The parent doesn't wait for the child unless the parent actually kicks the child.\nI will rename the test name and delete assertions that are based on the assumption the child finished successfully.", "author": "hkdnet", "createdAt": "2020-12-25T01:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgwMDM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc3NzU4Nw==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r548777587", "bodyText": "Sorry, I misread your comment... \ud83d\ude48\nThe parent always waits for the child. It's independent of whether the parent kicks the child or not.\nWill just rename the test case.", "author": "hkdnet", "createdAt": "2020-12-25T01:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgwMDM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc4MTgzMw==", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r548781833", "bodyText": "done: hkdnet@1a136ba", "author": "hkdnet", "createdAt": "2020-12-25T02:28:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgwMDM3OQ=="}], "type": "inlineReview"}, {"oid": "1a136ba7c377fb64bbfd57333cda7216aa287894", "url": "https://github.com/treasure-data/digdag/commit/1a136ba7c377fb64bbfd57333cda7216aa287894", "message": "Rename a test case\n\nbecause if the child finishes earlier than the require operation,\nthe parent doesn't wait for the child's completion.", "committedDate": "2020-12-25T01:59:12Z", "type": "commit"}]}