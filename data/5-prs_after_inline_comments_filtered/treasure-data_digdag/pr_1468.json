{"pr_number": 1468, "pr_title": "Fix a bug that failed tasks with java.lang.Error retry infinitely", "pr_createdAt": "2020-10-20T12:08:31Z", "pr_url": "https://github.com/treasure-data/digdag/pull/1468", "timeline": [{"oid": "8baa1e7db395d3a2d441ef1243c1f1da644f3c35", "url": "https://github.com/treasure-data/digdag/commit/8baa1e7db395d3a2d441ef1243c1f1da644f3c35", "message": "Cancel failed task if it's requested to be canceled", "committedDate": "2020-10-20T07:51:06Z", "type": "commit"}, {"oid": "61fc8c2f84201ee11803bd658e36783b5b3772f7", "url": "https://github.com/treasure-data/digdag/commit/61fc8c2f84201ee11803bd658e36783b5b3772f7", "message": "Fix broken test", "committedDate": "2020-10-21T05:24:45Z", "type": "commit"}, {"oid": "4bd0cb44e515fc587b91593c3384a9b265500f6f", "url": "https://github.com/treasure-data/digdag/commit/4bd0cb44e515fc587b91593c3384a9b265500f6f", "message": "Adding test cases for OperatorManager#runWithHeartbeat", "committedDate": "2020-10-21T07:58:20Z", "type": "commit"}, {"oid": "99141dc3b30be7b47a5d0081529aaddbcc525aa4", "url": "https://github.com/treasure-data/digdag/commit/99141dc3b30be7b47a5d0081529aaddbcc525aa4", "message": "Add error test case to OperatorManagerTest", "committedDate": "2020-10-21T09:01:28Z", "type": "commit"}, {"oid": "a8dbd5a59afd8f4748e38dc9620e2f47fc714548", "url": "https://github.com/treasure-data/digdag/commit/a8dbd5a59afd8f4748e38dc9620e2f47fc714548", "message": "Add a test", "committedDate": "2020-10-21T10:04:30Z", "type": "commit"}, {"oid": "f0aeb560f9fcd5e16594f1266c7e7dfe2e165272", "url": "https://github.com/treasure-data/digdag/commit/f0aeb560f9fcd5e16594f1266c7e7dfe2e165272", "message": "Add some test cases in OperatorManagerTest", "committedDate": "2020-10-21T11:20:40Z", "type": "commit"}, {"oid": "49e8345c9224935dda94e4a808ad3cbada528f59", "url": "https://github.com/treasure-data/digdag/commit/49e8345c9224935dda94e4a808ad3cbada528f59", "message": "Refactor import statement", "committedDate": "2020-10-21T11:28:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU2NjYyNw==", "url": "https://github.com/treasure-data/digdag/pull/1468#discussion_r510566627", "bodyText": "In this implementation, only when cancel is requested, task will finish with failure.\nIf canceling request is not set to the task, the task will continue to run with failure until TTL.\nIs my understanding correct ? If so, is there any reason to wait for TTL ?", "author": "yoyama", "createdAt": "2020-10-23T02:58:21Z", "path": "digdag-core/src/main/java/io/digdag/core/agent/OperatorManager.java", "diffHunk": "@@ -177,6 +177,19 @@ protected void runWithHeartbeat(TaskRequest request)\n                     }\n                     callback.taskFailed(request, agentId, buildExceptionErrorConfig(ex).toConfig(cf));  // no retry\n                 }\n+                catch (Throwable ex) {\n+                    logger.error(\n+                            LogMarkers.UNEXPECTED_SERVER_ERROR,\n+                            \"Task failed with unexpected error: {}\", ex.getMessage(), ex);\n+\n+                    // This block catches OutOfMemoryError and its cause can be either deterministic or non-deterministic.\n+                    // So, OperatorManager can't always cancel the failed task.\n+                    if (request.isCancelRequested()) {", "originalCommit": "49e8345c9224935dda94e4a808ad3cbada528f59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY1NzI1MA==", "url": "https://github.com/treasure-data/digdag/pull/1468#discussion_r510657250", "bodyText": "This catch block can handle non-deterministic retryable error like OutOfMemoryError caused by temporary lack of overall JVM heap not only deterministic error like OOM caused by instantiation of too huge String. So we can't decide to cancel the failed task immediately. But if the failed task has been already running more than 24 hours, we can cancel it without any concern.", "author": "komamitsu", "createdAt": "2020-10-23T06:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU2NjYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MDYwMQ==", "url": "https://github.com/treasure-data/digdag/pull/1468#discussion_r510660601", "bodyText": "Make sense.  \ud83d\udc4d", "author": "yoyama", "createdAt": "2020-10-23T06:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU2NjYyNw=="}], "type": "inlineReview"}]}