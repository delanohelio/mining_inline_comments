{"pr_number": 995, "pr_title": "update DB version when a client applies template", "pr_createdAt": "2020-05-28T22:13:59Z", "pr_url": "https://github.com/AthenZ/athenz/pull/995", "timeline": [{"oid": "b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf", "url": "https://github.com/AthenZ/athenz/commit/b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf", "message": "update DB version when a client applies template", "committedDate": "2020-05-28T22:11:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg5MTM0NA==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r432891344", "bodyText": "this implementation doesn't look correct to me. we're setting a templateMetaList object which contains only a single templateMeta which only has a version number. where are the rest of the templates or where are the template names we're storing?", "author": "havetisyan", "createdAt": "2020-05-30T22:13:46Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,29 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {", "originalCommit": "b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwNDU2MQ==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433504561", "bodyText": "done.", "author": "jothi-prasad", "createdAt": "2020-06-01T21:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg5MTM0NA=="}], "type": "inlineReview"}, {"oid": "a356edf817c89fe75306e71c7e682554f5e331e0", "url": "https://github.com/AthenZ/athenz/commit/a356edf817c89fe75306e71c7e682554f5e331e0", "message": "updating additional templatemetadata details in file connection", "committedDate": "2020-06-01T21:36:48Z", "type": "commit"}, {"oid": "5e41bc86a691875c6c7eb27d20c44ffc8f66341c", "url": "https://github.com/AthenZ/athenz/commit/5e41bc86a691875c6c7eb27d20c44ffc8f66341c", "message": "removing unused import from test", "committedDate": "2020-06-01T21:40:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMDg1NQ==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433530855", "bodyText": "we're creating the template meta list every time this api is called and replacing the struct in domain struct. which means it will only have a single template and will be overwritten every time. The implementation needs to be:\nif (domainStruct.getTemplateMeta() == null) {\ndomainStruct.setTemplateMeta(new ArrayList<>());\n}\nArrayList templateMetalist = domainStruct.getTemplateMeta();\n// then iterate through the list and see if we have an object\n// with that template. If yes, update the version only,\n// if not then create a new object and add it to the list", "author": "havetisyan", "createdAt": "2020-06-01T22:52:50Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,34 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+        TemplateMetaData templateMeta = new TemplateMetaData();\n+        templateMeta.setTemplateName(templateName);\n+        templateMeta.setKeywordsToReplace(templateMetaData.getKeywordsToReplace());\n+        templateMeta.setAutoUpdate(templateMetaData.getAutoUpdate());\n+        templateMeta.setDescription(templateMetaData.getDescription());\n+        templateMeta.setTimestamp(templateMetaData.getTimestamp());\n+        templateMeta.setCurrentVersion(templateMetaData.getLatestVersion());\n+        templateMetalist.add(templateMeta);\n+        domainStruct.setTemplateMeta(templateMetalist);", "originalCommit": "5e41bc86a691875c6c7eb27d20c44ffc8f66341c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b", "url": "https://github.com/AthenZ/athenz/commit/867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b", "message": "addressing review comments - change in file connection to handle update version", "committedDate": "2020-06-02T03:19:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDA3NA==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433680074", "bodyText": "we're missing the handling of the when when templateMetaList is not empty but it doesn't contain the templateName we're updating. In that case, we also need to add a new object.", "author": "havetisyan", "createdAt": "2020-06-02T07:40:26Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,47 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {", "originalCommit": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyMTA4OA==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434121088", "bodyText": "Done.", "author": "jothi-prasad", "createdAt": "2020-06-02T19:19:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDM0OA==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433680348", "bodyText": "these lines 436-439  are not necessary since the domain object only needs to contain the name of the template and the latest version and no other detail.", "author": "havetisyan", "createdAt": "2020-06-02T07:40:54Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,47 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {\n+                if (meta.getTemplateName().equals(templateName)) {\n+                    meta.setCurrentVersion(templateMetaData.getLatestVersion());\n+                }\n+            }\n+        } else {\n+            TemplateMetaData templateMeta = new TemplateMetaData();\n+            templateMeta.setTemplateName(templateName);\n+            templateMeta.setKeywordsToReplace(templateMetaData.getKeywordsToReplace());\n+            templateMeta.setAutoUpdate(templateMetaData.getAutoUpdate());\n+            templateMeta.setDescription(templateMetaData.getDescription());\n+            templateMeta.setTimestamp(templateMetaData.getTimestamp());", "originalCommit": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyMTAwOA==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434121008", "bodyText": "Done.", "author": "jothi-prasad", "createdAt": "2020-06-02T19:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDM0OA=="}], "type": "inlineReview"}, {"oid": "a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2", "url": "https://github.com/AthenZ/athenz/commit/a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2", "message": "file connection implementation changes", "committedDate": "2020-06-02T19:18:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NjYxMQ==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434176611", "bodyText": "this is not still correct since if you have 2 template in your list, when comparing the first element, you're just overriding the full list.\n#1000\nI created a new PR based on your PR. Remove the setTemplateNameAndVersion method from your PR and use the implementation of updateDomainTemplate method from that PR.", "author": "havetisyan", "createdAt": "2020-06-02T21:08:55Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,41 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {\n+                if (meta.getTemplateName().equals(templateName)) {\n+                    meta.setCurrentVersion(templateMetaData.getLatestVersion());\n+                } else {", "originalCommit": "a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwMTM4OA==", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434201388", "bodyText": "Done.", "author": "jothi-prasad", "createdAt": "2020-06-02T22:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NjYxMQ=="}], "type": "inlineReview"}, {"oid": "a358e40fb058e1506cc8287a880d0ff7a6f38c79", "url": "https://github.com/AthenZ/athenz/commit/a358e40fb058e1506cc8287a880d0ff7a6f38c79", "message": "changes to file implementation based on review comments", "committedDate": "2020-06-02T22:03:00Z", "type": "commit"}]}