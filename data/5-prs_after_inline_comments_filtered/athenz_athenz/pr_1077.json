{"pr_number": 1077, "pr_title": "Changes in Metrics API", "pr_createdAt": "2020-08-06T16:44:08Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1077", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU0NjgzOQ==", "url": "https://github.com/AthenZ/athenz/pull/1077#discussion_r466546839", "bodyText": "Getting the principal domain will require me to start the timer after the principal is authenticated (so not when creating the context).\nFor now, I've decided to leave this out along with the request domain.\nThis will only affect implementers that get the tags at the start of the timer (we send all arguments when stopping the timer)", "author": "OferLevi85", "createdAt": "2020-08-06T16:47:26Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -7231,8 +7231,10 @@ void logPrincipal(ResourceContext ctx) {\n     }\n \n     public ResourceContext newResourceContext(HttpServletRequest request,\n-                                              HttpServletResponse response) {\n-        Object timerMetric = metric.startTiming(\"zms_api_latency\", null);\n+                                              HttpServletResponse response,\n+                                              String httpMethod,\n+                                              String apiName) {\n+        Object timerMetric = metric.startTiming(\"zms_api_latency\", null, null, httpMethod, apiName);", "originalCommit": "765f28daa8d530ed4113f9c8c7592da33de392c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4a1df80e8f420f0a8bd9aaf075f2dd1aa8899d92", "url": "https://github.com/AthenZ/athenz/commit/4a1df80e8f420f0a8bd9aaf075f2dd1aa8899d92", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context", "committedDate": "2020-08-09T12:01:15Z", "type": "forcePushed"}, {"oid": "afcd1d6a577a7354735ece04c3b155601beb28dd", "url": "https://github.com/AthenZ/athenz/commit/afcd1d6a577a7354735ece04c3b155601beb28dd", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context", "committedDate": "2020-08-09T12:27:01Z", "type": "forcePushed"}, {"oid": "f56887c9e3402f5fe37c4d0b2df2b51f2c54347f", "url": "https://github.com/AthenZ/athenz/commit/f56887c9e3402f5fe37c4d0b2df2b51f2c54347f", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context", "committedDate": "2020-08-09T12:31:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU3OTMyNA==", "url": "https://github.com/AthenZ/athenz/pull/1077#discussion_r467579324", "bodyText": "Please note that I have changed the caller from \"getaccessext\" to \"getresourceaccessext\". Unlike the call in ZMS, putServiceIdentitySystemMeta, there is no call to verifyAuthorizedServiceOperation so this should affect anything.", "author": "OferLevi85", "createdAt": "2020-08-09T12:43:54Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -3643,8 +3643,8 @@ Principal createPrincipalForName(String principalName) {\n     @Override\n     public ResourceAccess getResourceAccessExt(ResourceContext ctx, String action, String resource,\n             String trustDomain, String checkPrincipal) {\n-        \n-        final String caller = \"getaccessext\";\n+\n+        final String caller = ctx.getApiName();", "originalCommit": "f56887c9e3402f5fe37c4d0b2df2b51f2c54347f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "18fa18108864ce6f286c7acbb33080c19af16c6a", "url": "https://github.com/AthenZ/athenz/commit/18fa18108864ce6f286c7acbb33080c19af16c6a", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context", "committedDate": "2020-08-09T12:44:26Z", "type": "commit"}, {"oid": "18fa18108864ce6f286c7acbb33080c19af16c6a", "url": "https://github.com/AthenZ/athenz/commit/18fa18108864ce6f286c7acbb33080c19af16c6a", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context", "committedDate": "2020-08-09T12:44:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU3OTc4Ng==", "url": "https://github.com/AthenZ/athenz/pull/1077#discussion_r467579786", "bodyText": "Unlike the other methods, I didn't change the caller as the name of the method \"putServiceIdentitySystemMeta\" is different than the caller \"putservicesystemmeta\". Changing this will break the call to verifyAuthorizedServiceOperation as it appears differently in authorized_services.json file", "author": "OferLevi85", "createdAt": "2020-08-09T12:48:20Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -4552,7 +4552,7 @@ public void putServiceIdentitySystemMeta(ResourceContext ctx, String domainName,\n         verifyAuthorizedServiceOperation(principal.getAuthorizedService(), caller);\n ", "originalCommit": "18fa18108864ce6f286c7acbb33080c19af16c6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}