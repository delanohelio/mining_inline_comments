{"pr_number": 972, "pr_title": "Template api implementation to expose metadata details", "pr_createdAt": "2020-05-08T02:10:11Z", "pr_url": "https://github.com/AthenZ/athenz/pull/972", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI1OTk5Mg==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422259992", "bodyText": "these should be created after the validation of data otherwise we're just wasting resources if the request is invalid", "author": "havetisyan", "createdAt": "2020-05-08T17:06:33Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2603,6 +2603,55 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = new DomainTemplateDetailsList();\n+        List<TemplateMetaData> templateMetaDataList = new ArrayList<>();\n+        Map<String, Integer> templateDomainMapping = new HashMap<>();", "originalCommit": "3c00cfffa3691dce18541bac7d41aec5b0dc242e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxMDY2OA==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422410668", "bodyText": "Done.", "author": "jothi-prasad", "createdAt": "2020-05-08T22:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI1OTk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2MTM5MQ==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422261391", "bodyText": "what are the possible cases for exception and why are hiding them?\notherwise it looks like if there is some type of exception we're going to return an empty list to the client which is not correct.\nso unless we're absolutely sure we want to swallow the exception, we shouldn't catch it and let an error be returned to the client", "author": "havetisyan", "createdAt": "2020-05-08T17:09:27Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2603,6 +2603,55 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = new DomainTemplateDetailsList();\n+        List<TemplateMetaData> templateMetaDataList = new ArrayList<>();\n+        Map<String, Integer> templateDomainMapping = new HashMap<>();\n+        final String caller = \"getDomainTemplateDetailsList\";\n+        metric.increment(ZMSConsts.HTTP_GET);\n+        metric.increment(ZMSConsts.HTTP_REQUEST);\n+        metric.increment(caller);\n+        logPrincipal(ctx);\n+        validateRequest(ctx.request(), caller);\n+        validate(domainName, TYPE_DOMAIN_NAME, caller);\n+\n+        // for consistent handling of all requests, we're going to convert\n+        // all domain into lower case\n+\n+        domainName = domainName.toLowerCase();\n+        final String principalDomain = getPrincipalDomain(ctx);\n+        Object timerMetric = metric.startTiming(\"getdomainrolemembers_timing\", domainName, principalDomain);\n+\n+        templateDomainMapping = dbService.getDomainTemplates(domainName);\n+        if (templateDomainMapping != null) {\n+            try {\n+                for (String templateName : templateDomainMapping.keySet()) {\n+                    TemplateMetaData metaData = new TemplateMetaData();\n+                    Template template = serverSolutionTemplates.get(templateName);\n+                    // there is a possibility of a stale template coming back from DB over time(caused by template clean up)\n+                    if (template != null) {\n+                        //Merging template metadata fields from solution-templates.json and template data from DB\n+                        metaData.setTemplateName(templateName);\n+                        metaData.setCurrentVersion(templateDomainMapping.get(templateName));\n+                        metaData.setLatestVersion(template.getMetadata().getLatestVersion());\n+                        metaData.setAutoUpdate(template.getMetadata().getAutoUpdate());\n+                        metaData.setDescription(template.getMetadata().getDescription());\n+                        metaData.setKeywordsToReplace(template.metadata.getKeywordsToReplace());\n+                        metaData.setTimestamp(template.metadata.getTimestamp());\n+                        templateMetaDataList.add(metaData);\n+                    }\n+                }\n+                domainTemplateDetailsList.setMetaData(templateMetaDataList);\n+            } catch (Exception ex) {", "originalCommit": "3c00cfffa3691dce18541bac7d41aec5b0dc242e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM0NDk0Mw==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422344943", "bodyText": "there is absolutely no situation where this code will throw an exception that needs to be handled because it is mostly local object sets and list/map functions. even if it is throwing an error it should be thrown back to the client YES!. i added it while simulating a test scenario in dev box and did not remove. i will take care of this", "author": "jothi-prasad", "createdAt": "2020-05-08T20:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2MTM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxMDc5OA==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422410798", "bodyText": "Checked in updated changes", "author": "jothi-prasad", "createdAt": "2020-05-08T22:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2MTM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2NDUwNw==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422264507", "bodyText": "Not sure why we're returning Map<String, Integer> here. if we add additional attributes, then this is not going to work thus is going to be changed again.\nLooking at the server side, it looks like we're taking this Map<String, Integer> and then we generate List by filling the rest of the fields in the template meta objects. So why not just return here. the api should be:\nList getDomainTemplates(String domainName);\nthen you just need fill in the other fields before returning to the client. in the future, if we need to add additional attributes, it would just require updating the TemplateMetaData object and not the api itself", "author": "havetisyan", "createdAt": "2020-05-08T17:16:00Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/ObjectStoreConnection.java", "diffHunk": "@@ -146,4 +146,6 @@\n     boolean updateRoleMemberReviewNotificationTimestamp(String server, long timestamp);\n \n     DomainRoleMembers listOverdueReviewRoleMembers(String domainName);\n+\n+    Map<String, Integer> getDomainTemplates(String domainName);", "originalCommit": "3c00cfffa3691dce18541bac7d41aec5b0dc242e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxMDk3OQ==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422410979", "bodyText": "replaced Map with List object", "author": "jothi-prasad", "createdAt": "2020-05-08T22:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2NDUwNw=="}], "type": "inlineReview"}, {"oid": "61796270a76a15e175e801177737510ff87e076f", "url": "https://github.com/AthenZ/athenz/commit/61796270a76a15e175e801177737510ff87e076f", "message": "api implementation to expose template metadata details", "committedDate": "2020-05-12T03:26:00Z", "type": "commit"}, {"oid": "61796270a76a15e175e801177737510ff87e076f", "url": "https://github.com/AthenZ/athenz/commit/61796270a76a15e175e801177737510ff87e076f", "message": "api implementation to expose template metadata details", "committedDate": "2020-05-12T03:26:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MTU5Mg==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r423841592", "bodyText": "there is no need to create this list again. we already have a list returned from dbservice. we should just add attributes and set that and return as part of our data. This way we're not just creating another set of objects which contains the same data as the original list. So just go through the list that we got on line 2629, update the objects and then on line 2650 we use that to set the meta data.\nif we come across an entry that has not value then we should send it back since that shows something not right in the db - where we have a template that no longer exists in the server.", "author": "havetisyan", "createdAt": "2020-05-12T15:48:16Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2607,6 +2607,53 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = null;\n+        List<TemplateMetaData> templateMetaDataList;\n+        final String caller = \"getDomainTemplateDetailsList\";\n+        metric.increment(ZMSConsts.HTTP_GET);\n+        metric.increment(ZMSConsts.HTTP_REQUEST);\n+        metric.increment(caller);\n+        logPrincipal(ctx);\n+        validateRequest(ctx.request(), caller);\n+        validate(domainName, TYPE_DOMAIN_NAME, caller);\n+\n+        // for consistent handling of all requests, we're going to convert\n+        // all domain into lower case\n+\n+        domainName = domainName.toLowerCase();\n+        final String principalDomain = getPrincipalDomain(ctx);\n+        Object timerMetric = metric.startTiming(\"getdomainrolemembers_timing\", domainName, principalDomain);\n+\n+        List<TemplateMetaData> templateDomainMapping = dbService.getDomainTemplates(domainName);\n+        if (templateDomainMapping != null) {\n+            domainTemplateDetailsList = new DomainTemplateDetailsList();\n+            templateMetaDataList = new ArrayList<>();", "originalCommit": "61796270a76a15e175e801177737510ff87e076f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxMTgyMg==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r424211822", "bodyText": "Done. reused the same object that comes back from DBservice. tested it in dev too.", "author": "jothi-prasad", "createdAt": "2020-05-13T06:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MTU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MTc0Mg==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r423841742", "bodyText": "this one is not needed, please see my comment below.", "author": "havetisyan", "createdAt": "2020-05-12T15:48:29Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2607,6 +2607,53 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = null;\n+        List<TemplateMetaData> templateMetaDataList;", "originalCommit": "61796270a76a15e175e801177737510ff87e076f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxMTkyNQ==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r424211925", "bodyText": "done.", "author": "jothi-prasad", "createdAt": "2020-05-13T06:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MTc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MjUwNw==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r423842507", "bodyText": "we should move this down before line 2630 to be consistent with all other methods in the class.", "author": "havetisyan", "createdAt": "2020-05-12T15:49:33Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2607,6 +2607,53 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = null;", "originalCommit": "61796270a76a15e175e801177737510ff87e076f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxMDcwNg==", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r424210706", "bodyText": "Make sense. Done.", "author": "jothi-prasad", "createdAt": "2020-05-13T06:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MjUwNw=="}], "type": "inlineReview"}, {"oid": "22d09af231c6e7dfd44ee83e2579488830308e1c", "url": "https://github.com/AthenZ/athenz/commit/22d09af231c6e7dfd44ee83e2579488830308e1c", "message": "addressing review comments", "committedDate": "2020-05-13T06:52:56Z", "type": "commit"}]}