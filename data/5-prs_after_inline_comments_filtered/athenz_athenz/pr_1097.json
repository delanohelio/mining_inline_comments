{"pr_number": 1097, "pr_title": "initial changes for group implementation", "pr_createdAt": "2020-08-27T22:57:35Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1097", "timeline": [{"oid": "a8b1e5f16ca9413b1fa1b95227aaf00e39fe4be4", "url": "https://github.com/AthenZ/athenz/commit/a8b1e5f16ca9413b1fa1b95227aaf00e39fe4be4", "message": "initial changes for group implementation", "committedDate": "2020-08-27T22:55:59Z", "type": "commit"}, {"oid": "2c32a7986e671d3a3e7c50bfce389b6a67816500", "url": "https://github.com/AthenZ/athenz/commit/2c32a7986e671d3a3e7c50bfce389b6a67816500", "message": "Merge branch 'master' into group", "committedDate": "2020-08-27T22:59:31Z", "type": "commit"}, {"oid": "3644ba0f58b84fc4d35ede8c74d0a34bdb80bba9", "url": "https://github.com/AthenZ/athenz/commit/3644ba0f58b84fc4d35ede8c74d0a34bdb80bba9", "message": "Update ZMSImplTest.java\n\nremove duplicated methods during conflict resolve", "committedDate": "2020-08-27T23:54:17Z", "type": "commit"}, {"oid": "0e4332925ee6c42f8e87e64908526d663f05b152", "url": "https://github.com/AthenZ/athenz/commit/0e4332925ee6c42f8e87e64908526d663f05b152", "message": "schema update file", "committedDate": "2020-08-28T01:58:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTczNzUyOQ==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479737529", "bodyText": "Please change the comment from  \"by default we're only going to handle audit enabled roles\" to \"by default we're only going to handle audit enabled roles and groups\"", "author": "OferLevi85", "createdAt": "2020-08-30T08:07:10Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -125,14 +126,17 @@ void setAuditRefObjectBits() {\n         // the value is a comma separated list of supported objects:", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc0MzA1Mg==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479743052", "bodyText": "// retrieve our original group", "author": "OferLevi85", "createdAt": "2020-08-30T09:01:21Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -934,6 +1026,63 @@ void executePutRole(ResourceContext ctx, String domainName, String roleName, Rol\n         }\n     }\n \n+    void executePutGroup(ResourceContext ctx, final String domainName, final String groupName, Group group, final String auditRef) {\n+\n+        // our exception handling code does the check for retry count\n+        // and throws the exception it had received when the retry\n+        // count reaches 0\n+\n+        for (int retryCount = defaultRetryCount; ; retryCount--) {\n+\n+            try (ObjectStoreConnection con = store.getConnection(false, true)) {\n+\n+                String principal = getPrincipalName(ctx);\n+\n+                // first verify that auditing requirements are met\n+\n+                checkDomainAuditEnabled(con, domainName, auditRef, ctx.getApiName(), principal, AUDIT_TYPE_GROUP);\n+\n+                // check that quota is not exceeded\n+\n+                quotaCheck.checkGroupQuota(con, domainName, group, ctx.getApiName());\n+\n+                // retrieve our original role", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc0MzM2MA==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479743360", "bodyText": "// update our group and domain time-stamps, and invalidate local cache entry", "author": "OferLevi85", "createdAt": "2020-08-30T09:03:59Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -1348,6 +1560,98 @@ void executeDeletePendingMembership(ResourceContext ctx, String domainName, Stri\n         }\n     }\n \n+    void executeDeleteGroupMembership(ResourceContext ctx, final String domainName, final String groupName,\n+                                      final String normalizedMember, final String auditRef) {\n+\n+        // our exception handling code does the check for retry count\n+        // and throws the exception it had received when the retry\n+        // count reaches 0\n+\n+        for (int retryCount = defaultRetryCount; ; retryCount--) {\n+\n+            try (ObjectStoreConnection con = store.getConnection(true, true)) {\n+\n+                String principal = getPrincipalName(ctx);\n+\n+                // first verify that auditing requirements are met\n+\n+                checkDomainAuditEnabled(con, domainName, auditRef, ctx.getApiName(), principal, AUDIT_TYPE_GROUP);\n+\n+                // process our delete group member operation\n+\n+                if (!con.deleteGroupMember(domainName, groupName, normalizedMember, principal, auditRef)) {\n+                    con.rollbackChanges();\n+                    throw ZMSUtils.notFoundError(\"unable to delete group member: \" +\n+                            normalizedMember + \" from group: \" + groupName, ctx.getApiName());\n+                }\n+\n+                // update our group and domain time-stamps, and invalidate local cache entry\n+\n+                con.updateGroupModTimestamp(domainName, groupName);\n+                con.updateDomainModTimestamp(domainName);\n+                cacheStore.invalidate(domainName);\n+\n+                // audit log the request\n+\n+                auditLogRequest(ctx, domainName, auditRef, ctx.getApiName(), ZMSConsts.HTTP_DELETE,\n+                        groupName, \"{\\\"member\\\": \\\"\" + normalizedMember + \"\\\"}\");\n+\n+                return;\n+\n+            } catch (ResourceException ex) {\n+                if (!shouldRetryOperation(ex, retryCount)) {\n+                    throw ex;\n+                }\n+            }\n+        }\n+    }\n+\n+    void executeDeletePendingGroupMembership(ResourceContext ctx, final String domainName, final String groupName,\n+                                             final String normalizedMember, final String auditRef) {\n+\n+        // our exception handling code does the check for retry count\n+        // and throws the exception it had received when the retry\n+        // count reaches 0\n+\n+        for (int retryCount = defaultRetryCount; ; retryCount--) {\n+\n+            try (ObjectStoreConnection con = store.getConnection(true, true)) {\n+\n+                String principal = getPrincipalName(ctx);\n+\n+                // first verify that auditing requirements are met\n+\n+                checkDomainAuditEnabled(con, domainName, auditRef, ctx.getApiName(), principal, AUDIT_TYPE_GROUP);\n+\n+                // process our delete pending group member operation\n+\n+                if (!con.deletePendingGroupMember(domainName, groupName, normalizedMember, principal, auditRef)) {\n+                    con.rollbackChanges();\n+                    throw ZMSUtils.notFoundError(\"unable to delete pending group member: \" +\n+                            normalizedMember + \" from group: \" + groupName, ctx.getApiName());\n+                }\n+\n+                // update our role and domain time-stamps, and invalidate local cache entry", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc0NDYwMg==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479744602", "bodyText": "Please add unit test for this method (similar to updateServiceIdentitySystemMetaFields which has unit tests)\nI think that it will be preferable to make the caller an input argument.\nThis method is called only from executePutGroupSystemMeta so the \"caller\" is correct but if someone will reuse this method then he can accidentally leave this value as-is. This is also true for updateServiceIdentitySystemMetaFields", "author": "OferLevi85", "createdAt": "2020-08-30T09:15:52Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -2624,36 +3017,46 @@ void updateSystemMetaFields(Domain domain, final String attribute, boolean delet\n         }\n     }\n \n-    void updateRoleSystemMetaFields(Role role, final String attribute, boolean deleteAllowed, RoleSystemMeta meta) {\n+    void updateRoleSystemMetaFields(Role role, final String attribute, RoleSystemMeta meta) {\n \n         final String caller = \"putrolesystemmeta\";\n \n         // system attributes we'll only set if they're available\n         // in the given object\n \n-        switch (attribute) {\n-            case ZMSConsts.SYSTEM_META_AUDIT_ENABLED:\n-                role.setAuditEnabled(meta.getAuditEnabled());\n-                break;\n-            default:\n-                throw ZMSUtils.requestError(\"unknown role system meta attribute: \" + attribute, caller);\n+        if (ZMSConsts.SYSTEM_META_AUDIT_ENABLED.equals(attribute)) {\n+            role.setAuditEnabled(meta.getAuditEnabled());\n+        } else {\n+            throw ZMSUtils.requestError(\"unknown role system meta attribute: \" + attribute, caller);\n+        }\n+    }\n+\n+    void updateGroupSystemMetaFields(Group group, final String attribute, GroupSystemMeta meta) {\n+\n+        final String caller = \"putgroupsystemmeta\";", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc0NTcwMw==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479745703", "bodyText": "// copy of our group", "author": "OferLevi85", "createdAt": "2020-08-30T09:27:03Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -4206,6 +4722,96 @@ public void executePutRoleMeta(ResourceContext ctx, String domainName, String ro\n         }\n     }\n \n+    void updateGroupMetaFields(Group group, GroupMeta meta) {\n+\n+        // these two fields have default values so after validation\n+        // we'll never have nulls\n+\n+        group.setSelfServe(meta.getSelfServe());\n+        group.setReviewEnabled(meta.getReviewEnabled());\n+\n+        if (meta.getNotifyRoles() != null) {\n+            group.setNotifyRoles(meta.getNotifyRoles());\n+        }\n+        if (meta.getUserAuthorityFilter() != null) {\n+            group.setUserAuthorityFilter(meta.getUserAuthorityFilter());\n+        }\n+        if (meta.getUserAuthorityExpiration() != null) {\n+            group.setUserAuthorityExpiration(meta.getUserAuthorityExpiration());\n+        }\n+    }\n+\n+    public void executePutGroupMeta(ResourceContext ctx, final String domainName, final String groupName,\n+                                    GroupMeta meta, final String auditRef) {\n+\n+        // our exception handling code does the check for retry count\n+        // and throws the exception it had received when the retry\n+        // count reaches 0\n+\n+        for (int retryCount = defaultRetryCount; ; retryCount--) {\n+\n+            try (ObjectStoreConnection con = store.getConnection(false, true)) {\n+\n+                Group originalGroup = getGroup(con, domainName, groupName, false, false);\n+                if (originalGroup == null) {\n+                    con.rollbackChanges();\n+                    throw ZMSUtils.notFoundError(\"Unknown group: \" + groupName, ctx.getApiName());\n+                }\n+\n+                checkObjectAuditEnabled(con, originalGroup.getAuditEnabled(), originalGroup.getName(),\n+                        auditRef, ctx.getApiName(), getPrincipalName(ctx));\n+\n+                // now process the request. first we're going to make a\n+                // copy of our role", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc0NTc5Mw==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479745793", "bodyText": "if the role member => if the group member\n... members in the role => members in the group", "author": "OferLevi85", "createdAt": "2020-08-30T09:28:11Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -4206,6 +4722,96 @@ public void executePutRoleMeta(ResourceContext ctx, String domainName, String ro\n         }\n     }\n \n+    void updateGroupMetaFields(Group group, GroupMeta meta) {\n+\n+        // these two fields have default values so after validation\n+        // we'll never have nulls\n+\n+        group.setSelfServe(meta.getSelfServe());\n+        group.setReviewEnabled(meta.getReviewEnabled());\n+\n+        if (meta.getNotifyRoles() != null) {\n+            group.setNotifyRoles(meta.getNotifyRoles());\n+        }\n+        if (meta.getUserAuthorityFilter() != null) {\n+            group.setUserAuthorityFilter(meta.getUserAuthorityFilter());\n+        }\n+        if (meta.getUserAuthorityExpiration() != null) {\n+            group.setUserAuthorityExpiration(meta.getUserAuthorityExpiration());\n+        }\n+    }\n+\n+    public void executePutGroupMeta(ResourceContext ctx, final String domainName, final String groupName,\n+                                    GroupMeta meta, final String auditRef) {\n+\n+        // our exception handling code does the check for retry count\n+        // and throws the exception it had received when the retry\n+        // count reaches 0\n+\n+        for (int retryCount = defaultRetryCount; ; retryCount--) {\n+\n+            try (ObjectStoreConnection con = store.getConnection(false, true)) {\n+\n+                Group originalGroup = getGroup(con, domainName, groupName, false, false);\n+                if (originalGroup == null) {\n+                    con.rollbackChanges();\n+                    throw ZMSUtils.notFoundError(\"Unknown group: \" + groupName, ctx.getApiName());\n+                }\n+\n+                checkObjectAuditEnabled(con, originalGroup.getAuditEnabled(), originalGroup.getName(),\n+                        auditRef, ctx.getApiName(), getPrincipalName(ctx));\n+\n+                // now process the request. first we're going to make a\n+                // copy of our role\n+\n+                Group updatedGroup = new Group()\n+                        .setName(originalGroup.getName())\n+                        .setAuditEnabled(originalGroup.getAuditEnabled())\n+                        .setSelfServe(originalGroup.getSelfServe())\n+                        .setReviewEnabled(originalGroup.getReviewEnabled())\n+                        .setNotifyRoles(originalGroup.getNotifyRoles())\n+                        .setUserAuthorityFilter(originalGroup.getUserAuthorityFilter())\n+                        .setUserAuthorityExpiration(originalGroup.getUserAuthorityExpiration());\n+\n+                // then we're going to apply the updated fields\n+                // from the given object\n+\n+                updateGroupMetaFields(updatedGroup, meta);\n+\n+                con.updateGroup(domainName, updatedGroup);\n+                saveChanges(con, domainName);\n+\n+                // audit log the request\n+\n+                StringBuilder auditDetails = new StringBuilder(ZMSConsts.STRING_BLDR_SIZE_DEFAULT);\n+                auditLogGroupMeta(auditDetails, updatedGroup, groupName);\n+\n+                auditLogRequest(ctx, domainName, auditRef, ctx.getApiName(), ZMSConsts.HTTP_PUT,\n+                        domainName, auditDetails.toString());\n+\n+                // if the role member expiry date or review date has changed then we're going", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc0OTk0Ng==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479749946", "bodyText": "insert the role => insert the group", "author": "OferLevi85", "createdAt": "2020-08-30T10:09:41Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -570,6 +570,61 @@ boolean processRole(ObjectStoreConnection con, Role originalRole, String domainN\n         return true;\n     }\n \n+    boolean processGroup(ObjectStoreConnection con, Group originalGroup, final String domainName,\n+                        final String groupName, Group group, final String admin, final String auditRef,\n+                        StringBuilder auditDetails) {\n+\n+        // check to see if we need to insert the role or update it", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc1NDM3Ng==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479754376", "bodyText": "I might be missing something but shouldn't this be reversed?\nif (defaultValue == Boolean.TRUE) {\nreturn value == Boolean.FALSE ? \"false\" : \"true\"; // in any other case that isn't false (null or true) - set to true\n} else {\nreturn value == Boolean.TRUE ? \"true\" : \"false\"; // in any other case that isn't true - set to false\n}\nIn any case, it's best to a unit-test just to confirm it works properly", "author": "OferLevi85", "createdAt": "2020-08-30T10:55:39Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -3779,6 +4182,38 @@ boolean auditLogRoleMember(StringBuilder auditDetails, RoleMember roleMember, bo\n         return firstEntry;\n     }\n \n+    void auditLogGroupMembers(StringBuilder auditDetails, String label,\n+                             Collection<GroupMember> values) {\n+        auditDetails.append(\", \\\"\").append(label).append(\"\\\": [\");\n+        boolean firstEntry = true;\n+        for (GroupMember value : values) {\n+            firstEntry = auditLogGroupMember(auditDetails, value, firstEntry);\n+        }\n+        auditDetails.append(']');\n+    }\n+\n+    boolean auditLogGroupMember(StringBuilder auditDetails, GroupMember groupMember, boolean firstEntry) {\n+        firstEntry = auditLogSeparator(auditDetails, firstEntry);\n+        auditDetails.append(\"{\\\"member\\\": \\\"\").append(groupMember.getMemberName()).append('\"');\n+        if (groupMember.getExpiration() != null) {\n+            auditDetails.append(\", \\\"expiration\\\": \\\"\").append(groupMember.getExpiration().toString()).append('\"');\n+        }\n+        auditDetails.append(\", \\\"approved\\\": \");\n+        auditDetails.append(auditLogBooleanDefault(groupMember.getApproved(), Boolean.FALSE));\n+        auditDetails.append(\", \\\"system-disabled\\\": \");\n+        auditDetails.append(groupMember.getSystemDisabled() == null ? 0 : groupMember.getSystemDisabled());\n+        auditDetails.append(\"}\");\n+        return firstEntry;\n+    }\n+\n+    String auditLogBooleanDefault(Boolean value, Boolean defaultValue) {", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1MDIwNw==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479850207", "bodyText": "the logic is correct but I renamed the defaultValue to checkValue to be more clear the usage. the unit test has more explanation", "author": "havetisyan", "createdAt": "2020-08-31T01:52:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc1NDM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc1NTIzOQ==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479755239", "bodyText": "our role members => our group members\nour role and domain => our group and domain", "author": "OferLevi85", "createdAt": "2020-08-30T11:04:29Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -4531,6 +5314,41 @@ void updateRoleMembersSystemDisabledState(ResourceContext ctx, ObjectStoreConnec\n         }\n     }\n \n+    void updateGroupMembersSystemDisabledState(ResourceContext ctx, ObjectStoreConnection con, final String domainName,\n+                                               final String groupName, Group originalGroup, Group updatedGroup, final String auditRef) {\n+\n+        // if no group members, then there is nothing to do\n+\n+        final List<GroupMember> groupMembers = originalGroup.getGroupMembers();\n+        if (groupMembers == null || groupMembers.isEmpty()) {\n+            return;\n+        }\n+\n+        // check if the authority filter has changed otherwise we have\n+        // nothing to do\n+\n+        if (!isUserAuthorityFilterChanged(originalGroup.getUserAuthorityFilter(), updatedGroup.getUserAuthorityFilter())) {\n+            return;\n+        }\n+\n+        final String principal = getPrincipalName(ctx);\n+\n+        // process our role members and if there were any changes processed then update", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc1NTQ5Ng==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479755496", "bodyText": "update our group and domain", "author": "OferLevi85", "createdAt": "2020-08-30T11:06:52Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -4531,6 +5314,41 @@ void updateRoleMembersSystemDisabledState(ResourceContext ctx, ObjectStoreConnec\n         }\n     }\n \n+    void updateGroupMembersSystemDisabledState(ResourceContext ctx, ObjectStoreConnection con, final String domainName,\n+                                               final String groupName, Group originalGroup, Group updatedGroup, final String auditRef) {\n+\n+        // if no group members, then there is nothing to do\n+\n+        final List<GroupMember> groupMembers = originalGroup.getGroupMembers();\n+        if (groupMembers == null || groupMembers.isEmpty()) {\n+            return;\n+        }\n+\n+        // check if the authority filter has changed otherwise we have\n+        // nothing to do\n+\n+        if (!isUserAuthorityFilterChanged(originalGroup.getUserAuthorityFilter(), updatedGroup.getUserAuthorityFilter())) {\n+            return;\n+        }\n+\n+        final String principal = getPrincipalName(ctx);\n+\n+        // process our role members and if there were any changes processed then update\n+        // our role and domain time-stamps, and invalidate local cache entry\n+\n+        List<GroupMember> groupMembersWithUpdatedDisabledState = getGroupMembersWithUpdatedDisabledState(groupMembers,\n+                updatedGroup.getUserAuthorityFilter(), getDomainUserAuthorityFilter(con, domainName));\n+        if (updateGroupMemberDisabledState(ctx, con, groupMembersWithUpdatedDisabledState, domainName,\n+                groupName, principal, auditRef, ctx.getApiName())) {\n+\n+            // update our role and domain time-stamps, and invalidate local cache entry", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc1NjAxOQ==", "url": "https://github.com/AthenZ/athenz/pull/1097#discussion_r479756019", "bodyText": "role => group", "author": "OferLevi85", "createdAt": "2020-08-30T11:11:08Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -5001,6 +6047,42 @@ void processUserAuthorityRestrictions() {\n         }\n     }\n \n+    void processGroupUserAuthorityRestrictions() {\n+\n+        // if we don't have a user authority defined then there\n+        // is no work to be done\n+\n+        if (zmsConfig.getUserAuthority() == null) {\n+            return;\n+        }\n+\n+        // first we need to get all the groups that have the authority\n+        // filter or date expiry attributes set\n+\n+        List<PrincipalGroup> groups;\n+        try (ObjectStoreConnection con = store.getConnection(true, false)) {\n+            groups = con.listGroupsWithUserAuthorityRestrictions();\n+        }\n+\n+        if (groups == null) {\n+            return;\n+        }\n+\n+        // for each role catch any exception and ignore since we", "originalCommit": "0e4332925ee6c42f8e87e64908526d663f05b152", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5106c13d73ee9476683989a1a56403450cbfd0ea", "url": "https://github.com/AthenZ/athenz/commit/5106c13d73ee9476683989a1a56403450cbfd0ea", "message": "address review comments", "committedDate": "2020-08-31T02:01:24Z", "type": "commit"}]}