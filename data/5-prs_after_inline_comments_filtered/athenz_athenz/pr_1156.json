{"pr_number": 1156, "pr_title": "Fix DynamoDB errors for records with missing info in notifications", "pr_createdAt": "2020-10-21T12:57:50Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1156", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1NTY0Nw==", "url": "https://github.com/AthenZ/athenz/pull/1156#discussion_r509255647", "bodyText": "If clientCert attribute doesn't exist for some reason I set it to false.", "author": "OferLevi85", "createdAt": "2020-10-21T12:58:43Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -101,6 +101,13 @@ public X509CertRecord getX509CertRecord(String provider, String instanceId, Stri\n     }\n \n     private X509CertRecord itemToX509CertRecord(Item item) {\n+        boolean clientCert;\n+        try {\n+            clientCert = item.getBoolean(KEY_CLIENT_CERT);", "originalCommit": "2d22d1e541602bbb825181abf9e948f75e811d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1NjE2NQ==", "url": "https://github.com/AthenZ/athenz/pull/1156#discussion_r509256165", "bodyText": "If we'll find a problematic record, we'll print an error and continue so it won't affect other records.", "author": "OferLevi85", "createdAt": "2020-10-21T12:59:28Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -259,21 +266,25 @@ private String getPrimaryKey(final String provider, final String instanceId, fin\n \n         List<X509CertRecord> updatedRecords = new ArrayList<>();\n         for (Item item : items) {\n-            // For each item, update lastNotifiedTime and lastNotifiedServer (unless they were already updated)\n-            UpdateItemSpec updateItemSpec = new UpdateItemSpec().withPrimaryKey(KEY_PRIMARY, item.getString(KEY_PRIMARY))\n-                    .withReturnValues(ReturnValue.ALL_NEW)\n-                    .withUpdateExpression(\"set lastNotifiedTime = :lastNotifiedTimeVal, lastNotifiedServer = :lastNotifiedServerVal\")\n-                    .withConditionExpression(\"attribute_not_exists(lastNotifiedTime) OR lastNotifiedTime < :v_yesterday\")\n-                    .withValueMap(new ValueMap()\n-                            .with(\":lastNotifiedTimeVal\", lastNotifiedTime)\n-                            .withNumber(\":v_yesterday\", yesterday)\n-                            .withString(\":lastNotifiedServerVal\", lastNotifiedServer));\n-\n-            Item updatedItem = table.updateItem(updateItemSpec).getItem();\n-\n-            if (isRecordUpdatedWithNotificationTimeAndServer(lastNotifiedServer, lastNotifiedTime, updatedItem)) {\n-                X509CertRecord x509CertRecord = itemToX509CertRecord(updatedItem);\n-                updatedRecords.add(x509CertRecord);\n+            try {", "originalCommit": "2d22d1e541602bbb825181abf9e948f75e811d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1NzA0MA==", "url": "https://github.com/AthenZ/athenz/pull/1156#discussion_r509257040", "bodyText": "If an error is thrown for a specific combination of provider + date, we'll print it and continue so it won't affect other records.", "author": "OferLevi85", "createdAt": "2020-10-21T13:00:44Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -303,19 +314,25 @@ private boolean isRecordUpdatedWithNotificationTimeAndServer(String lastNotified\n     }\n \n     private List<Item> getUnrefreshedCertRecordsByDate(String provider, Index index, long yesterday, String unrefreshedCertDate) {\n-        QuerySpec spec = new QuerySpec()\n-                .withKeyConditionExpression(\"currentDate = :v_current_date\")\n-                .withFilterExpression(\"provider = :v_provider AND (attribute_not_exists(lastNotifiedTime) OR lastNotifiedTime < :v_last_notified)\")\n-                .withValueMap(new ValueMap()\n-                        .withString(\":v_current_date\", unrefreshedCertDate)\n-                        .withNumber(\":v_last_notified\", yesterday)\n-                        .withString(\":v_provider\", provider));\n-\n-        ItemCollection<QueryOutcome> outcome = index.query(spec);\n-        List<Item> items = new ArrayList<>();\n-        for (Item item : outcome) {\n-            items.add(item);\n+        try {\n+            QuerySpec spec = new QuerySpec()\n+                    .withKeyConditionExpression(\"currentDate = :v_current_date\")", "originalCommit": "2d22d1e541602bbb825181abf9e948f75e811d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7223aa96bb5358cf445d8c6b93721fd84b62124e", "url": "https://github.com/AthenZ/athenz/commit/7223aa96bb5358cf445d8c6b93721fd84b62124e", "message": "Fix DynamoDB errors for records with missing info in notifications", "committedDate": "2020-10-21T13:55:49Z", "type": "commit"}, {"oid": "7223aa96bb5358cf445d8c6b93721fd84b62124e", "url": "https://github.com/AthenZ/athenz/commit/7223aa96bb5358cf445d8c6b93721fd84b62124e", "message": "Fix DynamoDB errors for records with missing info in notifications", "committedDate": "2020-10-21T13:55:49Z", "type": "forcePushed"}]}