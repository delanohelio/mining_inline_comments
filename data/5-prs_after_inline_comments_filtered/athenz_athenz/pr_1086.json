{"pr_number": 1086, "pr_title": "Enable case-sensitive assertion action/resource value storage", "pr_createdAt": "2020-08-16T11:19:26Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1086", "timeline": [{"oid": "c8c07dd363e646bffd4b49141c9ffa813f3956ba", "url": "https://github.com/AthenZ/athenz/commit/c8c07dd363e646bffd4b49141c9ffa813f3956ba", "message": "Enable case-sensitive assertion checks (action and resource)", "committedDate": "2020-08-16T12:53:27Z", "type": "commit"}, {"oid": "c8c07dd363e646bffd4b49141c9ffa813f3956ba", "url": "https://github.com/AthenZ/athenz/commit/c8c07dd363e646bffd4b49141c9ffa813f3956ba", "message": "Enable case-sensitive assertion checks (action and resource)", "committedDate": "2020-08-16T12:53:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1MDQ5MA==", "url": "https://github.com/AthenZ/athenz/pull/1086#discussion_r471350490", "bodyText": "I didn't want to change the API. Users that would like to save assertion as case-sensitive will need to set the caseSensitive field in Assertion / Policy in putAssertion and putPolicy calls.\nPlease note the following:\n\nThis value will not be saved to DB. It will only be used to tell ZMS to keep the resource and action as case sensitive\nThe policy structure will also have this field. If it is set, all assertions will be lowercased\nIf the policy structure case-sensitive field isn't set, it is still possible for some of the assertions to have the case-sensitive field enabled. In which case, only assertions with case-sensitive field enabled will be kept in the original case.", "author": "OferLevi85", "createdAt": "2020-08-17T09:19:57Z", "path": "core/zms/src/main/java/com/yahoo/athenz/zms/Assertion.java", "diffHunk": "@@ -20,6 +20,9 @@\n     @RdlOptional\n     @JsonInclude(JsonInclude.Include.NON_EMPTY)\n     public Long id;\n+    @RdlOptional\n+    @JsonInclude(JsonInclude.Include.NON_EMPTY)\n+    public Boolean caseSensitive;", "originalCommit": "c8c07dd363e646bffd4b49141c9ffa813f3956ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1MzAzOQ==", "url": "https://github.com/AthenZ/athenz/pull/1086#discussion_r471353039", "bodyText": "Even if we want to keep in original case - domain will be lower-cased.", "author": "OferLevi85", "createdAt": "2020-08-17T09:24:47Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/utils/ZMSUtils.java", "diffHunk": "@@ -406,4 +406,18 @@ public static String combineUserAuthorityFilters(final String roleUserAuthorityF\n \n         return authorityFilter;\n     }\n+\n+    public static String lowerDomainInResource(String resource) {", "originalCommit": "c8c07dd363e646bffd4b49141c9ffa813f3956ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1NDg5NQ==", "url": "https://github.com/AthenZ/athenz/pull/1086#discussion_r471354895", "bodyText": "We should now lower-case assertions from the DB before checking them. This change was also made in ZTSAuthorizer and ZPE (ZpeUpdPolLoader)", "author": "OferLevi85", "createdAt": "2020-08-17T09:28:08Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -4320,6 +4333,10 @@ AthenzDomain virtualHomeDomain(Principal principal, String domainName) {\n     boolean assertionMatch(Assertion assertion, String identity, String action, String resource,\n             String domain, List<Role> roles, List<String> authenticatedRoles, String trustDomain) {\n \n+        // Lowercase action and resource in assertion as it is possible to store them case-sensitive\n+        assertion.setResource(assertion.getResource().toLowerCase());", "originalCommit": "c8c07dd363e646bffd4b49141c9ffa813f3956ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}