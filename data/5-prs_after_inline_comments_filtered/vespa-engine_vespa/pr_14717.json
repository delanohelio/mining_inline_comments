{"pr_number": 14717, "pr_title": "Reapply \"Move code out of RemoteSesion\"", "pr_createdAt": "2020-10-05T09:54:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14717", "timeline": [{"oid": "7e01ac092d8bf6002987a57c47d726eeac4db1c1", "url": "https://github.com/vespa-engine/vespa/commit/7e01ac092d8bf6002987a57c47d726eeac4db1c1", "message": "Revert \"Revert \"Move code out of RemoteSesion\"\"", "committedDate": "2020-10-05T09:48:37Z", "type": "commit"}, {"oid": "15b574feb6be44ec9fd2f9473ff8567fa4bc2f15", "url": "https://github.com/vespa-engine/vespa/commit/15b574feb6be44ec9fd2f9473ff8567fa4bc2f15", "message": "Make sure to update session in SessionStateWatcher when status changes", "committedDate": "2020-10-05T09:52:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ4NjY1NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14717#discussion_r499486655", "bodyText": "Hehe, yes ...", "author": "jonmv", "createdAt": "2020-10-05T10:07:44Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -756,11 +756,14 @@ private File getSessionAppDir(long sessionId) {\n         return new TenantFileSystemDirs(componentRegistry.getConfigServerDB(), tenantName).getUserApplicationDir(sessionId);\n     }\n \n-    private void addSessionStateWatcher(long sessionId, RemoteSession remoteSession) {\n-        if ( ! sessionStateWatchers.containsKey(sessionId)) {\n+    private void updateSessionStateWatcher(long sessionId, RemoteSession remoteSession) {\n+        SessionStateWatcher sessionStateWatcher = sessionStateWatchers.get(sessionId);\n+        if (sessionStateWatcher == null) {\n             Curator.FileCache fileCache = curator.createFileCache(getSessionStatePath(sessionId).getAbsolute(), false);\n             fileCache.addListener(this::nodeChanged);\n             sessionStateWatchers.put(sessionId, new SessionStateWatcher(fileCache, remoteSession, metrics, zkWatcherExecutor, this));\n+        } else {\n+            sessionStateWatcher.updateRemoteSession(remoteSession);", "originalCommit": "15b574feb6be44ec9fd2f9473ff8567fa4bc2f15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}