{"pr_number": 14841, "pr_title": "Jonmv/async doc v1 take2", "pr_createdAt": "2020-10-13T11:53:48Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14841", "timeline": [{"oid": "c458fcd2c2a35b129763115439ba3d13502b40e0", "url": "https://github.com/vespa-engine/vespa/commit/c458fcd2c2a35b129763115439ba3d13502b40e0", "message": "Expose \"writeFields\" from JsonWriter, to write only document fields", "committedDate": "2020-10-13T11:50:08Z", "type": "commit"}, {"oid": "89098c7afddc62256d3b969c1fdc452e95360038", "url": "https://github.com/vespa-engine/vespa/commit/89098c7afddc62256d3b969c1fdc452e95360038", "message": "Take 2 of async /document/v1 handler \u2014\u00a0handler only", "committedDate": "2020-10-13T11:51:14Z", "type": "commit"}, {"oid": "2d1f722b835e2f844058bfffbca66f258129bff1", "url": "https://github.com/vespa-engine/vespa/commit/2d1f722b835e2f844058bfffbca66f258129bff1", "message": "Also do dispatch when enqueueing", "committedDate": "2020-10-13T12:01:33Z", "type": "commit"}, {"oid": "2931da13cbf55cb62ebc384d568914673f387bdf", "url": "https://github.com/vespa-engine/vespa/commit/2931da13cbf55cb62ebc384d568914673f387bdf", "message": "Support conditional removals in AsyncSession", "committedDate": "2020-10-13T15:24:53Z", "type": "commit"}, {"oid": "53e68ede523a33a6f7e87f991ee7c392ee3a088e", "url": "https://github.com/vespa-engine/vespa/commit/53e68ede523a33a6f7e87f991ee7c392ee3a088e", "message": "Tests, more config and various fixes", "committedDate": "2020-10-13T18:18:14Z", "type": "commit"}, {"oid": "f57d5749b65972ea4f852ddcd24e5082e40254a1", "url": "https://github.com/vespa-engine/vespa/commit/f57d5749b65972ea4f852ddcd24e5082e40254a1", "message": "Remove unneeded threading in unit test", "committedDate": "2020-10-13T18:58:07Z", "type": "commit"}, {"oid": "320d24ac771ed013a3d4fc408b4ca77a0f294e02", "url": "https://github.com/vespa-engine/vespa/commit/320d24ac771ed013a3d4fc408b4ca77a0f294e02", "message": "Default to a single wanted document in visits", "committedDate": "2020-10-14T07:15:43Z", "type": "commit"}, {"oid": "8959673839e959ff48d4ce1961888791ff4e4346", "url": "https://github.com/vespa-engine/vespa/commit/8959673839e959ff48d4ce1961888791ff4e4346", "message": "Be stricter about request property parsing (and test this)", "committedDate": "2020-10-14T07:15:56Z", "type": "commit"}, {"oid": "8b9d957056e74ef79f50fd441fa2ab75afe4ca28", "url": "https://github.com/vespa-engine/vespa/commit/8b9d957056e74ef79f50fd441fa2ab75afe4ca28", "message": "Use UPDATE when doing an update", "committedDate": "2020-10-14T07:39:45Z", "type": "commit"}, {"oid": "78fa36414d239450a4e7da3919c74a16452bf52f", "url": "https://github.com/vespa-engine/vespa/commit/78fa36414d239450a4e7da3919c74a16452bf52f", "message": "Remove unused VisitorOptions class", "committedDate": "2020-10-14T08:21:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ5NDMwMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14841#discussion_r504494301", "bodyText": "enqueued might be positive even when the actual queue is empty (when multiple threads executes enqueueAndDispatch simultaneously.", "author": "bjorncs", "createdAt": "2020-10-14T08:26:47Z", "path": "vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/resource/DocumentV1ApiHandler.java", "diffHunk": "@@ -406,18 +409,14 @@ private void enqueueAndDispatch(HttpRequest request, ResponseHandler handler, Su\n             return;\n         }\n         Operation operation = Operation.lazilyParsed(request, handler, operationParser);\n-        if (enqueued.get() == 0 && operation.dispatch()) // Bypass queue if it is empty.\n+        if (enqueued.get() == 1 && operation.dispatch()) // Bypass queue if it is empty.", "originalCommit": "53e68ede523a33a6f7e87f991ee7c392ee3a088e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c430a9ed1a8afaeae4b96a7df18a056bfd13a437", "url": "https://github.com/vespa-engine/vespa/commit/c430a9ed1a8afaeae4b96a7df18a056bfd13a437", "message": "Simpifly enqueue-dispatch", "committedDate": "2020-10-14T08:34:33Z", "type": "commit"}]}