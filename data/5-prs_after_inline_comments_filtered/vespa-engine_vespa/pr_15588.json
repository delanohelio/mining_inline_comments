{"pr_number": 15588, "pr_title": "Add host switch updater", "pr_createdAt": "2020-12-02T10:33:54Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15588", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3MTE3NA==", "url": "https://github.com/vespa-engine/vespa/pull/15588#discussion_r534071174", "bodyText": "I don't think builders should take Optionals, instead the caller should avoid calling if the field is not present.", "author": "freva", "createdAt": "2020-12-02T10:48:00Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/configserver/Node.java", "diffHunk": "@@ -495,12 +503,17 @@ public Builder openStackId(String openStackId) {\n             return this;\n         }\n \n+        public Builder switchHostname(Optional<String> switchHostname) {", "originalCommit": "d4a0f2f0f0963ca85d5ebee7e61e37085ac4630a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3MjYzMg==", "url": "https://github.com/vespa-engine/vespa/pull/15588#discussion_r534072632", "bodyText": "If we are guaranteed that this is set, this should be .orElseThrow(), otherwise we should filter this in shouldUpdate()", "author": "freva", "createdAt": "2020-12-02T10:50:18Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostSwitchUpdater.java", "diffHunk": "@@ -0,0 +1,52 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.maintenance;\n+\n+import com.yahoo.vespa.hosted.controller.Controller;\n+import com.yahoo.vespa.hosted.controller.api.integration.configserver.Node;\n+import com.yahoo.vespa.hosted.controller.api.integration.configserver.NodeRepository;\n+import com.yahoo.vespa.hosted.controller.api.integration.entity.NodeEntity;\n+import com.yahoo.vespa.hosted.controller.api.integration.noderepository.NodeRepositoryNode;\n+\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Ensures that the switch information for all hosts is up to date.\n+ *\n+ * @author mpolden\n+ */\n+public class HostSwitchUpdater extends ControllerMaintainer {\n+\n+    private final NodeRepository nodeRepository;\n+\n+    public HostSwitchUpdater(Controller controller, Duration interval) {\n+        super(controller, interval);\n+        this.nodeRepository = controller.serviceRegistry().configServer().nodeRepository();\n+    }\n+\n+    @Override\n+    protected boolean maintain() {\n+        Map<String, NodeEntity> nodeEntities = controller().serviceRegistry().entityService().listNodes().stream()\n+                                                           .collect(Collectors.toMap(NodeEntity::hostname,\n+                                                                                     Function.identity()));\n+        for (var zone : controller().zoneRegistry().zones().controllerUpgraded().all().ids()) {\n+            for (var node : nodeRepository.list(zone)) {\n+                NodeEntity nodeEntity = nodeEntities.get(node.hostname().value());\n+                if (!shouldUpdate(node, nodeEntity)) continue;\n+\n+                NodeRepositoryNode updatedNode = new NodeRepositoryNode();\n+                updatedNode.setSwitchHostname(nodeEntity.switchHostname().orElse(null));", "originalCommit": "d4a0f2f0f0963ca85d5ebee7e61e37085ac4630a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA4NzA5Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15588#discussion_r534087096", "bodyText": "NodeEntity isn't guaranteed to have a switch, and if it's removed we want to remove it from the node as well.", "author": "mpolden", "createdAt": "2020-12-02T11:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3MjYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5MDU3NQ==", "url": "https://github.com/vespa-engine/vespa/pull/15588#discussion_r534090575", "bodyText": "I see, makes sense, but NodeRepositoryNode excludes nulls, so I think this will just be a patch with {}?", "author": "freva", "createdAt": "2020-12-02T11:20:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3MjYzMg=="}], "type": "inlineReview"}, {"oid": "3d33f25b291d4a4d7ba44847da85ef9ad1f5b62f", "url": "https://github.com/vespa-engine/vespa/commit/3d33f25b291d4a4d7ba44847da85ef9ad1f5b62f", "message": "Add host switch updater", "committedDate": "2020-12-02T11:17:02Z", "type": "commit"}, {"oid": "3d33f25b291d4a4d7ba44847da85ef9ad1f5b62f", "url": "https://github.com/vespa-engine/vespa/commit/3d33f25b291d4a4d7ba44847da85ef9ad1f5b62f", "message": "Add host switch updater", "committedDate": "2020-12-02T11:17:02Z", "type": "forcePushed"}, {"oid": "e01758aca6852d2c391f0b1b46274344061bec35", "url": "https://github.com/vespa-engine/vespa/commit/e01758aca6852d2c391f0b1b46274344061bec35", "message": "Never clear switch hostname", "committedDate": "2020-12-02T11:31:33Z", "type": "commit"}]}