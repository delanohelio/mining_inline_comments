{"pr_number": 12711, "pr_title": "Add control over mbus params", "pr_createdAt": "2020-03-25T14:50:07Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12711", "timeline": [{"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d", "url": "https://github.com/vespa-engine/vespa/commit/5ba4494cacab2dda7e037aecd18bf9055033094d", "message": "Add control over\n - num network threads\n - num connections per target\n - tcpnodelay\nDefaults are unchanged.", "committedDate": "2020-03-25T14:31:21Z", "type": "commit"}, {"oid": "a4f448633278360f7cb8ef2135f68291cb021a9f", "url": "https://github.com/vespa-engine/vespa/commit/a4f448633278360f7cb8ef2135f68291cb021a9f", "message": "Use auto and captitalize first word in sentence.", "committedDate": "2020-03-25T14:53:32Z", "type": "commit"}, {"oid": "020c88692058131e4009125e00ff5ca2400a2f31", "url": "https://github.com/vespa-engine/vespa/commit/020c88692058131e4009125e00ff5ca2400a2f31", "message": "Add config control over tcpnodelay for c++ too.", "committedDate": "2020-03-25T15:20:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyODMxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397928311", "bodyText": "Do we have any numbers that indicate disabling TCP_NODELAY is worth it? We unconditionally enabled nodelay for everything to get rid  of spurious latency spikes incurred by the in-kernel deferred packet sending.", "author": "vekterli", "createdAt": "2020-03-25T15:06:26Z", "path": "jrt/src/com/yahoo/jrt/Connection.java", "diffHunk": "@@ -89,21 +90,23 @@ private void setState(int state) {\n     }\n \n     public Connection(TransportThread parent, Supervisor owner,\n-                      SocketChannel channel) {\n+                      SocketChannel channel, boolean tcpNoDelay) {\n \n         this.parent = parent;\n         this.owner = owner;\n         this.socket = parent.transport().createServerCryptoSocket(channel);\n         this.spec = null;\n+        this.tcpNoDelay = tcpNoDelay;\n         server = true;\n         owner.sessionInit(this);\n     }\n \n-    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context) {\n+    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context, boolean tcpNoDelay) {\n         super(context);\n         this.parent = parent;\n         this.owner = owner;\n         this.spec = spec;\n+        this.tcpNoDelay = tcpNoDelay;", "originalCommit": "5ba4494cacab2dda7e037aecd18bf9055033094d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk3NDA4OA==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397974088", "bodyText": "I saw significantly lower system cpu when hardcoding it yesterday.\nHowever I did a lot of different tests then, and I am not putting more into it than it is a dimension that should be tested further. And for that to happen I need config control over it.", "author": "baldersheim", "createdAt": "2020-03-25T16:03:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyODMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk1NzUwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397957505", "bodyText": "Consider wrapping in a shouldEnableNoDelay(params) method or similar to make semantics more obvious", "author": "vekterli", "createdAt": "2020-03-25T15:42:44Z", "path": "messagebus/src/main/java/com/yahoo/messagebus/network/rpc/RPCNetwork.java", "diffHunk": "@@ -82,7 +82,7 @@ private static int getNumThreads() {\n     public RPCNetwork(RPCNetworkParams params, SlobrokConfigSubscriber slobrokConfig) {\n         this.slobroksConfig = slobrokConfig;\n         identity = params.getIdentity();\n-        orb = new Supervisor(new Transport(2));\n+        orb = new Supervisor(new Transport(params.getNumNetworkThreads(), params.getOptimization() == RPCNetworkParams.Optimization.LATENCY));", "originalCommit": "020c88692058131e4009125e00ff5ca2400a2f31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE2MzU2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398163569", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-03-25T20:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk1NzUwNQ=="}], "type": "inlineReview"}, {"oid": "3cd7be25c87fca3e558c6c793fb7279762a4a7d7", "url": "https://github.com/vespa-engine/vespa/commit/3cd7be25c87fca3e558c6c793fb7279762a4a7d7", "message": "Use a well named helper method for readability.", "committedDate": "2020-03-25T20:54:27Z", "type": "commit"}, {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4", "url": "https://github.com/vespa-engine/vespa/commit/36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4", "message": "optimization => optimize_for", "committedDate": "2020-03-25T22:30:20Z", "type": "commit"}]}