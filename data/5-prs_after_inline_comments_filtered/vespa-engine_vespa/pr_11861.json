{"pr_number": 11861, "pr_title": "Emit metrics on job starts and ends, with status as name and job id a\u2026", "pr_createdAt": "2020-01-20T15:03:35Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11861", "timeline": [{"oid": "79002706787ca4c1def5e5ef50c4ee1340e06dd0", "url": "https://github.com/vespa-engine/vespa/commit/79002706787ca4c1def5e5ef50c4ee1340e06dd0", "message": "Emit metrics on job starts and ends, with status as name and job id as dim.", "committedDate": "2020-01-20T15:02:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg0MDYwOQ==", "url": "https://github.com/vespa-engine/vespa/pull/11861#discussion_r368840609", "bodyText": "Typo.", "author": "mpolden", "createdAt": "2020-01-21T07:14:45Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/JobMetrics.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.yahoo.vespa.hosted.controller.deployment;\n+\n+import com.yahoo.config.provision.SystemName;\n+import com.yahoo.jdisc.Metric;\n+import com.yahoo.vespa.hosted.controller.api.integration.deployment.JobId;\n+\n+import java.util.Map;\n+\n+/**\n+ * Records metrics related to deployment jobs.\n+ *\n+ * @author jommv", "originalCommit": "79002706787ca4c1def5e5ef50c4ee1340e06dd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg2NjYyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/11861#discussion_r368866621", "bodyText": "Nah, changed my name last week >_<", "author": "jonmv", "createdAt": "2020-01-21T08:36:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg0MDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg2NjY4NA==", "url": "https://github.com/vespa-engine/vespa/pull/11861#discussion_r368866684", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @author jommv\n          \n          \n            \n             * @author jonmv", "author": "jonmv", "createdAt": "2020-01-21T08:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg0MDYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg0OTExMg==", "url": "https://github.com/vespa-engine/vespa/pull/11861#discussion_r368849112", "bodyText": "Missing copyright header:\n// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "author": "mpolden", "createdAt": "2020-01-21T07:44:44Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/JobMetrics.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.yahoo.vespa.hosted.controller.deployment;", "originalCommit": "79002706787ca4c1def5e5ef50c4ee1340e06dd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg2NjkyMg==", "url": "https://github.com/vespa-engine/vespa/pull/11861#discussion_r368866922", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            package com.yahoo.vespa.hosted.controller.deployment;\n          \n          \n            \n            // Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n          \n          \n            \n            package com.yahoo.vespa.hosted.controller.deployment;", "author": "jonmv", "createdAt": "2020-01-21T08:37:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg0OTExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg0OTY5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/11861#discussion_r368849695", "bodyText": "Include the unexpected value in the message (or remove this case and let default handle it).", "author": "mpolden", "createdAt": "2020-01-21T07:46:45Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/JobMetrics.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.yahoo.vespa.hosted.controller.deployment;\n+\n+import com.yahoo.config.provision.SystemName;\n+import com.yahoo.jdisc.Metric;\n+import com.yahoo.vespa.hosted.controller.api.integration.deployment.JobId;\n+\n+import java.util.Map;\n+\n+/**\n+ * Records metrics related to deployment jobs.\n+ *\n+ * @author jommv\n+ */\n+public class JobMetrics {\n+\n+    public static final String start = \"deployment.start\";\n+    public static final String outOfCapacity = \"deployment.outOfCapacity\";\n+    public static final String deploymentFailure = \"deployment.deploymentFailure\";\n+    public static final String convergenceFailure = \"deployment.convergenceFailure\";\n+    public static final String testFailure = \"deployment.testFailure\";\n+    public static final String error = \"deployment.error\";\n+    public static final String abort = \"deployment.abort\";\n+    public static final String success = \"deployment.success\";\n+\n+    private final Metric metric;\n+    private final SystemName system;\n+\n+    public JobMetrics(Metric metric, SystemName system) {\n+        this.metric = metric;\n+        this.system = system;\n+    }\n+\n+    public void jobStarted(JobId id) {\n+        metric.add(start, 1, metric.createContext(contextOf(id)));\n+    }\n+\n+    public void jobFinished(JobId id, RunStatus status) {\n+        metric.add(valueOf(status), 1, metric.createContext(contextOf(id)));\n+    }\n+\n+    Map<String, String> contextOf(JobId id) {\n+        return Map.of(\"tenant\", id.application().tenant().value(),\n+                      \"application\", id.application().application().value(),\n+                      \"instance\", id.application().instance().value(),\n+                      \"job\", id.type().jobName(),\n+                      \"environment\", id.type().environment().value(),\n+                      \"region\", id.type().zone(system).region().value());\n+    }\n+\n+    static String valueOf(RunStatus status) {\n+        switch (status) {\n+            case outOfCapacity: return outOfCapacity;\n+            case deploymentFailed: return deploymentFailure;\n+            case installationFailed: return convergenceFailure;\n+            case testFailure: return testFailure;\n+            case error: return error;\n+            case aborted: return abort;\n+            case success: return success;\n+            case running: throw new IllegalArgumentException(\"Not supposed to get this value\");", "originalCommit": "79002706787ca4c1def5e5ef50c4ee1340e06dd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg2NzM2MA==", "url": "https://github.com/vespa-engine/vespa/pull/11861#discussion_r368867360", "bodyText": "I have no idea why I wrote it this way o_O", "author": "jonmv", "createdAt": "2020-01-21T08:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg0OTY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg2NzQxNg==", "url": "https://github.com/vespa-engine/vespa/pull/11861#discussion_r368867416", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        case running: throw new IllegalArgumentException(\"Not supposed to get this value\");", "author": "jonmv", "createdAt": "2020-01-21T08:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg0OTY5NQ=="}], "type": "inlineReview"}, {"oid": "43105be5a09fc15ff33013c711604e0b1df3fd1e", "url": "https://github.com/vespa-engine/vespa/commit/43105be5a09fc15ff33013c711604e0b1df3fd1e", "message": "Fix author name", "committedDate": "2020-01-21T08:36:57Z", "type": "commit"}, {"oid": "73f1b28590558a39d1ac29ffeaa45448c5b08593", "url": "https://github.com/vespa-engine/vespa/commit/73f1b28590558a39d1ac29ffeaa45448c5b08593", "message": "Add copyright header", "committedDate": "2020-01-21T08:37:39Z", "type": "commit"}, {"oid": "4cdf8bf167755f70c127514bda16a40b568487c0", "url": "https://github.com/vespa-engine/vespa/commit/4cdf8bf167755f70c127514bda16a40b568487c0", "message": "Don't special-case pointlessly", "committedDate": "2020-01-21T08:38:49Z", "type": "commit"}]}