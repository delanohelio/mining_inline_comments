{"pr_number": 12521, "pr_title": "Bratseth/deprovisioned node state", "pr_createdAt": "2020-03-09T20:46:38Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12521", "timeline": [{"oid": "2ca0e3be242332ee66277001da35c278f2bf3a4f", "url": "https://github.com/vespa-engine/vespa/commit/2ca0e3be242332ee66277001da35c278f2bf3a4f", "message": "Simplify, no functional changes", "committedDate": "2020-03-09T11:39:58Z", "type": "commit"}, {"oid": "5d86852c1f81f6e71aeaf3d6ccd3665e94b2e918", "url": "https://github.com/vespa-engine/vespa/commit/5d86852c1f81f6e71aeaf3d6ccd3665e94b2e918", "message": "Simplify, no functional changes", "committedDate": "2020-03-09T12:43:26Z", "type": "commit"}, {"oid": "aa1758edef6a1bfaa06dc7c88b888dc9ea0061b9", "url": "https://github.com/vespa-engine/vespa/commit/aa1758edef6a1bfaa06dc7c88b888dc9ea0061b9", "message": "Add deprovisioned state", "committedDate": "2020-03-09T13:48:40Z", "type": "commit"}, {"oid": "4753b5cadf9bcf74ad9cef6de2273f495d47c47f", "url": "https://github.com/vespa-engine/vespa/commit/4753b5cadf9bcf74ad9cef6de2273f495d47c47f", "message": "Recycle deprovisioned nodes on provision", "committedDate": "2020-03-09T15:06:56Z", "type": "commit"}, {"oid": "fcedbb36c7caea42e9ab9f6816fdcd28d71aeae9", "url": "https://github.com/vespa-engine/vespa/commit/fcedbb36c7caea42e9ab9f6816fdcd28d71aeae9", "message": "Remove hosts on aws", "committedDate": "2020-03-09T20:26:02Z", "type": "commit"}, {"oid": "2e8dfe4a5c8bc571262ae4b92feb31cebddc7c5b", "url": "https://github.com/vespa-engine/vespa/commit/2e8dfe4a5c8bc571262ae4b92feb31cebddc7c5b", "message": "Don't change method name", "committedDate": "2020-03-09T21:17:00Z", "type": "commit"}, {"oid": "4cf0f9f70c0d7c640f079f0cd1d055e37f4e8fb1", "url": "https://github.com/vespa-engine/vespa/commit/4cf0f9f70c0d7c640f079f0cd1d055e37f4e8fb1", "message": "Add deprivisioned state", "committedDate": "2020-03-10T06:20:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzNTY0MA==", "url": "https://github.com/vespa-engine/vespa/pull/12521#discussion_r390135640", "bodyText": "Looks like we have this in several places now. We should find a way to model it properly soon.", "author": "mpolden", "createdAt": "2020-03-10T07:39:54Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/NodeRepository.java", "diffHunk": "@@ -608,8 +608,11 @@ public Node markNodeAvailableForNewAllocation(String hostname, Agent agent, Stri\n                 List<Node> children = list().childrenOf(node).asList();\n                 children.forEach(child -> requireRemovable(child, true, force));\n                 db.removeNodes(children);\n-                move(node, State.deprovisioned, Agent.system, Optional.empty());\n                 List<Node> removed = new ArrayList<>(children);\n+                if (zone.cloud().value().equals(\"aws\"))", "originalCommit": "fcedbb36c7caea42e9ab9f6816fdcd28d71aeae9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE0MDc2Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12521#discussion_r390140766", "bodyText": "Agree. What I want to do is create a \"cloud config\" which defines the properties of a cloud and then only test for those properties.", "author": "bratseth", "createdAt": "2020-03-10T07:54:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzNTY0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzNzY1NA==", "url": "https://github.com/vespa-engine/vespa/pull/12521#discussion_r390137654", "bodyText": "Should also be added to com.yahoo.vespa.hosted.controller.api.integration.noderepository.NodeState.", "author": "mpolden", "createdAt": "2020-03-10T07:45:21Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/configserver/noderepository/NodeState.java", "diffHunk": "@@ -9,5 +9,5 @@\n  * @author freva\n  */\n public enum NodeState {\n-    provisioned, ready, reserved, active, inactive, dirty, failed, parked\n+    provisioned, ready, reserved, active, inactive, dirty, failed, parked, deprovisioned", "originalCommit": "4cf0f9f70c0d7c640f079f0cd1d055e37f4e8fb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE0MTczMg==", "url": "https://github.com/vespa-engine/vespa/pull/12521#discussion_r390141732", "bodyText": "Done - thanks", "author": "bratseth", "createdAt": "2020-03-10T07:56:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzNzY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzODU4OA==", "url": "https://github.com/vespa-engine/vespa/pull/12521#discussion_r390138588", "bodyText": "Why not?", "author": "mpolden", "createdAt": "2020-03-10T07:48:03Z", "path": "config-provisioning/src/main/java/com/yahoo/config/provision/NodeType.java", "diffHunk": "@@ -45,7 +45,7 @@\n         this.description = description;\n     }\n \n-    public boolean isHost() {\n+    public boolean isDockerHost() {", "originalCommit": "2e8dfe4a5c8bc571262ae4b92feb31cebddc7c5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE0MTE3NA==", "url": "https://github.com/vespa-engine/vespa/pull/12521#discussion_r390141174", "bodyText": "Breaks the config server/config model API - in theory, did not look at usages.\nI still want to do it but in a separate PR.", "author": "bratseth", "createdAt": "2020-03-10T07:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzODU4OA=="}], "type": "inlineReview"}, {"oid": "5f488cb8afc8ea85cbdd5d5ba327caa376d1dc1b", "url": "https://github.com/vespa-engine/vespa/commit/5f488cb8afc8ea85cbdd5d5ba327caa376d1dc1b", "message": "Add deprovisioned state", "committedDate": "2020-03-10T07:56:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNjI3NA==", "url": "https://github.com/vespa-engine/vespa/pull/12521#discussion_r390206274", "bodyText": "Add to \n  \n    \n      vespa/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/noderepository/NodeHistory.java\n    \n    \n         Line 35\n      in\n      ddd5141\n    \n    \n    \n    \n\n        \n          \n           public enum Agent {", "author": "freva", "createdAt": "2020-03-10T10:03:32Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/node/Agent.java", "diffHunk": "@@ -17,5 +17,6 @@\n     FailedExpirer,\n     InactiveExpirer,\n     ProvisionedExpirer,\n-    ReservationExpirer\n+    ReservationExpirer,\n+    DynamicProvisioningMaintainer", "originalCommit": "5f488cb8afc8ea85cbdd5d5ba327caa376d1dc1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxMTY5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12521#discussion_r390211695", "bodyText": "Thanks\n#12523", "author": "bratseth", "createdAt": "2020-03-10T10:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNjI3NA=="}], "type": "inlineReview"}]}