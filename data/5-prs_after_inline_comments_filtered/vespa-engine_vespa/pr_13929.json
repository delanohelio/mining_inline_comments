{"pr_number": 13929, "pr_title": "Add endpoint to delete all prod deployments", "pr_createdAt": "2020-07-21T10:52:01Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13929", "timeline": [{"oid": "4d5ddc879354e898b458150dbd7da69fecaddc0a", "url": "https://github.com/vespa-engine/vespa/commit/4d5ddc879354e898b458150dbd7da69fecaddc0a", "message": "Remove redundant commit argument", "committedDate": "2020-07-21T09:40:44Z", "type": "commit"}, {"oid": "ecd871806391296801f5475c991c1a2d0820c7f9", "url": "https://github.com/vespa-engine/vespa/commit/ecd871806391296801f5475c991c1a2d0820c7f9", "message": "Create application package to remove all deployments", "committedDate": "2020-07-21T10:49:14Z", "type": "commit"}, {"oid": "9be970a77dbe288f55853c364ea0e1df9046c629", "url": "https://github.com/vespa-engine/vespa/commit/9be970a77dbe288f55853c364ea0e1df9046c629", "message": "Add endpoint to remove all prod deployments", "committedDate": "2020-07-21T10:49:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1ODg4MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458058881", "bodyText": "Consider simplifying to deploymentRemoval().", "author": "mpolden", "createdAt": "2020-07-21T12:31:08Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/application/ApplicationPackage.java", "diffHunk": "@@ -184,4 +189,27 @@ private static String withoutLegacyDir(String name) {\n \n     }\n \n+    /** Creates a valid application package that will remove all application's deployments */\n+    public static ApplicationPackage createEmptyForDeploymentRemoval() {", "originalCommit": "9be970a77dbe288f55853c364ea0e1df9046c629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2OTUwOA==", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458069508", "bodyText": "Done", "author": "freva", "createdAt": "2020-07-21T12:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1ODg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MDc4Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458060783", "bodyText": "What about test/staging? If this indeed only applies to prod, we can perhaps use the path /application/v4/tenant/{tenant}/application/{application}/environment/prod?", "author": "mpolden", "createdAt": "2020-07-21T12:34:34Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -284,6 +284,7 @@ private HttpResponse handleDELETE(Path path, HttpRequest request) {\n         if (path.matches(\"/application/v4/tenant/{tenant}\")) return deleteTenant(path.get(\"tenant\"), request);\n         if (path.matches(\"/application/v4/tenant/{tenant}/key\")) return removeDeveloperKey(path.get(\"tenant\"), request);\n         if (path.matches(\"/application/v4/tenant/{tenant}/application/{application}\")) return deleteApplication(path.get(\"tenant\"), path.get(\"application\"), request);\n+        if (path.matches(\"/application/v4/tenant/{tenant}/application/{application}/deployment\")) return removeProdAllDeployments(path.get(\"tenant\"), path.get(\"application\"));", "originalCommit": "9be970a77dbe288f55853c364ea0e1df9046c629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2OTM1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458069359", "bodyText": "My understanding is that this will submit the empty application, which will notify the JobController which will asynchronously at some point see that prod deployments have been removed and start making DELETE calls against config servers. It will also figure out that the system/staging tests it might have been running are no longer needed and abort them + delete deployment (similar to what happens when you submit a new package while tests are running).", "author": "freva", "createdAt": "2020-07-21T12:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MDc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MTA0OA==", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458061048", "bodyText": "Consider naming it removeAllProdDeployments.", "author": "mpolden", "createdAt": "2020-07-21T12:35:00Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -1901,12 +1902,17 @@ private HttpResponse submit(String tenant, String application, HttpRequest reque\n                                                             sourceRevision,\n                                                             authorEmail,\n                                                             sourceUrl,\n-                                                            commit,\n                                                             projectId,\n                                                             applicationPackage,\n                                                             dataParts.get(EnvironmentResource.APPLICATION_TEST_ZIP));\n     }\n \n+    private HttpResponse removeProdAllDeployments(String tenant, String application) {", "originalCommit": "9be970a77dbe288f55853c364ea0e1df9046c629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2OTQwMg==", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458069402", "bodyText": "Done", "author": "freva", "createdAt": "2020-07-21T12:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MTA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MzQyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458063421", "bodyText": "Would be better if this said what happened (i.e. \"all deployments removed\"), but not important.", "author": "mpolden", "createdAt": "2020-07-21T12:39:12Z", "path": "controller-server/src/test/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiTest.java", "diffHunk": "@@ -974,6 +971,36 @@ public void testMeteringResponses() {\n                               new File(\"instance1-metering.json\"));\n     }\n \n+    @Test\n+    public void testRemovingAllDeployments() {\n+        createAthenzDomainWithAdmin(ATHENZ_TENANT_DOMAIN, USER_ID);\n+        ApplicationPackage applicationPackage = new ApplicationPackageBuilder()\n+                .instances(\"instance1\")\n+                .region(\"us-west-1\")\n+                .region(\"us-east-3\")\n+                .region(\"eu-west-1\")\n+                .endpoint(\"eu\", \"default\", \"eu-west-1\")\n+                .endpoint(\"default\", \"default\", \"us-west-1\", \"us-east-3\")\n+                .build();\n+\n+        deploymentTester.controllerTester().createTenant(\"tenant1\", ATHENZ_TENANT_DOMAIN.getName(), 432L);\n+\n+        // Create tenant and deploy\n+        var app = deploymentTester.newDeploymentContext(\"tenant1\", \"application1\", \"instance1\");\n+        app.submit(applicationPackage).deploy();\n+        tester.controller().jobController().deploy(app.instanceId(), JobType.devUsEast1, Optional.empty(), applicationPackage);\n+\n+        assertEquals(Set.of(ZoneId.from(\"prod.us-west-1\"), ZoneId.from(\"prod.us-east-3\"), ZoneId.from(\"prod.eu-west-1\"), ZoneId.from(\"dev.us-east-1\")),\n+                app.instance().deployments().keySet());\n+\n+        tester.assertResponse(request(\"/application/v4/tenant/tenant1/application/application1/deployment\", DELETE)\n+                        .userIdentity(USER_ID)\n+                        .oktaAccessToken(OKTA_AT).oktaIdentityToken(OKTA_IT),\n+                \"{\\\"message\\\":\\\"Application package version: 1.0.2-unknown\\\"}\");", "originalCommit": "9be970a77dbe288f55853c364ea0e1df9046c629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2OTQ5Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13929#discussion_r458069493", "bodyText": "Done", "author": "freva", "createdAt": "2020-07-21T12:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MzQyMQ=="}], "type": "inlineReview"}, {"oid": "1034436255c66d6b00b7ee6dc1c38f71701766b0", "url": "https://github.com/vespa-engine/vespa/commit/1034436255c66d6b00b7ee6dc1c38f71701766b0", "message": "Code review fixes", "committedDate": "2020-07-21T12:49:07Z", "type": "commit"}]}