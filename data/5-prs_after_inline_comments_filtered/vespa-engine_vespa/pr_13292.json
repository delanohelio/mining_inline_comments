{"pr_number": 13292, "pr_title": "Shutdown docproc thread executors.", "pr_createdAt": "2020-05-18T19:57:03Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13292", "timeline": [{"oid": "e6df521e70889b677d518af45c369bad2d3048f2", "url": "https://github.com/vespa-engine/vespa/commit/e6df521e70889b677d518af45c369bad2d3048f2", "message": "Shutdown docproc thread executors.", "committedDate": "2020-05-18T19:55:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r426887570", "bodyText": "I would have thought the one create by this would suffice?", "author": "jonmv", "createdAt": "2020-05-18T20:53:52Z", "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/DocumentProcessingHandler.java", "diffHunk": "@@ -121,7 +121,8 @@ public DocumentProcessingHandler(ComponentRegistry<DocumentProcessor> documentPr\n \n     @Override\n     protected void destroy() {\n-        //threadPoolMap.values().forEach( pool -> pool.shutdown());  //calling shutdownNow() seems like a bit of an overkill\n+        laterExecutor.shutdown();\n+        docprocServiceRegistry.allComponents().forEach(docprocService -> docprocService.deconstruct());", "originalCommit": "e6df521e70889b677d518af45c369bad2d3048f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MzU4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r426893589", "bodyText": "I think that all are created by this one.", "author": "baldersheim", "createdAt": "2020-05-18T21:07:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyOTA0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427029041", "bodyText": "But not by this instance? Wouldn\u2019t this also destruktivt the next gen create by DI, or isn\u2019t the registre shared?", "author": "jonmv", "createdAt": "2020-05-19T04:52:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA1MjY3MA==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427052670", "bodyText": "Ok, the registry is owned by the handler. All good, then.", "author": "jonmv", "createdAt": "2020-05-19T06:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3NzczMw==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427077733", "bodyText": "Well, after sleeping on this one I am no longer certain about the life time about this one.\nI looked at the ComponentRegistry and saw that it was freezeable and assumed it would be frozen once component graph was set up, and hence not being possible to unregister anything. But that assumption might be wrong. No tests failed due to this, but that might be due that the 60s grace period.\n@gjoranv could you have a look at this one.", "author": "baldersheim", "createdAt": "2020-05-19T07:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4NjAzMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427086031", "bodyText": "This will deconstruct all DocprocServices, regardless of whether they survive the next reconfig or not. The injected registry contains all of them, no matter which generation they were created in.", "author": "gjoranv", "createdAt": "2020-05-19T07:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4ODExNQ==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427088115", "bodyText": "That was the the creeping feeling I had.", "author": "baldersheim", "createdAt": "2020-05-19T07:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5Mjc4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427092789", "bodyText": "That was my objection yesterday, but it seems the registry is created in the constructor of this handler, not injected.", "author": "jonmv", "createdAt": "2020-05-19T07:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5Mzk5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427093995", "bodyText": "The other registries are injected, but not the one used for the DocprocServicees, which are the ones with the thread pools that weren't shut down.", "author": "jonmv", "createdAt": "2020-05-19T07:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExMTkwNg==", "url": "https://github.com/vespa-engine/vespa/pull/13292#discussion_r427111906", "bodyText": "Sorry, I looked at the wrong constructor. As @jonmv says, the registry is not injected. Without knowing the code in detail, it looks like all the DocprocServices are created by the handler instance. So this should be all good.", "author": "gjoranv", "createdAt": "2020-05-19T08:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NzU3MA=="}], "type": "inlineReview"}]}