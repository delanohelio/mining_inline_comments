{"pr_number": 15007, "pr_title": "andreer/basic quota subtraction", "pr_createdAt": "2020-10-22T11:45:57Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15007", "timeline": [{"oid": "f28d70669348831c86756a1b570e57605e9823d8", "url": "https://github.com/vespa-engine/vespa/commit/f28d70669348831c86756a1b570e57605e9823d8", "message": "subtract usage by other application deployments from Quota", "committedDate": "2020-10-20T11:46:10Z", "type": "commit"}, {"oid": "90aff3a99045f5fc35aff5069a723d0bdc3a54c7", "url": "https://github.com/vespa-engine/vespa/commit/90aff3a99045f5fc35aff5069a723d0bdc3a54c7", "message": "sum usage across tenant, not application", "committedDate": "2020-10-22T10:35:42Z", "type": "commit"}, {"oid": "80391c46eeafa371d1d6f991a4f984b50add7ad3", "url": "https://github.com/vespa-engine/vespa/commit/80391c46eeafa371d1d6f991a4f984b50add7ad3", "message": "simplify unlimited check", "committedDate": "2020-10-22T12:29:25Z", "type": "commit"}, {"oid": "4fc57f5fca98a9a0f879c6afbfffd8a8c3ce8b39", "url": "https://github.com/vespa-engine/vespa/commit/4fc57f5fca98a9a0f879c6afbfffd8a8c3ce8b39", "message": "extract class for deployment quota calculation", "committedDate": "2020-10-23T14:20:09Z", "type": "commit"}, {"oid": "cb1f0e479fb23add4499b712cbd2db42c5453e8b", "url": "https://github.com/vespa-engine/vespa/commit/cb1f0e479fb23add4499b712cbd2db42c5453e8b", "message": "divide application quota among deployments", "committedDate": "2020-10-25T19:09:27Z", "type": "commit"}, {"oid": "41d74ab07e9e45da22a1153176061bd186bcc0e8", "url": "https://github.com/vespa-engine/vespa/commit/41d74ab07e9e45da22a1153176061bd186bcc0e8", "message": "guard against division by zero", "committedDate": "2020-10-25T19:43:37Z", "type": "commit"}, {"oid": "c2cc2823c7397c30934b40cedafe2d9d34829c4a", "url": "https://github.com/vespa-engine/vespa/commit/c2cc2823c7397c30934b40cedafe2d9d34829c4a", "message": "use .zones() to get all deployments", "committedDate": "2020-10-25T20:38:59Z", "type": "commit"}, {"oid": "c36b1bd081047f0e95c27cd38afac69ae880b158", "url": "https://github.com/vespa-engine/vespa/commit/c36b1bd081047f0e95c27cd38afac69ae880b158", "message": "basic unit test", "committedDate": "2020-10-25T20:39:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzODAzNQ==", "url": "https://github.com/vespa-engine/vespa/pull/15007#discussion_r511938035", "bodyText": "I don't understand why application is a parameter for .quotaUsage(...). Surely the app object knows about its own identity?", "author": "oyving", "createdAt": "2020-10-26T12:56:17Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/application/DeploymentQuotaCalculator.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.yahoo.vespa.hosted.controller.application;\n+\n+import com.yahoo.config.application.api.DeploymentSpec;\n+import com.yahoo.config.provision.ApplicationId;\n+import com.yahoo.config.provision.zone.ZoneId;\n+import com.yahoo.vespa.hosted.controller.Application;\n+import com.yahoo.vespa.hosted.controller.api.integration.billing.Quota;\n+\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+import java.util.List;\n+\n+/** Calculates the quota to allocate to a deployment. */\n+public class DeploymentQuotaCalculator {\n+\n+    public static Quota calculate(Quota tenantQuota,\n+                                  List<Application> tenantApps,\n+                                  ApplicationId deployingApp, ZoneId deployingZone,\n+                                  DeploymentSpec deploymentSpec) {\n+\n+        if (tenantQuota.budget().isEmpty()) return tenantQuota; // Shortcut if there is no budget limit to care about.\n+\n+        if (deployingZone.environment().isProduction()) return probablyEnoughForAll(tenantQuota, tenantApps, deployingApp, deploymentSpec);\n+\n+        return getMaximumAllowedQuota(tenantQuota, tenantApps, deployingApp, deployingZone);\n+    }\n+\n+    /** Just get the maximum quota we are allowed to use. */\n+    private static Quota getMaximumAllowedQuota(Quota tenantQuota, List<Application> applications,\n+                                                ApplicationId application, ZoneId zone) {\n+        var usageOutsideDeployment = applications.stream()\n+                .map(app -> app.quotaUsage(application, zone))", "originalCommit": "c36b1bd081047f0e95c27cd38afac69ae880b158", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NzExNw==", "url": "https://github.com/vespa-engine/vespa/pull/15007#discussion_r511987117", "bodyText": "An ApplicationId is not the identifier of an Application - that is the TenantAndApplicationId (which it knows).\nAn ApplicationId actually specifies an instance: so TenantAndApplicationId + InstanceName. I could have passed just the InstanceName, and in the quotaUsage methods reconstructed the ApplicationId - but it would be more code and didn't seem any clearer to me.\nApplicationId needs to be renamed to InstanceId, or perhaps TenantAndApplicationAndInstanceId, but I think that's a big refactor :-)", "author": "andreer", "createdAt": "2020-10-26T14:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzODAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4OTk4Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15007#discussion_r511989986", "bodyText": "Aha! That makes more sense.", "author": "oyving", "createdAt": "2020-10-26T14:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzODAzNQ=="}], "type": "inlineReview"}]}