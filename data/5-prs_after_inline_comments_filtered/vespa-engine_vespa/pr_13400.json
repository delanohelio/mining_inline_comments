{"pr_number": 13400, "pr_title": "Add SystemMonitor and report to it from VersionStatusUpdater", "pr_createdAt": "2020-05-27T12:40:44Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13400", "timeline": [{"oid": "4b8bcc0d3ff5d849cf69df80274378b11fc79c35", "url": "https://github.com/vespa-engine/vespa/commit/4b8bcc0d3ff5d849cf69df80274378b11fc79c35", "message": "Add SystemMonitor and report to it from VersionStatusUpdater", "committedDate": "2020-05-27T12:40:20Z", "type": "commit"}, {"oid": "b9d352fd4fe4cea477c5c036fa8c849e23ae8c82", "url": "https://github.com/vespa-engine/vespa/commit/b9d352fd4fe4cea477c5c036fa8c849e23ae8c82", "message": "Expect failures for now", "committedDate": "2020-05-27T12:45:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA4OTkyMw==", "url": "https://github.com/vespa-engine/vespa/pull/13400#discussion_r431089923", "bodyText": "Add a test that verifies that all VespaVersion.Confidence can be converted?", "author": "freva", "createdAt": "2020-05-27T12:47:42Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/VersionStatusUpdater.java", "diffHunk": "@@ -27,10 +33,30 @@ protected void maintain() {\n         try {\n             VersionStatus newStatus = VersionStatus.compute(controller());\n             controller().updateVersionStatus(newStatus);\n+            newStatus.systemVersion().ifPresent(version -> {\n+                try {\n+                    controller().serviceRegistry().systemMonitor().reportSystemVersion(version.versionNumber(),\n+                                                                                       convert(version.confidence()));\n+                }\n+                // TODO jonmv: Remove try/catch when this is supposed to work.\n+                catch (Exception e) {\n+                    log.log(Level.INFO, \"Failed reporting system version status to monitor: \" + Exceptions.toMessageString(e));\n+                }\n+            });\n         } catch (Exception e) {\n             log.log(Level.WARNING, \"Failed to compute version status: \" + Exceptions.toMessageString(e) +\n                                    \". Retrying in \" + interval());\n         }\n     }\n \n+    private static SystemMonitor.Confidence convert(VespaVersion.Confidence confidence) {", "originalCommit": "b9d352fd4fe4cea477c5c036fa8c849e23ae8c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5MTg4Ng==", "url": "https://github.com/vespa-engine/vespa/pull/13400#discussion_r431091886", "bodyText": "Fair enough.", "author": "jonmv", "createdAt": "2020-05-27T12:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA4OTkyMw=="}], "type": "inlineReview"}, {"oid": "c3af22625994c04405a2675cedd5072e0dbcf0c4", "url": "https://github.com/vespa-engine/vespa/commit/c3af22625994c04405a2675cedd5072e0dbcf0c4", "message": "Verify confidence conversion", "committedDate": "2020-05-27T12:53:42Z", "type": "commit"}]}