{"pr_number": 15324, "pr_title": "Separate node failure maintenance from failing", "pr_createdAt": "2020-11-12T15:47:29Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15324", "timeline": [{"oid": "ccbb05c22ac610c2f6cb59024edcc3c90586b1a7", "url": "https://github.com/vespa-engine/vespa/commit/ccbb05c22ac610c2f6cb59024edcc3c90586b1a7", "message": "Separate node failure maintenance from failing", "committedDate": "2020-11-12T15:46:58Z", "type": "commit"}, {"oid": "ee332d88dbf3acdc778b5c5a5d38685c00a27297", "url": "https://github.com/vespa-engine/vespa/commit/ee332d88dbf3acdc778b5c5a5d38685c00a27297", "message": "Use node repository clock", "committedDate": "2020-11-12T21:37:04Z", "type": "commit"}, {"oid": "efa0126ed6949e7897102dfaa713d76686246680", "url": "https://github.com/vespa-engine/vespa/commit/efa0126ed6949e7897102dfaa713d76686246680", "message": "Don't make changes when there are zone-wide problems", "committedDate": "2020-11-13T07:22:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgwODg1Mw==", "url": "https://github.com/vespa-engine/vespa/pull/15324#discussion_r522808853", "bodyText": "Consider a shorter name. NodeHealthTracker?", "author": "mpolden", "createdAt": "2020-11-13T08:51:50Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/NodeFailureStatusUpdater.java", "diffHunk": "@@ -0,0 +1,137 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.provision.maintenance;\n+\n+import com.yahoo.config.provision.ApplicationId;\n+import com.yahoo.config.provision.ApplicationLockException;\n+import com.yahoo.config.provision.HostLivenessTracker;\n+import com.yahoo.jdisc.Metric;\n+import com.yahoo.transaction.Mutex;\n+import com.yahoo.vespa.applicationmodel.ServiceInstance;\n+import com.yahoo.vespa.applicationmodel.ServiceStatus;\n+import com.yahoo.vespa.hosted.provision.Node;\n+import com.yahoo.vespa.hosted.provision.NodeList;\n+import com.yahoo.vespa.hosted.provision.NodeRepository;\n+import com.yahoo.vespa.hosted.provision.node.Agent;\n+import com.yahoo.vespa.hosted.provision.node.History;\n+import com.yahoo.vespa.service.monitor.ServiceMonitor;\n+import com.yahoo.yolean.Exceptions;\n+\n+import java.time.Clock;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.logging.Level;\n+import java.util.stream.Collectors;\n+\n+import static java.util.stream.Collectors.counting;\n+\n+/**\n+ * Checks if nodes are responding and updates their status accordingly\n+ *\n+ * @author bratseth\n+ */\n+public class NodeFailureStatusUpdater extends NodeRepositoryMaintainer {", "originalCommit": "ccbb05c22ac610c2f6cb59024edcc3c90586b1a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMjA2NA==", "url": "https://github.com/vespa-engine/vespa/pull/15324#discussion_r522822064", "bodyText": "Good suggestion, I'll change it.", "author": "bratseth", "createdAt": "2020-11-13T09:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgwODg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgxMTk2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/15324#discussion_r522811969", "bodyText": "Consider simplifying to (double)downNodes.size() / (double)activeNodes.size() <= 0.2.", "author": "mpolden", "createdAt": "2020-11-13T08:57:39Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/NodeRepository.java", "diffHunk": "@@ -385,6 +385,18 @@ private NodeAcl getNodeAcl(Node node, NodeList candidates) {\n         return List.of(getNodeAcl(node, candidates));\n     }\n \n+    /**\n+     * Returns whether the zone managed by this node repository seems to be working.\n+     * If too many nodes are not responding, there is probably some zone-wide issue\n+     * and we should probably refrain from making changes to it.\n+     */\n+    public boolean isWorking() {\n+        NodeList activeNodes = list(State.active);\n+        if (activeNodes.size() <= 5) return true; // Not enough data to decide\n+        NodeList downNodes = activeNodes.down();\n+        return ! ( (double)downNodes.size() / (double)activeNodes.size() > 0.2 );", "originalCommit": "efa0126ed6949e7897102dfaa713d76686246680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMDc1Nw==", "url": "https://github.com/vespa-engine/vespa/pull/15324#discussion_r522820757", "bodyText": "I find \"working if not more than 20% fails\" is easier to get than the simpler one but that might just be me ...", "author": "bratseth", "createdAt": "2020-11-13T09:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgxMTk2OQ=="}], "type": "inlineReview"}, {"oid": "bdef9e9504a3d4df2b2e6887fa7829d7d06d4d46", "url": "https://github.com/vespa-engine/vespa/commit/bdef9e9504a3d4df2b2e6887fa7829d7d06d4d46", "message": "Shorter name", "committedDate": "2020-11-13T09:22:03Z", "type": "commit"}]}