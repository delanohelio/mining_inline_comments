{"pr_number": 13601, "pr_title": "- Removing body struct from our own usage.", "pr_createdAt": "2020-06-16T09:48:28Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13601", "timeline": [{"oid": "fcf38c0586e6166ed819a078355502bda4656d01", "url": "https://github.com/vespa-engine/vespa/commit/fcf38c0586e6166ed819a078355502bda4656d01", "message": "- Removing body struct from our own usage.\n- Deprecate public methods using body struct.\n- Update expected generated config.", "committedDate": "2020-06-16T09:46:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1MDU0MA==", "url": "https://github.com/vespa-engine/vespa/pull/13601#discussion_r440850540", "bodyText": "Is there a risk that someone might call this today (despite being deprecated) and effectively expect an empty Struct instead of null?", "author": "vekterli", "createdAt": "2020-06-16T13:30:27Z", "path": "document/src/main/java/com/yahoo/document/Document.java", "diffHunk": "@@ -104,7 +102,7 @@ private void internalSetId(DocumentId id, DocumentType docType) {\n \n     /** @deprecated do not use: Use getField(), getFieldValue() or iterator() instead */\n     @Deprecated // TODO: Remove on Vespa 8\n-    public Struct getBody() { return body; }\n+    public Struct getBody() { return null; }", "originalCommit": "fcf38c0586e6166ed819a078355502bda4656d01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NDAyMg==", "url": "https://github.com/vespa-engine/vespa/pull/13601#discussion_r441974022", "bodyText": "There is no known usages.", "author": "baldersheim", "createdAt": "2020-06-18T05:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1MDU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1NTU4MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13601#discussion_r440855581", "bodyText": "Can this entire iterator facade be removed now?", "author": "vekterli", "createdAt": "2020-06-16T13:37:17Z", "path": "document/src/main/java/com/yahoo/document/Document.java", "diffHunk": "@@ -193,66 +185,40 @@ public Field getField(String fieldName) {\n \n     @Override\n     public FieldValue getFieldValue(Field field) {\n-        FieldValue fv = header.getFieldValue(field);\n-        if (fv == null) {\n-            fv = body.getFieldValue(field);\n-        }\n-        return fv;\n+        return header.getFieldValue(field);\n     }\n \n     @Override\n-    @SuppressWarnings(\"deprecation\")\n     protected void doSetFieldValue(Field field, FieldValue value) {\n-        if (field.isHeader()) {\n-            header.setFieldValue(field, value);\n-        } else {\n-            body.setFieldValue(field, value);\n-        }\n+        header.setFieldValue(field, value);\n     }\n \n     @Override\n     public FieldValue removeFieldValue(Field field) {\n-        FieldValue removed = header.removeFieldValue(field);\n-        if (removed == null) {\n-            removed = body.removeFieldValue(field);\n-        }\n-        return removed;\n+        return header.removeFieldValue(field);\n     }\n \n     @Override\n     public void clear() {\n         header.clear();\n-        body.clear();\n     }\n \n     @Override\n     public Iterator<Map.Entry<Field, FieldValue>> iterator() {\n         return new Iterator<>() {\n \n             private Iterator<Map.Entry<Field, FieldValue>> headerIt = header.iterator();\n-            private Iterator<Map.Entry<Field, FieldValue>> bodyIt = body.iterator();\n \n             public boolean hasNext() {\n-                if (headerIt != null) {\n-                    if (headerIt.hasNext()) {\n-                        return true;\n-                    } else {\n-                        headerIt = null;\n-                    }\n-                }\n-                return bodyIt.hasNext();\n+                return headerIt.hasNext();", "originalCommit": "fcf38c0586e6166ed819a078355502bda4656d01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NDEwOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13601#discussion_r441974109", "bodyText": "Yes", "author": "baldersheim", "createdAt": "2020-06-18T05:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1NTU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1ODE3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/13601#discussion_r440858176", "bodyText": "Same question as getBody wrt. existing callers expecting something here. If there might be, maybe we should have a dummy empty sentinel struct type that gets returned?", "author": "vekterli", "createdAt": "2020-06-16T13:40:47Z", "path": "document/src/main/java/com/yahoo/document/DocumentType.java", "diffHunk": "@@ -139,11 +147,10 @@ public StructDataType getHeaderType() {\n     @Deprecated // TODO: Remove on Vespa 8\n     /** @deprecated use contentStruct instead */\n     public StructDataType getBodyType() {\n-        return bodyType;\n+        return null;", "originalCommit": "fcf38c0586e6166ed819a078355502bda4656d01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2OTY1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/13601#discussion_r441969656", "bodyText": "These has been deprecated for a long time, so I think not. But I actually think it is better to just remove it. There is currently no usage of it.", "author": "baldersheim", "createdAt": "2020-06-18T05:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1ODE3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1OTY5NA==", "url": "https://github.com/vespa-engine/vespa/pull/13601#discussion_r440859694", "bodyText": "Can this iterator facade be removed too?", "author": "vekterli", "createdAt": "2020-06-16T13:42:48Z", "path": "document/src/main/java/com/yahoo/document/DocumentType.java", "diffHunk": "@@ -485,26 +475,19 @@ public Field removeField(String name) {\n     public Iterator<Field> fieldIteratorThisTypeOnly() {\n         return new Iterator<>() {\n             Iterator<Field> headerIt = headerType.getFields().iterator();\n-            Iterator<Field> bodyIt = bodyType.getFields().iterator();\n \n             public boolean hasNext() {\n-                if (headerIt != null) {\n-                    if (headerIt.hasNext()) return true;\n-                    headerIt = null;\n-                }\n-                return bodyIt.hasNext();\n+                return headerIt.hasNext();", "originalCommit": "fcf38c0586e6166ed819a078355502bda4656d01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MTk2NA==", "url": "https://github.com/vespa-engine/vespa/pull/13601#discussion_r441971964", "bodyText": "Yes, it can.", "author": "baldersheim", "createdAt": "2020-06-18T05:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1OTY5NA=="}], "type": "inlineReview"}, {"oid": "78d1292783fd65b431462e9ab969a570c5f200fb", "url": "https://github.com/vespa-engine/vespa/commit/78d1292783fd65b431462e9ab969a570c5f200fb", "message": "Follow up from PR comments and GC some more code.", "committedDate": "2020-06-18T05:24:16Z", "type": "commit"}]}