{"pr_number": 15373, "pr_title": "Activate only if all config change actions are allowed, for hosted de\u2026", "pr_createdAt": "2020-11-18T09:02:19Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15373", "timeline": [{"oid": "702a51539d259be5f3e77f0f88d3360295e778c8", "url": "https://github.com/vespa-engine/vespa/commit/702a51539d259be5f3e77f0f88d3360295e778c8", "message": "Activate only if all config change actions are allowed, for hosted deployment", "committedDate": "2020-11-18T09:01:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkyMDk1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/15373#discussion_r525920959", "bodyText": "I think this check should be down in validation somewhere, not in ApplicationRepository?\nAnd isn't there a validate switch you should take into account?", "author": "bratseth", "createdAt": "2020-11-18T09:06:06Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/ApplicationRepository.java", "diffHunk": "@@ -321,11 +321,17 @@ public PrepareResult deploy(File applicationPackage, PrepareParams prepareParams\n         return deploy(applicationPackage, prepareParams, DeployHandlerLogger.forPrepareParams(prepareParams));\n     }\n \n-    public PrepareResult deploy(File applicationPackage, PrepareParams prepareParams, DeployHandlerLogger logger) {\n+    private PrepareResult deploy(File applicationPackage, PrepareParams prepareParams, DeployHandlerLogger logger) {\n         ApplicationId applicationId = prepareParams.getApplicationId();\n         long sessionId = createSession(applicationId, prepareParams.getTimeoutBudget(), applicationPackage);\n         Deployment deployment = prepare(sessionId, prepareParams, logger);\n-        deployment.activate();\n+\n+        if (deployment.configChangeActions().getRefeedActions().getEntries().stream().anyMatch(entry -> ! entry.allowed()))", "originalCommit": "702a51539d259be5f3e77f0f88d3360295e778c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkyOTA4NA==", "url": "https://github.com/vespa-engine/vespa/pull/15373#discussion_r525929084", "bodyText": "The actions are generated based on the validate switch down in validation.\nThis is a higher-level evaluation.\nIt could be in Deployment.activate(), but I think this is clearer, because that only conditionally runs Deployment.prepare(), which is the thing that sets these config change actions.", "author": "jonmv", "createdAt": "2020-11-18T09:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkyMDk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkzMDE4OA==", "url": "https://github.com/vespa-engine/vespa/pull/15373#discussion_r525930188", "bodyText": "This is just moving the logic that was previously in the controller (fail deployment if prepare reveals disallowed config change actions) closer to the action, so it actually works. Currently these deployments do happen, but the controller claims they didn't.", "author": "jonmv", "createdAt": "2020-11-18T09:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkyMDk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkzNTE2OA==", "url": "https://github.com/vespa-engine/vespa/pull/15373#discussion_r525935168", "bodyText": "Ok, I believe it was worse before. Even so, it could be that we can make it better than this.\n[New!] Why is this warning and otherwise silently ignoring prepare? Prepare should either succeed or throw?\nAnd why can't we do that down in the validation code like we do with everything else?\nAnd should this really disregard the \"validate\" argument?", "author": "bratseth", "createdAt": "2020-11-18T09:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkyMDk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1MTMyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/15373#discussion_r525951329", "bodyText": "Let's plug this hole now, and then do it properly. It may be some work.", "author": "jonmv", "createdAt": "2020-11-18T09:51:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkyMDk1OQ=="}], "type": "inlineReview"}]}