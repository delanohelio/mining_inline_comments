{"pr_number": 15257, "pr_title": "Arnej/add java tensor conformance app", "pr_createdAt": "2020-11-10T14:21:36Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15257", "timeline": [{"oid": "14874f78191132e7cbfa6b36e0121b5376948953", "url": "https://github.com/vespa-engine/vespa/commit/14874f78191132e7cbfa6b36e0121b5376948953", "message": "add a new Java application for evaluating tensor conformance tests\n\n* based on TensorConformanceTest unit test class\n* reads JSON into Slime structure\n* annotates with actual results from vespajlib evaluation", "committedDate": "2020-11-10T13:01:57Z", "type": "commit"}, {"oid": "db0c16fa7703507486a628f69cd2353c52e1ce56", "url": "https://github.com/vespa-engine/vespa/commit/db0c16fa7703507486a628f69cd2353c52e1ce56", "message": "add script wrapper", "committedDate": "2020-11-10T13:01:57Z", "type": "commit"}, {"oid": "de0f467a1f319972740c5b2945ebc0479faecb7e", "url": "https://github.com/vespa-engine/vespa/commit/de0f467a1f319972740c5b2945ebc0479faecb7e", "message": "install binary for vespa-tensor-conformance", "committedDate": "2020-11-10T14:18:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYwMzA0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15257#discussion_r520603046", "bodyText": "Copyright Verizon Media", "author": "lesters", "createdAt": "2020-11-10T14:27:25Z", "path": "searchlib/src/main/java/com/yahoo/searchlib/tensor/EvaluateTensorConformance.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright 2018 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "originalCommit": "de0f467a1f319972740c5b2945ebc0479faecb7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYwMzE4Mw==", "url": "https://github.com/vespa-engine/vespa/pull/15257#discussion_r520603183", "bodyText": "indent", "author": "lesters", "createdAt": "2020-11-10T14:27:35Z", "path": "searchlib/src/main/java/com/yahoo/searchlib/tensor/EvaluateTensorConformance.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright 2018 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.searchlib.tensor;\n+\n+import com.yahoo.slime.Cursor;\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.JsonFormat;\n+import com.yahoo.slime.ObjectTraverser;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.slime.SlimeUtils;\n+\n+import com.yahoo.io.GrowableByteBuffer;\n+import com.yahoo.searchlib.rankingexpression.RankingExpression;\n+import com.yahoo.searchlib.rankingexpression.evaluation.BooleanValue;\n+import com.yahoo.searchlib.rankingexpression.evaluation.DoubleCompatibleValue;\n+import com.yahoo.searchlib.rankingexpression.evaluation.MapContext;\n+import com.yahoo.searchlib.rankingexpression.evaluation.StringValue;\n+import com.yahoo.searchlib.rankingexpression.evaluation.TensorValue;\n+import com.yahoo.searchlib.rankingexpression.evaluation.Value;\n+import com.yahoo.searchlib.rankingexpression.parser.ParseException;\n+import com.yahoo.tensor.Tensor;\n+import com.yahoo.tensor.serialization.TypedBinaryFormat;\n+\n+import java.io.BufferedOutputStream;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+public class EvaluateTensorConformance {\n+\n+    public static void main(String[] args) {\n+        var app = new EvaluateTensorConformance();\n+        app.evaluateStdIn();\n+    }\n+\n+    OutputStream outStream = new BufferedOutputStream(System.out);\n+\n+    void evaluateStdIn() {\n+        int count = 0;\n+        try (BufferedReader br = new BufferedReader(new InputStreamReader(System.in))) {\n+            String test = br.readLine();\n+            while (test != null) {\n+                boolean success = testCase(test, count);\n+                if (!success) {\n+                    System.err.println(\"FAILED testcase \"+count);\n+                }\n+                ++count;\n+                test = br.readLine();\n+            }\n+        } catch (IOException e) {\n+            System.err.println(count + \" FAILED : \" + e.toString());\n+        }\n+    }\n+\n+    void output(Slime result) {\n+        try {\n+            new JsonFormat(true).encode(outStream, result);\n+            outStream.write('\\n');\n+            outStream.flush();\n+        } catch (IOException e) {\n+            System.err.println(\"FAILED writing output: \"+e);\n+            System.exit(1);\n+        }\n+    }\n+        \n+    private boolean testCase(String test, int count) {\n+        boolean okAndEqual = false;\n+        try {\n+\t    Slime input = SlimeUtils.jsonToSlime(test);", "originalCommit": "de0f467a1f319972740c5b2945ebc0479faecb7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f468e2ce0c4c4845a308655ac80bd9fee14a5f2", "url": "https://github.com/vespa-engine/vespa/commit/7f468e2ce0c4c4845a308655ac80bd9fee14a5f2", "message": "fix copyright, untabify", "committedDate": "2020-11-10T16:17:02Z", "type": "commit"}, {"oid": "28d50714e116379985a18e6aea208e7e1a1754f2", "url": "https://github.com/vespa-engine/vespa/commit/28d50714e116379985a18e6aea208e7e1a1754f2", "message": "just compute our result", "committedDate": "2020-11-10T18:07:12Z", "type": "commit"}]}