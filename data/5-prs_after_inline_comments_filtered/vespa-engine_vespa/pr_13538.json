{"pr_number": 13538, "pr_title": "tenant creation for everyone in public (with restrictions/gated by flag)", "pr_createdAt": "2020-06-10T13:08:18Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13538", "timeline": [{"oid": "86d5d47b402e3cb8ebbd6214abe85838a12611f1", "url": "https://github.com/vespa-engine/vespa/commit/86d5d47b402e3cb8ebbd6214abe85838a12611f1", "message": "tenant creation for everyone in public (with restrictions/gated by flag)", "committedDate": "2020-06-10T13:06:43Z", "type": "commit"}, {"oid": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "url": "https://github.com/vespa-engine/vespa/commit/d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "message": "make hostedOperator/hostedSupporter inherit \"everyone\", update tests", "committedDate": "2020-06-10T13:42:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NDE5MA==", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438554190", "bodyText": "(((\uff3c\uff08\u2718\u0df4\u2718\uff09\uff0f)))", "author": "jonmv", "createdAt": "2020-06-11T05:42:32Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/role/Policy.java", "diffHunk": "@@ -48,15 +48,10 @@\n                   .on(PathGroup.user)\n                   .in(SystemName.main, SystemName.cd, SystemName.dev)),\n \n-    /** Access to create a tenant in select systems. */\n+    /** Access to create a tenant. */\n     tenantCreate(Privilege.grant(Action.create)\n                           .on(PathGroup.tenant)\n-                          .in(SystemName.main, SystemName.cd, SystemName.dev)), // TODO SystemName.all()\n-\n-    /** Access to create a tenant in public */\n-    tenantCreatePublic(Privilege.grant(Action.create)\n-                                .on(PathGroup.tenant)\n-                                .in(SystemName.PublicCd, SystemName.Public)),\n+                          .in(SystemName.all())),", "originalCommit": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU4NjczMg==", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438586732", "bodyText": "I must not fear. Fear is the mind-killer. Fear is the little-death that brings total obliteration. I will face my fear. I will permit it to pass over me and through me. And when it has gone past I will turn the inner eye to see its path. Where the fear has gone there will be nothing. Only I will remain.", "author": "andreer", "createdAt": "2020-06-11T07:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NDE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NTM5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438555397", "bodyText": "The operator policy already provides all priviliges.", "author": "jonmv", "createdAt": "2020-06-11T05:46:50Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/role/RoleDefinition.java", "diffHunk": "@@ -18,18 +18,17 @@\n  */\n public enum RoleDefinition {\n \n+    /** Base role which every user is part of. */\n+    everyone(Policy.classifiedRead,\n+            Policy.publicRead,\n+            Policy.user,\n+            Policy.tenantCreate),\n+\n     /** Deus ex machina. */\n-    hostedOperator(Policy.operator),\n+    hostedOperator(everyone, Policy.operator),", "originalCommit": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NTUwMg==", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438555502", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                hostedOperator(everyone, Policy.operator),\n          \n          \n            \n                hostedOperator(Policy.operator),", "author": "jonmv", "createdAt": "2020-06-11T05:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NTM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NjE2Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438556163", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                hostedSupporter(everyone, Policy.supporter),\n          \n          \n            \n                hostedSupporter(Policy.supporter),\n          \n      \n    \n    \n  \n\nAnyone who is authenticated is automatically a member of the everyone role as well, but I guess that could be considered an implementation detail.\nI do know someone disliked thet role inheritance, though, and wanted to kill it.", "author": "jonmv", "createdAt": "2020-06-11T05:49:36Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/role/RoleDefinition.java", "diffHunk": "@@ -18,18 +18,17 @@\n  */\n public enum RoleDefinition {\n \n+    /** Base role which every user is part of. */\n+    everyone(Policy.classifiedRead,\n+            Policy.publicRead,\n+            Policy.user,\n+            Policy.tenantCreate),\n+\n     /** Deus ex machina. */\n-    hostedOperator(Policy.operator),\n+    hostedOperator(everyone, Policy.operator),\n \n     /** Machina autem exspiravit. */\n-    hostedSupporter(Policy.supporter,\n-                    Policy.tenantCreatePublic),\n-\n-    /** Base role which every user is part of. */\n-    everyone(Policy.classifiedRead,\n-             Policy.publicRead,\n-             Policy.user,\n-             Policy.tenantCreate),\n+    hostedSupporter(everyone, Policy.supporter),", "originalCommit": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU4NzUyMg==", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438587522", "bodyText": "True, but that does not apply when the hostedSupporter role is used in unit tests. I'll look at the affected tests and consider changing it there instead.", "author": "andreer", "createdAt": "2020-06-11T07:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NjE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NzA5NA==", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438557094", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Override\n          \n          \n            \n                public Principal user() { return super.user(); }", "author": "jonmv", "createdAt": "2020-06-11T05:52:48Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/security/Auth0Credentials.java", "diffHunk": "@@ -0,0 +1,33 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.security;\n+\n+import com.yahoo.vespa.hosted.controller.api.role.Role;\n+\n+import java.security.Principal;\n+import java.util.Collections;\n+import java.util.Set;\n+\n+/**\n+ * Like {@link Credentials}, but we know the principal is authenticated by Auth0.\n+ * Also includes the set of roles for which the principal is a member.\n+ *\n+ * @author andreer\n+ */\n+public class Auth0Credentials extends Credentials {\n+\n+    private final Set<Role> roles;\n+\n+    public Auth0Credentials(Principal user, Set<Role> roles) {\n+        super(user);\n+        this.roles = Collections.unmodifiableSet(roles);\n+    }\n+\n+    @Override\n+    public Principal user() { return super.user(); }\n+", "originalCommit": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1ODQyMg==", "url": "https://github.com/vespa-engine/vespa/pull/13538#discussion_r438558422", "bodyText": "Yes!", "author": "jonmv", "createdAt": "2020-06-11T05:57:14Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/security/CloudAccessControl.java", "diffHunk": "@@ -48,14 +60,43 @@ public CloudTenant createTenant(TenantSpec tenantSpec, Credentials credentials,\n         return tenant;\n     }\n \n+    private void requireTenantCreationAllowed(Auth0Credentials auth0Credentials) {\n+        if (allowedByPrivilegedRole(auth0Credentials)) return;\n+\n+        if (!allowedByFeatureFlag(auth0Credentials)) {\n+            throw new ForbiddenException(\"You are not currently permitted to create tenants. Please contact the Vespa team to request access.\");\n+        }\n+\n+        if(administeredTenants(auth0Credentials) >= 3) {\n+            throw new ForbiddenException(\"You are already administering 3 tenants. If you need more, please contact the Vespa team.\");\n+        }\n+    }\n+\n+    private boolean allowedByPrivilegedRole(Auth0Credentials auth0Credentials) {\n+        return auth0Credentials.getRoles().stream()\n+                .map(Role::definition)\n+                .anyMatch(rd -> rd == hostedOperator || rd == hostedSupporter);\n+    }\n+\n+    private boolean allowedByFeatureFlag(Auth0Credentials auth0Credentials) {\n+        return enablePublicSignup.with(FetchVector.Dimension.CONSOLE_USER_EMAIL, auth0Credentials.user().getName()).value();\n+    }\n+\n+    private long administeredTenants(Auth0Credentials auth0Credentials) {\n+        return auth0Credentials.getRoles().stream()\n+                .map(Role::definition)\n+                .filter(rd -> rd == administrator)\n+                .count();\n+    }\n+\n     @Override\n     public Tenant updateTenant(TenantSpec tenantSpec, Credentials credentials, List<Tenant> existing, List<Application> applications) {\n         throw new UnsupportedOperationException(\"Update is not supported here, as it would entail changing the tenant name.\");\n     }\n \n     @Override\n     public void deleteTenant(TenantName tenant, Credentials credentials) {\n-        // Probably terminate customer subscription?\n+        // TODO: allow only if 0 resources, 0 balance", "originalCommit": "d1d33ef7fcb2068e76ceb1ea7ac78f181d6075c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ef9e2d67cb8cbf16a62852005781831c64483f0c", "url": "https://github.com/vespa-engine/vespa/commit/ef9e2d67cb8cbf16a62852005781831c64483f0c", "message": "operator policy already provides all privileges\n\nCo-authored-by: Jon Marius Venstad <jonmv@users.noreply.github.com>", "committedDate": "2020-06-11T07:11:10Z", "type": "commit"}, {"oid": "0d3cfffca709fa900aa7e58ee0fb3bf8f2a88f12", "url": "https://github.com/vespa-engine/vespa/commit/0d3cfffca709fa900aa7e58ee0fb3bf8f2a88f12", "message": "remove overridden method without changes\n\nCo-authored-by: Jon Marius Venstad <jonmv@users.noreply.github.com>", "committedDate": "2020-06-11T07:14:36Z", "type": "commit"}, {"oid": "b9f7420993a4f4ab0f9c770834a9f97fdf8253cd", "url": "https://github.com/vespa-engine/vespa/commit/b9f7420993a4f4ab0f9c770834a9f97fdf8253cd", "message": "always include feature flag value in user api", "committedDate": "2020-06-11T07:28:25Z", "type": "commit"}, {"oid": "28dd3a27d372034352d0e8895ae59058b2d0fcb2", "url": "https://github.com/vespa-engine/vespa/commit/28dd3a27d372034352d0e8895ae59058b2d0fcb2", "message": "remove use of role inheritance", "committedDate": "2020-06-11T08:03:40Z", "type": "commit"}, {"oid": "cee795a8086204239172380199147b6f74f738cd", "url": "https://github.com/vespa-engine/vespa/commit/cee795a8086204239172380199147b6f74f738cd", "message": "undo whitespace change", "committedDate": "2020-06-11T08:27:05Z", "type": "commit"}]}