{"pr_number": 3205, "pr_title": "[GEOT-6730]: Supporting external overviews on COG", "pr_createdAt": "2020-11-10T12:16:59Z", "pr_url": "https://github.com/geotools/geotools/pull/3205", "timeline": [{"oid": "b38b25d6470931127c4bd2459d659e4b77d1379a", "url": "https://github.com/geotools/geotools/commit/b38b25d6470931127c4bd2459d659e4b77d1379a", "message": "[GEOT-6730]: Supporting external overviews on COG", "committedDate": "2020-11-11T15:25:28Z", "type": "forcePushed"}, {"oid": "43c7e8af4e2a68e9920ca4561a470618ea3ecdca", "url": "https://github.com/geotools/geotools/commit/43c7e8af4e2a68e9920ca4561a470618ea3ecdca", "message": "[GEOT-6730]: Supporting external overviews on COG", "committedDate": "2020-11-11T16:30:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU0NDg3Nw==", "url": "https://github.com/geotools/geotools/pull/3205#discussion_r521544877", "bodyText": "Interesting bit... made me wonder about a few things that are related to COG, but not the ovr usage per se.\n\n\nThe coverage generated by image mosaic normally contains a list of files used to generated it. Is that still the case for COG?\nBut I guess it's the main file, not the ovr, that is listed there... still useful I believe.\n\n\nAlso wondering how CSW direct download would play with COGs.", "author": "aaime", "createdAt": "2020-11-11T18:06:50Z", "path": "modules/plugin/geotiff/src/test/java/org/geotools/gce/geotiff/GeoTiffReaderCogOnlineTest.java", "diffHunk": "@@ -61,4 +75,49 @@ public void testCogRead() throws URISyntaxException, IOException {\n         assertEquals(512, raster.getHeight());\n         assertEquals(1, raster.getNumBands());\n     }\n+\n+    @Test\n+    public void testCogOverview() throws URISyntaxException, IOException {\n+        GeoTiffReader reader = new GeoTiffReader(getInputProvider());\n+        assertEquals(\n+                \"LC08_L1TP_153075_20190515_20190515_01_RT_B2\", reader.getGridCoverageNames()[0]);\n+\n+        GeneralParameterValue[] params = new GeneralParameterValue[1];\n+        // Define a GridGeometry in order to reduce the output\n+        final ParameterValue<GridGeometry2D> gg =\n+                AbstractGridFormat.READ_GRIDGEOMETRY2D.createValue();\n+        final GeneralEnvelope envelope = reader.getOriginalEnvelope();\n+        final Dimension dim = new Dimension();\n+        dim.setSize(\n+                reader.getOriginalGridRange().getSpan(0) / 24,\n+                reader.getOriginalGridRange().getSpan(1) / 24);\n+        final Rectangle rasterArea = ((GridEnvelope2D) reader.getOriginalGridRange());\n+        rasterArea.setSize(dim);\n+        final GridEnvelope2D range = new GridEnvelope2D(rasterArea);\n+        gg.setValue(new GridGeometry2D(range, envelope));\n+        params[0] = gg;\n+\n+        GridCoverage2D coverage = reader.read(params);\n+        assertNotNull(coverage);\n+        RenderedImage image = coverage.getRenderedImage();\n+        int numTileX = image.getNumXTiles();\n+        int numTileY = image.getNumYTiles();\n+\n+        CogImageReader imageReader = (CogImageReader) image.getProperty(\"JAI.ImageReader\");", "originalCommit": "43c7e8af4e2a68e9920ca4561a470618ea3ecdca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA1NzIyNQ==", "url": "https://github.com/geotools/geotools/pull/3205#discussion_r522057225", "bodyText": "Updated to deal with that, reporting the COG Url. Note that ImageMosaic reports .ovr instead, so it will be the same for COG\n\n\nAll GT APIs used by DirectDownload are File-related (FileGroups, FileGroupProvider, FileInfo and so on). We need to revisit the GT API to have it working for cog too", "author": "dromagnoli", "createdAt": "2020-11-12T12:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU0NDg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU0NTk5Nw==", "url": "https://github.com/geotools/geotools/pull/3205#discussion_r521545997", "bodyText": "I'm not familiar with this bit of code, but the change gives me the impression that before the code allowed to have two different types of format for image and ovr (which is a thing, I believe that GDAL handles jpeg as main image but tiff as ovr for example). While the updated code assumes they are the same?", "author": "aaime", "createdAt": "2020-11-11T18:08:47Z", "path": "modules/plugin/imagemosaic/src/main/java/org/geotools/gce/imagemosaic/GranuleDescriptor.java", "diffHunk": "@@ -1060,15 +1061,13 @@ public GranuleLoadingResult loadRaster(\n                 granuleURLUpdated = ovrProvider.getOvrURL();\n                 assert ovrProvider.getExternalOverviewInputStreamSpi() != null\n                         : \"no cachedStreamSPI available for external overview!\";\n-                inStream =\n+                SourceSPIProvider sourceSpiProvider =", "originalCommit": "43c7e8af4e2a68e9920ca4561a470618ea3ecdca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA1NjA3Ng==", "url": "https://github.com/geotools/geotools/pull/3205#discussion_r522056076", "bodyText": "Fixed.", "author": "dromagnoli", "createdAt": "2020-11-12T12:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU0NTk5Nw=="}], "type": "inlineReview"}, {"oid": "350f46a9ed723f5b9567a9c54c5671f352f2ea8d", "url": "https://github.com/geotools/geotools/commit/350f46a9ed723f5b9567a9c54c5671f352f2ea8d", "message": "[GEOT-6730]: Supporting external overviews on COG", "committedDate": "2020-11-12T12:03:14Z", "type": "forcePushed"}, {"oid": "9a22f37d089487a32a975e47ba192ce1727a44c7", "url": "https://github.com/geotools/geotools/commit/9a22f37d089487a32a975e47ba192ce1727a44c7", "message": "[GEOT-6730]: Supporting external overviews on COG", "committedDate": "2020-11-12T13:45:08Z", "type": "forcePushed"}, {"oid": "5b2595878ab423e46c37e2f80cb1403fea2e689a", "url": "https://github.com/geotools/geotools/commit/5b2595878ab423e46c37e2f80cb1403fea2e689a", "message": "[GEOT-6730]: Supporting external overviews on COG", "committedDate": "2020-11-12T17:36:40Z", "type": "forcePushed"}, {"oid": "ed6989167f576685f94a6b2954b49664426bf212", "url": "https://github.com/geotools/geotools/commit/ed6989167f576685f94a6b2954b49664426bf212", "message": "[GEOT-6730]: Supporting external overviews on COG", "committedDate": "2020-11-13T11:09:23Z", "type": "commit"}, {"oid": "ed6989167f576685f94a6b2954b49664426bf212", "url": "https://github.com/geotools/geotools/commit/ed6989167f576685f94a6b2954b49664426bf212", "message": "[GEOT-6730]: Supporting external overviews on COG", "committedDate": "2020-11-13T11:09:23Z", "type": "forcePushed"}]}