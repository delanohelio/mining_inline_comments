{"pr_number": 2840, "pr_title": "[GEOT-6533] Selection of source matrixset when cascading WMTS layers does not take into account Longitudefirst CRSs", "pr_createdAt": "2020-03-18T21:37:02Z", "pr_url": "https://github.com/geotools/geotools/pull/2840", "timeline": [{"oid": "ae198ddada587dc0fa3c7df801a8f7b79179503f", "url": "https://github.com/geotools/geotools/commit/ae198ddada587dc0fa3c7df801a8f7b79179503f", "message": "GEOT-6514 Updates to enable information from WMTS Getcapabilities calls to pass through to the WMTSService class.", "committedDate": "2020-03-18T20:48:17Z", "type": "commit"}, {"oid": "530f41cd23442c834ad8fc154d17051ec574380c", "url": "https://github.com/geotools/geotools/commit/530f41cd23442c834ad8fc154d17051ec574380c", "message": "Changed the way in which the source matrixset is selected so that it compares the request SRS and the matrixset SRS names rather than comparing the whole CRS. This will reduce the amount of transformation that will be needed when the tiles are returned.\n\nAlso added unit tests and some spelling corrections", "committedDate": "2020-03-18T20:58:48Z", "type": "commit"}, {"oid": "ce9f8a4098f0866c466812a2da3d88dfb900a140", "url": "https://github.com/geotools/geotools/commit/ce9f8a4098f0866c466812a2da3d88dfb900a140", "message": "Revert \"GEOT-6514 Updates to enable information from WMTS Getcapabilities calls to pass through to the WMTSService class.\"\n\nThis reverts commit 3a9ad1cb", "committedDate": "2020-03-18T21:26:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0Njg1Nw==", "url": "https://github.com/geotools/geotools/pull/2840#discussion_r396346857", "bodyText": "Tests should not be writing to system.out, use the logging framework instead, or if you need it for development, keep the line that does the printout commented out, using System.out directly.", "author": "aaime", "createdAt": "2020-03-23T10:25:30Z", "path": "modules/extension/wmts/src/test/java/org/geotools/ows/wmts/WebMapTileServerTest.java", "diffHunk": "@@ -16,21 +16,27 @@\n  */\n package org.geotools.ows.wmts;\n \n-import static junit.framework.TestCase.assertEquals;\n-import static junit.framework.TestCase.assertNotNull;\n-import static junit.framework.TestCase.assertNull;\n+import static junit.framework.TestCase.*;\n import static org.geotools.ows.wmts.WMTSTestUtils.createCapabilities;\n \n+import java.io.PrintStream;\n+import java.util.Set;\n import org.geotools.geometry.GeneralEnvelope;\n+import org.geotools.geometry.jts.ReferencedEnvelope;\n import org.geotools.ows.wms.Layer;\n import org.geotools.ows.wmts.model.WMTSCapabilities;\n+import org.geotools.ows.wmts.model.WMTSLayer;\n+import org.geotools.ows.wmts.request.GetTileRequest;\n import org.geotools.referencing.CRS;\n+import org.geotools.tile.Tile;\n import org.junit.Test;\n import org.opengis.referencing.crs.CoordinateReferenceSystem;\n \n /** @author Emanuele Tajariol (etj at geo-solutions dot it) */\n public class WebMapTileServerTest {\n \n+    private static PrintStream out = System.out;", "originalCommit": "ce9f8a4098f0866c466812a2da3d88dfb900a140", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0OTExOA==", "url": "https://github.com/geotools/geotools/pull/2840#discussion_r396749118", "bodyText": "Removed all print statements. I only needed them for development and no need for them to be left in and commented out", "author": "singhdan", "createdAt": "2020-03-23T20:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0Njg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0NzMxNw==", "url": "https://github.com/geotools/geotools/pull/2840#discussion_r396347317", "bodyText": "No need to convert it at every round in the loop, could be done outside.", "author": "aaime", "createdAt": "2020-03-23T10:26:19Z", "path": "modules/extension/wmts/src/main/java/org/geotools/ows/wmts/request/AbstractGetTileRequest.java", "diffHunk": "@@ -351,12 +351,15 @@ private TileMatrixSet selectMatrixSet() throws ServiceException, RuntimeExceptio\n             }\n         }\n \n-        // If the layer provides the requested CRS, use it\n+        // See if the layer supports the requested SRS. Matching against the SRS rather than the\n+        // full CRS will avoid missing matches due to Longitude first being set on the request\n+        // CRS and therefore minimise transformations that need to be performed on the received tile\n         for (TileMatrixSet matrixSet : capabilities.getMatrixSets()) {\n \n             CoordinateReferenceSystem matrixCRS = matrixSet.getCoordinateReferenceSystem();\n-\n-            if (CRS.equalsIgnoreMetadata(requestCRS, matrixCRS)) { // matching SRS\n+            String requestSRS = CRS.toSRS(requestCRS);", "originalCommit": "ce9f8a4098f0866c466812a2da3d88dfb900a140", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0OTI0NA==", "url": "https://github.com/geotools/geotools/pull/2840#discussion_r396749244", "bodyText": "Agreed, moved to outside the loop", "author": "singhdan", "createdAt": "2020-03-23T20:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0NzMxNw=="}], "type": "inlineReview"}, {"oid": "846818173716ddb177e9a057b85ab7f319ea5f17", "url": "https://github.com/geotools/geotools/commit/846818173716ddb177e9a057b85ab7f319ea5f17", "message": "Addressing comments: Removed system.out statements as they were for development only and not needed anymore. Moved call to get requestSRS outside of the for loop", "committedDate": "2020-03-23T20:48:23Z", "type": "commit"}]}