{"pr_number": 1129, "pr_title": "HDDS-3741. Reload old OM state if Install Snapshot from Leader fails", "pr_createdAt": "2020-06-25T21:53:17Z", "pr_url": "https://github.com/apache/ozone/pull/1129", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MjUyOA==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r447272528", "bodyText": "Let's log an error here.", "author": "arp7", "createdAt": "2020-06-29T21:45:47Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -2999,32 +3000,15 @@ public TermIndex installSnapshot(String leaderId) {\n     }\n \n     DBCheckpoint omDBcheckpoint = getDBCheckpointFromLeader(leaderId);\n-    Path newDBlocation = omDBcheckpoint.getCheckpointLocation();\n+    Path newDBLocation = omDBcheckpoint.getCheckpointLocation();\n \n     LOG.info(\"Downloaded checkpoint from Leader {}, in to the location {}\",\n-        leaderId, newDBlocation);\n+        leaderId, newDBLocation);\n \n-    // Check if current ratis log index is smaller than the downloaded\n-    // checkpoint transaction index. If yes, proceed by stopping the ratis\n-    // server so that the OM state can be re-initialized. If no, then do not\n-    // proceed with installSnapshot.\n+    OMTransactionInfo omTransactionInfo = getTransactionInfoFromDB(\n+        newDBLocation);\n \n-    OMTransactionInfo omTransactionInfo = null;\n-\n-    Path dbDir = newDBlocation.getParent();\n-    if (dbDir == null) {\n-      LOG.error(\"Incorrect DB location path {} received from checkpoint.\",\n-          newDBlocation);\n-      return null;\n-    }\n-\n-    try {\n-      omTransactionInfo =\n-          OzoneManagerRatisUtils.getTransactionInfoFromDownloadedSnapshot(\n-              configuration, dbDir);\n-    } catch (Exception ex) {\n-      LOG.error(\"Failed during opening downloaded snapshot from \" +\n-          \"{} to obtain transaction index\", newDBlocation, ex);\n+    if (omTransactionInfo == null) {", "originalCommit": "f4326767238fca5b3170adb81989f87327d127b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDA0MA==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r447280040", "bodyText": "Before calling reloadState check for existence of temp_marker file. Also on OM restart.", "author": "arp7", "createdAt": "2020-06-29T22:03:25Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3040,45 +3024,61 @@ public TermIndex installSnapshot(String leaderId) {\n     } catch (Exception e) {\n       LOG.error(\"Failed to stop/ pause the services. Cannot proceed with \" +\n           \"installing the new checkpoint.\", e);\n+\n+      // During stopServices, if KeyManager was stopped successfully and\n+      // OMMetadataManager stop failed, we should restart the KeyManager.\n+      keyManager.start(configuration);\n+\n       return null;\n     }\n \n-    //TODO: un-pause SM if any failures and retry?\n+    File dbBackup;\n+    TermIndex termIndex = omRatisServer.getLastAppliedTermIndex();\n+    long currentTerm = termIndex.getTerm();\n+    long lastAppliedIndex = termIndex.getIndex();\n+    boolean loadSuccess = false;\n \n-    long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n+    try {\n+      // Check if current applied log index is smaller than the downloaded\n+      // checkpoint transaction index. If yes, proceed by stopping the ratis\n+      // server so that the OM state can be re-initialized. If no then do not\n+      // proceed with installSnapshot.\n+      boolean canProceed = OzoneManagerRatisUtils.verifyTransactionInfo(\n+          omTransactionInfo, lastAppliedIndex, leaderId, newDBLocation);\n+      if (!canProceed) {\n+        return null;\n+      }\n \n-    boolean canProceed =\n-        OzoneManagerRatisUtils.verifyTransactionInfo(omTransactionInfo,\n-        lastAppliedIndex, leaderId, newDBlocation);\n+      try {\n+        dbBackup = replaceOMDBWithCheckpoint(lastAppliedIndex, oldDBLocation,\n+            newDBLocation);\n+      } catch (Exception e) {\n+        LOG.error(\"OM DB checkpoint replacement with new downloaded \" +\n+            \"checkpoint failed.\", e);\n+        return null;\n+      }\n \n-    // If downloaded DB has transaction info less than current one, return.\n-    if (!canProceed) {\n-      return null;\n+      loadSuccess = true;\n+    } finally {\n+      if (!loadSuccess) {\n+        omRatisServer.getOmStateMachine().unpause(lastAppliedIndex,\n+            currentTerm);\n+      }\n     }\n \n     long leaderIndex = omTransactionInfo.getTransactionIndex();\n     long leaderTerm = omTransactionInfo.getCurrentTerm();\n \n-\n-    File dbBackup;\n-    try {\n-      dbBackup = replaceOMDBWithCheckpoint(lastAppliedIndex, oldDBLocation,\n-          newDBlocation);\n-    } catch (Exception e) {\n-      LOG.error(\"OM DB checkpoint replacement with new downloaded checkpoint \" +\n-          \"failed.\", e);\n-      return null;\n-    }\n-\n     // Reload the OM DB store with the new checkpoint.\n     // Restart (unpause) the state machine and update its last applied index\n     // to the installed checkpoint's snapshot index.\n     try {\n       reloadOMState(leaderIndex, leaderTerm);", "originalCommit": "f4326767238fca5b3170adb81989f87327d127b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDQ4OQ==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r447280489", "bodyText": "replaceOMDBWithCheckpoint contract should be that it either leaves the current state or the old state. If it leaves inconsistent state then it should also leave some persistent marker on disk so OM doesn't try to restart with a bad checkpoint.", "author": "arp7", "createdAt": "2020-06-29T22:04:25Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3040,45 +3024,61 @@ public TermIndex installSnapshot(String leaderId) {\n     } catch (Exception e) {\n       LOG.error(\"Failed to stop/ pause the services. Cannot proceed with \" +\n           \"installing the new checkpoint.\", e);\n+\n+      // During stopServices, if KeyManager was stopped successfully and\n+      // OMMetadataManager stop failed, we should restart the KeyManager.\n+      keyManager.start(configuration);\n+\n       return null;\n     }\n \n-    //TODO: un-pause SM if any failures and retry?\n+    File dbBackup;\n+    TermIndex termIndex = omRatisServer.getLastAppliedTermIndex();\n+    long currentTerm = termIndex.getTerm();\n+    long lastAppliedIndex = termIndex.getIndex();\n+    boolean loadSuccess = false;\n \n-    long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n+    try {\n+      // Check if current applied log index is smaller than the downloaded\n+      // checkpoint transaction index. If yes, proceed by stopping the ratis\n+      // server so that the OM state can be re-initialized. If no then do not\n+      // proceed with installSnapshot.\n+      boolean canProceed = OzoneManagerRatisUtils.verifyTransactionInfo(\n+          omTransactionInfo, lastAppliedIndex, leaderId, newDBLocation);\n+      if (!canProceed) {\n+        return null;\n+      }\n \n-    boolean canProceed =\n-        OzoneManagerRatisUtils.verifyTransactionInfo(omTransactionInfo,\n-        lastAppliedIndex, leaderId, newDBlocation);\n+      try {\n+        dbBackup = replaceOMDBWithCheckpoint(lastAppliedIndex, oldDBLocation,", "originalCommit": "f4326767238fca5b3170adb81989f87327d127b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4NDcxMg==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r447284712", "bodyText": "Also the marker file should be created before starting the move operations, and deleted on success.", "author": "arp7", "createdAt": "2020-06-29T22:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDY4OQ==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r447280689", "bodyText": "Remove this unpause, we already do a reload and unpause below.", "author": "arp7", "createdAt": "2020-06-29T22:04:51Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3040,45 +3024,61 @@ public TermIndex installSnapshot(String leaderId) {\n     } catch (Exception e) {\n       LOG.error(\"Failed to stop/ pause the services. Cannot proceed with \" +\n           \"installing the new checkpoint.\", e);\n+\n+      // During stopServices, if KeyManager was stopped successfully and\n+      // OMMetadataManager stop failed, we should restart the KeyManager.\n+      keyManager.start(configuration);\n+\n       return null;\n     }\n \n-    //TODO: un-pause SM if any failures and retry?\n+    File dbBackup;\n+    TermIndex termIndex = omRatisServer.getLastAppliedTermIndex();\n+    long currentTerm = termIndex.getTerm();\n+    long lastAppliedIndex = termIndex.getIndex();\n+    boolean loadSuccess = false;\n \n-    long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n+    try {\n+      // Check if current applied log index is smaller than the downloaded\n+      // checkpoint transaction index. If yes, proceed by stopping the ratis\n+      // server so that the OM state can be re-initialized. If no then do not\n+      // proceed with installSnapshot.\n+      boolean canProceed = OzoneManagerRatisUtils.verifyTransactionInfo(\n+          omTransactionInfo, lastAppliedIndex, leaderId, newDBLocation);\n+      if (!canProceed) {\n+        return null;\n+      }\n \n-    boolean canProceed =\n-        OzoneManagerRatisUtils.verifyTransactionInfo(omTransactionInfo,\n-        lastAppliedIndex, leaderId, newDBlocation);\n+      try {\n+        dbBackup = replaceOMDBWithCheckpoint(lastAppliedIndex, oldDBLocation,\n+            newDBLocation);\n+      } catch (Exception e) {\n+        LOG.error(\"OM DB checkpoint replacement with new downloaded \" +\n+            \"checkpoint failed.\", e);\n+        return null;\n+      }\n \n-    // If downloaded DB has transaction info less than current one, return.\n-    if (!canProceed) {\n-      return null;\n+      loadSuccess = true;\n+    } finally {\n+      if (!loadSuccess) {", "originalCommit": "f4326767238fca5b3170adb81989f87327d127b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MTQyMg==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r447281422", "bodyText": "Move these inside the try block, just after you invoke replaceOMDBWithCheckpoint. Else these variables should be left to values that reflect the old checkpoint.", "author": "arp7", "createdAt": "2020-06-29T22:06:19Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3040,45 +3024,61 @@ public TermIndex installSnapshot(String leaderId) {\n     } catch (Exception e) {\n       LOG.error(\"Failed to stop/ pause the services. Cannot proceed with \" +\n           \"installing the new checkpoint.\", e);\n+\n+      // During stopServices, if KeyManager was stopped successfully and\n+      // OMMetadataManager stop failed, we should restart the KeyManager.\n+      keyManager.start(configuration);\n+\n       return null;\n     }\n \n-    //TODO: un-pause SM if any failures and retry?\n+    File dbBackup;\n+    TermIndex termIndex = omRatisServer.getLastAppliedTermIndex();\n+    long currentTerm = termIndex.getTerm();\n+    long lastAppliedIndex = termIndex.getIndex();\n+    boolean loadSuccess = false;\n \n-    long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n+    try {\n+      // Check if current applied log index is smaller than the downloaded\n+      // checkpoint transaction index. If yes, proceed by stopping the ratis\n+      // server so that the OM state can be re-initialized. If no then do not\n+      // proceed with installSnapshot.\n+      boolean canProceed = OzoneManagerRatisUtils.verifyTransactionInfo(\n+          omTransactionInfo, lastAppliedIndex, leaderId, newDBLocation);\n+      if (!canProceed) {\n+        return null;\n+      }\n \n-    boolean canProceed =\n-        OzoneManagerRatisUtils.verifyTransactionInfo(omTransactionInfo,\n-        lastAppliedIndex, leaderId, newDBlocation);\n+      try {\n+        dbBackup = replaceOMDBWithCheckpoint(lastAppliedIndex, oldDBLocation,\n+            newDBLocation);\n+      } catch (Exception e) {\n+        LOG.error(\"OM DB checkpoint replacement with new downloaded \" +\n+            \"checkpoint failed.\", e);\n+        return null;\n+      }\n \n-    // If downloaded DB has transaction info less than current one, return.\n-    if (!canProceed) {\n-      return null;\n+      loadSuccess = true;\n+    } finally {\n+      if (!loadSuccess) {\n+        omRatisServer.getOmStateMachine().unpause(lastAppliedIndex,\n+            currentTerm);\n+      }\n     }\n \n     long leaderIndex = omTransactionInfo.getTransactionIndex();", "originalCommit": "f4326767238fca5b3170adb81989f87327d127b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MTU1Mw==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r447281553", "bodyText": "Don't need loadSuccess any more.", "author": "arp7", "createdAt": "2020-06-29T22:06:36Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3040,45 +3024,61 @@ public TermIndex installSnapshot(String leaderId) {\n     } catch (Exception e) {\n       LOG.error(\"Failed to stop/ pause the services. Cannot proceed with \" +\n           \"installing the new checkpoint.\", e);\n+\n+      // During stopServices, if KeyManager was stopped successfully and\n+      // OMMetadataManager stop failed, we should restart the KeyManager.\n+      keyManager.start(configuration);\n+\n       return null;\n     }\n \n-    //TODO: un-pause SM if any failures and retry?\n+    File dbBackup;\n+    TermIndex termIndex = omRatisServer.getLastAppliedTermIndex();\n+    long currentTerm = termIndex.getTerm();\n+    long lastAppliedIndex = termIndex.getIndex();\n+    boolean loadSuccess = false;\n \n-    long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n+    try {\n+      // Check if current applied log index is smaller than the downloaded\n+      // checkpoint transaction index. If yes, proceed by stopping the ratis\n+      // server so that the OM state can be re-initialized. If no then do not\n+      // proceed with installSnapshot.\n+      boolean canProceed = OzoneManagerRatisUtils.verifyTransactionInfo(\n+          omTransactionInfo, lastAppliedIndex, leaderId, newDBLocation);\n+      if (!canProceed) {\n+        return null;\n+      }\n \n-    boolean canProceed =\n-        OzoneManagerRatisUtils.verifyTransactionInfo(omTransactionInfo,\n-        lastAppliedIndex, leaderId, newDBlocation);\n+      try {\n+        dbBackup = replaceOMDBWithCheckpoint(lastAppliedIndex, oldDBLocation,\n+            newDBLocation);\n+      } catch (Exception e) {\n+        LOG.error(\"OM DB checkpoint replacement with new downloaded \" +\n+            \"checkpoint failed.\", e);\n+        return null;\n+      }\n \n-    // If downloaded DB has transaction info less than current one, return.\n-    if (!canProceed) {\n-      return null;\n+      loadSuccess = true;", "originalCommit": "f4326767238fca5b3170adb81989f87327d127b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b4bdc3bfe23e2b8d8df0d1fe944e41606c876ffd", "url": "https://github.com/apache/ozone/commit/b4bdc3bfe23e2b8d8df0d1fe944e41606c876ffd", "message": "review fixes", "committedDate": "2020-06-30T19:15:11Z", "type": "forcePushed"}, {"oid": "d2f3d7c9e2bfcac17f93ceb9217aea82c6e058d8", "url": "https://github.com/apache/ozone/commit/d2f3d7c9e2bfcac17f93ceb9217aea82c6e058d8", "message": "fix can't proceed case", "committedDate": "2020-07-10T18:46:36Z", "type": "forcePushed"}, {"oid": "e45b5f8d951d0c5fb3e3b4aca02f5fc31a299ee3", "url": "https://github.com/apache/ozone/commit/e45b5f8d951d0c5fb3e3b4aca02f5fc31a299ee3", "message": "unit test for testing system exit on installing corrupted DB", "committedDate": "2020-07-10T23:07:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzODI2Ng==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r453138266", "bodyText": "Can you add a @VisibleForTesting annotation here?", "author": "arp7", "createdAt": "2020-07-11T01:27:12Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3314,4 +3352,8 @@ private void startJVMPauseMonitor() {\n     jvmPauseMonitor.init(configuration);\n     jvmPauseMonitor.start();\n   }\n+\n+  void setExitManagerForTesting(ExitManager exitManagerForTesting) {", "originalCommit": "a026c6b7049405755da0c40c75a579145ae1bc44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzODY1NQ==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r453138655", "bodyText": "Should we use ExitManager here?", "author": "arp7", "createdAt": "2020-07-11T01:30:47Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OmMetadataManagerImpl.java", "diffHunk": "@@ -249,6 +252,20 @@ public void start(OzoneConfiguration configuration) throws IOException {\n     if (store == null) {\n       File metaDir = OMStorage.getOmDbDir(configuration);\n \n+      // Check if there is a DB Inconsistent Marker in the metaDir. This\n+      // marker indicates that the DB is in an inconsistent state and hence\n+      // the OM process should be terminated.\n+      File markerFile = new File(metaDir, DB_TRANSIENT_MARKER);\n+      if (Files.exists(markerFile.toPath())) {\n+        LOG.error(\"File {} marks that OM DB is in an inconsistent state.\");\n+        // Note - The marker file should be deleted only after fixing the DB.\n+        // In an HA setup, this can be done by replacing this DB with a\n+        // checkpoint from another OM.\n+        String errorMsg = \"Cannot load OM DB as it is in an inconsistent \" +\n+            \"state.\";\n+        ExitUtils.terminate(1, errorMsg, LOG);", "originalCommit": "a026c6b7049405755da0c40c75a579145ae1bc44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQzMzU4Mg==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r455433582", "bodyText": "Nitpick: why not just markerFile.exists()?", "author": "arp7", "createdAt": "2020-07-16T00:04:42Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OmMetadataManagerImpl.java", "diffHunk": "@@ -249,6 +252,20 @@ public void start(OzoneConfiguration configuration) throws IOException {\n     if (store == null) {\n       File metaDir = OMStorage.getOmDbDir(configuration);\n \n+      // Check if there is a DB Inconsistent Marker in the metaDir. This\n+      // marker indicates that the DB is in an inconsistent state and hence\n+      // the OM process should be terminated.\n+      File markerFile = new File(metaDir, DB_TRANSIENT_MARKER);\n+      if (Files.exists(markerFile.toPath())) {", "originalCommit": "a026c6b7049405755da0c40c75a579145ae1bc44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQzNDY3Ng==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r455434676", "bodyText": "Print the dbPath in the exception message to make debugging easier in case this happens.", "author": "arp7", "createdAt": "2020-07-16T00:08:30Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/utils/OzoneManagerRatisUtils.java", "diffHunk": "@@ -228,15 +228,34 @@ public static Status exceptionToResponseStatus(IOException exception) {\n   }\n \n   /**\n-   * Obtain Transaction info from downloaded snapshot DB.\n+   * Obtain OMTransactionInfo from Checkpoint.\n+   */\n+  public static OMTransactionInfo getTrxnInfoFromCheckpoint(\n+      OzoneConfiguration conf, Path dbPath) throws Exception {\n+    Path dbDir = dbPath.getParent();\n+    String dbName = dbPath.getFileName().toString();\n+    if (dbDir == null) {\n+      throw new IOException(\"Checkpoint {} does not have proper DB location\");", "originalCommit": "a026c6b7049405755da0c40c75a579145ae1bc44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQzNjY0NA==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r455436644", "bodyText": "Did we change the snapshot file name convention in this jira?", "author": "arp7", "createdAt": "2020-07-16T00:14:58Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/snapshot/OzoneManagerSnapshotProvider.java", "diffHunk": "@@ -113,8 +113,10 @@ public OzoneManagerSnapshotProvider(MutableConfigurationSource conf,\n   public DBCheckpoint getOzoneManagerDBSnapshot(String leaderOMNodeID)\n       throws IOException {\n     String snapshotTime = Long.toString(System.currentTimeMillis());\n-    String snapshotFileName = Paths.get(omSnapshotDir.getAbsolutePath(),\n-        snapshotTime, OM_DB_NAME).toFile().getAbsolutePath();\n+    String snapshotFileName = OM_DB_NAME + \"-\" + leaderOMNodeID", "originalCommit": "a026c6b7049405755da0c40c75a579145ae1bc44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0Mjg0Nw==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r455442847", "bodyText": "On successful restart we should clear any old backups.", "author": "arp7", "createdAt": "2020-07-16T00:36:59Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3041,58 +3047,74 @@ public TermIndex installSnapshot(String leaderId) {\n       omRatisServer.getOmStateMachine().pause();\n     } catch (Exception e) {\n       LOG.error(\"Failed to stop/ pause the services. Cannot proceed with \" +\n-          \"installing the new checkpoint.\", e);\n-      return null;\n-    }\n-\n-    //TODO: un-pause SM if any failures and retry?\n-\n-    long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n-\n-    boolean canProceed =\n-        OzoneManagerRatisUtils.verifyTransactionInfo(omTransactionInfo,\n-        lastAppliedIndex, leaderId, newDBlocation);\n-\n-    // If downloaded DB has transaction info less than current one, return.\n-    if (!canProceed) {\n-      return null;\n+          \"installing the new checkpoint.\");\n+      // During stopServices, if KeyManager was stopped successfully and\n+      // OMMetadataManager stop failed, we should restart the KeyManager.\n+      keyManager.start(configuration);\n+      throw e;\n     }\n \n-    long leaderIndex = omTransactionInfo.getTransactionIndex();\n-    long leaderTerm = omTransactionInfo.getCurrentTerm();\n+    File dbBackup = null;\n+    TermIndex termIndex = omRatisServer.getLastAppliedTermIndex();\n+    long term = termIndex.getTerm();\n+    long lastAppliedIndex = termIndex.getIndex();\n \n+    // Check if current applied log index is smaller than the downloaded\n+    // checkpoint transaction index. If yes, proceed by stopping the ratis\n+    // server so that the OM state can be re-initialized. If no then do not\n+    // proceed with installSnapshot.\n+    boolean canProceed = OzoneManagerRatisUtils.verifyTransactionInfo(\n+        checkpointTrxnInfo, lastAppliedIndex, leaderId, checkpointLocation);\n \n-    File dbBackup;\n-    try {\n-      dbBackup = replaceOMDBWithCheckpoint(lastAppliedIndex, oldDBLocation,\n-          newDBlocation);\n-    } catch (Exception e) {\n-      LOG.error(\"OM DB checkpoint replacement with new downloaded checkpoint \" +\n-          \"failed.\", e);\n-      return null;\n+    if (canProceed) {\n+      try {\n+        dbBackup = replaceOMDBWithCheckpoint(lastAppliedIndex, oldDBLocation,\n+            checkpointLocation);\n+        term = checkpointTrxnInfo.getTerm();\n+        lastAppliedIndex = checkpointTrxnInfo.getTransactionIndex();\n+        LOG.info(\"Replaced DB with checkpoint from OM: {}, term: {}, index: {}\",\n+            leaderId, term, lastAppliedIndex);\n+      } catch (Exception e) {\n+        LOG.error(\"Failed to install Snapshot from {} as OM failed to replace\" +\n+            \" DB with downloaded checkpoint. Reloading old OM state.\", e);\n+      }\n+    } else {\n+      LOG.warn(\"Cannot proceed with InstallSnapshot as OM is at TermIndex {} \" +\n+          \"and checkpoint has lower TermIndex {}. Reloading old state of OM.\",\n+          termIndex, checkpointTrxnInfo.getTermIndex());\n     }\n \n     // Reload the OM DB store with the new checkpoint.\n     // Restart (unpause) the state machine and update its last applied index\n     // to the installed checkpoint's snapshot index.\n     try {\n-      reloadOMState(leaderIndex, leaderTerm);\n-      omRatisServer.getOmStateMachine().unpause(leaderIndex, leaderTerm);\n-    } catch (IOException e) {\n-      LOG.error(\"Failed to reload OM state with new DB checkpoint.\", e);\n-      return null;\n+      reloadOMState(lastAppliedIndex, term);\n+      omRatisServer.getOmStateMachine().unpause(lastAppliedIndex, term);\n+      LOG.info(\"Reloaded OM state with Term: {} and Index: {}\", term,\n+          lastAppliedIndex);\n+    } catch (IOException ex) {\n+      String errorMsg = \"Failed to reload OM state and instantiate services.\";\n+      exitManager.exitSystem(1, errorMsg, ex, LOG);\n     }\n \n     // Delete the backup DB\n     try {\n-      FileUtils.deleteFully(dbBackup);\n+      if (dbBackup != null) {\n+        FileUtils.deleteFully(dbBackup);\n+      }", "originalCommit": "a026c6b7049405755da0c40c75a579145ae1bc44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1MDA5NQ==", "url": "https://github.com/apache/ozone/pull/1129#discussion_r455950095", "bodyText": "Let's do this in a followup jira. Ok to commit this one.", "author": "arp7", "createdAt": "2020-07-16T17:24:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0Mjg0Nw=="}], "type": "inlineReview"}, {"oid": "7ffaae95076fc3ad9315355efeabb00868b503fb", "url": "https://github.com/apache/ozone/commit/7ffaae95076fc3ad9315355efeabb00868b503fb", "message": "HDDS-3741. Reload old OM state if Install Snapshot from Leader fails", "committedDate": "2020-07-17T18:11:51Z", "type": "commit"}, {"oid": "be58f0b9a46137d3f064d729e11589ba386e66dc", "url": "https://github.com/apache/ozone/commit/be58f0b9a46137d3f064d729e11589ba386e66dc", "message": "review fixes", "committedDate": "2020-07-17T18:11:51Z", "type": "commit"}, {"oid": "fd1a90822b44032b450f194150505db337517fe9", "url": "https://github.com/apache/ozone/commit/fd1a90822b44032b450f194150505db337517fe9", "message": "fix can't proceed case", "committedDate": "2020-07-17T18:11:51Z", "type": "commit"}, {"oid": "a0ff810022f815591f7713ac3be81a92f0b95785", "url": "https://github.com/apache/ozone/commit/a0ff810022f815591f7713ac3be81a92f0b95785", "message": "Refactor code to add unit test", "committedDate": "2020-07-17T18:11:51Z", "type": "commit"}, {"oid": "a4c9bf67ab22aa6fb92c34eecfe33cdf85606fa6", "url": "https://github.com/apache/ozone/commit/a4c9bf67ab22aa6fb92c34eecfe33cdf85606fa6", "message": "unit test for testing system exit on installing corrupted DB", "committedDate": "2020-07-17T18:12:54Z", "type": "commit"}, {"oid": "bcadd13812a3aeb29f307c4f2ee32dd8910ef62e", "url": "https://github.com/apache/ozone/commit/bcadd13812a3aeb29f307c4f2ee32dd8910ef62e", "message": "CI fixes", "committedDate": "2020-07-17T18:13:29Z", "type": "commit"}, {"oid": "e88121aa6e0844a91ca297ac3abae17ec1777b19", "url": "https://github.com/apache/ozone/commit/e88121aa6e0844a91ca297ac3abae17ec1777b19", "message": "review + findbug fixes", "committedDate": "2020-07-17T18:13:49Z", "type": "commit"}, {"oid": "a1ff4ad2231b10ef8a5209ee7a07a53d658ccb6d", "url": "https://github.com/apache/ozone/commit/a1ff4ad2231b10ef8a5209ee7a07a53d658ccb6d", "message": "findbug fix", "committedDate": "2020-07-17T18:13:49Z", "type": "commit"}, {"oid": "e06cf7e2668d555ee730a71da7103517b756624c", "url": "https://github.com/apache/ozone/commit/e06cf7e2668d555ee730a71da7103517b756624c", "message": "findbug and checkstyle fix", "committedDate": "2020-07-17T18:13:49Z", "type": "forcePushed"}, {"oid": "b3c6113dc2b8ad1068b7da7c35365810ea06d5ad", "url": "https://github.com/apache/ozone/commit/b3c6113dc2b8ad1068b7da7c35365810ea06d5ad", "message": "findbug and checkstyle fix", "committedDate": "2020-07-17T18:34:31Z", "type": "commit"}, {"oid": "b3c6113dc2b8ad1068b7da7c35365810ea06d5ad", "url": "https://github.com/apache/ozone/commit/b3c6113dc2b8ad1068b7da7c35365810ea06d5ad", "message": "findbug and checkstyle fix", "committedDate": "2020-07-17T18:34:31Z", "type": "forcePushed"}]}