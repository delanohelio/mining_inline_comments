{"pr_number": 1650, "pr_title": "HDDS-3684. Add tests for replication annotation", "pr_createdAt": "2020-12-02T21:26:36Z", "pr_url": "https://github.com/apache/ozone/pull/1650", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzNjU3Mw==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r534536573", "bodyText": "Should I actually mock a InvocationHandler and add a request type RequestType.Test? Then make sure replicatedOperation is eventually called.", "author": "amaliujia", "createdAt": "2020-12-02T22:53:15Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestRelicationAnnotation.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import java.io.IOException;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestRelicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+\n+  @Before\n+  public void setup() {\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER,\n+        null,\n+        new MockRatisServer());\n+  }\n+\n+  @Test(expected = IOException.class)\n+  public void testReplicateAnnotationBasic() throws Throwable {\n+    // test whether replicatedOperation will hit the Ratis based replication\n+    // code path in SCMHAInvocationHandler. Expect to see a IOException cause\n+    // no handler is added yet.\n+    scmhaInvocationHandler.invoke(new Object(),\n+        this.getClass().getMethod(\"replicatedOperation\"), new Object[0]);\n+  }\n+\n+  @Replicate\n+  public void replicatedOperation() { }", "originalCommit": "06c4c234f6f81bf596b477810ad852ea3ffe7843", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5NDI4OQ==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r535194289", "bodyText": "typo Relication -> Replication", "author": "GlenGeng", "createdAt": "2020-12-03T12:39:39Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestRelicationAnnotation.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import java.io.IOException;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestRelicationAnnotation {", "originalCommit": "06c4c234f6f81bf596b477810ad852ea3ffe7843", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f32d212a6d86bdee2580ade5dd7509aa4845bed", "url": "https://github.com/apache/ozone/commit/6f32d212a6d86bdee2580ade5dd7509aa4845bed", "message": "HDDS-3684. Add tests for replication annotation", "committedDate": "2020-12-02T21:24:47Z", "type": "forcePushed"}, {"oid": "2f2344a11e95a08ffc3b3354850c6eda316a5aee", "url": "https://github.com/apache/ozone/commit/2f2344a11e95a08ffc3b3354850c6eda316a5aee", "message": "HDDS-3684. Add tests for replication annotation", "committedDate": "2020-12-29T06:56:13Z", "type": "commit"}, {"oid": "2f2344a11e95a08ffc3b3354850c6eda316a5aee", "url": "https://github.com/apache/ozone/commit/2f2344a11e95a08ffc3b3354850c6eda316a5aee", "message": "HDDS-3684. Add tests for replication annotation", "committedDate": "2020-12-29T06:56:13Z", "type": "forcePushed"}, {"oid": "f99519c03e0c1c213ef2a2549de82da7819d1f1b", "url": "https://github.com/apache/ozone/commit/f99519c03e0c1c213ef2a2549de82da7819d1f1b", "message": "fixup! fix typo", "committedDate": "2020-12-29T07:03:57Z", "type": "commit"}, {"oid": "67b653010e15d74b7d8d05fee1ff745ac91827aa", "url": "https://github.com/apache/ozone/commit/67b653010e15d74b7d8d05fee1ff745ac91827aa", "message": "fixup! fix test", "committedDate": "2020-12-29T07:57:43Z", "type": "commit"}, {"oid": "f502a85f6d20f77235d4736efb1ae9ba644f9f6d", "url": "https://github.com/apache/ozone/commit/f502a85f6d20f77235d4736efb1ae9ba644f9f6d", "message": "fixup! update test case", "committedDate": "2020-12-29T08:14:41Z", "type": "commit"}, {"oid": "be72174ba5dc256af5b9b083ce3b996e99707fe5", "url": "https://github.com/apache/ozone/commit/be72174ba5dc256af5b9b083ce3b996e99707fe5", "message": "fixup! fix type", "committedDate": "2020-12-29T08:15:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA2OTAyNg==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550069026", "bodyText": "Hey Rui, Why we need to move MockRatisServer out of MockSCMHAManager ? My concern is\n// TODO: Move this class to test package after fixing Recon, I would like to separate them until they are moved back to test dir.\nYou duplicated the licenses.", "author": "GlenGeng", "createdAt": "2020-12-30T09:19:09Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "diffHunk": "@@ -15,29 +15,28 @@\n  * the License.\n  */\n \n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF", "originalCommit": "be72174ba5dc256af5b9b083ce3b996e99707fe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM1NTk0Mw==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550355943", "bodyText": "O we don't need to :)\nThat was a old design but now our codebase has changed so there is no need to move out this Ratis server. I will move it back.", "author": "amaliujia", "createdAt": "2020-12-30T23:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA2OTAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NDMzNA==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550164334", "bodyText": "Hey Rui, I suggested to simulate the real ratis call, what do you think ?\npublic class TestReplicationAnnotation {\n  @Test\n  public void testReplicateAnnotationBasic() throws Throwable {\n\n    final ContainerStateManagerV2 csm = new ContainerStateManagerV2() {\n\n      @Override\n      public boolean contains(HddsProtos.ContainerID containerID) {\n        return false;\n      }\n\n      @Override\n      public Set<ContainerID> getContainerIDs() {\n        return null;\n      }\n\n      @Override\n      public Set<ContainerID> getContainerIDs(HddsProtos.LifeCycleState state) {\n        return null;\n      }\n\n      @Override\n      public ContainerInfo getContainer(HddsProtos.ContainerID id) {\n        return null;\n      }\n\n      @Override\n      public Set<ContainerReplica> getContainerReplicas(HddsProtos.ContainerID id) {\n        return null;\n      }\n\n      @Override\n      public void updateContainerReplica(HddsProtos.ContainerID id, ContainerReplica replica) {\n\n      }\n\n      @Override\n      public void removeContainerReplica(HddsProtos.ContainerID id, ContainerReplica replica) {\n\n      }\n\n      @Override\n      public void addContainer(HddsProtos.ContainerInfoProto containerInfo) throws IOException {\n\n      }\n\n      @Override\n      public void updateContainerState(HddsProtos.ContainerID id, HddsProtos.LifeCycleEvent event) throws IOException, InvalidStateTransitionException {\n\n      }\n\n      @Override\n      public void updateDeleteTransactionId(Map<ContainerID, Long> deleteTransactionMap) throws IOException {\n\n      }\n\n      @Override\n      public ContainerInfo getMatchingContainer(long size, String owner, PipelineID pipelineID, NavigableSet<ContainerID> containerIDs) {\n        return null;\n      }\n\n      @Override\n      public void removeContainer(HddsProtos.ContainerID containerInfo) throws IOException {\n\n      }\n\n      @Override\n      public void close() throws IOException {\n\n      }\n    };\n\n    SCMRatisServer ratisServer = new SCMRatisServer() {\n      @Override\n      public void start() throws IOException {\n\n      }\n\n      @Override\n      public void registerStateMachineHandler(SCMRatisProtocol.RequestType handlerType, Object handler) {\n\n      }\n\n      @Override\n      public SCMRatisResponse submitRequest(SCMRatisRequest request) throws IOException, ExecutionException, InterruptedException {\n        throw new IOException(\"submitRequest is called.\");\n      }\n\n      @Override\n      public void stop() throws IOException {\n\n      }\n\n      @Override\n      public RaftServer.Division getDivision() {\n        return null;\n      }\n\n      @Override\n      public List<String> getRatisRoles() {\n        return null;\n      }\n\n      @Override\n      public NotLeaderException triggerNotLeaderException() {\n        return null;\n      }\n    };\n\n    final SCMHAInvocationHandler invocationHandler =\n        new SCMHAInvocationHandler(\n            SCMRatisProtocol.RequestType.CONTAINER, csm, ratisServer);\n\n    ContainerStateManagerV2 proxy = (ContainerStateManagerV2) Proxy.newProxyInstance(\n        SCMHAInvocationHandler.class.getClassLoader(),\n        new Class<?>[]{ContainerStateManagerV2.class}, invocationHandler);\n\n    try {\n      proxy.addContainer(HddsProtos.ContainerInfoProto.getDefaultInstance());\n      Assert.fail();\n    } catch (IOException ignore) {\n\n    }\n  }\n}", "author": "GlenGeng", "createdAt": "2020-12-30T11:37:43Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {", "originalCommit": "be72174ba5dc256af5b9b083ce3b996e99707fe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM1NzQ4Nw==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550357487", "bodyText": "I see. How about creating a MockContainerStateManagerV2 directly?", "author": "amaliujia", "createdAt": "2020-12-30T23:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NDMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM4OTc2NA==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550389764", "bodyText": "I consider that we can create a MockContainerStateManagerV2 when we need it. This anonymous one is an auto generated class by IDE.", "author": "GlenGeng", "createdAt": "2020-12-31T03:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NDMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwNDM4Ng==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550404386", "bodyText": "Done", "author": "amaliujia", "createdAt": "2020-12-31T05:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NDMzNA=="}], "type": "inlineReview"}, {"oid": "f4d7a23ca557dd9863d2d878bf690c40d6d0cb3e", "url": "https://github.com/apache/ozone/commit/f4d7a23ca557dd9863d2d878bf690c40d6d0cb3e", "message": "fixup! address comments", "committedDate": "2020-12-31T05:59:18Z", "type": "commit"}, {"oid": "391d7ba04f4ee2189bcd9cb0cf1d990523b7d5e2", "url": "https://github.com/apache/ozone/commit/391d7ba04f4ee2189bcd9cb0cf1d990523b7d5e2", "message": "fixup! fix findsbug", "committedDate": "2020-12-31T06:23:22Z", "type": "commit"}, {"oid": "e03abcf040140b83cb8fed036bb13d1af5aceb11", "url": "https://github.com/apache/ozone/commit/e03abcf040140b83cb8fed036bb13d1af5aceb11", "message": "fixup! remove duplicate license header", "committedDate": "2020-12-31T06:34:04Z", "type": "commit"}, {"oid": "cbf055ef0da1d0338a9c4d43de2aa2e3d61b455c", "url": "https://github.com/apache/ozone/commit/cbf055ef0da1d0338a9c4d43de2aa2e3d61b455c", "message": "fixup! fix style", "committedDate": "2020-12-31T06:35:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQxMDE4Nw==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550410187", "bodyText": "Hey Rui, changes in MockSCMHAManager.java may not be needed, since MockRatisServer is an inner class of MockSCMHAManager,", "author": "GlenGeng", "createdAt": "2020-12-31T06:42:27Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "diffHunk": "@@ -92,11 +92,20 @@ public void shutdown() throws IOException {\n     ratisServer.stop();\n   }\n \n-  private class MockRatisServer implements SCMRatisServer {\n+  /**\n+   * Mock RatisServer implementation for testing.", "originalCommit": "cbf055ef0da1d0338a9c4d43de2aa2e3d61b455c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQxMDgzMg==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550410832", "bodyText": "Hey Rui, I consider you have to use my anonymous version of SCMRatisServer,\nbecause of\n\n      @Override\n      public SCMRatisResponse submitRequest(SCMRatisRequest request) throws IOException, ExecutionException, InterruptedException {\n        throw new IOException(\"submitRequest is called.\");\n      }\n\n,\nfrom the IOException\n    ContainerStateManagerV2 proxy = (ContainerStateManagerV2) Proxy.newProxyInstance(\n        SCMHAInvocationHandler.class.getClassLoader(),\n        new Class<?>[]{ContainerStateManagerV2.class}, invocationHandler);\n\n    try {\n      proxy.addContainer(HddsProtos.ContainerInfoProto.getDefaultInstance());\n      Assert.fail();\n    } catch (IOException ignore) {\n\n    }\n\nwe can know that invokeRatis() is called, due to the annotation.", "author": "GlenGeng", "createdAt": "2020-12-31T06:46:22Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerInfo;\n+import org.apache.hadoop.hdds.scm.container.ContainerReplica;\n+import org.apache.hadoop.hdds.scm.container.ContainerStateManagerV2;\n+import org.apache.hadoop.hdds.scm.pipeline.PipelineID;\n+import org.apache.hadoop.ozone.common.statemachine.InvalidStateTransitionException;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+  private ContainerStateManagerV2 mockCSM;\n+\n+  @Before\n+  public void setup() {\n+    SCMHAManager mock = MockSCMHAManager.getInstance(true);\n+    mockCSM = new ContainerStateManagerV2() {\n+      @Override\n+      public boolean contains(HddsProtos.ContainerID containerID) {\n+        return false;\n+      }\n+\n+      @Override\n+      public Set<ContainerID> getContainerIDs() {\n+        return null;\n+      }\n+\n+      @Override\n+      public Set<ContainerID> getContainerIDs(\n+          HddsProtos.LifeCycleState state) {\n+        return null;\n+      }\n+\n+      @Override\n+      public ContainerInfo getContainer(HddsProtos.ContainerID id) {\n+        return null;\n+      }\n+\n+      @Override\n+      public Set<ContainerReplica> getContainerReplicas(\n+          HddsProtos.ContainerID id) {\n+        return null;\n+      }\n+\n+      @Override\n+      public void updateContainerReplica(\n+          HddsProtos.ContainerID id, ContainerReplica replica) {\n+\n+      }\n+\n+      @Override\n+      public void removeContainerReplica(\n+          HddsProtos.ContainerID id, ContainerReplica replica) {\n+\n+      }\n+\n+      @Override\n+      public void addContainer(HddsProtos.ContainerInfoProto containerInfo)\n+          throws IOException {\n+\n+      }\n+\n+      @Override\n+      public void updateContainerState(\n+          HddsProtos.ContainerID id, HddsProtos.LifeCycleEvent event)\n+          throws IOException, InvalidStateTransitionException {\n+\n+      }\n+\n+      @Override\n+      public void updateDeleteTransactionId(\n+          Map<ContainerID, Long> deleteTransactionMap) throws IOException {\n+\n+      }\n+\n+      @Override\n+      public ContainerInfo getMatchingContainer(\n+          long size, String owner, PipelineID pipelineID,\n+          NavigableSet<ContainerID> containerIDs) {\n+        return null;\n+      }\n+\n+      @Override\n+      public void removeContainer(HddsProtos.ContainerID containerInfo)\n+          throws IOException {\n+      }\n+\n+      @Override\n+      public void close() throws IOException {\n+\n+      }\n+    };\n+\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER, mockCSM, mock.getRatisServer());\n+  }\n+\n+  @Test\n+  public void testReplicateAnnotationBasic() throws Throwable {\n+    // test whether this call will hit the Ratis based replication\n+    // code path in SCMHAInvocationHandler. The invoke() can return means the\n+    // request is handled properly thus response is successful. Expected\n+    // result is null because the function returns nothing.\n+    Object[] arguments = {HddsProtos.ContainerInfoProto.getDefaultInstance()};\n+    Assert.assertEquals(null, scmhaInvocationHandler.invoke(new Object(),", "originalCommit": "cbf055ef0da1d0338a9c4d43de2aa2e3d61b455c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e10e0ce8c20dfa538232d9bbc858f98e97db2ed", "url": "https://github.com/apache/ozone/commit/9e10e0ce8c20dfa538232d9bbc858f98e97db2ed", "message": "fixup! address comments", "committedDate": "2020-12-31T07:51:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQyMTU2Ng==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550421566", "bodyText": "@GlenGeng\nDone.", "author": "amaliujia", "createdAt": "2020-12-31T07:53:20Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.container.ContainerStateManagerV2;\n+import org.apache.ratis.protocol.exceptions.NotLeaderException;\n+import org.apache.ratis.server.RaftServer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.lang.reflect.Proxy;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+\n+  @Before\n+  public void setup() {\n+    SCMRatisServer ratisServer = new SCMRatisServer() {\n+      @Override\n+      public void start() throws IOException {\n+      }\n+\n+      @Override\n+      public void registerStateMachineHandler(\n+          SCMRatisProtocol.RequestType handlerType, Object handler) {\n+      }\n+\n+      @Override\n+      public SCMRatisResponse submitRequest(SCMRatisRequest request)\n+          throws IOException, ExecutionException, InterruptedException {\n+        throw new IOException(\"submitRequest is called.\");\n+      }\n+\n+      @Override\n+      public void stop() throws IOException {\n+      }\n+\n+      @Override\n+      public RaftServer.Division getDivision() {\n+        return null;\n+      }\n+\n+      @Override\n+      public List<String> getRatisRoles() {\n+        return null;\n+      }\n+\n+      @Override\n+      public NotLeaderException triggerNotLeaderException() {\n+        return null;\n+      }\n+    };\n+\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER, null, ratisServer);\n+  }\n+\n+  @Test\n+  public void testReplicateAnnotationBasic() throws Throwable {\n+    ContainerStateManagerV2 proxy =\n+        (ContainerStateManagerV2) Proxy.newProxyInstance(\n+        SCMHAInvocationHandler.class.getClassLoader(),\n+        new Class<?>[]{ContainerStateManagerV2.class}, scmhaInvocationHandler);\n+\n+    try {\n+      proxy.addContainer(HddsProtos.ContainerInfoProto.getDefaultInstance());", "originalCommit": "9e10e0ce8c20dfa538232d9bbc858f98e97db2ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQyMTY4Mg==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550421682", "bodyText": "We only want to see that it will hit SCMHAInvocationHandler.invokeRatis() so there is no need to implement a ContainerStateManagerV2.", "author": "amaliujia", "createdAt": "2020-12-31T07:54:00Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.container.ContainerStateManagerV2;\n+import org.apache.ratis.protocol.exceptions.NotLeaderException;\n+import org.apache.ratis.server.RaftServer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.lang.reflect.Proxy;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+\n+  @Before\n+  public void setup() {\n+    SCMRatisServer ratisServer = new SCMRatisServer() {\n+      @Override\n+      public void start() throws IOException {\n+      }\n+\n+      @Override\n+      public void registerStateMachineHandler(\n+          SCMRatisProtocol.RequestType handlerType, Object handler) {\n+      }\n+\n+      @Override\n+      public SCMRatisResponse submitRequest(SCMRatisRequest request)\n+          throws IOException, ExecutionException, InterruptedException {\n+        throw new IOException(\"submitRequest is called.\");\n+      }\n+\n+      @Override\n+      public void stop() throws IOException {\n+      }\n+\n+      @Override\n+      public RaftServer.Division getDivision() {\n+        return null;\n+      }\n+\n+      @Override\n+      public List<String> getRatisRoles() {\n+        return null;\n+      }\n+\n+      @Override\n+      public NotLeaderException triggerNotLeaderException() {\n+        return null;\n+      }\n+    };\n+\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER, null, ratisServer);", "originalCommit": "9e10e0ce8c20dfa538232d9bbc858f98e97db2ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEzNzg0NA==", "url": "https://github.com/apache/ozone/pull/1650#discussion_r551137844", "bodyText": "Please add some message such as Assert.fail(\"xxxxx\");. You can do it in next pr, I will merge this first.", "author": "runzhiwang", "createdAt": "2021-01-04T06:34:05Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.container.ContainerStateManagerV2;\n+import org.apache.ratis.protocol.exceptions.NotLeaderException;\n+import org.apache.ratis.server.RaftServer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.lang.reflect.Proxy;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+\n+  @Before\n+  public void setup() {\n+    SCMRatisServer ratisServer = new SCMRatisServer() {\n+      @Override\n+      public void start() throws IOException {\n+      }\n+\n+      @Override\n+      public void registerStateMachineHandler(\n+          SCMRatisProtocol.RequestType handlerType, Object handler) {\n+      }\n+\n+      @Override\n+      public SCMRatisResponse submitRequest(SCMRatisRequest request)\n+          throws IOException, ExecutionException, InterruptedException {\n+        throw new IOException(\"submitRequest is called.\");\n+      }\n+\n+      @Override\n+      public void stop() throws IOException {\n+      }\n+\n+      @Override\n+      public RaftServer.Division getDivision() {\n+        return null;\n+      }\n+\n+      @Override\n+      public List<String> getRatisRoles() {\n+        return null;\n+      }\n+\n+      @Override\n+      public NotLeaderException triggerNotLeaderException() {\n+        return null;\n+      }\n+    };\n+\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER, null, ratisServer);\n+  }\n+\n+  @Test\n+  public void testReplicateAnnotationBasic() throws Throwable {\n+    ContainerStateManagerV2 proxy =\n+        (ContainerStateManagerV2) Proxy.newProxyInstance(\n+        SCMHAInvocationHandler.class.getClassLoader(),\n+        new Class<?>[]{ContainerStateManagerV2.class}, scmhaInvocationHandler);\n+\n+    try {\n+      proxy.addContainer(HddsProtos.ContainerInfoProto.getDefaultInstance());\n+      // Should have seen a IOException.\n+      Assert.fail();", "originalCommit": "9e10e0ce8c20dfa538232d9bbc858f98e97db2ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}