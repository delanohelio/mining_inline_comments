{"pr_number": 1185, "pr_title": "HDDS-3933. Fix memory leak because of too many Datanode State Machine Thread", "pr_createdAt": "2020-07-10T04:33:53Z", "pr_url": "https://github.com/apache/ozone/pull/1185", "timeline": [{"oid": "2d15f95a64181e04300518db3046ebf0bcf70387", "url": "https://github.com/apache/ozone/commit/2d15f95a64181e04300518db3046ebf0bcf70387", "message": "HDDS-3933. Fix memory leak because of too many Datanode State Machine Thread", "committedDate": "2020-07-14T03:18:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MjU0Nw==", "url": "https://github.com/apache/ozone/pull/1185#discussion_r454192547", "bodyText": "Instead of cancel the future, I would suggest to skip the next time execution, and let the current future finish it.  Also, please add LOG if this case happens.", "author": "ChenSammi", "createdAt": "2020-07-14T08:30:46Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -200,22 +203,31 @@ public void execute(ExecutorService executor) {\n   @Override\n   public DatanodeStateMachine.DatanodeStates\n       await(long duration, TimeUnit timeUnit)\n-      throws InterruptedException, ExecutionException, TimeoutException {\n+      throws InterruptedException {\n     int count = connectionManager.getValues().size();\n     int returned = 0;\n-    long timeLeft = timeUnit.toMillis(duration);\n+    long durationMS = timeUnit.toMillis(duration);\n     long startTime = Time.monotonicNow();\n-    List<Future<EndPointStates>> results = new LinkedList<>();\n-\n-    while (returned < count && timeLeft > 0) {\n-      Future<EndPointStates> result =\n-          ecs.poll(timeLeft, TimeUnit.MILLISECONDS);\n-      if (result != null) {\n-        results.add(result);\n-        returned++;\n+    Set<Future<EndPointStates>> results = new HashSet<>();\n+\n+    while (returned < count\n+        && (durationMS - (Time.monotonicNow() - startTime))> 0) {\n+      for (Future<EndPointStates> future : futures) {\n+        if (future != null && future.isDone() && !results.contains(future)) {\n+          results.add(future);\n+          returned++;\n+        }\n       }\n-      timeLeft = timeLeft - (Time.monotonicNow() - startTime);\n+\n+      Thread.sleep(durationMS / 10);\n     }\n+\n+    for (Future<EndPointStates> future : futures) {\n+      if (future != null && !future.isDone()) {\n+        future.cancel(true);", "originalCommit": "2d15f95a64181e04300518db3046ebf0bcf70387", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "013f5f6648328b258c4ede54ecd2e354660a985c", "url": "https://github.com/apache/ozone/commit/013f5f6648328b258c4ede54ecd2e354660a985c", "message": "HDDS-3933. Fix memory leak because of too many Datanode State Machine Thread", "committedDate": "2020-07-15T08:55:02Z", "type": "commit"}, {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "message": "fix code review", "committedDate": "2020-07-15T08:56:01Z", "type": "commit"}, {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "message": "fix code review", "committedDate": "2020-07-15T08:56:01Z", "type": "forcePushed"}, {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "message": "fix code review", "committedDate": "2020-07-15T08:56:01Z", "type": "forcePushed"}, {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "message": "fix code review", "committedDate": "2020-07-15T08:56:01Z", "type": "forcePushed"}, {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "message": "fix code review", "committedDate": "2020-07-15T08:56:01Z", "type": "forcePushed"}, {"oid": "9ff1d5299c2c44cb0790ecde0112336ef7028fe8", "url": "https://github.com/apache/ozone/commit/9ff1d5299c2c44cb0790ecde0112336ef7028fe8", "message": "triger ci", "committedDate": "2020-07-16T23:54:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzMxMA==", "url": "https://github.com/apache/ozone/pull/1185#discussion_r456153310", "bodyText": "In a similar case of endpoint task locked up, will we end up with flooding of warning logs here?", "author": "xiaoyuyao", "createdAt": "2020-07-17T00:35:31Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/StateContext.java", "diffHunk": "@@ -415,7 +431,14 @@ public void execute(ExecutorService service, long time, TimeUnit unit)\n       if (this.isEntering()) {\n         task.onEnter();\n       }\n-      task.execute(service);\n+\n+      if (isThreadPoolAvailable(service)) {\n+        task.execute(service);\n+      } else {\n+        LOG.warn(\"No available thread in pool, duration:\" +", "originalCommit": "9ff1d5299c2c44cb0790ecde0112336ef7028fe8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5NTI1NQ==", "url": "https://github.com/apache/ozone/pull/1185#discussion_r456195255", "bodyText": "@xiaoyuyao Thanks for review and reasonable suggestion. How about add metrics for thread pool available and unavailable times ?", "author": "runzhiwang", "createdAt": "2020-07-17T03:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzMxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwMDI0MQ==", "url": "https://github.com/apache/ozone/pull/1185#discussion_r456200241", "bodyText": "There is a  EndpointStateMachine#logIfNeeded function.   We can leverage this function to reduce the same warning logs logged.  @runzhiwang", "author": "ChenSammi", "createdAt": "2020-07-17T03:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzMxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA3NDg4Mw==", "url": "https://github.com/apache/ozone/pull/1185#discussion_r457074883", "bodyText": "@ChenSammi @xiaoyuyao  Thanks for review. I have updated the PR, because  EndpointStateMachine#logIfNeeded can not be accessed there, and it's can not be refactored to use, so I did not use it.", "author": "runzhiwang", "createdAt": "2020-07-20T05:50:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzMxMA=="}], "type": "inlineReview"}, {"oid": "2c381fa32eed28861e3c7970eebe6663199c4b66", "url": "https://github.com/apache/ozone/commit/2c381fa32eed28861e3c7970eebe6663199c4b66", "message": "log with interval", "committedDate": "2020-07-20T03:06:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2MDkwNA==", "url": "https://github.com/apache/ozone/pull/1185#discussion_r458560904", "bodyText": "Can we switch theset two statement?", "author": "ChenSammi", "createdAt": "2020-07-22T06:22:49Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/StateContext.java", "diffHunk": "@@ -434,9 +438,14 @@ public void execute(ExecutorService service, long time, TimeUnit unit)\n \n       if (isThreadPoolAvailable(service)) {\n         task.execute(service);\n+        threadPoolNotAvailableCount.set(0);\n       } else {\n-        LOG.warn(\"No available thread in pool, duration:\" +\n-            unit.toMillis(time));\n+        threadPoolNotAvailableCount.incrementAndGet();", "originalCommit": "2c381fa32eed28861e3c7970eebe6663199c4b66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU3MTc3NA==", "url": "https://github.com/apache/ozone/pull/1185#discussion_r458571774", "bodyText": "Updated", "author": "runzhiwang", "createdAt": "2020-07-22T06:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2MDkwNA=="}], "type": "inlineReview"}, {"oid": "0d9b1064c5dd263fb250d4cfc0a23aaa4c7afc9d", "url": "https://github.com/apache/ozone/commit/0d9b1064c5dd263fb250d4cfc0a23aaa4c7afc9d", "message": "fix code review", "committedDate": "2020-07-22T06:48:58Z", "type": "commit"}, {"oid": "717040e6179946fc126d25cd491d3fc23aec0b92", "url": "https://github.com/apache/ozone/commit/717040e6179946fc126d25cd491d3fc23aec0b92", "message": "fix code review", "committedDate": "2020-07-22T08:29:22Z", "type": "commit"}, {"oid": "f4f34523e3cd25ce81297ed3bf479a16e49fcf67", "url": "https://github.com/apache/ozone/commit/f4f34523e3cd25ce81297ed3bf479a16e49fcf67", "message": "fix code review", "committedDate": "2020-07-22T08:34:49Z", "type": "commit"}]}