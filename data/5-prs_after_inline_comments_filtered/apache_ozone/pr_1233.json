{"pr_number": 1233, "pr_title": "HDDS-3725. Ozone sh volume client support quota option.", "pr_createdAt": "2020-07-22T02:37:54Z", "pr_url": "https://github.com/apache/ozone/pull/1233", "timeline": [{"oid": "a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "url": "https://github.com/apache/ozone/commit/a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "message": "fix smoketests", "committedDate": "2020-07-22T04:51:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0OTYxMA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r458649610", "bodyText": "Suggestion :\n\"Quota of bytes allocated for the Volume.\"", "author": "cxorm", "createdAt": "2020-07-22T09:09:53Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -61,9 +61,13 @@\n    */\n   private String owner;\n   /**\n-   * Quota allocated for the Volume.\n+   * Bytes Quota allocated for the Volume.", "originalCommit": "a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY1MTU2Ng==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r458651566", "bodyText": "Suggestion :\n\"Quota of bucket count allocated for the Volume.\"", "author": "cxorm", "createdAt": "2020-07-22T09:13:13Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -61,9 +61,13 @@\n    */\n   private String owner;\n   /**\n-   * Quota allocated for the Volume.\n+   * Bytes Quota allocated for the Volume.\n    */\n-  private long quotaInBytes;\n+  private long storagespaceQuota;\n+  /**\n+   * Bucket Counts Quota allocated for the Volume.", "originalCommit": "a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY3NDQwNw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r458674407", "bodyText": "Suggestion :\nSeparate the annotations and add the comments.", "author": "cxorm", "createdAt": "2020-07-22T09:52:09Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -248,12 +267,14 @@ public boolean setOwner(String userName) throws IOException {\n \n   /**\n    * Sets/Changes the quota of this Volume.\n-   * @param quota new quota\n-   * @throws IOException\n+   *\n+   * @param quota@throws IOException", "originalCommit": "a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY3NTk4Nw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r458675987", "bodyText": "Suggestion :\n\"Returns quota of bucket counts allocated for the Volume.\"", "author": "cxorm", "createdAt": "2020-07-22T09:54:54Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -204,10 +215,18 @@ public String getOwner() {\n    *\n    * @return quotaInBytes\n    */\n-  public long getQuota() {\n-    return quotaInBytes;\n+  public long getStoragespaceQuota() {\n+    return storagespaceQuota;\n   }\n \n+  /**\n+   * Returns Bucket Quota count allocated for the Volume.", "originalCommit": "a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY4ODgwNQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r458688805", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"Quota Bytes of the newly created volume (eg. 1GB)\")\n          \n          \n            \n                      \"Quota in bytes of the newly created volume (eg. 1GB)\")", "author": "cxorm", "createdAt": "2020-07-22T10:18:06Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -40,10 +41,15 @@\n       description = \"Owner of of the volume\")\n   private String ownerName;\n \n+  @Option(names = {\"--spaceQuota\", \"-sq\"},\n+      description =\n+          \"Quota Bytes of the newly created volume (eg. 1GB)\")", "originalCommit": "a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY5MDUwNQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r458690505", "bodyText": "Correct me if I miss something.\nWould it be better to update the description to \"Bucket counts of the newly created volume (eg. 5) \" ?", "author": "cxorm", "createdAt": "2020-07-22T10:21:26Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -40,10 +41,15 @@\n       description = \"Owner of of the volume\")\n   private String ownerName;\n \n+  @Option(names = {\"--spaceQuota\", \"-sq\"},\n+      description =\n+          \"Quota Bytes of the newly created volume (eg. 1GB)\")\n+  private String storagespaceQuota;\n+\n   @Option(names = {\"--quota\", \"-q\"},\n       description =\n-          \"Quota of the newly created volume (eg. 1G)\")\n-  private String quota;\n+          \"Quota count of the newly created volume (eg. 5)\")", "originalCommit": "a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyMzM5NQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r458723395", "bodyText": "Do you mind change the \"-sq\" to \"-s\" (or other alphabet) ?\nI think the command-line promotion is better if it is alignment.\n(And take this way, it would be left-alignment)", "author": "cxorm", "createdAt": "2020-07-22T11:28:18Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -40,10 +41,15 @@\n       description = \"Owner of of the volume\")\n   private String ownerName;\n \n+  @Option(names = {\"--spaceQuota\", \"-sq\"},", "originalCommit": "a2c5317417ca8c6cf30b6d9edf6c4a0912c62b2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b905f6cfdac09444e21cdd29a950e5ae2eac69ee", "url": "https://github.com/apache/ozone/commit/b905f6cfdac09444e21cdd29a950e5ae2eac69ee", "message": "fix review issues", "committedDate": "2020-07-22T13:12:59Z", "type": "forcePushed"}, {"oid": "9b4240b6e8a4e027ebb1ade2ee8f49236df3237d", "url": "https://github.com/apache/ozone/commit/9b4240b6e8a4e027ebb1ade2ee8f49236df3237d", "message": "fix review issues", "committedDate": "2020-07-22T13:17:01Z", "type": "forcePushed"}, {"oid": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "url": "https://github.com/apache/ozone/commit/8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "message": "fix review issues", "committedDate": "2020-07-22T13:24:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NDM1Mw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459264353", "bodyText": "The RawStorageSpace is a little confuse. Here we could add comment addressed to the class RawStorageSpaceQuota IMHO.", "author": "cxorm", "createdAt": "2020-07-23T07:34:37Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -25,26 +25,75 @@\n  * represents an OzoneQuota Object that can be applied to\n  * a storage volume.\n  */\n-public class OzoneQuota {\n+public final class OzoneQuota {\n \n   public static final String OZONE_QUOTA_BYTES = \"BYTES\";\n+  public static final String OZONE_QUOTA_KB = \"KB\";\n   public static final String OZONE_QUOTA_MB = \"MB\";\n   public static final String OZONE_QUOTA_GB = \"GB\";\n   public static final String OZONE_QUOTA_TB = \"TB\";\n \n-  private Units unit;\n-  private long size;\n-\n   /** Quota Units.*/\n   public enum Units {UNDEFINED, BYTES, KB, MB, GB, TB}\n \n+  // Quota to decide how many buckets or keys can be created.\n+  private long namespaceQuota;\n+  // Quota to decide how many storage space will be used in bytes.\n+  private long storagespaceQuota;\n+  private RawStorageSpaceQuota rawStoragespaceQuota;\n+\n+  private static class RawStorageSpaceQuota {", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NDc0Mg==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459264742", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private OzoneQuota(long namespaceQuota,\n          \n          \n            \n                                 RawStorageSpaceQuota rawStoragespaceQuota) {\n          \n          \n            \n              private OzoneQuota(long namespaceQuota,\n          \n          \n            \n                  RawStorageSpaceQuota rawStoragespaceQuota) {", "author": "cxorm", "createdAt": "2020-07-23T07:35:24Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -53,26 +102,28 @@ public long getSize() {\n    * @return Unit in MB, GB or TB\n    */\n   public Units getUnit() {\n-    return unit;\n+    return this.rawStoragespaceQuota.getUnit();\n   }\n \n   /**\n    * Constructs a default Quota object.\n    */\n-  public OzoneQuota() {\n-    this.size = 0;\n-    this.unit = Units.UNDEFINED;\n+  private OzoneQuota() {\n+    this.namespaceQuota = OzoneConsts.QUOTA_COUNT_RESET;\n+    this.storagespaceQuota = OzoneConsts.MAX_QUOTA_IN_BYTES;\n   }\n \n   /**\n    * Constructor for Ozone Quota.\n    *\n-   * @param size Long Size\n-   * @param unit MB, GB  or TB\n+   * @param namespaceQuota long value\n+   * @param rawStoragespaceQuota RawStorageSpaceQuota value\n    */\n-  public OzoneQuota(long size, Units unit) {\n-    this.size = size;\n-    this.unit = unit;\n+  private OzoneQuota(long namespaceQuota,\n+                     RawStorageSpaceQuota rawStoragespaceQuota) {", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NDg5NA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459264894", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static OzoneQuota parseQuota(String storagespaceQuotaStr,\n          \n          \n            \n                                                  long namespaceQuota) {\n          \n          \n            \n              public static OzoneQuota parseQuota(String storagespaceQuotaStr,\n          \n          \n            \n                  long namespaceQuota) {", "author": "cxorm", "createdAt": "2020-07-23T07:35:47Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -82,25 +133,28 @@ public OzoneQuota(long size, Units unit) {\n    * @return string representation of quota\n    */\n   public static String formatQuota(OzoneQuota quota) {\n-    return String.valueOf(quota.size) + quota.unit;\n+    return String.valueOf(quota.getRawSize())+ quota.getUnit();\n   }\n \n   /**\n    * Parses a user provided string and returns the\n    * Quota Object.\n    *\n-   * @param quotaString Quota String\n+   * @param storagespaceQuotaStr Storage space Quota String\n+   * @param namespaceQuota namespace Quota\n    *\n    * @return OzoneQuota object\n    */\n-  public static OzoneQuota parseQuota(String quotaString) {\n+  public static OzoneQuota parseQuota(String storagespaceQuotaStr,\n+                                      long namespaceQuota) {", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NTU1OQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459265559", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static OzoneQuota getOzoneQuota(long quotaInBytes,\n          \n          \n            \n                                                     long quotaInCounts) {\n          \n          \n            \n              public static OzoneQuota getOzoneQuota(long quotaInBytes,\n          \n          \n            \n                  long quotaInCounts) {", "author": "cxorm", "createdAt": "2020-07-23T07:37:18Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -143,57 +204,53 @@ public static OzoneQuota parseQuota(String quotaString) {\n       throw new IllegalArgumentException(\"Quota cannot be negative.\");\n     }\n \n-    return new OzoneQuota(nSize, currUnit);\n+    return new OzoneQuota(namespaceQuota,\n+        new RawStorageSpaceQuota(currUnit, nSize));\n   }\n \n \n-  /**\n-   * Returns size in Bytes or -1 if there is no Quota.\n-   */\n-  public long sizeInBytes() {\n-    switch (this.unit) {\n-    case BYTES:\n-      return this.getSize();\n-    case MB:\n-      return this.getSize() * OzoneConsts.MB;\n-    case GB:\n-      return this.getSize() * OzoneConsts.GB;\n-    case TB:\n-      return this.getSize() * OzoneConsts.TB;\n-    case UNDEFINED:\n-    default:\n-      return -1;\n-    }\n-  }\n-\n   /**\n    * Returns OzoneQuota corresponding to size in bytes.\n    *\n-   * @param sizeInBytes size in bytes to be converted\n+   * @param quotaInBytes in bytes to be converted\n+   * @param quotaInCounts in counts to be converted\n    *\n    * @return OzoneQuota object\n    */\n-  public static OzoneQuota getOzoneQuota(long sizeInBytes) {\n+  public static OzoneQuota getOzoneQuota(long quotaInBytes,\n+                                         long quotaInCounts) {", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2Njc1Mw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459266753", "bodyText": "Could you please update the comment to \"Quota of bucket counts\" and add the description of meaning of \"-1\" here ?", "author": "cxorm", "createdAt": "2020-07-23T07:39:57Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -204,6 +204,16 @@ public static Versioning getVersioning(boolean versioning) {\n    */\n   public static final long MAX_QUOTA_IN_BYTES = 1024L * 1024 * TB;\n \n+  /**\n+   * Quota value.\n+   */\n+  public static final long QUOTA_COUNT_RESET = -1;", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NzQ5NA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459267494", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Quota to decide how many buckets or keys can be created.\n          \n          \n            \n              // Quota to decide how many buckets can be created.", "author": "cxorm", "createdAt": "2020-07-23T07:41:33Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -25,26 +25,75 @@\n  * represents an OzoneQuota Object that can be applied to\n  * a storage volume.\n  */\n-public class OzoneQuota {\n+public final class OzoneQuota {\n \n   public static final String OZONE_QUOTA_BYTES = \"BYTES\";\n+  public static final String OZONE_QUOTA_KB = \"KB\";\n   public static final String OZONE_QUOTA_MB = \"MB\";\n   public static final String OZONE_QUOTA_GB = \"GB\";\n   public static final String OZONE_QUOTA_TB = \"TB\";\n \n-  private Units unit;\n-  private long size;\n-\n   /** Quota Units.*/\n   public enum Units {UNDEFINED, BYTES, KB, MB, GB, TB}\n \n+  // Quota to decide how many buckets or keys can be created.", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2Nzk5NA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459267994", "bodyText": "We could not violate checkstyle if we use one line here.", "author": "cxorm", "createdAt": "2020-07-23T07:42:38Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/UpdateVolumeHandler.java", "diffHunk": "@@ -39,22 +40,34 @@\n       description = \"Owner of the volume to set\")\n   private String ownerName;\n \n-  @Option(names = {\"--quota\"},\n-      description = \"Quota of the volume to set\"\n-          + \"(eg. 1G)\")\n-  private String quota;\n+  @Option(names = {\"--spaceQuota\", \"-s\"},\n+      description = \"Quota in bytes of the volume to set (eg. 1GB)\")\n+  private String storagespaceQuota;\n+\n+  @Option(names = {\"--quota\", \"-q\"},\n+      description = \"Bucket counts of the volume to set (eg. 5)\")\n+  private long namespaceQuota = OzoneConsts.QUOTA_COUNT_RESET;\n \n   @Override\n   protected void execute(OzoneClient client, OzoneAddress address)\n       throws IOException {\n-\n     String volumeName = address.getVolumeName();\n-\n     OzoneVolume volume = client.getObjectStore().getVolume(volumeName);\n-    if (quota != null && !quota.isEmpty()) {\n-      volume.setQuota(OzoneQuota.parseQuota(quota));\n+\n+    long spaceQuota = volume.getStoragespaceQuota();\n+    long countQuota = volume.getNamespaceQuota();\n+\n+    if (storagespaceQuota != null && !storagespaceQuota.isEmpty()) {\n+      spaceQuota = OzoneQuota.parseQuota(storagespaceQuota,\n+          namespaceQuota).getStoragespaceQuota();\n+    }\n+    if (namespaceQuota >= 0) {\n+      countQuota = namespaceQuota;\n     }\n \n+    volume.setQuota(\n+        OzoneQuota.getOzoneQuota(spaceQuota, countQuota));", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2ODcyMg==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459268722", "bodyText": "I didn't found usage of this method in all places.\nCould you tell me why we add this part if I miss something ?", "author": "cxorm", "createdAt": "2020-07-23T07:44:17Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/StringUtils.java", "diffHunk": "@@ -149,6 +150,13 @@ public static String createStartupShutdownMessage(VersionInfo versionInfo,\n         \"  java = \" + System.getProperty(\"java.version\"));\n   }\n \n+  /**\n+   * The same as String.format(Locale.ENGLISH, format, objects).\n+   */\n+  public static String format(final String format, final Object... objects) {\n+    return String.format(Locale.ENGLISH, format, objects);\n+  }\n+", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2OTczNA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459269734", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns Volume Quota in counts.\n          \n          \n            \n               * Returns Volume Quota in bucket counts.", "author": "cxorm", "createdAt": "2020-07-23T07:46:25Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/VolumeArgs.java", "diffHunk": "@@ -73,11 +78,19 @@ public String getOwner() {\n   }\n \n   /**\n-   * Returns Volume Quota.\n-   * @return Quota.\n+   * Returns Volume Quota in bytes.\n+   * @return storagespaceQuota.\n    */\n-  public String getQuota() {\n-    return quota;\n+  public String getStoragespaceQuota() {\n+    return storagespaceQuota;\n+  }\n+\n+  /**\n+   * Returns Volume Quota in counts.", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2OTg2OA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459269868", "bodyText": "I think we could update the description of the parameter consistent with shell-command IMHO.", "author": "cxorm", "createdAt": "2020-07-23T07:46:43Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/VolumeArgs.java", "diffHunk": "@@ -33,25 +33,30 @@\n \n   private final String admin;\n   private final String owner;\n-  private final String quota;\n+  private final String storagespaceQuota;\n+  private final long namespaceQuota;\n   private final List<OzoneAcl> acls;\n   private Map<String, String> metadata;\n \n   /**\n    * Private constructor, constructed via builder.\n    * @param admin Administrator's name.\n    * @param owner Volume owner's name\n-   * @param quota Volume Quota.\n+   * @param storagespaceQuota Volume Quota.\n+   * @param namespaceQuota Volume Quota.", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MDM5Mw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459270393", "bodyText": "Instead of OzoneManager.java, this request is processed in OMVolumeSetQuotaRequest.java .\nWe could not update code-snippet here.", "author": "cxorm", "createdAt": "2020-07-23T07:47:50Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1706,21 +1706,24 @@ public boolean setOwner(String volume, String owner) throws IOException {\n    * Changes the Quota on a volume.\n    *\n    * @param volume - Name of the volume.\n-   * @param quota  - Quota in bytes.\n+   * @param storagespceQuota - Quota in bytes.\n+   * @param namespaceQuota - Quota in counts.\n    * @throws IOException\n    */\n   @Override\n-  public void setQuota(String volume, long quota) throws IOException {\n-    if (isAclEnabled) {\n+  public void setQuota(String volume, long namespaceQuota,", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2ODQ1Nw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459468457", "bodyText": "Similar to setOwner, there already exists setQuota. If none of this is needed, we can use separate PR to clean up this useless methods.", "author": "captainzmc", "createdAt": "2020-07-23T13:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MDM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MDYxNQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459270615", "bodyText": "This part is the same as comments on OzoneManager.java", "author": "cxorm", "createdAt": "2020-07-23T07:48:23Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/VolumeManager.java", "diffHunk": "@@ -49,10 +49,12 @@ void setOwner(String volume, String owner)\n    * Changes the Quota on a volume.\n    *\n    * @param volume - Name of the volume.\n-   * @param quota - Quota in bytes.\n+   * @param namespaceQuota - Quota in counts.\n+   * @param storagespaceQuota - Quota in bytes.\n    * @throws IOException\n    */\n-  void setQuota(String volume, long quota) throws IOException;\n+  void setQuota(String volume, long namespaceQuota,", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MDg2NA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459270864", "bodyText": "This part is the same as comments on OzoneManager.java", "author": "cxorm", "createdAt": "2020-07-23T07:48:57Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/VolumeManagerImpl.java", "diffHunk": "@@ -273,12 +272,14 @@ private void setOwnerCommitToDB(UserVolumeInfo oldOwnerVolumeList,\n    * Changes the Quota on a volume.\n    *\n    * @param volume - Name of the volume.\n-   * @param quota - Quota in bytes.\n+   * @param namespaceQuota - Quota in count for bucket.\n+   * @param storagespaceQuota - Quota in bytes.\n    *\n    * @throws IOException\n    */\n   @Override\n-  public void setQuota(String volume, long quota) throws IOException {\n+  public void setQuota(String volume, long namespaceQuota,", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MTE1NA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459271154", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (storagespaceQuota!= null) {\n          \n          \n            \n                if (storagespaceQuota != null) {", "author": "cxorm", "createdAt": "2020-07-23T07:49:26Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -58,9 +62,12 @@ protected void execute(OzoneClient client, OzoneAddress address)\n     VolumeArgs.Builder volumeArgsBuilder = VolumeArgs.newBuilder()\n         .setAdmin(adminName)\n         .setOwner(ownerName);\n-    if (quota != null) {\n-      volumeArgsBuilder.setQuota(quota);\n+    if (storagespaceQuota!= null) {", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MTMzMA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459271330", "bodyText": "The function name seems a little redundant.\nSuggestion is commented on VolumeArgs.java.", "author": "cxorm", "createdAt": "2020-07-23T07:49:47Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -58,9 +62,12 @@ protected void execute(OzoneClient client, OzoneAddress address)\n     VolumeArgs.Builder volumeArgsBuilder = VolumeArgs.newBuilder()\n         .setAdmin(adminName)\n         .setOwner(ownerName);\n-    if (quota != null) {\n-      volumeArgsBuilder.setQuota(quota);\n+    if (storagespaceQuota!= null) {\n+      volumeArgsBuilder.setStoragespaceQuota(storagespaceQuota);\n     }\n+\n+    volumeArgsBuilder.setNamespaceQuotaQuota(namespaceQuota);", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MTY5Nw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r459271697", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public VolumeArgs.Builder setNamespaceQuotaQuota(long quota) {\n          \n          \n            \n                public VolumeArgs.Builder setNamespaceQuota(long quota) {", "author": "cxorm", "createdAt": "2020-07-23T07:50:30Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/VolumeArgs.java", "diffHunk": "@@ -122,8 +136,13 @@ public String getQuota() {\n       return this;\n     }\n \n-    public VolumeArgs.Builder setQuota(String quota) {\n-      this.volumeQuota = quota;\n+    public VolumeArgs.Builder setStoragespaceQuota(String quota) {\n+      this.storagespaceQuota = quota;\n+      return this;\n+    }\n+\n+    public VolumeArgs.Builder setNamespaceQuotaQuota(long quota) {", "originalCommit": "8ea2e7b11bd864f65e481fcc680272e8bf9cd1bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b441496f221f4e977ec3acefa729cf9c59cd7f80", "url": "https://github.com/apache/ozone/commit/b441496f221f4e977ec3acefa729cf9c59cd7f80", "message": "fix review issues.", "committedDate": "2020-07-23T14:11:24Z", "type": "forcePushed"}, {"oid": "9070ce523e0807cc7cdb4537cf9148437cbecf83", "url": "https://github.com/apache/ozone/commit/9070ce523e0807cc7cdb4537cf9148437cbecf83", "message": "ignore protobuf lock.", "committedDate": "2020-08-03T11:48:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQyNjUxOQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468426519", "bodyText": "I think we should verify quotaInCounts here, too.", "author": "cxorm", "createdAt": "2020-08-11T08:51:04Z", "path": "hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/server/TestJsonUtils.java", "diffHunk": "@@ -32,11 +32,11 @@\n \n   @Test\n   public void printObjectAsJson() throws IOException {\n-    OzoneQuota quota = new OzoneQuota(123, OzoneQuota.Units.MB);\n+    OzoneQuota quota = OzoneQuota.parseQuota(\"123MB\", 1000L);\n \n     String result = JsonUtils.toJsonStringWithDefaultPrettyPrinter(quota);\n ", "originalCommit": "8e18f1c6ea9ba519b6575573109f6bf95e71c2c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQzMTM2Ng==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468431366", "bodyText": "I think we should verify two quota attributes if the OzoneQuota has two attributes.", "author": "cxorm", "createdAt": "2020-08-11T08:58:54Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java", "diffHunk": "@@ -734,7 +734,8 @@ public void testTempMount() throws Exception {\n     // Sanity check\n     Assert.assertNull(volumeArgs.getOwner());\n     Assert.assertNull(volumeArgs.getAdmin());\n-    Assert.assertNull(volumeArgs.getQuota());\n+    Assert.assertNull(volumeArgs.getQuotaInBytes());\n+    Assert.assertEquals(0, volumeArgs.getQuotaInCounts());", "originalCommit": "8e18f1c6ea9ba519b6575573109f6bf95e71c2c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQzNDYyMA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468434620", "bodyText": "The same as above.\nWe should verify two quota attributes if the OzoneQuota has two attributes.", "author": "cxorm", "createdAt": "2020-08-11T09:04:41Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -271,10 +271,10 @@ public void testSetVolumeQuota()\n       throws IOException {\n     String volumeName = UUID.randomUUID().toString();\n     store.createVolume(volumeName);\n-    store.getVolume(volumeName).setQuota(\n-        OzoneQuota.parseQuota(\"100000000 BYTES\"));\n+    store.getVolume(volumeName).setQuota(OzoneQuota.parseQuota(\"1GB\", 0L));\n     OzoneVolume volume = store.getVolume(volumeName);\n-    Assert.assertEquals(100000000L, volume.getQuota());\n+    Assert.assertEquals(1024 * 1024 * 1024,\n+        volume.getQuotaInBytes());", "originalCommit": "8e18f1c6ea9ba519b6575573109f6bf95e71c2c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "24db1c01f4f816b0931cba04f428129bf80760e3", "url": "https://github.com/apache/ozone/commit/24db1c01f4f816b0931cba04f428129bf80760e3", "message": "fix review issues", "committedDate": "2020-08-11T13:34:48Z", "type": "forcePushed"}, {"oid": "7dcd36a2097ea15d373d63549e901cdc48319ca1", "url": "https://github.com/apache/ozone/commit/7dcd36a2097ea15d373d63549e901cdc48319ca1", "message": "fix review issues and resolve the conflict", "committedDate": "2020-08-11T13:39:41Z", "type": "forcePushed"}, {"oid": "de6b73356f5f16e84ac43069d518e31f4515d288", "url": "https://github.com/apache/ozone/commit/de6b73356f5f16e84ac43069d518e31f4515d288", "message": "Ozone sh volume client support quota option", "committedDate": "2020-08-11T15:11:10Z", "type": "commit"}, {"oid": "f458e176f953376e950e51095e7e1b21f676cc23", "url": "https://github.com/apache/ozone/commit/f458e176f953376e950e51095e7e1b21f676cc23", "message": "fix ut", "committedDate": "2020-08-11T15:11:10Z", "type": "commit"}, {"oid": "29fa3887704f8c19ed8aa9c07172e5f4ea008765", "url": "https://github.com/apache/ozone/commit/29fa3887704f8c19ed8aa9c07172e5f4ea008765", "message": "fix ut.", "committedDate": "2020-08-11T15:11:10Z", "type": "commit"}, {"oid": "0a942f30d53d695985751f373caf86f58d199c5d", "url": "https://github.com/apache/ozone/commit/0a942f30d53d695985751f373caf86f58d199c5d", "message": "Fix naming format", "committedDate": "2020-08-11T15:11:51Z", "type": "commit"}, {"oid": "4b021bf3e893cb43af2bfb215b778dfaadf4c90e", "url": "https://github.com/apache/ozone/commit/4b021bf3e893cb43af2bfb215b778dfaadf4c90e", "message": "improve ut", "committedDate": "2020-08-11T15:12:30Z", "type": "commit"}, {"oid": "5aa512b6a7ce3d52d005746a7dd6a8ff05155499", "url": "https://github.com/apache/ozone/commit/5aa512b6a7ce3d52d005746a7dd6a8ff05155499", "message": "add doc", "committedDate": "2020-08-11T15:12:30Z", "type": "commit"}, {"oid": "079a7a8ae24707fa5f76b5237f1d459726091937", "url": "https://github.com/apache/ozone/commit/079a7a8ae24707fa5f76b5237f1d459726091937", "message": "fix smoketests", "committedDate": "2020-08-11T15:12:30Z", "type": "commit"}, {"oid": "496688c95004a6f5e4af27cf61a125f56fbde3d9", "url": "https://github.com/apache/ozone/commit/496688c95004a6f5e4af27cf61a125f56fbde3d9", "message": "fix review issues", "committedDate": "2020-08-11T15:12:30Z", "type": "commit"}, {"oid": "cb5b5ff4454162632df9da00ebc27fd4b49f80aa", "url": "https://github.com/apache/ozone/commit/cb5b5ff4454162632df9da00ebc27fd4b49f80aa", "message": "fix review issues.", "committedDate": "2020-08-11T15:13:13Z", "type": "commit"}, {"oid": "ab726476da528f02a1e19ed6e52be877189ac06d", "url": "https://github.com/apache/ozone/commit/ab726476da528f02a1e19ed6e52be877189ac06d", "message": "ignore protobuf lock.", "committedDate": "2020-08-11T15:13:13Z", "type": "commit"}, {"oid": "7d7013f6749bd92e1b67bc5d60e259469bd93b1c", "url": "https://github.com/apache/ozone/commit/7d7013f6749bd92e1b67bc5d60e259469bd93b1c", "message": "Delete useless setQuota from OzoneManager and VolumeManager", "committedDate": "2020-08-11T15:13:13Z", "type": "commit"}, {"oid": "00cd1e7f419abd9c4130fedc66c77f13cf5529a0", "url": "https://github.com/apache/ozone/commit/00cd1e7f419abd9c4130fedc66c77f13cf5529a0", "message": "fix review issues and resolve the conflict", "committedDate": "2020-08-11T15:13:13Z", "type": "commit"}, {"oid": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "url": "https://github.com/apache/ozone/commit/a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "message": "Resolve the conflict", "committedDate": "2020-08-11T15:18:30Z", "type": "commit"}, {"oid": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "url": "https://github.com/apache/ozone/commit/a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "message": "Resolve the conflict", "committedDate": "2020-08-11T15:18:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ0MTY4Ng==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468441686", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param quotaInBytesStr Volume quota in bytes String\n          \n          \n            \n               * @param quotaInBytes Volume quota in bytes", "author": "cxorm", "createdAt": "2020-08-11T09:16:41Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -82,25 +135,28 @@ public OzoneQuota(long size, Units unit) {\n    * @return string representation of quota\n    */\n   public static String formatQuota(OzoneQuota quota) {\n-    return String.valueOf(quota.size) + quota.unit;\n+    return String.valueOf(quota.getRawSize())+ quota.getUnit();\n   }\n \n   /**\n    * Parses a user provided string and returns the\n    * Quota Object.\n    *\n-   * @param quotaString Quota String\n+   * @param quotaInBytesStr Volume quota in bytes String", "originalCommit": "8e18f1c6ea9ba519b6575573109f6bf95e71c2c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ0MTc1NA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468441754", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static OzoneQuota parseQuota(String quotaInBytesStr,\n          \n          \n            \n              public static OzoneQuota parseQuota(String quotaInBytes,", "author": "cxorm", "createdAt": "2020-08-11T09:16:48Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -82,25 +135,28 @@ public OzoneQuota(long size, Units unit) {\n    * @return string representation of quota\n    */\n   public static String formatQuota(OzoneQuota quota) {\n-    return String.valueOf(quota.size) + quota.unit;\n+    return String.valueOf(quota.getRawSize())+ quota.getUnit();\n   }\n \n   /**\n    * Parses a user provided string and returns the\n    * Quota Object.\n    *\n-   * @param quotaString Quota String\n+   * @param quotaInBytesStr Volume quota in bytes String\n+   * @param quotaInCounts Volume quota in counts\n    *\n    * @return OzoneQuota object\n    */\n-  public static OzoneQuota parseQuota(String quotaString) {\n+  public static OzoneQuota parseQuota(String quotaInBytesStr,", "originalCommit": "8e18f1c6ea9ba519b6575573109f6bf95e71c2c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY2MzE3MA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468663170", "bodyText": "IMHO I think this part could be added before encountering quota size of MB.\nAnd in line 200 to 201, we should add KB in\nthrow new IllegalArgumentException(\"Quota unit not recognized. \" +\n    \"Supported values are BYTES, MB, GB and TB.\");", "author": "cxorm", "createdAt": "2020-08-11T15:19:37Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -112,6 +168,13 @@ public static OzoneQuota parseQuota(String quotaString) {\n       found = true;\n     }\n \n+    if (uppercase.endsWith(OZONE_QUOTA_KB)) {\n+      size = uppercase\n+          .substring(0, uppercase.length() - OZONE_QUOTA_KB.length());\n+      currUnit = Units.KB;\n+      found = true;\n+    }\n+", "originalCommit": "7dcd36a2097ea15d373d63549e901cdc48319ca1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4Mjg0MQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468682841", "bodyText": "For backward compatibility, I think we should add this method and also keep the original method.\n(User might implemented this interface and ran it on production.)\n@xiaoyuyao, would you please be so kind to provide some thoughts \ud83d\ude04", "author": "cxorm", "createdAt": "2020-08-11T15:47:09Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/protocol/ClientProtocol.java", "diffHunk": "@@ -101,10 +100,11 @@ void createVolume(String volumeName, VolumeArgs args)\n   /**\n    * Set Volume Quota.\n    * @param volumeName Name of the Volume\n-   * @param quota Quota to be set for the Volume\n+   * @param quotaInBytes The maximum size this volume can be used.\n+   * @param quotaInCounts The maximum number of buckets in this volume.\n    * @throws IOException\n    */\n-  void setVolumeQuota(String volumeName, OzoneQuota quota)\n+  void setVolumeQuota(String volumeName, long quotaInBytes, long quotaInCounts)", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwMzM3Ng==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r469003376", "bodyText": "Thanks @cxorm  for the discussion, that's a good question.\nThe previous feature of Ozone on Set quota is virtual, and this interface won't have any actual effect. This feature is incomplete, so no one will use it before.\nOne way to think about it is that this is the new API, and subsequent futures will gradually add new interfaces including clrQuota, etc. Users who want to use full functionality of quota need to update the client.\nSo I think we can think of this part as a new interface without regard to backward compatibility.", "author": "captainzmc", "createdAt": "2020-08-12T04:50:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4Mjg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3Nzg1Mg==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r481477852", "bodyText": "The previous feature of Ozone on Set quota is virtual, and this interface won't have any actual effect. This feature is incomplete, so no one will use it before.\n\nI am fine with it.", "author": "cxorm", "createdAt": "2020-09-01T22:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4Mjg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4MzMyMQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468683321", "bodyText": "As mention in interface side.", "author": "cxorm", "createdAt": "2020-08-11T15:47:55Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -328,12 +332,17 @@ public boolean setVolumeOwner(String volumeName, String owner)\n   }\n \n   @Override\n-  public void setVolumeQuota(String volumeName, OzoneQuota quota)\n-      throws IOException {\n-    verifyVolumeName(volumeName);\n-    Preconditions.checkNotNull(quota);\n-    long quotaInBytes = quota.sizeInBytes();\n-    ozoneManagerClient.setQuota(volumeName, quotaInBytes);\n+  public void setVolumeQuota(String volumeName, long quotaInCounts,", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5MzAxNA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468693014", "bodyText": "The same line could be indented by 4 space.", "author": "cxorm", "createdAt": "2020-08-11T16:02:27Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -62,13 +64,15 @@\n   @SuppressWarnings({\"checkstyle:ParameterNumber\", \"This is invoked from a \" +\n       \"builder.\"})\n   private OmVolumeArgs(String adminName, String ownerName, String volume,\n-                       long quotaInBytes, Map<String, String> metadata,\n-                       OmOzoneAclMap aclMap, long creationTime,\n-                       long modificationTime, long objectID, long updateID) {\n+                       long quotaInBytes, long quotaInCounts,\n+                       Map<String, String> metadata, OmOzoneAclMap aclMap,\n+                       long creationTime, long modificationTime, long objectID,\n+                       long updateID) {", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5NjMxNg==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468696316", "bodyText": "The same as ClientProtocol.java part.\nFor backward compatibility, I think we should add this method and also keep the original method.", "author": "cxorm", "createdAt": "2020-08-11T16:07:36Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/protocol/OzoneManagerProtocol.java", "diffHunk": "@@ -88,10 +88,12 @@\n   /**\n    * Changes the Quota on a volume.\n    * @param volume - Name of the volume.\n-   * @param quota - Quota in bytes.\n+   * @param quotaInCounts - Volume quota in counts.\n+   * @param quotaInBytes - Volume quota in bytes.\n    * @throws IOException\n    */\n-  void setQuota(String volume, long quota) throws IOException;\n+  void setQuota(String volume, long quotaInCounts, long quotaInBytes)\n+      throws IOException;", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5NzMwMA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468697300", "bodyText": "As mentioned in OzoneManagerProtocol.java.", "author": "cxorm", "createdAt": "2020-08-11T16:09:11Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1741,29 +1741,15 @@ public boolean setOwner(String volume, String owner) throws IOException {\n    * Changes the Quota on a volume.\n    *\n    * @param volume - Name of the volume.\n-   * @param quota  - Quota in bytes.\n+   * @param quotaInCounts - Volume quota in counts.\n+   * @param quotaInBytes - Volume quota in bytes.\n    * @throws IOException\n    */\n   @Override\n-  public void setQuota(String volume, long quota) throws IOException {\n-    if (isAclEnabled) {\n-      checkAcls(ResourceType.VOLUME, StoreType.OZONE, ACLType.WRITE, volume,\n-          null, null);\n-    }\n-\n-    Map<String, String> auditMap = buildAuditMap(volume);\n-    auditMap.put(OzoneConsts.QUOTA_IN_BYTES, String.valueOf(quota));\n-    try {\n-      metrics.incNumVolumeUpdates();\n-      volumeManager.setQuota(volume, quota);\n-      AUDIT.logWriteSuccess(buildAuditMessageForSuccess(OMAction.SET_QUOTA,\n-          auditMap));\n-    } catch (Exception ex) {\n-      metrics.incNumVolumeUpdateFails();\n-      AUDIT.logWriteFailure(buildAuditMessageForFailure(OMAction.SET_QUOTA,\n-          auditMap, ex));\n-      throw ex;\n-    }\n+  public void setQuota(String volume, long quotaInCounts,\n+                       long quotaInBytes) throws IOException {\n+    throw new UnsupportedOperationException(\"OzoneManager does not require \" +\n+        \"this to be implemented. As this requests use a new approach\");", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMTE2OA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468701168", "bodyText": "Some discussion on naming parameters is updated in design-doc.\nWe could fix/update here after discussion.", "author": "cxorm", "createdAt": "2020-08-11T16:15:07Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -40,10 +41,13 @@\n       description = \"Owner of the volume\")\n   private String ownerName;\n \n+  @Option(names = {\"--spaceQuota\", \"-s\"},\n+      description = \"Quota in bytes of the newly created volume (eg. 1GB)\")\n+  private String quotaInBytes;\n+\n   @Option(names = {\"--quota\", \"-q\"},\n-      description =\n-          \"Quota of the newly created volume (eg. 1G)\")\n-  private String quota;\n+      description = \"Bucket counts of the newly created volume (eg. 5)\")\n+  private long quotaInCounts = OzoneConsts.QUOTA_COUNT_RESET;", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzE5MQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468703191", "bodyText": "As mentioned in OzoneManagerProtocol.java.", "author": "cxorm", "createdAt": "2020-08-11T16:18:12Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/protocolPB/OzoneManagerProtocolClientSideTranslatorPB.java", "diffHunk": "@@ -258,14 +258,18 @@ public boolean setOwner(String volume, String owner) throws IOException {\n    * Changes the Quota on a volume.\n    *\n    * @param volume - Name of the volume.\n-   * @param quota - Quota in bytes.\n+   * @param quotaInCounts - Volume quota in counts.\n+   * @param quotaInBytes - Volume quota in bytes.\n    * @throws IOException\n    */\n   @Override\n-  public void setQuota(String volume, long quota) throws IOException {\n+  public void setQuota(String volume, long quotaInCounts,\n+      long quotaInBytes) throws IOException {\n     SetVolumePropertyRequest.Builder req =\n         SetVolumePropertyRequest.newBuilder();\n-    req.setVolumeName(volume).setQuotaInBytes(quota);\n+    req.setVolumeName(volume)\n+       .setQuotaInBytes(quotaInBytes)\n+       .setQuotaInCounts(quotaInCounts);", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNDk0Ng==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468704946", "bodyText": "For backward compatibility, I think we should add new API for new attribute and also keep the original public method.", "author": "cxorm", "createdAt": "2020-08-11T16:20:53Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -94,13 +98,15 @@\n   @SuppressWarnings(\"parameternumber\")\n   public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n       String name, String admin, String owner, long quotaInBytes,\n-      long creationTime, List<OzoneAcl> acls, Map<String, String> metadata) {\n+      long quotaInCounts, long creationTime, List<OzoneAcl> acls,\n+      Map<String, String> metadata) {\n     Preconditions.checkNotNull(proxy, \"Client proxy is not set.\");\n     this.proxy = proxy;\n     this.name = name;\n     this.admin = admin;\n     this.owner = owner;\n     this.quotaInBytes = quotaInBytes;\n+    this.quotaInCounts = quotaInCounts;\n     this.creationTime = Instant.ofEpochMilli(creationTime);\n     this.acls = acls;\n     this.listCacheSize = HddsClientUtils.getListCacheSize(conf);", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNTM1Ng==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468705356", "bodyText": "As mentioned above.", "author": "cxorm", "createdAt": "2020-08-11T16:21:31Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -118,19 +124,19 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n   @SuppressWarnings(\"parameternumber\")\n   public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n       String name, String admin, String owner, long quotaInBytes,\n-      long creationTime, long modificationTime, List<OzoneAcl> acls,\n-      Map<String, String> metadata) {\n-    this(conf, proxy, name, admin, owner, quotaInBytes,\n+      long quotaInCounts, long creationTime, long modificationTime,\n+      List<OzoneAcl> acls, Map<String, String> metadata) {\n+    this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n         creationTime, acls, metadata);\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNTgwNg==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468705806", "bodyText": "As mentioned above.", "author": "cxorm", "createdAt": "2020-08-11T16:22:14Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -141,19 +147,23 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n   @SuppressWarnings(\"parameternumber\")\n   public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n       String name, String admin, String owner, long quotaInBytes,\n-      long creationTime, long modificationTime, List<OzoneAcl> acls) {\n-    this(conf, proxy, name, admin, owner, quotaInBytes, creationTime, acls);\n+      long quotaInCounts, long creationTime, long modificationTime,\n+      List<OzoneAcl> acls) {\n+    this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n+        creationTime, acls);\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNjA5Mw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r468706093", "bodyText": "As mentioned above.", "author": "cxorm", "createdAt": "2020-08-11T16:22:43Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -118,19 +124,19 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n   @SuppressWarnings(\"parameternumber\")\n   public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n       String name, String admin, String owner, long quotaInBytes,\n-      long creationTime, long modificationTime, List<OzoneAcl> acls,\n-      Map<String, String> metadata) {\n-    this(conf, proxy, name, admin, owner, quotaInBytes,\n+      long quotaInCounts, long creationTime, long modificationTime,\n+      List<OzoneAcl> acls, Map<String, String> metadata) {\n+    this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n         creationTime, acls, metadata);\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }\n \n   @SuppressWarnings(\"parameternumber\")\n   public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n       String name, String admin, String owner, long quotaInBytes,\n-      long creationTime, List<OzoneAcl> acls) {\n-    this(conf, proxy, name, admin, owner, quotaInBytes, creationTime, acls,\n-        new HashMap<>());\n+      long quotaInCounts, long creationTime, List<OzoneAcl> acls) {\n+    this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n+        creationTime, acls, new HashMap<>());", "originalCommit": "a26f5d8c6c86113f7eccc90b19d66b5497f31a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6e475db3a83dbb63b60cc6f4222796278854d8c", "url": "https://github.com/apache/ozone/commit/d6e475db3a83dbb63b60cc6f4222796278854d8c", "message": "fix ut problems caused by fix conflicts.", "committedDate": "2020-08-12T08:57:31Z", "type": "commit"}, {"oid": "d612a413dedb4fad22edd652b1d8686a7a55f51c", "url": "https://github.com/apache/ozone/commit/d612a413dedb4fad22edd652b1d8686a7a55f51c", "message": "fix some review issues.", "committedDate": "2020-08-12T09:25:14Z", "type": "commit"}, {"oid": "2b914baaf17cc153b917a823ecd9b11d338a821b", "url": "https://github.com/apache/ozone/commit/2b914baaf17cc153b917a823ecd9b11d338a821b", "message": "fix issues as  HDDS-4129 suggested.", "committedDate": "2020-08-27T13:01:59Z", "type": "commit"}, {"oid": "2b914baaf17cc153b917a823ecd9b11d338a821b", "url": "https://github.com/apache/ozone/commit/2b914baaf17cc153b917a823ecd9b11d338a821b", "message": "fix issues as  HDDS-4129 suggested.", "committedDate": "2020-08-27T13:01:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY3NTgxNw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482675817", "bodyText": "rawQuotaInBytes initialization is missed.", "author": "ChenSammi", "createdAt": "2020-09-03T03:07:25Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -53,26 +114,27 @@ public long getSize() {\n    * @return Unit in MB, GB or TB\n    */\n   public Units getUnit() {\n-    return unit;\n+    return this.rawQuotaInBytes.getUnit();\n   }\n \n   /**\n    * Constructs a default Quota object.\n    */\n-  public OzoneQuota() {\n-    this.size = 0;\n-    this.unit = Units.UNDEFINED;\n+  private OzoneQuota() {\n+    this.quotaInCounts = OzoneConsts.QUOTA_RESET;\n+    this.quotaInBytes = OzoneConsts.QUOTA_RESET;", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY3NjAwMg==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482676002", "bodyText": "need space before \"+\"", "author": "ChenSammi", "createdAt": "2020-09-03T03:08:08Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -82,118 +144,130 @@ public OzoneQuota(long size, Units unit) {\n    * @return string representation of quota\n    */\n   public static String formatQuota(OzoneQuota quota) {\n-    return String.valueOf(quota.size) + quota.unit;\n+    return String.valueOf(quota.getRawSize())+ quota.getUnit();", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY3NzA0Ng==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482677046", "bodyText": "Use Strings.isNullOrEmpty instead.", "author": "ChenSammi", "createdAt": "2020-09-03T03:12:02Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -82,118 +144,130 @@ public OzoneQuota(long size, Units unit) {\n    * @return string representation of quota\n    */\n   public static String formatQuota(OzoneQuota quota) {\n-    return String.valueOf(quota.size) + quota.unit;\n+    return String.valueOf(quota.getRawSize())+ quota.getUnit();\n   }\n \n   /**\n    * Parses a user provided string and returns the\n    * Quota Object.\n    *\n-   * @param quotaString Quota String\n+   * @param quotaInBytes Volume quota in bytes\n+   * @param quotaInCounts Volume quota in counts\n    *\n    * @return OzoneQuota object\n    */\n-  public static OzoneQuota parseQuota(String quotaString) {\n+  public static OzoneQuota parseQuota(String quotaInBytes,\n+      long quotaInCounts) {\n \n-    if ((quotaString == null) || (quotaString.isEmpty())) {\n+    if ((quotaInBytes == null) || (quotaInBytes.isEmpty())) {", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4MTAyNg==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482681026", "bodyText": "Bytes Quota -> Space Bytes Quota\nCounts Quota -> Bucket Counts Quota", "author": "ChenSammi", "createdAt": "2020-09-03T03:28:16Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -82,118 +144,130 @@ public OzoneQuota(long size, Units unit) {\n    * @return string representation of quota\n    */\n   public static String formatQuota(OzoneQuota quota) {\n-    return String.valueOf(quota.size) + quota.unit;\n+    return String.valueOf(quota.getRawSize())+ quota.getUnit();\n   }\n \n   /**\n    * Parses a user provided string and returns the\n    * Quota Object.\n    *\n-   * @param quotaString Quota String\n+   * @param quotaInBytes Volume quota in bytes\n+   * @param quotaInCounts Volume quota in counts\n    *\n    * @return OzoneQuota object\n    */\n-  public static OzoneQuota parseQuota(String quotaString) {\n+  public static OzoneQuota parseQuota(String quotaInBytes,\n+      long quotaInCounts) {\n \n-    if ((quotaString == null) || (quotaString.isEmpty())) {\n+    if ((quotaInBytes == null) || (quotaInBytes.isEmpty())) {\n       throw new IllegalArgumentException(\n           \"Quota string cannot be null or empty.\");\n     }\n \n-    String uppercase = quotaString.toUpperCase().replaceAll(\"\\\\s+\", \"\");\n+    String uppercase = quotaInBytes.toUpperCase()\n+        .replaceAll(\"\\\\s+\", \"\");\n     String size = \"\";\n-    int nSize;\n+    long nSize = 0;\n     Units currUnit = Units.MB;\n-    boolean found = false;\n-    if (uppercase.endsWith(OZONE_QUOTA_MB)) {\n-      size = uppercase\n-          .substring(0, uppercase.length() - OZONE_QUOTA_MB.length());\n-      currUnit = Units.MB;\n-      found = true;\n-    }\n+    long quotaMultiplyExact = 0;\n \n-    if (uppercase.endsWith(OZONE_QUOTA_GB)) {\n-      size = uppercase\n-          .substring(0, uppercase.length() - OZONE_QUOTA_GB.length());\n-      currUnit = Units.GB;\n-      found = true;\n-    }\n+    try {\n+      if (uppercase.endsWith(OZONE_QUOTA_KB)) {\n+        size = uppercase\n+            .substring(0, uppercase.length() - OZONE_QUOTA_KB.length());\n+        currUnit = Units.KB;\n+        quotaMultiplyExact = Math.multiplyExact(Long.parseLong(size), KB);\n+      }\n \n-    if (uppercase.endsWith(OZONE_QUOTA_TB)) {\n-      size = uppercase\n-          .substring(0, uppercase.length() - OZONE_QUOTA_TB.length());\n-      currUnit = Units.TB;\n-      found = true;\n-    }\n+      if (uppercase.endsWith(OZONE_QUOTA_MB)) {\n+        size = uppercase\n+            .substring(0, uppercase.length() - OZONE_QUOTA_MB.length());\n+        currUnit = Units.MB;\n+        quotaMultiplyExact = Math.multiplyExact(Long.parseLong(size), MB);\n+      }\n \n-    if (uppercase.endsWith(OZONE_QUOTA_BYTES)) {\n-      size = uppercase\n-          .substring(0, uppercase.length() - OZONE_QUOTA_BYTES.length());\n-      currUnit = Units.BYTES;\n-      found = true;\n-    }\n+      if (uppercase.endsWith(OZONE_QUOTA_GB)) {\n+        size = uppercase\n+            .substring(0, uppercase.length() - OZONE_QUOTA_GB.length());\n+        currUnit = Units.GB;\n+        quotaMultiplyExact = Math.multiplyExact(Long.parseLong(size), GB);\n+      }\n \n-    if (!found) {\n-      throw new IllegalArgumentException(\"Quota unit not recognized. \" +\n-          \"Supported values are BYTES, MB, GB and TB.\");\n+      if (uppercase.endsWith(OZONE_QUOTA_TB)) {\n+        size = uppercase\n+            .substring(0, uppercase.length() - OZONE_QUOTA_TB.length());\n+        currUnit = Units.TB;\n+        quotaMultiplyExact = Math.multiplyExact(Long.parseLong(size), TB);\n+      }\n+\n+      if (uppercase.endsWith(OZONE_QUOTA_BYTES)) {\n+        size = uppercase\n+            .substring(0, uppercase.length() - OZONE_QUOTA_BYTES.length());\n+        currUnit = Units.BYTES;\n+        quotaMultiplyExact = Math.multiplyExact(Long.parseLong(size), 1L);\n+      }\n+      nSize = Long.parseLong(size);\n+    } catch (NumberFormatException e) {\n+      throw new IllegalArgumentException(\"Invalid values for quota, to ensure\" +\n+          \" that the Quota format is legal(supported values are BYTES, KB, \" +\n+          \"MB, GB and TB).\");\n+    } catch  (ArithmeticException e) {\n+      LOG.debug(\"long overflow:\\n{}\", quotaMultiplyExact);\n+      throw new IllegalArgumentException(\"Invalid values for quota, the quota\" +\n+          \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    nSize = Integer.parseInt(size);\n     if (nSize < 0) {\n       throw new IllegalArgumentException(\"Quota cannot be negative.\");\n     }\n \n-    return new OzoneQuota(nSize, currUnit);\n+    return new OzoneQuota(quotaInCounts,\n+        new RawQuotaInBytes(currUnit, nSize));\n   }\n \n \n-  /**\n-   * Returns size in Bytes or -1 if there is no Quota.\n-   */\n-  public long sizeInBytes() {\n-    switch (this.unit) {\n-    case BYTES:\n-      return this.getSize();\n-    case MB:\n-      return this.getSize() * OzoneConsts.MB;\n-    case GB:\n-      return this.getSize() * OzoneConsts.GB;\n-    case TB:\n-      return this.getSize() * OzoneConsts.TB;\n-    case UNDEFINED:\n-    default:\n-      return -1;\n-    }\n-  }\n-\n   /**\n    * Returns OzoneQuota corresponding to size in bytes.\n    *\n-   * @param sizeInBytes size in bytes to be converted\n+   * @param quotaInBytes in bytes to be converted\n+   * @param quotaInCounts in counts to be converted\n    *\n    * @return OzoneQuota object\n    */\n-  public static OzoneQuota getOzoneQuota(long sizeInBytes) {\n+  public static OzoneQuota getOzoneQuota(long quotaInBytes,\n+      long quotaInCounts) {\n     long size;\n     Units unit;\n-    if (sizeInBytes % OzoneConsts.TB == 0) {\n-      size = sizeInBytes / OzoneConsts.TB;\n+    if (quotaInBytes % TB == 0) {\n+      size = quotaInBytes / TB;\n       unit = Units.TB;\n-    } else if (sizeInBytes % OzoneConsts.GB == 0) {\n-      size = sizeInBytes / OzoneConsts.GB;\n+    } else if (quotaInBytes % GB == 0) {\n+      size = quotaInBytes / GB;\n       unit = Units.GB;\n-    } else if (sizeInBytes % OzoneConsts.MB == 0) {\n-      size = sizeInBytes / OzoneConsts.MB;\n+    } else if (quotaInBytes % MB == 0) {\n+      size = quotaInBytes / MB;\n       unit = Units.MB;\n+    } else if (quotaInBytes % KB == 0) {\n+      size = quotaInBytes / KB;\n+      unit = Units.KB;\n     } else {\n-      size = sizeInBytes;\n+      size = quotaInBytes;\n       unit = Units.BYTES;\n     }\n-    return new OzoneQuota((int)size, unit);\n+    return new OzoneQuota(quotaInCounts, new RawQuotaInBytes(unit, size));\n+  }\n+\n+  public long getQuotaInCounts() {\n+    return quotaInCounts;\n+  }\n+\n+  public long getQuotaInBytes() {\n+    return quotaInBytes;\n   }\n \n   @Override\n   public String toString() {\n-    return size + \" \" + unit;\n+    return \"Bytes Quota: \" + rawQuotaInBytes.toString() + \"\\n\" +", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4MTM2MQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482681361", "bodyText": "Shall we rename this class name to VolumeQuota?", "author": "ChenSammi", "createdAt": "2020-09-03T03:29:41Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -19,32 +19,93 @@\n package org.apache.hadoop.hdds.client;\n \n import org.apache.hadoop.ozone.OzoneConsts;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.hadoop.ozone.OzoneConsts.GB;\n+import static org.apache.hadoop.ozone.OzoneConsts.KB;\n+import static org.apache.hadoop.ozone.OzoneConsts.MB;\n+import static org.apache.hadoop.ozone.OzoneConsts.TB;\n \n \n /**\n  * represents an OzoneQuota Object that can be applied to\n  * a storage volume.\n  */\n-public class OzoneQuota {\n+public final class OzoneQuota {", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NDU5Mw==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482894593", "bodyText": "Subsequent bucket quota is also intended to use this class, so we might need a more generic name here.", "author": "captainzmc", "createdAt": "2020-09-03T11:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4MTM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4MTk0MA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482681940", "bodyText": "which means it does not take effect -> which means quota is not set", "author": "ChenSammi", "createdAt": "2020-09-03T03:31:53Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -204,6 +204,16 @@ public static Versioning getVersioning(boolean versioning) {\n    */\n   public static final long MAX_QUOTA_IN_BYTES = 1024L * 1024 * TB;\n \n+  /**\n+   * Quota RESET default is -1, which means it does not take effect.", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NTI5OA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482685298", "bodyText": "--quota  -> bucketQuota\n-q -> -bq", "author": "ChenSammi", "createdAt": "2020-09-03T03:44:33Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -40,10 +41,13 @@\n       description = \"Owner of the volume\")\n   private String ownerName;\n \n+  @Option(names = {\"--spaceQuota\", \"-s\"},\n+      description = \"Quota in bytes of the newly created volume (eg. 1GB)\")\n+  private String quotaInBytes;\n+\n   @Option(names = {\"--quota\", \"-q\"},", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NTM2MQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482685361", "bodyText": "-s -> -sq", "author": "ChenSammi", "createdAt": "2020-09-03T03:44:49Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -40,10 +41,13 @@\n       description = \"Owner of the volume\")\n   private String ownerName;\n \n+  @Option(names = {\"--spaceQuota\", \"-s\"},", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkxMzM5MA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482913390", "bodyText": "The abbreviation of this parameter was previously confirmed with Yisheng. In general, the parameter abbreviation is a single letter, in order to keep the same with other parameters here sq->s.\nOf course, For better understanding, I added a detailed description.", "author": "captainzmc", "createdAt": "2020-09-03T11:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NTM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI1ODExOQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r483258119", "bodyText": "I'm fine with the comment with @ChenSammi.\nLet's update it.", "author": "cxorm", "createdAt": "2020-09-03T21:15:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NTM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4NDU5MQ==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r483384591", "bodyText": "Agreed, I will fix the naming problem.", "author": "captainzmc", "createdAt": "2020-09-04T04:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NTM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NTUwNA==", "url": "https://github.com/apache/ozone/pull/1233#discussion_r482685504", "bodyText": "same as above", "author": "ChenSammi", "createdAt": "2020-09-03T03:45:22Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/UpdateVolumeHandler.java", "diffHunk": "@@ -39,22 +40,33 @@\n       description = \"Owner of the volume to set\")\n   private String ownerName;\n \n-  @Option(names = {\"--quota\"},\n-      description = \"Quota of the volume to set\"\n-          + \"(eg. 1G)\")\n-  private String quota;\n+  @Option(names = {\"--spaceQuota\", \"-s\"},", "originalCommit": "2b914baaf17cc153b917a823ecd9b11d338a821b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cac21a6ef21c729771fd047eb86739a4407b4129", "url": "https://github.com/apache/ozone/commit/cac21a6ef21c729771fd047eb86739a4407b4129", "message": "fix review issues.", "committedDate": "2020-09-03T12:05:55Z", "type": "commit"}, {"oid": "813c8d89c78596ebb7c7c721fbada91b57343b55", "url": "https://github.com/apache/ozone/commit/813c8d89c78596ebb7c7c721fbada91b57343b55", "message": "fix review issues.", "committedDate": "2020-09-04T05:01:19Z", "type": "commit"}]}