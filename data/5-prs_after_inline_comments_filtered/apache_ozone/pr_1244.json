{"pr_number": 1244, "pr_title": "HDDS-3999. OM Shutdown when Commit part tries to commit the part, after abort upload.", "pr_createdAt": "2020-07-22T22:48:28Z", "pr_url": "https://github.com/apache/ozone/pull/1244", "timeline": [{"oid": "b9f82671a671e44caf53263f3f80b0d6907e3354", "url": "https://github.com/apache/ozone/commit/b9f82671a671e44caf53263f3f80b0d6907e3354", "message": "HDDS-3999. OM NPE and shutdown while S3MultipartUploadCommitPartResponse#checkAndUpdateDB.", "committedDate": "2020-07-22T22:45:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE3OTMzMQ==", "url": "https://github.com/apache/ozone/pull/1244#discussion_r459179331", "bodyText": "Please remove the extra blank line.", "author": "maobaolong", "createdAt": "2020-07-23T02:06:00Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -1911,10 +1912,45 @@ public void testAbortUploadFail() throws Exception {\n     volume.createBucket(bucketName);\n     OzoneBucket bucket = volume.getBucket(bucketName);\n \n-    OzoneTestUtils.expectOmException(ResultCodes.NO_SUCH_MULTIPART_UPLOAD_ERROR,\n+    OzoneTestUtils.expectOmException(NO_SUCH_MULTIPART_UPLOAD_ERROR,\n         () -> bucket.abortMultipartUpload(keyName, \"random\"));\n   }\n \n+  @Test\n+  public void testAbortUploadFailWithInProgressPartUpload() throws Exception {\n+    String volumeName = UUID.randomUUID().toString();\n+    String bucketName = UUID.randomUUID().toString();\n+    String keyName = UUID.randomUUID().toString();\n+\n+    store.createVolume(volumeName);\n+    OzoneVolume volume = store.getVolume(volumeName);\n+    volume.createBucket(bucketName);\n+    OzoneBucket bucket = volume.getBucket(bucketName);\n+\n+    OmMultipartInfo omMultipartInfo = bucket.initiateMultipartUpload(keyName,\n+        STAND_ALONE, ONE);\n+\n+    Assert.assertNotNull(omMultipartInfo.getUploadID());\n+\n+    // Do not close output stream.\n+    byte[] data = \"data\".getBytes(UTF_8);\n+    OzoneOutputStream ozoneOutputStream = bucket.createMultipartKey(keyName,\n+        data.length, 1, omMultipartInfo.getUploadID());\n+    ozoneOutputStream.write(data, 0, data.length);\n+\n+    // Abort before completing part upload.\n+    bucket.abortMultipartUpload(keyName, omMultipartInfo.getUploadID());\n+\n+    try {\n+      ozoneOutputStream.close();\n+    } catch (IOException ex) {\n+      assertTrue(ex instanceof OMException);\n+      assertEquals(NO_SUCH_MULTIPART_UPLOAD_ERROR,\n+          ((OMException) ex).getResult());\n+    }\n+", "originalCommit": "b9f82671a671e44caf53263f3f80b0d6907e3354", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE4MDAyOA==", "url": "https://github.com/apache/ozone/pull/1244#discussion_r459180028", "bodyText": "Please add a fail() here", "author": "maobaolong", "createdAt": "2020-07-23T02:09:30Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -1911,10 +1912,45 @@ public void testAbortUploadFail() throws Exception {\n     volume.createBucket(bucketName);\n     OzoneBucket bucket = volume.getBucket(bucketName);\n \n-    OzoneTestUtils.expectOmException(ResultCodes.NO_SUCH_MULTIPART_UPLOAD_ERROR,\n+    OzoneTestUtils.expectOmException(NO_SUCH_MULTIPART_UPLOAD_ERROR,\n         () -> bucket.abortMultipartUpload(keyName, \"random\"));\n   }\n \n+  @Test\n+  public void testAbortUploadFailWithInProgressPartUpload() throws Exception {\n+    String volumeName = UUID.randomUUID().toString();\n+    String bucketName = UUID.randomUUID().toString();\n+    String keyName = UUID.randomUUID().toString();\n+\n+    store.createVolume(volumeName);\n+    OzoneVolume volume = store.getVolume(volumeName);\n+    volume.createBucket(bucketName);\n+    OzoneBucket bucket = volume.getBucket(bucketName);\n+\n+    OmMultipartInfo omMultipartInfo = bucket.initiateMultipartUpload(keyName,\n+        STAND_ALONE, ONE);\n+\n+    Assert.assertNotNull(omMultipartInfo.getUploadID());\n+\n+    // Do not close output stream.\n+    byte[] data = \"data\".getBytes(UTF_8);\n+    OzoneOutputStream ozoneOutputStream = bucket.createMultipartKey(keyName,\n+        data.length, 1, omMultipartInfo.getUploadID());\n+    ozoneOutputStream.write(data, 0, data.length);\n+\n+    // Abort before completing part upload.\n+    bucket.abortMultipartUpload(keyName, omMultipartInfo.getUploadID());\n+\n+    try {\n+      ozoneOutputStream.close();", "originalCommit": "b9f82671a671e44caf53263f3f80b0d6907e3354", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6b0d492ab01ff85628489ba657432988b9ba8b8", "url": "https://github.com/apache/ozone/commit/d6b0d492ab01ff85628489ba657432988b9ba8b8", "message": "address review comments", "committedDate": "2020-07-23T17:59:19Z", "type": "commit"}, {"oid": "e785b02f9f1591348d0632e99276c7cf78fd44a7", "url": "https://github.com/apache/ozone/commit/e785b02f9f1591348d0632e99276c7cf78fd44a7", "message": "add test", "committedDate": "2020-07-23T18:26:51Z", "type": "commit"}]}