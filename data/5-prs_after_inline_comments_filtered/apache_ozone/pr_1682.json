{"pr_number": 1682, "pr_title": "HDDS-4574. Inconsistencies in case the parent of a open file is deleted/renamed.", "pr_createdAt": "2020-12-10T08:01:58Z", "pr_url": "https://github.com/apache/ozone/pull/1682", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA0NzA3OA==", "url": "https://github.com/apache/ozone/pull/1682#discussion_r540047078", "bodyText": "Can you move this check inside ozoneManager.getEnableFileSystemPaths() == true case to do this only for FileSystem api.\nFor example, bucket#createKey & OzoneOutputStream#close() in turn make OMKeyCommitRequest call.", "author": "rakeshadr", "createdAt": "2020-12-10T10:19:30Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -172,6 +173,16 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         throw new OMException(\"Failed to commit key, as \" + dbOpenKey +\n             \"entry is not found in the OpenKey table\", KEY_NOT_FOUND);\n       }\n+\n+      // Ensure the parent exist.\n+      if (!\"\".equals(OzoneFSUtils.getParent(keyName))", "originalCommit": "d493ebdde5186d26d61a524fba8eb01ab7a39803", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDIwNjc2NA==", "url": "https://github.com/apache/ozone/pull/1682#discussion_r540206764", "bodyText": "Thanx @rakeshadr for the review.\nI have moved the check inside ozoneManager.getEnableFileSystemPaths() == true and added the same logic and tests for OMAllocateBlockRequest as well. Please have a look..", "author": "ayushtkn", "createdAt": "2020-12-10T14:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA0NzA3OA=="}], "type": "inlineReview"}, {"oid": "9a75f427e9888ec049e73b897adef40a7ae1296e", "url": "https://github.com/apache/ozone/commit/9a75f427e9888ec049e73b897adef40a7ae1296e", "message": "HDDS-4574. Inconsistencies in case the parent of a open file is deleted/renamed.", "committedDate": "2020-12-10T12:48:04Z", "type": "forcePushed"}, {"oid": "79906c33078b818bb51e9a5c9867544238f06459", "url": "https://github.com/apache/ozone/commit/79906c33078b818bb51e9a5c9867544238f06459", "message": "Fix Checkstyle.", "committedDate": "2020-12-15T10:45:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NzI0Mg==", "url": "https://github.com/apache/ozone/pull/1682#discussion_r543567242", "bodyText": "Just a question: Right now delete/rename is not an atomic operation, so will just checking the parent Dir is enough?\nBut this will help, once we have HDDS-2939 where we have atomic delete/renames.", "author": "bharatviswa504", "createdAt": "2020-12-15T18:03:14Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -192,6 +193,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n             KEY_NOT_FOUND);\n       }\n \n+      if (ozoneManager.getEnableFileSystemPaths()) {\n+        // Ensure the parent exist.\n+        if (!\"\".equals(OzoneFSUtils.getParent(keyName))", "originalCommit": "79906c33078b818bb51e9a5c9867544238f06459", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3MDAxNA==", "url": "https://github.com/apache/ozone/pull/1682#discussion_r543570014", "bodyText": "And also for performance reasons, can we leave allocateBlock, as during KeyCommit anyway we shall figure it out?\nAs this will save one extra DB op, (this might not be a problem again once HDDS-2939 comes in, as it has directory cache)\nBut I am fine with if we want to catch early also? Just thought of bringing this here.", "author": "bharatviswa504", "createdAt": "2020-12-15T18:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg2MTEyMQ==", "url": "https://github.com/apache/ozone/pull/1682#discussion_r543861121", "bodyText": "Thanx @bharatviswa504 for the review.\n\nRight now delete/rename is not an atomic operation, so will just checking the parent Dir is enough?\n\nIs there anything else, that can be checked? Yahh, there might be some issue because of non atomic behaviour delete/rename. Will pulling this check inside lock, solve them or lead to a better state?\n\nAnd also for performance reasons, can we leave allocateBlock, as during KeyCommit anyway we shall figure it out?\n\nRakesh suggested to add the check in allocateBlock, I think for a fail-fast approach, If we tend to fail during the commit phase and we know that at the allocateBlock phase, we should fail at an earlier stage itself, rather than going till the end. Might save a messed up client, if he is writing a big file.\nBut I am not very aware about the performance impacts and HDDS-2939 both, so I am ok both ways.\n@rakeshadr any thoughts on this?", "author": "ayushtkn", "createdAt": "2020-12-16T02:55:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMzI3OA==", "url": "https://github.com/apache/ozone/pull/1682#discussion_r544123278", "bodyText": "And also for performance reasons, can we leave allocateBlock, as during KeyCommit anyway we shall figure it out?\n\nOn a second thought, it makes sense to me to avoid any additional DB calls which can affect the OM performance. Most of the cases, parent directories would exists in RocksDB offheap cache even then I would agree to skip parentDir check considering the cost of DB call if not exist.\nOn the other side, I think there won't be any correctness issue if we skip parent dir check in AllocateBlockReq. Later, we can bring this fast-fail check based on user demand. Considering that, I'm +1 to skip extra DB check in AllocateBlockReq now.\nThanks a lot @ayushtkn for your patience and taking care this. I agree to revert the changes from OmAllocateBlockRequest.\n\nBut I am not very aware about the performance impacts and HDDS-2939 both\n\nIn HDDS-2939, in order to fetch openFileName, it requires to traverse top-down model and parentDir check won't add any additional overhead. For example, say open file /a/b/c/d/file1.\nHDDS-2939 branch: OM will fetch /a, /a/b, /a/b/c, /a/b/c/d from DirTable and finally get /a/b/c/d/file1 from OpenFileTable. Here, one idea is to build DirCache to reduce DB overhead. @bharatviswa504 was talking about this part in his previous comment.\nMaster branch: OM will do point look up by fetching /a/b/c/d from KeyTable. Here, existing RocksDB offheap cache would help.", "author": "rakeshadr", "createdAt": "2020-12-16T08:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMwMjU4NQ==", "url": "https://github.com/apache/ozone/pull/1682#discussion_r544302585", "bodyText": "Thanx Rakesh for sharing the details, makes sense, Will explore more :-)\nI have removed the check from AllocateBlock as suggested.\n@bharatviswa504 Please give a check once agin, if things make sense now. Thanx...", "author": "ayushtkn", "createdAt": "2020-12-16T13:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYwOTA4NQ==", "url": "https://github.com/apache/ozone/pull/1682#discussion_r545609085", "bodyText": "Is there anything else, that can be checked? Yahh, there might be some issue because of non atomic behaviour delete/rename. Will pulling this check inside lock, solve them or lead to a better state?\n\nAs due to non-atomic behavior whole path check can help here. But this issue will be solved once HDDS-2939 comes in. And also this check is done under lock even right now. Let's have this way for now.", "author": "bharatviswa504", "createdAt": "2020-12-18T06:59:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NzI0Mg=="}], "type": "inlineReview"}, {"oid": "d5085e74172d77a9311af98d323540ac99cffb58", "url": "https://github.com/apache/ozone/commit/d5085e74172d77a9311af98d323540ac99cffb58", "message": "HDDS-4574. Inconsistencies in case the parent of a open file is deleted/renamed.", "committedDate": "2020-12-16T09:31:26Z", "type": "commit"}, {"oid": "d5085e74172d77a9311af98d323540ac99cffb58", "url": "https://github.com/apache/ozone/commit/d5085e74172d77a9311af98d323540ac99cffb58", "message": "HDDS-4574. Inconsistencies in case the parent of a open file is deleted/renamed.", "committedDate": "2020-12-16T09:31:26Z", "type": "forcePushed"}, {"oid": "0b88f3d358b0c0e731d504a09cefb3e643f840be", "url": "https://github.com/apache/ozone/commit/0b88f3d358b0c0e731d504a09cefb3e643f840be", "message": "Fix test.", "committedDate": "2020-12-16T10:59:19Z", "type": "commit"}, {"oid": "4d25584c7a82dc14199de791cdc696090eea1645", "url": "https://github.com/apache/ozone/commit/4d25584c7a82dc14199de791cdc696090eea1645", "message": "Fix checkstyle.", "committedDate": "2020-12-16T11:27:04Z", "type": "commit"}]}