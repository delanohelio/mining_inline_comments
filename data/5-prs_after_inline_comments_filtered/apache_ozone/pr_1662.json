{"pr_number": 1662, "pr_title": "HDDS-4507. Add SCM CA CLI to query certificate.", "pr_createdAt": "2020-12-05T13:54:21Z", "pr_url": "https://github.com/apache/ozone/pull/1662", "timeline": [{"oid": "b6dba8c5a9b2c997ae6830be001cfb9c2e47dba5", "url": "https://github.com/apache/ozone/commit/b6dba8c5a9b2c997ae6830be001cfb9c2e47dba5", "message": "HDDS-4507. Add SCM CA CLI to query certificate.", "committedDate": "2020-12-05T05:04:52Z", "type": "commit"}, {"oid": "5ea8c57467cc4b6f32a707b4ad7eae31e6f2c4e0", "url": "https://github.com/apache/ozone/commit/5ea8c57467cc4b6f32a707b4ad7eae31e6f2c4e0", "message": "checkstyle", "committedDate": "2020-12-05T14:03:59Z", "type": "commit"}, {"oid": "171250a2448bb8e3a01939250a5f6fef9caced01", "url": "https://github.com/apache/ozone/commit/171250a2448bb8e3a01939250a5f6fef9caced01", "message": "checkstyle 2", "committedDate": "2020-12-05T14:17:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NzA0Mg==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r537267042", "bodyText": "Show we throw out the IOException here? The caller may not be aware of the exception happened here from the returned results.", "author": "GlenGeng", "createdAt": "2020-12-07T06:46:58Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMCertStore.java", "diffHunk": "@@ -112,4 +117,39 @@ public X509Certificate getCertificateByID(BigInteger serialID,\n       return scmMetadataStore.getRevokedCertsTable().get(serialID);\n     }\n   }\n+\n+  @Override\n+  public List<X509Certificate> listCertificate(HddsProtos.NodeType role,\n+      BigInteger startSerialID, int count, CertType certType)\n+      throws IOException {\n+    // TODO: Filter by role\n+    List<? extends Table.KeyValue<BigInteger, X509Certificate>> certs;\n+    if (startSerialID.longValue() == 0) {\n+      startSerialID = null;\n+    }\n+    if (certType == CertType.VALID_CERTS) {\n+      certs = scmMetadataStore.getValidCertsTable().getRangeKVs(\n+          startSerialID, count);\n+    } else {\n+      certs = scmMetadataStore.getRevokedCertsTable().getRangeKVs(\n+          startSerialID, count);\n+    }\n+    List<X509Certificate> results = new ArrayList<>(certs.size());\n+    for (Table.KeyValue<BigInteger, X509Certificate> kv : certs) {\n+      try {\n+        X509Certificate cert = kv.getValue();\n+        // TODO: filter certificate based on CN and specified role.\n+        // This requires change of the approved subject CN format:\n+        // Subject: O=CID-e66d4728-32bb-4282-9770-351a7e913f07,\n+        // OU=9a7c4f86-c862-4067-b12c-e7bca51d3dfe, CN=root@98dba189d5f0\n+\n+        // The new format will look like below that are easier to filter.\n+        // CN=FQDN/user=root/role=datanode/...\n+        results.add(cert);\n+      } catch (IOException e) {\n+        LOG.error(\"Fail to get certificate from SCM metadata store\", e);", "originalCommit": "171250a2448bb8e3a01939250a5f6fef9caced01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzOTA1Mg==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r539039052", "bodyText": "Fixed in the new commits.", "author": "xiaoyuyao", "createdAt": "2020-12-09T06:19:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NzA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2ODI5MA==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r537268290", "bodyText": "ditto", "author": "GlenGeng", "createdAt": "2020-12-07T06:50:20Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMSecurityProtocolServer.java", "diffHunk": "@@ -192,6 +195,33 @@ public String getCACertificate() throws IOException {\n     }\n   }\n \n+  /**\n+   *\n+   * @param role            - node role: OM/SCM/DN.\n+   * @param startSerialId   - start certificate serial id.\n+   * @param count           - max number of certificates returned in a batch.\n+   * @param isRevoked       - whether list for revoked certs only.\n+   * @return\n+   * @throws IOException\n+   */\n+  @Override\n+  public List<String> listCertificate(HddsProtos.NodeType role,\n+      long startSerialId, int count, boolean isRevoked) throws IOException {\n+    List<X509Certificate> certificates =\n+        certificateServer.listCertificate(role, startSerialId, count,\n+            isRevoked);\n+    List<String> results = new ArrayList<>(certificates.size());\n+    for (X509Certificate cert : certificates) {\n+      try {\n+        String certStr = CertificateCodec.getPEMEncodedString(cert);\n+        results.add(certStr);\n+      } catch (SCMSecurityException e) {\n+        LOGGER.error(\"listCertificate fail to encode certificate.\", e);", "originalCommit": "171250a2448bb8e3a01939250a5f6fef9caced01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzOTEyNQ==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r539039125", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-12-09T06:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2ODI5MA=="}], "type": "inlineReview"}, {"oid": "351a85a10ffcc7bb6061cd189a250744aebd3f39", "url": "https://github.com/apache/ozone/commit/351a85a10ffcc7bb6061cd189a250744aebd3f39", "message": "address code review comments", "committedDate": "2020-12-09T06:18:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwODA4Mg==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r542908082", "bodyText": "Nit: getCertificates may be a better name here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              List<String> listCertificate(HddsProtos.NodeType type, long startSerialId,\n          \n          \n            \n              List<String> getCertificates(HddsProtos.NodeType type, long startSerialId,", "author": "vivekratnavel", "createdAt": "2020-12-14T23:02:45Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/protocol/SCMSecurityProtocol.java", "diffHunk": "@@ -77,4 +80,16 @@ String getOMCertificate(OzoneManagerDetailsProto omDetails,\n    */\n   String getCACertificate() throws IOException;\n \n+  /**\n+   * Get list of certificates meet the query criteria.\n+   *\n+   * @param type            - node type: OM/SCM/DN.\n+   * @param startSerialId   - start certificate serial id.\n+   * @param count           - max number of certificates returned in a batch.\n+   * @param isRevoked       - whether list for revoked certs only.\n+   * @return list of PEM encoded certificate strings.\n+   */\n+  List<String> listCertificate(HddsProtos.NodeType type, long startSerialId,", "originalCommit": "351a85a10ffcc7bb6061cd189a250744aebd3f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5NTc5Mg==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r543795792", "bodyText": "list is chosen here instead of get to be consistent with similar API/CLI for pipeline/container/blocks.", "author": "xiaoyuyao", "createdAt": "2020-12-16T00:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwODA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxMjAzNA==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r542912034", "bodyText": "Nit: getCertificates may be a better name here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              List<X509Certificate> listCertificate(HddsProtos.NodeType type,\n          \n          \n            \n              List<X509Certificate> getCertificates(HddsProtos.NodeType type,", "author": "vivekratnavel", "createdAt": "2020-12-14T23:07:47Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/security/x509/certificate/authority/CertificateServer.java", "diffHunk": "@@ -112,6 +114,16 @@ X509Certificate getCertificate(String certSerialId)\n    * framework.\n    */\n \n+  /**\n+   * List certificates.\n+   * @param type            - node type: OM/SCM/DN\n+   * @param startSerialId   - start certificate serial id\n+   * @param count           - max number of certificates returned in a batch\n+   * @return\n+   * @throws IOException\n+   */\n+  List<X509Certificate> listCertificate(HddsProtos.NodeType type,", "originalCommit": "351a85a10ffcc7bb6061cd189a250744aebd3f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5NTg1Nw==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r543795857", "bodyText": "Same as above.", "author": "xiaoyuyao", "createdAt": "2020-12-16T00:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxMjAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMDgzMQ==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r542930831", "bodyText": "Nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                description = \"Show detail information of a specific certificate\",\n          \n          \n            \n                description = \"Show detailed information for a specific certificate\",", "author": "vivekratnavel", "createdAt": "2020-12-14T23:50:14Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/cert/InfoSubcommand.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm.cli.cert;\n+\n+import java.io.IOException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.hdds.cli.GenericParentCommand;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.protocol.SCMSecurityProtocol;\n+\n+import org.apache.hadoop.hdds.security.x509.certificate.utils.CertificateCodec;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Model.CommandSpec;\n+import picocli.CommandLine.Parameters;\n+import picocli.CommandLine.Spec;\n+\n+/**\n+ * This is the handler that process certificate info command.\n+ */\n+@Command(\n+    name = \"info\",\n+    description = \"Show detail information of a specific certificate\",", "originalCommit": "351a85a10ffcc7bb6061cd189a250744aebd3f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5Njc3Mg==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r543796772", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-12-16T00:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMDgzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMTM4MA==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r542931380", "bodyText": "Nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.error(\"Fail to get certificate id \" + serialId);\n          \n          \n            \n                  LOG.error(\"Failed to get certificate id \" + serialId);", "author": "vivekratnavel", "createdAt": "2020-12-14T23:51:36Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/cert/InfoSubcommand.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm.cli.cert;\n+\n+import java.io.IOException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.hdds.cli.GenericParentCommand;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.protocol.SCMSecurityProtocol;\n+\n+import org.apache.hadoop.hdds.security.x509.certificate.utils.CertificateCodec;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Model.CommandSpec;\n+import picocli.CommandLine.Parameters;\n+import picocli.CommandLine.Spec;\n+\n+/**\n+ * This is the handler that process certificate info command.\n+ */\n+@Command(\n+    name = \"info\",\n+    description = \"Show detail information of a specific certificate\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+class InfoSubcommand extends ScmCertSubcommand {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(InfoSubcommand.class);\n+\n+  @Spec\n+  private CommandSpec spec;\n+\n+  @Parameters(description = \"Serial id of the certificate in decimal.\")\n+  private String serialId;\n+\n+  @Override\n+  public void execute(SCMSecurityProtocol client) throws IOException {\n+    final String certPemStr =\n+        client.getCertificate(serialId);\n+    Preconditions.checkNotNull(certPemStr,\n+        \"Certificate can't be found\");\n+\n+    // Print container report info.\n+    LOG.info(\"Certificate id: {}\", serialId);\n+    boolean verbose = spec.root().userObject() instanceof GenericParentCommand\n+        && ((GenericParentCommand) spec.root().userObject()).isVerbose();\n+    try {\n+      X509Certificate cert = CertificateCodec.getX509Cert(certPemStr);\n+      LOG.info(cert.toString());\n+    } catch (CertificateException ex) {\n+      LOG.error(\"Fail to get certificate id \" + serialId);", "originalCommit": "351a85a10ffcc7bb6061cd189a250744aebd3f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5NjAyMg==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r543796022", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-12-16T00:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMTM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMTUzMw==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r542931533", "bodyText": "Nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new IOException(\"Fail to get certificate id \" + serialId, ex);\n          \n          \n            \n                  throw new IOException(\"Failed to get certificate id \" + serialId, ex);", "author": "vivekratnavel", "createdAt": "2020-12-14T23:51:58Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/cert/InfoSubcommand.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm.cli.cert;\n+\n+import java.io.IOException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.hdds.cli.GenericParentCommand;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.protocol.SCMSecurityProtocol;\n+\n+import org.apache.hadoop.hdds.security.x509.certificate.utils.CertificateCodec;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Model.CommandSpec;\n+import picocli.CommandLine.Parameters;\n+import picocli.CommandLine.Spec;\n+\n+/**\n+ * This is the handler that process certificate info command.\n+ */\n+@Command(\n+    name = \"info\",\n+    description = \"Show detail information of a specific certificate\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+class InfoSubcommand extends ScmCertSubcommand {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(InfoSubcommand.class);\n+\n+  @Spec\n+  private CommandSpec spec;\n+\n+  @Parameters(description = \"Serial id of the certificate in decimal.\")\n+  private String serialId;\n+\n+  @Override\n+  public void execute(SCMSecurityProtocol client) throws IOException {\n+    final String certPemStr =\n+        client.getCertificate(serialId);\n+    Preconditions.checkNotNull(certPemStr,\n+        \"Certificate can't be found\");\n+\n+    // Print container report info.\n+    LOG.info(\"Certificate id: {}\", serialId);\n+    boolean verbose = spec.root().userObject() instanceof GenericParentCommand\n+        && ((GenericParentCommand) spec.root().userObject()).isVerbose();\n+    try {\n+      X509Certificate cert = CertificateCodec.getX509Cert(certPemStr);\n+      LOG.info(cert.toString());\n+    } catch (CertificateException ex) {\n+      LOG.error(\"Fail to get certificate id \" + serialId);\n+      throw new IOException(\"Fail to get certificate id \" + serialId, ex);", "originalCommit": "351a85a10ffcc7bb6061cd189a250744aebd3f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5NjU1OQ==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r543796559", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-12-16T00:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMTUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMzA0OA==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r542933048", "bodyText": "Nit: May be \"Valid Until\" or \"Expiry\" will suit better here. And instead of subjectDN, can we use subject?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOG.info(\"SerialNumber\\t\\tValid From\\t\\tValid To\\t\\tSubjectDN\");\n          \n          \n            \n                LOG.info(\"SerialNumber\\t\\tValid From\\t\\tExpiry\\t\\tSubject\");", "author": "vivekratnavel", "createdAt": "2020-12-14T23:55:57Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/cert/ListSubcommand.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm.cli.cert;\n+\n+import java.io.IOException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+import java.util.List;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.protocol.SCMSecurityProtocol;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.security.x509.certificate.utils.CertificateCodec;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Help.Visibility;\n+import picocli.CommandLine.Option;\n+\n+/**\n+ * This is the handler that process certificate list command.\n+ */\n+@Command(\n+    name = \"list\",\n+    description = \"List certificates\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+public class ListSubcommand extends ScmCertSubcommand {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(ListSubcommand.class);\n+\n+  @Option(names = {\"-s\", \"--start\"},\n+      description = \"Certificate serial id to start the iteration\",\n+      defaultValue = \"0\", showDefaultValue = Visibility.ALWAYS)\n+  private long startSerialId;\n+\n+  @Option(names = {\"-c\", \"--count\"},\n+      description = \"Maximum number of certificates to list\",\n+      defaultValue = \"20\", showDefaultValue = Visibility.ALWAYS)\n+  private int count;\n+\n+  @Option(names = {\"-r\", \"--role\"},\n+      description = \"Filter certificate by the role: om/datanode\",\n+      defaultValue = \"datanode\", showDefaultValue = Visibility.ALWAYS)\n+  private String role;\n+\n+  @Option(names = {\"-t\", \"--type\"},\n+      description = \"Filter certificate by the type: valid or revoked\",\n+      defaultValue = \"valid\", showDefaultValue = Visibility.ALWAYS)\n+  private String type;\n+\n+  private HddsProtos.NodeType parseCertRole(String r) {\n+    if (r.equalsIgnoreCase(\"om\")) {\n+      return HddsProtos.NodeType.OM;\n+    } else if (r.equalsIgnoreCase(\"scm\")) {\n+      return HddsProtos.NodeType.SCM;\n+    } else {\n+      return HddsProtos.NodeType.DATANODE;\n+    }\n+  }\n+\n+  private void printCert(X509Certificate cert) {\n+    LOG.info(\"{}\\t{}\\t{}\\t{}\", cert.getSerialNumber(), cert.getNotBefore(),\n+        cert.getNotAfter(), cert.getSubjectDN());\n+  }\n+\n+  @Override\n+  protected void execute(SCMSecurityProtocol client) throws IOException {\n+    boolean isRevoked = type.equalsIgnoreCase(\"revoked\");\n+    List<String> certPemList = client.listCertificate(\n+        parseCertRole(role), startSerialId, count, isRevoked);\n+    LOG.info(\"Total {} {} certificates: \", certPemList.size(), type);\n+    LOG.info(\"SerialNumber\\t\\tValid From\\t\\tValid To\\t\\tSubjectDN\");", "originalCommit": "351a85a10ffcc7bb6061cd189a250744aebd3f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5NjI4Nw==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r543796287", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-12-16T00:53:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMzA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMzIyOA==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r542933228", "bodyText": "Nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG.error(\"Fail to parse certificate.\");\n          \n          \n            \n                    LOG.error(\"Failed to parse certificate.\");", "author": "vivekratnavel", "createdAt": "2020-12-14T23:56:24Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/cert/ListSubcommand.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm.cli.cert;\n+\n+import java.io.IOException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+import java.util.List;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.protocol.SCMSecurityProtocol;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.security.x509.certificate.utils.CertificateCodec;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Help.Visibility;\n+import picocli.CommandLine.Option;\n+\n+/**\n+ * This is the handler that process certificate list command.\n+ */\n+@Command(\n+    name = \"list\",\n+    description = \"List certificates\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+public class ListSubcommand extends ScmCertSubcommand {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(ListSubcommand.class);\n+\n+  @Option(names = {\"-s\", \"--start\"},\n+      description = \"Certificate serial id to start the iteration\",\n+      defaultValue = \"0\", showDefaultValue = Visibility.ALWAYS)\n+  private long startSerialId;\n+\n+  @Option(names = {\"-c\", \"--count\"},\n+      description = \"Maximum number of certificates to list\",\n+      defaultValue = \"20\", showDefaultValue = Visibility.ALWAYS)\n+  private int count;\n+\n+  @Option(names = {\"-r\", \"--role\"},\n+      description = \"Filter certificate by the role: om/datanode\",\n+      defaultValue = \"datanode\", showDefaultValue = Visibility.ALWAYS)\n+  private String role;\n+\n+  @Option(names = {\"-t\", \"--type\"},\n+      description = \"Filter certificate by the type: valid or revoked\",\n+      defaultValue = \"valid\", showDefaultValue = Visibility.ALWAYS)\n+  private String type;\n+\n+  private HddsProtos.NodeType parseCertRole(String r) {\n+    if (r.equalsIgnoreCase(\"om\")) {\n+      return HddsProtos.NodeType.OM;\n+    } else if (r.equalsIgnoreCase(\"scm\")) {\n+      return HddsProtos.NodeType.SCM;\n+    } else {\n+      return HddsProtos.NodeType.DATANODE;\n+    }\n+  }\n+\n+  private void printCert(X509Certificate cert) {\n+    LOG.info(\"{}\\t{}\\t{}\\t{}\", cert.getSerialNumber(), cert.getNotBefore(),\n+        cert.getNotAfter(), cert.getSubjectDN());\n+  }\n+\n+  @Override\n+  protected void execute(SCMSecurityProtocol client) throws IOException {\n+    boolean isRevoked = type.equalsIgnoreCase(\"revoked\");\n+    List<String> certPemList = client.listCertificate(\n+        parseCertRole(role), startSerialId, count, isRevoked);\n+    LOG.info(\"Total {} {} certificates: \", certPemList.size(), type);\n+    LOG.info(\"SerialNumber\\t\\tValid From\\t\\tValid To\\t\\tSubjectDN\");\n+    for (String certPemStr : certPemList) {\n+      try {\n+        X509Certificate cert = CertificateCodec.getX509Certificate(certPemStr);\n+        printCert(cert);\n+      } catch (CertificateException ex) {\n+        LOG.error(\"Fail to parse certificate.\");", "originalCommit": "351a85a10ffcc7bb6061cd189a250744aebd3f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5NjM5OA==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r543796398", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-12-16T00:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMzIyOA=="}], "type": "inlineReview"}, {"oid": "d54471123b321e074778e9a28263bc8531bdec5b", "url": "https://github.com/apache/ozone/commit/d54471123b321e074778e9a28263bc8531bdec5b", "message": "address code review comment", "committedDate": "2020-12-16T00:55:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM0ODYzMw==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r544348633", "bodyText": "verbose is unused.", "author": "adoroszlai", "createdAt": "2020-12-16T14:37:32Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/cert/InfoSubcommand.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm.cli.cert;\n+\n+import java.io.IOException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.hdds.cli.GenericParentCommand;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.protocol.SCMSecurityProtocol;\n+\n+import org.apache.hadoop.hdds.security.x509.certificate.utils.CertificateCodec;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Model.CommandSpec;\n+import picocli.CommandLine.Parameters;\n+import picocli.CommandLine.Spec;\n+\n+/**\n+ * This is the handler that process certificate info command.\n+ */\n+@Command(\n+    name = \"info\",\n+    description = \"Show detailed information for a specific certificate\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+class InfoSubcommand extends ScmCertSubcommand {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(InfoSubcommand.class);\n+\n+  @Spec\n+  private CommandSpec spec;\n+\n+  @Parameters(description = \"Serial id of the certificate in decimal.\")\n+  private String serialId;\n+\n+  @Override\n+  public void execute(SCMSecurityProtocol client) throws IOException {\n+    final String certPemStr =\n+        client.getCertificate(serialId);\n+    Preconditions.checkNotNull(certPemStr,\n+        \"Certificate can't be found\");\n+\n+    // Print container report info.\n+    LOG.info(\"Certificate id: {}\", serialId);\n+    boolean verbose = spec.root().userObject() instanceof GenericParentCommand\n+        && ((GenericParentCommand) spec.root().userObject()).isVerbose();", "originalCommit": "d54471123b321e074778e9a28263bc8531bdec5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQyOTAxMQ==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r546429011", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-12-20T19:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM0ODYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MTc4OQ==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r544351789", "bodyText": "Should we return emptyList() instead?", "author": "adoroszlai", "createdAt": "2020-12-16T14:41:30Z", "path": "hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/security/x509/certificate/authority/MockCAStore.java", "diffHunk": "@@ -51,4 +54,11 @@ public X509Certificate getCertificateByID(BigInteger serialID,\n       throws IOException {\n     return null;\n   }\n+\n+  @Override\n+  public List<X509Certificate> listCertificate(HddsProtos.NodeType role,\n+      BigInteger startSerialID, int count, CertType certType)\n+      throws IOException {\n+    return null;", "originalCommit": "d54471123b321e074778e9a28263bc8531bdec5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQyOTAyMQ==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r546429021", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-12-20T20:00:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MTc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1OTk4Mw==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r544359983", "bodyText": "Headers and data don't really line up:\nSerialNumber\t\tValid From\t\tExpiry\t\tSubject\n2205019573485754\tWed Dec 16 00:00:00 UTC 2020\tThu Dec 16 00:00:00 UTC 2021\tO=CID-fe48b3e3-f808-4cbd-86a9-847465f6f617, OU=b4fb9f43-c2ad-454a-b204-ba13d05bff63, CN=root@55967653af5c\n\nshould be something like:\nSerialNumber\t\tValid From\t\t\tExpiry\t\t\t\tSubject\n2205019573485754\tWed Dec 16 00:00:00 UTC 2020\tThu Dec 16 00:00:00 UTC 2021\tO=CID-fe48b3e3-f808-4cbd-86a9-847465f6f617, OU=b4fb9f43-c2ad-454a-b204-ba13d05bff63, CN=root@55967653af5c", "author": "adoroszlai", "createdAt": "2020-12-16T14:50:36Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/cert/ListSubcommand.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm.cli.cert;\n+\n+import java.io.IOException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+import java.util.List;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.protocol.SCMSecurityProtocol;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.security.x509.certificate.utils.CertificateCodec;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Help.Visibility;\n+import picocli.CommandLine.Option;\n+\n+/**\n+ * This is the handler that process certificate list command.\n+ */\n+@Command(\n+    name = \"list\",\n+    description = \"List certificates\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+public class ListSubcommand extends ScmCertSubcommand {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(ListSubcommand.class);\n+\n+  @Option(names = {\"-s\", \"--start\"},\n+      description = \"Certificate serial id to start the iteration\",\n+      defaultValue = \"0\", showDefaultValue = Visibility.ALWAYS)\n+  private long startSerialId;\n+\n+  @Option(names = {\"-c\", \"--count\"},\n+      description = \"Maximum number of certificates to list\",\n+      defaultValue = \"20\", showDefaultValue = Visibility.ALWAYS)\n+  private int count;\n+\n+  @Option(names = {\"-r\", \"--role\"},\n+      description = \"Filter certificate by the role: om/datanode\",\n+      defaultValue = \"datanode\", showDefaultValue = Visibility.ALWAYS)\n+  private String role;\n+\n+  @Option(names = {\"-t\", \"--type\"},\n+      description = \"Filter certificate by the type: valid or revoked\",\n+      defaultValue = \"valid\", showDefaultValue = Visibility.ALWAYS)\n+  private String type;\n+\n+  private HddsProtos.NodeType parseCertRole(String r) {\n+    if (r.equalsIgnoreCase(\"om\")) {\n+      return HddsProtos.NodeType.OM;\n+    } else if (r.equalsIgnoreCase(\"scm\")) {\n+      return HddsProtos.NodeType.SCM;\n+    } else {\n+      return HddsProtos.NodeType.DATANODE;\n+    }\n+  }\n+\n+  private void printCert(X509Certificate cert) {\n+    LOG.info(\"{}\\t{}\\t{}\\t{}\", cert.getSerialNumber(), cert.getNotBefore(),\n+        cert.getNotAfter(), cert.getSubjectDN());\n+  }\n+\n+  @Override\n+  protected void execute(SCMSecurityProtocol client) throws IOException {\n+    boolean isRevoked = type.equalsIgnoreCase(\"revoked\");\n+    List<String> certPemList = client.listCertificate(\n+        parseCertRole(role), startSerialId, count, isRevoked);\n+    LOG.info(\"Total {} {} certificates: \", certPemList.size(), type);\n+    LOG.info(\"SerialNumber\\t\\tValid From\\t\\tExpiry\\t\\tSubject\");", "originalCommit": "d54471123b321e074778e9a28263bc8531bdec5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQyOTA3OA==", "url": "https://github.com/apache/ozone/pull/1662#discussion_r546429078", "bodyText": "Fixed.\nTotal 2 valid certificates: \nSerialNumber      Valid From                     Expiry                         Subject                                                                                                       \n170901133690402   Sun Dec 20 00:00:00 UTC 2020   Mon Dec 20 00:00:00 UTC 2021   O=CID-4b97ad93-f91c-4700-83b8-62df6a24e12a, OU=e25f8f9c-9292-4731-8406-4d0e5e522757, CN=root@a65bf462da45     \n170904253373102   Sun Dec 20 00:00:00 UTC 2020   Mon Dec 20 00:00:00 UTC 2021   O=CID-4b97ad93-f91c-4700-83b8-62df6a24e12a, OU=e25f8f9c-9292-4731-8406-4d0e5e522757, CN=root@om", "author": "xiaoyuyao", "createdAt": "2020-12-20T20:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1OTk4Mw=="}], "type": "inlineReview"}, {"oid": "9ba65d50a4c0ab9b5bd958ac7c664cd99c963d66", "url": "https://github.com/apache/ozone/commit/9ba65d50a4c0ab9b5bd958ac7c664cd99c963d66", "message": "address additional code review comments.", "committedDate": "2020-12-20T20:01:27Z", "type": "commit"}, {"oid": "27aa2caafc6e7b82dc6ad3e63c3797e1087c44a5", "url": "https://github.com/apache/ozone/commit/27aa2caafc6e7b82dc6ad3e63c3797e1087c44a5", "message": "remove unused import", "committedDate": "2020-12-20T22:39:11Z", "type": "commit"}]}