{"pr_number": 1227, "pr_title": "HDDS-3993. Create volume required for S3G during OM startup.", "pr_createdAt": "2020-07-21T00:16:01Z", "pr_url": "https://github.com/apache/ozone/pull/1227", "timeline": [{"oid": "7f65198647bcfabc8a2a7956eb5ae6ae0fba0b1a", "url": "https://github.com/apache/ozone/commit/7f65198647bcfabc8a2a7956eb5ae6ae0fba0b1a", "message": "HDDS-3993. Create volume required for S3G during OM startup.\"", "committedDate": "2020-07-21T00:13:52Z", "type": "commit"}, {"oid": "4650ae55e01343673e7a515957f5040821e3dbc8", "url": "https://github.com/apache/ozone/commit/4650ae55e01343673e7a515957f5040821e3dbc8", "message": "fix cs", "committedDate": "2020-07-21T00:16:39Z", "type": "commit"}, {"oid": "498eb60f38eee2341ed29f8d43676954b8324688", "url": "https://github.com/apache/ozone/commit/498eb60f38eee2341ed29f8d43676954b8324688", "message": "remove collect", "committedDate": "2020-07-21T00:18:37Z", "type": "commit"}, {"oid": "19372393899cccecb10730a141b522cc239a092f", "url": "https://github.com/apache/ozone/commit/19372393899cccecb10730a141b522cc239a092f", "message": "add log", "committedDate": "2020-07-21T00:20:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgxNjk3Ng==", "url": "https://github.com/apache/ozone/pull/1227#discussion_r457816976", "bodyText": "What is the implication of hard-coding the transaction id = 1, especially for existing clusters where the s3 volume may not exist?", "author": "arp7", "createdAt": "2020-07-21T03:39:24Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3516,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = 1L;", "originalCommit": "19372393899cccecb10730a141b522cc239a092f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNDE1OQ==", "url": "https://github.com/apache/ozone/pull/1227#discussion_r457824159", "bodyText": "I looked into this function. I think hard-coding the transaction ID may be risky in a cluster where there are already some Ratis transactions however the s3v volume was not yet created. Perhaps we can set it to a really high value, something that is very unlikely to be hit in a real cluster. Like (MAX_ULONG - 1) >> 8", "author": "arp7", "createdAt": "2020-07-21T04:08:53Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3516,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = 1L;\n+      long objectID = OMFileRequest.getObjIDFromTxId(transactionID);", "originalCommit": "19372393899cccecb10730a141b522cc239a092f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d127a6134b0493ceb6a2d49d40e21dc317d17b6d", "url": "https://github.com/apache/ozone/commit/d127a6134b0493ceb6a2d49d40e21dc317d17b6d", "message": "test fixes", "committedDate": "2020-07-21T18:10:01Z", "type": "commit"}, {"oid": "b14d93c61747ec5f86d2f05b7bb0d8a555f99935", "url": "https://github.com/apache/ozone/commit/b14d93c61747ec5f86d2f05b7bb0d8a555f99935", "message": "add new test and remove volume creation step of s3v in robot test", "committedDate": "2020-07-21T18:15:33Z", "type": "commit"}, {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d", "url": "https://github.com/apache/ozone/commit/d2f285fac8d227a4fb14c78dc9e0a98dd857e90d", "message": "address review comment and add username", "committedDate": "2020-07-21T18:47:13Z", "type": "commit"}, {"oid": "0369bb704b60395f20b25b7ef4c46872d0cc8513", "url": "https://github.com/apache/ozone/commit/0369bb704b60395f20b25b7ef4c46872d0cc8513", "message": "fix checkstyle", "committedDate": "2020-07-21T19:02:11Z", "type": "commit"}, {"oid": "bb1f8381f4697e0d695ab807d05ff7df47350158", "url": "https://github.com/apache/ozone/commit/bb1f8381f4697e0d695ab807d05ff7df47350158", "message": "revert proto.lock changes", "committedDate": "2020-07-21T19:05:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyNzI5Ng==", "url": "https://github.com/apache/ozone/pull/1227#discussion_r458327296", "bodyText": "Let's assert in a test case that the generated object ID is correct.", "author": "arp7", "createdAt": "2020-07-21T19:10:54Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3517,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = (Long.MAX_VALUE - 1) >> 8;\n+      long objectID = OMFileRequest.getObjIDFromTxId(transactionID);", "originalCommit": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5f0c36a91800781445c6b265c6595bf026c6b2e4", "url": "https://github.com/apache/ozone/commit/5f0c36a91800781445c6b265c6595bf026c6b2e4", "message": "revert proto change", "committedDate": "2020-07-21T19:16:30Z", "type": "commit"}, {"oid": "7e53738e4e8f16a18f708e2c87001c66781894fe", "url": "https://github.com/apache/ozone/commit/7e53738e4e8f16a18f708e2c87001c66781894fe", "message": "test objectid and transactionid", "committedDate": "2020-07-21T20:10:41Z", "type": "commit"}]}