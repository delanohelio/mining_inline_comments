{"pr_number": 428, "pr_title": "HDDS-2868. Add ObjectID and UpdateID to OMKeyInfo.", "pr_createdAt": "2020-01-10T01:47:52Z", "pr_url": "https://github.com/apache/ozone/pull/428", "timeline": [{"oid": "70f086e69cf3375f51d92a70e092df44eefa976f", "url": "https://github.com/apache/ozone/commit/70f086e69cf3375f51d92a70e092df44eefa976f", "message": "HDDS-2868. Add ObjectID and UpdateID to OMKeyInfo.", "committedDate": "2020-01-10T01:45:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MjEyOA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365092128", "bodyText": "NIT: primitive type, we dont need @nonnull", "author": "bharatviswa504", "createdAt": "2020-01-10T06:46:12Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRequest.java", "diffHunk": "@@ -349,7 +349,8 @@ protected OmKeyInfo createKeyInfo(@Nonnull KeyArgs keyArgs,\n       @Nonnull HddsProtos.ReplicationType type, long size,\n       @Nullable FileEncryptionInfo encInfo,\n       @Nonnull PrefixManager prefixManager,\n-      @Nullable OmBucketInfo omBucketInfo) {\n+      @Nullable OmBucketInfo omBucketInfo,\n+      @Nonnull long transactionLogIndex) {", "originalCommit": "70f086e69cf3375f51d92a70e092df44eefa976f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQwMDcxOQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365400719", "bodyText": "done", "author": "hanishakoneru", "createdAt": "2020-01-10T19:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MjEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MjE5OQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365092199", "bodyText": "NIT: primitive type, we dont need @nonnull", "author": "bharatviswa504", "createdAt": "2020-01-10T06:46:31Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRequest.java", "diffHunk": "@@ -416,12 +419,14 @@ protected OmKeyInfo prepareKeyInfo(\n       @Nonnull KeyArgs keyArgs, @Nonnull String dbKeyName, long size,\n       @Nonnull List<OmKeyLocationInfo> locations,\n       @Nullable FileEncryptionInfo encInfo,\n-      @Nonnull PrefixManager prefixManager, @Nullable OmBucketInfo omBucketInfo)\n+      @Nonnull PrefixManager prefixManager,\n+      @Nullable OmBucketInfo omBucketInfo,\n+      @Nonnull long transactionLogIndex)", "originalCommit": "70f086e69cf3375f51d92a70e092df44eefa976f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQwMDc1OQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365400759", "bodyText": "done", "author": "hanishakoneru", "createdAt": "2020-01-10T19:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MjE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MzM0NQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365093345", "bodyText": "Missing to add objectID and updateID in multipartKeyInfo", "author": "bharatviswa504", "createdAt": "2020-01-10T06:51:47Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3InitiateMultipartUploadRequest.java", "diffHunk": "@@ -158,9 +158,10 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           .setOmKeyLocationInfos(Collections.singletonList(\n               new OmKeyLocationInfoGroup(0, new ArrayList<>())))\n           .setAcls(OzoneAclUtil.fromProtobuf(keyArgs.getAclsList()))\n+          .setObjectID(transactionLogIndex)", "originalCommit": "70f086e69cf3375f51d92a70e092df44eefa976f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQwMDg2OA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365400868", "bodyText": "Thanks for catching this. Updated the patch.", "author": "hanishakoneru", "createdAt": "2020-01-10T19:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MzM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5Mzc0MQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365093741", "bodyText": "Not understood the reason of setting updateID here, as below we are setting Optional.absent(), so it  means entry is deleted from DB.", "author": "bharatviswa504", "createdAt": "2020-01-10T06:53:37Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadAbortRequest.java", "diffHunk": "@@ -120,6 +124,21 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         multipartKeyInfo = omMetadataManager\n             .getMultipartInfoTable().get(multipartKey);\n \n+        // Set updateID to current transactionLogIndex for all parts\n+        TreeMap<Integer, PartKeyInfo> partKeyInfoMap = multipartKeyInfo\n+            .getPartKeyInfoMap();\n+        for (Map.Entry<Integer, PartKeyInfo> partKeyInfoEntry :\n+            partKeyInfoMap.entrySet()) {\n+          PartKeyInfo partKeyInfo = partKeyInfoEntry.getValue();\n+          OmKeyInfo currentKeyPartInfo = OmKeyInfo.getFromProtobuf(", "originalCommit": "70f086e69cf3375f51d92a70e092df44eefa976f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQwMDQyOA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365400428", "bodyText": "Yes, but this entry is added to DeletedTable. So I thought we should keep a record of the transaction which deleted the Key.", "author": "hanishakoneru", "createdAt": "2020-01-10T19:42:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5Mzc0MQ=="}], "type": "inlineReview"}, {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051", "url": "https://github.com/apache/ozone/commit/979d8a226b839f23dfcb5ea281d0c014781c6051", "message": "review comments", "committedDate": "2020-01-10T19:42:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyOTkyMQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365629921", "bodyText": "assert that it is greater than current updateID?", "author": "arp7", "createdAt": "2020-01-13T01:56:10Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -135,6 +141,47 @@ public void updateModifcationTime() {\n     this.modificationTime = Time.monotonicNow();\n   }\n \n+  /**\n+   * Set the Object ID. If this value is already set then this function throws.\n+   * There is a reason why we cannot use the final here. The OMKeyInfo is\n+   * deserialized from the protobuf in many places in code. We need to set\n+   * this object ID, after it is deserialized.\n+   *\n+   * @param obId - long\n+   */\n+  public void setObjectID(long obId) {\n+    if(this.objectID != 0) {\n+      throw new UnsupportedOperationException(\"Attempt to modify object ID \" +\n+          \"which is not zero. Current Object ID is \" + this.objectID);\n+    }\n+    this.objectID = obId;\n+  }\n+\n+  /**\n+   * Sets the update ID. For each modification of this object, we will set\n+   * this to a value greater than the current value.\n+   * @param updateID  long\n+   */\n+  public void setUpdateID(long updateID) {\n+    this.updateID = updateID;", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjUwMA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366546500", "bodyText": "Added the check.", "author": "hanishakoneru", "createdAt": "2020-01-14T20:05:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyOTkyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyOTk0Nw==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365629947", "bodyText": "Is 0 an invalid object ID and update id?", "author": "arp7", "createdAt": "2020-01-13T01:56:30Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -52,6 +52,9 @@\n   private HddsProtos.ReplicationType type;\n   private HddsProtos.ReplicationFactor factor;\n   private FileEncryptionInfo encInfo;\n+  private long objectID;", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMjYzNg==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366532636", "bodyText": "If there are any old objects in the DB, then those will have objectId and updateId as 0. It is not invalid but if it is 0, then we cannot determine if a corresponding transaction is a replay.", "author": "hanishakoneru", "createdAt": "2020-01-14T19:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyOTk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDUwMw==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365630503", "bodyText": "Is this code still used? @bharatviswa504", "author": "arp7", "createdAt": "2020-01-13T02:04:14Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -943,9 +943,13 @@ private OmMultipartInfo createMultipartInfo(OmKeyArgs keyArgs,\n \n       long currentTime = Time.now();\n       Map<Integer, PartKeyInfo> partKeyInfoMap = new HashMap<>();\n-      OmMultipartKeyInfo multipartKeyInfo = new OmMultipartKeyInfo(\n-          multipartUploadID, currentTime, keyArgs.getType(),\n-          keyArgs.getFactor(), partKeyInfoMap);\n+      OmMultipartKeyInfo multipartKeyInfo = new OmMultipartKeyInfo.Builder()", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAxMTQzNw==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366011437", "bodyText": "No @arp7. For write requests new OM HA code is used. (The new code is used for both OM HA and non-HA)", "author": "bharatviswa504", "createdAt": "2020-01-13T20:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExNzU5Mg==", "url": "https://github.com/apache/ozone/pull/428#discussion_r367117592", "bodyText": "Should we file a separate jira to delete this code now?", "author": "arp7", "createdAt": "2020-01-15T21:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDU2Mg==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365630562", "bodyText": "Is the transaction log index reset when the Ratis term changes?", "author": "arp7", "createdAt": "2020-01-13T02:05:05Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -210,7 +210,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n   private OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,\n       OmBucketInfo omBucketInfo, String volumeName, String bucketName,\n-      String keyName, KeyArgs keyArgs)\n+      String keyName, KeyArgs keyArgs, long transactionLogIndex)", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMzA1Nw==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366533057", "bodyText": "No Arpit. Transaction log index is the ratis log index. It is monotonically increasing always.", "author": "hanishakoneru", "createdAt": "2020-01-14T19:35:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDY3NQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365630675", "bodyText": "Also what happens for deployed clusters where the persisted keys have no object Id or update ID? What do we initialize it to?", "author": "arp7", "createdAt": "2020-01-13T02:06:15Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -52,6 +52,9 @@\n   private HddsProtos.ReplicationType type;\n   private HddsProtos.ReplicationFactor factor;\n   private FileEncryptionInfo encInfo;\n+  private long objectID;\n+  private long updateID;\n+", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMzQ0Nw==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366533447", "bodyText": "It will default to 0 as we use long primitive type here.", "author": "hanishakoneru", "createdAt": "2020-01-14T19:36:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDc5MA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r365630790", "bodyText": "It may be safer to initialize success to false, and set it to true at the end of the try block when all operations are complete.", "author": "arp7", "createdAt": "2020-01-13T02:07:46Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRenameRequest.java", "diffHunk": "@@ -112,6 +112,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n     boolean acquiredLock = false;\n     OMClientResponse omClientResponse = null;\n+    boolean success = true;", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjQwMA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366546400", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2020-01-14T20:04:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAwOTIxMA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366009210", "bodyText": "Minor NIT: OmKeyInfo -> OmMultipartKeyInfo", "author": "bharatviswa504", "createdAt": "2020-01-13T20:22:18Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmMultipartKeyInfo.java", "diffHunk": "@@ -83,6 +128,72 @@ public ReplicationFactor getReplicationFactor() {\n     return replicationFactor;\n   }\n \n+  /**\n+   * Builder of OmKeyInfo.", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjM0MA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366546340", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2020-01-14T20:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAwOTIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAyODA1MQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366028051", "bodyText": "I think, we don't need to set updateID, as we delete this entry from KeyTable anyway. (As we set Optional.absent() below, which will be deleted from OM DB eventually when double buffer picks). Or is there any scenario by setting this helps.\nExample: Create key Key1 - 1, Delete Key Key1 - 2 Create Key Key1 (again) - 3 Now replay happening from 1, as now in KeyTable it will have updateID 3, we think it as replay just by checking OmKeyInfo.getUpdateID, similar to Bucket/Volume delete.", "author": "bharatviswa504", "createdAt": "2020-01-13T21:07:19Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -126,6 +126,8 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       if (omKeyInfo == null) {\n         throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n       }\n+      // Set the UpdateID to current transactionLogIndex\n+      omKeyInfo.setUpdateID(transactionLogIndex);", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0MjI1Mw==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366542253", "bodyText": "Deleted Keys are put in DeletedKey Table and then purged when we get KeyPurgeRequest. As the purge request could also be a replay, we should only delete the keys which were deleted before the purge request. For this check, we need to set the updateID here.", "author": "hanishakoneru", "createdAt": "2020-01-14T19:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAyODA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAzMDMxMg==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366030312", "bodyText": "Same as above, I think we don't need to set updateID here, as anyway we are removing entry from multipartInfo table. Is there is any use case that will help in the detection of replay by setting here?", "author": "bharatviswa504", "createdAt": "2020-01-13T21:12:19Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadAbortRequest.java", "diffHunk": "@@ -120,6 +124,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         multipartKeyInfo = omMetadataManager\n             .getMultipartInfoTable().get(multipartKey);\n \n+        multipartKeyInfo.setUpdateID(transactionLogIndex);", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3OTg3MA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366079870", "bodyText": "As this is like new key is getting created, so do we need to set objectID also here?", "author": "bharatviswa504", "createdAt": "2020-01-13T23:16:32Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRenameRequest.java", "diffHunk": "@@ -155,6 +156,9 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       //Set modification time\n       fromKeyValue.setModificationTime(renameKeyArgs.getModificationTime());\n \n+      // Set the UpdateID to current transactionLogIndex\n+      fromKeyValue.setUpdateID(transactionLogIndex);", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NDAyMw==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366544023", "bodyText": "I think either way should be ok. I thought since its the same key being renamed, we could have the same objectID. But I am ok changing it to current transactionLogIndex. Let me know what you think.", "author": "hanishakoneru", "createdAt": "2020-01-14T19:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3OTg3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyMTE1OA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r367121158", "bodyText": "As discussed offline, we can change this when we use them in finding a transaction is replay or not.", "author": "bharatviswa504", "createdAt": "2020-01-15T21:39:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3OTg3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MTcxOQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366091719", "bodyText": "As discussed offline, for this we can set ObjectID, which we have in the dbOpenKeyInfo.", "author": "bharatviswa504", "createdAt": "2020-01-13T23:57:44Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadCompleteRequest.java", "diffHunk": "@@ -229,17 +229,33 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           // This is a newly added key, it does not have any versions.\n           OmKeyLocationInfoGroup keyLocationInfoGroup = new\n               OmKeyLocationInfoGroup(0, partLocationInfos);\n+\n+          // Get the objectID of the key from OpenKeyTable\n+          OmKeyInfo dbOpenKeyInfo = omMetadataManager.getOpenKeyTable()\n+              .get(multipartKey);\n+\n           // A newly created key, this is the first version.\n-          omKeyInfo = new OmKeyInfo.Builder().setVolumeName(volumeName)\n+          OmKeyInfo.Builder builder =\n+              new OmKeyInfo.Builder().setVolumeName(volumeName)\n               .setBucketName(bucketName).setKeyName(keyName)\n               .setReplicationFactor(factor).setReplicationType(type)\n               .setCreationTime(keyArgs.getModificationTime())\n               .setModificationTime(keyArgs.getModificationTime())\n               .setDataSize(dataSize)\n               .setOmKeyLocationInfos(\n                   Collections.singletonList(keyLocationInfoGroup))\n-              .setAcls(OzoneAclUtil.fromProtobuf(keyArgs.getAclsList()))\n-              .build();\n+              .setAcls(OzoneAclUtil.fromProtobuf(keyArgs.getAclsList()));\n+          // Check if db entry has ObjectID. This check is required because\n+          // it is possible that between multipart key uploads and complete,\n+          // we had an upgrade.\n+          // TODO: If on upgrades we do not consider the non-completed multipart\n+          //  uploads, then this check can be removed.\n+          if (dbOpenKeyInfo.getObjectID() != 0) {", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjIyMw==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366546223", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2020-01-14T20:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MTcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MjU1MA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366092550", "bodyText": "This method is not called any where, as we use builder methods.", "author": "bharatviswa504", "createdAt": "2020-01-14T00:01:00Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmMultipartKeyInfo.java", "diffHunk": "@@ -35,22 +35,67 @@\n   private final ReplicationType replicationType;\n   private final ReplicationFactor replicationFactor;\n   private TreeMap<Integer, PartKeyInfo> partKeyInfoList;\n+  private long objectID;\n+  private long updateID;\n \n   /**\n    * Construct OmMultipartKeyInfo object which holds multipart upload\n    * information for a key.\n    */\n   public OmMultipartKeyInfo(String id, long creationTime,\n-                            ReplicationType replicationType,\n-                            ReplicationFactor replicationFactor,\n-                            Map<Integer, PartKeyInfo> list) {\n+      ReplicationType replicationType, ReplicationFactor replicationFactor,\n+      Map<Integer, PartKeyInfo> list, long objectID, long updateID) {\n     this.uploadID = id;\n     this.creationTime = creationTime;\n     this.replicationType = replicationType;\n     this.replicationFactor = replicationFactor;\n     this.partKeyInfoList = new TreeMap<>(list);\n+    this.objectID = objectID;\n+    this.updateID = updateID;\n   }\n \n+  /**\n+   * Set the Object ID. If this value is already set then this function throws.\n+   * There is a reason why we cannot use the final here. The\n+   * OMMultipartKeyInfo is deserialized from the protobuf in many places in\n+   * code. We need to set this object ID, after it is deserialized.\n+   *\n+   * @param obId - long\n+   */\n+  public void setObjectID(long obId) {", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjE0OQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366546149", "bodyText": "Removed.", "author": "hanishakoneru", "createdAt": "2020-01-14T20:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MjU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5Mjc4NA==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366092784", "bodyText": "This method is not called anywhere, as we use builder methods.", "author": "bharatviswa504", "createdAt": "2020-01-14T00:01:55Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -135,6 +141,47 @@ public void updateModifcationTime() {\n     this.modificationTime = Time.monotonicNow();\n   }\n \n+  /**\n+   * Set the Object ID. If this value is already set then this function throws.\n+   * There is a reason why we cannot use the final here. The OMKeyInfo is\n+   * deserialized from the protobuf in many places in code. We need to set\n+   * this object ID, after it is deserialized.\n+   *\n+   * @param obId - long\n+   */\n+  public void setObjectID(long obId) {\n+    if(this.objectID != 0) {", "originalCommit": "979d8a226b839f23dfcb5ea281d0c014781c6051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjExMQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r366546111", "bodyText": "Removed", "author": "hanishakoneru", "createdAt": "2020-01-14T20:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5Mjc4NA=="}], "type": "inlineReview"}, {"oid": "abf4119878ed2a302c176759124669a10b2bab08", "url": "https://github.com/apache/ozone/commit/abf4119878ed2a302c176759124669a10b2bab08", "message": "Review comments", "committedDate": "2020-01-14T20:00:54Z", "type": "commit"}, {"oid": "6ff22114b9fea4e46d886e460330be0bde2f62c6", "url": "https://github.com/apache/ozone/commit/6ff22114b9fea4e46d886e460330be0bde2f62c6", "message": "checkstype fixes", "committedDate": "2020-01-14T20:03:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5MTgwNQ==", "url": "https://github.com/apache/ozone/pull/428#discussion_r372191805", "bodyText": "Can transactionLogIndex be used as a unique objectId over time ?", "author": "prashantpogde", "createdAt": "2020-01-29T05:15:40Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -210,7 +210,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n   private OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,\n       OmBucketInfo omBucketInfo, String volumeName, String bucketName,\n-      String keyName, KeyArgs keyArgs)\n+      String keyName, KeyArgs keyArgs, long transactionLogIndex)", "originalCommit": "6ff22114b9fea4e46d886e460330be0bde2f62c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}