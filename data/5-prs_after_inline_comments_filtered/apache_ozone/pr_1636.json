{"pr_number": 1636, "pr_title": "HDDS-4496. Separate client and server2server GRPC services of datanode", "pr_createdAt": "2020-11-30T13:52:50Z", "pr_url": "https://github.com/apache/ozone/pull/1636", "timeline": [{"oid": "3fcfc4b848b9de63d135d8f35bc1e12ba6d80f4c", "url": "https://github.com/apache/ozone/commit/3fcfc4b848b9de63d135d8f35bc1e12ba6d80f4c", "message": "replication separation", "committedDate": "2020-11-23T12:58:24Z", "type": "commit"}, {"oid": "e432d7d68285ea989264a2c9013753b92c05b83f", "url": "https://github.com/apache/ozone/commit/e432d7d68285ea989264a2c9013753b92c05b83f", "message": "fix tests + checkstyle", "committedDate": "2020-11-24T13:00:51Z", "type": "commit"}, {"oid": "ec21c3f19d7f4a0a42e4f2a5a4712c7ee5630601", "url": "https://github.com/apache/ozone/commit/ec21c3f19d7f4a0a42e4f2a5a4712c7ee5630601", "message": "temporary fix", "committedDate": "2020-11-25T07:55:11Z", "type": "commit"}, {"oid": "6f97fece21613226320db978c9ca35f06b41930d", "url": "https://github.com/apache/ozone/commit/6f97fece21613226320db978c9ca35f06b41930d", "message": "ssl context fix", "committedDate": "2020-11-26T12:14:47Z", "type": "commit"}, {"oid": "8d1aab6e7133f2226b20c1d6c224b95d1be9b8e8", "url": "https://github.com/apache/ozone/commit/8d1aab6e7133f2226b20c1d6c224b95d1be9b8e8", "message": "cleanup the patch", "committedDate": "2020-11-26T12:19:23Z", "type": "commit"}, {"oid": "b8cdb9d36c2a2b7bf1747c831d68e236fed1d44a", "url": "https://github.com/apache/ozone/commit/b8cdb9d36c2a2b7bf1747c831d68e236fed1d44a", "message": "checkstyle fix", "committedDate": "2020-11-26T12:20:56Z", "type": "commit"}, {"oid": "3e7e14e0c037600697ac0796dadb0e8be01241ee", "url": "https://github.com/apache/ozone/commit/3e7e14e0c037600697ac0796dadb0e8be01241ee", "message": "remove proto reflection service", "committedDate": "2020-11-26T13:43:03Z", "type": "commit"}, {"oid": "562eb0dfb3852a36150312353d3b5c6bf6d45eb4", "url": "https://github.com/apache/ozone/commit/562eb0dfb3852a36150312353d3b5c6bf6d45eb4", "message": "fix grpc error handling", "committedDate": "2020-11-26T15:34:01Z", "type": "commit"}, {"oid": "0f22e5617454845a60297aac11694c2b2885f997", "url": "https://github.com/apache/ozone/commit/0f22e5617454845a60297aac11694c2b2885f997", "message": "Merge remote-tracking branch 'origin/master' into HDDS-4496", "committedDate": "2020-12-01T15:15:17Z", "type": "commit"}, {"oid": "2bf3cdde0cbd5431e31d8877b8fb16399e379847", "url": "https://github.com/apache/ozone/commit/2bf3cdde0cbd5431e31d8877b8fb16399e379847", "message": "fix imports after merge", "committedDate": "2020-12-01T15:16:31Z", "type": "commit"}, {"oid": "a803689bac98e2c74043dc683055d4897653ddf7", "url": "https://github.com/apache/ozone/commit/a803689bac98e2c74043dc683055d4897653ddf7", "message": "signature fixes after merge", "committedDate": "2020-12-01T15:19:04Z", "type": "commit"}, {"oid": "a05b2657bcad3a17a6506ba48939954b4018260b", "url": "https://github.com/apache/ozone/commit/a05b2657bcad3a17a6506ba48939954b4018260b", "message": "fix unit test", "committedDate": "2020-12-01T15:27:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc0NTg2MQ==", "url": "https://github.com/apache/ozone/pull/1636#discussion_r533745861", "bodyText": "Just curious in which case we will get a 0 here after netty server starts. If each server has a non-zero known port for replication server, this should work.\nHowever, if the replication server returns port 0, DatanodeDetails#Name.Replication will be set 0 as well in OzoneContainer#start. How does other DNs figure out the proper port number to connect. Do we have other way to figure out the actual random port number and populate it properly to DatanodeDetails?", "author": "xiaoyuyao", "createdAt": "2020-12-01T21:53:35Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/replication/ReplicationServer.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.replication;\n+\n+import javax.net.ssl.SSLException;\n+import java.io.IOException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.hadoop.hdds.conf.Config;\n+import org.apache.hadoop.hdds.conf.ConfigGroup;\n+import org.apache.hadoop.hdds.conf.ConfigTag;\n+import org.apache.hadoop.hdds.security.x509.SecurityConfig;\n+import org.apache.hadoop.hdds.security.x509.certificate.client.CertificateClient;\n+import org.apache.hadoop.hdds.tracing.GrpcServerInterceptor;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.container.ozoneimpl.ContainerController;\n+\n+import org.apache.ratis.thirdparty.io.grpc.Server;\n+import org.apache.ratis.thirdparty.io.grpc.ServerBuilder;\n+import org.apache.ratis.thirdparty.io.grpc.ServerInterceptors;\n+import org.apache.ratis.thirdparty.io.grpc.netty.GrpcSslContexts;\n+import org.apache.ratis.thirdparty.io.grpc.netty.NettyServerBuilder;\n+import org.apache.ratis.thirdparty.io.netty.handler.ssl.ClientAuth;\n+import org.apache.ratis.thirdparty.io.netty.handler.ssl.SslContextBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Separated network server for server2server container replication.\n+ */\n+public class ReplicationServer {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(ReplicationServer.class);\n+\n+  private Server server;\n+\n+  private SecurityConfig secConf;\n+\n+  private CertificateClient caClient;\n+\n+  private ContainerController controller;\n+\n+  private int port;\n+\n+  public ReplicationServer(\n+      ContainerController controller,\n+      ReplicationConfig replicationConfig,\n+      SecurityConfig secConf,\n+      CertificateClient caClient\n+  ) {\n+    this.secConf = secConf;\n+    this.caClient = caClient;\n+    this.controller = controller;\n+    this.port = replicationConfig.getPort();\n+    init();\n+  }\n+\n+  public void init() {\n+    NettyServerBuilder nettyServerBuilder =\n+        ((NettyServerBuilder) ServerBuilder.forPort(port))\n+            .maxInboundMessageSize(OzoneConsts.OZONE_SCM_CHUNK_MAX_SIZE);\n+\n+    GrpcServerInterceptor tracingInterceptor = new GrpcServerInterceptor();\n+    nettyServerBuilder\n+        .addService(ServerInterceptors.intercept(new GrpcReplicationService(\n+            new OnDemandContainerReplicationSource(controller)\n+        ), tracingInterceptor));\n+\n+    if (secConf.isSecurityEnabled()) {\n+      try {\n+        SslContextBuilder sslContextBuilder = SslContextBuilder.forServer(\n+            caClient.getPrivateKey(), caClient.getCertificate());\n+\n+        sslContextBuilder = GrpcSslContexts.configure(\n+            sslContextBuilder, secConf.getGrpcSslProvider());\n+\n+        sslContextBuilder.clientAuth(ClientAuth.REQUIRE);\n+        sslContextBuilder.trustManager(caClient.getCACertificate());\n+\n+        nettyServerBuilder.sslContext(sslContextBuilder.build());\n+      } catch (SSLException ex) {\n+        throw new IllegalArgumentException(\n+            \"Unable to setup TLS for secure datanode replication GRPC \"\n+                + \"endpoint.\", ex);\n+      }\n+    }\n+\n+    server = nettyServerBuilder.build();\n+  }\n+\n+  public void start() throws IOException {\n+    server.start();\n+\n+    port = server.getPort();\n+\n+    if (port == 0) {", "originalCommit": "a05b2657bcad3a17a6506ba48939954b4018260b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0Mjk1NQ==", "url": "https://github.com/apache/ozone/pull/1636#discussion_r536042955", "bodyText": "That's my fault. This is in the wrong order. here the server.getPort() should never be 0. port includes the final port number which is used in  datanodeDetails.setPort(Name.REPLICATION, replicationServer.getPort());.\nBut it was not clear as I used the wrong order. port check should be done before setting the variable. Fixed with:\n    if (port == 0) {\n      LOG.info(\"{} is started using port {}\", getClass().getSimpleName(), server.getPort());\n    }\n\n    port = server.getPort();", "author": "elek", "createdAt": "2020-12-04T11:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc0NTg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc1MjAzNA==", "url": "https://github.com/apache/ozone/pull/1636#discussion_r533752034", "bodyText": "To be consistent with existing replication related configurations, should we move this Configuration key as part of DatanodeConfiguration.java class under the prefix as hdds.datanode.replication.*?", "author": "xiaoyuyao", "createdAt": "2020-12-01T22:05:09Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/replication/ReplicationServer.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.replication;\n+\n+import javax.net.ssl.SSLException;\n+import java.io.IOException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.hadoop.hdds.conf.Config;\n+import org.apache.hadoop.hdds.conf.ConfigGroup;\n+import org.apache.hadoop.hdds.conf.ConfigTag;\n+import org.apache.hadoop.hdds.security.x509.SecurityConfig;\n+import org.apache.hadoop.hdds.security.x509.certificate.client.CertificateClient;\n+import org.apache.hadoop.hdds.tracing.GrpcServerInterceptor;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.container.ozoneimpl.ContainerController;\n+\n+import org.apache.ratis.thirdparty.io.grpc.Server;\n+import org.apache.ratis.thirdparty.io.grpc.ServerBuilder;\n+import org.apache.ratis.thirdparty.io.grpc.ServerInterceptors;\n+import org.apache.ratis.thirdparty.io.grpc.netty.GrpcSslContexts;\n+import org.apache.ratis.thirdparty.io.grpc.netty.NettyServerBuilder;\n+import org.apache.ratis.thirdparty.io.netty.handler.ssl.ClientAuth;\n+import org.apache.ratis.thirdparty.io.netty.handler.ssl.SslContextBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Separated network server for server2server container replication.\n+ */\n+public class ReplicationServer {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(ReplicationServer.class);\n+\n+  private Server server;\n+\n+  private SecurityConfig secConf;\n+\n+  private CertificateClient caClient;\n+\n+  private ContainerController controller;\n+\n+  private int port;\n+\n+  public ReplicationServer(\n+      ContainerController controller,\n+      ReplicationConfig replicationConfig,\n+      SecurityConfig secConf,\n+      CertificateClient caClient\n+  ) {\n+    this.secConf = secConf;\n+    this.caClient = caClient;\n+    this.controller = controller;\n+    this.port = replicationConfig.getPort();\n+    init();\n+  }\n+\n+  public void init() {\n+    NettyServerBuilder nettyServerBuilder =\n+        ((NettyServerBuilder) ServerBuilder.forPort(port))\n+            .maxInboundMessageSize(OzoneConsts.OZONE_SCM_CHUNK_MAX_SIZE);\n+\n+    GrpcServerInterceptor tracingInterceptor = new GrpcServerInterceptor();\n+    nettyServerBuilder\n+        .addService(ServerInterceptors.intercept(new GrpcReplicationService(\n+            new OnDemandContainerReplicationSource(controller)\n+        ), tracingInterceptor));\n+\n+    if (secConf.isSecurityEnabled()) {\n+      try {\n+        SslContextBuilder sslContextBuilder = SslContextBuilder.forServer(\n+            caClient.getPrivateKey(), caClient.getCertificate());\n+\n+        sslContextBuilder = GrpcSslContexts.configure(\n+            sslContextBuilder, secConf.getGrpcSslProvider());\n+\n+        sslContextBuilder.clientAuth(ClientAuth.REQUIRE);\n+        sslContextBuilder.trustManager(caClient.getCACertificate());\n+\n+        nettyServerBuilder.sslContext(sslContextBuilder.build());\n+      } catch (SSLException ex) {\n+        throw new IllegalArgumentException(\n+            \"Unable to setup TLS for secure datanode replication GRPC \"\n+                + \"endpoint.\", ex);\n+      }\n+    }\n+\n+    server = nettyServerBuilder.build();\n+  }\n+\n+  public void start() throws IOException {\n+    server.start();\n+\n+    port = server.getPort();\n+\n+    if (port == 0) {\n+      LOG.info(\"{} is started using port {}\", getClass().getSimpleName(), port);\n+    }\n+  }\n+\n+  public void stop() {\n+    try {\n+      server.shutdown().awaitTermination(10L, TimeUnit.SECONDS);\n+    } catch (InterruptedException ex) {\n+      LOG.warn(\"{} couldn't be stopped gracefully\", getClass().getSimpleName());\n+    }\n+  }\n+\n+  public int getPort() {\n+    return port;\n+  }\n+\n+  @ConfigGroup(prefix = \"datanode.replication\")", "originalCommit": "a05b2657bcad3a17a6506ba48939954b4018260b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0MzEwNQ==", "url": "https://github.com/apache/ozone/pull/1636#discussion_r536043105", "bodyText": "YES. Thanks the suggestion.", "author": "elek", "createdAt": "2020-12-04T11:49:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc1MjAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc1NDg1NA==", "url": "https://github.com/apache/ozone/pull/1636#discussion_r533754854", "bodyText": "NIT: separate line 44 from the *.", "author": "xiaoyuyao", "createdAt": "2020-12-01T22:10:39Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/replication/ReplicationServer.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.replication;\n+\n+import javax.net.ssl.SSLException;\n+import java.io.IOException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.hadoop.hdds.conf.Config;\n+import org.apache.hadoop.hdds.conf.ConfigGroup;\n+import org.apache.hadoop.hdds.conf.ConfigTag;\n+import org.apache.hadoop.hdds.security.x509.SecurityConfig;\n+import org.apache.hadoop.hdds.security.x509.certificate.client.CertificateClient;\n+import org.apache.hadoop.hdds.tracing.GrpcServerInterceptor;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.container.ozoneimpl.ContainerController;\n+\n+import org.apache.ratis.thirdparty.io.grpc.Server;\n+import org.apache.ratis.thirdparty.io.grpc.ServerBuilder;\n+import org.apache.ratis.thirdparty.io.grpc.ServerInterceptors;\n+import org.apache.ratis.thirdparty.io.grpc.netty.GrpcSslContexts;\n+import org.apache.ratis.thirdparty.io.grpc.netty.NettyServerBuilder;\n+import org.apache.ratis.thirdparty.io.netty.handler.ssl.ClientAuth;\n+import org.apache.ratis.thirdparty.io.netty.handler.ssl.SslContextBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Separated network server for server2server container replication.", "originalCommit": "a05b2657bcad3a17a6506ba48939954b4018260b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0NTQ0Mg==", "url": "https://github.com/apache/ozone/pull/1636#discussion_r536045442", "bodyText": "Sorry, I don't get it. Seems to be a normal Javadoc for me. Must be a typo but I don't see it. (can be the reason why I wrote it ;-) )", "author": "elek", "createdAt": "2020-12-04T11:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc1NDg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0MzA0Ng==", "url": "https://github.com/apache/ozone/pull/1636#discussion_r537843046", "bodyText": "The two lines of the class description in the previous commits somehow wraps into the same line as indicated the * in the middle between two sentences. I see this comments has be simplified and not an issue any more.", "author": "xiaoyuyao", "createdAt": "2020-12-07T21:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc1NDg1NA=="}], "type": "inlineReview"}, {"oid": "f7dc18d7bbcd6ded90ec119b6ef471c14dbba0f3", "url": "https://github.com/apache/ozone/commit/f7dc18d7bbcd6ded90ec119b6ef471c14dbba0f3", "message": "Address review comments", "committedDate": "2020-12-04T11:51:10Z", "type": "commit"}, {"oid": "6f70c34bd73879eb9bc59c8dc56a9d388bfaf31c", "url": "https://github.com/apache/ozone/commit/6f70c34bd73879eb9bc59c8dc56a9d388bfaf31c", "message": "Merge remote-tracking branch 'origin/master' into HDDS-4496", "committedDate": "2020-12-04T11:52:30Z", "type": "commit"}, {"oid": "c0de138ed242e139d778b1e4f595df10d7364ede", "url": "https://github.com/apache/ozone/commit/c0de138ed242e139d778b1e4f595df10d7364ede", "message": "retrigger build", "committedDate": "2020-12-09T10:23:49Z", "type": "commit"}]}