{"pr_number": 806, "pr_title": "HDDS-3374. OMVolumeSetOwnerRequest doesn't check if user is already the owner", "pr_createdAt": "2020-04-10T12:27:06Z", "pr_url": "https://github.com/apache/ozone/pull/806", "timeline": [{"oid": "b71c1af774f06951bb58f97b2813883925a6842e", "url": "https://github.com/apache/ozone/commit/b71c1af774f06951bb58f97b2813883925a6842e", "message": "Add check in OMVolumeRequest; Add test case.", "committedDate": "2020-04-10T12:25:14Z", "type": "commit"}, {"oid": "3ec933472213f4204edd2a4c7ded798402cb1149", "url": "https://github.com/apache/ozone/commit/3ec933472213f4204edd2a4c7ded798402cb1149", "message": "Initial fix.", "committedDate": "2020-04-10T13:05:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NTM0NQ==", "url": "https://github.com/apache/ozone/pull/806#discussion_r406865345", "bodyText": "Instead of throwing exception here, I was wondering if we can instead perform the subsequent \"add new volume to list\" if !prevVolList.contains(volume) and complement with WARN log.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Sanity check, a user should not own same volume twice\n          \n          \n            \n                //  TODO: May want to remove this due to perf if user owns a lot of volumes.\n          \n          \n            \n                if (prevVolList.contains(volume)) {\n          \n          \n            \n                  throw new IOException(\"Invalid operation: User \" + owner +\n          \n          \n            \n                      \" is about to own a same volume \" + volume + \" twice!\" +\n          \n          \n            \n                      \" Check for DB consistency error.\");\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                // Add the new volume to the list\n          \n          \n            \n                prevVolList.add(volume);\n          \n          \n            \n                // Avoid adding a user to the same volume twice\n          \n          \n            \n                if (!prevVolList.contains(volume)) {\n          \n          \n            \n                  // Add the new volume to the list\n          \n          \n            \n                  prevVolList.add(volume);\n          \n          \n            \n                  UserVolumeInfo newVolList = UserVolumeInfo.newBuilder()\n          \n          \n            \n                      .setObjectID(objectID)\n          \n          \n            \n                      .setUpdateID(txID)\n          \n          \n            \n                      .addAllVolumeNames(prevVolList).build();\n          \n          \n            \n                }", "author": "dineshchitlangia", "createdAt": "2020-04-10T17:41:06Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/OMVolumeRequest.java", "diffHunk": "@@ -106,6 +106,13 @@ protected UserVolumeInfo addVolumeToOwnerList(UserVolumeInfo volumeList,\n       objectID = volumeList.getObjectID();\n     }\n \n+    // Sanity check, a user should not own same volume twice\n+    //  TODO: May want to remove this due to perf if user owns a lot of volumes.\n+    if (prevVolList.contains(volume)) {\n+      throw new IOException(\"Invalid operation: User \" + owner +\n+          \" is about to own a same volume \" + volume + \" twice!\" +\n+          \" Check for DB consistency error.\");\n+    }\n \n     // Add the new volume to the list\n     prevVolList.add(volume);", "originalCommit": "3ec933472213f4204edd2a4c7ded798402cb1149", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4ODIxNw==", "url": "https://github.com/apache/ozone/pull/806#discussion_r406888217", "bodyText": "Will do. Thanks :)", "author": "smengcl", "createdAt": "2020-04-10T18:37:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NTM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NjM0Mw==", "url": "https://github.com/apache/ozone/pull/806#discussion_r406866343", "bodyText": "Like previous comment, we can make similar change here too.", "author": "dineshchitlangia", "createdAt": "2020-04-10T17:43:25Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/OMVolumeSetOwnerRequest.java", "diffHunk": "@@ -143,6 +143,11 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       oldOwner = omVolumeArgs.getOwnerName();\n \n+      if (oldOwner.equals(newOwner)) {\n+        throw new OMException(\"Owner of volume \" + volume + \" is already \" +\n+            newOwner, OMException.ResultCodes.ACCESS_DENIED);\n+      }\n+", "originalCommit": "3ec933472213f4204edd2a4c7ded798402cb1149", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NjgyMw==", "url": "https://github.com/apache/ozone/pull/806#discussion_r406866823", "bodyText": "I am thinking instead of returning an error like AccessDenied, can we return a code that this owner is already owner for this volume.\nBecause access Denied looks not proper here.", "author": "bharatviswa504", "createdAt": "2020-04-10T17:44:38Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/OMVolumeRequest.java", "diffHunk": "@@ -106,6 +106,13 @@ protected UserVolumeInfo addVolumeToOwnerList(UserVolumeInfo volumeList,\n       objectID = volumeList.getObjectID();\n     }\n \n+    // Sanity check, a user should not own same volume twice\n+    //  TODO: May want to remove this due to perf if user owns a lot of volumes.\n+    if (prevVolList.contains(volume)) {", "originalCommit": "3ec933472213f4204edd2a4c7ded798402cb1149", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4ODAxMw==", "url": "https://github.com/apache/ozone/pull/806#discussion_r406888013", "bodyText": "I was also thinking of adding a new type of exception. But now I think @dineshchitlangia 's suggestion might be better -- handle it silently and maybe throw a warning.", "author": "smengcl", "createdAt": "2020-04-10T18:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NjgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk3MzYzMg==", "url": "https://github.com/apache/ozone/pull/806#discussion_r406973632", "bodyText": "Can we document this behavior, so that the end-user knows about this behavior?", "author": "bharatviswa504", "createdAt": "2020-04-10T22:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NjgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI5NzMyMg==", "url": "https://github.com/apache/ozone/pull/806#discussion_r407297322", "bodyText": "IMO the client shouldn't notice this. The warnings should only show up on the server (if any).", "author": "smengcl", "createdAt": "2020-04-13T03:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NjgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzIyNw==", "url": "https://github.com/apache/ozone/pull/806#discussion_r406867227", "bodyText": "We don't need an IT test to test this behavior. We have a UT TestOMVolumeSetOwnerRequest which we can use this to cover this test.", "author": "bharatviswa504", "createdAt": "2020-04-10T17:45:38Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestOzoneManagerSetOwner.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om;\n+\n+import java.io.IOException;\n+import java.util.UUID;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.client.ObjectStore;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.protocol.ClientProtocol;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.security.UserGroupInformation;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_RATIS_PIPELINE_LIMIT;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_ACL_AUTHORIZER_CLASS;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_ACL_AUTHORIZER_CLASS_NATIVE;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_ACL_ENABLED;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_ADMINISTRATORS;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_OPEN_KEY_EXPIRE_THRESHOLD_SECONDS;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.Timeout;\n+\n+/**\n+ * Test OzoneManager list volume operation under combinations of configs.\n+ */\n+public class TestOzoneManagerSetOwner {\n+\n+  @Rule\n+  public Timeout timeout = new Timeout(120_000);\n+\n+  private UserGroupInformation loginUser;\n+\n+  @Before\n+  public void init() throws Exception {\n+    loginUser = UserGroupInformation.getLoginUser();\n+  }\n+\n+  /**\n+   * Create a MiniDFSCluster for testing.\n+   */\n+  private MiniOzoneCluster startCluster(boolean aclEnabled) throws Exception {\n+\n+    OzoneConfiguration conf = new OzoneConfiguration();\n+    String clusterId = UUID.randomUUID().toString();\n+    String scmId = UUID.randomUUID().toString();\n+    String omId = UUID.randomUUID().toString();\n+    conf.setInt(OZONE_OPEN_KEY_EXPIRE_THRESHOLD_SECONDS, 2);\n+    conf.set(OZONE_ADMINISTRATORS, \"user1\");\n+    conf.setInt(OZONE_SCM_RATIS_PIPELINE_LIMIT, 10);\n+\n+    // Use native impl here, default impl doesn't do actual checks\n+    conf.set(OZONE_ACL_AUTHORIZER_CLASS, OZONE_ACL_AUTHORIZER_CLASS_NATIVE);\n+    // Note: OM doesn't support live config reloading\n+    conf.setBoolean(OZONE_ACL_ENABLED, aclEnabled);\n+", "originalCommit": "3ec933472213f4204edd2a4c7ded798402cb1149", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4NzEyNw==", "url": "https://github.com/apache/ozone/pull/806#discussion_r406887127", "bodyText": "Yes I acknowledge that. This integration test is a quick hack from #696 's test since I discovered this issue when debugging that PR. Just a POC for now. Will figure out a way to write this in TestOMVolumeSetOwnerRequest.", "author": "smengcl", "createdAt": "2020-04-10T18:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzIyNw=="}], "type": "inlineReview"}, {"oid": "22f5ce8015116ef0dd890306dc67fbdbd9e3f2f3", "url": "https://github.com/apache/ozone/commit/22f5ce8015116ef0dd890306dc67fbdbd9e3f2f3", "message": "Don't throw in OMVolumeRequest. `LOG.warn` instead.", "committedDate": "2020-04-13T03:07:26Z", "type": "commit"}, {"oid": "448cbbe84a04992398d5d8c2235ca8c1f0ddf4d5", "url": "https://github.com/apache/ozone/commit/448cbbe84a04992398d5d8c2235ca8c1f0ddf4d5", "message": "Also warn in OMVolumeSetOwnerRequest. See comment inline.", "committedDate": "2020-04-13T03:08:15Z", "type": "commit"}, {"oid": "8fa6ba1a50231ae2f45c38a32c9d5f2bae5ba8bb", "url": "https://github.com/apache/ozone/commit/8fa6ba1a50231ae2f45c38a32c9d5f2bae5ba8bb", "message": "Add unit test testOwnSameVolumeTwice.", "committedDate": "2020-04-13T04:19:55Z", "type": "commit"}, {"oid": "7a5c9ba6c7cb1d8eb33876cfd2b688b86f195fc6", "url": "https://github.com/apache/ozone/commit/7a5c9ba6c7cb1d8eb33876cfd2b688b86f195fc6", "message": "validateAndUpdateCache: Return OK immediately if newOwner is the same as oldOwner", "committedDate": "2020-04-13T23:42:22Z", "type": "commit"}, {"oid": "a08a0332286b72c9468d4acb471982769925457f", "url": "https://github.com/apache/ozone/commit/a08a0332286b72c9468d4acb471982769925457f", "message": "Remove integration test.", "committedDate": "2020-04-13T23:42:31Z", "type": "commit"}, {"oid": "7bc36bcaabcddfd97564f9e825d534cb214cac9c", "url": "https://github.com/apache/ozone/commit/7bc36bcaabcddfd97564f9e825d534cb214cac9c", "message": "addVolumeToOwnerList: Use Set instead of List to avoid existence checking. Should improve performance.", "committedDate": "2020-04-13T23:49:25Z", "type": "commit"}, {"oid": "5b1d26e5e8c823dd3edcb9210da29bb37a9bfbcb", "url": "https://github.com/apache/ozone/commit/5b1d26e5e8c823dd3edcb9210da29bb37a9bfbcb", "message": "Fix checkstyle.", "committedDate": "2020-04-13T23:55:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTQ0Mg==", "url": "https://github.com/apache/ozone/pull/806#discussion_r408229442", "bodyText": "should we remove this comment as checkStatusNotOK is now conditioned with success=true? Also, do we redirect existing callers for success=false case appropriately?", "author": "xiaoyuyao", "createdAt": "2020-04-14T15:29:18Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/volume/OMVolumeSetOwnerResponse.java", "diffHunk": "@@ -55,11 +56,27 @@ public OMVolumeSetOwnerResponse(@Nonnull OMResponse omResponse,\n \n   /**\n    * For when the request is not successful or it is a replay transaction.", "originalCommit": "5b1d26e5e8c823dd3edcb9210da29bb37a9bfbcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMzUwOA==", "url": "https://github.com/apache/ozone/pull/806#discussion_r408233508", "bodyText": "I think the reply response is taken care by createReplayOMResponse now. So we can safely clean up the comments above.", "author": "xiaoyuyao", "createdAt": "2020-04-14T15:34:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MTA0OQ==", "url": "https://github.com/apache/ozone/pull/806#discussion_r408251049", "bodyText": "I believe the comment is still accurate. There are four places that use this constructor at the moment:\n\nINVALID_REQUEST\n\n    // In production this will never happen, this request will be called only\n    // when we have ownerName in setVolumePropertyRequest.\n    if (!setVolumePropertyRequest.hasOwnerName()) {\n      omResponse.setStatus(OzoneManagerProtocolProtos.Status.INVALID_REQUEST)\n          .setSuccess(false);\n      return new OMVolumeSetOwnerResponse(omResponse.build());\n    }\n\nReplay\n\n      // Check if this transaction is a replay of ratis logs.\n      // If this is a replay, then the response has already been returned to\n      // the client. So take no further action and return a dummy\n      // OMClientResponse.\n      if (isReplay(ozoneManager, omVolumeArgs, transactionLogIndex)) {\n        LOG.debug(\"Replayed Transaction {} ignored. Request: {}\",\n            transactionLogIndex, setVolumePropertyRequest);\n        return new OMVolumeSetOwnerResponse(createReplayOMResponse(omResponse));\n      }\n\nnewOwner is the same as oldOwner (added in this PR)\n\n      // Return OK immediately if newOwner is the same as oldOwner.\n      if (oldOwner.equals(newOwner)) {\n        LOG.warn(\"Volume '{}' owner is already user '{}'.\", volume, oldOwner);\n        omResponse.setStatus(OzoneManagerProtocolProtos.Status.OK)\n          .setMessage(\n            \"Volume '\" + volume + \"' owner is already '\" + newOwner + \"'.\")\n          .setSuccess(false);\n        return new OMVolumeSetOwnerResponse(omResponse.build());\n      }\n\nIOException\n\n    } catch (IOException ex) {\n      exception = ex;\n      omClientResponse = new OMVolumeSetOwnerResponse(\n          createErrorOMResponse(omResponse, exception));\n    } finally {", "author": "smengcl", "createdAt": "2020-04-14T15:58:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MTc0NQ==", "url": "https://github.com/apache/ozone/pull/806#discussion_r408251745", "bodyText": "Though in all four cases the success flag is set to false, rendering the condition around checkStatusNotOK() (seemingly) pointless.\nStill, this should act to prevent new code from calling this constructor when success is true and status is OK.", "author": "smengcl", "createdAt": "2020-04-14T15:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NzAzOQ==", "url": "https://github.com/apache/ozone/pull/806#discussion_r408257039", "bodyText": "Just BTW in a discussion with @bharatviswa504 we conclude the reason of setting success to false for \"newOwner equals to oldOwner\" case is that in addAcl we have some logic to print different results on the client side depending on the success flag. Though the success flag of setOwner isn't utilized at the moment, we might be able to use it later.\nAnd reason of returning status OK is that the client will throw exception if the status isn't OK.", "author": "smengcl", "createdAt": "2020-04-14T16:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2MjM0OA==", "url": "https://github.com/apache/ozone/pull/806#discussion_r408262348", "bodyText": "Just to add more info, we set the success flag and also there is a response which we return that is used by the end client which has a response flag which is set based on the result of the operation.\n  OMClientResponse onSuccess(OMResponse.Builder omResponse,\n      OmBucketInfo omBucketInfo, boolean operationResult) {\n    omResponse.setSuccess(operationResult);\n    omResponse.setAddAclResponse(AddAclResponse.newBuilder()\n         .setResponse(operationResult));\n\nBut in OmVolumeSetOwner case, there is no such flag. If we can introduce a flag in SetVolumePropertyResponse, we can use the success flag.\n  omResponse.setSetVolumePropertyResponse(\n      SetVolumePropertyResponse.newBuilder().build());", "author": "bharatviswa504", "createdAt": "2020-04-14T16:14:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3OTA5OA==", "url": "https://github.com/apache/ozone/pull/806#discussion_r408279098", "bodyText": "Just to add more info, we set the success flag and also there is a response which we return that is used by the end client which has a response flag which is set based on the result of the operation.\n  OMClientResponse onSuccess(OMResponse.Builder omResponse,\n      OmBucketInfo omBucketInfo, boolean operationResult) {\n    omResponse.setSuccess(operationResult);\n    omResponse.setAddAclResponse(AddAclResponse.newBuilder()\n         .setResponse(operationResult));\n\nBut in OmVolumeSetOwner case, there is no such flag. If we can introduce a flag in SetVolumePropertyResponse, we can use the success flag.\n  omResponse.setSetVolumePropertyResponse(\n      SetVolumePropertyResponse.newBuilder().build());\n\n\nGood idea we can add optional bool response = 1; in here in another jira.", "author": "smengcl", "createdAt": "2020-04-14T16:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMyNjU5Ng==", "url": "https://github.com/apache/ozone/pull/806#discussion_r408326596", "bodyText": "Discussed with @xiaoyuyao and we agree the comment don't need to be changed at the moment.\nResolving this conversation. Will commit shortly.", "author": "smengcl", "createdAt": "2020-04-14T17:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTQ0Mg=="}], "type": "inlineReview"}]}