{"pr_number": 1412, "pr_title": "HDDS-3751. Ozone sh client support bucket quota option.", "pr_createdAt": "2020-09-09T13:52:39Z", "pr_url": "https://github.com/apache/ozone/pull/1412", "timeline": [{"oid": "90449d9c1aff2ff887ba1f34e2b711cf380229b8", "url": "https://github.com/apache/ozone/commit/90449d9c1aff2ff887ba1f34e2b711cf380229b8", "message": "Ozone sh client support bucket quota option.", "committedDate": "2020-09-09T13:51:10Z", "type": "forcePushed"}, {"oid": "8acd1b25c1ff2764fe2e2aebfc6acaff5759d66a", "url": "https://github.com/apache/ozone/commit/8acd1b25c1ff2764fe2e2aebfc6acaff5759d66a", "message": "fix ut.", "committedDate": "2020-09-10T03:46:19Z", "type": "forcePushed"}, {"oid": "532768181cafb281ed4974b63f2415dc4f06159a", "url": "https://github.com/apache/ozone/commit/532768181cafb281ed4974b63f2415dc4f06159a", "message": "fix ut.", "committedDate": "2020-09-10T07:39:53Z", "type": "forcePushed"}, {"oid": "4a468a8ea88e60c58f769ea31c149a7aee8b3794", "url": "https://github.com/apache/ozone/commit/4a468a8ea88e60c58f769ea31c149a7aee8b3794", "message": "fix ut.", "committedDate": "2020-09-10T09:27:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3NTk3MA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r486775970", "bodyText": "Out of curiosity: what is the purpose of @SuppressWarnings(\"parameternumber\")?", "author": "amaliujia", "createdAt": "2020-09-11T05:06:47Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneBucket.java", "diffHunk": "@@ -174,6 +184,20 @@ public OzoneBucket(ConfigurationSource conf, ClientProtocol proxy,\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }\n \n+  @SuppressWarnings(\"parameternumber\")", "originalCommit": "4a468a8ea88e60c58f769ea31c149a7aee8b3794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxMTUzOQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r488511539", "bodyText": "Thanks for @amaliujia\u2018s review.\nOzone's CheckStyle requires that the number of method variables must not exceed a certain value, or the check fails.  So it borrows from other usage.", "author": "captainzmc", "createdAt": "2020-09-15T09:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3NTk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3NzYwNQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r486777605", "bodyText": "Do you need to verify whether quotaInBytes and quotaInCounts are valid? e.g. >= 0?", "author": "amaliujia", "createdAt": "2020-09-11T05:12:57Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -464,6 +469,8 @@ public void createBucket(\n         .setStorageType(storageType)\n         .setSourceVolume(bucketArgs.getSourceVolume())\n         .setSourceBucket(bucketArgs.getSourceBucket())\n+        .setQuotaInBytes(quotaInBytes)\n+        .setQuotaInCounts(quotaInCounts)", "originalCommit": "4a468a8ea88e60c58f769ea31c149a7aee8b3794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUzNDQ3Ng==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r488534476", "bodyText": "I had added a verify method In new commit.", "author": "captainzmc", "createdAt": "2020-09-15T09:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3NzYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3NDQ5Nw==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490174497", "bodyText": "This verifyQuota has the same function as above two. Suggest choose one and remove the other.", "author": "ChenSammi", "createdAt": "2020-09-17T11:37:26Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -494,6 +500,30 @@ private static void verifyBucketName(String bucketName) throws OMException {\n     }\n   }\n \n+  private static void verifyCountsQuota(long quota) throws OMException {\n+    if ((quota < OzoneConsts.QUOTA_RESET)) {\n+      throw new IllegalArgumentException(\"Invalid values for quota : \" +\n+          \"counts quota is :\" + quota + \".\");\n+    }\n+  }\n+\n+  private static void verifySpaceQuota(long quota) throws OMException {\n+    if ((quota < OzoneConsts.QUOTA_RESET)) {\n+      throw new IllegalArgumentException(\"Invalid values for quota : \" +\n+          \"space quota is :\" + quota + \".\");\n+    }\n+  }\n+\n+  private static void verifyQuota(long quotaInCounts, long quotaInBytes)", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3NTcyMg==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490175722", "bodyText": "quotaInBytes in VolumeArgs has String as type. Can we unify them?", "author": "ChenSammi", "createdAt": "2020-09-17T11:39:30Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/BucketArgs.java", "diffHunk": "@@ -57,6 +57,9 @@\n   private final String sourceVolume;\n   private final String sourceBucket;\n \n+  private long quotaInBytes;", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIzMTg1Mg==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490231852", "bodyText": "I will change the String in VolumeArgs to long", "author": "captainzmc", "createdAt": "2020-09-17T13:12:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3NTcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3ODEwMg==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490178102", "bodyText": "Can we add default -1 value to newly added fields in proto file?", "author": "ChenSammi", "createdAt": "2020-09-17T11:44:14Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -439,6 +434,15 @@ public void createBucket(\n     verifyVolumeName(volumeName);\n     verifyBucketName(bucketName);\n     Preconditions.checkNotNull(bucketArgs);\n+    verifyCountsQuota(bucketArgs.getQuotaInCounts());\n+    verifySpaceQuota(bucketArgs.getQuotaInBytes());\n+\n+    // When creating buckets using the API, if the user does not specify quota,\n+    // 0 is passed in by default, which should be set to -1.", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1NzMwNQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490257305", "bodyText": "In proto unsigned field can't have negative default value. The logic here is the same and I can encapsulate it as a method, which should be better", "author": "captainzmc", "createdAt": "2020-09-17T13:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3ODEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3OTI1Ng==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490179256", "bodyText": "verify volume", "author": "ChenSammi", "createdAt": "2020-09-17T11:46:32Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -598,6 +628,20 @@ public void setBucketStorageType(\n     ozoneManagerClient.setBucketProperty(builder.build());\n   }\n \n+  @Override\n+  public void setBucketQuota(String volumeName, String bucketName,\n+      long quotaInCounts, long quotaInBytes) throws IOException {\n+    HddsClientUtils.verifyResourceName(bucketName);", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3OTc1OA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490179758", "bodyText": "setBucketQuota?  setBucketProperty?", "author": "ChenSammi", "createdAt": "2020-09-17T11:47:41Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -598,6 +628,20 @@ public void setBucketStorageType(\n     ozoneManagerClient.setBucketProperty(builder.build());\n   }\n \n+  @Override\n+  public void setBucketQuota(String volumeName, String bucketName,\n+      long quotaInCounts, long quotaInBytes) throws IOException {\n+    HddsClientUtils.verifyResourceName(bucketName);\n+    verifyQuota(quotaInCounts, quotaInBytes);\n+    OmBucketArgs.Builder builder = OmBucketArgs.newBuilder();\n+    builder.setVolumeName(volumeName)\n+        .setBucketName(bucketName)\n+        .setQuotaInBytes(quotaInBytes)\n+        .setQuotaInCounts(quotaInCounts);\n+    ozoneManagerClient.setBucketProperty(builder.build());", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI3MDk5NQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490270995", "bodyText": "Bucket provides the setBucketProperty method and the corresponding request to modify the bucket information. This method already exists and is not something I added later. So here I'm reusing the method.", "author": "captainzmc", "createdAt": "2020-09-17T14:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3OTc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE4NTgyMA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490185820", "bodyText": "indent", "author": "ChenSammi", "createdAt": "2020-09-17T11:57:26Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -297,4 +301,28 @@ private BucketEncryptionInfoProto getBeinfo(\n             CipherSuite.convert(metadata.getCipher())));\n     return bekb.build();\n   }\n+\n+  public void checkQuotaBytesValid(OmVolumeArgs omVolumeArgs,\n+                                      OmBucketInfo omBucketInfo) {", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE4Nzc3OA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490187778", "bodyText": "--quota -> --keyQuota   -q -> -kq", "author": "ChenSammi", "createdAt": "2020-09-17T12:00:41Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/CreateBucketHandler.java", "diffHunk": "@@ -46,6 +47,14 @@\n           \"false/unspecified indicates otherwise\")\n   private Boolean isGdprEnforced;\n \n+  @Option(names = {\"--spaceQuota\", \"-sq\"},\n+      description = \"Quota in bytes of the newly created bucket (eg. 1GB)\")\n+  private String quotaInBytes;\n+\n+  @Option(names = {\"--quota\", \"-q\"},", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIxMzUwMA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490213500", "bodyText": "I would suggest dropping the short option.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Option(names = {\"--quota\", \"-q\"},\n          \n          \n            \n              @Option(names = {\"--key-quota\"},", "author": "adoroszlai", "createdAt": "2020-09-17T12:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE4Nzc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE4ODE1MQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490188151", "bodyText": "same as above", "author": "ChenSammi", "createdAt": "2020-09-17T12:01:26Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/UpdateBucketHandler.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.bucket;\n+\n+import org.apache.hadoop.hdds.client.OzoneQuota;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+import java.io.IOException;\n+\n+/**\n+ * create bucket handler.\n+ */\n+@Command(name = \"update\",\n+    description = \"Updates parameter of the buckets\")\n+public class UpdateBucketHandler extends BucketHandler {\n+\n+  @Option(names = {\"--spaceQuota\", \"-sq\"},\n+      description = \"Quota in bytes of the newly created volume (eg. 1GB)\")\n+  private String quotaInBytes;\n+\n+  @Option(names = {\"--quota\", \"-q\"},", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE2OTg3NA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490169874", "bodyText": "If you want to keep this QuotaInBytes and  QuotaInCounts  big enough, you can set it to Long.MAX_VALUE;", "author": "maobaolong", "createdAt": "2020-09-17T11:29:16Z", "path": "hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/TestOMRequestUtils.java", "diffHunk": "@@ -283,7 +285,8 @@ public static void addVolumeToDB(String volumeName, String ownerName,\n     OmVolumeArgs omVolumeArgs =\n         OmVolumeArgs.newBuilder().setCreationTime(Time.now())\n             .setVolume(volumeName).setAdminName(ownerName)\n-            .setOwnerName(ownerName).build();\n+            .setOwnerName(ownerName).setQuotaInBytes(1024 * GB)", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE3MjEyOA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490172128", "bodyText": "You can use \"9223372036854775808\" here, it stand for the Long.MAX_VALUE + 1", "author": "maobaolong", "createdAt": "2020-09-17T11:33:23Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -269,6 +269,68 @@ public void testVolumeSetOwner() throws IOException {\n     proxy.setVolumeOwner(volumeName, ownerName);\n   }\n \n+  @Test\n+  public void testSetBucketQuota() throws IOException {\n+    String volumeName = UUID.randomUUID().toString();\n+    String bucketName = UUID.randomUUID().toString();\n+    store.createVolume(volumeName);\n+    store.getVolume(volumeName).setQuota(OzoneQuota.parseQuota(\n+        \"10GB\", 10000L));\n+    store.getVolume(volumeName).createBucket(bucketName);\n+    OzoneBucket bucket = store.getVolume(volumeName).getBucket(bucketName);\n+\n+    Assert.assertEquals(OzoneConsts.QUOTA_RESET, bucket.getQuotaInBytes());\n+    Assert.assertEquals(OzoneConsts.QUOTA_RESET, bucket.getQuotaInCounts());\n+    store.getVolume(volumeName).getBucket(bucketName).setQuota(\n+        OzoneQuota.parseQuota(\"1GB\", 1000L));\n+    OzoneBucket ozoneBucket = store.getVolume(volumeName).getBucket(bucketName);\n+    Assert.assertEquals(1024 * 1024 * 1024,\n+        ozoneBucket.getQuotaInBytes());\n+    Assert.assertEquals(1000L, ozoneBucket.getQuotaInCounts());\n+  }\n+\n+  @Test\n+  public void testSetBucketQuotaIllegal() throws IOException {\n+    String volumeName = UUID.randomUUID().toString();\n+    String bucketName = UUID.randomUUID().toString();\n+    store.createVolume(volumeName);\n+    store.getVolume(volumeName).createBucket(bucketName);\n+\n+    try {\n+      store.getVolume(volumeName).getBucket(bucketName).setQuota(\n+          OzoneQuota.parseQuota(\"1GB\", -100L));\n+    } catch (IllegalArgumentException ex) {\n+      GenericTestUtils.assertExceptionContains(\n+          \"Invalid values for quota\", ex);\n+    }\n+    // The unit should be legal.\n+    try {\n+      store.getVolume(volumeName).getBucket(bucketName).setQuota(\n+          OzoneQuota.parseQuota(\"1TEST\", 100L));\n+    } catch (IllegalArgumentException ex) {\n+      GenericTestUtils.assertExceptionContains(\n+          \"Invalid values for quota\", ex);\n+    }\n+\n+    // The setting value cannot be greater than LONG.MAX_VALUE BYTES.\n+    try {\n+      store.getVolume(volumeName).getBucket(bucketName).setQuota(\n+          OzoneQuota.parseQuota(\"9999999999999GB\", 100L));", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE5MjY2OQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490192669", "bodyText": "update -> setquota,  could you please also change the volume quota update command to setquota?\nWe also need a remove quota CLI for both volume and bucket.", "author": "ChenSammi", "createdAt": "2020-09-17T12:09:36Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/UpdateBucketHandler.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.bucket;\n+\n+import org.apache.hadoop.hdds.client.OzoneQuota;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+import java.io.IOException;\n+\n+/**\n+ * create bucket handler.\n+ */\n+@Command(name = \"update\",", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIxMzE0Mg==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490213142", "bodyText": "Short options should be only one character to support option grouping (ie. -sq should be two separate options, same as -s -q).\nLong options should not be camel-case, rather lower-case using dash as separator.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Option(names = {\"--spaceQuota\", \"-sq\"},\n          \n          \n            \n              @Option(names = {\"--space-quota\", \"-s\"},", "author": "adoroszlai", "createdAt": "2020-09-17T12:44:24Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/CreateBucketHandler.java", "diffHunk": "@@ -46,6 +47,14 @@\n           \"false/unspecified indicates otherwise\")\n   private Boolean isGdprEnforced;\n \n+  @Option(names = {\"--spaceQuota\", \"-sq\"},", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIyNTg5Nw==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490225897", "bodyText": "Please consider creating a mixin with the two quota options to ensure consistency and reduce duplication.  See ListOptions for example, and its usages in\nhttps://github.com/apache/hadoop-ozone/blob/079ee7fc2a223e1251b16b9c42004aa2a27bf0f4/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/ListVolumeHandler.java#L51-L52\nand\nhttps://github.com/apache/hadoop-ozone/blob/079ee7fc2a223e1251b16b9c42004aa2a27bf0f4/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/ListBucketHandler.java#L42-L43\nOption descriptions can be generic, without mentioning \"newly created volume\" etc., so they can be applied to create|update volume|bucket.", "author": "adoroszlai", "createdAt": "2020-09-17T13:03:16Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/UpdateBucketHandler.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.bucket;\n+\n+import org.apache.hadoop.hdds.client.OzoneQuota;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+import java.io.IOException;\n+\n+/**\n+ * create bucket handler.\n+ */\n+@Command(name = \"update\",\n+    description = \"Updates parameter of the buckets\")\n+public class UpdateBucketHandler extends BucketHandler {\n+\n+  @Option(names = {\"--spaceQuota\", \"-sq\"},\n+      description = \"Quota in bytes of the newly created volume (eg. 1GB)\")", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIzNTE2NA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490235164", "bodyText": "nit: leftover doc", "author": "adoroszlai", "createdAt": "2020-09-17T13:16:48Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/UpdateBucketHandler.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.bucket;\n+\n+import org.apache.hadoop.hdds.client.OzoneQuota;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+import java.io.IOException;\n+\n+/**\n+ * create bucket handler.", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIzNTIzOA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490235238", "bodyText": "nit: leftover doc", "author": "adoroszlai", "createdAt": "2020-09-17T13:16:55Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/UpdateBucketHandler.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.bucket;\n+\n+import org.apache.hadoop.hdds.client.OzoneQuota;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+import java.io.IOException;\n+\n+/**\n+ * create bucket handler.\n+ */\n+@Command(name = \"update\",\n+    description = \"Updates parameter of the buckets\")\n+public class UpdateBucketHandler extends BucketHandler {\n+\n+  @Option(names = {\"--spaceQuota\", \"-sq\"},\n+      description = \"Quota in bytes of the newly created volume (eg. 1GB)\")\n+  private String quotaInBytes;\n+\n+  @Option(names = {\"--quota\", \"-q\"},\n+      description = \"Key counts of the newly created bucket (eg. 5)\")\n+  private long quotaInCounts = OzoneConsts.QUOTA_RESET;\n+\n+  /**\n+   * Executes create bucket.", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0MTQyOQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r490241429", "bodyText": "Argument validity should be checked before acquiring lock, preferably in preExecute.\nAlso, please verify that the bucket is not a link, if quota is set in the request.  Links cannot have actual content, so they should not have any quota defined, similar to encryption:\nhttps://github.com/apache/hadoop-ozone/blob/079ee7fc2a223e1251b16b9c42004aa2a27bf0f4/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java#L127-L130", "author": "adoroszlai", "createdAt": "2020-09-17T13:24:42Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -192,6 +192,10 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         throw new OMException(\"Bucket already exist\", BUCKET_ALREADY_EXISTS);\n       }\n \n+      //Check quotaInBytes and quotaInCounts to update\n+      checkQuotaBytesValid(omVolumeArgs, omBucketInfo);\n+      checkQuotaCountsValid(omVolumeArgs, omBucketInfo);", "originalCommit": "0a335167fc9d9e401c4df166735a43db8e643756", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1MTQ4Nw==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r496451487", "bodyText": "Thanks @adoroszlai for the advice, the check action needs to get the volume or bucket in DB, so it better to do this action after acquiring the lock.  And other comments has been fixed.", "author": "captainzmc", "createdAt": "2020-09-29T06:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0MTQyOQ=="}], "type": "inlineReview"}, {"oid": "2ee20ba519e46b645196cce879d5238354c317e9", "url": "https://github.com/apache/ozone/commit/2ee20ba519e46b645196cce879d5238354c317e9", "message": "fix review issues", "committedDate": "2020-09-19T13:28:15Z", "type": "forcePushed"}, {"oid": "3967b86967b5eae550199ee9b9a0d15c1544e059", "url": "https://github.com/apache/ozone/commit/3967b86967b5eae550199ee9b9a0d15c1544e059", "message": "fix review issues", "committedDate": "2020-09-19T13:55:34Z", "type": "forcePushed"}, {"oid": "2da62920d2d926f17b40cbea29ebd506f7051be8", "url": "https://github.com/apache/ozone/commit/2da62920d2d926f17b40cbea29ebd506f7051be8", "message": "fix review issues", "committedDate": "2020-09-19T14:05:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2MTEyMA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r492461120", "bodyText": "parameter statement is incorrent.", "author": "ChenSammi", "createdAt": "2020-09-22T03:54:50Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/BucketArgs.java", "diffHunk": "@@ -66,17 +69,23 @@\n    * @param bucketEncryptionKey bucket encryption key name\n    * @param sourceVolume\n    * @param sourceBucket\n+   * @param quotaInBytes Volume quota in bytes.", "originalCommit": "2da62920d2d926f17b40cbea29ebd506f7051be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwMDQxNQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r492500415", "bodyText": "Bucket has quota while Volume doesn't\uff0cthis is a common case.", "author": "ChenSammi", "createdAt": "2020-09-22T06:32:44Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -282,15 +285,48 @@ public boolean setOwner(String userName) throws IOException {\n     return result;\n   }\n \n+  /**\n+   * Clean the space quota of the volume.\n+   *\n+   * @throws IOException\n+   */\n+  public void clearSpaceQuota() throws IOException {\n+    OzoneVolume ozoneVolume = proxy.getVolumeDetails(name);\n+    Iterator bucketIter = ozoneVolume.listBuckets(null);\n+    while (bucketIter.hasNext()) {\n+      OzoneBucket nextBucket = (OzoneBucket) bucketIter.next();\n+      if(nextBucket.getQuotaInBytes() != QUOTA_RESET) {", "originalCommit": "2da62920d2d926f17b40cbea29ebd506f7051be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNTU1NQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r492505555", "bodyText": "@param order doesn't match the real parmater order.", "author": "ChenSammi", "createdAt": "2020-09-22T06:45:14Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/protocol/ClientProtocol.java", "diffHunk": "@@ -655,4 +655,15 @@ OzoneOutputStream createFile(String volumeName, String bucketName,\n    * Getter for OzoneManagerClient.\n    */\n   OzoneManagerProtocol getOzoneManagerClient();\n+\n+  /**\n+   * Set Bucket Quota.\n+   * @param volumeName Name of the Volume.\n+   * @param bucketName Name of the Bucket.\n+   * @param quotaInBytes The maximum size this volume can be used.", "originalCommit": "2da62920d2d926f17b40cbea29ebd506f7051be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxMTM5Nw==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r492511397", "bodyText": "typo  comands", "author": "ChenSammi", "createdAt": "2020-09-22T06:58:29Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/ClearSpaceQuotaOptions.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell;\n+\n+import picocli.CommandLine;\n+\n+/**\n+ * Common options for 'clrquota' comands.", "originalCommit": "2da62920d2d926f17b40cbea29ebd506f7051be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxNTE5Nw==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r492515197", "bodyText": "statement is stale.", "author": "ChenSammi", "createdAt": "2020-09-22T07:07:08Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/SetQuotaHandler.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.shell.volume;\n+\n+import org.apache.hadoop.hdds.client.OzoneQuota;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.SetSpaceQuotaOptions;\n+import picocli.CommandLine;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Executes update volume calls.", "originalCommit": "2da62920d2d926f17b40cbea29ebd506f7051be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxNTc4Ng==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r492515786", "bodyText": "set -> create", "author": "ChenSammi", "createdAt": "2020-09-22T07:08:30Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/SetQuotaHandler.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.shell.volume;\n+\n+import org.apache.hadoop.hdds.client.OzoneQuota;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.SetSpaceQuotaOptions;\n+import picocli.CommandLine;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Executes update volume calls.\n+ */\n+@Command(name = \"setquota\",\n+    description = \"Set quota of the volumes\")\n+public class SetQuotaHandler extends VolumeHandler {\n+\n+  @CommandLine.Mixin\n+  private SetSpaceQuotaOptions quotaOptions;\n+\n+  @Option(names = {\"--bucket-quota\"},\n+      description = \"Bucket counts of the volume to set (eg. 5)\")", "originalCommit": "2da62920d2d926f17b40cbea29ebd506f7051be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxNzk0MA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r492517940", "bodyText": "Need check sum of all bucket quota under the Volume. Better cover this case in UT.\nWe also need this check when update volume quato.", "author": "ChenSammi", "createdAt": "2020-09-22T07:13:15Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -297,4 +300,17 @@ private BucketEncryptionInfoProto getBeinfo(\n             CipherSuite.convert(metadata.getCipher())));\n     return bekb.build();\n   }\n+\n+  public void checkQuotaBytesValid(OmVolumeArgs omVolumeArgs,\n+      OmBucketInfo omBucketInfo) {\n+    long volumeQuotaInBytes = omVolumeArgs.getQuotaInBytes();\n+    long quotaInBytes = omBucketInfo.getQuotaInBytes();\n+    if(volumeQuotaInBytes < quotaInBytes) {", "originalCommit": "2da62920d2d926f17b40cbea29ebd506f7051be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxODI1NA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r492518254", "bodyText": "same as above.", "author": "ChenSammi", "createdAt": "2020-09-22T07:14:01Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -150,6 +148,20 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n             .setIsVersionEnabled(dbBucketInfo.getIsVersionEnabled());\n       }\n \n+      //Check quotaInBytes and quotaInCounts to update\n+      String volumeKey = omMetadataManager.getVolumeKey(volumeName);\n+      OmVolumeArgs omVolumeArgs = omMetadataManager.getVolumeTable()\n+          .get(volumeKey);\n+      if (checkQuotaBytesValid(omVolumeArgs, omBucketArgs)) {", "originalCommit": "2da62920d2d926f17b40cbea29ebd506f7051be8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf0e0942157e674342d533577bfbadcdc90e58bd", "url": "https://github.com/apache/ozone/commit/bf0e0942157e674342d533577bfbadcdc90e58bd", "message": "fix review issues", "committedDate": "2020-09-22T14:09:34Z", "type": "forcePushed"}, {"oid": "ac7a49fe69b64e30306fed051b11ed7896c5ace1", "url": "https://github.com/apache/ozone/commit/ac7a49fe69b64e30306fed051b11ed7896c5ace1", "message": "fix review issues", "committedDate": "2020-09-22T16:09:24Z", "type": "forcePushed"}, {"oid": "f1e36a9f3691143798686af3ccba408952185214", "url": "https://github.com/apache/ozone/commit/f1e36a9f3691143798686af3ccba408952185214", "message": "fix review issues", "committedDate": "2020-09-22T16:42:06Z", "type": "forcePushed"}, {"oid": "e9cfb227f25ec91cf81c3af080d1ae7c72bf0b51", "url": "https://github.com/apache/ozone/commit/e9cfb227f25ec91cf81c3af080d1ae7c72bf0b51", "message": "fix review issues", "committedDate": "2020-09-22T16:54:46Z", "type": "forcePushed"}, {"oid": "af358b82182706be78b5a3227ee17282162bc095", "url": "https://github.com/apache/ozone/commit/af358b82182706be78b5a3227ee17282162bc095", "message": "fix review issues", "committedDate": "2020-09-22T17:32:23Z", "type": "forcePushed"}, {"oid": "4d673fdb3fed3355d9708e559098229bf2d49af6", "url": "https://github.com/apache/ozone/commit/4d673fdb3fed3355d9708e559098229bf2d49af6", "message": "fix review issues", "committedDate": "2020-09-23T03:08:42Z", "type": "forcePushed"}, {"oid": "8f5c12285b8d98dbc3b6610a66bf53b771b8dd3c", "url": "https://github.com/apache/ozone/commit/8f5c12285b8d98dbc3b6610a66bf53b771b8dd3c", "message": "fix review issues", "committedDate": "2020-09-24T04:52:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxOTI3Mw==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r495519273", "bodyText": "same as other place.", "author": "ChenSammi", "createdAt": "2020-09-27T02:45:15Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/exceptions/OMException.java", "diffHunk": "@@ -229,7 +229,9 @@ public String toString() {\n \n     NOT_SUPPORTED_OPERATION,\n \n-    PARTIAL_RENAME\n+    PARTIAL_RENAME,\n+\n+    BUCKET_SPACE_QUOTA_NOT_RESET", "originalCommit": "8f5c12285b8d98dbc3b6610a66bf53b771b8dd3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc3NTg0Mg==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r495775842", "bodyText": "single ( is enough.", "author": "ChenSammi", "createdAt": "2020-09-28T08:36:37Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -496,6 +491,28 @@ private static void verifyBucketName(String bucketName) throws OMException {\n     }\n   }\n \n+  private static void verifyCountsQuota(long quota) throws OMException {\n+    if ((quota < OzoneConsts.QUOTA_RESET)) {", "originalCommit": "bfd134cd2c84bf7f4d4b61983a7810ad0fa7cf27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc3NjE0OQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r495776149", "bodyText": "same as above", "author": "ChenSammi", "createdAt": "2020-09-28T08:37:06Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -496,6 +491,28 @@ private static void verifyBucketName(String bucketName) throws OMException {\n     }\n   }\n \n+  private static void verifyCountsQuota(long quota) throws OMException {\n+    if ((quota < OzoneConsts.QUOTA_RESET)) {\n+      throw new IllegalArgumentException(\"Invalid values for quota : \" +\n+          \"counts quota is :\" + quota + \".\");\n+    }\n+  }\n+\n+  private static void verifySpaceQuota(long quota) throws OMException {\n+    if ((quota < OzoneConsts.QUOTA_RESET)) {", "originalCommit": "bfd134cd2c84bf7f4d4b61983a7810ad0fa7cf27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc3NzEzMQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r495777131", "bodyText": "Can we align the  quotaInBytes and quotaInCounts order in setVolumeQuota and setBucketQuota\uff1f  In another words, no need for the code change here.", "author": "ChenSammi", "createdAt": "2020-09-28T08:38:54Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -334,15 +329,11 @@ public boolean setVolumeOwner(String volumeName, String owner)\n   }\n \n   @Override\n-  public void setVolumeQuota(String volumeName, long quotaInCounts,\n-      long quotaInBytes) throws IOException {\n+  public void setVolumeQuota(String volumeName, long quotaInBytes,\n+      long quotaInCounts) throws IOException {", "originalCommit": "bfd134cd2c84bf7f4d4b61983a7810ad0fa7cf27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc5Nzg5Nw==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r495797897", "bodyText": "leftover statement", "author": "ChenSammi", "createdAt": "2020-09-28T09:13:58Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/SetQuotaHandler.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.bucket;\n+\n+import org.apache.hadoop.hdds.client.OzoneQuota;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.SetSpaceQuotaOptions;\n+import picocli.CommandLine;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+import java.io.IOException;\n+\n+/**\n+ * set quota of the bucket.\n+ */\n+@Command(name = \"setquota\",\n+    description = \"Set quota of the buckets\")\n+public class SetQuotaHandler extends BucketHandler {\n+\n+  @CommandLine.Mixin\n+  private SetSpaceQuotaOptions quotaOptions;\n+\n+  @Option(names = {\"--key-quota\"},\n+      description = \"Key counts of the newly created bucket (eg. 5)\")\n+  private long quotaInCounts = OzoneConsts.QUOTA_RESET;\n+\n+  /**\n+   * Executes create bucket.", "originalCommit": "bfd134cd2c84bf7f4d4b61983a7810ad0fa7cf27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d1b36360a0240717c0a69d8168035f120e4145ba", "url": "https://github.com/apache/ozone/commit/d1b36360a0240717c0a69d8168035f120e4145ba", "message": "fix review issues", "committedDate": "2020-09-28T13:20:03Z", "type": "forcePushed"}, {"oid": "81dba9e55fa19138973d0444d73343b8c3a86773", "url": "https://github.com/apache/ozone/commit/81dba9e55fa19138973d0444d73343b8c3a86773", "message": "Ozone sh client support bucket quota option.", "committedDate": "2020-09-29T03:44:20Z", "type": "commit"}, {"oid": "81dba9e55fa19138973d0444d73343b8c3a86773", "url": "https://github.com/apache/ozone/commit/81dba9e55fa19138973d0444d73343b8c3a86773", "message": "Ozone sh client support bucket quota option.", "committedDate": "2020-09-29T03:44:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYwNjI3Mg==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r496606272", "bodyText": "Arguments are already checked, why change from use of the variables to getQuotaValue?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                builder.setQuotaInBytes(getQuotaValue(volArgs.getQuotaInBytes()));\n          \n          \n            \n                builder.setQuotaInCounts(getQuotaValue(volArgs.getQuotaInCounts()));\n          \n          \n            \n                builder.setQuotaInBytes(quotaInBytes);\n          \n          \n            \n                builder.setQuotaInCounts(quotaInCounts);", "author": "adoroszlai", "createdAt": "2020-09-29T10:21:27Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -305,8 +300,8 @@ public void createVolume(String volumeName, VolumeArgs volArgs)\n     builder.setVolume(volumeName);\n     builder.setAdminName(admin);\n     builder.setOwnerName(owner);\n-    builder.setQuotaInBytes(quotaInBytes);\n-    builder.setQuotaInCounts(quotaInCounts);\n+    builder.setQuotaInBytes(getQuotaValue(volArgs.getQuotaInBytes()));\n+    builder.setQuotaInCounts(getQuotaValue(volArgs.getQuotaInCounts()));", "originalCommit": "81dba9e55fa19138973d0444d73343b8c3a86773", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYxNzI5OQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r496617299", "bodyText": "createBucket verifies quota args, but createVolume does not.  Is this intentional?", "author": "adoroszlai", "createdAt": "2020-09-29T10:41:39Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -441,6 +431,8 @@ public void createBucket(\n     verifyVolumeName(volumeName);\n     verifyBucketName(bucketName);\n     Preconditions.checkNotNull(bucketArgs);\n+    verifyCountsQuota(bucketArgs.getQuotaInCounts());\n+    verifySpaceQuota(bucketArgs.getQuotaInBytes());", "originalCommit": "81dba9e55fa19138973d0444d73343b8c3a86773", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY2MjA2OA==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r496662068", "bodyText": "The PR of createVolume did not add a checkmark before, I will add this in the createVolume.", "author": "captainzmc", "createdAt": "2020-09-29T12:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYxNzI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyMTA1NQ==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r496621055", "bodyText": "By using a bit more generic option name --count-quota, this could be moved into ClearSpaceQuotaOptions (and unified with volume's --bucket-quota option).", "author": "adoroszlai", "createdAt": "2020-09-29T10:48:38Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/ClearQuotaHandler.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.shell.bucket;\n+\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.ClearSpaceQuotaOptions;\n+import picocli.CommandLine;\n+import picocli.CommandLine.Command;\n+\n+import java.io.IOException;\n+\n+/**\n+ * clean quota of the bucket.\n+ */\n+@Command(name = \"clrquota\",\n+    description = \"clear quota of the bucket\")\n+public class ClearQuotaHandler extends BucketHandler {\n+\n+  @CommandLine.Mixin\n+  private ClearSpaceQuotaOptions clrSpaceQuota;\n+\n+  @CommandLine.Option(names = {\"--key-quota\"},\n+      description = \"clear count quota\")\n+  private boolean clrKeyQuota;", "originalCommit": "81dba9e55fa19138973d0444d73343b8c3a86773", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyMjE1Mg==", "url": "https://github.com/apache/ozone/pull/1412#discussion_r496622152", "bodyText": "Similarly to the option for ClearQuotaHandler:\nby using a bit more generic option name --count-quota (and description), this could be moved into SetSpaceQuotaOptions (and unified with volume's --bucket-quota option).", "author": "adoroszlai", "createdAt": "2020-09-29T10:50:44Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/CreateBucketHandler.java", "diffHunk": "@@ -46,6 +49,13 @@\n           \"false/unspecified indicates otherwise\")\n   private Boolean isGdprEnforced;\n \n+  @CommandLine.Mixin\n+  private SetSpaceQuotaOptions quotaOptions;\n+\n+  @Option(names = {\"--key-quota\"},\n+      description = \"Key counts of the newly created bucket (eg. 5)\")\n+  private long quotaInCounts = OzoneConsts.QUOTA_RESET;", "originalCommit": "81dba9e55fa19138973d0444d73343b8c3a86773", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b4a99585a801b302b7f635a80f48b1b6f03b7c9", "url": "https://github.com/apache/ozone/commit/4b4a99585a801b302b7f635a80f48b1b6f03b7c9", "message": "fix review issues", "committedDate": "2020-09-29T12:40:11Z", "type": "commit"}, {"oid": "a892560b8268cf39c5a362ee2bae18ccdf031d7e", "url": "https://github.com/apache/ozone/commit/a892560b8268cf39c5a362ee2bae18ccdf031d7e", "message": "trigger new CI check", "committedDate": "2020-09-29T13:42:25Z", "type": "commit"}, {"oid": "b748978d714cfbf698f6ac785e9c054514d919c9", "url": "https://github.com/apache/ozone/commit/b748978d714cfbf698f6ac785e9c054514d919c9", "message": "trigger new CI check", "committedDate": "2020-09-29T13:45:31Z", "type": "commit"}]}