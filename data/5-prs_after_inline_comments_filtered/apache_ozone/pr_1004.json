{"pr_number": 1004, "pr_title": "HDDS-3639. Maintain FileHandle Information in OMMetadataManager.", "pr_createdAt": "2020-06-02T05:58:03Z", "pr_url": "https://github.com/apache/ozone/pull/1004", "timeline": [{"oid": "e539d0bd4c182a7b60a18d08f672cf9b5c9ee65f", "url": "https://github.com/apache/ozone/commit/e539d0bd4c182a7b60a18d08f672cf9b5c9ee65f", "message": "HDDS-3639. Maintain FileHandle Information in OMMetadataManager.", "committedDate": "2020-06-02T05:52:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyNTQ1MQ==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r434125451", "bodyText": "Isn't this check already done inside createToKeyAndDeleteFromKey()?", "author": "avijayanhwx", "createdAt": "2020-06-02T19:27:30Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyRenameResponse.java", "diffHunk": "@@ -88,11 +88,22 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n           omMetadataManager.getOzoneKey(volumeName, bucketName, fromKeyName));\n     } else if (createToKeyAndDeleteFromKey()) {\n       // If both from and toKeyName are equal do nothing\n-      omMetadataManager.getKeyTable().deleteWithBatch(batchOperation,\n-          omMetadataManager.getOzoneKey(volumeName, bucketName, fromKeyName));\n-      omMetadataManager.getKeyTable().putWithBatch(batchOperation,\n-          omMetadataManager.getOzoneKey(volumeName, bucketName, toKeyName),\n-          newKeyInfo);\n+      if (!toKeyName.equals(fromKeyName)) {", "originalCommit": "e539d0bd4c182a7b60a18d08f672cf9b5c9ee65f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NjE5NA==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r434276194", "bodyText": "Yes, the check is there in createToKeyAndDeleteFromKey() and it is redundant. I will remove the check from here and upload again.", "author": "prashantpogde", "createdAt": "2020-06-03T02:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyNTQ1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyNjE2OA==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r434126168", "bodyText": "What does it mean for the fileHandleInfo to be zero? If it is zero, we do not delete the old Id from the keyIdTable?", "author": "avijayanhwx", "createdAt": "2020-06-02T19:28:47Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyRenameResponse.java", "diffHunk": "@@ -88,11 +88,22 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n           omMetadataManager.getOzoneKey(volumeName, bucketName, fromKeyName));\n     } else if (createToKeyAndDeleteFromKey()) {\n       // If both from and toKeyName are equal do nothing\n-      omMetadataManager.getKeyTable().deleteWithBatch(batchOperation,\n-          omMetadataManager.getOzoneKey(volumeName, bucketName, fromKeyName));\n-      omMetadataManager.getKeyTable().putWithBatch(batchOperation,\n-          omMetadataManager.getOzoneKey(volumeName, bucketName, toKeyName),\n-          newKeyInfo);\n+      if (!toKeyName.equals(fromKeyName)) {\n+        omMetadataManager.getKeyTable().deleteWithBatch(batchOperation,\n+            omMetadataManager.getOzoneKey(volumeName, bucketName, fromKeyName));\n+        omMetadataManager.getKeyTable().putWithBatch(batchOperation,\n+            omMetadataManager.getOzoneKey(volumeName, bucketName, toKeyName),\n+            newKeyInfo);\n+        // At this point we can also update the KeyIdTable.\n+        if (newKeyInfo.getFileHandleInfo() != 0) {", "originalCommit": "e539d0bd4c182a7b60a18d08f672cf9b5c9ee65f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NjAzNg==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r434276036", "bodyText": "This means we never created the file handle for this key. The check is there to take care of this case. Eventually we should have file handle for all keys.", "author": "prashantpogde", "createdAt": "2020-06-03T02:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyNjE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2MDQwNw==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435460407", "bodyText": "Got it, thanks!", "author": "avijayanhwx", "createdAt": "2020-06-04T18:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyNjE2OA=="}], "type": "inlineReview"}, {"oid": "17f347b7426f8e42339ca3c68a77a9f8abc0e9fb", "url": "https://github.com/apache/ozone/commit/17f347b7426f8e42339ca3c68a77a9f8abc0e9fb", "message": "HDDS-3639. Addressing review comments.", "committedDate": "2020-06-03T18:47:07Z", "type": "commit"}, {"oid": "b44cbbb6ad66f27df4dee35f078868c75da69bdb", "url": "https://github.com/apache/ozone/commit/b44cbbb6ad66f27df4dee35f078868c75da69bdb", "message": "HDDS-3639. Checkstyle fix.", "committedDate": "2020-06-03T18:50:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NTMzMw==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435465333", "bodyText": "The Javadoc needs to be updated here. We are not passing the volume and bucket", "author": "hanishakoneru", "createdAt": "2020-06-04T18:30:20Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OMMetadataManager.java", "diffHunk": "@@ -103,6 +103,16 @@\n \n   String getOzoneKey(String volume, String bucket, String key);\n \n+  /**\n+   * Given a volume, bucket, return the corresponding DB key.\n+   *\n+   * @param fileHandleInfo - unique keyId that is used by NFS to create a", "originalCommit": "e539d0bd4c182a7b60a18d08f672cf9b5c9ee65f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NDgzOA==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r436884838", "bodyText": "@hanishakoneru thank you for reviewing the changes.\nYes, updated this.", "author": "prashantpogde", "createdAt": "2020-06-08T17:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NTMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3OTc0Nw==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435479747", "bodyText": "Just a thought - should this table be named something else like FileHandle Table to avoid confusing this with Key Table? (It's just a thought. Please feel free to ignore if you think \"KeyId\" is the more appropriate name).", "author": "hanishakoneru", "createdAt": "2020-06-04T18:51:05Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OmMetadataManagerImpl.java", "diffHunk": "@@ -118,12 +118,19 @@\n    * |----------------------------------------------------------------------|\n    * |  multipartInfoTable| /volumeName/bucketName/keyName/uploadId ->...   |\n    * |----------------------------------------------------------------------|\n+   * | keyIdTable         | /volumeName/bucketName/keyId -> KeyName         |\n+   * |----------------------------------------------------------------------|\n+   *\n+   * TBD : Renames need to be made keyIdTable aware. Also KeyId based lookups\n+   * should be able to handle any possible race with renames/deletes.\n+   *\n    */\n \n   public static final String USER_TABLE = \"userTable\";\n   public static final String VOLUME_TABLE = \"volumeTable\";\n   public static final String BUCKET_TABLE = \"bucketTable\";\n   public static final String KEY_TABLE = \"keyTable\";\n+  public static final String KEY_ID_TABLE = \"keyIdTable\";", "originalCommit": "e539d0bd4c182a7b60a18d08f672cf9b5c9ee65f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NjA1NA==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r436886054", "bodyText": "If you insist, I will change :)", "author": "prashantpogde", "createdAt": "2020-06-08T17:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3OTc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4Mzg4Ng==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435483886", "bodyText": "OzoneKey is already processed in line 79 (dirKey). That can be reused here.", "author": "hanishakoneru", "createdAt": "2020-06-04T18:58:37Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/file/OMDirectoryCreateResponse.java", "diffHunk": "@@ -81,6 +81,15 @@ protected void addToDBBatch(OMMetadataManager omMetadataManager,\n       omMetadataManager.getKeyTable().putWithBatch(batchOperation, dirKey,\n           dirKeyInfo);\n \n+      // We can also persist the fileHandle to KeyIdTable.\n+      if (dirKeyInfo.getFileHandleInfo() != 0) {\n+        omMetadataManager.getKeyIdTable().putWithBatch(batchOperation,\n+            omMetadataManager.getOzoneKeyIdTableKey(\n+                dirKeyInfo.getFileHandleInfo()),\n+            omMetadataManager.getOzoneKey(dirKeyInfo.getVolumeName(),\n+                dirKeyInfo.getBucketName(),\n+                dirKeyInfo.getKeyName()));", "originalCommit": "e539d0bd4c182a7b60a18d08f672cf9b5c9ee65f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NjIyOA==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r436886228", "bodyText": "yup, done.", "author": "prashantpogde", "createdAt": "2020-06-08T17:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4Mzg4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MDE2NQ==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435490165", "bodyText": "This keyId be added when the key is actually getting committed i.e. in OMKeyCommitResponse#validateAndUpdateCache()? Otherwise, KeyID could point to a key that does not exist.", "author": "hanishakoneru", "createdAt": "2020-06-04T19:10:31Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "diffHunk": "@@ -87,6 +87,15 @@ protected void addToDBBatch(OMMetadataManager omMetadataManager,\n         omKeyInfo.getBucketName(), omKeyInfo.getKeyName(), openKeySessionID);\n     omMetadataManager.getOpenKeyTable().putWithBatch(batchOperation,\n         openKey, omKeyInfo);\n+\n+    // We can also persist the fileHandle to KeyIdTable.\n+    if (omKeyInfo.getFileHandleInfo() != 0) {\n+      omMetadataManager.getKeyIdTable().putWithBatch(batchOperation,\n+          omMetadataManager.getOzoneKeyIdTableKey(\n+              omKeyInfo.getFileHandleInfo()),\n+          omMetadataManager.getOzoneKey(omKeyInfo.getVolumeName(),\n+              omKeyInfo.getBucketName(), omKeyInfo.getKeyName()));\n+    }", "originalCommit": "e539d0bd4c182a7b60a18d08f672cf9b5c9ee65f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NjcyMQ==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r436886721", "bodyText": "yes, moved to OmKeyCommitResponse.", "author": "prashantpogde", "createdAt": "2020-06-08T17:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MDE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5ODIxNA==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435498214", "bodyText": "We are putting and deleting the same key from KeyID Table.\nThe delete operation is not required here as keyId -> fromKey will be overridden with keyId -> toKey.", "author": "hanishakoneru", "createdAt": "2020-06-04T19:26:16Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyRenameResponse.java", "diffHunk": "@@ -93,6 +93,15 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n       omMetadataManager.getKeyTable().putWithBatch(batchOperation,\n           omMetadataManager.getOzoneKey(volumeName, bucketName, toKeyName),\n           newKeyInfo);\n+      // At this point we can also update the KeyIdTable.\n+      if (newKeyInfo.getFileHandleInfo() != 0) {\n+        omMetadataManager.getKeyIdTable().putWithBatch(batchOperation,\n+            omMetadataManager.getOzoneKeyIdTableKey(\n+                newKeyInfo.getFileHandleInfo()), toKeyName);\n+        omMetadataManager.getKeyIdTable().deleteWithBatch(batchOperation,\n+            omMetadataManager.getOzoneKeyIdTableKey(\n+                newKeyInfo.getFileHandleInfo()));", "originalCommit": "b44cbbb6ad66f27df4dee35f078868c75da69bdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4ODMwOQ==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r436888309", "bodyText": "yup, I have changed this.", "author": "prashantpogde", "createdAt": "2020-06-08T17:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5ODIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5OTkwNg==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435499906", "bodyText": "In the if case (deleteFromKeyOnly()) - toKey already exists but fromKey is created as part of replay. When the fromKey is being created, it would update KeyID to fromKey value. So KeyId Table should be updated with correct value (toKey) for this condition also.\n@bharatviswa504  is working on replay optimization after which we would not require to take care of replay scenarios. But let's fix it for now anyway till the old replay code is still in effect.", "author": "hanishakoneru", "createdAt": "2020-06-04T19:29:41Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyRenameResponse.java", "diffHunk": "@@ -93,6 +93,15 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n       omMetadataManager.getKeyTable().putWithBatch(batchOperation,", "originalCommit": "b44cbbb6ad66f27df4dee35f078868c75da69bdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5NDgyMQ==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r436894821", "bodyText": "Not sure, if we need to do this.\n\nIn case of replay its only deleting fromKey, in this case we do not have the toKeyName available, its NULL,\nIn the first tie, it seems the sequence would be :\n\nupdate mapping id <-> toKeyname\nadd toKey\ndelete FromKey\n\n\n\nSo in case of replay if the newkey is already there then we should also have the id-<->keyname mapping updated.\nI also noticed that the sequence of delete and newkey addition was reversed before this change. Not sure how this worked.", "author": "prashantpogde", "createdAt": "2020-06-08T18:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5OTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyNjA4Ng==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r437726086", "bodyText": "Let me elaborate on the scenario I am talking about:\nTrxn n1 : Create Key - key1\nTrxn n2 : Commit Key - key1 (adds n1 -> key1 entry to KeyID table)\nTrxn n3 : Rename key1 -> key2 (update n1 -> key2 in KeyID table)\nNow lets say we replay transactions from n1.\nReplay Trxn n1 : Create Key - key1 (key1 does not exist so this transaction is replayed)\nReplay Trxn n2 : Commit Key - key1 (this again updates n1 -> key1 in KeyID table)\nReplay Trxn n3 : Since key2 exists, we figure out this is replay and execute\ndeleteFromKeyOnly() logic in addToBatch.\nSo finally after replay, we have n1 in KeyID table pointing to key1 instead of key2.\n\nI also noticed that the sequence of delete and newkey addition was reversed before this change. Not sure how this worked.\n\nThe order does not matter here as they are part of batch operation.", "author": "hanishakoneru", "createdAt": "2020-06-09T21:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5OTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzgyMDE1Mw==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r437820153", "bodyText": "Thanks @prashantpogde for the offline discussion.\nIt will be lot of extra work updating the keyID in deleteFromKeyOnly case also as we don't send the toKey name in this case. It is safe to go ahead with this approach as Bharat's replay optimization - HDDS-3354 will take care of this.", "author": "hanishakoneru", "createdAt": "2020-06-10T02:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5OTkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwMzk3Mg==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435503972", "bodyText": "FileHandleInfo in OmMultipartKeyInfo object is not used anywhere.", "author": "hanishakoneru", "createdAt": "2020-06-04T19:37:59Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3InitiateMultipartUploadRequest.java", "diffHunk": "@@ -156,6 +156,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           .setReplicationFactor(keyArgs.getFactor())\n           .setObjectID(objectID)\n           .setUpdateID(transactionLogIndex)\n+          .setFileHandleInfo(objectID)", "originalCommit": "b44cbbb6ad66f27df4dee35f078868c75da69bdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5Njk4OQ==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r436896989", "bodyText": "Let us keep this for now. If it becomes redundant, I will remove this with subsequent PRs.", "author": "prashantpogde", "createdAt": "2020-06-08T18:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwMzk3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwOTY5Mg==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r435509692", "bodyText": "This keyId be added when the key is actually getting committed i.e. in S3MultipartUploadComplete#validateAndUpdateCache()? Otherwise, KeyID could point to a key that does not exist.", "author": "hanishakoneru", "createdAt": "2020-06-04T19:48:39Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/s3/multipart/S3InitiateMultipartUploadResponse.java", "diffHunk": "@@ -69,6 +69,16 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n         multipartKey, omKeyInfo);\n     omMetadataManager.getMultipartInfoTable().putWithBatch(batchOperation,\n         multipartKey, omMultipartKeyInfo);\n+\n+\n+    if (omKeyInfo.getFileHandleInfo() != 0) {\n+      omMetadataManager.getKeyIdTable().putWithBatch(batchOperation,\n+          omMetadataManager.getOzoneKeyIdTableKey(\n+              omKeyInfo.getFileHandleInfo()),\n+          omMetadataManager.getOzoneKey(omKeyInfo.getVolumeName(),\n+              omKeyInfo.getBucketName(),\n+              omKeyInfo.getKeyName()));\n+    }", "originalCommit": "b44cbbb6ad66f27df4dee35f078868c75da69bdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5NzE4NQ==", "url": "https://github.com/apache/ozone/pull/1004#discussion_r436897185", "bodyText": "Yup, Updated the changes.", "author": "prashantpogde", "createdAt": "2020-06-08T18:07:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwOTY5Mg=="}], "type": "inlineReview"}, {"oid": "2d9c77b99a143f23b8a608e20a25cc21ab264d37", "url": "https://github.com/apache/ozone/commit/2d9c77b99a143f23b8a608e20a25cc21ab264d37", "message": "HDDS-3639. Addressing review comments.", "committedDate": "2020-06-08T18:15:22Z", "type": "commit"}]}