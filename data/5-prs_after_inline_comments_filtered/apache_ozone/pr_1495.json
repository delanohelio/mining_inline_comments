{"pr_number": 1495, "pr_title": "HDDS-4343: ReplicationManager.handleOverReplicatedContainer() does not handle unhealthyReplicas properly.", "pr_createdAt": "2020-10-14T08:51:42Z", "pr_url": "https://github.com/apache/ozone/pull/1495", "timeline": [{"oid": "e73042e24e1e3e4c4c42b8d2c26235d121be26e4", "url": "https://github.com/apache/ozone/commit/e73042e24e1e3e4c4c42b8d2c26235d121be26e4", "message": "HDDS-4343: ReplicationManager.handleOverReplicatedContainer() does not handle unhealthyReplicas properly.", "committedDate": "2020-10-14T08:49:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzOTc5Mw==", "url": "https://github.com/apache/ozone/pull/1495#discussion_r504539793", "bodyText": "Looking into this PR change, I am thinking if we still need to do excess check before sending delete command for unhealthy containers. As we want to remove all unhealthy container replicas, we can just send delete command and decrease the excess count by the way.\nI prefer simplified the logic like below:\n      for (ContainerReplica r : unhealthyReplicas) {\n          sendDeleteCommand(container, r.getDatanodeDetails(), true);\n          excess -= 1;\n      }\nThe unhealthyReplicas will also removed in ReplicationManager#handleUnstableContainer if we don't remove all them here.", "author": "linyiqun", "createdAt": "2020-10-14T09:36:48Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -746,8 +746,9 @@ private void handleOverReplicatedContainer(final ContainerInfo container,\n         if (excess > 0) {\n           sendDeleteCommand(container, r.getDatanodeDetails(), true);\n           excess -= 1;\n+        } else {\n+          break;\n         }\n-        break;", "originalCommit": "e73042e24e1e3e4c4c42b8d2c26235d121be26e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2OTM0OA==", "url": "https://github.com/apache/ozone/pull/1495#discussion_r504569348", "bodyText": "@linyiqun What if there is an excess of containers, but all containers are somehow unhealthy? We don't want RM to remove all copies of them, as that could result in a lost container. That is why we limit the number of unhealthy containers removed to the excess number.", "author": "sodonnel", "createdAt": "2020-10-14T10:26:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzOTc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU4NDcyNg==", "url": "https://github.com/apache/ozone/pull/1495#discussion_r504584726", "bodyText": "Okay, get it. Thanks @sodonnel.", "author": "linyiqun", "createdAt": "2020-10-14T10:55:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzOTc5Mw=="}], "type": "inlineReview"}]}