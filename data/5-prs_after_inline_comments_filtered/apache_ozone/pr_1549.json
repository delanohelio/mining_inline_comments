{"pr_number": 1549, "pr_title": "HDDS-4427. Avoid ContainerCache in ContainerReader at Datanode startup", "pr_createdAt": "2020-11-03T13:00:40Z", "pr_url": "https://github.com/apache/ozone/pull/1549", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzODMzOQ==", "url": "https://github.com/apache/ozone/pull/1549#discussion_r519838339", "bodyText": "What is the reason for removing this assertion, and opening a new ReferenceCountedDB after running the block deleting service?", "author": "errose28", "createdAt": "2020-11-09T14:06:11Z", "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/TestSchemaOneBackwardsCompatibility.java", "diffHunk": "@@ -269,29 +272,29 @@ public void testDelete() throws Exception {\n    */\n   @Test\n   public void testReadDeletedBlockChunkInfo() throws Exception {\n-    try(ReferenceCountedDB refCountedDB = BlockUtils.getDB(newKvData(), conf)) {\n+    KeyValueContainerData kvData = newKvData();\n+    List<? extends Table.KeyValue<String, ChunkInfoList>> deletedBlocks;\n+    Set<String> preUpgradeBlocks = new HashSet<>();\n+    try(ReferenceCountedDB refCountedDB = BlockUtils.getDB(kvData, conf)) {\n       // Read blocks that were already deleted before the upgrade.\n-      List<? extends Table.KeyValue<String, ChunkInfoList>> deletedBlocks =\n-              refCountedDB.getStore()\n-                      .getDeletedBlocksTable().getRangeKVs(null, 100);\n-\n-      Set<String> preUpgradeBlocks = new HashSet<>();\n+      deletedBlocks = refCountedDB.getStore()\n+          .getDeletedBlocksTable().getRangeKVs(null, 100);\n \n-      for(Table.KeyValue<String, ChunkInfoList> chunkListKV: deletedBlocks) {\n+      for (Table.KeyValue<String, ChunkInfoList> chunkListKV : deletedBlocks) {\n         preUpgradeBlocks.add(chunkListKV.getKey());\n         try {\n           chunkListKV.getValue();\n           Assert.fail(\"No exception thrown when trying to retrieve old \" +\n-                  \"deleted blocks values as chunk lists.\");\n-        } catch(IOException ex) {\n+              \"deleted blocks values as chunk lists.\");\n+        } catch (IOException ex) {\n           // Exception thrown as expected.\n         }\n       }\n+    }\n \n-      Assert.assertEquals(TestDB.NUM_DELETED_BLOCKS, preUpgradeBlocks.size());", "originalCommit": "cc31909ba3e18a49c62cc0f6982e4f18e5a09bc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkyNjg4NA==", "url": "https://github.com/apache/ozone/pull/1549#discussion_r519926884", "bodyText": "That seems like a mistake, as I don't remember intentionally changing it. I did have some problems getting these tests to pass.\nHowever now I have refactored the container opening part to handle the case where there is already a DB in the cache, I think the changes to this class are not needed. I have reverted them all and the tests pass locally, so lets see how the latest CI run goes.", "author": "sodonnel", "createdAt": "2020-11-09T16:04:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzODMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzODUwOQ==", "url": "https://github.com/apache/ozone/pull/1549#discussion_r519838509", "bodyText": "I think this is a typo.", "author": "errose28", "createdAt": "2020-11-09T14:06:27Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/metadata/DatanodeStore.java", "diffHunk": "@@ -47,7 +47,7 @@\n    */\n   void stop() throws Exception;\n \n-  /**\n+  /**TestSchemaOneBackwardsCompatibility.java", "originalCommit": "cc31909ba3e18a49c62cc0f6982e4f18e5a09bc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkyNTk2Nw==", "url": "https://github.com/apache/ozone/pull/1549#discussion_r519925967", "bodyText": "You are correct. Thanks for spotting it!", "author": "sodonnel", "createdAt": "2020-11-09T16:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzODUwOQ=="}], "type": "inlineReview"}, {"oid": "7918215b2daf823981a8db6ce1e45aa2ef2da5d0", "url": "https://github.com/apache/ozone/commit/7918215b2daf823981a8db6ce1e45aa2ef2da5d0", "message": "Avoid ContainerCache when starting the DN", "committedDate": "2020-11-12T12:14:19Z", "type": "commit"}, {"oid": "725fafd1a4c29eeb1889bd665ce1adbf908a61f5", "url": "https://github.com/apache/ozone/commit/725fafd1a4c29eeb1889bd665ce1adbf908a61f5", "message": "Fix failing tests", "committedDate": "2020-11-12T12:14:19Z", "type": "commit"}, {"oid": "45cfc53adf92e2385e250f8aa60959061469e0d5", "url": "https://github.com/apache/ozone/commit/45cfc53adf92e2385e250f8aa60959061469e0d5", "message": "Fix findbugs warning", "committedDate": "2020-11-12T12:14:19Z", "type": "commit"}, {"oid": "0e23ee2c63f57dceed8e2b58b32dea3f6ba72d99", "url": "https://github.com/apache/ozone/commit/0e23ee2c63f57dceed8e2b58b32dea3f6ba72d99", "message": "Refactor to obtain the RocksDB instance from the ContainerCache if the uncached instance fails to open", "committedDate": "2020-11-12T12:14:19Z", "type": "commit"}, {"oid": "73f8f6356cda50b123bbd9d040bc1f18a1b5ccd6", "url": "https://github.com/apache/ozone/commit/73f8f6356cda50b123bbd9d040bc1f18a1b5ccd6", "message": "Revert changes to TestSchemaOneBackwardsCompatibility.java", "committedDate": "2020-11-12T12:14:19Z", "type": "commit"}, {"oid": "c53b02867bfd403b57ce48bcf1278ded526ce298", "url": "https://github.com/apache/ozone/commit/c53b02867bfd403b57ce48bcf1278ded526ce298", "message": "Fixed typo", "committedDate": "2020-11-12T12:14:19Z", "type": "commit"}, {"oid": "c53b02867bfd403b57ce48bcf1278ded526ce298", "url": "https://github.com/apache/ozone/commit/c53b02867bfd403b57ce48bcf1278ded526ce298", "message": "Fixed typo", "committedDate": "2020-11-12T12:14:19Z", "type": "forcePushed"}]}