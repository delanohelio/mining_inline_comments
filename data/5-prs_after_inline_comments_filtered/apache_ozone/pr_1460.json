{"pr_number": 1460, "pr_title": "HDDS-4298. Use an interface in Ozone client instead of XceiverClientManager", "pr_createdAt": "2020-09-30T12:04:53Z", "pr_url": "https://github.com/apache/ozone/pull/1460", "timeline": [{"oid": "f36a8ce13f9b10e7a654202613ee5d88a5694bba", "url": "https://github.com/apache/ozone/commit/f36a8ce13f9b10e7a654202613ee5d88a5694bba", "message": "HDDS-4298. Use an interface in Ozone client instead of XceiverClientManager", "committedDate": "2020-09-30T12:01:48Z", "type": "commit"}, {"oid": "f59ceb3f4b4322bea49cc47a0ecdb386bffd4a9b", "url": "https://github.com/apache/ozone/commit/f59ceb3f4b4322bea49cc47a0ecdb386bffd4a9b", "message": "merge latest master", "committedDate": "2020-10-01T11:28:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4MjI2Mg==", "url": "https://github.com/apache/ozone/pull/1460#discussion_r498682262", "bodyText": "Why cast instead of changing the variable to XceiverClientFactory?", "author": "adoroszlai", "createdAt": "2020-10-02T08:24:20Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestReadRetries.java", "diffHunk": "@@ -147,7 +145,8 @@ public void testPutKeyAndGetKeyThreeNodes()\n             ReplicationFactor.THREE, new HashMap<>());\n     KeyOutputStream groupOutputStream =\n         (KeyOutputStream) out.getOutputStream();\n-    XceiverClientManager manager = groupOutputStream.getXceiverClientManager();\n+    XceiverClientManager manager =\n+        (XceiverClientManager) groupOutputStream.getXceiverClientFactory();", "originalCommit": "f59ceb3f4b4322bea49cc47a0ecdb386bffd4a9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ1MzQ1Ng==", "url": "https://github.com/apache/ozone/pull/1460#discussion_r499453456", "bodyText": "Both can work, but I feel it more safe as it doesn't require changing method signatures in KeyOutputStream. Even if getXceiverClientFactory is marked as @VisibleForTesting I feel it safer to return only the interface. Unit test can have cast, it's expected to have access to the internal representations.", "author": "elek", "createdAt": "2020-10-05T09:14:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4MjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNjMzMA==", "url": "https://github.com/apache/ozone/pull/1460#discussion_r499526330", "bodyText": "I meant: is there anything against changing to\n    XceiverClientFactory manager =\n        groupOutputStream.getXceiverClientFactory();\nNo need to change signature in KeyOutputStream.\nSorry if it was unclear.", "author": "adoroszlai", "createdAt": "2020-10-05T11:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4MjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU0NDAxOQ==", "url": "https://github.com/apache/ozone/pull/1460#discussion_r499544019", "bodyText": "Aghh, got it. Obviously: you are right, I just didn't notice the usage of the manager. Pushed the improved version.", "author": "elek", "createdAt": "2020-10-05T11:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4MjI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4NDYzMQ==", "url": "https://github.com/apache/ozone/pull/1460#discussion_r498684631", "bodyText": "I don't think this method should be part of the interface.  The implementation is a convenience method to avoid passing configuration down the RpcClient -> KeyOutputStream.Builder -> KeyOutputStream -> BlockOutputStreamEntryPool chain.\nhttps://github.com/apache/hadoop-ozone/blob/7216e3cb651dffc8c7a86d18729fd5f5cffa24b4/hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientManager.java#L281-L283\nI'd rather get rid of this smell as part of this refactoring.", "author": "adoroszlai", "createdAt": "2020-10-02T08:29:09Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientFactory.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.function.Function;\n+\n+import org.apache.hadoop.hdds.scm.pipeline.Pipeline;\n+\n+import org.apache.ratis.thirdparty.com.google.protobuf.ByteString;\n+\n+/**\n+ * Interface to provide XceiverClient when needed.\n+ */\n+public interface XceiverClientFactory {\n+\n+  Function<ByteBuffer, ByteString> byteBufferToByteStringConversion();", "originalCommit": "f59ceb3f4b4322bea49cc47a0ecdb386bffd4a9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQyNzA4OA==", "url": "https://github.com/apache/ozone/pull/1460#discussion_r499427088", "bodyText": "I agree with @adoroszlai here. Let's remove this.", "author": "bshashikant", "createdAt": "2020-10-05T08:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4NDYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ1NDA5NQ==", "url": "https://github.com/apache/ozone/pull/1460#discussion_r499454095", "bodyText": "Totally agree, I also felt like this, but I was lazy to hunt it down. Let me try to remove it.", "author": "elek", "createdAt": "2020-10-05T09:15:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4NDYzMQ=="}], "type": "inlineReview"}, {"oid": "08dda9ade16b0befb2e643d64906337cd2fa7e34", "url": "https://github.com/apache/ozone/commit/08dda9ade16b0befb2e643d64906337cd2fa7e34", "message": "move out unsafeByteBufferConversion from the new interface", "committedDate": "2020-10-05T10:30:11Z", "type": "commit"}, {"oid": "3ef56cfad1e28a51380b0f6fee771f94d578f02c", "url": "https://github.com/apache/ozone/commit/3ef56cfad1e28a51380b0f6fee771f94d578f02c", "message": "remove cast form unit test", "committedDate": "2020-10-05T11:53:31Z", "type": "commit"}]}