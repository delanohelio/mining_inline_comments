{"pr_number": 1392, "pr_title": "HDDS-4173.  Implement HDDS Version management using the LayoutVersion\u2026", "pr_createdAt": "2020-09-04T03:06:31Z", "pr_url": "https://github.com/apache/ozone/pull/1392", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTIyOQ==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r483365229", "bodyText": "Can be removed.", "author": "avijayanhwx", "createdAt": "2020-09-04T03:30:37Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/upgrade/SCMLayoutFeatureAPI.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.upgrade;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+import org.apache.hadoop.hdds.scm.upgrade.SCMLayoutFeatureCatalog.SCMLayoutFeature;\n+\n+/**\n+ * Annotation to specify if an API is backed up by a Layout Feature.\n+ */\n+@Target(ElementType.METHOD)\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface SCMLayoutFeatureAPI {", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTI1OA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r483365258", "bodyText": "Can be removed.", "author": "avijayanhwx", "createdAt": "2020-09-04T03:30:45Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/upgrade/SCMLayoutFeatureAspect.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.upgrade;\n+\n+import static org.apache.hadoop.hdds.scm.exceptions.SCMException.ResultCodes.NOT_SUPPORTED_OPERATION;\n+\n+import org.apache.hadoop.hdds.scm.exceptions.SCMException;\n+import org.apache.hadoop.ozone.upgrade.LayoutFeature;\n+import org.apache.hadoop.ozone.upgrade.LayoutVersionManager;\n+import org.aspectj.lang.JoinPoint;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Before;\n+import org.aspectj.lang.reflect.MethodSignature;\n+\n+/**\n+ * 'Aspect' for SCM Layout Feature API. All methods annotated with the\n+ * specific annotation will have pre-processing done here to check layout\n+ * version compatibility.\n+ */\n+@Aspect\n+public class SCMLayoutFeatureAspect {", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwNjgwOQ==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484706809", "bodyText": "done", "author": "prashantpogde", "createdAt": "2020-09-08T07:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTQ5MQ==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r483365491", "bodyText": "Should be \"HDDSLayoutFeature\" since it is common across SCM and DN.", "author": "avijayanhwx", "createdAt": "2020-09-04T03:31:32Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/upgrade/SCMLayoutFeatureCatalog.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.upgrade;\n+\n+import java.util.Optional;\n+\n+import org.apache.hadoop.ozone.upgrade.LayoutFeature;\n+\n+/**\n+ * Catalog of SCM features.\n+ */\n+public class SCMLayoutFeatureCatalog {\n+\n+  /**\n+   * List of SCM Features.\n+   */\n+  public enum SCMLayoutFeature implements LayoutFeature {", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwNjg2MQ==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484706861", "bodyText": "done", "author": "prashantpogde", "createdAt": "2020-09-08T07:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTcyNQ==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r483365725", "bodyText": "We already have \"test\" features in OM Catalog to support testing. HDDS can be left with just 'INITIAL_VERSION'.", "author": "avijayanhwx", "createdAt": "2020-09-04T03:32:35Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/upgrade/SCMLayoutFeatureCatalog.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.upgrade;\n+\n+import java.util.Optional;\n+\n+import org.apache.hadoop.ozone.upgrade.LayoutFeature;\n+\n+/**\n+ * Catalog of SCM features.\n+ */\n+public class SCMLayoutFeatureCatalog {\n+\n+  /**\n+   * List of SCM Features.\n+   */\n+  public enum SCMLayoutFeature implements LayoutFeature {\n+    INITIAL_VERSION(0, \"Initial Layout Version\"),\n+    CREATE_EC(1, \"\"),", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTc4Ng==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r483365786", "bodyText": "Can be removed.", "author": "avijayanhwx", "createdAt": "2020-09-04T03:32:52Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/upgrade/SCMLayoutFeatureCatalog.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.upgrade;\n+\n+import java.util.Optional;\n+\n+import org.apache.hadoop.ozone.upgrade.LayoutFeature;\n+\n+/**\n+ * Catalog of SCM features.\n+ */\n+public class SCMLayoutFeatureCatalog {\n+\n+  /**\n+   * List of SCM Features.\n+   */\n+  public enum SCMLayoutFeature implements LayoutFeature {\n+    INITIAL_VERSION(0, \"Initial Layout Version\"),\n+    CREATE_EC(1, \"\"),\n+    NEW_FEATURE(2, \"new feature\", new NewSCMFeatureUpgradeAction());\n+\n+\n+    private int layoutVersion;\n+    private String description;\n+    private Optional<SCMUpgradeAction> scmUpgradeAction = Optional.empty();\n+\n+    SCMLayoutFeature(final int layoutVersion, String description) {\n+      this.layoutVersion = layoutVersion;\n+      this.description = description;\n+    }\n+\n+    SCMLayoutFeature(final int layoutVersion, String description,\n+                    SCMUpgradeAction upgradeAction) {\n+      this.layoutVersion = layoutVersion;\n+      this.description = description;\n+      scmUpgradeAction = Optional.of(upgradeAction);\n+    }\n+\n+    @Override\n+    public int layoutVersion() {\n+      return layoutVersion;\n+    }\n+\n+    @Override\n+    public String description() {\n+      return description;\n+    }\n+\n+    @Override\n+    public Optional<SCMUpgradeAction> onFinalizeAction() {\n+      return scmUpgradeAction;\n+    }\n+  }\n+\n+  /**\n+   * This is an example of an \"API\" that uses a new Layout feature (EC) that is\n+   * not yet supported by the current layout version. The following can be\n+   * \"guarded\" by just adding the following annotation, thereby keeping the\n+   * method logic and upgrade logic separate.\n+   */\n+  @SCMLayoutFeatureAPI(SCMLayoutFeature.CREATE_EC)", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwNjk0Ng==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484706946", "bodyText": "done", "author": "prashantpogde", "createdAt": "2020-09-08T07:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NTc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NzE5MA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r483367190", "bodyText": "Can we rename to HDDSLayoutVersionManager to reuse between SCM and DN?", "author": "avijayanhwx", "createdAt": "2020-09-04T03:39:33Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/upgrade/SCMLayoutVersionManager.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.upgrade;\n+\n+import static org.apache.hadoop.hdds.scm.exceptions.SCMException.ResultCodes.NOT_SUPPORTED_OPERATION;\n+import org.apache.hadoop.ozone.common.Storage;\n+import org.apache.hadoop.hdds.scm.server.SCMStorageConfig;\n+import org.apache.hadoop.hdds.scm.exceptions.SCMException;\n+import org.apache.hadoop.hdds.scm.upgrade.SCMLayoutFeatureCatalog.SCMLayoutFeature;\n+import org.apache.hadoop.ozone.upgrade.AbstractLayoutVersionManager;\n+import org.apache.hadoop.ozone.upgrade.LayoutVersionManager;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * Class to manage layout versions and features for Storage Container Manager.\n+ */\n+public final class SCMLayoutVersionManager extends AbstractLayoutVersionManager {", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NzcxNg==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r483367716", "bodyText": "We may need an 'HDDSUpgradeAction' from which SCMUpgradeAction is extended. Then, in this class we can have something like  Optional<? extends HDDSUpgradeAction>.", "author": "avijayanhwx", "createdAt": "2020-09-04T03:41:56Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/upgrade/SCMLayoutFeatureCatalog.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.upgrade;\n+\n+import java.util.Optional;\n+\n+import org.apache.hadoop.ozone.upgrade.LayoutFeature;\n+\n+/**\n+ * Catalog of SCM features.\n+ */\n+public class SCMLayoutFeatureCatalog {\n+\n+  /**\n+   * List of SCM Features.\n+   */\n+  public enum SCMLayoutFeature implements LayoutFeature {\n+    INITIAL_VERSION(0, \"Initial Layout Version\"),\n+    CREATE_EC(1, \"\"),\n+    NEW_FEATURE(2, \"new feature\", new NewSCMFeatureUpgradeAction());\n+\n+\n+    private int layoutVersion;\n+    private String description;\n+    private Optional<SCMUpgradeAction> scmUpgradeAction = Optional.empty();", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwNzAwOA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484707008", "bodyText": "done", "author": "prashantpogde", "createdAt": "2020-09-08T07:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2NzcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAxOTY1Ng==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484019656", "bodyText": "This new introduced method is not used here, what's this method intended used for?", "author": "linyiqun", "createdAt": "2020-09-06T04:27:22Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/storage/ContainerProtocolCalls.java", "diffHunk": "@@ -578,4 +581,35 @@ private static Text getService(DatanodeBlockID blockId) {\n     validators.add(validator);\n     return validators;\n   }\n+\n+  public static HashMap<DatanodeDetails, GetBlockResponseProto>\n+      getBlockFromAllNodes(", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwODI1OA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484708258", "bodyText": "not sure, why these changes are showed up in this PR. These changes were not made as part of this PR.\nI have re-uploaded the changes and it should go away.", "author": "prashantpogde", "createdAt": "2020-09-08T07:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAxOTY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyMDAyMA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484020020", "bodyText": "I see lots of code update focus on ScmSubcommand refactoring, is this related with this JIRA? I don't see there we do some common rolling upgrade logic but seems just a code refactoring.", "author": "linyiqun", "createdAt": "2020-09-06T04:33:36Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/ScmSubcommand.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm.cli;\n+\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+import java.io.IOException;\n+import java.util.concurrent.Callable;\n+\n+/**\n+ * Base class for admin commands that connect via SCM client.\n+ */\n+public abstract class ScmSubcommand implements Callable<Void> {\n+\n+  @CommandLine.Mixin\n+  private ScmOption scmOption;\n+\n+  protected abstract void execute(ScmClient client) throws IOException;", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwODUyOA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484708528", "bodyText": "NA. Please see the comment above.", "author": "prashantpogde", "createdAt": "2020-09-08T07:29:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyMDAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyMDIzNQ==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484020235", "bodyText": "RenameKey on Bucket seems also not related with this JIRA if I understand this PR correctly.", "author": "linyiqun", "createdAt": "2020-09-06T04:36:40Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -2244,6 +2248,14 @@ public OmKeyInfo lookupKey(OmKeyArgs args) throws IOException {\n     }\n   }\n \n+\n+  @Override\n+  public void renameKeys(OmRenameKeys omRenameKeys)", "originalCommit": "432ee6a7447140620a7861341a5b01bc2759e639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwODYzNA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484708634", "bodyText": "NA, like above.", "author": "prashantpogde", "createdAt": "2020-09-08T07:30:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyMDIzNQ=="}], "type": "inlineReview"}, {"oid": "188b94f6734a20ef9459c7b100bab8b9113117b0", "url": "https://github.com/apache/ozone/commit/188b94f6734a20ef9459c7b100bab8b9113117b0", "message": "HDDS-4173. Implement HDDS Version management using the LayoutVersion.", "committedDate": "2020-09-08T07:25:53Z", "type": "commit"}, {"oid": "188b94f6734a20ef9459c7b100bab8b9113117b0", "url": "https://github.com/apache/ozone/commit/188b94f6734a20ef9459c7b100bab8b9113117b0", "message": "HDDS-4173. Implement HDDS Version management using the LayoutVersion.", "committedDate": "2020-09-08T07:25:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg1ODgwNw==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484858807", "bodyText": "New SCMException introduced here that broken the unit test:\n[ERROR] Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 0.077 s <<< FAILURE! - in org.apache.hadoop.hdds.scm.exceptions.TestSCMExceptionResultCodes\n[ERROR] codeMapping(org.apache.hadoop.hdds.scm.exceptions.TestSCMExceptionResultCodes)  Time elapsed: 0.023 s  <<< FAILURE!\njava.lang.AssertionError: expected:<30> but was:<29>\nat org.junit.Assert.fail(Assert.java:88)\nat org.junit.Assert.failNotEquals(Assert.java:743)\nat org.junit.Assert.assertEquals(Assert.java:118)\nat org.junit.Assert.assertEquals(Assert.java:555)\nat org.junit.Assert.assertEquals(Assert.java:542)\nat org.apache.hadoop.hdds.scm.exceptions.TestSCMExceptionResultCodes.codeMapping(TestSCMExceptionResultCodes.java:35)", "author": "linyiqun", "createdAt": "2020-09-08T11:55:40Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/exceptions/SCMException.java", "diffHunk": "@@ -123,6 +123,7 @@ public ResultCodes getResult() {\n     FAILED_TO_INIT_CONTAINER_PLACEMENT_POLICY,\n     FAILED_TO_ALLOCATE_ENOUGH_BLOCKS,\n     INTERNAL_ERROR,\n-    FAILED_TO_INIT_PIPELINE_CHOOSE_POLICY\n+    FAILED_TO_INIT_PIPELINE_CHOOSE_POLICY,\n+    NOT_SUPPORTED_OPERATION,", "originalCommit": "188b94f6734a20ef9459c7b100bab8b9113117b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNTM5Nw==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r485115397", "bodyText": "I don't see usages for 'NOT_SUPPORTED_OPERATION' now. Can it be removed?", "author": "avijayanhwx", "createdAt": "2020-09-08T18:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg1ODgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMjI1Mg==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r485202252", "bodyText": "yup", "author": "prashantpogde", "createdAt": "2020-09-08T21:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg1ODgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg2MDU0MA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r484860540", "bodyText": "Can we add the unit test for HDDSLayoutVersionManager like TestOMVersionManager does?", "author": "linyiqun", "createdAt": "2020-09-08T11:58:56Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/upgrade/HDDSLayoutVersionManager.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.upgrade;\n+\n+\n+import java.io.IOException;\n+\n+import org.apache.hadoop.ozone.common.Storage;\n+import org.apache.hadoop.hdds.upgrade.HDDSLayoutFeatureCatalog.HDDSLayoutFeature;\n+import org.apache.hadoop.ozone.upgrade.AbstractLayoutVersionManager;\n+import org.apache.hadoop.ozone.upgrade.LayoutVersionManager;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * Class to manage layout versions and features for Storage Container Manager\n+ * and DataNodes.\n+ */\n+public final class HDDSLayoutVersionManager extends", "originalCommit": "188b94f6734a20ef9459c7b100bab8b9113117b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMjU2Mg==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r485202562", "bodyText": "yup", "author": "prashantpogde", "createdAt": "2020-09-08T21:20:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg2MDU0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMxMzk2OQ==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r485313969", "bodyText": "I will add the test in another PR.", "author": "prashantpogde", "createdAt": "2020-09-09T03:23:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg2MDU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNDg0NQ==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r485114845", "bodyText": "Unused class?  Can be removed.", "author": "avijayanhwx", "createdAt": "2020-09-08T18:26:47Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/upgrade/NewSCMFeatureUpgradeAction.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.server.upgrade;\n+\n+import org.apache.hadoop.hdds.scm.server.StorageContainerManager;\n+import org.apache.hadoop.hdds.upgrade.HDDSUpgradeAction;\n+\n+/**\n+ * Example SCM Action class to help with understanding.\n+ */\n+public class NewSCMFeatureUpgradeAction implements", "originalCommit": "188b94f6734a20ef9459c7b100bab8b9113117b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMzI3Ng==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r485203276", "bodyText": "Yes, left it as an example.  Can we remove it after we are done with other upgrade changes too ?", "author": "prashantpogde", "createdAt": "2020-09-08T21:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNDg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc2NTUzNA==", "url": "https://github.com/apache/ozone/pull/1392#discussion_r485765534", "bodyText": "Yes, sure.", "author": "avijayanhwx", "createdAt": "2020-09-09T16:45:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNDg0NQ=="}], "type": "inlineReview"}, {"oid": "c24c31dad89fb3987977497d3befb4cf376aeb8c", "url": "https://github.com/apache/ozone/commit/c24c31dad89fb3987977497d3befb4cf376aeb8c", "message": "HDDS-4173. Addressing review comments.", "committedDate": "2020-09-09T03:25:04Z", "type": "commit"}]}