{"pr_number": 625, "pr_title": "HDDS-2980. Delete replayed entry from OpenKeyTable during commit", "pr_createdAt": "2020-03-02T18:17:12Z", "pr_url": "https://github.com/apache/ozone/pull/625", "timeline": [{"oid": "7298d3455d0097cdb5908aaab13971f0d5080ff4", "url": "https://github.com/apache/ozone/commit/7298d3455d0097cdb5908aaab13971f0d5080ff4", "message": "Unit test", "committedDate": "2020-03-12T23:51:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4OTYwNA==", "url": "https://github.com/apache/ozone/pull/625#discussion_r396189604", "bodyText": "We can still pass here  clientID and generate openKey. Like how we used to generate open key before.", "author": "bharatviswa504", "createdAt": "2020-03-23T02:48:36Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -183,21 +196,26 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOzoneKey),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n-      omResponse.setCommitKeyResponse(CommitKeyResponse.newBuilder().build());\n       omClientResponse = new OMKeyCommitResponse(omResponse.build(),\n-          omKeyInfo, commitKeyRequest.getClientID());\n+          omKeyInfo, dbOpenKey);", "originalCommit": "fb7b28918c441e478629a147477b5086b2337e0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2Njc1NQ==", "url": "https://github.com/apache/ozone/pull/625#discussion_r396566755", "bodyText": "We are anyway computing the openKey using the clientID here. So instead of passing the clientID and computing that again in OMKeyCommitResponse, we can directly pass the openKey.", "author": "hanishakoneru", "createdAt": "2020-03-23T16:05:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4OTYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MTk3Nw==", "url": "https://github.com/apache/ozone/pull/625#discussion_r396581977", "bodyText": "I see that we are doing similar thing for ozone key, so that is why my question. Then we can do similar thing for ozone key also then?", "author": "bharatviswa504", "createdAt": "2020-03-23T16:25:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4OTYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5MjczNg==", "url": "https://github.com/apache/ozone/pull/625#discussion_r396592736", "bodyText": "We could. But since we have to pass the omKeyInfo irrespective of whether we pass ozoneKey or not, I didnt change that.\nI am ok to have it either way. Will post an update.", "author": "hanishakoneru", "createdAt": "2020-03-23T16:40:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4OTYwNA=="}], "type": "inlineReview"}, {"oid": "ec0b06c73162f5cdf04397d25f7eb177108c9174", "url": "https://github.com/apache/ozone/commit/ec0b06c73162f5cdf04397d25f7eb177108c9174", "message": "HDDS-2980. Delete replayed entry from OpenKeyTable during commit", "committedDate": "2020-03-23T16:56:45Z", "type": "commit"}, {"oid": "7f718dd39eb89eef25b2ab0ae39e2916c3919548", "url": "https://github.com/apache/ozone/commit/7f718dd39eb89eef25b2ab0ae39e2916c3919548", "message": "Unit test", "committedDate": "2020-03-23T16:56:46Z", "type": "commit"}, {"oid": "8926e150bf969f8390c943e4fe1f256e057be196", "url": "https://github.com/apache/ozone/commit/8926e150bf969f8390c943e4fe1f256e057be196", "message": "unit test fix", "committedDate": "2020-03-23T16:56:46Z", "type": "commit"}, {"oid": "26d8fe9bb45bdd14f0ab7bc69c57b20c3c7851c7", "url": "https://github.com/apache/ozone/commit/26d8fe9bb45bdd14f0ab7bc69c57b20c3c7851c7", "message": "checkstyle fix", "committedDate": "2020-03-23T16:56:46Z", "type": "commit"}, {"oid": "3947e0a1fa3543f10804a27e35699d14b0af05ee", "url": "https://github.com/apache/ozone/commit/3947e0a1fa3543f10804a27e35699d14b0af05ee", "message": "review comment - Pass ozoneKeyName to OMKeyCommitResponse", "committedDate": "2020-03-23T16:56:46Z", "type": "commit"}, {"oid": "3947e0a1fa3543f10804a27e35699d14b0af05ee", "url": "https://github.com/apache/ozone/commit/3947e0a1fa3543f10804a27e35699d14b0af05ee", "message": "review comment - Pass ozoneKeyName to OMKeyCommitResponse", "committedDate": "2020-03-23T16:56:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MjQxNA==", "url": "https://github.com/apache/ozone/pull/625#discussion_r398972414", "bodyText": "Not understood why this check is removed.", "author": "bharatviswa504", "createdAt": "2020-03-27T00:38:24Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadCommitPartRequest.java", "diffHunk": "@@ -147,11 +146,6 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         throw new OMException(\"Failed to commit Multipart Upload key, as \" +\n             openKey + \"entry is not found in the openKey table\",\n             KEY_NOT_FOUND);\n-      } else {\n-        // Check the OpenKeyTable if this transaction is a replay of ratis logs.", "originalCommit": "3947e0a1fa3543f10804a27e35699d14b0af05ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1NDI5NQ==", "url": "https://github.com/apache/ozone/pull/625#discussion_r399554295", "bodyText": "This check was redundant. Irrespective of whether KeyCreate Request was replayed or not, if key+clientID exits in the openKey table, then the CommitPart request should also be executed (same as we do for KeyCommit Request).\nIf the same Key part was created again, the clientID would be different. Hence the openKey would also be different.", "author": "hanishakoneru", "createdAt": "2020-03-27T21:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MjQxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5OTEwMQ==", "url": "https://github.com/apache/ozone/pull/625#discussion_r399699101", "bodyText": "Got it. thanks.", "author": "bharatviswa504", "createdAt": "2020-03-28T19:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MjQxNA=="}], "type": "inlineReview"}]}