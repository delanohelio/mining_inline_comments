{"pr_number": 1542, "pr_title": "HDDS-4417. Simplify Ozone client code with configuration object", "pr_createdAt": "2020-11-02T15:05:44Z", "pr_url": "https://github.com/apache/ozone/pull/1542", "timeline": [{"oid": "55deff376260ca5494add79b75c1d6054b78db6a", "url": "https://github.com/apache/ozone/commit/55deff376260ca5494add79b75c1d6054b78db6a", "message": "ozone client config", "committedDate": "2020-10-29T13:01:21Z", "type": "commit"}, {"oid": "e28e737770ea1baf49ac1f45989be150a77d0bd9", "url": "https://github.com/apache/ozone/commit/e28e737770ea1baf49ac1f45989be150a77d0bd9", "message": "fix config handling", "committedDate": "2020-10-29T13:01:25Z", "type": "commit"}, {"oid": "8f7808f2c4efe0817adaa9eaf88a0f203a92aab3", "url": "https://github.com/apache/ozone/commit/8f7808f2c4efe0817adaa9eaf88a0f203a92aab3", "message": "end", "committedDate": "2020-10-30T16:05:25Z", "type": "commit"}, {"oid": "b4dd5632d8196eaefac66009b9c56a4109eccce3", "url": "https://github.com/apache/ozone/commit/b4dd5632d8196eaefac66009b9c56a4109eccce3", "message": "fix", "committedDate": "2020-10-30T16:16:13Z", "type": "commit"}, {"oid": "911706cfb7504a7fab98d4f5e1a202ae813dca0c", "url": "https://github.com/apache/ozone/commit/911706cfb7504a7fab98d4f5e1a202ae813dca0c", "message": "checkstyle fixes", "committedDate": "2020-10-30T16:38:16Z", "type": "commit"}, {"oid": "d2b553ba79dd894a17ef5e13b529fbbd3f6f5a43", "url": "https://github.com/apache/ozone/commit/d2b553ba79dd894a17ef5e13b529fbbd3f6f5a43", "message": "retrigger ci", "committedDate": "2020-11-02T08:42:13Z", "type": "commit"}, {"oid": "2a755461af92abc89499920b3cd0d89f7e2a6176", "url": "https://github.com/apache/ozone/commit/2a755461af92abc89499920b3cd0d89f7e2a6176", "message": "finish block output stream", "committedDate": "2020-11-02T11:24:03Z", "type": "commit"}, {"oid": "13f33106882691ecee99798b38f41c40b9335022", "url": "https://github.com/apache/ozone/commit/13f33106882691ecee99798b38f41c40b9335022", "message": "fix unit tests", "committedDate": "2020-11-02T13:40:08Z", "type": "commit"}, {"oid": "44a3aa67d87eeada76740a51264f90598a93ec66", "url": "https://github.com/apache/ozone/commit/44a3aa67d87eeada76740a51264f90598a93ec66", "message": "HDDS-4417. Simplify Ozone client code with configuration object", "committedDate": "2020-11-02T15:04:14Z", "type": "commit"}, {"oid": "83a4fe071b1de0c71a259de81b6b62425ba31a4e", "url": "https://github.com/apache/ozone/commit/83a4fe071b1de0c71a259de81b6b62425ba31a4e", "message": "Merge remote-tracking branch 'origin/master' into HDDS-4417", "committedDate": "2020-11-02T15:34:08Z", "type": "commit"}, {"oid": "ea7064c16d5f9e7440728fdee6f49bc5be8f8b81", "url": "https://github.com/apache/ozone/commit/ea7064c16d5f9e7440728fdee6f49bc5be8f8b81", "message": "Restore lines disappeared during the merge", "committedDate": "2020-11-11T09:46:26Z", "type": "commit"}, {"oid": "eef29d22f94dd1b7236c86bb4c3a64a4d9c38015", "url": "https://github.com/apache/ozone/commit/eef29d22f94dd1b7236c86bb4c3a64a4d9c38015", "message": "fix findbugs problem", "committedDate": "2020-11-11T09:50:25Z", "type": "commit"}, {"oid": "3b7018eb8d1d7b2b00f8880a36b0490bdc312433", "url": "https://github.com/apache/ozone/commit/3b7018eb8d1d7b2b00f8880a36b0490bdc312433", "message": "fix copy paste typo", "committedDate": "2020-11-11T10:36:13Z", "type": "commit"}, {"oid": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3", "url": "https://github.com/apache/ozone/commit/76d62e56eb4a3bb08c0b26a4e68530109fc18dd3", "message": "retrigger build", "committedDate": "2020-11-11T13:48:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg2OTk4Nw==", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521869987", "bodyText": "Currently validate() is unused.  I think it should have @PostConstruct annotation.", "author": "adoroszlai", "createdAt": "2020-11-12T06:39:07Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/OzoneClientConfig.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.\u2002\u2002See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.\u2002\u2002The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.\u2002\u2002You may obtain a copy of the License at\n+ *\n+ * \u2002\u2002\u2002\u2002 http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm;\n+\n+import org.apache.hadoop.hdds.conf.Config;\n+import org.apache.hadoop.hdds.conf.ConfigGroup;\n+import org.apache.hadoop.hdds.conf.ConfigTag;\n+import org.apache.hadoop.hdds.conf.ConfigType;\n+import org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos.ChecksumType;\n+import org.apache.hadoop.ozone.OzoneConfigKeys;\n+\n+import com.google.common.base.Preconditions;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Configuration values for Ozone Client.\n+ */\n+@ConfigGroup(prefix = \"ozone.client\")\n+public class OzoneClientConfig {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(OzoneClientConfig.class);\n+\n+  @Config(key = \"stream.buffer.flush.size\",\n+      defaultValue = \"16MB\",\n+      type = ConfigType.SIZE,\n+      description = \"Size which determines at what buffer position a partial \"\n+          + \"flush will be initiated during write. It should be a multiple of\"\n+          + \" ozone.client.stream.buffer.size\",\n+      tags = ConfigTag.CLIENT)\n+  private long streamBufferFlushSize = 16 * 1024 * 1024;\n+\n+  @Config(key = \"stream.buffer.size\",\n+      defaultValue = \"4MB\",\n+      type = ConfigType.SIZE,\n+      description = \"The size of chunks the client will send to the server\",\n+      tags = ConfigTag.CLIENT)\n+  private int streamBufferSize = 4 * 1024 * 1024;\n+\n+  @Config(key = \"stream.buffer.flush.delay\",\n+      defaultValue = \"true\",\n+      description = \"Default true, when call flush() and determine whether \"\n+          + \"the data in the current buffer is greater than ozone.client\"\n+          + \".stream.buffer.size, if greater than then send buffer to the \"\n+          + \"datanode. You can  turn this off by setting this configuration \"\n+          + \"to false.\", tags = ConfigTag.CLIENT)\n+  private boolean streamBufferFlushDelay = true;\n+\n+  @Config(key = \"stream.buffer.max.size\",\n+      defaultValue = \"32MB\",\n+      type = ConfigType.SIZE,\n+      description = \"Size which determines at what buffer position write call\"\n+          + \" be blocked till acknowledgement of the first partial flush \"\n+          + \"happens by all servers.\",\n+      tags = ConfigTag.CLIENT)\n+  private long streamBufferMaxSize = 32 * 1024 * 1024;\n+\n+  @Config(key = \"max.retries\",\n+      defaultValue = \"5\",\n+      description = \"Maximum number of retries by Ozone Client on \"\n+          + \"encountering exception while writing a key\",\n+      tags = ConfigTag.CLIENT)\n+  private int maxRetryCount = 5;\n+\n+  @Config(key = \"retry.interval\",\n+      defaultValue = \"0\",\n+      description =\n+          \"Indicates the time duration a client will wait before retrying a \"\n+              + \"write key request on encountering an exception. By default \"\n+              + \"there is no wait\",\n+      tags = ConfigTag.CLIENT)\n+  private int retryInterval = 0;\n+\n+  @Config(key = \"checksum.type\",\n+      defaultValue = \"CRC32\",\n+      description = \"The checksum type [NONE/ CRC32/ CRC32C/ SHA256/ MD5] \"\n+          + \"determines which algorithm would be used to compute checksum for \"\n+          + \"chunk data. Default checksum type is CRC32.\",\n+      tags = ConfigTag.CLIENT)\n+  private String checksumType = ChecksumType.CRC32.name();\n+\n+  @Config(key = \"bytes.per.checksum\",\n+      defaultValue = \"1MB\",\n+      type = ConfigType.SIZE,\n+      description = \"Checksum will be computed for every bytes per checksum \"\n+          + \"number of bytes and stored sequentially. The minimum value for \"\n+          + \"this config is 256KB.\",\n+      tags = ConfigTag.CLIENT)\n+  private int bytesPerChecksum = 1024 * 1024;\n+\n+  @Config(key = \"verify.checksum\",\n+      defaultValue = \"true\",\n+      description = \"Ozone client to verify checksum of the checksum \"\n+          + \"blocksize data.\",\n+      tags = ConfigTag.CLIENT)\n+  private boolean checksumVerify = true;\n+\n+  public OzoneClientConfig() {\n+  }\n+\n+  private void validate() {", "originalCommit": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3MjYxMg==", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521872612", "bodyText": "This was removed on master in HDDS-4285.  I don't think it should have been restored in the merge.", "author": "adoroszlai", "createdAt": "2020-11-12T06:46:40Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/BlockOutputStreamEntry.java", "diffHunk": "@@ -108,11 +96,12 @@ long getRemaining() {\n    */\n   private void checkStream() throws IOException {\n     if (this.outputStream == null) {\n+      if (getToken() != null) {\n+        UserGroupInformation.getCurrentUser().addToken(getToken());\n+      }", "originalCommit": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3MzYwMg==", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521873602", "bodyText": "This condition is not the same as previously.", "author": "adoroszlai", "createdAt": "2020-11-12T06:49:34Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -715,7 +666,7 @@ public OzoneOutputStream createKey(\n       throws IOException {\n     verifyVolumeName(volumeName);\n     verifyBucketName(bucketName);\n-    if(checkKeyNameEnabled) {\n+    if (clientConfig.isStreamBufferFlushDelay()) {", "originalCommit": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3NTgxMQ==", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521875811", "bodyText": "Nit: two blocks of OzoneClientConfig can be merged:\n    OzoneClientConfig clientConfig = conf.getObject(OzoneClientConfig.class);\n    clientConfig.setChecksumType(ChecksumType.NONE);\n    clientConfig.setStreamBufferFlushDelay(false);\n    conf.setFromObject(clientConfig);", "author": "adoroszlai", "createdAt": "2020-11-12T06:56:01Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestBlockOutputStream.java", "diffHunk": "@@ -85,13 +86,20 @@ public static void init() throws Exception {\n     flushSize = 2 * chunkSize;\n     maxFlushSize = 2 * flushSize;\n     blockSize = 2 * maxFlushSize;\n+    OzoneClientConfig config = new OzoneClientConfig();\n+    config.setChecksumType(ChecksumType.NONE);\n+    conf.setFromObject(config);\n+\n     conf.setTimeDuration(HDDS_SCM_WATCHER_TIMEOUT, 1000, TimeUnit.MILLISECONDS);\n     conf.setTimeDuration(OZONE_SCM_STALENODE_INTERVAL, 3, TimeUnit.SECONDS);\n-    conf.set(OzoneConfigKeys.OZONE_CLIENT_CHECKSUM_TYPE, \"NONE\");\n     conf.setQuietMode(false);\n     conf.setStorageSize(OzoneConfigKeys.OZONE_SCM_BLOCK_SIZE, 4,\n         StorageUnit.MB);\n-    conf.setBoolean(OZONE_CLIENT_STREAM_BUFFER_FLUSH_DELAY, false);\n+\n+    OzoneClientConfig clientConfig = conf.getObject(OzoneClientConfig.class);\n+    clientConfig.setStreamBufferFlushDelay(false);\n+    conf.setFromObject(clientConfig);\n+", "originalCommit": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3NzA4NQ==", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521877085", "bodyText": "Nit: aren't defaults set automatically without this?", "author": "adoroszlai", "createdAt": "2020-11-12T06:59:31Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClient.java", "diffHunk": "@@ -49,6 +51,7 @@\n   @BeforeClass\n   public static void init() throws Exception {\n     OzoneConfiguration conf = new OzoneConfiguration();\n+    conf.setFromObject(new OzoneClientConfig());", "originalCommit": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgwMzQ5OA==", "url": "https://github.com/apache/ozone/pull/1542#discussion_r522803498", "bodyText": "Yes, it's supposed to be set. I was confused by the other pattern used elsewhere:\n\ncreate OzoneConfig\nset custom properties by setter\nHere we need to export OzoneClientConfig\nmodify tags\nreset OzoneClientConfig to OzoneConfig", "author": "elek", "createdAt": "2020-11-13T08:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3NzA4NQ=="}], "type": "inlineReview"}]}