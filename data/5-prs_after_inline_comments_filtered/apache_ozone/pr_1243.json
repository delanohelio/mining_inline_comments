{"pr_number": 1243, "pr_title": "HDDS-4008. Recon should fallback to ozone.om.service.ids when the internal service id is not defined.", "pr_createdAt": "2020-07-22T21:39:10Z", "pr_url": "https://github.com/apache/ozone/pull/1243", "timeline": [{"oid": "0ed2e1148da33ba360f358cce7fcbf0582cad7aa", "url": "https://github.com/apache/ozone/commit/0ed2e1148da33ba360f358cce7fcbf0582cad7aa", "message": "HDDS-4008. Recon should fallback to ozone.om.service.ids when the internal service id is not defined.", "committedDate": "2020-07-22T21:38:04Z", "type": "commit"}, {"oid": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1", "url": "https://github.com/apache/ozone/commit/2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1", "message": "Move method to common class.", "committedDate": "2020-07-23T00:33:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE2NTczOA==", "url": "https://github.com/apache/ozone/pull/1243#discussion_r459165738", "bodyText": "I think we also need to check if localServiceID value is one of the ozone.om.service.ids value.\nTo find if there is a mistake in the config.", "author": "bharatviswa504", "createdAt": "2020-07-23T01:06:23Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java", "diffHunk": "@@ -527,4 +529,45 @@ public static void validateKeyName(String keyName)\n               OMException.ResultCodes.INVALID_KEY_NAME);\n     }\n   }\n+\n+  /**\n+   * Return configured OzoneManager service id based on the following logic.\n+   * Look at 'ozone.om.internal.service.id' first. If configured, return that.\n+   * If the above is not configured, look at 'ozone.om.service.ids'.\n+   * If count(ozone.om.service.ids) == 1, return that id.\n+   * If count(ozone.om.service.ids) > 1 throw exception\n+   * If 'ozone.om.service.ids' is not configured, return null. (Non HA)\n+   * @param conf configuration\n+   * @return OM service ID.\n+   * @throws IOException on error.\n+   */\n+  public static String getOzoneManagerServiceId(OzoneConfiguration conf)\n+      throws IOException {\n+    Collection<String> omServiceIds;\n+    String localOMServiceId = conf.get(OZONE_OM_INTERNAL_SERVICE_ID);\n+    if (localOMServiceId == null) {\n+      LOG.info(\"{} is not defined, falling back to {} to find serviceID for \"\n+              + \"OzoneManager if it is HA enabled cluster\",\n+          OZONE_OM_INTERNAL_SERVICE_ID, OZONE_OM_SERVICE_IDS_KEY);\n+      omServiceIds = conf.getTrimmedStringCollection(\n+          OZONE_OM_SERVICE_IDS_KEY);\n+      if (omServiceIds.size() > 1) {\n+        throw new IOException(String.format(\n+            \"More than 1 OzoneManager ServiceID (ozone.om.service.ids) \" +\n+                \"configured : %s, but ozone.om.internal.service.id is not \" +\n+                \"configured.\", omServiceIds.toString()));\n+      }\n+    } else {\n+      omServiceIds = Collections.singletonList(localOMServiceId);\n+    }\n+", "originalCommit": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyMjI2Mw==", "url": "https://github.com/apache/ozone/pull/1243#discussion_r459622263", "bodyText": "Thanks @bharatviswa504. Will fix this.", "author": "avijayanhwx", "createdAt": "2020-07-23T17:46:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE2NTczOA=="}], "type": "inlineReview"}, {"oid": "1b943a6b3bb3ccbb0806b5dfb3204d0076d6b3d3", "url": "https://github.com/apache/ozone/commit/1b943a6b3bb3ccbb0806b5dfb3204d0076d6b3d3", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-4008-master", "committedDate": "2020-07-23T16:53:59Z", "type": "commit"}, {"oid": "7f721b9a4dab54655c928b0ded2d7bfcc1b5dd30", "url": "https://github.com/apache/ozone/commit/7f721b9a4dab54655c928b0ded2d7bfcc1b5dd30", "message": "Addressed review comment.", "committedDate": "2020-07-23T18:26:17Z", "type": "commit"}]}