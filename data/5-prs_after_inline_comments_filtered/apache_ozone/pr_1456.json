{"pr_number": 1456, "pr_title": "HDDS-4172. Implement Finalize command in Ozone Manager server.", "pr_createdAt": "2020-09-30T02:21:42Z", "pr_url": "https://github.com/apache/ozone/pull/1456", "timeline": [{"oid": "d65827c4e18833859347bef219138c4b784405ca", "url": "https://github.com/apache/ozone/commit/d65827c4e18833859347bef219138c4b784405ca", "message": "HDDS-3829. Introduce Layout Feature interface in Ozone. (#1322)", "committedDate": "2020-09-04T05:31:03Z", "type": "commit"}, {"oid": "073109869bbf2791ec2cc9dee35e2eb51cb4e2a5", "url": "https://github.com/apache/ozone/commit/073109869bbf2791ec2cc9dee35e2eb51cb4e2a5", "message": "HDDS-4173.  Implement HDDS Version management using the LayoutVersionManager interface. (#1392)", "committedDate": "2020-09-09T16:46:18Z", "type": "commit"}, {"oid": "54e5982073e4751e1ab405e7d359be9b241e56c3", "url": "https://github.com/apache/ozone/commit/54e5982073e4751e1ab405e7d359be9b241e56c3", "message": "HDDS-4141. Implement Finalize command in Ozone Manager client. (#1400)", "committedDate": "2020-09-09T19:02:24Z", "type": "commit"}, {"oid": "75ea5bf64b5ca86726871fe8de8786c384239237", "url": "https://github.com/apache/ozone/commit/75ea5bf64b5ca86726871fe8de8786c384239237", "message": "HDDS-4174. Add current HDDS layout version to Datanode heartbeat/registration (#1421)", "committedDate": "2020-09-15T01:40:05Z", "type": "commit"}, {"oid": "86c4c9b628e266706f80aedc09ed520723cf283c", "url": "https://github.com/apache/ozone/commit/86c4c9b628e266706f80aedc09ed520723cf283c", "message": "HDDS-4143. Implement a factory for OM Requests that returns an instance based on layout version. (#1405)", "committedDate": "2020-09-15T17:40:24Z", "type": "commit"}, {"oid": "c6f51ee3aa304ed42d4aee6f0606d2134ab09164", "url": "https://github.com/apache/ozone/commit/c6f51ee3aa304ed42d4aee6f0606d2134ab09164", "message": "HDDS-4252. Add the current layout versions to DN - SCM proto payload. (#1432)", "committedDate": "2020-09-28T18:28:22Z", "type": "commit"}, {"oid": "a2788b72cf068ab1723cd1c64670acca4db78e8f", "url": "https://github.com/apache/ozone/commit/a2788b72cf068ab1723cd1c64670acca4db78e8f", "message": "HDDS-4227. Implement a 'Prepare For Upgrade' step in OM that applies all committed Ratis transactions. (#1430)", "committedDate": "2020-09-29T16:41:43Z", "type": "commit"}, {"oid": "d3244bd46f97efd24921481ed9de989574c3e948", "url": "https://github.com/apache/ozone/commit/d3244bd46f97efd24921481ed9de989574c3e948", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nChanged the finalizeUpgradeProgress request to be a read request.\nRemoved classes represented the write request handling.\nIn a recent dicussion it turned out that this implemenataion failed for me\nbefore because of some other reason, and there is no need to handle the\nprogress request as a write request.", "committedDate": "2020-09-30T00:39:01Z", "type": "commit"}, {"oid": "d0f7c8ad636baceb5d65999f1293c5a5dda88cf0", "url": "https://github.com/apache/ozone/commit/d0f7c8ad636baceb5d65999f1293c5a5dda88cf0", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nAdded UpgradeFinalizer to serve as the encapsulation for the finalization logic.\nRemoved unnecessary METADATA_VERSION_IS_NEWER_THAN_SOFTWARE constant.\nNamed softwareBehindMetadata condition and extracted it to a method.\nFixed javadoc of OmLayoutVersionManagerImpl#registerRequestType.\nIntroduced Proto Independent implementation above the proto layer for upgrade\nfinalization requests and responses, added proto message creation in the\nrequest handler and response provider code.", "committedDate": "2020-09-30T00:44:57Z", "type": "commit"}, {"oid": "6d06ff8b0f4c6966274192677a43bbdf27878f95", "url": "https://github.com/apache/ozone/commit/6d06ff8b0f4c6966274192677a43bbdf27878f95", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nAdded StatusAndMessage to decouple from protobuf structures inside high level\ncode.\nImplemented finalization logic in UpgradeFinalizer and OMUpgradeFinalizer:\n- the implementation now does one serial finalization of features at the\n    initial call to FinalizeUpgradeRequest processing\n- there are facilities added to separate this to individual Ratis requests\n    later on, HDDS-4286 filed for follow up on this\n- Removed doFinalize logic from OMVersionManager\n- Added state and metadata layout version preservation logic to Storage", "committedDate": "2020-09-30T00:49:48Z", "type": "commit"}, {"oid": "af0b49147f822163c8e8223a45268682ee9ccca7", "url": "https://github.com/apache/ozone/commit/af0b49147f822163c8e8223a45268682ee9ccca7", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nRename upgradeToLayoutVersion persistance related error codes.\nAdd new error codes to the proto structure as well.", "committedDate": "2020-09-30T00:49:48Z", "type": "commit"}, {"oid": "b9f3071fb4629b63aae741cb4caba651482c9695", "url": "https://github.com/apache/ozone/commit/b9f3071fb4629b63aae741cb4caba651482c9695", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nFixed checkstyle issues.\nAdded client exclusivity check in OMUpgradeFinalizer.", "committedDate": "2020-09-30T00:49:48Z", "type": "commit"}, {"oid": "aa51b0141d0aeb66978dfd2fe9356e6e30dbbed7", "url": "https://github.com/apache/ozone/commit/aa51b0141d0aeb66978dfd2fe9356e6e30dbbed7", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nRebase to apache branch, and and fix changes lost during merge.", "committedDate": "2020-09-30T00:54:02Z", "type": "commit"}, {"oid": "05f8c4c7b1539b5f14f9511864fe9df96888aa50", "url": "https://github.com/apache/ozone/commit/05f8c4c7b1539b5f14f9511864fe9df96888aa50", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nFixed a JUnit failure, moved back version checking to abstract version\nmanager's init.\nFixed exit condition of the loop while gathering status messages in\nOMUpgradeFinalizer.", "committedDate": "2020-09-30T02:15:47Z", "type": "commit"}, {"oid": "4c9a789e63a149320adfc88eb09bc5bc0684436a", "url": "https://github.com/apache/ozone/commit/4c9a789e63a149320adfc88eb09bc5bc0684436a", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nAdded license to UpgradeFinalizer, and OMUpgradeFinalizer. Thanks to rat test.", "committedDate": "2020-09-30T02:26:19Z", "type": "commit"}, {"oid": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "url": "https://github.com/apache/ozone/commit/7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nFix JUnit errors from CI run.\nThe implementation missed to update the request factory under OM's version\nmanager, this is fixed, and the tests are modified to accomodate the changes.", "committedDate": "2020-09-30T10:24:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxNjAwNQ==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r497516005", "bodyText": "Nit. Can this be moved to the interface for reuse in other implementations?", "author": "avijayanhwx", "createdAt": "2020-09-30T13:38:08Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.INVALID_REQUEST;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.PERSIST_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.REMOVE_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.UPDATE_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.ALREADY_FINALIZED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_REQUIRED;\n+\n+/**\n+ * UpgradeFinalizer implementation for the Ozone Manager service.\n+ */\n+public class OMUpgradeFinalizer implements UpgradeFinalizer<OzoneManager> {\n+\n+  private Status status = ALREADY_FINALIZED;\n+  private OMLayoutVersionManagerImpl versionManager;\n+  private String clientID;\n+\n+  private Queue<String> msgs = new ConcurrentLinkedQueue<>();\n+  private boolean isDone = false;\n+\n+  private static final OmUpgradeAction NOOP = a -> {};", "originalCommit": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MDc4NQ==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498760785", "bodyText": "I moved it to OmUpgradeAction, I believe that is the best place. Thank you for catching this one.", "author": "fapifta", "createdAt": "2020-10-02T11:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxNjAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MTUwOA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498861508", "bodyText": "Ok, it turned out that if OMUpgradeAction has just one constants, that qualifies as a bad practice, as if an interface does contain just constants, that can have some disadvantages according to seemingly more clever ppl than me. :)\nI moved it back to OMUpgradeFinalizer, as due to the logic we need to preserve the OMUpgradeAction-ness of the NOOP to work well there, as we want to push OzoneManager instances to the executeAction, and the type system is against having a simple UpgradeAction as a NOOP. We can thin about adding this to OMLayoutFeature instead, but as we do not use it elsewhere at the moment, and because we use Optional and we provide just a null in case the finalize action is a noop, we do not need it elsewhere as it seems...\nAn other approach can be an orElse(null), but with that we can even leave out the Optional in the OMLayoutFeature and LayoutFeature implementations/definitions, and instead checking if it is a NOOP, we can check for null.\nWhat do you think?", "author": "fapifta", "createdAt": "2020-10-02T14:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxNjAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxNjYxMw==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r497516613", "bodyText": "Nit. Class needs a Javadoc.", "author": "avijayanhwx", "createdAt": "2020-09-30T13:38:54Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.INVALID_REQUEST;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.PERSIST_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.REMOVE_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.UPDATE_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.ALREADY_FINALIZED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_REQUIRED;\n+\n+/**\n+ * UpgradeFinalizer implementation for the Ozone Manager service.\n+ */\n+public class OMUpgradeFinalizer implements UpgradeFinalizer<OzoneManager> {\n+\n+  private Status status = ALREADY_FINALIZED;\n+  private OMLayoutVersionManagerImpl versionManager;\n+  private String clientID;\n+\n+  private Queue<String> msgs = new ConcurrentLinkedQueue<>();\n+  private boolean isDone = false;\n+\n+  private static final OmUpgradeAction NOOP = a -> {};\n+\n+  public OMUpgradeFinalizer(OMLayoutVersionManagerImpl versionManager) {\n+    this.versionManager = versionManager;\n+    if (versionManager.needsFinalization()) {\n+      status = FINALIZATION_REQUIRED;\n+    }\n+  }\n+\n+  @Override\n+  public StatusAndMessages finalize(String upgradeClientID, OzoneManager om)\n+      throws IOException {\n+    if (!versionManager.needsFinalization()) {\n+      return FINALIZED_MSG;\n+    }\n+    clientID = upgradeClientID;\n+\n+// This requires some more investigation on how to do it properly while\n+// requests are on the fly, and post finalize features one by one.\n+// Until that is done, monitoring is not really doing anything meaningful\n+// but this is a tradoff we can take for the first iteration either if needed,\n+// as the finalization of the first few features should not take that long.\n+// Follow up JIRA is in HDDS-4286\n+//    String threadName = \"OzoneManager-Upgrade-Finalizer\";\n+//    ExecutorService executor =\n+//        Executors.newSingleThreadExecutor(r -> new Thread(threadName));\n+//    executor.submit(new Worker(om));\n+    new Worker(om).call();\n+    return STARTING_MSG;\n+  }\n+\n+  @Override\n+  public StatusAndMessages reportStatus(\n+      String upgradeClientID, boolean takeover\n+  ) throws IOException {\n+    if (takeover) {\n+      clientID = upgradeClientID;\n+    }\n+    assertClientId(upgradeClientID);\n+    List<String> returningMsgs = new ArrayList<>(msgs.size()+10);\n+    status = isDone ? FINALIZATION_DONE : FINALIZATION_IN_PROGRESS;\n+    while (msgs.size() > 0) {\n+      returningMsgs.add(msgs.poll());\n+    }\n+    return new StatusAndMessages(status, returningMsgs);\n+  }\n+\n+  private void assertClientId(String id) throws OMException {\n+    if (!this.clientID.equals(id)) {\n+      throw new OMException(\"Unknown client tries to get finalization status.\\n\"\n+          + \"The requestor is not the initiating client of the finalization,\"\n+          + \" if you want to take over, and get unsent status messages, check\"\n+          + \" -takeover option.\", INVALID_REQUEST);\n+    }\n+  }\n+\n+\n+\n+\n+  private class Worker implements Callable<Void> {", "originalCommit": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MDk3Nw==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498760977", "bodyText": "Added doc to the Worker class as well.", "author": "fapifta", "createdAt": "2020-10-02T11:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxNjYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1MTgzMg==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498051832", "bodyText": "Do we really need to persist version to storage every time? Why not persist storage only once for the final finalization version? We already update current layout version on memory value (StorageInfo#LAYOUT_VERSION) each time Other place can get this value to know which feature is now on finalizing.", "author": "linyiqun", "createdAt": "2020-10-01T07:54:51Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.INVALID_REQUEST;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.PERSIST_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.REMOVE_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.UPDATE_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.ALREADY_FINALIZED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_REQUIRED;\n+\n+/**\n+ * UpgradeFinalizer implementation for the Ozone Manager service.\n+ */\n+public class OMUpgradeFinalizer implements UpgradeFinalizer<OzoneManager> {\n+\n+  private Status status = ALREADY_FINALIZED;\n+  private OMLayoutVersionManagerImpl versionManager;\n+  private String clientID;\n+\n+  private Queue<String> msgs = new ConcurrentLinkedQueue<>();\n+  private boolean isDone = false;\n+\n+  private static final OmUpgradeAction NOOP = a -> {};\n+\n+  public OMUpgradeFinalizer(OMLayoutVersionManagerImpl versionManager) {\n+    this.versionManager = versionManager;\n+    if (versionManager.needsFinalization()) {\n+      status = FINALIZATION_REQUIRED;\n+    }\n+  }\n+\n+  @Override\n+  public StatusAndMessages finalize(String upgradeClientID, OzoneManager om)\n+      throws IOException {\n+    if (!versionManager.needsFinalization()) {\n+      return FINALIZED_MSG;\n+    }\n+    clientID = upgradeClientID;\n+\n+// This requires some more investigation on how to do it properly while\n+// requests are on the fly, and post finalize features one by one.\n+// Until that is done, monitoring is not really doing anything meaningful\n+// but this is a tradoff we can take for the first iteration either if needed,\n+// as the finalization of the first few features should not take that long.\n+// Follow up JIRA is in HDDS-4286\n+//    String threadName = \"OzoneManager-Upgrade-Finalizer\";\n+//    ExecutorService executor =\n+//        Executors.newSingleThreadExecutor(r -> new Thread(threadName));\n+//    executor.submit(new Worker(om));\n+    new Worker(om).call();\n+    return STARTING_MSG;\n+  }\n+\n+  @Override\n+  public StatusAndMessages reportStatus(\n+      String upgradeClientID, boolean takeover\n+  ) throws IOException {\n+    if (takeover) {\n+      clientID = upgradeClientID;\n+    }\n+    assertClientId(upgradeClientID);\n+    List<String> returningMsgs = new ArrayList<>(msgs.size()+10);\n+    status = isDone ? FINALIZATION_DONE : FINALIZATION_IN_PROGRESS;\n+    while (msgs.size() > 0) {\n+      returningMsgs.add(msgs.poll());\n+    }\n+    return new StatusAndMessages(status, returningMsgs);\n+  }\n+\n+  private void assertClientId(String id) throws OMException {\n+    if (!this.clientID.equals(id)) {\n+      throw new OMException(\"Unknown client tries to get finalization status.\\n\"\n+          + \"The requestor is not the initiating client of the finalization,\"\n+          + \" if you want to take over, and get unsent status messages, check\"\n+          + \" -takeover option.\", INVALID_REQUEST);\n+    }\n+  }\n+\n+\n+\n+\n+  private class Worker implements Callable<Void> {\n+    private OzoneManager ozoneManager;\n+\n+    Worker(OzoneManager om) {\n+      ozoneManager = om;\n+    }\n+\n+    @Override\n+    public Void call() throws OMException {\n+      try {\n+        emitStartingMsg();\n+\n+        for (OMLayoutFeature f : versionManager.unfinalizedFeatures()) {\n+          finalizeFeature(f);\n+          updateLayoutVersionInVersionFile(f);\n+          versionManager.finalized(f);\n+        }\n+\n+        emitFinishedMsg();\n+      } finally {\n+        isDone = true;\n+      }\n+      return null;\n+    }\n+\n+    private void finalizeFeature(OMLayoutFeature feature)\n+        throws OMException {\n+      OmUpgradeAction action = feature.onFinalizeAction().orElse(NOOP);\n+\n+      if (action == NOOP) {\n+        emitNOOPMsg(feature.name());\n+        return;\n+      }\n+\n+      putFinalizationMarkIntoVersionFile(feature);\n+\n+      emitStartingFinalizationActionMsg(feature.name());\n+      action.executeAction(ozoneManager);\n+      emitFinishFinalizationActionMsg(feature.name());\n+\n+      removeFinalizationMarkFromVersionFile(feature);\n+    }\n+\n+    private void updateLayoutVersionInVersionFile(OMLayoutFeature feature)\n+        throws OMException {\n+      int prevLayoutVersion = currentStoredLayoutVersion();\n+\n+      updateStorageLayoutVersion(feature.layoutVersion());\n+      try {\n+        persistStorage();\n+      } catch (IOException e) {", "originalCommit": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2NjM3NQ==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498766375", "bodyText": "The main things we want to ensure here:\n\nat any point in time there can be a failure point, so we would better persist where we are at before and after every major step, that is what we can not loose, as all the in-memory states can be lost at any point in time.\nThe finalization action that we do for LayoutFeatures does the modifications required by the LayoutFeature inside our internal structures, so we need to know when we have started one such a step but we have not finished it due to a catastrophic failure, as in that case we are potentially in an inconsistent state, and OM should not proceed with anything until the state is examined and we are free to move further.\nIf the finalization action is a NOOP, we skip this part, and just update the LayoutVersion and persist the update\nAfter a LayoutFeature is finalized we need to update and persist the LayoutVersion, as if the next finalize action ends in a catastrophic failure, we need to know where to catch up from.\n\nSo In this particular case, we persisting the LayoutFeature's LayoutVersion to Storage to ensure point 4, so we never redo the finalization of a LayoutFeature, as redoing it might lead to an issue as the start state of a second finalization would be unexpected after it finished once.", "author": "fapifta", "createdAt": "2020-10-02T11:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1MTgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTgzMA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r499129830", "bodyText": "Comment makes sense to me.", "author": "linyiqun", "createdAt": "2020-10-03T08:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1MTgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1NjI4OQ==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498056289", "bodyText": "Should we do the safe layout check here? We should ensure the feature layout is increasing between OMLayoutFeature, otherwise versionManager#finalized will throw IllegalArgumentException error.", "author": "linyiqun", "createdAt": "2020-10-01T08:02:44Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.INVALID_REQUEST;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.PERSIST_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.REMOVE_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.UPDATE_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.ALREADY_FINALIZED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_REQUIRED;\n+\n+/**\n+ * UpgradeFinalizer implementation for the Ozone Manager service.\n+ */\n+public class OMUpgradeFinalizer implements UpgradeFinalizer<OzoneManager> {\n+\n+  private Status status = ALREADY_FINALIZED;\n+  private OMLayoutVersionManagerImpl versionManager;\n+  private String clientID;\n+\n+  private Queue<String> msgs = new ConcurrentLinkedQueue<>();\n+  private boolean isDone = false;\n+\n+  private static final OmUpgradeAction NOOP = a -> {};\n+\n+  public OMUpgradeFinalizer(OMLayoutVersionManagerImpl versionManager) {\n+    this.versionManager = versionManager;\n+    if (versionManager.needsFinalization()) {\n+      status = FINALIZATION_REQUIRED;\n+    }\n+  }\n+\n+  @Override\n+  public StatusAndMessages finalize(String upgradeClientID, OzoneManager om)\n+      throws IOException {\n+    if (!versionManager.needsFinalization()) {\n+      return FINALIZED_MSG;\n+    }\n+    clientID = upgradeClientID;\n+\n+// This requires some more investigation on how to do it properly while\n+// requests are on the fly, and post finalize features one by one.\n+// Until that is done, monitoring is not really doing anything meaningful\n+// but this is a tradoff we can take for the first iteration either if needed,\n+// as the finalization of the first few features should not take that long.\n+// Follow up JIRA is in HDDS-4286\n+//    String threadName = \"OzoneManager-Upgrade-Finalizer\";\n+//    ExecutorService executor =\n+//        Executors.newSingleThreadExecutor(r -> new Thread(threadName));\n+//    executor.submit(new Worker(om));\n+    new Worker(om).call();\n+    return STARTING_MSG;\n+  }\n+\n+  @Override\n+  public StatusAndMessages reportStatus(\n+      String upgradeClientID, boolean takeover\n+  ) throws IOException {\n+    if (takeover) {\n+      clientID = upgradeClientID;\n+    }\n+    assertClientId(upgradeClientID);\n+    List<String> returningMsgs = new ArrayList<>(msgs.size()+10);\n+    status = isDone ? FINALIZATION_DONE : FINALIZATION_IN_PROGRESS;\n+    while (msgs.size() > 0) {\n+      returningMsgs.add(msgs.poll());\n+    }\n+    return new StatusAndMessages(status, returningMsgs);\n+  }\n+\n+  private void assertClientId(String id) throws OMException {\n+    if (!this.clientID.equals(id)) {\n+      throw new OMException(\"Unknown client tries to get finalization status.\\n\"\n+          + \"The requestor is not the initiating client of the finalization,\"\n+          + \" if you want to take over, and get unsent status messages, check\"\n+          + \" -takeover option.\", INVALID_REQUEST);\n+    }\n+  }\n+\n+\n+\n+\n+  private class Worker implements Callable<Void> {\n+    private OzoneManager ozoneManager;\n+\n+    Worker(OzoneManager om) {\n+      ozoneManager = om;\n+    }\n+\n+    @Override\n+    public Void call() throws OMException {\n+      try {\n+        emitStartingMsg();\n+\n+        for (OMLayoutFeature f : versionManager.unfinalizedFeatures()) {\n+          finalizeFeature(f);\n+          updateLayoutVersionInVersionFile(f);\n+          versionManager.finalized(f);", "originalCommit": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc3NDM1MA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498774350", "bodyText": "AbstractLayoutVersionManager gives the insurance for us here, as that has a map for the features with the feature's LayoutVersion as a key, and unfinalizedFeatures() works based off of that map.\nSo the internal structure, and the overall design should ensure that there can be only one LayoutFeature associated with one LayoutVersion.\nIt would be beneficial to work based on the ordinal of the OMLayoutFeature enum, but this is not the case for now, I think that is an improvement we can add there, so that a wrongly defined enum member can not hide an other LayoutFeature, or we can ensure that with a test. I filed HDDS-4303 to track this.", "author": "fapifta", "createdAt": "2020-10-02T11:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1NjI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTc4Nw==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r499129787", "bodyText": "Okay, let's do the further track on HDDS-4303", "author": "linyiqun", "createdAt": "2020-10-03T08:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1NjI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwNTAyOQ==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r499305029", "bodyText": "There is a test that covers this check (in a way) --> TestOMVersionManager#testOMLayoutFeatureCatalog. Maybe, we can build on that.", "author": "avijayanhwx", "createdAt": "2020-10-05T00:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1NjI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1ODExOQ==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498058119", "bodyText": "Nit: Missing a whitespace before 'finalized'.", "author": "linyiqun", "createdAt": "2020-10-01T08:06:07Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/AbstractLayoutVersionManager.java", "diffHunk": "@@ -65,53 +64,66 @@ protected void initializeFeatures(LayoutFeature[] lfs) {\n     });\n   }\n \n+  protected void reset() {\n+    metadataLayoutVersion = 0;\n+    softwareLayoutVersion = 0;\n+    featureMap.clear();\n+    features.clear();\n+    isInitialized = false;\n+  }\n+\n+  public void finalized(T layoutFeature) {\n+    if (layoutFeature.layoutVersion() > metadataLayoutVersion) {\n+      metadataLayoutVersion = layoutFeature.layoutVersion();\n+    } else {\n+      throw new IllegalArgumentException(\n+          \"Finalize attempt on a layoutFeature which has already been\"\n+              + \"finalized. Software Layout version: \" + softwareLayoutVersion", "originalCommit": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MTA1NA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498761054", "bodyText": "fixed", "author": "fapifta", "createdAt": "2020-10-02T11:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1ODExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1OTEzNA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498059134", "bodyText": "Nit: Missing a whitespace before 'a LayoutFeature upgrade'.", "author": "linyiqun", "createdAt": "2020-10-01T08:07:59Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/common/StorageInfo.java", "diffHunk": "@@ -150,6 +179,16 @@ private void verifyClusterId()\n     }\n   }\n \n+  private void verifyUpgradingToLayoutVersion()\n+      throws InconsistentStorageStateException {\n+    int upgradeMark = getUpgradingToLayoutVersion();\n+    if (upgradeMark != INVALID_LAYOUT_VERSION) {\n+      throw new InconsistentStorageStateException(\"Ozone Manager died during\"\n+          + \"a LayoutFeature upgrade.\");", "originalCommit": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MTEzOA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498761138", "bodyText": "fixed", "author": "fapifta", "createdAt": "2020-10-02T11:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1OTEzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NDk3Ng==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498064976", "bodyText": "Same comment for persistStorage like above.", "author": "linyiqun", "createdAt": "2020-10-01T08:18:18Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.INVALID_REQUEST;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.PERSIST_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.REMOVE_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.UPDATE_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.ALREADY_FINALIZED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_REQUIRED;\n+\n+/**\n+ * UpgradeFinalizer implementation for the Ozone Manager service.\n+ */\n+public class OMUpgradeFinalizer implements UpgradeFinalizer<OzoneManager> {\n+\n+  private Status status = ALREADY_FINALIZED;\n+  private OMLayoutVersionManagerImpl versionManager;\n+  private String clientID;\n+\n+  private Queue<String> msgs = new ConcurrentLinkedQueue<>();\n+  private boolean isDone = false;\n+\n+  private static final OmUpgradeAction NOOP = a -> {};\n+\n+  public OMUpgradeFinalizer(OMLayoutVersionManagerImpl versionManager) {\n+    this.versionManager = versionManager;\n+    if (versionManager.needsFinalization()) {\n+      status = FINALIZATION_REQUIRED;\n+    }\n+  }\n+\n+  @Override\n+  public StatusAndMessages finalize(String upgradeClientID, OzoneManager om)\n+      throws IOException {\n+    if (!versionManager.needsFinalization()) {\n+      return FINALIZED_MSG;\n+    }\n+    clientID = upgradeClientID;\n+\n+// This requires some more investigation on how to do it properly while\n+// requests are on the fly, and post finalize features one by one.\n+// Until that is done, monitoring is not really doing anything meaningful\n+// but this is a tradoff we can take for the first iteration either if needed,\n+// as the finalization of the first few features should not take that long.\n+// Follow up JIRA is in HDDS-4286\n+//    String threadName = \"OzoneManager-Upgrade-Finalizer\";\n+//    ExecutorService executor =\n+//        Executors.newSingleThreadExecutor(r -> new Thread(threadName));\n+//    executor.submit(new Worker(om));\n+    new Worker(om).call();\n+    return STARTING_MSG;\n+  }\n+\n+  @Override\n+  public StatusAndMessages reportStatus(\n+      String upgradeClientID, boolean takeover\n+  ) throws IOException {\n+    if (takeover) {\n+      clientID = upgradeClientID;\n+    }\n+    assertClientId(upgradeClientID);\n+    List<String> returningMsgs = new ArrayList<>(msgs.size()+10);\n+    status = isDone ? FINALIZATION_DONE : FINALIZATION_IN_PROGRESS;\n+    while (msgs.size() > 0) {\n+      returningMsgs.add(msgs.poll());\n+    }\n+    return new StatusAndMessages(status, returningMsgs);\n+  }\n+\n+  private void assertClientId(String id) throws OMException {\n+    if (!this.clientID.equals(id)) {\n+      throw new OMException(\"Unknown client tries to get finalization status.\\n\"\n+          + \"The requestor is not the initiating client of the finalization,\"\n+          + \" if you want to take over, and get unsent status messages, check\"\n+          + \" -takeover option.\", INVALID_REQUEST);\n+    }\n+  }\n+\n+\n+\n+\n+  private class Worker implements Callable<Void> {\n+    private OzoneManager ozoneManager;\n+\n+    Worker(OzoneManager om) {\n+      ozoneManager = om;\n+    }\n+\n+    @Override\n+    public Void call() throws OMException {\n+      try {\n+        emitStartingMsg();\n+\n+        for (OMLayoutFeature f : versionManager.unfinalizedFeatures()) {\n+          finalizeFeature(f);\n+          updateLayoutVersionInVersionFile(f);\n+          versionManager.finalized(f);\n+        }\n+\n+        emitFinishedMsg();\n+      } finally {\n+        isDone = true;\n+      }\n+      return null;\n+    }\n+\n+    private void finalizeFeature(OMLayoutFeature feature)\n+        throws OMException {\n+      OmUpgradeAction action = feature.onFinalizeAction().orElse(NOOP);\n+\n+      if (action == NOOP) {\n+        emitNOOPMsg(feature.name());\n+        return;\n+      }\n+\n+      putFinalizationMarkIntoVersionFile(feature);\n+\n+      emitStartingFinalizationActionMsg(feature.name());\n+      action.executeAction(ozoneManager);\n+      emitFinishFinalizationActionMsg(feature.name());\n+\n+      removeFinalizationMarkFromVersionFile(feature);\n+    }\n+\n+    private void updateLayoutVersionInVersionFile(OMLayoutFeature feature)\n+        throws OMException {\n+      int prevLayoutVersion = currentStoredLayoutVersion();\n+\n+      updateStorageLayoutVersion(feature.layoutVersion());\n+      try {\n+        persistStorage();\n+      } catch (IOException e) {\n+        updateStorageLayoutVersion(prevLayoutVersion);\n+        logLayoutVersionUpdateFailureAndThrow(e);\n+      }\n+    }\n+\n+    private void putFinalizationMarkIntoVersionFile(OMLayoutFeature feature)\n+        throws OMException {\n+      try {\n+        emitUpgradeToLayoutVersionPersistingMsg(feature.name());\n+\n+        setUpgradeToLayoutVersionInStorage(feature.layoutVersion());\n+        persistStorage();", "originalCommit": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2NjQxMA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498766410", "bodyText": "From the comment for the previous persisting related comment point 2 is relevant here, we need to know if we have started the finalization of a LayoutFeature but never finished it, and we need to know it even if there is a catastrophic failure, and OM has been restarted due to that failure, and persisting this information to disk seems to be the way to fullfil this requirement.", "author": "fapifta", "createdAt": "2020-10-02T11:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NDk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTg3Mw==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r499129873", "bodyText": "Comment makes sense to me.", "author": "linyiqun", "createdAt": "2020-10-03T08:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NDk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxMjcxMg==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498312712", "bodyText": "Here clientID should be thread-safe to update, can we make clientID as a volatile variable?", "author": "linyiqun", "createdAt": "2020-10-01T14:59:57Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.INVALID_REQUEST;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.PERSIST_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.REMOVE_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.UPDATE_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.ALREADY_FINALIZED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_REQUIRED;\n+\n+/**\n+ * UpgradeFinalizer implementation for the Ozone Manager service.\n+ */\n+public class OMUpgradeFinalizer implements UpgradeFinalizer<OzoneManager> {\n+\n+  private Status status = ALREADY_FINALIZED;\n+  private OMLayoutVersionManagerImpl versionManager;\n+  private String clientID;\n+\n+  private Queue<String> msgs = new ConcurrentLinkedQueue<>();\n+  private boolean isDone = false;\n+\n+  private static final OmUpgradeAction NOOP = a -> {};\n+\n+  public OMUpgradeFinalizer(OMLayoutVersionManagerImpl versionManager) {\n+    this.versionManager = versionManager;\n+    if (versionManager.needsFinalization()) {\n+      status = FINALIZATION_REQUIRED;\n+    }\n+  }\n+\n+  @Override\n+  public StatusAndMessages finalize(String upgradeClientID, OzoneManager om)\n+      throws IOException {\n+    if (!versionManager.needsFinalization()) {\n+      return FINALIZED_MSG;\n+    }\n+    clientID = upgradeClientID;\n+\n+// This requires some more investigation on how to do it properly while\n+// requests are on the fly, and post finalize features one by one.\n+// Until that is done, monitoring is not really doing anything meaningful\n+// but this is a tradoff we can take for the first iteration either if needed,\n+// as the finalization of the first few features should not take that long.\n+// Follow up JIRA is in HDDS-4286\n+//    String threadName = \"OzoneManager-Upgrade-Finalizer\";\n+//    ExecutorService executor =\n+//        Executors.newSingleThreadExecutor(r -> new Thread(threadName));\n+//    executor.submit(new Worker(om));\n+    new Worker(om).call();\n+    return STARTING_MSG;\n+  }\n+\n+  @Override\n+  public StatusAndMessages reportStatus(\n+      String upgradeClientID, boolean takeover\n+  ) throws IOException {\n+    if (takeover) {\n+      clientID = upgradeClientID;", "originalCommit": "7bb3ef5fb34dafb67d98cddb3a4c48ef183fa9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwMjI1NA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r498802254", "bodyText": "Good point, though making clientID volatile, does not really help to solve a race condition here I believe, so I propose to synchronize the whole reportStatus method.\nThe reasons is that, if there is the original client that polls together with a client that does a takeover, then both can step on each others toes, as if for the original client we are already processing the message queue when an other client takes over, then returning status might change as well, and also there might be missing messages in the responses sent to the clients.\nFortunately we don't have to worry about isDone and messages at least, as even if isDone is being updated late, and the final message is polled from the msgs queue with an IN_PROGRES state, the client in the next cycle gets a DONE state without messages, and that is acceptable.", "author": "fapifta", "createdAt": "2020-10-02T12:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxMjcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTY1NA==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r499129654", "bodyText": "To synchronize the whole reportStatus method looks good to me.", "author": "linyiqun", "createdAt": "2020-10-03T08:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxMjcxMg=="}], "type": "inlineReview"}, {"oid": "0a410f522195e2efd123c8c7f4ad3ccafe724f09", "url": "https://github.com/apache/ozone/commit/0a410f522195e2efd123c8c7f4ad3ccafe724f09", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nAddressing review comments:\n  - added JavaDoc for UpgradeFinalizer#Worker\n  - moved OMUpgradeFinalizer#NOOP to OMUpgradeAction\n  - fixed missing whitespaces in log messages", "committedDate": "2020-10-02T11:14:28Z", "type": "commit"}, {"oid": "dab34f95b4e0b4daf2486890cc449dab1ca257e1", "url": "https://github.com/apache/ozone/commit/dab34f95b4e0b4daf2486890cc449dab1ca257e1", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nSynchronize the reportStatus call, to avoid weird race conditions in between\nclients that try to take over and the original client.", "committedDate": "2020-10-02T12:46:13Z", "type": "commit"}, {"oid": "9ea98ede5e0b466bd55326d609c0df2552bc3054", "url": "https://github.com/apache/ozone/commit/9ea98ede5e0b466bd55326d609c0df2552bc3054", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nMoving back NOOP to the UpgradeFinalizer, to fix a checkstyle warning,\nin OMUpgradeAction as there are no methods there, we can not have just\na constant as interfaces with just constants is a bad practice.", "committedDate": "2020-10-02T14:25:46Z", "type": "commit"}, {"oid": "a0f1e40a266355d9b8341bb1171f85dc22f055f1", "url": "https://github.com/apache/ozone/commit/a0f1e40a266355d9b8341bb1171f85dc22f055f1", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nAdded tests for the new AbstractLayoutVersionManager methods.\nDeclared to throw Exception from UpgradeActions belongs to LayoutFeatures.\nAdded exception handling in the finalizer for the UpgradeAction exceptions.\nAdded finalization failure status in OMException and related proto.\nAdded tests for OMUpgradeFinalizer.", "committedDate": "2020-10-06T23:49:11Z", "type": "commit"}, {"oid": "4de2ea5698602a2bcdf11591d9615855ebffe706", "url": "https://github.com/apache/ozone/commit/4de2ea5698602a2bcdf11591d9615855ebffe706", "message": "Merge remote-tracking branch 'apache/HDDS-3698-upgrade' into upgrade", "committedDate": "2020-10-07T01:18:27Z", "type": "commit"}, {"oid": "cf22eabba2a26ee8dc104aa7ff475ce9e3be800e", "url": "https://github.com/apache/ozone/commit/cf22eabba2a26ee8dc104aa7ff475ce9e3be800e", "message": "Fixed missing license.", "committedDate": "2020-10-07T01:23:38Z", "type": "commit"}, {"oid": "5aecceaf920ec6ef64c0a2bad56151c3d3c96b3a", "url": "https://github.com/apache/ozone/commit/5aecceaf920ec6ef64c0a2bad56151c3d3c96b3a", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nRemoved some merge related leftovers in OzoneConsts\nAdded closing newline to SCMDatanodeProtocolServer\nFixed JUnit test failure\nRemoved unnecessarily added dependency from hadoop-ozone/ozone-manager\n\nJUnit failure's was caused by the finalness of HDDSLayoutVersionManager.\nI tried to upgrade to Mockito 2.x, but it tunred out because of we are\n  depending on hadoop-common's MetricsAsserts class, which uses old\n  Mockito 1 ArgumentMatcher extension, and Mockito 2 made it to an\n  interface, it results in an IncompatibleClassChange, and fails other\n  tests, besides other incompatible changes.\nWe may revisit the update to Mockito 2 after that we can add final to the\n  HDDSLAyoutVersionManager class, as with that mocking final classes became\n  possible, as with OmLayoutVersionManager in hadoop-ozone where we can\n  use Mockito 2's capability to mock finals properly.", "committedDate": "2020-10-07T12:04:10Z", "type": "commit"}, {"oid": "2d8186c9072fe1025875541c713bbddd57d8499b", "url": "https://github.com/apache/ozone/commit/2d8186c9072fe1025875541c713bbddd57d8499b", "message": "Merge remote-tracking branch 'apache/HDDS-3698-upgrade' into upgrade", "committedDate": "2020-10-12T20:48:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzODczMw==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r503538733", "bodyText": "Can this be moved to the individual layout version update methods above, so that the caller does not need to invoke the persist explicitly every time? As a caller, if I do storage.updateStorageLayoutVersion(), I can expect it to be persisted, right? I don't have a strong opinion about this, just a suggestion.", "author": "avijayanhwx", "createdAt": "2020-10-12T21:23:07Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.*;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.INVALID_REQUEST;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.PERSIST_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.REMOVE_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.UPDATE_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+\n+/**\n+ * UpgradeFinalizer implementation for the Ozone Manager service.\n+ */\n+public class OMUpgradeFinalizer implements UpgradeFinalizer<OzoneManager> {\n+\n+  private  static final OmUpgradeAction NOOP = a -> {};\n+\n+  private OMLayoutVersionManagerImpl versionManager;\n+  private String clientID;\n+\n+  private Queue<String> msgs = new ConcurrentLinkedQueue<>();\n+  private boolean isDone = false;\n+\n+  public OMUpgradeFinalizer(OMLayoutVersionManagerImpl versionManager) {\n+    this.versionManager = versionManager;\n+  }\n+\n+  @Override\n+  public StatusAndMessages finalize(String upgradeClientID, OzoneManager om)\n+      throws IOException {\n+    if (!versionManager.needsFinalization()) {\n+      return FINALIZED_MSG;\n+    }\n+    clientID = upgradeClientID;\n+\n+// This requires some more investigation on how to do it properly while\n+// requests are on the fly, and post finalize features one by one.\n+// Until that is done, monitoring is not really doing anything meaningful\n+// but this is a tradoff we can take for the first iteration either if needed,\n+// as the finalization of the first few features should not take that long.\n+// Follow up JIRA is in HDDS-4286\n+//    String threadName = \"OzoneManager-Upgrade-Finalizer\";\n+//    ExecutorService executor =\n+//        Executors.newSingleThreadExecutor(r -> new Thread(threadName));\n+//    executor.submit(new Worker(om));\n+    new Worker(om).call();\n+    return STARTING_MSG;\n+  }\n+\n+  @Override\n+  public synchronized StatusAndMessages reportStatus(\n+      String upgradeClientID, boolean takeover\n+  ) throws IOException {\n+    if (takeover) {\n+      clientID = upgradeClientID;\n+    }\n+    assertClientId(upgradeClientID);\n+    List<String> returningMsgs = new ArrayList<>(msgs.size()+10);\n+    Status status = isDone ? FINALIZATION_DONE : FINALIZATION_IN_PROGRESS;\n+    while (msgs.size() > 0) {\n+      returningMsgs.add(msgs.poll());\n+    }\n+    return new StatusAndMessages(status, returningMsgs);\n+  }\n+\n+  private void assertClientId(String id) throws OMException {\n+    if (!this.clientID.equals(id)) {\n+      throw new OMException(\"Unknown client tries to get finalization status.\\n\"\n+          + \"The requestor is not the initiating client of the finalization,\"\n+          + \" if you want to take over, and get unsent status messages, check\"\n+          + \" -takeover option.\", INVALID_REQUEST);\n+    }\n+  }\n+\n+  /**\n+   * This class implements the finalization logic applied to every\n+   * LayoutFeature that needs to be finalized.\n+   *\n+   * For the first approach this happens synchronously within the state machine\n+   * during the FinalizeUpgrade request, but ideally this has to be moved to\n+   * individual calls that are going into the StateMaching one by one.\n+   * The prerequisits for this to happen in the background are the following:\n+   * - more fine grained control for LayoutFeatures to prepare the\n+   *    finalization outside the state machine, do the switch from old to new\n+   *    logic inside the statemachine and apply the finalization, and then do\n+   *    any cleanup necessary outside the state machine\n+   * - a way to post a request to the state machine that is not part of the\n+   *    client API, so basically not an OMRequest, but preferably an internal\n+   *    request, which is posted from the leader OM to the follower OMs only.\n+   * - ensure that there is a possibility to implement a rollback logic if\n+   *    something goes wrong inside the state machine, to avoid OM stuck in an\n+   *    intermediate state due to an error.\n+   */\n+  private class Worker implements Callable<Void> {\n+    private OzoneManager ozoneManager;\n+\n+    /**\n+     * Initiates the Worker, for the specified OM instance.\n+     * @param om the OzoneManager instance on which to finalize the new\n+     *           LayoutFeatures.\n+     */\n+    Worker(OzoneManager om) {\n+      ozoneManager = om;\n+    }\n+\n+    @Override\n+    public Void call() throws OMException {\n+      try {\n+        emitStartingMsg();\n+\n+        for (OMLayoutFeature f : versionManager.unfinalizedFeatures()) {\n+          finalizeFeature(f);\n+          updateLayoutVersionInVersionFile(f);\n+          versionManager.finalized(f);\n+        }\n+\n+        emitFinishedMsg();\n+      } finally {\n+        isDone = true;\n+      }\n+      return null;\n+    }\n+\n+    private void finalizeFeature(OMLayoutFeature feature)\n+        throws OMException {\n+      OmUpgradeAction action = feature.onFinalizeAction().orElse(NOOP);\n+\n+      if (action == NOOP) {\n+        emitNOOPMsg(feature.name());\n+        return;\n+      }\n+\n+      putFinalizationMarkIntoVersionFile(feature);\n+\n+      emitStartingFinalizationActionMsg(feature.name());\n+      try {\n+        action.executeAction(ozoneManager);\n+      } catch (Exception e) {\n+        logFinalizationFailureAndThrow(e, feature.name());\n+      }\n+      emitFinishFinalizationActionMsg(feature.name());\n+\n+      removeFinalizationMarkFromVersionFile(feature);\n+    }\n+\n+    private void updateLayoutVersionInVersionFile(OMLayoutFeature feature)\n+        throws OMException {\n+      int prevLayoutVersion = currentStoredLayoutVersion();\n+\n+      updateStorageLayoutVersion(feature.layoutVersion());\n+      try {\n+        persistStorage();\n+      } catch (IOException e) {\n+        updateStorageLayoutVersion(prevLayoutVersion);\n+        logLayoutVersionUpdateFailureAndThrow(e);\n+      }\n+    }\n+\n+    private void putFinalizationMarkIntoVersionFile(OMLayoutFeature feature)\n+        throws OMException {\n+      try {\n+        emitUpgradeToLayoutVersionPersistingMsg(feature.name());\n+\n+        setUpgradeToLayoutVersionInStorage(feature.layoutVersion());\n+        persistStorage();\n+\n+        emitUpgradeToLayoutVersionPersistedMsg();\n+      } catch (IOException e) {\n+        logUpgradeToLayoutVersionPersistingFailureAndThrow(feature.name(), e);\n+      }\n+    }\n+\n+    private void removeFinalizationMarkFromVersionFile(OMLayoutFeature feature)\n+        throws OMException {\n+      try {\n+        emitRemovingUpgradeToLayoutVersionMsg(feature.name());\n+\n+        unsetUpgradeToLayoutVersionInStorage();\n+        persistStorage();\n+\n+        emitRemovedUpgradeToLayoutVersionMsg();\n+      } catch (IOException e) {\n+        logUpgradeToLayoutVersionRemovalFailureAndThrow(feature.name(), e);\n+      }\n+    }\n+\n+\n+\n+\n+\n+    private void setUpgradeToLayoutVersionInStorage(int version) {\n+      ozoneManager.getOmStorage().setUpgradeToLayoutVersion(version);\n+    }\n+\n+    private void unsetUpgradeToLayoutVersionInStorage() {\n+      ozoneManager.getOmStorage().unsetUpgradeToLayoutVersion();\n+    }\n+\n+    private int currentStoredLayoutVersion() {\n+      return ozoneManager.getOmStorage().getLayoutVersion();\n+    }\n+\n+    private void updateStorageLayoutVersion(int version) {\n+      ozoneManager.getOmStorage().setLayoutVersion(version);\n+    }\n+\n+    private void persistStorage() throws IOException {", "originalCommit": "2d8186c9072fe1025875541c713bbddd57d8499b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU1NjgxNg==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r503556816", "bodyText": "Storage and OMStorage chose to have an implementation for setters where the setter does not persist the change to the disk, these are the two that I have checked, and decided to remain consistent with this behaviour. This is the sole reason for controlling this from outside the Storage class implementation. Here it is extracted into a method to make it easier to follow the flow, and to hide the implementation detail of how to persist the storage from the reader when he reads the backbone of the internal logic of the methods with a higher layer in the abstractions.", "author": "fapifta", "createdAt": "2020-10-12T22:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzODczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU0MjI2Mg==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r503542262", "bodyText": "Line 54 has a debug log line left.", "author": "avijayanhwx", "createdAt": "2020-10-12T21:31:37Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/upgrade/OMFinalizeUpgradeRequest.java", "diffHunk": "@@ -63,11 +64,20 @@ public OMClientResponse validateAndUpdateCache(\n \n       String upgradeClientID = request.getUpgradeClientId();\n \n-      UpgradeFinalizationStatus status =\n+      StatusAndMessages omStatus =", "originalCommit": "2d8186c9072fe1025875541c713bbddd57d8499b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU1OTEyMw==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r503559123", "bodyText": "Nice catch, it seems I forgot to remove this one. I am pushing the deletion of this line.", "author": "fapifta", "createdAt": "2020-10-12T22:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU0MjI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU0ODc5NQ==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r503548795", "bodyText": "Just an observation. By the time we return 'STARTING_MSG' at 77, we are already done with Finalization right? Is this return message left as it is for a future refactoring through HDDS-3286 where async finalization will be done?", "author": "avijayanhwx", "createdAt": "2020-10-12T21:40:41Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.*;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.INVALID_REQUEST;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.PERSIST_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.REMOVE_UPGRADE_TO_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.UPDATE_LAYOUT_VERSION_FAILED;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+\n+/**\n+ * UpgradeFinalizer implementation for the Ozone Manager service.\n+ */\n+public class OMUpgradeFinalizer implements UpgradeFinalizer<OzoneManager> {\n+\n+  private  static final OmUpgradeAction NOOP = a -> {};\n+\n+  private OMLayoutVersionManagerImpl versionManager;\n+  private String clientID;\n+\n+  private Queue<String> msgs = new ConcurrentLinkedQueue<>();\n+  private boolean isDone = false;\n+\n+  public OMUpgradeFinalizer(OMLayoutVersionManagerImpl versionManager) {\n+    this.versionManager = versionManager;\n+  }\n+\n+  @Override\n+  public StatusAndMessages finalize(String upgradeClientID, OzoneManager om)\n+      throws IOException {\n+    if (!versionManager.needsFinalization()) {\n+      return FINALIZED_MSG;\n+    }\n+    clientID = upgradeClientID;\n+\n+// This requires some more investigation on how to do it properly while\n+// requests are on the fly, and post finalize features one by one.\n+// Until that is done, monitoring is not really doing anything meaningful\n+// but this is a tradoff we can take for the first iteration either if needed,\n+// as the finalization of the first few features should not take that long.\n+// Follow up JIRA is in HDDS-4286\n+//    String threadName = \"OzoneManager-Upgrade-Finalizer\";\n+//    ExecutorService executor =\n+//        Executors.newSingleThreadExecutor(r -> new Thread(threadName));\n+//    executor.submit(new Worker(om));\n+    new Worker(om).call();\n+    return STARTING_MSG;", "originalCommit": "2d8186c9072fe1025875541c713bbddd57d8499b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU1Mjk3Nw==", "url": "https://github.com/apache/ozone/pull/1456#discussion_r503552977", "bodyText": "yes, I did not wanted to change the overall flow of messages and statusas that I came up with, but technically at this point we already done in the current implementation.", "author": "fapifta", "createdAt": "2020-10-12T21:52:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU0ODc5NQ=="}], "type": "inlineReview"}, {"oid": "b00f2fffcfb0f325ee48c3748860830c0cc657a6", "url": "https://github.com/apache/ozone/commit/b00f2fffcfb0f325ee48c3748860830c0cc657a6", "message": "HDDS-4172. Implement Finalize command in Ozone Manager server.\n\nRemoved forgotten debug log on INFO level from OMFinalizeUpgradeRequest.", "committedDate": "2020-10-12T22:09:52Z", "type": "commit"}]}