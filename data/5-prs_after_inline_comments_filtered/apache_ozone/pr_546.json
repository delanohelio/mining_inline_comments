{"pr_number": 546, "pr_title": "HDDS-2847. Add Recon tasks for tracking missing containers (FSCK) and syncing deleted pipelines from SCM.", "pr_createdAt": "2020-02-12T00:23:50Z", "pr_url": "https://github.com/apache/ozone/pull/546", "timeline": [{"oid": "4d04c0e18528b0f08b1cc42e2cb0d2579a74cab7", "url": "https://github.com/apache/ozone/commit/4d04c0e18528b0f08b1cc42e2cb0d2579a74cab7", "message": "HDDS-2847. Recon should track containers that are missing along with corresponding keys (FSCK).", "committedDate": "2020-02-12T05:25:48Z", "type": "commit"}, {"oid": "4d04c0e18528b0f08b1cc42e2cb0d2579a74cab7", "url": "https://github.com/apache/ozone/commit/4d04c0e18528b0f08b1cc42e2cb0d2579a74cab7", "message": "HDDS-2847. Recon should track containers that are missing along with corresponding keys (FSCK).", "committedDate": "2020-02-12T05:25:48Z", "type": "forcePushed"}, {"oid": "d781f2ef0228468dada411c4a3729791ea9ebeb8", "url": "https://github.com/apache/ozone/commit/d781f2ef0228468dada411c4a3729791ea9ebeb8", "message": "HDDS-2847. Cleanup & Fix Recon integration test", "committedDate": "2020-02-12T23:41:22Z", "type": "commit"}, {"oid": "6ca146083f7d48c37a45405cc19efbcbd8a262ca", "url": "https://github.com/apache/ozone/commit/6ca146083f7d48c37a45405cc19efbcbd8a262ca", "message": "HDDS-2847. Fix unit test.", "committedDate": "2020-02-13T00:25:24Z", "type": "commit"}, {"oid": "7f2aed37eab9c4802608e8fecc89fb13d8d36683", "url": "https://github.com/apache/ozone/commit/7f2aed37eab9c4802608e8fecc89fb13d8d36683", "message": "HDDS-2847. Fix issues in Missing Container Task.", "committedDate": "2020-02-13T22:00:15Z", "type": "commit"}, {"oid": "cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "url": "https://github.com/apache/ozone/commit/cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "message": "HDDS-2847. Fix checkstyle.", "committedDate": "2020-02-13T22:43:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczMzk2NQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379733965", "bodyText": "Minor code org nit: Possibly doesn't belong in this class.", "author": "swagle", "createdAt": "2020-02-15T05:03:55Z", "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/schema/UtilizationSchemaDefinition.java", "diffHunk": "@@ -77,4 +81,13 @@ void createFileSizeCount(Connection conn) {\n             .primaryKey(\"file_size\"))\n         .execute();\n   }\n+\n+  void createMissingContainersTable(Connection conn) {", "originalCommit": "cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNDI0Mg==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379734242", "bodyText": "Index on timestamp for lookups?", "author": "swagle", "createdAt": "2020-02-15T05:04:37Z", "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/schema/UtilizationSchemaDefinition.java", "diffHunk": "@@ -77,4 +81,13 @@ void createFileSizeCount(Connection conn) {\n             .primaryKey(\"file_size\"))\n         .execute();\n   }\n+\n+  void createMissingContainersTable(Connection conn) {\n+    DSL.using(conn).createTableIfNotExists(MISSING_CONTAINERS_TABLE_NAME)\n+        .column(\"container_id\", SQLDataType.BIGINT)\n+        .column(\"missing_since\", SQLDataType.BIGINT)", "originalCommit": "cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNjE1NQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379736155", "bodyText": "Why don't we inject DAOs?", "author": "swagle", "createdAt": "2020-02-15T05:10:11Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.fsck;\n+\n+import java.util.Set;\n+\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerManager;\n+import org.apache.hadoop.hdds.scm.container.ContainerNotFoundException;\n+import org.apache.hadoop.hdds.scm.container.ContainerReplica;\n+import org.apache.hadoop.hdds.scm.server.OzoneStorageContainerManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconStorageContainerManagerFacade;\n+import org.apache.hadoop.util.ExitUtil;\n+import org.apache.hadoop.util.Time;\n+import org.hadoop.ozone.recon.schema.tables.daos.MissingContainersDao;\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.MissingContainers;\n+import org.hadoop.ozone.recon.schema.tables.pojos.ReconTaskStatus;\n+import org.jooq.Configuration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.util.CollectionUtils;\n+\n+/**\n+ * Class that scans the list of containers and keeps track of containers with\n+ * no replicas in a SQL table.\n+ */\n+public class MissingContainerTask {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(MissingContainerTask.class);\n+\n+  private OzoneStorageContainerManager scm;\n+  private MissingContainersDao missingContainersDao;\n+  private ReconTaskStatusDao reconTaskStatusDao;\n+  private static final long INTERVAL = 5 * 60 * 1000L;\n+\n+  private Thread fsckMonitor;\n+  private volatile boolean running;\n+\n+  public MissingContainerTask(ReconStorageContainerManagerFacade scm,\n+                              Configuration sqlConfiguration) {\n+    this.scm = scm;\n+    this.missingContainersDao = new MissingContainersDao(sqlConfiguration);", "originalCommit": "cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNjc5Mg==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379736792", "bodyText": "Code with side effects should be in a lifecycle method that can throw checked exceptions, why not move this to start?", "author": "swagle", "createdAt": "2020-02-15T05:11:50Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.fsck;\n+\n+import java.util.Set;\n+\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerManager;\n+import org.apache.hadoop.hdds.scm.container.ContainerNotFoundException;\n+import org.apache.hadoop.hdds.scm.container.ContainerReplica;\n+import org.apache.hadoop.hdds.scm.server.OzoneStorageContainerManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconStorageContainerManagerFacade;\n+import org.apache.hadoop.util.ExitUtil;\n+import org.apache.hadoop.util.Time;\n+import org.hadoop.ozone.recon.schema.tables.daos.MissingContainersDao;\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.MissingContainers;\n+import org.hadoop.ozone.recon.schema.tables.pojos.ReconTaskStatus;\n+import org.jooq.Configuration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.util.CollectionUtils;\n+\n+/**\n+ * Class that scans the list of containers and keeps track of containers with\n+ * no replicas in a SQL table.\n+ */\n+public class MissingContainerTask {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(MissingContainerTask.class);\n+\n+  private OzoneStorageContainerManager scm;\n+  private MissingContainersDao missingContainersDao;\n+  private ReconTaskStatusDao reconTaskStatusDao;\n+  private static final long INTERVAL = 5 * 60 * 1000L;\n+\n+  private Thread fsckMonitor;\n+  private volatile boolean running;\n+\n+  public MissingContainerTask(ReconStorageContainerManagerFacade scm,\n+                              Configuration sqlConfiguration) {\n+    this.scm = scm;\n+    this.missingContainersDao = new MissingContainersDao(sqlConfiguration);\n+    this.reconTaskStatusDao = new ReconTaskStatusDao(sqlConfiguration);\n+    String taskName = getClass().getSimpleName();\n+    ReconTaskStatus reconTaskStatusRecord = new ReconTaskStatus(\n+        taskName, 0L, 0L);\n+    if (!reconTaskStatusDao.existsById(taskName)) {", "originalCommit": "cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0NzU5MQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379747591", "bodyText": "Agreed, will move it.", "author": "avijayanhwx", "createdAt": "2020-02-15T05:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNjc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNzAxMQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379737011", "bodyText": "Why not use a single-threaded executor?", "author": "swagle", "createdAt": "2020-02-15T05:12:25Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.fsck;\n+\n+import java.util.Set;\n+\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerManager;\n+import org.apache.hadoop.hdds.scm.container.ContainerNotFoundException;\n+import org.apache.hadoop.hdds.scm.container.ContainerReplica;\n+import org.apache.hadoop.hdds.scm.server.OzoneStorageContainerManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconStorageContainerManagerFacade;\n+import org.apache.hadoop.util.ExitUtil;\n+import org.apache.hadoop.util.Time;\n+import org.hadoop.ozone.recon.schema.tables.daos.MissingContainersDao;\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.MissingContainers;\n+import org.hadoop.ozone.recon.schema.tables.pojos.ReconTaskStatus;\n+import org.jooq.Configuration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.util.CollectionUtils;\n+\n+/**\n+ * Class that scans the list of containers and keeps track of containers with\n+ * no replicas in a SQL table.\n+ */\n+public class MissingContainerTask {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(MissingContainerTask.class);\n+\n+  private OzoneStorageContainerManager scm;\n+  private MissingContainersDao missingContainersDao;\n+  private ReconTaskStatusDao reconTaskStatusDao;\n+  private static final long INTERVAL = 5 * 60 * 1000L;\n+\n+  private Thread fsckMonitor;\n+  private volatile boolean running;\n+\n+  public MissingContainerTask(ReconStorageContainerManagerFacade scm,\n+                              Configuration sqlConfiguration) {\n+    this.scm = scm;\n+    this.missingContainersDao = new MissingContainersDao(sqlConfiguration);\n+    this.reconTaskStatusDao = new ReconTaskStatusDao(sqlConfiguration);\n+    String taskName = getClass().getSimpleName();\n+    ReconTaskStatus reconTaskStatusRecord = new ReconTaskStatus(\n+        taskName, 0L, 0L);\n+    if (!reconTaskStatusDao.existsById(taskName)) {\n+      reconTaskStatusDao.insert(reconTaskStatusRecord);\n+      LOG.info(\"Registered {} task \", taskName);\n+    }\n+  }\n+\n+  public void start() {\n+    if (!isRunning()) {\n+      LOG.info(\"Starting Missing Container Monitor Thread.\");\n+      running = true;\n+      fsckMonitor = new Thread(this::run);", "originalCommit": "cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0NzU0MA==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379747540", "bodyText": "Since this is very similar to the ReplicationManager, I borrowed the code from there.", "author": "avijayanhwx", "createdAt": "2020-02-15T05:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNzAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNzYzNA==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379737634", "bodyText": "start() should also be synchronized.", "author": "swagle", "createdAt": "2020-02-15T05:14:04Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.fsck;\n+\n+import java.util.Set;\n+\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerManager;\n+import org.apache.hadoop.hdds.scm.container.ContainerNotFoundException;\n+import org.apache.hadoop.hdds.scm.container.ContainerReplica;\n+import org.apache.hadoop.hdds.scm.server.OzoneStorageContainerManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconStorageContainerManagerFacade;\n+import org.apache.hadoop.util.ExitUtil;\n+import org.apache.hadoop.util.Time;\n+import org.hadoop.ozone.recon.schema.tables.daos.MissingContainersDao;\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.MissingContainers;\n+import org.hadoop.ozone.recon.schema.tables.pojos.ReconTaskStatus;\n+import org.jooq.Configuration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.util.CollectionUtils;\n+\n+/**\n+ * Class that scans the list of containers and keeps track of containers with\n+ * no replicas in a SQL table.\n+ */\n+public class MissingContainerTask {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(MissingContainerTask.class);\n+\n+  private OzoneStorageContainerManager scm;\n+  private MissingContainersDao missingContainersDao;\n+  private ReconTaskStatusDao reconTaskStatusDao;\n+  private static final long INTERVAL = 5 * 60 * 1000L;\n+\n+  private Thread fsckMonitor;\n+  private volatile boolean running;\n+\n+  public MissingContainerTask(ReconStorageContainerManagerFacade scm,\n+                              Configuration sqlConfiguration) {\n+    this.scm = scm;\n+    this.missingContainersDao = new MissingContainersDao(sqlConfiguration);\n+    this.reconTaskStatusDao = new ReconTaskStatusDao(sqlConfiguration);\n+    String taskName = getClass().getSimpleName();\n+    ReconTaskStatus reconTaskStatusRecord = new ReconTaskStatus(\n+        taskName, 0L, 0L);\n+    if (!reconTaskStatusDao.existsById(taskName)) {\n+      reconTaskStatusDao.insert(reconTaskStatusRecord);\n+      LOG.info(\"Registered {} task \", taskName);\n+    }\n+  }\n+\n+  public void start() {", "originalCommit": "cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0Njk1OQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379746959", "bodyText": "Good catch, will fix it.", "author": "avijayanhwx", "createdAt": "2020-02-15T05:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNzYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0MDQ0Ng==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379740446", "bodyText": "Is that necessarily true for Recon, could there be a benign problem that we could recover from?", "author": "swagle", "createdAt": "2020-02-15T05:22:18Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.fsck;\n+\n+import java.util.Set;\n+\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerManager;\n+import org.apache.hadoop.hdds.scm.container.ContainerNotFoundException;\n+import org.apache.hadoop.hdds.scm.container.ContainerReplica;\n+import org.apache.hadoop.hdds.scm.server.OzoneStorageContainerManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconStorageContainerManagerFacade;\n+import org.apache.hadoop.util.ExitUtil;\n+import org.apache.hadoop.util.Time;\n+import org.hadoop.ozone.recon.schema.tables.daos.MissingContainersDao;\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.MissingContainers;\n+import org.hadoop.ozone.recon.schema.tables.pojos.ReconTaskStatus;\n+import org.jooq.Configuration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.util.CollectionUtils;\n+\n+/**\n+ * Class that scans the list of containers and keeps track of containers with\n+ * no replicas in a SQL table.\n+ */\n+public class MissingContainerTask {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(MissingContainerTask.class);\n+\n+  private OzoneStorageContainerManager scm;\n+  private MissingContainersDao missingContainersDao;\n+  private ReconTaskStatusDao reconTaskStatusDao;\n+  private static final long INTERVAL = 5 * 60 * 1000L;\n+\n+  private Thread fsckMonitor;\n+  private volatile boolean running;\n+\n+  public MissingContainerTask(ReconStorageContainerManagerFacade scm,\n+                              Configuration sqlConfiguration) {\n+    this.scm = scm;\n+    this.missingContainersDao = new MissingContainersDao(sqlConfiguration);\n+    this.reconTaskStatusDao = new ReconTaskStatusDao(sqlConfiguration);\n+    String taskName = getClass().getSimpleName();\n+    ReconTaskStatus reconTaskStatusRecord = new ReconTaskStatus(\n+        taskName, 0L, 0L);\n+    if (!reconTaskStatusDao.existsById(taskName)) {\n+      reconTaskStatusDao.insert(reconTaskStatusRecord);\n+      LOG.info(\"Registered {} task \", taskName);\n+    }\n+  }\n+\n+  public void start() {\n+    if (!isRunning()) {\n+      LOG.info(\"Starting Missing Container Monitor Thread.\");\n+      running = true;\n+      fsckMonitor = new Thread(this::run);\n+      fsckMonitor.setName(\"MissingContainerMonitor\");\n+      fsckMonitor.setDaemon(true);\n+      fsckMonitor.start();\n+    } else {\n+      LOG.info(\"Missing Container Monitor Thread is already running.\");\n+    }\n+  }\n+\n+  /**\n+   * Stops Replication Monitor thread.\n+   */\n+  public synchronized void stop() {\n+    if (running) {\n+      LOG.info(\"Stopping Missing Container Monitor Thread.\");\n+      running = false;\n+      notifyAll();\n+    } else {\n+      LOG.info(\"Missing Container Monitor Thread is not running.\");\n+    }\n+  }\n+\n+  public synchronized void run() {\n+    try {\n+      while (running) {\n+        long start = Time.monotonicNow();\n+        long currentTime = System.currentTimeMillis();\n+        ContainerManager containerManager = scm.getContainerManager();\n+        final Set<ContainerID> containerIds =\n+            containerManager.getContainerIDs();\n+        containerManager.getContainerIDs().forEach(containerID ->\n+            processContainer(containerID, currentTime));\n+\n+        LOG.info(\"Missing Container Monitor Thread took {} milliseconds for\" +\n+                \" processing {} containers.\", Time.monotonicNow() - start,\n+            containerIds.size());\n+        wait(INTERVAL);\n+      }\n+    } catch (Throwable t) {\n+      // When we get runtime exception, we should terminate SCM.\n+      LOG.error(\"Exception in Replication Monitor Thread.\", t);", "originalCommit": "cbf5fefb43d6a2adbfe7ee5d13af381ce5ac3a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0NzA0NQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r379747045", "bodyText": "We dont need to terminate Recon. Will remove it.", "author": "avijayanhwx", "createdAt": "2020-02-15T05:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0MDQ0Ng=="}], "type": "inlineReview"}, {"oid": "0705d5ed5d62cebd416a85b9d3985df560911cf5", "url": "https://github.com/apache/ozone/commit/0705d5ed5d62cebd416a85b9d3985df560911cf5", "message": "HDDS-2847. Add Recon tasks for tracking missing containers and syncing piplines from SCM.", "committedDate": "2020-02-18T09:08:01Z", "type": "commit"}, {"oid": "0705d5ed5d62cebd416a85b9d3985df560911cf5", "url": "https://github.com/apache/ozone/commit/0705d5ed5d62cebd416a85b9d3985df560911cf5", "message": "HDDS-2847. Add Recon tasks for tracking missing containers and syncing piplines from SCM.", "committedDate": "2020-02-18T09:08:01Z", "type": "forcePushed"}, {"oid": "33f115a65675e4e0f6cc53a2607f7bbc79e469c4", "url": "https://github.com/apache/ozone/commit/33f115a65675e4e0f6cc53a2607f7bbc79e469c4", "message": "Fix issues in storing task status.", "committedDate": "2020-02-18T17:50:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1MDcxMA==", "url": "https://github.com/apache/ozone/pull/546#discussion_r380850710", "bodyText": "AFAIK, DAOs are in-expensive to create so enforcing Singleton's might be an anti-pattern.", "author": "swagle", "createdAt": "2020-02-18T18:20:09Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/ReconControllerModule.java", "diffHunk": "@@ -96,6 +106,34 @@ protected void configure() {\n         .to(ReconStorageContainerManagerFacade.class).in(Singleton.class);\n   }\n \n+  @Provides\n+  @Singleton", "originalCommit": "33f115a65675e4e0f6cc53a2607f7bbc79e469c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2NzcyNg==", "url": "https://github.com/apache/ozone/pull/546#discussion_r380967726", "bodyText": "Fixed.", "author": "avijayanhwx", "createdAt": "2020-02-18T22:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1MDcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4ODk4Ng==", "url": "https://github.com/apache/ozone/pull/546#discussion_r380888986", "bodyText": "Looks like too many LOG.info messages!", "author": "swagle", "createdAt": "2020-02-18T19:33:24Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconContainerReportHandler.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.scm;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import org.apache.hadoop.hdds.protocol.proto.StorageContainerDatanodeProtocolProtos.ContainerReplicaProto;\n+import org.apache.hadoop.hdds.protocol.proto.StorageContainerDatanodeProtocolProtos.ContainerReportsProto;\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerManager;\n+import org.apache.hadoop.hdds.scm.container.ContainerReportHandler;\n+import org.apache.hadoop.hdds.scm.container.common.helpers.ContainerWithPipeline;\n+import org.apache.hadoop.hdds.scm.node.NodeManager;\n+import org.apache.hadoop.hdds.scm.server.SCMDatanodeHeartbeatDispatcher.ContainerReportFromDatanode;\n+import org.apache.hadoop.hdds.server.events.EventPublisher;\n+import org.apache.hadoop.ozone.recon.spi.StorageContainerServiceProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Recon's container report handler.\n+ */\n+public class ReconContainerReportHandler extends ContainerReportHandler {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(ReconContainerReportHandler.class);\n+  private StorageContainerServiceProvider scmClient;\n+\n+  public ReconContainerReportHandler(NodeManager nodeManager,\n+                                     ContainerManager containerManager,\n+                                     StorageContainerServiceProvider scm) {\n+    super(nodeManager, containerManager);\n+    this.scmClient = scm;\n+  }\n+\n+  @Override\n+  public void onMessage(final ContainerReportFromDatanode reportFromDatanode,\n+                        final EventPublisher publisher) {\n+\n+    final ContainerReportsProto containerReport =\n+        reportFromDatanode.getReport();\n+    ReconContainerManager containerManager =\n+        (ReconContainerManager) getContainerManager();\n+\n+    List<ContainerReplicaProto> reportsList = containerReport.getReportsList();\n+    for (ContainerReplicaProto containerReplicaProto : reportsList) {\n+      final ContainerID id = ContainerID.valueof(\n+          containerReplicaProto.getContainerID());\n+      if (!getContainerManager().exists(id)) {\n+        LOG.info(\"New container {} got from {}.\", id,\n+            reportFromDatanode.getDatanodeDetails());\n+        try {\n+          ContainerWithPipeline containerWithPipeline =\n+              scmClient.getContainerWithPipeline(id.getId());\n+          LOG.info(\"Verified new container from SCM {} \",", "originalCommit": "33f115a65675e4e0f6cc53a2607f7bbc79e469c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2NzY5Nw==", "url": "https://github.com/apache/ozone/pull/546#discussion_r380967697", "bodyText": "Fixed.", "author": "avijayanhwx", "createdAt": "2020-02-18T22:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4ODk4Ng=="}], "type": "inlineReview"}, {"oid": "77f2ee0a9e96e4aff503e0482c989d87c0687c68", "url": "https://github.com/apache/ozone/commit/77f2ee0a9e96e4aff503e0482c989d87c0687c68", "message": "HDDS-2847. Address review comments.", "committedDate": "2020-02-18T22:12:25Z", "type": "commit"}, {"oid": "6f4bba09d4634da93ea4cdb30fc39dbf4bbf9b0c", "url": "https://github.com/apache/ozone/commit/6f4bba09d4634da93ea4cdb30fc39dbf4bbf9b0c", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-2847-master", "committedDate": "2020-02-19T05:13:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1MDU4MA==", "url": "https://github.com/apache/ozone/pull/546#discussion_r381550580", "bodyText": "Shouldn't this process containerIds instead of getting the set again?", "author": "adoroszlai", "createdAt": "2020-02-19T21:19:41Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.fsck;\n+\n+import java.util.Set;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerManager;\n+import org.apache.hadoop.hdds.scm.container.ContainerNotFoundException;\n+import org.apache.hadoop.hdds.scm.container.ContainerReplica;\n+import org.apache.hadoop.hdds.scm.server.OzoneStorageContainerManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconScmTask;\n+import org.apache.hadoop.util.Time;\n+import org.hadoop.ozone.recon.schema.tables.daos.MissingContainersDao;\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.MissingContainers;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.util.CollectionUtils;\n+\n+/**\n+ * Class that scans the list of containers and keeps track of containers with\n+ * no replicas in a SQL table.\n+ */\n+public class MissingContainerTask extends ReconScmTask {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(MissingContainerTask.class);\n+\n+  private ContainerManager containerManager;\n+  private MissingContainersDao missingContainersDao;\n+  private static final long INTERVAL = 5 * 60 * 1000L;\n+\n+  @Inject\n+  public MissingContainerTask(\n+      OzoneStorageContainerManager ozoneStorageContainerManager,\n+      ReconTaskStatusDao reconTaskStatusDao,\n+      MissingContainersDao missingContainersDao) {\n+    super(reconTaskStatusDao);\n+    this.missingContainersDao = missingContainersDao;\n+    this.containerManager = ozoneStorageContainerManager.getContainerManager();\n+  }\n+\n+  public synchronized void run() {\n+    try {\n+      while (canRun()) {\n+        long start = Time.monotonicNow();\n+        long currentTime = System.currentTimeMillis();\n+        final Set<ContainerID> containerIds =\n+            containerManager.getContainerIDs();\n+        containerManager.getContainerIDs().forEach(containerID ->", "originalCommit": "6f4bba09d4634da93ea4cdb30fc39dbf4bbf9b0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5NDgwMQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r381594801", "bodyText": "Will fix it.", "author": "avijayanhwx", "createdAt": "2020-02-19T22:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1MDU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1MTk0OA==", "url": "https://github.com/apache/ozone/pull/546#discussion_r381551948", "bodyText": "Do we need to always create ReconTaskStatus, or only if it is being inserted?", "author": "adoroszlai", "createdAt": "2020-02-19T21:22:35Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconScmTask.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.scm;\n+\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.ReconTaskStatus;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.inject.Inject;\n+\n+/**\n+ * Any background task that keeps SCM's metadata up to date.\n+ */\n+public abstract class ReconScmTask {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ReconScmTask.class);\n+  private Thread taskThread;\n+  private ReconTaskStatusDao reconTaskStatusDao;\n+  private volatile boolean running;\n+\n+  @Inject\n+  public ReconScmTask(ReconTaskStatusDao reconTaskStatusDao) {\n+    this.reconTaskStatusDao = reconTaskStatusDao;\n+  }\n+\n+  public void register() {\n+    String taskName = getClass().getSimpleName();\n+    ReconTaskStatus reconTaskStatusRecord = new ReconTaskStatus(\n+        taskName, 0L, 0L);\n+    if (!reconTaskStatusDao.existsById(taskName)) {\n+      reconTaskStatusDao.insert(reconTaskStatusRecord);", "originalCommit": "6f4bba09d4634da93ea4cdb30fc39dbf4bbf9b0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5NDE5NQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r381594195", "bodyText": "Good catch, will fix it.", "author": "avijayanhwx", "createdAt": "2020-02-19T22:53:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1MTk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1MjgyNA==", "url": "https://github.com/apache/ozone/pull/546#discussion_r381552824", "bodyText": "Leftover comment.", "author": "adoroszlai", "createdAt": "2020-02-19T21:24:23Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconScmTask.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.scm;\n+\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.ReconTaskStatus;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.inject.Inject;\n+\n+/**\n+ * Any background task that keeps SCM's metadata up to date.\n+ */\n+public abstract class ReconScmTask {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ReconScmTask.class);\n+  private Thread taskThread;\n+  private ReconTaskStatusDao reconTaskStatusDao;\n+  private volatile boolean running;\n+\n+  @Inject\n+  public ReconScmTask(ReconTaskStatusDao reconTaskStatusDao) {\n+    this.reconTaskStatusDao = reconTaskStatusDao;\n+  }\n+\n+  public void register() {\n+    String taskName = getClass().getSimpleName();\n+    ReconTaskStatus reconTaskStatusRecord = new ReconTaskStatus(\n+        taskName, 0L, 0L);\n+    if (!reconTaskStatusDao.existsById(taskName)) {\n+      reconTaskStatusDao.insert(reconTaskStatusRecord);\n+      LOG.info(\"Registered {} task \", taskName);\n+    }\n+  }\n+\n+  public synchronized void start() {\n+    if (!isRunning()) {\n+      LOG.info(\"Starting {} Thread.\", getTaskName());\n+      running = true;\n+      taskThread = new Thread(this::run);\n+      taskThread.setName(getTaskName());\n+      taskThread.setDaemon(true);\n+      taskThread.start();\n+    } else {\n+      LOG.info(\"{} Thread is already running.\", getTaskName());\n+    }\n+  }\n+\n+  /**\n+   * Stops Replication Monitor thread.", "originalCommit": "6f4bba09d4634da93ea4cdb30fc39dbf4bbf9b0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5Mzc1Ng==", "url": "https://github.com/apache/ozone/pull/546#discussion_r381593756", "bodyText": "Will remove.", "author": "avijayanhwx", "createdAt": "2020-02-19T22:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1MjgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1NzQ4OQ==", "url": "https://github.com/apache/ozone/pull/546#discussion_r381557489", "bodyText": "I think UnsupportedOperationException would be more appropriate.\nAlso, what about the other create method below?", "author": "adoroszlai", "createdAt": "2020-02-19T21:33:48Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconPipelineFactory.java", "diffHunk": "@@ -48,8 +48,8 @@\n \n     @Override\n     public Pipeline create(HddsProtos.ReplicationFactor factor){\n-      LOG.warn(\"Trying to create pipeline in Recon, which is prohibited!\");\n-      return null;\n+      throw new RuntimeException(", "originalCommit": "6f4bba09d4634da93ea4cdb30fc39dbf4bbf9b0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5NDM2NA==", "url": "https://github.com/apache/ozone/pull/546#discussion_r381594364", "bodyText": "Good catch, will add it.", "author": "avijayanhwx", "createdAt": "2020-02-19T22:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1NzQ4OQ=="}], "type": "inlineReview"}]}