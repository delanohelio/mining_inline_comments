{"pr_number": 906, "pr_title": "HDDS-3494. Implement ofs://: Support volume and bucket deletion", "pr_createdAt": "2020-05-08T18:18:46Z", "pr_url": "https://github.com/apache/ozone/pull/906", "timeline": [{"oid": "763ba21ea27fb511c163db27ad79a27dc79ec98d", "url": "https://github.com/apache/ozone/commit/763ba21ea27fb511c163db27ad79a27dc79ec98d", "message": "HDDS-3494. Implement ofs://: Support volume and bucket deletion\n\n(cherry picked from commit ac2ffc239b153cbfe54b42fc06c4c5966e131d3e)", "committedDate": "2020-05-08T18:16:04Z", "type": "commit"}, {"oid": "dae6acde081a01ee18d676fa14b864890a55bfc7", "url": "https://github.com/apache/ozone/commit/dae6acde081a01ee18d676fa14b864890a55bfc7", "message": "Improve code readability.\n\n(cherry picked from commit a4fb02933f1d5c103d40561bfe84391b0796aaa8)", "committedDate": "2020-05-08T18:16:20Z", "type": "commit"}, {"oid": "c76532e7660ae0a3aec0bca36dae4f1ea0510135", "url": "https://github.com/apache/ozone/commit/c76532e7660ae0a3aec0bca36dae4f1ea0510135", "message": "Non-recursively deleting volume or bucket should throw PathIsNotEmptyDirectoryException when they are not empty.", "committedDate": "2020-05-12T18:23:08Z", "type": "commit"}, {"oid": "188e06c71937f80a024b82fe7adff6a3cc90bcee", "url": "https://github.com/apache/ozone/commit/188e06c71937f80a024b82fe7adff6a3cc90bcee", "message": "Fix NPE in delete() where getFileStatus() can return null when a volume doesn't exist.", "committedDate": "2020-05-12T18:23:54Z", "type": "commit"}, {"oid": "9716c3b18343c07247951d4f787198ba136a5b91", "url": "https://github.com/apache/ozone/commit/9716c3b18343c07247951d4f787198ba136a5b91", "message": "Add testDeleteVolumeAndBucket.", "committedDate": "2020-05-12T18:24:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc0MTkyNw==", "url": "https://github.com/apache/ozone/pull/906#discussion_r424741927", "bodyText": "Replace the rm root logic with a warning. Effectively disallowing admin to use rm -r / to clear the cluster.\nAdmins should re-init the cluster if they really want to clear the cluster.", "author": "smengcl", "createdAt": "2020-05-13T21:28:53Z", "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -469,15 +478,76 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n         return false;\n       }\n \n+      OFSPath ofsPath = new OFSPath(key);\n+\n+      // Handle rm root\n+      if (ofsPath.isRoot()) {\n+        Iterator<? extends OzoneVolume> it =\n+            adapterImpl.getObjectStore().listVolumes(\"\");\n+        while (it.hasNext()) {\n+          OzoneVolume volume = it.next();\n+          String nextVolume = addTrailingSlashIfNeeded(\n+              f.toString()) + volume.getName();\n+          delete(new Path(nextVolume), true);\n+        }", "originalCommit": "9716c3b18343c07247951d4f787198ba136a5b91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a8fea368bb67c72a9679845f23664c53d7e1be9", "url": "https://github.com/apache/ozone/commit/8a8fea368bb67c72a9679845f23664c53d7e1be9", "message": "Drop support for rm root.", "committedDate": "2020-05-13T21:58:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2NzYwNg==", "url": "https://github.com/apache/ozone/pull/906#discussion_r424867606", "bodyText": "Before this there is a root validation.\nif (key.equals(\"/\")) {\nLOG.warn(\"Cannot delete root directory.\");\nreturn false;\n}\nIs this above check still needed?", "author": "umamaheswararao", "createdAt": "2020-05-14T04:43:20Z", "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -469,15 +478,72 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n         return false;\n       }\n \n+      OFSPath ofsPath = new OFSPath(key);\n+", "originalCommit": "8a8fea368bb67c72a9679845f23664c53d7e1be9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM2MDkxNw==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425360917", "bodyText": "Yes. Unfortunately I found that the original check is broken. we might just want to remove it:\n$ ozone fs -rm -r ofs://omservice/\n2020-05-14 18:51:50 INFO  deprecation:1394 - io.bytes.per.checksum is deprecated. Instead, use dfs.bytes-per-checksum\n2020-05-14 18:51:50 INFO  BasicRootedOzoneFileSystem:476 - delete: key =\n2020-05-14 18:51:50 WARN  BasicRootedOzoneFileSystem:488 - delete: OFS does not support rm root. To wipe the cluster, please re-init OM instead.\nrm: `ofs://omservice/': Input/output error\n\naddTrailingSlashIfNeeded doesn't really add '/' to empty string (root).\nalso I noticed the Input/output error part. looking into it. IMO the Input/output error should be fine. Seems like hadoop common Delete.java throws when fs.delete returns false. Not much I can do on the FileSystem side, unless we want to return true for rm root.", "author": "smengcl", "createdAt": "2020-05-14T18:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2NzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM2NDI4NQ==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425364285", "bodyText": "Indeed for o3fs this logic is fixed in HDDS-2973: d1b8c08#diff-e48c4ce6b86d4a33c3f38ba8d6d06ea3R442", "author": "smengcl", "createdAt": "2020-05-14T18:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2NzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM5Mzc0Ng==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425393746", "bodyText": "I will remove the buggy check logic.", "author": "smengcl", "createdAt": "2020-05-14T19:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2NzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQxNjUxNw==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425416517", "bodyText": "done in 5b5b7ca", "author": "smengcl", "createdAt": "2020-05-14T20:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2NzYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2ODIxNg==", "url": "https://github.com/apache/ozone/pull/906#discussion_r424868216", "bodyText": "I think we can do this addTrailingSlashIfNeeded(f.toString()) outside of loop once?\npath.toString also does lot of conversions. we can avoid that if we do it outside loop", "author": "umamaheswararao", "createdAt": "2020-05-14T04:45:56Z", "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -469,15 +478,72 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n         return false;\n       }\n \n+      OFSPath ofsPath = new OFSPath(key);\n+\n+      // Handle rm root\n+      if (ofsPath.isRoot()) {\n+        // Intentionally drop support for rm root\n+        // because it is too dangerous and doesn't provide much value\n+        LOG.warn(\"delete: OFS does not support rm root. \"\n+            + \"To wipe the cluster, please re-init OM instead.\");\n+        return false;\n+      }\n+\n+      // Handle delete volume\n+      if (ofsPath.isVolume()) {\n+        String volumeName = ofsPath.getVolumeName();\n+        if (recursive) {\n+          // Delete all buckets first\n+          OzoneVolume volume =\n+              adapterImpl.getObjectStore().getVolume(volumeName);\n+          Iterator<? extends OzoneBucket> it = volume.listBuckets(\"\");\n+          while (it.hasNext()) {\n+            OzoneBucket bucket = it.next();", "originalCommit": "8a8fea368bb67c72a9679845f23664c53d7e1be9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM5NTc2Ng==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425395766", "bodyText": "done", "author": "smengcl", "createdAt": "2020-05-14T19:59:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2ODIxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzAzMA==", "url": "https://github.com/apache/ozone/pull/906#discussion_r424873030", "bodyText": "Why is this? Do you mind explaining why do we need to create parent dir. Parent dir should not have deleted right? I know its not related to this change, but just for my understanding.", "author": "umamaheswararao", "createdAt": "2020-05-14T05:06:13Z", "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -469,15 +478,72 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n         return false;\n       }\n \n+      OFSPath ofsPath = new OFSPath(key);\n+\n+      // Handle rm root\n+      if (ofsPath.isRoot()) {\n+        // Intentionally drop support for rm root\n+        // because it is too dangerous and doesn't provide much value\n+        LOG.warn(\"delete: OFS does not support rm root. \"\n+            + \"To wipe the cluster, please re-init OM instead.\");\n+        return false;\n+      }\n+\n+      // Handle delete volume\n+      if (ofsPath.isVolume()) {\n+        String volumeName = ofsPath.getVolumeName();\n+        if (recursive) {\n+          // Delete all buckets first\n+          OzoneVolume volume =\n+              adapterImpl.getObjectStore().getVolume(volumeName);\n+          Iterator<? extends OzoneBucket> it = volume.listBuckets(\"\");\n+          while (it.hasNext()) {\n+            OzoneBucket bucket = it.next();\n+            String nextBucket = addTrailingSlashIfNeeded(\n+                f.toString()) + bucket.getName();\n+            delete(new Path(nextBucket), true);\n+          }\n+        }\n+        try {\n+          adapterImpl.getObjectStore().deleteVolume(volumeName);\n+          return true;\n+        } catch (OMException ex) {\n+          // volume is not empty\n+          if (ex.getResult() == VOLUME_NOT_EMPTY) {\n+            throw new PathIsNotEmptyDirectoryException(f.toString());\n+          } else {\n+            throw ex;\n+          }\n+        }\n+      }\n+\n       result = innerDelete(f, recursive);\n+\n+      // Handle delete bucket\n+      if (ofsPath.isBucket()) {\n+        OzoneVolume volume =\n+            adapterImpl.getObjectStore().getVolume(ofsPath.getVolumeName());\n+        try {\n+          volume.deleteBucket(ofsPath.getBucketName());\n+          return result;\n+        } catch (OMException ex) {\n+          // bucket is not empty\n+          if (ex.getResult() == BUCKET_NOT_EMPTY) {\n+            throw new PathIsNotEmptyDirectoryException(f.toString());\n+          } else {\n+            throw ex;\n+          }\n+        }\n+      }\n+\n     } else {\n       LOG.debug(\"delete: Path is a file: {}\", f);\n       result = adapter.deleteObject(key);\n     }\n \n     if (result) {\n       // If this delete operation removes all files/directories from the\n-      // parent direcotry, then an empty parent directory must be created.\n+      // parent directory, then an empty parent directory must be created.", "originalCommit": "8a8fea368bb67c72a9679845f23664c53d7e1be9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM5NzEyMQ==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425397121", "bodyText": "as far as I recall, this should relate to the fact that ozone doesn't create all dirs along the way if we create a key inside a deep directory. e.g. if we create /volume1/bucket1/dir1/subdir1/key1 only, key/volume1/bucket1/dir1 and /volume1/bucket1/dir1/subdir1 will NOT be actually created (unless we explicitly create them). But the end user will expect them to be \"created\" from the way they are browsing the FileSystem, for example, with shell commands. So when key1 is deleted afterwards, subdir1 should still be visible from user's perspective.\n@hanishakoneru should have more insights into this. CMIIW", "author": "smengcl", "createdAt": "2020-05-14T20:02:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQxMjkyNw==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425412927", "bodyText": "We should remove this logic in another jira for both o3fs and ofs since HDDS-2940 is already in, which solves the problem.", "author": "smengcl", "createdAt": "2020-05-14T20:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0NTMwNw==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425445307", "bodyText": "some special behavior :-). Its good that we will create dirs along the path now. Thanks for the details.", "author": "umamaheswararao", "createdAt": "2020-05-14T21:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk4MzUwMA==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425983500", "bodyText": "No problem :) Filed HDDS-3596.", "author": "smengcl", "createdAt": "2020-05-15T18:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzY3NQ==", "url": "https://github.com/apache/ozone/pull/906#discussion_r424873675", "bodyText": "I think these test cases should be split into multiple cases?", "author": "umamaheswararao", "createdAt": "2020-05-14T05:08:54Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java", "diffHunk": "@@ -766,4 +768,103 @@ public void testTempMount() throws Exception {\n         fileStatusesInDir1[0].getPath().toUri().getPath());\n   }\n \n+  /**\n+   * Helper function. Check Ozone volume existence.\n+   * @param volumeStr Name of the volume\n+   * @return true if volume exists, false if not\n+   */\n+  private boolean volumeExist(String volumeStr) throws IOException {\n+    try {\n+      objectStore.getVolume(volumeStr);\n+    } catch (OMException ex) {\n+      if (ex.getResult() == VOLUME_NOT_FOUND) {\n+        return false;\n+      } else {\n+        throw ex;\n+      }\n+    }\n+    return true;\n+  }\n+\n+  /**\n+   * Helper function. Delete a path non-recursively and expect failure.\n+   * @param f Path to delete.\n+   * @throws IOException\n+   */\n+  private void deleteNonRecursivelyAndFail(Path f) throws IOException {\n+    try {\n+      fs.delete(f, false);\n+      Assert.fail(\"Should have thrown PathIsNotEmptyDirectoryException!\");\n+    } catch (PathIsNotEmptyDirectoryException ignored) {\n+    }\n+  }\n+\n+  @Test\n+  public void testDeleteVolumeAndBucket() throws IOException {", "originalCommit": "8a8fea368bb67c72a9679845f23664c53d7e1be9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0NzYxOQ==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425347619", "bodyText": "Good idea", "author": "smengcl", "createdAt": "2020-05-14T18:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyMjIyOA==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425422228", "bodyText": "done in 118dbf6", "author": "smengcl", "createdAt": "2020-05-14T20:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3NjQ3Mw==", "url": "https://github.com/apache/ozone/pull/906#discussion_r424876473", "bodyText": "Can we add javadoc to delete method here? parent abstract method delete does not provide any javadoc. SO, its good to provide here and explain the behavior?", "author": "umamaheswararao", "createdAt": "2020-05-14T05:20:10Z", "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -457,6 +462,10 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n       return false;\n     }\n \n+    if (status == null) {\n+      return false;\n+    }\n+\n     String key = pathToKey(f);\n     boolean result;\n ", "originalCommit": "8a8fea368bb67c72a9679845f23664c53d7e1be9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0OTIxMw==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425349213", "bodyText": "It complies to the FileSystem#delete behavior: https://github.com/apache/hadoop/blob/263c76b678275dfff867415c71ba9dc00a9235ef/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java#L1634-L1643\nBut yes it would be a good idea to explain delete behavior for OFS.", "author": "smengcl", "createdAt": "2020-05-14T18:33:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3NjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQxODg5MQ==", "url": "https://github.com/apache/ozone/pull/906#discussion_r425418891", "bodyText": "done. I've appended some extra javadoc for delete in 6d7a21b", "author": "smengcl", "createdAt": "2020-05-14T20:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3NjQ3Mw=="}], "type": "inlineReview"}, {"oid": "118dbf6cba9f0a9388f42875fbeea5ae2194d606", "url": "https://github.com/apache/ozone/commit/118dbf6cba9f0a9388f42875fbeea5ae2194d606", "message": "Split tests. Add testFailToDeleteRoot.", "committedDate": "2020-05-14T19:53:42Z", "type": "commit"}, {"oid": "5b5b7cae4a86f360ece9ae132444c63361e08f09", "url": "https://github.com/apache/ozone/commit/5b5b7cae4a86f360ece9ae132444c63361e08f09", "message": "Remove the buggy root check logic inherited from o3fs. Note: o3fs root check is already fixed by HDDS-2973", "committedDate": "2020-05-14T19:56:38Z", "type": "commit"}, {"oid": "88969bb882ed0388ded2a72aa4e5b538c0e554b1", "url": "https://github.com/apache/ozone/commit/88969bb882ed0388ded2a72aa4e5b538c0e554b1", "message": "Move addTrailingSlashIfNeeded() outside the loop to reduce unnecessary calls.", "committedDate": "2020-05-14T19:59:17Z", "type": "commit"}, {"oid": "6d7a21b911b7b1ecff3a60443fa72782c5425de0", "url": "https://github.com/apache/ozone/commit/6d7a21b911b7b1ecff3a60443fa72782c5425de0", "message": "Add appended javadoc for delete().", "committedDate": "2020-05-14T20:43:38Z", "type": "commit"}, {"oid": "8091184c8b34cb2532b3dddf46ff773cd77b3d92", "url": "https://github.com/apache/ozone/commit/8091184c8b34cb2532b3dddf46ff773cd77b3d92", "message": "Retest 1", "committedDate": "2020-05-15T18:39:05Z", "type": "commit"}, {"oid": "a5c42336814335b1f811c2a29dda4e7032e4055e", "url": "https://github.com/apache/ozone/commit/a5c42336814335b1f811c2a29dda4e7032e4055e", "message": "Retest 2", "committedDate": "2020-05-16T07:05:30Z", "type": "commit"}]}