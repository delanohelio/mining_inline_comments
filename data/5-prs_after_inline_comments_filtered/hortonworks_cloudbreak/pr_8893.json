{"pr_number": 8893, "pr_title": "CB-8248: FreeIPA reboot flow finishes before instances reboot", "pr_createdAt": "2020-08-31T18:57:02Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8893", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMyOTU2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r480329566", "bodyText": "I am a little confused as to why there is an async stop followed by an async start. Does andThen() wait for the async to complete? If so, why even use async (unless it is referenced elsewhere).", "author": "jamisonbennett", "createdAt": "2020-08-31T19:04:58Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureInstanceConnector.java", "diffHunk": "@@ -78,7 +78,8 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n             AzureClient azureClient = ac.getParameter(AzureClient.class);\n             String resourceGroupName = azureResourceGroupMetadataProvider.getResourceGroupName(ac.getCloudContext(), vm.getCloudInstance());\n             if (vm.getStatus() == InstanceStatus.STARTED) {\n-                doReboot(completables, vm, statuses, () -> azureClient.rebootVirtualMachineAsync(resourceGroupName, vm.getCloudInstance().getInstanceId()));\n+                doReboot(completables, vm, statuses, () -> azureClient.stopVirtualMachineAsync(resourceGroupName, vm.getCloudInstance().getInstanceId())\n+                        .andThen(azureClient.startVirtualMachineAsync(resourceGroupName, vm.getCloudInstance().getInstanceId())));", "originalCommit": "fd4415842d4162f03b1f087f471d82e571517ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM4MDQzOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r480380438", "bodyText": "Thank you very much for the review. I verified that andThen() is a blocking call and wait for the first async completable to finish. Also it will re-throw any error that is thrown by the first completable. The link to the snippet I use to verify that : https://gist.github.com/christmasferret/3c0a185160ef420526bf882090517ca7", "author": "christmasferret", "createdAt": "2020-08-31T20:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMyOTU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NDc4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r480984782", "bodyText": "this is not used anymore", "author": "lacikaaa", "createdAt": "2020-09-01T09:02:54Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -134,18 +134,21 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n         AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),", "originalCommit": "fd4415842d4162f03b1f087f471d82e571517ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4NzQ1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481487450", "bodyText": "Thank you for pointing this out. It is removed.", "author": "christmasferret", "createdAt": "2020-09-01T23:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NDc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NTU2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r480985567", "bodyText": "why did you introduce a new doStart? the old one is not used anymore", "author": "lacikaaa", "createdAt": "2020-09-01T09:04:11Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -185,6 +188,28 @@ private void doStart(List<CloudInstance> affectedVMs, AuthenticatedContext ac, L\n         }\n     }\n \n+    private void doStart(List<CloudInstance> affectedVMs, AuthenticatedContext ac, List<CloudInstance> instances, List<CloudVmInstanceStatus> rebootedVmsStatus) {", "originalCommit": "fd4415842d4162f03b1f087f471d82e571517ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5Mjg5OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481492898", "bodyText": "The reason to introduce new doStart() is we want to return the polling results from doStart(). The polling can take 1000 seconds total if blocking. In the case of a hang blocking call, we will wait twice as much long. It is not necessary to poll inside doStart() and then after return from doStart() immediately poll again. I also removed the old one.", "author": "christmasferret", "createdAt": "2020-09-01T23:47:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NTU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NTg2OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r480985869", "bodyText": "doReboot is not used anymore", "author": "lacikaaa", "createdAt": "2020-09-01T09:04:41Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -134,18 +134,21 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n         AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n                 ac.getCloudContext().getLocation().getRegion().value());\n         List<CloudInstance> affectedVms = new ArrayList<>();\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();\n+\n         try {\n             if (!vms.isEmpty()) {\n                 List<CloudVmInstanceStatus> statuses = check(ac, vms);\n-                doReboot(affectedVms, amazonEC2Client, getStarted(statuses));", "originalCommit": "fd4415842d4162f03b1f087f471d82e571517ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4ODk1MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481488951", "bodyText": "Thank you! I removed the line.", "author": "christmasferret", "createdAt": "2020-09-01T23:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NTg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NjYyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r480986621", "bodyText": "why do we need this new list of statuses? shouldn't the affectedVms fill the same purpose?", "author": "lacikaaa", "createdAt": "2020-09-01T09:05:59Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -134,18 +134,21 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n         AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n                 ac.getCloudContext().getLocation().getRegion().value());\n         List<CloudInstance> affectedVms = new ArrayList<>();\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();", "originalCommit": "fd4415842d4162f03b1f087f471d82e571517ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4ODc5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481488796", "bodyText": "Thank you for the suggestion! I removed affectedVms. Also, the rebootedVmsStatus will be returned from doStart() method as suggested in another comment.", "author": "christmasferret", "createdAt": "2020-09-01T23:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NjYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4ODY1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r480988653", "bodyText": "instead of passing affectedVms list to doStop and doStart it would be nicer if they return with a list and we can use that", "author": "lacikaaa", "createdAt": "2020-09-01T09:09:43Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -134,18 +134,21 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n         AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n                 ac.getCloudContext().getLocation().getRegion().value());\n         List<CloudInstance> affectedVms = new ArrayList<>();\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();\n+\n         try {\n             if (!vms.isEmpty()) {\n                 List<CloudVmInstanceStatus> statuses = check(ac, vms);\n-                doReboot(affectedVms, amazonEC2Client, getStarted(statuses));\n-                doStart(affectedVms, ac, getStopped(statuses));\n+                doStop(new ArrayList<>(), ac, getStarted(statuses));\n+                statuses = check(ac, vms);\n+                doStart(affectedVms, ac, getStopped(statuses), rebootedVmsStatus);", "originalCommit": "fd4415842d4162f03b1f087f471d82e571517ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk5MTk4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r480991989", "bodyText": "I miss some action here. what happens here is:\n\nissue stop for VMs which are running\ncollect the VM statuses\nstart VMs which are stopped\n\nIn theory all VMs should be stopped at the point we are collecting the statuses after stop. I think we should at least match that the requested VMs for reboot are all stopped and have a log here if any of them is not stopped", "author": "lacikaaa", "createdAt": "2020-09-01T09:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4ODY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4OTc2OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481489769", "bodyText": "Thanks for suggesting that! Now I returned rebootedVmsStatus from doStart() method.\nI also added a specific log check to see if any requested VMs for reboot were not stopped\n-logInvalidStatuses(getNotStopped(statuses));", "author": "christmasferret", "createdAt": "2020-09-01T23:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4ODY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAwNDI5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481004293", "bodyText": "you have dropped polling here. are we sure about AmazonEC2Client#stopInstances and AmazonEC2Client#startInstances will return only after the state is changed to stopped/started? if not we might need some polling there", "author": "lacikaaa", "createdAt": "2020-09-01T09:36:35Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -134,18 +134,21 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n         AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n                 ac.getCloudContext().getLocation().getRegion().value());\n         List<CloudInstance> affectedVms = new ArrayList<>();\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();\n+\n         try {\n             if (!vms.isEmpty()) {\n                 List<CloudVmInstanceStatus> statuses = check(ac, vms);\n-                doReboot(affectedVms, amazonEC2Client, getStarted(statuses));\n-                doStart(affectedVms, ac, getStopped(statuses));\n+                doStop(new ArrayList<>(), ac, getStarted(statuses));\n+                statuses = check(ac, vms);\n+                doStart(affectedVms, ac, getStopped(statuses), rebootedVmsStatus);\n                 logInvalidStatuses(getNotStoppedOrStarted(statuses));\n             }\n         } catch (SdkClientException e) {\n             LOGGER.warn(\"Failed to send reboot request to AWS: \", e);\n             throw e;\n         }\n-        return pollerUtil.waitFor(ac, affectedVms, Sets.newHashSet(InstanceStatus.STARTED, InstanceStatus.FAILED));\n+        return rebootedVmsStatus;", "originalCommit": "fd4415842d4162f03b1f087f471d82e571517ed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5MTQ5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481491496", "bodyText": "The reason to drop the polling outside here is that we already specifically do polling inside doStop() and doStart() as below. The polling will take 1000 seconds total. In the case of a hang blocking call, we will wait twice as much long. It is not necessary to poll and then immediately poll again. I added unit test and also did integration testing with AWS.\ndoStop(...) { \n\tstop(...) {\n\t\tsetCloudVmInstanceStatuses(...){\n\t\t\tpollerUtil.waitFor(...);\n\t\t}\n\t}\n}", "author": "christmasferret", "createdAt": "2020-09-01T23:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAwNDI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg0NTQ2OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481845469", "bodyText": "ok I missed that! thanks for pointing out", "author": "lacikaaa", "createdAt": "2020-09-02T07:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAwNDI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3MjA0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481972047", "bodyText": "doStop first parameter is never used, could you drop it?", "author": "lacikaaa", "createdAt": "2020-09-02T10:40:05Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -131,25 +126,31 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n     )\n     @Override\n     public List<CloudVmInstanceStatus> reboot(AuthenticatedContext ac, List<CloudInstance> vms) {\n-        AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n-                ac.getCloudContext().getLocation().getRegion().value());\n-        List<CloudInstance> affectedVms = new ArrayList<>();\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();\n+\n         try {\n             if (!vms.isEmpty()) {\n                 List<CloudVmInstanceStatus> statuses = check(ac, vms);\n-                doReboot(affectedVms, amazonEC2Client, getStarted(statuses));\n-                doStart(affectedVms, ac, getStopped(statuses));\n-                logInvalidStatuses(getNotStoppedOrStarted(statuses));\n+                doStop(new ArrayList<>(), ac, getStarted(statuses));", "originalCommit": "60c97bb01c36178bd4f47fdbfeeba7b92d8e4383", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNjA5MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r482326091", "bodyText": "Thanks. I dropped it.", "author": "christmasferret", "createdAt": "2020-09-02T19:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3MjA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3MjU3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481972576", "bodyText": "doStart first parameter case is the same as doStop. could you drop it?", "author": "lacikaaa", "createdAt": "2020-09-02T10:41:05Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -131,25 +126,31 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n     )\n     @Override\n     public List<CloudVmInstanceStatus> reboot(AuthenticatedContext ac, List<CloudInstance> vms) {\n-        AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n-                ac.getCloudContext().getLocation().getRegion().value());\n-        List<CloudInstance> affectedVms = new ArrayList<>();\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();\n+\n         try {\n             if (!vms.isEmpty()) {\n                 List<CloudVmInstanceStatus> statuses = check(ac, vms);\n-                doReboot(affectedVms, amazonEC2Client, getStarted(statuses));\n-                doStart(affectedVms, ac, getStopped(statuses));\n-                logInvalidStatuses(getNotStoppedOrStarted(statuses));\n+                doStop(new ArrayList<>(), ac, getStarted(statuses));\n+                statuses = check(ac, vms);\n+                logInvalidStatuses(getNotStopped(statuses));\n+                rebootedVmsStatus = doStart(new ArrayList<>(), ac, getStopped(statuses));", "originalCommit": "60c97bb01c36178bd4f47fdbfeeba7b92d8e4383", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNjI1Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r482326257", "bodyText": "Thanks. I dropped it.", "author": "christmasferret", "createdAt": "2020-09-02T19:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3MjU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NjIzNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r481976237", "bodyText": "I think logInvalidStatuses would need some extra parameter which is also logged. Like \"instances should be in STOPPED state\" and here comes the list of instance ids and states. Otherwise we won't know if the log is coming from line 136 or 138.\nAlso logInvalidStatuses should log only one line, and not separate lines per instance. Could you fix that?", "author": "lacikaaa", "createdAt": "2020-09-02T10:47:17Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -131,25 +126,31 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n     )\n     @Override\n     public List<CloudVmInstanceStatus> reboot(AuthenticatedContext ac, List<CloudInstance> vms) {\n-        AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n-                ac.getCloudContext().getLocation().getRegion().value());\n-        List<CloudInstance> affectedVms = new ArrayList<>();\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();\n+\n         try {\n             if (!vms.isEmpty()) {\n                 List<CloudVmInstanceStatus> statuses = check(ac, vms);\n-                doReboot(affectedVms, amazonEC2Client, getStarted(statuses));\n-                doStart(affectedVms, ac, getStopped(statuses));\n-                logInvalidStatuses(getNotStoppedOrStarted(statuses));\n+                doStop(new ArrayList<>(), ac, getStarted(statuses));\n+                statuses = check(ac, vms);\n+                logInvalidStatuses(getNotStopped(statuses));\n+                rebootedVmsStatus = doStart(new ArrayList<>(), ac, getStopped(statuses));\n+                logInvalidStatuses(getNotStarted(statuses));", "originalCommit": "60c97bb01c36178bd4f47fdbfeeba7b92d8e4383", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyODczOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r482328738", "bodyText": "I fixed both here.\nNow it will only log one line. Also there is a targetStatus parameter to log the expected status.\nBelow is a sample log message.\n Unable to reboot instance i-1 because of invalid status STARTED, instance i-2 because of invalid status STARTED. Instances should be in STOPPED state.", "author": "christmasferret", "createdAt": "2020-09-02T19:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NjIzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyOTQxMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r482329411", "bodyText": "I have also squashed all my commits into one commit.", "author": "christmasferret", "createdAt": "2020-09-02T19:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NjIzNw=="}], "type": "inlineReview"}, {"oid": "c5e04f99c7ba73ea273d813f2bc82f1157627d47", "url": "https://github.com/hortonworks/cloudbreak/commit/c5e04f99c7ba73ea273d813f2bc82f1157627d47", "message": "CB-8248: FreeIPA reboot flow finishes before instances reboot\n\nUse combined stop/start operations in the FreeIPA instance reboot flow so that FreeIPA repair will wait for the AWS/Azure nodes to return to an actual running state. Currently, during a reboot operation, the AWS/Azure nodes always report a running state (this is so that the billing doesn't start billing a new session). With this fix, the reboot flow will actually finish. AWS will only bill for a minimum of 60 seconds each time a new instance is started.", "committedDate": "2020-09-02T16:36:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2OTk1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r482769953", "bodyText": "multiple issues here:\n\nplease don't use return like this, if possible avoid in the middle of returns in methods, or use else to indicate there are multiple exit points in the method\nif you would like to check if a collection is empty, please use isEmpty()\nI would negate the if condition and put the body of the method inside. You can use CollectionUtils from apache (CollectionUtils.isNotEmpty(instances)) or spring (!CollectionUtils.isEmpty(instances)) or write the whole condition by hand (instances != null && !instances.isEmpty()). It would still result in the same logic but there won't be that unnecessary return", "author": "lacikaaa", "createdAt": "2020-09-03T07:37:17Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -163,33 +164,37 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n                 .map(status -> status.getCloudInstance()).collect(Collectors.toList());\n     }\n \n-    private void doReboot(List<CloudInstance> affectedVMs, AmazonEC2Client amazonEC2Client, List<CloudInstance> instances) {\n+    private List<CloudVmInstanceStatus> doStart(AuthenticatedContext ac, List<CloudInstance> instances) {\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();\n         for (CloudInstance instance: instances) {\n             try {\n-                amazonEC2Client.rebootInstances(new RebootInstancesRequest().withInstanceIds(List.of(instance.getInstanceId())));\n-                affectedVMs.add(instance);\n+                rebootedVmsStatus.addAll(start(ac, null, List.of(instance)));\n             } catch (AmazonEC2Exception e) {\n-                LOGGER.warn(String.format(\"Unable to reboot instance %s\", instance), e);\n+                LOGGER.warn(String.format(\"Unable to start instance %s\", instance), e);\n             }\n         }\n+        return rebootedVmsStatus;\n     }\n \n-    private void doStart(List<CloudInstance> affectedVMs, AuthenticatedContext ac, List<CloudInstance> instances) {\n+    private void doStop(AuthenticatedContext ac, List<CloudInstance> instances) {\n         for (CloudInstance instance: instances) {\n             try {\n-                start(ac, null, List.of(instance));\n-                affectedVMs.add(instance);\n+                stop(ac, null, List.of(instance));\n             } catch (AmazonEC2Exception e) {\n-                LOGGER.warn(String.format(\"Unable to start instance %s\", instance), e);\n+                LOGGER.warn(String.format(\"Unable to stop instance %s\", instance), e);\n             }\n         }\n     }\n \n-    private void logInvalidStatuses(List<CloudVmInstanceStatus> instances) {\n-        for (CloudVmInstanceStatus instance: instances) {\n-            LOGGER.warn(String.format(\"Unable to reboot instance %s because of invalid status %s.\",\n-                    instance.getCloudInstance().getInstanceId(), instance.getStatus().toString()));\n+    public void logInvalidStatuses(List<CloudVmInstanceStatus> instances, InstanceStatus targetStatus) {\n+        if (instances == null || instances.size() < 1) {\n+            return;", "originalCommit": "c5e04f99c7ba73ea273d813f2bc82f1157627d47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac472345c0dc83aeca103c5c5ce81777e5240e0f", "url": "https://github.com/hortonworks/cloudbreak/commit/ac472345c0dc83aeca103c5c5ce81777e5240e0f", "message": "CB-8248: FreeIPA reboot flow finishes before instances reboot\n\nUse combined stop/start operations in the FreeIPA instance reboot flow so that FreeIPA repair will wait for the AWS/Azure nodes to return to an actual running state. Currently, during a reboot operation, the AWS/Azure nodes always report a running state (this is so that the billing doesn't start billing a new session). With this fix, the reboot flow will actually finish. AWS will only bill for a minimum of 60 seconds each time a new instance is started.", "committedDate": "2020-09-03T15:07:19Z", "type": "commit"}, {"oid": "ac472345c0dc83aeca103c5c5ce81777e5240e0f", "url": "https://github.com/hortonworks/cloudbreak/commit/ac472345c0dc83aeca103c5c5ce81777e5240e0f", "message": "CB-8248: FreeIPA reboot flow finishes before instances reboot\n\nUse combined stop/start operations in the FreeIPA instance reboot flow so that FreeIPA repair will wait for the AWS/Azure nodes to return to an actual running state. Currently, during a reboot operation, the AWS/Azure nodes always report a running state (this is so that the billing doesn't start billing a new session). With this fix, the reboot flow will actually finish. AWS will only bill for a minimum of 60 seconds each time a new instance is started.", "committedDate": "2020-09-03T15:07:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3NDgzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r483074833", "bodyText": "one more nit, but we can merge it without even if you don't change this:\nyou can declare this variable right in the line where it gets value, at doStart. also the return could be moved inside the try, right after logInvalidStatuses(getNotStarted(statuses), InstanceStatus.STARTED);", "author": "lacikaaa", "createdAt": "2020-09-03T15:40:17Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -131,25 +127,31 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n     )\n     @Override\n     public List<CloudVmInstanceStatus> reboot(AuthenticatedContext ac, List<CloudInstance> vms) {\n-        AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n-                ac.getCloudContext().getLocation().getRegion().value());\n-        List<CloudInstance> affectedVms = new ArrayList<>();\n+        List<CloudVmInstanceStatus> rebootedVmsStatus = new ArrayList<>();", "originalCommit": "ac472345c0dc83aeca103c5c5ce81777e5240e0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3NTUxNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8893#discussion_r483075515", "bodyText": "oh I missed if (!vms.isEmpty()), nevermind....", "author": "lacikaaa", "createdAt": "2020-09-03T15:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3NDgzMw=="}], "type": "inlineReview"}]}