{"pr_number": 9198, "pr_title": "CB-9237 stack can stuck, somehow status is deleted but terminated timestamp is null", "pr_createdAt": "2020-10-12T12:00:10Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9198", "timeline": [{"oid": "9ac5c1a5d9b45911e4089ec2432e7dae6d1d208f", "url": "https://github.com/hortonworks/cloudbreak/commit/9ac5c1a5d9b45911e4089ec2432e7dae6d1d208f", "message": "CB-9237 stack can stuck, somehow status is deleted but terminated timestamp is null", "committedDate": "2020-10-12T13:34:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc4MTA3OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9198#discussion_r503781078", "bodyText": "are you sure you want to include an external call in the transaction? I'm against it", "author": "lacikaaa", "createdAt": "2020-10-13T08:54:33Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/stack/flow/TerminationService.java", "diffHunk": "@@ -114,12 +114,18 @@ private void deleteOnlyIfForced(Stack stack, boolean force, String terminatedNam\n     }\n \n     private void updateToDeleteCompleted(Stack stack, String terminatedName, String statusReason) {\n-        stack.setName(terminatedName);\n-        stack.setTerminated(clock.getCurrentTimeMillis());\n-        stackService.save(stack);\n-        stackUpdater.updateStackStatus(stack.getId(), DetailedStackStatus.DELETE_COMPLETED, statusReason);\n-        if (stack.getType().equals(StackType.WORKLOAD)) {\n-            grpcUmsClient.notifyResourceDeleted(stack.getResourceCrn(), MDCUtils.getRequestId());\n+        try {\n+            transactionService.required(() -> {\n+                stack.setName(terminatedName);\n+                stack.setTerminated(clock.getCurrentTimeMillis());\n+                stackService.save(stack);\n+                stackUpdater.updateStackStatus(stack.getId(), DetailedStackStatus.DELETE_COMPLETED, statusReason);\n+                if (stack.getType().equals(StackType.WORKLOAD)) {\n+                    grpcUmsClient.notifyResourceDeleted(stack.getResourceCrn(), MDCUtils.getRequestId());", "originalCommit": "9ac5c1a5d9b45911e4089ec2432e7dae6d1d208f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc4OTMxMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9198#discussion_r503789311", "bodyText": "oh god! :) thanks..", "author": "sodre90", "createdAt": "2020-10-13T09:06:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc4MTA3OA=="}], "type": "inlineReview"}, {"oid": "e0496f27b45b204fbdb4f41fd156474605d19748", "url": "https://github.com/hortonworks/cloudbreak/commit/e0496f27b45b204fbdb4f41fd156474605d19748", "message": "CB-9237 stack can stuck, somehow status is deleted but terminated timestamp is null", "committedDate": "2020-10-13T09:06:01Z", "type": "commit"}, {"oid": "e0496f27b45b204fbdb4f41fd156474605d19748", "url": "https://github.com/hortonworks/cloudbreak/commit/e0496f27b45b204fbdb4f41fd156474605d19748", "message": "CB-9237 stack can stuck, somehow status is deleted but terminated timestamp is null", "committedDate": "2020-10-13T09:06:01Z", "type": "forcePushed"}]}