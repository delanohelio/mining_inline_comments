{"pr_number": 9578, "pr_title": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.", "pr_createdAt": "2020-12-04T17:42:58Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9578", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyMTQ1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r536821453", "bodyText": "\"subnetId\" constanst is already present in AwsNetworkView or CloudInstance. I think you should use one of them.", "author": "lacikaaa", "createdAt": "2020-12-05T16:50:39Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,16 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack,\n+            List<CloudResource> instances, Network network, AmazonEC2Client amazonEC2Client) {\n+\n+        String subnetId = network.getStringParameter(\"subnetId\");", "originalCommit": "8f5964bf50dfa77ba7367a430b0249c3591a24ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyODY2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r536828661", "bodyText": "actually, we have AwsNetworkView in the caller method, so if you pass it as an argument, or just the subnetId itself as the network is not used for anything else you could omit this part", "author": "lacikaaa", "createdAt": "2020-12-05T17:36:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyMTQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyMTU2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r536821567", "bodyText": "CloudStack stack parameter is not used and after removing parameters should fit into one line", "author": "lacikaaa", "createdAt": "2020-12-05T16:51:20Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,16 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack,\n+            List<CloudResource> instances, Network network, AmazonEC2Client amazonEC2Client) {", "originalCommit": "8f5964bf50dfa77ba7367a430b0249c3591a24ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyOTY1Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r536829652", "bodyText": "this scheme creation could be in a separate method", "author": "lacikaaa", "createdAt": "2020-12-05T17:42:46Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,16 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack,\n+            List<CloudResource> instances, Network network, AmazonEC2Client amazonEC2Client) {\n+\n+        String subnetId = network.getStringParameter(\"subnetId\");\n+        DescribeRouteTablesResult describeRouteTablesResult = amazonEC2Client.describeRouteTables();\n+        AwsLoadBalancerScheme scheme = awsSubnetIgwExplorer.hasInternetGatewayOfSubnet(describeRouteTablesResult, subnetId)\n+                ? AwsLoadBalancerScheme.PUBLIC : AwsLoadBalancerScheme.PRIVATE;", "originalCommit": "8f5964bf50dfa77ba7367a430b0249c3591a24ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6dad38172340ae4c53caea878bc707ad565dfb2e", "url": "https://github.com/hortonworks/cloudbreak/commit/6dad38172340ae4c53caea878bc707ad565dfb2e", "message": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.\n\nThis deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer.", "committedDate": "2020-12-08T18:24:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3NjgxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r540076817", "bodyText": "are we sure it's not a subnet list here? shall we validate?", "author": "lacikaaa", "createdAt": "2020-12-10T11:03:16Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,19 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancerScheme determinePublicVsPrivateSchema(AwsNetworkView awsNetworkView, AmazonEC2Client amazonEC2Client) {\n+        String subnetId = awsNetworkView.getExistingSubnet();", "originalCommit": "6dad38172340ae4c53caea878bc707ad565dfb2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM0Mzc0NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r540343745", "bodyText": "In debugging, I have only seen 1 subnet get passed in when I select 3 during env creation.", "author": "frozenwizard", "createdAt": "2020-12-10T17:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3NjgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM0NDkzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r540344934", "bodyText": "Hreeve is working on a change for semi-private networks to support a list of subnets.", "author": "frozenwizard", "createdAt": "2020-12-10T17:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3NjgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3NzA2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r540077063", "bodyText": "could you give it a better name?", "author": "lacikaaa", "createdAt": "2020-12-10T11:03:41Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,19 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancerScheme determinePublicVsPrivateSchema(AwsNetworkView awsNetworkView, AmazonEC2Client amazonEC2Client) {\n+        String subnetId = awsNetworkView.getExistingSubnet();\n+        DescribeRouteTablesResult describeRouteTablesResult = amazonEC2Client.describeRouteTables();\n+        return awsSubnetIgwExplorer.hasInternetGatewayOfSubnet(describeRouteTablesResult, subnetId)\n+                ? AwsLoadBalancerScheme.PUBLIC : AwsLoadBalancerScheme.PRIVATE;\n+    }\n+\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, List<CloudResource> instances,", "originalCommit": "6dad38172340ae4c53caea878bc707ad565dfb2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c8bc04140baf37c4ebabe2972436756fd2ff846f", "url": "https://github.com/hortonworks/cloudbreak/commit/c8bc04140baf37c4ebabe2972436756fd2ff846f", "message": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.\n\nThis deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer.", "committedDate": "2020-12-10T17:09:43Z", "type": "commit"}, {"oid": "c8bc04140baf37c4ebabe2972436756fd2ff846f", "url": "https://github.com/hortonworks/cloudbreak/commit/c8bc04140baf37c4ebabe2972436756fd2ff846f", "message": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.\n\nThis deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer.", "committedDate": "2020-12-10T17:09:43Z", "type": "forcePushed"}]}