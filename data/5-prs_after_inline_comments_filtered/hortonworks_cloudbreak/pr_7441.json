{"pr_number": 7441, "pr_title": "CB-5582 CB-5583 enforce authorization annotations", "pr_createdAt": "2020-03-02T16:48:56Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7441", "timeline": [{"oid": "005ff5a133aee008a600d64ea17febad76a15e52", "url": "https://github.com/hortonworks/cloudbreak/commit/005ff5a133aee008a600d64ea17febad76a15e52", "message": "CB-5582 CB-5583 enforce annotations", "committedDate": "2020-03-02T17:18:04Z", "type": "forcePushed"}, {"oid": "9b273f97ce9342f20f7986a12832fe76f743f8dc", "url": "https://github.com/hortonworks/cloudbreak/commit/9b273f97ce9342f20f7986a12832fe76f743f8dc", "message": "CB-5582 CB-5583 enforce annotations", "committedDate": "2020-03-02T21:32:16Z", "type": "forcePushed"}, {"oid": "6297ca100f2e5721e04d5a3314fe2bf056721da5", "url": "https://github.com/hortonworks/cloudbreak/commit/6297ca100f2e5721e04d5a3314fe2bf056721da5", "message": "CB-5582 CB-5583 enforce annotations", "committedDate": "2020-03-02T21:50:53Z", "type": "forcePushed"}, {"oid": "f6f2deeaf44fcb6ed651483ada27c45977a7dac4", "url": "https://github.com/hortonworks/cloudbreak/commit/f6f2deeaf44fcb6ed651483ada27c45977a7dac4", "message": "CB-5582 CB-5583 enforce annotations", "committedDate": "2020-03-02T22:11:10Z", "type": "forcePushed"}, {"oid": "9e4464aac6a0a3731bd21828634f82e626406fac", "url": "https://github.com/hortonworks/cloudbreak/commit/9e4464aac6a0a3731bd21828634f82e626406fac", "message": "CB-5582 CB-5583 enforce annotations", "committedDate": "2020-03-03T10:33:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0NTc0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7441#discussion_r386945746", "bodyText": "This might be better as a Warn message.", "author": "lnardai", "createdAt": "2020-03-03T11:01:33Z", "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/AbstractPermissionCheckerService.java", "diffHunk": "@@ -60,34 +65,39 @@ protected Object checkPermission(ProceedingJoinPoint proceedingJoinPoint, Method\n         Optional<Annotation> classAnnotation = commonPermissionCheckingUtils.getClassAnnotation(authorizationClass);\n \n         AuthorizationResource classAuthorizationResource = (AuthorizationResource) classAnnotation.get();\n+        AuthorizationResourceType resource = classAuthorizationResource.type();\n+        String userCrn = ThreadBasedUserCrnProvider.getUserCrn();\n \n         List<? extends Annotation> annotations = getPossibleMethodAnnotations().stream()\n                 .map(c -> methodSignature.getMethod().getAnnotation(c))\n                 .collect(Collectors.toList());\n \n-        Annotation methodAnnotation = validateNumberOfAnnotations(methodSignature, annotations);\n-        if (methodAnnotation instanceof DisableCheckPermissions) {\n+        Optional<Annotation> methodAnnotation = validateNumberOfAnnotations(methodSignature, annotations);\n+        if (!methodAnnotation.isPresent()) {\n+            LOGGER.info(\"Your Controller ({}) method {} does not have any authorization related annotation, \" +", "originalCommit": "9e4464aac6a0a3731bd21828634f82e626406fac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0NjI5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7441#discussion_r386946295", "bodyText": "What happens if someone specifies another annotation, should we verify an exact list of Annotations we are looking for? Would it be an error in the permission checking util or cause some RunTimeError?", "author": "lnardai", "createdAt": "2020-03-03T11:02:46Z", "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/AbstractPermissionCheckerService.java", "diffHunk": "@@ -60,34 +65,39 @@ protected Object checkPermission(ProceedingJoinPoint proceedingJoinPoint, Method\n         Optional<Annotation> classAnnotation = commonPermissionCheckingUtils.getClassAnnotation(authorizationClass);\n \n         AuthorizationResource classAuthorizationResource = (AuthorizationResource) classAnnotation.get();\n+        AuthorizationResourceType resource = classAuthorizationResource.type();\n+        String userCrn = ThreadBasedUserCrnProvider.getUserCrn();\n \n         List<? extends Annotation> annotations = getPossibleMethodAnnotations().stream()\n                 .map(c -> methodSignature.getMethod().getAnnotation(c))\n                 .collect(Collectors.toList());\n \n-        Annotation methodAnnotation = validateNumberOfAnnotations(methodSignature, annotations);\n-        if (methodAnnotation instanceof DisableCheckPermissions) {\n+        Optional<Annotation> methodAnnotation = validateNumberOfAnnotations(methodSignature, annotations);\n+        if (!methodAnnotation.isPresent()) {\n+            LOGGER.info(\"Your Controller ({}) method {} does not have any authorization related annotation, \" +\n+                            \"thus we are checking write permission on current account.\",\n+                    proceedingJoinPoint.getTarget().getClass().getSimpleName(), methodSignature.getMethod().getName());\n+            commonPermissionCheckingUtils.checkPermissionForUser(resource, AuthorizationResourceAction.WRITE, userCrn);\n+            return commonPermissionCheckingUtils.proceed(proceedingJoinPoint, methodSignature, startTime);\n+        } else if (methodAnnotation.get() instanceof DisableCheckPermissions) {\n             return commonPermissionCheckingUtils.proceed(proceedingJoinPoint, methodSignature, startTime);\n         }\n \n-        String userCrn = ThreadBasedUserCrnProvider.getUserCrn();\n-        PermissionChecker<? extends Annotation> permissionChecker = permissionCheckerMap.get(methodAnnotation.annotationType());\n-        AuthorizationResourceType resource = classAuthorizationResource.type();\n-        return permissionChecker.checkPermissions(methodAnnotation, resource, userCrn, proceedingJoinPoint, methodSignature, startTime);\n+        PermissionChecker<? extends Annotation> permissionChecker = permissionCheckerMap.get(methodAnnotation.get().annotationType());\n+        return permissionChecker.checkPermissions(methodAnnotation.get(), resource, userCrn, proceedingJoinPoint, methodSignature, startTime);\n     }\n \n-    private Annotation validateNumberOfAnnotations(MethodSignature methodSignature, List<? extends Annotation> annotations) {\n+    private Optional<Annotation> validateNumberOfAnnotations(MethodSignature methodSignature, List<? extends Annotation> annotations) {", "originalCommit": "9e4464aac6a0a3731bd21828634f82e626406fac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk1MjcyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7441#discussion_r386952720", "bodyText": "Child class (PermissionCheckerService) has a static list about possible authz annotations and we are checking those.", "author": "horadla23", "createdAt": "2020-03-03T11:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0NjI5NQ=="}], "type": "inlineReview"}, {"oid": "ff25430a2bb572de64a5d3dcee34df49c1c11202", "url": "https://github.com/hortonworks/cloudbreak/commit/ff25430a2bb572de64a5d3dcee34df49c1c11202", "message": "CB-5582 CB-5583 enforce annotations", "committedDate": "2020-03-03T11:16:16Z", "type": "commit"}, {"oid": "ff25430a2bb572de64a5d3dcee34df49c1c11202", "url": "https://github.com/hortonworks/cloudbreak/commit/ff25430a2bb572de64a5d3dcee34df49c1c11202", "message": "CB-5582 CB-5583 enforce annotations", "committedDate": "2020-03-03T11:16:16Z", "type": "forcePushed"}]}