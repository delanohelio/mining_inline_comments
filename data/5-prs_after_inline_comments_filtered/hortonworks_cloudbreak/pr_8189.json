{"pr_number": 8189, "pr_title": "DISTX-421 Separate endpoint for autoscale recommendation", "pr_createdAt": "2020-06-02T01:31:26Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8189", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY2NDk1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8189#discussion_r433664955", "bodyText": "Can this take only clusterCrn and internally use blueprintName ?", "author": "smaniraju", "createdAt": "2020-06-02T07:10:03Z", "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/autoscales/AutoscaleV4Endpoint.java", "diffHunk": "@@ -106,4 +107,10 @@ void decommissionInstancesForClusterCrn(@PathParam(\"crn\") String clusterCrn,\n     @Path(\"clusterproxy\")\n     @Produces(MediaType.APPLICATION_JSON)\n     ClusterProxyConfiguration getClusterProxyconfiguration();\n+\n+    @GET\n+    @Path(\"recommendation\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    AutoscaleRecommendationV4Response getRecommendation(@QueryParam(\"workspaceId\") Long workspaceId,\n+                                                        @QueryParam(\"blueprintName\") String blueprintName);\n }", "originalCommit": "cbf417194ac7b9d4cb971ce06a23b380b2887678", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MDMxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8189#discussion_r434260313", "bodyText": "Doing it by blueprintName is more cache-friendly. At the same time, clusterCrn is a nice abstraction, particularly caller need not worry about workspaceId.", "author": "cegganesh84", "createdAt": "2020-06-03T01:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY2NDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMyMDM4MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8189#discussion_r434320381", "bodyText": "I would prefer it using clusterCrn, since it avoids additional CB call to retrieve blueprintname associated with the cluster. Also workspaceId is internal id of CB, so  would  prefer to avoid making api calls based on that.", "author": "smaniraju", "createdAt": "2020-06-03T05:43:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY2NDk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxODg2NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8189#discussion_r434318865", "bodyText": "This api is meant for internal periscope use which uses internalCrn for communication. It should use the earlier PreAuthorize checks  and not CheckPermissionByAccount.", "author": "smaniraju", "createdAt": "2020-06-03T05:38:16Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/v4/AutoscaleV4Controller.java", "diffHunk": "@@ -157,8 +157,7 @@ public ClusterProxyConfiguration getClusterProxyconfiguration() {\n     }\n \n     @Override\n-    @DisableCheckPermissions\n-    @PreAuthorize(\"hasRole('AUTOSCALE')\")\n+    @CheckPermissionByAccount(action = AuthorizationResourceAction.DATAHUB_READ)\n     public AutoscaleRecommendationV4Response getRecommendation(Long workspaceId, String blueprintName) {", "originalCommit": "2435dbb5d0b17cc515e9f1f6077b73177b4d15c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMyMDA0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8189#discussion_r434320041", "bodyText": "That makes sense. How to test those internal APIs (in general)?", "author": "cegganesh84", "createdAt": "2020-06-03T05:42:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxODg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNjM1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8189#discussion_r435016353", "bodyText": "Nit: empty lines", "author": "smaniraju", "createdAt": "2020-06-04T06:19:52Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/stack/CloudResourceAdvisor.java", "diffHunk": "@@ -149,6 +146,20 @@ public PlatformRecommendation createForBlueprint(Long workspaceId, String bluepr\n         return new PlatformRecommendation(vmTypesByHostGroup, availableVmTypes, diskTypes, instanceCounts, gateway, autoscale, resize);\n     }\n \n+    public AutoscaleRecommendation getAutoscaleRecommendation(Long workspaceId, String blueprintName) {\n+        LOGGER.debug(\"Autoscale advice for blueprintName: {}.\", blueprintName);\n+\n+        BlueprintTextProcessor blueprintTextProcessor = getBlueprintTextProcessor(workspaceId, blueprintName);\n+\n+        return recommendAutoscale(blueprintTextProcessor);", "originalCommit": "577e97dfcc012c71f0732a2ed0c409ea421f653b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "892c735126f3c0b1c2e9862c830a75f3bde49ee2", "url": "https://github.com/hortonworks/cloudbreak/commit/892c735126f3c0b1c2e9862c830a75f3bde49ee2", "message": "DISTX-421 Separate endpoint for autoscale recommendation\n\n1. Autoscale needs a recommendation endpoint for the backend verification in periscope.", "committedDate": "2020-06-09T01:22:04Z", "type": "commit"}, {"oid": "762e99b39494e43a4f3e836146ca1801ee1b9522", "url": "https://github.com/hortonworks/cloudbreak/commit/762e99b39494e43a4f3e836146ca1801ee1b9522", "message": "DISTX-421 Separate endpoint for autoscale recommendation\n\n1. Autoscale needs a recommendation endpoint for the backend verification in periscope.\n2. Tested in private stack.", "committedDate": "2020-06-09T01:22:05Z", "type": "commit"}, {"oid": "cfcda5b873ae789abf81a0564d49e0d54324f6bc", "url": "https://github.com/hortonworks/cloudbreak/commit/cfcda5b873ae789abf81a0564d49e0d54324f6bc", "message": "Used clusterCrn instead of workspaceId and blueprintName.\nChanged the auth method.\nTested without these two changes that the api works.", "committedDate": "2020-06-09T01:22:05Z", "type": "commit"}, {"oid": "fe1b7097fbbe08549b5386c6de9db864b2f97517", "url": "https://github.com/hortonworks/cloudbreak/commit/fe1b7097fbbe08549b5386c6de9db864b2f97517", "message": "Address review comments", "committedDate": "2020-06-09T01:22:05Z", "type": "commit"}, {"oid": "fe1b7097fbbe08549b5386c6de9db864b2f97517", "url": "https://github.com/hortonworks/cloudbreak/commit/fe1b7097fbbe08549b5386c6de9db864b2f97517", "message": "Address review comments", "committedDate": "2020-06-09T01:22:05Z", "type": "forcePushed"}]}