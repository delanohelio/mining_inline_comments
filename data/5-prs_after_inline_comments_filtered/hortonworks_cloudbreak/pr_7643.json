{"pr_number": 7643, "pr_title": "CB-6251: Could not reboot stopped FreeIPA", "pr_createdAt": "2020-03-25T02:04:17Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7643", "timeline": [{"oid": "50d22c381bf23d0715363758a054aa29b0b46e06", "url": "https://github.com/hortonworks/cloudbreak/commit/50d22c381bf23d0715363758a054aa29b0b46e06", "message": "CB-6251: Could not reboot stopped FreeIPA\n\nThis change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted.", "committedDate": "2020-03-25T02:17:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1ODIxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7643#discussion_r397658219", "bodyText": "could you move these stream parameters into variables or even to methods?", "author": "lacikaaa", "createdAt": "2020-03-25T07:45:02Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -133,18 +133,52 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n     public List<CloudVmInstanceStatus> reboot(AuthenticatedContext ac, List<CloudInstance> vms) {\n         AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n                 ac.getCloudContext().getLocation().getRegion().value());\n+        List<CloudInstance> affectedVms = new ArrayList<>();\n         try {\n-            Collection<String> instances = vms.stream().map(CloudInstance::getInstanceId).collect(Collectors.toSet());\n-            if (!instances.isEmpty()) {\n-                amazonEC2Client.rebootInstances(new RebootInstancesRequest().withInstanceIds(instances));\n+            if (!vms.isEmpty()) {\n+                List<CloudVmInstanceStatus> statuses = check(ac, vms);\n+                doReboot(affectedVms, amazonEC2Client, statuses.stream().filter(status -> status.getStatus() == InstanceStatus.STARTED)\n+                        .map(status -> status.getCloudInstance()).collect(Collectors.toList()));\n+                doStart(affectedVms, ac, statuses.stream().filter(status -> status.getStatus() == InstanceStatus.STOPPED)\n+                        .map(status -> status.getCloudInstance()).collect(Collectors.toList()));", "originalCommit": "50d22c381bf23d0715363758a054aa29b0b46e06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4MzgzOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7643#discussion_r397983839", "bodyText": "moved", "author": "holleyism", "createdAt": "2020-03-25T16:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1ODIxOQ=="}], "type": "inlineReview"}, {"oid": "0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11", "url": "https://github.com/hortonworks/cloudbreak/commit/0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11", "message": "CB-6251: Could not reboot stopped FreeIPA\n\nThis change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted.", "committedDate": "2020-03-25T14:31:28Z", "type": "commit"}, {"oid": "0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11", "url": "https://github.com/hortonworks/cloudbreak/commit/0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11", "message": "CB-6251: Could not reboot stopped FreeIPA\n\nThis change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted.", "committedDate": "2020-03-25T14:31:28Z", "type": "forcePushed"}]}