{"pr_number": 9563, "pr_title": "CB-9525 DB SSL root cert file location customization", "pr_createdAt": "2020-12-02T16:08:25Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9563", "timeline": [{"oid": "50115ae649c1bab8a7e423be3aa72b58a6e9ebb0", "url": "https://github.com/hortonworks/cloudbreak/commit/50115ae649c1bab8a7e423be3aa72b58a6e9ebb0", "message": "CB-9525 DB SSL root cert file location customization\n\nTODO:\n* List of changes\n* Testing", "committedDate": "2020-12-03T09:03:52Z", "type": "forcePushed"}, {"oid": "93834f59eeec167b7354b56f5778256ebea75fb9", "url": "https://github.com/hortonworks/cloudbreak/commit/93834f59eeec167b7354b56f5778256ebea75fb9", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ", "committedDate": "2020-12-05T02:42:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5Njg0Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537196843", "bodyText": "praise: I really like this way of exception testing. Are we trying to move CB to AssertJ?", "author": "brycederriso", "createdAt": "2020-12-07T02:55:17Z", "path": "core/src/test/java/com/sequenceiq/cloudbreak/converter/v2/StackToTemplatePreparationObjectConverterTest.java", "diffHunk": "@@ -366,11 +371,10 @@ public void testConvertIfTheAttemptOfObtainingBaseFileSystemConfigurationsViewTh\n                 eq(configQueryEntries))).thenThrow(invokedException);\n         when(cmCloudStorageConfigProvider.getConfigQueryEntries()).thenReturn(configQueryEntries);\n \n-        expectedException.expect(CloudbreakServiceException.class);\n-        expectedException.expectMessage(iOExceptionMessage);\n-        expectedException.expectCause(is(invokedException));\n-\n-        underTest.convert(stackMock);\n+        assertThatCode(() -> underTest.convert(stackMock))", "originalCommit": "93834f59eeec167b7354b56f5778256ebea75fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI4OTY5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537289696", "bodyText": "@lajosrodek we are also using this way https://github.com/hortonworks/cloudbreak/blob/master/cluster-cm/src/test/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerModificationServiceTest.java#L170", "author": "doktoric", "createdAt": "2020-12-07T07:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5Njg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM1ODc1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537358759", "bodyText": "@brycederriso  I personally prefer AssertJ over JUnit and Hamcrest assertions due to its fluent API and more expressive structure. Not sure if AssertJ is the future and especially not aware of any specific initiatives in CB around AssertJ usage. I think JUnit 4 should be avoided altogether in new tests and gradually migrated to JUnit 5 in legacy ones, but there is probably no such requirement for AssertJ.\n@doktoric Shall I then replace the AssertJ assertThatCode() construct with the JUnit 5 assertThrows()?", "author": "lajosrodek", "createdAt": "2020-12-07T09:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5Njg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQwMTk4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537401988", "bodyText": "@lajosrodek I would appreciate that.", "author": "doktoric", "createdAt": "2020-12-07T10:39:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5Njg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxMzM0MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537413340", "bodyText": "@doktoric  Sure, done. Now it is actually a combination of JUnit 5 & AssertJ. \ud83d\ude08", "author": "lajosrodek", "createdAt": "2020-12-07T10:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5Njg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIwMDU2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537200563", "bodyText": "praise: Thanks for refactoring!", "author": "brycederriso", "createdAt": "2020-12-07T03:08:02Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/rdsconfig/RedbeamsDbCertificateProvider.java", "diffHunk": "@@ -70,10 +79,10 @@ private void getDatalakeDatabaseRootCerts(Stack stack, Set<String> result) {\n             LOGGER.info(\"Gathering cluster's(crn:'{}', name: '{}') remote database root certificates\", stackResourceCrn, clusterName);\n             String databaseServerCrn = cluster.getDatabaseServerCrn();\n             DatabaseServerV4Response databaseServer = dbServerConfigurer.getDatabaseServer(databaseServerCrn);\n-            if (databaseServer.getSslConfig() != null) {\n-                SslMode sslMode = databaseServer.getSslConfig().getSslMode();\n-                if (SslMode.ENABLED.equals(sslMode)) {\n-                    Set<String> sslCertificates = databaseServer.getSslConfig().getSslCertificates();\n+            SslConfigV4Response sslConfig = databaseServer.getSslConfig();\n+            if (sslConfig != null) {\n+                if (SslMode.isEnabled(sslConfig.getSslMode())) {", "originalCommit": "93834f59eeec167b7354b56f5778256ebea75fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM1MzM3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537353377", "bodyText": "Welcome. \ud83d\ude03", "author": "lajosrodek", "createdAt": "2020-12-07T09:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIwMDU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIwMTMxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537201313", "bodyText": "question: This looks like the only new test in this file, is that the case? (I'm not missing any?)\nThe rest of the changes are conversions to AssertJ?", "author": "brycederriso", "createdAt": "2020-12-07T03:10:55Z", "path": "core/src/test/java/com/sequenceiq/cloudbreak/converter/v2/StackToTemplatePreparationObjectConverterTest.java", "diffHunk": "@@ -526,7 +534,17 @@ public void testMissingClouderaManagerIp() {\n         when(stackMock.getPrimaryGatewayInstance()).thenReturn(dummyMetadata);\n \n         TemplatePreparationObject result = underTest.convert(stackMock);\n-        assertEquals(\"10.0.0.1\", result.getGeneralClusterConfigs().getClusterManagerIp());\n+\n+        assertThat(result.getGeneralClusterConfigs().getClusterManagerIp()).isEqualTo(\"10.0.0.1\");\n         verify(gatewayConfigService, times(1)).getPrimaryGatewayIp(any(Stack.class));\n     }\n+\n+    @Test\n+    void testRdsSslCertificateFile() {", "originalCommit": "93834f59eeec167b7354b56f5778256ebea75fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM1OTMxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537359310", "bodyText": "Correct, the rest is just noise due to AssertJ.", "author": "lajosrodek", "createdAt": "2020-12-07T09:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIwMTMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMjQ4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537212489", "bodyText": "question: What is this TemplatePreparationObject for? It looks like just a plain old value object.\nI see it's in the template namespace, but I don't actually know what that means in the broader context of CB.", "author": "brycederriso", "createdAt": "2020-12-07T03:50:19Z", "path": "template-manager-core/src/main/java/com/sequenceiq/cloudbreak/template/TemplatePreparationObject.java", "diffHunk": "@@ -53,6 +53,8 @@\n ", "originalCommit": "93834f59eeec167b7354b56f5778256ebea75fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI4NTE2NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537285164", "bodyText": "@brycederriso read more here https://cloudera.atlassian.net/wiki/spaces/ENG/pages/730268997/TRAINING+-+Cloudera+Manager+template+generation", "author": "doktoric", "createdAt": "2020-12-07T07:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMjQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM2MzQyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537363422", "bodyText": "Yes, it is an immutable POJO that contains all the cluster & service details needed for dynamic template generation. As explained in the wiki that Richie linked, the TemplatePreparationObject instance is fed into two kinds of template engines: Handlebars (used for dynamic parameter placeholders within CM cluster templates; see TemplateProcessor) and the CB logic generating CM cluster templates (CentralCmTemplateUpdater.updateCmTemplateConfiguration()).", "author": "lajosrodek", "createdAt": "2020-12-07T09:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMjQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY4MjQ4NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537682484", "bodyText": "Thanks!", "author": "brycederriso", "createdAt": "2020-12-07T17:18:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMjQ4OQ=="}], "type": "inlineReview"}, {"oid": "499fda4f800d15d654255c3c1d6192cfe9b978c7", "url": "https://github.com/hortonworks/cloudbreak/commit/499fda4f800d15d654255c3c1d6192cfe9b978c7", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ\n  * Use org.junit.jupiter.api.Assertions.assertThrows instead of\n    org.assertj.core.api.Assertions.assertThatCode for better\n    readability.", "committedDate": "2020-12-07T10:54:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyNjc3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539326770", "bodyText": "Shouldn't the builder's method name relate to the file path too?", "author": "biharitomi", "createdAt": "2020-12-09T13:57:35Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/converter/StackToTemplatePreparationObjectConverter.java", "diffHunk": "@@ -210,6 +214,7 @@ public TemplatePreparationObject convert(Stack source) {\n             Builder builder = Builder.builder()\n                     .withCloudPlatform(CloudPlatform.valueOf(source.getCloudPlatform()))\n                     .withRdsConfigs(postgresConfigService.createRdsConfigIfNeeded(source, cluster))\n+                    .withRdsSslCertificateFile(dbCertificateProvider.getSslCertsFilePath())", "originalCommit": "499fda4f800d15d654255c3c1d6192cfe9b978c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwNDczNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539404736", "bodyText": "Good point. Fixed.", "author": "lajosrodek", "createdAt": "2020-12-09T15:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyNjc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMzNTM0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539335342", "bodyText": "Can we name it {{rdsSslCertificateFilePath}} or ending with location? I think it would be more straightforward that way.", "author": "biharitomi", "createdAt": "2020-12-09T14:08:40Z", "path": "template-manager-core/src/main/java/com/sequenceiq/cloudbreak/template/TemplatePreparationObject.java", "diffHunk": "@@ -53,6 +53,8 @@\n \n     private final Map<String, RDSConfig> rdsConfigs;\n \n+    private final String rdsSslCertificateFile;", "originalCommit": "499fda4f800d15d654255c3c1d6192cfe9b978c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwNDk3OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539404979", "bodyText": "Good point. Fixed.", "author": "lajosrodek", "createdAt": "2020-12-09T15:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMzNTM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMzNjQxNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539336415", "bodyText": "The same here, it is not the file, it's just the location/path of the file.", "author": "biharitomi", "createdAt": "2020-12-09T14:09:56Z", "path": "template-manager-core/src/main/java/com/sequenceiq/cloudbreak/template/views/RdsView.java", "diffHunk": "@@ -59,6 +58,12 @@\n     private final RdsViewDialect rdsViewDialect;\n \n     public RdsView(RDSConfig rdsConfig) {\n+        this(rdsConfig, \"\");\n+    }\n+\n+    public RdsView(RDSConfig rdsConfig, String sslCertificateFile) {\n+        // Note: any value is valid for sslCertificateFile for sake of backward compatibility.\n+        this.sslCertificateFile = Objects.requireNonNullElse(sslCertificateFile, \"\");", "originalCommit": "499fda4f800d15d654255c3c1d6192cfe9b978c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwNTEyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539405128", "bodyText": "Good point. Fixed.", "author": "lajosrodek", "createdAt": "2020-12-09T15:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMzNjQxNQ=="}], "type": "inlineReview"}, {"oid": "2a9af93448d22c05f6725412a475795f93e50059", "url": "https://github.com/hortonworks/cloudbreak/commit/2a9af93448d22c05f6725412a475795f93e50059", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ\n  * Use org.junit.jupiter.api.Assertions.assertThrows instead of\n    org.assertj.core.api.Assertions.assertThatCode for better\n    readability.", "committedDate": "2020-12-09T15:29:04Z", "type": "commit"}, {"oid": "2a9af93448d22c05f6725412a475795f93e50059", "url": "https://github.com/hortonworks/cloudbreak/commit/2a9af93448d22c05f6725412a475795f93e50059", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ\n  * Use org.junit.jupiter.api.Assertions.assertThrows instead of\n    org.assertj.core.api.Assertions.assertThatCode for better\n    readability.", "committedDate": "2020-12-09T15:29:04Z", "type": "forcePushed"}]}