{"pr_number": 9274, "pr_title": "CB-9306 - Env service should create private DNS zones - various follow-ups", "pr_createdAt": "2020-10-22T14:35:25Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9274", "timeline": [{"oid": "db606980d7f719d7253c163c1a2e40f3bb9523f2", "url": "https://github.com/hortonworks/cloudbreak/commit/db606980d7f719d7253c163c1a2e40f3bb9523f2", "message": "CB-9306 - Azure ARM templates - API version upgrade", "committedDate": "2020-10-26T08:09:04Z", "type": "forcePushed"}, {"oid": "e6eaed82ab60a4aca338ab34c61e8f5093b837e1", "url": "https://github.com/hortonworks/cloudbreak/commit/e6eaed82ab60a4aca338ab34c61e8f5093b837e1", "message": "CB-9306 - Env service should create private DNS zones - various follow-ups", "committedDate": "2020-10-26T11:51:45Z", "type": "forcePushed"}, {"oid": "8978fe6f56ebfe745221d6ab344cd79a99779a8c", "url": "https://github.com/hortonworks/cloudbreak/commit/8978fe6f56ebfe745221d6ab344cd79a99779a8c", "message": "CB-9306 - Env service should create private DNS zones - various follow-ups", "committedDate": "2020-10-28T20:59:41Z", "type": "forcePushed"}, {"oid": "f83c20119e9e39cc59814870c8a2e40ef59872d0", "url": "https://github.com/hortonworks/cloudbreak/commit/f83c20119e9e39cc59814870c8a2e40ef59872d0", "message": "CB-9306 - Env service should create private DNS zones - various follow-ups", "committedDate": "2020-10-30T11:19:09Z", "type": "forcePushed"}, {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8", "url": "https://github.com/hortonworks/cloudbreak/commit/e7e5910682b9006f265504e46123f909f8d9b2a8", "message": "CB-9306 - Env service should create private DNS zones - various follow-ups", "committedDate": "2020-10-30T11:57:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNDg2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519634863", "bodyText": "why do we still need to check networkLinksDeployed? I think this should be dropped and only dnsZonesDeployed checked", "author": "lacikaaa", "createdAt": "2020-11-09T08:40:14Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -1,307 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud.azure;\n \n import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n-import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n \n import java.util.List;\n import java.util.Map;\n-import java.util.Objects;\n-import java.util.Optional;\n-import java.util.stream.Collectors;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.lang3.StringUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Value;\n import org.springframework.dao.DataAccessException;\n import org.springframework.stereotype.Service;\n \n-import com.microsoft.azure.CloudException;\n-import com.microsoft.azure.PagedList;\n-import com.microsoft.azure.management.network.Network;\n-import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n-import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n-import com.sequenceiq.cloudbreak.common.json.Json;\n import com.sequenceiq.common.api.type.CommonStatus;\n-import com.sequenceiq.common.api.type.ResourceType;\n \n @Service\n public class AzureDnsZoneService {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n \n-    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n-\n     private static final String DNS_ZONES = \"-dns-zones\";\n \n-    private static final String NETWORK_LINKS = \"-links\";\n-\n-    @Inject\n-    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n-\n-    @Inject\n-    private PersistenceRetriever resourcePersistenceRetriever;\n-\n-    @Inject\n-    private PersistenceNotifier persistenceNotifier;\n-\n     @Inject\n-    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n \n     @Inject\n     private AzureResourceIdProviderService azureResourceIdProviderService;\n \n-    @Inject\n-    private AzureUtils azureUtils;\n-\n-    @Value(\"${cb.arm.privateendpoint.services:}\")\n-    private List<String> privateEndpointServices;\n-\n-    public void getOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+    public void checkOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n             String resourceGroup, Map<String, String> tags) {\n \n         String networkId = networkView.getNetworkId();\n         String networkResourceGroup = networkView.getResourceGroupName();\n-        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n-\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n         boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n         boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n-        String deploymentName = generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n         String dnsZoneDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n                 resourceGroup, deploymentName);\n \n         if (dnsZonesDeployed && networkLinksDeployed) {", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNTc4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519635789", "bodyText": "most of these variable could be moved into the if branch when dnsZonesDeployed is false.", "author": "lacikaaa", "createdAt": "2020-11-09T08:41:48Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -1,307 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud.azure;\n \n import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n-import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n \n import java.util.List;\n import java.util.Map;\n-import java.util.Objects;\n-import java.util.Optional;\n-import java.util.stream.Collectors;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.lang3.StringUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Value;\n import org.springframework.dao.DataAccessException;\n import org.springframework.stereotype.Service;\n \n-import com.microsoft.azure.CloudException;\n-import com.microsoft.azure.PagedList;\n-import com.microsoft.azure.management.network.Network;\n-import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n-import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n-import com.sequenceiq.cloudbreak.common.json.Json;\n import com.sequenceiq.common.api.type.CommonStatus;\n-import com.sequenceiq.common.api.type.ResourceType;\n \n @Service\n public class AzureDnsZoneService {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n \n-    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n-\n     private static final String DNS_ZONES = \"-dns-zones\";\n \n-    private static final String NETWORK_LINKS = \"-links\";\n-\n-    @Inject\n-    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n-\n-    @Inject\n-    private PersistenceRetriever resourcePersistenceRetriever;\n-\n-    @Inject\n-    private PersistenceNotifier persistenceNotifier;\n-\n     @Inject\n-    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n \n     @Inject\n     private AzureResourceIdProviderService azureResourceIdProviderService;\n \n-    @Inject\n-    private AzureUtils azureUtils;\n-\n-    @Value(\"${cb.arm.privateendpoint.services:}\")\n-    private List<String> privateEndpointServices;\n-\n-    public void getOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+    public void checkOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n             String resourceGroup, Map<String, String> tags) {\n \n         String networkId = networkView.getNetworkId();\n         String networkResourceGroup = networkView.getResourceGroupName();\n-        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n-\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n         boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n         boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n-        String deploymentName = generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n         String dnsZoneDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNzU0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519637546", "bodyText": "this branch should be splitted into smaller methods", "author": "lacikaaa", "createdAt": "2020-11-09T08:44:35Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -1,307 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud.azure;\n \n import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n-import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n \n import java.util.List;\n import java.util.Map;\n-import java.util.Objects;\n-import java.util.Optional;\n-import java.util.stream.Collectors;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.lang3.StringUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Value;\n import org.springframework.dao.DataAccessException;\n import org.springframework.stereotype.Service;\n \n-import com.microsoft.azure.CloudException;\n-import com.microsoft.azure.PagedList;\n-import com.microsoft.azure.management.network.Network;\n-import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n-import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n-import com.sequenceiq.cloudbreak.common.json.Json;\n import com.sequenceiq.common.api.type.CommonStatus;\n-import com.sequenceiq.common.api.type.ResourceType;\n \n @Service\n public class AzureDnsZoneService {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n \n-    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n-\n     private static final String DNS_ZONES = \"-dns-zones\";\n \n-    private static final String NETWORK_LINKS = \"-links\";\n-\n-    @Inject\n-    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n-\n-    @Inject\n-    private PersistenceRetriever resourcePersistenceRetriever;\n-\n-    @Inject\n-    private PersistenceNotifier persistenceNotifier;\n-\n     @Inject\n-    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n \n     @Inject\n     private AzureResourceIdProviderService azureResourceIdProviderService;\n \n-    @Inject\n-    private AzureUtils azureUtils;\n-\n-    @Value(\"${cb.arm.privateendpoint.services:}\")\n-    private List<String> privateEndpointServices;\n-\n-    public void getOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+    public void checkOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n             String resourceGroup, Map<String, String> tags) {\n \n         String networkId = networkView.getNetworkId();\n         String networkResourceGroup = networkView.getResourceGroupName();\n-        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n-\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n         boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n         boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n-        String deploymentName = generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n         String dnsZoneDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n                 resourceGroup, deploymentName);\n \n         if (dnsZonesDeployed && networkLinksDeployed) {\n             LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n         } else if (!dnsZonesDeployed) {", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzODUxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519638517", "bodyText": "these 2 variables should be moved inside the if", "author": "lacikaaa", "createdAt": "2020-11-09T08:46:25Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+\n+@Service\n+public class AzureNetworkLinkService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureNetworkLinkService.class);\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    public String validateExistingNetworkLink(AzureClient azureClient, String networkId) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+        return azureClient.validateNetworkLinkExistenceForDnsZones(networkId, enabledPrivateEndpointServices);\n+    }\n+\n+    public void checkOrCreateNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, \"-\" + networkId + NETWORK_LINKS);\n+        String networkLinkDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzOTEyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519639129", "bodyText": "could you move this near to it's usage?", "author": "lacikaaa", "createdAt": "2020-11-09T08:47:26Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+\n+@Service\n+public class AzureNetworkLinkService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureNetworkLinkService.class);\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    public String validateExistingNetworkLink(AzureClient azureClient, String networkId) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+        return azureClient.validateNetworkLinkExistenceForDnsZones(networkId, enabledPrivateEndpointServices);\n+    }\n+\n+    public void checkOrCreateNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, \"-\" + networkId + NETWORK_LINKS);\n+        String networkLinkDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n+                resourceGroup, deploymentName);\n+\n+        if (!networkLinksDeployed) {\n+            LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+            String azureNetworkId = azureResourceCreationHelperService.getAzureNetwork(azureClient, networkId, networkResourceGroup).id();", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MDQ2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519640467", "bodyText": "could you split this part into smaller methods?", "author": "lacikaaa", "createdAt": "2020-11-09T08:49:49Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+\n+@Service\n+public class AzureNetworkLinkService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureNetworkLinkService.class);\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    public String validateExistingNetworkLink(AzureClient azureClient, String networkId) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+        return azureClient.validateNetworkLinkExistenceForDnsZones(networkId, enabledPrivateEndpointServices);\n+    }\n+\n+    public void checkOrCreateNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, \"-\" + networkId + NETWORK_LINKS);\n+        String networkLinkDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n+                resourceGroup, deploymentName);\n+\n+        if (!networkLinksDeployed) {\n+            LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+            String azureNetworkId = azureResourceCreationHelperService.getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+\n+            try {", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MTg1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519641855", "bodyText": "you should consider a wrapper object for these parameters as there are already 7 of them", "author": "lacikaaa", "createdAt": "2020-11-09T08:52:11Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceCreationHelperService.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.management.network.Network;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureResourceCreationHelperService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureResourceCreationHelperService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureUtils azureUtils;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void pollForCreation(AuthenticatedContext authenticatedContext, AzureClient azureClient, String resourceGroup, String deploymentName,", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NjA0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519646048", "bodyText": "I think this class has a responsibility of doing at least 2 different things:\n\nresource persistence handling\ndeployment creation/polling etc\n\nthis means it could be splitted into 2 separate class", "author": "lacikaaa", "createdAt": "2020-11-09T08:59:16Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceCreationHelperService.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.management.network.Network;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureResourceCreationHelperService {", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1MzI0MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519653240", "bodyText": "instead of returning null please consider a different way, like using Optional", "author": "lacikaaa", "createdAt": "2020-11-09T09:11:12Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "diffHunk": "@@ -739,8 +739,29 @@ public void deleteGenericResourceById(String databaseServerId) {\n         handleAuthException(() -> azure.genericResources().deleteById(databaseServerId));\n     }\n \n-    public PrivateZone getPrivateDnsZoneByResourceGroup(String resourceGroupName, String dnsZoneName) {\n-        return privatednsManager.privateZones().getByResourceGroup(resourceGroupName, dnsZoneName);\n+    public PagedList<PrivateZone> getPrivateDnsZoneList() {\n+        return privatednsManager.privateZones().list();\n+    }\n+\n+    public String validateNetworkLinkExistenceForDnsZones(String networkLinkId, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        PagedList<PrivateZone> privateDnsZoneList = getPrivateDnsZoneList();\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            Optional<PrivateZone> privateZoneWithNetworkLink = privateDnsZoneList.stream()\n+                    .filter(privateZone -> privateZone.name().equals(dnsZoneName))\n+                    .filter(privateZone -> privateZone.provisioningState().equals(SUCCEEDED))\n+                    .filter(privateZone -> Objects.nonNull(getNetworkLinkByPrivateDnsZone(privateZone.resourceGroupName(), dnsZoneName, networkLinkId)))\n+                    .findFirst();\n+            if (privateZoneWithNetworkLink.isPresent()) {\n+                PrivateZone privateZone = privateZoneWithNetworkLink.get();\n+                String validationMessage = String.format(\"Network link for the network %s already exists for Private DNS Zone %s in resource group %s. \"\n+                            + \"Please ensure that there is no existing network link and try again!\",\n+                    networkLinkId, dnsZoneName, privateZone.resourceGroupName());\n+                LOGGER.warn(validationMessage);\n+                return validationMessage;\n+            }\n+        }\n+        return null;", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1MzUwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519653505", "bodyText": "please avoid in the middle return", "author": "lacikaaa", "createdAt": "2020-11-09T09:11:37Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "diffHunk": "@@ -739,8 +739,29 @@ public void deleteGenericResourceById(String databaseServerId) {\n         handleAuthException(() -> azure.genericResources().deleteById(databaseServerId));\n     }\n \n-    public PrivateZone getPrivateDnsZoneByResourceGroup(String resourceGroupName, String dnsZoneName) {\n-        return privatednsManager.privateZones().getByResourceGroup(resourceGroupName, dnsZoneName);\n+    public PagedList<PrivateZone> getPrivateDnsZoneList() {\n+        return privatednsManager.privateZones().list();\n+    }\n+\n+    public String validateNetworkLinkExistenceForDnsZones(String networkLinkId, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        PagedList<PrivateZone> privateDnsZoneList = getPrivateDnsZoneList();\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            Optional<PrivateZone> privateZoneWithNetworkLink = privateDnsZoneList.stream()\n+                    .filter(privateZone -> privateZone.name().equals(dnsZoneName))\n+                    .filter(privateZone -> privateZone.provisioningState().equals(SUCCEEDED))\n+                    .filter(privateZone -> Objects.nonNull(getNetworkLinkByPrivateDnsZone(privateZone.resourceGroupName(), dnsZoneName, networkLinkId)))\n+                    .findFirst();\n+            if (privateZoneWithNetworkLink.isPresent()) {\n+                PrivateZone privateZone = privateZoneWithNetworkLink.get();\n+                String validationMessage = String.format(\"Network link for the network %s already exists for Private DNS Zone %s in resource group %s. \"\n+                            + \"Please ensure that there is no existing network link and try again!\",\n+                    networkLinkId, dnsZoneName, privateZone.resourceGroupName());\n+                LOGGER.warn(validationMessage);\n+                return validationMessage;", "originalCommit": "e7e5910682b9006f265504e46123f909f8d9b2a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e4c9747db571916e9531a7bbe6fb195f28b837ea", "url": "https://github.com/hortonworks/cloudbreak/commit/e4c9747db571916e9531a7bbe6fb195f28b837ea", "message": "CB-9306 - Env service should create private DNS zones - various follow-ups", "committedDate": "2020-11-09T18:12:32Z", "type": "forcePushed"}, {"oid": "540b0ef82975e83384cf2b938c9bd2d0c5b718f6", "url": "https://github.com/hortonworks/cloudbreak/commit/540b0ef82975e83384cf2b938c9bd2d0c5b718f6", "message": "CB-9306 - Env service should create private DNS zones - various follow-ups", "committedDate": "2020-11-09T18:16:48Z", "type": "forcePushed"}, {"oid": "1f1b8a6594e9924d4637deb4825c2a091fdc29e0", "url": "https://github.com/hortonworks/cloudbreak/commit/1f1b8a6594e9924d4637deb4825c2a091fdc29e0", "message": "CB-9306 - Env service should create private DNS zones - various follow-ups", "committedDate": "2020-11-09T21:41:54Z", "type": "commit"}, {"oid": "1f1b8a6594e9924d4637deb4825c2a091fdc29e0", "url": "https://github.com/hortonworks/cloudbreak/commit/1f1b8a6594e9924d4637deb4825c2a091fdc29e0", "message": "CB-9306 - Env service should create private DNS zones - various follow-ups", "committedDate": "2020-11-09T21:41:54Z", "type": "forcePushed"}]}