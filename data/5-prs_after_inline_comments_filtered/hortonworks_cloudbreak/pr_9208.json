{"pr_number": 9208, "pr_title": "CB-9086 Enable host cert rotation on older runtimes", "pr_createdAt": "2020-10-12T19:37:55Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9208", "timeline": [{"oid": "2335b29cbd4c8dc9c8cc114e197795cf5ec24e5f", "url": "https://github.com/hortonworks/cloudbreak/commit/2335b29cbd4c8dc9c8cc114e197795cf5ec24e5f", "message": "CB-9086 Enable host cert rotation on older runtimes", "committedDate": "2020-10-12T20:10:17Z", "type": "forcePushed"}, {"oid": "483605a02bf93ab7f554e73e46e912caa1869004", "url": "https://github.com/hortonworks/cloudbreak/commit/483605a02bf93ab7f554e73e46e912caa1869004", "message": "CB-9086 Enable host cert rotation on older runtimes", "committedDate": "2020-10-13T14:20:59Z", "type": "forcePushed"}, {"oid": "2c6f89d5010c9eb23b5233fed47ac94ebf5e8e41", "url": "https://github.com/hortonworks/cloudbreak/commit/2c6f89d5010c9eb23b5233fed47ac94ebf5e8e41", "message": "CB-9086 Enable host cert rotation on older runtimes", "committedDate": "2020-10-13T15:37:28Z", "type": "forcePushed"}, {"oid": "8c1164f88521850bc6c4bba66d7e5ad9d354c184", "url": "https://github.com/hortonworks/cloudbreak/commit/8c1164f88521850bc6c4bba66d7e5ad9d354c184", "message": "CB-9086 Enable host cert rotation on older runtimes", "committedDate": "2020-10-13T18:03:28Z", "type": "forcePushed"}, {"oid": "10042b431ec52c1796f346123b5a26974e6285ac", "url": "https://github.com/hortonworks/cloudbreak/commit/10042b431ec52c1796f346123b5a26974e6285ac", "message": "CB-9086 Enable host cert rotation on older runtimes", "committedDate": "2020-10-14T09:16:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMjE3NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#discussion_r504722175", "bodyText": "StringUtils.removeEnd(String str, String remove) would be a bit simpler", "author": "lacikaaa", "createdAt": "2020-10-14T14:26:22Z", "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerSecurityService.java", "diffHunk": "@@ -405,4 +417,12 @@ private void processHostCertsBatchResponse(ApiClient client, ApiBatchResponse ap\n             throw new ClouderaManagerOperationFailedException(\"Host certificates rotation batch operation failed: \" + apiBatchResponse);\n         }\n     }\n+\n+    private String createPrivateKeyString(KeyPair sshKeyPair) {\n+        String privateKeyStr = PkiUtil.convert(sshKeyPair.getPrivate());\n+        if (privateKeyStr.endsWith(\"\\n\")) {\n+            privateKeyStr = privateKeyStr.substring(0, privateKeyStr.length() - 1);\n+        }\n+        return privateKeyStr;", "originalCommit": "10042b431ec52c1796f346123b5a26974e6285ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDczMjk4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#discussion_r504732983", "bodyText": "I would refactor this bit as there is almost a condition for every line:\n    protected Selectable doAccept(HandlerEvent event) {\n        LOGGER.debug(\"Accepting Cluster Manager host certificates rotation request...\");\n        ClusterHostCertificatesRotationRequest request = event.getData();\n        Selectable result;\n        try {\n            Stack stack = stackService.getByIdWithListsInTransaction(request.getResourceId());\n            ClusterApi clusterApi = apiConnectors.getConnector(stack);\n            if (isRootSshAccessNeededForHostCertRotation(stack)) {\n                rotateCertsWithSsh(stack, clusterApi);\n            } else {\n                clusterApi.rotateHostCertificates(null, null);\n            }\n            result = new ClusterHostCertificatesRotationSuccess(request.getResourceId());\n        } catch (Exception e) {\n            LOGGER.info(\"Cluster Manager host certificates rotation failed\", e);\n            result = new ClusterCertificatesRotationFailed(request.getResourceId(), e);\n        }\n        return result;\n    }\n\n    private boolean isRootSshAccessNeededForHostCertRotation(Stack stack) {\n        return CMRepositoryVersionUtil.isRootSshAccessNeededForHostCertRotation(\n                clusterComponentConfigProvider.getClouderaManagerRepoDetails(stack.getCluster().getId()));\n    }\n\n    private void rotateCertsWithSsh(Stack stack, ClusterApi clusterApi) throws Exception {\n        KeyPair sshKeyPair = sshKeyService.generateKeyPair();\n        sshKeyService.addSshPublicKeyToHosts(stack, ROOT_USER, sshKeyPair, TEMPORARY_SSH_KEY);\n        clusterApi.rotateHostCertificates(ROOT_USER, sshKeyPair);\n        sshKeyService.removeSshPublicKeyFromHosts(stack, ROOT_USER, TEMPORARY_SSH_KEY);\n    }", "author": "lacikaaa", "createdAt": "2020-10-14T14:39:35Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/reactor/handler/cluster/certrotate/ClusterHostCertificatesRotationHandler.java", "diffHunk": "@@ -46,8 +61,18 @@ protected Selectable doAccept(HandlerEvent event) {\n         Selectable result;\n         try {\n             Stack stack = stackService.getByIdWithListsInTransaction(request.getResourceId());\n+            boolean rootSshAccessNeeded = CMRepositoryVersionUtil.isRootSshAccessNeededForHostCertRotation(\n+                    clusterComponentConfigProvider.getClouderaManagerRepoDetails(stack.getCluster().getId()));\n+            KeyPair sshKeyPair = null;\n+            if (rootSshAccessNeeded) {\n+                sshKeyPair = sshKeyService.generateKeyPair();\n+                sshKeyService.addSshPublicKeyToHosts(stack, ROOT_USER, sshKeyPair, TEMPORARY_SSH_KEY);\n+            }\n             ClusterApi clusterApi = apiConnectors.getConnector(stack);\n-            clusterApi.rotateHostCertificates();\n+            clusterApi.rotateHostCertificates(rootSshAccessNeeded ? ROOT_USER : null, sshKeyPair);\n+            if (rootSshAccessNeeded) {\n+                sshKeyService.removeSshPublicKeyFromHosts(stack, ROOT_USER, TEMPORARY_SSH_KEY);\n+            }", "originalCommit": "10042b431ec52c1796f346123b5a26974e6285ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc0MjY0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#discussion_r504742646", "bodyText": "saltState is always \"ssh.remove_ssh_publickey\"\ncould be moved to a constant and inlined at line #54", "author": "lacikaaa", "createdAt": "2020-10-14T14:51:31Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/ssh/SshKeyService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.cloudbreak.ssh;\n+\n+import java.security.KeyPair;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.certificate.PkiUtil;\n+import com.sequenceiq.cloudbreak.core.bootstrap.service.ClusterDeletionBasedExitCriteriaModel;\n+import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.domain.stack.cluster.Cluster;\n+import com.sequenceiq.cloudbreak.orchestrator.host.HostOrchestrator;\n+import com.sequenceiq.cloudbreak.orchestrator.host.OrchestratorStateParams;\n+import com.sequenceiq.cloudbreak.orchestrator.model.Node;\n+import com.sequenceiq.cloudbreak.service.GatewayConfigService;\n+import com.sequenceiq.cloudbreak.util.StackUtil;\n+\n+@Component\n+public class SshKeyService {\n+    @Inject\n+    private HostOrchestrator hostOrchestrator;\n+\n+    @Inject\n+    private GatewayConfigService gatewayConfigService;\n+\n+    @Inject\n+    private StackUtil stackUtil;\n+\n+    public KeyPair generateKeyPair() {\n+        return PkiUtil.generateKeypair();\n+    }\n+\n+    public void addSshPublicKeyToHosts(Stack stack, String user, KeyPair keyPair, String authKeysComment) throws Exception {\n+        OrchestratorStateParams stateParams = createSshStateParams(stack, user, keyPair, authKeysComment, \"ssh.remove_ssh_publickey\");\n+        hostOrchestrator.runOrchestratorState(stateParams);\n+        stateParams.setState(\"ssh.add_ssh_publickey\");\n+        hostOrchestrator.runOrchestratorState(stateParams);\n+    }\n+\n+    public void removeSshPublicKeyFromHosts(Stack stack, String user, String authKeysComment) throws Exception {\n+        OrchestratorStateParams stateParams = createSshStateParams(stack, user, null, authKeysComment, \"ssh.remove_ssh_publickey\");\n+        hostOrchestrator.runOrchestratorState(stateParams);\n+    }\n+\n+    private OrchestratorStateParams createSshStateParams(Stack stack, String user, KeyPair keyPair, String authKeysComment, String saltState) {", "originalCommit": "10042b431ec52c1796f346123b5a26974e6285ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c6a38ca2f988c9d2935f4dc1796804c76454294c", "url": "https://github.com/hortonworks/cloudbreak/commit/c6a38ca2f988c9d2935f4dc1796804c76454294c", "message": "CB-9086 Enable host cert rotation on older runtimes\nOn clusters with older than 7.2.1 version for CM host certificates rotation root ssh access is needed.\nThe following changes are introduced  for this:\n- Extend HostOrchestrator / SaltOrchestrator with new method for execute specific saltstates\n- Introducing new salt states for ssh key adding / removal for given users on hosts\n- Extend host certs rotation with adding temporary ssh access for root user during host cert rotation api call. This is only needed on clusters with older than 7.2.1 version.\n\nCB-9297 add 755 permission for CM agent cert directory after host certs rotation on all hosts. This is needed to workaround OPSAPS-58475.", "committedDate": "2020-10-15T11:58:18Z", "type": "forcePushed"}, {"oid": "b8d4691e4b155a348e6a1b68fed90f04e284e651", "url": "https://github.com/hortonworks/cloudbreak/commit/b8d4691e4b155a348e6a1b68fed90f04e284e651", "message": "CB-9086 Enable host cert rotation on older runtimes\nOn clusters with older than 7.2.1 version for CM host certificates rotation root ssh access is needed.\nThe following changes are introduced  for this:\n- Extend HostOrchestrator / SaltOrchestrator with new method for execute specific saltstates\n- Introducing new salt states for ssh key adding / removal for given users on hosts\n- Extend host certs rotation with adding temporary ssh access for root user during host cert rotation api call. This is only needed on clusters with older than 7.2.1 version.\n\nCB-9297 add 755 permission for CM agent cert directory after host certs rotation on all hosts. This is needed to workaround OPSAPS-58475.", "committedDate": "2020-10-15T13:05:30Z", "type": "commit"}, {"oid": "b8d4691e4b155a348e6a1b68fed90f04e284e651", "url": "https://github.com/hortonworks/cloudbreak/commit/b8d4691e4b155a348e6a1b68fed90f04e284e651", "message": "CB-9086 Enable host cert rotation on older runtimes\nOn clusters with older than 7.2.1 version for CM host certificates rotation root ssh access is needed.\nThe following changes are introduced  for this:\n- Extend HostOrchestrator / SaltOrchestrator with new method for execute specific saltstates\n- Introducing new salt states for ssh key adding / removal for given users on hosts\n- Extend host certs rotation with adding temporary ssh access for root user during host cert rotation api call. This is only needed on clusters with older than 7.2.1 version.\n\nCB-9297 add 755 permission for CM agent cert directory after host certs rotation on all hosts. This is needed to workaround OPSAPS-58475.", "committedDate": "2020-10-15T13:05:30Z", "type": "forcePushed"}]}