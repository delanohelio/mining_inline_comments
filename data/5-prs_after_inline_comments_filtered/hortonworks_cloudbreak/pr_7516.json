{"pr_number": 7516, "pr_title": "CB-5339 - Adding automated cloud backups to FreeIPA", "pr_createdAt": "2020-03-09T18:24:55Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7516", "timeline": [{"oid": "d986dcc432bc0d4ff640a79de43b9be30111cadb", "url": "https://github.com/hortonworks/cloudbreak/commit/d986dcc432bc0d4ff640a79de43b9be30111cadb", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.", "committedDate": "2020-03-09T19:17:21Z", "type": "forcePushed"}, {"oid": "532ceec6428c5a3cd13c04d6304324c5b03759ca", "url": "https://github.com/hortonworks/cloudbreak/commit/532ceec6428c5a3cd13c04d6304324c5b03759ca", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.", "committedDate": "2020-03-10T03:08:41Z", "type": "forcePushed"}, {"oid": "2c91b59a59bb4831559d774d84ded4c1dd62b78e", "url": "https://github.com/hortonworks/cloudbreak/commit/2c91b59a59bb4831559d774d84ded4c1dd62b78e", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.", "committedDate": "2020-03-10T14:07:14Z", "type": "forcePushed"}, {"oid": "8cd05133035205cc7d1437f6e4ab99dab91020de", "url": "https://github.com/hortonworks/cloudbreak/commit/8cd05133035205cc7d1437f6e4ab99dab91020de", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.", "committedDate": "2020-03-10T14:40:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NTY2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390455662", "bodyText": "remove empty line please", "author": "lacikaaa", "createdAt": "2020-03-10T16:42:56Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaCreationService.java", "diffHunk": "@@ -115,8 +120,15 @@ public DescribeFreeIpaResponse launchFreeIpa(CreateFreeIpaRequest request, Strin\n         Telemetry telemetry = stack.getTelemetry();\n         cloudStorageFolderResolverService.updateStorageLocation(telemetry,\n                 FluentClusterType.FREEIPA.value(), stack.getName(), stack.getResourceCrn());\n+", "originalCommit": "8cd05133035205cc7d1437f6e4ab99dab91020de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1NzI3OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390557279", "bodyText": "done", "author": "wonderslug", "createdAt": "2020-03-10T19:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NTY2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3ODI4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390478283", "bodyText": "could you change it to a more meaningful name?", "author": "lacikaaa", "createdAt": "2020-03-10T17:15:52Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/backup/cloud/AdlsGen2BackupConfigGenerator.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.sequenceiq.freeipa.service.freeipa.backup.cloud;\n+\n+import java.nio.file.Paths;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.exception.CloudbreakServiceException;\n+import com.sequenceiq.cloudbreak.telemetry.fluent.cloud.AdlsGen2Config;\n+\n+@Component\n+public class AdlsGen2BackupConfigGenerator extends CloudBackupConfigGenerator<AdlsGen2Config> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AdlsGen2BackupConfigGenerator.class);\n+\n+    private static final String[] ADLS_GEN2_SCHEME_PREFIXES = {\"abfs://\", \"abfss://\"};\n+\n+    private static final String AZURE_DFS_DOMAIN_SUFFIX = \".dfs.core.windows.net\";\n+\n+    private static final String AZURE_BLOB_STORAGE_SUFFIX = \"blob.core.windows.net\";\n+\n+    private static final String AZURE_BLOB_STORAGE_SCHEMA = \"https://\";\n+\n+    @Override\n+    public String generateBackupLocation(String location, String clusterType,\n+            String clusterName, String clusterId) {\n+        AdlsGen2Config adlsGen2Config = generateBackupConfig(location);\n+        String logFolder = resolveBackupFolder(adlsGen2Config, clusterType, clusterName, clusterId);\n+        String hostPart = String.format(\"%s.%s\", adlsGen2Config.getAccount(), AZURE_BLOB_STORAGE_SUFFIX);\n+        String generatedLocation = String.format(\"%s%s\", AZURE_BLOB_STORAGE_SCHEMA,\n+                Paths.get(hostPart, adlsGen2Config.getFileSystem(), logFolder));\n+        LOGGER.info(\"The following ADLS Gen2 base folder location is generated: {} (from {})\",\n+                generatedLocation, location);\n+        return generatedLocation;\n+    }\n+\n+    private AdlsGen2Config generateBackupConfig(String location) {\n+        if (StringUtils.isNotEmpty(location)) {\n+            boolean secure = location.startsWith(ADLS_GEN2_SCHEME_PREFIXES[1]);\n+            String locationWithoutScheme = getLocationWithoutSchemePrefixes(location, ADLS_GEN2_SCHEME_PREFIXES);\n+            String[] split = locationWithoutScheme.split(\"@\");", "originalCommit": "8cd05133035205cc7d1437f6e4ab99dab91020de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1Mzk3OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390553979", "bodyText": "which part?", "author": "wonderslug", "createdAt": "2020-03-10T19:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3ODI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA3OTMyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391079328", "bodyText": "the variable split", "author": "lacikaaa", "createdAt": "2020-03-11T15:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3ODI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5MTg0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391091844", "bodyText": "Done", "author": "wonderslug", "createdAt": "2020-03-11T16:16:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3ODI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4MDI4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390480286", "bodyText": "so many magic numbers. why 2?", "author": "lacikaaa", "createdAt": "2020-03-10T17:18:48Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/backup/cloud/AdlsGen2BackupConfigGenerator.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.sequenceiq.freeipa.service.freeipa.backup.cloud;\n+\n+import java.nio.file.Paths;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.exception.CloudbreakServiceException;\n+import com.sequenceiq.cloudbreak.telemetry.fluent.cloud.AdlsGen2Config;\n+\n+@Component\n+public class AdlsGen2BackupConfigGenerator extends CloudBackupConfigGenerator<AdlsGen2Config> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AdlsGen2BackupConfigGenerator.class);\n+\n+    private static final String[] ADLS_GEN2_SCHEME_PREFIXES = {\"abfs://\", \"abfss://\"};\n+\n+    private static final String AZURE_DFS_DOMAIN_SUFFIX = \".dfs.core.windows.net\";\n+\n+    private static final String AZURE_BLOB_STORAGE_SUFFIX = \"blob.core.windows.net\";\n+\n+    private static final String AZURE_BLOB_STORAGE_SCHEMA = \"https://\";\n+\n+    @Override\n+    public String generateBackupLocation(String location, String clusterType,\n+            String clusterName, String clusterId) {\n+        AdlsGen2Config adlsGen2Config = generateBackupConfig(location);\n+        String logFolder = resolveBackupFolder(adlsGen2Config, clusterType, clusterName, clusterId);\n+        String hostPart = String.format(\"%s.%s\", adlsGen2Config.getAccount(), AZURE_BLOB_STORAGE_SUFFIX);\n+        String generatedLocation = String.format(\"%s%s\", AZURE_BLOB_STORAGE_SCHEMA,\n+                Paths.get(hostPart, adlsGen2Config.getFileSystem(), logFolder));\n+        LOGGER.info(\"The following ADLS Gen2 base folder location is generated: {} (from {})\",\n+                generatedLocation, location);\n+        return generatedLocation;\n+    }\n+\n+    private AdlsGen2Config generateBackupConfig(String location) {\n+        if (StringUtils.isNotEmpty(location)) {\n+            boolean secure = location.startsWith(ADLS_GEN2_SCHEME_PREFIXES[1]);\n+            String locationWithoutScheme = getLocationWithoutSchemePrefixes(location, ADLS_GEN2_SCHEME_PREFIXES);\n+            String[] split = locationWithoutScheme.split(\"@\");\n+            String[] storageWithSuffix = split[0].split(\"/\", 2);\n+            String folderPrefix = storageWithSuffix.length < 2 ? \"\" :  \"/\" + storageWithSuffix[1];\n+            if (split.length < 2) {\n+                return new AdlsGen2Config(folderPrefix, storageWithSuffix[0], null, secure);\n+            } else {\n+                String[] splitByDomain = split[1].split(AZURE_DFS_DOMAIN_SUFFIX);\n+                String account = splitByDomain[0];\n+                if (splitByDomain.length > 1) {\n+                    String folderPrefixAfterDomain = splitByDomain[1];", "originalCommit": "8cd05133035205cc7d1437f6e4ab99dab91020de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MTc0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390551746", "bodyText": "This is a direct copy of the Telemetry processing of the storage locations for logging.  Do we want to change this overall?", "author": "wonderslug", "createdAt": "2020-03-10T19:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4MDI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA4MDYyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391080629", "bodyText": "then comes the question, why do we have to copy if it's the same?", "author": "lacikaaa", "createdAt": "2020-03-11T16:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4MDI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA4MzQ5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391083495", "bodyText": "The functions and flow is not an outright copy. Right now it is using very similar logic on the parsing of the adls container and s3 buckets paths, but the functions are slightly different with the base backups folder being different and a changed call path.\nAs well, later on, we will be moving to a dedicated selection of the backup storage location to a stand-alone bucket/container but the UI and flow work was unable to be done in the time needed for that call. This allows for the separate parsing mechanism for the backup once it moves away from the telemetry storage location.", "author": "wonderslug", "createdAt": "2020-03-11T16:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4MDI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NTk2NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390485965", "bodyText": "backup related stuff could be under backup as they logically stick together", "author": "lacikaaa", "createdAt": "2020-03-10T17:27:24Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/config/FreeIpaConfigView.java", "diffHunk": "@@ -0,0 +1,248 @@\n+package com.sequenceiq.freeipa.service.freeipa.config;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.collections.CollectionUtils;\n+import org.apache.commons.lang3.ObjectUtils;\n+\n+import com.sequenceiq.cloudbreak.orchestrator.model.Node;\n+\n+public class FreeIpaConfigView {\n+\n+    private static final String EMPTY_CONFIG_DEFAULT = \"\";\n+\n+    private final boolean backupEnabled;\n+\n+    private final boolean monthlyFullBackUpEnabled;\n+\n+    private final boolean hourlyBackUpEnabled;\n+\n+    private final boolean initialFullBackupEnabled;\n+\n+    private final String backupPlatform;\n+\n+    private final String backupLocation;\n+\n+    private final String realm;\n+\n+    private final String domain;\n+\n+    private final String password;\n+\n+    private final String reverseZones;\n+\n+    private final String adminUser;\n+\n+    private final String freeipaToReplicate;\n+\n+    private final Set<Object> hosts;\n+\n+    private final String azureInstanceMsi;\n+\n+    @SuppressWarnings(\"ExecutableStatementCount\")\n+    private FreeIpaConfigView(Builder builder) {\n+        this.backupEnabled = builder.backupEnabled;\n+        this.monthlyFullBackUpEnabled = builder.monthlyFullBackUpEnabled;\n+        this.hourlyBackUpEnabled = builder.hourlyBackUpEnabled;\n+        this.initialFullBackupEnabled = builder.initialFullBackupEnabled;\n+        this.backupLocation = builder.backupLocation;\n+        this.backupPlatform = builder.backupPlatform;\n+        this.realm = builder.realm;\n+        this.domain = builder.domain;\n+        this.password = builder.password;\n+        this.reverseZones = builder.reverseZones;\n+        this.adminUser = builder.adminUser;\n+        this.freeipaToReplicate = builder.freeipaToReplicate;\n+        this.hosts = builder.hosts;\n+        this.azureInstanceMsi = builder.azureInstanceMsi;\n+    }\n+\n+    public String getBackupLocation() {\n+        return backupLocation;\n+    }\n+\n+    public String getRealm() {\n+        return realm;\n+    }\n+\n+    public String getDomain() {\n+        return domain;\n+    }\n+\n+    public String getPassword() {\n+        return password;\n+    }\n+\n+    public String getReverseZones() {\n+        return reverseZones;\n+    }\n+\n+    public String getAdminUser() {\n+        return adminUser;\n+    }\n+\n+    public String getFreeipaToReplicate() {\n+        return freeipaToReplicate;\n+    }\n+\n+    public Set<Object> getHosts() {\n+        return hosts;\n+    }\n+\n+    public boolean isBackupEnabled() {\n+        return backupEnabled;\n+    }\n+\n+    public boolean isMonthlyFullBackUpEnabled() {\n+        return monthlyFullBackUpEnabled;\n+    }\n+\n+    public boolean isHourlyBackUpEnabled() {\n+        return hourlyBackUpEnabled;\n+    }\n+\n+    public boolean isInitialFullBackupEnabled() {\n+        return initialFullBackupEnabled;\n+    }\n+\n+    public String getBackupPlatform() {\n+        return backupPlatform;\n+    }\n+\n+    public String getAzureInstanceMsi() {\n+        return azureInstanceMsi;\n+    }\n+\n+    @SuppressWarnings(\"ExecutableStatementCount\")\n+    public Map<String, Object> toMap() {\n+        Map<String, Object> map = new HashMap<>();\n+        map.put(\"backup_enabled\", this.backupEnabled);\n+        map.put(\"backup_location\", ObjectUtils.defaultIfNull(this.backupLocation, EMPTY_CONFIG_DEFAULT));\n+        map.put(\"monthly_full_backup_enabled\", this.monthlyFullBackUpEnabled);\n+        map.put(\"hourly_backup_enabled\", this.hourlyBackUpEnabled);\n+        map.put(\"initial_full_backup_enabled\", this.initialFullBackupEnabled);\n+        map.put(\"backup_platform\", ObjectUtils.defaultIfNull(this.backupPlatform, EMPTY_CONFIG_DEFAULT));", "originalCommit": "8cd05133035205cc7d1437f6e4ab99dab91020de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNjM3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391636371", "bodyText": "Ill see if I can do this", "author": "wonderslug", "createdAt": "2020-03-12T13:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NTk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc2ODc1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391768754", "bodyText": "Changed the structure", "author": "wonderslug", "createdAt": "2020-03-12T17:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NTk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4OTAwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390489000", "bodyText": "I think S3BackupConfigGenerator and AdlsGen2BackupConfigGenerator should be tested in different test, and here you should test the logic related to CloudBackupFolderResolverService. I have a feeling that not all the cases are covered here, and it would be too complex to test it through this class", "author": "lacikaaa", "createdAt": "2020-03-10T17:32:03Z", "path": "freeipa/src/test/java/com/sequenceiq/freeipa/service/freeipa/backup/cloud/CloudBackupFolderResolverServiceTest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.sequenceiq.freeipa.service.freeipa.backup.cloud;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import com.sequenceiq.cloudbreak.auth.altus.CrnParseException;\n+import com.sequenceiq.cloudbreak.telemetry.fluent.FluentClusterType;\n+import com.sequenceiq.common.api.cloudstorage.old.AdlsGen2CloudStorageV1Parameters;\n+import com.sequenceiq.common.api.cloudstorage.old.S3CloudStorageV1Parameters;\n+import com.sequenceiq.freeipa.api.model.Backup;\n+\n+public class CloudBackupFolderResolverServiceTest {", "originalCommit": "8cd05133035205cc7d1437f6e4ab99dab91020de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5MTQ4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391091486", "bodyText": "Fair enough.   don.", "author": "wonderslug", "createdAt": "2020-03-11T16:15:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4OTAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5MDY3NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390490675", "bodyText": "it's a bit strange that we use the telemetry settings for backup. Is it really a good idea?", "author": "lacikaaa", "createdAt": "2020-03-10T17:34:33Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/converter/backup/BackupConverter.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package com.sequenceiq.freeipa.converter.backup;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.common.api.cloudstorage.old.AdlsGen2CloudStorageV1Parameters;\n+import com.sequenceiq.common.api.cloudstorage.old.S3CloudStorageV1Parameters;\n+import com.sequenceiq.common.api.telemetry.request.LoggingRequest;\n+import com.sequenceiq.common.api.telemetry.request.TelemetryRequest;\n+import com.sequenceiq.freeipa.api.model.Backup;\n+import com.sequenceiq.freeipa.configuration.BackupConfiguration;\n+\n+@Component\n+public class BackupConverter {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BackupConverter.class);\n+\n+    private final boolean freeIpaBackupEnabled;\n+\n+    private final BackupConfiguration backupConfiguration;\n+\n+    public BackupConverter(BackupConfiguration backupConfiguration,\n+            @Value(\"${freeipa.backup.enabled:true}\") boolean freeIpaBackupEnabled) {\n+        this.backupConfiguration = backupConfiguration;\n+        this.freeIpaBackupEnabled = freeIpaBackupEnabled;\n+    }\n+\n+    public Backup convert(TelemetryRequest request) {", "originalCommit": "8cd05133035205cc7d1437f6e4ab99dab91020de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MzM3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390553373", "bodyText": "This is a shorter-term decision so we did not have to introduce using another s3 bucket or azure container.  We do not have time to introduce all the UI and flow components to support the additional storage location at the moment.  The Logging bucket/container is currently the only one available to the freeipa at the moment.", "author": "wonderslug", "createdAt": "2020-03-10T19:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5MDY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5NDMwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r393894308", "bodyText": "i would suggest to support this from the API (env or probably better for freeipa) in this PR already, as backup is nothing to do with telemetry, especially with logging. use this \"temporal\" solution (to fill data from telemetry) only if backup request is not filled in the freeipa (env?) request. so if the UI will support it you can remove the logging usage (but you will have everything that is needed for the UI to implement that)", "author": "oleewere", "createdAt": "2020-03-17T18:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5MDY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1MjY5NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r393952694", "bodyText": "We can change this when we add support for UI configuration.  I've added https://jira.cloudera.com/browse/CB-6146", "author": "holleyism", "createdAt": "2020-03-17T20:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5MDY3NQ=="}], "type": "inlineReview"}, {"oid": "97ace46c88be40a9d6f918d596bf8fddf0aa3657", "url": "https://github.com/hortonworks/cloudbreak/commit/97ace46c88be40a9d6f918d596bf8fddf0aa3657", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.", "committedDate": "2020-03-10T19:27:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1Mzc0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r390953748", "bodyText": "why duplicate this kind of classes/implementations from common ? most of the code looks duplication", "author": "oleewere", "createdAt": "2020-03-11T13:03:16Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/backup/cloud/AdlsGen2BackupConfigGenerator.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.sequenceiq.freeipa.service.freeipa.backup.cloud;\n+\n+import java.nio.file.Paths;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.exception.CloudbreakServiceException;\n+import com.sequenceiq.cloudbreak.telemetry.fluent.cloud.AdlsGen2Config;\n+\n+@Component\n+public class AdlsGen2BackupConfigGenerator extends CloudBackupConfigGenerator<AdlsGen2Config> {", "originalCommit": "97ace46c88be40a9d6f918d596bf8fddf0aa3657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAwMTE0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391001144", "bodyText": "Its not an outright copy.  Right now it is using very similar logic on the parsing of the adls container and s3 buckets paths, but the functions are slightly different with the base backups folder being different and a changed call path.\nAs well, later on we will be moving to a dedicated selection of the backup storage location to a stand-alone bucket/container but the UI and flow work was unable to be done in the time needed for that call.  This allows for the seperate parsing mechanism for the backup once it moves away from the telementry storage location.", "author": "wonderslug", "createdAt": "2020-03-11T14:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1Mzc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEyOTc2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391129761", "bodyText": "you can make things more abstract, but fine...btw it's nothing to do with Fluent but it has many references for it, so that looks logically invalid for me (for example: using fluent cluster type that is used as a string in fluentd related configs - so if i would change that for logging it would affect this code as well)", "author": "oleewere", "createdAt": "2020-03-11T17:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1Mzc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM1OTY1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391359654", "bodyText": "Fair enough.  I refactored it to be more independent.  There is a single value enum because It will be added to later on when it gets more options.", "author": "wonderslug", "createdAt": "2020-03-12T01:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1Mzc0OA=="}], "type": "inlineReview"}, {"oid": "2776c4000487fd3c3d0fde4ccedc20507ebc20ad", "url": "https://github.com/hortonworks/cloudbreak/commit/2776c4000487fd3c3d0fde4ccedc20507ebc20ad", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.", "committedDate": "2020-03-11T16:14:56Z", "type": "forcePushed"}, {"oid": "341338dc07933eb05f08e51dc60c29b103e013b6", "url": "https://github.com/hortonworks/cloudbreak/commit/341338dc07933eb05f08e51dc60c29b103e013b6", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.", "committedDate": "2020-03-12T01:37:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwNzY1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391707653", "bodyText": "im wondering why is this needed here. I had to split and store different parts of the storage location parts (scheme + host + path) because of fluentd configuration requirements, i think in your case the path will work as is as you are using s3 tool for the upload (probably same is true for azure)...so probably most of these path generator code are not required at all...just pass the storage location as is (with appending the cluster-backup and cluster name/id prefixes)", "author": "oleewere", "createdAt": "2020-03-12T15:38:06Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/backup/cloud/CloudBackupConfigGenerator.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package com.sequenceiq.freeipa.service.freeipa.backup.cloud;\n+\n+import java.nio.file.Paths;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public abstract class CloudBackupConfigGenerator<T extends CloudBackupStorageConfig> {\n+\n+    protected static final String CLUSTER_BACKUP_PREFIX = \"cluster-backups\";\n+\n+    public abstract String generateBackupLocation(String location, String clusterType,\n+            String clusterName, String clusterId);\n+\n+    String getLocationWithoutSchemePrefixes(String input, String... schemePrefixes) {", "originalCommit": "341338dc07933eb05f08e51dc60c29b103e013b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc3MTY1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391771653", "bodyText": "Actually this needs the exact same sort of segmentation as logs.  Adding additional user-defined folders as well as segmenting the into the per cluster based folders is all still necessary.", "author": "wonderslug", "createdAt": "2020-03-12T17:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwNzY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc3Mjc2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391772767", "bodyText": "An example of this is right now in out SDX environments we have a shared bucket which we put in the environment name as the top-level under the bucket in order to allow us to put the logs and data both under that bucket on a per-environment basis", "author": "wonderslug", "createdAt": "2020-03-12T17:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwNzY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk2NDU1MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7516#discussion_r391964551", "bodyText": "but is the splitting really needed? concat segments would be enough instead of the generator service usage as schema/host parts can be included in (at least) s3 tool (so object transformations can be avoided)", "author": "oleewere", "createdAt": "2020-03-12T23:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwNzY1Mw=="}], "type": "inlineReview"}, {"oid": "c8ecac723c43033a53dcc65829f1f3fe25254a18", "url": "https://github.com/hortonworks/cloudbreak/commit/c8ecac723c43033a53dcc65829f1f3fe25254a18", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.\n\nCo-authored-by: holleyism <git@holleyism.com>", "committedDate": "2020-03-12T17:10:37Z", "type": "forcePushed"}, {"oid": "544c24bdb5546e57df82e511e50b649309a7531a", "url": "https://github.com/hortonworks/cloudbreak/commit/544c24bdb5546e57df82e511e50b649309a7531a", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.\n\nCo-authored-by: holleyism <git@holleyism.com>", "committedDate": "2020-03-12T19:23:50Z", "type": "forcePushed"}, {"oid": "bf22afbf1f350900a914b2a8095e7d569cc7f82a", "url": "https://github.com/hortonworks/cloudbreak/commit/bf22afbf1f350900a914b2a8095e7d569cc7f82a", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.\n\nCo-authored-by: holleyism <git@holleyism.com>", "committedDate": "2020-03-12T20:16:58Z", "type": "forcePushed"}, {"oid": "a8bf4af5ccdd434b027601cf6a18e3b74bdbb425", "url": "https://github.com/hortonworks/cloudbreak/commit/a8bf4af5ccdd434b027601cf6a18e3b74bdbb425", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.\n\nTest line for push test.\n\nCo-authored-by: holleyism <git@holleyism.com>", "committedDate": "2020-03-13T14:22:06Z", "type": "forcePushed"}, {"oid": "fe30f7387502d5c5d41b67ec262a4e02f95d115e", "url": "https://github.com/hortonworks/cloudbreak/commit/fe30f7387502d5c5d41b67ec262a4e02f95d115e", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.\n\nTest line for push test.\n\nCo-authored-by: holleyism <git@holleyism.com>", "committedDate": "2020-03-17T04:08:27Z", "type": "forcePushed"}, {"oid": "3084202e3010c1bf70d344365f9796c0984636e7", "url": "https://github.com/hortonworks/cloudbreak/commit/3084202e3010c1bf70d344365f9796c0984636e7", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.\n\nCo-authored-by: holleyism <git@holleyism.com>", "committedDate": "2020-03-17T20:34:39Z", "type": "forcePushed"}, {"oid": "7a25845513c1f0fc4126624cc09a5be04e96b3cf", "url": "https://github.com/hortonworks/cloudbreak/commit/7a25845513c1f0fc4126624cc09a5be04e96b3cf", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.\n\nCo-authored-by: holleyism <git@holleyism.com>\nCo-authored-by: Jamison Bennett <jamison.bennett@gmail.com>", "committedDate": "2020-03-20T21:33:33Z", "type": "commit"}, {"oid": "7a25845513c1f0fc4126624cc09a5be04e96b3cf", "url": "https://github.com/hortonworks/cloudbreak/commit/7a25845513c1f0fc4126624cc09a5be04e96b3cf", "message": "CB-5339 - Adding automated cloud backups to FreeIPA\n\nThis adds support for automated backup of the FreeIPA\nservice.  It backups up to the cloud provider defined\nby the telemetry and uses the same logging bucket or\ncontainer as well as the Identity.\n\nIt will determine the backup directory root pathing\nsimilarly to the way telemetry does.\n\nIt stores the backup configuration with the stack so\nthat as we add its own bucket later on, backward\ncompatibility can be maintained.\n\nCo-authored-by: holleyism <git@holleyism.com>\nCo-authored-by: Jamison Bennett <jamison.bennett@gmail.com>", "committedDate": "2020-03-20T21:33:33Z", "type": "forcePushed"}]}