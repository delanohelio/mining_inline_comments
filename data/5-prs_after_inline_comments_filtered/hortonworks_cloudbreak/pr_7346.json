{"pr_number": 7346, "pr_title": "CB-5642 Put flow into runningFlows before save flow to the DB", "pr_createdAt": "2020-02-21T07:10:46Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7346", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQyODAyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7346#discussion_r382428022", "bodyText": "Could you please write few unit tests?", "author": "topolyai5", "createdAt": "2020-02-21T07:15:13Z", "path": "flow/src/main/java/com/sequenceiq/flow/core/Flow2Handler.java", "diffHunk": "@@ -109,10 +109,16 @@ private void handle(String key, Payload payload, FlowParameters flowParameters,\n                         flowParameters.setFlowId(flowId);\n                         Flow flow = flowConfig.createFlow(flowId, payload.getResourceId());\n                         flow.initialize(contextParams);\n-                        flowLogService.save(flowParameters, flowChainId, key, payload, null, flowConfig.getClass(), flow.getCurrentState());\n+                        runningFlows.put(flow, flowChainId);\n+                        try {\n+                            flowLogService.save(flowParameters, flowChainId, key, payload, null, flowConfig.getClass(), flow.getCurrentState());\n+                        } catch (Exception e) {\n+                            LOGGER.error(\"Can't save flow: {}\", flowId);\n+                            runningFlows.remove(flowId);\n+                            throw e;\n+                        }", "originalCommit": "e7f84282883a2a2e0a7c9d041ab41dd438f4d0bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ3NTU0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7346#discussion_r382475544", "bodyText": "Done! Thanks", "author": "sodre90", "createdAt": "2020-02-21T09:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQyODAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzNjQ3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7346#discussion_r382436470", "bodyText": "This method says nothing about when it should run. Can you please rename it or just inline the underlying implementation which is so simple:\nnodeConfig.isNodeIdSpecified()", "author": "foldik", "createdAt": "2020-02-21T07:43:24Z", "path": "flow/src/main/java/com/sequenceiq/cloudbreak/service/ha/HeartbeatService.java", "diffHunk": "@@ -119,12 +119,14 @@ public void heartbeat() {\n     @Scheduled(initialDelay = 35000L, fixedDelay = 30000L)\n     public void scheduledFlowDistribution() {\n         if (shouldRun()) {", "originalCommit": "e7f84282883a2a2e0a7c9d041ab41dd438f4d0bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bfcd8a2edd174c36f62cea078b84dde3b71c2f02", "url": "https://github.com/hortonworks/cloudbreak/commit/bfcd8a2edd174c36f62cea078b84dde3b71c2f02", "message": "CB-5642 Put flow into runningFlows before save flow to the DB", "committedDate": "2020-02-21T09:15:08Z", "type": "commit"}, {"oid": "bfcd8a2edd174c36f62cea078b84dde3b71c2f02", "url": "https://github.com/hortonworks/cloudbreak/commit/bfcd8a2edd174c36f62cea078b84dde3b71c2f02", "message": "CB-5642 Put flow into runningFlows before save flow to the DB", "committedDate": "2020-02-21T09:15:08Z", "type": "forcePushed"}]}