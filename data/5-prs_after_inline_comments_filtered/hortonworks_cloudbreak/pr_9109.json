{"pr_number": 9109, "pr_title": "CB-9056. Prevent restart of clusters creating new machines user acces\u2026", "pr_createdAt": "2020-09-30T11:10:49Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9109", "timeline": [{"oid": "5202f294020798d5e5459209ff2d60167ad2affa", "url": "https://github.com/hortonworks/cloudbreak/commit/5202f294020798d5e5459209ff2d60167ad2affa", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)", "committedDate": "2020-09-30T14:09:00Z", "type": "forcePushed"}, {"oid": "de4adef7bb6f990bd12a33c549222b29b8901e1e", "url": "https://github.com/hortonworks/cloudbreak/commit/de4adef7bb6f990bd12a33c549222b29b8901e1e", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)", "committedDate": "2020-09-30T16:00:51Z", "type": "forcePushed"}, {"oid": "c7b335d16bad0478cf1c08b34e05a0dcd04a0257", "url": "https://github.com/hortonworks/cloudbreak/commit/c7b335d16bad0478cf1c08b34e05a0dcd04a0257", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java", "committedDate": "2020-10-01T10:23:06Z", "type": "forcePushed"}, {"oid": "ff9f605e06d55399da933e12e54ee3234ed03eb6", "url": "https://github.com/hortonworks/cloudbreak/commit/ff9f605e06d55399da933e12e54ee3234ed03eb6", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java", "committedDate": "2020-10-01T10:38:01Z", "type": "forcePushed"}, {"oid": "e128612b7ed269492c0655d66453a28d1f115df7", "url": "https://github.com/hortonworks/cloudbreak/commit/e128612b7ed269492c0655d66453a28d1f115df7", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java", "committedDate": "2020-10-02T16:11:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ0MjM0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#discussion_r499442346", "bodyText": "Isn't there a cheaper method of validating wether and access key exists or works?\nGetAccessKeyVerificationData? I'm not sure it's better, but listing all keys seems tedious.", "author": "lnardai", "createdAt": "2020-10-05T08:55:41Z", "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -640,6 +640,24 @@ public void deleteMachineUserAccessKeys(String actorCrn, String accountId, Strin\n         }\n     }\n \n+    /**\n+     * Check that machine user has a specific access key in UMS\n+     * @param actorCrn actor for the machine user request\n+     * @param accountId the account ID\n+     * @param machineUserCrn machine user crn that own the access key\n+     * @param accessKeyId access key id that we need to check\n+     * @return result that is true if the machine user has the queried access key in UMS\n+     */\n+    public boolean doesMachineUserHasAccessKey(String actorCrn, String accountId,\n+            String machineUserCrn, String accessKeyId) {\n+        try (ManagedChannelWrapper channelWrapper = makeWrapper()) {\n+            UmsClient client = makeClient(channelWrapper.getChannel(), actorCrn);\n+            String requestId = UUID.randomUUID().toString();\n+            List<String> accessKeys = client.listMachineUserAccessKeys(requestId, actorCrn, accountId, machineUserCrn, true);", "originalCommit": "e128612b7ed269492c0655d66453a28d1f115df7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4MzI1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#discussion_r499583256", "bodyText": "that's only listing the access keys that are assigned to the generated machine user + we need to first check the machine user existence itself anyway + with this no any new calls added. so i think that should be fine for now (can be refactored later)", "author": "oleewere", "createdAt": "2020-10-05T13:05:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ0MjM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ3Njk3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#discussion_r499476972", "bodyText": "It's quite confusing that you did not kept the order of variables but used the same name for the method! Somewhere the actorCrn is first, but here machineUserName is the first sine. Since we are only using strings here it's easy to misuse these methods.", "author": "lnardai", "createdAt": "2020-10-05T09:51:36Z", "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java", "diffHunk": "@@ -40,6 +40,27 @@ public AltusIAMService(GrpcUmsClient umsClient,\n                         UserManagementProto.AccessKeyType.Value.ED25519)));\n     }\n \n+    /**\n+     * Checks that machine user has a specific access key on UMS side\n+     */\n+    public boolean doesMachineUserHasAccessKey(String machineUserName, String accessKey, String actorCrn, String accountId,", "originalCommit": "e128612b7ed269492c0655d66453a28d1f115df7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4MzQzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#discussion_r499583430", "bodyText": "ok,right, im fixing it", "author": "oleewere", "createdAt": "2020-10-05T13:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ3Njk3Mg=="}], "type": "inlineReview"}, {"oid": "e733188cfcefcb969aad98e890cc24e611f152ed", "url": "https://github.com/hortonworks/cloudbreak/commit/e733188cfcefcb969aad98e890cc24e611f152ed", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java", "committedDate": "2020-10-05T13:10:31Z", "type": "commit"}, {"oid": "e733188cfcefcb969aad98e890cc24e611f152ed", "url": "https://github.com/hortonworks/cloudbreak/commit/e733188cfcefcb969aad98e890cc24e611f152ed", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java", "committedDate": "2020-10-05T13:10:31Z", "type": "forcePushed"}]}