{"pr_number": 9139, "pr_title": "CB-9060 Check if certificates on cluster are about to expire", "pr_createdAt": "2020-10-02T16:10:44Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9139", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI1NDY4MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9139#discussion_r499254680", "bodyText": "Can you please add a few log lines here?", "author": "keyki", "createdAt": "2020-10-04T14:50:26Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/job/StackStatusCheckerJob.java", "diffHunk": "@@ -185,20 +189,24 @@ private void buildMdcContext(Stack stack) {\n     }\n \n     private void reportHealthAndSyncInstances(Stack stack, Collection<InstanceMetaData> runningInstances, Collection<InstanceMetaData> failedInstances,\n-            Set<String> newHealtyHostNames, InstanceSyncState defaultState) {\n+            Set<String> newHealtyHostNames, boolean hostCertExpiring) {\n         Set<String> newFailedNodeNames = failedInstances.stream()\n                 .filter(i -> !Set.of(SERVICES_UNHEALTHY, STOPPED).contains(i.getInstanceStatus()))\n                 .map(InstanceMetaData::getDiscoveryFQDN)\n                 .collect(toSet());\n-        ifFlowNotRunning(() -> clusterOperationService.reportHealthChange(stack.getResourceCrn(), newFailedNodeNames, newHealtyHostNames));\n-        ifFlowNotRunning(() -> {\n-            if (!failedInstances.isEmpty()) {\n-                clusterService.updateClusterStatusByStackId(stack.getId(), Status.AMBIGUOUS);\n-            } else if (statesFromAvailabeAllowed().contains(stack.getCluster().getStatus())) {\n-                clusterService.updateClusterStatusByStackId(stack.getId(), Status.AVAILABLE);\n-            }\n-        });\n-        syncInstances(stack, runningInstances, failedInstances, defaultState);\n+        ifFlowNotRunning(() -> updateStates(stack, failedInstances, newFailedNodeNames, newHealtyHostNames, hostCertExpiring));\n+        syncInstances(stack, runningInstances, failedInstances, InstanceSyncState.RUNNING);\n+    }\n+\n+    private void updateStates(Stack stack, Collection<InstanceMetaData> failedInstances, Set<String> newFailedNodeNames, Set<String> newHealtyHostNames,\n+            boolean hostCertExpiring) {\n+        clusterService.updateClusterCertExpirationState(stack.getCluster(), hostCertExpiring);\n+        clusterOperationService.reportHealthChange(stack.getResourceCrn(), newFailedNodeNames, newHealtyHostNames);\n+        if (!failedInstances.isEmpty()) {", "originalCommit": "7630cc77a896b64d91d38f03936c0369a83650d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM4NjQ1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9139#discussion_r499386454", "bodyText": "added", "author": "lacikaaa", "createdAt": "2020-10-05T07:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI1NDY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI1NDc1MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9139#discussion_r499254751", "bodyText": "Can you please add a few log lines to these methods?", "author": "keyki", "createdAt": "2020-10-04T14:51:12Z", "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerClusterStatusService.java", "diffHunk": "@@ -215,16 +223,37 @@ public ClusterStatusResult getStatus(boolean blueprintPresent) {\n     }\n \n     @Override\n-    public Map<HostName, ClusterManagerState> getExtendedHostStatuses() {\n-        Map<HostName, ClusterManagerState> result = new HashMap<>();\n-        getHostHealth().forEach((hostname, health) ->\n-                result.put(hostname, new ClusterManagerState(healthSummaryToState(health.getSummary()),\n-                        getHostHealthMessage(health.getSummary(), health.getExplanation()))));\n-        return result;\n+    public ExtendedHostStatuses getExtendedHostStatuses() {\n+        Map<HostName, Collection<ApiHealthCheck>> hostHealth = getHostHealth();", "originalCommit": "7630cc77a896b64d91d38f03936c0369a83650d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM4NjUxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9139#discussion_r499386514", "bodyText": "added", "author": "lacikaaa", "createdAt": "2020-10-05T07:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI1NDc1MQ=="}], "type": "inlineReview"}, {"oid": "e3217e7d233a63b3b2b26f9d86db11d521290ab7", "url": "https://github.com/hortonworks/cloudbreak/commit/e3217e7d233a63b3b2b26f9d86db11d521290ab7", "message": "CB-9060 Check if certificates on cluster are about to expire\n\nWe are setting up clusters with autotls, which means every host has it's own certificate.\nThese certificates expiry every year and we must detect it and notify the customer before expiration date.\nIn this commit `StackStatusCheckerJob` has been enriched with checking the result from Cloudera Manager for\nhost certificate expiration related health info. Although these are not stored per host, they are aggregated\nand if there is at least one which is expiring we are setting a new field in `Cluster` entity, `certExpirationState`\nfrom `VALID` to `HOST_CERT_EXPIRING`.\nThis field is an enum to allow further expansion if we later would like to indicate eg CMCA expiration.\nThe value of this field is available on DistroX API in `ClusterV4Response` and on SDX API in `SdxClusterDetailResponse`.", "committedDate": "2020-10-05T07:16:39Z", "type": "forcePushed"}, {"oid": "44745ff14b5e4e2ff62b90c19d27a60add016345", "url": "https://github.com/hortonworks/cloudbreak/commit/44745ff14b5e4e2ff62b90c19d27a60add016345", "message": "CB-9060 Check if certificates on cluster are about to expire\n\nWe are setting up clusters with autotls, which means every host has it's own certificate.\nThese certificates expiry every year and we must detect it and notify the customer before expiration date.\nIn this commit `StackStatusCheckerJob` has been enriched with checking the result from Cloudera Manager for\nhost certificate expiration related health info. Although these are not stored per host, they are aggregated\nand if there is at least one which is expiring we are setting a new field in `Cluster` entity, `certExpirationState`\nfrom `VALID` to `HOST_CERT_EXPIRING`.\nThis field is an enum to allow further expansion if we later would like to indicate eg CMCA expiration.\nThe value of this field is available on DistroX API in `ClusterV4Response` and on SDX API in `SdxClusterDetailResponse`.", "committedDate": "2020-10-05T09:19:25Z", "type": "forcePushed"}, {"oid": "ebbb6460cd658dd0aaf4917fdeb1698148fe9a4f", "url": "https://github.com/hortonworks/cloudbreak/commit/ebbb6460cd658dd0aaf4917fdeb1698148fe9a4f", "message": "CB-9060 Check if certificates on cluster are about to expire\n\nWe are setting up clusters with autotls, which means every host has it's own certificate.\nThese certificates expiry every year and we must detect it and notify the customer before expiration date.\nIn this commit `StackStatusCheckerJob` has been enriched with checking the result from Cloudera Manager for\nhost certificate expiration related health info. Although these are not stored per host, they are aggregated\nand if there is at least one which is expiring we are setting a new field in `Cluster` entity, `certExpirationState`\nfrom `VALID` to `HOST_CERT_EXPIRING`.\nThis field is an enum to allow further expansion if we later would like to indicate eg CMCA expiration.\nThe value of this field is available on DistroX API in `ClusterV4Response` and on SDX API in `SdxClusterDetailResponse`.", "committedDate": "2020-10-05T09:36:03Z", "type": "forcePushed"}, {"oid": "61d7d5ab2c8228640a8654ad5cdf831f34851f17", "url": "https://github.com/hortonworks/cloudbreak/commit/61d7d5ab2c8228640a8654ad5cdf831f34851f17", "message": "CB-9060 Check if certificates on cluster are about to expire\n\nWe are setting up clusters with autotls, which means every host has it's own certificate.\nThese certificates expiry every year and we must detect it and notify the customer before expiration date.\nIn this commit `StackStatusCheckerJob` has been enriched with checking the result from Cloudera Manager for\nhost certificate expiration related health info. Although these are not stored per host, they are aggregated\nand if there is at least one which is expiring we are setting a new field in `Cluster` entity, `certExpirationState`\nfrom `VALID` to `HOST_CERT_EXPIRING`.\nThis field is an enum to allow further expansion if we later would like to indicate eg CMCA expiration.\nThe value of this field is available on DistroX API in `ClusterV4Response` and on SDX API in `SdxClusterDetailResponse`.", "committedDate": "2020-10-05T10:34:58Z", "type": "commit"}, {"oid": "61d7d5ab2c8228640a8654ad5cdf831f34851f17", "url": "https://github.com/hortonworks/cloudbreak/commit/61d7d5ab2c8228640a8654ad5cdf831f34851f17", "message": "CB-9060 Check if certificates on cluster are about to expire\n\nWe are setting up clusters with autotls, which means every host has it's own certificate.\nThese certificates expiry every year and we must detect it and notify the customer before expiration date.\nIn this commit `StackStatusCheckerJob` has been enriched with checking the result from Cloudera Manager for\nhost certificate expiration related health info. Although these are not stored per host, they are aggregated\nand if there is at least one which is expiring we are setting a new field in `Cluster` entity, `certExpirationState`\nfrom `VALID` to `HOST_CERT_EXPIRING`.\nThis field is an enum to allow further expansion if we later would like to indicate eg CMCA expiration.\nThe value of this field is available on DistroX API in `ClusterV4Response` and on SDX API in `SdxClusterDetailResponse`.", "committedDate": "2020-10-05T10:34:58Z", "type": "forcePushed"}]}