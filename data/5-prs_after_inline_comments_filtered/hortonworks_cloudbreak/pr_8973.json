{"pr_number": 8973, "pr_title": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query\u2026", "pr_createdAt": "2020-09-10T07:46:15Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8973", "timeline": [{"oid": "cbeb1ab02d589ea0ac8eb167b087a2b994136eea", "url": "https://github.com/hortonworks/cloudbreak/commit/cbeb1ab02d589ea0ac8eb167b087a2b994136eea", "message": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n* execute the select of cluster templates\n* the other test (thread in CB) delete the USER_DEFINED template\n* try to fetch the referenced stack, but this deleted by the other thread", "committedDate": "2020-09-10T11:15:15Z", "type": "forcePushed"}, {"oid": "e5630159ecbd64185051273bc82a3ec548efc475", "url": "https://github.com/hortonworks/cloudbreak/commit/e5630159ecbd64185051273bc82a3ec548efc475", "message": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n* execute the select of cluster templates\n* the other test (thread in CB) delete the USER_DEFINED template\n* try to fetch the referenced stack, but this deleted by the other thread", "committedDate": "2020-09-10T11:15:58Z", "type": "commit"}, {"oid": "e5630159ecbd64185051273bc82a3ec548efc475", "url": "https://github.com/hortonworks/cloudbreak/commit/e5630159ecbd64185051273bc82a3ec548efc475", "message": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n* execute the select of cluster templates\n* the other test (thread in CB) delete the USER_DEFINED template\n* try to fetch the referenced stack, but this deleted by the other thread", "committedDate": "2020-09-10T11:15:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI2Nzc5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8973#discussion_r486267793", "bodyText": "We need to be careful with this and monitor mow-dev how it will behave.", "author": "doktoric", "createdAt": "2020-09-10T11:37:28Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/repository/cluster/ClusterTemplateViewRepository.java", "diffHunk": "@@ -16,7 +16,9 @@\n @Transactional(TxType.REQUIRED)\n public interface ClusterTemplateViewRepository extends WorkspaceResourceRepository<ClusterTemplateView, Long> {\n \n-    @Query(\"SELECT b FROM ClusterTemplateView b WHERE b.workspace.id= :workspaceId AND b.status <> 'DEFAULT_DELETED'\")\n+    @Query(\"SELECT b FROM ClusterTemplateView b \" +\n+            \"LEFT JOIN FETCH b.stackTemplate \" +", "originalCommit": "e5630159ecbd64185051273bc82a3ec548efc475", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}