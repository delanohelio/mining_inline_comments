{"pr_number": 7650, "pr_title": "CB-5734 Datahub Autoscaling API Enhancements", "pr_createdAt": "2020-03-25T16:00:59Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7650", "timeline": [{"oid": "2434180c80c8ad6c79668e0321da95d19c33520d", "url": "https://github.com/hortonworks/cloudbreak/commit/2434180c80c8ad6c79668e0321da95d19c33520d", "message": "CB-5734 DistroX Autoscaling API Enhancements\n\nAdded additional validations.\nAdded additional unit tests.\nRemoved AutoscalingMode and ScalingConfigurationRequest from DistroXAutoscaleClusterRequest.", "committedDate": "2020-03-25T16:04:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3NDg3NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7650#discussion_r398274874", "bodyText": "How will the ParseException manifest in an actual WS call?", "author": "sidseth", "createdAt": "2020-03-26T02:01:18Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/endpoint/v1/DistroXAutoScaleClusterV1Endpoint.java", "diffHunk": "@@ -48,14 +51,14 @@\n     @Produces(MediaType.APPLICATION_JSON)\n     @ApiOperation(value = ClusterOpDescription.CLUSTER_SET_AUTOSCALE_STATE, produces = MediaType.APPLICATION_JSON, notes = DistroXClusterNotes.NOTES)\n     DistroXAutoscaleClusterResponse updateAutoscaleConfigByClusterCrn(@PathParam(\"crn\") String clusterCrn,\n-            DistroXAutoscaleClusterRequest autoscaleClusterRequest);\n+            @ValidDistroXAutoscaleRequest @Valid DistroXAutoscaleClusterRequest autoscaleClusterRequest) throws ParseException;", "originalCommit": "2434180c80c8ad6c79668e0321da95d19c33520d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2OTk2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7650#discussion_r398369960", "bodyText": "As BAD_REQUEST", "author": "smaniraju", "createdAt": "2020-03-26T07:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3NDg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3NjI0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7650#discussion_r398276247", "bodyText": "Does this meant the AdjustmentType has to be specified?\nHave that, and a few other questions at: https://github.infra.cloudera.com/sseth/thunderhead/blob/master/services/api/distrox/src/main/java/com/cloudera/thunderhead/service/distroxapi/server/Conversions.java#L347 (Also other comments which mention: \"check with Santosh\")", "author": "sidseth", "createdAt": "2020-03-26T02:06:45Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/endpoint/validator/DistroXAutoscaleRequestValidator.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.sequenceiq.periscope.api.endpoint.validator;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+import javax.validation.ConstraintValidator;\n+import javax.validation.ConstraintValidatorContext;\n+\n+import com.sequenceiq.periscope.api.model.AdjustmentType;\n+import com.sequenceiq.periscope.api.model.DistroXAutoscaleClusterRequest;\n+import com.sequenceiq.periscope.api.util.ValidatorUtil;\n+\n+public class DistroXAutoscaleRequestValidator\n+        implements ConstraintValidator<ValidDistroXAutoscaleRequest, DistroXAutoscaleClusterRequest> {\n+    @Inject\n+    private ValidatorUtil validatorUtil;\n+\n+    @Override\n+    public boolean isValid(DistroXAutoscaleClusterRequest request, ConstraintValidatorContext context) {\n+        Set<String> duplicateAutoscaleHostGroups = validatorUtil.getDuplicateAutoscaleHostGroups(request);\n+\n+        if (duplicateAutoscaleHostGroups.size() > 0) {\n+            String message = String.format(\"Hostgroup(s) %s configured with multiple autoscaling policies.\",\n+                    duplicateAutoscaleHostGroups.toString());\n+            com.sequenceiq.cloudbreak.validation.ValidatorUtil.addConstraintViolation(context, message, \"hostGroup\")\n+                    .disableDefaultConstraintViolation();\n+            return false;\n+        }\n+\n+        List<AdjustmentType> invalidLoadAlertHostGroups =\n+        request.getLoadAlertRequests().stream()\n+                .map(loadAlertRequest -> loadAlertRequest.getScalingPolicy().getAdjustmentType())\n+                .filter(adjustmentType -> !AdjustmentType.LOAD_BASED.equals(adjustmentType))", "originalCommit": "2434180c80c8ad6c79668e0321da95d19c33520d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3MDE5NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7650#discussion_r398370194", "bodyText": "Yes it needs to be specified to keep all alert definitions in sync.", "author": "smaniraju", "createdAt": "2020-03-26T07:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3NjI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3NjkzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7650#discussion_r398276933", "bodyText": "Is the API allowing multiple scalingRequests to be specified for a single cluster already? Don't see a check for that. (I'm explicitly disallowing this on the CDP API).\nGiven that the UI will call this API directly, the check is likely required here as well (to avoid accidental UI code bugs)", "author": "sidseth", "createdAt": "2020-03-26T02:09:22Z", "path": "autoscale-api/src/main/java/com/sequenceiq/periscope/api/endpoint/validator/DistroXAutoscaleRequestValidator.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.sequenceiq.periscope.api.endpoint.validator;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+import javax.validation.ConstraintValidator;\n+import javax.validation.ConstraintValidatorContext;\n+\n+import com.sequenceiq.periscope.api.model.AdjustmentType;\n+import com.sequenceiq.periscope.api.model.DistroXAutoscaleClusterRequest;\n+import com.sequenceiq.periscope.api.util.ValidatorUtil;\n+\n+public class DistroXAutoscaleRequestValidator", "originalCommit": "2434180c80c8ad6c79668e0321da95d19c33520d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3MjM4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7650#discussion_r398372387", "bodyText": "ack.", "author": "smaniraju", "createdAt": "2020-03-26T07:50:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3NjkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMzE0MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7650#discussion_r398303140", "bodyText": "Is the ScalingPolicy field optional, or validated elsewhere?", "author": "sidseth", "createdAt": "2020-03-26T03:52:16Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/service/AlertService.java", "diffHunk": "@@ -132,12 +132,18 @@ public TimeAlert findTimeAlertByCluster(Long clusterId, Long alertId) {\n         return timeAlertRepository.findByCluster(alertId, clusterId);\n     }\n \n-    public TimeAlert updateTimeAlert(Long clusterId, Long alertId, TimeAlert timeAlert) {\n+    public TimeAlert updateTimeAlert(Long clusterId, Long alertId, TimeAlert timeAlertForUpdate) {\n         TimeAlert alert = timeAlertRepository.findByCluster(alertId, clusterId);\n-        alert.setDescription(timeAlert.getDescription());\n-        alert.setCron(timeAlert.getCron());\n-        alert.setTimeZone(timeAlert.getTimeZone());\n-        alert.setName(timeAlert.getName());\n+        alert.setDescription(timeAlertForUpdate.getDescription());\n+        alert.setCron(timeAlertForUpdate.getCron());\n+        alert.setTimeZone(timeAlertForUpdate.getTimeZone());\n+        alert.setName(timeAlertForUpdate.getName());\n+        if (timeAlertForUpdate.getScalingPolicy() != null) {", "originalCommit": "2434180c80c8ad6c79668e0321da95d19c33520d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3MTk3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7650#discussion_r398371976", "bodyText": "In the api it is not optional.", "author": "smaniraju", "createdAt": "2020-03-26T07:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMzE0MA=="}], "type": "inlineReview"}, {"oid": "96d07ddd8e86f298d2af41cc2c0b09c95fca5b35", "url": "https://github.com/hortonworks/cloudbreak/commit/96d07ddd8e86f298d2af41cc2c0b09c95fca5b35", "message": "CB-5734 DistroX Autoscaling API Enhancements\n\nAdded additional validations.\nAdded additional unit tests.\nRemoved AutoscalingMode and ScalingConfigurationRequest from DistroXAutoscaleClusterRequest.", "committedDate": "2020-03-26T09:52:24Z", "type": "forcePushed"}, {"oid": "7cb6744b74117fe8df42b88727b7a2f749bc3c3d", "url": "https://github.com/hortonworks/cloudbreak/commit/7cb6744b74117fe8df42b88727b7a2f749bc3c3d", "message": "CB-5734 DistroX Autoscaling API Enhancements\n\nAdded additional validations.\nAdded additional unit tests.\nRemoved AutoscalingMode and ScalingConfigurationRequest from DistroXAutoscaleClusterRequest.", "committedDate": "2020-03-26T10:37:55Z", "type": "forcePushed"}, {"oid": "e8b13522e2f7b10093a668e526d6a89a96dc9d32", "url": "https://github.com/hortonworks/cloudbreak/commit/e8b13522e2f7b10093a668e526d6a89a96dc9d32", "message": "CB-5734 DistroX Autoscaling API Enhancements\n\nAdded additional validations.\nAdded additional unit tests.\nRemoved AutoscalingMode and ScalingConfigurationRequest from DistroXAutoscaleClusterRequest.", "committedDate": "2020-03-26T11:12:08Z", "type": "commit"}, {"oid": "e8b13522e2f7b10093a668e526d6a89a96dc9d32", "url": "https://github.com/hortonworks/cloudbreak/commit/e8b13522e2f7b10093a668e526d6a89a96dc9d32", "message": "CB-5734 DistroX Autoscaling API Enhancements\n\nAdded additional validations.\nAdded additional unit tests.\nRemoved AutoscalingMode and ScalingConfigurationRequest from DistroXAutoscaleClusterRequest.", "committedDate": "2020-03-26T11:12:08Z", "type": "forcePushed"}]}