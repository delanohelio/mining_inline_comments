{"pr_number": 7547, "pr_title": "CB-6035: FMS should relogin on failures", "pr_createdAt": "2020-03-11T18:56:23Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7547", "timeline": [{"oid": "5bb042f8aa0078c9921d338d072541cbfab70755", "url": "https://github.com/hortonworks/cloudbreak/commit/5bb042f8aa0078c9921d338d072541cbfab70755", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.", "committedDate": "2020-03-12T06:56:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU2OTcwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r391569704", "bodyText": "line 124-128 is repeated from 91-98. Should it be a function? See FreeIpaClientExceptionUtils.java for similar functions.", "author": "jamisonbennett", "createdAt": "2020-03-12T11:53:02Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -97,11 +114,25 @@ public FreeIpaClient getFreeIpaClientForStackWithPing(Stack stack) throws Except\n                 if (clusterProxyService.isCreateConfigForClusterProxy(stack)) {\n                     return getFreeIpaClientBuilderForClusterProxy(stack).buildWithPing();\n                 } else {\n-                    return getFreeIpaClientBuilder(stack).buildWithPing();\n+                    Exception lastException = new FreeIpaClientException(\"No instances exist in the stack.\");\n+                    for (InstanceMetaData instanceMetaData: stack.getInstanceGroups().stream().flatMap(\n+                            instanceGroup -> instanceGroup.getInstanceMetaData().stream()).collect(Collectors.toList())) {\n+                        try {\n+                            return getFreeIpaClientBuilder(stack, instanceMetaData).buildWithPing();\n+                        } catch (FreeIpaClientException | IOException e) {\n+                            lastException = e;\n+                            if (e instanceof FreeIpaClientException) {", "originalCommit": "5bb042f8aa0078c9921d338d072541cbfab70755", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5ODcwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r391698705", "bodyText": "moved", "author": "holleyism", "createdAt": "2020-03-12T15:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU2OTcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU3MjkyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r391572921", "bodyText": "I think the statusCode should be OptionalInt since its not always present.", "author": "jamisonbennett", "createdAt": "2020-03-12T12:00:00Z", "path": "freeipa-client/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClientException.java", "diffHunk": "@@ -1,19 +1,25 @@\n package com.sequenceiq.freeipa.client;\n \n public class FreeIpaClientException extends Exception {\n+\n+    private final int statusCode;", "originalCommit": "5bb042f8aa0078c9921d338d072541cbfab70755", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5ODU2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r391698560", "bodyText": "changed", "author": "holleyism", "createdAt": "2020-03-12T15:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU3MjkyMQ=="}], "type": "inlineReview"}, {"oid": "35cbb5b1bc155aa78eef11177edbe4aedf76b636", "url": "https://github.com/hortonworks/cloudbreak/commit/35cbb5b1bc155aa78eef11177edbe4aedf76b636", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.", "committedDate": "2020-03-12T19:50:25Z", "type": "forcePushed"}, {"oid": "51eefdf4e7ac980d95ea2b6a4ac7fadde86047fd", "url": "https://github.com/hortonworks/cloudbreak/commit/51eefdf4e7ac980d95ea2b6a4ac7fadde86047fd", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.", "committedDate": "2020-03-13T01:47:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDE0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r392944147", "bodyText": "I don't think this response.getStatusLine().getStatusCode() is necessary", "author": "lacikaaa", "createdAt": "2020-03-16T11:12:40Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClientBuilder.java", "diffHunk": "@@ -193,21 +187,14 @@ private String connect(String user, String pass, String apiAddress, int port)\n                 throw new FreeIpaClientException(String.format(\"Encountered unexpected response from \"\n                         + \"FreeIPA; details:%n%n\"\n                         + \"code: %s%n\"\n-                        + \"headers: %s\", response.getStatusLine().getStatusCode(), response.getAllHeaders()));\n+                        + \"headers: %s\", response.getStatusLine().getStatusCode(), response.getAllHeaders()),\n+                        response.getStatusLine().getStatusCode());", "originalCommit": "51eefdf4e7ac980d95ea2b6a4ac7fadde86047fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE5NTEwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r393195109", "bodyText": "It's necessary for the calling function to determine if the exception was due to not being authorized.  We want to retry logging it to different IPA servers for failover, unless the exception is because we're unauthorized.", "author": "holleyism", "createdAt": "2020-03-16T17:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIxNDgzOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r393214838", "bodyText": "ok, I missed the parenthesis", "author": "lacikaaa", "createdAt": "2020-03-16T18:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDk1Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r392944957", "bodyText": "if we get stack here instead of id we can omit the gw port from parameters as it's in the stack already", "author": "lacikaaa", "createdAt": "2020-03-16T11:15:07Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/TlsSecurityService.java", "diffHunk": "@@ -103,9 +103,8 @@ private void generateSaltPassword(SaltSecurityConfig saltSecurityConfig) {\n         saltSecurityConfig.setSaltPasswordVault(saltPassword);\n     }\n \n-    public GatewayConfig buildGatewayConfig(Long stackId, InstanceMetaData gatewayInstance, Integer gatewayPort,\n+    public GatewayConfig buildGatewayConfig(Stack stack, InstanceMetaData gatewayInstance, Integer gatewayPort,", "originalCommit": "51eefdf4e7ac980d95ea2b6a4ac7fadde86047fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE5NTc5OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r393195798", "bodyText": "fixed", "author": "holleyism", "createdAt": "2020-03-16T17:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NzYxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r392947617", "bodyText": "this wouldn't be necessary if there is 2 catch for the 2 exception", "author": "lacikaaa", "createdAt": "2020-03-16T11:22:46Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -70,42 +73,48 @@ private String toClusterProxyBasepath(String freeIpaClusterCrn) {\n         return String.format(\"%s%s\", clusterProxyService.getProxyPath(freeIpaClusterCrn), FreeIpaClientBuilder.DEFAULT_BASE_PATH);\n     }\n \n-    public FreeIpaClient getFreeIpaClientForStack(Stack stack) throws FreeIpaClientException {\n-        LOGGER.debug(\"Creating FreeIpaClient for stack {}\", stack.getResourceCrn());\n+    private FreeIpaClient getFreeIpaClient(Stack stack, boolean withPing) throws FreeIpaClientException {\n+        stack = stackService.getByIdWithListsInTransaction(stack.getId());\n         Status stackStatus = stack.getStackStatus().getStatus();\n         if (!stackStatus.isFreeIpaUnreachableStatus()) {\n             try {\n                 if (clusterProxyService.isCreateConfigForClusterProxy(stack)) {\n-                    return getFreeIpaClientBuilderForClusterProxy(stack).build();\n+                    return getFreeIpaClientBuilderForClusterProxy(stack).build(withPing);\n                 } else {\n-                    return getFreeIpaClientBuilder(stack).build();\n+                    Exception lastException = new FreeIpaClientException(\"No instances exist in the stack.\");\n+                    for (InstanceMetaData instanceMetaData: stack.getInstanceGroups().stream().flatMap(\n+                            instanceGroup -> instanceGroup.getInstanceMetaData().stream()).collect(Collectors.toList())) {\n+                        try {\n+                            return getFreeIpaClientBuilder(stack, instanceMetaData).build(withPing);\n+                        } catch (FreeIpaClientException | IOException e) {\n+                            lastException = e;\n+                            if (e instanceof FreeIpaClientException) {", "originalCommit": "51eefdf4e7ac980d95ea2b6a4ac7fadde86047fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE5NjczOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r393196738", "bodyText": "fixed", "author": "holleyism", "createdAt": "2020-03-16T17:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NzYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MDE2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r392950167", "bodyText": "please move out the stream into a variable and/or to a method", "author": "lacikaaa", "createdAt": "2020-03-16T11:27:49Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -70,42 +73,48 @@ private String toClusterProxyBasepath(String freeIpaClusterCrn) {\n         return String.format(\"%s%s\", clusterProxyService.getProxyPath(freeIpaClusterCrn), FreeIpaClientBuilder.DEFAULT_BASE_PATH);\n     }\n \n-    public FreeIpaClient getFreeIpaClientForStack(Stack stack) throws FreeIpaClientException {\n-        LOGGER.debug(\"Creating FreeIpaClient for stack {}\", stack.getResourceCrn());\n+    private FreeIpaClient getFreeIpaClient(Stack stack, boolean withPing) throws FreeIpaClientException {\n+        stack = stackService.getByIdWithListsInTransaction(stack.getId());\n         Status stackStatus = stack.getStackStatus().getStatus();\n         if (!stackStatus.isFreeIpaUnreachableStatus()) {\n             try {\n                 if (clusterProxyService.isCreateConfigForClusterProxy(stack)) {\n-                    return getFreeIpaClientBuilderForClusterProxy(stack).build();\n+                    return getFreeIpaClientBuilderForClusterProxy(stack).build(withPing);\n                 } else {\n-                    return getFreeIpaClientBuilder(stack).build();\n+                    Exception lastException = new FreeIpaClientException(\"No instances exist in the stack.\");\n+                    for (InstanceMetaData instanceMetaData: stack.getInstanceGroups().stream().flatMap(", "originalCommit": "51eefdf4e7ac980d95ea2b6a4ac7fadde86047fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE5ODAxMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r393198012", "bodyText": "moved", "author": "holleyism", "createdAt": "2020-03-16T17:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MDE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MTU0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r392951546", "bodyText": "this exception driven logic and return inside the for loop makes the code hard to read.\nI think it would be more readable if you do something like have an Optional<FreeIpaClient> client = Optional.empty() and iterate through the instances while it's empty and you have more instances. In the end you could return with the client or throw an exception", "author": "lacikaaa", "createdAt": "2020-03-16T11:30:32Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -70,42 +73,48 @@ private String toClusterProxyBasepath(String freeIpaClusterCrn) {\n         return String.format(\"%s%s\", clusterProxyService.getProxyPath(freeIpaClusterCrn), FreeIpaClientBuilder.DEFAULT_BASE_PATH);\n     }\n \n-    public FreeIpaClient getFreeIpaClientForStack(Stack stack) throws FreeIpaClientException {\n-        LOGGER.debug(\"Creating FreeIpaClient for stack {}\", stack.getResourceCrn());\n+    private FreeIpaClient getFreeIpaClient(Stack stack, boolean withPing) throws FreeIpaClientException {\n+        stack = stackService.getByIdWithListsInTransaction(stack.getId());\n         Status stackStatus = stack.getStackStatus().getStatus();\n         if (!stackStatus.isFreeIpaUnreachableStatus()) {\n             try {\n                 if (clusterProxyService.isCreateConfigForClusterProxy(stack)) {\n-                    return getFreeIpaClientBuilderForClusterProxy(stack).build();\n+                    return getFreeIpaClientBuilderForClusterProxy(stack).build(withPing);\n                 } else {\n-                    return getFreeIpaClientBuilder(stack).build();\n+                    Exception lastException = new FreeIpaClientException(\"No instances exist in the stack.\");", "originalCommit": "51eefdf4e7ac980d95ea2b6a4ac7fadde86047fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzcyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7547#discussion_r393203728", "bodyText": "changed.", "author": "holleyism", "createdAt": "2020-03-16T17:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MTU0Ng=="}], "type": "inlineReview"}, {"oid": "78a17bd5e99ad5a357c4a232ac9e210e461e120a", "url": "https://github.com/hortonworks/cloudbreak/commit/78a17bd5e99ad5a357c4a232ac9e210e461e120a", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.", "committedDate": "2020-03-16T17:29:17Z", "type": "forcePushed"}, {"oid": "dfe4656d226c585b2bc338c04cfc3764a2c7467a", "url": "https://github.com/hortonworks/cloudbreak/commit/dfe4656d226c585b2bc338c04cfc3764a2c7467a", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.", "committedDate": "2020-03-16T18:20:30Z", "type": "forcePushed"}, {"oid": "9d8ee503a3cbafcd41ca0a3a6ed0e48b2193a65a", "url": "https://github.com/hortonworks/cloudbreak/commit/9d8ee503a3cbafcd41ca0a3a6ed0e48b2193a65a", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.", "committedDate": "2020-03-19T18:41:29Z", "type": "forcePushed"}, {"oid": "eb83897f52d65a798fd994ce9847ea7a792dae80", "url": "https://github.com/hortonworks/cloudbreak/commit/eb83897f52d65a798fd994ce9847ea7a792dae80", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.\n\nCo-authored-by: Jamison Bennett <jamison.bennnett@gmail.com>", "committedDate": "2020-03-20T19:32:00Z", "type": "forcePushed"}, {"oid": "d4951328aefac081af353fd358e7b5426cf58f53", "url": "https://github.com/hortonworks/cloudbreak/commit/d4951328aefac081af353fd358e7b5426cf58f53", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.\n\nCo-authored-by: Jamison Bennett <jamison.bennnett@gmail.com>", "committedDate": "2020-03-20T20:03:13Z", "type": "forcePushed"}, {"oid": "780d505d179b0c0b6b979b9cf1678b823bc3f537", "url": "https://github.com/hortonworks/cloudbreak/commit/780d505d179b0c0b6b979b9cf1678b823bc3f537", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.\n\nCo-authored-by: Jamison Bennett <jamison.bennnett@gmail.com>", "committedDate": "2020-03-24T08:27:23Z", "type": "commit"}, {"oid": "780d505d179b0c0b6b979b9cf1678b823bc3f537", "url": "https://github.com/hortonworks/cloudbreak/commit/780d505d179b0c0b6b979b9cf1678b823bc3f537", "message": "CB-6035: FMS should relogin on failures\n\nThis change adds goes through all instances in the\nstack when trying to get a FreeIPA client unless the\nloging is incorrect.\n\nCo-authored-by: Jamison Bennett <jamison.bennnett@gmail.com>", "committedDate": "2020-03-24T08:27:23Z", "type": "forcePushed"}]}