{"pr_number": 8153, "pr_title": "CB-6805 extract rest and flow into AuditEvent", "pr_createdAt": "2020-05-27T06:48:52Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8153", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3ODMxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r430978313", "bodyText": "can NPE be possible?\nalso you can extract structuredEvent.getRestCall().getRestRequest() to a local var (just cosmetics)", "author": "bergerdenes", "createdAt": "2020-05-27T09:21:35Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/ApiEventDataExtractor.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package com.sequenceiq.cloudbreak.audit.converter;\n+\n+import java.util.Set;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.model.ApiRequestData;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.audit.model.EventData;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredRestCallEvent;\n+\n+@Component(\"REST\")\n+public class ApiEventDataExtractor implements EventDataExtractor<StructuredRestCallEvent> {\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Override\n+    public EventData eventData(StructuredRestCallEvent structuredEvent) {\n+        String method = structuredEvent.getRestCall().getRestRequest().getMethod();", "originalCommit": "cb99ae32ca5595fbee70947b0dbc1d3cf5733c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY5NTEwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r431695109", "bodyText": "Of course, but the refining in progress", "author": "topolyai5", "createdAt": "2020-05-28T09:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3ODMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3ODUyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r430978522", "bodyText": "similar questions like above", "author": "bergerdenes", "createdAt": "2020-05-27T09:21:55Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/ApiEventDataExtractor.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package com.sequenceiq.cloudbreak.audit.converter;\n+\n+import java.util.Set;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.model.ApiRequestData;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.audit.model.EventData;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredRestCallEvent;\n+\n+@Component(\"REST\")\n+public class ApiEventDataExtractor implements EventDataExtractor<StructuredRestCallEvent> {\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Override\n+    public EventData eventData(StructuredRestCallEvent structuredEvent) {\n+        String method = structuredEvent.getRestCall().getRestRequest().getMethod();\n+        boolean mutating = Set.of(\"POST\", \"PUT\", \"DELETE\").contains(method);\n+        String userAgent = structuredEvent.getRestCall().getRestRequest().getHeaders().get(\"user-agent\");\n+        return ApiRequestData.builder()\n+                .withApiVersion(cbVersion)\n+                .withMutating(mutating)\n+                .withRequestParameters(structuredEvent.getRestCall().getRestRequest().getRequestUri())\n+                .withUserAgent(userAgent)\n+                .build();\n+    }\n+\n+    @Override\n+    public AuditEventName eventName(StructuredRestCallEvent structuredEvent) {\n+        String method = structuredEvent.getRestCall().getRestRequest().getMethod();", "originalCommit": "cb99ae32ca5595fbee70947b0dbc1d3cf5733c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUwMDgzOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r432500838", "bodyText": "It cannot be null", "author": "topolyai5", "createdAt": "2020-05-29T13:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3ODUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3OTAzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r430979033", "bodyText": "NPE?", "author": "bergerdenes", "createdAt": "2020-05-27T09:22:44Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/ApiEventDataExtractor.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package com.sequenceiq.cloudbreak.audit.converter;\n+\n+import java.util.Set;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.model.ApiRequestData;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.audit.model.EventData;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredRestCallEvent;\n+\n+@Component(\"REST\")\n+public class ApiEventDataExtractor implements EventDataExtractor<StructuredRestCallEvent> {\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Override\n+    public EventData eventData(StructuredRestCallEvent structuredEvent) {\n+        String method = structuredEvent.getRestCall().getRestRequest().getMethod();\n+        boolean mutating = Set.of(\"POST\", \"PUT\", \"DELETE\").contains(method);\n+        String userAgent = structuredEvent.getRestCall().getRestRequest().getHeaders().get(\"user-agent\");\n+        return ApiRequestData.builder()\n+                .withApiVersion(cbVersion)\n+                .withMutating(mutating)\n+                .withRequestParameters(structuredEvent.getRestCall().getRestRequest().getRequestUri())\n+                .withUserAgent(userAgent)\n+                .build();\n+    }\n+\n+    @Override\n+    public AuditEventName eventName(StructuredRestCallEvent structuredEvent) {\n+        String method = structuredEvent.getRestCall().getRestRequest().getMethod();\n+        String uri = structuredEvent.getRestCall().getRestRequest().getRequestUri();\n+        AuditEventName eventName = null;\n+        if (\"POST\".equals(method)) {\n+            eventName = creationRest(uri);\n+        } else if (\"DELETE\".equals(method)) {\n+            eventName = deletionRest(uri);\n+        }\n+        // parse the URL\n+        if (eventName != null) {\n+            return eventName;\n+        }\n+        throw new UnsupportedOperationException(String.format(\"The `%s` with `%s` does not support for auditing\", uri, method));\n+    }\n+\n+    @Override\n+    public Crn.Service eventSource(StructuredRestCallEvent structuredEvent) {\n+        return Crn.Service.DATAHUB;\n+    }\n+\n+    @Override\n+    public String sourceIp(StructuredRestCallEvent structuredEvent) {\n+        return structuredEvent.getRestCall().getRestRequest().getHeaders().get(\"x-real-ip\");", "originalCommit": "cb99ae32ca5595fbee70947b0dbc1d3cf5733c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUwMTQ2NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r432501464", "bodyText": "Only the .get(\"x-real-ip\"); can be null, but the source IP is handled as null", "author": "topolyai5", "createdAt": "2020-05-29T13:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3OTAzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk4MjQzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r430982432", "bodyText": "should come from a property like the others (but I guess it is just like that because of it's a draft)", "author": "bergerdenes", "createdAt": "2020-05-27T09:28:19Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/conf/StructuredEventSenderConfig.java", "diffHunk": "@@ -33,6 +33,10 @@ public boolean isFilePathConfigured() {\n         return StringUtils.isNotEmpty(auditFilePath);\n     }\n \n+    public boolean isAuditServiceConfigured() {\n+        return true;", "originalCommit": "cb99ae32ca5595fbee70947b0dbc1d3cf5733c69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUwMTg2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r432501866", "bodyText": "yep", "author": "topolyai5", "createdAt": "2020-05-29T14:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk4MjQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk4NzU4MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r430987580", "bodyText": "how are we going to differentiate flows for different resources (like sdx or distrox)?", "author": "bergerdenes", "createdAt": "2020-05-27T09:36:43Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/FlowEventDataExtractor.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.sequenceiq.cloudbreak.audit.converter;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.audit.model.EventData;\n+import com.sequenceiq.cloudbreak.audit.model.ServiceEventData;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component(\"FLOW\")\n+public class FlowEventDataExtractor implements EventDataExtractor<StructuredFlowEvent> {\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Override\n+    public EventData eventData(StructuredFlowEvent structuredEvent) {\n+        Map<String, Object> eventDetails = new HashMap<>();\n+        eventDetails.put(\"userCrn\", structuredEvent.getOperation().getUserCrn());\n+        eventDetails.put(\"clusterCrn\", structuredEvent.getOperation().getResourceCrn());\n+        eventDetails.put(\"timestamp\", System.currentTimeMillis());\n+        eventDetails.put(\"environmentCrn\", structuredEvent.getOperation().getEnvironmentCrn());\n+        return ServiceEventData.builder()\n+                .withEventDetails(new Json(eventDetails).getValue())\n+                .withVersion(cbVersion)\n+                .build();\n+    }\n+\n+    @Override\n+    public AuditEventName eventName(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();", "originalCommit": "cb99ae32ca5595fbee70947b0dbc1d3cf5733c69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63a8af7c5313cd38dedb637756c35dcc774552a1", "url": "https://github.com/hortonworks/cloudbreak/commit/63a8af7c5313cd38dedb637756c35dcc774552a1", "message": "CB-6805 refinement of event name converter", "committedDate": "2020-05-29T13:46:55Z", "type": "forcePushed"}, {"oid": "bb166b3406138ae814f960272a35fa5e7e0ea698", "url": "https://github.com/hortonworks/cloudbreak/commit/bb166b3406138ae814f960272a35fa5e7e0ea698", "message": "CB-6805 refinement of event name converter", "committedDate": "2020-05-29T15:41:35Z", "type": "forcePushed"}, {"oid": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "url": "https://github.com/hortonworks/cloudbreak/commit/2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-02T07:34:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2Njc0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435566742", "bodyText": "typo", "author": "bergerdenes", "createdAt": "2020-06-04T21:36:13Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/FlowEventDataExtractor.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package com.sequenceiq.cloudbreak.audit.converter;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.FlowResourceAuditEventConverter;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.audit.model.EventData;\n+import com.sequenceiq.cloudbreak.audit.model.ServiceEventData;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.OperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component\n+public class FlowEventDataExtractor implements EventDataExtractor<StructuredFlowEvent> {\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Inject\n+    private Map<String, FlowResourceAuditEventConverter> resourceAuditEventConverters;\n+\n+    @Override\n+    public EventData eventData(StructuredFlowEvent structuredEvent) {\n+        Map<String, Object> eventDetails = new HashMap<>();\n+        eventDetails.put(\"userCrn\", structuredEvent.getOperation().getUserCrn());\n+        eventDetails.put(\"clusterCrn\", structuredEvent.getOperation().getResourceCrn());\n+        eventDetails.put(\"timestamp\", System.currentTimeMillis());\n+        eventDetails.put(\"environmentCrn\", structuredEvent.getOperation().getEnvironmentCrn());\n+        eventDetails.put(\"flowState\", getFlowStat(structuredEvent));\n+        eventDetails.put(\"flowId\", structuredEvent.getFlow().getFlowId());\n+        return ServiceEventData.builder()\n+                .withEventDetails(new Json(eventDetails).getValue())\n+                .withVersion(cbVersion)\n+                .build();\n+    }\n+\n+    private String getFlowStat(StructuredFlowEvent structuredEvent) {", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2OTU4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435569586", "bodyText": "this case might go into a retriable cycle and should fail hard in case of error (hard fail might be feature-switchable)", "author": "bergerdenes", "createdAt": "2020-06-04T21:43:11Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/structuredevent/audit/AuditStructuredEventHandler.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.sequenceiq.cloudbreak.structuredevent.audit;\n+\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.AuditClient;\n+import com.sequenceiq.cloudbreak.audit.converter.EventDataExtractor;\n+import com.sequenceiq.cloudbreak.audit.model.ActorCrn;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.OperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.flow.reactor.api.handler.EventHandler;\n+\n+import reactor.bus.Event;\n+\n+@Component\n+public class AuditStructuredEventHandler<T extends StructuredEvent> implements EventHandler<T> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AuditStructuredEventHandler.class);\n+\n+    @Inject\n+    private AuditClient auditClient;\n+\n+    @Inject\n+    private Map<String, EventDataExtractor<T>> eventDataExtractorMap;\n+\n+    @Override\n+    public String selector() {\n+        return AsyncAuditStructuredEventSender.AUDIT_EVENT_LOG_MESSAGE;\n+    }\n+\n+    @Override\n+    public void accept(Event<T> structuredEvent) {\n+        try {\n+            T data = structuredEvent.getData();\n+            OperationDetails operation = data.getOperation();\n+            var extractor = eventDataExtractorMap.get(operation.getEventType().name().toLowerCase() + \"EventDataExtractor\");\n+            AuditEvent event = AuditEvent.builder()\n+                    .withAccountId(operation.getTenant())\n+                    .withActor(ActorCrn.builder().withActorCrn(operation.getUserCrn()).build())\n+                    .withEventData(extractor.eventData(data))\n+                    .withEventName(extractor.eventName(data))\n+                    .withEventSource(extractor.eventSource(data))\n+                    .withSourceIp(extractor.sourceIp(data))\n+                    .build();\n+            auditClient.createAuditEvent(event);\n+        } catch (UnsupportedOperationException e) {\n+            LOGGER.debug(\"Audit log is unnecessary: {}\", e.getMessage());\n+        } catch (Exception e) {\n+            LOGGER.error(\"Cannot perform auditing: {}\", e.getMessage(), e);", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MDQ0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435570441", "bodyText": "\"sdx\" should be \"datalake\" (I assume it is a crn service name, and sdx is deprecated now)\ncould be refactored to a constant as well", "author": "bergerdenes", "createdAt": "2020-06-04T21:45:13Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/structuredevent/StructuredFlowEventFactory.java", "diffHunk": "@@ -124,9 +127,10 @@ public StructuredNotificationEvent createStructuredNotificationEvent(Stack stack\n             LOGGER.info(\"Access denied in structured notification event creation, user: {}, stack: {}\", userName, stackId, e);\n         }\n \n-        OperationDetails operationDetails = new OperationDetails(clock.getCurrentTimeMillis(), NOTIFICATION, \"stacks\", stackId, stackName,\n+        String resourceType = (stack.getType() == null || stack.getType().equals(StackType.WORKLOAD)) ? CloudbreakEventService.DATAHUB_RESOURCE_TYPE : \"sdx\";", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MjE5NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435572194", "bodyText": "\"sdx\" should be \"datalake\" (I assume it is a crn service name, and sdx is deprecated now)\ncould be refactored to a constant as well", "author": "bergerdenes", "createdAt": "2020-06-04T21:49:09Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/structuredevent/StructuredFlowEventFactory.java", "diffHunk": "@@ -64,9 +66,10 @@ public StructuredFlowEvent createStucturedFlowEvent(Long stackId, FlowDetails fl\n \n     public StructuredFlowEvent createStucturedFlowEvent(Long stackId, FlowDetails flowDetails, Boolean detailed, Exception exception) {\n         Stack stack = stackService.getByIdWithTransaction(stackId);\n-        OperationDetails operationDetails = new OperationDetails(clock.getCurrentTimeMillis(), FLOW, \"stacks\", stackId, stack.getName(),\n+        String resourceType = (stack.getType() == null || stack.getType().equals(StackType.WORKLOAD)) ? CloudbreakEventService.DATAHUB_RESOURCE_TYPE : \"sdx\";", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MjgyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435572824", "bodyText": "please be consistent with the naming (see the backing field name)", "author": "bergerdenes", "createdAt": "2020-06-04T21:50:32Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/conf/StructuredEventSenderConfig.java", "diffHunk": "@@ -33,6 +36,10 @@ public boolean isFilePathConfigured() {\n         return StringUtils.isNotEmpty(auditFilePath);\n     }\n \n+    public boolean isAuditServiceConfigured() {", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzMTc2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435831760", "bodyText": "unfortunately, the naming will change, therefore a parameter will be needed.\nReference: https://github.infra.cloudera.com/thunderhead/thunderhead/blob/master/services/audit/event-names.md\nBill will update the sheet with the names (has not started it yet...) I will let you know, but you can prepare for it.", "author": "bergerdenes", "createdAt": "2020-06-05T10:25:06Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/model/AuditEventName.java", "diffHunk": "@@ -1,5 +1,14 @@\n package com.sequenceiq.cloudbreak.audit.model;\n \n public enum AuditEventName {\n-    DATAHUB_CLUSTER_CREATION\n+    DATAHUB_CLUSTER_CREATION,", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwOTU3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437409576", "bodyText": "The updated names are in the \"CDP Control Plane Audit Events\" sheet (contact me for URL please if you don't have it)", "author": "bergerdenes", "createdAt": "2020-06-09T13:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzMTc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzMzIyMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435833223", "bodyText": "swap the sides of  && as it is a short-circuit operator and crn value is already known", "author": "bergerdenes", "createdAt": "2020-06-05T10:28:03Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/FlowEventDataExtractor.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package com.sequenceiq.cloudbreak.audit.converter;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.FlowResourceAuditEventConverter;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.audit.model.EventData;\n+import com.sequenceiq.cloudbreak.audit.model.ServiceEventData;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.OperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component\n+public class FlowEventDataExtractor implements EventDataExtractor<StructuredFlowEvent> {\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Inject\n+    private Map<String, FlowResourceAuditEventConverter> resourceAuditEventConverters;\n+\n+    @Override\n+    public EventData eventData(StructuredFlowEvent structuredEvent) {\n+        Map<String, Object> eventDetails = new HashMap<>();\n+        eventDetails.put(\"userCrn\", structuredEvent.getOperation().getUserCrn());\n+        eventDetails.put(\"clusterCrn\", structuredEvent.getOperation().getResourceCrn());\n+        eventDetails.put(\"timestamp\", System.currentTimeMillis());\n+        eventDetails.put(\"environmentCrn\", structuredEvent.getOperation().getEnvironmentCrn());\n+        eventDetails.put(\"flowState\", getFlowStat(structuredEvent));\n+        eventDetails.put(\"flowId\", structuredEvent.getFlow().getFlowId());\n+        return ServiceEventData.builder()\n+                .withEventDetails(new Json(eventDetails).getValue())\n+                .withVersion(cbVersion)\n+                .build();\n+    }\n+\n+    private String getFlowStat(StructuredFlowEvent structuredEvent) {\n+        String flowState = structuredEvent.getFlow().getFlowState();\n+        return \"INIT_STATE\".equals(flowState) ? flowState : structuredEvent.getFlow().getNextFlowState();\n+    }\n+\n+    @Override\n+    public AuditEventName eventName(StructuredFlowEvent structuredEvent) {\n+        FlowDetails flow = structuredEvent.getFlow();\n+        String flowEvent = flow.getFlowEvent();\n+        AuditEventName eventName = null;\n+        String resourceType = structuredEvent.getOperation().getResourceType();\n+        FlowResourceAuditEventConverter flowResourceAuditEventConverter = getConverter(resourceType);\n+        if (flowResourceAuditEventConverter != null) {\n+            eventName = flowResourceAuditEventConverter.auditEventName(structuredEvent);\n+        }\n+        if (eventName != null) {\n+            return eventName;\n+        }\n+        String flowState = flow.getFlowState();\n+        String flowType = flow.getFlowType();\n+        throw new UnsupportedOperationException(String.format(\"The %s, %s and %s does not support for auditing for %s\",\n+                flowType, flowEvent, flowState, resourceType));\n+    }\n+\n+    @Override\n+    public Crn.Service eventSource(StructuredFlowEvent structuredEvent) {\n+        return Crn.fromString(structuredEvent.getOperation().getResourceCrn()).getService();\n+    }\n+\n+    @Override\n+    public String sourceIp(StructuredFlowEvent structuredEvent) {\n+        return null;\n+    }\n+\n+    @Override\n+    public boolean shouldAudit(StructuredEvent structuredEvent) {\n+        OperationDetails operation = structuredEvent.getOperation();\n+        FlowResourceAuditEventConverter flowResourceAuditEventConverter = getConverter(operation.getResourceType());\n+        if (flowResourceAuditEventConverter == null) {\n+            return false;\n+        }\n+        boolean crn = Crn.isCrn(operation.getResourceCrn());\n+        return flowResourceAuditEventConverter.shouldAudit((StructuredFlowEvent) structuredEvent) && crn;", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzNDI1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435834259", "bodyText": "how will you decide if it is a datalake?", "author": "bergerdenes", "createdAt": "2020-06-05T10:30:11Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/RestEventDataExtractor.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package com.sequenceiq.cloudbreak.audit.converter;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.converter.auditeventname.rest.RestResourceAuditEventConverter;\n+import com.sequenceiq.cloudbreak.audit.model.ApiRequestData;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.audit.model.EventData;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredRestCallEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestRequestDetails;\n+\n+@Component\n+public class RestEventDataExtractor implements EventDataExtractor<StructuredRestCallEvent> {\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Inject\n+    private Map<String, RestResourceAuditEventConverter> resourceAuditEventConverters;\n+\n+    @Override\n+    public EventData eventData(StructuredRestCallEvent structuredEvent) {\n+        RestRequestDetails restRequest = structuredEvent.getRestCall().getRestRequest();\n+        boolean mutating = Set.of(\"POST\", \"PUT\", \"DELETE\").contains(restRequest.getMethod());\n+        String userAgent = restRequest.getHeaders().get(\"user-agent\");\n+        return ApiRequestData.builder()\n+                .withApiVersion(cbVersion)\n+                .withMutating(mutating)\n+                .withRequestParameters(restRequest.getRequestUri())\n+                .withUserAgent(userAgent)\n+                .build();\n+    }\n+\n+    @Override\n+    public AuditEventName eventName(StructuredRestCallEvent structuredEvent) {\n+        String resourceType = structuredEvent.getOperation().getResourceType();\n+        RestResourceAuditEventConverter restResourceAuditEventConverter = getConverter(resourceType);\n+        if (restResourceAuditEventConverter != null) {\n+            AuditEventName eventName = restResourceAuditEventConverter.auditEventName(structuredEvent);\n+            if (eventName != null) {\n+                return eventName;\n+            }\n+        }\n+        String method = structuredEvent.getRestCall().getRestRequest().getMethod();\n+        throw new UnsupportedOperationException(String.format(\"The `%s` with `%s` does not support for auditing\", resourceType, method));\n+    }\n+\n+    @Override\n+    public Crn.Service eventSource(StructuredRestCallEvent structuredEvent) {\n+        return Crn.Service.DATAHUB;", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0ODU1Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435848557", "bodyText": "you can determine from the payload, the stack type either DATALAKE or WORKLOAD", "author": "topolyai5", "createdAt": "2020-06-05T11:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzNDI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MzMzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435843335", "bodyText": "how will you determine if it is a datalake?", "author": "bergerdenes", "createdAt": "2020-06-05T10:50:34Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/structuredevent/db/StructuredEventDBService.java", "diffHunk": "@@ -135,7 +136,7 @@ protected void prepareCreation(StructuredEventEntity resource) {\n \n     @Override\n     public StructuredEventContainer getStructuredEventsForStack(String name, Long workspaceId) {\n-        return getEventsForUserWithResourceId(\"stacks\", getStackIfAvailable(workspaceId, name).getId());\n+        return getEventsForUserWithResourceId(CloudbreakEventService.DATAHUB_RESOURCE_TYPE, getStackIfAvailable(workspaceId, name).getId());", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MzM3NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r435843374", "bodyText": "how will you determine if it is a datalake?", "author": "bergerdenes", "createdAt": "2020-06-05T10:50:40Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/structuredevent/db/StructuredEventDBService.java", "diffHunk": "@@ -151,6 +152,7 @@ public StructuredEventEntity findByWorkspaceIdAndId(Long workspaceId, Long id) {\n     }\n \n     private Stack getStackIfAvailable(Long workspaceId, String name) {\n-        return Optional.ofNullable(stackService.getByNameInWorkspace(name, workspaceId)).orElseThrow(notFound(\"stack\", name));\n+        return Optional.ofNullable(stackService.getByNameInWorkspace(name, workspaceId))\n+                .orElseThrow(notFound(CloudbreakEventService.DATAHUB_RESOURCE_TYPE, name));", "originalCommit": "2abf6a14a870f8c4c4a8bd7940cec278c2e226f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f2510ae30f518cc16f0481c102e0cb25b121081f", "url": "https://github.com/hortonworks/cloudbreak/commit/f2510ae30f518cc16f0481c102e0cb25b121081f", "message": "Audit of Datalake", "committedDate": "2020-06-09T10:51:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwNTYxOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437405618", "bodyText": "would be more flexible with a default value \"false\" and set explicitly in the enabled services.\nbecause of transitive dependencies, other services that are not explicitly adding :structuredevent-model (like RedBeams) will fail upon startup", "author": "bergerdenes", "createdAt": "2020-06-09T13:12:49Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/conf/StructuredEventEnablementConfig.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.sequenceiq.cloudbreak.structuredevent.conf;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class StructuredEventEnablementConfig {\n+\n+    @Value(\"${cb.kafka.bootstrap.servers:}\")\n+    private String bootstrapServers;\n+\n+    @Value(\"${cb.audit.filepath:}\")\n+    private String auditFilePath;\n+\n+    @Value(\"${audit.service.enabled}\")", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjEyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r438972124", "bodyText": "I am trying to add the. variable to all module", "author": "topolyai5", "createdAt": "2020-06-11T17:57:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwNTYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODI0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437418249", "bodyText": "is this WIP?", "author": "bergerdenes", "createdAt": "2020-06-09T13:30:59Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/auditeventname/flow/datahub/StartDatahubFlowOperationAuditEventNameConverter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.datahub;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component\n+public class StartDatahubFlowOperationAuditEventNameConverter implements DatahubFlowOperationAuditEventNameConverter {\n+\n+    @Override\n+    public boolean isInit(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"STACK_START_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFinal(StructuredFlowEvent structuredEvent) {\n+        String flowState = structuredEvent.getFlow().getFlowState();\n+        return \"CLUSTER_START_FINISHED_STATE\".equals(flowState);\n+    }\n+\n+    @Override\n+    public boolean isFailed(StructuredFlowEvent structuredEvent) {\n+        return false;", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3Njg2OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r439276869", "bodyText": "follow-up story is needed", "author": "bergerdenes", "createdAt": "2020-06-12T08:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODM1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437418354", "bodyText": "is this WIP?", "author": "bergerdenes", "createdAt": "2020-06-09T13:31:08Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/auditeventname/flow/datahub/StopDatahubFlowOperationAuditEventNameConverter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.datahub;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component\n+public class StopDatahubFlowOperationAuditEventNameConverter implements DatahubFlowOperationAuditEventNameConverter {\n+\n+    @Override\n+    public boolean isInit(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"STACK_STOP_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFinal(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"STOP_FINALIZED_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFailed(StructuredFlowEvent structuredEvent) {\n+        return false;", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODQ0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437418442", "bodyText": "is this WIP?", "author": "bergerdenes", "createdAt": "2020-06-09T13:31:14Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/auditeventname/flow/datalake/CreationDatalakeFlowOperationAuditEventNameConverter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.datalake;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component\n+public class CreationDatalakeFlowOperationAuditEventNameConverter implements DatalakeFlowOperationAuditEventNameConverter {\n+\n+    @Override\n+    public boolean isInit(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"START_CREATION_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFinal(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"CLUSTER_CREATION_FINISHED_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFailed(StructuredFlowEvent structuredEvent) {\n+        return false;", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0MzUxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437443519", "bodyText": "yep, all the faild branches are wip", "author": "topolyai5", "createdAt": "2020-06-09T13:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODc1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437418755", "bodyText": "is this WIP?", "author": "bergerdenes", "createdAt": "2020-06-09T13:31:44Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/auditeventname/flow/datalake/DeletionDatalakeFlowOperationAuditEventNameConverter.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.datalake;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.FlowOperationAuditEventNameConverter;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component\n+public class DeletionDatalakeFlowOperationAuditEventNameConverter implements DatalakeFlowOperationAuditEventNameConverter {\n+\n+    @Override\n+    public boolean isInit(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"TERMINATION_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFinal(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"TERMINATION_FINALIZED_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFailed(StructuredFlowEvent structuredEvent) {\n+        return false;", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODg5MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437418891", "bodyText": "is this WIP?", "author": "bergerdenes", "createdAt": "2020-06-09T13:31:57Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/auditeventname/flow/datalake/StartDatalakeFlowOperationAuditEventNameConverter.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.datalake;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.FlowOperationAuditEventNameConverter;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component\n+public class StartDatalakeFlowOperationAuditEventNameConverter implements DatalakeFlowOperationAuditEventNameConverter {\n+\n+    @Override\n+    public boolean isInit(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"STACK_START_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFinal(StructuredFlowEvent structuredEvent) {\n+        String flowState = structuredEvent.getFlow().getFlowState();\n+        return \"CLUSTER_START_FINISHED_STATE\".equals(flowState);\n+    }\n+\n+    @Override\n+    public boolean isFailed(StructuredFlowEvent structuredEvent) {\n+        return false;", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxOTAwMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437419001", "bodyText": "is this WIP?", "author": "bergerdenes", "createdAt": "2020-06-09T13:32:08Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/auditeventname/flow/datalake/StopDatalakeFlowOperationAuditEventNameConverter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.sequenceiq.cloudbreak.audit.converter.auditeventname.flow.datalake;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.model.AuditEventName;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n+\n+@Component\n+public class StopDatalakeFlowOperationAuditEventNameConverter implements DatalakeFlowOperationAuditEventNameConverter {\n+\n+    @Override\n+    public boolean isInit(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"STACK_STOP_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFinal(StructuredFlowEvent structuredEvent) {\n+        String flowEvent = structuredEvent.getFlow().getFlowEvent();\n+        return \"STOP_FINALIZED_EVENT\".equals(flowEvent);\n+    }\n+\n+    @Override\n+    public boolean isFailed(StructuredFlowEvent structuredEvent) {\n+        return false;", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyMzk5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437423992", "bodyText": "As I have commented earlier, that is important that\n\nwe should retry (it would be the responsibility of the client) auditing\nat this point we should only log, like this above\nfail hard, if the auditing is not possible\nand the behavior between 2) and 3) should be a feautre switch", "author": "bergerdenes", "createdAt": "2020-06-09T13:39:02Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/event/AuditStructuredEventHandler.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.sequenceiq.cloudbreak.audit.event;\n+\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.audit.AuditClient;\n+import com.sequenceiq.cloudbreak.audit.converter.EventDataExtractor;\n+import com.sequenceiq.cloudbreak.audit.model.ActorCrn;\n+import com.sequenceiq.cloudbreak.audit.model.AuditEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.OperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEvent;\n+import com.sequenceiq.flow.reactor.api.handler.EventHandler;\n+\n+import reactor.bus.Event;\n+\n+@Component\n+public class AuditStructuredEventHandler<T extends StructuredEvent> implements EventHandler<T> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AuditStructuredEventHandler.class);\n+\n+    @Inject\n+    private AuditClient auditClient;\n+\n+    @Inject\n+    private Map<String, EventDataExtractor<T>> eventDataExtractorMap;\n+\n+    @Override\n+    public String selector() {\n+        return AsyncAuditStructuredEventSender.AUDIT_EVENT_LOG_MESSAGE;\n+    }\n+\n+    @Override\n+    public void accept(Event<T> structuredEvent) {\n+        try {\n+            T data = structuredEvent.getData();\n+            OperationDetails operation = data.getOperation();\n+            var extractor = eventDataExtractorMap.get(operation.getEventType().name().toLowerCase() + \"EventDataExtractor\");\n+            AuditEvent event = AuditEvent.builder()\n+                    .withAccountId(operation.getTenant())\n+                    .withActor(ActorCrn.builder().withActorCrn(operation.getUserCrn()).build())\n+                    .withEventData(extractor.eventData(data))\n+                    .withEventName(extractor.eventName(data))\n+                    .withEventSource(extractor.eventSource(data))\n+                    .withSourceIp(extractor.sourceIp(data))\n+                    .build();\n+            auditClient.createAuditEvent(event);\n+        } catch (UnsupportedOperationException e) {\n+            LOGGER.debug(\"Audit log is unnecessary: {}\", e.getMessage());\n+        } catch (Exception e) {\n+            LOGGER.error(\"Cannot perform auditing: {}\", e.getMessage(), e);", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0MTc1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437441759", "bodyText": "I think that is very annoying if your sdx is failed after 1 hour because an audit log problem occurred at the end of the flow", "author": "topolyai5", "createdAt": "2020-06-09T13:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyMzk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3ODAyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r439278029", "bodyText": "followup story", "author": "bergerdenes", "createdAt": "2020-06-12T08:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyMzk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyNTI0NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437425245", "bodyText": "is it always datahub? I think the same is called for datalake", "author": "bergerdenes", "createdAt": "2020-06-09T13:40:35Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/events/DefaultCloudbreakEventService.java", "diffHunk": "@@ -121,18 +121,27 @@ public void fireCloudbreakInstanceGroupEvent(Long stackId, String eventType, Str\n     public List<StructuredNotificationEvent> cloudbreakEventsForStack(Long stackId) {\n         List<StructuredNotificationEvent> events = new ArrayList<>();\n         if (stackId != null) {\n-            events = structuredEventService.getEventsWithTypeAndResourceId(StructuredNotificationEvent.class, \"stacks\", stackId);\n+            events = structuredEventService.getEventsWithTypeAndResourceId(StructuredNotificationEvent.class,\n+                    CloudbreakEventService.DATAHUB_RESOURCE_TYPE, stackId);", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0MjA2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437442060", "bodyText": "wip", "author": "topolyai5", "createdAt": "2020-06-09T13:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyNTI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyNTM2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437425366", "bodyText": "is it always datahub? I think the same is called for datalake", "author": "bergerdenes", "createdAt": "2020-06-09T13:40:42Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/events/DefaultCloudbreakEventService.java", "diffHunk": "@@ -121,18 +121,27 @@ public void fireCloudbreakInstanceGroupEvent(Long stackId, String eventType, Str\n     public List<StructuredNotificationEvent> cloudbreakEventsForStack(Long stackId) {\n         List<StructuredNotificationEvent> events = new ArrayList<>();\n         if (stackId != null) {\n-            events = structuredEventService.getEventsWithTypeAndResourceId(StructuredNotificationEvent.class, \"stacks\", stackId);\n+            events = structuredEventService.getEventsWithTypeAndResourceId(StructuredNotificationEvent.class,\n+                    CloudbreakEventService.DATAHUB_RESOURCE_TYPE, stackId);", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyODQ3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r437428477", "bodyText": "please return the constant DATALAKE_RESOURCE_TYPE value", "author": "bergerdenes", "createdAt": "2020-06-09T13:43:38Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/events/DefaultCloudbreakEventService.java", "diffHunk": "@@ -121,18 +121,27 @@ public void fireCloudbreakInstanceGroupEvent(Long stackId, String eventType, Str\n     public List<StructuredNotificationEvent> cloudbreakEventsForStack(Long stackId) {\n         List<StructuredNotificationEvent> events = new ArrayList<>();\n         if (stackId != null) {\n-            events = structuredEventService.getEventsWithTypeAndResourceId(StructuredNotificationEvent.class, \"stacks\", stackId);\n+            events = structuredEventService.getEventsWithTypeAndResourceId(StructuredNotificationEvent.class,\n+                    CloudbreakEventService.DATAHUB_RESOURCE_TYPE, stackId);\n         }\n         return events;\n     }\n \n     @Override\n-    public Page<StructuredNotificationEvent> cloudbreakEventsForStack(Long stackId, Pageable pageable) {\n+    public Page<StructuredNotificationEvent> cloudbreakEventsForStack(Long stackId, String stackType, Pageable pageable) {\n         return Optional.ofNullable(stackId)\n-                .map(id -> structuredEventService.getEventsLimitedWithTypeAndResourceId(StructuredNotificationEvent.class, \"stacks\", id, pageable))\n+                .map(id -> structuredEventService.getEventsLimitedWithTypeAndResourceId(StructuredNotificationEvent.class,\n+                        getResourceType(stackType), id, pageable))\n                 .orElse(Page.empty());\n     }\n \n+    private String getResourceType(String stackType) {\n+        if (\"WORKLOAD\".equals(stackType)) {\n+            return DATAHUB_RESOURCE_TYPE;\n+        }\n+        return stackType.toLowerCase();", "originalCommit": "f2510ae30f518cc16f0481c102e0cb25b121081f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxNTY0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r438915648", "bodyText": "I'm not sure with the else brach. Because the datahub is different than the stack type, I created a converter but any other case I assume that the name is  same.", "author": "topolyai5", "createdAt": "2020-06-11T16:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyODQ3Nw=="}], "type": "inlineReview"}, {"oid": "b573591d4c3bd47e990926a4ca34fee90f5f296f", "url": "https://github.com/hortonworks/cloudbreak/commit/b573591d4c3bd47e990926a4ca34fee90f5f296f", "message": "Audit of Datalake", "committedDate": "2020-06-11T08:58:51Z", "type": "forcePushed"}, {"oid": "9d40e5820cd33c01abad95d9ee51d7840d3b734f", "url": "https://github.com/hortonworks/cloudbreak/commit/9d40e5820cd33c01abad95d9ee51d7840d3b734f", "message": "Audit of Datalake", "committedDate": "2020-06-11T17:48:55Z", "type": "forcePushed"}, {"oid": "22ca6b80dc46b3762cc4c6591d2ff8d482c243aa", "url": "https://github.com/hortonworks/cloudbreak/commit/22ca6b80dc46b3762cc4c6591d2ff8d482c243aa", "message": "Audit of Datalake", "committedDate": "2020-06-12T06:23:12Z", "type": "forcePushed"}, {"oid": "b64ac1011e16c069c7a28a20127a3938db73f12c", "url": "https://github.com/hortonworks/cloudbreak/commit/b64ac1011e16c069c7a28a20127a3938db73f12c", "message": "Audit of Datalake", "committedDate": "2020-06-12T06:59:54Z", "type": "forcePushed"}, {"oid": "6c3654442a6d8885a1fae9e9176643694d89acb2", "url": "https://github.com/hortonworks/cloudbreak/commit/6c3654442a6d8885a1fae9e9176643694d89acb2", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-12T10:15:31Z", "type": "forcePushed"}, {"oid": "337990e2deb1460dd116fa26a5d558d8e68d58a3", "url": "https://github.com/hortonworks/cloudbreak/commit/337990e2deb1460dd116fa26a5d558d8e68d58a3", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-12T11:24:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExNzE0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r440117148", "bodyText": "\ud83d\udc4d", "author": "bergerdenes", "createdAt": "2020-06-15T11:44:33Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/converter/AuditEventToGrpcAuditEventConverter.java", "diffHunk": "@@ -35,12 +36,17 @@\n                 .setTimestamp(System.currentTimeMillis())\n                 .setAccountId(source.getAccountId())\n                 .setRequestId(requestId)\n-                .setEventName(source.getEventName().name())\n+                .setEventName(formatAuditEventName(source))", "originalCommit": "337990e2deb1460dd116fa26a5d558d8e68d58a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyMTkwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r440121908", "bodyText": "Please rename the corresponding constants to the following, as it was recommended in the event names sheet:\nCREATE_DATAHUB_CLUSTER\nDELETE_DATAHUB_CLUSTER\nSTOP_DATAHUB_CLUSTER\nRESIZE_DATAHUB_CLUSTER\nDELETE_DATAHUB_CLUSTER_INSTANCE\nMAINTAIN_DATAHUB_CLUSTER\nSTART_DATAHUB_CLUSTER", "author": "bergerdenes", "createdAt": "2020-06-15T11:53:50Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/model/AuditEventName.java", "diffHunk": "@@ -1,5 +1,25 @@\n package com.sequenceiq.cloudbreak.audit.model;\n \n public enum AuditEventName {\n-    DATAHUB_CLUSTER_CREATION\n+    CREATION_DATAHUB_CLUSTER,\n+    DELETION_DATAHUB_CLUSTER,\n+    STOPPAGE_DATAHUB_CLUSTER,\n+    RESIZING_DATAHUB_CLUSTER,\n+    MANUAL_REPAIR_DATAHUB_CLUSTER,\n+    SYNC_DATAHUB_CLUSTER,\n+    RETRY_DATAHUB_CLUSTER,\n+    INSTANCE_DELETION_DATAHUB_CLUSTER,\n+    MAINTENANCE_DATAHUB_CLUSTER,\n+    STARTING_DATAHUB_CLUSTER,", "originalCommit": "337990e2deb1460dd116fa26a5d558d8e68d58a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE1MDcxOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r440150718", "bodyText": "done", "author": "topolyai5", "createdAt": "2020-06-15T12:48:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyMTkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyMzA0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r440123044", "bodyText": "Please rename the corresponding constants to the following, as it was recommended in the event names sheet:\nCREATE_DATALAKE_CLUSTER\nDELETE_DATALAKE_CLUSTER\nSTOP_DATALAKE_CLUSTER\nRESIZE_DATALAKE_CLUSTER\nDELETE_DATALAKE_CLUSTER_INSTANCE\nMAINTAIN_DATALAKE_CLUSTER\nSTART_DATALAKE_CLUSTER", "author": "bergerdenes", "createdAt": "2020-06-15T11:55:54Z", "path": "audit-connector/src/main/java/com/sequenceiq/cloudbreak/audit/model/AuditEventName.java", "diffHunk": "@@ -1,5 +1,25 @@\n package com.sequenceiq.cloudbreak.audit.model;\n \n public enum AuditEventName {\n-    DATAHUB_CLUSTER_CREATION\n+    CREATION_DATAHUB_CLUSTER,\n+    DELETION_DATAHUB_CLUSTER,\n+    STOPPAGE_DATAHUB_CLUSTER,\n+    RESIZING_DATAHUB_CLUSTER,\n+    MANUAL_REPAIR_DATAHUB_CLUSTER,\n+    SYNC_DATAHUB_CLUSTER,\n+    RETRY_DATAHUB_CLUSTER,\n+    INSTANCE_DELETION_DATAHUB_CLUSTER,\n+    MAINTENANCE_DATAHUB_CLUSTER,\n+    STARTING_DATAHUB_CLUSTER,\n+\n+    CREATION_DATALAKE_CLUSTER,\n+    DELETION_DATALAKE_CLUSTER,\n+    STOPPAGE_DATALAKE_CLUSTER,\n+    RESIZING_DATALAKE_CLUSTER,\n+    MANUAL_REPAIR_DATALAKE_CLUSTER,\n+    SYNC_DATALAKE_CLUSTER,\n+    RETRY_DATALAKE_CLUSTER,\n+    INSTANCE_DELETION_DATALAKE_CLUSTER,\n+    MAINTENANCE_DATALAKE_CLUSTER,\n+    STARTING_DATALAKE_CLUSTER", "originalCommit": "337990e2deb1460dd116fa26a5d558d8e68d58a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE1MDc5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8153#discussion_r440150797", "bodyText": "done", "author": "topolyai5", "createdAt": "2020-06-15T12:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyMzA0NA=="}], "type": "inlineReview"}, {"oid": "7b2e89c7706fb755858a3ae69ca1159e5d25ceed", "url": "https://github.com/hortonworks/cloudbreak/commit/7b2e89c7706fb755858a3ae69ca1159e5d25ceed", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-15T12:45:33Z", "type": "forcePushed"}, {"oid": "0c937108934c268714a6acf9a121515115659bf5", "url": "https://github.com/hortonworks/cloudbreak/commit/0c937108934c268714a6acf9a121515115659bf5", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-15T12:54:09Z", "type": "forcePushed"}, {"oid": "35ee14acaf9bb078e05f880e9ab8c5ec397a779b", "url": "https://github.com/hortonworks/cloudbreak/commit/35ee14acaf9bb078e05f880e9ab8c5ec397a779b", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-15T12:59:48Z", "type": "forcePushed"}, {"oid": "e27109b6e303b51e33e9a78767bcc5718f966db5", "url": "https://github.com/hortonworks/cloudbreak/commit/e27109b6e303b51e33e9a78767bcc5718f966db5", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-15T13:47:47Z", "type": "forcePushed"}, {"oid": "efee7f302d344975cb768ebd6c2d5bd4bd8d658a", "url": "https://github.com/hortonworks/cloudbreak/commit/efee7f302d344975cb768ebd6c2d5bd4bd8d658a", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-15T14:23:40Z", "type": "commit"}, {"oid": "efee7f302d344975cb768ebd6c2d5bd4bd8d658a", "url": "https://github.com/hortonworks/cloudbreak/commit/efee7f302d344975cb768ebd6c2d5bd4bd8d658a", "message": "CB-6805 extract rest and flow into AuditEvent", "committedDate": "2020-06-15T14:23:40Z", "type": "forcePushed"}]}