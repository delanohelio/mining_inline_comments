{"pr_number": 9385, "pr_title": "CB-7552: IDBroker VM is provisioned with an attached disk that remain\u2026", "pr_createdAt": "2020-11-09T05:02:56Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9385", "timeline": [{"oid": "58cb040c92afc8af318260eb386ad7976ed19955", "url": "https://github.com/hortonworks/cloudbreak/commit/58cb040c92afc8af318260eb386ad7976ed19955", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused", "committedDate": "2020-11-10T05:34:46Z", "type": "forcePushed"}, {"oid": "f34effd6b897201392ad399408b4ccc5b5299e05", "url": "https://github.com/hortonworks/cloudbreak/commit/f34effd6b897201392ad399408b4ccc5b5299e05", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused", "committedDate": "2020-11-11T05:24:57Z", "type": "forcePushed"}, {"oid": "51323b9bd8fbf69730bd80d64c1b06e1d51d9681", "url": "https://github.com/hortonworks/cloudbreak/commit/51323b9bd8fbf69730bd80d64c1b06e1d51d9681", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused", "committedDate": "2020-11-12T16:54:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxNjg1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r522316850", "bodyText": "Update the error message to state that IDBroker does not use data volume and so you are expecting it to be zero.", "author": "kmanamcheri", "createdAt": "2020-11-12T18:16:48Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -157,13 +163,22 @@ private void validateVolumeType(VolumeTemplate value, Platform platform, Validat\n         }\n     }\n \n+    private boolean isIDBrokerInstanceGroup(InstanceGroup instanceGroup) {\n+        return groupNameIDBroker.equalsIgnoreCase(instanceGroup.getGroupName());\n+    }\n+\n     private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n                 if (value.getVolumeCount() > config.maximumNumber()) {\n                     validationBuilder.error(String.format(\"Max allowed volume count for '%s': %s\", vmType.value(), config.maximumNumber()));\n+                } else if (isIDBrokerInstanceGroup(instanceGroup)) {\n+                    if (value.getVolumeCount() != 0)  {\n+                        // IDBroker does not use data volume, so its volume count should be zero\n+                        validationBuilder.error(String.format(\"IDBroker volume count: %s is not zero\", value.getVolumeCount()));", "originalCommit": "51323b9bd8fbf69730bd80d64c1b06e1d51d9681", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxODUyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r522318521", "bodyText": "nit: why use a constant and then a function, and then another helper function. Why can't we just use the string to compare directly?\nAlso, static strings should be upper case.\nIDBROKER_GROUP_NAME.equalsIgnoreCase(instanceGroup.getGroupName());", "author": "kmanamcheri", "createdAt": "2020-11-12T18:19:22Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -157,13 +163,22 @@ private void validateVolumeType(VolumeTemplate value, Platform platform, Validat\n         }\n     }\n \n+    private boolean isIDBrokerInstanceGroup(InstanceGroup instanceGroup) {\n+        return groupNameIDBroker.equalsIgnoreCase(instanceGroup.getGroupName());", "originalCommit": "51323b9bd8fbf69730bd80d64c1b06e1d51d9681", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxOTUwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r522319505", "bodyText": "This can be final and by convention static final variables are upper cased.\nhttps://docs.oracle.com/javase/tutorial/java/nutsandbolts/variables.html\n\nIf your variable stores a constant value, such as static final int NUM_GEARS = 6, the convention changes slightly, capitalizing every letter and separating subsequent words with the underscore character. By convention, the underscore character is never used elsewhere.", "author": "kmanamcheri", "createdAt": "2020-11-12T18:21:02Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -29,13 +29,15 @@\n import com.sequenceiq.cloudbreak.domain.Template;\n import com.sequenceiq.cloudbreak.domain.VolumeTemplate;\n import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.domain.stack.instance.InstanceGroup;\n import com.sequenceiq.cloudbreak.dto.credential.Credential;\n import com.sequenceiq.cloudbreak.validation.ValidationResult;\n import com.sequenceiq.cloudbreak.workspace.model.User;\n import com.sequenceiq.common.api.type.CdpResourceType;\n \n @Component\n public class TemplateValidator {\n+    private static String groupNameIDBroker = \"idbroker\";", "originalCommit": "51323b9bd8fbf69730bd80d64c1b06e1d51d9681", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29c2955c3a047560db5570582733a5c55e4d0408", "url": "https://github.com/hortonworks/cloudbreak/commit/29c2955c3a047560db5570582733a5c55e4d0408", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused", "committedDate": "2020-11-12T21:33:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MDk0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r522470941", "bodyText": "You have a typo in doesn't\nI prefer not using contractions in error logs. Use the full form does not", "author": "kmanamcheri", "createdAt": "2020-11-12T22:25:33Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -157,13 +159,24 @@ private void validateVolumeType(VolumeTemplate value, Platform platform, Validat\n         }\n     }\n \n+    private boolean isIDBrokerInstanceGroup(InstanceGroup instanceGroup) {\n+        return GROUP_NAME_ID_BROKER.equalsIgnoreCase(instanceGroup.getGroupName());\n+    }\n+\n     private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n                 if (value.getVolumeCount() > config.maximumNumber()) {\n                     validationBuilder.error(String.format(\"Max allowed volume count for '%s': %s\", vmType.value(), config.maximumNumber()));\n+                } else if (isIDBrokerInstanceGroup(instanceGroup)) {\n+                    if (value.getVolumeCount() != 0)  {\n+                        // IDBroker does not use data volume, so its volume count should be zero\n+                        validationBuilder.error(\n+                                String.format(\"IDBroker volume count: %s is not zero. It does't use data volume, and its count must be zero.\",", "originalCommit": "29c2955c3a047560db5570582733a5c55e4d0408", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ba06b229fa6157b505fc6533a31c348d2966da45", "url": "https://github.com/hortonworks/cloudbreak/commit/ba06b229fa6157b505fc6533a31c348d2966da45", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused", "committedDate": "2020-11-13T03:44:48Z", "type": "forcePushed"}, {"oid": "b2e3748737e3dd84db26cf1635583eaf4e18b3ec", "url": "https://github.com/hortonworks/cloudbreak/commit/b2e3748737e3dd84db26cf1635583eaf4e18b3ec", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused", "committedDate": "2020-11-13T17:55:10Z", "type": "forcePushed"}, {"oid": "c89488c8c02ccc4ea70cc326418e452aaa4cfc2c", "url": "https://github.com/hortonworks/cloudbreak/commit/c89488c8c02ccc4ea70cc326418e452aaa4cfc2c", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused", "committedDate": "2020-11-14T00:06:28Z", "type": "forcePushed"}, {"oid": "2cd06a23163c83b6f8344cbf9457d94eed285e13", "url": "https://github.com/hortonworks/cloudbreak/commit/2cd06a23163c83b6f8344cbf9457d94eed285e13", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused\n\nAdd unit tests. All related unit tests past.", "committedDate": "2020-11-18T03:22:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzOTk4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r526039985", "bodyText": "why we are doing this? we dont want to set it if the user specify us. QA team can test any scenario.", "author": "doktoric", "createdAt": "2020-11-18T12:13:30Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -157,12 +159,23 @@ private void validateVolumeType(VolumeTemplate value, Platform platform, Validat\n         }\n     }\n \n+    private boolean isIDBrokerInstanceGroup(InstanceGroup instanceGroup) {\n+        return GROUP_NAME_ID_BROKER.equalsIgnoreCase(instanceGroup.getGroupName());\n+    }\n+\n     private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n-                if (value.getVolumeCount() > config.maximumNumber()) {\n+                if (isIDBrokerInstanceGroup(instanceGroup)) {\n+                    if (value.getVolumeCount() > 0) {", "originalCommit": "2cd06a23163c83b6f8344cbf9457d94eed285e13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE0NDE5NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r526144194", "bodyText": "@doktoric I think we never want to attach a data volume for the IDBroker node. I don't think QA team should or want to test this. This is applicable ONLY for IDBroker nodes. The reason is that IDBroker should not need a data volume.", "author": "kmanamcheri", "createdAt": "2020-11-18T14:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzOTk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0MDEyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r526040121", "bodyText": "I dont think we should do this", "author": "doktoric", "createdAt": "2020-11-18T12:13:47Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -174,11 +187,18 @@ private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumePara\n     }\n \n     private void validateVolumeSize(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n-                if (value.getVolumeSize() > config.maximumSize()) {\n+                if (isIDBrokerInstanceGroup(instanceGroup)) {\n+                    if (value.getVolumeSize() > 0) {", "originalCommit": "2cd06a23163c83b6f8344cbf9457d94eed285e13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b203109ee8c21677c5c1bb3f6e8faf17172ba7ea", "url": "https://github.com/hortonworks/cloudbreak/commit/b203109ee8c21677c5c1bb3f6e8faf17172ba7ea", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused\n\nAdd unit tests. All related unit tests past.", "committedDate": "2020-11-18T20:42:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0NjAxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r527146013", "bodyText": "Naive question: Is there possibly any VM type that has a positive minimum size? If so, the change above will cause conflicts if the custom DL is launched with the IDBroker using such an instance type.", "author": "lajosrodek", "createdAt": "2020-11-19T19:33:05Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -157,12 +159,21 @@ private void validateVolumeType(VolumeTemplate value, Platform platform, Validat\n         }\n     }\n \n+    private boolean isIDBrokerInstanceGroup(InstanceGroup instanceGroup) {\n+        return GROUP_NAME_ID_BROKER.equalsIgnoreCase(instanceGroup.getGroupName());\n+    }\n+\n     private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n-                if (value.getVolumeCount() > config.maximumNumber()) {\n+                if (isIDBrokerInstanceGroup(instanceGroup)) {\n+                    if (value.getVolumeCount() != 0) {\n+                        // IDBroker does not use data volume, so its volume count should be zero\n+                        validationBuilder.error(String.format(\"IDBroker volume count: %s is not zero\", value.getVolumeCount()));\n+                    }\n+                } else if (value.getVolumeCount() > config.maximumNumber()) {\n                     validationBuilder.error(String.format(\"Max allowed volume count for '%s': %s\", vmType.value(), config.maximumNumber()));\n                 } else if (value.getVolumeCount() < config.minimumNumber()) {", "originalCommit": "b203109ee8c21677c5c1bb3f6e8faf17172ba7ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0Njc4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r527146785", "bodyText": "Like above, I wonder if forcing the size & count to zero causes any troubles for custom DL clusters.", "author": "lajosrodek", "createdAt": "2020-11-19T19:34:24Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -174,11 +185,16 @@ private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumePara\n     }\n \n     private void validateVolumeSize(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n-                if (value.getVolumeSize() > config.maximumSize()) {\n+                if (isIDBrokerInstanceGroup(instanceGroup)) {\n+                    if (value.getVolumeSize() != 0) {\n+                        // IDBroker does not use data volume, so its volume size should be zero\n+                        validationBuilder.error(String.format(\"IDBroker volume size: %s is not zero\", value.getVolumeSize()));\n+                    }\n+                } else if (value.getVolumeSize() > config.maximumSize()) {\n                     validationBuilder.error(String.format(\"Max allowed volume size for '%s': %s\", vmType.value(), config.maximumSize()));\n                 } else if (value.getVolumeSize() < config.minimumSize()) {", "originalCommit": "b203109ee8c21677c5c1bb3f6e8faf17172ba7ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0OTAzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r527149034", "bodyText": "The usage of JUnit 5 would be preferable; it is high time to get rid of JUnit 4. For assertions, please consider using AssertJ assertThat() etc. as its fluent API is more expressive. (Neither of these are mandatory or enforced anywhere, but it would be nice to use them in new tests at least.)", "author": "lajosrodek", "createdAt": "2020-11-19T19:38:16Z", "path": "core/src/test/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidatorTest.java", "diffHunk": "@@ -0,0 +1,217 @@\n+package com.sequenceiq.cloudbreak.controller.validation.template;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.isNull;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.junit.Assert;", "originalCommit": "b203109ee8c21677c5c1bb3f6e8faf17172ba7ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0OTQzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r527149432", "bodyText": "I wonder if anyone relying on custom DL templates would be pissed about this change if they expected the volume to be present (for whatever reason). I know we are already committing such a change by overwriting the RAZ flag just a few lines below. \ud83d\ude04", "author": "lajosrodek", "createdAt": "2020-11-19T19:38:59Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java", "diffHunk": "@@ -288,9 +292,12 @@ private StackV4Request getStackRequest(SdxClusterRequest sdxClusterRequest, Stac\n                 throw new BadRequestException(\"Can't find template for cloudplatform: \" + cloudPlatform + \", shape: \" + sdxClusterRequest.getClusterShape() +\n                         \", runtime version: \" + runtimeVersion);\n             }\n+            updateStackV4RequestWithIDBrokerVolume(stackRequest);\n             stackRequest.getCluster().setRangerRazEnabled(sdxClusterRequest.isEnableRangerRaz());\n             return stackRequest;\n         } else {\n+            updateStackV4RequestWithIDBrokerVolume(internalStackV4Request);", "originalCommit": "b203109ee8c21677c5c1bb3f6e8faf17172ba7ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE1MTM5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r527151396", "bodyText": "Nit: compatable -> compatible.", "author": "lajosrodek", "createdAt": "2020-11-19T19:42:10Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java", "diffHunk": "@@ -299,6 +306,26 @@ private StackV4Request getStackRequest(SdxClusterRequest sdxClusterRequest, Stac\n         }\n     }\n \n+    private void updateStackV4RequestWithIDBrokerVolume(StackV4Request request) {\n+        for (InstanceGroupV4Request instanceGroupV4Request : request.getInstanceGroups()) {\n+            if (!GROUP_NAME_ID_BROKER.equalsIgnoreCase(instanceGroupV4Request.getName())) {\n+                continue;\n+            }\n+\n+            InstanceTemplateV4Request templateV4Request = instanceGroupV4Request.getTemplate();\n+            if (templateV4Request == null || templateV4Request.getAttachedVolumes() == null) {\n+                continue;\n+            }\n+\n+            for (VolumeV4Request attachedVolumeRequest : templateV4Request.getAttachedVolumes()) {\n+                // IDBroker does not use data volume, so its volume count should be zero\n+                // set the data volume count and size to be zero to be backward-compatable and avoid creating volume that is not used", "originalCommit": "b203109ee8c21677c5c1bb3f6e8faf17172ba7ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "abffad9c40521fcb65b8ae91ab047452bed0d0af", "url": "https://github.com/hortonworks/cloudbreak/commit/abffad9c40521fcb65b8ae91ab047452bed0d0af", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused\n\nAdd unit tests. All related unit tests past.", "committedDate": "2020-11-20T04:12:03Z", "type": "forcePushed"}, {"oid": "d36e6ac7bf37a172d0bbb3ea5d3fdb87e5e0e01a", "url": "https://github.com/hortonworks/cloudbreak/commit/d36e6ac7bf37a172d0bbb3ea5d3fdb87e5e0e01a", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused\n\nAdd unit tests. All related unit tests past.", "committedDate": "2020-11-20T19:11:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU3MDM3OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r528570378", "bodyText": "Insert !isIDBrokerInstanceGroup(instanceGroup) &&  at the beginning of condition.", "author": "lajosrodek", "createdAt": "2020-11-23T09:36:01Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -157,12 +159,22 @@ private void validateVolumeType(VolumeTemplate value, Platform platform, Validat\n         }\n     }\n \n+    private boolean isIDBrokerInstanceGroup(InstanceGroup instanceGroup) {\n+        return GROUP_NAME_ID_BROKER.equalsIgnoreCase(instanceGroup.getGroupName());\n+    }\n+\n     private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n-                if (value.getVolumeCount() > config.maximumNumber()) {\n+                if (isIDBrokerInstanceGroup(instanceGroup)) {\n+                    if (value.getVolumeCount() > config.maximumNumber()) {\n+                        // IDBroker does not use data volume, so its volume count should be zero\n+                        // To be backward-compatible, we only check max limit and allow the min limit to be zero for IDBroker\n+                        validationBuilder.error(String.format(\"Max allowed volume count for '%s': %s\", vmType.value(), config.maximumNumber()));\n+                    }\n+                } else if (value.getVolumeCount() > config.maximumNumber()) {\n                     validationBuilder.error(String.format(\"Max allowed volume count for '%s': %s\", vmType.value(), config.maximumNumber()));\n                 } else if (value.getVolumeCount() < config.minimumNumber()) {", "originalCommit": "d36e6ac7bf37a172d0bbb3ea5d3fdb87e5e0e01a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU3MzIzOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r528573239", "bodyText": "Please do not duplicate code. There is no need for this isIDBrokerInstanceGroup(instanceGroup) branch. Instead, the original validation for the max limit can be reused without changes, and the extra check for the IDBroker instance group name can be added to the min limit validation below. The comment can be also moved in front of the whole if block, or possibly inside the min limit validation branch (whichever you prefer).", "author": "lajosrodek", "createdAt": "2020-11-23T09:40:34Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -157,12 +159,22 @@ private void validateVolumeType(VolumeTemplate value, Platform platform, Validat\n         }\n     }\n \n+    private boolean isIDBrokerInstanceGroup(InstanceGroup instanceGroup) {\n+        return GROUP_NAME_ID_BROKER.equalsIgnoreCase(instanceGroup.getGroupName());\n+    }\n+\n     private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n-                if (value.getVolumeCount() > config.maximumNumber()) {\n+                if (isIDBrokerInstanceGroup(instanceGroup)) {", "originalCommit": "d36e6ac7bf37a172d0bbb3ea5d3fdb87e5e0e01a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU3NDc0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r528574747", "bodyText": "Like above, please remove the new isIDBrokerInstanceGroup(instanceGroup) branch and reuse the original max limit validation without any changes.", "author": "lajosrodek", "createdAt": "2020-11-23T09:43:04Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -174,11 +186,17 @@ private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumePara\n     }\n \n     private void validateVolumeSize(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n-                if (value.getVolumeSize() > config.maximumSize()) {\n+                if (isIDBrokerInstanceGroup(instanceGroup)) {", "originalCommit": "d36e6ac7bf37a172d0bbb3ea5d3fdb87e5e0e01a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU3NjIxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r528576214", "bodyText": "Insert !isIDBrokerInstanceGroup(instanceGroup) &&  at the beginning of condition.", "author": "lajosrodek", "createdAt": "2020-11-23T09:45:27Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidator.java", "diffHunk": "@@ -174,11 +186,17 @@ private void validateVolumeCount(VolumeTemplate value, VmType vmType, VolumePara\n     }\n \n     private void validateVolumeSize(VolumeTemplate value, VmType vmType, VolumeParameterType volumeParameterType,\n-        ValidationResult.ValidationResultBuilder validationBuilder) {\n+        ValidationResult.ValidationResultBuilder validationBuilder, InstanceGroup instanceGroup) {\n         if (vmType != null && needToCheckVolume(volumeParameterType, value.getVolumeCount())) {\n             VolumeParameterConfig config = vmType.getVolumeParameterbyVolumeParameterType(volumeParameterType);\n             if (config != null) {\n-                if (value.getVolumeSize() > config.maximumSize()) {\n+                if (isIDBrokerInstanceGroup(instanceGroup)) {\n+                    if (value.getVolumeSize() > config.maximumSize()) {\n+                        // IDBroker does not use data volume, so its volume size should be zero\n+                        // To be backward-compatible, we only check max limit and allow the min limit to be zero for IDBroker\n+                        validationBuilder.error(String.format(\"Max allowed volume size for '%s': %s\", vmType.value(), config.maximumSize()));\n+                    }\n+                } else if (value.getVolumeSize() > config.maximumSize()) {\n                     validationBuilder.error(String.format(\"Max allowed volume size for '%s': %s\", vmType.value(), config.maximumSize()));\n                 } else if (value.getVolumeSize() < config.minimumSize()) {", "originalCommit": "d36e6ac7bf37a172d0bbb3ea5d3fdb87e5e0e01a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU3NzM2NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r528577365", "bodyText": "Please use JUnit 5 (Jupiter API) for new test classes.", "author": "lajosrodek", "createdAt": "2020-11-23T09:47:22Z", "path": "core/src/test/java/com/sequenceiq/cloudbreak/controller/validation/template/TemplateValidatorTest.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.sequenceiq.cloudbreak.controller.validation.template;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.isNull;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.junit.Before;", "originalCommit": "d36e6ac7bf37a172d0bbb3ea5d3fdb87e5e0e01a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU3Nzg5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9385#discussion_r528577897", "bodyText": "Please remove, this is not needed anymore.", "author": "lajosrodek", "createdAt": "2020-11-23T09:48:21Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java", "diffHunk": "@@ -92,6 +92,8 @@\n @Service\n public class SdxService implements ResourceIdProvider, ResourceBasedCrnProvider {\n \n+    private static final String GROUP_NAME_ID_BROKER = \"idbroker\";", "originalCommit": "d36e6ac7bf37a172d0bbb3ea5d3fdb87e5e0e01a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7c7b1a6e3da0684be871c961d8d5d75bd604f465", "url": "https://github.com/hortonworks/cloudbreak/commit/7c7b1a6e3da0684be871c961d8d5d75bd604f465", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused\n\nAdd unit tests. All related unit tests past.", "committedDate": "2020-11-23T13:59:32Z", "type": "commit"}, {"oid": "7c7b1a6e3da0684be871c961d8d5d75bd604f465", "url": "https://github.com/hortonworks/cloudbreak/commit/7c7b1a6e3da0684be871c961d8d5d75bd604f465", "message": "CB-7552: IDBroker VM is provisioned with an attached disk that remains unused\n\nAdd unit tests. All related unit tests past.", "committedDate": "2020-11-23T13:59:32Z", "type": "forcePushed"}]}