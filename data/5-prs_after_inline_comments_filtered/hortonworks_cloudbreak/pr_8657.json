{"pr_number": 8657, "pr_title": "CB-7490 avoid duplicate key value violates unique constraint \"uk_user_crn\" error during credential creation", "pr_createdAt": "2020-07-28T13:45:33Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8657", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY0MzcwMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8657#discussion_r461643701", "bodyText": "couldn't we just drop the whole transaction?\nI'm not sure about the UMS call, but that could take up some time as it's an external call. If we can skip it it would be great.\nbut I would definitely move the notification out from the transaction", "author": "lacikaaa", "createdAt": "2020-07-28T14:50:30Z", "path": "environment/src/main/java/com/sequenceiq/environment/credential/service/CredentialService.java", "diffHunk": "@@ -179,12 +179,12 @@ public Credential create(Credential credential, @Nonnull String accountId, @Nonn\n         credential.setResourceCrn(credentialCrn);\n         credential.setCreator(creatorUserCrn);\n         credential.setAccountId(accountId);\n+        Credential verifiedCredential = credentialAdapter.verify(credential, accountId).getCredential();\n+        if (verifiedCredential.getVerificationStatusText() != null) {\n+            throw new BadRequestException(verifiedCredential.getVerificationStatusText());\n+        }\n         try {\n             return transactionService.required(() -> {", "originalCommit": "66973ab8d17e5077f07a5cc7821c604df50a50f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aef75d0a71dc7f8741aa73c3fb0d1d3aed21c1ad", "url": "https://github.com/hortonworks/cloudbreak/commit/aef75d0a71dc7f8741aa73c3fb0d1d3aed21c1ad", "message": "CB-7490 avoid duplicate key value violates unique constraint \"uk_user_crn\" error during credential creation\n\n- Remove long running credential verification code from the transactional block to avoid long transacition duration\n- Remove UserPreferencesService.getExternalId() from the transactional block as it can cause the duplicate key error", "committedDate": "2020-07-28T15:29:57Z", "type": "forcePushed"}, {"oid": "8655a9b53820c5fb6aad459d1d8aff265827d952", "url": "https://github.com/hortonworks/cloudbreak/commit/8655a9b53820c5fb6aad459d1d8aff265827d952", "message": "CB-7490 avoid duplicate key value violates unique constraint \"uk_user_crn\" error during credential creation\n\n- Remove long running credential verification code from the transactional block to avoid long transacition duration\n- With verification removal the UserPreferencesService.getExternalId() will be removed from the transactional block. This method call in the transaction was the main reason of the duplicate key error\n- Remove notification sending from the transactional block", "committedDate": "2020-07-28T15:50:46Z", "type": "forcePushed"}, {"oid": "f0cc0f2c14517248dad50a94a0e6ee64343114cf", "url": "https://github.com/hortonworks/cloudbreak/commit/f0cc0f2c14517248dad50a94a0e6ee64343114cf", "message": "CB-7490 avoid duplicate key value violates unique constraint \"uk_user_crn\" error during credential creation\n\n- Remove long running credential verification code from the transactional block to avoid long transacition duration\n- With verification removal the UserPreferencesService.getExternalId() will be removed from the transactional block. This method call in the transaction was the main reason of the duplicate key error\n- Remove notification sending from the transactional block", "committedDate": "2020-07-29T09:12:55Z", "type": "forcePushed"}, {"oid": "0e2b27a5df1b09fd7a901266b5d9f16e2ec5cb46", "url": "https://github.com/hortonworks/cloudbreak/commit/0e2b27a5df1b09fd7a901266b5d9f16e2ec5cb46", "message": "CB-7490 avoid duplicate key value violates unique constraint \"uk_user_crn\" error during credential creation\n\n- Remove long running credential verification code from the transactional block to avoid long transacition duration\n- With verification removal the UserPreferencesService.getExternalId() will be removed from the transactional block. This method call in the transaction was the main reason of the duplicate key error\n- Remove notification sending from the transactional block", "committedDate": "2020-07-29T10:19:10Z", "type": "commit"}, {"oid": "0e2b27a5df1b09fd7a901266b5d9f16e2ec5cb46", "url": "https://github.com/hortonworks/cloudbreak/commit/0e2b27a5df1b09fd7a901266b5d9f16e2ec5cb46", "message": "CB-7490 avoid duplicate key value violates unique constraint \"uk_user_crn\" error during credential creation\n\n- Remove long running credential verification code from the transactional block to avoid long transacition duration\n- With verification removal the UserPreferencesService.getExternalId() will be removed from the transactional block. This method call in the transaction was the main reason of the duplicate key error\n- Remove notification sending from the transactional block", "committedDate": "2020-07-29T10:19:10Z", "type": "forcePushed"}]}