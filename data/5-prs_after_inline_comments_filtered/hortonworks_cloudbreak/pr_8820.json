{"pr_number": 8820, "pr_title": "CB-7876 Fail API Cleanup Jenkins build in case of left resources", "pr_createdAt": "2020-08-14T17:09:34Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8820", "timeline": [{"oid": "e237f302d07be33b6fbb2e11082307251777585a", "url": "https://github.com/hortonworks/cloudbreak/commit/e237f302d07be33b6fbb2e11082307251777585a", "message": "CB-7876 Fail API Cleanup Jenkins build in case of left resources", "committedDate": "2020-08-14T18:45:43Z", "type": "forcePushed"}, {"oid": "3b5b67c7a0508fa743c0852684f45d183015099f", "url": "https://github.com/hortonworks/cloudbreak/commit/3b5b67c7a0508fa743c0852684f45d183015099f", "message": "CB-7876 Fail API Cleanup Jenkins build in case of left resources", "committedDate": "2020-08-14T18:59:35Z", "type": "forcePushed"}, {"oid": "3cc7881826eb3552f34ed0384c7b92ffc3ed92b7", "url": "https://github.com/hortonworks/cloudbreak/commit/3cc7881826eb3552f34ed0384c7b92ffc3ed92b7", "message": "CB-7876 Fail API Cleanup Jenkins build in case of left resources", "committedDate": "2020-08-14T22:21:45Z", "type": "forcePushed"}, {"oid": "028597844c8baa42f57fc72c2be0f65a1525947f", "url": "https://github.com/hortonworks/cloudbreak/commit/028597844c8baa42f57fc72c2be0f65a1525947f", "message": "CB-7876 Fail API Cleanup Jenkins build in case of left resources", "committedDate": "2020-08-15T06:37:35Z", "type": "forcePushed"}, {"oid": "48e72990813fdb55f4b41943bd3f0dd031e2430c", "url": "https://github.com/hortonworks/cloudbreak/commit/48e72990813fdb55f4b41943bd3f0dd031e2430c", "message": "CB-7876 Fail API Cleanup Jenkins build in case of left resources", "committedDate": "2020-08-15T10:08:19Z", "type": "forcePushed"}, {"oid": "6cd0998074d264507333c55ef93c391dba0a85c2", "url": "https://github.com/hortonworks/cloudbreak/commit/6cd0998074d264507333c55ef93c391dba0a85c2", "message": "CB-8484 Replace TestContext to MockedTestContext for integration tests", "committedDate": "2020-08-15T11:18:41Z", "type": "forcePushed"}, {"oid": "c69dcc5f36558a857651a3c837a8ca80b6929982", "url": "https://github.com/hortonworks/cloudbreak/commit/c69dcc5f36558a857651a3c837a8ca80b6929982", "message": "CB-8484 Replace TestContext to MockedTestContext for integration tests", "committedDate": "2020-08-15T11:30:51Z", "type": "forcePushed"}, {"oid": "225810518e2615ca7f40443e8bdc53db6de424c8", "url": "https://github.com/hortonworks/cloudbreak/commit/225810518e2615ca7f40443e8bdc53db6de424c8", "message": "CB-8484 Replace TestContext to MockedTestContext for integration tests", "committedDate": "2020-08-15T11:34:05Z", "type": "forcePushed"}, {"oid": "656a9a8f15ab9959634c83b63b31833b55d1ef61", "url": "https://github.com/hortonworks/cloudbreak/commit/656a9a8f15ab9959634c83b63b31833b55d1ef61", "message": "CB-8484 Replace TestContext to MockedTestContext for integration tests", "committedDate": "2020-08-15T11:38:23Z", "type": "forcePushed"}, {"oid": "98ced8dd754f7762489c7d0601f00ed150a7d19d", "url": "https://github.com/hortonworks/cloudbreak/commit/98ced8dd754f7762489c7d0601f00ed150a7d19d", "message": "CB-8484 Replace TestContext to MockedTestContext for integration tests", "committedDate": "2020-08-15T12:10:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk0MjU4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8820#discussion_r478942585", "bodyText": "Please use this standard library method for file reading:\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/file/Files.html#readString(java.nio.file.Path)", "author": "foldik", "createdAt": "2020-08-28T08:31:38Z", "path": "integration-test/src/main/java/com/sequenceiq/it/util/cleanup/CleanupUtil.java", "diffHunk": "@@ -172,21 +191,213 @@ public void cleanupCredentials() {\n         return sdxNames;\n     }\n \n-    private void deleteEnvironments(Set<String> environmentNames, EnvironmentClient environmentClient) {\n-        environmentNames.forEach(environmentName -> LOG.info(\"Environment with name: {} will be deleted!\", environmentName));\n+    private List<String> getResourcesFromFile(String resourceNameType, Path filePath) {\n+        List<String> resourceNames = new ArrayList<>();\n+        try (BufferedReader reader = new BufferedReader(new FileReader(filePath.toString()))) {\n+            StringBuilder builder = new StringBuilder();\n+            String line;\n+            while ((line = reader.readLine()) != null) {", "originalCommit": "98ced8dd754f7762489c7d0601f00ed150a7d19d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk0NTAxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8820#discussion_r478945014", "bodyText": "Why not an empty list with List.of()?", "author": "foldik", "createdAt": "2020-08-28T08:34:19Z", "path": "integration-test/src/main/java/com/sequenceiq/it/util/cleanup/CleanupUtil.java", "diffHunk": "@@ -172,21 +191,213 @@ public void cleanupCredentials() {\n         return sdxNames;\n     }\n \n-    private void deleteEnvironments(Set<String> environmentNames, EnvironmentClient environmentClient) {\n-        environmentNames.forEach(environmentName -> LOG.info(\"Environment with name: {} will be deleted!\", environmentName));\n+    private List<String> getResourcesFromFile(String resourceNameType, Path filePath) {\n+        List<String> resourceNames = new ArrayList<>();\n+        try (BufferedReader reader = new BufferedReader(new FileReader(filePath.toString()))) {\n+            StringBuilder builder = new StringBuilder();\n+            String line;\n+            while ((line = reader.readLine()) != null) {\n+                builder.append(line);\n+            }\n+            JSONObject jsonObject = new JSONObject(builder.toString());\n+            if (jsonObject.has(resourceNameType)) {\n+                try {\n+                    JSONArray resources = jsonObject.getJSONArray(resourceNameType);\n+                    for (int i = 0; i < resources.length(); i++) {\n+                        String resource = resources.getString(i);\n+                        resourceNames.add(resource);\n+                        LOG.info(\"Get '{}' JSON array '{}' element from resource file with: '{}'.\", resourceNameType, i, resource);\n+                    }\n+                } catch (JSONException e) {\n+                    String resource = jsonObject.getString(resourceNameType);\n+                    resourceNames.add(resource);\n+                    LOG.info(\"Get '{}' JSON object from resource file with: '{}'.\", resourceNameType, resource);\n+                }\n+            } else {\n+                LOG.error(\"Cannot find '{}' in resource file '{}'.\", resourceNameType, filePath.getFileName());\n+            }\n+            return resourceNames;\n+        } catch (JSONException e) {\n+            LOG.warn(\"Cannot get '{}' key, because of: {}\", resourceNameType, e.getMessage(), e);\n+            return resourceNames;\n+        } catch (FileNotFoundException e) {\n+            LOG.warn(\"'{}' file not found, because of: {}\", filePath, e.getMessage(), e);\n+            return resourceNames;\n+        } catch (IOException e) {\n+            LOG.warn(\"Reading '{}' file throws exception: {}\", filePath, e.getMessage(), e);\n+            return resourceNames;\n+        }\n+    }\n+\n+    private void deleteResources(List<String> foundResources, String resourceNameType) {\n+        List<Path> fileList = new ArrayList<>();\n+        List<String> deletedCredentials = new ArrayList<>();\n+        AtomicBoolean e2eCleanupFailed = new AtomicBoolean(false);\n+\n+        try (DirectoryStream<Path> stream = Files.newDirectoryStream(Paths.get(outputDirectory))) {\n+            for (Path path : stream) {\n+                String fileName = path.getFileName().toString();\n+                if (fileName.startsWith(\"resource_names\") && fileName.endsWith(\".json\")) {\n+                    LOG.info(\"Found resource file: '{}' is going to be added to resource files' list\", path.getFileName().toAbsolutePath().normalize());\n+                    fileList.add(path);\n+                }\n+            }\n+        } catch (Exception e) {\n+            LOG.error(\"Cannot find resource file at path: '{}', because of: {}\", Paths.get(outputDirectory).toAbsolutePath().normalize(), e.getMessage(), e);\n+            throw new RuntimeException(String.format(\"Cannot find resource file at path: '%s', because of: %s\",\n+                    Paths.get(outputDirectory).toAbsolutePath().normalize(), e.getMessage()));\n+        }\n+        fileList.forEach(filePath -> {\n+            LOG.info(\"Processing resource file: '{}'\", filePath.getFileName());\n+            List<String> resourcesName = Optional.ofNullable(getResourcesFromFile(resourceNameType, filePath))\n+                    .orElse(List.of(\"\"));", "originalCommit": "98ced8dd754f7762489c7d0601f00ed150a7d19d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MTEwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8820#discussion_r478951108", "bodyText": "Cool, functional, but I guess foundResources.contains(resourceName) will be enough instead of foundResources.stream().anyMatch(resourceName::equals).", "author": "foldik", "createdAt": "2020-08-28T08:40:26Z", "path": "integration-test/src/main/java/com/sequenceiq/it/util/cleanup/CleanupUtil.java", "diffHunk": "@@ -172,21 +191,213 @@ public void cleanupCredentials() {\n         return sdxNames;\n     }\n \n-    private void deleteEnvironments(Set<String> environmentNames, EnvironmentClient environmentClient) {\n-        environmentNames.forEach(environmentName -> LOG.info(\"Environment with name: {} will be deleted!\", environmentName));\n+    private List<String> getResourcesFromFile(String resourceNameType, Path filePath) {\n+        List<String> resourceNames = new ArrayList<>();\n+        try (BufferedReader reader = new BufferedReader(new FileReader(filePath.toString()))) {\n+            StringBuilder builder = new StringBuilder();\n+            String line;\n+            while ((line = reader.readLine()) != null) {\n+                builder.append(line);\n+            }\n+            JSONObject jsonObject = new JSONObject(builder.toString());\n+            if (jsonObject.has(resourceNameType)) {\n+                try {\n+                    JSONArray resources = jsonObject.getJSONArray(resourceNameType);\n+                    for (int i = 0; i < resources.length(); i++) {\n+                        String resource = resources.getString(i);\n+                        resourceNames.add(resource);\n+                        LOG.info(\"Get '{}' JSON array '{}' element from resource file with: '{}'.\", resourceNameType, i, resource);\n+                    }\n+                } catch (JSONException e) {\n+                    String resource = jsonObject.getString(resourceNameType);\n+                    resourceNames.add(resource);\n+                    LOG.info(\"Get '{}' JSON object from resource file with: '{}'.\", resourceNameType, resource);\n+                }\n+            } else {\n+                LOG.error(\"Cannot find '{}' in resource file '{}'.\", resourceNameType, filePath.getFileName());\n+            }\n+            return resourceNames;\n+        } catch (JSONException e) {\n+            LOG.warn(\"Cannot get '{}' key, because of: {}\", resourceNameType, e.getMessage(), e);\n+            return resourceNames;\n+        } catch (FileNotFoundException e) {\n+            LOG.warn(\"'{}' file not found, because of: {}\", filePath, e.getMessage(), e);\n+            return resourceNames;\n+        } catch (IOException e) {\n+            LOG.warn(\"Reading '{}' file throws exception: {}\", filePath, e.getMessage(), e);\n+            return resourceNames;\n+        }\n+    }\n+\n+    private void deleteResources(List<String> foundResources, String resourceNameType) {\n+        List<Path> fileList = new ArrayList<>();\n+        List<String> deletedCredentials = new ArrayList<>();\n+        AtomicBoolean e2eCleanupFailed = new AtomicBoolean(false);\n+\n+        try (DirectoryStream<Path> stream = Files.newDirectoryStream(Paths.get(outputDirectory))) {\n+            for (Path path : stream) {\n+                String fileName = path.getFileName().toString();\n+                if (fileName.startsWith(\"resource_names\") && fileName.endsWith(\".json\")) {\n+                    LOG.info(\"Found resource file: '{}' is going to be added to resource files' list\", path.getFileName().toAbsolutePath().normalize());\n+                    fileList.add(path);\n+                }\n+            }\n+        } catch (Exception e) {\n+            LOG.error(\"Cannot find resource file at path: '{}', because of: {}\", Paths.get(outputDirectory).toAbsolutePath().normalize(), e.getMessage(), e);\n+            throw new RuntimeException(String.format(\"Cannot find resource file at path: '%s', because of: %s\",\n+                    Paths.get(outputDirectory).toAbsolutePath().normalize(), e.getMessage()));\n+        }\n+        fileList.forEach(filePath -> {\n+            LOG.info(\"Processing resource file: '{}'\", filePath.getFileName());\n+            List<String> resourcesName = Optional.ofNullable(getResourcesFromFile(resourceNameType, filePath))\n+                    .orElse(List.of(\"\"));\n+            resourcesName.forEach(resourceName -> {\n+                if (foundResources.stream()", "originalCommit": "98ced8dd754f7762489c7d0601f00ed150a7d19d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzA5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8820#discussion_r478953096", "bodyText": "This is strange. You try to delete credentials, then you immediately say it is failed. Where does this information comes from?", "author": "foldik", "createdAt": "2020-08-28T08:42:19Z", "path": "integration-test/src/main/java/com/sequenceiq/it/util/cleanup/CleanupUtil.java", "diffHunk": "@@ -172,21 +191,213 @@ public void cleanupCredentials() {\n         return sdxNames;\n     }\n \n-    private void deleteEnvironments(Set<String> environmentNames, EnvironmentClient environmentClient) {\n-        environmentNames.forEach(environmentName -> LOG.info(\"Environment with name: {} will be deleted!\", environmentName));\n+    private List<String> getResourcesFromFile(String resourceNameType, Path filePath) {\n+        List<String> resourceNames = new ArrayList<>();\n+        try (BufferedReader reader = new BufferedReader(new FileReader(filePath.toString()))) {\n+            StringBuilder builder = new StringBuilder();\n+            String line;\n+            while ((line = reader.readLine()) != null) {\n+                builder.append(line);\n+            }\n+            JSONObject jsonObject = new JSONObject(builder.toString());\n+            if (jsonObject.has(resourceNameType)) {\n+                try {\n+                    JSONArray resources = jsonObject.getJSONArray(resourceNameType);\n+                    for (int i = 0; i < resources.length(); i++) {\n+                        String resource = resources.getString(i);\n+                        resourceNames.add(resource);\n+                        LOG.info(\"Get '{}' JSON array '{}' element from resource file with: '{}'.\", resourceNameType, i, resource);\n+                    }\n+                } catch (JSONException e) {\n+                    String resource = jsonObject.getString(resourceNameType);\n+                    resourceNames.add(resource);\n+                    LOG.info(\"Get '{}' JSON object from resource file with: '{}'.\", resourceNameType, resource);\n+                }\n+            } else {\n+                LOG.error(\"Cannot find '{}' in resource file '{}'.\", resourceNameType, filePath.getFileName());\n+            }\n+            return resourceNames;\n+        } catch (JSONException e) {\n+            LOG.warn(\"Cannot get '{}' key, because of: {}\", resourceNameType, e.getMessage(), e);\n+            return resourceNames;\n+        } catch (FileNotFoundException e) {\n+            LOG.warn(\"'{}' file not found, because of: {}\", filePath, e.getMessage(), e);\n+            return resourceNames;\n+        } catch (IOException e) {\n+            LOG.warn(\"Reading '{}' file throws exception: {}\", filePath, e.getMessage(), e);\n+            return resourceNames;\n+        }\n+    }\n+\n+    private void deleteResources(List<String> foundResources, String resourceNameType) {\n+        List<Path> fileList = new ArrayList<>();\n+        List<String> deletedCredentials = new ArrayList<>();\n+        AtomicBoolean e2eCleanupFailed = new AtomicBoolean(false);\n+\n+        try (DirectoryStream<Path> stream = Files.newDirectoryStream(Paths.get(outputDirectory))) {\n+            for (Path path : stream) {\n+                String fileName = path.getFileName().toString();\n+                if (fileName.startsWith(\"resource_names\") && fileName.endsWith(\".json\")) {\n+                    LOG.info(\"Found resource file: '{}' is going to be added to resource files' list\", path.getFileName().toAbsolutePath().normalize());\n+                    fileList.add(path);\n+                }\n+            }\n+        } catch (Exception e) {\n+            LOG.error(\"Cannot find resource file at path: '{}', because of: {}\", Paths.get(outputDirectory).toAbsolutePath().normalize(), e.getMessage(), e);\n+            throw new RuntimeException(String.format(\"Cannot find resource file at path: '%s', because of: %s\",\n+                    Paths.get(outputDirectory).toAbsolutePath().normalize(), e.getMessage()));\n+        }\n+        fileList.forEach(filePath -> {\n+            LOG.info(\"Processing resource file: '{}'\", filePath.getFileName());\n+            List<String> resourcesName = Optional.ofNullable(getResourcesFromFile(resourceNameType, filePath))\n+                    .orElse(List.of(\"\"));\n+            resourcesName.forEach(resourceName -> {\n+                if (foundResources.stream()\n+                        .anyMatch(resourceName::equals)) {\n+                    LOG.info(\"{}:{} will be deleted!\", resourceNameType, foundResources.stream()\n+                            .filter(resourceName::equals).findAny().orElse(null));\n+                    switch (resourceNameType) {\n+                        case \"distroxName\":\n+                        case \"stackName\":\n+                            deleteDistrox(getCloudbreakClient(), resourceName);\n+                            break;\n+                        case \"sdxName\":\n+                            deleteSdx(getSdxClient(), resourceName);\n+                            break;\n+                        case \"credentialName\":\n+                            deleteCredential(getEnvironmentClient(), resourceName);\n+                            e2eCleanupFailed.set(true);", "originalCommit": "98ced8dd754f7762489c7d0601f00ed150a7d19d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk2MzU4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8820#discussion_r478963587", "bodyText": "Answer in the description:\n\nIf the Cleanup finds one or more credential(s) present from the resource JSON at the given tenant, Cleanup exits with error:\nERROR c.s.it.util.cleanup.CleanupUtil [nolabel] - End To End cleanup have been failed, because of credential(s) '[aws-test-1b8a1afafded4daca3e1cc5e9533f37, yarn-test-54daadca706347818431edc9c6b560]' found left behind! after all the found resources have been deleted/terminated.\n\nThis was the requirement:\n\n\"If Cleanup job should terminate / delete any resource after test, that should mean the E2E cleanup was not success. So we should investigate and fix the issue.", "author": "aszegedi", "createdAt": "2020-08-28T08:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTExMDc0NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8820#discussion_r479110745", "bodyText": "I see. What about other resources? Don't we expect them to be deleted as well?", "author": "foldik", "createdAt": "2020-08-28T10:44:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUyNTQ0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8820#discussion_r479525444", "bodyText": "Credential(s) is(are) the final in the sequence of deleting resources. So we can rest assured if we need to delete any credential from the created ones, that means the related E2E job cleanup was not successful.\nWe can sure the final deletable resource from the list is the credential. If we need to delete any listed credential from the resources Json file, we need to investigate the related E2E build:\n\nWhat was happened at the Cleanup phase? Is this started at the end of the test execution?\nWhy the E2E cleanup cannot fulfil its goal?\n\nIn this situation the amount and type (distrox, sdx, environment, credential) of the remained resources are not important for the Cleanup App. The fact: we found deletable resource(s) is the vital information and need to highlight for reviewers.", "author": "aszegedi", "createdAt": "2020-08-28T20:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzA5Ng=="}], "type": "inlineReview"}, {"oid": "871f7719c5e8658f0231376e6a9dc45f3f1e2f33", "url": "https://github.com/hortonworks/cloudbreak/commit/871f7719c5e8658f0231376e6a9dc45f3f1e2f33", "message": "CB-8484 Replace TestContext to MockedTestContext for integration tests", "committedDate": "2020-08-29T09:22:45Z", "type": "forcePushed"}, {"oid": "4abd0d15cf6bea5fcc231ccfff8c27a1d1ccd350", "url": "https://github.com/hortonworks/cloudbreak/commit/4abd0d15cf6bea5fcc231ccfff8c27a1d1ccd350", "message": "CB-7876 Fail API Cleanup Jenkins build in case of left resources", "committedDate": "2020-09-02T17:14:41Z", "type": "commit"}, {"oid": "5680ecb833b09712daf57baf20042068f76ce7f7", "url": "https://github.com/hortonworks/cloudbreak/commit/5680ecb833b09712daf57baf20042068f76ce7f7", "message": "CB-8484 Replace TestContext to MockedTestContext for integration tests", "committedDate": "2020-09-02T17:14:41Z", "type": "commit"}, {"oid": "5680ecb833b09712daf57baf20042068f76ce7f7", "url": "https://github.com/hortonworks/cloudbreak/commit/5680ecb833b09712daf57baf20042068f76ce7f7", "message": "CB-8484 Replace TestContext to MockedTestContext for integration tests", "committedDate": "2020-09-02T17:14:41Z", "type": "forcePushed"}]}