{"pr_number": 7610, "pr_title": "CB-6113 Sync in Environment modul", "pr_createdAt": "2020-03-18T14:19:26Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7610", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NzQzNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394887437", "bodyText": "I guess the view is enough right ?", "author": "doktoric", "createdAt": "2020-03-19T09:21:13Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/repository/EnvironmentRepository.java", "diffHunk": "@@ -73,4 +73,8 @@\n             + \"WHERE pe.id = :parentEnvironmentId AND e.accountId = :accountId AND e.archived = false\")\n     List<Environment> findAllByAccountIdAndParentEnvIdAndArchivedIsFalse(@Param(\"accountId\") String accountId,\n             @Param(\"parentEnvironmentId\") Long parentEnvironmentId);\n+\n+    @CheckPermission(action = ResourceAction.READ)\n+    @Query(\"SELECT e FROM Environment e WHERE e.archived = false and e.status in (:statuses)\")\n+    List<Environment> findAllRunningAndStatusIn(@Param(\"statuses\") Collection<EnvironmentStatus> statuses);", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwMjk1Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394902952", "bodyText": "you are right, I'm going to replace", "author": "topolyai5", "createdAt": "2020-03-19T09:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NzQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNzM0NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394907345", "bodyText": "No, I cannot replace. It is run only once at start only. This code is used in another place so I should convert there the Environment to EnvironmentView. But I can optimize the fetch part like: e.id, e.name, e.resourceCrn instead of the e", "author": "topolyai5", "createdAt": "2020-03-19T09:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NzQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg5MDE3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394890172", "bodyText": "you could move this before the if along with Line 76", "author": "bergerdenes", "createdAt": "2020-03-19T09:25:57Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/service/EnvironmentDeletionService.java", "diffHunk": "@@ -65,8 +70,10 @@ public Environment delete(Environment environment, String userCrn, boolean force\n         validateDeletion(environment);\n         LOGGER.debug(\"Deleting environment with name: {}\", environment.getName());\n         if (forced) {\n+            environmentJobService.unschedule(environment);", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg5MTQxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394891410", "bodyText": "typo: FreeIPA", "author": "bergerdenes", "createdAt": "2020-03-19T09:28:03Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/sync/EnvironmentSyncServiceTest.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package com.sequenceiq.environment.environment.sync;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import com.sequenceiq.environment.environment.EnvironmentStatus;\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.environment.environment.service.freeipa.FreeIpaService;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.Status;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.describe.DescribeFreeIpaResponse;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class EnvironmentSyncServiceTest {\n+\n+    private final FreeIpaService freeIpaService = mock(FreeIpaService.class);\n+\n+    private final EnvironmentSyncService underTest = new EnvironmentSyncService(freeIpaService);\n+\n+    @ParameterizedTest(name = \"{0}\")\n+    @MethodSource(\"getStatusByFreeipaParams\")\n+    void testGetStatusByFreeipa(String testName, DescribeFreeIpaResponse freeIpaResponse, EnvironmentStatus expected) {\n+        Environment environment = new Environment();\n+        environment.setResourceCrn(\"crn\");\n+\n+        when(freeIpaService.describe(environment.getResourceCrn())).thenReturn(Optional.of(freeIpaResponse));\n+\n+        EnvironmentStatus actual = underTest.getStatusByFreeipa(environment);\n+\n+        Assertions.assertEquals(expected, actual);\n+    }\n+\n+    @Test\n+    void testGetStatusByFreeipaWhenFreeipaAttachedButNotFound() {\n+        Environment environment = new Environment();\n+        environment.setResourceCrn(\"crn\");\n+        environment.setCreateFreeIpa(true);\n+\n+        when(freeIpaService.describe(environment.getResourceCrn())).thenReturn(Optional.empty());\n+\n+        EnvironmentStatus actual = underTest.getStatusByFreeipa(environment);\n+        Assertions.assertEquals(EnvironmentStatus.FREEIPA_DELETED_ON_PROVIDER_SIDE, actual);\n+    }\n+\n+    @Test\n+    void testGetStatusByFreeipaWhenFreeipaNotAttached() {\n+        Environment environment = new Environment();\n+        environment.setResourceCrn(\"crn\");\n+        environment.setCreateFreeIpa(false);\n+\n+        when(freeIpaService.describe(environment.getResourceCrn())).thenReturn(Optional.empty());\n+\n+        EnvironmentStatus actual = underTest.getStatusByFreeipa(environment);\n+        Assertions.assertEquals(EnvironmentStatus.AVAILABLE, actual);\n+    }\n+\n+    // @formatter:off\n+    // CHECKSTYLE:OFF\n+    static Object[][] getStatusByFreeipaParams() {\n+        return new Object[][]{\n+                // testCaseName                     freeipa status                                          expected env status\n+                {\"Freeiap is available\",            getFreeipaResponse(Status.AVAILABLE),                   EnvironmentStatus.AVAILABLE},", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwMjI3OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394902279", "bodyText": "should be INFO (or WARN?)", "author": "bergerdenes", "createdAt": "2020-03-19T09:46:42Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/sync/EnvironmentStatusCheckerJob.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.sequenceiq.environment.environment.sync;\n+\n+import java.util.Optional;\n+\n+import org.quartz.JobExecutionContext;\n+import org.quartz.JobExecutionException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.event.ResourceEvent;\n+import com.sequenceiq.cloudbreak.logger.MDCBuilder;\n+import com.sequenceiq.cloudbreak.logger.MdcContext;\n+import com.sequenceiq.environment.environment.EnvironmentStatus;\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.environment.environment.service.EnvironmentService;\n+import com.sequenceiq.environment.environment.service.EnvironmentStatusUpdateService;\n+import com.sequenceiq.flow.core.FlowLogService;\n+import com.sequenceiq.statuschecker.job.StatusCheckerJob;\n+\n+@Component\n+public class EnvironmentStatusCheckerJob extends StatusCheckerJob {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentStatusCheckerJob.class);\n+\n+    private final EnvironmentService environmentService;\n+\n+    private final FlowLogService flowLogService;\n+\n+    private final EnvironmentSyncService environmentSyncService;\n+\n+    private final EnvironmentStatusUpdateService environmentStatusUpdateService;\n+\n+    private final EnvironmentJobService environmentJobService;\n+\n+    public EnvironmentStatusCheckerJob(EnvironmentService environmentService, FlowLogService flowLogService,\n+            EnvironmentSyncService environmentSyncService, EnvironmentStatusUpdateService environmentStatusUpdateService,\n+            EnvironmentJobService environmentJobService) {\n+        this.environmentService = environmentService;\n+        this.flowLogService = flowLogService;\n+        this.environmentSyncService = environmentSyncService;\n+        this.environmentStatusUpdateService = environmentStatusUpdateService;\n+        this.environmentJobService = environmentJobService;\n+    }\n+\n+    @Override\n+    protected void executeInternal(JobExecutionContext context) throws JobExecutionException {\n+        Long envId = getEnvId();\n+        Optional<Environment> environmentOpt = environmentService.findEnvironmentById(envId);\n+        if (environmentOpt.isPresent()) {\n+            Environment environment = environmentOpt.get();\n+            prepareMdcContext(environment);\n+            if (flowLogService.isOtherFlowRunning(envId)) {\n+                LOGGER.debug(\"EnvironmentStatusCheckerJob cannot run, because flow is running for environment: {}\", environment.getName());", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxMjkwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394912904", "bodyText": "info is ok me, but no warn", "author": "topolyai5", "createdAt": "2020-03-19T10:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwMjI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNDgzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394904835", "bodyText": "LOGGER.info signature is wrong, if you want to pass a Throwable then the first parameter is a String so you must format it.", "author": "bergerdenes", "createdAt": "2020-03-19T09:51:07Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/sync/EnvironmentStatusCheckerJob.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.sequenceiq.environment.environment.sync;\n+\n+import java.util.Optional;\n+\n+import org.quartz.JobExecutionContext;\n+import org.quartz.JobExecutionException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.event.ResourceEvent;\n+import com.sequenceiq.cloudbreak.logger.MDCBuilder;\n+import com.sequenceiq.cloudbreak.logger.MdcContext;\n+import com.sequenceiq.environment.environment.EnvironmentStatus;\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.environment.environment.service.EnvironmentService;\n+import com.sequenceiq.environment.environment.service.EnvironmentStatusUpdateService;\n+import com.sequenceiq.flow.core.FlowLogService;\n+import com.sequenceiq.statuschecker.job.StatusCheckerJob;\n+\n+@Component\n+public class EnvironmentStatusCheckerJob extends StatusCheckerJob {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentStatusCheckerJob.class);\n+\n+    private final EnvironmentService environmentService;\n+\n+    private final FlowLogService flowLogService;\n+\n+    private final EnvironmentSyncService environmentSyncService;\n+\n+    private final EnvironmentStatusUpdateService environmentStatusUpdateService;\n+\n+    private final EnvironmentJobService environmentJobService;\n+\n+    public EnvironmentStatusCheckerJob(EnvironmentService environmentService, FlowLogService flowLogService,\n+            EnvironmentSyncService environmentSyncService, EnvironmentStatusUpdateService environmentStatusUpdateService,\n+            EnvironmentJobService environmentJobService) {\n+        this.environmentService = environmentService;\n+        this.flowLogService = flowLogService;\n+        this.environmentSyncService = environmentSyncService;\n+        this.environmentStatusUpdateService = environmentStatusUpdateService;\n+        this.environmentJobService = environmentJobService;\n+    }\n+\n+    @Override\n+    protected void executeInternal(JobExecutionContext context) throws JobExecutionException {\n+        Long envId = getEnvId();\n+        Optional<Environment> environmentOpt = environmentService.findEnvironmentById(envId);\n+        if (environmentOpt.isPresent()) {\n+            Environment environment = environmentOpt.get();\n+            prepareMdcContext(environment);\n+            if (flowLogService.isOtherFlowRunning(envId)) {\n+                LOGGER.debug(\"EnvironmentStatusCheckerJob cannot run, because flow is running for environment: {}\", environment.getName());\n+            } else {\n+                syncAnEnv(environment);\n+            }\n+            MDCBuilder.cleanupMdc();\n+        } else {\n+            environmentJobService.unschedule(envId);\n+            LOGGER.warn(\"EnvironmentStatusCheckerJob cannot run, because environment is not found with id: {}. This env is unscheduled now\", envId);\n+        }\n+    }\n+\n+    @VisibleForTesting\n+    void syncAnEnv(Environment environment) {\n+        try {\n+            ThreadBasedUserCrnProvider.doAs(environment.getCreator(), () -> {\n+                EnvironmentStatus status = environmentSyncService.getStatusByFreeipa(environment);\n+                if (environment.getStatus() != status) {\n+                    if (!flowLogService.isOtherFlowRunning(environment.getId())) {\n+                        environmentStatusUpdateService.updateEnvironmentStatusAndNotify(environment, status, ResourceEvent.ENVIRONMENT_SYNC_FINISHED);\n+                    } else {\n+                        LOGGER.info(\"EnvironmentStatusCheckerJob wants to update the status but it's ignored because a flow started on: {}\",\n+                                environment.getName());\n+                    }\n+                } else {\n+                    LOGGER.debug(\"Environment status is the same ({}), the update is skipped\", status);\n+                }\n+            });\n+        } catch (Exception e) {\n+            LOGGER.info(\"Environment sync is failed for {}, error: {}\", environment.getName(), e.getMessage(), e);", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkzNjM1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394936353", "bodyText": "I've tried and working fine for me", "author": "topolyai5", "createdAt": "2020-03-19T10:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNDgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNTc1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394905756", "bodyText": "switch?", "author": "bergerdenes", "createdAt": "2020-03-19T09:52:38Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/sync/EnvironmentSyncService.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.environment.environment.sync;\n+\n+import java.util.Optional;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.environment.environment.EnvironmentStatus;\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.environment.environment.service.freeipa.FreeIpaService;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.Status;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.describe.DescribeFreeIpaResponse;\n+\n+@Component\n+public class EnvironmentSyncService {\n+\n+    private final FreeIpaService freeIpaService;\n+\n+    public EnvironmentSyncService(FreeIpaService freeIpaService) {\n+        this.freeIpaService = freeIpaService;\n+    }\n+\n+    public EnvironmentStatus getStatusByFreeipa(Environment environment) {\n+        Optional<DescribeFreeIpaResponse> freeIpaResponseOpt = freeIpaService.describe(environment.getResourceCrn());\n+        if (freeIpaResponseOpt.isPresent()) {\n+            DescribeFreeIpaResponse freeIpaResponse = freeIpaResponseOpt.get();\n+            if (freeIpaResponse.getStatus() == Status.STOPPED) {\n+                return EnvironmentStatus.ENV_STOPPED;\n+            } else if (freeIpaResponse.getStatus() == Status.DELETED_ON_PROVIDER_SIDE) {\n+                return EnvironmentStatus.FREEIPA_DELETED_ON_PROVIDER_SIDE;\n+            } else if (freeIpaResponse.getStatus() == Status.STOP_FAILED) {\n+                return EnvironmentStatus.STOP_FREEIPA_FAILED;\n+            } else if (freeIpaResponse.getStatus() == Status.START_FAILED) {\n+                return EnvironmentStatus.START_FREEIPA_FAILED;\n+            } else if (freeIpaResponse.getStatus() == Status.START_IN_PROGRESS) {\n+                return EnvironmentStatus.START_FREEIPA_STARTED;\n+            } else if (freeIpaResponse.getStatus() == Status.STOP_IN_PROGRESS) {\n+                return EnvironmentStatus.STOP_FREEIPA_STARTED;\n+            }", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxNjg3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394916872", "bodyText": "I do not like switch because of the checkstyle. Everytime crying about \"cyclomaticComplexity\", but I cannot reduce the case number. But I make a try with the switch", "author": "topolyai5", "createdAt": "2020-03-19T10:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNTc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNzcwNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394907706", "bodyText": "call this class' unschedule(Long) and move logging there", "author": "bergerdenes", "createdAt": "2020-03-19T09:55:41Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/sync/EnvironmentJobService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.sequenceiq.environment.environment.sync;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.statuschecker.service.JobService;\n+\n+@Component\n+public class EnvironmentJobService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentJobService.class);\n+\n+    @Inject\n+    private AutoSyncConfig autoSyncConfig;\n+\n+    @Inject\n+    private JobService jobService;\n+\n+    public void deleteAll() {\n+        jobService.deleteAll();\n+    }\n+\n+    public void schedule(Environment environment) {\n+        if (autoSyncConfig.isEnabled()) {\n+            jobService.schedule(new EnvironmentJobAdapter(environment));\n+            LOGGER.info(\"{} is scheduled for auto sync\", environment.getName());\n+        }\n+    }\n+\n+    public void unschedule(Long envId) {\n+        jobService.unschedule(envId.toString());\n+    }\n+\n+    public void unschedule(Environment environment) {\n+        jobService.unschedule(environment.getId().toString());", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxNTY4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394915686", "bodyText": "I cannot log there, because here the log message is writing the name. The unschedule(long) will be called here instead of jobService", "author": "topolyai5", "createdAt": "2020-03-19T10:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNzcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwODY3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394908670", "bodyText": "please use constructor injection", "author": "bergerdenes", "createdAt": "2020-03-19T09:57:23Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/sync/EnvironmentJobService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.sequenceiq.environment.environment.sync;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.statuschecker.service.JobService;\n+\n+@Component\n+public class EnvironmentJobService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentJobService.class);\n+\n+    @Inject", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwODgxMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r394908812", "bodyText": "please use constructor injection", "author": "bergerdenes", "createdAt": "2020-03-19T09:57:37Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/sync/EnvironmentJobInitializer.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.sequenceiq.environment.environment.sync;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.environment.environment.service.EnvironmentService;\n+import com.sequenceiq.statuschecker.model.JobInitializer;\n+\n+@Component\n+public class EnvironmentJobInitializer implements JobInitializer {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentJobInitializer.class);\n+\n+    @Inject", "originalCommit": "ec4a1b2a2ec4e5c1115e37e993406259cb5bfb9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6736a1bd80cd7b5f16073fc6b91ed5cd803a26da", "url": "https://github.com/hortonworks/cloudbreak/commit/6736a1bd80cd7b5f16073fc6b91ed5cd803a26da", "message": "CB-6113 Sync in Environment modul", "committedDate": "2020-03-19T13:24:12Z", "type": "forcePushed"}, {"oid": "2bf77b773f36f887406cb69ef2eaba281d1ec80f", "url": "https://github.com/hortonworks/cloudbreak/commit/2bf77b773f36f887406cb69ef2eaba281d1ec80f", "message": "CB-6113 Sync in Environment modul", "committedDate": "2020-03-19T13:28:26Z", "type": "commit"}, {"oid": "2bf77b773f36f887406cb69ef2eaba281d1ec80f", "url": "https://github.com/hortonworks/cloudbreak/commit/2bf77b773f36f887406cb69ef2eaba281d1ec80f", "message": "CB-6113 Sync in Environment modul", "committedDate": "2020-03-19T13:28:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyNjI1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7610#discussion_r395026250", "bodyText": "\ud83d\udc4d", "author": "bergerdenes", "createdAt": "2020-03-19T13:32:10Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/service/EnvironmentDeletionService.java", "diffHunk": "@@ -64,6 +69,7 @@ public Environment delete(Environment environment, String userCrn, boolean force\n         MDCBuilder.buildMdcContext(environment);\n         validateDeletion(environment);\n         LOGGER.debug(\"Deleting environment with name: {}\", environment.getName());\n+        environmentJobService.unschedule(environment);", "originalCommit": "2bf77b773f36f887406cb69ef2eaba281d1ec80f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78dd2c25f14b4d7c28ac390454ce951bcf0bc0ef", "url": "https://github.com/hortonworks/cloudbreak/commit/78dd2c25f14b4d7c28ac390454ce951bcf0bc0ef", "message": "CB-6113 disable environment sync in IT", "committedDate": "2020-03-20T10:46:57Z", "type": "commit"}]}