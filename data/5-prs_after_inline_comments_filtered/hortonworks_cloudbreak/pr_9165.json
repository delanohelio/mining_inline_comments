{"pr_number": 9165, "pr_title": "CB-8923 Introduce a custom JUnit XML Report Listener", "pr_createdAt": "2020-10-07T21:29:43Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9165", "timeline": [{"oid": "d656bb71165734ab703a500372467544e0e338a6", "url": "https://github.com/hortonworks/cloudbreak/commit/d656bb71165734ab703a500372467544e0e338a6", "message": "CB-8923 Introduce a custom JUnit XML Report Listener", "committedDate": "2020-10-08T08:30:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1NTMxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r501555319", "bodyText": "What does status 2 mean? Why 2 exactly?", "author": "lnardai", "createdAt": "2020-10-08T08:54:33Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/context/TestContext.java", "diffHunk": "@@ -1133,6 +1139,29 @@ public void handleExceptionsDuringTest(TestErrorLog testErrorLog) {\n             String errorMessage = errorLogMessageProvider.getMessage(exceptionMap, clues);\n             testErrorLog.report(LOGGER, errorMessage);\n \n+            ITestResult testResult = Reporter.getCurrentTestResult();\n+            Throwable testFailException = errorLogMessageProvider.getException(exceptionMap);\n+\n+            if (testFailException != null) {\n+                testResult.setThrowable(testFailException);\n+                testResult.setTestName(getTestMethodName().get());\n+                testResult.setStatus(2);", "originalCommit": "d656bb71165734ab703a500372467544e0e338a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU3Mjc2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r501572760", "bodyText": "This means ITestResult.FAILURE\nHere we have to set the correct test results (status, throwable, type) for test, because of our TestContext is not ITestContext indeed. So our project generates all the errors and related messages as Reporter Output.", "author": "aszegedi", "createdAt": "2020-10-08T09:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1NTMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5NjU3NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r501596574", "bodyText": "So, can we use the Enum from there, or not a variable that is more descriptive?", "author": "lnardai", "createdAt": "2020-10-08T09:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1NTMxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5NzcxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r501597714", "bodyText": "Just asking, would this work correctly with parallel runs since it's static?", "author": "lnardai", "createdAt": "2020-10-08T10:01:06Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/listener/ReportListener.java", "diffHunk": "@@ -24,23 +23,31 @@\n \n     public static final String MEASUREMENTS = \"measurements\";\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(ReportListener.class);\n-\n     @Override\n     public void onTestFailure(ITestResult tr) {\n-        super.onTestFailure(tr);\n         logUrl(tr);\n         logMeasurements(tr);\n         log(tr);\n+        Reporter.setCurrentTestResult(tr);\n+        super.onTestFailure(tr);\n     }\n \n     @Override\n     public void onTestSuccess(ITestResult tr) {\n         logUrl(tr);\n         logMeasurements(tr);\n+        Reporter.setCurrentTestResult(tr);", "originalCommit": "d656bb71165734ab703a500372467544e0e338a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5ODQzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r501598436", "bodyText": "Just checked in the code, it uses ThreadLocal internally.", "author": "lnardai", "createdAt": "2020-10-08T10:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwNTg5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r501605893", "bodyText": "Each test method and its respective before and after method is executed in a different thread. This is identified by the ID of the thread that is printed on the console.\nYou can find some additional details, for example: TestNG parallel execution of tests, classes and suites", "author": "aszegedi", "createdAt": "2020-10-08T10:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyNzQ0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r502027449", "bodyText": "You were scratcing the ugly truth: After I've tested this out with several threads, I had to realised the original solution wasn't able to get the correct throwable to the given test case. So I've applied the same prefixing as we already have for searchUrl.\nSo finally not the Reporter caused the issue as rather than custom.results.xml template.", "author": "aszegedi", "createdAt": "2020-10-08T21:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5NzcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNDcyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r502034720", "bodyText": "Here is the test upload for Quanta: https://quanta.infra.cloudera.com/?#/runDetails?gtn=6369877", "author": "aszegedi", "createdAt": "2020-10-08T21:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU5NzcxNA=="}], "type": "inlineReview"}, {"oid": "5f09fb397572cbea28c0f2d6c2fb1d0fc7232ba4", "url": "https://github.com/hortonworks/cloudbreak/commit/5f09fb397572cbea28c0f2d6c2fb1d0fc7232ba4", "message": "CB-8923 Introduce a custom JUnit XML Report Listener", "committedDate": "2020-10-08T12:16:58Z", "type": "forcePushed"}, {"oid": "eae0d4f62fb6295abf6aa5fb8442944240bc6ff2", "url": "https://github.com/hortonworks/cloudbreak/commit/eae0d4f62fb6295abf6aa5fb8442944240bc6ff2", "message": "CB-8923 Introduce a custom JUnit XML Report Listener", "committedDate": "2020-10-08T12:17:34Z", "type": "forcePushed"}, {"oid": "427c6a621e221df3ee5878fcb68243a1190af44e", "url": "https://github.com/hortonworks/cloudbreak/commit/427c6a621e221df3ee5878fcb68243a1190af44e", "message": "CB-8923 Introduce a custom JUnit XML Report Listener", "committedDate": "2020-10-08T12:31:05Z", "type": "forcePushed"}, {"oid": "947cf142473c693ae5156a84645271e2d73fcd21", "url": "https://github.com/hortonworks/cloudbreak/commit/947cf142473c693ae5156a84645271e2d73fcd21", "message": "CB-8923 Introduce a custom JUnit XML Report Listener", "committedDate": "2020-10-08T21:18:53Z", "type": "forcePushed"}, {"oid": "fb8d958c45f194fa0e5f4a129c3d21dbc310360b", "url": "https://github.com/hortonworks/cloudbreak/commit/fb8d958c45f194fa0e5f4a129c3d21dbc310360b", "message": "CB-8923 Introduce a custom JUnit XML Report Listener", "committedDate": "2020-10-08T21:19:30Z", "type": "commit"}, {"oid": "fb8d958c45f194fa0e5f4a129c3d21dbc310360b", "url": "https://github.com/hortonworks/cloudbreak/commit/fb8d958c45f194fa0e5f4a129c3d21dbc310360b", "message": "CB-8923 Introduce a custom JUnit XML Report Listener", "committedDate": "2020-10-08T21:19:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyMDU2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9165#discussion_r502420566", "bodyText": "This will only show the first exception that we encounter in the test, is that correct?\nOr we are specifically looking for this type of exceptions among them?\nIf so this method should be rather, findFirstTestFailException.", "author": "lnardai", "createdAt": "2020-10-09T13:18:08Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/ErrorLogMessageProvider.java", "diffHunk": "@@ -22,6 +23,13 @@\n \n     private static final ObjectWriter OBJECT_WRITER = new ObjectMapper().writerWithDefaultPrettyPrinter();\n \n+    public Throwable getException(Map<String, Exception> exceptionsDuringTest) {\n+        return exceptionsDuringTest.values().stream()\n+                .filter(exception -> exception.getCause() instanceof TestFailException)", "originalCommit": "fb8d958c45f194fa0e5f4a129c3d21dbc310360b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}