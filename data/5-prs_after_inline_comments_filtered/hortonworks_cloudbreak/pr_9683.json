{"pr_number": 9683, "pr_title": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services.", "pr_createdAt": "2020-12-23T21:18:25Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9683", "timeline": [{"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a", "url": "https://github.com/hortonworks/cloudbreak/commit/c82f9d70907f91211c364777acc39e8dd1cf154a", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services.", "committedDate": "2020-12-23T21:43:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM5NzIwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551397209", "bodyText": "nit: This import is int the wrong place.", "author": "hreeve-cloudera", "createdAt": "2021-01-04T15:47:53Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -28,6 +28,7 @@\n import javax.annotation.Nonnull;\n import javax.inject.Inject;\n \n+import com.sequenceiq.common.api.type.LoadBalancerType;", "originalCommit": "c82f9d70907f91211c364777acc39e8dd1cf154a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM5ODczMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551398731", "bodyText": "This orElse is internal within the filter method, correct? It's hard to parse as-is, because it's indented to the same level as the calls that are directly on stream(), so it seems like it should also be directly on stream(). Could you either change the indentation, or break this call out into two lines so it's easier to read?", "author": "hreeve-cloudera", "createdAt": "2021-01-04T15:50:10Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -629,7 +630,19 @@ private void addGatewayUserFacingCertAndFqdn(GatewayConfig gatewayConfig, Cluste\n             gateway.put(\"userfacingkey\", cluster.getStack().getSecurityConfig().getUserFacingKey());\n             gateway.put(\"userfacingcert\", cluster.getStack().getSecurityConfig().getUserFacingCert());\n         }\n-        String fqdn = cluster.getFqdn();\n+\n+        String fqdn = null;\n+        if (cluster.getStack().getLoadBalancers() != null && cluster.getStack().getLoadBalancers().size() > 0) {\n+            fqdn = (cluster.getStack().getLoadBalancers().stream()\n+                    .filter(lb -> lb.getType() == LoadBalancerType.PUBLIC).findAny()\n+                    .orElse(cluster.getStack().getLoadBalancers().iterator().next()))", "originalCommit": "c82f9d70907f91211c364777acc39e8dd1cf154a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ2Nzk2NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551467964", "bodyText": "LoadBalanceryType.PUBLIC.equals(lb.getType())", "author": "frozenwizard", "createdAt": "2021-01-04T17:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM5ODczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM5OTc5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551399796", "bodyText": "We should make this check isNotEmpty, so we don't set the fqdn to an empty string.", "author": "hreeve-cloudera", "createdAt": "2021-01-04T15:51:49Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -629,7 +630,19 @@ private void addGatewayUserFacingCertAndFqdn(GatewayConfig gatewayConfig, Cluste\n             gateway.put(\"userfacingkey\", cluster.getStack().getSecurityConfig().getUserFacingKey());\n             gateway.put(\"userfacingcert\", cluster.getStack().getSecurityConfig().getUserFacingCert());\n         }\n-        String fqdn = cluster.getFqdn();\n+\n+        String fqdn = null;\n+        if (cluster.getStack().getLoadBalancers() != null && cluster.getStack().getLoadBalancers().size() > 0) {\n+            fqdn = (cluster.getStack().getLoadBalancers().stream()\n+                    .filter(lb -> lb.getType() == LoadBalancerType.PUBLIC).findAny()\n+                    .orElse(cluster.getStack().getLoadBalancers().iterator().next()))\n+                    .getFqdn();\n+        }\n+\n+        if (fqdn == null) {", "originalCommit": "c82f9d70907f91211c364777acc39e8dd1cf154a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwMTQwNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551401407", "bodyText": "To be safe, we should make sure this logic isn't triggered if the DNS for the load balancer couldn't be registered. (See the else statement directly above this).", "author": "hreeve-cloudera", "createdAt": "2021-01-04T15:54:26Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/publicendpoint/GatewayPublicEndpointManagementService.java", "diffHunk": "@@ -132,6 +132,9 @@ public void updateDnsEntryForLoadBalancers(Stack stack) {\n                     LOGGER.warn(\"Could not find IP or cloud DNS info for load balancer with endpoint {} .\" +\n                         \"DNS registration will be skipped.\", loadBalancer.getEndpoint());\n                 }\n+\n+                loadBalancer.setFqdn(getDomainNameProvider().getFullyQualifiedEndpointName(\n+                        endpoint.get(), environment.getName(), getWorkloadSubdomain(userCrn)));", "originalCommit": "c82f9d70907f91211c364777acc39e8dd1cf154a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwMTU3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551401576", "bodyText": "nit: This import is in the wrong place.", "author": "hreeve-cloudera", "createdAt": "2021-01-04T15:54:40Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/util/StackUtil.java", "diffHunk": "@@ -11,6 +11,7 @@\n \n import javax.inject.Inject;\n \n+import com.sequenceiq.common.api.type.LoadBalancerType;", "originalCommit": "c82f9d70907f91211c364777acc39e8dd1cf154a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwMjkwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551402903", "bodyText": "Same note about the indentation here. Since this code looks the same as the other code block, it might be worth pulling it out into a common method. Maybe putting it directly in Stack, so you can just call something like stack.getLoadBalancerUserFacingFQDN().", "author": "hreeve-cloudera", "createdAt": "2021-01-04T15:56:43Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/util/StackUtil.java", "diffHunk": "@@ -177,6 +178,13 @@ private String extractClusterManagerIp(long stackId) {\n     }\n \n     public String extractClusterManagerAddress(Stack stack) {\n+        if (stack.getLoadBalancers() != null && stack.getLoadBalancers().size() != 0) {\n+            return (stack.getLoadBalancers().stream()\n+                    .filter(lb -> lb.getType() == LoadBalancerType.PUBLIC).findAny()\n+                    .orElse(stack.getLoadBalancers().iterator().next()))", "originalCommit": "c82f9d70907f91211c364777acc39e8dd1cf154a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e18a4ae25eb87b57f9a61c55be608821d962d894", "url": "https://github.com/hortonworks/cloudbreak/commit/e18a4ae25eb87b57f9a61c55be608821d962d894", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services.", "committedDate": "2021-01-04T18:27:13Z", "type": "forcePushed"}, {"oid": "1a127096ae2637165f6969070eff37da2a353c08", "url": "https://github.com/hortonworks/cloudbreak/commit/1a127096ae2637165f6969070eff37da2a353c08", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services.", "committedDate": "2021-01-04T18:28:40Z", "type": "forcePushed"}, {"oid": "d3157258410ac9bddb0b080ae787a4eff14a8d38", "url": "https://github.com/hortonworks/cloudbreak/commit/d3157258410ac9bddb0b080ae787a4eff14a8d38", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services.", "committedDate": "2021-01-04T18:52:46Z", "type": "forcePushed"}, {"oid": "7ba987fa80cb312a435f05b5bf041effd97b8579", "url": "https://github.com/hortonworks/cloudbreak/commit/7ba987fa80cb312a435f05b5bf041effd97b8579", "message": "Saving LB to database after setting FQDN, and loading directly from database instead of indirectly through Stack.", "committedDate": "2021-01-06T02:31:24Z", "type": "forcePushed"}, {"oid": "ae86e7669905e482306296cfa4fa4ccf8303406a", "url": "https://github.com/hortonworks/cloudbreak/commit/ae86e7669905e482306296cfa4fa4ccf8303406a", "message": "Saving LB to database after setting FQDN, and loading directly from database instead of indirectly through Stack.", "committedDate": "2021-01-07T00:50:36Z", "type": "forcePushed"}, {"oid": "b526b793ba56b48f33638a815a0746b0ec82f7eb", "url": "https://github.com/hortonworks/cloudbreak/commit/b526b793ba56b48f33638a815a0746b0ec82f7eb", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services.", "committedDate": "2021-01-07T16:18:37Z", "type": "commit"}, {"oid": "b526b793ba56b48f33638a815a0746b0ec82f7eb", "url": "https://github.com/hortonworks/cloudbreak/commit/b526b793ba56b48f33638a815a0746b0ec82f7eb", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services.", "committedDate": "2021-01-07T16:18:37Z", "type": "forcePushed"}]}