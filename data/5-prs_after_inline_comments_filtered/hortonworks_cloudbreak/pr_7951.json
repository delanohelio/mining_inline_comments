{"pr_number": 7951, "pr_title": "CB-4377: Use cluster proxy HA for FreeIPA connections", "pr_createdAt": "2020-04-30T16:43:55Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7951", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2OTM4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r418169388", "bodyText": "Wouldnt these be the cases we do want to retry on?  Bad Gateway means it still could be starting up.", "author": "wonderslug", "createdAt": "2020-04-30T17:23:26Z", "path": "freeipa-client/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClientExceptionUtil.java", "diffHunk": "@@ -57,8 +57,6 @@\n             HttpStatus.REQUEST_TIMEOUT,\n             HttpStatus.TOO_MANY_REQUESTS,\n             HttpStatus.INTERNAL_SERVER_ERROR,\n-            HttpStatus.BAD_GATEWAY,\n-            HttpStatus.SERVICE_UNAVAILABLE,", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1MjgwNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419352806", "bodyText": "it's already defined inn the app yaml, so I think we should remove all default values from here", "author": "lacikaaa", "createdAt": "2020-05-04T10:50:19Z", "path": "cluster-proxy/src/main/java/com/sequenceiq/cloudbreak/clusterproxy/ClusterProxyConfiguration.java", "diffHunk": "@@ -29,6 +29,9 @@\n     @Value(\"${clusterProxy.removeConfigPath:/rpc/removeConfig}\")\n     private String removeConfigPath;\n \n+    @Value(\"${clusterProxy.readConfigPath:/rpc/readConfig}\")", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ5NDAxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419494010", "bodyText": "Ok, I will also clean up the other default values in this file.", "author": "jamisonbennett", "createdAt": "2020-05-04T14:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1MjgwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2NzMwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419367305", "bodyText": "could you move it to a separate method, like createStickyHeaders?", "author": "lacikaaa", "createdAt": "2020-05-04T11:23:05Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClientBuilder.java", "diffHunk": "@@ -144,22 +159,39 @@ public FreeIpaClient build(boolean withPing) throws URISyntaxException, IOExcept\n                 LOGGER.debug(\"Ping at target: {}\", target);\n                 HttpHead request = new HttpHead(target);\n                 additionalHeaders.forEach(request::addHeader);\n+                additionalHeadersStickySessionFirstRpc.forEach(request::addHeader);\n                 try (CloseableHttpResponse response = client.execute(request)) {\n                     if (UNAVIALLBE_PING_HTTP_RESPONSES.contains(response.getStatusLine().getStatusCode())) {\n                         throw new HttpException(\"Ping failed with http status code \" + response.getStatusLine().getStatusCode());\n                     }\n+                    if (stickyIdHeader.isPresent()) {\n+                        stickyId = Optional.ofNullable(response.getLastHeader(stickyIdHeader.get())).map(NameValuePair::getValue);\n+                    }\n                 }\n                 LOGGER.debug(\"Freeipa is reachable\");\n             } catch (Exception e) {\n                 throw new FreeIpaHostNotAvailableException(\"Ping failed\", e);\n             }\n         }\n-        String sessionCookie = connect(user, pass, clientConfig.getApiAddress(), port);\n+        Map<String, String> stickyHeaders = new HashMap<>();\n+        if (stickyId.isEmpty()) {\n+            stickyHeaders.putAll(additionalHeadersStickySessionFirstRpc);\n+        } else {\n+            stickyHeaders.putAll(additionalHeadersStickySession);\n+            stickyHeaders.put(stickyIdHeader.get(), stickyId.get());\n+        }", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2NzUxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419367510", "bodyText": "could refactor it into a method like buildHeaders?", "author": "lacikaaa", "createdAt": "2020-05-04T11:23:38Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClientBuilder.java", "diffHunk": "@@ -144,22 +159,39 @@ public FreeIpaClient build(boolean withPing) throws URISyntaxException, IOExcept\n                 LOGGER.debug(\"Ping at target: {}\", target);\n                 HttpHead request = new HttpHead(target);\n                 additionalHeaders.forEach(request::addHeader);\n+                additionalHeadersStickySessionFirstRpc.forEach(request::addHeader);\n                 try (CloseableHttpResponse response = client.execute(request)) {\n                     if (UNAVIALLBE_PING_HTTP_RESPONSES.contains(response.getStatusLine().getStatusCode())) {\n                         throw new HttpException(\"Ping failed with http status code \" + response.getStatusLine().getStatusCode());\n                     }\n+                    if (stickyIdHeader.isPresent()) {\n+                        stickyId = Optional.ofNullable(response.getLastHeader(stickyIdHeader.get())).map(NameValuePair::getValue);\n+                    }\n                 }\n                 LOGGER.debug(\"Freeipa is reachable\");\n             } catch (Exception e) {\n                 throw new FreeIpaHostNotAvailableException(\"Ping failed\", e);\n             }\n         }\n-        String sessionCookie = connect(user, pass, clientConfig.getApiAddress(), port);\n+        Map<String, String> stickyHeaders = new HashMap<>();\n+        if (stickyId.isEmpty()) {\n+            stickyHeaders.putAll(additionalHeadersStickySessionFirstRpc);\n+        } else {\n+            stickyHeaders.putAll(additionalHeadersStickySession);\n+            stickyHeaders.put(stickyIdHeader.get(), stickyId.get());\n+        }\n+        ConnectReturn connectReturn = connect(user, pass, clientConfig.getApiAddress(), port, stickyHeaders, stickyIdHeader);\n+        String sessionCookie = connectReturn.getCookie();\n+        stickyId = connectReturn.getStickyId();\n \n-        Map<String, String> headers = ImmutableMap.<String, String>builder()\n+        ImmutableMap.Builder<String, String> headersBuidler = ImmutableMap.<String, String>builder()\n                 .put(\"Cookie\", \"ipa_session=\" + sessionCookie)\n                 .putAll(additionalHeaders)\n-                .build();\n+                .putAll(additionalHeadersStickySession);\n+        if (stickyIdHeader.isPresent() && stickyId.isPresent()) {\n+            headersBuidler.put(stickyIdHeader.get(), stickyId.get());\n+        }\n+        Map<String, String> headers = headersBuidler.build();", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2ODE2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419368166", "bodyText": "I know this class is tied to this pretty much, but as it is already pretty big, could you move it out?", "author": "lacikaaa", "createdAt": "2020-05-04T11:25:03Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClientBuilder.java", "diffHunk": "@@ -271,4 +308,24 @@ private CloseableHttpResponse execute(HttpPost post, CookieStore cookieStore) th\n     private static HostnameVerifier hostnameVerifier() {\n         return (s, sslSession) -> true;\n     }\n+\n+    private static class ConnectReturn {", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3MjY1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419372650", "bodyText": "could you move this to a method also?", "author": "lacikaaa", "createdAt": "2020-05-04T11:34:54Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClientBuilder.java", "diffHunk": "@@ -144,22 +159,39 @@ public FreeIpaClient build(boolean withPing) throws URISyntaxException, IOExcept\n                 LOGGER.debug(\"Ping at target: {}\", target);\n                 HttpHead request = new HttpHead(target);\n                 additionalHeaders.forEach(request::addHeader);\n+                additionalHeadersStickySessionFirstRpc.forEach(request::addHeader);\n                 try (CloseableHttpResponse response = client.execute(request)) {\n                     if (UNAVIALLBE_PING_HTTP_RESPONSES.contains(response.getStatusLine().getStatusCode())) {\n                         throw new HttpException(\"Ping failed with http status code \" + response.getStatusLine().getStatusCode());\n                     }\n+                    if (stickyIdHeader.isPresent()) {\n+                        stickyId = Optional.ofNullable(response.getLastHeader(stickyIdHeader.get())).map(NameValuePair::getValue);\n+                    }", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3Nzg3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419377876", "bodyText": "could you give this variable a meaningful name?", "author": "lacikaaa", "createdAt": "2020-05-04T11:46:21Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -104,20 +121,17 @@ private FreeIpaClient getFreeIpaClient(Stack stack, boolean withPing, boolean fo\n         }\n     }\n \n-    private Optional<FreeIpaClient> getFreeIpaClient(Stack stack, InstanceMetaData instanceMetaData, boolean withPing, boolean lastInstance) throws Exception {\n-        Optional<FreeIpaClient> client = Optional.empty();\n+    private Optional<FreeIpaClient> getFreeIpaClientForDirectConnect(Stack stack, InstanceMetaData instanceMetaData, boolean withPing, boolean lastInstance)\n+            throws Exception {\n+        Optional<FreeIpaClient> ret = Optional.empty();", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4MjIzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419382232", "bodyText": "could you move this to a variable, it easier to follow that way", "author": "lacikaaa", "createdAt": "2020-05-04T11:55:46Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/ClusterProxyService.java", "diffHunk": "@@ -193,12 +248,10 @@ public String getProxyPath(String crn) {\n         return String.format(\"%s/proxy/%s/%s\", clusterProxyConfiguration.getClusterProxyBasePath(), crn, FREEIPA_SERVICE_NAME);\n     }\n \n-    public String getProxyPath(Stack stack, String serviceName) {\n-        if (ClusterProxyServiceAvailabilityChecker.isDnsBasedServiceNameAvailable(stack)) {\n-            return String.format(\"%s/proxy/%s/%s\", clusterProxyConfiguration.getClusterProxyBasePath(), stack.getResourceCrn(), serviceName);\n-        } else {\n-            return getProxyPath(stack.getResourceCrn());\n-        }\n+    public String getProxyPath(Stack stack, Optional<String> serviceName) {\n+        FreeIpa freeIpa = freeIpaService.findByStack(stack);\n+        return String.format(\"%s/proxy/%s/%s\", clusterProxyConfiguration.getClusterProxyBasePath(), stack.getResourceCrn(),\n+                serviceName.orElse(FreeIpaDomainUtils.getFreeIpaFqdn(freeIpa.getDomain())));", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4NDAxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7951#discussion_r419384019", "bodyText": "would it have any benefit if these values would be configurable?", "author": "lacikaaa", "createdAt": "2020-05-04T11:59:31Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/ClusterProxyService.java", "diffHunk": "@@ -50,6 +59,24 @@\n \n     private static final String NGINX_PROTOCOL = \"https\";\n \n+    private static final int MAX_ATTEMPTS = 3;\n+\n+    private static final int MAX_FAILURE = 1;", "originalCommit": "95066c61da58fdec8d49135faf36dd8b48282df2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e7e5a585c5f38a5a8175be82a6a142f035df35e1", "url": "https://github.com/hortonworks/cloudbreak/commit/e7e5a585c5f38a5a8175be82a6a142f035df35e1", "message": "CB-4377: Use cluster proxy HA for FreeIPA connections\n\nUse cluster proxy HA for FreeIPA connections. Configure cluster proxy\nto monitor the FreeIPA health using the login page. A better health\ncheck is being developed, but the login will at least allow cluster\nproxy to determine if FreeIPA is reachable.\n\nUse a sticky session to maintain the connection to a specific FreeIPA\ninstance.\n\nWhen provisioning, wait for the HA endpoint provide a good status\nbefore continuing to provision.\n\nThis was tested manually, by stopping nginx on one node and performing\nFreeIPA management service requests to FreeIPA. Then the first node\nwas brought back up and the same thing was done after bringing the\nsecond node down.", "committedDate": "2020-05-04T18:50:50Z", "type": "forcePushed"}, {"oid": "bf35393917520568cd29b77ade84a0571b58b96a", "url": "https://github.com/hortonworks/cloudbreak/commit/bf35393917520568cd29b77ade84a0571b58b96a", "message": "CB-4377: Use cluster proxy HA for FreeIPA connections\n\nUse cluster proxy HA for FreeIPA connections. Configure cluster proxy\nto monitor the FreeIPA health using the login page. A better health\ncheck is being developed, but the login will at least allow cluster\nproxy to determine if FreeIPA is reachable.\n\nUse a sticky session to maintain the connection to a specific FreeIPA\ninstance.\n\nWhen provisioning, wait for the HA endpoint provide a good status\nbefore continuing to provision.\n\nThis was tested manually, by stopping nginx on one node and performing\nFreeIPA management service requests to FreeIPA. Then the first node\nwas brought back up and the same thing was done after bringing the\nsecond node down.", "committedDate": "2020-05-05T12:53:34Z", "type": "forcePushed"}, {"oid": "81c68c0859dadb8bd36846858828d0c8c1a6d444", "url": "https://github.com/hortonworks/cloudbreak/commit/81c68c0859dadb8bd36846858828d0c8c1a6d444", "message": "CB-4377: Use cluster proxy HA for FreeIPA connections\n\nUse cluster proxy HA for FreeIPA connections. Configure cluster proxy\nto monitor the FreeIPA health using the login page. A better health\ncheck is being developed, but the login will at least allow cluster\nproxy to determine if FreeIPA is reachable.\n\nUse a sticky session to maintain the connection to a specific FreeIPA\ninstance.\n\nWhen provisioning, wait for the HA endpoint provide a good status\nbefore continuing to provision.\n\nThis was tested manually, by stopping nginx on one node and performing\nFreeIPA management service requests to FreeIPA. Then the first node\nwas brought back up and the same thing was done after bringing the\nsecond node down.", "committedDate": "2020-05-05T13:28:35Z", "type": "commit"}, {"oid": "81c68c0859dadb8bd36846858828d0c8c1a6d444", "url": "https://github.com/hortonworks/cloudbreak/commit/81c68c0859dadb8bd36846858828d0c8c1a6d444", "message": "CB-4377: Use cluster proxy HA for FreeIPA connections\n\nUse cluster proxy HA for FreeIPA connections. Configure cluster proxy\nto monitor the FreeIPA health using the login page. A better health\ncheck is being developed, but the login will at least allow cluster\nproxy to determine if FreeIPA is reachable.\n\nUse a sticky session to maintain the connection to a specific FreeIPA\ninstance.\n\nWhen provisioning, wait for the HA endpoint provide a good status\nbefore continuing to provision.\n\nThis was tested manually, by stopping nginx on one node and performing\nFreeIPA management service requests to FreeIPA. Then the first node\nwas brought back up and the same thing was done after bringing the\nsecond node down.", "committedDate": "2020-05-05T13:28:35Z", "type": "forcePushed"}]}