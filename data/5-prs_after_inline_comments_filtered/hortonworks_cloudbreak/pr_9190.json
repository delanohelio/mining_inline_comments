{"pr_number": 9190, "pr_title": "CB-8668: FreeIPA status updates should not incorrectly overwrite the \u2026", "pr_createdAt": "2020-10-09T19:54:17Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9190", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NDc5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r502674796", "bodyText": "shouldn't the stack be available if it has the UPSCALE_COMPLETED, DOWNSCALE_COMPLETED, or REPAIR_COMPLETED status? There are places we check whether a stack is available before performing an operation on it.", "author": "handavid", "createdAt": "2020-10-09T21:16:18Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/common/Status.java", "diffHunk": "@@ -33,10 +41,10 @@\n     public static final Collection<Status> AVAILABLE_STATUSES = List.of(AVAILABLE, MAINTENANCE_MODE_ENABLED);", "originalCommit": "0abee58dc4e10d75b310a4ac11ce7869ec568850", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3NDQ0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r503174447", "bodyText": "I would stick with AVAILABLE and won't introduce new states representing the same. What's the benefit of this?", "author": "lacikaaa", "createdAt": "2020-10-12T09:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NDc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4NzY4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r503387685", "bodyText": "Hi @handavid and @lacikaaa , thanks for the review!\nThe reason we are changing the finishing status of a repair operation is because an operation will always change the status to running/available even operation failed or freeipa is unhealthy. So we will have a period where the available status is falsely reported.\n\nOne example,\nIssue a reboot/repair operation\n\nThen instances are terminated so reboot/repair operation failed. But the operation will update status to running.\n\nAfter 3 minutes, the actually health check find out freeipa is not running.\n\nWith this fix, the false running status will not be reported before a health check.", "author": "christmasferret", "createdAt": "2020-10-12T15:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NDc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc0ODc1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r503748750", "bodyText": "ok so we would let the statuschecker to determine the status? in case of failed this seems right to me. Although it's a bit strange if we run repair/upscale/downscale and the flow finishes successfully and we can't expect the cluster is in a healthy state. It means the flow exit criteria isn't checking if it's job is done well. This just seems like a workaround to me, instead of fixing the flow (if it needs fixing)\ncc @jamisonbennett", "author": "lacikaaa", "createdAt": "2020-10-13T08:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NDc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1NzEzMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r504657131", "bodyText": "hi @lacikaaa,\nThanks a lot for the suggestion! I have removed the \"repair completed\" status, at the end of a successful repair flow, I added statuschecker to determine the status. I've verified both reboot and repair as below.\nIssue a reboot\n\nat the end of the reboot flow, the statuschecker update it to available.\n\n\nIssue a repair,\n\nat the end of repair flow, status checker update it to available", "author": "christmasferret", "createdAt": "2020-10-14T13:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NDc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NTA4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r502675087", "bodyText": "should UPSCALE_COMPLETED, DOWNSCALE_COMPLETED, and REPAIR_COMPLETED also be removable? I'm not sure what isRemovable is used for.", "author": "handavid", "createdAt": "2020-10-09T21:17:02Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/common/Status.java", "diffHunk": "@@ -33,10 +41,10 @@\n     public static final Collection<Status> AVAILABLE_STATUSES = List.of(AVAILABLE, MAINTENANCE_MODE_ENABLED);\n \n     public static final Collection<Status> REMOVABLE_STATUSES = List.of(AVAILABLE, UPDATE_FAILED, CREATE_FAILED, DELETE_FAILED,\n-            DELETE_COMPLETED, STOPPED, START_FAILED, STOP_FAILED);\n+            DELETE_COMPLETED, STOPPED, START_FAILED, STOP_FAILED, REPAIR_FAILED, UPSCALE_FAILED, DOWNSCALE_FAILED);", "originalCommit": "0abee58dc4e10d75b310a4ac11ce7869ec568850", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2MDQ0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r503560449", "bodyText": "If it is removable status, we will delete the freeipa stack from in memory cache. I am reverting this part of code change as in the repair case we can leave it in cache.\n    if (newStatus.isRemovableStatus()) {\n        InMemoryStateStore.deleteStack(stack.getId());\n    }", "author": "christmasferret", "createdAt": "2020-10-12T22:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NTA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc0MzIzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r503743234", "bodyText": "All new FAILED, COMPLETED statuses should be added to REMOVABLE_STATUSES as this indicates these are final states, no flow should be running for these stack and they can be removed from the InMemoryStateStore.", "author": "lacikaaa", "createdAt": "2020-10-13T07:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NTA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1OTY0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r504659642", "bodyText": "Thanks for the suggestion! Now I added all the status to REMOVABLE_STATUSES. Since I have removed \"repair completed\", I use statuschecker to update it to available status.", "author": "christmasferret", "createdAt": "2020-10-14T13:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NTA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE1NDk0NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r508154945", "bodyText": "I added the newly added failed states (REPAIR_FAILED, UPSCALE_FAILED, DOWNSCALE_FAILED) to removable states now. Thanks!", "author": "christmasferret", "createdAt": "2020-10-20T01:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NTA4Nw=="}], "type": "inlineReview"}, {"oid": "0385c7df986c0b12a1010c729c8c18bc8436e2c0", "url": "https://github.com/hortonworks/cloudbreak/commit/0385c7df986c0b12a1010c729c8c18bc8436e2c0", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\".", "committedDate": "2020-10-12T22:15:55Z", "type": "forcePushed"}, {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937", "url": "https://github.com/hortonworks/cloudbreak/commit/5f49d3dd48b3a51c62287dcda4a0ea598260b937", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nAdded health check to the end of a successful freeipa repair operation to update the stack status to available. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. In case of a failed operation, the stack will report a false available status.", "committedDate": "2020-10-14T12:49:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk0NzgyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r504947821", "bodyText": "this if can be combined with the if starting on line 162.", "author": "handavid", "createdAt": "2020-10-14T20:19:00Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/freeipa/repair/changeprimarygw/action/ChangePrimaryGatewayActions.java", "diffHunk": "@@ -150,7 +154,11 @@ protected void doExecute(ChangePrimaryGatewayContext context, StackEvent payload\n                 Stack stack = context.getStack();\n                 SuccessDetails successDetails = new SuccessDetails(stack.getEnvironmentCrn());\n \n-                stackUpdater.updateStackStatus(stack.getId(), getChangePrimaryGatewayCompleteStatus(variables), \"Finished changing the primary gateway\");\n+                if (isFinalChain(variables)) {", "originalCommit": "5f49d3dd48b3a51c62287dcda4a0ea598260b937", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE1NTU1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r508155556", "bodyText": "Thanks a lot for the suggestion. I've combined the two \"if\"s and tested the flow again.\nAfter repair, the status check updates it to available.", "author": "christmasferret", "createdAt": "2020-10-20T01:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk0NzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUyNzA2NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r507527065", "bodyText": "still missing the failure states from here", "author": "lacikaaa", "createdAt": "2020-10-19T07:25:48Z", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/common/Status.java", "diffHunk": "@@ -32,11 +37,11 @@\n \n     public static final Collection<Status> AVAILABLE_STATUSES = List.of(AVAILABLE, MAINTENANCE_MODE_ENABLED);\n \n-    public static final Collection<Status> REMOVABLE_STATUSES = List.of(AVAILABLE, UPDATE_FAILED, CREATE_FAILED, DELETE_FAILED,\n+    public static final Collection<Status>  REMOVABLE_STATUSES = List.of(AVAILABLE, UPDATE_FAILED, CREATE_FAILED, DELETE_FAILED,", "originalCommit": "5f49d3dd48b3a51c62287dcda4a0ea598260b937", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE1NzE0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r508157141", "bodyText": "I added the newly added failed states (REPAIR_FAILED, UPSCALE_FAILED, DOWNSCALE_FAILED) to removable states now. Thanks!", "author": "christmasferret", "createdAt": "2020-10-20T01:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUyNzA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUyOTI3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r507529271", "bodyText": "getChangePrimaryGatewayCompleteStatus implementation also checks isFinalChain(variables) which doesn't make too much sense after this change. most probably you should replace the method call with DetailedStackStatus.REPAIR_IN_PROGRESS", "author": "lacikaaa", "createdAt": "2020-10-19T07:30:02Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/freeipa/repair/changeprimarygw/action/ChangePrimaryGatewayActions.java", "diffHunk": "@@ -150,7 +154,11 @@ protected void doExecute(ChangePrimaryGatewayContext context, StackEvent payload\n                 Stack stack = context.getStack();\n                 SuccessDetails successDetails = new SuccessDetails(stack.getEnvironmentCrn());\n \n-                stackUpdater.updateStackStatus(stack.getId(), getChangePrimaryGatewayCompleteStatus(variables), \"Finished changing the primary gateway\");\n+                if (isFinalChain(variables)) {\n+                    stackStatusCheckerJob.syncAStack(stack);\n+                } else {\n+                    stackUpdater.updateStackStatus(stack.getId(), getChangePrimaryGatewayCompleteStatus(variables), \"Finished changing the primary gateway\");", "originalCommit": "5f49d3dd48b3a51c62287dcda4a0ea598260b937", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE1NzM1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r508157350", "bodyText": "Thanks! I removed the method getChangePrimaryGatewayCompleteStatus() since it is not necessary and I use DetailedStackStatus.REPAIR_IN_PROGRESS directly. I tested the repair flow again and attached evidence below.", "author": "christmasferret", "createdAt": "2020-10-20T01:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUyOTI3MQ=="}], "type": "inlineReview"}, {"oid": "59a4e79b48a74caa04cd98940585d7b44a575e68", "url": "https://github.com/hortonworks/cloudbreak/commit/59a4e79b48a74caa04cd98940585d7b44a575e68", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\".", "committedDate": "2020-10-20T01:27:59Z", "type": "forcePushed"}, {"oid": "0597a180cc7abd7b1a17fe721cec8d5065ea2715", "url": "https://github.com/hortonworks/cloudbreak/commit/0597a180cc7abd7b1a17fe721cec8d5065ea2715", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\".", "committedDate": "2020-10-21T13:56:18Z", "type": "forcePushed"}, {"oid": "b387009d590a3bd76077ebc429a3463c0190ddcf", "url": "https://github.com/hortonworks/cloudbreak/commit/b387009d590a3bd76077ebc429a3463c0190ddcf", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\".", "committedDate": "2020-10-21T14:44:37Z", "type": "commit"}, {"oid": "b387009d590a3bd76077ebc429a3463c0190ddcf", "url": "https://github.com/hortonworks/cloudbreak/commit/b387009d590a3bd76077ebc429a3463c0190ddcf", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\".", "committedDate": "2020-10-21T14:44:37Z", "type": "forcePushed"}]}