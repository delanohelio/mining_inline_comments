{"pr_number": 7160, "pr_title": "CDPCP-624. Prevent cross-account queries for operation status", "pr_createdAt": "2020-01-28T18:29:26Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7160", "timeline": [{"oid": "ec32cf2b3c05f16a82d83e14952d9fa7e907827a", "url": "https://github.com/hortonworks/cloudbreak/commit/ec32cf2b3c05f16a82d83e14952d9fa7e907827a", "message": "CDPCP-624. Prevent cross-account queries for operation status\n\nThis commit renames the existing OperationStatusService to OperationService.\n\nEntity conversion into API models has been moved to the controllers so\nthat all internal code works with the Operation entity instead.\n\nAn account id must always be specified when retrieving an operation from\nthe database. The controller for the getSyncOperationStatus api gets the\naccount id from the caller (i.e., from the x-cdp-actor header). This ensures\nthat no actor can retrieve operation status for any account other than its\nown account. Since the request does not include an account\nparameter, there is no way for an internal actor to request status of\nan operation in a different account.", "committedDate": "2020-01-28T18:21:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5Mzk5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7160#discussion_r372193997", "bodyText": "So was this functionality was always there but you just didn't use it? What are the use cases for using getOperationForOperationID? should that be removed?", "author": "giladwolff", "createdAt": "2020-01-29T05:23:52Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/operation/OperationService.java", "diffHunk": "@@ -97,12 +87,13 @@ public Operation failOperation(String operationId, String failureMessage) {\n         return failOperation(operationId, failureMessage, Collections.emptyList(), Collections.emptyList());\n     }\n \n-    public SyncOperationStatus getSyncOperationStatus(String operationId) {\n-        return operationToSyncOperationStatus.convert(getOperationForOperationId(operationId));\n-    }\n-\n-    public OperationStatus getOperationStatus(String operationId, String accountId) {\n-        return operationToOperationStatusConverter.convert(getOperationForOperationId(operationId));\n+    public Operation getOperationForAccountIdAndOperationId(String accountId, String operationId) {\n+        Optional<Operation> operationOptional = operationRepository.findByOperationIdAndAccountId(operationId, accountId);", "originalCommit": "ec32cf2b3c05f16a82d83e14952d9fa7e907827a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1MzAzMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7160#discussion_r373153031", "bodyText": "yeah. this code was there but not used.\nThe getter by operation id only is used internally for the \"complete\" and \"fail\" methods that transition the operation to either the COMPLETED or FAILED state. These are used internally to the FMS. I didn't want to change the behavior of the callers in this PR. We would have to update the flow CleanupEvent to either hold the account id or retrieve the account id from the Stack prior to completing or failing an operation.\nI can do that in a follow-on commit.", "author": "handavid", "createdAt": "2020-01-30T19:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5Mzk5Nw=="}], "type": "inlineReview"}]}