{"pr_number": 8656, "pr_title": "CDPCP-2673. Poll status of refresh when syncing OIDs", "pr_createdAt": "2020-07-28T11:40:56Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8656", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc3ODE3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r463778171", "bodyText": "we only have a commandId if the status is ACTIVE, right?", "author": "handavid", "createdAt": "2020-07-31T18:56:48Z", "path": "datalake-api/src/main/java/com/sequenceiq/sdx/api/model/RangerCloudIdentitySyncStatus.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.sequenceiq.sdx.api.model;\n+\n+import io.swagger.annotations.ApiModelProperty;\n+\n+import javax.validation.constraints.NotNull;\n+\n+public class RangerCloudIdentitySyncStatus {\n+\n+    @ApiModelProperty\n+    private Long commandId;", "originalCommit": "14a4b48e686de672070c89d2d99e94b56e019d78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2MDI2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r464960266", "bodyText": "Well, we can have it on a SUCCESS as well (see RangerCloudIdentityService.toRangerCloudIdentitySyncStatus).", "author": "aarman-cloudera", "createdAt": "2020-08-04T10:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc3ODE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc5Mzk0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r463793942", "bodyText": "should we have an \"unsupported\" status instead of successful? successful seems misleading to me.", "author": "handavid", "createdAt": "2020-07-31T19:32:07Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/RangerCloudIdentityService.java", "diffHunk": "@@ -24,21 +27,87 @@\n     @Inject\n     private SdxService sdxService;\n \n-    private void setAzureCloudIdentityMapping(SdxCluster sdxCluster, Map<String, String> azureUserMapping) {\n+    private RangerCloudIdentitySyncStatus sucessfulCloudIdSyncStatus(String message) {\n+        RangerCloudIdentitySyncStatus status = new RangerCloudIdentitySyncStatus();\n+        status.setState(RangerCloudIdentitySyncState.SUCCESS);\n+        status.setStatusReason(message);\n+        return status;\n+    }\n+\n+    private RangerCloudIdentitySyncStatus failedRangerCloudIdentitySyncStatus(String message) {\n+        RangerCloudIdentitySyncStatus status = new RangerCloudIdentitySyncStatus();\n+        status.setState(RangerCloudIdentitySyncState.FAILED);\n+        status.setStatusReason(message);\n+        return status;\n+    }\n+\n+    private RangerCloudIdentitySyncStatus setAzureCloudIdentityMapping(String envCrn, SdxCluster sdxCluster, Map<String, String> azureUserMapping) {\n         String stackCrn = sdxCluster.getStackCrn();\n-        LOGGER.info(\"Updating azure cloud id mappings for datalake stack crn = {}\", stackCrn);\n+        LOGGER.info(\"Updating azure cloud id mappings for envCrn = {}, datalake stack crn = {}\", envCrn, stackCrn);\n         try {\n-            clouderaManagerRangerUtil.setAzureCloudIdentityMapping(stackCrn, azureUserMapping);\n+            if (!clouderaManagerRangerUtil.isCloudIdMappingSupported(sdxCluster.getStackCrn())) {\n+                return sucessfulCloudIdSyncStatus(\"The datalake does not support cloud identity sync. Sync request is ignored.\");", "originalCommit": "14a4b48e686de672070c89d2d99e94b56e019d78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2MDUzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r464960530", "bodyText": "True, I've added a NOT_APPLICABLE status like you've mentioned.", "author": "aarman-cloudera", "createdAt": "2020-08-04T10:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc5Mzk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2MTA4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r464961082", "bodyText": "I think we can also get rid of this part if we only make the call from FreeIPA on RAZ enabled environments. I'll look into it as a separate item though.", "author": "aarman-cloudera", "createdAt": "2020-08-04T10:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc5Mzk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc5NTM4MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r463795381", "bodyText": "typo: datalakes\nalso, this doesn't sound like a successful scenario. Is there a better status to describe what happened?", "author": "handavid", "createdAt": "2020-07-31T19:35:50Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/RangerCloudIdentityService.java", "diffHunk": "@@ -24,21 +27,87 @@\n     @Inject\n     private SdxService sdxService;\n \n-    private void setAzureCloudIdentityMapping(SdxCluster sdxCluster, Map<String, String> azureUserMapping) {\n+    private RangerCloudIdentitySyncStatus sucessfulCloudIdSyncStatus(String message) {\n+        RangerCloudIdentitySyncStatus status = new RangerCloudIdentitySyncStatus();\n+        status.setState(RangerCloudIdentitySyncState.SUCCESS);\n+        status.setStatusReason(message);\n+        return status;\n+    }\n+\n+    private RangerCloudIdentitySyncStatus failedRangerCloudIdentitySyncStatus(String message) {\n+        RangerCloudIdentitySyncStatus status = new RangerCloudIdentitySyncStatus();\n+        status.setState(RangerCloudIdentitySyncState.FAILED);\n+        status.setStatusReason(message);\n+        return status;\n+    }\n+\n+    private RangerCloudIdentitySyncStatus setAzureCloudIdentityMapping(String envCrn, SdxCluster sdxCluster, Map<String, String> azureUserMapping) {\n         String stackCrn = sdxCluster.getStackCrn();\n-        LOGGER.info(\"Updating azure cloud id mappings for datalake stack crn = {}\", stackCrn);\n+        LOGGER.info(\"Updating azure cloud id mappings for envCrn = {}, datalake stack crn = {}\", envCrn, stackCrn);\n         try {\n-            clouderaManagerRangerUtil.setAzureCloudIdentityMapping(stackCrn, azureUserMapping);\n+            if (!clouderaManagerRangerUtil.isCloudIdMappingSupported(sdxCluster.getStackCrn())) {\n+                return sucessfulCloudIdSyncStatus(\"The datalake does not support cloud identity sync. Sync request is ignored.\");\n+            }\n+            Optional<ApiCommand> apiCommand = clouderaManagerRangerUtil.setAzureCloudIdentityMapping(stackCrn, azureUserMapping);\n+            if (apiCommand.isEmpty()) {\n+                return sucessfulCloudIdSyncStatus(\"Sucessfully synced, no role refresh required\");\n+            }\n+            return toRangerCloudIdentitySyncStatus(apiCommand.get());\n         } catch (ApiException e) {\n             LOGGER.error(\"Encountered api exception\", e);\n-            throw new RangerCloudIdentitySyncException(\"Encountered api exception\", e);\n+            return failedRangerCloudIdentitySyncStatus(\"Encountered cloudera manager api exception\");\n+        }\n+    }\n+\n+    private Optional<SdxCluster> getSdxCluster(String envCrn) {\n+        List<SdxCluster> sdxClusters = sdxService.listSdxByEnvCrn(envCrn);\n+        if (sdxClusters.isEmpty()) {\n+            return Optional.empty();\n+        } else if (sdxClusters.size() > 1) {\n+            LOGGER.error(\"Multiple datalakes per environment not supported, environmentCrn = {}\", envCrn);\n+            throw new IllegalStateException(\"Multiple datalakes per environment not supported\");\n+        }\n+        return Optional.of(Iterables.getOnlyElement(sdxClusters));\n+    }\n+\n+    public RangerCloudIdentitySyncStatus setAzureCloudIdentityMapping(String envCrn, Map<String, String> azureUserMapping) {\n+        Optional<SdxCluster> sdxCluster = getSdxCluster(envCrn);\n+        if (sdxCluster.isEmpty()) {\n+            return sucessfulCloudIdSyncStatus(\"No datlakes associated with the environment.\");", "originalCommit": "14a4b48e686de672070c89d2d99e94b56e019d78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc5Njk2OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r463796969", "bodyText": "typo: datalakes\nalso, this doesn't feel like a successful condition. maybe NOT_APPLICABLE would make sense for both this case and the case where the CM doesn't support this feature?", "author": "handavid", "createdAt": "2020-07-31T19:39:17Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/RangerCloudIdentityService.java", "diffHunk": "@@ -24,21 +27,87 @@\n     @Inject\n     private SdxService sdxService;\n \n-    private void setAzureCloudIdentityMapping(SdxCluster sdxCluster, Map<String, String> azureUserMapping) {\n+    private RangerCloudIdentitySyncStatus sucessfulCloudIdSyncStatus(String message) {\n+        RangerCloudIdentitySyncStatus status = new RangerCloudIdentitySyncStatus();\n+        status.setState(RangerCloudIdentitySyncState.SUCCESS);\n+        status.setStatusReason(message);\n+        return status;\n+    }\n+\n+    private RangerCloudIdentitySyncStatus failedRangerCloudIdentitySyncStatus(String message) {\n+        RangerCloudIdentitySyncStatus status = new RangerCloudIdentitySyncStatus();\n+        status.setState(RangerCloudIdentitySyncState.FAILED);\n+        status.setStatusReason(message);\n+        return status;\n+    }\n+\n+    private RangerCloudIdentitySyncStatus setAzureCloudIdentityMapping(String envCrn, SdxCluster sdxCluster, Map<String, String> azureUserMapping) {\n         String stackCrn = sdxCluster.getStackCrn();\n-        LOGGER.info(\"Updating azure cloud id mappings for datalake stack crn = {}\", stackCrn);\n+        LOGGER.info(\"Updating azure cloud id mappings for envCrn = {}, datalake stack crn = {}\", envCrn, stackCrn);\n         try {\n-            clouderaManagerRangerUtil.setAzureCloudIdentityMapping(stackCrn, azureUserMapping);\n+            if (!clouderaManagerRangerUtil.isCloudIdMappingSupported(sdxCluster.getStackCrn())) {\n+                return sucessfulCloudIdSyncStatus(\"The datalake does not support cloud identity sync. Sync request is ignored.\");\n+            }\n+            Optional<ApiCommand> apiCommand = clouderaManagerRangerUtil.setAzureCloudIdentityMapping(stackCrn, azureUserMapping);\n+            if (apiCommand.isEmpty()) {\n+                return sucessfulCloudIdSyncStatus(\"Sucessfully synced, no role refresh required\");\n+            }\n+            return toRangerCloudIdentitySyncStatus(apiCommand.get());\n         } catch (ApiException e) {\n             LOGGER.error(\"Encountered api exception\", e);\n-            throw new RangerCloudIdentitySyncException(\"Encountered api exception\", e);\n+            return failedRangerCloudIdentitySyncStatus(\"Encountered cloudera manager api exception\");\n+        }\n+    }\n+\n+    private Optional<SdxCluster> getSdxCluster(String envCrn) {\n+        List<SdxCluster> sdxClusters = sdxService.listSdxByEnvCrn(envCrn);\n+        if (sdxClusters.isEmpty()) {\n+            return Optional.empty();\n+        } else if (sdxClusters.size() > 1) {\n+            LOGGER.error(\"Multiple datalakes per environment not supported, environmentCrn = {}\", envCrn);\n+            throw new IllegalStateException(\"Multiple datalakes per environment not supported\");\n+        }\n+        return Optional.of(Iterables.getOnlyElement(sdxClusters));\n+    }\n+\n+    public RangerCloudIdentitySyncStatus setAzureCloudIdentityMapping(String envCrn, Map<String, String> azureUserMapping) {\n+        Optional<SdxCluster> sdxCluster = getSdxCluster(envCrn);\n+        if (sdxCluster.isEmpty()) {\n+            return sucessfulCloudIdSyncStatus(\"No datlakes associated with the environment.\");\n         }\n+        return setAzureCloudIdentityMapping(envCrn, sdxCluster.get(), azureUserMapping);\n     }\n \n-    public void setAzureCloudIdentityMapping(String environmentCrn, Map<String, String> azureUserMapping) {\n-        List<SdxCluster> sdxClusters = sdxService.listSdxByEnvCrn(environmentCrn);\n-        List<String> sdxClusterCrns = sdxClusters.stream().map(SdxCluster::getCrn).collect(Collectors.toList());\n-        LOGGER.info(\"Setting Azure cloud id mappings for datalake clusters = {}, environment = {}\", sdxClusterCrns, environmentCrn);\n-        sdxClusters.forEach(sdxCluster -> setAzureCloudIdentityMapping(sdxCluster, azureUserMapping));\n+    public RangerCloudIdentitySyncStatus getRangerCloudIdentitySyncStatus(String envCrn, long commandId) {\n+        Optional<SdxCluster> sdxCluster = getSdxCluster(envCrn);\n+        if (sdxCluster.isEmpty()) {\n+            return sucessfulCloudIdSyncStatus(\"No datlakes associated with the environment.\");", "originalCommit": "14a4b48e686de672070c89d2d99e94b56e019d78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc5ODk0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r463798946", "bodyText": "lets make these timeouts configurable", "author": "handavid", "createdAt": "2020-07-31T19:44:16Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/CloudIdentitySyncService.java", "diffHunk": "@@ -26,6 +29,13 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(CloudIdentitySyncService.class);\n \n+    private static final int SYNC_TIMEOUT_MS = 1000 * 4;", "originalCommit": "14a4b48e686de672070c89d2d99e94b56e019d78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc5OTg3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r463799877", "bodyText": "let's explicitly call out the ACTIVE case here", "author": "handavid", "createdAt": "2020-07-31T19:46:29Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/CloudIdentitySyncService.java", "diffHunk": "@@ -48,16 +58,49 @@ private void syncAzureObjectIds(Stack stack, UmsUsersState umsUsersState, BiCons\n \n             SetRangerCloudIdentityMappingRequest setRangerCloudIdentityMappingRequest = new SetRangerCloudIdentityMappingRequest();\n             setRangerCloudIdentityMappingRequest.setAzureUserMapping(userToAzureObjectIdMap);\n-            // TODO The SDX endpoint currently sets the config and triggers refresh. The SDX endpoint should also be updated\n-            //      to allow polling the status of the refresh.\n+\n             LOGGER.debug(\"Setting ranger cloud identity mapping: {}\", setRangerCloudIdentityMappingRequest);\n-            sdxEndpoint.setRangerCloudIdentityMapping(envCrn, setRangerCloudIdentityMappingRequest);\n+            RangerCloudIdentitySyncStatus syncStatus = sdxEndpoint.setRangerCloudIdentityMapping(envCrn, setRangerCloudIdentityMappingRequest);\n+\n+            // The sync status represents a cloud identity sync that may still be in progress, which we need to poll to check for completion.\n+            pollSyncStatus(syncStatus, envCrn, warnings);\n         } catch (Exception e) {\n             LOGGER.warn(\"Failed to set cloud identity mapping for environment {}\", envCrn, e);\n             warnings.accept(envCrn, \"Failed to set cloud identity mapping\");\n         }\n     }\n \n+    private void pollSyncStatus(RangerCloudIdentitySyncStatus syncStatus, String envCrn, BiConsumer<String, String> warnings) {\n+        // NOTE: Although it's synchronously polling, in practice this sync takes less than a second to complete\n+        Instant startTime = clock.getCurrentInstant();\n+        while (true) {\n+            LOGGER.info(\"syncStatus = {}\", syncStatus);\n+            switch (syncStatus.getState()) {\n+                case SUCCESS:\n+                    LOGGER.info(\"Successfully synced cloud identity, envCrn = {}\", envCrn);\n+                    return;\n+                case FAILED:\n+                    LOGGER.error(\"Failed to sync cloud identity, envCrn = {}\", envCrn);\n+                    warnings.accept(envCrn, \"Failed to sync cloud identity into environment\");\n+                    return;\n+                default:", "originalCommit": "14a4b48e686de672070c89d2d99e94b56e019d78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgwMTMyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r463801329", "bodyText": "it's possible to make this call and then not check the returned value because we timed out. I suggest moving the clock isAfter check to before the sleep.", "author": "handavid", "createdAt": "2020-07-31T19:49:57Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/CloudIdentitySyncService.java", "diffHunk": "@@ -48,16 +58,49 @@ private void syncAzureObjectIds(Stack stack, UmsUsersState umsUsersState, BiCons\n \n             SetRangerCloudIdentityMappingRequest setRangerCloudIdentityMappingRequest = new SetRangerCloudIdentityMappingRequest();\n             setRangerCloudIdentityMappingRequest.setAzureUserMapping(userToAzureObjectIdMap);\n-            // TODO The SDX endpoint currently sets the config and triggers refresh. The SDX endpoint should also be updated\n-            //      to allow polling the status of the refresh.\n+\n             LOGGER.debug(\"Setting ranger cloud identity mapping: {}\", setRangerCloudIdentityMappingRequest);\n-            sdxEndpoint.setRangerCloudIdentityMapping(envCrn, setRangerCloudIdentityMappingRequest);\n+            RangerCloudIdentitySyncStatus syncStatus = sdxEndpoint.setRangerCloudIdentityMapping(envCrn, setRangerCloudIdentityMappingRequest);\n+\n+            // The sync status represents a cloud identity sync that may still be in progress, which we need to poll to check for completion.\n+            pollSyncStatus(syncStatus, envCrn, warnings);\n         } catch (Exception e) {\n             LOGGER.warn(\"Failed to set cloud identity mapping for environment {}\", envCrn, e);\n             warnings.accept(envCrn, \"Failed to set cloud identity mapping\");\n         }\n     }\n \n+    private void pollSyncStatus(RangerCloudIdentitySyncStatus syncStatus, String envCrn, BiConsumer<String, String> warnings) {\n+        // NOTE: Although it's synchronously polling, in practice this sync takes less than a second to complete\n+        Instant startTime = clock.getCurrentInstant();\n+        while (true) {\n+            LOGGER.info(\"syncStatus = {}\", syncStatus);\n+            switch (syncStatus.getState()) {\n+                case SUCCESS:\n+                    LOGGER.info(\"Successfully synced cloud identity, envCrn = {}\", envCrn);\n+                    return;\n+                case FAILED:\n+                    LOGGER.error(\"Failed to sync cloud identity, envCrn = {}\", envCrn);\n+                    warnings.accept(envCrn, \"Failed to sync cloud identity into environment\");\n+                    return;\n+                default:\n+                    LOGGER.info(\"Sync is in progress, retrying\");\n+                    try {\n+                        Thread.sleep(SYNC_SLEEP_INTERVAL_MS);\n+                    } catch (InterruptedException e) {\n+                        LOGGER.error(\"Interrupted during cloud identity sync\", e);\n+                        warnings.accept(envCrn, \"Interrupted during cloud identity sync\");\n+                    }\n+                    long commandId = syncStatus.getCommandId();\n+                    syncStatus = sdxEndpoint.getRangerCloudIdentitySyncStatus(envCrn, commandId);", "originalCommit": "14a4b48e686de672070c89d2d99e94b56e019d78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2MjA4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r464962088", "bodyText": "hmm true, I've moved the check up higher.", "author": "aarman-cloudera", "createdAt": "2020-08-04T10:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgwMTMyOQ=="}], "type": "inlineReview"}, {"oid": "760c649730f994c4098117a4240094557d951e37", "url": "https://github.com/hortonworks/cloudbreak/commit/760c649730f994c4098117a4240094557d951e37", "message": "CDPCP-2673. Poll status of refresh when syncing OIDs\n\nWhen setting cloud identity settings in ranger, the SDX service\nnow also returns a status object that the caller can use to\npoll the status of the sync (which is just the status of the underlying\nCM refresh command). The FreeIPA service polls this object to verify\nthat the sync is successful.\n\nIn order to simplify the design, the cloud identity sync code\nhas been modified to only work for single datalake per environment\nand fail if there are multiple datalakes present (which we currently\ndon't support anyway).", "committedDate": "2020-08-04T10:43:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU2MjM1Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r465562352", "bodyText": "Is it need to be a POST request?", "author": "keyki", "createdAt": "2020-08-05T08:30:23Z", "path": "datalake-api/src/main/java/com/sequenceiq/sdx/api/endpoint/SdxEndpoint.java", "diffHunk": "@@ -202,7 +203,14 @@ SdxDatabaseRestoreStatusResponse getRestoreDatabaseStatusByName(@PathParam(\"name\n     @POST\n     @Path(\"/envcrn/{envCrn}/ranger_cloud_identity_mapping\")\n     @Produces(MediaType.APPLICATION_JSON)\n-    @ApiOperation(value = \"set ranger cloud identity mapping\", produces = MediaType.APPLICATION_JSON, nickname = \"setRangerCloudIdentityMapping\")\n-    void setRangerCloudIdentityMapping(@PathParam(\"envCrn\") @ValidCrn String envCrn, @NotNull @Valid SetRangerCloudIdentityMappingRequest request);\n+    @ApiOperation(value = \"Set ranger cloud identity mapping\", produces = MediaType.APPLICATION_JSON, nickname = \"setRangerCloudIdentityMapping\")\n+    RangerCloudIdentitySyncStatus setRangerCloudIdentityMapping(@PathParam(\"envCrn\") @ValidCrn String envCrn,\n+            @NotNull @Valid SetRangerCloudIdentityMappingRequest request);\n+\n+    @POST", "originalCommit": "760c649730f994c4098117a4240094557d951e37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyNzQwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r467727405", "bodyText": "Your right, changed it to GET", "author": "aarman-cloudera", "createdAt": "2020-08-10T07:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU2MjM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU2OTg5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r465569897", "bodyText": "Can you please remove the default values from here? The application.yml already contains them.", "author": "keyki", "createdAt": "2020-08-05T08:43:37Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/configuration/CloudIdSyncConfig.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package com.sequenceiq.freeipa.configuration;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class CloudIdSyncConfig {\n+\n+    @Value(\"${freeipa.cloudidsync.poller.timeoutMs:4000}\")", "originalCommit": "760c649730f994c4098117a4240094557d951e37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU3Mjk4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r465572982", "bodyText": "This method is not used anywhere.", "author": "keyki", "createdAt": "2020-08-05T08:48:54Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java", "diffHunk": "@@ -165,6 +165,17 @@ public SdxCluster getByCrn(String userCrn, String clusterCrn) {\n         }\n     }\n \n+    public SdxCluster getByClusterCrn(String clusterCrn) {", "originalCommit": "760c649730f994c4098117a4240094557d951e37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU3Nzg0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r465577844", "bodyText": "Instead of writing another polling method, we should use the one that we already have. Example: https://github.com/hortonworks/cloudbreak/blob/master/freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/ClusterProxyService.java#L296", "author": "keyki", "createdAt": "2020-08-05T08:57:18Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/CloudIdentitySyncService.java", "diffHunk": "@@ -48,16 +58,59 @@ private void syncAzureObjectIds(Stack stack, UmsUsersState umsUsersState, BiCons\n \n             SetRangerCloudIdentityMappingRequest setRangerCloudIdentityMappingRequest = new SetRangerCloudIdentityMappingRequest();\n             setRangerCloudIdentityMappingRequest.setAzureUserMapping(userToAzureObjectIdMap);\n-            // TODO The SDX endpoint currently sets the config and triggers refresh. The SDX endpoint should also be updated\n-            //      to allow polling the status of the refresh.\n+\n             LOGGER.debug(\"Setting ranger cloud identity mapping: {}\", setRangerCloudIdentityMappingRequest);\n-            sdxEndpoint.setRangerCloudIdentityMapping(envCrn, setRangerCloudIdentityMappingRequest);\n+            RangerCloudIdentitySyncStatus syncStatus = sdxEndpoint.setRangerCloudIdentityMapping(envCrn, setRangerCloudIdentityMappingRequest);\n+\n+            // The sync status represents a cloud identity sync that may still be in progress, which we need to poll to check for completion.\n+            pollSyncStatus(syncStatus, envCrn, warnings);\n         } catch (Exception e) {\n             LOGGER.warn(\"Failed to set cloud identity mapping for environment {}\", envCrn, e);\n             warnings.accept(envCrn, \"Failed to set cloud identity mapping\");\n         }\n     }\n \n+    private void pollSyncStatus(RangerCloudIdentitySyncStatus syncStatus, String envCrn, BiConsumer<String, String> warnings) {", "originalCommit": "760c649730f994c4098117a4240094557d951e37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyNzc1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8656#discussion_r467727750", "bodyText": "Thanks, didn't know about that one, I've moved to using it.", "author": "aarman-cloudera", "createdAt": "2020-08-10T07:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU3Nzg0NA=="}], "type": "inlineReview"}, {"oid": "5542425d709ef10783a8b0b59503d641633f64c6", "url": "https://github.com/hortonworks/cloudbreak/commit/5542425d709ef10783a8b0b59503d641633f64c6", "message": "CDPCP-2673. Poll status of refresh when syncing OIDs\n\nWhen setting cloud identity settings in ranger, the SDX service\nnow also returns a status object that the caller can use to\npoll the status of the sync (which is just the status of the underlying\nCM refresh command). The FreeIPA service polls this object to verify\nthat the sync is successful.\n\nIn order to simplify the design, the cloud identity sync code\nhas been modified to only work for single datalake per environment\nand fail if there are multiple datalakes present (which we currently\ndon't support anyway).", "committedDate": "2020-08-10T07:26:44Z", "type": "forcePushed"}, {"oid": "e18ffe9b3126c0da2f2cf7d7f1f78a639351ab37", "url": "https://github.com/hortonworks/cloudbreak/commit/e18ffe9b3126c0da2f2cf7d7f1f78a639351ab37", "message": "CDPCP-2673. Poll status of refresh when syncing OIDs\n\nWhen setting cloud identity settings in ranger, the SDX service\nnow also returns a status object that the caller can use to\npoll the status of the sync (which is just the status of the underlying\nCM refresh command). The FreeIPA service polls this object to verify\nthat the sync is successful.\n\nIn order to simplify the design, the cloud identity sync code\nhas been modified to only work for single datalake per environment\nand fail if there are multiple datalakes present (which we currently\ndon't support anyway).", "committedDate": "2020-08-12T18:46:07Z", "type": "commit"}, {"oid": "e18ffe9b3126c0da2f2cf7d7f1f78a639351ab37", "url": "https://github.com/hortonworks/cloudbreak/commit/e18ffe9b3126c0da2f2cf7d7f1f78a639351ab37", "message": "CDPCP-2673. Poll status of refresh when syncing OIDs\n\nWhen setting cloud identity settings in ranger, the SDX service\nnow also returns a status object that the caller can use to\npoll the status of the sync (which is just the status of the underlying\nCM refresh command). The FreeIPA service polls this object to verify\nthat the sync is successful.\n\nIn order to simplify the design, the cloud identity sync code\nhas been modified to only work for single datalake per environment\nand fail if there are multiple datalakes present (which we currently\ndon't support anyway).", "committedDate": "2020-08-12T18:46:07Z", "type": "forcePushed"}]}