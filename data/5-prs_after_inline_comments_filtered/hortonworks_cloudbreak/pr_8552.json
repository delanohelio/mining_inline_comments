{"pr_number": 8552, "pr_title": "Introduce Audit credential", "pr_createdAt": "2020-07-14T16:19:26Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8552", "timeline": [{"oid": "39d7af5b94b99b1b38549c0be2f56e21ca47542a", "url": "https://github.com/hortonworks/cloudbreak/commit/39d7af5b94b99b1b38549c0be2f56e21ca47542a", "message": "CB-7523 audit credential added", "committedDate": "2020-07-14T22:03:12Z", "type": "forcePushed"}, {"oid": "5fd7d23f4b3c3c704d5a7da92f6659febbabcb61", "url": "https://github.com/hortonworks/cloudbreak/commit/5fd7d23f4b3c3c704d5a7da92f6659febbabcb61", "message": "CB-7523 audit credential added", "committedDate": "2020-07-15T09:01:59Z", "type": "forcePushed"}, {"oid": "ac2b5c0a64ebe274c685ebcabe50f6d8aad3be9a", "url": "https://github.com/hortonworks/cloudbreak/commit/ac2b5c0a64ebe274c685ebcabe50f6d8aad3be9a", "message": "CB-7523 audit credential added", "committedDate": "2020-07-15T09:54:36Z", "type": "forcePushed"}, {"oid": "cacef9135d4f7cd3f7ee89044d055015e36ab8a6", "url": "https://github.com/hortonworks/cloudbreak/commit/cacef9135d4f7cd3f7ee89044d055015e36ab8a6", "message": "CB-7523 audit credential added\n\nNew field was intrudoced which is type on the credential domain this will clearly separate AUDIT and ENVIRONMENT credentials. New controller layer added as well just to clearly separate the two type of credential.", "committedDate": "2020-07-15T10:00:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0NDM3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8552#discussion_r454944372", "bodyText": "this should be authorized against the existing credential resource, not on account level\nto do that:\n\nadd @CheckPermissionByResourceObject to the method\nadd @ResourceObject to the credentialrequest parameter (it is there as i see)\nadd @ResourceObjectField(action = AuthorizationResourceAction.EDIT_CREDENTIAL, variableType = AuthorizationVariableType.NAME) to the name field of the CredentialRequest class (I think this is done too since it is the same class as used in other crednetial controller)\n\nso I think the method annotation should be changed only", "author": "horadla23", "createdAt": "2020-07-15T10:14:32Z", "path": "environment/src/main/java/com/sequenceiq/environment/credential/v1/AuditCredentialV1Controller.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.sequenceiq.environment.credential.v1;\n+\n+import static com.sequenceiq.common.model.CredentialType.AUDIT;\n+import static com.sequenceiq.common.model.CredentialType.onlyAudit;\n+\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.validation.Valid;\n+\n+import org.springframework.stereotype.Controller;\n+\n+import com.sequenceiq.authorization.annotation.AuthorizationResource;\n+import com.sequenceiq.authorization.annotation.CheckPermissionByAccount;\n+import com.sequenceiq.authorization.annotation.CheckPermissionByResourceCrn;\n+import com.sequenceiq.authorization.annotation.FilterListBasedOnPermissions;\n+import com.sequenceiq.authorization.annotation.ResourceCrn;\n+import com.sequenceiq.authorization.annotation.ResourceObject;\n+import com.sequenceiq.authorization.resource.AuthorizationResourceAction;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.auth.security.internal.InternalReady;\n+import com.sequenceiq.cloudbreak.auth.security.internal.TenantAwareParam;\n+import com.sequenceiq.cloudbreak.cloud.response.CredentialPrerequisitesResponse;\n+import com.sequenceiq.cloudbreak.event.ResourceEvent;\n+import com.sequenceiq.cloudbreak.exception.BadRequestException;\n+import com.sequenceiq.common.model.CredentialType;\n+import com.sequenceiq.environment.api.v1.credential.endpoint.AuditCredentialEndpoint;\n+import com.sequenceiq.environment.api.v1.credential.model.request.CredentialRequest;\n+import com.sequenceiq.environment.api.v1.credential.model.response.CredentialResponse;\n+import com.sequenceiq.environment.api.v1.credential.model.response.CredentialResponses;\n+import com.sequenceiq.environment.credential.domain.Credential;\n+import com.sequenceiq.environment.credential.service.CredentialService;\n+import com.sequenceiq.environment.credential.v1.converter.CredentialToCredentialV1ResponseConverter;\n+import com.sequenceiq.notification.NotificationController;\n+\n+@Controller\n+@InternalReady\n+@AuthorizationResource\n+public class AuditCredentialV1Controller extends NotificationController implements AuditCredentialEndpoint {\n+\n+    private final CredentialService credentialService;\n+\n+    private final CredentialToCredentialV1ResponseConverter credentialConverter;\n+\n+    public AuditCredentialV1Controller(\n+            CredentialService credentialService,\n+            CredentialToCredentialV1ResponseConverter credentialConverter) {\n+        this.credentialService = credentialService;\n+        this.credentialConverter = credentialConverter;\n+    }\n+\n+    @Override\n+    @FilterListBasedOnPermissions(action = AuthorizationResourceAction.DESCRIBE_CREDENTIAL)\n+    public CredentialResponses list() {\n+        String accountId = ThreadBasedUserCrnProvider.getAccountId();\n+        return new CredentialResponses(\n+                credentialService.listAvailablesByAccountId(accountId, onlyAudit())\n+                        .stream()\n+                        .map(credentialConverter::convert)\n+                        .collect(Collectors.toSet()));\n+    }\n+\n+    @Override\n+    @CheckPermissionByResourceCrn(action = AuthorizationResourceAction.DESCRIBE_CREDENTIAL)\n+    public CredentialResponse getByResourceCrn(@TenantAwareParam @ResourceCrn String credentialCrn) {\n+        String accountId = ThreadBasedUserCrnProvider.getAccountId();\n+        return credentialConverter.convert(credentialService.getByCrnForAccountId(credentialCrn, accountId, onlyAudit()));\n+    }\n+\n+    @Override\n+    @CheckPermissionByAccount(action = AuthorizationResourceAction.CREATE_CREDENTIAL)\n+    public CredentialResponse post(@Valid CredentialRequest request) {\n+        String accountId = ThreadBasedUserCrnProvider.getAccountId();\n+        String creator = ThreadBasedUserCrnProvider.getUserCrn();\n+        Credential credential = credentialConverter.convert(request);\n+        credential.setType(AUDIT);\n+        notify(ResourceEvent.CREDENTIAL_CREATED);\n+        Set<Credential> auditCredentialsByPlatfom = credentialService\n+                .listAvailablesByAccountId(accountId, onlyAudit())\n+                .stream()\n+                .filter(c -> c.getCloudPlatform().equals(credential.getCloudPlatform()))\n+                .collect(Collectors.toSet());\n+        if (auditCredentialsByPlatfom.isEmpty()) {\n+            return credentialConverter.convert(credentialService.create(credential, accountId, creator, onlyAudit()));\n+        } else {\n+            throw new BadRequestException(String.format(\"Audit credential already exist for %s cloud.\", credential.getCloudPlatform()));\n+        }\n+    }\n+\n+    @Override\n+    @CheckPermissionByAccount(action = AuthorizationResourceAction.CREATE_CREDENTIAL)\n+    public CredentialResponse put(@ResourceObject @Valid CredentialRequest credentialRequest) {", "originalCommit": "cacef9135d4f7cd3f7ee89044d055015e36ab8a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9128be1009bfd915c5cabf000cb6cf62f5fabd74", "url": "https://github.com/hortonworks/cloudbreak/commit/9128be1009bfd915c5cabf000cb6cf62f5fabd74", "message": "CB-7523 audit credential added\n\nNew field was intrudoced which is type on the credential domain this will clearly separate AUDIT and ENVIRONMENT credentials. New controller layer added as well just to clearly separate the two type of credential.", "committedDate": "2020-07-15T19:34:40Z", "type": "forcePushed"}, {"oid": "fc23f28252d21896636d7f47128a488f2e28122f", "url": "https://github.com/hortonworks/cloudbreak/commit/fc23f28252d21896636d7f47128a488f2e28122f", "message": "CB-7523 audit credential added\n\nAudit credential was introduced. New Credential field on the domain which is type. It can be AUDIT or ENVIRONMENT and only account admin can create AUDIT credential and modify it. This credential only used for archive audit data into the customer account", "committedDate": "2020-07-16T07:40:30Z", "type": "forcePushed"}, {"oid": "5f9105bc2addb37479ef68ce0c9169d46e59372b", "url": "https://github.com/hortonworks/cloudbreak/commit/5f9105bc2addb37479ef68ce0c9169d46e59372b", "message": "CB-7523 audit credential added\n\nAudit credential was introduced. New Credential field on the domain which is type. It can be AUDIT or ENVIRONMENT and only account admin can create AUDIT credential and modify it. This credential only used for archive audit data into the customer account", "committedDate": "2020-07-16T13:27:52Z", "type": "forcePushed"}, {"oid": "f616249502fa45b6478d8aa1a2d53245b15cfc64", "url": "https://github.com/hortonworks/cloudbreak/commit/f616249502fa45b6478d8aa1a2d53245b15cfc64", "message": "CB-7523 audit credential added\n\nAudit credential was introduced. New Credential field on the domain which is type. It can be AUDIT or ENVIRONMENT and only account admin can create AUDIT credential and modify it. This credential only used for archive audit data into the customer account", "committedDate": "2020-07-16T15:01:57Z", "type": "forcePushed"}, {"oid": "e51f0b31ba75179b6ae3ebf450922fb5227b2d20", "url": "https://github.com/hortonworks/cloudbreak/commit/e51f0b31ba75179b6ae3ebf450922fb5227b2d20", "message": "CB-7523 audit credential added\n\nAudit credential was introduced. New Credential field on the domain which is type. It can be AUDIT or ENVIRONMENT and only account admin can create AUDIT credential and modify it. This credential only used for archive audit data into the customer account", "committedDate": "2020-07-17T06:44:44Z", "type": "forcePushed"}, {"oid": "23f656d1699ed4a377c10a0e6b023050985ce2f4", "url": "https://github.com/hortonworks/cloudbreak/commit/23f656d1699ed4a377c10a0e6b023050985ce2f4", "message": "CB-7523 audit credential added\n\nAudit credential was introduced. New Credential field on the domain which is type. It can be AUDIT or ENVIRONMENT and only account admin can create AUDIT credential and modify it. This credential only used for archive audit data into the customer account", "committedDate": "2020-07-17T09:33:57Z", "type": "forcePushed"}, {"oid": "5fc97a22ba4cb02c9ff645fc4b68cec00df1c3f4", "url": "https://github.com/hortonworks/cloudbreak/commit/5fc97a22ba4cb02c9ff645fc4b68cec00df1c3f4", "message": "CB-7523 audit credential added\n\nAudit credential was introduced. New Credential field on the domain which is type. It can be AUDIT or ENVIRONMENT and only account admin can create AUDIT credential and modify it. This credential only used for archive audit data into the customer account", "committedDate": "2020-07-17T10:21:44Z", "type": "forcePushed"}, {"oid": "c9fc5950eab5ff85736e37399fb114a4d61fbc96", "url": "https://github.com/hortonworks/cloudbreak/commit/c9fc5950eab5ff85736e37399fb114a4d61fbc96", "message": "CB-7523 audit credential added\n\nAudit credential was introduced. New Credential field on the domain which is type. It can be AUDIT or ENVIRONMENT and only account admin can create AUDIT credential and modify it. This credential only used for archive audit data into the customer account", "committedDate": "2020-07-17T12:36:31Z", "type": "commit"}, {"oid": "c9fc5950eab5ff85736e37399fb114a4d61fbc96", "url": "https://github.com/hortonworks/cloudbreak/commit/c9fc5950eab5ff85736e37399fb114a4d61fbc96", "message": "CB-7523 audit credential added\n\nAudit credential was introduced. New Credential field on the domain which is type. It can be AUDIT or ENVIRONMENT and only account admin can create AUDIT credential and modify it. This credential only used for archive audit data into the customer account", "committedDate": "2020-07-17T12:36:31Z", "type": "forcePushed"}]}