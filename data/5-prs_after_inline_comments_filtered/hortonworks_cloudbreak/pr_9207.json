{"pr_number": 9207, "pr_title": "CB-8867 - Env service should create private DNS zone privatelink.post\u2026", "pr_createdAt": "2020-10-12T19:25:44Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9207", "timeline": [{"oid": "81c0e63145c030f2d230d7a691ec5a6af83b7328", "url": "https://github.com/hortonworks/cloudbreak/commit/81c0e63145c030f2d230d7a691ec5a6af83b7328", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-12T19:56:19Z", "type": "forcePushed"}, {"oid": "aa4cd37827ee6d1dbe4037782eecb4634fa69629", "url": "https://github.com/hortonworks/cloudbreak/commit/aa4cd37827ee6d1dbe4037782eecb4634fa69629", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-12T20:02:41Z", "type": "forcePushed"}, {"oid": "829646ebfe217237e20f2bd09f8322f8009b5006", "url": "https://github.com/hortonworks/cloudbreak/commit/829646ebfe217237e20f2bd09f8322f8009b5006", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-12T20:47:00Z", "type": "forcePushed"}, {"oid": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "url": "https://github.com/hortonworks/cloudbreak/commit/7460cceea835605e2cf2d5e1ba749ae119d1581d", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-12T21:27:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzcyMzU1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503723555", "bodyText": "I think we have such exception in our code as well", "author": "doktoric", "createdAt": "2020-10-13T07:25:48Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/DefaultNetworkConnector.java", "diffHunk": "@@ -39,6 +41,11 @@ default SubnetSelectionResult chooseSubnets(Collection<CloudSubnet> subnetMetas,\n         return subnetSelectionResult;\n     }\n \n+    @Override\n+    default void createProviderSpecificNetworkResources(ProviderSpecificNetworkResourcesCreationRequest providerSpecificNetworkResourcesCreationRequest) {\n+        throw new NotImplementedException(\"No cloud provider specific resources exist on this cloud platform!\");", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMjM0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503802346", "bodyText": "privatednsManager - > PrivateDnsManager", "author": "doktoric", "createdAt": "2020-10-13T09:25:56Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "diffHunk": "@@ -90,13 +97,16 @@\n \n     private final Azure azure;\n \n+    private final privatednsManager privatednsManager;", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzMzA0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503833044", "bodyText": "This is an Azure internal class, with its own naming.", "author": "pdarvasi", "createdAt": "2020-10-13T10:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMjM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc5NjgyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503796828", "bodyText": "if you would create a NOOP method here, then in NetworkCreationHandler#createProviderSpecificNetworkResourcesIfNeeded you don't have to make a cloud provider check", "author": "lacikaaa", "createdAt": "2020-10-13T09:17:52Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/DefaultNetworkConnector.java", "diffHunk": "@@ -39,6 +41,11 @@ default SubnetSelectionResult chooseSubnets(Collection<CloudSubnet> subnetMetas,\n         return subnetSelectionResult;\n     }\n \n+    @Override\n+    default void createProviderSpecificNetworkResources(ProviderSpecificNetworkResourcesCreationRequest providerSpecificNetworkResourcesCreationRequest) {\n+        throw new NotImplementedException(\"No cloud provider specific resources exist on this cloud platform!\");", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMDMxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503800314", "bodyText": "nit: a bit shorter name would be nice, like NetworkResourcesCreationRequest or CloudNetworkResourcesCreationRequest", "author": "lacikaaa", "createdAt": "2020-10-13T09:23:07Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/network/ProviderSpecificNetworkResourcesCreationRequest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.sequenceiq.cloudbreak.cloud.model.network;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import com.sequenceiq.cloudbreak.cloud.context.CloudContext;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n+import com.sequenceiq.cloudbreak.cloud.model.Region;\n+\n+public class ProviderSpecificNetworkResourcesCreationRequest {", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMDkzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503800930", "bodyText": "this field name is not in sync with the original field", "author": "lacikaaa", "createdAt": "2020-10-13T09:24:03Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/network/ProviderSpecificNetworkResourcesCreationRequest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.sequenceiq.cloudbreak.cloud.model.network;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import com.sequenceiq.cloudbreak.cloud.context.CloudContext;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudCredential;\n+import com.sequenceiq.cloudbreak.cloud.model.Region;\n+\n+public class ProviderSpecificNetworkResourcesCreationRequest {\n+\n+    private final String networkId;\n+\n+    private final String networkResourceGroup;\n+\n+    private final boolean existingNetwork;\n+\n+    private final CloudCredential cloudCredential;\n+\n+    private final CloudContext cloudContext;\n+\n+    private final Region region;\n+\n+    private final String resourceGroup;\n+\n+    private final boolean privateEndpointsEnabled;\n+\n+    private final Map<String, String> tags;\n+\n+    private ProviderSpecificNetworkResourcesCreationRequest(Builder builder) {\n+        networkId = builder.networkId;\n+        networkResourceGroup = builder.networkResourceGroup;\n+        existingNetwork = builder.existingNetwork;\n+        cloudCredential = builder.cloudCredential;\n+        cloudContext = builder.cloudContext;\n+        region = builder.region;\n+        resourceGroup = builder.resourceGroup;\n+        privateEndpointsEnabled = builder.serviceEndpointsEnabled;\n+        tags = builder.tags;\n+    }\n+\n+    public String getNetworkId() {\n+        return networkId;\n+    }\n+\n+    public String getNetworkResourceGroup() {\n+        return networkResourceGroup;\n+    }\n+\n+    public boolean isExistingNetwork() {\n+        return existingNetwork;\n+    }\n+\n+    public CloudCredential getCloudCredential() {\n+        return cloudCredential;\n+    }\n+\n+    public CloudContext getCloudContext() {\n+        return cloudContext;\n+    }\n+\n+    public Region getRegion() {\n+        return region;\n+    }\n+\n+    public String getResourceGroup() {\n+        return resourceGroup;\n+    }\n+\n+    public boolean isPrivateEndpointsEnabled() {\n+        return privateEndpointsEnabled;\n+    }\n+\n+    public Map<String, String> getTags() {\n+        return tags;\n+    }\n+\n+    public static class Builder {\n+\n+        private String networkId;\n+\n+        private String networkResourceGroup;\n+\n+        private boolean existingNetwork;\n+\n+        private CloudCredential cloudCredential;\n+\n+        private CloudContext cloudContext;\n+\n+        private Region region;\n+\n+        private String resourceGroup;\n+\n+        private boolean serviceEndpointsEnabled;", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgxMjkxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503812919", "bodyText": "where do you set this to FAILED? I see the next step is a polling.", "author": "lacikaaa", "createdAt": "2020-10-13T09:41:42Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudError;\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss:SSS\");\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void checkOrCreateDnsZonesAndNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n+\n+        boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String dnsZoneDeploymentId = getDnsZoneDeploymentId(resourceGroup, azureClient, deploymentName);\n+\n+        if (dnsZonesDeployed && networkLinksDeployed) {\n+            LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+        } else if (!dnsZonesDeployed) {\n+            LOGGER.debug(\"Dns zones are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            if (isRequested(dnsZoneDeploymentId)) {\n+                LOGGER.debug(\"Dns zones ({}) already requested in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                        enabledPrivateEndpointServices);\n+                if (!networkLinksDeployed) {\n+                    LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+                    createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                }\n+            } else {\n+                try {\n+                    LOGGER.debug(\"Dns zones ({}) are not requested yet in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                    if (isCreated(dnsZoneDeploymentId)) {\n+                        LOGGER.debug(\"Dns zone deployment ({}) is there in database but not deployed on Azure, resetting it..\", dnsZoneDeploymentId);\n+                        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.REQUESTED);\n+                    } else {\n+                        persistDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId);\n+                    }\n+\n+                    createDnsZonesAndNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                    updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.CREATED);\n+\n+                } catch (CloudException | DataAccessException e) {\n+                    LOGGER.warn(\"Deployment failed due to {}, setting the resource status of {} to FAILED\", e.getMessage(), deploymentName);", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgyMDIzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503820236", "bodyText": "this part not covered with unit test", "author": "lacikaaa", "createdAt": "2020-10-13T09:52:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgxMjkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDUxMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r504544511", "bodyText": "I'm still not getting it from the code why is a polling here", "author": "lacikaaa", "createdAt": "2020-10-14T09:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgxMjkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0OTA3NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r504549075", "bodyText": "Because DataAccessException comes when the unique key for a resource is violated - meaning the same DNS Zone is meant to be inserted multiple times. In that case, the second entry waits for the poller to complete the deployment of the first entry.", "author": "pdarvasi", "createdAt": "2020-10-14T09:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgxMjkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgyNDc3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503824770", "bodyText": "this method is hard to follow and pretty complex\nmy suggestion is to create 2 new classes:\n\nDnsZoneDeploymentService: responsible for creating the DNS Zone if it's missing, or just wait for it to finish, etc\nNetworkLinkDepleymentService: add/create network links to the zone. I think if we reach this we can be sure we have the DNS zone deployed\n\nAfter this refactor you could get rid of:\n\nif (dnsZonesDeployed && networkLinksDeployed) as subclasses would check if they have to do anything\ncreateDnsZonesAndNetworkLinks as it would be always 2 separate steps", "author": "lacikaaa", "createdAt": "2020-10-13T10:00:12Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudError;\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss:SSS\");\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void checkOrCreateDnsZonesAndNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0Njc0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r504546747", "bodyText": "I think these 2 don't belong to the same class as they are completely different things.\nAlso the new method names: getOrCreate is misleading as the methods don't return anything", "author": "lacikaaa", "createdAt": "2020-10-14T09:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgyNDc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgyNTk0NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503825945", "bodyText": "networkId here is always null", "author": "lacikaaa", "createdAt": "2020-10-13T10:02:05Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudError;\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss:SSS\");\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void checkOrCreateDnsZonesAndNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n+\n+        boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String dnsZoneDeploymentId = getDnsZoneDeploymentId(resourceGroup, azureClient, deploymentName);\n+\n+        if (dnsZonesDeployed && networkLinksDeployed) {\n+            LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+        } else if (!dnsZonesDeployed) {\n+            LOGGER.debug(\"Dns zones are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            if (isRequested(dnsZoneDeploymentId)) {\n+                LOGGER.debug(\"Dns zones ({}) already requested in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                        enabledPrivateEndpointServices);\n+                if (!networkLinksDeployed) {\n+                    LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+                    createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                }\n+            } else {\n+                try {\n+                    LOGGER.debug(\"Dns zones ({}) are not requested yet in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                    if (isCreated(dnsZoneDeploymentId)) {\n+                        LOGGER.debug(\"Dns zone deployment ({}) is there in database but not deployed on Azure, resetting it..\", dnsZoneDeploymentId);\n+                        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.REQUESTED);\n+                    } else {\n+                        persistDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId);\n+                    }\n+\n+                    createDnsZonesAndNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                    updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.CREATED);\n+\n+                } catch (CloudException | DataAccessException e) {\n+                    LOGGER.warn(\"Deployment failed due to {}, setting the resource status of {} to FAILED\", e.getMessage(), deploymentName);\n+                    pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                            enabledPrivateEndpointServices);\n+                }\n+            }\n+        } else {\n+            LOGGER.debug(\"Network links are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+        }\n+    }\n+\n+    private void pollForCreation(AuthenticatedContext authenticatedContext, AzureClient azureClient, String resourceGroup, String deploymentName,\n+            String dnsZoneDeploymentId, String networkId, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzMzM5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503833395", "bodyText": "this seems unnecessary, logging framework adds timestamp to every line", "author": "lacikaaa", "createdAt": "2020-10-13T10:14:45Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudError;\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss:SSS\");\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void checkOrCreateDnsZonesAndNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n+\n+        boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String dnsZoneDeploymentId = getDnsZoneDeploymentId(resourceGroup, azureClient, deploymentName);\n+\n+        if (dnsZonesDeployed && networkLinksDeployed) {\n+            LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+        } else if (!dnsZonesDeployed) {\n+            LOGGER.debug(\"Dns zones are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            if (isRequested(dnsZoneDeploymentId)) {\n+                LOGGER.debug(\"Dns zones ({}) already requested in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                        enabledPrivateEndpointServices);\n+                if (!networkLinksDeployed) {\n+                    LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+                    createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                }\n+            } else {\n+                try {\n+                    LOGGER.debug(\"Dns zones ({}) are not requested yet in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                    if (isCreated(dnsZoneDeploymentId)) {\n+                        LOGGER.debug(\"Dns zone deployment ({}) is there in database but not deployed on Azure, resetting it..\", dnsZoneDeploymentId);\n+                        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.REQUESTED);\n+                    } else {\n+                        persistDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId);\n+                    }\n+\n+                    createDnsZonesAndNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                    updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.CREATED);\n+\n+                } catch (CloudException | DataAccessException e) {\n+                    LOGGER.warn(\"Deployment failed due to {}, setting the resource status of {} to FAILED\", e.getMessage(), deploymentName);\n+                    pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                            enabledPrivateEndpointServices);\n+                }\n+            }\n+        } else {\n+            LOGGER.debug(\"Network links are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+        }\n+    }\n+\n+    private void pollForCreation(AuthenticatedContext authenticatedContext, AzureClient azureClient, String resourceGroup, String deploymentName,\n+            String dnsZoneDeploymentId, String networkId, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        AzureDnsZoneCreationCheckerContext checkerContext = new AzureDnsZoneCreationCheckerContext(azureClient,\n+                resourceGroup,\n+                deploymentName,\n+                networkId,\n+                enabledPrivateEndpointServices);\n+        azureDnsZoneCreationPoller.startPolling(authenticatedContext, checkerContext);\n+        CommonStatus deploymentStatus = azureClient.getTemplateDeploymentCommonStatus(resourceGroup, deploymentName);\n+        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, deploymentStatus);\n+    }\n+\n+    private void createDnsZonesAndNetworkLinks(AzureClient azureClient, String azureNetworkId, String resourceGroup,\n+            Map<String, String> tags, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        AzureDnsZoneDeploymentParameters parameters = new AzureDnsZoneDeploymentParameters(azureNetworkId,\n+                false,\n+                enabledPrivateEndpointServices,\n+                resourceGroup,\n+                tags);\n+        deployTemplate(azureClient, parameters);\n+    }\n+\n+    private Network getAzureNetwork(AzureClient azureClient, String networkId, String networkResourceGroup) {\n+        Network azureNetwork = azureClient.getNetworkByResourceGroup(networkResourceGroup, networkId);\n+        if (Objects.isNull(azureNetwork)) {\n+            throw new CloudConnectorException(String.format(\"Azure network id lookup failed with network id %s in resource group %s\", networkId,\n+                    networkResourceGroup));\n+        }\n+        return azureNetwork;\n+    }\n+\n+    private void createMissingNetworkLinks(AzureClient azureClient, String azureNetworkId, String resourceGroup,\n+            Map<String, String> tags, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        for (AzurePrivateDnsZoneServiceEnum service: enabledPrivateEndpointServices) {\n+            PagedList<VirtualNetworkLinkInner> networkLinks = azureClient.listNetworkLinksByPrivateDnsZoneName(resourceGroup, service.getDnsZoneName());\n+            boolean networkLinkCreated = azureClient.isNetworkLinkCreated(StringUtils.substringAfterLast(azureNetworkId, \"/\"), networkLinks);\n+            if (!networkLinkCreated) {\n+                LOGGER.debug(\"Network links for service {} not yet created, creating them now\", service.getSubResource());\n+                AzureDnsZoneDeploymentParameters parameters = new AzureDnsZoneDeploymentParameters(azureNetworkId,\n+                        true,\n+                        enabledPrivateEndpointServices,\n+                        resourceGroup,\n+                        tags);\n+                deployTemplate(azureClient, parameters);\n+            }\n+        }\n+    }\n+\n+    private List<AzurePrivateDnsZoneServiceEnum> getEnabledPrivateEndpointServices() {\n+        return privateEndpointServices.stream()\n+                .map(AzurePrivateDnsZoneServiceEnum::getBySubResource)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private void deployTemplate(AzureClient azureClient, AzureDnsZoneDeploymentParameters parameters) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = parameters.getEnabledPrivateEndpointServices();\n+        String resourceGroup = parameters.getResourceGroupName();\n+\n+        LOGGER.debug(\"Deploying Private DNS Zones and applying network link for services {}\",\n+                enabledPrivateEndpointServices.stream().map(AzurePrivateDnsZoneServiceEnum::getSubResource).collect(Collectors.toList()));\n+        String networkId = StringUtils.substringAfterLast(parameters.getNetworkId(), \"/\");\n+        String suffix = parameters.getDeployOnlyNetworkLinks() ? \"-\" + networkId + NETWORK_LINKS : DNS_ZONES;\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, suffix);\n+\n+        try {\n+            if (azureClient.templateDeploymentExists(resourceGroup, deploymentName)) {\n+                LOGGER.debug(\"Deleting already existing deployment {}\", deploymentName);\n+                azureClient.deleteTemplateDeployment(resourceGroup, deploymentName);\n+            }\n+            String template = azureNetworkDnsZoneTemplateBuilder.build(parameters);\n+            String parametersMapAsString = new Json(Map.of()).getValue();\n+            if (azureClient.getTemplateDeploymentStatus(resourceGroup, deploymentName).isTransient()) {\n+                throw new CloudConnectorException(String.format(\n+                        \"Not finished template deployment with name %s already exists in resource group %s\", deploymentName, resourceGroup));\n+            } else {\n+                LocalDateTime now = LocalDateTime.now();\n+                LOGGER.debug(\"Creating deployment {}\", DTF.format(now));\n+                azureClient.createTemplateDeployment(resourceGroup, deploymentName, template, parametersMapAsString);\n+            }\n+        } catch (CloudException e) {\n+            LOGGER.info(\"Provisioning error, cloud exception happened: \", e);\n+            if (e.body() != null && e.body().details() != null) {\n+                String details = e.body().details().stream().map(CloudError::message).collect(Collectors.joining(\", \"));\n+                throw new CloudConnectorException(String.format(\"Template provisioning failed, status code %s, error message: %s, details: %s\",\n+                        e.body().code(), e.body().message(), details));\n+            } else {\n+                throw new CloudConnectorException(String.format(\"Template provisioning failed: '%s', please go to Azure Portal for detailed message\", e));\n+            }\n+        } catch (Exception e) {\n+            LOGGER.warn(\"Provisioning error:\", e);\n+            throw new CloudConnectorException(String.format(\"Error in provisioning network dns zone template %s: %s\",\n+                    deploymentName, e.getMessage()));\n+        }\n+    }\n+\n+    private String generateDnsZoneDeploymentName(List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices, String suffix) {\n+        String fullDeploymentName = enabledPrivateEndpointServices.stream()\n+                .map(AzurePrivateDnsZoneServiceEnum::getSubResource)\n+                .collect(Collectors.joining(\"-\", \"\", suffix))\n+                .toLowerCase();\n+        String deploymentName = StringUtils.left(fullDeploymentName, DEPLOYMENT_LENGTH_LIMIT);\n+        LOGGER.debug(\"Generated deployment name {}\", deploymentName);\n+        return deploymentName;\n+    }\n+\n+    private String getDnsZoneDeploymentId(String resourceGroup, AzureClient client, String deploymentName) {\n+        return azureResourceIdProviderService.generateDnsZoneDeploymentId(client.getCurrentSubscription()\n+                .subscriptionId(), resourceGroup, deploymentName);\n+    }\n+\n+    private boolean isRequested(String dnsZoneDeploymentId) {\n+        return findDnsZoneDeploymentByStatus(dnsZoneDeploymentId, CommonStatus.REQUESTED).isPresent();\n+    }\n+\n+    private boolean isCreated(String dnsZoneDeploymentId) {\n+        return findDnsZoneDeploymentByStatus(dnsZoneDeploymentId, CommonStatus.CREATED).isPresent();\n+    }\n+\n+    private void persistDnsZone(AuthenticatedContext ac, String deploymentName, String deploymentId) {\n+        LocalDateTime now = LocalDateTime.now();", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzNDQxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503834413", "bodyText": "now is unnecessary here. adding rg name and deployment name would be more helpful", "author": "lacikaaa", "createdAt": "2020-10-13T10:16:28Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudError;\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss:SSS\");\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void checkOrCreateDnsZonesAndNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n+\n+        boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String dnsZoneDeploymentId = getDnsZoneDeploymentId(resourceGroup, azureClient, deploymentName);\n+\n+        if (dnsZonesDeployed && networkLinksDeployed) {\n+            LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+        } else if (!dnsZonesDeployed) {\n+            LOGGER.debug(\"Dns zones are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            if (isRequested(dnsZoneDeploymentId)) {\n+                LOGGER.debug(\"Dns zones ({}) already requested in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                        enabledPrivateEndpointServices);\n+                if (!networkLinksDeployed) {\n+                    LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+                    createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                }\n+            } else {\n+                try {\n+                    LOGGER.debug(\"Dns zones ({}) are not requested yet in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                    if (isCreated(dnsZoneDeploymentId)) {\n+                        LOGGER.debug(\"Dns zone deployment ({}) is there in database but not deployed on Azure, resetting it..\", dnsZoneDeploymentId);\n+                        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.REQUESTED);\n+                    } else {\n+                        persistDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId);\n+                    }\n+\n+                    createDnsZonesAndNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                    updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.CREATED);\n+\n+                } catch (CloudException | DataAccessException e) {\n+                    LOGGER.warn(\"Deployment failed due to {}, setting the resource status of {} to FAILED\", e.getMessage(), deploymentName);\n+                    pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                            enabledPrivateEndpointServices);\n+                }\n+            }\n+        } else {\n+            LOGGER.debug(\"Network links are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+        }\n+    }\n+\n+    private void pollForCreation(AuthenticatedContext authenticatedContext, AzureClient azureClient, String resourceGroup, String deploymentName,\n+            String dnsZoneDeploymentId, String networkId, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        AzureDnsZoneCreationCheckerContext checkerContext = new AzureDnsZoneCreationCheckerContext(azureClient,\n+                resourceGroup,\n+                deploymentName,\n+                networkId,\n+                enabledPrivateEndpointServices);\n+        azureDnsZoneCreationPoller.startPolling(authenticatedContext, checkerContext);\n+        CommonStatus deploymentStatus = azureClient.getTemplateDeploymentCommonStatus(resourceGroup, deploymentName);\n+        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, deploymentStatus);\n+    }\n+\n+    private void createDnsZonesAndNetworkLinks(AzureClient azureClient, String azureNetworkId, String resourceGroup,\n+            Map<String, String> tags, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        AzureDnsZoneDeploymentParameters parameters = new AzureDnsZoneDeploymentParameters(azureNetworkId,\n+                false,\n+                enabledPrivateEndpointServices,\n+                resourceGroup,\n+                tags);\n+        deployTemplate(azureClient, parameters);\n+    }\n+\n+    private Network getAzureNetwork(AzureClient azureClient, String networkId, String networkResourceGroup) {\n+        Network azureNetwork = azureClient.getNetworkByResourceGroup(networkResourceGroup, networkId);\n+        if (Objects.isNull(azureNetwork)) {\n+            throw new CloudConnectorException(String.format(\"Azure network id lookup failed with network id %s in resource group %s\", networkId,\n+                    networkResourceGroup));\n+        }\n+        return azureNetwork;\n+    }\n+\n+    private void createMissingNetworkLinks(AzureClient azureClient, String azureNetworkId, String resourceGroup,\n+            Map<String, String> tags, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        for (AzurePrivateDnsZoneServiceEnum service: enabledPrivateEndpointServices) {\n+            PagedList<VirtualNetworkLinkInner> networkLinks = azureClient.listNetworkLinksByPrivateDnsZoneName(resourceGroup, service.getDnsZoneName());\n+            boolean networkLinkCreated = azureClient.isNetworkLinkCreated(StringUtils.substringAfterLast(azureNetworkId, \"/\"), networkLinks);\n+            if (!networkLinkCreated) {\n+                LOGGER.debug(\"Network links for service {} not yet created, creating them now\", service.getSubResource());\n+                AzureDnsZoneDeploymentParameters parameters = new AzureDnsZoneDeploymentParameters(azureNetworkId,\n+                        true,\n+                        enabledPrivateEndpointServices,\n+                        resourceGroup,\n+                        tags);\n+                deployTemplate(azureClient, parameters);\n+            }\n+        }\n+    }\n+\n+    private List<AzurePrivateDnsZoneServiceEnum> getEnabledPrivateEndpointServices() {\n+        return privateEndpointServices.stream()\n+                .map(AzurePrivateDnsZoneServiceEnum::getBySubResource)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private void deployTemplate(AzureClient azureClient, AzureDnsZoneDeploymentParameters parameters) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = parameters.getEnabledPrivateEndpointServices();\n+        String resourceGroup = parameters.getResourceGroupName();\n+\n+        LOGGER.debug(\"Deploying Private DNS Zones and applying network link for services {}\",\n+                enabledPrivateEndpointServices.stream().map(AzurePrivateDnsZoneServiceEnum::getSubResource).collect(Collectors.toList()));\n+        String networkId = StringUtils.substringAfterLast(parameters.getNetworkId(), \"/\");\n+        String suffix = parameters.getDeployOnlyNetworkLinks() ? \"-\" + networkId + NETWORK_LINKS : DNS_ZONES;\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, suffix);\n+\n+        try {\n+            if (azureClient.templateDeploymentExists(resourceGroup, deploymentName)) {\n+                LOGGER.debug(\"Deleting already existing deployment {}\", deploymentName);\n+                azureClient.deleteTemplateDeployment(resourceGroup, deploymentName);\n+            }\n+            String template = azureNetworkDnsZoneTemplateBuilder.build(parameters);\n+            String parametersMapAsString = new Json(Map.of()).getValue();\n+            if (azureClient.getTemplateDeploymentStatus(resourceGroup, deploymentName).isTransient()) {\n+                throw new CloudConnectorException(String.format(\n+                        \"Not finished template deployment with name %s already exists in resource group %s\", deploymentName, resourceGroup));\n+            } else {\n+                LocalDateTime now = LocalDateTime.now();\n+                LOGGER.debug(\"Creating deployment {}\", DTF.format(now));", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzNDU0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503834548", "bodyText": "this can be dropped", "author": "lacikaaa", "createdAt": "2020-10-13T10:16:43Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudError;\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss:SSS\");", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzNzUwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503837500", "bodyText": "these 2 lines can be moved into generateDnsZoneDeploymentName as the result only used there", "author": "lacikaaa", "createdAt": "2020-10-13T10:21:40Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudError;\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss:SSS\");\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void checkOrCreateDnsZonesAndNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n+\n+        boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String dnsZoneDeploymentId = getDnsZoneDeploymentId(resourceGroup, azureClient, deploymentName);\n+\n+        if (dnsZonesDeployed && networkLinksDeployed) {\n+            LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+        } else if (!dnsZonesDeployed) {\n+            LOGGER.debug(\"Dns zones are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            if (isRequested(dnsZoneDeploymentId)) {\n+                LOGGER.debug(\"Dns zones ({}) already requested in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                        enabledPrivateEndpointServices);\n+                if (!networkLinksDeployed) {\n+                    LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+                    createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                }\n+            } else {\n+                try {\n+                    LOGGER.debug(\"Dns zones ({}) are not requested yet in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                    if (isCreated(dnsZoneDeploymentId)) {\n+                        LOGGER.debug(\"Dns zone deployment ({}) is there in database but not deployed on Azure, resetting it..\", dnsZoneDeploymentId);\n+                        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.REQUESTED);\n+                    } else {\n+                        persistDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId);\n+                    }\n+\n+                    createDnsZonesAndNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                    updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.CREATED);\n+\n+                } catch (CloudException | DataAccessException e) {\n+                    LOGGER.warn(\"Deployment failed due to {}, setting the resource status of {} to FAILED\", e.getMessage(), deploymentName);\n+                    pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                            enabledPrivateEndpointServices);\n+                }\n+            }\n+        } else {\n+            LOGGER.debug(\"Network links are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+        }\n+    }\n+\n+    private void pollForCreation(AuthenticatedContext authenticatedContext, AzureClient azureClient, String resourceGroup, String deploymentName,\n+            String dnsZoneDeploymentId, String networkId, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        AzureDnsZoneCreationCheckerContext checkerContext = new AzureDnsZoneCreationCheckerContext(azureClient,\n+                resourceGroup,\n+                deploymentName,\n+                networkId,\n+                enabledPrivateEndpointServices);\n+        azureDnsZoneCreationPoller.startPolling(authenticatedContext, checkerContext);\n+        CommonStatus deploymentStatus = azureClient.getTemplateDeploymentCommonStatus(resourceGroup, deploymentName);\n+        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, deploymentStatus);\n+    }\n+\n+    private void createDnsZonesAndNetworkLinks(AzureClient azureClient, String azureNetworkId, String resourceGroup,\n+            Map<String, String> tags, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        AzureDnsZoneDeploymentParameters parameters = new AzureDnsZoneDeploymentParameters(azureNetworkId,\n+                false,\n+                enabledPrivateEndpointServices,\n+                resourceGroup,\n+                tags);\n+        deployTemplate(azureClient, parameters);\n+    }\n+\n+    private Network getAzureNetwork(AzureClient azureClient, String networkId, String networkResourceGroup) {\n+        Network azureNetwork = azureClient.getNetworkByResourceGroup(networkResourceGroup, networkId);\n+        if (Objects.isNull(azureNetwork)) {\n+            throw new CloudConnectorException(String.format(\"Azure network id lookup failed with network id %s in resource group %s\", networkId,\n+                    networkResourceGroup));\n+        }\n+        return azureNetwork;\n+    }\n+\n+    private void createMissingNetworkLinks(AzureClient azureClient, String azureNetworkId, String resourceGroup,\n+            Map<String, String> tags, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        for (AzurePrivateDnsZoneServiceEnum service: enabledPrivateEndpointServices) {\n+            PagedList<VirtualNetworkLinkInner> networkLinks = azureClient.listNetworkLinksByPrivateDnsZoneName(resourceGroup, service.getDnsZoneName());\n+            boolean networkLinkCreated = azureClient.isNetworkLinkCreated(StringUtils.substringAfterLast(azureNetworkId, \"/\"), networkLinks);\n+            if (!networkLinkCreated) {\n+                LOGGER.debug(\"Network links for service {} not yet created, creating them now\", service.getSubResource());\n+                AzureDnsZoneDeploymentParameters parameters = new AzureDnsZoneDeploymentParameters(azureNetworkId,\n+                        true,\n+                        enabledPrivateEndpointServices,\n+                        resourceGroup,\n+                        tags);\n+                deployTemplate(azureClient, parameters);\n+            }\n+        }\n+    }\n+\n+    private List<AzurePrivateDnsZoneServiceEnum> getEnabledPrivateEndpointServices() {\n+        return privateEndpointServices.stream()\n+                .map(AzurePrivateDnsZoneServiceEnum::getBySubResource)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private void deployTemplate(AzureClient azureClient, AzureDnsZoneDeploymentParameters parameters) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = parameters.getEnabledPrivateEndpointServices();\n+        String resourceGroup = parameters.getResourceGroupName();\n+\n+        LOGGER.debug(\"Deploying Private DNS Zones and applying network link for services {}\",\n+                enabledPrivateEndpointServices.stream().map(AzurePrivateDnsZoneServiceEnum::getSubResource).collect(Collectors.toList()));\n+        String networkId = StringUtils.substringAfterLast(parameters.getNetworkId(), \"/\");\n+        String suffix = parameters.getDeployOnlyNetworkLinks() ? \"-\" + networkId + NETWORK_LINKS : DNS_ZONES;", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzOTE1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503839159", "bodyText": "why this check is necessary? at line #187 deployment existence already checked and deleted if present", "author": "lacikaaa", "createdAt": "2020-10-13T10:24:42Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudError;\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss:SSS\");\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void checkOrCreateDnsZonesAndNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n+\n+        boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String dnsZoneDeploymentId = getDnsZoneDeploymentId(resourceGroup, azureClient, deploymentName);\n+\n+        if (dnsZonesDeployed && networkLinksDeployed) {\n+            LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+        } else if (!dnsZonesDeployed) {\n+            LOGGER.debug(\"Dns zones are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            if (isRequested(dnsZoneDeploymentId)) {\n+                LOGGER.debug(\"Dns zones ({}) already requested in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                        enabledPrivateEndpointServices);\n+                if (!networkLinksDeployed) {\n+                    LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+                    createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                }\n+            } else {\n+                try {\n+                    LOGGER.debug(\"Dns zones ({}) are not requested yet in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n+                    if (isCreated(dnsZoneDeploymentId)) {\n+                        LOGGER.debug(\"Dns zone deployment ({}) is there in database but not deployed on Azure, resetting it..\", dnsZoneDeploymentId);\n+                        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.REQUESTED);\n+                    } else {\n+                        persistDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId);\n+                    }\n+\n+                    createDnsZonesAndNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+                    updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, CommonStatus.CREATED);\n+\n+                } catch (CloudException | DataAccessException e) {\n+                    LOGGER.warn(\"Deployment failed due to {}, setting the resource status of {} to FAILED\", e.getMessage(), deploymentName);\n+                    pollForCreation(authenticatedContext, azureClient, resourceGroup, deploymentName, dnsZoneDeploymentId, null,\n+                            enabledPrivateEndpointServices);\n+                }\n+            }\n+        } else {\n+            LOGGER.debug(\"Network links are not deployed yet!\");\n+            String azureNetworkId = getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+            createMissingNetworkLinks(azureClient, azureNetworkId, resourceGroup, tags, enabledPrivateEndpointServices);\n+        }\n+    }\n+\n+    private void pollForCreation(AuthenticatedContext authenticatedContext, AzureClient azureClient, String resourceGroup, String deploymentName,\n+            String dnsZoneDeploymentId, String networkId, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        AzureDnsZoneCreationCheckerContext checkerContext = new AzureDnsZoneCreationCheckerContext(azureClient,\n+                resourceGroup,\n+                deploymentName,\n+                networkId,\n+                enabledPrivateEndpointServices);\n+        azureDnsZoneCreationPoller.startPolling(authenticatedContext, checkerContext);\n+        CommonStatus deploymentStatus = azureClient.getTemplateDeploymentCommonStatus(resourceGroup, deploymentName);\n+        updateDnsZone(authenticatedContext, deploymentName, dnsZoneDeploymentId, deploymentStatus);\n+    }\n+\n+    private void createDnsZonesAndNetworkLinks(AzureClient azureClient, String azureNetworkId, String resourceGroup,\n+            Map<String, String> tags, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        AzureDnsZoneDeploymentParameters parameters = new AzureDnsZoneDeploymentParameters(azureNetworkId,\n+                false,\n+                enabledPrivateEndpointServices,\n+                resourceGroup,\n+                tags);\n+        deployTemplate(azureClient, parameters);\n+    }\n+\n+    private Network getAzureNetwork(AzureClient azureClient, String networkId, String networkResourceGroup) {\n+        Network azureNetwork = azureClient.getNetworkByResourceGroup(networkResourceGroup, networkId);\n+        if (Objects.isNull(azureNetwork)) {\n+            throw new CloudConnectorException(String.format(\"Azure network id lookup failed with network id %s in resource group %s\", networkId,\n+                    networkResourceGroup));\n+        }\n+        return azureNetwork;\n+    }\n+\n+    private void createMissingNetworkLinks(AzureClient azureClient, String azureNetworkId, String resourceGroup,\n+            Map<String, String> tags, List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        for (AzurePrivateDnsZoneServiceEnum service: enabledPrivateEndpointServices) {\n+            PagedList<VirtualNetworkLinkInner> networkLinks = azureClient.listNetworkLinksByPrivateDnsZoneName(resourceGroup, service.getDnsZoneName());\n+            boolean networkLinkCreated = azureClient.isNetworkLinkCreated(StringUtils.substringAfterLast(azureNetworkId, \"/\"), networkLinks);\n+            if (!networkLinkCreated) {\n+                LOGGER.debug(\"Network links for service {} not yet created, creating them now\", service.getSubResource());\n+                AzureDnsZoneDeploymentParameters parameters = new AzureDnsZoneDeploymentParameters(azureNetworkId,\n+                        true,\n+                        enabledPrivateEndpointServices,\n+                        resourceGroup,\n+                        tags);\n+                deployTemplate(azureClient, parameters);\n+            }\n+        }\n+    }\n+\n+    private List<AzurePrivateDnsZoneServiceEnum> getEnabledPrivateEndpointServices() {\n+        return privateEndpointServices.stream()\n+                .map(AzurePrivateDnsZoneServiceEnum::getBySubResource)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private void deployTemplate(AzureClient azureClient, AzureDnsZoneDeploymentParameters parameters) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = parameters.getEnabledPrivateEndpointServices();\n+        String resourceGroup = parameters.getResourceGroupName();\n+\n+        LOGGER.debug(\"Deploying Private DNS Zones and applying network link for services {}\",\n+                enabledPrivateEndpointServices.stream().map(AzurePrivateDnsZoneServiceEnum::getSubResource).collect(Collectors.toList()));\n+        String networkId = StringUtils.substringAfterLast(parameters.getNetworkId(), \"/\");\n+        String suffix = parameters.getDeployOnlyNetworkLinks() ? \"-\" + networkId + NETWORK_LINKS : DNS_ZONES;\n+        String deploymentName = generateDnsZoneDeploymentName(enabledPrivateEndpointServices, suffix);\n+\n+        try {\n+            if (azureClient.templateDeploymentExists(resourceGroup, deploymentName)) {\n+                LOGGER.debug(\"Deleting already existing deployment {}\", deploymentName);\n+                azureClient.deleteTemplateDeployment(resourceGroup, deploymentName);\n+            }\n+            String template = azureNetworkDnsZoneTemplateBuilder.build(parameters);\n+            String parametersMapAsString = new Json(Map.of()).getValue();\n+            if (azureClient.getTemplateDeploymentStatus(resourceGroup, deploymentName).isTransient()) {", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0NDIwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503844205", "bodyText": "nit: could be inlined", "author": "lacikaaa", "createdAt": "2020-10-13T10:33:22Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkConnector.java", "diffHunk": "@@ -206,6 +210,26 @@ public SubnetSelectionResult chooseSubnets(Collection<CloudSubnet> subnetMetas,\n         return azureSubnetSelectorService.select(subnetMetas, subnetSelectionParameters);\n     }\n \n+    @Override\n+    public void createProviderSpecificNetworkResources(ProviderSpecificNetworkResourcesCreationRequest request) {\n+        boolean privateEndpointsEnabled = request.isPrivateEndpointsEnabled();", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0NDY1OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503844658", "bodyText": "wrong class", "author": "lacikaaa", "createdAt": "2020-10-13T10:34:15Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkDnsZoneTemplateBuilder.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.util.FreeMarkerTemplateUtils;\n+\n+import freemarker.template.Configuration;\n+import freemarker.template.Template;\n+import freemarker.template.TemplateException;\n+\n+@Component\n+public class AzureNetworkDnsZoneTemplateBuilder {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureTemplateBuilder.class);", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0NDk2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503844967", "bodyText": "please loose the : to ensure the value is set", "author": "lacikaaa", "createdAt": "2020-10-13T10:34:51Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkDnsZoneTemplateBuilder.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.util.FreeMarkerTemplateUtils;\n+\n+import freemarker.template.Configuration;\n+import freemarker.template.Template;\n+import freemarker.template.TemplateException;\n+\n+@Component\n+public class AzureNetworkDnsZoneTemplateBuilder {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureTemplateBuilder.class);\n+\n+    @Value(\"${cb.arm.network.dnszone.template.path:}\")", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2Njg5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503966890", "bodyText": "Ok, done this for all the arm templates", "author": "pdarvasi", "createdAt": "2020-10-13T13:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0NDk2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1MTE4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503851187", "bodyText": "you should use equals here instead of ==", "author": "lacikaaa", "createdAt": "2020-10-13T10:46:10Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "diffHunk": "@@ -722,6 +739,66 @@ public void deleteDatabaseServer(String databaseServerId) {\n         handleAuthException(() -> azure.genericResources().deleteById(databaseServerId));\n     }\n \n+    public PrivateZone getPrivateDnsZoneByResourceGroup(String resourceGroupName, String dnsZoneName) {\n+        return privatednsManager.privateZones().getByResourceGroup(resourceGroupName, dnsZoneName);\n+    }\n+\n+    public PagedList<PrivateZone> listPrivateDnsZonesByResourceGroup(String resourceGroupName) {\n+        return privatednsManager.privateZones().listByResourceGroup(resourceGroupName);\n+    }\n+\n+    public PagedList<VirtualNetworkLinkInner> listNetworkLinksByPrivateDnsZoneName(String resourceGroupName, String dnsZoneName) {\n+        return privatednsManager.virtualNetworkLinks().inner().list(resourceGroupName, dnsZoneName);\n+    }\n+\n+    public boolean checkIfDnsZonesDeployed(String resourceGroupName, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        LOGGER.debug(\"Checking DNS Zones for services {}\", services.stream()\n+                .map(AzurePrivateDnsZoneServiceEnum::getDnsZoneName)\n+                .collect(Collectors.toList()));\n+\n+        PagedList<PrivateZone> dnsZones = listPrivateDnsZonesByResourceGroup(resourceGroupName);\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            Optional<PrivateZone> foundDnsZone = dnsZones.stream()\n+                    .filter(dnsZone -> dnsZone.name().equals(dnsZoneName))\n+                    .filter(dnsZone -> dnsZone.provisioningState() == SUCCEEDED)", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1MzM4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503853382", "bodyText": "you could use noneMatch or anyMatch instead of the last filter, so it would return a boolean and you could use that in the if condition", "author": "lacikaaa", "createdAt": "2020-10-13T10:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1MTE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1MzkwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503853909", "bodyText": "isEmpty please, like:\n\t\t\tif (virtualNetworkLinks.isEmpty()) {\n                LOGGER.info(\"Network link for network {} not found for DNS zone {}!\", networkId, dnsZoneName);\n                return false;\n            } else if (!isNetworkLinkCreated(networkId, virtualNetworkLinks)) {\n                LOGGER.info(\"Network link for network {} and DNS Zone {} is not provisioned successfully yet!\", networkId, dnsZoneName);\n                return false;\n            }", "author": "lacikaaa", "createdAt": "2020-10-13T10:51:04Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "diffHunk": "@@ -722,6 +739,66 @@ public void deleteDatabaseServer(String databaseServerId) {\n         handleAuthException(() -> azure.genericResources().deleteById(databaseServerId));\n     }\n \n+    public PrivateZone getPrivateDnsZoneByResourceGroup(String resourceGroupName, String dnsZoneName) {\n+        return privatednsManager.privateZones().getByResourceGroup(resourceGroupName, dnsZoneName);\n+    }\n+\n+    public PagedList<PrivateZone> listPrivateDnsZonesByResourceGroup(String resourceGroupName) {\n+        return privatednsManager.privateZones().listByResourceGroup(resourceGroupName);\n+    }\n+\n+    public PagedList<VirtualNetworkLinkInner> listNetworkLinksByPrivateDnsZoneName(String resourceGroupName, String dnsZoneName) {\n+        return privatednsManager.virtualNetworkLinks().inner().list(resourceGroupName, dnsZoneName);\n+    }\n+\n+    public boolean checkIfDnsZonesDeployed(String resourceGroupName, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        LOGGER.debug(\"Checking DNS Zones for services {}\", services.stream()\n+                .map(AzurePrivateDnsZoneServiceEnum::getDnsZoneName)\n+                .collect(Collectors.toList()));\n+\n+        PagedList<PrivateZone> dnsZones = listPrivateDnsZonesByResourceGroup(resourceGroupName);\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            Optional<PrivateZone> foundDnsZone = dnsZones.stream()\n+                    .filter(dnsZone -> dnsZone.name().equals(dnsZoneName))\n+                    .filter(dnsZone -> dnsZone.provisioningState() == SUCCEEDED)\n+                    .findAny();\n+            if (foundDnsZone.isEmpty()) {\n+                LOGGER.info(\"DNS Zone {} is not provisioned successfully yet!\", dnsZoneName);\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n+\n+    public boolean checkIfNetworkLinksDeployed(String resourceGroupName, String networkId, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        LOGGER.debug(\"Checking Network link between network and services {} and network link {}\", networkId,\n+                services.stream()\n+                        .map(AzurePrivateDnsZoneServiceEnum::getDnsZoneName)\n+                        .collect(Collectors.toList()));\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            PagedList<VirtualNetworkLinkInner> virtualNetworkLinks = listNetworkLinksByPrivateDnsZoneName(resourceGroupName, dnsZoneName);\n+            if (virtualNetworkLinks.size() > 0) {", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1ODE3NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503858175", "bodyText": "as these are not real enums, please use equals", "author": "lacikaaa", "createdAt": "2020-10-13T10:58:31Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "diffHunk": "@@ -722,6 +739,66 @@ public void deleteDatabaseServer(String databaseServerId) {\n         handleAuthException(() -> azure.genericResources().deleteById(databaseServerId));\n     }\n \n+    public PrivateZone getPrivateDnsZoneByResourceGroup(String resourceGroupName, String dnsZoneName) {\n+        return privatednsManager.privateZones().getByResourceGroup(resourceGroupName, dnsZoneName);\n+    }\n+\n+    public PagedList<PrivateZone> listPrivateDnsZonesByResourceGroup(String resourceGroupName) {\n+        return privatednsManager.privateZones().listByResourceGroup(resourceGroupName);\n+    }\n+\n+    public PagedList<VirtualNetworkLinkInner> listNetworkLinksByPrivateDnsZoneName(String resourceGroupName, String dnsZoneName) {\n+        return privatednsManager.virtualNetworkLinks().inner().list(resourceGroupName, dnsZoneName);\n+    }\n+\n+    public boolean checkIfDnsZonesDeployed(String resourceGroupName, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        LOGGER.debug(\"Checking DNS Zones for services {}\", services.stream()\n+                .map(AzurePrivateDnsZoneServiceEnum::getDnsZoneName)\n+                .collect(Collectors.toList()));\n+\n+        PagedList<PrivateZone> dnsZones = listPrivateDnsZonesByResourceGroup(resourceGroupName);\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            Optional<PrivateZone> foundDnsZone = dnsZones.stream()\n+                    .filter(dnsZone -> dnsZone.name().equals(dnsZoneName))\n+                    .filter(dnsZone -> dnsZone.provisioningState() == SUCCEEDED)\n+                    .findAny();\n+            if (foundDnsZone.isEmpty()) {\n+                LOGGER.info(\"DNS Zone {} is not provisioned successfully yet!\", dnsZoneName);\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n+\n+    public boolean checkIfNetworkLinksDeployed(String resourceGroupName, String networkId, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        LOGGER.debug(\"Checking Network link between network and services {} and network link {}\", networkId,\n+                services.stream()\n+                        .map(AzurePrivateDnsZoneServiceEnum::getDnsZoneName)\n+                        .collect(Collectors.toList()));\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            PagedList<VirtualNetworkLinkInner> virtualNetworkLinks = listNetworkLinksByPrivateDnsZoneName(resourceGroupName, dnsZoneName);\n+            if (virtualNetworkLinks.size() > 0) {\n+                if (!isNetworkLinkCreated(networkId, virtualNetworkLinks)) {\n+                    LOGGER.info(\"Network link for network {} and DNS Zone {} is not provisioned successfully yet!\", networkId, dnsZoneName);\n+                    return false;\n+                }\n+            } else {\n+                LOGGER.info(\"Network link for network {} not found for DNS zone {}!\", networkId, dnsZoneName);\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n+\n+    public boolean isNetworkLinkCreated(String networkId, PagedList<VirtualNetworkLinkInner> virtualNetworkLinks) {\n+        return virtualNetworkLinks.stream()\n+                .filter(networkLink -> networkId.equals(networkLink.name()))\n+                .anyMatch(networkLink -> networkLink.provisioningState() == SUCCEEDED\n+                        && networkLink.virtualNetworkLinkState() == VirtualNetworkLinkState.COMPLETED);", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1MDM2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503950367", "bodyText": "God bless the Azure SDK! :D", "author": "pdarvasi", "createdAt": "2020-10-13T13:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1ODE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2MDMwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503860300", "bodyText": "this could be private, or if we keep this public we might want to add asserts for the parameters also here", "author": "lacikaaa", "createdAt": "2020-10-13T11:02:24Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/resource/AzureResourceIdProviderService.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.cloudbreak.cloud.azure.resource;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.Assert;\n+\n+import com.sequenceiq.cloudbreak.cloud.azure.AzureStorage;\n+\n+@Component\n+public class AzureResourceIdProviderService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureResourceIdProviderService.class);\n+\n+    public String generateImageId(String subscriptionId, String resourceGroup, String imageName) {\n+        Assert.hasText(subscriptionId, \"Subscription id must not be null or empty.\");\n+        Assert.hasText(resourceGroup, \"Resource group must not be null or empty.\");\n+        Assert.hasText(imageName, \"Image name must not be null or empty.\");\n+\n+        StringBuilder sb = new StringBuilder();\n+        sb.append(generateCommonPart(subscriptionId, resourceGroup));\n+        sb.append(\"/providers/Microsoft.Compute/\");\n+        sb.append(AzureStorage.IMAGES_CONTAINER);\n+        sb.append(\"/\");\n+        sb.append(imageName);\n+        String resourceReference = sb.toString();\n+        LOGGER.info(\"Generated resourceReferenceId: {}\", resourceReference);\n+        return resourceReference;\n+    }\n+\n+    public String generateDnsZoneDeploymentId(String subscriptionId, String resourceGroup, String deploymentName) {\n+        Assert.hasText(subscriptionId, \"Subscription id must not be null or empty.\");\n+        Assert.hasText(resourceGroup, \"Resource group must not be null or empty.\");\n+        Assert.hasText(deploymentName, \"Deployment name must not be null or empty.\");\n+\n+        StringBuilder sb = new StringBuilder();\n+        sb.append(generateCommonPart(subscriptionId, resourceGroup));\n+        sb.append(\"/providers/Microsoft.Resources/\");\n+        sb.append(\"deployments/\");\n+        sb.append(deploymentName);\n+        String resourceReference = sb.toString();\n+        LOGGER.info(\"Generated resourceReferenceId: {}\", resourceReference);\n+        return resourceReference;\n+    }\n+\n+    public String generateCommonPart(String subscriptionId, String resourceGroup) {", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2MDgzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503860832", "bodyText": "maybe an extra log could help us later here", "author": "lacikaaa", "createdAt": "2020-10-13T11:03:19Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/status/AzureStatusMapper.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.cloudbreak.cloud.azure.status;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.ResourceStatus;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+\n+public class AzureStatusMapper {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureStatusMapper.class);\n+\n+    private AzureStatusMapper() {\n+    }\n+\n+    public static ResourceStatus mapResourceStatus(String status) {\n+        LOGGER.debug(\"Mapping resource status {}\", status);\n+        switch (status) {\n+            case \"Accepted\":\n+                return ResourceStatus.IN_PROGRESS;\n+            case \"Ready\":\n+                return ResourceStatus.UPDATED;\n+            case \"Canceled\":\n+                return ResourceStatus.FAILED;\n+            case \"Failed\":\n+                return ResourceStatus.FAILED;\n+            case \"Deleted\":\n+                return ResourceStatus.DELETED;\n+            case \"Succeeded\":\n+                return ResourceStatus.CREATED;\n+            default:\n+                return ResourceStatus.IN_PROGRESS;\n+\n+        }\n+    }\n+\n+    public static CommonStatus mapCommonStatus(String status) {\n+        LOGGER.debug(\"Mapping common status {}\", status);\n+        switch (status) {\n+            case \"Accepted\":\n+                return CommonStatus.REQUESTED;\n+            case \"Ready\":\n+            case \"Succeeded\":\n+                return CommonStatus.CREATED;\n+            case \"Canceled\":\n+            case \"Deleted\":\n+            case \"Failed\":\n+                return CommonStatus.FAILED;\n+            default:\n+                return CommonStatus.FAILED;", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2MTg0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503861849", "bodyText": "according to call hierarchy this always be null", "author": "lacikaaa", "createdAt": "2020-10-13T11:05:10Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/task/dnszone/AzureDnsZoneCreationCheckerContext.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.sequenceiq.cloudbreak.cloud.azure.task.dnszone;\n+\n+import java.util.List;\n+\n+import com.sequenceiq.cloudbreak.cloud.azure.AzurePrivateDnsZoneServiceEnum;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+\n+public class AzureDnsZoneCreationCheckerContext {\n+\n+    private final AzureClient azureClient;\n+\n+    private final String resourceGroupName;\n+\n+    private final String deploymentName;\n+\n+    private final String networkId;\n+\n+    private final List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices;\n+\n+    public AzureDnsZoneCreationCheckerContext(AzureClient azureClient, String resourceGroupName, String deploymentName, String networkId,\n+            List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices) {\n+        this.azureClient = azureClient;\n+        this.resourceGroupName = resourceGroupName;\n+        this.deploymentName = deploymentName;\n+        this.networkId = networkId;", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2MzM3OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503863379", "bodyText": "this will never be called as networkId is null", "author": "lacikaaa", "createdAt": "2020-10-13T11:08:12Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/task/dnszone/AzureDnsZoneCreationCheckerTask.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.sequenceiq.cloudbreak.cloud.azure.task.dnszone;\n+\n+import java.util.List;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.azure.AzurePrivateDnsZoneServiceEnum;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.model.ResourceStatus;\n+import com.sequenceiq.cloudbreak.cloud.task.PollBooleanStateTask;\n+\n+@Component(AzureDnsZoneCreationCheckerTask.NAME)\n+@Scope(\"prototype\")\n+public class AzureDnsZoneCreationCheckerTask extends PollBooleanStateTask {\n+\n+    public static final String NAME = \"AzureDnsZoneCreationChecker\";\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneCreationCheckerTask.class);\n+\n+    private final AzureDnsZoneCreationCheckerContext context;\n+\n+    public AzureDnsZoneCreationCheckerTask(AuthenticatedContext authenticatedContext, AzureDnsZoneCreationCheckerContext context) {\n+        super(authenticatedContext, false);\n+        this.context = context;\n+    }\n+\n+    @Override\n+    protected Boolean doCall() {\n+        String deploymentName = context.getDeploymentName();\n+        String resourceGroupName = context.getResourceGroupName();\n+        AzureClient azureClient = context.getAzureClient();\n+        String networkId = context.getNetworkId();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = context.getEnabledPrivateEndpointServices();\n+        LOGGER.info(\"Waiting for DNS zone to be created: {}\", deploymentName);\n+\n+        ResourceStatus templateDeploymentStatus = azureClient.getTemplateDeploymentStatus(resourceGroupName, deploymentName);\n+\n+        if (templateDeploymentStatus.isPermanent() &&\n+                templateDeploymentStatus != ResourceStatus.DELETED &&\n+                azureClient.checkIfDnsZonesDeployed(resourceGroupName, enabledPrivateEndpointServices)) {\n+            LOGGER.info(\"DNS zone and network link creation has been finished with status {}\", templateDeploymentStatus);\n+            if (StringUtils.isNotEmpty(networkId)) {\n+                return azureClient.checkIfNetworkLinksDeployed(resourceGroupName, networkId, enabledPrivateEndpointServices);\n+            }", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2NDQ4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503864489", "bodyText": "these should be @Values so we could easily override them", "author": "lacikaaa", "createdAt": "2020-10-13T11:10:17Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/task/dnszone/AzureDnsZoneCreationPoller.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.sequenceiq.cloudbreak.cloud.azure.task.dnszone;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.azure.task.AzurePollTaskFactory;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.scheduler.SyncPollingScheduler;\n+import com.sequenceiq.cloudbreak.cloud.task.PollTask;\n+\n+@Component\n+public class AzureDnsZoneCreationPoller {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneCreationPoller.class);\n+\n+    private static final int DNS_ZONE_CREATION_CHECKING_INTERVAL = 1000;\n+\n+    private static final int DNS_ZONE_CREATION_CHECKING_MAX_ATTEMPT = 100;\n+\n+    private static final int MAX_FAILURE_TOLERANT = 1;", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0NzYzMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503947631", "bodyText": "Good idea, worth doing for all the affected Pollers", "author": "pdarvasi", "createdAt": "2020-10-13T13:23:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2NDQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2Nzk5OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503867999", "bodyText": "as mentioned above this could be removed if we change the DefaultNetworkConnector", "author": "lacikaaa", "createdAt": "2020-10-13T11:17:20Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/NetworkCreationHandler.java", "diffHunk": "@@ -118,6 +120,12 @@ private void createCloudNetworkIfNeeded(EnvironmentDto environmentDto, Environme\n         }\n     }\n \n+    private void createProviderSpecificNetworkResourcesIfNeeded(EnvironmentDto environmentDto, BaseNetwork network) {\n+        if (AZURE.equalsIgnoreCase(environmentDto.getCloudPlatform())) {", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MDAwMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503870002", "bodyText": "nit: isExistingNetwork", "author": "lacikaaa", "createdAt": "2020-10-13T11:21:00Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/service/NetworkCreationRequestFactory.java", "diffHunk": "@@ -72,6 +80,25 @@ public NetworkCreationRequest create(EnvironmentDto environment) {\n         return builder.build();\n     }\n \n+    public ProviderSpecificNetworkResourcesCreationRequest createProviderSpecificNetworkResources(EnvironmentDto environment, BaseNetwork baseNetwork) {\n+        NetworkDto networkDto = environment.getNetwork();\n+        ProviderSpecificNetworkResourcesCreationRequest.Builder builder = new ProviderSpecificNetworkResourcesCreationRequest.Builder()\n+                .withNetworkId(NullUtil.getIfNotNull(baseNetwork, BaseNetwork::getNetworkId))\n+                .withNetworkResourceGroup(NullUtil.getIfNotNull(baseNetwork, this::getNetworkResourceGroupName))\n+                .withExistingNetwork(NullUtil.getIfNotNull(baseNetwork, this::getExistingNetwork))\n+                .withCloudCredential(getCredential(environment))\n+                .withCloudContext(getCloudContext(environment))\n+                .withRegion(Region.region(environment.getLocation().getName()))\n+                .withPrivateEndpointsEnabled(ServiceEndpointCreation.ENABLED_PRIVATE_ENDPOINT == networkDto.getServiceEndpointCreation())\n+                .withTags(networkTagProvider.getTags(environment));\n+                getResourceGroupName(environment).ifPresent(builder::withResourceGroup);\n+        return builder.build();\n+    }\n+\n+    private boolean getExistingNetwork(BaseNetwork baseNetwork) {", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MDkxNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503870915", "bodyText": "I don't like instanceof. You could solve this by adding the method to BaseNetwork which returns null and override it from AzureNetwork", "author": "lacikaaa", "createdAt": "2020-10-13T11:22:36Z", "path": "environment/src/main/java/com/sequenceiq/environment/network/service/NetworkCreationRequestFactory.java", "diffHunk": "@@ -80,6 +107,10 @@ public String getStackName(EnvironmentDto environment) {\n         return String.join(\"-\", environment.getName(), String.valueOf(environment.getNetwork().getId()));\n     }\n \n+    private String getNetworkResourceGroupName(BaseNetwork baseNetwork) {\n+        return baseNetwork instanceof AzureNetwork ? ((AzureNetwork) baseNetwork).getResourceGroupName() : null;", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkyODQzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503928430", "bodyText": "Yes, me neither, but the RG term does not make any sense for any other provider.", "author": "pdarvasi", "createdAt": "2020-10-13T12:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MDkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2MDM2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503960362", "bodyText": "In that case this should be solved similarly like NetworkDto <-> AzureNetwork conversion or other cloudplatform dependent stuff. maybe @doktoric can point to a more fitting example", "author": "lacikaaa", "createdAt": "2020-10-13T13:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MDkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MjA3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503872072", "bodyText": "so this won't result in any unexpected result? why have you changed this and why to this one?", "author": "lacikaaa", "createdAt": "2020-10-13T11:24:54Z", "path": "environment/src/main/java/com/sequenceiq/environment/parameters/dao/converter/ResourceTypeConverter.java", "diffHunk": "@@ -1,12 +1,12 @@\n package com.sequenceiq.environment.parameters.dao.converter;\n \n import com.sequenceiq.cloudbreak.converter.DefaultEnumConverter;\n-import com.sequenceiq.environment.resourcepersister.ResourceType;\n+import com.sequenceiq.common.api.type.ResourceType;\n \n public class ResourceTypeConverter extends DefaultEnumConverter<ResourceType> {\n \n     @Override\n     public ResourceType getDefault() {\n-        return ResourceType.AWS_INSTANCE;\n+        return ResourceType.AZURE_PRIVATE_DNS_ZONE;", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkzODczMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503938730", "bodyText": "Because this is the only resource type stored in the environment service now.", "author": "pdarvasi", "createdAt": "2020-10-13T13:13:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MjA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDE4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503874185", "bodyText": "could you use the exact converter instead of ConversionService here?", "author": "lacikaaa", "createdAt": "2020-10-13T11:28:36Z", "path": "environment/src/main/java/com/sequenceiq/environment/resourcepersister/CloudResourceRetrieverService.java", "diffHunk": "@@ -12,8 +18,21 @@\n @Component\n public class CloudResourceRetrieverService implements ResourceRetriever {\n \n+    private static final Logger LOGGER = LoggerFactory.getLogger(CloudResourceRetrieverService.class);\n+\n+    @Inject\n+    @Qualifier(\"conversionService\")\n+    private ConversionService conversionService;\n+\n+    @Inject\n+    private ResourceService resourceService;\n+\n     @Override\n     public Optional<CloudResource> findByResourceReferenceAndStatusAndType(String resourceReference, CommonStatus status, ResourceType resourceType) {\n-        return Optional.empty();\n+        Optional<Resource> optionalResource = resourceService.findByResourceReferenceAndStatusAndType(resourceReference, status, resourceType);\n+        LOGGER.debug(\"Resource retrieved by optionalResource reference: {}, status: {} and type: {}. Is present: {}\", resourceReference, status, resourceType,\n+                optionalResource.isPresent());\n+        return optionalResource\n+                .map(resource -> conversionService.convert(resource, CloudResource.class));", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4MzIzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503883235", "bodyText": "if you would name the column in your sql environment_id I think you could drop this line", "author": "lacikaaa", "createdAt": "2020-10-13T11:44:26Z", "path": "environment/src/main/java/com/sequenceiq/environment/resourcepersister/Resource.java", "diffHunk": "@@ -1,30 +1,33 @@\n package com.sequenceiq.environment.resourcepersister;\n \n-import java.io.Serializable;\n-\n import javax.persistence.Column;\n import javax.persistence.Convert;\n import javax.persistence.Entity;\n+import javax.persistence.FetchType;\n import javax.persistence.GeneratedValue;\n import javax.persistence.GenerationType;\n import javax.persistence.Id;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n import javax.persistence.SequenceGenerator;\n \n-import com.sequenceiq.cloudbreak.common.json.Json;\n-import com.sequenceiq.cloudbreak.common.json.JsonToString;\n import com.sequenceiq.cloudbreak.converter.CommonStatusConverter;\n import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+import com.sequenceiq.environment.environment.domain.Environment;\n import com.sequenceiq.environment.parameters.dao.converter.ResourceTypeConverter;\n \n @Entity\n-public class Resource implements Serializable {\n+public class Resource {\n \n     @Id\n     @GeneratedValue(strategy = GenerationType.AUTO, generator = \"resource_generator\")\n     @SequenceGenerator(name = \"resource_generator\", sequenceName = \"resource_id_seq\", allocationSize = 1)\n     private Long id;\n \n-    private String instanceGroup;\n+    @ManyToOne(fetch = FetchType.LAZY)\n+    @JoinColumn(name = \"resource_environment\")", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4NDc3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r503884776", "bodyText": "Long would be more consistent", "author": "lacikaaa", "createdAt": "2020-10-13T11:47:15Z", "path": "environment/src/main/java/com/sequenceiq/environment/resourcepersister/ResourceRepository.java", "diffHunk": "@@ -10,14 +10,24 @@\n import org.springframework.data.repository.CrudRepository;\n import org.springframework.data.repository.query.Param;\n \n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n @Transactional(TxType.REQUIRED)\n public interface ResourceRepository extends CrudRepository<Resource, Long> {\n \n-    @Query(\"SELECT r FROM Resource r WHERE r.crn = :crn AND r.resourceName = :name AND r.resourceType = :type\")\n-    Optional<Resource> findByStackIdAndNameAndType(@Param(\"crn\") String crnId, @Param(\"name\") String name,\n-            @Param(\"type\") com.sequenceiq.environment.resourcepersister.ResourceType type);\n+    @Query(\"SELECT r FROM Resource r WHERE r.environment.id = :environmentId AND r.resourceName = :name AND r.resourceType = :type\")\n+    Optional<Resource> findByEnvironmentIdAndNameAndType(@Param(\"environmentId\") Long environmentId, @Param(\"name\") String name,\n+            @Param(\"type\") com.sequenceiq.common.api.type.ResourceType type);\n+\n+    @Query(\"SELECT r FROM Resource r WHERE r.environment.id = :environmentId\")\n+    List<Resource> findAllByEnvironmentId(@Param(\"environmentId\") long environmentId);", "originalCommit": "7460cceea835605e2cf2d5e1ba749ae119d1581d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e32bcab86a2159efdc1b143098a2110a4258af73", "url": "https://github.com/hortonworks/cloudbreak/commit/e32bcab86a2159efdc1b143098a2110a4258af73", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-13T23:24:43Z", "type": "forcePushed"}, {"oid": "4b6019fb75aa02383330ad7a02bb73114c76805f", "url": "https://github.com/hortonworks/cloudbreak/commit/4b6019fb75aa02383330ad7a02bb73114c76805f", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-14T07:41:43Z", "type": "forcePushed"}, {"oid": "ee5a44f3986996601c7091e72bb45ee9ec574f10", "url": "https://github.com/hortonworks/cloudbreak/commit/ee5a44f3986996601c7091e72bb45ee9ec574f10", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-14T08:11:49Z", "type": "forcePushed"}, {"oid": "5fd998f8bf0ed75c1747f377adc9b8f3365684c7", "url": "https://github.com/hortonworks/cloudbreak/commit/5fd998f8bf0ed75c1747f377adc9b8f3365684c7", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-14T08:12:25Z", "type": "forcePushed"}, {"oid": "5c3ab0b4ef383c19cca3e6da6a28cf60d16a403e", "url": "https://github.com/hortonworks/cloudbreak/commit/5c3ab0b4ef383c19cca3e6da6a28cf60d16a403e", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-14T08:42:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1MDY5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r504550692", "bodyText": "I don't think it's needed anymore", "author": "lacikaaa", "createdAt": "2020-10-14T09:54:15Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -0,0 +1,290 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.network.Network;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureDnsZoneService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    @Inject\n+    private AzureUtils azureUtils;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void getOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n+\n+        boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String dnsZoneDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n+                resourceGroup, deploymentName);\n+\n+        if (dnsZonesDeployed && networkLinksDeployed) {\n+            LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);", "originalCommit": "5c3ab0b4ef383c19cca3e6da6a28cf60d16a403e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MTk3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9207#discussion_r504691973", "bodyText": "It is needed to short-circuit the creation if it is not needed.", "author": "pdarvasi", "createdAt": "2020-10-14T13:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1MDY5Mg=="}], "type": "inlineReview"}, {"oid": "c8fdf248ebbfea223a1a5fe84c69ee82f294b837", "url": "https://github.com/hortonworks/cloudbreak/commit/c8fdf248ebbfea223a1a5fe84c69ee82f294b837", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-14T12:22:53Z", "type": "commit"}, {"oid": "c8fdf248ebbfea223a1a5fe84c69ee82f294b837", "url": "https://github.com/hortonworks/cloudbreak/commit/c8fdf248ebbfea223a1a5fe84c69ee82f294b837", "message": "CB-8867 - Env service should create private DNS zone privatelink.postgres.database.azure.com", "committedDate": "2020-10-14T12:22:53Z", "type": "forcePushed"}]}