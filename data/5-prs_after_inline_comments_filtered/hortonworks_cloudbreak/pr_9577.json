{"pr_number": 9577, "pr_title": "CB-10157 Store the original tags in our services and transform GCP la\u2026", "pr_createdAt": "2020-12-04T16:52:58Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9577", "timeline": [{"oid": "343c4472c0bcc283c27353a4840e1b762a82f009", "url": "https://github.com/hortonworks/cloudbreak/commit/343c4472c0bcc283c27353a4840e1b762a82f009", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective", "committedDate": "2020-12-07T07:39:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI5MTIwMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9577#discussion_r537291201", "bodyText": "I think it would be beneficial to log the generated value", "author": "doktoric", "createdAt": "2020-12-07T07:44:04Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/util/GcpLabelUtil.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.cloudbreak.cloud.gcp.util;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudStack;\n+\n+public final class GcpLabelUtil {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GcpLabelUtil.class);\n+\n+    private static final int GCP_MAX_TAG_LEN = 63;\n+\n+    private GcpLabelUtil() {\n+    }\n+\n+    public static Map<String, String> createLabelsFromTags(CloudStack cloudStack) {\n+        Map<String, String> result = new HashMap<>();\n+        Map<String, String> tags = cloudStack.getTags();\n+        if (tags != null) {\n+            tags.forEach((key, value) -> result.put(transform(key), transform(value)));\n+        }\n+        return result;\n+    }\n+\n+    private static String transform(String value) {\n+        // GCP labels have strict rules https://cloud.google.com/compute/docs/labeling-resources\n+        LOGGER.debug(\"Transforming tag key/value for GCP.\");\n+        if (Crn.isCrn(value)) {\n+            try {\n+                Crn crn = Crn.fromString(value);\n+                value = crn == null ? value : crn.getResource();\n+            } catch (Exception e) {\n+                LOGGER.debug(\"Ignoring CRN ({}) parse error during tag value generation : {}\", value, e.getMessage());\n+            }\n+        }\n+        String sanitized = value.split(\"@\")[0].toLowerCase().replaceAll(\"[^\\\\w]\", \"-\");\n+        return StringUtils.right(sanitized, GCP_MAX_TAG_LEN);", "originalCommit": "343c4472c0bcc283c27353a4840e1b762a82f009", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8d0823cde23d1c8f44830817ebf39ce557828d41", "url": "https://github.com/hortonworks/cloudbreak/commit/8d0823cde23d1c8f44830817ebf39ce557828d41", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective", "committedDate": "2020-12-07T09:06:34Z", "type": "forcePushed"}, {"oid": "f794749c2f9863b6fd84192b94da6919647bfe12", "url": "https://github.com/hortonworks/cloudbreak/commit/f794749c2f9863b6fd84192b94da6919647bfe12", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective", "committedDate": "2020-12-07T09:20:20Z", "type": "forcePushed"}, {"oid": "d6643723adf45bb0762c39fe3c32b9126946d185", "url": "https://github.com/hortonworks/cloudbreak/commit/d6643723adf45bb0762c39fe3c32b9126946d185", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective", "committedDate": "2020-12-07T13:21:36Z", "type": "commit"}, {"oid": "d6643723adf45bb0762c39fe3c32b9126946d185", "url": "https://github.com/hortonworks/cloudbreak/commit/d6643723adf45bb0762c39fe3c32b9126946d185", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective", "committedDate": "2020-12-07T13:21:36Z", "type": "forcePushed"}]}