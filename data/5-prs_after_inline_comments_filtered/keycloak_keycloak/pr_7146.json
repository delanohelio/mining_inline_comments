{"pr_number": 7146, "pr_title": "[KEYCLOAK-13202] Reset password redirects to account client", "pr_createdAt": "2020-06-08T10:44:35Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7146", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwMzE1OA==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r436903158", "bodyText": "I believe the lines 409-411 should be removed and line 410 should be moved after line 401 - so that redirectUri is set to the redirectUri of account client just in case that it corresponds to account client? Probably something like this:\n       if (client == null) {\n            client = SystemClientUtil.getSystemClient(realm);\n            redirectUri = Urls.accountBase(session.getContext().getUri().getBaseUri()).path(\"/\").build(realm.getName()).toString();\n        }\n\nWDYT?", "author": "mposolda", "createdAt": "2020-06-08T18:18:40Z", "path": "services/src/main/java/org/keycloak/services/resources/LoginActionsService.java", "diffHunk": "@@ -380,31 +379,43 @@ public Response resetCredentialsGET(@QueryParam(AUTH_SESSION_ID) String authSess\n             if (!realm.isResetPasswordAllowed()) {\n                 event.event(EventType.RESET_PASSWORD);\n                 event.error(Errors.NOT_ALLOWED);\n-                return ErrorPage.error(session, authSession, Response.Status.BAD_REQUEST, Messages.RESET_CREDENTIAL_NOT_ALLOWED);\n+                return ErrorPage.error(session, null, Response.Status.BAD_REQUEST, Messages.RESET_CREDENTIAL_NOT_ALLOWED);\n \n             }\n-            authSession = createAuthenticationSessionForClient();\n+            authSession = createAuthenticationSessionForClient(clientId);\n             return processResetCredentials(false, null, authSession, null);\n         }\n \n         event.event(EventType.RESET_PASSWORD);\n         return resetCredentials(authSessionId, code, execution, clientId, tabId);\n     }\n \n-    AuthenticationSessionModel createAuthenticationSessionForClient()\n-      throws UriBuilderException, IllegalArgumentException {\n+    AuthenticationSessionModel createAuthenticationSessionForClient(String clientID)\n+            throws UriBuilderException, IllegalArgumentException {\n         AuthenticationSessionModel authSession;\n \n-        // set up the account service as the endpoint to call.\n-        ClientModel client = SystemClientUtil.getSystemClient(realm);\n+        ClientModel client = session.realms().getClientByClientId(clientID, realm);\n+        String redirectUri = null;\n+\n+        if (client == null) {\n+            client = SystemClientUtil.getSystemClient(realm);\n+        } else {\n+            redirectUri = client.getRedirectUris()\n+                    .stream()\n+                    .findFirst()\n+                    .orElse(null);\n+        }\n+\n+        if (redirectUri == null) {\n+            redirectUri = Urls.accountBase(session.getContext().getUri().getBaseUri()).path(\"/\").build(realm.getName()).toString();", "originalCommit": "dffb83106baee9f8db28290c35658882f6945001", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3MzA4Ng==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r436973086", "bodyText": "@mposolda I've been thinking about it a little. I know, each client should has at least one redirect URI, but there might be some case, when a client has not. When a client is created, redirect URI doesn't have to be provided, so far. Of course, user is informed about this in some way, but this approach, I think, is resistant to this. So, if the client exists and doesn't have any redirect URI, it's redirected in a same way like client, which is null.\nBut, if you think, it's unnecessary, I'll remove this. :)\nI agree, automated test should be included, thanks!", "author": "mabartos", "createdAt": "2020-06-08T20:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwMzE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwMTAwOQ==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r437601009", "bodyText": "+1 to remove this and move after line 401. The thing is, that with the current code, it can happen that \"redirectUri\" is set to the redirectUri of the account client, even if client_id is different than account. This can have various side-effects. If the null redirectUri is the issue, then it might be better to throw the exception in case of null redirectUri", "author": "mposolda", "createdAt": "2020-06-09T17:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwMzE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkwNTgzOQ==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r437905839", "bodyText": "Ok, I agree, but I've just thought it would be better to redirect to account console, than show to user some message \"We're sorry...\" :)\nThanks @mposolda !", "author": "mabartos", "createdAt": "2020-06-10T07:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwMzE1OA=="}], "type": "inlineReview"}, {"oid": "0a0a26da9578808e2057785345ab8cdd79035a6a", "url": "https://github.com/keycloak/keycloak/commit/0a0a26da9578808e2057785345ab8cdd79035a6a", "message": "[KEYCLOAK-13202] Reset password redirects to account client", "committedDate": "2020-06-16T12:18:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5OTU0Ng==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r441299546", "bodyText": "I see there is existing method RedirectUtils.resolveValidRedirects(KeycloakSession session, String rootUrl, Set<String> validRedirects)  , which seems to already quite similar thing you introduced here? Will it be possible to use the existing method as much as possible to avoid some duplicated code logic?", "author": "mposolda", "createdAt": "2020-06-17T06:03:07Z", "path": "services/src/main/java/org/keycloak/protocol/oidc/utils/RedirectUtils.java", "diffHunk": "@@ -195,4 +196,27 @@ private static String getSingleValidRedirectUri(Collection<String> validRedirect\n         }\n         return validRedirect;\n     }\n+\n+    public static String getValidRedirectUriWithRootUrl(ClientModel client) {\n+        return (client != null) ? getValidRedirectUriWithRootUrl(client.getRootUrl(), client.getRedirectUris()) : null;\n+    }\n+\n+    public static String getValidRedirectUriWithRootUrl(String rootUrl, Collection<String> redirectUris) {", "originalCommit": "0a0a26da9578808e2057785345ab8cdd79035a6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0MTAyMQ==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r441341021", "bodyText": "Thanks. You're right.", "author": "mabartos", "createdAt": "2020-06-17T07:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5OTU0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMzcyMQ==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r441303721", "bodyText": "Is it possible to test the scenario with 2 browsers (driver and driver2 variables already available inside this test) instead of the different browser tabs as we discussed on the call? It seems to me the test with more browser tabs is quite error prone and there might be issues/instabilities for various browsers (which will occur especially in the environments like jenkins etc)", "author": "mposolda", "createdAt": "2020-06-17T06:15:14Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/forms/ResetPasswordTest.java", "diffHunk": "@@ -1084,4 +1086,140 @@ public void failResetPasswordServiceAccount() {\n         loginPage.assertCurrent();\n         assertEquals(\"Invalid username or password.\", errorPage.getError());\n     }\n+\n+    @Test\n+    public void resetPasswordLinkNewTabAndProperRedirectAccount() throws IOException {\n+        final String REQUIRED_URI = OAuthClient.AUTH_SERVER_ROOT + \"/realms/test/account/applications\";\n+        final String REDIRECT_URI = getAccountRedirectUrl() + \"?path=applications\";\n+        final String CLIENT_ID = \"account\";\n+\n+        try (BrowserTabUtil tabUtil = BrowserTabUtil.getInstanceAndSetEnv(driver)) {", "originalCommit": "0a0a26da9578808e2057785345ab8cdd79035a6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3MzYxNQ==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r441373615", "bodyText": "As I mentioned above, simulate this case with two web drivers is quite difficult (at least for me). When I open a link from received email by driver2, there isn't the same environment like in new tab created by first driver and this leads to a different behavior. The page isn't redirected back to the application, but there is only message 'Your account has been updated'. So, it's not the required behavior.\nAt this time, I don't know, how to do that better. So, If you have better solution for that, you may share your hints. Thanks @mposolda", "author": "mabartos", "createdAt": "2020-06-17T08:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMzcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUwNjE1NA==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r441506154", "bodyText": "Yes, true. Let's go with your approach then. It will be good to run some set of pipeline tests for various browsers to make sure that things are not broken for different browsers...", "author": "mposolda", "createdAt": "2020-06-17T12:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMzcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwNTM2OQ==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r441305369", "bodyText": "I suggest to test the scenario with different client than the admin console. Any test with the admin console adds the potential for instabilities and issues and needs of the workarounds like this :) How about the default client \"test-client\" , which uses the AppPage? For example see the ResetPasswordTest.resetPasswordWithLengthPasswordPolicy() or some other tests used on many places inside the testsuite.", "author": "mposolda", "createdAt": "2020-06-17T06:19:45Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/forms/ResetPasswordTest.java", "diffHunk": "@@ -1084,4 +1086,140 @@ public void failResetPasswordServiceAccount() {\n         loginPage.assertCurrent();\n         assertEquals(\"Invalid username or password.\", errorPage.getError());\n     }\n+\n+    @Test\n+    public void resetPasswordLinkNewTabAndProperRedirectAccount() throws IOException {\n+        final String REQUIRED_URI = OAuthClient.AUTH_SERVER_ROOT + \"/realms/test/account/applications\";\n+        final String REDIRECT_URI = getAccountRedirectUrl() + \"?path=applications\";\n+        final String CLIENT_ID = \"account\";\n+\n+        try (BrowserTabUtil tabUtil = BrowserTabUtil.getInstanceAndSetEnv(driver)) {\n+            assertThat(tabUtil.getCountOfTabs(), Matchers.is(1));\n+\n+            driver.navigate().to(REQUIRED_URI);\n+            resetPasswordTwiceInNewTab(defaultUser, CLIENT_ID, false, REDIRECT_URI, REQUIRED_URI);\n+            assertThat(driver.getTitle(), Matchers.equalTo(\"Keycloak Account Management\"));\n+\n+            oauth.openLogout();\n+\n+            driver.navigate().to(REQUIRED_URI);\n+            resetPasswordTwiceInNewTab(defaultUser, CLIENT_ID, true, REDIRECT_URI, REQUIRED_URI);\n+            assertThat(driver.getTitle(), Matchers.equalTo(\"Keycloak Account Management\"));\n+        }\n+    }\n+\n+    @Test\n+    public void resetPasswordLinkNewTabAndProperRedirectAdminConsole() throws IOException {\n+        final String REDIRECT_URI = OAuthClient.AUTH_SERVER_ROOT + \"/admin/test/console/\";\n+        final String CLIENT_ID = \"security-admin-console\";\n+\n+        // It's necessary to take this here before redirecting to Admin Console.\n+        try (BrowserTabUtil tabUtil = BrowserTabUtil.getInstanceAndSetEnv(driver)) {\n+            assertThat(tabUtil.getCountOfTabs(), Matchers.is(1));\n+            driver.navigate().to(REDIRECT_URI);\n+\n+            // HtmlUnit has problem with redirecting immediately to Security Console.\n+            if (driver instanceof HtmlUnitDriver)", "originalCommit": "0a0a26da9578808e2057785345ab8cdd79035a6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0OTIwMQ==", "url": "https://github.com/keycloak/keycloak/pull/7146#discussion_r441349201", "bodyText": "I've already found it out too, that a test with admin console requires a lot of effort to execute it properly. The \"test-client\" will be better choice. Thanks!", "author": "mabartos", "createdAt": "2020-06-17T07:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwNTM2OQ=="}], "type": "inlineReview"}, {"oid": "5c20fb7433bf58f2faf85a1b58d31a489b73436c", "url": "https://github.com/keycloak/keycloak/commit/5c20fb7433bf58f2faf85a1b58d31a489b73436c", "message": "[KEYCLOAK-13202] Reset password redirects to account client", "committedDate": "2020-06-17T12:23:00Z", "type": "commit"}, {"oid": "5c20fb7433bf58f2faf85a1b58d31a489b73436c", "url": "https://github.com/keycloak/keycloak/commit/5c20fb7433bf58f2faf85a1b58d31a489b73436c", "message": "[KEYCLOAK-13202] Reset password redirects to account client", "committedDate": "2020-06-17T12:23:00Z", "type": "forcePushed"}]}