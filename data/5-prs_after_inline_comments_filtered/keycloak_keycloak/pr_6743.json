{"pr_number": 6743, "pr_title": "KEYCLOAK-9632 Improve handling of user locale", "pr_createdAt": "2020-02-06T13:25:32Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6743", "timeline": [{"oid": "dbaabe55d4e54dcca487c5a85b04328c61e5326e", "url": "https://github.com/keycloak/keycloak/commit/dbaabe55d4e54dcca487c5a85b04328c61e5326e", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-06T20:39:15Z", "type": "forcePushed"}, {"oid": "65b56684ac1a859af1195377d84e2d786e83e4db", "url": "https://github.com/keycloak/keycloak/commit/65b56684ac1a859af1195377d84e2d786e83e4db", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-06T20:42:35Z", "type": "forcePushed"}, {"oid": "a8eb3be4e1c7bf8bcbd81512ebfbe24528fe4fbc", "url": "https://github.com/keycloak/keycloak/commit/a8eb3be4e1c7bf8bcbd81512ebfbe24528fe4fbc", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-06T20:46:24Z", "type": "forcePushed"}, {"oid": "5c11c268f91474bc3316d6487f42500a0755894f", "url": "https://github.com/keycloak/keycloak/commit/5c11c268f91474bc3316d6487f42500a0755894f", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-06T20:50:36Z", "type": "forcePushed"}, {"oid": "dc0a324e75023cd6576e40f3399f838edf9abce1", "url": "https://github.com/keycloak/keycloak/commit/dc0a324e75023cd6576e40f3399f838edf9abce1", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-07T06:06:13Z", "type": "forcePushed"}, {"oid": "14592aa5030f3d2702b86998811479c06f2f87c6", "url": "https://github.com/keycloak/keycloak/commit/14592aa5030f3d2702b86998811479c06f2f87c6", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-07T08:37:41Z", "type": "forcePushed"}, {"oid": "7dfe9af1cf049810360d31479a6e23b14fa2d1b7", "url": "https://github.com/keycloak/keycloak/commit/7dfe9af1cf049810360d31479a6e23b14fa2d1b7", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-07T14:09:18Z", "type": "forcePushed"}, {"oid": "af454df3986b080261e1ab201274708477930ee3", "url": "https://github.com/keycloak/keycloak/commit/af454df3986b080261e1ab201274708477930ee3", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-10T08:48:46Z", "type": "forcePushed"}, {"oid": "f9f9e6307e3b6c8c591ee0b27782a5c3520df256", "url": "https://github.com/keycloak/keycloak/commit/f9f9e6307e3b6c8c591ee0b27782a5c3520df256", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-10T08:50:28Z", "type": "forcePushed"}, {"oid": "cf22c6b7c04e1f9f287c59c123b44fd24b21c887", "url": "https://github.com/keycloak/keycloak/commit/cf22c6b7c04e1f9f287c59c123b44fd24b21c887", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-10T10:09:33Z", "type": "forcePushed"}, {"oid": "3785884249083620c35d217d339fd62e91ecf54d", "url": "https://github.com/keycloak/keycloak/commit/3785884249083620c35d217d339fd62e91ecf54d", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-12T08:17:21Z", "type": "forcePushed"}, {"oid": "fd727e2071c8f6b932fba07419667d281004e302", "url": "https://github.com/keycloak/keycloak/commit/fd727e2071c8f6b932fba07419667d281004e302", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-13T15:47:42Z", "type": "commit"}, {"oid": "fd727e2071c8f6b932fba07419667d281004e302", "url": "https://github.com/keycloak/keycloak/commit/fd727e2071c8f6b932fba07419667d281004e302", "message": "KEYCLOAK-9632 Improve handling of user locale", "committedDate": "2020-02-13T15:47:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MDUyNA==", "url": "https://github.com/keycloak/keycloak/pull/6743#discussion_r378970524", "bodyText": "RequiredAction is basically used here as a callback to be triggered after authentication. This works fine, on the other hand it looks to me as a workaround. It has some unneeded side-effects (EG. administrator will see \"update user locale\" as requiredAction and they will be able to set it to users. This won't have any effect and might be slightly confusing etc).\nIt may be better to have something like \"Interceptor SPI\" or possibly re-use our EventSPI. However using Event SPI in it's current form looks also as a workaround an I guess we don't have proper event yet for \"POST_REQUIRED_ACTIONS\", which is triggered after success of all required actions etc.\nIn shortcut, consider that we don't have better SPI right now, I am fine with using it as it for this PR :)", "author": "mposolda", "createdAt": "2020-02-13T16:25:25Z", "path": "services/src/main/java/org/keycloak/authentication/requiredactions/UpdateUserLocaleAction.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.keycloak.authentication.requiredactions;\n+\n+import org.keycloak.Config;\n+import org.keycloak.authentication.RequiredActionContext;\n+import org.keycloak.authentication.RequiredActionFactory;\n+import org.keycloak.authentication.RequiredActionProvider;\n+import org.keycloak.locale.LocaleSelectorProvider;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.models.KeycloakSessionFactory;\n+import org.keycloak.models.UserModel;\n+\n+public class UpdateUserLocaleAction implements RequiredActionProvider, RequiredActionFactory {\n+\n+    @Override\n+    public String getDisplayText() {\n+        return \"Update User Locale\";\n+    }\n+\n+    @Override\n+    public void evaluateTriggers(RequiredActionContext context) {\n+        String userRequestedLocale = context.getAuthenticationSession().getAuthNote(LocaleSelectorProvider.USER_REQUEST_LOCALE);", "originalCommit": "fd727e2071c8f6b932fba07419667d281004e302", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzNTQ3MQ==", "url": "https://github.com/keycloak/keycloak/pull/6743#discussion_r379035471", "bodyText": "What I want to do is make required action API into action API. Where an action can advertise how it supports being triggered (i.e. an action after auth, an required action, an aia, etc.). Think that is better than yet another API", "author": "stianst", "createdAt": "2020-02-13T18:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MDUyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA1MDI4OQ==", "url": "https://github.com/keycloak/keycloak/pull/6743#discussion_r379050289", "bodyText": "Also, someone may want to remove this action and replace it with something else that prompts the user with a form.", "author": "stianst", "createdAt": "2020-02-13T18:47:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MDUyNA=="}], "type": "inlineReview"}]}