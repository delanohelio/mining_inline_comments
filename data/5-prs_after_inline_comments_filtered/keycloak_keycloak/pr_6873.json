{"pr_number": 6873, "pr_title": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if upda\u2026", "pr_createdAt": "2020-03-06T07:28:49Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6873", "timeline": [{"oid": "dbf2c2494bdb7c74f85fc882782e5538916bc3b2", "url": "https://github.com/keycloak/keycloak/commit/dbf2c2494bdb7c74f85fc882782e5538916bc3b2", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell", "committedDate": "2020-03-12T09:27:29Z", "type": "forcePushed"}, {"oid": "30e84c563620a50cd6302e8774f929f147f3dbe1", "url": "https://github.com/keycloak/keycloak/commit/30e84c563620a50cd6302e8774f929f147f3dbe1", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell", "committedDate": "2020-04-30T06:41:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2MzYyNQ==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r420063625", "bodyText": "The response is never closed and causes connection leak.\nCreator relieves you from boilerplate code, see e.g. https://github.com/keycloak/keycloak/blob/master/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/UserTest.java#L2047.", "author": "hmlnarik", "createdAt": "2020-05-05T12:17:17Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/concurrency/ConcurrencyTest.java", "diffHunk": "@@ -51,6 +62,38 @@ public void concurrentTest(KeycloakRunnable... tasks) throws Throwable {\n         System.out.println(\"took \" + end + \" ms\");\n     }\n \n+    // KEYCLOAK-8141 Verify that no attribute values are duplicated, and there are no locking exceptions when adding attributes in parallell\n+    @Test\n+    @Ignore\n+    public void createUserAttributes() throws Throwable {\n+        AtomicInteger c = new AtomicInteger();\n+\n+        UsersResource users = testRealm().users();\n+\n+        UserRepresentation u = UserBuilder.create().username(\"attributes\").build();\n+        Response response = users.create(u);", "originalCommit": "30e84c563620a50cd6302e8774f929f147f3dbe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAwOTAxOQ==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r422009019", "bodyText": "Doesn't really save me anything - just closing the response. IMO the try with makes the code less readable and messy.", "author": "stianst", "createdAt": "2020-05-08T08:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2MzYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4OTg4Ng==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r422889886", "bodyText": "It does. The try variant also ensures that the user is deleted after the block, and that even in case of failure of the test. This is not covered by the current code, thus complete realm delete is necessary before the next test", "author": "hmlnarik", "createdAt": "2020-05-11T08:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2MzYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2NDQ4NQ==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r420064485", "bodyText": "assertThat(rep.getAttributes(), Matchers.hasSize(lessThanOrEqualTo(c.get()) has better error reporting.", "author": "hmlnarik", "createdAt": "2020-05-05T12:18:50Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/concurrency/ConcurrencyTest.java", "diffHunk": "@@ -51,6 +62,38 @@ public void concurrentTest(KeycloakRunnable... tasks) throws Throwable {\n         System.out.println(\"took \" + end + \" ms\");\n     }\n \n+    // KEYCLOAK-8141 Verify that no attribute values are duplicated, and there are no locking exceptions when adding attributes in parallell\n+    @Test\n+    @Ignore\n+    public void createUserAttributes() throws Throwable {\n+        AtomicInteger c = new AtomicInteger();\n+\n+        UsersResource users = testRealm().users();\n+\n+        UserRepresentation u = UserBuilder.create().username(\"attributes\").build();\n+        Response response = users.create(u);\n+        String userId = ApiUtil.getCreatedId(response);\n+\n+        UserResource user = users.get(userId);\n+\n+        concurrentTest((threadIndex, keycloak, realm) -> {\n+            UserRepresentation rep = user.toRepresentation();\n+            rep.singleAttribute(\"a-\" + c.getAndIncrement(), \"value\");\n+            user.update(rep);\n+        });\n+\n+        UserRepresentation rep = user.toRepresentation();\n+\n+        // Number of attributes should be equal to created attributes, or less (concurrent requests may drop attributes added by other threads)\n+        assertTrue(rep.getAttributes().size() <= c.get());", "originalCommit": "30e84c563620a50cd6302e8774f929f147f3dbe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAwNzEyOA==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r422007128", "bodyText": "Nitpick - not changing", "author": "stianst", "createdAt": "2020-05-08T08:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2NDQ4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5MDczMQ==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r422890731", "bodyText": "Not a nitpick.\nError reporting with assertThat shows the list items which is useful for bug investigation, especially in case of hard-to-reproduce concurrent tests.\nCurrent variant only fails without any further details", "author": "hmlnarik", "createdAt": "2020-05-11T09:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2NDQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2NDk1OQ==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r420064959", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertEquals(1, e.getValue().size());\n          \n          \n            \n                        assertThat(e.getValue(), Matchers.hasSize(1));\n          \n      \n    \n    \n  \n\nfor better error reporting.", "author": "hmlnarik", "createdAt": "2020-05-05T12:19:39Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/concurrency/ConcurrencyTest.java", "diffHunk": "@@ -51,6 +62,38 @@ public void concurrentTest(KeycloakRunnable... tasks) throws Throwable {\n         System.out.println(\"took \" + end + \" ms\");\n     }\n \n+    // KEYCLOAK-8141 Verify that no attribute values are duplicated, and there are no locking exceptions when adding attributes in parallell\n+    @Test\n+    @Ignore\n+    public void createUserAttributes() throws Throwable {\n+        AtomicInteger c = new AtomicInteger();\n+\n+        UsersResource users = testRealm().users();\n+\n+        UserRepresentation u = UserBuilder.create().username(\"attributes\").build();\n+        Response response = users.create(u);\n+        String userId = ApiUtil.getCreatedId(response);\n+\n+        UserResource user = users.get(userId);\n+\n+        concurrentTest((threadIndex, keycloak, realm) -> {\n+            UserRepresentation rep = user.toRepresentation();\n+            rep.singleAttribute(\"a-\" + c.getAndIncrement(), \"value\");\n+            user.update(rep);\n+        });\n+\n+        UserRepresentation rep = user.toRepresentation();\n+\n+        // Number of attributes should be equal to created attributes, or less (concurrent requests may drop attributes added by other threads)\n+        assertTrue(rep.getAttributes().size() <= c.get());\n+\n+        // All attributes should have a single value\n+        for (Map.Entry<String, List<String>> e : rep.getAttributes().entrySet()) {\n+            assertEquals(1, e.getValue().size());", "originalCommit": "30e84c563620a50cd6302e8774f929f147f3dbe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAwNzE2Mw==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r422007163", "bodyText": "Nitpick - not changing", "author": "stianst", "createdAt": "2020-05-08T08:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2NDk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4OTQxMw==", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r422889413", "bodyText": "Not a nitpick.\nError reporting with assertThat shows the list items which is useful for bug investigation, especially in case of hard-to-reproduce concurrent tests.", "author": "hmlnarik", "createdAt": "2020-05-11T08:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2NDk1OQ=="}], "type": "inlineReview"}, {"oid": "04d380136f575c94a7873a422ba610bf77879902", "url": "https://github.com/keycloak/keycloak/commit/04d380136f575c94a7873a422ba610bf77879902", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell", "committedDate": "2020-05-08T08:10:18Z", "type": "commit"}, {"oid": "04d380136f575c94a7873a422ba610bf77879902", "url": "https://github.com/keycloak/keycloak/commit/04d380136f575c94a7873a422ba610bf77879902", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell", "committedDate": "2020-05-08T08:10:18Z", "type": "forcePushed"}]}