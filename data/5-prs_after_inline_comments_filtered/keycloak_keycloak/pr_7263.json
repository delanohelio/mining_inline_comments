{"pr_number": 7263, "pr_title": "KEYCLOAK-14220 Complement methods for accessing clients with Stream v\u2026", "pr_createdAt": "2020-07-14T07:19:16Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7263", "timeline": [{"oid": "8a5c1403c6d219abf19855660b55ca5d93cf5c62", "url": "https://github.com/keycloak/keycloak/commit/8a5c1403c6d219abf19855660b55ca5d93cf5c62", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-14T08:48:07Z", "type": "forcePushed"}, {"oid": "ded3ef8a5a5953a710780e11ffa985c02771de1f", "url": "https://github.com/keycloak/keycloak/commit/ded3ef8a5a5953a710780e11ffa985c02771de1f", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-14T11:03:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5MTc4MA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r454991780", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected Stream<RoleModel> getRoles(TypedQuery<RoleEntity> query, RealmModel realm, Integer first, Integer max) {\n          \n          \n            \n                protected Stream<RoleModel> getRolesStream(TypedQuery<RoleEntity> query, RealmModel realm, Integer first, Integer max) {", "author": "hmlnarik", "createdAt": "2020-07-15T11:48:56Z", "path": "model/jpa/src/main/java/org/keycloak/models/jpa/JpaRealmProvider.java", "diffHunk": "@@ -284,76 +281,67 @@ public RoleModel getClientRole(RealmModel realm, ClientModel client, String name\n \n \n     @Override\n-    public Set<RoleModel> getClientRoles(RealmModel realm, ClientModel client) {\n-        Set<RoleModel> list = new HashSet<>();\n+    public Stream<RoleModel> getClientRolesStream(RealmModel realm, ClientModel client) {\n         TypedQuery<String> query = em.createNamedQuery(\"getClientRoleIds\", String.class);\n         query.setParameter(\"client\", client.getId());\n-        List<String> roles = query.getResultList();\n-        for (String id : roles) {\n-            list.add(session.realms().getRoleById(id, realm));\n-        }\n-        return list;\n+        Stream<String> roles = query.getResultStream();\n+\n+        return roles.map(realm::getRoleById);\n     }\n     \n     @Override\n-    public Set<RoleModel> getRealmRoles(RealmModel realm, Integer first, Integer max) {\n+    public Stream<RoleModel> getRealmRolesStream(RealmModel realm, Integer first, Integer max) {\n         TypedQuery<RoleEntity> query = em.createNamedQuery(\"getRealmRoles\", RoleEntity.class);\n         query.setParameter(\"realm\", realm.getId());\n         \n         return getRoles(query, realm, first, max);\n     }\n \n     @Override\n-    public Set<RoleModel> getClientRoles(RealmModel realm, ClientModel client, Integer first, Integer max) {\n+    public Stream<RoleModel> getClientRolesStream(RealmModel realm, ClientModel client, Integer first, Integer max) {\n         TypedQuery<RoleEntity> query = em.createNamedQuery(\"getClientRoles\", RoleEntity.class);\n         query.setParameter(\"client\", client.getId());\n         \n         return getRoles(query, realm, first, max);\n     }\n     \n-    protected Set<RoleModel> getRoles(TypedQuery<RoleEntity> query, RealmModel realm, Integer first, Integer max) {\n+    protected Stream<RoleModel> getRoles(TypedQuery<RoleEntity> query, RealmModel realm, Integer first, Integer max) {", "originalCommit": "ded3ef8a5a5953a710780e11ffa985c02771de1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5MjY4NA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r454992684", "bodyText": "StackOverflowException", "author": "hmlnarik", "createdAt": "2020-07-15T11:50:35Z", "path": "server-spi/src/main/java/org/keycloak/models/ClientProvider.java", "diffHunk": "@@ -41,9 +57,23 @@\n \n     RoleModel getClientRole(RealmModel realm, ClientModel client, String name);\n \n-    Set<RoleModel> getClientRoles(RealmModel realm, ClientModel client);\n+    @Deprecated\n+    default Set<RoleModel> getClientRoles(RealmModel realm, ClientModel client) {\n+        return getClientRolesStream(realm, client).collect(Collectors.toSet());\n+    }\n+\n+    default Stream<RoleModel> getClientRolesStream(RealmModel realm, ClientModel client) {\n+        return getClientRolesStream(realm, client);", "originalCommit": "ded3ef8a5a5953a710780e11ffa985c02771de1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5NDk1Mw==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r454994953", "bodyText": "It should be fixed already. Are you looking at latest change?", "author": "martin-kanis", "createdAt": "2020-07-15T11:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5MjY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5MjkyMQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r454992921", "bodyText": "StackOverflowException", "author": "hmlnarik", "createdAt": "2020-07-15T11:50:48Z", "path": "server-spi/src/main/java/org/keycloak/models/ClientProvider.java", "diffHunk": "@@ -41,9 +57,23 @@\n \n     RoleModel getClientRole(RealmModel realm, ClientModel client, String name);\n \n-    Set<RoleModel> getClientRoles(RealmModel realm, ClientModel client);\n+    @Deprecated\n+    default Set<RoleModel> getClientRoles(RealmModel realm, ClientModel client) {\n+        return getClientRolesStream(realm, client).collect(Collectors.toSet());\n+    }\n+\n+    default Stream<RoleModel> getClientRolesStream(RealmModel realm, ClientModel client) {\n+        return getClientRolesStream(realm, client);\n+    }\n+\n+    @Deprecated\n+    default List<ClientModel> getAlwaysDisplayInConsoleClients(RealmModel realm) {\n+        return getAlwaysDisplayInConsoleClientsStream(realm).collect(Collectors.toList());\n+    }\n \n-    List<ClientModel> getAlwaysDisplayInConsoleClients(RealmModel realm);\n+    default Stream<ClientModel> getAlwaysDisplayInConsoleClientsStream(RealmModel realm) {\n+        return getAlwaysDisplayInConsoleClientsStream(realm);", "originalCommit": "ded3ef8a5a5953a710780e11ffa985c02771de1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5NTA2MQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r454995061", "bodyText": "same as above", "author": "martin-kanis", "createdAt": "2020-07-15T11:55:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5MjkyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5ODM4Ng==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r454998386", "bodyText": "Could be perhaps like this:\nStream<ClientModel> local = session.clientLocalStorage().searchClientsByClientIdStream(clientId,  firstResult, maxResults, realm);\nStream<ClientModel> ext = getEnabledStorageProviders(session, realm, ClientLookupProvider.class).stream()\n    .map(p -> p.searchClientsByClientIdStream(clientId,  firstResult, maxResults, realm))\n    .flatMap(Function.identity());\nreturn Stream.concat(local, ext);", "author": "hmlnarik", "createdAt": "2020-07-15T12:01:37Z", "path": "services/src/main/java/org/keycloak/storage/ClientStorageManager.java", "diffHunk": "@@ -151,14 +153,18 @@ public ClientModel getClientByClientId(String clientId, RealmModel realm) {\n     }\n \n     @Override\n-    public List<ClientModel> searchClientsByClientId(String clientId, Integer firstResult, Integer maxResults, RealmModel realm) {\n-        List<ClientModel> clients = session.clientLocalStorage().searchClientsByClientId(clientId,  firstResult, maxResults, realm);\n-        if (clients != null) {\n-            return clients;\n+    public Stream<ClientModel> searchClientsByClientIdStream(String clientId, Integer firstResult, Integer maxResults, RealmModel realm) {\n+        Stream<ClientModel> clients = session.clientLocalStorage().searchClientsByClientIdStream(clientId,  firstResult, maxResults, realm);\n+        Iterator<ClientModel> iterator = clients.iterator();\n+        if (iterator.hasNext()) {\n+            return StreamSupport.stream(Spliterators.spliteratorUnknownSize(iterator, 0), false);\n         }\n         for (ClientLookupProvider provider : getEnabledStorageProviders(session, realm, ClientLookupProvider.class)) {\n-            clients = provider.searchClientsByClientId(clientId, firstResult, maxResults, realm);\n-            if (clients != null) return clients;\n+            clients = provider.searchClientsByClientIdStream(clientId, firstResult, maxResults, realm);\n+            iterator = clients.iterator();\n+            if (iterator.hasNext()) {\n+                return StreamSupport.stream(Spliterators.spliteratorUnknownSize(iterator, 0), false);\n+            }", "originalCommit": "ded3ef8a5a5953a710780e11ffa985c02771de1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA0MDA3MA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r455040070", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Set<RoleModel> model = getRealmDelegate().getRealmRolesStream(realm).collect(Collectors.toSet());\n          \n          \n            \n                        if (model == null) return null;\n          \n          \n            \n                        Set<String> ids = new HashSet<>();\n          \n          \n            \n                        for (RoleModel role : model) ids.add(role.getId());\n          \n          \n            \n                        query = new RoleListQuery(loaded, cacheKey, realm, ids);\n          \n          \n            \n                        logger.tracev(\"adding realm roles cache miss: realm {0} key {1}\", realm.getName(), cacheKey);\n          \n          \n            \n                        cache.addRevisioned(query, startupRevision);\n          \n          \n            \n                        return model;\n          \n          \n            \n                        return model.stream();\n          \n          \n            \n                        Set<RoleModel> model = getRealmDelegate().getRealmRoles(realm);\n          \n          \n            \n                        if (model == null) return null;\n          \n          \n            \n                        Set<String> ids = model.stream().map(RoleModel::getId).collect(Collectors.toSet());\n          \n          \n            \n                        query = new RoleListQuery(loaded, cacheKey, realm, ids);\n          \n          \n            \n                        logger.tracev(\"adding realm roles cache miss: realm {0} key {1}\", realm.getName(), cacheKey);\n          \n          \n            \n                        cache.addRevisioned(query, startupRevision);\n          \n          \n            \n                        return model.stream();", "author": "hmlnarik", "createdAt": "2020-07-15T13:13:05Z", "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmCacheSession.java", "diffHunk": "@@ -612,33 +614,33 @@ public RoleModel addRealmRole(RealmModel realm, String id, String name) {\n \n         if (query == null) {\n             Long loaded = cache.getCurrentRevision(cacheKey);\n-            Set<RoleModel> model = getRealmDelegate().getRealmRoles(realm);\n+            Set<RoleModel> model = getRealmDelegate().getRealmRolesStream(realm).collect(Collectors.toSet());\n             if (model == null) return null;\n             Set<String> ids = new HashSet<>();\n             for (RoleModel role : model) ids.add(role.getId());\n             query = new RoleListQuery(loaded, cacheKey, realm, ids);\n             logger.tracev(\"adding realm roles cache miss: realm {0} key {1}\", realm.getName(), cacheKey);\n             cache.addRevisioned(query, startupRevision);\n-            return model;\n+            return model.stream();", "originalCommit": "ded3ef8a5a5953a710780e11ffa985c02771de1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7de0e66f85338e39139fe0cc8e76a3dc1d99a5a8", "url": "https://github.com/keycloak/keycloak/commit/7de0e66f85338e39139fe0cc8e76a3dc1d99a5a8", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-21T09:47:26Z", "type": "forcePushed"}, {"oid": "cb2e2e930122c511f80cece3eeb79c518a0a308b", "url": "https://github.com/keycloak/keycloak/commit/cb2e2e930122c511f80cece3eeb79c518a0a308b", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-22T13:09:13Z", "type": "forcePushed"}, {"oid": "40ea3e6b7cf3637006813ad9712be177890f2687", "url": "https://github.com/keycloak/keycloak/commit/40ea3e6b7cf3637006813ad9712be177890f2687", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-22T15:57:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM2MTA4NA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459361084", "bodyText": "Should also be methods for accessing roles within scope of this work?", "author": "vramik", "createdAt": "2020-07-23T10:41:50Z", "path": "server-spi/src/main/java/org/keycloak/models/RealmProvider.java", "diffHunk": "@@ -81,16 +83,42 @@ default GroupModel createGroup(RealmModel realm, String name, GroupModel toParen\n \n     RoleModel getRealmRole(RealmModel realm, String name);\n \n-    Set<RoleModel> getRealmRoles(RealmModel realm);\n-    \n-    Set<RoleModel> getRealmRoles(RealmModel realm, Integer first, Integer max);\n-    \n-    Set<RoleModel> getClientRoles(RealmModel realm, ClientModel client, Integer first, Integer max);\n-    \n-    Set<RoleModel> searchForClientRoles(RealmModel realm, ClientModel client, String search, Integer first,\n-            Integer max);\n-    \n-    Set<RoleModel> searchForRoles(RealmModel realm, String search, Integer first, Integer max);\n+    @Deprecated\n+    default Set<RoleModel> getRealmRoles(RealmModel realm) {\n+        return getRealmRolesStream(realm).collect(Collectors.toSet());\n+    }\n+\n+    Stream<RoleModel> getRealmRolesStream(RealmModel realm);\n+\n+    @Deprecated\n+    default Set<RoleModel> getRealmRoles(RealmModel realm, Integer first, Integer max) {\n+        return getRealmRolesStream(realm, first, max).collect(Collectors.toSet());\n+    }\n+\n+    Stream<RoleModel> getRealmRolesStream(RealmModel realm, Integer first, Integer max);", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM3OTMxMQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459379311", "bodyText": "It was simpler to include also getRealmRolesStream because there is a common method getRolesStream in JpaRealmProvider which operates with both getClientRoles and getRealmRoles.  So when I changed return type of getRolesStream to Stream<> it wasn't possible to call this method from getClientRoles and getRealmRoles if they both don't operate with streams.", "author": "martin-kanis", "createdAt": "2020-07-23T11:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM2MTA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwMTIyMA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459401220", "bodyText": "These calls should be time-bound.", "author": "hmlnarik", "createdAt": "2020-07-23T12:09:48Z", "path": "services/src/main/java/org/keycloak/storage/ClientStorageManager.java", "diffHunk": "@@ -148,16 +149,11 @@ public ClientModel getClientByClientId(RealmModel realm, String clientId) {\n     }\n \n     @Override\n-    public List<ClientModel> searchClientsByClientId(RealmModel realm, String clientId, Integer firstResult, Integer maxResults) {\n-        List<ClientModel> clients = session.clientLocalStorage().searchClientsByClientId(realm, clientId,  firstResult, maxResults);\n-        if (clients != null) {\n-            return clients;\n-        }\n-        for (ClientLookupProvider provider : getEnabledStorageProviders(session, realm, ClientLookupProvider.class)) {\n-            clients = provider.searchClientsByClientId(realm, clientId, firstResult, maxResults);\n-            if (clients != null) return clients;\n-        }\n-        return null;\n+    public Stream<ClientModel> searchClientsByClientIdStream(RealmModel realm, String clientId, Integer firstResult, Integer maxResults) {\n+        Stream<ClientModel> local = session.clientLocalStorage().searchClientsByClientIdStream(realm, clientId,  firstResult, maxResults);\n+        Stream<ClientModel> ext = getEnabledStorageProviders(session, realm, ClientLookupProvider.class).stream()\n+                .flatMap(p -> p.searchClientsByClientIdStream(realm, clientId,  firstResult, maxResults));", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MjExNA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459992114", "bodyText": "Updated", "author": "martin-kanis", "createdAt": "2020-07-24T11:16:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwMTIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NDk3Nw==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459744977", "bodyText": "getRealmRoles(realm) is now deprecated so I guess we shouldn't use it, right?", "author": "vramik", "createdAt": "2020-07-23T21:43:25Z", "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmCacheSession.java", "diffHunk": "@@ -620,31 +622,30 @@ public RoleModel addRealmRole(RealmModel realm, String id, String name) {\n             Long loaded = cache.getCurrentRevision(cacheKey);\n             Set<RoleModel> model = getRealmDelegate().getRealmRoles(realm);", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4NTcwOA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459885708", "bodyText": "We discussed this with @hmlnarik and @sguilhen and we agreed on this solution. Problem here is the cashing of role ids. If you obtain a stream here, it will be spend by transformation to Stream (for cashing) and therefore the stream couldn't be returned later.", "author": "martin-kanis", "createdAt": "2020-07-24T07:09:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NDk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxODEzMg==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459918132", "bodyText": "This is an excellent question.\nGenerally, this is the case. In this case, it is however justified, as the cache provider is the final recipient of all the roles that it needs to cache, and it needs to process all of them, so it would collect them anyway.\nLater, we can think of optimizations like lazy-loading of the role details, and only returning stubs with IDs that would load the details only after when they are accessed. This would help across multiple places in caching.", "author": "hmlnarik", "createdAt": "2020-07-24T08:26:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NDk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk1NzM0Ng==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459957346", "bodyText": "So maybe we shouldn't deprecate the method(s) after all. As far as I understand there are cases when using non-stream method is actually more efficient, right?", "author": "vramik", "createdAt": "2020-07-24T09:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NDk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk4NTQ3Mg==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459985472", "bodyText": "So after discussion with @hmlnarik we agreed we should add comment something like // this method is used intentionally here because ... to places where the deprecated methods are used.", "author": "vramik", "createdAt": "2020-07-24T10:59:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NDk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5NDkxMA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459994910", "bodyText": "comments added", "author": "martin-kanis", "createdAt": "2020-07-24T11:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NDk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NjU3NA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459746574", "bodyText": "the same here, getClientRoles(realm, client, null, null) is now deprecated.", "author": "vramik", "createdAt": "2020-07-23T21:46:51Z", "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmCacheSession.java", "diffHunk": "@@ -654,46 +655,45 @@ public RoleModel addRealmRole(RealmModel realm, String id, String name) {\n \n         if (query == null) {\n             Long loaded = cache.getCurrentRevision(cacheKey);\n-            Set<RoleModel> model = getRealmDelegate().getClientRoles(realm, client);\n+            Set<RoleModel> model = getRealmDelegate().getClientRoles(realm, client, null, null);", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4NTg1Nw==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459885857", "bodyText": "Same as above", "author": "martin-kanis", "createdAt": "2020-07-24T07:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NjU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTExMg==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459749112", "bodyText": "Why is new method getClientsStream added here in RealmProvider? I think we should leave original methods here as deprecated and add the new 'Stream' ones into ClientProvider.", "author": "vramik", "createdAt": "2020-07-23T21:53:02Z", "path": "server-spi/src/main/java/org/keycloak/models/RealmProvider.java", "diffHunk": "@@ -147,14 +177,14 @@ default ClientModel addClient(RealmModel realm, String clientId) {\n     /**\n      * @deprecated Use the corresponding method from {@link ClientProvider}. */\n     @Override\n-    default List<ClientModel> getClients(RealmModel realm) {\n-        return this.getClients(realm, null, null);\n+    default Stream<ClientModel> getClientsStream(RealmModel realm) {", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MTg4NA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459991884", "bodyText": "reverted", "author": "martin-kanis", "createdAt": "2020-07-24T11:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTQzNQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459749435", "bodyText": "dtto", "author": "vramik", "createdAt": "2020-07-23T21:53:45Z", "path": "server-spi/src/main/java/org/keycloak/models/RealmProvider.java", "diffHunk": "@@ -147,14 +177,14 @@ default ClientModel addClient(RealmModel realm, String clientId) {\n     /**\n      * @deprecated Use the corresponding method from {@link ClientProvider}. */\n     @Override\n-    default List<ClientModel> getClients(RealmModel realm) {\n-        return this.getClients(realm, null, null);\n+    default Stream<ClientModel> getClientsStream(RealmModel realm) {\n+        return this.getClientsStream(realm, null, null);\n     }\n \n     /**\n      * @deprecated Use the corresponding method from {@link ClientProvider}. */\n     @Override\n-    public List<ClientModel> getClients(RealmModel realm, Integer firstResult, Integer maxResults);\n+    public Stream<ClientModel> getClientsStream(RealmModel realm, Integer firstResult, Integer maxResults);", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk4NTYwMA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459985600", "bodyText": "In case I revert this I have to implement the method in JpaRealmProvider and RealmCacheSession or the method has to be removed from RealmProvider.", "author": "martin-kanis", "createdAt": "2020-07-24T10:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MTc1MA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459991750", "bodyText": "I proceeded with removing the method from RealmProvider.", "author": "martin-kanis", "createdAt": "2020-07-24T11:15:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTUwOQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459749509", "bodyText": "dtto", "author": "vramik", "createdAt": "2020-07-23T21:53:56Z", "path": "server-spi/src/main/java/org/keycloak/models/RealmProvider.java", "diffHunk": "@@ -176,7 +206,7 @@ default ClientModel addClient(RealmModel realm, String clientId) {\n     /**\n      * @deprecated Use the corresponding method from {@link ClientProvider}. */\n     @Override\n-    public List<ClientModel> searchClientsByClientId(RealmModel realm, String clientId, Integer firstResult, Integer maxResults);\n+    public Stream<ClientModel> searchClientsByClientIdStream(RealmModel realm, String clientId, Integer firstResult, Integer maxResults);", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MTYyOA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459991628", "bodyText": "removed", "author": "martin-kanis", "createdAt": "2020-07-24T11:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTU5MQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459749591", "bodyText": "dtto", "author": "vramik", "createdAt": "2020-07-23T21:54:06Z", "path": "server-spi/src/main/java/org/keycloak/models/RealmProvider.java", "diffHunk": "@@ -200,6 +230,6 @@ default ClientModel addClient(RealmModel realm, String clientId) {\n     /**\n      * @deprecated Use the corresponding method from {@link ClientProvider}. */\n     @Override\n-    public List<ClientModel> getAlwaysDisplayInConsoleClients(RealmModel realm);\n+    public Stream<ClientModel> getAlwaysDisplayInConsoleClientsStream(RealmModel realm);", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk4NjQ2MQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459986461", "bodyText": "In case I revert this I have to implement the method in JpaRealmProvider and RealmCacheSession or the method has to be removed from RealmProvider.", "author": "martin-kanis", "createdAt": "2020-07-24T11:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MTA0MQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459991041", "bodyText": "I proceeded with removing the method from RealmProvider.", "author": "martin-kanis", "createdAt": "2020-07-24T11:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MzEwMQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459753101", "bodyText": "This method is now deprecated but still used across the codebase.", "author": "vramik", "createdAt": "2020-07-23T22:02:18Z", "path": "server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java", "diffHunk": "@@ -47,12 +49,27 @@\n \n     boolean removeRole(RoleModel role);\n \n-    Set<RoleModel> getRoles();\n-    \n-    Set<RoleModel> getRoles(Integer firstResult, Integer maxResults);\n+    @Deprecated\n+    default Set<RoleModel> getRoles() {", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4NzA0NA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459887044", "bodyText": "This was intentionally left for a separate commit together with the rest of methods like getClients(). The PR would be huge if it was done at once. I've the second commit WIP.", "author": "martin-kanis", "createdAt": "2020-07-24T07:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MzEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk2MDE4NQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459960185", "bodyText": "so maybe it'd be good to add //TODO?", "author": "vramik", "createdAt": "2020-07-24T09:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MzEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MDY1MA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459990650", "bodyText": "TODO added to multiple places", "author": "martin-kanis", "createdAt": "2020-07-24T11:12:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MzEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MzMxNw==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459753317", "bodyText": "the same here", "author": "vramik", "createdAt": "2020-07-23T22:02:51Z", "path": "server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java", "diffHunk": "@@ -47,12 +49,27 @@\n \n     boolean removeRole(RoleModel role);\n \n-    Set<RoleModel> getRoles();\n-    \n-    Set<RoleModel> getRoles(Integer firstResult, Integer maxResults);\n+    @Deprecated\n+    default Set<RoleModel> getRoles() {\n+        return getRolesStream().collect(Collectors.toSet());\n+    }\n+\n+    Stream<RoleModel> getRolesStream();\n+\n+    @Deprecated\n+    default Set<RoleModel> getRoles(Integer firstResult, Integer maxResults) {", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MzU0Mg==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459753542", "bodyText": "the same here", "author": "vramik", "createdAt": "2020-07-23T22:03:27Z", "path": "server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java", "diffHunk": "@@ -47,12 +49,27 @@\n \n     boolean removeRole(RoleModel role);\n \n-    Set<RoleModel> getRoles();\n-    \n-    Set<RoleModel> getRoles(Integer firstResult, Integer maxResults);\n+    @Deprecated\n+    default Set<RoleModel> getRoles() {\n+        return getRolesStream().collect(Collectors.toSet());\n+    }\n+\n+    Stream<RoleModel> getRolesStream();\n+\n+    @Deprecated\n+    default Set<RoleModel> getRoles(Integer firstResult, Integer maxResults) {\n+        return getRolesStream(firstResult, maxResults).collect(Collectors.toSet());\n+    }\n+\n+    Stream<RoleModel> getRolesStream(Integer firstResult, Integer maxResults);\n+\n+    @Deprecated\n+    default Set<RoleModel> searchForRoles(String search, Integer first, Integer max) {", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1NzgzMQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459757831", "bodyText": "Line 164-167: public List<ClientModel> getClients(RealmModel realm) doesn't have to be implemented here, right? It's deprecated and it's used nowhere.", "author": "vramik", "createdAt": "2020-07-23T22:14:20Z", "path": "model/map/src/main/java/org/keycloak/models/map/client/MapClientProvider.java", "diffHunk": "@@ -152,7 +152,7 @@ public void unregisterNode(String nodeHost) {\n         return Stream.concat(tx.createdValuesStream(clientStore.keySet()), updatedAndNotRemovedClientsStream);\n     }\n \n-//    @Override\n+    @Override", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MDQ3MA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459990470", "bodyText": "removed", "author": "martin-kanis", "createdAt": "2020-07-24T11:11:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1NzgzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NDQyNQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459764425", "bodyText": "This method wasn't declared in previous version of Keycloak, so I believe we don't have to deprecate it and we can remove it instead.", "author": "vramik", "createdAt": "2020-07-23T22:32:07Z", "path": "server-spi/src/main/java/org/keycloak/storage/client/ClientLookupProvider.java", "diffHunk": "@@ -71,22 +73,38 @@\n      * @param clientId Searched substring of the public client\n      *   identifier ({@code client_id} in OIDC or {@code entityID} in SAML.)\n      * @param firstResult First result to return. Ignored if negative or {@code null}.\n-     * @param maxResults Maximim number of results to return. Ignored if negative or {@code null}.\n-     * @return Model of the client, or {@code null} if no client is found.\n+     * @param maxResults Maximum number of results to return. Ignored if negative or {@code null}.\n+     * @return List of ClientModel or an empty list if no client is found.\n+     * @deprecated Use {@link #searchClientsByClientIdStream(org.keycloak.models.RealmModel, java.lang.String, java.lang.Integer, java.lang.Integer)} instead.\n      */\n-    List<ClientModel> searchClientsByClientId(RealmModel realm, String clientId, Integer firstResult, Integer maxResults);\n+    @Deprecated\n+    default List<ClientModel> searchClientsByClientId(RealmModel realm, String clientId, Integer firstResult, Integer maxResults) {", "originalCommit": "40ea3e6b7cf3637006813ad9712be177890f2687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MDM1Ng==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459990356", "bodyText": "removed", "author": "martin-kanis", "createdAt": "2020-07-24T11:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NDQyNQ=="}], "type": "inlineReview"}, {"oid": "1ba4c9c574bfd95071e9a3dfc9c5cec9f65e5c01", "url": "https://github.com/keycloak/keycloak/commit/1ba4c9c574bfd95071e9a3dfc9c5cec9f65e5c01", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-24T05:55:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2ODM3OA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459868378", "bodyText": "nit: not used", "author": "vramik", "createdAt": "2020-07-24T06:10:39Z", "path": "services/src/main/java/org/keycloak/services/DefaultKeycloakSession.java", "diffHunk": "@@ -16,6 +16,7 @@\n  */\n package org.keycloak.services;\n \n+import org.keycloak.Config;", "originalCommit": "1ba4c9c574bfd95071e9a3dfc9c5cec9f65e5c01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MDI4OQ==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459990289", "bodyText": "removed", "author": "martin-kanis", "createdAt": "2020-07-24T11:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2ODM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3MDYwMg==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459870602", "bodyText": "We should add a javadoc for the timeout. What it does and in what units it's expected. Not sure where tha javadoc should be, whether in DefaultKeycloakSessionFactory or DefaultKeycloakSession or ClientStorageManager. Maybe  everywhere? :)", "author": "vramik", "createdAt": "2020-07-24T06:19:39Z", "path": "services/src/main/java/org/keycloak/services/DefaultKeycloakSessionFactory.java", "diffHunk": "@@ -59,6 +59,8 @@\n     // TODO: Likely should be changed to int and use Time.currentTime() to be compatible with all our \"time\" reps\n     protected long serverStartupTimestamp;\n \n+    private long clientStorageProviderTimeout;", "originalCommit": "1ba4c9c574bfd95071e9a3dfc9c5cec9f65e5c01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MzI5Ng==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459883296", "bodyText": "I believe DefaultKeycloakSessionFactory is the right place for the time being, since the configuration option should only be parsed once rather than with every DefaultKeycloakSession instantiation.\nSadly, ClientStorageManager is not instantiated as other SPIs so lacks ability to be configured in the init() method, and we have to simulate it from here. In the future, once we refactor the ClientStorageManager to be more SPI-like, it will be moved accordingly.", "author": "hmlnarik", "createdAt": "2020-07-24T07:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3MDYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MDIzNw==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459990237", "bodyText": "done", "author": "martin-kanis", "createdAt": "2020-07-24T11:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3MDYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk1NjM0Mw==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459956343", "bodyText": "This method IMO should have also javadoc which describes its behavior, because on the first look it's not so obvious.", "author": "vramik", "createdAt": "2020-07-24T09:48:01Z", "path": "services/src/main/java/org/keycloak/storage/ClientStorageManager.java", "diffHunk": "@@ -148,16 +159,22 @@ public ClientModel getClientByClientId(RealmModel realm, String clientId) {\n     }\n \n     @Override\n-    public List<ClientModel> searchClientsByClientId(RealmModel realm, String clientId, Integer firstResult, Integer maxResults) {\n-        List<ClientModel> clients = session.clientLocalStorage().searchClientsByClientId(realm, clientId,  firstResult, maxResults);\n-        if (clients != null) {\n-            return clients;\n-        }\n-        for (ClientLookupProvider provider : getEnabledStorageProviders(session, realm, ClientLookupProvider.class)) {\n-            clients = provider.searchClientsByClientId(realm, clientId, firstResult, maxResults);\n-            if (clients != null) return clients;\n+    public Stream<ClientModel> searchClientsByClientIdStream(RealmModel realm, String clientId, Integer firstResult, Integer maxResults) {", "originalCommit": "1ba4c9c574bfd95071e9a3dfc9c5cec9f65e5c01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5MDE3OA==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r459990178", "bodyText": "done", "author": "martin-kanis", "createdAt": "2020-07-24T11:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk1NjM0Mw=="}], "type": "inlineReview"}, {"oid": "3d703b9c15f1450c9bdce7d296379c6bd8420c06", "url": "https://github.com/keycloak/keycloak/commit/3d703b9c15f1450c9bdce7d296379c6bd8420c06", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-24T11:10:24Z", "type": "forcePushed"}, {"oid": "f953d1f6d54d06448e7d09a182d8d1e187fce80d", "url": "https://github.com/keycloak/keycloak/commit/f953d1f6d54d06448e7d09a182d8d1e187fce80d", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-24T11:22:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NzE2Nw==", "url": "https://github.com/keycloak/keycloak/pull/7263#discussion_r460267167", "bodyText": "nit: copyright missing", "author": "vramik", "createdAt": "2020-07-24T20:15:19Z", "path": "services/src/main/java/org/keycloak/utils/ServicesUtils.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.keycloak.utils;", "originalCommit": "f953d1f6d54d06448e7d09a182d8d1e187fce80d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "94b2c97d293459aed9789fbb3268fcc45f388ff3", "url": "https://github.com/keycloak/keycloak/commit/94b2c97d293459aed9789fbb3268fcc45f388ff3", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-24T20:30:05Z", "type": "commit"}, {"oid": "94b2c97d293459aed9789fbb3268fcc45f388ff3", "url": "https://github.com/keycloak/keycloak/commit/94b2c97d293459aed9789fbb3268fcc45f388ff3", "message": "KEYCLOAK-14220 Complement methods for accessing clients with Stream variants", "committedDate": "2020-07-24T20:30:05Z", "type": "forcePushed"}]}