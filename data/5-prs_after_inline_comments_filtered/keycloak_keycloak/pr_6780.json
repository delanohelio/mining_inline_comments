{"pr_number": 6780, "pr_title": "KEYCLOAK-12958 Preview feature profile for WebAuthn", "pr_createdAt": "2020-02-13T11:52:36Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6780", "timeline": [{"oid": "c3775a1e35a0f373d58887e708438263067c61e3", "url": "https://github.com/keycloak/keycloak/commit/c3775a1e35a0f373d58887e708438263067c61e3", "message": "KEYCLOAK-12958 Preview feature profile for WebAuthn", "committedDate": "2020-02-13T12:14:46Z", "type": "forcePushed"}, {"oid": "db3be2cfb8456e4656e3662c8e577f33fcf823a0", "url": "https://github.com/keycloak/keycloak/commit/db3be2cfb8456e4656e3662c8e577f33fcf823a0", "message": "KEYCLOAK-12958 Preview feature profile for WebAuthn", "committedDate": "2020-02-13T12:58:46Z", "type": "forcePushed"}, {"oid": "8bb5f4bca0e707ab4de4694b0806f5f461bd7b02", "url": "https://github.com/keycloak/keycloak/commit/8bb5f4bca0e707ab4de4694b0806f5f461bd7b02", "message": "KEYCLOAK-12958 Preview feature profile for WebAuthn", "committedDate": "2020-02-13T14:55:29Z", "type": "forcePushed"}, {"oid": "26a78a1eb61b4e2b293bcf98d06fe78713492b70", "url": "https://github.com/keycloak/keycloak/commit/26a78a1eb61b4e2b293bcf98d06fe78713492b70", "message": "KEYCLOAK-12958 Ability to enable features having EnvironmentDependent providers without restart server", "committedDate": "2020-02-24T06:58:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0NDkwOQ==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383144909", "bodyText": "I believe we don't need to enable WebAuthn for the whole test class. This affects only:\n\n  \n    \n      keycloak/testsuite/integration-arquillian/tests/other/base-ui/src/test/java/org/keycloak/testsuite/ui/account2/SigningInTest.java\n    \n    \n        Lines 246 to 254\n      in\n      26a78a1\n    \n    \n    \n    \n\n        \n          \n           @Test \n        \n\n        \n          \n           public void twoFactorWebAuthnTest() { \n        \n\n        \n          \n               testWebAuthn(false); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           @Test \n        \n\n        \n          \n           public void passwordlessWebAuthnTest() { \n        \n\n        \n          \n               testWebAuthn(true); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nIf I understand it correctly, the annotation should work for test methods as well, shouldn't it?", "author": "vmuzikar", "createdAt": "2020-02-24T09:09:25Z", "path": "testsuite/integration-arquillian/tests/other/base-ui/src/test/java/org/keycloak/testsuite/ui/account2/SigningInTest.java", "diffHunk": "@@ -62,6 +64,9 @@\n /**\n  * @author Vaclav Muzikar <vmuzikar@redhat.com>\n  */\n+@EnableFeature(value = Profile.Feature.ACCOUNT2, skipRestart = true)\n+@EnableFeature(value = Profile.Feature.ACCOUNT_API, skipRestart = true)\n+@EnableFeature(value = Profile.Feature.WEB_AUTHN, skipRestart = true)", "originalCommit": "26a78a1eb61b4e2b293bcf98d06fe78713492b70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE2MDI5MA==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383160290", "bodyText": "Scratch that! I completely forgot we configure WebAuthn before running the whole test class. This approach is therefore correct.", "author": "vmuzikar", "createdAt": "2020-02-24T09:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0NDkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3MDg1Mw==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383170853", "bodyText": "There are more tests, which depend on the WebAuthn feature. So, I think, it would be better to keep that for whole class.\nf.e. categoriesTest,setUpLinksTest,...", "author": "mabartos", "createdAt": "2020-02-24T10:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0NDkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3MzEwMA==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383173100", "bodyText": "@mabartos You're, of course, correct. I almost forgot what's in the test I wrote. I guess it's monday... :D", "author": "vmuzikar", "createdAt": "2020-02-24T10:06:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0NDkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0NTUzMw==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383145533", "bodyText": "Is there any reason why to put here the account profile features? Seems a bit redundant, there are already present in the parent class.", "author": "vmuzikar", "createdAt": "2020-02-24T09:10:45Z", "path": "testsuite/integration-arquillian/tests/other/base-ui/src/test/java/org/keycloak/testsuite/ui/account2/SigningInTest.java", "diffHunk": "@@ -62,6 +64,9 @@\n /**\n  * @author Vaclav Muzikar <vmuzikar@redhat.com>\n  */\n+@EnableFeature(value = Profile.Feature.ACCOUNT2, skipRestart = true)\n+@EnableFeature(value = Profile.Feature.ACCOUNT_API, skipRestart = true)", "originalCommit": "26a78a1eb61b4e2b293bcf98d06fe78713492b70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3Njc4NA==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383176784", "bodyText": "AFAIK, the problem is with KeycloakContainerFeaturesController, which manage and prepare all environments to enabling/disabling feature. The controller enable a feature only for specific class, therefore, it doesn't allow inheritance of the enabling/disabling feature from parent. So, the account features should be again explicitly specified.\nI don't know, if it's a good approach, but it's not \"target\" of this PR :)", "author": "mabartos", "createdAt": "2020-02-24T10:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0NTUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3Nzk2Ng==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383177966", "bodyText": "Maybe @mposolda knows more details.", "author": "mabartos", "createdAt": "2020-02-24T10:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0NTUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODQ2Ng==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383218466", "bodyText": "Ok, makes sense. Even though I don't like this redundancy too much, we don't have much options right now. And rewriting KeycloakContainerFeaturesController is really out of scope of this PR.\nCreated KEYCLOAK-13078 for that.", "author": "vmuzikar", "createdAt": "2020-02-24T11:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0NTUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMTIzNw==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383511237", "bodyText": "Is it possible to remove field \"defaultType\" and methods \"setDefaultType\" and \"getType\" from the Feature enum? AFAIK the mutable enums is the antipattern - see for example https://rules.sonarsource.com/java/RSPEC-3066 . Hopefully all occurences of \"f.getType()\" in the further code can be replaced simply with the \"type\", which was retrieved on line 122? For exampe:\nswitch (type) {\n\ninstead of:\nswitch (f.getType()) {\n\netc", "author": "mposolda", "createdAt": "2020-02-24T21:00:21Z", "path": "common/src/main/java/org/keycloak/common/Profile.java", "diffHunk": "@@ -95,6 +119,8 @@ private Profile() {\n \n         for (Feature f : Feature.values()) {\n             Boolean enabled = config.getConfig(f);\n+            Type type = product.equals(ProductValue.RHSSO) ? f.getTypeProduct() : f.getTypeProject();", "originalCommit": "516cf5dc8b1f4749cbf21101572780a4eb11e1a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzOTcxMA==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383539710", "bodyText": "@mposolda I see, it's good to know that. I've just wanted to ensure the getType() method really works. Thanks!", "author": "mabartos", "createdAt": "2020-02-24T21:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMTIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNTQ4NA==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383515484", "bodyText": "I see there are failing tests on travis. Maybe the check for \"Profile.getName().equals(\"product\")\" should be removed from this line and the check should be always disabled to have the tests passing?", "author": "mposolda", "createdAt": "2020-02-24T21:09:26Z", "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/arquillian/containers/KeycloakContainerFeaturesController.java", "diffHunk": "@@ -86,20 +86,32 @@ public UpdateFeature(Profile.Feature feature, boolean skipRestart, FeatureAction\n          *\n          */\n         private void assertValid() {\n+            if (shouldSkipValidation())\n+                return;\n+\n             assertThat(\"An annotation requested to \" + action.name()\n                             + \" feature \" + feature.name() + \" however it was already in that state\" ,\n                     ProfileAssume.isFeatureEnabled(feature),\n                     is(!(action == FeatureAction.ENABLE)));\n         }\n \n         private void assertPerformed() {\n+            if (shouldSkipValidation())\n+                return;\n+\n             assertThat(\"An annotation requested to \" + action.name() +\n                             \" feature \" + feature.name() + \", however after performing this operation \" +\n                             \"the feature is not in desired state\" ,\n                     ProfileAssume.isFeatureEnabled(feature),\n                     is(action == FeatureAction.ENABLE));\n         }\n \n+        private boolean shouldSkipValidation() {\n+            // KEYCLOAK-12895 - Some features might be in product disabled and in project enabled.\n+            // In this case, the current state of the feature can be different.\n+            return feature.hasDifferentProductType() && Profile.getName().equals(\"product\");", "originalCommit": "516cf5dc8b1f4749cbf21101572780a4eb11e1a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0MjA3OQ==", "url": "https://github.com/keycloak/keycloak/pull/6780#discussion_r383542079", "bodyText": "Ok, at this time, it could be removed.", "author": "mabartos", "createdAt": "2020-02-24T22:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNTQ4NA=="}], "type": "inlineReview"}, {"oid": "b08438f95879e2a9f06b0b0c9c3b05526df37413", "url": "https://github.com/keycloak/keycloak/commit/b08438f95879e2a9f06b0b0c9c3b05526df37413", "message": "KEYCLOAK-12958 WebAuthn profile product/project", "committedDate": "2020-02-25T13:52:08Z", "type": "forcePushed"}, {"oid": "f4d698198790525199f7cfd80aadb22cf7f8c859", "url": "https://github.com/keycloak/keycloak/commit/f4d698198790525199f7cfd80aadb22cf7f8c859", "message": "KEYCLOAK-12958 Preview feature profile for WebAuthn", "committedDate": "2020-02-25T16:15:43Z", "type": "commit"}, {"oid": "8b298a71701781cd8dc4b585785dc06d8ac371b6", "url": "https://github.com/keycloak/keycloak/commit/8b298a71701781cd8dc4b585785dc06d8ac371b6", "message": "KEYCLOAK-12958 Ability to enable features having EnvironmentDependent providers without restart server", "committedDate": "2020-02-25T16:15:43Z", "type": "commit"}, {"oid": "1e7275801dcd5f4fcbc51e8d1aa41a3d371e6384", "url": "https://github.com/keycloak/keycloak/commit/1e7275801dcd5f4fcbc51e8d1aa41a3d371e6384", "message": "KEYCLOAK-12958 WebAuthn profile product/project", "committedDate": "2020-02-25T16:15:43Z", "type": "commit"}, {"oid": "1e7275801dcd5f4fcbc51e8d1aa41a3d371e6384", "url": "https://github.com/keycloak/keycloak/commit/1e7275801dcd5f4fcbc51e8d1aa41a3d371e6384", "message": "KEYCLOAK-12958 WebAuthn profile product/project", "committedDate": "2020-02-25T16:15:43Z", "type": "forcePushed"}]}