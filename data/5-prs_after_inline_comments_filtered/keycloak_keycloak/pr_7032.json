{"pr_number": 7032, "pr_title": "KEYCLOAK-4593: Moved NamedQuery to entity attribute to improve perfor\u2026", "pr_createdAt": "2020-05-01T18:10:25Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7032", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODkyMw==", "url": "https://github.com/keycloak/keycloak/pull/7032#discussion_r431538923", "bodyText": "Removing this flush inside the for loop decreased the whoamI request a lot....", "author": "YaoFu-ea", "createdAt": "2020-05-28T01:54:12Z", "path": "model/jpa/src/main/java/org/keycloak/models/jpa/JpaRealmProvider.java", "diffHunk": "@@ -120,7 +120,6 @@ public RealmModel getRealm(String id) {\n         for (String id : entities) {\n             RealmModel realm = session.realms().getRealm(id);\n             if (realm != null) realms.add(realm);\n-            em.flush();", "originalCommit": "24d6362296ccde8dc282dfc3d5dcf6403896641e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2OTc0Mg==", "url": "https://github.com/keycloak/keycloak/pull/7032#discussion_r449669742", "bodyText": "This is interesting point. See #6012, the call to flush reportedly improved the performance for bigger number of realms.  As I mentioned in the #6012 (review) comment, I'd rather have no flush whatsoever in the JPA layer. Yet now I wonder which of the alternatives is better.\nCould you please try the same patch without this flush and report the results here?", "author": "hmlnarik", "createdAt": "2020-07-03T17:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI4Njc1Mw==", "url": "https://github.com/keycloak/keycloak/pull/7032#discussion_r455286753", "bodyText": "Hi, @hmlnarik\nI've tested with 560 realms in KC 9.0.4 where the fix is originally committed:\n\nWith flush: Takes around 11min\nWithout flush: Takes around 1min\nPlease let me know if more results are needed. Thanks!", "author": "YaoFu-ea", "createdAt": "2020-07-15T19:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODkyMw=="}], "type": "inlineReview"}, {"oid": "0e9972c0cb60e90595172a36afff8ef5db02f953", "url": "https://github.com/keycloak/keycloak/commit/0e9972c0cb60e90595172a36afff8ef5db02f953", "message": "KEYCLOAK-4593: Remove em.flush to help performance with large realms", "committedDate": "2020-06-09T18:44:56Z", "type": "forcePushed"}, {"oid": "5e9ec13c0bd7f96d45602304730723f2e352c9d3", "url": "https://github.com/keycloak/keycloak/commit/5e9ec13c0bd7f96d45602304730723f2e352c9d3", "message": "KEYCLOAK-4593: Remove em.flush to help performance with large realms", "committedDate": "2020-06-09T21:07:57Z", "type": "forcePushed"}, {"oid": "1b5b7f2fd7b90c48911cd9d2390c022caea4d1cc", "url": "https://github.com/keycloak/keycloak/commit/1b5b7f2fd7b90c48911cd9d2390c022caea4d1cc", "message": "KEYCLOAK-4593: Remove em.flush to help performance with large realms", "committedDate": "2020-07-15T15:17:05Z", "type": "forcePushed"}, {"oid": "33109237dd29c66edd4d40c7ab9be8075e426474", "url": "https://github.com/keycloak/keycloak/commit/33109237dd29c66edd4d40c7ab9be8075e426474", "message": "KEYCLOAK-4593: Moved NamedQuery to entity attribute to improve performance", "committedDate": "2020-07-15T15:39:58Z", "type": "forcePushed"}, {"oid": "24ae1cf909bf362f6a46b88b21650c8ae04dc773", "url": "https://github.com/keycloak/keycloak/commit/24ae1cf909bf362f6a46b88b21650c8ae04dc773", "message": "KEYCLOAK-4593: Moved NamedQuery to entity attribute to improve performance", "committedDate": "2020-07-15T19:11:26Z", "type": "commit"}, {"oid": "24ae1cf909bf362f6a46b88b21650c8ae04dc773", "url": "https://github.com/keycloak/keycloak/commit/24ae1cf909bf362f6a46b88b21650c8ae04dc773", "message": "KEYCLOAK-4593: Moved NamedQuery to entity attribute to improve performance", "committedDate": "2020-07-15T19:11:26Z", "type": "forcePushed"}]}