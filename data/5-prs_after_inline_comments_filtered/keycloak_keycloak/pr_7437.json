{"pr_number": 7437, "pr_title": "KEYCLOAK-14231 - validate supported locales", "pr_createdAt": "2020-09-22T12:39:40Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7437", "timeline": [{"oid": "a056e64dbb7eaedfeee963ae37abfcc352271d5f", "url": "https://github.com/keycloak/keycloak/commit/a056e64dbb7eaedfeee963ae37abfcc352271d5f", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-23T06:31:39Z", "type": "forcePushed"}, {"oid": "52c924dda25fa5e2bbca8a55467164fbb04271c9", "url": "https://github.com/keycloak/keycloak/commit/52c924dda25fa5e2bbca8a55467164fbb04271c9", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-24T11:49:17Z", "type": "forcePushed"}, {"oid": "055263071cf06da7d86a911e8c89c9ba22194290", "url": "https://github.com/keycloak/keycloak/commit/055263071cf06da7d86a911e8c89c9ba22194290", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-24T11:52:29Z", "type": "forcePushed"}, {"oid": "57b2c62cc6d3d14047eff882a4260ae78db0be96", "url": "https://github.com/keycloak/keycloak/commit/57b2c62cc6d3d14047eff882a4260ae78db0be96", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-24T11:53:13Z", "type": "forcePushed"}, {"oid": "eb089b7808a44dd570695bbbc68a5f8b89eb3d15", "url": "https://github.com/keycloak/keycloak/commit/eb089b7808a44dd570695bbbc68a5f8b89eb3d15", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-24T19:25:37Z", "type": "forcePushed"}, {"oid": "abe0a06d203d559e811a4727d0912ac3482db7a2", "url": "https://github.com/keycloak/keycloak/commit/abe0a06d203d559e811a4727d0912ac3482db7a2", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-29T15:35:47Z", "type": "forcePushed"}, {"oid": "58e3678f841eec9c4268d9a57bc1fade73bbce9e", "url": "https://github.com/keycloak/keycloak/commit/58e3678f841eec9c4268d9a57bc1fade73bbce9e", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-30T08:21:16Z", "type": "forcePushed"}, {"oid": "f0d3fd9b3555f0c6663cebe0c4179d5f8197222f", "url": "https://github.com/keycloak/keycloak/commit/f0d3fd9b3555f0c6663cebe0c4179d5f8197222f", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-30T12:59:47Z", "type": "forcePushed"}, {"oid": "cfe119bd026f52147d8fdf554d9fd392e0c4c35d", "url": "https://github.com/keycloak/keycloak/commit/cfe119bd026f52147d8fdf554d9fd392e0c4c35d", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-30T13:00:44Z", "type": "forcePushed"}, {"oid": "c3fd6fe2b02f45c763cfa5aaa42fe0a04fbf90ee", "url": "https://github.com/keycloak/keycloak/commit/c3fd6fe2b02f45c763cfa5aaa42fe0a04fbf90ee", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-30T13:02:47Z", "type": "forcePushed"}, {"oid": "8e0c641a238b91999e6537ac849bb82e12a38a99", "url": "https://github.com/keycloak/keycloak/commit/8e0c641a238b91999e6537ac849bb82e12a38a99", "message": "KEYCLOAK-14231 - supported locales, validate reserved chars", "committedDate": "2020-09-30T15:55:40Z", "type": "forcePushed"}, {"oid": "ddcbb0f6532893512aa9ac236ee6c644dccc49d5", "url": "https://github.com/keycloak/keycloak/commit/ddcbb0f6532893512aa9ac236ee6c644dccc49d5", "message": "KEYCLOAK-14231 - validate supported locales", "committedDate": "2020-10-01T11:39:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NjcxOQ==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r498666719", "bodyText": "This is not in line with https://tools.ietf.org/html/rfc3986#section-2.2 anymore. Is this intended? If so, needs to be justified in the comment above", "author": "hmlnarik", "createdAt": "2020-10-02T07:51:59Z", "path": "services/src/main/java/org/keycloak/utils/ReservedCharValidator.java", "diffHunk": "@@ -19,17 +19,20 @@\n import javax.ws.rs.BadRequestException;\n import org.jboss.logging.Logger;\n \n+import java.util.Set;\n+\n /**\n  *\n  * @author Stan Silvert\n+ * @author Lukas Hanusovsky lhanusov@redhat.com\n  */\n public class ReservedCharValidator {\n     protected static final Logger logger = Logger.getLogger(ReservedCharValidator.class);\n     \n     // https://tools.ietf.org/html/rfc3986#section-2.2\n-    private static final String[] RESERVED_CHARS = { \":\", \"/\", \"?\", \"#\", \"[\", \"@\", \"!\", \"$\", \n+    private static final String[] RESERVED_CHARS = { \":\", \"/\", \"?\", \"#\", \"@\", \"!\", \"$\",\n                                                    \"&\", \"(\", \")\", \"*\", \"+\", \",\", \";\", \"=\", \n-                                                   \"]\", \"[\", \"\\\\\" };\n+                                                   \"]\", \"[\", \"\\\\\", \"{\", \"}\", \"%\" };", "originalCommit": "ddcbb0f6532893512aa9ac236ee6c644dccc49d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY5MjU5NA==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r498692594", "bodyText": "Thank you for your comments, I added there the comment with justification and also changed the Set into Iterable.", "author": "lhanusov", "createdAt": "2020-10-02T08:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NjcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkxOTU1NA==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r501919554", "bodyText": "I wonder if adding those three characters could break things for existing users?", "author": "ssilvert", "createdAt": "2020-10-08T18:14:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NjcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NzE0Nw==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r498667147", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static void validate(Set<String> strSet) throws ReservedCharException {\n          \n          \n            \n                public static void validate(Iterable<String> strSet) throws ReservedCharException {", "author": "hmlnarik", "createdAt": "2020-10-02T07:52:48Z", "path": "services/src/main/java/org/keycloak/utils/ReservedCharValidator.java", "diffHunk": "@@ -44,6 +47,14 @@ public static void validate(String str) throws ReservedCharException {\n             } \n         }\n     }\n+\n+    public static void validate(Set<String> strSet) throws ReservedCharException {", "originalCommit": "ddcbb0f6532893512aa9ac236ee6c644dccc49d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3bdb57de09cef9127f24528f4a2555a91b8865a3", "url": "https://github.com/keycloak/keycloak/commit/3bdb57de09cef9127f24528f4a2555a91b8865a3", "message": "KEYCLOAK-14231 - validate supported locales", "committedDate": "2020-10-02T08:37:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ3MDUxNg==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r501470516", "bodyText": "@ssilvert I changed the ReservedChars array and added there 3 new chars. Also Hynek proposed to refactor the whole class and change the for-each loop into regex validation. What do you think?", "author": "lhanusov", "createdAt": "2020-10-08T06:13:06Z", "path": "services/src/main/java/org/keycloak/utils/ReservedCharValidator.java", "diffHunk": "@@ -22,14 +22,16 @@\n /**\n  *\n  * @author Stan Silvert\n+ * @author Lukas Hanusovsky lhanusov@redhat.com\n  */\n public class ReservedCharValidator {", "originalCommit": "3bdb57de09cef9127f24528f4a2555a91b8865a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkxNjQ3OQ==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r501916479", "bodyText": "You can code it either way.  If you use regex then you might lose the ability to report which character was disallowed?", "author": "ssilvert", "createdAt": "2020-10-08T18:09:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ3MDUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4MTg5Mg==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r501981892", "bodyText": "You can get the disallowed character encountered by the regex via capturing groups. Regex has linear complexity while current validate complexity is O(nm).", "author": "hmlnarik", "createdAt": "2020-10-08T20:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ3MDUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2MjE0NQ==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r503462145", "bodyText": "You can get the disallowed character encountered by the regex via capturing groups. Regex has linear complexity while current validate complexity is O(nm).\n\nI doubt that there is actually a meaningful performance benefit because n and m are so small.  And regex solutions often to lead to code that is hard to read.\nBut like I said, either way is fine with me.", "author": "ssilvert", "createdAt": "2020-10-12T18:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ3MDUxNg=="}], "type": "inlineReview"}, {"oid": "c97985c47c02a8be298b0b335123dfaa565cfa4b", "url": "https://github.com/keycloak/keycloak/commit/c97985c47c02a8be298b0b335123dfaa565cfa4b", "message": "KEYCLOAK-14231 - validate supported locales", "committedDate": "2020-11-09T11:11:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczMzY0Mw==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r519733643", "bodyText": "Missing\n        if (str == null) return;", "author": "hmlnarik", "createdAt": "2020-11-09T11:19:41Z", "path": "services/src/main/java/org/keycloak/utils/ReservedCharValidator.java", "diffHunk": "@@ -19,29 +19,46 @@\n import javax.ws.rs.BadRequestException;\n import org.jboss.logging.Logger;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n /**\n  *\n  * @author Stan Silvert\n+ * @author Lukas Hanusovsky lhanusov@redhat.com\n  */\n public class ReservedCharValidator {\n     protected static final Logger logger = Logger.getLogger(ReservedCharValidator.class);\n     \n     // https://tools.ietf.org/html/rfc3986#section-2.2\n-    private static final String[] RESERVED_CHARS = { \":\", \"/\", \"?\", \"#\", \"[\", \"@\", \"!\", \"$\", \n-                                                   \"&\", \"(\", \")\", \"*\", \"+\", \",\", \";\", \"=\", \n-                                                   \"]\", \"[\", \"\\\\\" };\n+    private static final Pattern RESERVED_CHARS_PATTERN = Pattern.compile(\"[:/?#@!$&()*+,;=\\\\[\\\\]\\\\\\\\]\");\n+\n+    // KEYCLOAK-14231 - Supported Locales: Three new characters were added on top of this RFC: \"{\", \"}\", \"%\"\n+    private static final Pattern RESERVED_CHARS_LOCALES_PATTERN = Pattern.compile(\"[:/?#@!$&()*+,;=\\\\[\\\\]\\\\\\\\{}%]\");\n+\n     private ReservedCharValidator() {}\n-    \n-    public static void validate(String str) throws ReservedCharException {\n+\n+    public static void validate(String str, Pattern pattern) throws ReservedCharException {", "originalCommit": "c97985c47c02a8be298b0b335123dfaa565cfa4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczMzY3MQ==", "url": "https://github.com/keycloak/keycloak/pull/7437#discussion_r519733671", "bodyText": "This is weird and I understand that this is based on the original code. Please replace with\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ReservedCharException e = new ReservedCharException(message);\n          \n          \n            \n                        logger.warn(message, e);\n          \n          \n            \n                        throw e;\n          \n          \n            \n                        logger.warn(message);\n          \n          \n            \n                        throw new ReservedCharException(message);", "author": "hmlnarik", "createdAt": "2020-11-09T11:19:44Z", "path": "services/src/main/java/org/keycloak/utils/ReservedCharValidator.java", "diffHunk": "@@ -19,29 +19,46 @@\n import javax.ws.rs.BadRequestException;\n import org.jboss.logging.Logger;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n /**\n  *\n  * @author Stan Silvert\n+ * @author Lukas Hanusovsky lhanusov@redhat.com\n  */\n public class ReservedCharValidator {\n     protected static final Logger logger = Logger.getLogger(ReservedCharValidator.class);\n     \n     // https://tools.ietf.org/html/rfc3986#section-2.2\n-    private static final String[] RESERVED_CHARS = { \":\", \"/\", \"?\", \"#\", \"[\", \"@\", \"!\", \"$\", \n-                                                   \"&\", \"(\", \")\", \"*\", \"+\", \",\", \";\", \"=\", \n-                                                   \"]\", \"[\", \"\\\\\" };\n+    private static final Pattern RESERVED_CHARS_PATTERN = Pattern.compile(\"[:/?#@!$&()*+,;=\\\\[\\\\]\\\\\\\\]\");\n+\n+    // KEYCLOAK-14231 - Supported Locales: Three new characters were added on top of this RFC: \"{\", \"}\", \"%\"\n+    private static final Pattern RESERVED_CHARS_LOCALES_PATTERN = Pattern.compile(\"[:/?#@!$&()*+,;=\\\\[\\\\]\\\\\\\\{}%]\");\n+\n     private ReservedCharValidator() {}\n-    \n-    public static void validate(String str) throws ReservedCharException {\n+\n+    public static void validate(String str, Pattern pattern) throws ReservedCharException {\n+        Matcher matcher = pattern.matcher(str);\n+        if (matcher.find()) {\n+            String message = \"Character '\" + matcher.group() + \"' not allowed.\";\n+            ReservedCharException e = new ReservedCharException(message);\n+            logger.warn(message, e);\n+            throw e;", "originalCommit": "c97985c47c02a8be298b0b335123dfaa565cfa4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b9e0c0d647b64691646b4cc6082a3b6d78293ee9", "url": "https://github.com/keycloak/keycloak/commit/b9e0c0d647b64691646b4cc6082a3b6d78293ee9", "message": "KEYCLOAK-14231 - validate supported locales", "committedDate": "2020-11-09T12:02:50Z", "type": "forcePushed"}, {"oid": "47f1e54f25503484d206eea5b95407e714dbdff9", "url": "https://github.com/keycloak/keycloak/commit/47f1e54f25503484d206eea5b95407e714dbdff9", "message": "KEYCLOAK-14231 - validate supported locales", "committedDate": "2020-11-24T15:33:44Z", "type": "forcePushed"}, {"oid": "55b6294b4beb5e859a01312a9b342b40d3ebb23c", "url": "https://github.com/keycloak/keycloak/commit/55b6294b4beb5e859a01312a9b342b40d3ebb23c", "message": "KEYCLOAK-14231 - validate supported locales", "committedDate": "2020-11-30T09:17:31Z", "type": "forcePushed"}, {"oid": "acef07832f4c7a2adb57ab20539ed502b5a9e037", "url": "https://github.com/keycloak/keycloak/commit/acef07832f4c7a2adb57ab20539ed502b5a9e037", "message": "KEYCLOAK-14231 - validate supported locales", "committedDate": "2020-12-02T07:47:29Z", "type": "commit"}, {"oid": "acef07832f4c7a2adb57ab20539ed502b5a9e037", "url": "https://github.com/keycloak/keycloak/commit/acef07832f4c7a2adb57ab20539ed502b5a9e037", "message": "KEYCLOAK-14231 - validate supported locales", "committedDate": "2020-12-02T07:47:29Z", "type": "forcePushed"}]}