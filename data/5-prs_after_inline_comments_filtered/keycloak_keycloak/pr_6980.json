{"pr_number": 6980, "pr_title": "KEYCLOAK-13817 Fix X509 auth fails when attribute value is always read from LDAP and import is enabled", "pr_createdAt": "2020-04-15T20:08:32Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6980", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1MDA5MA==", "url": "https://github.com/keycloak/keycloak/pull/6980#discussion_r409550090", "bodyText": "I think it will be good to remove method \"shouldUserAttributeBeAlwaysReadFromLdap\" (and any new things related to that added in this PR) and just always add the proxy to the results.\nRegarding this, it may be also good to update a bit method UserStorageManager.query and make sure that duplicates are not returned. As currently UserStorageMAnager.query returns stuff from multiple providers, so it can probably return duplicated stuff in some cases (EG. in case that LDAP user was imported and attribute \"foo\" with value \"bar\" is available in both the DB and LDAP)", "author": "mposolda", "createdAt": "2020-04-16T13:21:00Z", "path": "federation/ldap/src/main/java/org/keycloak/storage/ldap/LDAPStorageProvider.java", "diffHunk": "@@ -237,16 +233,33 @@ public boolean supportsCredentialAuthenticationFor(String type) {\n \n              for (LDAPObject ldapUser : ldapObjects) {\n                  String ldapUsername = LDAPUtils.getUsername(ldapUser, this.ldapIdentityStore.getConfig());\n-                 if (session.userLocalStorage().getUserByUsername(ldapUsername, realm) == null) {\n+                 UserModel localUser = session.userLocalStorage().getUserByUsername(ldapUsername, realm);\n+                 if (localUser == null) {\n                      UserModel imported = importUserFromLDAP(session, realm, ldapUser);\n                      searchResults.add(imported);\n+                 } else if (shouldUserAttributeBeAlwaysReadFromLdap(realm, attrName)) {\n+                     searchResults.add(proxy(realm, localUser, ldapUser));", "originalCommit": "eadd80d94ff2d4bf181947afe688e25fb69d1d04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NTIyOQ==", "url": "https://github.com/keycloak/keycloak/pull/6980#discussion_r409795229", "bodyText": "In which case would we consider two users from different stores to be duplicates?\nThey may be duplicates when user from LDAP has been imported to local store. Then LDAP user and user from local store could be considered duplicates.\nShould we treat users from (let say) a custom storage provider and the LDAP provider to be duplicates (e.g. when usernames are equal)?\nAnd if we have duplicates, which user model should be removed from the result set?\nIs it always the one from the local store, because the one from LDAP provider will always proxy the local one anyways?", "author": "sventorben", "createdAt": "2020-04-16T19:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1MDA5MA=="}], "type": "inlineReview"}, {"oid": "54865a66ab555f60dd0b09b9b5c133aebccf5363", "url": "https://github.com/keycloak/keycloak/commit/54865a66ab555f60dd0b09b9b5c133aebccf5363", "message": "KEYCLOAK-13817 Return local user from LDAPStorageProvider", "committedDate": "2020-04-21T19:33:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc3ODA0NQ==", "url": "https://github.com/keycloak/keycloak/pull/6980#discussion_r423778045", "bodyText": "Please remove star imports and replace with individual classes", "author": "mposolda", "createdAt": "2020-05-12T14:26:35Z", "path": "federation/ldap/src/main/java/org/keycloak/storage/ldap/LDAPStorageProvider.java", "diffHunk": "@@ -58,10 +57,7 @@\n import org.keycloak.storage.ldap.idm.query.internal.LDAPQueryConditionsBuilder;\n import org.keycloak.storage.ldap.idm.store.ldap.LDAPIdentityStore;\n import org.keycloak.storage.ldap.kerberos.LDAPProviderKerberosConfig;\n-import org.keycloak.storage.ldap.mappers.LDAPOperationDecorator;\n-import org.keycloak.storage.ldap.mappers.LDAPStorageMapper;\n-import org.keycloak.storage.ldap.mappers.LDAPStorageMapperManager;\n-import org.keycloak.storage.ldap.mappers.PasswordUpdateCallback;\n+import org.keycloak.storage.ldap.mappers.*;", "originalCommit": "54865a66ab555f60dd0b09b9b5c133aebccf5363", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc3ODE4OQ==", "url": "https://github.com/keycloak/keycloak/pull/6980#discussion_r423778189", "bodyText": "Please remove star imports and replace with individual classes", "author": "mposolda", "createdAt": "2020-05-12T14:26:47Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/federation/ldap/LDAPNoCacheTest.java", "diffHunk": "@@ -52,7 +53,12 @@\n import org.keycloak.testsuite.util.LDAPTestUtils;\n import org.keycloak.testsuite.util.MailUtils;\n \n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.not;\n+import static org.hamcrest.Matchers.*;", "originalCommit": "54865a66ab555f60dd0b09b9b5c133aebccf5363", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9699bd539f788757baab1efd6e57b55e3d1c1fd2", "url": "https://github.com/keycloak/keycloak/commit/9699bd539f788757baab1efd6e57b55e3d1c1fd2", "message": "KEYCLOAK-13817 Fix X509 auth fails\n\nwhen attribute value is always read from LDAP and import is enabled\n\nWhen userattribute value is always read from LDAP, then the value is not\navailable in the local store. Therfore, KC will not find a user by that\nattribute in the local store. When querying the LDAP storage\nprovider, the user will be found. However, when it is also available in\nthe local store (though without the attribute) it will not get imported\nand therefore not returned with the result set of the LDAP storage\nprovider. Hence, the user will not be found at all.\n\nThis change adds the user to the result set of the LDAP user stoage\nprovider, iff the attribute user by the search is set to always read\nvalue from LDAP.", "committedDate": "2020-05-12T15:29:52Z", "type": "commit"}, {"oid": "abd34c7d078da4ba522c8b1de981f4cca828adc9", "url": "https://github.com/keycloak/keycloak/commit/abd34c7d078da4ba522c8b1de981f4cca828adc9", "message": "KEYCLOAK-13817 Return local user from LDAPStorageProvider", "committedDate": "2020-05-12T15:29:52Z", "type": "commit"}, {"oid": "b07518e0b697af34b0133a9b91eb2e2cc43b079a", "url": "https://github.com/keycloak/keycloak/commit/b07518e0b697af34b0133a9b91eb2e2cc43b079a", "message": "Remove *-imports", "committedDate": "2020-05-12T15:29:53Z", "type": "commit"}, {"oid": "b07518e0b697af34b0133a9b91eb2e2cc43b079a", "url": "https://github.com/keycloak/keycloak/commit/b07518e0b697af34b0133a9b91eb2e2cc43b079a", "message": "Remove *-imports", "committedDate": "2020-05-12T15:29:53Z", "type": "forcePushed"}]}