{"pr_number": 6734, "pr_title": "KEYCLOAK-12749 fix \"invalid state\" error due to IE requesting favicon", "pr_createdAt": "2020-02-05T14:18:17Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6734", "timeline": [{"oid": "705d912cbfc3e7afa17935736f70e644f88824fb", "url": "https://github.com/keycloak/keycloak/commit/705d912cbfc3e7afa17935736f70e644f88824fb", "message": "KEYCLOAK-12749 fix \"invalid state\" error due to IE requesting favicon\n\nInternet Explorer occasionally requests a favicon before doing the\nactual redirect to localhost. This commit adds Undertow to properly\nhandle those unwanted requests.", "committedDate": "2020-02-05T14:06:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU4NjQxMQ==", "url": "https://github.com/keycloak/keycloak/pull/6734#discussion_r382586411", "bodyText": "You can use org.keycloak.OAuth2Constants#ERROR_DESCRIPTION. The server should return OAuth2Constants#ERROR_DESCRIPTION and not \"error-description\".", "author": "pedroigor", "createdAt": "2020-02-21T13:42:05Z", "path": "adapters/oidc/installed/src/main/java/org/keycloak/adapters/installed/KeycloakInstalled.java", "diffHunk": "@@ -613,96 +610,86 @@ private String readCode(Reader reader) throws IOException {\n         return sb.toString();\n     }\n \n+    KeycloakInstalled(int i) {\n \n-    public class CallbackListener extends Thread {\n+    }\n \n-        private ServerSocket server;\n+    class CallbackListener implements HttpHandler {\n+        private final CountDownLatch shutdownSignal = new CountDownLatch(1);\n \n         private String code;\n-\n         private String error;\n-\n         private String errorDescription;\n+        private String state;\n+        private Undertow server;\n \n-        private IOException errorException;\n+        private GracefulShutdownHandler gracefulShutdownHandler;\n \n-        private String state;\n+        public void start() {\n+            PathHandler pathHandler = Handlers.path().addExactPath(\"/\", this);\n+            AllowedMethodsHandler allowedMethodsHandler = new AllowedMethodsHandler(pathHandler, Methods.GET);\n+            gracefulShutdownHandler = Handlers.gracefulShutdown(allowedMethodsHandler);\n+\n+            server = Undertow.builder()\n+                    .addHttpListener(0, \"localhost\")\n+                    .setHandler(gracefulShutdownHandler).build();\n \n-        private Socket socket;\n+            server.start();\n+        }\n \n-        private HttpResponseWriter writer;\n+        public void stop() {\n+            server.stop();\n+        }\n \n-        public CallbackListener(HttpResponseWriter writer) throws IOException {\n-            this.writer = writer;\n-            server = new ServerSocket(0);\n+        public int getLocalPort() {\n+            return ((InetSocketAddress) server.getListenerInfo().get(0).getAddress()).getPort();\n+        }\n+\n+        public void await() throws InterruptedException {\n+            shutdownSignal.await();\n         }\n \n         @Override\n-        public void run() {\n-            try {\n-                socket = server.accept();\n-\n-                BufferedReader br = new BufferedReader(new InputStreamReader(socket.getInputStream()));\n-                String request = br.readLine();\n-\n-                String url = request.split(\" \")[1];\n-                if (url.indexOf('?') >= 0) {\n-                    url = url.split(\"\\\\?\")[1];\n-                    String[] params = url.split(\"&\");\n-\n-                    for (String param : params) {\n-                        String[] p = param.split(\"=\");\n-                        if (p[0].equals(OAuth2Constants.CODE)) {\n-                            code = p[1];\n-                        } else if (p[0].equals(OAuth2Constants.ERROR)) {\n-                            error = p[1];\n-                        } else if (p[0].equals(\"error-description\")) {\n-                            errorDescription = p[1];\n-                        } else if (p[0].equals(OAuth2Constants.STATE)) {\n-                            state = p[1];\n-                        }\n-                    }\n-                }\n+        public void handleRequest(HttpServerExchange exchange) throws Exception {\n+            gracefulShutdownHandler.shutdown();\n \n-                OutputStreamWriter out = new OutputStreamWriter(socket.getOutputStream());\n-                PrintWriter pw = new PrintWriter(out);\n-                if (writer != null) {\n-                    System.err.println(\"Using a writer is deprecated.  Please remove its usage.  This is now handled by endpoint on server\");\n-                }\n+            if (!exchange.getQueryParameters().isEmpty()) {\n+                readQueryParameters(exchange);\n+            }\n \n-                if (error == null) {\n-                     if (writer != null) {\n-                         writer.success(pw, KeycloakInstalled.this);\n-                     } else {\n-                         pw.println(\"HTTP/1.1 302 Found\");\n-                         pw.println(\"Location: \" + deployment.getTokenUrl().replace(\"/token\", \"/delegated\"));\n+            exchange.setStatusCode(StatusCodes.FOUND);\n+            exchange.getResponseHeaders().add(Headers.LOCATION, getRedirectUrl());\n+            exchange.endExchange();\n \n-                     }\n-                } else {\n-                    if (writer != null) {\n-                        writer.failure(pw, KeycloakInstalled.this);\n-                    } else {\n-                        pw.println(\"HTTP/1.1 302 Found\");\n-                        pw.println(\"Location: \" + deployment.getTokenUrl().replace(\"/token\", \"/delegated?error=true\"));\n+            shutdownSignal.countDown();\n \n-                    }\n-                }\n-                pw.flush();\n-                socket.close();\n-            } catch (IOException e) {\n-                errorException = e;\n-            }\n+            ForkJoinPool.commonPool().execute(this::stop);\n+        }\n \n-            try {\n-                server.close();\n-            } catch (IOException e) {\n-            }\n+        private void readQueryParameters(HttpServerExchange exchange) {\n+            code = getQueryParameterIfPresent(exchange, OAuth2Constants.CODE);\n+            error = getQueryParameterIfPresent(exchange, OAuth2Constants.ERROR);\n+            errorDescription = getQueryParameterIfPresent(exchange, \"error-description\");", "originalCommit": "705d912cbfc3e7afa17935736f70e644f88824fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MTMxMA==", "url": "https://github.com/keycloak/keycloak/pull/6734#discussion_r382671310", "bodyText": "Good point. I already changed that locally to ERROR_DESCRIPTION but then I realized the _ vs. -. Thought it was by intention.", "author": "thokuest", "createdAt": "2020-02-21T16:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU4NjQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU5NDQxMA==", "url": "https://github.com/keycloak/keycloak/pull/6734#discussion_r382594410", "bodyText": "Maybe you can set a single IO/Worker thread as follows:\n.setIoThreads(1)\n.setWorkerThreads(1)", "author": "pedroigor", "createdAt": "2020-02-21T13:58:47Z", "path": "adapters/oidc/installed/src/main/java/org/keycloak/adapters/installed/KeycloakInstalled.java", "diffHunk": "@@ -613,96 +610,86 @@ private String readCode(Reader reader) throws IOException {\n         return sb.toString();\n     }\n \n+    KeycloakInstalled(int i) {\n \n-    public class CallbackListener extends Thread {\n+    }\n \n-        private ServerSocket server;\n+    class CallbackListener implements HttpHandler {\n+        private final CountDownLatch shutdownSignal = new CountDownLatch(1);\n \n         private String code;\n-\n         private String error;\n-\n         private String errorDescription;\n+        private String state;\n+        private Undertow server;\n \n-        private IOException errorException;\n+        private GracefulShutdownHandler gracefulShutdownHandler;\n \n-        private String state;\n+        public void start() {\n+            PathHandler pathHandler = Handlers.path().addExactPath(\"/\", this);\n+            AllowedMethodsHandler allowedMethodsHandler = new AllowedMethodsHandler(pathHandler, Methods.GET);\n+            gracefulShutdownHandler = Handlers.gracefulShutdown(allowedMethodsHandler);\n+\n+            server = Undertow.builder()", "originalCommit": "705d912cbfc3e7afa17935736f70e644f88824fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU5OTcxMw==", "url": "https://github.com/keycloak/keycloak/pull/6734#discussion_r382599713", "bodyText": "We should probably advertise in our change notes the removal of HttpResponseWriter from the API?", "author": "pedroigor", "createdAt": "2020-02-21T14:09:16Z", "path": "adapters/oidc/installed/src/main/java/org/keycloak/adapters/installed/KeycloakInstalled.java", "diffHunk": "@@ -613,96 +610,86 @@ private String readCode(Reader reader) throws IOException {\n         return sb.toString();\n     }\n \n+    KeycloakInstalled(int i) {\n \n-    public class CallbackListener extends Thread {\n+    }\n \n-        private ServerSocket server;\n+    class CallbackListener implements HttpHandler {\n+        private final CountDownLatch shutdownSignal = new CountDownLatch(1);\n \n         private String code;\n-\n         private String error;\n-\n         private String errorDescription;\n+        private String state;\n+        private Undertow server;\n \n-        private IOException errorException;\n+        private GracefulShutdownHandler gracefulShutdownHandler;\n \n-        private String state;\n+        public void start() {\n+            PathHandler pathHandler = Handlers.path().addExactPath(\"/\", this);\n+            AllowedMethodsHandler allowedMethodsHandler = new AllowedMethodsHandler(pathHandler, Methods.GET);\n+            gracefulShutdownHandler = Handlers.gracefulShutdown(allowedMethodsHandler);\n+\n+            server = Undertow.builder()\n+                    .addHttpListener(0, \"localhost\")\n+                    .setHandler(gracefulShutdownHandler).build();\n \n-        private Socket socket;\n+            server.start();\n+        }\n \n-        private HttpResponseWriter writer;\n+        public void stop() {\n+            server.stop();\n+        }\n \n-        public CallbackListener(HttpResponseWriter writer) throws IOException {\n-            this.writer = writer;\n-            server = new ServerSocket(0);\n+        public int getLocalPort() {\n+            return ((InetSocketAddress) server.getListenerInfo().get(0).getAddress()).getPort();\n+        }\n+\n+        public void await() throws InterruptedException {\n+            shutdownSignal.await();\n         }\n \n         @Override\n-        public void run() {\n-            try {\n-                socket = server.accept();\n-\n-                BufferedReader br = new BufferedReader(new InputStreamReader(socket.getInputStream()));\n-                String request = br.readLine();\n-\n-                String url = request.split(\" \")[1];\n-                if (url.indexOf('?') >= 0) {\n-                    url = url.split(\"\\\\?\")[1];\n-                    String[] params = url.split(\"&\");\n-\n-                    for (String param : params) {\n-                        String[] p = param.split(\"=\");\n-                        if (p[0].equals(OAuth2Constants.CODE)) {\n-                            code = p[1];\n-                        } else if (p[0].equals(OAuth2Constants.ERROR)) {\n-                            error = p[1];\n-                        } else if (p[0].equals(\"error-description\")) {\n-                            errorDescription = p[1];\n-                        } else if (p[0].equals(OAuth2Constants.STATE)) {\n-                            state = p[1];\n-                        }\n-                    }\n-                }\n+        public void handleRequest(HttpServerExchange exchange) throws Exception {\n+            gracefulShutdownHandler.shutdown();\n \n-                OutputStreamWriter out = new OutputStreamWriter(socket.getOutputStream());\n-                PrintWriter pw = new PrintWriter(out);\n-                if (writer != null) {\n-                    System.err.println(\"Using a writer is deprecated.  Please remove its usage.  This is now handled by endpoint on server\");", "originalCommit": "705d912cbfc3e7afa17935736f70e644f88824fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbb54db1a1c134d2505240cba5c15c6d0b210338", "url": "https://github.com/keycloak/keycloak/commit/dbb54db1a1c134d2505240cba5c15c6d0b210338", "message": "KEYCLOAK-12749 single worker/IO thread, use OAUTH2 constants", "committedDate": "2020-02-21T16:39:19Z", "type": "commit"}]}