{"pr_number": 7536, "pr_title": "KEYCLOAK-16077 Remove need for MapStorage.replace", "pr_createdAt": "2020-10-26T11:20:50Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7536", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0MDQ1OA==", "url": "https://github.com/keycloak/keycloak/pull/7536#discussion_r512640458", "bodyText": "@hmlnarik Do you know about any scenario/place where this method is really necessary and it is not possible to make it work in the way that everything is committed and everyone notified at the end of the transaction?\nTo me this still seems like something we should get rid of eventually, I think the code would be easier to understand and also debugging would be easier without this idea of notifying/flushing in the middle of transaction. I understand it is not possible now, as apparently there is a lot of code relying on it, but we should not support using it, therefore I would leave the @deprecated comment as is or at least I would add some warning to the javadoc that this should be used only in case it is really necessary.", "author": "mhajas", "createdAt": "2020-10-27T12:10:25Z", "path": "server-spi/src/main/java/org/keycloak/models/ClientModel.java", "diffHunk": "@@ -34,10 +36,33 @@\n     String PUBLIC_KEY = \"publicKey\";\n     String X509CERTIFICATE = \"X509Certificate\";\n \n+    interface ClientCreationEvent extends ProviderEvent {\n+        ClientModel getCreatedClient();\n+    }\n+\n+    // Called also during client creation after client is fully initialized (including all attributes etc)\n+    interface ClientUpdatedEvent extends ProviderEvent {\n+        ClientModel getUpdatedClient();\n+        KeycloakSession getKeycloakSession();\n+    }\n+\n+    interface ClientRemovedEvent extends ProviderEvent {\n+        ClientModel getClient();\n+        KeycloakSession getKeycloakSession();\n+    }\n+\n     /**\n-     * Stores the current state of the client immediately to the underlying store, similarly to a commit.\n+     * Notifies other providers that this client has been updated.\n+     * <p>\n+     * After a client is updated, providers can register for {@link ClientUpdatedEvent}.\n+     * The setters in this model do not send an update for individual updates of the model.\n+     * This method is here to allow for sending this event for this client,\n+     * allowsing for to group multiple changes of a client and signal that\n+     * all the changes in this client have been performed.\n      *\n-     * @deprecated Do not use, to be removed\n+     * @see ProviderEvent\n+     * @see ProviderEventManager\n+     * @see ClientUpdatedEvent\n      */\n     void updateClient();", "originalCommit": "12ed78a41d4f406c1f1bf6f43830fbedde5cf385", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1MDE0NQ==", "url": "https://github.com/keycloak/keycloak/pull/7536#discussion_r512650145", "bodyText": "You are right, I missed the removal of this comment. Thanks.\nWhen walking through the code, I believe this should be possible to remove by publishing the event before the transaction end. I leave this to https://issues.redhat.com/browse/KEYCLOAK-16021, since this should be actually a separate issue. Introduced https://issues.redhat.com/browse/KEYCLOAK-16077.", "author": "hmlnarik", "createdAt": "2020-10-27T12:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0MDQ1OA=="}], "type": "inlineReview"}, {"oid": "ecffcec40ff4994f29cab833fdc230c9f756d054", "url": "https://github.com/keycloak/keycloak/commit/ecffcec40ff4994f29cab833fdc230c9f756d054", "message": "KEYCLOAK-16077 Remove need for MapStorage.replace", "committedDate": "2020-10-27T12:27:49Z", "type": "commit"}, {"oid": "ecffcec40ff4994f29cab833fdc230c9f756d054", "url": "https://github.com/keycloak/keycloak/commit/ecffcec40ff4994f29cab833fdc230c9f756d054", "message": "KEYCLOAK-16077 Remove need for MapStorage.replace", "committedDate": "2020-10-27T12:27:49Z", "type": "forcePushed"}]}