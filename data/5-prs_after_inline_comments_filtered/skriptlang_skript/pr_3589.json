{"pr_number": 3589, "pr_title": "Feature/xp block break event", "pr_createdAt": "2020-11-30T10:11:21Z", "pr_url": "https://github.com/SkriptLang/Skript/pull/3589", "timeline": [{"oid": "278ac6b11c93d17823cce7be2e30a7dd1bff23f8", "url": "https://github.com/SkriptLang/Skript/commit/278ac6b11c93d17823cce7be2e30a7dd1bff23f8", "message": "ExprExperience - add support for XP dropped in block break event", "committedDate": "2020-11-30T10:08:24Z", "type": "commit"}, {"oid": "85783015a1f5d09059ea97a3af57270ba162f404", "url": "https://github.com/SkriptLang/Skript/commit/85783015a1f5d09059ea97a3af57270ba162f404", "message": "ExprExperience - tab docs in 1 more", "committedDate": "2020-11-30T10:10:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk1Njg2Nw==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532956867", "bodyText": "the acceptChange method supports the DELETE case currently", "author": "APickledWalrus", "createdAt": "2020-11-30T22:55:05Z", "path": "src/main/java/ch/njol/skript/expressions/ExprExperience.java", "diffHunk": "@@ -87,31 +96,41 @@ public boolean init(final Expression<?>[] exprs, final int matchedPattern, final\n \t\n \t@Override\n \tpublic void change(final Event e, final @Nullable Object[] delta, final ChangeMode mode) {\n-\t\tif (!(e instanceof ExperienceSpawnEvent))\n+\t\tdouble d;\n+\t\tif (e instanceof ExperienceSpawnEvent)\n+\t\t\td = ((ExperienceSpawnEvent) e).getSpawnedXP();\n+\t\telse if (e instanceof BlockBreakEvent)\n+\t\t\td = ((BlockBreakEvent) e).getExpToDrop();\n+\t\telse\n \t\t\treturn;\n-\t\tif (delta == null) {\n-\t\t\t((ExperienceSpawnEvent) e).setSpawnedXP(0);\n-\t\t\treturn;\n-\t\t}\n-\t\tdouble d = 0;\n-\t\tfor (final Object o : delta) {\n-\t\t\tfinal double v = o instanceof Experience ? ((Experience) o).getXP() : ((Number) o).doubleValue();\n-\t\t\tswitch (mode) {\n-\t\t\t\tcase ADD:\n-\t\t\t\tcase SET:\n-\t\t\t\t\td += v;\n-\t\t\t\t\tbreak;\n-\t\t\t\tcase REMOVE:\n-\t\t\t\tcase REMOVE_ALL:\n-\t\t\t\t\td -= v;\n-\t\t\t\t\tbreak;\n-\t\t\t\tcase RESET:\n-\t\t\t\tcase DELETE:\n-\t\t\t\t\tassert false;\n-\t\t\t\t\tbreak;\n+\t\t\n+\t\tif (delta != null)\n+\t\t\tfor (final Object o : delta) {\n+\t\t\t\tfinal double v = o instanceof Experience ? ((Experience) o).getXP() : ((Number) o).doubleValue();\n+\t\t\t\tswitch (mode) {\n+\t\t\t\t\tcase ADD:\n+\t\t\t\t\t\td += v;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase SET:\n+\t\t\t\t\t\td = v;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase REMOVE:\n+\t\t\t\t\tcase REMOVE_ALL:\n+\t\t\t\t\t\td -= v;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase RESET:\n+\t\t\t\t\tcase DELETE:", "originalCommit": "85783015a1f5d09059ea97a3af57270ba162f404", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2NDE5MQ==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532964191", "bodyText": "Since delta would be null in this case, that won't even run,\nthe else would be used in this case.", "author": "ShaneBeee", "createdAt": "2020-11-30T23:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk1Njg2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2Nzk0MQ==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532967941", "bodyText": "whoops I missed that haha", "author": "APickledWalrus", "createdAt": "2020-11-30T23:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk1Njg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MDM0MA==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532960340", "bodyText": "I think REMOVE_ALL should be removed here? I don't think it's appropriate usage of it.", "author": "APickledWalrus", "createdAt": "2020-11-30T23:03:32Z", "path": "src/main/java/ch/njol/skript/expressions/ExprExperience.java", "diffHunk": "@@ -87,31 +96,41 @@ public boolean init(final Expression<?>[] exprs, final int matchedPattern, final\n \t\n \t@Override\n \tpublic void change(final Event e, final @Nullable Object[] delta, final ChangeMode mode) {\n-\t\tif (!(e instanceof ExperienceSpawnEvent))\n+\t\tdouble d;\n+\t\tif (e instanceof ExperienceSpawnEvent)\n+\t\t\td = ((ExperienceSpawnEvent) e).getSpawnedXP();\n+\t\telse if (e instanceof BlockBreakEvent)\n+\t\t\td = ((BlockBreakEvent) e).getExpToDrop();\n+\t\telse\n \t\t\treturn;\n-\t\tif (delta == null) {\n-\t\t\t((ExperienceSpawnEvent) e).setSpawnedXP(0);\n-\t\t\treturn;\n-\t\t}\n-\t\tdouble d = 0;\n-\t\tfor (final Object o : delta) {\n-\t\t\tfinal double v = o instanceof Experience ? ((Experience) o).getXP() : ((Number) o).doubleValue();\n-\t\t\tswitch (mode) {\n-\t\t\t\tcase ADD:\n-\t\t\t\tcase SET:\n-\t\t\t\t\td += v;\n-\t\t\t\t\tbreak;\n-\t\t\t\tcase REMOVE:\n-\t\t\t\tcase REMOVE_ALL:\n-\t\t\t\t\td -= v;\n-\t\t\t\t\tbreak;\n-\t\t\t\tcase RESET:\n-\t\t\t\tcase DELETE:\n-\t\t\t\t\tassert false;\n-\t\t\t\t\tbreak;\n+\t\t\n+\t\tif (delta != null)\n+\t\t\tfor (final Object o : delta) {\n+\t\t\t\tfinal double v = o instanceof Experience ? ((Experience) o).getXP() : ((Number) o).doubleValue();\n+\t\t\t\tswitch (mode) {\n+\t\t\t\t\tcase ADD:\n+\t\t\t\t\t\td += v;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase SET:\n+\t\t\t\t\t\td = v;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase REMOVE:\n+\t\t\t\t\tcase REMOVE_ALL:", "originalCommit": "85783015a1f5d09059ea97a3af57270ba162f404", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MzY4NA==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532963684", "bodyText": "good call, I removed it.", "author": "ShaneBeee", "createdAt": "2020-11-30T23:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MDM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2ODM2Ng==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532968366", "bodyText": "needs removed from acceptChange too ;D", "author": "APickledWalrus", "createdAt": "2020-11-30T23:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MDM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2ODc2OQ==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532968769", "bodyText": "you're so needy ;) haha, jk jk... ok its been removed.!", "author": "ShaneBeee", "createdAt": "2020-11-30T23:24:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MDM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MDc2OQ==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532960769", "bodyText": "Is it okay for experience to be negative? You removed the Math#max check that was originally here ;D", "author": "APickledWalrus", "createdAt": "2020-11-30T23:04:39Z", "path": "src/main/java/ch/njol/skript/expressions/ExprExperience.java", "diffHunk": "@@ -87,31 +96,41 @@ public boolean init(final Expression<?>[] exprs, final int matchedPattern, final\n \t\n \t@Override\n \tpublic void change(final Event e, final @Nullable Object[] delta, final ChangeMode mode) {\n-\t\tif (!(e instanceof ExperienceSpawnEvent))\n+\t\tdouble d;\n+\t\tif (e instanceof ExperienceSpawnEvent)\n+\t\t\td = ((ExperienceSpawnEvent) e).getSpawnedXP();\n+\t\telse if (e instanceof BlockBreakEvent)\n+\t\t\td = ((BlockBreakEvent) e).getExpToDrop();\n+\t\telse\n \t\t\treturn;\n-\t\tif (delta == null) {\n-\t\t\t((ExperienceSpawnEvent) e).setSpawnedXP(0);\n-\t\t\treturn;\n-\t\t}\n-\t\tdouble d = 0;\n-\t\tfor (final Object o : delta) {\n-\t\t\tfinal double v = o instanceof Experience ? ((Experience) o).getXP() : ((Number) o).doubleValue();\n-\t\t\tswitch (mode) {\n-\t\t\t\tcase ADD:\n-\t\t\t\tcase SET:\n-\t\t\t\t\td += v;\n-\t\t\t\t\tbreak;\n-\t\t\t\tcase REMOVE:\n-\t\t\t\tcase REMOVE_ALL:\n-\t\t\t\t\td -= v;\n-\t\t\t\t\tbreak;\n-\t\t\t\tcase RESET:\n-\t\t\t\tcase DELETE:\n-\t\t\t\t\tassert false;\n-\t\t\t\t\tbreak;\n+\t\t\n+\t\tif (delta != null)\n+\t\t\tfor (final Object o : delta) {\n+\t\t\t\tfinal double v = o instanceof Experience ? ((Experience) o).getXP() : ((Number) o).doubleValue();\n+\t\t\t\tswitch (mode) {\n+\t\t\t\t\tcase ADD:\n+\t\t\t\t\t\td += v;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase SET:\n+\t\t\t\t\t\td = v;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase REMOVE:\n+\t\t\t\t\tcase REMOVE_ALL:\n+\t\t\t\t\t\td -= v;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tcase RESET:\n+\t\t\t\t\tcase DELETE:\n+\t\t\t\t\t\tassert false;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t}\n \t\t\t}\n-\t\t}\n-\t\t((ExperienceSpawnEvent) e).setSpawnedXP(Math.max(0, (int) Math.round(((ExperienceSpawnEvent) e).getSpawnedXP() + d)));\n+\t\telse\n+\t\t\td = 0;\n+\t\t\n+\t\tif (e instanceof ExperienceSpawnEvent)\n+\t\t\t((ExperienceSpawnEvent) e).setSpawnedXP((int) Math.round(d));", "originalCommit": "85783015a1f5d09059ea97a3af57270ba162f404", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2Mzc5OA==", "url": "https://github.com/SkriptLang/Skript/pull/3589#discussion_r532963798", "bodyText": "WOOPS, my mistake. Good catch. I have added it back in.", "author": "ShaneBeee", "createdAt": "2020-11-30T23:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MDc2OQ=="}], "type": "inlineReview"}, {"oid": "f583879bd1703f2d2d90f2d6aca13e009a644e0a", "url": "https://github.com/SkriptLang/Skript/commit/f583879bd1703f2d2d90f2d6aca13e009a644e0a", "message": "ExprExperience - put back Math.max i accidentally removed\n- also removed unneeded REMOVE_ALL", "committedDate": "2020-11-30T23:11:01Z", "type": "commit"}, {"oid": "ccacd4f4bd95f30f752ca12cbbfff65afc08331b", "url": "https://github.com/SkriptLang/Skript/commit/ccacd4f4bd95f30f752ca12cbbfff65afc08331b", "message": "ExprExperience - remove REMOVE_ALL from acceptChange", "committedDate": "2020-11-30T23:23:52Z", "type": "commit"}, {"oid": "785a13f740efd4cb4f96a9fdae1e8bcf8838d77b", "url": "https://github.com/SkriptLang/Skript/commit/785a13f740efd4cb4f96a9fdae1e8bcf8838d77b", "message": "ExprExperience - adding REMOVE_ALL back in", "committedDate": "2020-11-30T23:38:32Z", "type": "commit"}, {"oid": "c9a3685ff7f3e63179cd623f19b3f96f0a8ff0b9", "url": "https://github.com/SkriptLang/Skript/commit/c9a3685ff7f3e63179cd623f19b3f96f0a8ff0b9", "message": "Merge branch 'dev-2.5' into feature/xp-block-break-event", "committedDate": "2020-12-04T19:03:21Z", "type": "commit"}]}