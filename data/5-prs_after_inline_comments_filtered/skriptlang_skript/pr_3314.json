{"pr_number": 3314, "pr_title": "Fix chunk is loaded condition", "pr_createdAt": "2020-08-16T20:27:11Z", "pr_url": "https://github.com/SkriptLang/Skript/pull/3314", "timeline": [{"oid": "05be906686d0f742a3eb6570da565c935a8b4a37", "url": "https://github.com/SkriptLang/Skript/commit/05be906686d0f742a3eb6570da565c935a8b4a37", "message": "Introducing block state modification", "committedDate": "2020-08-03T08:11:23Z", "type": "commit"}, {"oid": "2ea350b47773ff6ebaf48bf6a3c44833778e7838", "url": "https://github.com/SkriptLang/Skript/commit/2ea350b47773ff6ebaf48bf6a3c44833778e7838", "message": "Revert \"Introducing block state modification\"\n\nThis reverts commit 05be9066", "committedDate": "2020-08-03T08:24:46Z", "type": "commit"}, {"oid": "29a0869b3b6553fc1043066413d30c2ffe486916", "url": "https://github.com/SkriptLang/Skript/commit/29a0869b3b6553fc1043066413d30c2ffe486916", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-06T18:58:31Z", "type": "commit"}, {"oid": "23785c76083b6eca9c26a3c9cd0d7674def09aa8", "url": "https://github.com/SkriptLang/Skript/commit/23785c76083b6eca9c26a3c9cd0d7674def09aa8", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-06T20:48:52Z", "type": "commit"}, {"oid": "e81e1b28e76c0bfcaeb6970bb0c9d6545d242294", "url": "https://github.com/SkriptLang/Skript/commit/e81e1b28e76c0bfcaeb6970bb0c9d6545d242294", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-09T02:19:46Z", "type": "commit"}, {"oid": "08d03bcea367a59149c785a9653c5c1e755e95da", "url": "https://github.com/SkriptLang/Skript/commit/08d03bcea367a59149c785a9653c5c1e755e95da", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-09T07:09:44Z", "type": "commit"}, {"oid": "9001efcf33e39f290d5957351ff19e2ade694944", "url": "https://github.com/SkriptLang/Skript/commit/9001efcf33e39f290d5957351ff19e2ade694944", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-10T01:30:06Z", "type": "commit"}, {"oid": "1695141b1a408522b1c061afb09f17b536f4a7ab", "url": "https://github.com/SkriptLang/Skript/commit/1695141b1a408522b1c061afb09f17b536f4a7ab", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-10T02:09:45Z", "type": "commit"}, {"oid": "80c69bdebdc09a0d83878f3b8de40b695981cabf", "url": "https://github.com/SkriptLang/Skript/commit/80c69bdebdc09a0d83878f3b8de40b695981cabf", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-11T03:58:37Z", "type": "commit"}, {"oid": "a26eba6519fbb63a6cb82ef63d85f34910014c16", "url": "https://github.com/SkriptLang/Skript/commit/a26eba6519fbb63a6cb82ef63d85f34910014c16", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-11T10:40:47Z", "type": "commit"}, {"oid": "add92ec52b2da9728b2501e56357036d79eb92f3", "url": "https://github.com/SkriptLang/Skript/commit/add92ec52b2da9728b2501e56357036d79eb92f3", "message": "Merge branch 'master' of https://github.com/SkriptLang/Skript", "committedDate": "2020-08-15T19:34:50Z", "type": "commit"}, {"oid": "d4500072119962fbeb0fcc934969b58cec9da767", "url": "https://github.com/SkriptLang/Skript/commit/d4500072119962fbeb0fcc934969b58cec9da767", "message": "CondIsLoaded - fix issue with checking if chunks are loaded (which was forcing them to load)", "committedDate": "2020-08-16T20:19:42Z", "type": "commit"}, {"oid": "79b124feb879b515a5dc0a1a36eeb8fdc48b0d51", "url": "https://github.com/SkriptLang/Skript/commit/79b124feb879b515a5dc0a1a36eeb8fdc48b0d51", "message": "rename regression test to actual PR number", "committedDate": "2020-08-16T20:30:03Z", "type": "commit"}, {"oid": "16980f395b29aa820047a1da7a2d5b88c0a089af", "url": "https://github.com/SkriptLang/Skript/commit/16980f395b29aa820047a1da7a2d5b88c0a089af", "message": "CondIsLoaded - add version thing for revamp", "committedDate": "2020-08-16T20:32:16Z", "type": "commit"}, {"oid": "3b75fb394448f296caf9911df69890571569b8be", "url": "https://github.com/SkriptLang/Skript/commit/3b75fb394448f296caf9911df69890571569b8be", "message": "regression - added some more chunk tests using location function", "committedDate": "2020-08-16T20:42:47Z", "type": "commit"}, {"oid": "6a5c65768f9f3b09917d415e328c95eb871cd831", "url": "https://github.com/SkriptLang/Skript/commit/6a5c65768f9f3b09917d415e328c95eb871cd831", "message": "CondIsLoaded - parse marks were wrong", "committedDate": "2020-08-16T20:50:40Z", "type": "commit"}, {"oid": "4fe15f9440fdb356040610c6f410c0ad7f148f1a", "url": "https://github.com/SkriptLang/Skript/commit/4fe15f9440fdb356040610c6f410c0ad7f148f1a", "message": "Fix regression test", "committedDate": "2020-08-16T20:51:01Z", "type": "commit"}, {"oid": "43f9b021059160e0b03748343f7332144aad483a", "url": "https://github.com/SkriptLang/Skript/commit/43f9b021059160e0b03748343f7332144aad483a", "message": "Fix regression test .... again", "committedDate": "2020-08-16T21:06:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE1OTQwMA==", "url": "https://github.com/SkriptLang/Skript/pull/3314#discussion_r471159400", "bodyText": "The parameter names should always match super, matchedPattern was changed.", "author": "FranKusmiruk", "createdAt": "2020-08-16T21:11:51Z", "path": "src/main/java/ch/njol/skript/conditions/CondIsLoaded.java", "diffHunk": "@@ -19,38 +19,93 @@\n  */\n package ch.njol.skript.conditions;\n \n-import ch.njol.skript.conditions.base.PropertyCondition;\n+import ch.njol.skript.Skript;\n import ch.njol.skript.doc.Description;\n import ch.njol.skript.doc.Examples;\n import ch.njol.skript.doc.Name;\n import ch.njol.skript.doc.Since;\n+import ch.njol.skript.lang.Condition;\n+import ch.njol.skript.lang.Expression;\n+import ch.njol.skript.lang.SkriptParser.ParseResult;\n+import ch.njol.skript.util.Direction;\n+import ch.njol.util.Kleenean;\n \n import org.bukkit.Bukkit;\n-import org.bukkit.Chunk;\n+import org.bukkit.Location;\n import org.bukkit.World;\n+import org.bukkit.event.Event;\n+import org.eclipse.jdt.annotation.Nullable;\n \n @Name(\"Is Loaded\")\n-@Description(\"Checks whether or not a chunk/world is loaded\")\n-@Examples(\"if chunk at {home::%player's uuid%} is loaded:\")\n-@Since(\"2.3\")\n-public class CondIsLoaded extends PropertyCondition<Object> {\n+@Description(\"Checks whether or not a chunk/world is loaded. 'chunk at 1, 1' uses chunk coords, which are location coords divided by 16.\")\n+@Examples({\"if chunk at {home::%player's uuid%} is loaded:\",\n+\t\t\"if chunk 1, 10 in world \\\"world\\\" is loaded:\",\n+\t\t\"if world(\\\"lobby\\\") is loaded:\"})\n+@Since(\"2.3, INSERT VERSION (revamp with chunk at location/coords)\")\n+public class CondIsLoaded extends Condition {\n \t\n \tstatic {\n-\t\tregister(CondIsLoaded.class, \"loaded\", \"worlds/chunks\");\n+\t\tSkript.registerCondition(CondIsLoaded.class,\n+\t\t\t\"chunk[s] %directions% [%locations%] (is|are)[(1\u00a6(n't| not))] loaded\",\n+\t\t\t\"chunk [at] %number%, %number% (in|of) [world] %world% is[(1\u00a6(n't| not))] loaded\",\n+\t\t\t\"[world[s]] %worlds% (is|are)[(1\u00a6(n't| not))] loaded\");\n \t}\n \t\n+\t@Nullable\n+\tprivate Expression<Location> locations;\n+\t@Nullable\n+\tprivate Expression<Number> x,z;\n+\t@Nullable\n+\tprivate Expression<World> world;\n+\t@Nullable\n+\tprivate Expression<World> worlds;\n+\tprivate int pattern;\n+\t\n+\t@Override\n+\tpublic boolean init(Expression<?>[] exprs, int pattern, Kleenean isDelayed, ParseResult parseResult) {", "originalCommit": "43f9b021059160e0b03748343f7332144aad483a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMjA3Nw==", "url": "https://github.com/SkriptLang/Skript/pull/3314#discussion_r471902077", "bodyText": "Ahh... this I did not know. Will be fixed in next commit", "author": "ShaneBeee", "createdAt": "2020-08-18T04:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE1OTQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMDc1Mw==", "url": "https://github.com/SkriptLang/Skript/pull/3314#discussion_r471900753", "bodyText": "I believe the second world variable isn't needed", "author": "FranKusmiruk", "createdAt": "2020-08-18T04:04:08Z", "path": "src/main/java/ch/njol/skript/conditions/CondIsLoaded.java", "diffHunk": "@@ -19,38 +19,93 @@\n  */\n package ch.njol.skript.conditions;\n \n-import ch.njol.skript.conditions.base.PropertyCondition;\n+import ch.njol.skript.Skript;\n import ch.njol.skript.doc.Description;\n import ch.njol.skript.doc.Examples;\n import ch.njol.skript.doc.Name;\n import ch.njol.skript.doc.Since;\n+import ch.njol.skript.lang.Condition;\n+import ch.njol.skript.lang.Expression;\n+import ch.njol.skript.lang.SkriptParser.ParseResult;\n+import ch.njol.skript.util.Direction;\n+import ch.njol.util.Kleenean;\n \n import org.bukkit.Bukkit;\n-import org.bukkit.Chunk;\n+import org.bukkit.Location;\n import org.bukkit.World;\n+import org.bukkit.event.Event;\n+import org.eclipse.jdt.annotation.Nullable;\n \n @Name(\"Is Loaded\")\n-@Description(\"Checks whether or not a chunk/world is loaded\")\n-@Examples(\"if chunk at {home::%player's uuid%} is loaded:\")\n-@Since(\"2.3\")\n-public class CondIsLoaded extends PropertyCondition<Object> {\n+@Description(\"Checks whether or not a chunk/world is loaded. 'chunk at 1, 1' uses chunk coords, which are location coords divided by 16.\")\n+@Examples({\"if chunk at {home::%player's uuid%} is loaded:\",\n+\t\t\"if chunk 1, 10 in world \\\"world\\\" is loaded:\",\n+\t\t\"if world(\\\"lobby\\\") is loaded:\"})\n+@Since(\"2.3, INSERT VERSION (revamp with chunk at location/coords)\")\n+public class CondIsLoaded extends Condition {\n \t\n \tstatic {\n-\t\tregister(CondIsLoaded.class, \"loaded\", \"worlds/chunks\");\n+\t\tSkript.registerCondition(CondIsLoaded.class,\n+\t\t\t\"chunk[s] %directions% [%locations%] (is|are)[(1\u00a6(n't| not))] loaded\",\n+\t\t\t\"chunk [at] %number%, %number% (in|of) [world] %world% is[(1\u00a6(n't| not))] loaded\",\n+\t\t\t\"[world[s]] %worlds% (is|are)[(1\u00a6(n't| not))] loaded\");\n \t}\n \t\n+\t@Nullable\n+\tprivate Expression<Location> locations;\n+\t@Nullable\n+\tprivate Expression<Number> x,z;\n+\t@Nullable\n+\tprivate Expression<World> world;\n+\t@Nullable\n+\tprivate Expression<World> worlds;\n+\tprivate int pattern;\n+\t\n+\t@Override\n+\tpublic boolean init(Expression<?>[] exprs, int pattern, Kleenean isDelayed, ParseResult parseResult) {\n+\t\tlocations = pattern == 0 ? Direction.combine((Expression<? extends Direction>) exprs[0], (Expression<? extends Location>) exprs[1]) : null;\n+\t\tx = pattern == 1 ? (Expression<Number>) exprs[0] : null;\n+\t\tz = pattern == 1 ? (Expression<Number>) exprs[1] : null;\n+\t\tworld = pattern == 1 ? (Expression<World>) exprs[2] : null;\n+\t\tworlds = pattern == 2 ? (Expression<World>) exprs[0] : null;", "originalCommit": "43f9b021059160e0b03748343f7332144aad483a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMjE2Mg==", "url": "https://github.com/SkriptLang/Skript/pull/3314#discussion_r471902162", "bodyText": "What was I thinking? haha. My brain must have been elsewhere. Will be removed in next commit.", "author": "ShaneBeee", "createdAt": "2020-08-18T04:10:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMDc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMDk5MQ==", "url": "https://github.com/SkriptLang/Skript/pull/3314#discussion_r471900991", "bodyText": "x and z are never null at this point of the code, x#getSingle and z#getSingle can be though", "author": "FranKusmiruk", "createdAt": "2020-08-18T04:05:08Z", "path": "src/main/java/ch/njol/skript/conditions/CondIsLoaded.java", "diffHunk": "@@ -19,38 +19,93 @@\n  */\n package ch.njol.skript.conditions;\n \n-import ch.njol.skript.conditions.base.PropertyCondition;\n+import ch.njol.skript.Skript;\n import ch.njol.skript.doc.Description;\n import ch.njol.skript.doc.Examples;\n import ch.njol.skript.doc.Name;\n import ch.njol.skript.doc.Since;\n+import ch.njol.skript.lang.Condition;\n+import ch.njol.skript.lang.Expression;\n+import ch.njol.skript.lang.SkriptParser.ParseResult;\n+import ch.njol.skript.util.Direction;\n+import ch.njol.util.Kleenean;\n \n import org.bukkit.Bukkit;\n-import org.bukkit.Chunk;\n+import org.bukkit.Location;\n import org.bukkit.World;\n+import org.bukkit.event.Event;\n+import org.eclipse.jdt.annotation.Nullable;\n \n @Name(\"Is Loaded\")\n-@Description(\"Checks whether or not a chunk/world is loaded\")\n-@Examples(\"if chunk at {home::%player's uuid%} is loaded:\")\n-@Since(\"2.3\")\n-public class CondIsLoaded extends PropertyCondition<Object> {\n+@Description(\"Checks whether or not a chunk/world is loaded. 'chunk at 1, 1' uses chunk coords, which are location coords divided by 16.\")\n+@Examples({\"if chunk at {home::%player's uuid%} is loaded:\",\n+\t\t\"if chunk 1, 10 in world \\\"world\\\" is loaded:\",\n+\t\t\"if world(\\\"lobby\\\") is loaded:\"})\n+@Since(\"2.3, INSERT VERSION (revamp with chunk at location/coords)\")\n+public class CondIsLoaded extends Condition {\n \t\n \tstatic {\n-\t\tregister(CondIsLoaded.class, \"loaded\", \"worlds/chunks\");\n+\t\tSkript.registerCondition(CondIsLoaded.class,\n+\t\t\t\"chunk[s] %directions% [%locations%] (is|are)[(1\u00a6(n't| not))] loaded\",\n+\t\t\t\"chunk [at] %number%, %number% (in|of) [world] %world% is[(1\u00a6(n't| not))] loaded\",\n+\t\t\t\"[world[s]] %worlds% (is|are)[(1\u00a6(n't| not))] loaded\");\n \t}\n \t\n+\t@Nullable\n+\tprivate Expression<Location> locations;\n+\t@Nullable\n+\tprivate Expression<Number> x,z;\n+\t@Nullable\n+\tprivate Expression<World> world;\n+\t@Nullable\n+\tprivate Expression<World> worlds;\n+\tprivate int pattern;\n+\t\n+\t@Override\n+\tpublic boolean init(Expression<?>[] exprs, int pattern, Kleenean isDelayed, ParseResult parseResult) {\n+\t\tlocations = pattern == 0 ? Direction.combine((Expression<? extends Direction>) exprs[0], (Expression<? extends Location>) exprs[1]) : null;\n+\t\tx = pattern == 1 ? (Expression<Number>) exprs[0] : null;\n+\t\tz = pattern == 1 ? (Expression<Number>) exprs[1] : null;\n+\t\tworld = pattern == 1 ? (Expression<World>) exprs[2] : null;\n+\t\tworlds = pattern == 2 ? (Expression<World>) exprs[0] : null;\n+\t\tsetNegated(parseResult.mark == 1);\n+\t\tthis.pattern = pattern;\n+\t\treturn true;\n+\t}\n+\t\n+\t@SuppressWarnings(\"null\")\n \t@Override\n-\tpublic boolean check(Object o) {\n-\t\tif (o instanceof Chunk)\n-\t\t\treturn ((Chunk) o).isLoaded();\n-\t\telse if (o instanceof World)\n-\t\t\treturn Bukkit.getWorld(((World) o).getName()) != null;\n+\tpublic boolean check(Event e) {\n+\t\tswitch (pattern) {\n+\t\t\tcase 0:\n+\t\t\t\treturn locations.check(e, location -> {\n+\t\t\t\t\tWorld world = location.getWorld();\n+\t\t\t\t\tif (world != null)\n+\t\t\t\t\t\treturn world.isChunkLoaded(location.getBlockX() >> 4, location.getBlockZ() >> 4);\n+\t\t\t\t\treturn false;\n+\t\t\t\t}, isNegated());\n+\t\t\tcase 1:\n+\t\t\t\treturn world.check(e, world -> {\n+\t\t\t\t\tif (x == null || z == null)", "originalCommit": "43f9b021059160e0b03748343f7332144aad483a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMzIzOQ==", "url": "https://github.com/SkriptLang/Skript/pull/3314#discussion_r471903239", "bodyText": "I probably got confused with the amount of \"this could be null\" messages haha.\nWill change it up for next commit.", "author": "ShaneBeee", "createdAt": "2020-08-18T04:15:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMDk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMzY4OQ==", "url": "https://github.com/SkriptLang/Skript/pull/3314#discussion_r471903689", "bodyText": "Ok, all changes have been made \ud83d\udc4d", "author": "ShaneBeee", "createdAt": "2020-08-18T04:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwMDk5MQ=="}], "type": "inlineReview"}, {"oid": "4c53adb290fe2000c70c48d5728cfb673fce76b0", "url": "https://github.com/SkriptLang/Skript/commit/4c53adb290fe2000c70c48d5728cfb673fce76b0", "message": "CondIsLoaded - some small fixes/cleanup", "committedDate": "2020-08-18T04:16:31Z", "type": "commit"}, {"oid": "61ab384ed94251d38fd4aa4f330798782d0da3f0", "url": "https://github.com/SkriptLang/Skript/commit/61ab384ed94251d38fd4aa4f330798782d0da3f0", "message": "CondIsLoaded - move pattern to before its used (duh Shane... come on)", "committedDate": "2020-08-18T04:54:23Z", "type": "commit"}, {"oid": "e651d40d87fe9827ac62dee49ba7b43ae76c9c83", "url": "https://github.com/SkriptLang/Skript/commit/e651d40d87fe9827ac62dee49ba7b43ae76c9c83", "message": "Merge branch 'master' into fix/chunk-is-loaded", "committedDate": "2020-08-19T08:11:09Z", "type": "commit"}]}