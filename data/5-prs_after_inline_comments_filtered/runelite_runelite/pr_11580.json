{"pr_number": 11580, "pr_title": "screenshot: fix method for naming quest complete screenshots", "pr_createdAt": "2020-05-14T02:02:33Z", "pr_url": "https://github.com/runelite/runelite/pull/11580", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTA3Mg==", "url": "https://github.com/runelite/runelite/pull/11580#discussion_r426111072", "bodyText": "This is only package-private so it can be tested, so it should be marked as such.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tString parseQuestCompletedWidget()\n          \n          \n            \n            \t@VisibleForTesting\n          \n          \n            \n            \tString parseQuestCompletedWidget()", "author": "Nightfirecat", "createdAt": "2020-05-16T02:58:05Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/screenshot/ScreenshotPlugin.java", "diffHunk": "@@ -574,6 +576,56 @@ String parseLevelUpWidget(WidgetInfo levelUpLevel)\n \t\treturn skillName + \"(\" + skillLevel + \")\";\n \t}\n \n+\t/**\n+\t * Parses a WidgetInfo pointing to the second widget of the quest-completed dialog\n+\t * into a shortened string for filename usage.\n+\t *\n+\t * @return Shortened string in the format \"Quest(The Corsair Curse)\"\n+\t */\n+\tString parseQuestCompletedWidget()", "originalCommit": "2717cfbf69f89d1aaef98bb9a514f17805ee2b8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExNDAwMA==", "url": "https://github.com/runelite/runelite/pull/11580#discussion_r426114000", "bodyText": "All of this code is basically only testing parseQuestCompletedWidget() != null in the context of the calling code, so it can be removed.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            \t\tWidgetLoaded event = new WidgetLoaded();\n          \n          \n            \n            \t\tevent.setGroupId(QUEST_COMPLETED_GROUP_ID);\n          \n          \n            \n            \t\tscreenshotPlugin.onWidgetLoaded(event);\n          \n          \n            \n            \n          \n          \n            \n            \t\tGameTick tick = new GameTick();\n          \n          \n            \n            \t\tscreenshotPlugin.onGameTick(tick);\n          \n          \n            \n            \n          \n          \n            \n            \t\tverify(drawManager).requestNextFrameListener(any(Consumer.class));", "author": "Nightfirecat", "createdAt": "2020-05-16T03:41:08Z", "path": "runelite-client/src/test/java/net/runelite/client/plugins/screenshot/ScreenshotPluginTest.java", "diffHunk": "@@ -245,4 +248,144 @@ public void testHunterLevel2()\n \n \t\tverify(drawManager).requestNextFrameListener(any(Consumer.class));\n \t}\n+\n+\t@Test\n+\tpublic void testTheCorsairCurseQuestComplete()\n+\t{\n+\t\tWidget questChild = mock(Widget.class);\n+\t\twhen(client.getWidget(eq(QUEST_COMPLETED_NAME_TEXT))).thenReturn(questChild);\n+\n+\t\twhen(questChild.getText()).thenReturn(\"You have completed The Corsair Curse!\");\n+\n+\t\tassertEquals(\"Quest(The Corsair Curse)\", screenshotPlugin.parseQuestCompletedWidget());\n+\n+\t\tWidgetLoaded event = new WidgetLoaded();\n+\t\tevent.setGroupId(QUEST_COMPLETED_GROUP_ID);\n+\t\tscreenshotPlugin.onWidgetLoaded(event);\n+\n+\t\tGameTick tick = new GameTick();\n+\t\tscreenshotPlugin.onGameTick(tick);\n+\n+\t\tverify(drawManager).requestNextFrameListener(any(Consumer.class));", "originalCommit": "2717cfbf69f89d1aaef98bb9a514f17805ee2b8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExNDAzMg==", "url": "https://github.com/runelite/runelite/pull/11580#discussion_r426114032", "bodyText": "Write a test for this code path.", "author": "Nightfirecat", "createdAt": "2020-05-16T03:41:42Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/screenshot/ScreenshotPlugin.java", "diffHunk": "@@ -574,6 +576,56 @@ String parseLevelUpWidget(WidgetInfo levelUpLevel)\n \t\treturn skillName + \"(\" + skillLevel + \")\";\n \t}\n \n+\t/**\n+\t * Parses a WidgetInfo pointing to the second widget of the quest-completed dialog\n+\t * into a shortened string for filename usage.\n+\t *\n+\t * @return Shortened string in the format \"Quest(The Corsair Curse)\"\n+\t */\n+\tString parseQuestCompletedWidget()\n+\t{\n+\t\tWidget questChild = client.getWidget(WidgetInfo.QUEST_COMPLETED_NAME_TEXT);\n+\t\tif (questChild == null)\n+\t\t{\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tString text = questChild.getText();\n+\t\t// \"You have completed The Corsair Curse!\"\n+\t\tMatcher quest_match_1 = QUEST_PATTERN_1.matcher(text);\n+\t\t// \"'One Small Favour' completed!\"\n+\t\tMatcher quest_match_2 = QUEST_PATTERN_2.matcher(text);\n+\t\tMatcher quest_match_final = quest_match_1.matches() ? quest_match_1 : quest_match_2;\n+\t\tif (!quest_match_final.matches())\n+\t\t{\n+\t\t\treturn \"Quest(quest not found)\";", "originalCommit": "2717cfbf69f89d1aaef98bb9a514f17805ee2b8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExNDA5MQ==", "url": "https://github.com/runelite/runelite/pull/11580#discussion_r426114091", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tquest = quest + \" partial completion\";\n          \n          \n            \n            \t\t\tquest += \" partial completion\";", "author": "Nightfirecat", "createdAt": "2020-05-16T03:42:25Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/screenshot/ScreenshotPlugin.java", "diffHunk": "@@ -574,6 +576,56 @@ String parseLevelUpWidget(WidgetInfo levelUpLevel)\n \t\treturn skillName + \"(\" + skillLevel + \")\";\n \t}\n \n+\t/**\n+\t * Parses a WidgetInfo pointing to the second widget of the quest-completed dialog\n+\t * into a shortened string for filename usage.\n+\t *\n+\t * @return Shortened string in the format \"Quest(The Corsair Curse)\"\n+\t */\n+\tString parseQuestCompletedWidget()\n+\t{\n+\t\tWidget questChild = client.getWidget(WidgetInfo.QUEST_COMPLETED_NAME_TEXT);\n+\t\tif (questChild == null)\n+\t\t{\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tString text = questChild.getText();\n+\t\t// \"You have completed The Corsair Curse!\"\n+\t\tMatcher quest_match_1 = QUEST_PATTERN_1.matcher(text);\n+\t\t// \"'One Small Favour' completed!\"\n+\t\tMatcher quest_match_2 = QUEST_PATTERN_2.matcher(text);\n+\t\tMatcher quest_match_final = quest_match_1.matches() ? quest_match_1 : quest_match_2;\n+\t\tif (!quest_match_final.matches())\n+\t\t{\n+\t\t\treturn \"Quest(quest not found)\";\n+\t\t}\n+\n+\t\tString quest = quest_match_final.group(\"quest\");\n+\t\tString verb = quest_match_final.group(\"verb\") != null ? quest_match_final.group(\"verb\") : \"\";\n+\n+\t\tif (verb.contains(\"kind of\"))\n+\t\t{\n+\t\t\tquest = quest + \" partial completion\";", "originalCommit": "2717cfbf69f89d1aaef98bb9a514f17805ee2b8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExNDEwNA==", "url": "https://github.com/runelite/runelite/pull/11580#discussion_r426114104", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tquest = quest + \" II\";\n          \n          \n            \n            \t\t\tquest += \" II\";", "author": "Nightfirecat", "createdAt": "2020-05-16T03:42:33Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/screenshot/ScreenshotPlugin.java", "diffHunk": "@@ -574,6 +576,56 @@ String parseLevelUpWidget(WidgetInfo levelUpLevel)\n \t\treturn skillName + \"(\" + skillLevel + \")\";\n \t}\n \n+\t/**\n+\t * Parses a WidgetInfo pointing to the second widget of the quest-completed dialog\n+\t * into a shortened string for filename usage.\n+\t *\n+\t * @return Shortened string in the format \"Quest(The Corsair Curse)\"\n+\t */\n+\tString parseQuestCompletedWidget()\n+\t{\n+\t\tWidget questChild = client.getWidget(WidgetInfo.QUEST_COMPLETED_NAME_TEXT);\n+\t\tif (questChild == null)\n+\t\t{\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tString text = questChild.getText();\n+\t\t// \"You have completed The Corsair Curse!\"\n+\t\tMatcher quest_match_1 = QUEST_PATTERN_1.matcher(text);\n+\t\t// \"'One Small Favour' completed!\"\n+\t\tMatcher quest_match_2 = QUEST_PATTERN_2.matcher(text);\n+\t\tMatcher quest_match_final = quest_match_1.matches() ? quest_match_1 : quest_match_2;\n+\t\tif (!quest_match_final.matches())\n+\t\t{\n+\t\t\treturn \"Quest(quest not found)\";\n+\t\t}\n+\n+\t\tString quest = quest_match_final.group(\"quest\");\n+\t\tString verb = quest_match_final.group(\"verb\") != null ? quest_match_final.group(\"verb\") : \"\";\n+\n+\t\tif (verb.contains(\"kind of\"))\n+\t\t{\n+\t\t\tquest = quest + \" partial completion\";\n+\t\t}\n+\t\telse if (verb.contains(\"completely\"))\n+\t\t{\n+\t\t\tquest = quest + \" II\";", "originalCommit": "2717cfbf69f89d1aaef98bb9a514f17805ee2b8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExNDEyOQ==", "url": "https://github.com/runelite/runelite/pull/11580#discussion_r426114129", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tquest = quest + \" Quest\";\n          \n          \n            \n            \t\t\tquest += \" Quest\";", "author": "Nightfirecat", "createdAt": "2020-05-16T03:42:45Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/screenshot/ScreenshotPlugin.java", "diffHunk": "@@ -574,6 +576,56 @@ String parseLevelUpWidget(WidgetInfo levelUpLevel)\n \t\treturn skillName + \"(\" + skillLevel + \")\";\n \t}\n \n+\t/**\n+\t * Parses a WidgetInfo pointing to the second widget of the quest-completed dialog\n+\t * into a shortened string for filename usage.\n+\t *\n+\t * @return Shortened string in the format \"Quest(The Corsair Curse)\"\n+\t */\n+\tString parseQuestCompletedWidget()\n+\t{\n+\t\tWidget questChild = client.getWidget(WidgetInfo.QUEST_COMPLETED_NAME_TEXT);\n+\t\tif (questChild == null)\n+\t\t{\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tString text = questChild.getText();\n+\t\t// \"You have completed The Corsair Curse!\"\n+\t\tMatcher quest_match_1 = QUEST_PATTERN_1.matcher(text);\n+\t\t// \"'One Small Favour' completed!\"\n+\t\tMatcher quest_match_2 = QUEST_PATTERN_2.matcher(text);\n+\t\tMatcher quest_match_final = quest_match_1.matches() ? quest_match_1 : quest_match_2;\n+\t\tif (!quest_match_final.matches())\n+\t\t{\n+\t\t\treturn \"Quest(quest not found)\";\n+\t\t}\n+\n+\t\tString quest = quest_match_final.group(\"quest\");\n+\t\tString verb = quest_match_final.group(\"verb\") != null ? quest_match_final.group(\"verb\") : \"\";\n+\n+\t\tif (verb.contains(\"kind of\"))\n+\t\t{\n+\t\t\tquest = quest + \" partial completion\";\n+\t\t}\n+\t\telse if (verb.contains(\"completely\"))\n+\t\t{\n+\t\t\tquest = quest + \" II\";\n+\t\t}\n+\n+\t\tif (RFD_TAGS.stream().anyMatch((quest + verb)::contains))\n+\t\t{\n+\t\t\tquest = \"Recipe for Disaster - \" + quest;\n+\t\t}\n+\n+\t\tif (WORD_QUEST_IN_NAME_TAGS.stream().anyMatch(quest::contains))\n+\t\t{\n+\t\t\tquest = quest + \" Quest\";", "originalCommit": "2717cfbf69f89d1aaef98bb9a514f17805ee2b8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6b7215446f4318cd40b6a9a8a806052d91f2f082", "url": "https://github.com/runelite/runelite/commit/6b7215446f4318cd40b6a9a8a806052d91f2f082", "message": "screenshot: fix method for naming quest complete screenshots\n\nCurrent code assumes only one text format in the quest reward scroll and\n trims the text based on that assumption. The new code anticipates all\n possible text formats, present and future, and extracts the quest name\n based on regex pattern matching. This limits the possible number of\n incorrect file names for finishing quests. Remaining exceptions are\n handled on a case by case basis.", "committedDate": "2020-05-17T00:10:24Z", "type": "commit"}, {"oid": "41eeee4312d018c79f372f6d73a0a5ad52a468a0", "url": "https://github.com/runelite/runelite/commit/41eeee4312d018c79f372f6d73a0a5ad52a468a0", "message": "screenshot: add tests for naming quest complete screenshots\n\nAdds 7 test cases for testing the new mechanism to name the quest\ncomplete screenshot. Two test cases are quests that need no exception\nhandling. Five test cases are select quests which take extra code,\nimplemented in my previous commit, to refine the file name.", "committedDate": "2020-05-17T00:10:24Z", "type": "commit"}, {"oid": "7ae2bd6cc0dcdda18db152a46e6b085b1b37b145", "url": "https://github.com/runelite/runelite/commit/7ae2bd6cc0dcdda18db152a46e6b085b1b37b145", "message": "screenshot: add default case for naming quest complete screenshots\n\nIn the unlikely event that a new or updated quest reward scroll text\ndoes not match either regex, return a default string, until the code\naccounts for the new text.", "committedDate": "2020-05-17T00:10:24Z", "type": "commit"}, {"oid": "707a43888de4772ae2858a06a036b96bf76efc3e", "url": "https://github.com/runelite/runelite/commit/707a43888de4772ae2858a06a036b96bf76efc3e", "message": "screenshot: refine code, add test for naming quest complete screenshots\n\nImplements changes as requested, including adding a test case for when\nthe quest cannot be found. The reward scroll text to use for this case\nshould both be a reasonable message to expect and not match either regex\n used to match the input. The format used is \"quest name\" \"past tense\n irregular verb\".\n Also removes a line that, when running tests, now causes unnecessary\n stubbings error when previously it seemed necessary to run tests.", "committedDate": "2020-05-17T01:13:24Z", "type": "forcePushed"}, {"oid": "ad0d71803964c4885a1a78fb77a49fd683e8fe4d", "url": "https://github.com/runelite/runelite/commit/ad0d71803964c4885a1a78fb77a49fd683e8fe4d", "message": "screenshot: refine code, add test for naming quest complete screenshots\n\nImplements changes as requested, including adding a test case for when\nthe quest cannot be found. The reward scroll text to use for this case\nshould both be a reasonable message to expect and not match either regex\n used to match the input. The format used is \"quest name\" \"past tense\n irregular verb\".\n Also removes a line that, when running tests, now causes unnecessary\n stubbings error when previously it seemed necessary to run tests.", "committedDate": "2020-05-18T05:35:11Z", "type": "commit"}, {"oid": "ad0d71803964c4885a1a78fb77a49fd683e8fe4d", "url": "https://github.com/runelite/runelite/commit/ad0d71803964c4885a1a78fb77a49fd683e8fe4d", "message": "screenshot: refine code, add test for naming quest complete screenshots\n\nImplements changes as requested, including adding a test case for when\nthe quest cannot be found. The reward scroll text to use for this case\nshould both be a reasonable message to expect and not match either regex\n used to match the input. The format used is \"quest name\" \"past tense\n irregular verb\".\n Also removes a line that, when running tests, now causes unnecessary\n stubbings error when previously it seemed necessary to run tests.", "committedDate": "2020-05-18T05:35:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NTk3Nw==", "url": "https://github.com/runelite/runelite/pull/11580#discussion_r432865977", "bodyText": "This should probably just String parseQuestCompletedText(String text) which would make it easier to test due to not having the dep on the widget", "author": "Adam-", "createdAt": "2020-05-30T15:58:08Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/screenshot/ScreenshotPlugin.java", "diffHunk": "@@ -574,6 +576,57 @@ String parseLevelUpWidget(WidgetInfo levelUpLevel)\n \t\treturn skillName + \"(\" + skillLevel + \")\";\n \t}\n \n+\t/**\n+\t * Parses a WidgetInfo pointing to the second widget of the quest-completed dialog\n+\t * into a shortened string for filename usage.\n+\t *\n+\t * @return Shortened string in the format \"Quest(The Corsair Curse)\"\n+\t */\n+\t@VisibleForTesting\n+\tString parseQuestCompletedWidget()", "originalCommit": "ad0d71803964c4885a1a78fb77a49fd683e8fe4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4e9f00fd8bcd1d844a7863d2e4463da7cc279e4", "url": "https://github.com/runelite/runelite/commit/c4e9f00fd8bcd1d844a7863d2e4463da7cc279e4", "message": "Make quest parsing function static", "committedDate": "2020-06-01T05:39:54Z", "type": "commit"}, {"oid": "feaf77390f06f257aaeaa2f18a671348ee6ca4eb", "url": "https://github.com/runelite/runelite/commit/feaf77390f06f257aaeaa2f18a671348ee6ca4eb", "message": "fix method javadoc", "committedDate": "2020-06-01T05:42:34Z", "type": "commit"}, {"oid": "cfb96f1f1fb92327f5e433ccbf8fb9e8a38d8cf3", "url": "https://github.com/runelite/runelite/commit/cfb96f1f1fb92327f5e433ccbf8fb9e8a38d8cf3", "message": "cleanup", "committedDate": "2020-06-01T05:43:46Z", "type": "commit"}]}