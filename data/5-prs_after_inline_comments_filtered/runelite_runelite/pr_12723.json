{"pr_number": 12723, "pr_title": "hiscore: correctly look up ironmen players from chat message or self lookup", "pr_createdAt": "2020-10-30T15:53:07Z", "pr_url": "https://github.com/runelite/runelite/pull/12723", "timeline": [{"oid": "5e284fa3aab1804a97dc42de40ad9c8f2d933020", "url": "https://github.com/runelite/runelite/commit/5e284fa3aab1804a97dc42de40ad9c8f2d933020", "message": "hiscore: use correct endpoint when looking up self with shortcut", "committedDate": "2020-11-26T16:46:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODYzODA3Ng==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r558638076", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\tNameAutocompleter nameAutocompleter, OkHttpClient okHttpClient)\n          \n          \n            \n            \t\tNameAutocompleter nameAutocompleter, OkHttpClient okHttpClient)", "author": "Nightfirecat", "createdAt": "2021-01-15T23:00:00Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/hiscore/HiscorePanel.java", "diffHunk": "@@ -138,8 +138,8 @@\n \tprivate boolean loading = false;\n \n \t@Inject\n-\tpublic HiscorePanel(@Nullable Client client,\n-\t\tHiscoreConfig config, NameAutocompleter nameAutocompleter, OkHttpClient okHttpClient)\n+\tpublic HiscorePanel(@Nullable Client client, HiscorePlugin plugin, HiscoreConfig config,\n+\t\t\t\t\t\tNameAutocompleter nameAutocompleter, OkHttpClient okHttpClient)", "originalCommit": "5e284fa3aab1804a97dc42de40ad9c8f2d933020", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODY0NDU4NQ==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r558644585", "bodyText": "This part of the logic could be replaced by HiscorePanel#selectWorldEndpoint(), e.g.:\nprivate HiscoreEndpoint getLocalHiscoreEndpoint()\n{\n\tfinal HiscoreEndpoint profile = HiscorePanel.selectWorldEndpoint();\n\tif (profile != HiscoreEndpoint.NORMAL)\n\t{\n\t\treturn profile;\n\t}\n\n\tswitch (client.getAccountType())\n\t// ...\n}", "author": "Nightfirecat", "createdAt": "2021-01-15T23:12:19Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/hiscore/HiscorePlugin.java", "diffHunk": "@@ -217,4 +231,25 @@ private void lookupPlayer(String playerName)\n \t\t\thiscorePanel.lookup(playerName);\n \t\t});\n \t}\n+\n+\tprivate HiscoreEndpoint getLocalHiscoreEndpointType()\n+\t{\n+\t\tEnumSet<WorldType> worldType = client.getWorldType();\n+\t\tif (worldType.contains(WorldType.LEAGUE))\n+\t\t{\n+\t\t\treturn HiscoreEndpoint.LEAGUE;\n+\t\t}", "originalCommit": "5e284fa3aab1804a97dc42de40ad9c8f2d933020", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "871885177ec0386377929ce06c9fb121f5b246ed", "url": "https://github.com/runelite/runelite/commit/871885177ec0386377929ce06c9fb121f5b246ed", "message": "hiscore: use correct endpoint when looking up self with shortcut", "committedDate": "2021-01-17T14:41:37Z", "type": "forcePushed"}, {"oid": "54dee79aca6d16065a514b7157c3f0b48fd84b50", "url": "https://github.com/runelite/runelite/commit/54dee79aca6d16065a514b7157c3f0b48fd84b50", "message": "hiscore: use correct endpoint when looking up self with shortcut", "committedDate": "2021-01-17T14:48:42Z", "type": "forcePushed"}, {"oid": "7a4d58cb6a7153d711d0814a8651802a72ae7ecd", "url": "https://github.com/runelite/runelite/commit/7a4d58cb6a7153d711d0814a8651802a72ae7ecd", "message": "hiscore: use ironman icon when looking up players by chat message", "committedDate": "2021-02-07T22:56:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjYzMDU5MQ==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r572630591", "bodyText": "Suggested change", "author": "Nightfirecat", "createdAt": "2021-02-09T06:45:11Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/hiscore/HiscorePlugin.java", "diffHunk": "@@ -195,13 +207,22 @@ public void onMenuOptionClicked(MenuOptionClicked event)\n \t\t\t}\n \t\t\telse\n \t\t\t{\n+\t\t\t\t// Prefer the world-based endpoint if the world is special\n+\t\t\t\tendpoint = getWorldEndpoint();\n+\t\t\t\tif (endpoint == HiscoreEndpoint.NORMAL)\n+\t\t\t\t{\n+\t\t\t\t\tendpoint = getHiscoreEndpointFromName(event.getMenuTarget());\n+\t\t\t\t}\n+\n \t\t\t\ttarget = Text.removeTags(event.getMenuTarget());\n \t\t\t}\n \n-\t\t\tlookupPlayer(target);\n+\t\t\tlookupPlayer(target, endpoint);\n \t\t}\n \t}\n \n+\n+", "originalCommit": "7a4d58cb6a7153d711d0814a8651802a72ae7ecd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjYzMTc1OA==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r572631758", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tprivate HiscoreEndpoint getHiscoreEndpointFromName(String rawName)\n          \n          \n            \n            \t@Nullable\n          \n          \n            \n            \tprivate HiscoreEndpoint getHiscoreEndpointFromName(String rawName)", "author": "Nightfirecat", "createdAt": "2021-02-09T06:48:09Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/hiscore/HiscorePlugin.java", "diffHunk": "@@ -227,14 +254,92 @@ private void insertMenuEntry(MenuEntry newEntry, MenuEntry[] entries)\n \t}\n \n \tprivate void lookupPlayer(String playerName)\n+\t{\n+\t\tlookupPlayer(playerName, HiscoreEndpoint.NORMAL);\n+\t}\n+\n+\tprivate void lookupPlayer(String playerName, HiscoreEndpoint endpoint)\n \t{\n \t\tSwingUtilities.invokeLater(() ->\n \t\t{\n \t\t\tif (!navButton.isSelected())\n \t\t\t{\n \t\t\t\tnavButton.getOnSelect().run();\n \t\t\t}\n-\t\t\thiscorePanel.lookup(playerName);\n+\t\t\thiscorePanel.lookup(playerName, endpoint);\n \t\t});\n \t}\n+\n+\tHiscoreEndpoint getWorldEndpoint()\n+\t{\n+\t\tif (client != null)\n+\t\t{\n+\t\t\tEnumSet<WorldType> wTypes = client.getWorldType();\n+\n+\t\t\tif (wTypes.contains(WorldType.DEADMAN_TOURNAMENT))\n+\t\t\t{\n+\t\t\t\treturn HiscoreEndpoint.TOURNAMENT;\n+\t\t\t}\n+\t\t\telse if (wTypes.contains(WorldType.DEADMAN))\n+\t\t\t{\n+\t\t\t\treturn HiscoreEndpoint.DEADMAN;\n+\t\t\t}\n+\t\t\telse if (wTypes.contains(WorldType.LEAGUE))\n+\t\t\t{\n+\t\t\t\treturn HiscoreEndpoint.LEAGUE;\n+\t\t\t}\n+\t\t}\n+\t\treturn HiscoreEndpoint.NORMAL;\n+\t}\n+\n+\tprivate HiscoreEndpoint getLocalHiscoreEndpointType()\n+\t{\n+\t\tfinal HiscoreEndpoint profile = getWorldEndpoint();\n+\t\tif (profile != HiscoreEndpoint.NORMAL)\n+\t\t{\n+\t\t\treturn profile;\n+\t\t}\n+\n+\t\tif (client != null)\n+\t\t{\n+\t\t\tswitch (client.getAccountType())\n+\t\t\t{\n+\t\t\t\tcase IRONMAN:\n+\t\t\t\t\treturn HiscoreEndpoint.IRONMAN;\n+\t\t\t\tcase ULTIMATE_IRONMAN:\n+\t\t\t\t\treturn HiscoreEndpoint.ULTIMATE_IRONMAN;\n+\t\t\t\tcase HARDCORE_IRONMAN:\n+\t\t\t\t\treturn HiscoreEndpoint.HARDCORE_IRONMAN;\n+\t\t\t}\n+\t\t}\n+\t\treturn HiscoreEndpoint.NORMAL;\n+\t}\n+\n+\tprivate HiscoreEndpoint getHiscoreEndpointFromName(String rawName)", "originalCommit": "7a4d58cb6a7153d711d0814a8651802a72ae7ecd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjYzNjQwNw==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r572636407", "bodyText": "In fact I'm pretty sure this causes IndexOutOfBoundsException if it returns null by trying to get the -1 indexed tab via:\n\nnet.runelite.client.ui.components.materialtabs.MaterialTabGroup.getTab(MaterialTabGroup:83)\nnet.runelite.client.plugins.hiscore.HiscorePanel.lookup(HiscorePanel:364)\nnet.runelite.client.plugins.hiscore.HiscorePlugin.onMenuOptionClicked(HiscorePlugin:220)\n\nThat says to me we should do either or both of not returning null from this method or having better annotations/handling around null args for these methods.", "author": "Nightfirecat", "createdAt": "2021-02-09T06:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjYzMTc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjgxNTUyOQ==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r612815529", "bodyText": "Players can dm you from other worlds, so it probably would be best to just not check this. Or maybe check the flags of the world they are in, but those aren't always available.", "author": "Adam-", "createdAt": "2021-04-13T22:28:01Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/hiscore/HiscorePlugin.java", "diffHunk": "@@ -203,13 +207,22 @@ public void onMenuOptionClicked(MenuOptionClicked event)\n \t\t\t}\n \t\t\telse\n \t\t\t{\n+\t\t\t\t// Prefer the world-based endpoint if the world is special\n+\t\t\t\tendpoint = getWorldEndpoint();\n+\t\t\t\tif (endpoint == HiscoreEndpoint.NORMAL)", "originalCommit": "7a4d58cb6a7153d711d0814a8651802a72ae7ecd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjgxNTk2OA==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r612815968", "bodyText": "This is only use one other place, might aswell remove it and use the one which takes the endpoint.", "author": "Adam-", "createdAt": "2021-04-13T22:28:59Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/hiscore/HiscorePlugin.java", "diffHunk": "@@ -241,14 +254,19 @@ private void insertMenuEntry(MenuEntry newEntry, MenuEntry[] entries)\n \t}\n \n \tprivate void lookupPlayer(String playerName)", "originalCommit": "7a4d58cb6a7153d711d0814a8651802a72ae7ecd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjgxNjY0OQ==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r612816649", "bodyText": "I see no reason why this should ever be able to default to anything other than NORMAL", "author": "Adam-", "createdAt": "2021-04-13T22:30:40Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/hiscore/HiscorePlugin.java", "diffHunk": "@@ -296,4 +314,32 @@ private HiscoreEndpoint getLocalHiscoreEndpointType()\n \t\t}\n \t\treturn HiscoreEndpoint.NORMAL;\n \t}\n+\n+\tprivate HiscoreEndpoint getHiscoreEndpointFromName(String rawName)\n+\t{\n+\t\t// Remove <col> tags, as they come before the <img> tags we need.\n+\t\tMatcher macther = COL_STRIPPER.matcher(rawName);\n+\t\tif (macther.matches())\n+\t\t{\n+\t\t\trawName = macther.group(1);\n+\t\t}\n+\n+\t\tif (!rawName.startsWith(\"<\"))\n+\t\t{\n+\t\t\treturn HiscoreEndpoint.NORMAL;\n+\t\t}\n+\t\telse if (rawName.startsWith(IconID.IRONMAN.toString()))\n+\t\t{\n+\t\t\treturn HiscoreEndpoint.IRONMAN;\n+\t\t}\n+\t\telse if (rawName.startsWith(IconID.ULTIMATE_IRONMAN.toString()))\n+\t\t{\n+\t\t\treturn HiscoreEndpoint.ULTIMATE_IRONMAN;\n+\t\t}\n+\t\telse if (rawName.startsWith(IconID.HARDCORE_IRONMAN.toString()))\n+\t\t{\n+\t\t\treturn HiscoreEndpoint.HARDCORE_IRONMAN;\n+\t\t}\n+\t\treturn null;", "originalCommit": "7a4d58cb6a7153d711d0814a8651802a72ae7ecd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjgxNjg2NQ==", "url": "https://github.com/runelite/runelite/pull/12723#discussion_r612816865", "bodyText": "Instead of this, you could just contains() the name with IconID.toString()", "author": "Adam-", "createdAt": "2021-04-13T22:31:15Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/hiscore/HiscorePlugin.java", "diffHunk": "@@ -296,4 +314,32 @@ private HiscoreEndpoint getLocalHiscoreEndpointType()\n \t\t}\n \t\treturn HiscoreEndpoint.NORMAL;\n \t}\n+\n+\tprivate HiscoreEndpoint getHiscoreEndpointFromName(String rawName)\n+\t{\n+\t\t// Remove <col> tags, as they come before the <img> tags we need.\n+\t\tMatcher macther = COL_STRIPPER.matcher(rawName);", "originalCommit": "7a4d58cb6a7153d711d0814a8651802a72ae7ecd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "923100ab24da2904b4c057197badd46ddb74743f", "url": "https://github.com/runelite/runelite/commit/923100ab24da2904b4c057197badd46ddb74743f", "message": "Rename this", "committedDate": "2021-04-13T22:50:37Z", "type": "forcePushed"}, {"oid": "f8a73d58298f132f9ec2a683cb22e6f95b78fcd3", "url": "https://github.com/runelite/runelite/commit/f8a73d58298f132f9ec2a683cb22e6f95b78fcd3", "message": "hiscore: use correct endpoint when looking up self with shortcut\n\nCo-authored-by: Hydrox6 <ikada@protonmail.ch>", "committedDate": "2021-04-13T23:20:07Z", "type": "commit"}, {"oid": "d900cda417b64dde2ac8954d237516b071f9f1c9", "url": "https://github.com/runelite/runelite/commit/d900cda417b64dde2ac8954d237516b071f9f1c9", "message": "hiscore: use correct endpoint when looking up chat messages\n\nCo-authored-by: Hydrox6 <ikada@protonmail.ch>", "committedDate": "2021-04-13T23:26:47Z", "type": "commit"}, {"oid": "d900cda417b64dde2ac8954d237516b071f9f1c9", "url": "https://github.com/runelite/runelite/commit/d900cda417b64dde2ac8954d237516b071f9f1c9", "message": "hiscore: use correct endpoint when looking up chat messages\n\nCo-authored-by: Hydrox6 <ikada@protonmail.ch>", "committedDate": "2021-04-13T23:26:47Z", "type": "forcePushed"}]}