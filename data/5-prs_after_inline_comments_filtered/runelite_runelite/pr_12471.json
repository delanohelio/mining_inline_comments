{"pr_number": 12471, "pr_title": "discord: Fix action timeout, add in game time elapsed option", "pr_createdAt": "2020-09-08T23:28:51Z", "pr_url": "https://github.com/runelite/runelite/pull/12471", "timeline": [{"oid": "6960c93e669a6c3f20c82713dffdd4c4ee060ac2", "url": "https://github.com/runelite/runelite/commit/6960c93e669a6c3f20c82713dffdd4c4ee060ac2", "message": "discord: Small refactor, fix not showing area, fix various regressions", "committedDate": "2020-09-09T03:07:11Z", "type": "forcePushed"}, {"oid": "19161d6aee1fd6acc37e4f00c38808e57c7ad89a", "url": "https://github.com/runelite/runelite/commit/19161d6aee1fd6acc37e4f00c38808e57c7ad89a", "message": "Cleanup\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-09-11T14:23:04Z", "type": "forcePushed"}, {"oid": "f02d231a42197cb191416660f071112cd1a28289", "url": "https://github.com/runelite/runelite/commit/f02d231a42197cb191416660f071112cd1a28289", "message": "Cleanup\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-09-11T14:25:25Z", "type": "forcePushed"}, {"oid": "0c5232f77583595e0e06cb2bef94a09d55437e0b", "url": "https://github.com/runelite/runelite/commit/0c5232f77583595e0e06cb2bef94a09d55437e0b", "message": "Cleanup\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-09-11T14:37:40Z", "type": "forcePushed"}, {"oid": "de2f1ad81b5a324323c0784034d38ff45011741f", "url": "https://github.com/runelite/runelite/commit/de2f1ad81b5a324323c0784034d38ff45011741f", "message": "Cleanup\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-09-11T17:08:19Z", "type": "forcePushed"}, {"oid": "20d3e33e2dcd441c937d36c820ff12e31bd55177", "url": "https://github.com/runelite/runelite/commit/20d3e33e2dcd441c937d36c820ff12e31bd55177", "message": "Cleanup\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-09-11T18:11:53Z", "type": "forcePushed"}, {"oid": "32d680840008ba71872700026a7f0b6606004c47", "url": "https://github.com/runelite/runelite/commit/32d680840008ba71872700026a7f0b6606004c47", "message": "Cleanup\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-09-11T18:12:52Z", "type": "forcePushed"}, {"oid": "96c8ba368322b98034d58ba95e9ba2a7ae2ed832", "url": "https://github.com/runelite/runelite/commit/96c8ba368322b98034d58ba95e9ba2a7ae2ed832", "message": "Cleanup\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-09-11T19:15:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU4Mjc3Nw==", "url": "https://github.com/runelite/runelite/pull/12471#discussion_r503582777", "bodyText": "Imo this behaviour should be controlled by enum. Basically what you want here is flag to mark IN_GAME event to be \"sticky\" or something, e.g it should not be removed when shouldClear event triggers. Or add shouldBeCleared and shouldClear flags where shouldClear will clear other events that need to be cleared and shouldBeCleared will determine if the event will be cleared.\nSo in this case you would end up with IN_GAME event with shouldBeCleared: false, shouldClear: true", "author": "deathbeam", "createdAt": "2020-10-12T23:25:32Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/discord/DiscordState.java", "diffHunk": "@@ -115,32 +117,51 @@ void refresh()\n \tvoid triggerEvent(final DiscordGameEventType eventType)\n \t{\n \t\tfinal Optional<EventWithTime> foundEvent = events.stream().filter(e -> e.type == eventType).findFirst();\n-\t\tEventWithTime event;\n+\t\tfinal EventWithTime event;\n \n \t\tif (foundEvent.isPresent())\n \t\t{\n \t\t\tevent = foundEvent.get();\n \t\t}\n \t\telse\n \t\t{\n-\t\t\tevent = new EventWithTime(eventType, Instant.now());\n-\n+\t\t\tevent = new EventWithTime(eventType);\n+\t\t\tevent.setStart(Instant.now());\n \t\t\tevents.add(event);\n \t\t}\n \n \t\tevent.setUpdated(Instant.now());\n \n-\t\tif (event.getType().isShouldClear())\n+\t\t// An IN_GAME (or IN_MENU) event should remove all other areas from events\n+\t\t// but since events is fully cleared every time before IN_MENU is added,\n+\t\t// we will never need to run this on an IN_MENU event trigger\n+\t\tif (event.getType().isShouldClear() || event.getType() == DiscordGameEventType.IN_GAME)", "originalCommit": "7413c8d1b55f6299420bc5319146a40538d86500", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d73f95c746ba53a6850816f6fc8df1b2337f8b38", "url": "https://github.com/runelite/runelite/commit/d73f95c746ba53a6850816f6fc8df1b2337f8b38", "message": "discord: Add option to display total time. Time resets on exiting to menu.", "committedDate": "2020-10-12T23:36:57Z", "type": "commit"}, {"oid": "360f8bdedeac57de2867dd4adc3103ce41c3025a", "url": "https://github.com/runelite/runelite/commit/360f8bdedeac57de2867dd4adc3103ce41c3025a", "message": "discord: Fixed action timeout.", "committedDate": "2020-10-12T23:36:57Z", "type": "commit"}, {"oid": "61ea39f01da8031e4739901e3824c65df7074b48", "url": "https://github.com/runelite/runelite/commit/61ea39f01da8031e4739901e3824c65df7074b48", "message": "discord: Small refactor, fix not showing area, fix various regressions", "committedDate": "2020-10-12T23:36:57Z", "type": "commit"}, {"oid": "96a651aaa44612b386d9f171394252237362ad22", "url": "https://github.com/runelite/runelite/commit/96a651aaa44612b386d9f171394252237362ad22", "message": "Cleanup\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-10-12T23:36:57Z", "type": "commit"}, {"oid": "8eac93f2db29cccfbaf2602d301fa4b824952cff", "url": "https://github.com/runelite/runelite/commit/8eac93f2db29cccfbaf2602d301fa4b824952cff", "message": "Fixes: total time resetting on area change, area change from known location -> generic IN_GAME not updating presence.", "committedDate": "2020-10-12T23:36:57Z", "type": "commit"}, {"oid": "fc72e8ddce36dde93c77556f58fdba1e31d90e7a", "url": "https://github.com/runelite/runelite/commit/fc72e8ddce36dde93c77556f58fdba1e31d90e7a", "message": "discord: add test for correct state on area change", "committedDate": "2020-10-12T23:36:57Z", "type": "commit"}, {"oid": "2b38eea250dd2be7de8839a05771abef24df1442", "url": "https://github.com/runelite/runelite/commit/2b38eea250dd2be7de8839a05771abef24df1442", "message": "small cleanup", "committedDate": "2020-10-12T23:36:58Z", "type": "commit"}, {"oid": "8ccea05eaffb6dbeefc57e39c07ab17ccdd43e6d", "url": "https://github.com/runelite/runelite/commit/8ccea05eaffb6dbeefc57e39c07ab17ccdd43e6d", "message": "Cleanup 2\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-10-12T23:49:08Z", "type": "forcePushed"}, {"oid": "115de72c771e8d489f6f12166e2ce93ca2ed9ba4", "url": "https://github.com/runelite/runelite/commit/115de72c771e8d489f6f12166e2ce93ca2ed9ba4", "message": "Cleanup 2\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-10-12T23:57:23Z", "type": "forcePushed"}, {"oid": "740b15fb8b72b727c2672c9afcfd144a94ca6896", "url": "https://github.com/runelite/runelite/commit/740b15fb8b72b727c2672c9afcfd144a94ca6896", "message": "Cleanup 2\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-10-13T00:00:55Z", "type": "forcePushed"}, {"oid": "583eeb779285cad8c6a5d11f752e69ea6b3d5a2c", "url": "https://github.com/runelite/runelite/commit/583eeb779285cad8c6a5d11f752e69ea6b3d5a2c", "message": "Cleanup 2\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-10-13T00:02:06Z", "type": "commit"}, {"oid": "583eeb779285cad8c6a5d11f752e69ea6b3d5a2c", "url": "https://github.com/runelite/runelite/commit/583eeb779285cad8c6a5d11f752e69ea6b3d5a2c", "message": "Cleanup 2\n\nSigned-off-by: Tomas Slusny <slusnucky@gmail.com>", "committedDate": "2020-10-13T00:02:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2ODk1NQ==", "url": "https://github.com/runelite/runelite/pull/12471#discussion_r503868955", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Determines if event should clear other events when triggered\n          \n          \n            \n            \t * Determines if event should clear other clearable events when triggered", "author": "Matthew-nop", "createdAt": "2020-10-13T11:19:10Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/discord/DiscordGameEventType.java", "diffHunk": "@@ -451,10 +451,32 @@\n \tprivate String details;\n \n \tprivate int priority;\n+\n+\t/**\n+\t * Marks this event as root event, e.g event that should be used for total time tracking\n+\t */\n+\tprivate boolean root;\n+\n+\t/**\n+\t * Determines if event should clear other events when triggered", "originalCommit": "583eeb779285cad8c6a5d11f752e69ea6b3d5a2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2OTA1Mg==", "url": "https://github.com/runelite/runelite/pull/12471#discussion_r503869052", "bodyText": "Would naming this clearable make this more distinct from shouldClear? Also the documentation should state that it's also cleared when a shouldClear event is processed.", "author": "Matthew-nop", "createdAt": "2020-10-13T11:19:20Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/discord/DiscordGameEventType.java", "diffHunk": "@@ -451,10 +451,32 @@\n \tprivate String details;\n \n \tprivate int priority;\n+\n+\t/**\n+\t * Marks this event as root event, e.g event that should be used for total time tracking\n+\t */\n+\tprivate boolean root;\n+\n+\t/**\n+\t * Determines if event should clear other events when triggered\n+\t */\n \tprivate boolean shouldClear;\n+\n+\t/**\n+\t * Determines if event should be processed when it timeouts based on action timeout\n+\t */\n \tprivate boolean shouldTimeout;\n+\n+\t/**\n+\t * Determines if event start time should be reset when processed\n+\t */\n \tprivate boolean shouldRestart;\n \n+\t/**\n+\t * Determines if event should be cleared when processed\n+\t */\n+\tprivate boolean shouldBeCleared = true;", "originalCommit": "583eeb779285cad8c6a5d11f752e69ea6b3d5a2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk1NzU4Nw==", "url": "https://github.com/runelite/runelite/pull/12471#discussion_r505957587", "bodyText": "processed indicates that its cleared when that happens (as events are processed either when triggered or in the periodic timeout check). and i think shouldBeCleared is more clear, idk", "author": "deathbeam", "createdAt": "2020-10-16T01:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2OTA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMzY2OQ==", "url": "https://github.com/runelite/runelite/pull/12471#discussion_r503903669", "bodyText": "Assuming there's only 1 root event in events list at any given time, this could be simplified.", "author": "Matthew-nop", "createdAt": "2020-10-13T12:19:35Z", "path": "runelite-client/src/main/java/net/runelite/client/plugins/discord/DiscordState.java", "diffHunk": "@@ -209,10 +206,10 @@ private void updatePresenceWithLatestEvent()\n \t\t\t\tbreak;\n \t\t\tcase TOTAL:\n \t\t\t\t// We are tracking total time spent instead of per activity time so try to find\n-\t\t\t\t// IN_GAME or IN_MENU event as this indicates start of tracking and find last updated one\n-\t\t\t\t// to determine if we are in game or menu\n+\t\t\t\t// root event as this indicates start of tracking and find last updated one\n+\t\t\t\t// to determine correct state we are in\n \t\t\t\tstartTime = events.stream()\n-\t\t\t\t\t.filter(e -> e.type == DiscordGameEventType.IN_GAME || e.type == DiscordGameEventType.IN_MENU)\n+\t\t\t\t\t.filter(e -> e.getType().isRoot())\n \t\t\t\t\t.sorted((a, b) -> b.getUpdated().compareTo(a.getUpdated()))\n \t\t\t\t\t.map(EventWithTime::getStart)\n \t\t\t\t\t.findFirst()", "originalCommit": "583eeb779285cad8c6a5d11f752e69ea6b3d5a2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk1NzAwMA==", "url": "https://github.com/runelite/runelite/pull/12471#discussion_r505957000", "bodyText": "Well in-menu theoretically can be active at same time as in-game timer", "author": "deathbeam", "createdAt": "2020-10-16T01:14:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMzY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MTc5Mg==", "url": "https://github.com/runelite/runelite/pull/12471#discussion_r506341792", "bodyText": "Yeah, this is just to clarify which section of code I was referring to in the above post. Although both can be in the events list, is it possible for the player to actually be both in-menu and in-game at the same time?", "author": "Matthew-nop", "createdAt": "2020-10-16T11:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMzY2OQ=="}], "type": "inlineReview"}, {"oid": "07210563898eee5a49a469dfcfbea99518291011", "url": "https://github.com/runelite/runelite/commit/07210563898eee5a49a469dfcfbea99518291011", "message": "Update runelite-client/src/main/java/net/runelite/client/plugins/discord/DiscordGameEventType.java\n\nCo-authored-by: Matthew C <66925241+Matthew-nop@users.noreply.github.com>", "committedDate": "2020-10-23T21:21:24Z", "type": "commit"}]}