{"pr_number": 4756, "pr_title": "[FEATURE]Check date type to avoid scan all partitions", "pr_createdAt": "2020-10-17T12:55:50Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4756", "timeline": [{"oid": "1a15f533098eec6708121004ef835d111dc374f3", "url": "https://github.com/apache/incubator-doris/commit/1a15f533098eec6708121004ef835d111dc374f3", "message": "udf: replace function", "committedDate": "2020-08-13T14:09:31Z", "type": "commit"}, {"oid": "7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "url": "https://github.com/apache/incubator-doris/commit/7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-14T01:37:05Z", "type": "commit"}, {"oid": "391158f52190755b5fc621c31bf703835c0a7b3b", "url": "https://github.com/apache/incubator-doris/commit/391158f52190755b5fc621c31bf703835c0a7b3b", "message": "udf: replace function", "committedDate": "2020-08-14T02:11:25Z", "type": "commit"}, {"oid": "5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "url": "https://github.com/apache/incubator-doris/commit/5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "message": "udf: replace function", "committedDate": "2020-08-14T03:58:30Z", "type": "commit"}, {"oid": "a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "url": "https://github.com/apache/incubator-doris/commit/a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-18T02:31:52Z", "type": "commit"}, {"oid": "86f841f29fa4ee19773d6c5922465194a2887cf6", "url": "https://github.com/apache/incubator-doris/commit/86f841f29fa4ee19773d6c5922465194a2887cf6", "message": "udf: replace function", "committedDate": "2020-08-18T03:56:14Z", "type": "commit"}, {"oid": "ade1afa75c94a178a6801ba1324acf25ad8b16fe", "url": "https://github.com/apache/incubator-doris/commit/ade1afa75c94a178a6801ba1324acf25ad8b16fe", "message": "udf: replace function", "committedDate": "2020-08-18T03:59:59Z", "type": "commit"}, {"oid": "1d95a491115064c9753694ad4d45c2f72b8d2645", "url": "https://github.com/apache/incubator-doris/commit/1d95a491115064c9753694ad4d45c2f72b8d2645", "message": "udf: replace function", "committedDate": "2020-08-18T08:01:45Z", "type": "commit"}, {"oid": "433eb87f02cfa6740e80b0e4157d916ab5aca400", "url": "https://github.com/apache/incubator-doris/commit/433eb87f02cfa6740e80b0e4157d916ab5aca400", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-24T02:03:34Z", "type": "commit"}, {"oid": "c62d239792b174fbc56ab311f0bc5337de971d96", "url": "https://github.com/apache/incubator-doris/commit/c62d239792b174fbc56ab311f0bc5337de971d96", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-25T03:17:32Z", "type": "commit"}, {"oid": "0a8db8cc4e7e72ebad4491a2cd48c758a435ba5c", "url": "https://github.com/apache/incubator-doris/commit/0a8db8cc4e7e72ebad4491a2cd48c758a435ba5c", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-25T08:21:34Z", "type": "commit"}, {"oid": "02d3f863c8556463c8dea903abdc4d21bf1eb19b", "url": "https://github.com/apache/incubator-doris/commit/02d3f863c8556463c8dea903abdc4d21bf1eb19b", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-01T01:25:42Z", "type": "commit"}, {"oid": "41da0ba0109414c47239f3fb926da48540059018", "url": "https://github.com/apache/incubator-doris/commit/41da0ba0109414c47239f3fb926da48540059018", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-08T08:25:12Z", "type": "commit"}, {"oid": "de4e523b505f0d628a16199b88d4bb5a0419fef6", "url": "https://github.com/apache/incubator-doris/commit/de4e523b505f0d628a16199b88d4bb5a0419fef6", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-11T02:42:20Z", "type": "commit"}, {"oid": "a863b0dfc7f909bf1ca8ad176ef8f82b1346924f", "url": "https://github.com/apache/incubator-doris/commit/a863b0dfc7f909bf1ca8ad176ef8f82b1346924f", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-17T09:37:21Z", "type": "commit"}, {"oid": "024c422b74829efe4c4b715a014517c7eee1a80a", "url": "https://github.com/apache/incubator-doris/commit/024c422b74829efe4c4b715a014517c7eee1a80a", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-22T09:15:31Z", "type": "commit"}, {"oid": "e1656c7a8bdc137261505d8b384dddb1c9bf5a72", "url": "https://github.com/apache/incubator-doris/commit/e1656c7a8bdc137261505d8b384dddb1c9bf5a72", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-23T11:48:49Z", "type": "commit"}, {"oid": "837e037057936e933fd79cbbdb432047be2bba5e", "url": "https://github.com/apache/incubator-doris/commit/837e037057936e933fd79cbbdb432047be2bba5e", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-27T06:37:32Z", "type": "commit"}, {"oid": "a36d3e78136a3fefb62f2513d20773479904cb6b", "url": "https://github.com/apache/incubator-doris/commit/a36d3e78136a3fefb62f2513d20773479904cb6b", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-17T10:32:25Z", "type": "commit"}, {"oid": "33af93fd282010043dac760ce09ddf70aacbc1c6", "url": "https://github.com/apache/incubator-doris/commit/33af93fd282010043dac760ce09ddf70aacbc1c6", "message": "check invalid date type", "committedDate": "2020-10-17T12:21:32Z", "type": "commit"}, {"oid": "ab58cbd3dc2cbd0c7358c5847eef3f8aad8bfcf0", "url": "https://github.com/apache/incubator-doris/commit/ab58cbd3dc2cbd0c7358c5847eef3f8aad8bfcf0", "message": "Check date type to avoid scan all partitions", "committedDate": "2020-10-17T12:55:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ4NjgwNg==", "url": "https://github.com/apache/incubator-doris/pull/4756#discussion_r508486806", "bodyText": "Why not check the type in analysis state?", "author": "xy720", "createdAt": "2020-10-20T13:10:12Z", "path": "fe/fe-core/src/main/java/org/apache/doris/rewrite/ExprRewriter.java", "diffHunk": "@@ -55,6 +58,12 @@ public Expr rewrite(Expr expr, Analyzer analyzer) throws AnalysisException {\n                 rewrittenExpr = applyRuleRepeatedly(rewrittenExpr, rule, analyzer);\n             }\n         } while (oldNumChanges != numChanges_);\n+        if (expr instanceof BinaryPredicate) {", "originalCommit": "ab58cbd3dc2cbd0c7358c5847eef3f8aad8bfcf0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ4ODgxNQ==", "url": "https://github.com/apache/incubator-doris/pull/4756#discussion_r508488815", "bodyText": "I think throwing a exception is not the best solution of this problem, may be rewrite the binary expr day = '2020-10-32' to something like contant expr BoolLiteral[false] in where statement is better. We should discuss it first.", "author": "xy720", "createdAt": "2020-10-20T13:12:55Z", "path": "fe/fe-core/src/main/java/org/apache/doris/rewrite/ExprRewriter.java", "diffHunk": "@@ -55,6 +58,12 @@ public Expr rewrite(Expr expr, Analyzer analyzer) throws AnalysisException {\n                 rewrittenExpr = applyRuleRepeatedly(rewrittenExpr, rule, analyzer);\n             }\n         } while (oldNumChanges != numChanges_);\n+        if (expr instanceof BinaryPredicate) {\n+            Expr valueExpr = ((BinaryPredicate) expr).getBinding();\n+            if(valueExpr != null && valueExpr.getType() == Type.DATETIME && valueExpr instanceof CastExpr) {\n+                throw new AnalysisException(\"invalid date type :\" + valueExpr.toSql());", "originalCommit": "ab58cbd3dc2cbd0c7358c5847eef3f8aad8bfcf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA1NjkyMw==", "url": "https://github.com/apache/incubator-doris/pull/4756#discussion_r509056923", "bodyText": "I think throwing a exception is not the best solution of this problem, may be rewrite the binary expr day = '2020-10-32' to something like contant expr BoolLiteral[false] in where statement is better. We should discuss it first.\n\nok\uff0cI will modify it;", "author": "xinghuayu007", "createdAt": "2020-10-21T07:41:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ4ODgxNQ=="}], "type": "inlineReview"}, {"oid": "1ef7fb849f5aa7561264fc51a91ecc797b06f5ea", "url": "https://github.com/apache/incubator-doris/commit/1ef7fb849f5aa7561264fc51a91ecc797b06f5ea", "message": "update", "committedDate": "2020-10-22T08:17:05Z", "type": "commit"}, {"oid": "92ee1afa05c4c077ba17598780d970e6ef2970bb", "url": "https://github.com/apache/incubator-doris/commit/92ee1afa05c4c077ba17598780d970e6ef2970bb", "message": "update", "committedDate": "2020-10-22T08:35:41Z", "type": "commit"}, {"oid": "c5ef96ee72be91124694f0944169e3b14053fb1e", "url": "https://github.com/apache/incubator-doris/commit/c5ef96ee72be91124694f0944169e3b14053fb1e", "message": "update", "committedDate": "2020-10-22T09:38:58Z", "type": "commit"}, {"oid": "87378184aa355d7acffc6c250cc1d5a19f83b5ce", "url": "https://github.com/apache/incubator-doris/commit/87378184aa355d7acffc6c250cc1d5a19f83b5ce", "message": "update", "committedDate": "2020-10-22T09:40:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE2NTQ5Ng==", "url": "https://github.com/apache/incubator-doris/pull/4756#discussion_r510165496", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(valueExpr.getType() == Type.DATETIME && valueExpr instanceof CastExpr) {\n          \n          \n            \n                    if(valueExpr.getType() == Type.DATETIME && valueExpr instanceof CastExpr && valueExpr.getChild(0).getType() == Type.VARCHAR) {\n          \n      \n    \n    \n  \n\nThere is something wrong with this If statement.\nFor example, where day = 20201030 will rewrite to where false, which is not right.\nYou should only support covert StringLiteral now:\nwhere day = '20201032' -> where false", "author": "xy720", "createdAt": "2020-10-22T13:34:17Z", "path": "fe/fe-core/src/main/java/org/apache/doris/rewrite/BinaryPredicatesDateRule.java", "diffHunk": "@@ -0,0 +1,46 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.rewrite;\n+\n+import org.apache.doris.analysis.Analyzer;\n+import org.apache.doris.analysis.BinaryPredicate;\n+import org.apache.doris.analysis.CastExpr;\n+import org.apache.doris.analysis.Expr;\n+import org.apache.doris.analysis.BoolLiteral;\n+import org.apache.doris.catalog.Type;\n+import org.apache.doris.common.AnalysisException;\n+\n+/**\n+ * Binary predicaate date rule try to convert date expression, if date is invalid, it will be\n+ * convert into bool literal to avoid to scan all partitions\n+ * Examples:\n+ * date = \"2020-10-32\" => FALSE\n+ */\n+public class BinaryPredicatesDateRule implements ExprRewriteRule {\n+    public static ExprRewriteRule INSTANCE = new BinaryPredicatesDateRule();\n+\n+    @Override\n+    public Expr apply(Expr expr, Analyzer analyzer) throws AnalysisException {\n+        if (!(expr instanceof BinaryPredicate)) return expr;\n+        Expr valueExpr = expr.getChild(1);\n+        if(valueExpr.getType() == Type.DATETIME && valueExpr instanceof CastExpr) {", "originalCommit": "87378184aa355d7acffc6c250cc1d5a19f83b5ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3NjIzMg==", "url": "https://github.com/apache/incubator-doris/pull/4756#discussion_r510576232", "bodyText": "The rule of FoldConstantsRule will convert where day = 20201030 into where day='2020-10-30 00:00:00', whic is DateLiteral type.", "author": "xinghuayu007", "createdAt": "2020-10-23T03:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE2NTQ5Ng=="}], "type": "inlineReview"}, {"oid": "9a302474f7b4f117e7c018698b393b89115ab4a9", "url": "https://github.com/apache/incubator-doris/commit/9a302474f7b4f117e7c018698b393b89115ab4a9", "message": "update", "committedDate": "2020-10-23T02:08:34Z", "type": "commit"}, {"oid": "5fd15004b77a45c4417b050b37f0503265910d06", "url": "https://github.com/apache/incubator-doris/commit/5fd15004b77a45c4417b050b37f0503265910d06", "message": "Merge remote-tracking branch 'upstream/master' into check_datetime", "committedDate": "2020-10-23T02:09:00Z", "type": "commit"}, {"oid": "a4bdbcdd677781efedfb5df8d487f6e876e407b2", "url": "https://github.com/apache/incubator-doris/commit/a4bdbcdd677781efedfb5df8d487f6e876e407b2", "message": "update", "committedDate": "2020-10-23T15:37:47Z", "type": "commit"}, {"oid": "99f6e307f855337599d9731bbb7473c0bb6e564d", "url": "https://github.com/apache/incubator-doris/commit/99f6e307f855337599d9731bbb7473c0bb6e564d", "message": "Merge remote-tracking branch 'upstream/master' into check_datetime", "committedDate": "2020-10-27T02:06:44Z", "type": "commit"}, {"oid": "1736f13e52da7f5d5f2072cd400c604fde5c228e", "url": "https://github.com/apache/incubator-doris/commit/1736f13e52da7f5d5f2072cd400c604fde5c228e", "message": "update", "committedDate": "2020-11-01T11:21:57Z", "type": "commit"}, {"oid": "685a7bf0ea0f884def809d8d8a664eeae96bd371", "url": "https://github.com/apache/incubator-doris/commit/685a7bf0ea0f884def809d8d8a664eeae96bd371", "message": "update", "committedDate": "2020-11-01T11:39:24Z", "type": "commit"}, {"oid": "7b2d36d78be8cf87d968e4a8df89dbc3cf03c1d3", "url": "https://github.com/apache/incubator-doris/commit/7b2d36d78be8cf87d968e4a8df89dbc3cf03c1d3", "message": "update", "committedDate": "2020-11-01T11:45:51Z", "type": "commit"}]}