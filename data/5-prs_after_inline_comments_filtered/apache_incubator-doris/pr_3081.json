{"pr_number": 3081, "pr_title": "[Dynamic Partition] Support for automatically drop partitions", "pr_createdAt": "2020-03-11T09:00:56Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3081", "timeline": [{"oid": "9320c0f5d445f3adbc496ee1054616b539490620", "url": "https://github.com/apache/incubator-doris/commit/9320c0f5d445f3adbc496ee1054616b539490620", "message": "[Dynamic Partition]Support dynamic drop partition", "committedDate": "2020-03-10T10:15:36Z", "type": "commit"}, {"oid": "33c175ac84471194b4a85261f25781e3fdb1b863", "url": "https://github.com/apache/incubator-doris/commit/33c175ac84471194b4a85261f25781e3fdb1b863", "message": "fix default start", "committedDate": "2020-03-10T11:24:25Z", "type": "commit"}, {"oid": "4592093a7c3f8e3b4c748d2c7874e9e44bfc1f88", "url": "https://github.com/apache/incubator-doris/commit/4592093a7c3f8e3b4c748d2c7874e9e44bfc1f88", "message": "fix test", "committedDate": "2020-03-10T12:57:47Z", "type": "commit"}, {"oid": "4bdc5acd9b0511431e202d810954329847407d0f", "url": "https://github.com/apache/incubator-doris/commit/4bdc5acd9b0511431e202d810954329847407d0f", "message": "complete drop logic", "committedDate": "2020-03-11T08:54:58Z", "type": "commit"}, {"oid": "5b7c26d4fe66900d49d0a552683110171d623a66", "url": "https://github.com/apache/incubator-doris/commit/5b7c26d4fe66900d49d0a552683110171d623a66", "message": "fix miss start property in alter", "committedDate": "2020-03-12T09:41:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNjU5Mg==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r392106592", "bodyText": "-3?", "author": "kangkaisen", "createdAt": "2020-03-13T09:09:53Z", "path": "fe/src/test/java/org/apache/doris/persist/ModifyDynamicPartitionInfoTest.java", "diffHunk": "@@ -49,6 +49,7 @@ public void testNormal() throws IOException {\n         HashMap<String, String> properties = new HashMap<>();\n         properties.put(DynamicPartitionProperty.ENABLE, \"true\");\n         properties.put(DynamicPartitionProperty.TIME_UNIT, \"day\");\n+        properties.put(DynamicPartitionProperty.START, \"3\");", "originalCommit": "5b7c26d4fe66900d49d0a552683110171d623a66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNjcxMA==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r392106710", "bodyText": "-3", "author": "kangkaisen", "createdAt": "2020-03-13T09:10:08Z", "path": "fe/src/test/java/org/apache/doris/catalog/TablePropertyTest.java", "diffHunk": "@@ -49,6 +49,7 @@ public void testNormal() throws IOException {\n         HashMap<String, String> properties = new HashMap<>();\n         properties.put(DynamicPartitionProperty.ENABLE, \"true\");\n         properties.put(DynamicPartitionProperty.TIME_UNIT, \"day\");\n+        properties.put(DynamicPartitionProperty.START, \"3\");", "originalCommit": "5b7c26d4fe66900d49d0a552683110171d623a66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNzcxNg==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r392107716", "bodyText": "You could refer to QueryPlanTest, and create real table.", "author": "kangkaisen", "createdAt": "2020-03-13T09:12:14Z", "path": "fe/src/test/java/org/apache/doris/catalog/DynamicPartitionTableTest.java", "diffHunk": "@@ -293,6 +294,50 @@ public void testMissTimeUnit(@Injectable SystemInfoService systemInfoService,\n         catalog.createTable(stmt);\n     }\n \n+    @Test\n+    public void testMissSTART(@Injectable SystemInfoService systemInfoService,", "originalCommit": "5b7c26d4fe66900d49d0a552683110171d623a66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI5MzgwNQ==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r392293805", "bodyText": "ok, i will change it.", "author": "WingsGo", "createdAt": "2020-03-13T15:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNzcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MDkxNA==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r394770914", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-03-19T03:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNzcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwODg3Mw==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r392108873", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @ConfField(mutable = false, masterOnly = true)\n          \n          \n            \n                @ConfField", "author": "kangkaisen", "createdAt": "2020-03-13T09:14:49Z", "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -981,7 +981,7 @@\n     /*\n      * Decide how often to check dynamic partition\n      */\n-    @ConfField(mutable = true, masterOnly = true)\n+    @ConfField(mutable = false, masterOnly = true)", "originalCommit": "5b7c26d4fe66900d49d0a552683110171d623a66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MDc5NQ==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r394770795", "bodyText": "I think maybe we should allow dynamic change the check interval seconds?", "author": "WingsGo", "createdAt": "2020-03-19T03:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwODg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3NTU5Ng==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r392275596", "bodyText": "the pattern should be:\ndb.readLock();\ntry {\n    OlapTable olapTable = (OlapTable) db.getTable(tableId);\n    .....\n} finally {\n    db.readUnlock();\n}", "author": "morningman", "createdAt": "2020-03-13T14:50:43Z", "path": "fe/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -136,12 +245,15 @@ private void dynamicAddPartition() {\n                 iterator.remove();\n                 continue;\n             }\n-            String tableName;\n-            ArrayList<AddPartitionClause> addPartitionClauses = new ArrayList<>();\n+\n             db.readLock();\n+            ArrayList<AddPartitionClause> addPartitionClauses;\n+            ArrayList<DropPartitionClause> dropPartitionClauses;\n+            OlapTable olapTable = (OlapTable) db.getTable(tableId);\n+            String tableName;\n+            boolean skipAddPartition = false;", "originalCommit": "5b7c26d4fe66900d49d0a552683110171d623a66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwMzk5Nw==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r392303997", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-03-13T15:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3NTU5Ng=="}], "type": "inlineReview"}, {"oid": "83648e4109e53ec672275e8185a9b8b663fadac3", "url": "https://github.com/apache/incubator-doris/commit/83648e4109e53ec672275e8185a9b8b663fadac3", "message": "fix", "committedDate": "2020-03-13T15:12:46Z", "type": "commit"}, {"oid": "a2acca757b6f0d199cec93474e0275fbce7442c5", "url": "https://github.com/apache/incubator-doris/commit/a2acca757b6f0d199cec93474e0275fbce7442c5", "message": "fix", "committedDate": "2020-03-13T15:35:44Z", "type": "commit"}, {"oid": "71b7ff050e0c99399aa96f5994d05fe688ac31f4", "url": "https://github.com/apache/incubator-doris/commit/71b7ff050e0c99399aa96f5994d05fe688ac31f4", "message": "fix", "committedDate": "2020-03-18T11:11:50Z", "type": "commit"}, {"oid": "793aa9ea8f7a1cf33d555d616ffb3c8e880c88ad", "url": "https://github.com/apache/incubator-doris/commit/793aa9ea8f7a1cf33d555d616ffb3c8e880c88ad", "message": "fix", "committedDate": "2020-03-19T03:29:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4NTM4OA==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r396185388", "bodyText": "No need to get add partition clause is skipAddPartition is true.", "author": "morningman", "createdAt": "2020-03-23T02:25:51Z", "path": "fe/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -168,98 +281,62 @@ private void dynamicAddPartition() {\n                 try {\n                     partitionFormat = DynamicPartitionUtil.getPartitionFormat(partitionColumn);\n                 } catch (DdlException e) {\n-                    recordFailedMsg(olapTable.getName(), e.getMessage());\n+                    recordCreatePartitionFailedMsg(olapTable.getName(), e.getMessage());\n                     continue;\n                 }\n \n-                Calendar calendar = Calendar.getInstance();\n-                TableProperty tableProperty = olapTable.getTableProperty();\n-                DynamicPartitionProperty dynamicPartitionProperty = tableProperty.getDynamicPartitionProperty();\n-\n-                for (int i = 0; i <= dynamicPartitionProperty.getEnd(); i++) {\n-                    String dynamicPartitionPrefix = dynamicPartitionProperty.getPrefix();\n-                    String prevBorder = DynamicPartitionUtil.getPartitionRange(dynamicPartitionProperty.getTimeUnit(),\n-                            i, (Calendar) calendar.clone(), partitionFormat);\n-                    String partitionName = dynamicPartitionPrefix + DynamicPartitionUtil.getFormattedPartitionName(prevBorder);\n-\n-                    // continue if partition already exists\n-                    String nextBorder = DynamicPartitionUtil.getPartitionRange(dynamicPartitionProperty.getTimeUnit(),\n-                            i + 1, (Calendar) calendar.clone(), partitionFormat);\n-                    PartitionValue lowerValue = new PartitionValue(prevBorder);\n-                    PartitionValue upperValue = new PartitionValue(nextBorder);\n-                    PartitionInfo partitionInfo = olapTable.getPartitionInfo();\n-                    RangePartitionInfo info = (RangePartitionInfo) (partitionInfo);\n-                    boolean isPartitionExists = false;\n-                    Range<PartitionKey> addPartitionKeyRange = null;\n-                    try {\n-                        PartitionKey lowerBound = PartitionKey.createPartitionKey(Collections.singletonList(lowerValue), Collections.singletonList(partitionColumn));\n-                        PartitionKey upperBound = PartitionKey.createPartitionKey(Collections.singletonList(upperValue), Collections.singletonList(partitionColumn));\n-                        addPartitionKeyRange = Range.closedOpen(lowerBound, upperBound);\n-                    } catch (AnalysisException e) {\n-                        // keys.size is always equal to column.size, cannot reach this exception\n-                        LOG.error(\"Keys size is not equl to column size.\");\n-                        continue;\n-                    }\n-                    for (Range<PartitionKey> partitionKeyRange : info.getIdToRange().values()) {\n-                        // only support single column partition now\n-                        try {\n-                            RangeUtils.checkRangeIntersect(partitionKeyRange, addPartitionKeyRange);\n-                        } catch (DdlException e) {\n-                            isPartitionExists = true;\n-                            if (addPartitionKeyRange.equals(partitionKeyRange)) {\n-                                clearFailedMsg(olapTable.getName());\n-                            } else {\n-                                recordFailedMsg(olapTable.getName(), e.getMessage());\n-                            }\n-                            break;\n-                        }\n-                    }\n-                    if (isPartitionExists) {\n-                        continue;\n-                    }\n-\n-                    // construct partition desc\n-                    PartitionKeyDesc partitionKeyDesc = new PartitionKeyDesc(Collections.singletonList(lowerValue), Collections.singletonList(upperValue));\n-                    HashMap<String, String> partitionProperties = new HashMap<>(1);\n-                    partitionProperties.put(\"replication_num\", String.valueOf(DynamicPartitionUtil.estimateReplicateNum(olapTable)));\n-                    SingleRangePartitionDesc rangePartitionDesc = new SingleRangePartitionDesc(true, partitionName,\n-                            partitionKeyDesc, partitionProperties);\n-\n-                    // construct distribution desc\n-                    HashDistributionInfo hashDistributionInfo = (HashDistributionInfo) olapTable.getDefaultDistributionInfo();\n-                    List<String> distColumnNames = new ArrayList<>();\n-                    for (Column distributionColumn : hashDistributionInfo.getDistributionColumns()) {\n-                        distColumnNames.add(distributionColumn.getName());\n-                    }\n-                    DistributionDesc distributionDesc = new HashDistributionDesc(dynamicPartitionProperty.getBuckets(), distColumnNames);\n-\n-                    // add partition according to partition desc and distribution desc\n-                    addPartitionClauses.add(new AddPartitionClause(rangePartitionDesc, distributionDesc, null, false));\n-                }\n+                addPartitionClauses = getAddPartitionClause(olapTable, partitionColumn, partitionFormat);", "originalCommit": "793aa9ea8f7a1cf33d555d616ffb3c8e880c88ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNzI3Mw==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r396207273", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-03-23T04:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4NTM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4NTgyOQ==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r396185829", "bodyText": "Do not use error level, error means fatal.\nAnd it better to add details in log, such as e.getMessage().\nSame suggest to the getDropPartitionClause()", "author": "morningman", "createdAt": "2020-03-23T02:28:25Z", "path": "fe/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -121,11 +123,118 @@ public void createOrUpdateRuntimeInfo(String tableName, String key, String value\n         defaultRuntimeInfo.put(LAST_UPDATE_TIME, DEFAULT_RUNTIME_VALUE);\n         defaultRuntimeInfo.put(LAST_SCHEDULER_TIME, DEFAULT_RUNTIME_VALUE);\n         defaultRuntimeInfo.put(DYNAMIC_PARTITION_STATE, State.NORMAL.toString());\n-        defaultRuntimeInfo.put(MSG, DEFAULT_RUNTIME_VALUE);\n+        defaultRuntimeInfo.put(CREATE_PARTITION_MSG, DEFAULT_RUNTIME_VALUE);\n+        defaultRuntimeInfo.put(DROP_PARTITION_MSG, DEFAULT_RUNTIME_VALUE);\n         return defaultRuntimeInfo;\n     }\n \n-    private void dynamicAddPartition() {\n+    private ArrayList<AddPartitionClause> getAddPartitionClause(OlapTable olapTable, Column partitionColumn, String partitionFormat) {\n+        ArrayList<AddPartitionClause> addPartitionClauses = new ArrayList<>();\n+        Calendar calendar = Calendar.getInstance();\n+        DynamicPartitionProperty dynamicPartitionProperty = olapTable.getTableProperty().getDynamicPartitionProperty();\n+        for (int i = 0; i <= dynamicPartitionProperty.getEnd(); i++) {\n+            String prevBorder = DynamicPartitionUtil.getPartitionRange(dynamicPartitionProperty.getTimeUnit(),\n+                    i, (Calendar) calendar.clone(), partitionFormat);\n+            // continue if partition already exists\n+            String nextBorder = DynamicPartitionUtil.getPartitionRange(dynamicPartitionProperty.getTimeUnit(),\n+                    i + 1, (Calendar) calendar.clone(), partitionFormat);\n+            PartitionValue lowerValue = new PartitionValue(prevBorder);\n+            PartitionValue upperValue = new PartitionValue(nextBorder);\n+            PartitionInfo partitionInfo = olapTable.getPartitionInfo();\n+            RangePartitionInfo info = (RangePartitionInfo) (partitionInfo);\n+            boolean isPartitionExists = false;\n+            Range<PartitionKey> addPartitionKeyRange;\n+            try {\n+                PartitionKey lowerBound = PartitionKey.createPartitionKey(Collections.singletonList(lowerValue), Collections.singletonList(partitionColumn));\n+                PartitionKey upperBound = PartitionKey.createPartitionKey(Collections.singletonList(upperValue), Collections.singletonList(partitionColumn));\n+                addPartitionKeyRange = Range.closedOpen(lowerBound, upperBound);\n+            } catch (AnalysisException e) {\n+                // keys.size is always equal to column.size, cannot reach this exception\n+                LOG.error(\"Keys size is not equal to column size.\");", "originalCommit": "793aa9ea8f7a1cf33d555d616ffb3c8e880c88ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNzM0OA==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r396207348", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-03-23T04:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4NTgyOQ=="}], "type": "inlineReview"}, {"oid": "f2ee87ad2a9ea5f73d21636b408a1b5c36353cb3", "url": "https://github.com/apache/incubator-doris/commit/f2ee87ad2a9ea5f73d21636b408a1b5c36353cb3", "message": "fix", "committedDate": "2020-03-23T04:25:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MDAwNA==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r396480004", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG.warn(\"Keys size is not equal to column size. Error=\" + e.getMessage());\n          \n          \n            \n                            LOG.warn(\"Keys size is not equal to column size. Error={}\", e.getMessage());", "author": "morningman", "createdAt": "2020-03-23T14:12:29Z", "path": "fe/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -150,7 +150,7 @@ public void createOrUpdateRuntimeInfo(String tableName, String key, String value\n                 addPartitionKeyRange = Range.closedOpen(lowerBound, upperBound);\n             } catch (AnalysisException e) {\n                 // keys.size is always equal to column.size, cannot reach this exception\n-                LOG.error(\"Keys size is not equal to column size.\");\n+                LOG.warn(\"Keys size is not equal to column size. Error=\" + e.getMessage());", "originalCommit": "f2ee87ad2a9ea5f73d21636b408a1b5c36353cb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MDkxMQ==", "url": "https://github.com/apache/incubator-doris/pull/3081#discussion_r396480911", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG.warn(\"Keys size is not equal to column size. Error=\" + e.getMessage());\n          \n          \n            \n                        LOG.warn(\"Keys size is not equal to column size. Error={}\", e.getMessage());", "author": "morningman", "createdAt": "2020-03-23T14:13:39Z", "path": "fe/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -211,7 +211,7 @@ public void createOrUpdateRuntimeInfo(String tableName, String key, String value\n             reservePartitionKeyRange = Range.closedOpen(lowerBound, upperBound);\n         } catch (AnalysisException e) {\n             // keys.size is always equal to column.size, cannot reach this exception\n-            LOG.error(\"Keys size is not equal to column size.\");\n+            LOG.warn(\"Keys size is not equal to column size. Error=\" + e.getMessage());", "originalCommit": "f2ee87ad2a9ea5f73d21636b408a1b5c36353cb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df557ced76add264eb637204db5b37810104bff8", "url": "https://github.com/apache/incubator-doris/commit/df557ced76add264eb637204db5b37810104bff8", "message": "fix error msg", "committedDate": "2020-03-23T14:21:49Z", "type": "commit"}, {"oid": "ba8ffcdada1f1e4ea8bad071ec740a39cc552db7", "url": "https://github.com/apache/incubator-doris/commit/ba8ffcdada1f1e4ea8bad071ec740a39cc552db7", "message": "Merge branch 'master' into add_auto_delete_partition", "committedDate": "2020-03-23T14:23:31Z", "type": "commit"}, {"oid": "80e0bbea2803b0493778f66782ba719914331bb7", "url": "https://github.com/apache/incubator-doris/commit/80e0bbea2803b0493778f66782ba719914331bb7", "message": "Merge branch 'add_auto_delete_partition' of github.com:WingsGo/incubator-doris into add_auto_delete_partition", "committedDate": "2020-03-23T14:32:33Z", "type": "commit"}, {"oid": "ba93d294bc316d8e5432414e3e79dd3e986a46e1", "url": "https://github.com/apache/incubator-doris/commit/ba93d294bc316d8e5432414e3e79dd3e986a46e1", "message": "fix", "committedDate": "2020-03-23T14:35:36Z", "type": "commit"}, {"oid": "8708c758d6a26c645b6e7f1b5cecf87d8f30df3b", "url": "https://github.com/apache/incubator-doris/commit/8708c758d6a26c645b6e7f1b5cecf87d8f30df3b", "message": "fix", "committedDate": "2020-03-24T00:04:43Z", "type": "commit"}, {"oid": "36bf515deca6ac0220590485445fe5de50f96202", "url": "https://github.com/apache/incubator-doris/commit/36bf515deca6ac0220590485445fe5de50f96202", "message": "Merge branch 'add_auto_delete_partition' of github.com:WingsGo/incubator-doris into add_auto_delete_partition", "committedDate": "2020-03-24T00:04:58Z", "type": "commit"}]}