{"pr_number": 3981, "pr_title": "[Feature] Batch update partition's property in one command", "pr_createdAt": "2020-06-29T21:42:42Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3981", "timeline": [{"oid": "d31e79d4b29dd11f5df80af72d0a266fcc46e9b6", "url": "https://github.com/apache/incubator-doris/commit/d31e79d4b29dd11f5df80af72d0a266fcc46e9b6", "message": "save code", "committedDate": "2020-06-29T14:00:26Z", "type": "commit"}, {"oid": "137662fdc60a2f4caa806b096be4ff23fc4b44e8", "url": "https://github.com/apache/incubator-doris/commit/137662fdc60a2f4caa806b096be4ff23fc4b44e8", "message": "fix", "committedDate": "2020-06-29T16:21:36Z", "type": "commit"}, {"oid": "e885cd21e9c01673fe2d99920299f54efe574e68", "url": "https://github.com/apache/incubator-doris/commit/e885cd21e9c01673fe2d99920299f54efe574e68", "message": "add ut and doc", "committedDate": "2020-06-29T21:17:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM5MTAzNQ==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r448391035", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static public ModifyPartitionClause createStarClause(Map<String, String> properties) {\n          \n          \n            \n                public static ModifyPartitionClause createStarClause(Map<String, String> properties) {", "author": "morningman", "createdAt": "2020-07-01T14:11:01Z", "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -48,10 +56,27 @@ public ModifyPartitionClause(String partitionName, Map<String, String> propertie\n         this.needTableStable = false;\n     }\n \n+    // c'tor for 'Modify Partition(*)' clause\n+    private ModifyPartitionClause(Map<String, String> properties) {\n+        super(AlterOpType.MODIFY_PARTITION);\n+        this.partitionNames = Lists.newArrayList();\n+        this.properties = properties;\n+        this.needExpand = true;\n+        this.needTableStable = false;\n+    }\n+\n+    static public ModifyPartitionClause createStarClause(Map<String, String> properties) {", "originalCommit": "e885cd21e9c01673fe2d99920299f54efe574e68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM5MTc4MQ==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r448391781", "bodyText": "better to write meta in one edit log", "author": "morningman", "createdAt": "2020-07-01T14:12:07Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -3334,6 +3334,45 @@ public void replayRecoverPartition(RecoverInfo info) {\n         }\n     }\n \n+    /**\n+     * Batch update partitions' properties\n+     * caller should hold the db lock\n+     */\n+    public void modifyPartitionsProperty(Database db,\n+                                         OlapTable olapTable,\n+                                         List<String> partitionNames,\n+                                         Map<String, String> properties)\n+            throws DdlException {\n+        Preconditions.checkArgument(db.isWriteLockHeldByCurrentThread());\n+        if (olapTable.getState() != OlapTableState.NORMAL) {\n+            throw new DdlException(\"Table[\" + olapTable.getName() + \"]'s state is not NORMAL\");\n+        }\n+\n+        for (String partitionName : partitionNames) {\n+            Partition partition = olapTable.getPartition(partitionName);\n+            if (partition == null) {\n+                throw new DdlException(\n+                        \"Partition[\" + partitionName + \"] does not exist in table[\" + olapTable.getName() + \"]\");\n+            }\n+        }\n+\n+        // If error occurs tell user which partition is wrong.\n+        for (String partitionName : partitionNames) {\n+            try {\n+                Map<String, String> partitionProperties = Maps.newHashMap(properties);\n+                modifyPartitionProperty(db, olapTable, partitionName, partitionProperties);", "originalCommit": "e885cd21e9c01673fe2d99920299f54efe574e68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ba3e52296bf755df1870d7afb7edc8b15acda5bc", "url": "https://github.com/apache/incubator-doris/commit/ba3e52296bf755df1870d7afb7edc8b15acda5bc", "message": "add editlog", "committedDate": "2020-07-02T06:40:32Z", "type": "commit"}, {"oid": "5ee92f9762ce8e89e86f258bfd4ac15d50253afa", "url": "https://github.com/apache/incubator-doris/commit/5ee92f9762ce8e89e86f258bfd4ac15d50253afa", "message": "license", "committedDate": "2020-07-02T07:16:00Z", "type": "commit"}, {"oid": "dd49f51567c75c3d6e32d15781af76710bd06c08", "url": "https://github.com/apache/incubator-doris/commit/dd49f51567c75c3d6e32d15781af76710bd06c08", "message": "remove unuse", "committedDate": "2020-07-02T07:19:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDcxOQ==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r449850719", "bodyText": "Wrong import.", "author": "morningman", "createdAt": "2020-07-05T08:33:53Z", "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -17,28 +17,36 @@\n \n package org.apache.doris.analysis;\n \n+import com.clearspring.analytics.util.Lists;", "originalCommit": "dd49f51567c75c3d6e32d15781af76710bd06c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MTQ0Ng==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r449891446", "bodyText": "fix", "author": "xy720", "createdAt": "2020-07-05T15:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDg0MA==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r449850840", "bodyText": "Should print \"*\" if needExpand is true", "author": "morningman", "createdAt": "2020-07-05T08:35:12Z", "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -64,11 +89,17 @@ public void analyze(Analyzer analyzer) throws AnalysisException {\n         return this.properties;\n     }\n \n+    public boolean isNeedExpand() {\n+        return this.needExpand;\n+    }\n+\n     @Override\n     public String toSql() {\n         StringBuilder sb = new StringBuilder();\n         sb.append(\"MODIFY PARTITION \");\n-        sb.append(partitionName);\n+        sb.append(\"(\");\n+        sb.append(Joiner.on(\", \").join(partitionNames));", "originalCommit": "dd49f51567c75c3d6e32d15781af76710bd06c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MTQ3Mw==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r449891473", "bodyText": "fixed", "author": "xy720", "createdAt": "2020-07-05T15:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDg0MA=="}], "type": "inlineReview"}, {"oid": "e23e88903f73aa65086f233d774eb03035cf2fd3", "url": "https://github.com/apache/incubator-doris/commit/e23e88903f73aa65086f233d774eb03035cf2fd3", "message": "fix toSql", "committedDate": "2020-07-05T15:43:37Z", "type": "commit"}, {"oid": "988f576346bd6e50015e2bf60419f39764647c04", "url": "https://github.com/apache/incubator-doris/commit/988f576346bd6e50015e2bf60419f39764647c04", "message": "save code", "committedDate": "2020-07-06T07:52:19Z", "type": "commit"}, {"oid": "64a83cdcf85e2a7596dd1359bb61bbee40249ffd", "url": "https://github.com/apache/incubator-doris/commit/64a83cdcf85e2a7596dd1359bb61bbee40249ffd", "message": "fix replay", "committedDate": "2020-07-06T10:43:32Z", "type": "commit"}, {"oid": "e468e22de02241d32d35858e1a3e27eefa4b1d74", "url": "https://github.com/apache/incubator-doris/commit/e468e22de02241d32d35858e1a3e27eefa4b1d74", "message": "fix replay", "committedDate": "2020-07-06T10:48:08Z", "type": "commit"}, {"oid": "0b4c3c210cd9bff03c43928335fef85fcaac51c7", "url": "https://github.com/apache/incubator-doris/commit/0b4c3c210cd9bff03c43928335fef85fcaac51c7", "message": "adjust", "committedDate": "2020-07-07T01:41:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NDkyOA==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r450944928", "bodyText": "Import order", "author": "morningman", "createdAt": "2020-07-07T15:17:19Z", "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -17,28 +17,41 @@\n \n package org.apache.doris.analysis;\n \n+import com.google.common.base.Joiner;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;", "originalCommit": "0b4c3c210cd9bff03c43928335fef85fcaac51c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NTI1Mg==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r450945252", "bodyText": "private, and no need to be static. And method name can be changed to checkProperties.", "author": "morningman", "createdAt": "2020-07-07T15:17:45Z", "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -48,27 +61,80 @@ public ModifyPartitionClause(String partitionName, Map<String, String> propertie\n         this.needTableStable = false;\n     }\n \n+    // c'tor for 'Modify Partition(*)' clause\n+    private ModifyPartitionClause(Map<String, String> properties) {\n+        super(AlterOpType.MODIFY_PARTITION);\n+        this.partitionNames = Lists.newArrayList();\n+        this.properties = properties;\n+        this.needExpand = true;\n+        this.needTableStable = false;\n+    }\n+\n+    public static ModifyPartitionClause createStarClause(Map<String, String> properties) {\n+        return new ModifyPartitionClause(properties);\n+    }\n+\n     @Override\n     public void analyze(Analyzer analyzer) throws AnalysisException {\n-        if (Strings.isNullOrEmpty(partitionName)) {\n-            throw new AnalysisException(\"Partition name is not set\");\n+        if (partitionNames == null || (!needExpand && partitionNames.isEmpty())) {\n+            throw new AnalysisException(\"Partition names is not set or empty\");\n+        }\n+\n+        if (partitionNames.stream().anyMatch(entity -> Strings.isNullOrEmpty(entity))) {\n+            throw new AnalysisException(\"there are empty partition name\");\n         }\n \n         if (properties == null || properties.isEmpty()) {\n             throw new AnalysisException(\"Properties is not set\");\n         }\n+\n+        // check properties here\n+        preCheck(Maps.newHashMap(properties));\n+    }\n+\n+    // pre check the following properties' legality before modifying partition.\n+    // 1. replication_num\n+    // 2. storage_medium && storage_cooldown_time\n+    // 3. in_memory\n+    // 4. tablet type\n+    public static void preCheck(Map<String, String> properties) throws AnalysisException {", "originalCommit": "0b4c3c210cd9bff03c43928335fef85fcaac51c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI3MzM2Mg==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r451273362", "bodyText": "done", "author": "xy720", "createdAt": "2020-07-08T04:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NTI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NjY1NA==", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r450946654", "bodyText": "Add UT to test the read/write method of this class", "author": "morningman", "createdAt": "2020-07-07T15:19:49Z", "path": "fe/src/main/java/org/apache/doris/persist/BatchModifyPartitionsInfo.java", "diffHunk": "@@ -0,0 +1,55 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.persist;\n+\n+import com.google.gson.annotations.SerializedName;\n+import org.apache.doris.common.io.Text;\n+import org.apache.doris.common.io.Writable;\n+import org.apache.doris.persist.gson.GsonUtils;\n+\n+import java.io.DataInput;\n+import java.io.DataOutput;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * used for batch modify multi partitions in one atomic operation\n+ */\n+\n+public class BatchModifyPartitionsInfo implements Writable {", "originalCommit": "0b4c3c210cd9bff03c43928335fef85fcaac51c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09daa29956857aed386cea08f1f7149547167ded", "url": "https://github.com/apache/incubator-doris/commit/09daa29956857aed386cea08f1f7149547167ded", "message": "fix import order and add ut", "committedDate": "2020-07-08T03:15:43Z", "type": "commit"}]}