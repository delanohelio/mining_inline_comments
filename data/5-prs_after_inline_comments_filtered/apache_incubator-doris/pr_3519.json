{"pr_number": 3519, "pr_title": "Check backend disk has available capactiy by storage medium before create table", "pr_createdAt": "2020-05-08T03:11:12Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3519", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxNzUwMQ==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422617501", "bodyText": "We can just remove the if (table.getType() == TableType.OLAP). The argument is already OlapTable", "author": "morningman", "createdAt": "2020-05-10T09:32:24Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -4894,8 +4894,7 @@ public void renameTable(Database db, OlapTable table, TableRenameClause tableRen\n \n         // check if rollup has same name\n         if (table.getType() == TableType.OLAP) {", "originalCommit": "9cffe922792506d4732909606fa4994c81c0cf2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxNzUxOQ==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422617519", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        for (String idxName: table.getIndexNameToId().keySet()) {\n          \n          \n            \n                        for (String idxName : table.getIndexNameToId().keySet()) {", "author": "morningman", "createdAt": "2020-05-10T09:32:30Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -4894,8 +4894,7 @@ public void renameTable(Database db, OlapTable table, TableRenameClause tableRen\n \n         // check if rollup has same name\n         if (table.getType() == TableType.OLAP) {\n-            OlapTable olapTable = (OlapTable) table;\n-            for (String idxName: olapTable.getIndexNameToId().keySet()) {\n+            for (String idxName: table.getIndexNameToId().keySet()) {", "originalCommit": "9cffe922792506d4732909606fa4994c81c0cf2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxODUxNQ==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422618515", "bodyText": "Add comment to explain the return value of this method.\nthe name checkDiskExceedLimitByStorageMedium is a little bit confused.", "author": "morningman", "createdAt": "2020-05-10T09:40:37Z", "path": "fe/src/main/java/org/apache/doris/system/Backend.java", "diffHunk": "@@ -346,6 +347,23 @@ public double getMaxDiskUsedPct() {\n         return maxPct;\n     }\n \n+    public boolean checkDiskExceedLimitByStorageMedium(TStorageMedium storageMedium) {", "originalCommit": "9cffe922792506d4732909606fa4994c81c0cf2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyNzI2Ng==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422627266", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-05-10T10:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxODUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxODY1MA==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422618650", "bodyText": "Is this logic correct? If all disks are offline or is not with specified storage medium, then this method will return false?", "author": "morningman", "createdAt": "2020-05-10T09:41:46Z", "path": "fe/src/main/java/org/apache/doris/system/Backend.java", "diffHunk": "@@ -346,6 +347,23 @@ public double getMaxDiskUsedPct() {\n         return maxPct;\n     }\n \n+    public boolean checkDiskExceedLimitByStorageMedium(TStorageMedium storageMedium) {\n+        // no available disk with storage medium\n+        if (getDiskNumByStorageMedium(storageMedium) <= 0) {\n+            return true;\n+        }\n+        ImmutableMap<String, DiskInfo> disks = disksRef.get();\n+        boolean exceedLimit = false;\n+        for (DiskInfo diskInfo : disks.values()) {", "originalCommit": "9cffe922792506d4732909606fa4994c81c0cf2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyNzIzNQ==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422627235", "bodyText": "yes, you are right, I fixed it, and should we change the logic in be, just remove the judgement _available_storage_medium_type_count == 1?\nfor (auto& it : _store_map) {\n            if (it.second->is_used()) {\n                if (_available_storage_medium_type_count == 1\n                    || it.second->storage_medium() == storage_medium) {\n                    stores.push_back(it.second);\n                }\n            }\n        }", "author": "WingsGo", "createdAt": "2020-05-10T10:55:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxODY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxOTEwOA==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422619108", "bodyText": "Actually, the method calculateDecommissionBackends() is deprecated.\nSo could you please add @Derepcated to this method?", "author": "morningman", "createdAt": "2020-05-10T09:45:30Z", "path": "fe/src/main/java/org/apache/doris/system/SystemInfoService.java", "diffHunk": "@@ -443,7 +390,7 @@ public void releaseBackends(String clusterName, boolean isReplay) {\n         }\n \n         List<List<Backend>> hostList = Lists.newArrayList(hostBackendsMapInCluster.values());\n-        Collections.sort(hostList, hostBackendsListComparator);\n+        hostList.sort(hostBackendsListComparator);", "originalCommit": "9cffe922792506d4732909606fa4994c81c0cf2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyNjkxMA==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422626910", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-05-10T10:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxOTEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxOTU1MA==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422619550", "bodyText": "This is not user friendly. For example, if all backends not meet the checkDiskExceedLimitByStorageMedium(), the user will only get the msg: \"Not enough backends\", but he will not know why there is no enough backend.\nSo could you please find a way to return the detail msg to user about the reason of failure?", "author": "morningman", "createdAt": "2020-05-10T09:49:16Z", "path": "fe/src/main/java/org/apache/doris/system/SystemInfoService.java", "diffHunk": "@@ -729,8 +639,18 @@ public void releaseBackends(String clusterName, boolean isReplay) {\n     // return null if not enough backend\n     // use synchronized to run serially\n     public synchronized List<Long> seqChooseBackendIds(int backendNum, boolean needAlive, boolean isCreate,\n-            String clusterName) {\n-        long lastBackendId = -1L;\n+                                                       String clusterName) {\n+        return seqChooseBackendIds(backendNum, needAlive, isCreate, clusterName, getClusterBackends(clusterName));\n+    }\n+    public synchronized List<Long> seqChooseBackendIdsByStorageMedium(int backendNum, boolean needAlive, boolean isCreate,\n+                                                                      String clusterName, TStorageMedium storageMedium) {\n+        final List<Backend> backends = getClusterBackends(clusterName).stream().filter(v -> !v.checkDiskExceedLimitByStorageMedium(storageMedium)).collect(Collectors.toList());", "originalCommit": "9cffe922792506d4732909606fa4994c81c0cf2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyNjc1Nw==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422626757", "bodyText": "actually, I change the detail msg to throw new DdlException(\"Failed to find enough host in all backends with storage medium is \" + storageMedium + \". need: \" + replicationNum", "author": "WingsGo", "createdAt": "2020-05-10T10:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxOTU1MA=="}], "type": "inlineReview"}, {"oid": "000ea8aca0ae8bc9e901028d00194745f597adfc", "url": "https://github.com/apache/incubator-doris/commit/000ea8aca0ae8bc9e901028d00194745f597adfc", "message": "remove code format", "committedDate": "2020-06-19T07:24:57Z", "type": "commit"}, {"oid": "000ea8aca0ae8bc9e901028d00194745f597adfc", "url": "https://github.com/apache/incubator-doris/commit/000ea8aca0ae8bc9e901028d00194745f597adfc", "message": "remove code format", "committedDate": "2020-06-19T07:24:57Z", "type": "forcePushed"}, {"oid": "215844f5eaf588a1eebf6e6cce397401aee04452", "url": "https://github.com/apache/incubator-doris/commit/215844f5eaf588a1eebf6e6cce397401aee04452", "message": "add odc", "committedDate": "2020-06-19T07:37:38Z", "type": "commit"}, {"oid": "f53eaa65b90b8a549301646a980ae18eadc0e122", "url": "https://github.com/apache/incubator-doris/commit/f53eaa65b90b8a549301646a980ae18eadc0e122", "message": "remove in be", "committedDate": "2020-06-19T08:41:46Z", "type": "commit"}, {"oid": "50d82125259c406ac5c6d069e79f8ab5dd429868", "url": "https://github.com/apache/incubator-doris/commit/50d82125259c406ac5c6d069e79f8ab5dd429868", "message": "Add config", "committedDate": "2020-06-21T13:40:21Z", "type": "commit"}, {"oid": "1fa9b36c94dd17f6f9a531bf2b5832f8cdbddd6a", "url": "https://github.com/apache/incubator-doris/commit/1fa9b36c94dd17f6f9a531bf2b5832f8cdbddd6a", "message": "add doc", "committedDate": "2020-06-21T14:14:15Z", "type": "commit"}, {"oid": "cd9340644920f67691bc53ea7f9f42736cf772ce", "url": "https://github.com/apache/incubator-doris/commit/cd9340644920f67691bc53ea7f9f42736cf772ce", "message": "fix", "committedDate": "2020-06-21T14:19:55Z", "type": "commit"}, {"oid": "8eb74df697b33539c1b6ad9ced231f9b102debba", "url": "https://github.com/apache/incubator-doris/commit/8eb74df697b33539c1b6ad9ced231f9b102debba", "message": "add docs", "committedDate": "2020-06-21T14:31:40Z", "type": "commit"}, {"oid": "cd2a8b42a14bc8facbf6f56dd4b20a6562db6a0d", "url": "https://github.com/apache/incubator-doris/commit/cd2a8b42a14bc8facbf6f56dd4b20a6562db6a0d", "message": "add normal check", "committedDate": "2020-06-22T02:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU2OTA3Mw==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r443569073", "bodyText": "missing coment?", "author": "morningman", "createdAt": "2020-06-22T13:46:00Z", "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1082,5 +1082,11 @@\n      */\n     @ConfField(mutable = true, masterOnly = true)\n     public static boolean drop_backend_after_decommission = true;\n+\n+    /**\n+     *\n+     */", "originalCommit": "cd2a8b42a14bc8facbf6f56dd4b20a6562db6a0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwMzI4MA==", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r443603280", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-06-22T14:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU2OTA3Mw=="}], "type": "inlineReview"}, {"oid": "57234c6bc1db32bfb498e69d3d9ff0b601070c9f", "url": "https://github.com/apache/incubator-doris/commit/57234c6bc1db32bfb498e69d3d9ff0b601070c9f", "message": "add comment", "committedDate": "2020-06-22T14:23:22Z", "type": "commit"}, {"oid": "32060e69acfb254a81fbb97e6e49b0a68294e907", "url": "https://github.com/apache/incubator-doris/commit/32060e69acfb254a81fbb97e6e49b0a68294e907", "message": "fix conflict", "committedDate": "2020-06-22T15:26:06Z", "type": "commit"}, {"oid": "05b67c18aa2f7e82da06740ceb58677abe42c6aa", "url": "https://github.com/apache/incubator-doris/commit/05b67c18aa2f7e82da06740ceb58677abe42c6aa", "message": "Merge branch 'master' into fix_create_table_by_storage_medium", "committedDate": "2020-06-22T15:30:34Z", "type": "commit"}, {"oid": "34268f80be26748e5c893a239537af66d4bcaabe", "url": "https://github.com/apache/incubator-doris/commit/34268f80be26748e5c893a239537af66d4bcaabe", "message": "fix UT", "committedDate": "2020-06-24T06:32:26Z", "type": "commit"}, {"oid": "43b5b52f141e0a86ae2f9496cb6c70519e021428", "url": "https://github.com/apache/incubator-doris/commit/43b5b52f141e0a86ae2f9496cb6c70519e021428", "message": "fix ut", "committedDate": "2020-06-24T08:28:29Z", "type": "commit"}, {"oid": "e8ad6434774aacca23268561f4df0836d8749c84", "url": "https://github.com/apache/incubator-doris/commit/e8ad6434774aacca23268561f4df0836d8749c84", "message": "Merge branch 'master' into fix_create_table_by_storage_medium", "committedDate": "2020-06-24T14:15:12Z", "type": "commit"}]}