{"pr_number": 2922, "pr_title": "AlterJobV2 Pending Status Replay Fix Bug", "pr_createdAt": "2020-02-17T05:31:36Z", "pr_url": "https://github.com/apache/incubator-doris/pull/2922", "timeline": [{"oid": "f294f2fb1341bfe7e3a54db3191cd09609cdc6fd", "url": "https://github.com/apache/incubator-doris/commit/f294f2fb1341bfe7e3a54db3191cd09609cdc6fd", "message": "AlterJobV2 Pending Status Replay Fix Bug #2920", "committedDate": "2020-02-17T05:22:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5NzkzNA==", "url": "https://github.com/apache/incubator-doris/pull/2922#discussion_r379997934", "bodyText": "code style. Add {} to if else.", "author": "kangkaisen", "createdAt": "2020-02-17T06:03:22Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -1702,8 +1702,18 @@ public long loadAlterJob(DataInputStream dis, long checksum, JobType type) throw\n             newChecksum ^= size;\n             for (int i = 0; i < size; i++) {\n                 AlterJobV2 alterJobV2 = AlterJobV2.read(dis);\n-                if (type == JobType.ROLLUP) {\n-                    this.getRollupHandler().addAlterJobV2(alterJobV2);\n+                if (type == JobType.ROLLUP || type == JobType.SCHEMA_CHANGE) {\n+                    if (type == JobType.ROLLUP)", "originalCommit": "f294f2fb1341bfe7e3a54db3191cd09609cdc6fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAxNjY0NQ==", "url": "https://github.com/apache/incubator-doris/pull/2922#discussion_r380016645", "bodyText": "\ud83d\udc4c", "author": "wangbo", "createdAt": "2020-02-17T07:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5NzkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5ODAyOA==", "url": "https://github.com/apache/incubator-doris/pull/2922#discussion_r379998028", "bodyText": "info is enough.", "author": "kangkaisen", "createdAt": "2020-02-17T06:03:49Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -1702,8 +1702,18 @@ public long loadAlterJob(DataInputStream dis, long checksum, JobType type) throw\n             newChecksum ^= size;\n             for (int i = 0; i < size; i++) {\n                 AlterJobV2 alterJobV2 = AlterJobV2.read(dis);\n-                if (type == JobType.ROLLUP) {\n-                    this.getRollupHandler().addAlterJobV2(alterJobV2);\n+                if (type == JobType.ROLLUP || type == JobType.SCHEMA_CHANGE) {\n+                    if (type == JobType.ROLLUP)\n+                        this.getRollupHandler().addAlterJobV2(alterJobV2);\n+                    else\n+                        alterJobsV2.put(alterJobV2.getJobId(), alterJobV2);\n+                    // ATTN : we just want to add tablet into TabletInvertedIndex when only PendingJob is checkpointed\n+                    // to prevent TabletInvertedIndex data loss,\n+                    // So just use AlterJob.replay() instead of AlterHandler.replay().\n+                    if (alterJobV2.getJobState() == AlterJobV2.JobState.PENDING) {\n+                        alterJobV2.replay(alterJobV2);\n+                        LOG.warn(\"replay pending alter job when load alter job {} \", alterJobV2.getJobId());", "originalCommit": "f294f2fb1341bfe7e3a54db3191cd09609cdc6fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAxNjcxNg==", "url": "https://github.com/apache/incubator-doris/pull/2922#discussion_r380016716", "bodyText": "\ud83d\udc4c", "author": "wangbo", "createdAt": "2020-02-17T07:22:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5ODAyOA=="}], "type": "inlineReview"}, {"oid": "b7318356bc656af29847c5100c1c650f3d59c3d8", "url": "https://github.com/apache/incubator-doris/commit/b7318356bc656af29847c5100c1c650f3d59c3d8", "message": "1 fix code style;2 using LOG.info", "committedDate": "2020-02-17T07:28:03Z", "type": "commit"}]}