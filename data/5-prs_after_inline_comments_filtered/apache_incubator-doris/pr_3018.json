{"pr_number": 3018, "pr_title": "Fix the pre aggregation is difference between old and new selector", "pr_createdAt": "2020-02-28T08:53:58Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3018", "timeline": [{"oid": "cc3c06b23927ed41947df5e9a737d607d51549b6", "url": "https://github.com/apache/incubator-doris/commit/cc3c06b23927ed41947df5e9a737d607d51549b6", "message": "Fix the pre aggregation is difference between old and new selector\n\nThe issue is #3016.\nIf there is no aggregated column in aggregate index, the index will be deduplicate table.\nFor example:\n    aggregate table (k1, k2, v1 sum)\n    mv index (k1, k2)\nThis kind of index is SPJG which same as select k1, k2 from aggregate_table group by k1, k2.\nIt also need to check the grouping column using following steps.\n\nIf there is no aggregated column in duplicate index, the index will be SPJ which passes the grouping verification directly.\n\nAlso after the supplement of index, the new candidate index should be checked the output columns also.", "committedDate": "2020-02-28T08:51:57Z", "type": "commit"}, {"oid": "838a236a09e21d3e6ab1b150321e04ca6a567e3f", "url": "https://github.com/apache/incubator-doris/commit/838a236a09e21d3e6ab1b150321e04ca6a567e3f", "message": "Fix the check failed on materialized selector\n\nIf the slot ref comes from the inline view, there will be no column name of slot ref.", "committedDate": "2020-02-28T09:46:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzMTEzNg==", "url": "https://github.com/apache/incubator-doris/pull/3018#discussion_r386031136", "bodyText": "Please add a UT to cover this case.", "author": "kangkaisen", "createdAt": "2020-02-29T14:18:12Z", "path": "fe/src/main/java/org/apache/doris/planner/MaterializedViewSelector.java", "diffHunk": "@@ -279,16 +280,30 @@ private void checkCompensatingPredicates(Set<String> columnsInPredicates,\n      * @param candidateIndexIdToSchema\n      */\n \n-    private void checkGrouping(Set<String> columnsInGrouping, Map<Long, List<Column>> candidateIndexIdToSchema) {\n+    private void checkGrouping(Set<String> columnsInGrouping, Map<Long, List<Column>> candidateIndexIdToSchema,\n+            KeysType keysType) {\n         Iterator<Map.Entry<Long, List<Column>>> iterator = candidateIndexIdToSchema.entrySet().iterator();\n         while (iterator.hasNext()) {\n             Map.Entry<Long, List<Column>> entry = iterator.next();\n             Set<String> indexNonAggregatedColumnNames = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n             List<Column> candidateIndexSchema = entry.getValue();\n             candidateIndexSchema.stream().filter(column -> !column.isAggregated())\n                     .forEach(column -> indexNonAggregatedColumnNames.add(column.getName()));\n-            // When the candidate index is SPJ type, it passes the verification directly\n-            if (indexNonAggregatedColumnNames.size() == candidateIndexSchema.size()) {\n+            /*\n+            If there is no aggregated column in duplicate table, the index will be SPJ.\n+            For example:\n+                duplicate table (k1, k2, v1)\n+                mv index (k1, v1)\n+            When the candidate index is SPJ type, it passes the verification directly\n+\n+            If there is no aggregated column in aggregate index, the index will be deduplicate table.\n+            For example:\n+                aggregate table (k1, k2, v1 sum)\n+                mv index (k1, k2)\n+            This kind of index is SPJG which same as select k1, k2 from aggregate_table group by k1, k2.\n+            It also need to check the grouping column using following steps.\n+             */", "originalCommit": "3b922416edf0a4c74ca8b2c4f45bbd134b3dee16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NTUzNw==", "url": "https://github.com/apache/incubator-doris/pull/3018#discussion_r386195537", "bodyText": "OK", "author": "EmmyMiao87", "createdAt": "2020-03-02T04:45:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzMTEzNg=="}], "type": "inlineReview"}, {"oid": "ef67f2962af9f14ceb32da1cf930d49f7f3f5cad", "url": "https://github.com/apache/incubator-doris/commit/ef67f2962af9f14ceb32da1cf930d49f7f3f5cad", "message": "Same as above", "committedDate": "2020-03-02T04:43:45Z", "type": "commit"}, {"oid": "ef67f2962af9f14ceb32da1cf930d49f7f3f5cad", "url": "https://github.com/apache/incubator-doris/commit/ef67f2962af9f14ceb32da1cf930d49f7f3f5cad", "message": "Same as above", "committedDate": "2020-03-02T04:43:45Z", "type": "forcePushed"}, {"oid": "9700c9607eb328f9076bc75dc60815f4a905faea", "url": "https://github.com/apache/incubator-doris/commit/9700c9607eb328f9076bc75dc60815f4a905faea", "message": "Fix the selector error when table is empty", "committedDate": "2020-03-02T09:05:42Z", "type": "commit"}, {"oid": "53a52fd5649bb8f6b35caf7c1c1fc148421c0923", "url": "https://github.com/apache/incubator-doris/commit/53a52fd5649bb8f6b35caf7c1c1fc148421c0923", "message": "Add comments", "committedDate": "2020-03-02T09:08:26Z", "type": "commit"}, {"oid": "dcbe441baf7a975dfb92e57d2b6e2a45c5abfc98", "url": "https://github.com/apache/incubator-doris/commit/dcbe441baf7a975dfb92e57d2b6e2a45c5abfc98", "message": "Remove unused import", "committedDate": "2020-03-02T10:02:47Z", "type": "commit"}, {"oid": "04e4111ec91afc5e8bd23ed4b923cf3267097556", "url": "https://github.com/apache/incubator-doris/commit/04e4111ec91afc5e8bd23ed4b923cf3267097556", "message": "Add comments", "committedDate": "2020-03-02T11:07:45Z", "type": "commit"}]}