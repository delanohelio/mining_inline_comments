{"pr_number": 2737, "pr_title": "Support replication_num setting for table level", "pr_createdAt": "2020-01-11T10:16:57Z", "pr_url": "https://github.com/apache/incubator-doris/pull/2737", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUxOTc5MQ==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365519791", "bodyText": "I don't think it is a good way to analyze this class with a input replicationNum. It is up to the caller to decide how to use this object.\nIf we do this through input arguments, there will be too many arguments.", "author": "imay", "createdAt": "2020-01-11T12:53:23Z", "path": "fe/src/main/java/org/apache/doris/analysis/SingleRangePartitionDesc.java", "diffHunk": "@@ -87,15 +87,13 @@ public short getReplicationNum() {\n         return this.properties;\n     }\n \n-    public void analyze(int partColNum, Map<String, String> otherProperties) throws AnalysisException {\n+    public void analyze(int partColNum, Map<String, String> otherProperties, Short replicationNum) throws AnalysisException {", "originalCommit": "d89c77bb68e0772a080e3d0620b503346a5003c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU4MjMyOQ==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365582329", "bodyText": "ok, I will fix it", "author": "caiconghui", "createdAt": "2020-01-12T13:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUxOTc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MjgyMw==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365562823", "bodyText": "I think you can add this this.replicationNum to the tableProperty so that we do not need to update the FeMetaVersion.", "author": "morningman", "createdAt": "2020-01-12T07:24:04Z", "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -148,6 +150,8 @@ public OlapTable() {\n         this.indexes = null;\n       \n         this.tableProperty = null;\n+\n+        this.replicationNum = null;", "originalCommit": "d89c77bb68e0772a080e3d0620b503346a5003c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU4MjMwNw==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365582307", "bodyText": "The current analyzer will remove all the table property after analyzed, include replication_num, so is it a better way to change this design?", "author": "caiconghui", "createdAt": "2020-01-12T13:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MjgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTU2Ng==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365641566", "bodyText": "ok. I will fix it", "author": "caiconghui", "createdAt": "2020-01-13T03:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MjgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2Mjg3MA==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365562870", "bodyText": "Do not add replication num in create table stmt, cause it does not reflect the real replication num of each partition of a table.", "author": "morningman", "createdAt": "2020-01-12T07:25:19Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -3908,6 +3907,12 @@ public static void getDdlStmt(Table table, List<String> createTableStmt, List<St\n                 sb.append(olapTable.getTableProperty().getDynamicPartitionProperty().toString());\n             }\n \n+            // 7. replicationNum", "originalCommit": "d89c77bb68e0772a080e3d0620b503346a5003c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU4MTg0MQ==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365581841", "bodyText": "I think just like the DISTRIBUTED BY HASH(id) BUCKETS 5, which also does not reflect the real hash info of each partition of a table. so in the create table it just show the baisc config for the table and user can still set different distribution info for the special partition\nthe real table status like partition real information should be got by show partitions statement, and create table statement show only show the basic config for the table and the initial status", "author": "caiconghui", "createdAt": "2020-01-12T13:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2Mjg3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzNzUwMg==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365637502", "bodyText": "OK, I agree with u.", "author": "morningman", "createdAt": "2020-01-13T03:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2Mjg3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2Mjg5MA==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365562890", "bodyText": "Do not use static import", "author": "morningman", "createdAt": "2020-01-12T07:25:32Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -242,6 +242,8 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.concurrent.atomic.AtomicLong;\n \n+import static org.apache.doris.common.util.PropertyAnalyzer.PROPERTIES_REPLICATION_NUM;", "originalCommit": "d89c77bb68e0772a080e3d0620b503346a5003c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE2MzU2Mg==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r366163562", "bodyText": "how about just return FeConstants.default_replication_num is there is no default replica num?", "author": "morningman", "createdAt": "2020-01-14T05:58:52Z", "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -1203,4 +1203,19 @@ public boolean convertRandomDistributionToHashDistribution() {\n         }\n         return hasChanged;\n     }\n+\n+    public void setReplicationNum(Short replicationNum) {\n+        if (tableProperty == null) {\n+            tableProperty = new TableProperty(new HashMap<String, String>());\n+        }\n+        tableProperty.getProperties().put(PropertyAnalyzer.PROPERTIES_REPLICATION_NUM, replicationNum.toString());\n+    }\n+\n+    public Short getReplicationNum() {", "originalCommit": "1c91dcdadfb5e0dd978a3044162a862fb1ed3c2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI4NzQ4OQ==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r366287489", "bodyText": "I think that may confused user. Because the user doesn't set the replication_num in table level,\nhowever, FeConstants.default_replication_num can be changed by admin, and when user don't modify config for table, he may find the replication_num config in table level changed, return null indicate that we don't set any replication_num config in table level, and then we use FeConstants.default_replication_num", "author": "caiconghui", "createdAt": "2020-01-14T11:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE2MzU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE2MzU5OQ==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r366163599", "bodyText": "See comment of TableProperty about how to modify and use this class.\nYou should add a new field defaultReplicaNum in TableProperty, and this field is built from properties.\nAlso, a method buildDefaultReplicaNum() should be implemented.", "author": "morningman", "createdAt": "2020-01-14T05:59:05Z", "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -1203,4 +1203,19 @@ public boolean convertRandomDistributionToHashDistribution() {\n         }\n         return hasChanged;\n     }\n+\n+    public void setReplicationNum(Short replicationNum) {", "originalCommit": "1c91dcdadfb5e0dd978a3044162a862fb1ed3c2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzMjI0NA==", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r367432244", "bodyText": "You do not need to log all properties in TableProperty, only properties is enough", "author": "morningman", "createdAt": "2020-01-16T14:01:16Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -5117,15 +5118,28 @@ public void replayModifyTableDynamicPartition(ModifyDynamicPartitionInfo info) {\n             OlapTable olapTable = (OlapTable) db.getTable(tableId);\n             TableProperty tableProperty = olapTable.getTableProperty();\n             if (tableProperty == null) {\n-                olapTable.setTableProperty(new TableProperty(properties).buildDynamicProperty());\n+                olapTable.setTableProperty(new TableProperty(properties).buildProperty(opCode));\n             } else {\n                 tableProperty.modifyTableProperties(properties);\n+                tableProperty.buildProperty(opCode);\n             }\n         } finally {\n             db.writeUnlock();\n         }\n     }\n \n+    public void modifyTableReplicationNum(Database db, OlapTable table, Map<String, String> properties) throws DdlException {\n+        TableProperty tableProperty = table.getTableProperty();\n+        if (tableProperty == null) {\n+            tableProperty = new TableProperty(properties);\n+        } else {\n+            tableProperty.modifyTableProperties(properties);\n+        }\n+        tableProperty.buildReplicationNum();\n+        ModifyTablePropertyOperationLog info = new ModifyTablePropertyOperationLog(db.getId(), table.getId(), table.getTableProperty().getProperties());", "originalCommit": "479de4a8eefe0137c004149d6b7f53b1f77f56e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bed3dd75dd6d2a80dd0671735756b251604aea0a", "url": "https://github.com/apache/incubator-doris/commit/bed3dd75dd6d2a80dd0671735756b251604aea0a", "message": "Support replicationNum setting for table level", "committedDate": "2020-01-17T16:08:23Z", "type": "commit"}, {"oid": "e8b04e13a9cba4570ee03dbe8b57cf1988aa118d", "url": "https://github.com/apache/incubator-doris/commit/e8b04e13a9cba4570ee03dbe8b57cf1988aa118d", "message": "fix", "committedDate": "2020-01-17T16:11:35Z", "type": "commit"}, {"oid": "047eb1464db3e3bd592df8acdbd58f72e0d1914f", "url": "https://github.com/apache/incubator-doris/commit/047eb1464db3e3bd592df8acdbd58f72e0d1914f", "message": "fix", "committedDate": "2020-01-17T16:11:39Z", "type": "commit"}, {"oid": "159a201f691f437cbf83172b1c6543ded15f0f0d", "url": "https://github.com/apache/incubator-doris/commit/159a201f691f437cbf83172b1c6543ded15f0f0d", "message": "fix", "committedDate": "2020-01-17T16:11:39Z", "type": "commit"}, {"oid": "028565d8898f9b47a73d075449f6c014feffb3bf", "url": "https://github.com/apache/incubator-doris/commit/028565d8898f9b47a73d075449f6c014feffb3bf", "message": "fix", "committedDate": "2020-01-17T16:11:39Z", "type": "commit"}, {"oid": "9754dee703ab507aca12ff22e4bbde15c7953465", "url": "https://github.com/apache/incubator-doris/commit/9754dee703ab507aca12ff22e4bbde15c7953465", "message": "fix", "committedDate": "2020-01-17T16:11:39Z", "type": "commit"}, {"oid": "a123a032393538e04d84765b4e4b82c78f278c39", "url": "https://github.com/apache/incubator-doris/commit/a123a032393538e04d84765b4e4b82c78f278c39", "message": "support tableProperty modification", "committedDate": "2020-01-17T16:11:39Z", "type": "commit"}, {"oid": "bfee366751e2e15f2a41d3fece6ecbdb92fed53c", "url": "https://github.com/apache/incubator-doris/commit/bfee366751e2e15f2a41d3fece6ecbdb92fed53c", "message": "fix", "committedDate": "2020-01-17T16:11:39Z", "type": "commit"}, {"oid": "0a144d8db381f2cad69ffff186653df06454f052", "url": "https://github.com/apache/incubator-doris/commit/0a144d8db381f2cad69ffff186653df06454f052", "message": "fix set replication_num exception", "committedDate": "2020-01-17T16:11:39Z", "type": "commit"}, {"oid": "0a144d8db381f2cad69ffff186653df06454f052", "url": "https://github.com/apache/incubator-doris/commit/0a144d8db381f2cad69ffff186653df06454f052", "message": "fix set replication_num exception", "committedDate": "2020-01-17T16:11:39Z", "type": "forcePushed"}, {"oid": "fa9284b77dcab3e991ca73bbcf2ef16780680fe1", "url": "https://github.com/apache/incubator-doris/commit/fa9284b77dcab3e991ca73bbcf2ef16780680fe1", "message": "Use default.replication_num instead of replication_num to alter table", "committedDate": "2020-01-18T12:34:37Z", "type": "commit"}, {"oid": "3d2e88ee5fa16e9b09d0ca3957553cf3dc4b4f7e", "url": "https://github.com/apache/incubator-doris/commit/3d2e88ee5fa16e9b09d0ca3957553cf3dc4b4f7e", "message": "fix", "committedDate": "2020-01-18T13:07:02Z", "type": "commit"}]}