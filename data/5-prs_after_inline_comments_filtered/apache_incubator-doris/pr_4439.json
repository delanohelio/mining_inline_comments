{"pr_number": 4439, "pr_title": "Validate the param of rand function in compile step", "pr_createdAt": "2020-08-24T13:05:54Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4439", "timeline": [{"oid": "1a15f533098eec6708121004ef835d111dc374f3", "url": "https://github.com/apache/incubator-doris/commit/1a15f533098eec6708121004ef835d111dc374f3", "message": "udf: replace function", "committedDate": "2020-08-13T14:09:31Z", "type": "commit"}, {"oid": "7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "url": "https://github.com/apache/incubator-doris/commit/7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-14T01:37:05Z", "type": "commit"}, {"oid": "391158f52190755b5fc621c31bf703835c0a7b3b", "url": "https://github.com/apache/incubator-doris/commit/391158f52190755b5fc621c31bf703835c0a7b3b", "message": "udf: replace function", "committedDate": "2020-08-14T02:11:25Z", "type": "commit"}, {"oid": "5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "url": "https://github.com/apache/incubator-doris/commit/5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "message": "udf: replace function", "committedDate": "2020-08-14T03:58:30Z", "type": "commit"}, {"oid": "a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "url": "https://github.com/apache/incubator-doris/commit/a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-18T02:31:52Z", "type": "commit"}, {"oid": "86f841f29fa4ee19773d6c5922465194a2887cf6", "url": "https://github.com/apache/incubator-doris/commit/86f841f29fa4ee19773d6c5922465194a2887cf6", "message": "udf: replace function", "committedDate": "2020-08-18T03:56:14Z", "type": "commit"}, {"oid": "ade1afa75c94a178a6801ba1324acf25ad8b16fe", "url": "https://github.com/apache/incubator-doris/commit/ade1afa75c94a178a6801ba1324acf25ad8b16fe", "message": "udf: replace function", "committedDate": "2020-08-18T03:59:59Z", "type": "commit"}, {"oid": "1d95a491115064c9753694ad4d45c2f72b8d2645", "url": "https://github.com/apache/incubator-doris/commit/1d95a491115064c9753694ad4d45c2f72b8d2645", "message": "udf: replace function", "committedDate": "2020-08-18T08:01:45Z", "type": "commit"}, {"oid": "433eb87f02cfa6740e80b0e4157d916ab5aca400", "url": "https://github.com/apache/incubator-doris/commit/433eb87f02cfa6740e80b0e4157d916ab5aca400", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-24T02:03:34Z", "type": "commit"}, {"oid": "313e0a9ccd35297279011e904711311fe6acf621", "url": "https://github.com/apache/incubator-doris/commit/313e0a9ccd35297279011e904711311fe6acf621", "message": "rand function validate literal param", "committedDate": "2020-08-24T12:55:03Z", "type": "commit"}, {"oid": "d00fde471708754b9db2213e6d066ff98f5c9ef9", "url": "https://github.com/apache/incubator-doris/commit/d00fde471708754b9db2213e6d066ff98f5c9ef9", "message": "rand function validate literal param", "committedDate": "2020-08-24T12:58:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM4ODA2Nw==", "url": "https://github.com/apache/incubator-doris/pull/4439#discussion_r476388067", "bodyText": "this.children != null is unnecessary", "author": "kangkaisen", "createdAt": "2020-08-25T11:50:06Z", "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/Expr.java", "diffHunk": "@@ -1405,7 +1405,15 @@ protected Function getBuiltinFunction(\n             throws AnalysisException {\n         FunctionName fnName = new FunctionName(name);\n         Function searchDesc = new Function(fnName, argTypes, Type.INVALID, false);\n-        return Catalog.getCurrentCatalog().getFunction(searchDesc, mode);\n+        Function f = Catalog.getCurrentCatalog().getFunction(searchDesc, mode);\n+        if (f != null && fnName.getFunction().equalsIgnoreCase(\"rand\")) {\n+            if (this.children != null", "originalCommit": "d00fde471708754b9db2213e6d066ff98f5c9ef9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxOTY4Mg==", "url": "https://github.com/apache/incubator-doris/pull/4439#discussion_r476419682", "bodyText": "Rand function has two implements. One is Rand(const int), the other is Rand() without parm**.  this.children != null** filters Rand() without param.", "author": "xinghuayu007", "createdAt": "2020-08-25T12:46:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM4ODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyNjYzNg==", "url": "https://github.com/apache/incubator-doris/pull/4439#discussion_r476426636", "bodyText": "children is init with Lists.newArrayList(); in TreeNode, so it won't be null.", "author": "kangkaisen", "createdAt": "2020-08-25T12:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM4ODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1ODQwMw==", "url": "https://github.com/apache/incubator-doris/pull/4439#discussion_r476458403", "bodyText": "You are right.", "author": "xinghuayu007", "createdAt": "2020-08-25T13:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM4ODA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5MTM4Ng==", "url": "https://github.com/apache/incubator-doris/pull/4439#discussion_r476391386", "bodyText": "You could add the test in SelectStmtTest, and then you could directly write testRandFunction", "author": "kangkaisen", "createdAt": "2020-08-25T11:56:23Z", "path": "fe/fe-core/src/test/java/org/apache/doris/analysis/ExprTest.java", "diffHunk": "@@ -24,18 +24,43 @@\n \n import com.google.common.collect.Maps;\n \n+import org.apache.doris.mysql.privilege.MockedAuth;\n+import org.apache.doris.mysql.privilege.PaloAuth;\n+import org.apache.doris.qe.ConnectContext;\n+import org.apache.doris.utframe.DorisAssert;\n+import org.apache.doris.utframe.UtFrameUtils;\n import org.junit.Assert;\n import org.junit.Test;\n+import org.junit.BeforeClass;\n+import org.junit.AfterClass;\n \n-import java.util.Map;\n-import java.util.Set;\n+import java.io.IOException;\n+import java.util.*;\n \n import mockit.Expectations;\n import mockit.Injectable;\n import mockit.Mocked;\n \n public class ExprTest {\n \n+    private static String runningDir = \"fe/mocked/DemoTest/\" + UUID.randomUUID().toString() + \"/\";", "originalCommit": "d00fde471708754b9db2213e6d066ff98f5c9ef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5MTYzOA==", "url": "https://github.com/apache/incubator-doris/pull/4439#discussion_r476391638", "bodyText": "What's the meaning of   Assert.assertTrue(1 == 1); ?", "author": "kangkaisen", "createdAt": "2020-08-25T11:56:48Z", "path": "fe/fe-core/src/test/java/org/apache/doris/analysis/ExprTest.java", "diffHunk": "@@ -159,4 +184,42 @@ public void testUncheckedCastTo() throws AnalysisException {\n         StringLiteral castStringLiteral2 = (StringLiteral) stringLiteral.uncheckedCastTo(Type.VARCHAR);\n         Assert.assertTrue(stringLiteral == castStringLiteral2);\n     }\n+\n+    @Test\n+    public void testRandFunction() {\n+        try {\n+            ConnectContext ctx = UtFrameUtils.createDefaultCtx();\n+            String selectStmtStr = \"select rand(db1.tbl1.k1) from db1.tbl1;\";\n+            UtFrameUtils.parseAndAnalyzeStmt(selectStmtStr, ctx);\n+        } catch (Exception e) {\n+            Assert.assertTrue(e.getMessage().contains(\"The param of rand function must be literal\"));\n+        }\n+\n+        try {\n+            ConnectContext ctx = UtFrameUtils.createDefaultCtx();\n+            String selectStmtStr = \"select rand(1234) from db1.tbl1;\";\n+            UtFrameUtils.parseAndAnalyzeStmt(selectStmtStr, ctx);\n+        } catch (Exception e) {\n+            Assert.assertFalse(e.getMessage().contains(\"The param of rand function must be literal\"));\n+        }\n+        Assert.assertTrue(1 == 1);", "originalCommit": "d00fde471708754b9db2213e6d066ff98f5c9ef9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f01f1f46d2c1c86f0bf31f75834433c0d5e31361", "url": "https://github.com/apache/incubator-doris/commit/f01f1f46d2c1c86f0bf31f75834433c0d5e31361", "message": "validate funtion rand with literal in compile step", "committedDate": "2020-08-25T12:46:42Z", "type": "commit"}, {"oid": "608037f3e437a3d458a007393fe108f2995694d2", "url": "https://github.com/apache/incubator-doris/commit/608037f3e437a3d458a007393fe108f2995694d2", "message": "validate funtion rand with literal in compile step", "committedDate": "2020-08-25T12:48:48Z", "type": "commit"}, {"oid": "a3ee01eba6d446b92ec03914939c499321770442", "url": "https://github.com/apache/incubator-doris/commit/a3ee01eba6d446b92ec03914939c499321770442", "message": "validate funtion rand with literal in compile step", "committedDate": "2020-08-25T12:49:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyNTcwNw==", "url": "https://github.com/apache/incubator-doris/pull/4439#discussion_r476425707", "bodyText": "You could use dorisAssert.query(sql).explainQuery();, which is more simpler.", "author": "kangkaisen", "createdAt": "2020-08-25T12:55:26Z", "path": "fe/fe-core/src/test/java/org/apache/doris/analysis/SelectStmtTest.java", "diffHunk": "@@ -362,4 +362,39 @@ public void testDataGripSupport() throws Exception {\n                 \"from information_schema.collations\";\n         dorisAssert.query(sql).explainQuery();\n     }\n+\n+    @Test\n+    public void testRandFunction() {\n+        try {\n+            ConnectContext ctx = UtFrameUtils.createDefaultCtx();", "originalCommit": "a3ee01eba6d446b92ec03914939c499321770442", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3089445ba5e1eaede342d0b72c979f0e0399ab91", "url": "https://github.com/apache/incubator-doris/commit/3089445ba5e1eaede342d0b72c979f0e0399ab91", "message": "validate funtion rand with literal in compile step", "committedDate": "2020-08-25T13:39:48Z", "type": "commit"}, {"oid": "c6f7a9cf6e681053707ea155980d315f00da2e68", "url": "https://github.com/apache/incubator-doris/commit/c6f7a9cf6e681053707ea155980d315f00da2e68", "message": "validate funtion rand with literal in compile step", "committedDate": "2020-08-25T13:40:36Z", "type": "commit"}, {"oid": "a2f9673fbd2e84bb0e88d275254baaf09645b6b9", "url": "https://github.com/apache/incubator-doris/commit/a2f9673fbd2e84bb0e88d275254baaf09645b6b9", "message": "validate funtion rand with literal in compile step", "committedDate": "2020-08-25T13:42:00Z", "type": "commit"}, {"oid": "e0adcef9d99dcef88c59d78bcff1d59c7675d3b5", "url": "https://github.com/apache/incubator-doris/commit/e0adcef9d99dcef88c59d78bcff1d59c7675d3b5", "message": "validate rand function param in compile phase", "committedDate": "2020-08-27T06:29:08Z", "type": "commit"}, {"oid": "3e99267974ceff15cde5313fe270603654674fd5", "url": "https://github.com/apache/incubator-doris/commit/3e99267974ceff15cde5313fe270603654674fd5", "message": "update", "committedDate": "2020-08-27T08:15:56Z", "type": "commit"}, {"oid": "e7148921e503b2fef3a8b1bb331023998cfe1257", "url": "https://github.com/apache/incubator-doris/commit/e7148921e503b2fef3a8b1bb331023998cfe1257", "message": "Merge remote-tracking branch 'upstream/master' into function_check", "committedDate": "2020-08-27T11:36:02Z", "type": "commit"}, {"oid": "697c5e780a94ae9226eac267b7810ed375ac9bb2", "url": "https://github.com/apache/incubator-doris/commit/697c5e780a94ae9226eac267b7810ed375ac9bb2", "message": "update", "committedDate": "2020-08-27T11:58:46Z", "type": "commit"}, {"oid": "84d3ea8c6335fa588bb9655b00a40ad6ffb1c589", "url": "https://github.com/apache/incubator-doris/commit/84d3ea8c6335fa588bb9655b00a40ad6ffb1c589", "message": "Merge remote-tracking branch 'upstream/master' into function_check", "committedDate": "2020-08-28T03:25:11Z", "type": "commit"}, {"oid": "a6051794faabab05929ab2aadf34896131cf147e", "url": "https://github.com/apache/incubator-doris/commit/a6051794faabab05929ab2aadf34896131cf147e", "message": "Merge remote-tracking branch 'upstream/master' into function_check", "committedDate": "2020-08-31T02:35:47Z", "type": "commit"}]}