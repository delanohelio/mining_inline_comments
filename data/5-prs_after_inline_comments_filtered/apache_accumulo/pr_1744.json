{"pr_number": 1744, "pr_title": "Use newer map methods in TabletGroupWatcher", "pr_createdAt": "2020-10-20T20:25:25Z", "pr_url": "https://github.com/apache/accumulo/pull/1744", "timeline": [{"oid": "d23b62584cd01fc95bbffb151a10659862689b9a", "url": "https://github.com/apache/accumulo/commit/d23b62584cd01fc95bbffb151a10659862689b9a", "message": "Use newer map methods in TabletGroupWatcher", "committedDate": "2020-10-20T20:04:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2MTI4Mg==", "url": "https://github.com/apache/accumulo/pull/1744#discussion_r508861282", "bodyText": "This always constructs the the 'default' new MergeStats(new MergeInfo())), even if already exists in currentMerges. To avoid that, you could use the following instead of getOrDefault:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          k -> currentMerges.getOrDefault(k, new MergeStats(new MergeInfo())));\n          \n          \n            \n                          k -> {\n          \n          \n            \n                            var mergeStats = currentMerges.get(k);\n          \n          \n            \n                            return mergeStats != null ? mergeStats : new MergeStats(new MergeInfo());\n          \n          \n            \n                          });", "author": "ctubbsii", "createdAt": "2020-10-20T21:49:34Z", "path": "server/manager/src/main/java/org/apache/accumulo/master/TabletGroupWatcher.java", "diffHunk": "@@ -214,14 +214,8 @@ public void run() {\n           TableId tableId = tls.extent.tableId();\n           TableConfiguration tableConf = this.master.getContext().getTableConfiguration(tableId);\n \n-          MergeStats mergeStats = mergeStatsCache.get(tableId);\n-          if (mergeStats == null) {\n-            mergeStats = currentMerges.get(tableId);\n-            if (mergeStats == null) {\n-              mergeStats = new MergeStats(new MergeInfo());\n-            }\n-            mergeStatsCache.put(tableId, mergeStats);\n-          }\n+          MergeStats mergeStats = mergeStatsCache.computeIfAbsent(tableId,\n+              k -> currentMerges.getOrDefault(k, new MergeStats(new MergeInfo())));", "originalCommit": "d23b62584cd01fc95bbffb151a10659862689b9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM0MDQ1MA==", "url": "https://github.com/apache/accumulo/pull/1744#discussion_r509340450", "bodyText": "Now you got me thinking, how does map.getOrDefault(k, new MergeInfo()) behave differently from log.debug(\"Merge: {}\", new MergeInfo())?  Does slf4j have a special ability to not call the method on the interface based on logging level vs the default method on the Map interface, which will always execute the method?", "author": "milleruntime", "createdAt": "2020-10-21T14:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2MTI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM2MTA4OQ==", "url": "https://github.com/apache/accumulo/pull/1744#discussion_r509361089", "bodyText": "I guess I am confusing how sl4j doesn't create unnecessary objects with the creation of an object when it is passed it as a parameter.  If new Object() is passed as a parameter to a method, it will always create the object when the method is executed.", "author": "milleruntime", "createdAt": "2020-10-21T14:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2MTI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQzNjIwNA==", "url": "https://github.com/apache/accumulo/pull/1744#discussion_r509436204", "bodyText": "To clarify, this code will throw an exception even at the \"info\" level:\npublic class Slf4jLoggingTest {\n    private static Logger log = LoggerFactory.getLogger(Slf4jLoggingTest.class);\n\n    public static void main(String[] args) {\n        log.info(\"Start main\");\n        log.debug(\"debug called: {}\", expensiveCall());\n        log.info(\"Finished\");\n    }\n    public static String expensiveCall() {\n        if (true)\n            throw new UnsupportedOperationException(\"Do not call\");\n        return \"expensive string\";\n    }\n}\n\nThis code is actually passing a method but its the same idea.  The method will get called to get the string it returns in the same way new Object() will get resolved.", "author": "milleruntime", "createdAt": "2020-10-21T16:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2MTI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ0MTY0Nw==", "url": "https://github.com/apache/accumulo/pull/1744#discussion_r509441647", "bodyText": "With log4j 2 - it appears that lambdas can be used to provide lazy behavior.\nlog.debug(\"debug called: {}\", () -> expensiveCall());\nWould avoid the call if debug level logging was not enabled.", "author": "EdColeman", "createdAt": "2020-10-21T16:45:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2MTI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ0ODg4Mg==", "url": "https://github.com/apache/accumulo/pull/1744#discussion_r509448882", "bodyText": "This does work if you explicitly call the Log4j2 logger.  Lambdas aren't implemented yet in slf4fj.  There is an alpha version though: https://jira.qos.ch/browse/SLF4J-371", "author": "milleruntime", "createdAt": "2020-10-21T16:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2MTI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYwMDcwNw==", "url": "https://github.com/apache/accumulo/pull/1744#discussion_r509600707", "bodyText": "Yeah, the same issue would apply to our slf4j debug statments... which is why we typically wrap stuff in an if block to check the log level .isTraceEnabled() first, to avoid making expensive objects.", "author": "ctubbsii", "createdAt": "2020-10-21T19:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2MTI4Mg=="}], "type": "inlineReview"}, {"oid": "c9db848cb19c83e950f45516786c59e56e9d3364", "url": "https://github.com/apache/accumulo/commit/c9db848cb19c83e950f45516786c59e56e9d3364", "message": "Update server/manager/src/main/java/org/apache/accumulo/master/TabletGroupWatcher.java\n\nCo-authored-by: Christopher Tubbs <ctubbsii@apache.org>", "committedDate": "2020-10-21T16:44:12Z", "type": "commit"}, {"oid": "37fe14a7f63ca065ca2175798bad6a96df298311", "url": "https://github.com/apache/accumulo/commit/37fe14a7f63ca065ca2175798bad6a96df298311", "message": "Fix variable name and format", "committedDate": "2020-10-21T17:05:38Z", "type": "commit"}]}