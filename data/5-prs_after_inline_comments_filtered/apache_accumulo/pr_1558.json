{"pr_number": 1558, "pr_title": "Resolve relative delete markers on upgrade. Closes #1463", "pr_createdAt": "2020-03-10T19:07:43Z", "pr_url": "https://github.com/apache/accumulo/pull/1558", "timeline": [{"oid": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7", "url": "https://github.com/apache/accumulo/commit/d19bccd6d33e1219ceaaea54a21304dfb99b5fc7", "message": "Resolve relative delete markers on upgrade. Closes #1463", "committedDate": "2020-03-10T18:58:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNTEyMg==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390635122", "bodyText": "What is the significance of depth 4? Could add to a comment.", "author": "ctubbsii", "createdAt": "2020-03-10T21:57:26Z", "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -430,26 +432,27 @@ public void upgradeFileDeletes(ServerContext ctx, Ample.DataLevel level) {\n     }\n   }\n \n+  /**\n+   * If path of file to delete is a directory, change it to all volumes. See {@link GcVolumeUtil}.\n+   * For example: A directory \"hdfs://localhost:9000/accumulo/tables/5a/t-0005\" with depth = 4 will\n+   * be switched to \"agcav:/tables/5a/t-0005\". A file\n+   * \"hdfs://localhost:9000/accumulo/tables/5a/t-0005/A0012.rf\" with depth = 5 will be returned as\n+   * is.\n+   */\n   @VisibleForTesting\n-  static String switchToAllVolumes(String olddelete) {\n-    Path relPath = VolumeManager.FileType.TABLE.removeVolume(new Path(olddelete));\n-\n-    if (relPath == null) {\n-      // An old style relative delete marker of the form /<table id>/<tablet dir>[/<file>]\n-      relPath = new Path(\"/\" + VolumeManager.FileType.TABLE.getDirectory() + olddelete);\n-      Preconditions.checkState(\n-          olddelete.startsWith(\"/\") && relPath.depth() == 3 || relPath.depth() == 4,\n-          \"Unrecongnized relative delete marker {}\", olddelete);\n-    }\n-\n-    if (relPath.depth() == 3 && !relPath.getName().startsWith(Constants.BULK_PREFIX)) {\n-      return GcVolumeUtil.getDeleteTabletOnAllVolumesUri(TableId.of(relPath.getParent().getName()),\n-          relPath.getName());\n+  static String switchToAllVolumes(Path olddelete) {\n+    // for directory, change volume to all volumes\n+    if (olddelete.depth() == 4 && !olddelete.getName().startsWith(Constants.BULK_PREFIX)) {", "originalCommit": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MDEwNw==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390670107", "bodyText": "Volumes do not have to be depth of 1.  For example a user could configure a volume like hdfs://localhost:9000/dev/accumulo.  This would make a dir using that volume have a depth != 4.", "author": "keith-turner", "createdAt": "2020-03-10T23:32:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNTEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0MzA2OA==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390943068", "bodyText": "Ah OK.  Then we still need to remove the volume before checking.\n@ctubbsii I added a comment above the line and at the beginning of the method.  I will add the removeVolume call back and update the comments.", "author": "milleruntime", "createdAt": "2020-03-11T12:43:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNTEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNzM1OA==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390637358", "bodyText": "Should have comment to briefly explain intent of this check, so its implementation can be more easily verified. The current comment just says \"check the format is correct\", but does not explain what it means to be \"correct\".", "author": "ctubbsii", "createdAt": "2020-03-10T22:03:14Z", "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -625,4 +626,39 @@ private static Path resolveRelativePath(String metadataEntry, Key key) {\n       return new Path(prefix + tableId.canonical() + metadataEntry);\n     }\n   }\n+\n+  /**\n+   * Resolve old relative delete markers of the form /tableId/tabletDir/[file] to\n+   * UpgradeVolume/tables/tableId/tabletDir/[file]\n+   */\n+  static Path resolveRelativeDelete(VolumeManager fs, String oldDelete, String upgradeProperty) {\n+    Path pathNoVolume = VolumeManager.FileType.TABLE.removeVolume(new Path(oldDelete));\n+\n+    // abs path won't be null so return\n+    if (pathNoVolume != null)\n+      return pathNoVolume;\n+\n+    // use Path to check the format is correct\n+    Path pathToCheck = new Path(oldDelete);\n+    Preconditions.checkState(\n+        oldDelete.startsWith(\"/\") && (pathToCheck.depth() == 2 || pathToCheck.depth() == 3),", "originalCommit": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2NDAzNg==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390964036", "bodyText": "Updated comments.  Let me know if it is more clear now", "author": "milleruntime", "createdAt": "2020-03-11T13:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNzM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3MTA0OA==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r391971048", "bodyText": "This is definitely better. Thanks.", "author": "ctubbsii", "createdAt": "2020-03-13T00:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNzM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzODE1NQ==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390638155", "bodyText": "This says \"absolute path won't be null\", but that's not the same as \"relative path must be null\". Can relative path be non-null? If so, then this will return for both absolute paths and non-null relative paths.", "author": "ctubbsii", "createdAt": "2020-03-10T22:05:20Z", "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -625,4 +626,39 @@ private static Path resolveRelativePath(String metadataEntry, Key key) {\n       return new Path(prefix + tableId.canonical() + metadataEntry);\n     }\n   }\n+\n+  /**\n+   * Resolve old relative delete markers of the form /tableId/tabletDir/[file] to\n+   * UpgradeVolume/tables/tableId/tabletDir/[file]\n+   */\n+  static Path resolveRelativeDelete(VolumeManager fs, String oldDelete, String upgradeProperty) {\n+    Path pathNoVolume = VolumeManager.FileType.TABLE.removeVolume(new Path(oldDelete));\n+\n+    // abs path won't be null so return\n+    if (pathNoVolume != null)\n+      return pathNoVolume;", "originalCommit": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0NDAyMg==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390944022", "bodyText": "The removeVolume method will return null if it doesn't have a volume aka it is a relative path.", "author": "milleruntime", "createdAt": "2020-03-11T12:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzODE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MDkwMQ==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390670901", "bodyText": "Delete entries do not have to exists.  This can happen when the GC deletes some files, but the GC process dies before it deletes the delete entries.", "author": "keith-turner", "createdAt": "2020-03-10T23:35:18Z", "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -625,4 +626,39 @@ private static Path resolveRelativePath(String metadataEntry, Key key) {\n       return new Path(prefix + tableId.canonical() + metadataEntry);\n     }\n   }\n+\n+  /**\n+   * Resolve old relative delete markers of the form /tableId/tabletDir/[file] to\n+   * UpgradeVolume/tables/tableId/tabletDir/[file]\n+   */\n+  static Path resolveRelativeDelete(VolumeManager fs, String oldDelete, String upgradeProperty) {\n+    Path pathNoVolume = VolumeManager.FileType.TABLE.removeVolume(new Path(oldDelete));\n+\n+    // abs path won't be null so return\n+    if (pathNoVolume != null)\n+      return pathNoVolume;\n+\n+    // use Path to check the format is correct\n+    Path pathToCheck = new Path(oldDelete);\n+    Preconditions.checkState(\n+        oldDelete.startsWith(\"/\") && (pathToCheck.depth() == 2 || pathToCheck.depth() == 3),\n+        \"Unrecognized relative delete marker {}\", oldDelete);\n+\n+    // found relative paths so verify the property used to build the absolute paths\n+    if (upgradeProperty == null || upgradeProperty.isBlank()) {\n+      throw new IllegalArgumentException(\n+          \"Missing required property \" + Property.INSTANCE_VOLUMES_UPGRADE_RELATIVE.getKey());\n+    }\n+    Path absPath =\n+        new Path(upgradeProperty, VolumeManager.FileType.TABLE.getDirectory() + oldDelete);\n+    try {\n+      if (!fs.exists(absPath)) {", "originalCommit": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0NDQyOQ==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390944429", "bodyText": "Good to know, thanks.  I will remove this check.", "author": "milleruntime", "createdAt": "2020-03-11T12:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MDkwMQ=="}], "type": "inlineReview"}, {"oid": "70dd2760ce5974d47ca2902e609d1f6261376829", "url": "https://github.com/apache/accumulo/commit/70dd2760ce5974d47ca2902e609d1f6261376829", "message": "PR updates", "committedDate": "2020-03-11T13:18:14Z", "type": "commit"}, {"oid": "f97f349f5ffdf4cd991fedac6526acb9ea4fcb38", "url": "https://github.com/apache/accumulo/commit/f97f349f5ffdf4cd991fedac6526acb9ea4fcb38", "message": "Remove param no longer used", "committedDate": "2020-03-11T13:25:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3MDkxMw==", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r391970913", "bodyText": "I'm still a bit concerned about the wording of this comment here. Is this an if or an iff (if and only if)?", "author": "ctubbsii", "createdAt": "2020-03-13T00:23:06Z", "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -625,4 +630,30 @@ private static Path resolveRelativePath(String metadataEntry, Key key) {\n       return new Path(prefix + tableId.canonical() + metadataEntry);\n     }\n   }\n+\n+  /**\n+   * Resolve old relative delete markers of the form /tableId/tabletDir/[file] to\n+   * UpgradeVolume/tables/tableId/tabletDir/[file]\n+   */\n+  static Path resolveRelativeDelete(String oldDelete, String upgradeProperty) {\n+    Path pathNoVolume = VolumeManager.FileType.TABLE.removeVolume(new Path(oldDelete));\n+\n+    // removeVolume will return null if path doesn't have a volume aka is a relative path", "originalCommit": "f97f349f5ffdf4cd991fedac6526acb9ea4fcb38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1b5c4dca9014009dda28155d0ea4b5cec48b42a0", "url": "https://github.com/apache/accumulo/commit/1b5c4dca9014009dda28155d0ea4b5cec48b42a0", "message": "Fix replace method after changing other method. Update comment", "committedDate": "2020-03-13T14:31:49Z", "type": "commit"}, {"oid": "4c12724007ee4258c1f10a86df9655dfe8b47b86", "url": "https://github.com/apache/accumulo/commit/4c12724007ee4258c1f10a86df9655dfe8b47b86", "message": "Update comment", "committedDate": "2020-03-13T19:28:27Z", "type": "commit"}]}