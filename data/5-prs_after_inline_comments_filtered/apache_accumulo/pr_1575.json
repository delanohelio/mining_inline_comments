{"pr_number": 1575, "pr_title": "Skip restricted ports in TServer port search", "pr_createdAt": "2020-03-28T22:22:44Z", "pr_url": "https://github.com/apache/accumulo/pull/1575", "timeline": [{"oid": "3817718b089e6396264774f9d9f6cdbd427da602", "url": "https://github.com/apache/accumulo/commit/3817718b089e6396264774f9d9f6cdbd427da602", "message": "Skip restricted ports in TServer port search\n\nFixes #1573. Includes debug logging for ports being skipped.", "committedDate": "2020-03-28T22:19:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODc3MQ==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r399738771", "bodyText": "enum comparisons in Java should always use == and not .equals(Object)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      if (p.getType().equals(PropertyType.PORT)) {\n          \n          \n            \n                      if (p.getType() == PropertyType.PORT) {", "author": "ctubbsii", "createdAt": "2020-03-29T03:23:25Z", "path": "server/base/src/main/java/org/apache/accumulo/server/rpc/TServerUtils.java", "diffHunk": "@@ -168,10 +171,33 @@ public static ServerAddress startServer(MetricsSystem metricsSystem, ServerConte\n           addresses);\n     } catch (TTransportException e) {\n       if (portSearch) {\n+        // Build a list of reserved ports - as identified by properties of type PropertyType.PORT\n+        ArrayList<Integer> restrictedPorts = new ArrayList<Integer>();\n+        for (Property p : Property.values()) {\n+          if (p.getType().equals(PropertyType.PORT)) {", "originalCommit": "3817718b089e6396264774f9d9f6cdbd427da602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczOTUzNw==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r399739537", "bodyText": "Also, you might be able to do something shorter with streams. Something like:\nList<Integer> restrictedPorts = EnumSet.allOf(Property.class).stream()\n        .filter(p -> p.getType() == HttpMethod.TRACE)\n        .map(config::getPort).collect(Collectors.toList());", "author": "ctubbsii", "createdAt": "2020-03-29T03:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczOTcyMg==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r399739722", "bodyText": "If we \"remember\" which config proper where we found each integer (by collecting as Map<Integer,Property>, perhaps), then we could also have more informative debug log messages when ports are skipped.", "author": "ctubbsii", "createdAt": "2020-03-29T03:37:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc1Nzg3MQ==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r399757871", "bodyText": "Thanks! Will incorporate these. I also realized that TSERV_CLIENTPORT should not be skipped as it is a valid port for the TServer to use even if port search is enabled.", "author": "arvindshmicrosoft", "createdAt": "2020-03-29T07:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgzODg0Mw==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r399838843", "bodyText": "TSERV_CLIENTPORT should be the starting point before incrementing, so I don't think it would be a problem anyway, but it wouldn't hurt to skip it too, just in case the code is changed, or reused for other services.", "author": "ctubbsii", "createdAt": "2020-03-29T19:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNzIzNQ==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r400317235", "bodyText": "Done. The debug logs now include port numbers, the config setting and the description as well.\n2020-03-30T08:57:25,201 [rpc.TServerUtils] WARN : Error attempting to create server at 0.0.0.0:9997. Error: Could not create ServerSocket on address /0.0.0.0:9997.\n2020-03-30T08:57:25,214 [rpc.TServerUtils] DEBUG: During port search, skipping reserved port 9998 - property gc.port.client (The listening port for the garbage collector's monitor service)\n2020-03-30T08:57:25,215 [rpc.TServerUtils] DEBUG: During port search, skipping reserved port 9999 - property master.port.client (The port used for handling client connections on the master)\n2020-03-30T08:57:25,215 [rpc.TServerUtils] DEBUG: Instantiating unsecure custom half-async Thrift server\n2020-03-30T08:57:25,215 [rpc.TServerUtils] WARN : Error attempting to create server at 0.0.0.0:10000. Error: Could not create ServerSocket on address /0.0.0.0:10000.\n2020-03-30T08:57:25,215 [rpc.TServerUtils] INFO : Unable to use port 10000, retrying. (Thread Name = Thrift Client Server)\n2020-03-30T08:57:25,215 [rpc.TServerUtils] DEBUG: During port search, skipping reserved port 10001 - property master.replication.coordinator.port (Port for the replication coordinator service)\n2020-03-30T08:57:25,216 [rpc.TServerUtils] DEBUG: Instantiating unsecure custom half-async Thrift server\n2020-03-30T08:57:25,216 [rpc.TServerUtils] WARN : Error attempting to create server at 0.0.0.0:10002. Error: Could not create ServerSocket on address /0.0.0.0:10002.\n2020-03-30T08:57:25,216 [rpc.TServerUtils] INFO : Unable to use port 10002, retrying. (Thread Name = Thrift Client Server)\n2020-03-30T08:57:25,216 [rpc.TServerUtils] DEBUG: Instantiating unsecure custom half-async Thrift server\n2020-03-30T08:57:25,223 [tserver.TabletServer] INFO : address = dev-ub18:10003", "author": "arvindshmicrosoft", "createdAt": "2020-03-30T16:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczOTYyOA==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r399739628", "bodyText": "I don't think we need this debug statement here, but if there's an easy way to unit test the code with a mock configuration, that might be nice. Might need to move some of this port search logic into a separate method to make that easier.", "author": "ctubbsii", "createdAt": "2020-03-29T03:35:57Z", "path": "server/base/src/main/java/org/apache/accumulo/server/rpc/TServerUtils.java", "diffHunk": "@@ -168,10 +171,33 @@ public static ServerAddress startServer(MetricsSystem metricsSystem, ServerConte\n           addresses);\n     } catch (TTransportException e) {\n       if (portSearch) {\n+        // Build a list of reserved ports - as identified by properties of type PropertyType.PORT\n+        ArrayList<Integer> restrictedPorts = new ArrayList<Integer>();\n+        for (Property p : Property.values()) {\n+          if (p.getType().equals(PropertyType.PORT)) {\n+            for (int element : config.getPort(p)) {\n+              restrictedPorts.add(element);\n+              if (log.isDebugEnabled()) {\n+                log.debug(\"Adding port {} to list of restricted ports\", element);", "originalCommit": "3817718b089e6396264774f9d9f6cdbd427da602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxNzQ2NA==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r400317464", "bodyText": "Done. I added what I think is a pretty comprehensive unit test. Please take a look when possible.", "author": "arvindshmicrosoft", "createdAt": "2020-03-30T16:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczOTYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczOTk4OQ==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r399739989", "bodyText": "There is no need to guard log messages with .isLEVELEnabled() calls when merely printing a log statement, since the logging framework already does this itself (it's also why we use the format string instead of using String.format or string concatenation ourselves). We only need to do that if we're doing extra work to prepare the log messages.\nSee previous comment on suggestion to improve this log message with the specific service that has reserved it. Could print Property.getKey() here.", "author": "ctubbsii", "createdAt": "2020-03-29T03:41:30Z", "path": "server/base/src/main/java/org/apache/accumulo/server/rpc/TServerUtils.java", "diffHunk": "@@ -168,10 +171,33 @@ public static ServerAddress startServer(MetricsSystem metricsSystem, ServerConte\n           addresses);\n     } catch (TTransportException e) {\n       if (portSearch) {\n+        // Build a list of reserved ports - as identified by properties of type PropertyType.PORT\n+        ArrayList<Integer> restrictedPorts = new ArrayList<Integer>();\n+        for (Property p : Property.values()) {\n+          if (p.getType().equals(PropertyType.PORT)) {\n+            for (int element : config.getPort(p)) {\n+              restrictedPorts.add(element);\n+              if (log.isDebugEnabled()) {\n+                log.debug(\"Adding port {} to list of restricted ports\", element);\n+              }\n+            }\n+          }\n+        }\n+\n         HostAndPort last = addresses[addresses.length - 1];\n         // Attempt to allocate a port outside of the specified port property\n         // Search sequentially over the next 1000 ports\n         for (int port = last.getPort() + 1; port < last.getPort() + 1001; port++) {\n+          if (restrictedPorts.contains(port)) {\n+            if (log.isDebugEnabled()) {\n+              log.debug(\n+                  \"During port search, skipping port {} as it is reserved for another service\",\n+                  port);\n+            }", "originalCommit": "3817718b089e6396264774f9d9f6cdbd427da602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc1ODE2OA==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r399758168", "bodyText": "Thanks, I was doing this based on suggestions to do so from @keith-turner for a previous PR - but I realize now that the suggestion was related to the extra work in that case (joining a list) to prep the log message. Will rework.", "author": "arvindshmicrosoft", "createdAt": "2020-03-29T07:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczOTk4OQ=="}], "type": "inlineReview"}, {"oid": "df3f67c52b8cc7dc671f634470837edb2e0be7e9", "url": "https://github.com/apache/accumulo/commit/df3f67c52b8cc7dc671f634470837edb2e0be7e9", "message": "Use Java Streams and add Unit Test\n\n* Using streams to make the reserved port enumeration code more declarative\n* Added a comprehensive unit test to check that reserved ports are\n  skipped during TServer startup as part of port search", "committedDate": "2020-03-30T17:19:52Z", "type": "commit"}, {"oid": "df3f67c52b8cc7dc671f634470837edb2e0be7e9", "url": "https://github.com/apache/accumulo/commit/df3f67c52b8cc7dc671f634470837edb2e0be7e9", "message": "Use Java Streams and add Unit Test\n\n* Using streams to make the reserved port enumeration code more declarative\n* Added a comprehensive unit test to check that reserved ports are\n  skipped during TServer startup as part of port search", "committedDate": "2020-03-30T17:19:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwNzIwNA==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r400607204", "bodyText": "I think I have an idea to simplify the unit testing logic for the port search behavior by putting all the port search logic into a single method that accepts a starting port and a config, and returns a selected port, but I can experiment with that idea after we merge in the functionality you've added.", "author": "ctubbsii", "createdAt": "2020-03-31T02:34:20Z", "path": "server/base/src/test/java/org/apache/accumulo/server/util/TServerUtilsTest.java", "diffHunk": "@@ -233,6 +234,72 @@ public void testStartServerUsedPortWithSearch() throws Exception {\n     }\n   }\n \n+  @SuppressFBWarnings(value = \"UNENCRYPTED_SERVER_SOCKET\", justification = \"socket for testing\")\n+  @Test\n+  public void testStartServerNonDefaultPorts() throws Exception {", "originalCommit": "df3f67c52b8cc7dc671f634470837edb2e0be7e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM3MjA2OQ==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r402372069", "bodyText": "It would be nice to rework this entire unit test to use less static stuff and pass more, but that would be follow on work.  Not something for this PR.", "author": "keith-turner", "createdAt": "2020-04-02T14:47:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwNzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyMTYwNA==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r532621604", "bodyText": "I can't remember the entire idea I had to simplify the logic for this test. I looked over the existing test, and it seems fine as-is, but I did open #1815 to clean up some of the static stuff and EasyMock code a bit.", "author": "ctubbsii", "createdAt": "2020-11-30T14:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwNzIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM2NjM3Mw==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r402366373", "bodyText": "May be able to do the following.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      if (reservedPorts.keySet().contains(port)) {\n          \n          \n            \n                      if (reservedPorts.containsKey(port)) {", "author": "keith-turner", "createdAt": "2020-04-02T14:40:15Z", "path": "server/base/src/main/java/org/apache/accumulo/server/rpc/TServerUtils.java", "diffHunk": "@@ -168,10 +189,20 @@ public static ServerAddress startServer(MetricsSystem metricsSystem, ServerConte\n           addresses);\n     } catch (TTransportException e) {\n       if (portSearch) {\n+        // Build a list of reserved ports - as identified by properties of type PropertyType.PORT\n+        Map<Integer,Property> reservedPorts = getReservedPorts(config);\n+\n         HostAndPort last = addresses[addresses.length - 1];\n         // Attempt to allocate a port outside of the specified port property\n         // Search sequentially over the next 1000 ports\n         for (int port = last.getPort() + 1; port < last.getPort() + 1001; port++) {\n+          if (reservedPorts.keySet().contains(port)) {", "originalCommit": "df3f67c52b8cc7dc671f634470837edb2e0be7e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwOTc2MQ==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r402409761", "bodyText": "Will do! Allow me a few hours to add a commit and push this change.", "author": "arvindshmicrosoft", "createdAt": "2020-04-02T15:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM2NjM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyMTI5Mg==", "url": "https://github.com/apache/accumulo/pull/1575#discussion_r402421292", "bodyText": "I'm going to merge now. I can make this change subsequently.", "author": "ctubbsii", "createdAt": "2020-04-02T15:51:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM2NjM3Mw=="}], "type": "inlineReview"}]}