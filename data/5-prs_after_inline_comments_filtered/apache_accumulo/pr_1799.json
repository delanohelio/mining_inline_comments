{"pr_number": 1799, "pr_title": "Add getTabletState to TabletMetadata", "pr_createdAt": "2020-11-20T17:34:16Z", "pr_url": "https://github.com/apache/accumulo/pull/1799", "timeline": [{"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb", "url": "https://github.com/apache/accumulo/commit/f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb", "message": "Add getTabletState to TabletMetadata\n\n* Added suspend column to data that gets fetched\n* Dropped LAST column type and included it in LOCATION type so when any\nlocation gets fetched they all do\n* Added testLocationStates() to TabletMetadataTest", "committedDate": "2020-11-20T17:30:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg5NTk5MA==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528895990", "bodyText": "If there's any chance this is serialized, removing the enum changes the ordinals and could break things. Might be safer to mark it as deprecated and add a comment that it is no longer in use.", "author": "ctubbsii", "createdAt": "2020-11-23T18:00:43Z", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -98,11 +104,10 @@\n   }\n \n   public enum ColumnType {\n-    LOCATION,\n+    LOCATION, // includes all types in LocationType + SUSPEND\n     PREV_ROW,\n     OLD_PREV_ROW,\n     FILES,\n-    LAST,", "originalCommit": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwNzg2Mg==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528907862", "bodyText": "I don't think so.  This enum is used to tell the class what column families to fetch in the scanner created in TabletsMetadata.  There is also a check ensureFetched(ColumnType col) that is called on the get methods that will throw an error if you didn't fetch the column family associated with that type.", "author": "milleruntime", "createdAt": "2020-11-23T18:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg5NTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxNzIyMw==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528917223", "bodyText": "As long as it's just used internally, and never serialized or sent over the wire, it's fine.", "author": "ctubbsii", "createdAt": "2020-11-23T18:39:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg5NTk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxNzg0Ng==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528917846", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        families.add(TabletsSection.SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());\n          \n          \n            \n                        families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());", "author": "ctubbsii", "createdAt": "2020-11-23T18:40:04Z", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -163,15 +163,14 @@ public Options fetch(ColumnType... colsToFetch) {\n           case FLUSH_ID:\n             qualifiers.add(FLUSH_COLUMN);\n             break;\n-          case LAST:\n-            families.add(LastLocationColumnFamily.NAME);\n-            break;\n           case LOADED:\n             families.add(BulkFileColumnFamily.NAME);\n             break;\n           case LOCATION:\n             families.add(CurrentLocationColumnFamily.NAME);\n             families.add(FutureLocationColumnFamily.NAME);\n+            families.add(LastLocationColumnFamily.NAME);\n+            families.add(TabletsSection.SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());", "originalCommit": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAzODczNw==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r529038737", "bodyText": "I applied this suggestion manually to the case for SUSPEND.", "author": "milleruntime", "createdAt": "2020-11-23T22:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxNzg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxODg1Mw==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528918853", "bodyText": "This still looks like it's fetching the \"loc\" column. It might be more clear if this enum that refers to fetching all locations, was something like ALL_LOCATIONS", "author": "ctubbsii", "createdAt": "2020-11-23T18:41:49Z", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -190,10 +195,15 @@ public boolean hasCurrent() {\n   }\n \n   public Location getLast() {\n-    ensureFetched(ColumnType.LAST);\n+    ensureFetched(ColumnType.LOCATION);", "originalCommit": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkzMjcxMA==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528932710", "bodyText": "One of the issues is that there is a separate enum called LocationType that is used in the inner class Location to differentiate between the types. This doesn't really work with SuspendingTServer because it is its own special type.  I made an attempt to have SuspendingTServer extend the Location or TServerInstance types but it stores the suspension time with the host and port string in Value, differently from how we typically store the tserver host and port with the zk session id.\n\n  \n    \n      accumulo/core/src/main/java/org/apache/accumulo/core/metadata/SuspendingTServer.java\n    \n    \n         Line 45\n      in\n      cccac86\n    \n    \n    \n    \n\n        \n          \n           return new Value(tServer.getHostPort() + \"|\" + suspensionTime); \n        \n    \n  \n\n\nThen this is how TServerInstance is written:\n\n  \n    \n      accumulo/server/base/src/main/java/org/apache/accumulo/server/metadata/TabletMutatorBase.java\n    \n    \n        Lines 144 to 147\n      in\n      cccac86\n    \n    \n    \n    \n\n        \n          \n           public Ample.TabletMutator putLocation(TServerInstance tsi, LocationType type) { \n        \n\n        \n          \n             Preconditions.checkState(updatesEnabled, \"Cannot make updates after calling mutate.\"); \n        \n\n        \n          \n             mutation.put(getLocationFamily(type), tsi.getSession(), tsi.getHostPort()); \n        \n\n        \n          \n             return this;", "author": "milleruntime", "createdAt": "2020-11-23T19:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxODg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyMjA4OA==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528922088", "bodyText": "@ctubbsii I have a comment here.  I could rename it to ALL_LOCATIONS", "author": "milleruntime", "createdAt": "2020-11-23T18:47:50Z", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -98,11 +104,10 @@\n   }\n \n   public enum ColumnType {\n-    LOCATION,\n+    LOCATION, // includes all types in LocationType + SUSPEND", "originalCommit": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "03b0e954f3a8fd16e36f6064e5b0867739622f76", "url": "https://github.com/apache/accumulo/commit/03b0e954f3a8fd16e36f6064e5b0867739622f76", "message": "Updates from PR\n\n* Add SUSPEND ColumnType", "committedDate": "2020-11-23T21:53:46Z", "type": "commit"}, {"oid": "4dce7c9eab23ba15bdcbd7f1e382f45c8af35c87", "url": "https://github.com/apache/accumulo/commit/4dce7c9eab23ba15bdcbd7f1e382f45c8af35c87", "message": "format", "committedDate": "2020-11-23T22:31:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1NDgyNw==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r529054827", "bodyText": "This needs a break statement to avoid unintentional fall-through:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());\n          \n          \n            \n                        families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());\n          \n          \n            \n                        break;", "author": "ctubbsii", "createdAt": "2020-11-23T23:08:50Z", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -182,6 +183,8 @@ public Options fetch(ColumnType... colsToFetch) {\n           case SCANS:\n             families.add(ScanFileColumnFamily.NAME);\n             break;\n+          case SUSPEND:\n+            families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());", "originalCommit": "4dce7c9eab23ba15bdcbd7f1e382f45c8af35c87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU5NTI1Mg==", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r529595252", "bodyText": "Thanks good catch.", "author": "milleruntime", "createdAt": "2020-11-24T14:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1NDgyNw=="}], "type": "inlineReview"}, {"oid": "d22aaf90d80d93b1c57dad30c9629f7038a2da1c", "url": "https://github.com/apache/accumulo/commit/d22aaf90d80d93b1c57dad30c9629f7038a2da1c", "message": "Update core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java\n\nCo-authored-by: Christopher Tubbs <ctubbsii@apache.org>", "committedDate": "2020-11-24T14:40:32Z", "type": "commit"}]}