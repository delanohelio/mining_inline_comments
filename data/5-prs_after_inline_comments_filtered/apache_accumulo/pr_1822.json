{"pr_number": 1822, "pr_title": "Closes #1349 - Throw errors from Main instead of using System.exit()", "pr_createdAt": "2020-12-04T16:21:12Z", "pr_url": "https://github.com/apache/accumulo/pull/1822", "timeline": [{"oid": "590d64121fda123fdf5205d81dd1af69e216e972", "url": "https://github.com/apache/accumulo/commit/590d64121fda123fdf5205d81dd1af69e216e972", "message": "Closes #1349 - Throw errors from Main instead of using System.exit()", "committedDate": "2020-12-04T16:20:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUxNjI5NQ==", "url": "https://github.com/apache/accumulo/pull/1822#discussion_r536516295", "bodyText": "This one might actually be a legitimate use for System.exit(1), since the expectation here is that it scripts or users should see a non-zero return code, and that our usage information that we print is more useful than any ugly stack trace.", "author": "ctubbsii", "createdAt": "2020-12-05T05:14:08Z", "path": "start/src/main/java/org/apache/accumulo/start/Main.java", "diffHunk": "@@ -41,63 +41,57 @@\n   private static Class<?> vfsClassLoader;\n   private static Map<String,KeywordExecutable> servicesMap;\n \n-  public static void main(final String[] args) {\n+  public static void main(final String[] args) throws Exception {\n+    // Preload classes that cause a deadlock between the ServiceLoader and the DFSClient when\n+    // using the VFSClassLoader with jars in HDFS.\n+    ClassLoader loader = getClassLoader();\n+    Class<?> confClass = null;\n     try {\n-      // Preload classes that cause a deadlock between the ServiceLoader and the DFSClient when\n-      // using the VFSClassLoader with jars in HDFS.\n-      ClassLoader loader = getClassLoader();\n-      Class<?> confClass = null;\n-      try {\n-        @SuppressWarnings(\"deprecation\")\n-        var deprecatedConfClass = org.apache.accumulo.start.classloader.AccumuloClassLoader\n-            .getClassLoader().loadClass(\"org.apache.hadoop.conf.Configuration\");\n-        confClass = deprecatedConfClass;\n-      } catch (ClassNotFoundException e) {\n-        log.error(\"Unable to find Hadoop Configuration class on classpath, check configuration.\",\n-            e);\n-        System.exit(1);\n-      }\n-      Object conf = null;\n-      try {\n-        conf = confClass.getDeclaredConstructor().newInstance();\n-      } catch (Exception e) {\n-        log.error(\"Error creating new instance of Hadoop Configuration\", e);\n-        System.exit(1);\n-      }\n-      try {\n-        Method getClassByNameOrNullMethod =\n-            conf.getClass().getMethod(\"getClassByNameOrNull\", String.class);\n-        getClassByNameOrNullMethod.invoke(conf, \"org.apache.hadoop.mapred.JobConf\");\n-        getClassByNameOrNullMethod.invoke(conf, \"org.apache.hadoop.mapred.JobConfigurable\");\n-      } catch (Exception e) {\n-        log.error(\"Error pre-loading JobConf and JobConfigurable classes, VFS classloader with \"\n-            + \"system classes in HDFS may not work correctly\", e);\n-        System.exit(1);\n-      }\n-\n-      if (args.length == 0) {\n-        printUsage();\n-        System.exit(1);\n-      }\n-      if (args[0].equals(\"-h\") || args[0].equals(\"-help\") || args[0].equals(\"--help\")) {\n-        printUsage();\n-        System.exit(1);\n-      }\n+      @SuppressWarnings(\"deprecation\")\n+      var deprecatedConfClass = org.apache.accumulo.start.classloader.AccumuloClassLoader\n+          .getClassLoader().loadClass(\"org.apache.hadoop.conf.Configuration\");\n+      confClass = deprecatedConfClass;\n+    } catch (ClassNotFoundException e) {\n+      log.error(\"Unable to find Hadoop Configuration class on classpath, check configuration.\", e);\n+      throw e;\n+    }\n+    Object conf = null;\n+    try {\n+      conf = confClass.getDeclaredConstructor().newInstance();\n+    } catch (Exception e) {\n+      log.error(\"Error creating new instance of Hadoop Configuration\", e);\n+      throw e;\n+    }\n+    try {\n+      Method getClassByNameOrNullMethod =\n+          conf.getClass().getMethod(\"getClassByNameOrNull\", String.class);\n+      getClassByNameOrNullMethod.invoke(conf, \"org.apache.hadoop.mapred.JobConf\");\n+      getClassByNameOrNullMethod.invoke(conf, \"org.apache.hadoop.mapred.JobConfigurable\");\n+    } catch (Exception e) {\n+      log.error(\"Error pre-loading JobConf and JobConfigurable classes, VFS classloader with \"\n+          + \"system classes in HDFS may not work correctly\", e);\n+      throw e;\n+    }\n \n-      // determine whether a keyword was used or a class name, and execute it with the remaining\n-      // args\n-      String keywordOrClassName = args[0];\n-      KeywordExecutable keywordExec = getExecutables(loader).get(keywordOrClassName);\n-      if (keywordExec != null) {\n-        execKeyword(keywordExec, stripArgs(args, 1));\n-      } else {\n-        execMainClassName(keywordOrClassName, stripArgs(args, 1));\n-      }\n+    if (args.length == 0) {\n+      printUsage();\n+      throw new IllegalArgumentException(\"No arguments passed to Main\");", "originalCommit": "590d64121fda123fdf5205d81dd1af69e216e972", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "80b2444b5901c6b512458021c58e1dff32658277", "url": "https://github.com/apache/accumulo/commit/80b2444b5901c6b512458021c58e1dff32658277", "message": "re #1349 - Call System.exit() when no args passed to Main", "committedDate": "2020-12-14T15:35:05Z", "type": "commit"}, {"oid": "a5336f2d53ccc889981b4a5e15c5f27ba2a5d6aa", "url": "https://github.com/apache/accumulo/commit/a5336f2d53ccc889981b4a5e15c5f27ba2a5d6aa", "message": "Merge branch 'main' into 1349-throw-errors-from-main", "committedDate": "2020-12-14T15:36:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc1NTU2Nw==", "url": "https://github.com/apache/accumulo/pull/1822#discussion_r542755567", "bodyText": "Even though this is a legitimate use of exit, if we want consistency with the help options, we could just return without an exit code here as well. I'm fine either way, as long as we don't throw an exception here.", "author": "ctubbsii", "createdAt": "2020-12-14T20:37:22Z", "path": "start/src/main/java/org/apache/accumulo/start/Main.java", "diffHunk": "@@ -41,63 +41,57 @@\n   private static Class<?> vfsClassLoader;\n   private static Map<String,KeywordExecutable> servicesMap;\n \n-  public static void main(final String[] args) {\n+  public static void main(final String[] args) throws Exception {\n+    // Preload classes that cause a deadlock between the ServiceLoader and the DFSClient when\n+    // using the VFSClassLoader with jars in HDFS.\n+    ClassLoader loader = getClassLoader();\n+    Class<?> confClass = null;\n     try {\n-      // Preload classes that cause a deadlock between the ServiceLoader and the DFSClient when\n-      // using the VFSClassLoader with jars in HDFS.\n-      ClassLoader loader = getClassLoader();\n-      Class<?> confClass = null;\n-      try {\n-        @SuppressWarnings(\"deprecation\")\n-        var deprecatedConfClass = org.apache.accumulo.start.classloader.AccumuloClassLoader\n-            .getClassLoader().loadClass(\"org.apache.hadoop.conf.Configuration\");\n-        confClass = deprecatedConfClass;\n-      } catch (ClassNotFoundException e) {\n-        log.error(\"Unable to find Hadoop Configuration class on classpath, check configuration.\",\n-            e);\n-        System.exit(1);\n-      }\n-      Object conf = null;\n-      try {\n-        conf = confClass.getDeclaredConstructor().newInstance();\n-      } catch (Exception e) {\n-        log.error(\"Error creating new instance of Hadoop Configuration\", e);\n-        System.exit(1);\n-      }\n-      try {\n-        Method getClassByNameOrNullMethod =\n-            conf.getClass().getMethod(\"getClassByNameOrNull\", String.class);\n-        getClassByNameOrNullMethod.invoke(conf, \"org.apache.hadoop.mapred.JobConf\");\n-        getClassByNameOrNullMethod.invoke(conf, \"org.apache.hadoop.mapred.JobConfigurable\");\n-      } catch (Exception e) {\n-        log.error(\"Error pre-loading JobConf and JobConfigurable classes, VFS classloader with \"\n-            + \"system classes in HDFS may not work correctly\", e);\n-        System.exit(1);\n-      }\n-\n-      if (args.length == 0) {\n-        printUsage();\n-        System.exit(1);\n-      }\n-      if (args[0].equals(\"-h\") || args[0].equals(\"-help\") || args[0].equals(\"--help\")) {\n-        printUsage();\n-        System.exit(1);\n-      }\n-\n-      // determine whether a keyword was used or a class name, and execute it with the remaining\n-      // args\n-      String keywordOrClassName = args[0];\n-      KeywordExecutable keywordExec = getExecutables(loader).get(keywordOrClassName);\n-      if (keywordExec != null) {\n-        execKeyword(keywordExec, stripArgs(args, 1));\n-      } else {\n-        execMainClassName(keywordOrClassName, stripArgs(args, 1));\n-      }\n+      @SuppressWarnings(\"deprecation\")\n+      var deprecatedConfClass = org.apache.accumulo.start.classloader.AccumuloClassLoader\n+          .getClassLoader().loadClass(\"org.apache.hadoop.conf.Configuration\");\n+      confClass = deprecatedConfClass;\n+    } catch (ClassNotFoundException e) {\n+      log.error(\"Unable to find Hadoop Configuration class on classpath, check configuration.\", e);\n+      throw e;\n+    }\n+    Object conf = null;\n+    try {\n+      conf = confClass.getDeclaredConstructor().newInstance();\n+    } catch (Exception e) {\n+      log.error(\"Error creating new instance of Hadoop Configuration\", e);\n+      throw e;\n+    }\n+    try {\n+      Method getClassByNameOrNullMethod =\n+          conf.getClass().getMethod(\"getClassByNameOrNull\", String.class);\n+      getClassByNameOrNullMethod.invoke(conf, \"org.apache.hadoop.mapred.JobConf\");\n+      getClassByNameOrNullMethod.invoke(conf, \"org.apache.hadoop.mapred.JobConfigurable\");\n+    } catch (Exception e) {\n+      log.error(\"Error pre-loading JobConf and JobConfigurable classes, VFS classloader with \"\n+          + \"system classes in HDFS may not work correctly\", e);\n+      throw e;\n+    }\n \n-    } catch (Throwable t) {\n-      log.error(\"Uncaught exception\", t);\n+    if (args.length == 0) {\n+      printUsage();\n       System.exit(1);", "originalCommit": "a5336f2d53ccc889981b4a5e15c5f27ba2a5d6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc2NDk3Mg==", "url": "https://github.com/apache/accumulo/pull/1822#discussion_r542764972", "bodyText": "@dlmarion Not sure if you saw this comment. I made it after marking \"Approve\" on my last review. Feel free to mark this as \"resolved\" if you're fine with it as-is.", "author": "ctubbsii", "createdAt": "2020-12-14T20:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc1NTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc4ODkwMg==", "url": "https://github.com/apache/accumulo/pull/1822#discussion_r542788902", "bodyText": "I'm fine with it as is.", "author": "dlmarion", "createdAt": "2020-12-14T21:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc1NTU2Nw=="}], "type": "inlineReview"}]}