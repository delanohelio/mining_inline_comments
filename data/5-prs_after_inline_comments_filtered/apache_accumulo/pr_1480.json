{"pr_number": 1480, "pr_title": "Clean up tablet event logging #1316", "pr_createdAt": "2020-01-22T23:17:31Z", "pr_url": "https://github.com/apache/accumulo/pull/1480", "timeline": [{"oid": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "url": "https://github.com/apache/accumulo/commit/290e6fe8992ced471d98b19ac8a1002c05f98bef", "message": "Clean up tablet event logging #1316\n\nCentralized in code logging related to tablet files and location.\nRemoved and supressed redundant logging, with the goal of logging a\nsingle message for an event like assignment or compaction.", "committedDate": "2020-01-22T23:13:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2NTY2NA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370165664", "bodyText": "Is there a specific reason for having a method for every message?  I think this class could be written differently so it is more generic and not all hard coded methods.  An enum comes to mind for something like LogType.  Or even something as simple as making the Loggers all public static so there is no need for a method for every different log message.  Then you could just call TabletLogger.locLog.debug(\"Assigned {} to {}\", extent, server);\nI have a feeling, these static methods were intentional for say, log message consistency so perhaps document that if the case.", "author": "milleruntime", "createdAt": "2020-01-23T14:55:55Z", "path": "core/src/main/java/org/apache/accumulo/core/logging/TabletLogger.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.accumulo.core.logging;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.accumulo.core.dataImpl.KeyExtent;\n+import org.apache.accumulo.core.metadata.schema.Ample;\n+import org.apache.accumulo.core.tabletserver.log.LogEntry;\n+import org.apache.accumulo.core.util.HostAndPort;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// logs messages about a tablets internal state, like its location, set of files, metadata... operations that cut across multiple tablets should go elsewhere\n+public class TabletLogger {", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIwMDg2NQ==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370200865", "bodyText": "The reason I did that was to bring the code into a single place so that user could see it.  This would also make it easy to diff the changes in log messages between releases of Accumulo.  Users use tools to parse log messages from Accumumulo, I am hoping this organization of the code will make that use case easier.  I can add package level javadoc explaining this.", "author": "keith-turner", "createdAt": "2020-01-23T15:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2NTY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NjI5Nw==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370766297", "bodyText": "Attempted to clarify this in 2fea1a6", "author": "keith-turner", "createdAt": "2020-01-24T18:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2NTY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2Njg3Nw==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370166877", "bodyText": "Should describe what this class is doing.", "author": "milleruntime", "createdAt": "2020-01-23T14:57:49Z", "path": "server/base/src/main/java/org/apache/accumulo/server/master/state/LoggingTabletStateStore.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.server.master.state;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.accumulo.core.logging.TabletLogger;\n+import org.apache.hadoop.fs.Path;\n+\n+class LoggingTabletStateStore implements TabletStateStore {", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4MjI1Ng==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r375582256", "bodyText": "Documented in 46de4c6", "author": "keith-turner", "createdAt": "2020-02-06T00:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2Njg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3MDE5Ng==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370170196", "bodyText": "All the public and abstract modifiers could be dropped now that this is an interface.  Also, should update the javadac or just simplify since it will be inaccurate... like move the descriptions to their appropriate class.", "author": "milleruntime", "createdAt": "2020-01-23T15:03:05Z", "path": "server/base/src/main/java/org/apache/accumulo/server/master/state/TabletStateStore.java", "diffHunk": "@@ -33,7 +35,7 @@\n  * ZooTabletStateStore: information about the root tablet is stored in ZooKeeper MetaDataStateStore:\n  * information about the other tablets are stored in the metadata table\n  */\n-public abstract class TabletStateStore implements Iterable<TabletLocationState> {\n+public interface TabletStateStore extends Iterable<TabletLocationState> {", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4NTIzOA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r375585238", "bodyText": "done in 6f568b4", "author": "keith-turner", "createdAt": "2020-02-06T00:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3MDE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3NjA0MQ==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370176041", "bodyText": "This change will be great for consolidating or dropping stuff like this.", "author": "milleruntime", "createdAt": "2020-01-23T15:12:31Z", "path": "server/master/src/main/java/org/apache/accumulo/master/TabletGroupWatcher.java", "diffHunk": "@@ -99,8 +100,6 @@\n \n abstract class TabletGroupWatcher extends Daemon {\n   // Constants used to make sure assignment logging isn't excessive in quantity or size\n-  private static final String ASSIGNMENT_BUFFER_SEPARATOR = \", \";\n-  private static final int ASSIGNMENT_BUFFER_MAX_LENGTH = 4096;\n ", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NzkxMA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370187910", "bodyText": "Might not need this method if you just do the check in the wal log method.", "author": "milleruntime", "createdAt": "2020-01-23T15:30:37Z", "path": "core/src/main/java/org/apache/accumulo/core/logging/TabletLogger.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.accumulo.core.logging;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.accumulo.core.dataImpl.KeyExtent;\n+import org.apache.accumulo.core.metadata.schema.Ample;\n+import org.apache.accumulo.core.tabletserver.log.LogEntry;\n+import org.apache.accumulo.core.util.HostAndPort;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// logs messages about a tablets internal state, like its location, set of files, metadata... operations that cut across multiple tablets should go elsewhere\n+public class TabletLogger {\n+\n+  private static final String PREFIX = Logging.PREFIX + \"tablet.\";\n+\n+  private static final Logger locLog = LoggerFactory.getLogger(PREFIX + \"location\");\n+  private static final Logger fileLog = LoggerFactory.getLogger(PREFIX + \"files\");\n+  private static final Logger recoveryLog = LoggerFactory.getLogger(PREFIX + \"recovery\");\n+  private static final Logger walsLog = LoggerFactory.getLogger(PREFIX + \"wals\");\n+\n+  /**\n+   * A decision was made to assign a tablet to a tablet server process. Accumulo will stick to this\n+   * decision until the tablet server loads the tablet or dies.\n+   */\n+  public static void assigned(KeyExtent extent, Ample.TServer server) {\n+    locLog.debug(\"Assigned {} to {}\", extent, server);\n+  }\n+\n+  /**\n+   * A tablet server has received an assignment message from master and queued the tablet for\n+   * loading.\n+   */\n+  public static void loading(KeyExtent extent, Ample.TServer server) {\n+    locLog.debug(\"Loading {} on {}\", extent, server);\n+  }\n+\n+  public static void suspended(KeyExtent extent, HostAndPort server, long time, TimeUnit timeUnit,\n+      int numWalogs) {\n+    locLog.debug(\"Suspended {} to {} at {} ms with {} walogs\", extent, server,\n+        timeUnit.toMillis(time), numWalogs);\n+  }\n+\n+  public static void unsuspended(KeyExtent extent) {\n+    locLog.debug(\"Unsuspended \" + extent);\n+  }\n+\n+  public static void loaded(KeyExtent extent, Ample.TServer server) {\n+    locLog.debug(\"Loaded {} on {}\", extent, server);\n+  }\n+\n+  public static void unassigned(KeyExtent extent, int logCount) {\n+    locLog.debug(\"Unassigned {} with {} walogs\", extent, logCount);\n+  }\n+\n+  public static void split(KeyExtent parent, KeyExtent lowChild, KeyExtent highChild,\n+      Ample.TServer server) {\n+    locLog.debug(\"Split {} into {} and {} on {}\", parent, lowChild, highChild, server);\n+  }\n+\n+  /**\n+   * Called when a tablet's current assignment state does not match the goal state.\n+   */\n+  public static void missassigned(KeyExtent extent, String goalState, String currentState,\n+      Ample.TServer future, Ample.TServer current, int walogs) {\n+    // usually this is only called when the states are not equal, but for the root tablet this\n+    // method is currently always called\n+    if (!goalState.equals(currentState)) {\n+      locLog.trace(\"Miss-assigned {} goal:{} current:{} future:{} location:{} walogs:{}\", extent,\n+          goalState, currentState, future, current, walogs);\n+    }\n+  }\n+\n+  public static void compacted(KeyExtent extent, Collection<? extends Ample.FileMeta> inputs,\n+      Ample.FileMeta output) {\n+    fileLog.debug(\"Compacted {} created {} from {}\", extent, output, inputs);\n+  }\n+\n+  public static void flushed(KeyExtent extent, Ample.FileMeta absMergeFile,\n+      Ample.FileMeta newDatafile) {\n+    if (absMergeFile == null)\n+      fileLog.debug(\"Flushed {} created {} from [memory]\", extent, newDatafile);\n+    else\n+      fileLog.debug(\"Flushed {} created {} from [memory,{}]\", extent, newDatafile, absMergeFile);\n+  }\n+\n+  public static void bulkImported(KeyExtent extent, Ample.FileMeta file) {\n+    fileLog.debug(\"Imported {} {}  \", extent, file);\n+  }\n+\n+  public static void recovering(KeyExtent extent, List<LogEntry> logEntries) {\n+    if (recoveryLog.isDebugEnabled()) {\n+      List<String> logIds = logEntries.stream().map(LogEntry::getUniqueID).collect(toList());\n+      recoveryLog.debug(\"For {} recovering data from walogs: {}\", extent, logIds);\n+    }\n+  }\n+\n+  public static void recovered(KeyExtent extent, List<LogEntry> logEntries, long numMutation,\n+      long numEntries) {\n+    recoveryLog.info(\"For {} recovered {} mutations creating {} entries from {} walogs\", extent,\n+        numMutation, numEntries, logEntries.size());\n+  }\n+\n+  public static boolean isWalRefLoggingEnabled() {", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxMjg2OQ==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370412869", "bodyText": "That's certainly possible with just the one use of the method in this PR. If more complex checks were needed, you might still want to wrap the logger state check with a more descriptive/logical state check, so you don't have to leak the logger outside this class.\nIf such a check were necessary in other, more complex cases than what is in this PR, you might be able to do something with a lambda to avoid unnecessary work if trace logging is disabled.", "author": "ctubbsii", "createdAt": "2020-01-23T23:43:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NzkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyNDE5NA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370424194", "bodyText": "I was trying to avoid an expensive computation if tracing was disabled.  I did try using a lambda, but it made the code more complex.  I went with this because I thought it was easier to read.", "author": "keith-turner", "createdAt": "2020-01-24T00:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NzkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM2MTQ5OA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370361498", "bodyText": "\"logs\" here is either redundant (if it refers to the fact that this is a log message), or ambiguous (if it refers to WAL or some other kind of logging).\nIs the intent to have this used for specific kinds of logs, or replace all Accumulo logging? If it is the former, the name might need to be more specific to reflect the category of logs it represents.", "author": "ctubbsii", "createdAt": "2020-01-23T21:23:09Z", "path": "core/src/main/java/org/apache/accumulo/core/logging/Logging.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.accumulo.core.logging;\n+\n+public class Logging {\n+  public static final String PREFIX = \"org.apache.accumulo.logs.\";", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM3NzkzMA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370377930", "bodyText": "My goal is to apply a logical structure to logging namespace based on function that cross cuts lots of code, allowing easily adjusting log levels based on function by users.  Also, centralizing important log messages in the source code makes it easier for user interested in automatic parsing of log messages to track changes. I don't think all logs would go here.\nFor the name, I was thinking org.apache.accumulo.logs. would be the prefix for everything in this logical logging namespace.  Under it would have things like org.apache.accumulo.logs.fate, org.apache.accumulo.logs.metadata, org.apache.accumulo.logs.tablet, etc.\nAt first I tried using something like accumulo.tablet for the logical namepsace, but I found this annoying when I tried to turn on debug logging for Accumulo because I had to set two things in the log4j config (log4j.logger.org.apache.accumulo=DEBUG and log4j.logger.accumulo=DEBUG).  Based on this I decided it would be nice to share the prefix org.apache.accumulo  with class loggers, but then add something that is different than all existing packages.  Any suggestions for the namespace prefix would be appreciated.", "author": "keith-turner", "createdAt": "2020-01-23T22:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM2MTQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwNzM4NA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370407384", "bodyText": "I like the idea of logical logging, but I don't think we need a global prefix for it to separate it from code-based logging with a separate namespace. It's probably better to just remove the .logs part of the prefix. Over time, more logging should be logical and less code-based, so the question is moot in the long term (because org.apache.accumulo will eventually be the top-level logical logging prefix), and unless there's a conflict, it's not really an issue in the short-term. Using just org.apache.accumulo as the prefix aligns with the current practice of using org.apache.accumulo.audit as the logical logging prefix for auditing.\nI'm fine with sticking to the fully-qualified org.apache.accumulo prefix rather than the more abbreviated accumulo one.", "author": "ctubbsii", "createdAt": "2020-01-23T23:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM2MTQ5OA=="}], "type": "inlineReview"}, {"oid": "151c7e714993cd930cea6e91c981e23e733dfa15", "url": "https://github.com/apache/accumulo/commit/151c7e714993cd930cea6e91c981e23e733dfa15", "message": "remove .logs from prefix", "committedDate": "2020-01-23T23:35:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwODQxNQ==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370408415", "bodyText": "You went with explicit names, rather than brevity (location instead of loc), for all of these except wals. It'd might be good to try to be consistent here by selecting a more explicit name, like writeaheadlogs or compromise with walogs.", "author": "ctubbsii", "createdAt": "2020-01-23T23:27:16Z", "path": "core/src/main/java/org/apache/accumulo/core/logging/TabletLogger.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.accumulo.core.logging;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.accumulo.core.dataImpl.KeyExtent;\n+import org.apache.accumulo.core.metadata.schema.Ample;\n+import org.apache.accumulo.core.tabletserver.log.LogEntry;\n+import org.apache.accumulo.core.util.HostAndPort;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// logs messages about a tablets internal state, like its location, set of files, metadata... operations that cut across multiple tablets should go elsewhere\n+public class TabletLogger {\n+\n+  private static final String PREFIX = Logging.PREFIX + \"tablet.\";\n+\n+  private static final Logger locLog = LoggerFactory.getLogger(PREFIX + \"location\");\n+  private static final Logger fileLog = LoggerFactory.getLogger(PREFIX + \"files\");\n+  private static final Logger recoveryLog = LoggerFactory.getLogger(PREFIX + \"recovery\");\n+  private static final Logger walsLog = LoggerFactory.getLogger(PREFIX + \"wals\");", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4NTU5NQ==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r375585595", "bodyText": "Done in 2fea1a6", "author": "keith-turner", "createdAt": "2020-02-06T00:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwODQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwODYyMQ==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370408621", "bodyText": "For all those messages with a KeyExtent, it might be good to put the KeyExtent in the same position in each message, in a more structured way, so it's easier to parse out by log analyzers.\nFor example, any of these:\nlocLog.debug(\"Assigned tablet to server; server={}, tablet={}\", server, extent); // description with named params\nlocLog.debug(\"action=assignment; server={}, tablet={}\", server, extent); // all named params\nlocLog.debug(\"{} assigned to server {}\", extent, server); // KeyExtent always first strategy\nlocLog.debug(\"Tablet({}) assigned to server {}\", extent, server); // KeyExtent always first strategy, with descriptive structure", "author": "ctubbsii", "createdAt": "2020-01-23T23:28:02Z", "path": "core/src/main/java/org/apache/accumulo/core/logging/TabletLogger.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.accumulo.core.logging;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.accumulo.core.dataImpl.KeyExtent;\n+import org.apache.accumulo.core.metadata.schema.Ample;\n+import org.apache.accumulo.core.tabletserver.log.LogEntry;\n+import org.apache.accumulo.core.util.HostAndPort;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// logs messages about a tablets internal state, like its location, set of files, metadata... operations that cut across multiple tablets should go elsewhere\n+public class TabletLogger {\n+\n+  private static final String PREFIX = Logging.PREFIX + \"tablet.\";\n+\n+  private static final Logger locLog = LoggerFactory.getLogger(PREFIX + \"location\");\n+  private static final Logger fileLog = LoggerFactory.getLogger(PREFIX + \"files\");\n+  private static final Logger recoveryLog = LoggerFactory.getLogger(PREFIX + \"recovery\");\n+  private static final Logger walsLog = LoggerFactory.getLogger(PREFIX + \"wals\");\n+\n+  /**\n+   * A decision was made to assign a tablet to a tablet server process. Accumulo will stick to this\n+   * decision until the tablet server loads the tablet or dies.\n+   */\n+  public static void assigned(KeyExtent extent, Ample.TServer server) {\n+    locLog.debug(\"Assigned {} to {}\", extent, server);", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyNzkyMA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370427920", "bodyText": "I would like to experiment with creating grok patterns to parse these messages and use that experience to refine the messages.  Not sure I will get around to that.", "author": "keith-turner", "createdAt": "2020-01-24T00:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwODYyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4MjUzMQ==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370882531", "bodyText": "If the messages are relatively easily parseable with something like LogStash grok patterns, I think it's fine to keep the messages more human-readable. As long as thought is put in to avoid making them too difficult to parse with automation, I'm fine with whatever messages you use.", "author": "ctubbsii", "createdAt": "2020-01-24T23:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwODYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxMzkzNA==", "url": "https://github.com/apache/accumulo/pull/1480#discussion_r370413934", "bodyText": "This change makes Ample look even more like it's precurser, MetadataServicer. Ample.of(...) is precisely analogous to MetadataServicer.forTableId(...). \ud83d\ude3a\nOne item on my personal wish list (if I ever get time) is to combine these, taking the best of each, and putting them into one.", "author": "ctubbsii", "createdAt": "2020-01-23T23:47:17Z", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/Ample.java", "diffHunk": "@@ -95,6 +95,16 @@ public TableId tableId() {\n         throw new UnsupportedOperationException();\n       return id;\n     }\n+\n+    public static DataLevel of(TableId tableId) {\n+      if (tableId.equals(RootTable.ID)) {\n+        return DataLevel.ROOT;\n+      } else if (tableId.equals(MetadataTable.ID)) {\n+        return DataLevel.METADATA;\n+      } else {\n+        return DataLevel.USER;\n+      }\n+    }", "originalCommit": "290e6fe8992ced471d98b19ac8a1002c05f98bef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2fea1a65f31916f327cebf6e7804ad95474cd40b", "url": "https://github.com/apache/accumulo/commit/2fea1a65f31916f327cebf6e7804ad95474cd40b", "message": "Attempt to document raison d'\u00eatre", "committedDate": "2020-01-24T18:00:21Z", "type": "commit"}, {"oid": "2fea1a65f31916f327cebf6e7804ad95474cd40b", "url": "https://github.com/apache/accumulo/commit/2fea1a65f31916f327cebf6e7804ad95474cd40b", "message": "Attempt to document raison d'\u00eatre", "committedDate": "2020-01-24T18:00:21Z", "type": "forcePushed"}, {"oid": "46de4c6e5cc084694d7c45dac75dd8bec36f8f5d", "url": "https://github.com/apache/accumulo/commit/46de4c6e5cc084694d7c45dac75dd8bec36f8f5d", "message": "Update LoggingTabletStateStore.java", "committedDate": "2020-02-06T00:21:27Z", "type": "commit"}, {"oid": "6f568b4430a9da5f9c8084e76ccd81191aad9360", "url": "https://github.com/apache/accumulo/commit/6f568b4430a9da5f9c8084e76ccd81191aad9360", "message": "Update TabletStateStore.java", "committedDate": "2020-02-06T00:26:26Z", "type": "commit"}, {"oid": "f82d10fe2d9cab817dd5655b2f9096a5627f5b6e", "url": "https://github.com/apache/accumulo/commit/f82d10fe2d9cab817dd5655b2f9096a5627f5b6e", "message": "format code", "committedDate": "2020-02-06T00:30:44Z", "type": "commit"}, {"oid": "fe31b1e9b13ec4249104d42acbfe228bbe1a8e54", "url": "https://github.com/apache/accumulo/commit/fe31b1e9b13ec4249104d42acbfe228bbe1a8e54", "message": "Merge branch 'master' into accumulo-1316-tablets", "committedDate": "2020-02-06T21:23:08Z", "type": "commit"}]}