{"pr_number": 255, "pr_title": "Introduce separate thread pool for establishing Initiator connections", "pr_createdAt": "2020-01-07T14:38:06Z", "pr_url": "https://github.com/quickfix-j/quickfixj/pull/255", "timeline": [{"oid": "0e0554615185b199d1223dfaca6da2c6cf1ae208", "url": "https://github.com/quickfix-j/quickfixj/commit/0e0554615185b199d1223dfaca6da2c6cf1ae208", "message": "Introduce separate thread pool for establishing Initiator connections\n\n * Fixes #254\n * introduced separate thread pool with 3 threads for connection establishment\n * changed `enabled` flag in `Session` to `volatile` and removed synchronization from `setEnabled`/`isEnabled` since I could not find any good reason why it was synchronized\n ** `volatile` should ensure that all threads should see the current state and prevents possible deadlocks now that flag is checked from distinct threads\n * removed `synchronized` from `IoSessionInitiator.ConnectTask.run()` since I could not find any good reason why it was synchronized", "committedDate": "2020-01-07T14:30:39Z", "type": "commit"}, {"oid": "f5e050c907decfdb0bfc27c6be21e9834a7ff59a", "url": "https://github.com/quickfix-j/quickfixj/commit/f5e050c907decfdb0bfc27c6be21e9834a7ff59a", "message": "whitespace change\n\nto test LGTM check", "committedDate": "2020-01-10T15:04:30Z", "type": "commit"}, {"oid": "f2514215391f64527cff5537a63b243bf88a0c26", "url": "https://github.com/quickfix-j/quickfixj/commit/f2514215391f64527cff5537a63b243bf88a0c26", "message": "fixed typo", "committedDate": "2020-04-05T21:57:59Z", "type": "commit"}, {"oid": "2c4b2b5672ca050272e64e3aab847f80fa599728", "url": "https://github.com/quickfix-j/quickfixj/commit/2c4b2b5672ca050272e64e3aab847f80fa599728", "message": "Merge branch 'connection-timeout-254' of https://github.com/quickfix-j/quickfixj into connection-timeout-254", "committedDate": "2020-04-05T22:08:15Z", "type": "commit"}, {"oid": "8b635cd64fe869681d72821af6418b5cf41a917a", "url": "https://github.com/quickfix-j/quickfixj/commit/8b635cd64fe869681d72821af6418b5cf41a917a", "message": " - prevent NPE on Logon in Session when not specifying messageFactory in\nAbstractSessionConnectorBuilder", "committedDate": "2020-04-07T13:16:02Z", "type": "commit"}, {"oid": "d55caffc5c8561cf37572f61d6f8b8032feea960", "url": "https://github.com/quickfix-j/quickfixj/commit/d55caffc5c8561cf37572f61d6f8b8032feea960", "message": " - added possibility to specify number of reconnect threads via builder\n - by default 3 threads are used\n - changed executor to be non-static, i.e. each Initiator instance has its own reconnect thread pool\n  - (unless feature is disabled which will use the former behaviour)\n  - to use the former behaviour (i.e. use \"QFJ Timer\" thread for both reconnections and calls to next()) you should pass 0 as number of reconnect threads\n - when passing 1 you will end up with a separate thread for reconnections; next() will still be called by \"QFJ Timer\" thread", "committedDate": "2020-04-08T21:02:06Z", "type": "commit"}, {"oid": "7e1e5348607661464fd7b2a33ae5723a115b4e1d", "url": "https://github.com/quickfix-j/quickfixj/commit/7e1e5348607661464fd7b2a33ae5723a115b4e1d", "message": "minor formatting", "committedDate": "2020-04-08T21:05:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE1MjQzNQ==", "url": "https://github.com/quickfix-j/quickfixj/pull/255#discussion_r416152435", "bodyText": "Setting maximumPoolSize to initialPoolSize ensures that numReconnectThreads threads are available to service tasks. Otherwise new threads only get created when the task queue is full.", "author": "chrjohn", "createdAt": "2020-04-27T21:12:31Z", "path": "quickfixj-core/src/main/java/quickfix/mina/initiator/AbstractSocketInitiator.java", "diffHunk": "@@ -69,9 +76,27 @@ protected AbstractSocketInitiator(Application application,\n \n     protected AbstractSocketInitiator(SessionSettings settings, SessionFactory sessionFactory)\n             throws ConfigError {\n+        this(settings, sessionFactory, 0);\n+    }\n+\n+    protected AbstractSocketInitiator(Application application,\n+            MessageStoreFactory messageStoreFactory, SessionSettings settings,\n+            LogFactory logFactory, MessageFactory messageFactory, int numReconnectThreads) throws ConfigError {\n+        this(settings, new DefaultSessionFactory(application, messageStoreFactory, logFactory,\n+                messageFactory), numReconnectThreads);\n+    }\n+\n+    protected AbstractSocketInitiator(SessionSettings settings, SessionFactory sessionFactory, int numReconnectThreads)\n+            throws ConfigError {\n         super(settings, sessionFactory);\n         IoBuffer.setAllocator(new SimpleBufferAllocator());\n         IoBuffer.setUseDirectBuffer(false);\n+        if (numReconnectThreads > 0) {\n+            scheduledReconnectExecutor = Executors.newScheduledThreadPool(numReconnectThreads, new QFScheduledReconnectThreadFactory());\n+            ((ThreadPoolExecutor) scheduledReconnectExecutor).setMaximumPoolSize(numReconnectThreads);", "originalCommit": "7e1e5348607661464fd7b2a33ae5723a115b4e1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0Mjg2OA==", "url": "https://github.com/quickfix-j/quickfixj/pull/255#discussion_r424542868", "bodyText": "Not directly related to this change, but we probably don't want to queue up timer tasks if they take too long for some reason.\n\n  \n    \n      quickfixj/quickfixj-core/src/main/java/quickfix/mina/initiator/IoSessionInitiator.java\n    \n    \n         Line 364\n      in\n      e53d41b\n    \n    \n    \n    \n\n        \n          \n           .scheduleWithFixedDelay(reconnectTask, 0, 1, TimeUnit.SECONDS);", "author": "the-thing", "createdAt": "2020-05-13T15:46:50Z", "path": "quickfixj-core/src/main/java/quickfix/mina/SessionConnector.java", "diffHunk": "@@ -318,7 +318,7 @@ protected void startSessionTimer() {\n         if (shortLivedExecutor != null) {\n             timerTask = new DelegatingTask(timerTask, shortLivedExecutor);\n         }\n-        sessionTimerFuture = scheduledExecutorService.scheduleAtFixedRate(timerTask, 0, 1000L,\n+        sessionTimerFuture = SCHEDULED_EXECUTOR.scheduleAtFixedRate(timerTask, 0, 1000L,", "originalCommit": "7e1e5348607661464fd7b2a33ae5723a115b4e1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY1MzY0MQ==", "url": "https://github.com/quickfix-j/quickfixj/pull/255#discussion_r436653641", "bodyText": "The reconnectTasks timed out after a maximum of 2000ms. That was the reason to have a bigger pool to service these requests, see #254 .\nWhat do you suggest to prevent piling up these tasks?", "author": "chrjohn", "createdAt": "2020-06-08T12:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0Mjg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcxMTkwNA==", "url": "https://github.com/quickfix-j/quickfixj/pull/255#discussion_r436711904", "bodyText": "Similar to IoSessionInitiator. As a rule of thumb scheduleWithFixedDelay is better in majority of cases than scheduleAtFixedRate. It respects the delay, but it only reschedules when the tasks finishes - this does not allow bursts if for some reason task is slow.", "author": "the-thing", "createdAt": "2020-06-08T13:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0Mjg2OA=="}], "type": "inlineReview"}]}