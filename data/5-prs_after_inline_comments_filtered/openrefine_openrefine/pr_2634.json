{"pr_number": 2634, "pr_title": "Add difference-within-range Scrutinizer", "pr_createdAt": "2020-05-22T17:15:39Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/2634", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MDgyMg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429570822", "bodyText": "It would be good to mention that this is used by the difference between range constraint (otherwise one might think this is for another constraint).", "author": "wetneb", "createdAt": "2020-05-23T19:11:35Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/qa/ConstraintFetcher.java", "diffHunk": "@@ -134,4 +135,35 @@\n      * Can this property be used on items?\n      */\n     boolean usableOnItems(PropertyIdValue pid);\n+\n+    /**\n+     * Retrieves the minimum difference value of the range", "originalCommit": "3db2a11a4d2abc63deb0418a2e3691e3a5f40abb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5NTI2OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429595269", "bodyText": "Sure.", "author": "darecoder", "createdAt": "2020-05-24T03:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MDgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MDgzMA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429570830", "bodyText": "Same here.", "author": "wetneb", "createdAt": "2020-05-23T19:11:43Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/qa/ConstraintFetcher.java", "diffHunk": "@@ -134,4 +135,35 @@\n      * Can this property be used on items?\n      */\n     boolean usableOnItems(PropertyIdValue pid);\n+\n+    /**\n+     * Retrieves the minimum difference value of the range\n+     *\n+     * @param pid\n+     * @return minimum value\n+     */\n+    QuantityValue getMinimumValue(PropertyIdValue pid);\n+\n+    /**\n+     * Retrieves the maximum difference value of the range", "originalCommit": "3db2a11a4d2abc63deb0418a2e3691e3a5f40abb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTIxMw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429571213", "bodyText": "We should handle the case where only some of these parameters have been defined: we should make sure we do not fail with a null pointer exception, for instance\u2026", "author": "wetneb", "createdAt": "2020-05-23T19:17:42Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/qa/scrutinizers/DifferenceWithinRangeScrutinizer.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.openrefine.wikidata.qa.scrutinizers;\n+\n+import org.openrefine.wikidata.qa.QAWarning;\n+import org.openrefine.wikidata.updates.ItemUpdate;\n+import org.wikidata.wdtk.datamodel.interfaces.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class DifferenceWithinRangeScrutinizer extends EditScrutinizer {\n+\n+    public static final String type = \"difference-of-the-properties-is-not-within-the-specified-range\";\n+\n+    @Override\n+    public void scrutinize(ItemUpdate update) {\n+        Map<PropertyIdValue, Value> propertyIdValueValueMap = new HashMap<>();\n+        for (Statement statement : update.getAddedStatements()){\n+            PropertyIdValue pid = statement.getClaim().getMainSnak().getPropertyId();\n+            Value value = statement.getClaim().getMainSnak().getValue();\n+            propertyIdValueValueMap.put(pid, value);\n+        }\n+\n+        for(PropertyIdValue propertyId : propertyIdValueValueMap.keySet()){\n+            if (_fetcher.hasDiffWithinRange(propertyId)){\n+                PropertyIdValue lowerPropertyId = _fetcher.getLowerPropertyId(propertyId);\n+                QuantityValue minRangeValue = _fetcher.getMinimumValue(propertyId);\n+                QuantityValue maxRangeValue = _fetcher.getMaximumValue(propertyId);", "originalCommit": "3db2a11a4d2abc63deb0418a2e3691e3a5f40abb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5NTE1Ng==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429595156", "bodyText": "When I went through the docs It was mentioned that these are mandatory parameters for the constraint. Therefore, I didn't add the conditions. If you say so, I'll add those checks.", "author": "darecoder", "createdAt": "2020-05-24T03:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYwMzg3Mg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429603872", "bodyText": "They are mandatory indeed, but there is nothing preventing users from not adding them to the constraint definition.", "author": "wetneb", "createdAt": "2020-05-24T06:25:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxMDMyMw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429610323", "bodyText": "Done!", "author": "darecoder", "createdAt": "2020-05-24T08:01:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI1Ng==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429571256", "bodyText": "This constraint might also be used on quantities: it would be good to support that case too.", "author": "wetneb", "createdAt": "2020-05-23T19:18:09Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/qa/scrutinizers/DifferenceWithinRangeScrutinizer.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.openrefine.wikidata.qa.scrutinizers;\n+\n+import org.openrefine.wikidata.qa.QAWarning;\n+import org.openrefine.wikidata.updates.ItemUpdate;\n+import org.wikidata.wdtk.datamodel.interfaces.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class DifferenceWithinRangeScrutinizer extends EditScrutinizer {\n+\n+    public static final String type = \"difference-of-the-properties-is-not-within-the-specified-range\";\n+\n+    @Override\n+    public void scrutinize(ItemUpdate update) {\n+        Map<PropertyIdValue, Value> propertyIdValueValueMap = new HashMap<>();\n+        for (Statement statement : update.getAddedStatements()){\n+            PropertyIdValue pid = statement.getClaim().getMainSnak().getPropertyId();\n+            Value value = statement.getClaim().getMainSnak().getValue();\n+            propertyIdValueValueMap.put(pid, value);\n+        }\n+\n+        for(PropertyIdValue propertyId : propertyIdValueValueMap.keySet()){\n+            if (_fetcher.hasDiffWithinRange(propertyId)){\n+                PropertyIdValue lowerPropertyId = _fetcher.getLowerPropertyId(propertyId);\n+                QuantityValue minRangeValue = _fetcher.getMinimumValue(propertyId);\n+                QuantityValue maxRangeValue = _fetcher.getMaximumValue(propertyId);\n+\n+                if (propertyIdValueValueMap.containsKey(lowerPropertyId)){\n+                    Value startingValue = propertyIdValueValueMap.get(lowerPropertyId);\n+                    Value endingValue = propertyIdValueValueMap.get(propertyId);\n+\n+                    if (startingValue instanceof TimeValue && endingValue instanceof TimeValue){", "originalCommit": "3db2a11a4d2abc63deb0418a2e3691e3a5f40abb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5NTkyOQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429595929", "bodyText": "I took a look at the uses of this constraint, and all of them are for date & year. Therefore, I made this specific condition for TimeValue only.\nIf there are chances to use this constraint on other quantities then should I make a different class extending this one for TimeValue and so on for other quantities?", "author": "darecoder", "createdAt": "2020-05-24T03:36:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYwNDAwMw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429604003", "bodyText": "Good question. Perhaps it is worth checking the code of WikibaseQualityConstraints to see how it was implemented there (perhaps quantities are not supported indeed!)\nhttps://github.com/wikimedia/mediawiki-extensions-WikibaseQualityConstraints", "author": "wetneb", "createdAt": "2020-05-24T06:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxMDE0NA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429610144", "bodyText": "I checked their implementation, quantities are not really supported over there too", "author": "darecoder", "createdAt": "2020-05-24T07:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk1MDM1NQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r432950355", "bodyText": "Apparently they are actually supported! :) but we can merge this without full support, so we can focus on the architecture changes.", "author": "wetneb", "createdAt": "2020-05-31T14:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk1MjYxNg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r432952616", "bodyText": "Yes, they do.  I'm trying to implement something similar to rangeCheckerHelper and UnitsConverter. Once it gets implemented very well and validated I'll update the PR. implementing these kinds of classes will provide a good help in range constraints too. :)", "author": "darecoder", "createdAt": "2020-05-31T14:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI2Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429571263", "bodyText": "I think this would be cleaner if we first compute the difference between the two values, in some unit, and then compare it to the bounds supplied in the constraint.\nAlso, it is not clear to me how this works in the Wikibase implementation, but I think the constraint system automatically converts units: differences can be specified in any unit, as far as I can tell.\nSee the official docs:\n\nWikibaseQualityConstraints normalizes the range endpoints before checking this constraint; for example, the intervals [ 0 days , 14 days] and [ 0 weeks , 2 weeks] are equivalent.\n\nhttps://www.wikidata.org/wiki/Help:Property_constraints_portal/Diff_within_range", "author": "wetneb", "createdAt": "2020-05-23T19:18:11Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/qa/scrutinizers/DifferenceWithinRangeScrutinizer.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.openrefine.wikidata.qa.scrutinizers;\n+\n+import org.openrefine.wikidata.qa.QAWarning;\n+import org.openrefine.wikidata.updates.ItemUpdate;\n+import org.wikidata.wdtk.datamodel.interfaces.*;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class DifferenceWithinRangeScrutinizer extends EditScrutinizer {\n+\n+    public static final String type = \"difference-of-the-properties-is-not-within-the-specified-range\";\n+\n+    @Override\n+    public void scrutinize(ItemUpdate update) {\n+        Map<PropertyIdValue, Value> propertyIdValueValueMap = new HashMap<>();\n+        for (Statement statement : update.getAddedStatements()){\n+            PropertyIdValue pid = statement.getClaim().getMainSnak().getPropertyId();\n+            Value value = statement.getClaim().getMainSnak().getValue();\n+            propertyIdValueValueMap.put(pid, value);\n+        }\n+\n+        for(PropertyIdValue propertyId : propertyIdValueValueMap.keySet()){\n+            if (_fetcher.hasDiffWithinRange(propertyId)){\n+                PropertyIdValue lowerPropertyId = _fetcher.getLowerPropertyId(propertyId);\n+                QuantityValue minRangeValue = _fetcher.getMinimumValue(propertyId);\n+                QuantityValue maxRangeValue = _fetcher.getMaximumValue(propertyId);\n+\n+                if (propertyIdValueValueMap.containsKey(lowerPropertyId)){\n+                    Value startingValue = propertyIdValueValueMap.get(lowerPropertyId);\n+                    Value endingValue = propertyIdValueValueMap.get(propertyId);\n+\n+                    if (startingValue instanceof TimeValue && endingValue instanceof TimeValue){\n+                        TimeValue lowerDate = (TimeValue)startingValue;\n+                        TimeValue upperDate = (TimeValue)endingValue;\n+\n+                        if (upperDate.getYear() - lowerDate.getYear() < minRangeValue.getNumericValue().longValue()\n+                            || upperDate.getYear() == lowerDate.getYear() && upperDate.getMonth() < lowerDate.getMonth()\n+                            || upperDate.getYear() == lowerDate.getYear() && upperDate.getMonth() == lowerDate.getMonth() && upperDate.getDay() < lowerDate.getDay()\n+                            || upperDate.getYear() - lowerDate.getYear() > maxRangeValue.getNumericValue().longValue()){", "originalCommit": "3db2a11a4d2abc63deb0418a2e3691e3a5f40abb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYwNTY2OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429605669", "bodyText": "If I'll even calculate the difference that would be in terms of year-month-day and the range is provided in years. So, 1st thing that comes in my mind is it might increase the complexity of the code to understand the working and 2nd thing is the comparison with range.\nfor instance: here it's quite simple to even check for same death and birth of year but an invalid month and day.  In case of difference, it will be like 0 years -2 month something which doesn't sound good to me. I also checked wikibase implementation before implementing this. They only checked for the year difference which I guess not so appropriate in cases like:\nD.O.B : 2020-10-09\nD.O.D: 2020-02-02\n(ps: I'm not too good in PHP maybe I have overlooked any condition)\nDo you want to have that implementation, I can proceed with that. No issues :)", "author": "darecoder", "createdAt": "2020-05-24T06:53:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYwNjA3Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r429606073", "bodyText": "Oh indeed, they only support years on their end too. That's not really what the docs say!\nStill, I would prefer to compute the difference in years first, and then check how it compares to the bounds, which is what they do:\nhttps://github.com/wikimedia/mediawiki-extensions-WikibaseQualityConstraints/blob/master/src/ConstraintCheck/Checker/DiffWithinRangeChecker.php#L166", "author": "wetneb", "createdAt": "2020-05-24T06:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MTI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk1MDAxMw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r432950013", "bodyText": "Typo: it's -> its", "author": "wetneb", "createdAt": "2020-05-31T13:58:09Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/qa/WikidataConstraintFetcher.java", "diffHunk": "@@ -340,4 +336,84 @@ public boolean usableOnItems(PropertyIdValue pid) {\n         }\n         return results;\n     }\n+\n+    protected List<QuantityValue> getValues(List<SnakGroup> groups, String pid) {\n+        List<QuantityValue> results = new ArrayList<>();\n+        for (SnakGroup group : groups) {\n+            if (group.getProperty().getId().equals(pid)) {\n+                for (Snak snak : group.getSnaks())\n+                    results.add((QuantityValueImpl) snak.getValue());\n+            }\n+        }\n+        return results;\n+    }\n+\n+    /**\n+     * Is this property expected to have a value whose difference\n+     * with it's lower bound property should be in a range?", "originalCommit": "ae3d84b8474f9db0f506d41bc9652b1eb43196ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk1MDE2Nw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2634#discussion_r432950167", "bodyText": "We have the same problem as the Conflicts With constraint here: as a parameter, we should pass the target property id (the one against which the difference is checked), and then find the corresponding constraint definition instead of only reading the first one.", "author": "wetneb", "createdAt": "2020-05-31T14:00:02Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/qa/WikidataConstraintFetcher.java", "diffHunk": "@@ -340,4 +336,84 @@ public boolean usableOnItems(PropertyIdValue pid) {\n         }\n         return results;\n     }\n+\n+    protected List<QuantityValue> getValues(List<SnakGroup> groups, String pid) {\n+        List<QuantityValue> results = new ArrayList<>();\n+        for (SnakGroup group : groups) {\n+            if (group.getProperty().getId().equals(pid)) {\n+                for (Snak snak : group.getSnaks())\n+                    results.add((QuantityValueImpl) snak.getValue());\n+            }\n+        }\n+        return results;\n+    }\n+\n+    /**\n+     * Is this property expected to have a value whose difference\n+     * with it's lower bound property should be in a range?\n+     */\n+    @Override\n+    public boolean hasDiffWithinRange(PropertyIdValue pid) {\n+        return getSingleConstraint(pid, DIFFERENCE_WITHIN_RANGE_CONSTRAINT_QID) != null;\n+    }\n+\n+    /**\n+     * Retrieves the lower value property for calculating the difference\n+     * required in difference-within-range constraint\n+     *\n+     * @param pid:\n+     *            the property to calculate difference with\n+     * @return the pid of the lower bound property\n+     */\n+    @Override\n+    public PropertyIdValue getLowerPropertyId(PropertyIdValue pid) {", "originalCommit": "ae3d84b8474f9db0f506d41bc9652b1eb43196ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fc05eeaf098663d22702ce8d98e00981a01b19ca", "url": "https://github.com/OpenRefine/OpenRefine/commit/fc05eeaf098663d22702ce8d98e00981a01b19ca", "message": "Added difference-within-range Scrutinizer", "committedDate": "2020-06-03T04:01:47Z", "type": "commit"}]}