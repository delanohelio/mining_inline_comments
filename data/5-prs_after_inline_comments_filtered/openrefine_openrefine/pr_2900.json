{"pr_number": 2900, "pr_title": "Use standard text normalization - fixes #2898", "pr_createdAt": "2020-07-07T03:43:04Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/2900", "timeline": [{"oid": "85fbd6e7a3975e4dd31cd02867f684a6d3327a24", "url": "https://github.com/OpenRefine/OpenRefine/commit/85fbd6e7a3975e4dd31cd02867f684a6d3327a24", "message": "Use standard text normalization - fixes #2898\n\nFixes #2898. Fixes #409. Refs #650\n\nReplaces homegrown ISO Latin-1 only character subsitition\nwith standard Java Normalize to NFD, followed by diacritic\nremoval and a few custom character expansions/replacements.", "committedDate": "2020-07-07T03:41:36Z", "type": "commit"}, {"oid": "de51a9178bb775b280442c4e2300afda68391545", "url": "https://github.com/OpenRefine/OpenRefine/commit/de51a9178bb775b280442c4e2300afda68391545", "message": "Fix Mac build", "committedDate": "2020-07-07T04:03:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MjA1Ng==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2900#discussion_r450662056", "bodyText": "Random thought: to make sure we are not missing any of these cases by expressing the conversion with your regular expression, would it make sense to just transform this deleted code into a unit test which would check that all the behaviour is preserved for all the cases listed here?", "author": "wetneb", "createdAt": "2020-07-07T07:25:48Z", "path": "main/src/com/google/refine/clustering/binning/FingerprintKeyer.java", "diffHunk": "@@ -69,222 +96,32 @@ public String key(String s, Object... o) {\n         return b.toString();\n     }\n \n+    protected String normalize(String s) {\n+        s = stripDiacritics(s);\n+        s = stripNonDiacritics(s);\n+        return s;\n+    }\n+\n+    @Deprecated\n     protected String asciify(String s) {\n-        char[] c = s.toCharArray();\n-        StringBuffer b = new StringBuffer();\n-        for (char element : c) {\n-            b.append(translate(element));\n-        }\n-        return b.toString();\n+        return normalize(s);\n     }\n-    \n-    /**\n-     * Translate the given unicode char in the closest ASCII representation\n-     * NOTE: this function deals only with latin-1 supplement and latin-1 extended code charts\n-     */\n-    private char translate(char c) {", "originalCommit": "de51a9178bb775b280442c4e2300afda68391545", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MDI4MA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2900#discussion_r451080280", "bodyText": "Good idea. I did that and updated the normalization with some substitutions for visually similar characters which are not normally considered the same. I also switched to the more powerful compatibility decomposition (NFKD) from the canonical decomposition (NFD) which is a bigger hammer, but this is intended to be a relatively blunt instrument. When we expose normalization as a function, we can allow more fine grained control.\nThe current code should handle all characters in the old table the same, except for O with stroke which is now \"oe\" instead of \"o\", and provide equivalent semantics for all characters and ligatures which were not included in the old table.\nWe need to decide (eventually) whether we want to continue the practice of aggressively folding Latin characters to their nearest ASCII equivalent even if the Java normalization code doesn't. The Latin Extended B and Latin Extended C characters (and probably others) would require us to do our own mappings. Latin Basic, Latin-1 Supplement, Latin Extended A and Latin Extended Additional are fully covered.", "author": "tfmorris", "createdAt": "2020-07-07T19:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MjA1Ng=="}], "type": "inlineReview"}, {"oid": "cc62db96adf0560a658b3ad77b142650b163c47d", "url": "https://github.com/OpenRefine/OpenRefine/commit/cc62db96adf0560a658b3ad77b142650b163c47d", "message": "Improve compatibility with previous code\n\nOne intentional change is folding O with stroke to\noe instead of o.\n\n- Use more powerful NFKD instead of NFD\n- strip punctuation after decomposition since it can generate\n  new punctuation\n- Add compatibility test for old asciify() method\n- Add some graphically similar characters to substitution table", "committedDate": "2020-07-07T17:12:39Z", "type": "commit"}, {"oid": "c2ff64d354615e9ef12b5bd1602b025b4ae5b8ff", "url": "https://github.com/OpenRefine/OpenRefine/commit/c2ff64d354615e9ef12b5bd1602b025b4ae5b8ff", "message": "Add oe character/ligature & more long S forms", "committedDate": "2020-07-07T18:35:26Z", "type": "commit"}, {"oid": "08fa4b292be36fa6fbc46f3ac3bc0b80a89275f8", "url": "https://github.com/OpenRefine/OpenRefine/commit/08fa4b292be36fa6fbc46f3ac3bc0b80a89275f8", "message": "More tests for ligatures and Latin Extended", "committedDate": "2020-07-07T18:35:59Z", "type": "commit"}, {"oid": "4ce584f35e866564689af78c5a4a497bf23e7fad", "url": "https://github.com/OpenRefine/OpenRefine/commit/4ce584f35e866564689af78c5a4a497bf23e7fad", "message": "Add Latin-1 Supplement tests", "committedDate": "2020-07-07T19:02:01Z", "type": "commit"}]}