{"pr_number": 1377, "pr_title": "Consider MGP in eth_getPrice", "pr_createdAt": "2020-11-26T12:33:21Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1377", "timeline": [{"oid": "b53a190533ddd14c9ee878284430b446abe68ff7", "url": "https://github.com/rsksmart/rskj/commit/b53a190533ddd14c9ee878284430b446abe68ff7", "message": "Consider MGP in eth_getPrice", "committedDate": "2020-11-26T13:55:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE4ODc0Mw==", "url": "https://github.com/rsksmart/rskj/pull/1377#discussion_r531188743", "bodyText": "Empty blocks or unusued block space should reduce the suggested gas price, which is not happening with this formula. Probably an idea to track in the backlog, nothing actually related to this task", "author": "donequis", "createdAt": "2020-11-26T18:50:29Z", "path": "rskj-core/src/main/java/org/ethereum/listener/GasPriceTracker.java", "diffHunk": "@@ -61,30 +75,39 @@ public void onBlock(Block block, List<TransactionReceipt> receipts) {\n         logger.trace(\"End onBlock\");\n     }\n \n-    public void onTransaction(Transaction tx) {\n+    private void onTransaction(Transaction tx) {", "originalCommit": "b53a190533ddd14c9ee878284430b446abe68ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTc0NzU2MQ==", "url": "https://github.com/rsksmart/rskj/pull/1377#discussion_r531747561", "bodyText": "wouldnt be better to declare max() in Coin? would be consistent with BigInteger.max()", "author": "patogallaiovlabs", "createdAt": "2020-11-27T19:56:55Z", "path": "rskj-core/src/main/java/org/ethereum/listener/GasPriceTracker.java", "diffHunk": "@@ -61,30 +75,39 @@ public void onBlock(Block block, List<TransactionReceipt> receipts) {\n         logger.trace(\"End onBlock\");\n     }\n \n-    public void onTransaction(Transaction tx) {\n+    private void onTransaction(Transaction tx) {\n         if (tx instanceof RemascTransaction) {\n             return;\n         }\n \n         if (idx == -1) {\n-            idx = window.length - 1;\n-            filled = true;\n+            idx = WINDOW_SIZE - 1;\n             lastVal = null;  // recalculate only 'sometimes'\n         }\n \n         window[idx--] = tx.getGasPrice();\n     }\n \n-    public Coin getGasPrice() {\n-        if (!filled) {\n+    public synchronized Coin getGasPrice() {\n+        if (window[0] == null) { // not filled yet\n             return defaultPrice;\n         } else {\n             if (lastVal == null) {\n-                Coin[] values = Arrays.copyOf(window, window.length);\n+                Coin[] values = Arrays.copyOf(window, WINDOW_SIZE);\n                 Arrays.sort(values);\n                 lastVal = values[values.length / 4];  // 25% percentile\n             }\n-            return lastVal;\n+\n+            Coin bestBlockPrice = bestBlockPriceRef.get();\n+            if (bestBlockPrice == null) {\n+                return lastVal;\n+            } else {\n+                return max(lastVal, bestBlockPrice.multiply(BI_11).divide(BI_10));\n+            }\n         }\n     }\n+\n+    private static Coin max(Coin a, Coin b) {", "originalCommit": "b53a190533ddd14c9ee878284430b446abe68ff7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNDgwMA==", "url": "https://github.com/rsksmart/rskj/pull/1377#discussion_r532604800", "bodyText": "nice :)", "author": "patogallaiovlabs", "createdAt": "2020-11-30T13:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTc0NzU2MQ=="}], "type": "inlineReview"}, {"oid": "64a65bdfc84703f0f533ab613347ae6ab3124cf8", "url": "https://github.com/rsksmart/rskj/commit/64a65bdfc84703f0f533ab613347ae6ab3124cf8", "message": "Consider MGP in eth_getPrice", "committedDate": "2020-12-14T15:42:16Z", "type": "commit"}, {"oid": "62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663", "url": "https://github.com/rsksmart/rskj/commit/62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663", "message": "Extracted max method", "committedDate": "2020-12-14T15:42:16Z", "type": "commit"}, {"oid": "62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663", "url": "https://github.com/rsksmart/rskj/commit/62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663", "message": "Extracted max method", "committedDate": "2020-12-14T15:42:16Z", "type": "forcePushed"}]}