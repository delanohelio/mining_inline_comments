{"pr_number": 1299, "pr_title": "Preserve Txn revert reason", "pr_createdAt": "2020-08-31T20:30:29Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1299", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzNzk5Ng==", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r491937996", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Optional.of(decoded.get(0).getValue().toString());\n          \n          \n            \n                    return decoded.isEmpty() ? Optional.empty() : Optional.of(decoded.get(0).getValue().toString());", "author": "Vovchyk", "createdAt": "2020-09-21T10:25:14Z", "path": "rskj-core/src/main/java/co/rsk/rpc/modules/eth/EthModule.java", "diffHunk": "@@ -227,6 +240,25 @@ private ProgramResult callConstant(Web3.CallArguments args, Block executionBlock\n         );\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private Optional<String> decodeRevertReason(ProgramResult res) {\n+        byte[] bytes = res.getHReturn();\n+        if (bytes == null || bytes.length == 0) {\n+            return Optional.empty();\n+        }\n+\n+        String value = Hex.toHexString(res.getHReturn());\n+        if (!value.startsWith(\"08c379a0\")) {\n+            return Optional.empty();\n+        }\n+\n+        List<TypeReference<Type>> revertReasonTypes =\n+                Collections.singletonList(TypeReference.create((Class<Type>) AbiTypes.getType(\"string\")));\n+        String encodedRevertReason = value.substring(8);\n+        List<Type> decoded = FunctionReturnDecoder.decode(encodedRevertReason, revertReasonTypes);\n+        return Optional.of(decoded.get(0).getValue().toString());", "originalCommit": "4e224f3f501fa7796132a389aa240338a2b0f81a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzU0MQ==", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r492963541", "bodyText": "Magic value? Add comment and Constant.", "author": "patogallaiovlabs", "createdAt": "2020-09-22T18:55:20Z", "path": "rskj-core/src/main/java/co/rsk/rpc/modules/eth/EthModule.java", "diffHunk": "@@ -227,6 +240,25 @@ private ProgramResult callConstant(Web3.CallArguments args, Block executionBlock\n         );\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private Optional<String> decodeRevertReason(ProgramResult res) {\n+        byte[] bytes = res.getHReturn();\n+        if (bytes == null || bytes.length == 0) {\n+            return Optional.empty();\n+        }\n+\n+        String value = Hex.toHexString(res.getHReturn());\n+        if (!value.startsWith(\"08c379a0\")) {", "originalCommit": "4e224f3f501fa7796132a389aa240338a2b0f81a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2Mzk0Ng==", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r492963946", "bodyText": "Extract these lines to a method and add docs (at least some doc).", "author": "patogallaiovlabs", "createdAt": "2020-09-22T18:56:03Z", "path": "rskj-core/src/main/java/co/rsk/rpc/modules/eth/EthModule.java", "diffHunk": "@@ -227,6 +240,25 @@ private ProgramResult callConstant(Web3.CallArguments args, Block executionBlock\n         );\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private Optional<String> decodeRevertReason(ProgramResult res) {\n+        byte[] bytes = res.getHReturn();\n+        if (bytes == null || bytes.length == 0) {\n+            return Optional.empty();\n+        }\n+\n+        String value = Hex.toHexString(res.getHReturn());\n+        if (!value.startsWith(\"08c379a0\")) {\n+            return Optional.empty();\n+        }\n+\n+        List<TypeReference<Type>> revertReasonTypes =\n+                Collections.singletonList(TypeReference.create((Class<Type>) AbiTypes.getType(\"string\")));\n+        String encodedRevertReason = value.substring(8);", "originalCommit": "4e224f3f501fa7796132a389aa240338a2b0f81a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2NTI2OQ==", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r492965269", "bodyText": "What does this value means? Add some comments. We could check other possible values (?)", "author": "patogallaiovlabs", "createdAt": "2020-09-22T18:58:16Z", "path": "rskj-core/src/test/java/co/rsk/rpc/modules/eth/EthModuleTest.java", "diffHunk": "@@ -78,6 +80,50 @@ public void callSmokeTest() {\n         assertThat(result, is(TypeConverter.toJsonHex(hreturn)));\n     }\n \n+    @Test\n+    public void test_revertedTransaction() {\n+        Web3.CallArguments args = new Web3.CallArguments();\n+        BlockResult blockResult = mock(BlockResult.class);\n+        Block block = mock(Block.class);\n+        ExecutionBlockRetriever retriever = mock(ExecutionBlockRetriever.class);\n+        when(retriever.getExecutionBlock_workaround(\"latest\"))\n+                .thenReturn(blockResult);\n+        when(blockResult.getBlock()).thenReturn(block);\n+\n+        byte[] hreturn = Hex.decode(\n+                \"08c379a000000000000000000000000000000000000000000000000000000000\" +\n+                        \"0000002000000000000000000000000000000000000000000000000000000000\" +\n+                        \"0000000f6465706f73697420746f6f2062696700000000000000000000000000\" +\n+                        \"00000000\");", "originalCommit": "4e224f3f501fa7796132a389aa240338a2b0f81a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1be59a97b6bd2b76af52661e0a2e188fec26f4c0", "url": "https://github.com/rsksmart/rskj/commit/1be59a97b6bd2b76af52661e0a2e188fec26f4c0", "message": "dependency fix", "committedDate": "2020-10-07T13:06:39Z", "type": "forcePushed"}, {"oid": "5289207e2ad9d60c9b9fc608f47a006cb30cfcad", "url": "https://github.com/rsksmart/rskj/commit/5289207e2ad9d60c9b9fc608f47a006cb30cfcad", "message": "dependency fix", "committedDate": "2020-10-07T13:08:06Z", "type": "forcePushed"}, {"oid": "64e1037fa0a561288d3941d73ad25fdf81bd4462", "url": "https://github.com/rsksmart/rskj/commit/64e1037fa0a561288d3941d73ad25fdf81bd4462", "message": "Remove Web3j dependency", "committedDate": "2020-10-26T14:02:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNjI0MQ==", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r513636241", "bodyText": "Any real transaction executed in a code test (maybe using DSL), to test this signature?", "author": "ajlopezrsk", "createdAt": "2020-10-28T17:35:05Z", "path": "rskj-core/src/main/java/co/rsk/rpc/modules/eth/EthModule.java", "diffHunk": "@@ -58,6 +58,9 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(\"web3\");\n \n+    private static final CallTransaction.Function ERROR_ABI_FUNCTION = CallTransaction.Function.fromSignature(\"Error\", \"string\");\n+    private static final byte[] ERROR_ABI_FUNCTION_SIGNATURE = ERROR_ABI_FUNCTION.encodeSignature(); //08c379a0", "originalCommit": "64e1037fa0a561288d3941d73ad25fdf81bd4462", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzczNjM5MQ==", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r513736391", "bodyText": "Done!", "author": "patogallaiovlabs", "createdAt": "2020-10-28T20:22:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNjI0MQ=="}], "type": "inlineReview"}, {"oid": "32df3b06dc88fb0aea5999cb718e49aa1bc10856", "url": "https://github.com/rsksmart/rskj/commit/32df3b06dc88fb0aea5999cb718e49aa1bc10856", "message": "Preserve txn revert reason", "committedDate": "2020-11-18T17:32:38Z", "type": "commit"}, {"oid": "e319a3be9698787a162e6346f54798b38c207b4c", "url": "https://github.com/rsksmart/rskj/commit/e319a3be9698787a162e6346f54798b38c207b4c", "message": "Add unit test", "committedDate": "2020-11-18T17:32:38Z", "type": "commit"}, {"oid": "fe8c53cbb45fede321b6b412f0863e286a78845c", "url": "https://github.com/rsksmart/rskj/commit/fe8c53cbb45fede321b6b412f0863e286a78845c", "message": "Remove Web3j dependency", "committedDate": "2020-11-18T17:33:23Z", "type": "commit"}, {"oid": "d61afe38b088eff0026e393ec4c8ec8371f82387", "url": "https://github.com/rsksmart/rskj/commit/d61afe38b088eff0026e393ec4c8ec8371f82387", "message": "Add DSL test, simulating a revert", "committedDate": "2020-11-18T17:33:23Z", "type": "commit"}, {"oid": "437b644382bd8f0c43a0ddf026c43f0b1e0e0a64", "url": "https://github.com/rsksmart/rskj/commit/437b644382bd8f0c43a0ddf026c43f0b1e0e0a64", "message": "remove call to gc", "committedDate": "2020-11-18T17:33:23Z", "type": "commit"}, {"oid": "151aa541b76fa10600cc21237e3d9bdb418e150e", "url": "https://github.com/rsksmart/rskj/commit/151aa541b76fa10600cc21237e3d9bdb418e150e", "message": "fix test", "committedDate": "2020-11-18T17:33:23Z", "type": "commit"}, {"oid": "151aa541b76fa10600cc21237e3d9bdb418e150e", "url": "https://github.com/rsksmart/rskj/commit/151aa541b76fa10600cc21237e3d9bdb418e150e", "message": "fix test", "committedDate": "2020-11-18T17:33:23Z", "type": "forcePushed"}]}