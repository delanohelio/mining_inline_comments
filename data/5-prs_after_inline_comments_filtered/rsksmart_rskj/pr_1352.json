{"pr_number": 1352, "pr_title": "Fixed issue with empty contract's return result", "pr_createdAt": "2020-11-02T12:18:05Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1352", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk5OTQxMA==", "url": "https://github.com/rsksmart/rskj/pull/1352#discussion_r518999410", "bodyText": "I would not test agains the function, but for the explicit value", "author": "patogallaiovlabs", "createdAt": "2020-11-06T20:52:55Z", "path": "rskj-core/src/test/java/co/rsk/rpc/modules/eth/EthModuleTest.java", "diffHunk": "@@ -75,7 +112,7 @@ public void callSmokeTest() {\n                         null, null, null));\n \n         String result = eth.call(args, \"latest\");\n-        assertThat(result, is(TypeConverter.toJsonHex(hreturn)));\n+        assertThat(result, is(TypeConverter.toUnformattedJsonHex(hReturn)));", "originalCommit": "402cd25ec532fd54ea226799196c970b55966f41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU2MjA4Ng==", "url": "https://github.com/rsksmart/rskj/pull/1352#discussion_r520562086", "bodyText": "done", "author": "Vovchyk", "createdAt": "2020-11-10T13:30:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk5OTQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk5OTYxOA==", "url": "https://github.com/rsksmart/rskj/pull/1352#discussion_r518999618", "bodyText": "Same here, to be clear whats the expected value.", "author": "patogallaiovlabs", "createdAt": "2020-11-06T20:53:29Z", "path": "rskj-core/src/test/java/co/rsk/rpc/modules/eth/EthModuleTest.java", "diffHunk": "@@ -52,10 +53,46 @@ public void callSmokeTest() {\n                 .thenReturn(blockResult);\n         when(blockResult.getBlock()).thenReturn(block);\n \n-        byte[] hreturn = TypeConverter.stringToByteArray(\"hello\");\n+        byte[] hReturn = TypeConverter.stringToByteArray(\"hello\");\n+        ProgramResult executorResult = mock(ProgramResult.class);\n+        when(executorResult.getHReturn())\n+                .thenReturn(hReturn);\n+\n+        ReversibleTransactionExecutor executor = mock(ReversibleTransactionExecutor.class);\n+        when(executor.executeTransaction(eq(blockResult.getBlock()), any(), any(), any(), any(), any(), any(), any()))\n+                .thenReturn(executorResult);\n+\n+        EthModule eth = new EthModule(\n+                null,\n+                anyByte(),\n+                null,\n+                null,\n+                executor,\n+                retriever,\n+                null,\n+                null,\n+                null,\n+                new BridgeSupportFactory(\n+                        null, null, null));\n+\n+        String result = eth.call(args, \"latest\");\n+        assertThat(result, is(TypeConverter.toUnformattedJsonHex(hReturn)));", "originalCommit": "402cd25ec532fd54ea226799196c970b55966f41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU2MjEyNw==", "url": "https://github.com/rsksmart/rskj/pull/1352#discussion_r520562127", "bodyText": "done", "author": "Vovchyk", "createdAt": "2020-11-10T13:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk5OTYxOA=="}], "type": "inlineReview"}, {"oid": "3d3d090440cab02744e52f0770f579fa5b5e230f", "url": "https://github.com/rsksmart/rskj/commit/3d3d090440cab02744e52f0770f579fa5b5e230f", "message": "Refactored unit test", "committedDate": "2020-11-10T13:29:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjIyNQ==", "url": "https://github.com/rsksmart/rskj/pull/1352#discussion_r523236225", "bodyText": "Could we have a test using an address without code? To be sure EthModule reacts with the expected behavior, even if we change the internal code in the future. In this test, we are presuming the hReturn will be the empty byte array.", "author": "ajlopezrsk", "createdAt": "2020-11-13T21:15:46Z", "path": "rskj-core/src/test/java/co/rsk/rpc/modules/eth/EthModuleTest.java", "diffHunk": "@@ -52,10 +54,48 @@ public void callSmokeTest() {\n                 .thenReturn(blockResult);\n         when(blockResult.getBlock()).thenReturn(block);\n \n-        byte[] hreturn = TypeConverter.stringToByteArray(\"hello\");\n+        byte[] hReturn = TypeConverter.stringToByteArray(\"hello\");\n+        ProgramResult executorResult = mock(ProgramResult.class);\n+        when(executorResult.getHReturn())\n+                .thenReturn(hReturn);\n+\n+        ReversibleTransactionExecutor executor = mock(ReversibleTransactionExecutor.class);\n+        when(executor.executeTransaction(eq(blockResult.getBlock()), any(), any(), any(), any(), any(), any(), any()))\n+                .thenReturn(executorResult);\n+\n+        EthModule eth = new EthModule(\n+                null,\n+                anyByte(),\n+                null,\n+                null,\n+                executor,\n+                retriever,\n+                null,\n+                null,\n+                null,\n+                new BridgeSupportFactory(\n+                        null, null, null));\n+\n+        String expectedResult = TypeConverter.toUnformattedJsonHex(hReturn);\n+        String actualResult = eth.call(args, \"latest\");\n+\n+        assertEquals(expectedResult, actualResult);\n+    }\n+\n+    @Test\n+    public void callWithoutReturn() {\n+        Web3.CallArguments args = new Web3.CallArguments();\n+        BlockResult blockResult = mock(BlockResult.class);\n+        Block block = mock(Block.class);\n+        ExecutionBlockRetriever retriever = mock(ExecutionBlockRetriever.class);\n+        when(retriever.getExecutionBlock_workaround(\"latest\"))\n+                .thenReturn(blockResult);\n+        when(blockResult.getBlock()).thenReturn(block);\n+\n+        byte[] hReturn = new byte[0];", "originalCommit": "3d3d090440cab02744e52f0770f579fa5b5e230f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA4NDA0Ng==", "url": "https://github.com/rsksmart/rskj/pull/1352#discussion_r527084046", "bodyText": "done", "author": "Vovchyk", "createdAt": "2020-11-19T17:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjIyNQ=="}], "type": "inlineReview"}, {"oid": "06da8b0b9033c4a62bba4b48ba06685067a20d1a", "url": "https://github.com/rsksmart/rskj/commit/06da8b0b9033c4a62bba4b48ba06685067a20d1a", "message": "Fixed testCall_getRevertReason test", "committedDate": "2020-11-19T17:22:01Z", "type": "forcePushed"}, {"oid": "5074d61a809238852556c26d9338ad21662dad45", "url": "https://github.com/rsksmart/rskj/commit/5074d61a809238852556c26d9338ad21662dad45", "message": "Fixed testCall_getRevertReason test", "committedDate": "2020-12-17T13:42:19Z", "type": "forcePushed"}, {"oid": "84bbc63a36b6b66a0af273183ddc1ace6de2d3a2", "url": "https://github.com/rsksmart/rskj/commit/84bbc63a36b6b66a0af273183ddc1ace6de2d3a2", "message": "Fixed issue with empty contract's return result", "committedDate": "2020-12-28T17:07:16Z", "type": "commit"}, {"oid": "bef10ab801f0086abec3d21c8c0b8d83a77f9ee5", "url": "https://github.com/rsksmart/rskj/commit/bef10ab801f0086abec3d21c8c0b8d83a77f9ee5", "message": "Small refactoring", "committedDate": "2020-12-28T17:07:16Z", "type": "commit"}, {"oid": "f1c6af18ab40596f5d8b779bbf51a744518de3e5", "url": "https://github.com/rsksmart/rskj/commit/f1c6af18ab40596f5d8b779bbf51a744518de3e5", "message": "Refactored unit test", "committedDate": "2020-12-28T17:07:16Z", "type": "commit"}, {"oid": "3715d8b1ca02aab0a5bd3ec38a571bf05becdfb6", "url": "https://github.com/rsksmart/rskj/commit/3715d8b1ca02aab0a5bd3ec38a571bf05becdfb6", "message": "Added test for no contract return case in Web3ImplTest", "committedDate": "2020-12-28T17:18:42Z", "type": "commit"}, {"oid": "a8fec98e574af403d9a067557663a12e0872dea5", "url": "https://github.com/rsksmart/rskj/commit/a8fec98e574af403d9a067557663a12e0872dea5", "message": "Fixed testCall_getRevertReason test", "committedDate": "2020-12-28T17:18:44Z", "type": "commit"}, {"oid": "a8fec98e574af403d9a067557663a12e0872dea5", "url": "https://github.com/rsksmart/rskj/commit/a8fec98e574af403d9a067557663a12e0872dea5", "message": "Fixed testCall_getRevertReason test", "committedDate": "2020-12-28T17:18:44Z", "type": "forcePushed"}]}