{"pr_number": 4247, "pr_title": "fix thread unsafe problem in server-alarm-plugin (#4230)", "pr_createdAt": "2020-01-16T08:39:02Z", "pr_url": "https://github.com/apache/skywalking/pull/4247", "timeline": [{"oid": "82c7bccd0d8416ca88a55b135591181ff9e81834", "url": "https://github.com/apache/skywalking/commit/82c7bccd0d8416ca88a55b135591181ff9e81834", "message": "fix thread unsafe problem in server-alarm-plugin (#4230)", "committedDate": "2020-01-16T08:35:36Z", "type": "commit"}, {"oid": "1c7fd0c1e34fc4056083f44378325b1354911c30", "url": "https://github.com/apache/skywalking/commit/1c7fd0c1e34fc4056083f44378325b1354911c30", "message": "Merge branch 'master' into master", "committedDate": "2020-01-16T08:39:38Z", "type": "commit"}, {"oid": "765162dbd0a205800d187914ffa0ca4f25069bb2", "url": "https://github.com/apache/skywalking/commit/765162dbd0a205800d187914ffa0ca4f25069bb2", "message": "Merge branch 'master' into master", "committedDate": "2020-01-16T13:15:16Z", "type": "commit"}, {"oid": "85b1107ae29652b3a4df2cd3b11ded78d41171eb", "url": "https://github.com/apache/skywalking/commit/85b1107ae29652b3a4df2cd3b11ded78d41171eb", "message": "Merge branch 'master' into master", "committedDate": "2020-01-18T15:19:48Z", "type": "commit"}, {"oid": "85b1107ae29652b3a4df2cd3b11ded78d41171eb", "url": "https://github.com/apache/skywalking/commit/85b1107ae29652b3a4df2cd3b11ded78d41171eb", "message": "Merge branch 'master' into master", "committedDate": "2020-01-18T15:19:48Z", "type": "forcePushed"}, {"oid": "dd761fcc79879c3197dff7cccb6c6d3290f9a2e6", "url": "https://github.com/apache/skywalking/commit/dd761fcc79879c3197dff7cccb6c6d3290f9a2e6", "message": "Merge branch 'master' into master", "committedDate": "2020-01-19T09:51:13Z", "type": "commit"}, {"oid": "e0d3f758dba8835be85278ba361a3ceccfbf8933", "url": "https://github.com/apache/skywalking/commit/e0d3f758dba8835be85278ba361a3ceccfbf8933", "message": "remove redundant #moveTo", "committedDate": "2020-01-19T10:04:34Z", "type": "commit"}, {"oid": "a9855bba559ecf855a54fea9627806c69e02c272", "url": "https://github.com/apache/skywalking/commit/a9855bba559ecf855a54fea9627806c69e02c272", "message": "Merge branch 'develop'", "committedDate": "2020-01-19T10:16:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4NDIzMA==", "url": "https://github.com/apache/skywalking/pull/4247#discussion_r368284230", "bodyText": "Why add this? End time has been initialized in the constructor. End time should never be null. Right?", "author": "wu-sheng", "createdAt": "2020-01-19T10:47:09Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/RunningRule.java", "diffHunk": "@@ -227,18 +221,17 @@ public void moveTo(LocalDateTime current) {\n         public void add(Metrics metrics) {\n             long bucket = metrics.getTimeBucket();\n \n-            LocalDateTime timebucket = TIME_BUCKET_FORMATTER.parseLocalDateTime(bucket + \"\");\n-\n-            int minutes = Minutes.minutesBetween(timebucket, endTime).getMinutes();\n-            if (minutes == -1) {\n-                this.moveTo(timebucket);\n-\n-            }\n+            LocalDateTime timeBucket = TIME_BUCKET_FORMATTER.parseLocalDateTime(bucket + \"\");\n \n-            lock.lock();\n+            this.lock.lock();\n             try {\n+                if (this.endTime == null) {\n+                    init();\n+                    this.endTime = timeBucket;", "originalCommit": "a9855bba559ecf855a54fea9627806c69e02c272", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4NTA3Ng==", "url": "https://github.com/apache/skywalking/pull/4247#discussion_r368285076", "bodyText": "End time was not initialized.\nhard-coded initialization of endTime is elegant, but may cause fatal problem when the initial bucketTime is less than  1970-01-01T00:00:00Z, under this circumstance, #add will treated window as inited and invoke #set on un-inited this.values, which will cause IOB Exception. Maybe an alternative way is initializing endTime with value '0000-01-01T00:00:00Z\u2018,  it's not so elegant though..", "author": "liuhaoXD", "createdAt": "2020-01-19T11:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4NDIzMA=="}], "type": "inlineReview"}]}