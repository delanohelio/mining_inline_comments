{"pr_number": 5914, "pr_title": "Support collecting logs of log4j, log4j2, and logback in the tracing context", "pr_createdAt": "2020-11-27T08:55:50Z", "pr_url": "https://github.com/apache/skywalking/pull/5914", "timeline": [{"oid": "0825c27b5b80b1e5ce255a162e47374de3079e51", "url": "https://github.com/apache/skywalking/commit/0825c27b5b80b1e5ce255a162e47374de3079e51", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: Brandon Fergerson <bfergerson@apache.org>", "committedDate": "2020-12-09T16:49:05Z", "type": "commit"}, {"oid": "76a5232b315b7db34a08e19d82038ea924c87768", "url": "https://github.com/apache/skywalking/commit/76a5232b315b7db34a08e19d82038ea924c87768", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: Brandon Fergerson <bfergerson@apache.org>", "committedDate": "2020-12-09T16:49:43Z", "type": "commit"}, {"oid": "86f35bd7ce77252e834d1d7bbb5281a186806e93", "url": "https://github.com/apache/skywalking/commit/86f35bd7ce77252e834d1d7bbb5281a186806e93", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: Brandon Fergerson <bfergerson@apache.org>", "committedDate": "2020-12-09T16:49:53Z", "type": "commit"}, {"oid": "31600589f287b4653bb2552c307b2438d4f8f7f2", "url": "https://github.com/apache/skywalking/commit/31600589f287b4653bb2552c307b2438d4f8f7f2", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: Brandon Fergerson <bfergerson@apache.org>", "committedDate": "2020-12-09T16:50:01Z", "type": "commit"}, {"oid": "0a502a68cb2731c453c92d98a53694d13bcf3077", "url": "https://github.com/apache/skywalking/commit/0a502a68cb2731c453c92d98a53694d13bcf3077", "message": "only add interceptors to necessary points based on config level", "committedDate": "2020-12-09T17:06:19Z", "type": "commit"}, {"oid": "9f921410d6ba018b1cb9cb35874a169df66157c7", "url": "https://github.com/apache/skywalking/commit/9f921410d6ba018b1cb9cb35874a169df66157c7", "message": "don't need to check level. only acceptable have interceptors", "committedDate": "2020-12-09T17:19:43Z", "type": "commit"}, {"oid": "42862034936fb149d89e070124eddf1bb267e7d9", "url": "https://github.com/apache/skywalking/commit/42862034936fb149d89e070124eddf1bb267e7d9", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: Brandon Fergerson <bfergerson@apache.org>", "committedDate": "2020-12-09T23:52:57Z", "type": "commit"}, {"oid": "04eab4958423cfd33e80ae1a94f52716729cb580", "url": "https://github.com/apache/skywalking/commit/04eab4958423cfd33e80ae1a94f52716729cb580", "message": "Merge pull request #11 from BFergerson/bf-master\n\nOnly add interceptors to necessary points based on config level", "committedDate": "2020-12-10T00:52:40Z", "type": "commit"}, {"oid": "f5cb91dd2e0e82534c59525f3637743cd8c4a224", "url": "https://github.com/apache/skywalking/commit/f5cb91dd2e0e82534c59525f3637743cd8c4a224", "message": "fix UT for ContextConfig", "committedDate": "2020-12-10T03:01:17Z", "type": "commit"}, {"oid": "a3506e66149eb4115ea434872a5146f898b1fa67", "url": "https://github.com/apache/skywalking/commit/a3506e66149eb4115ea434872a5146f898b1fa67", "message": "Fix the problem of CI failure:ignore the log level of fatal from logback", "committedDate": "2020-12-10T04:08:27Z", "type": "forcePushed"}, {"oid": "a3506e66149eb4115ea434872a5146f898b1fa67", "url": "https://github.com/apache/skywalking/commit/a3506e66149eb4115ea434872a5146f898b1fa67", "message": "Fix the problem of CI failure:ignore the log level of fatal from logback", "committedDate": "2020-12-10T04:08:27Z", "type": "commit"}, {"oid": "0dec4643b90ef55f9ba37d60048a6c80bd5afa02", "url": "https://github.com/apache/skywalking/commit/0dec4643b90ef55f9ba37d60048a6c80bd5afa02", "message": "create project for logger-plugin(#4545)", "committedDate": "2020-10-03T06:21:04Z", "type": "commit"}, {"oid": "f69fc08c3716e09d7238923da398bb58a2785363", "url": "https://github.com/apache/skywalking/commit/f69fc08c3716e09d7238923da398bb58a2785363", "message": "create plugin project for logger-plugin", "committedDate": "2020-10-04T10:29:49Z", "type": "commit"}, {"oid": "32eb8b79c7caa45899fd446bd131b05a07c38347", "url": "https://github.com/apache/skywalking/commit/32eb8b79c7caa45899fd446bd131b05a07c38347", "message": "Merge branch 'master' of https://github.com/apache/skywalking into f-log", "committedDate": "2020-10-05T02:51:20Z", "type": "commit"}, {"oid": "ce8f8758dc9983a3b4022fb7783015af838f4ff0", "url": "https://github.com/apache/skywalking/commit/ce8f8758dc9983a3b4022fb7783015af838f4ff0", "message": "some test works", "committedDate": "2020-11-18T02:41:37Z", "type": "commit"}, {"oid": "b606cea1cee98756cc4cd083f12789a04c9bc97a", "url": "https://github.com/apache/skywalking/commit/b606cea1cee98756cc4cd083f12789a04c9bc97a", "message": "#5863 complete logger plugin scenario", "committedDate": "2020-11-27T08:36:34Z", "type": "commit"}, {"oid": "5fa47a9e4a929e217463b7692dd4216c82a53043", "url": "https://github.com/apache/skywalking/commit/5fa47a9e4a929e217463b7692dd4216c82a53043", "message": "Merge branch 'master' of https://github.com/apache/skywalking into f-log", "committedDate": "2020-11-27T08:54:40Z", "type": "commit"}, {"oid": "f7d37c1dab3143c246894dae4638f970999fdca9", "url": "https://github.com/apache/skywalking/commit/f7d37c1dab3143c246894dae4638f970999fdca9", "message": "normalized logconfig", "committedDate": "2020-11-27T23:52:56Z", "type": "commit"}, {"oid": "c5bb28c983b6a6c964ca8255326fdcaf598d1810", "url": "https://github.com/apache/skywalking/commit/c5bb28c983b6a6c964ca8255326fdcaf598d1810", "message": "impl for log4j/log4j2", "committedDate": "2020-11-28T00:40:40Z", "type": "commit"}, {"oid": "2030e8cb7731c1fa67702e20b89e040b017083a7", "url": "https://github.com/apache/skywalking/commit/2030e8cb7731c1fa67702e20b89e040b017083a7", "message": "Merge branch 'f-log' into bf-master", "committedDate": "2020-11-28T00:55:10Z", "type": "commit"}, {"oid": "d3d0460bb3afbe9bdce6fb2c18d9e719f3af6778", "url": "https://github.com/apache/skywalking/commit/d3d0460bb3afbe9bdce6fb2c18d9e719f3af6778", "message": "Merge pull request #7 from BFergerson/master\n\nImpl log4j/log4j2", "committedDate": "2020-11-28T02:26:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyNzg1MA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r531827850", "bodyText": "CatchAndPrintStackTrace:  Logging or rethrowing exceptions should usually be preferred to catching and calling printStackTrace", "author": "sonatype-lift", "createdAt": "2020-11-28T03:19:35Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/ContextConfig.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackageNotFoundException;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackagePath;\n+import org.yaml.snakeyaml.Yaml;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * contains all config of the logger plugin.\n+ */\n+public class ContextConfig {\n+\n+    private final LoggerConfig logbackConfig;\n+    private final LoggerConfig log4jConfig;\n+    private final LoggerConfig log4j2Config;\n+\n+    private ContextConfig(LoggerConfig logbackConfig, LoggerConfig log4jConfig, LoggerConfig log4j2Config) {\n+        this.logbackConfig = logbackConfig;\n+        this.log4jConfig = log4jConfig;\n+        this.log4j2Config = log4j2Config;\n+    }\n+\n+    public LoggerConfig getLogbackConfig() {\n+        return logbackConfig;\n+    }\n+\n+    public LoggerConfig getLog4jConfig() {\n+        return log4jConfig;\n+    }\n+\n+    public LoggerConfig getLog4j2Config() {\n+        return log4j2Config;\n+    }\n+\n+    public static ContextConfig getInstance() {\n+        return HolderContextConfig.INSTANCE;\n+    }\n+\n+    //use singleton\n+    private static class HolderContextConfig {\n+        private final static ContextConfig INSTANCE = initContextConfig();\n+\n+        private static ContextConfig initContextConfig() {\n+            // judge whether has yaml file\n+            File configFile;\n+            try {\n+                configFile = new File(AgentPackagePath.getPath(), \"/config/logconfig.yaml\");\n+            } catch (AgentPackageNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+            LoggerConfig logbackConfig = null, log4jConfig = null, log4j2Config = null;\n+            // not has config file, make config default\n+            if (!configFile.exists()) {\n+                List<String> packages = new ArrayList<>();\n+                packages.add(\"*\");\n+                logbackConfig = new LoggerConfig(\"logback\", packages, LogLevel.ERROR);\n+                log4jConfig = new LoggerConfig(\"log4j\", packages, LogLevel.ERROR);\n+                log4j2Config = new LoggerConfig(\"log4j2\", packages, LogLevel.ERROR);\n+            } else {\n+                // use config file to init ContextConfig\n+                FileInputStream configFileInputStream = null;\n+                try {\n+                    configFileInputStream = new FileInputStream(configFile);\n+                    List<LoggerConfig> configs = parseConfigFile(configFileInputStream);\n+                    // initialization of variables which are described in config file\n+                    for (LoggerConfig loggerConfig : configs) {\n+                        if (\"logback\".equals(loggerConfig.getName())) {\n+                            logbackConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j\".equals(loggerConfig.getName())) {\n+                            log4jConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j2\".equals(loggerConfig.getName())) {\n+                            log4j2Config = fillLoggerConfig(loggerConfig);\n+                        } else {\n+                            throw new IllegalArgumentException();\n+                        }\n+                    }\n+                } catch (FileNotFoundException e) {\n+                    e.printStackTrace();\n+                } finally {\n+                    //close input stream\n+                    if (configFileInputStream != null) {\n+                        try {\n+                            configFileInputStream.close();\n+                        } catch (IOException e) {\n+                            e.printStackTrace();", "originalCommit": "d3d0460bb3afbe9bdce6fb2c18d9e719f3af6778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyNzg1Mg==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r531827852", "bodyText": "CatchAndPrintStackTrace:  Logging or rethrowing exceptions should usually be preferred to catching and calling printStackTrace", "author": "sonatype-lift", "createdAt": "2020-11-28T03:19:36Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/ContextConfig.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackageNotFoundException;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackagePath;\n+import org.yaml.snakeyaml.Yaml;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * contains all config of the logger plugin.\n+ */\n+public class ContextConfig {\n+\n+    private final LoggerConfig logbackConfig;\n+    private final LoggerConfig log4jConfig;\n+    private final LoggerConfig log4j2Config;\n+\n+    private ContextConfig(LoggerConfig logbackConfig, LoggerConfig log4jConfig, LoggerConfig log4j2Config) {\n+        this.logbackConfig = logbackConfig;\n+        this.log4jConfig = log4jConfig;\n+        this.log4j2Config = log4j2Config;\n+    }\n+\n+    public LoggerConfig getLogbackConfig() {\n+        return logbackConfig;\n+    }\n+\n+    public LoggerConfig getLog4jConfig() {\n+        return log4jConfig;\n+    }\n+\n+    public LoggerConfig getLog4j2Config() {\n+        return log4j2Config;\n+    }\n+\n+    public static ContextConfig getInstance() {\n+        return HolderContextConfig.INSTANCE;\n+    }\n+\n+    //use singleton\n+    private static class HolderContextConfig {\n+        private final static ContextConfig INSTANCE = initContextConfig();\n+\n+        private static ContextConfig initContextConfig() {\n+            // judge whether has yaml file\n+            File configFile;\n+            try {\n+                configFile = new File(AgentPackagePath.getPath(), \"/config/logconfig.yaml\");\n+            } catch (AgentPackageNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+            LoggerConfig logbackConfig = null, log4jConfig = null, log4j2Config = null;\n+            // not has config file, make config default\n+            if (!configFile.exists()) {\n+                List<String> packages = new ArrayList<>();\n+                packages.add(\"*\");\n+                logbackConfig = new LoggerConfig(\"logback\", packages, LogLevel.ERROR);\n+                log4jConfig = new LoggerConfig(\"log4j\", packages, LogLevel.ERROR);\n+                log4j2Config = new LoggerConfig(\"log4j2\", packages, LogLevel.ERROR);\n+            } else {\n+                // use config file to init ContextConfig\n+                FileInputStream configFileInputStream = null;\n+                try {\n+                    configFileInputStream = new FileInputStream(configFile);\n+                    List<LoggerConfig> configs = parseConfigFile(configFileInputStream);\n+                    // initialization of variables which are described in config file\n+                    for (LoggerConfig loggerConfig : configs) {\n+                        if (\"logback\".equals(loggerConfig.getName())) {\n+                            logbackConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j\".equals(loggerConfig.getName())) {\n+                            log4jConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j2\".equals(loggerConfig.getName())) {\n+                            log4j2Config = fillLoggerConfig(loggerConfig);\n+                        } else {\n+                            throw new IllegalArgumentException();\n+                        }\n+                    }\n+                } catch (FileNotFoundException e) {\n+                    e.printStackTrace();", "originalCommit": "d3d0460bb3afbe9bdce6fb2c18d9e719f3af6778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9ae15edb91aadea41ddfe4a5b483bca0af5c0f8f", "url": "https://github.com/apache/skywalking/commit/9ae15edb91aadea41ddfe4a5b483bca0af5c0f8f", "message": "translated from log4j2", "committedDate": "2020-11-28T07:46:51Z", "type": "commit"}, {"oid": "45339bc1ea4edb7cfdbe54839f142ff2523731d6", "url": "https://github.com/apache/skywalking/commit/45339bc1ea4edb7cfdbe54839f142ff2523731d6", "message": "impl logger scenarios", "committedDate": "2020-11-28T07:54:02Z", "type": "commit"}, {"oid": "c56a540c244e6397937920dc1494c3d9988f0fba", "url": "https://github.com/apache/skywalking/commit/c56a540c244e6397937920dc1494c3d9988f0fba", "message": "don't work", "committedDate": "2020-11-28T08:00:57Z", "type": "commit"}, {"oid": "1e00ea59342a78b4e187e84afc3c37d468399924", "url": "https://github.com/apache/skywalking/commit/1e00ea59342a78b4e187e84afc3c37d468399924", "message": "Merge pull request #8 from BFergerson/master\n\nImpl logger test scenarios", "committedDate": "2020-11-28T13:09:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NzYzNw==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532057637", "bodyText": "Remove or uncomment", "author": "kezhenxu94", "createdAt": "2020-11-28T16:25:30Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/test/java/org/apache/skywalking/apm/plugin/logger/logback/TestContextConfig.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger.logback;\n+\n+import org.junit.Test;\n+\n+public class TestContextConfig {\n+    @Test\n+    public void testGetInstance() {\n+//        ContextConfig config = ContextConfig.getInstance();\n+//        LoggerConfig logbackConfig = config.getLogbackConfig();\n+//        LoggerConfig log4j2Config = config.getLog4j2Config();\n+//\n+//        //test logback\n+//        assertEquals(logbackConfig.getName(), \"logback\");\n+//        assertEquals(logbackConfig.getExpression(), \"Regular expression\");\n+//        assertEquals(logbackConfig.getLevel(), Level.ERROR);\n+//        assertEquals(logbackConfig.getPackages().get(0).toString(), \"*\");\n+//        assertEquals(logbackConfig.getPattern(), \"%msg%n\");\n+\n+//        //test log4j\n+//        assertEquals(log4j2Config.getName(), \"log4j2\");\n+//        assertEquals(log4j2Config.getExpression(), \"Regular expression\");\n+//        assertEquals(log4j2Config.getLevel(), Level.TRACE);\n+//        assertEquals(log4j2Config.getPattern(), \"%date %level [%thread] %logger{10} [%file:%line] %msg%n\");\n+//        assertEquals(log4j2Config.getPackages().get(0), \"package1\");\n+//        assertEquals(log4j2Config.getPackages().get(1), \"package2\");", "originalCommit": "1e00ea59342a78b4e187e84afc3c37d468399924", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NzgwOQ==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532057809", "bodyText": "use Lombok annotations to remove boilerplate codes", "author": "kezhenxu94", "createdAt": "2020-11-28T16:27:01Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/ContextConfig.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackageNotFoundException;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackagePath;\n+import org.yaml.snakeyaml.Yaml;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * contains all config of the logger plugin.\n+ */\n+public class ContextConfig {\n+\n+    private final LoggerConfig logbackConfig;\n+    private final LoggerConfig log4jConfig;\n+    private final LoggerConfig log4j2Config;\n+\n+    private ContextConfig(LoggerConfig logbackConfig, LoggerConfig log4jConfig, LoggerConfig log4j2Config) {\n+        this.logbackConfig = logbackConfig;\n+        this.log4jConfig = log4jConfig;\n+        this.log4j2Config = log4j2Config;\n+    }\n+\n+    public LoggerConfig getLogbackConfig() {\n+        return logbackConfig;\n+    }\n+\n+    public LoggerConfig getLog4jConfig() {\n+        return log4jConfig;\n+    }\n+\n+    public LoggerConfig getLog4j2Config() {\n+        return log4j2Config;\n+    }\n+\n+    public static ContextConfig getInstance() {\n+        return HolderContextConfig.INSTANCE;\n+    }\n+\n+    //use singleton\n+    private static class HolderContextConfig {\n+        private final static ContextConfig INSTANCE = initContextConfig();\n+\n+        private static ContextConfig initContextConfig() {\n+            // judge whether has yaml file\n+            File configFile;\n+            try {\n+                configFile = new File(AgentPackagePath.getPath(), \"/config/logconfig.yaml\");\n+            } catch (AgentPackageNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+            LoggerConfig logbackConfig = null, log4jConfig = null, log4j2Config = null;\n+            // not has config file, make config default\n+            if (!configFile.exists()) {\n+                List<String> packages = new ArrayList<>();\n+                packages.add(\"*\");\n+                logbackConfig = new LoggerConfig(\"logback\", packages, LogLevel.ERROR);\n+                log4jConfig = new LoggerConfig(\"log4j\", packages, LogLevel.ERROR);\n+                log4j2Config = new LoggerConfig(\"log4j2\", packages, LogLevel.ERROR);\n+            } else {\n+                // use config file to init ContextConfig\n+                FileInputStream configFileInputStream = null;\n+                try {\n+                    configFileInputStream = new FileInputStream(configFile);\n+                    List<LoggerConfig> configs = parseConfigFile(configFileInputStream);\n+                    // initialization of variables which are described in config file\n+                    for (LoggerConfig loggerConfig : configs) {\n+                        if (\"logback\".equals(loggerConfig.getName())) {\n+                            logbackConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j\".equals(loggerConfig.getName())) {\n+                            log4jConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j2\".equals(loggerConfig.getName())) {\n+                            log4j2Config = fillLoggerConfig(loggerConfig);\n+                        } else {\n+                            throw new IllegalArgumentException();\n+                        }\n+                    }\n+                } catch (FileNotFoundException e) {\n+                    e.printStackTrace();\n+                } finally {\n+                    //close input stream\n+                    if (configFileInputStream != null) {\n+                        try {\n+                            configFileInputStream.close();\n+                        } catch (IOException e) {\n+                            e.printStackTrace();\n+                        }\n+                    }\n+                }\n+                //creat ContextConfig object\n+            }\n+            return new ContextConfig(logbackConfig, log4jConfig, log4j2Config);\n+        }\n+\n+        /**\n+         * @param fileInputStream the input stream of config file\n+         * @return the list of configuration file analysis result objects\n+         */\n+        private static List<LoggerConfig> parseConfigFile(FileInputStream fileInputStream) {\n+            Yaml yaml = new Yaml();\n+            List<LoggerConfig> configs = new ArrayList<>();\n+            for (Object o : (List) yaml.loadAll(fileInputStream).iterator().next()) {\n+                if (o instanceof Map) {\n+                    Map configMap = (Map) o;\n+                    LoggerConfig loggerConfig = new LoggerConfig();\n+                    loggerConfig.setName((String) configMap.get(\"name\"));\n+\n+                    if (configMap.get(\"level\") != null) {\n+                        loggerConfig.setLevel(LogLevel.valueOf(configMap.get(\"level\").toString().toUpperCase()));\n+                    }\n+                    if (configMap.get(\"packages\") instanceof List) {\n+                        loggerConfig.setPackages((List<String>) configMap.get(\"packages\"));\n+                    }\n+                    configs.add(loggerConfig);\n+                } else {\n+                    return null;\n+                }\n+            }\n+            return configs;\n+        }\n+\n+        /**\n+         * @param src instance which need to fill\n+         * @return object that has been filled with default values\n+         */\n+        private static LoggerConfig fillLoggerConfig(LoggerConfig src) {\n+            if (src == null) {\n+                return null;\n+            }\n+            if (src.getLevel() == null) {\n+                src.setLevel(LogLevel.ERROR);\n+            }\n+            if (src.getPackages() == null) {\n+                List<String> packages = new ArrayList<>();\n+                packages.add(\"*\");\n+                src.setPackages(packages);\n+            }\n+            return src;\n+        }\n+    }\n+\n+    static class LoggerConfig implements Cloneable {", "originalCommit": "1e00ea59342a78b4e187e84afc3c37d468399924", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1ODEyNQ==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532058125", "bodyText": "use try-with-resouces?", "author": "kezhenxu94", "createdAt": "2020-11-28T16:30:16Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/ContextConfig.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackageNotFoundException;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackagePath;\n+import org.yaml.snakeyaml.Yaml;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * contains all config of the logger plugin.\n+ */\n+public class ContextConfig {\n+\n+    private final LoggerConfig logbackConfig;\n+    private final LoggerConfig log4jConfig;\n+    private final LoggerConfig log4j2Config;\n+\n+    private ContextConfig(LoggerConfig logbackConfig, LoggerConfig log4jConfig, LoggerConfig log4j2Config) {\n+        this.logbackConfig = logbackConfig;\n+        this.log4jConfig = log4jConfig;\n+        this.log4j2Config = log4j2Config;\n+    }\n+\n+    public LoggerConfig getLogbackConfig() {\n+        return logbackConfig;\n+    }\n+\n+    public LoggerConfig getLog4jConfig() {\n+        return log4jConfig;\n+    }\n+\n+    public LoggerConfig getLog4j2Config() {\n+        return log4j2Config;\n+    }\n+\n+    public static ContextConfig getInstance() {\n+        return HolderContextConfig.INSTANCE;\n+    }\n+\n+    //use singleton\n+    private static class HolderContextConfig {\n+        private final static ContextConfig INSTANCE = initContextConfig();\n+\n+        private static ContextConfig initContextConfig() {\n+            // judge whether has yaml file\n+            File configFile;\n+            try {\n+                configFile = new File(AgentPackagePath.getPath(), \"/config/logconfig.yaml\");\n+            } catch (AgentPackageNotFoundException e) {\n+                throw new RuntimeException(e);\n+            }\n+            LoggerConfig logbackConfig = null, log4jConfig = null, log4j2Config = null;\n+            // not has config file, make config default\n+            if (!configFile.exists()) {\n+                List<String> packages = new ArrayList<>();\n+                packages.add(\"*\");\n+                logbackConfig = new LoggerConfig(\"logback\", packages, LogLevel.ERROR);\n+                log4jConfig = new LoggerConfig(\"log4j\", packages, LogLevel.ERROR);\n+                log4j2Config = new LoggerConfig(\"log4j2\", packages, LogLevel.ERROR);\n+            } else {\n+                // use config file to init ContextConfig\n+                FileInputStream configFileInputStream = null;\n+                try {", "originalCommit": "1e00ea59342a78b4e187e84afc3c37d468399924", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "272500af2a4959d33bef7f556174c494bf22efe7", "url": "https://github.com/apache/skywalking/commit/272500af2a4959d33bef7f556174c494bf22efe7", "message": "fix some question of file format", "committedDate": "2020-11-29T13:03:39Z", "type": "commit"}, {"oid": "216d3b109b2844b158c612b2f75eafb5cd050497", "url": "https://github.com/apache/skywalking/commit/216d3b109b2844b158c612b2f75eafb5cd050497", "message": "Refactor ContextConfig:\n1. use loggerConfig.properties as a configure file\n2. use try-with-resources\n3. use lombok", "committedDate": "2020-11-29T15:08:40Z", "type": "commit"}, {"oid": "dc22822b6ebca7f1db48b8beacbc8552d169ed81", "url": "https://github.com/apache/skywalking/commit/dc22822b6ebca7f1db48b8beacbc8552d169ed81", "message": "Merge branch 'master' into f-log", "committedDate": "2020-11-29T15:17:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIzMTA0Mg==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532231042", "bodyText": "NULL_DEREFERENCE:  object configFile last assigned on line 65 could be null and is dereferenced at line 72.", "author": "sonatype-lift", "createdAt": "2020-11-29T16:14:11Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/ContextConfig.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import lombok.Setter;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackageNotFoundException;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackagePath;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.Map;\n+import java.util.HashMap;\n+\n+/**\n+ * contains all config of the logger plugin.\n+ */\n+@Getter\n+public class ContextConfig {\n+\n+    private final LoggerConfig logbackConfig;\n+    private final LoggerConfig log4jConfig;\n+    private final LoggerConfig log4j2Config;\n+\n+    private ContextConfig(LoggerConfig logbackConfig, LoggerConfig log4jConfig, LoggerConfig log4j2Config) {\n+        this.logbackConfig = logbackConfig;\n+        this.log4jConfig = log4jConfig;\n+        this.log4j2Config = log4j2Config;\n+    }\n+\n+    public static ContextConfig getInstance() {\n+        return HolderContextConfig.INSTANCE;\n+    }\n+\n+    //use singleton\n+    private static class HolderContextConfig {\n+        private final static ContextConfig INSTANCE = initContextConfig();\n+\n+        private static ContextConfig initContextConfig() {\n+            // judge whether has yaml file\n+            LoggerConfig logbackConfig = null, log4jConfig = null, log4j2Config = null;\n+            File configFile = null;\n+            try {\n+                configFile = new File(AgentPackagePath.getPath(), \"/config/logger-plugin/logconfig.properties\");\n+            } catch (AgentPackageNotFoundException e) {\n+                e.printStackTrace();\n+            }\n+            // not has config file, make config default\n+            if (!configFile.exists()) {", "originalCommit": "216d3b109b2844b158c612b2f75eafb5cd050497", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6cadbc3aa669f19d1ce795870c572f95e0375c9e", "url": "https://github.com/apache/skywalking/commit/6cadbc3aa669f19d1ce795870c572f95e0375c9e", "message": "Refactor ContextConfig:log exception instead of calling printStackTrace", "committedDate": "2020-11-30T01:59:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyMDIwOQ==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532320209", "bodyText": "Doesn't need to be clonable (nothing clones it).", "author": "BFergerson", "createdAt": "2020-11-30T02:47:15Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/ContextConfig.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import lombok.Setter;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackageNotFoundException;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackagePath;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.Map;\n+import java.util.HashMap;\n+\n+/**\n+ * contains all config of the logger plugin.\n+ */\n+@Getter\n+public class ContextConfig {\n+\n+    private final LoggerConfig logbackConfig;\n+    private final LoggerConfig log4jConfig;\n+    private final LoggerConfig log4j2Config;\n+\n+    private ContextConfig(LoggerConfig logbackConfig, LoggerConfig log4jConfig, LoggerConfig log4j2Config) {\n+        this.logbackConfig = logbackConfig;\n+        this.log4jConfig = log4jConfig;\n+        this.log4j2Config = log4j2Config;\n+    }\n+\n+    public static ContextConfig getInstance() {\n+        return HolderContextConfig.INSTANCE;\n+    }\n+\n+    //use singleton\n+    private static class HolderContextConfig {\n+        private final static ContextConfig INSTANCE = initContextConfig();\n+\n+        private static ContextConfig initContextConfig() {\n+            // judge whether has yaml file\n+            LoggerConfig logbackConfig = null, log4jConfig = null, log4j2Config = null;\n+            File configFile = null;\n+            try {\n+                configFile = new File(AgentPackagePath.getPath(), \"/config/logger-plugin/logconfig.properties\");\n+            } catch (AgentPackageNotFoundException e) {\n+                e.printStackTrace();\n+            }\n+            // not has config file, make config default\n+            if (!configFile.exists()) {\n+                List<String> packages = new ArrayList<>();\n+                packages.add(\"*\");\n+                logbackConfig = new LoggerConfig(\"logback\", packages, LogLevel.ERROR);\n+                log4jConfig = new LoggerConfig(\"log4j\", packages, LogLevel.ERROR);\n+                log4j2Config = new LoggerConfig(\"log4j2\", packages, LogLevel.ERROR);\n+            } else {\n+                // use config file to init ContextConfig\n+                try (FileInputStream configFileInputStream = new FileInputStream(configFile)) {\n+                    List<LoggerConfig> configs = parseConfigFile(configFileInputStream);\n+                    // initialization of variables which are described in config file\n+                    for (LoggerConfig loggerConfig : configs) {\n+                        if (\"logback\".equals(loggerConfig.getName())) {\n+                            logbackConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j\".equals(loggerConfig.getName())) {\n+                            log4jConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j2\".equals(loggerConfig.getName())) {\n+                            log4j2Config = fillLoggerConfig(loggerConfig);\n+                        } else {\n+                            throw new IllegalArgumentException();\n+                        }\n+                    }\n+                } catch (IOException e) {\n+                    e.printStackTrace();\n+                }\n+                //creat ContextConfig object\n+            }\n+            return new ContextConfig(logbackConfig, log4jConfig, log4j2Config);\n+        }\n+\n+        /**\n+         * @param fileInputStream the input stream of config file\n+         * @return the list of configuration file analysis result objects\n+         */\n+        private static List<LoggerConfig> parseConfigFile(FileInputStream fileInputStream) throws IOException {\n+            Properties p = new Properties();\n+            p.load(fileInputStream);\n+            List<LoggerConfig> configs = new ArrayList<>();\n+            LoggerConfig logback, log4j, log4j2;\n+            logback = fillPackageAndLevel(p.getProperty(\"logback.packages\"), p.getProperty(\"logback.level\"));\n+            log4j = fillPackageAndLevel(p.getProperty(\"log4j.packages\"), p.getProperty(\"log4j.level\"));\n+            log4j2 = fillPackageAndLevel(p.getProperty(\"log4j2.packages\"), p.getProperty(\"log4j2.level\"));\n+            if (logback != null) {\n+                logback.setName(\"logback\");\n+                configs.add(logback);\n+            }\n+            if (log4j != null) {\n+                log4j.setName(\"log4j\");\n+                configs.add(log4j);\n+            }\n+            if (log4j2 != null) {\n+                log4j2.setName(\"log4j2\");\n+                configs.add(log4j2);\n+            }\n+            return configs;\n+        }\n+\n+        private static LoggerConfig fillPackageAndLevel(String packages, String level) {\n+            LoggerConfig loggerConfig = null;\n+            if (packages != null || level != null) {\n+                loggerConfig = new LoggerConfig();\n+                if (packages != null) {\n+                    loggerConfig.setPackages(splitPackages(packages));\n+                }\n+                if (level != null) {\n+                    loggerConfig.setLevel(LogLevel.valueOf(level.toUpperCase()));\n+                }\n+            }\n+            return loggerConfig;\n+        }\n+\n+        private static List<String> splitPackages(String packages) {\n+            return Arrays.asList(packages.split(\",\"));\n+        }\n+\n+        /**\n+         * @param src instance which need to fill\n+         * @return object that has been filled with default values\n+         */\n+        private static LoggerConfig fillLoggerConfig(LoggerConfig src) {\n+            if (src == null) {\n+                return null;\n+            }\n+            if (src.getLevel() == null) {\n+                src.setLevel(LogLevel.ERROR);\n+            }\n+            if (src.getPackages() == null) {\n+                List<String> packages = new ArrayList<>();\n+                packages.add(\"*\");\n+                src.setPackages(packages);\n+            }\n+            return src;\n+        }\n+    }\n+\n+    @Getter\n+    @Setter\n+    @AllArgsConstructor\n+    @NoArgsConstructor\n+    static class LoggerConfig implements Cloneable {\n+        private String name;\n+        private List<String> packages;\n+        private LogLevel level;\n+\n+        /**\n+         * Encapsulate the obtained log information into a map\n+         *\n+         * @param loggerName the name of log system,eg:logback\n+         * @param level      which level of log need to recorder\n+         * @param args       the params of log\n+         * @return a message map\n+         */\n+        public Map<String, String> toMessageMap(String loggerName, String level, Object... args) {\n+            Map<String, String> messageMap = new HashMap<>();\n+            messageMap.put(\"log.kind\", loggerName);\n+            messageMap.put(\"event\", level);\n+            int paramStart = 2;\n+            // like `warn(String format, Object arg)`\n+            if (args[0] instanceof String) {\n+                paramStart = 1;\n+                messageMap.put(\"message\", args[0].toString());\n+            } else {\n+                messageMap.put(\"message\", args[1].toString());\n+            }\n+            //build log\n+            for (int i = paramStart; i < args.length; i++) {\n+                String key = \"param.\" + (i - paramStart + 1);\n+                messageMap.put(key, args[i].toString());\n+            }\n+            return messageMap;\n+        }\n+\n+        @Override\n+        protected Object clone() throws CloneNotSupportedException {", "originalCommit": "dc22822b6ebca7f1db48b8beacbc8552d169ed81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNjU1Ng==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532326556", "bodyText": "Ok, I will fix it.", "author": "vcjmhg", "createdAt": "2020-11-30T03:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyMDIwOQ=="}], "type": "inlineReview"}, {"oid": "29e03333d548ae7ebcdb0ae6873e84ffa33af0e5", "url": "https://github.com/apache/skywalking/commit/29e03333d548ae7ebcdb0ae6873e84ffa33af0e5", "message": "test for logger-plugin(4545)", "committedDate": "2020-11-30T03:16:23Z", "type": "commit"}, {"oid": "24545d92faa3c2718eede4087d5c545fc23ad000", "url": "https://github.com/apache/skywalking/commit/24545d92faa3c2718eede4087d5c545fc23ad000", "message": "Update apm-sniffer/apm-sdk-plugin/logger-plugin/pom.xml", "committedDate": "2020-11-30T03:26:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMDQ5MA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532330490", "bodyText": "From the performance perspective, this is not a good practice. You have to check the method name repeatedly on the runtime. The better way to check this on the bootstrap stage, intercepting the necessary methods.", "author": "wu-sheng", "createdAt": "2020-11-30T03:33:42Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/define/Log4j2LoggerInstrumentation.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.match.NameMatch;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+public class Log4j2LoggerInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {\n+    private static final String ENHANCE_CLASS = \"org.apache.logging.log4j.spi.AbstractLogger\";\n+    private static final String INTERCEPT_CLASS = \"org.apache.skywalking.apm.plugin.logger.Log4j2LoggerInterceptor\";\n+    private static final String[] INTERCEPT_METHODS = {\"trace\", \"debug\", \"info\", \"error\", \"warn\", \"fatal\"};\n+\n+    @Override\n+    protected ClassMatch enhanceClass() {\n+        return NameMatch.byName(ENHANCE_CLASS);\n+    }\n+\n+    @Override\n+    public ConstructorInterceptPoint[] getConstructorsInterceptPoints() {\n+        return new ConstructorInterceptPoint[0];\n+    }\n+\n+    @Override\n+    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {\n+        return new InstanceMethodsInterceptPoint[]{\n+                new InstanceMethodsInterceptPoint() {\n+                    @Override\n+                    public ElementMatcher<MethodDescription> getMethodsMatcher() {\n+                        return named(INTERCEPT_METHODS[0])\n+                                .or(named(INTERCEPT_METHODS[1]))\n+                                .or(named(INTERCEPT_METHODS[2]))\n+                                .or(named(INTERCEPT_METHODS[3]))\n+                                .or(named(INTERCEPT_METHODS[4]))\n+                                .or(named(INTERCEPT_METHODS[5]));", "originalCommit": "24545d92faa3c2718eede4087d5c545fc23ad000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMzUyOA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532333528", "bodyText": "I know there would be a challenge as you could have a complex set of rules. At least, consider #5914 (comment).", "author": "wu-sheng", "createdAt": "2020-11-30T03:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMDQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4ODkxNg==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532388916", "bodyText": "From the performance perspective, this is not a good practice. You have to check the method name repeatedly on the runtime. The better way to check this on the bootstrap stage, intercepting the necessary methods\n\nWe can determine which insertion points to set according to the method category in the configuration file, right? @wu-sheng @BFergerson . The code just like this:\nLogbackLoggerInstrumentation.class\n@Override\n    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {\n        if (CONFIG == null) {\n            return null;\n        }\n        return new InstanceMethodsInterceptPoint[]{\n                new InstanceMethodsInterceptPoint() {\n\n                    @Override\n                    public ElementMatcher<MethodDescription> getMethodsMatcher() {\n                        List<String> levelList = CONFIG.getUpeerLevelList(CONFIG.getLevel());\n                        ElementMatcher.Junction<MethodDescription> canInstrumentMethods = named(levelList.get(0));\n                        for (int i = 1; i < levelList.size(); i++) {\n                            canInstrumentMethods = canInstrumentMethods.or(named(levelList.get(i)));\n                        }\n                        return canInstrumentMethods;\n                    }\n\n                    @Override\n                    public String getMethodsInterceptor() {\n                        return INTERCEPT_CLASS;\n                    }\n\n                    @Override\n                    public boolean isOverrideArgs() {\n                        return false;\n                    }\n                }\n        };\n    }\nContextConfig.class\npublic List<String> getUpeerLevelList(LogLevel level) {\n            List<String> levelList = new ArrayList<>();\n            for (LogLevel l : LogLevel.values()) {\n                if (level.getPriority() >= l.getPriority()) {\n                    levelList.add(l.toString().toLowCase());\n                }\n            }\n            return levelList;\n        }", "author": "vcjmhg", "createdAt": "2020-11-30T07:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMDQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTExMA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532331110", "bodyText": "In the real world coding, there is a log level config in the app code level, such as in log4j.xml. What do you expect if it mismatched w/ plugin's config?\nIn the current implementation, you are overriding it. Is this a good way? @vcjmhg @BFergerson", "author": "wu-sheng", "createdAt": "2020-11-30T03:36:12Z", "path": "apm-sniffer/apm-sdk-plugin/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/Log4j2LoggerInterceptor.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+\n+public class Log4j2LoggerInterceptor implements InstanceMethodsAroundInterceptor {\n+\n+    private static final ContextConfig.LoggerConfig CONFIG = ContextConfig.getInstance().getLog4j2Config();\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n+        String loggerName = objInst.getSkyWalkingDynamicField().toString();", "originalCommit": "24545d92faa3c2718eede4087d5c545fc23ad000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMzYwMA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532333600", "bodyText": "I think the argument could be made that these log levels have different contexts and therefore must be configured independently. What is the alternative? Waiting till the user's logging framework is fully loaded and using that to generate the monitored log configuration?", "author": "BFergerson", "createdAt": "2020-11-30T03:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzNTM5Nw==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532335397", "bodyText": "I think the most confusing thing would be 2 configurations. Eventually, I would expect the Satellite project to take the responsibility of the logging collecting, rather than using tracing context.\nIn the short term, we could try to use this, as it is simple enough.\nAnd, log level should be available when the interceptor invoking, right? How about we use it directly? such as this#isDebugEnabled?\nThe idea is from the performance perspective. If users think logging to file or logging system had over-load risk, it definitely should have more risks to collect those through tracing core. Right?\nSo, we could have our config file but basically should have lower-priority comparing to the official log config file(such as log4j.xml). Is this better? Of course, if we provide that, we could have a collecting all loggable things configuration in default, such as no config file, mean while this plugin must be placed in the optional plugin to avoid OOM.", "author": "wu-sheng", "createdAt": "2020-11-30T03:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzNTg0MA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532335840", "bodyText": "FYI @EvanLjp, we are doing log collection for now.", "author": "wu-sheng", "createdAt": "2020-11-30T03:59:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4Njg4Nw==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r532986887", "bodyText": "@wu-sheng, I've made the changes you suggested here. This makes the monitored logging configuration a lower priority than the official log config.", "author": "BFergerson", "createdAt": "2020-12-01T00:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTExMA=="}], "type": "inlineReview"}, {"oid": "8b1baa4fba4ec6666fbcb3847dc645ab71fa43fd", "url": "https://github.com/apache/skywalking/commit/8b1baa4fba4ec6666fbcb3847dc645ab71fa43fd", "message": "update documents for Logger-plugin", "committedDate": "2020-11-30T05:31:49Z", "type": "commit"}, {"oid": "fffaf3e65ad8bacf298d36ccd088b8132640a3ae", "url": "https://github.com/apache/skywalking/commit/fffaf3e65ad8bacf298d36ccd088b8132640a3ae", "message": "determine which insertion points to set according to the method category in the configuration file", "committedDate": "2020-11-30T08:24:55Z", "type": "commit"}, {"oid": "c0aa895bc6959db8cfc1960475563d8774b22d60", "url": "https://github.com/apache/skywalking/commit/c0aa895bc6959db8cfc1960475563d8774b22d60", "message": "Merge branch 'master' into f-log", "committedDate": "2020-11-30T09:35:52Z", "type": "commit"}, {"oid": "64086dd8143909324167143f22d08ab9b6b421a9", "url": "https://github.com/apache/skywalking/commit/64086dd8143909324167143f22d08ab9b6b421a9", "message": "simplify, fix spelling", "committedDate": "2020-11-30T23:19:23Z", "type": "commit"}, {"oid": "2ca09b5d2328455db791bd56fc17bfa49539e089", "url": "https://github.com/apache/skywalking/commit/2ca09b5d2328455db791bd56fc17bfa49539e089", "message": "simplify, fix spelling, impl log level checking", "committedDate": "2020-12-01T00:02:31Z", "type": "commit"}, {"oid": "29f220d1232c985387d2aeb437e9f139996dbeba", "url": "https://github.com/apache/skywalking/commit/29f220d1232c985387d2aeb437e9f139996dbeba", "message": "Merge pull request #1 from vcjmhg/f-log\n\nmerge up", "committedDate": "2020-12-01T00:09:09Z", "type": "commit"}, {"oid": "0630f53941f7181eca4338a2156717717b2a02a8", "url": "https://github.com/apache/skywalking/commit/0630f53941f7181eca4338a2156717717b2a02a8", "message": "Merge branch 'master' of https://github.com/BFergerson/skywalking into bf-master", "committedDate": "2020-12-01T00:09:18Z", "type": "commit"}, {"oid": "b61d563d4ff3f1bebf86b7940d5a0f6697bf656c", "url": "https://github.com/apache/skywalking/commit/b61d563d4ff3f1bebf86b7940d5a0f6697bf656c", "message": "don't need", "committedDate": "2020-12-01T00:45:38Z", "type": "commit"}, {"oid": "546ebaca43a1f7ef6086f7a5cce507e0504f0240", "url": "https://github.com/apache/skywalking/commit/546ebaca43a1f7ef6086f7a5cce507e0504f0240", "message": "Merge pull request #9 from BFergerson/master\n\nSome changes", "committedDate": "2020-12-01T02:26:12Z", "type": "commit"}, {"oid": "1afbda41fc180226ec2f96ab7875dff1c369159b", "url": "https://github.com/apache/skywalking/commit/1afbda41fc180226ec2f96ab7875dff1c369159b", "message": "Merge branch 'master' into f-log", "committedDate": "2020-12-01T02:26:47Z", "type": "commit"}, {"oid": "85669f1095532a741d2ebabc12610cace0a6e774", "url": "https://github.com/apache/skywalking/commit/85669f1095532a741d2ebabc12610cace0a6e774", "message": "remove unused code", "committedDate": "2020-12-01T05:05:16Z", "type": "commit"}, {"oid": "f85c4352b62963d9e2d15197a4172ed351639cde", "url": "https://github.com/apache/skywalking/commit/f85c4352b62963d9e2d15197a4172ed351639cde", "message": "remove logger-plugin project into optional-plugins", "committedDate": "2020-12-02T01:46:01Z", "type": "commit"}, {"oid": "04c476570525b7dd4e1e12f76273c857fa273a68", "url": "https://github.com/apache/skywalking/commit/04c476570525b7dd4e1e12f76273c857fa273a68", "message": "change the running mode of logger-plugin testcase(contains logback-scenario,log4j-scenario,log-scenario)", "committedDate": "2020-12-02T01:48:12Z", "type": "commit"}, {"oid": "5ff2a5d7a00d9c2f318c4f54709eb8c26106a19b", "url": "https://github.com/apache/skywalking/commit/5ff2a5d7a00d9c2f318c4f54709eb8c26106a19b", "message": "move logger-plugin project into optional-plugins", "committedDate": "2020-12-02T02:34:18Z", "type": "commit"}, {"oid": "c3083d936423c29f0760da11bbbfe417114c5a1b", "url": "https://github.com/apache/skywalking/commit/c3083d936423c29f0760da11bbbfe417114c5a1b", "message": "change the running mode of logger-plugin testcase(contains logback-scenario,log4j-scenario,log-scenario)", "committedDate": "2020-12-02T02:34:18Z", "type": "commit"}, {"oid": "c6b4707ebf0d2f03b4d6dad7958946393d15c6e5", "url": "https://github.com/apache/skywalking/commit/c6b4707ebf0d2f03b4d6dad7958946393d15c6e5", "message": "Merge remote-tracking branch 'origin/f-log' into f-log", "committedDate": "2020-12-02T02:36:46Z", "type": "commit"}, {"oid": "397389601b6dcbb58a678512ea40a8478c90e600", "url": "https://github.com/apache/skywalking/commit/397389601b6dcbb58a678512ea40a8478c90e600", "message": "remove unused dependency", "committedDate": "2020-12-02T05:48:15Z", "type": "commit"}, {"oid": "21e2c747b6fb6868d52cf07f36009d0250b0d147", "url": "https://github.com/apache/skywalking/commit/21e2c747b6fb6868d52cf07f36009d0250b0d147", "message": "Merge branch 'master' into f-log", "committedDate": "2020-12-04T03:55:57Z", "type": "commit"}, {"oid": "94ba3a93727caa8d8277ed4ae5d2156cd3fc4966", "url": "https://github.com/apache/skywalking/commit/94ba3a93727caa8d8277ed4ae5d2156cd3fc4966", "message": "add support for logger framework(logback,log4j,log4j2)", "committedDate": "2020-12-05T06:17:20Z", "type": "commit"}, {"oid": "5ab7fb8406ac588c6d9e9cf3214276ff28ee027d", "url": "https://github.com/apache/skywalking/commit/5ab7fb8406ac588c6d9e9cf3214276ff28ee027d", "message": "change Plugin-list.md", "committedDate": "2020-12-05T07:27:30Z", "type": "commit"}, {"oid": "68d9136657851a422b739980f5cf2fb9ae4851ad", "url": "https://github.com/apache/skywalking/commit/68d9136657851a422b739980f5cf2fb9ae4851ad", "message": "Update docs/en/setup/service-agent/java-agent/README.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-12-05T08:40:47Z", "type": "commit"}, {"oid": "28e1567bbde9b629c297ff656935509733fa19f2", "url": "https://github.com/apache/skywalking/commit/28e1567bbde9b629c297ff656935509733fa19f2", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-12-05T08:41:40Z", "type": "commit"}, {"oid": "a3494d57c3e5b8bf09e772829dec7737ee16329a", "url": "https://github.com/apache/skywalking/commit/a3494d57c3e5b8bf09e772829dec7737ee16329a", "message": "Merge branch 'master' into f-log", "committedDate": "2020-12-05T08:42:01Z", "type": "commit"}, {"oid": "719f3e0a6e3373e22dbc4dbde63c857af2a26664", "url": "https://github.com/apache/skywalking/commit/719f3e0a6e3373e22dbc4dbde63c857af2a26664", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-12-05T08:44:15Z", "type": "commit"}, {"oid": "778bfa9206dfaaac0c3037ab162abd694a694f60", "url": "https://github.com/apache/skywalking/commit/778bfa9206dfaaac0c3037ab162abd694a694f60", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-12-05T08:44:44Z", "type": "commit"}, {"oid": "466788ab1678a634d9dc8a9c0279e54646437f94", "url": "https://github.com/apache/skywalking/commit/466788ab1678a634d9dc8a9c0279e54646437f94", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-12-05T08:45:21Z", "type": "commit"}, {"oid": "f3f9a05dce363aace5389ef3d4af7fc7871ba0fc", "url": "https://github.com/apache/skywalking/commit/f3f9a05dce363aace5389ef3d4af7fc7871ba0fc", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-12-05T08:45:46Z", "type": "commit"}, {"oid": "a934095f22c3f4b262e687b7e62ee8202ebad91c", "url": "https://github.com/apache/skywalking/commit/a934095f22c3f4b262e687b7e62ee8202ebad91c", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-12-05T08:47:28Z", "type": "commit"}, {"oid": "845d332025028c13107884d1634d31053608f971", "url": "https://github.com/apache/skywalking/commit/845d332025028c13107884d1634d31053608f971", "message": "add use cases for Logger-plugin.md", "committedDate": "2020-12-05T09:26:33Z", "type": "commit"}, {"oid": "1e5310ca7134cf316aa1d76334f98d80a5234b76", "url": "https://github.com/apache/skywalking/commit/1e5310ca7134cf316aa1d76334f98d80a5234b76", "message": "remove default configuration file(logconfig.properties)", "committedDate": "2020-12-05T10:12:07Z", "type": "commit"}, {"oid": "8e3cb8b06e5174ecfddad8f080efad9a8b9d8809", "url": "https://github.com/apache/skywalking/commit/8e3cb8b06e5174ecfddad8f080efad9a8b9d8809", "message": "Update docs/en/setup/service-agent/java-agent/agent-optional-plugins/Logger-plugin.md", "committedDate": "2020-12-05T11:37:30Z", "type": "commit"}, {"oid": "0a8a32091f94b60f9c3962ab7d56437c14199f35", "url": "https://github.com/apache/skywalking/commit/0a8a32091f94b60f9c3962ab7d56437c14199f35", "message": "Update docs/en/setup/service-agent/java-agent/README.md", "committedDate": "2020-12-05T11:40:25Z", "type": "commit"}, {"oid": "ce0c53dede019f7ad1fe06c15fad6f875cfdc837", "url": "https://github.com/apache/skywalking/commit/ce0c53dede019f7ad1fe06c15fad6f875cfdc837", "message": "update Supported-list.md", "committedDate": "2020-12-05T12:38:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r536742623", "bodyText": "This switch could be easily replaced by a more explicit instrumentation definition, with a flag(enum maybe) as the interceptor constructuor, isn't it?\nString match is another performance impact.", "author": "wu-sheng", "createdAt": "2020-12-05T12:58:41Z", "path": "apm-sniffer/optional-plugins/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/LogbackLoggerInterceptor.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import ch.qos.logback.classic.Logger;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+\n+public class LogbackLoggerInterceptor implements InstanceMethodsAroundInterceptor {\n+\n+    private static final ContextConfig.LoggerConfig CONFIG = ContextConfig.getInstance().getLogbackConfig();\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n+        Logger logger = (Logger) ((Object) objInst);\n+        switch (method.getName()) {", "originalCommit": "ce0c53dede019f7ad1fe06c15fad6f875cfdc837", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc4MTYxNA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r536781614", "bodyText": "More interceptors for different methods seem higher performance? Just my thinking.", "author": "wu-sheng", "createdAt": "2020-12-05T14:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU2MTgxNA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r537561814", "bodyText": "@wu-sheng ,for better performance, I modified the code, and the commit is here.\nMain Idea:\n\nBefore recording, use config.isValid( to determine whether the permission of log4j.yaml has been verified.\nIf not, set the level of log4j.yaml to config.level , if the level of log4j.yaml higher than that of config.level\nIf true, log.", "author": "vcjmhg", "createdAt": "2020-12-07T14:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4MDU0MQ==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r537580541", "bodyText": "@vcjmhg, I think @wu-sheng wanted the switch gone completely. I think he's in favor of adding more InstanceMethodsAroundInterceptor until the switch has been implemented at that level. Correct me if I'm wrong @wu-sheng. If so, I could take a swing at it.", "author": "BFergerson", "createdAt": "2020-12-07T15:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5NzE2NA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r537597164", "bodyText": "Yes, I want switch gone.", "author": "wu-sheng", "createdAt": "2020-12-07T15:29:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU0MzUzMA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r538543530", "bodyText": "@vcjmhg Have you gotten this?", "author": "wu-sheng", "createdAt": "2020-12-08T16:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMzgyMA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r539033820", "bodyText": "@wu-sheng , does each method has its own INTERCEPT_CLASS?\nJust like this:\nLog4jLoggerInstrumentation.java\n@Override\npublic InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {\n    if (CONFIG == null) {\n        return null;\n    }\n    return new InstanceMethodsInterceptPoint[]{\n            new InstanceMethodsInterceptPoint() {\n\n                @Override\n                public ElementMatcher<MethodDescription> getMethodsMatcher() {\n                    return named(\"fatal\")\n                }\n\n                @Override\n                public String getMethodsInterceptor() {\n                    return FATAL_INTERCEPT_CLASS;\n                }\n\n                @Override\n                public boolean isOverrideArgs() {\n                    return false;\n                }\n            },\n            new InstanceMethodsInterceptPoint(){\n                 @Override\n                public ElementMatcher<MethodDescription> getMethodsMatcher() {\n                    return named(\"error\")\n                }\n\n                @Override\n                public String getMethodsInterceptor() {\n                    return ERROR_INTERCEPT_CLASS;\n                }\n\n                @Override\n                public boolean isOverrideArgs() {\n                    return false;\n                }\n            },\n            ...\n    };\n}", "author": "vcjmhg", "createdAt": "2020-12-09T06:04:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1NDgxNA==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r539154814", "bodyText": "Yes, I think that would be more efficient, right?", "author": "wu-sheng", "createdAt": "2020-12-09T09:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MDQyNg==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r539170426", "bodyText": "Ok, I got it. I will try it.", "author": "vcjmhg", "createdAt": "2020-12-09T10:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5MjQwNw==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r539292407", "bodyText": "@wu-sheng, I've made the changes you suggested here.", "author": "vcjmhg", "createdAt": "2020-12-09T13:09:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc0MjYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjc4MjEzOQ==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r536782139", "bodyText": "Why the initial exception should be collected by tracing core?", "author": "wu-sheng", "createdAt": "2020-12-05T14:12:45Z", "path": "apm-sniffer/optional-plugins/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/ContextConfig.java", "diffHunk": "@@ -0,0 +1,242 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import lombok.Setter;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackageNotFoundException;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackagePath;\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * contains all config of the logger plugin.\n+ */\n+@Getter\n+public class ContextConfig {\n+\n+    private final LoggerConfig logbackConfig;\n+    private final LoggerConfig log4jConfig;\n+    private final LoggerConfig log4j2Config;\n+\n+    private ContextConfig(LoggerConfig logbackConfig, LoggerConfig log4jConfig, LoggerConfig log4j2Config) {\n+        this.logbackConfig = logbackConfig;\n+        this.log4jConfig = log4jConfig;\n+        this.log4j2Config = log4j2Config;\n+    }\n+\n+    public static ContextConfig getInstance() {\n+        return HolderContextConfig.INSTANCE;\n+    }\n+\n+    //use singleton\n+    private static class HolderContextConfig {\n+        private final static ContextConfig INSTANCE = initContextConfig();\n+\n+        private static ContextConfig initContextConfig() {\n+            // judge whether has config file\n+            LoggerConfig logbackConfig = null, log4jConfig = null, log4j2Config = null;\n+            File configFile = null;\n+            try {\n+                configFile = new File(AgentPackagePath.getPath(), \"/config/logger-plugin/logconfig.properties\");\n+            } catch (AgentPackageNotFoundException e) {\n+                if (ContextManager.isActive()) {\n+                    ContextManager.activeSpan().log(e);\n+                }\n+            }", "originalCommit": "ce0c53dede019f7ad1fe06c15fad6f875cfdc837", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "221f7f7594df6b6dfd837c9c3f28c56d4d6e6f50", "url": "https://github.com/apache/skywalking/commit/221f7f7594df6b6dfd837c9c3f28c56d4d6e6f50", "message": "update CHANGES.md", "committedDate": "2020-12-06T05:11:22Z", "type": "commit"}, {"oid": "4badf618352ac39ce0e08b5d1541a854a0d5f2a4", "url": "https://github.com/apache/skywalking/commit/4badf618352ac39ce0e08b5d1541a854a0d5f2a4", "message": "log exception when logger-plugin initialized failure.", "committedDate": "2020-12-06T06:31:44Z", "type": "commit"}, {"oid": "a7d73d081c9ab05b32c36e4fdaaa6919fdaff642", "url": "https://github.com/apache/skywalking/commit/a7d73d081c9ab05b32c36e4fdaaa6919fdaff642", "message": "Merge branch 'master' into f-log", "committedDate": "2020-12-06T08:53:45Z", "type": "commit"}, {"oid": "89ed1e01f3d565338d2268cc4fa30c952efd7810", "url": "https://github.com/apache/skywalking/commit/89ed1e01f3d565338d2268cc4fa30c952efd7810", "message": "Merge branch 'master' into f-log", "committedDate": "2020-12-07T02:42:28Z", "type": "commit"}, {"oid": "ef5859cfab92c8defb6e23f11ece498e46a75758", "url": "https://github.com/apache/skywalking/commit/ef5859cfab92c8defb6e23f11ece498e46a75758", "message": "add UT for ContextConfig", "committedDate": "2020-12-07T05:30:06Z", "type": "commit"}, {"oid": "b713ff066330f4879a05497c79f9d3133e30c525", "url": "https://github.com/apache/skywalking/commit/b713ff066330f4879a05497c79f9d3133e30c525", "message": "modify document", "committedDate": "2020-12-07T05:43:52Z", "type": "commit"}, {"oid": "e1bd6d966b56ece485f4a19c43515bab2f8c8a37", "url": "https://github.com/apache/skywalking/commit/e1bd6d966b56ece485f4a19c43515bab2f8c8a37", "message": "Merge branch 'f-log' of https://github.com/vcjmhg/skywalking into f-log", "committedDate": "2020-12-07T05:53:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NjIyMg==", "url": "https://github.com/apache/skywalking/pull/5914#discussion_r537266222", "bodyText": "NULL_DEREFERENCE:  object logbackConfig last assigned on line 69 could be null and is dereferenced at line 104.", "author": "sonatype-lift", "createdAt": "2020-12-07T06:44:39Z", "path": "apm-sniffer/optional-plugins/logger-plugin/src/main/java/org/apache/skywalking/apm/plugin/logger/ContextConfig.java", "diffHunk": "@@ -0,0 +1,246 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.logger;\n+\n+import lombok.Setter;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackageNotFoundException;\n+import org.apache.skywalking.apm.agent.core.boot.AgentPackagePath;\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * contains all config of the logger plugin.\n+ */\n+@Getter\n+public class ContextConfig {\n+\n+    private final LoggerConfig logbackConfig;\n+    private final LoggerConfig log4jConfig;\n+    private final LoggerConfig log4j2Config;\n+\n+    private ContextConfig(LoggerConfig logbackConfig, LoggerConfig log4jConfig, LoggerConfig log4j2Config) {\n+        this.logbackConfig = logbackConfig;\n+        this.log4jConfig = log4jConfig;\n+        this.log4j2Config = log4j2Config;\n+    }\n+\n+    public static ContextConfig getInstance() {\n+        return HolderContextConfig.INSTANCE;\n+    }\n+\n+    //use singleton\n+    private static class HolderContextConfig {\n+        private final static ContextConfig INSTANCE = initContextConfig();\n+\n+        private static ContextConfig initContextConfig() {\n+            // judge whether has config file\n+            final ILog logger = LogManager.getLogger(HolderContextConfig.class);\n+            LoggerConfig logbackConfig = null, log4jConfig = null, log4j2Config = null;\n+            File configFile = null;\n+            try {\n+                configFile = new File(AgentPackagePath.getPath(), \"/config/logger-plugin/logconfig.properties\");\n+            } catch (AgentPackageNotFoundException e) {\n+                logger.error(\"Agent package not found.\", e);\n+            }\n+            // not has config file, make config default\n+            if (configFile == null || !configFile.exists()) {\n+                List<String> packages = new ArrayList<>();\n+                packages.add(\"*\");\n+                logbackConfig = new LoggerConfig(\"logback\", packages, LogLevel.ERROR);\n+                log4jConfig = new LoggerConfig(\"log4j\", packages, LogLevel.ERROR);\n+                log4j2Config = new LoggerConfig(\"log4j2\", packages, LogLevel.ERROR);\n+            } else {\n+                // use config file to init ContextConfig\n+                try (FileInputStream configFileInputStream = new FileInputStream(configFile)) {\n+                    List<LoggerConfig> configs = parseConfigFile(configFileInputStream);\n+                    // initialization of variables which are described in config file\n+                    for (LoggerConfig loggerConfig : configs) {\n+                        if (\"logback\".equals(loggerConfig.getName())) {\n+                            logbackConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j\".equals(loggerConfig.getName())) {\n+                            log4jConfig = fillLoggerConfig(loggerConfig);\n+                        } else if (\"log4j2\".equals(loggerConfig.getName())) {\n+                            log4j2Config = fillLoggerConfig(loggerConfig);\n+                        } else {\n+                            logger.error(\"logconfig.properties was not configured properly.Please check again.\");\n+                            return null;\n+                        }\n+                    }\n+                } catch (IOException e) {\n+                    logger.error(\"Logger plugin initialized failure.Please check again.\", e);\n+                }\n+            }\n+            if (logbackConfig.level == LogLevel.FATAL) {", "originalCommit": "e1bd6d966b56ece485f4a19c43515bab2f8c8a37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc0d11071fdb173ff8f04ffa217e1af1ce5237ea", "url": "https://github.com/apache/skywalking/commit/cc0d11071fdb173ff8f04ffa217e1af1ce5237ea", "message": "improve performance", "committedDate": "2020-12-07T14:28:57Z", "type": "forcePushed"}, {"oid": "cc0d11071fdb173ff8f04ffa217e1af1ce5237ea", "url": "https://github.com/apache/skywalking/commit/cc0d11071fdb173ff8f04ffa217e1af1ce5237ea", "message": "improve performance", "committedDate": "2020-12-07T14:28:57Z", "type": "commit"}, {"oid": "ea4dca00e194c85e8dfff904e458e1b9f53b3b7a", "url": "https://github.com/apache/skywalking/commit/ea4dca00e194c85e8dfff904e458e1b9f53b3b7a", "message": "Merge branch 'master' into f-log", "committedDate": "2020-12-08T01:51:56Z", "type": "commit"}, {"oid": "6f5edfdba0f51c1cd5ab2f30c0f3d0be2d07f49e", "url": "https://github.com/apache/skywalking/commit/6f5edfdba0f51c1cd5ab2f30c0f3d0be2d07f49e", "message": "Merge branch 'master' into f-log", "committedDate": "2020-12-08T02:06:07Z", "type": "commit"}, {"oid": "64928667f3c0713d17fead8cb103284dba902b09", "url": "https://github.com/apache/skywalking/commit/64928667f3c0713d17fead8cb103284dba902b09", "message": "Merge branch 'master' into f-log", "committedDate": "2020-12-09T02:26:28Z", "type": "commit"}, {"oid": "3bb27b2cf3963818c74ebc0a8682bd9aef023193", "url": "https://github.com/apache/skywalking/commit/3bb27b2cf3963818c74ebc0a8682bd9aef023193", "message": "Improve performance:different methods have different Interceptor", "committedDate": "2020-12-09T12:18:08Z", "type": "commit"}, {"oid": "0fd6c67fb2d6e93e19c28e5dbff7eb73d92d51fc", "url": "https://github.com/apache/skywalking/commit/0fd6c67fb2d6e93e19c28e5dbff7eb73d92d51fc", "message": "Merge branch 'master' of https://github.com/apache/skywalking into f-log", "committedDate": "2020-12-09T12:18:23Z", "type": "commit"}, {"oid": "80fd50d379ca4a79c9bcb800b8cc57d4a0e3ea98", "url": "https://github.com/apache/skywalking/commit/80fd50d379ca4a79c9bcb800b8cc57d4a0e3ea98", "message": "Update CHANGES.md", "committedDate": "2020-12-09T13:33:46Z", "type": "commit"}]}