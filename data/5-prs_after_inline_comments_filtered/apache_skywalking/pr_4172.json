{"pr_number": 4172, "pr_title": "Provide profile task downstream to sniffer", "pr_createdAt": "2020-01-04T13:59:53Z", "pr_url": "https://github.com/apache/skywalking/pull/4172", "timeline": [{"oid": "48338a265cde4bf1b654cd5fbd348358cb271f1b", "url": "https://github.com/apache/skywalking/commit/48338a265cde4bf1b654cd5fbd348358cb271f1b", "message": "Provide profile task downstream to sniffer", "committedDate": "2020-01-04T13:54:01Z", "type": "commit"}, {"oid": "eb76ed31015916f9433b764914225628657c8b67", "url": "https://github.com/apache/skywalking/commit/eb76ed31015916f9433b764914225628657c8b67", "message": "Merge branch 'master' into profile_task_downstream_sniffer", "committedDate": "2020-01-04T14:00:04Z", "type": "commit"}, {"oid": "e7125b57c5beb52e363a9f7eaa97b8850e647812", "url": "https://github.com/apache/skywalking/commit/e7125b57c5beb52e363a9f7eaa97b8850e647812", "message": "fix agent unit testcase issue", "committedDate": "2020-01-04T14:14:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzNzgyMg==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363037822", "bodyText": "Hi, I suggest will ProfileTaskExecutionService disabled by default, enabled by the user through the displayed configuration.", "author": "arugal", "createdAt": "2020-01-04T14:23:04Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionService.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Profile task executor, use {@link #addProfileTask(ProfileTask)} to add a new profile task.\n+ *\n+ * @author MrPro\n+ */\n+public class ProfileTaskExecutionService implements BootService {\n+\n+    private static volatile ScheduledExecutorService PROFILE_TASK_READY_SCHEDULE = Executors.newScheduledThreadPool(15, new DefaultNamedThreadFactory(\"PROFILE-TASK-READY-SCHEDULE\"));", "originalCommit": "e7125b57c5beb52e363a9f7eaa97b8850e647812", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzODA2NQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363038065", "bodyText": "Sorry, I'm not sure what you mean? Why need to disable it? I need to use it to process the profile task. Do you mean to make a switch, user decides sniffer can enable profile?", "author": "mrproliu", "createdAt": "2020-01-04T14:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzNzgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzODEzMA==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363038130", "bodyText": "Do you mean to make a switch, user decides sniffer can enable profile?\n\nYes.", "author": "arugal", "createdAt": "2020-01-04T14:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzNzgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTEzMQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363039131", "bodyText": "@arugal Why make it disabled in default? Could you explain a little?", "author": "wu-sheng", "createdAt": "2020-01-04T14:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzNzgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTgyNg==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363039826", "bodyText": "please check. I have added a new agent switch config agent.active_profile.\nIt will be working on the query profile tasks. If disable the query, the sniffer will not have any profile task need to be executed.", "author": "mrproliu", "createdAt": "2020-01-04T15:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzNzgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MDgxMA==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363040810", "bodyText": "Agent config? So if the user wants to enable profiling, he must restart the agent? Unacceptable to me", "author": "kezhenxu94", "createdAt": "2020-01-04T15:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzNzgyMg=="}], "type": "inlineReview"}, {"oid": "60a8ecc9ae562097337403ab5f7482cf69667a3a", "url": "https://github.com/apache/skywalking/commit/60a8ecc9ae562097337403ab5f7482cf69667a3a", "message": "add profile switch config on sniffer", "committedDate": "2020-01-04T15:05:33Z", "type": "commit"}, {"oid": "f067eb9ac75d127237f3985f32e07c16f3586bfe", "url": "https://github.com/apache/skywalking/commit/f067eb9ac75d127237f3985f32e07c16f3586bfe", "message": "Merge branch 'master' into profile_task_downstream_sniffer", "committedDate": "2020-01-04T15:07:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTg5Nw==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363039897", "bodyText": "As a key feature of 7.0.0, this flag should be true as default. @arugal Could you share your concern?", "author": "wu-sheng", "createdAt": "2020-01-04T15:09:32Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java", "diffHunk": "@@ -118,6 +118,11 @@\n          * Limit the length of the operationName to prevent errors when inserting elasticsearch\n          **/\n         public static int OPERATION_NAME_THRESHOLD = 500;\n+\n+        /**\n+         * If true, skywalking agent will enable profile when user create a new profile task\n+         */\n+        public static boolean ACTIVE_PROFILE = false;", "originalCommit": "60a8ecc9ae562097337403ab5f7482cf69667a3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MTA1Nw==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363041057", "bodyText": "As a key feature of 7.0.0, this flag should be true as default. @arugal Could you share your concern?\n\n\nI think thread monitoring is an auxiliary feature\nThread snapshot collection has a great impact on application performance\n\nSo I think it should be enabled by the user display", "author": "arugal", "createdAt": "2020-01-04T15:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MTg1NQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363041855", "bodyText": "That is why we set the acceptable task with the following limitations\n\nOnly one endpoint at a certain time.\n15 mins as max duration of the task\ndumpPeriod >= 10ms\nminDurationThreshold for collecting thread dump in meaningful case.\nmaxSamplingCount should less than 10. FYI @mrproliu I think maxSamplingCount is missing from existing codes, backend and protocol. right? Please fix this.\n\nWe should not set that in the false, because once the undetected performance issue happens, you have no change to reboot agent already.", "author": "wu-sheng", "createdAt": "2020-01-04T15:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MTk0Mw==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363041943", "bodyText": "You could recheck these in the design doc, except the (5), we miss that in the doc too.", "author": "wu-sheng", "createdAt": "2020-01-04T15:56:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MjA1OQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363042059", "bodyText": "You could recheck these in the design doc, except the (5), we miss that in the doc too.\n\nI'll reread the design document", "author": "arugal", "createdAt": "2020-01-04T15:58:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MTUwMg==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363071502", "bodyText": "@mrproliu Set up a config class for profile first.\npublic static class Profile {\n           public static boolean ACTIVE = true;\n}", "author": "wu-sheng", "createdAt": "2020-01-05T06:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3NzAzNg==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363077036", "bodyText": "please check. maxSamplingCount have added into design document and codes.", "author": "mrproliu", "createdAt": "2020-01-05T08:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAzOTg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MDA0MA==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363040040", "bodyText": "< should be enough.", "author": "wu-sheng", "createdAt": "2020-01-04T15:12:51Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionService.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Profile task executor, use {@link #addProfileTask(ProfileTask)} to add a new profile task.\n+ *\n+ * @author MrPro\n+ */\n+public class ProfileTaskExecutionService implements BootService {\n+\n+    private static volatile ScheduledExecutorService PROFILE_TASK_READY_SCHEDULE = Executors.newScheduledThreadPool(15, new DefaultNamedThreadFactory(\"PROFILE-TASK-READY-SCHEDULE\"));\n+\n+    // last command create time, use to next query task list\n+    private volatile long lastCommandCreateTime = -1;\n+\n+    /**\n+     * get profile task from OAP\n+     * @param task\n+     */\n+    public void addProfileTask(ProfileTask task) {\n+        // update last command create time\n+        if (task.getStartTime() > lastCommandCreateTime) {\n+            lastCommandCreateTime = task.getStartTime();\n+        }\n+\n+        long timeFromStartMills = task.getStartTime() - System.currentTimeMillis();\n+        if (timeFromStartMills <= 0) {", "originalCommit": "f067eb9ac75d127237f3985f32e07c16f3586bfe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MDk3NA==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363040974", "bodyText": "Use @DefaultImplementor in all agent services.", "author": "wu-sheng", "createdAt": "2020-01-04T15:34:28Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskQueryService.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import io.grpc.Channel;\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+import org.apache.skywalking.apm.agent.core.boot.ServiceManager;\n+import org.apache.skywalking.apm.agent.core.commands.CommandService;\n+import org.apache.skywalking.apm.agent.core.conf.Config;\n+import org.apache.skywalking.apm.agent.core.conf.RemoteDownstreamConfig;\n+import org.apache.skywalking.apm.agent.core.dictionary.DictionaryUtil;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.remote.GRPCChannelListener;\n+import org.apache.skywalking.apm.agent.core.remote.GRPCChannelManager;\n+import org.apache.skywalking.apm.agent.core.remote.GRPCChannelStatus;\n+import org.apache.skywalking.apm.network.common.Commands;\n+import org.apache.skywalking.apm.network.language.profile.ProfileTaskCommandQuery;\n+import org.apache.skywalking.apm.network.language.profile.ProfileTaskGrpc;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.apache.skywalking.apm.agent.core.conf.Config.Collector.GRPC_UPSTREAM_TIMEOUT;\n+\n+/**\n+ * sniffer will check has new profile task list every {@link Config.Collector#GET_PROFILE_TASK_INTERVAL} second.\n+ *\n+ * @author MrPro\n+ */\n+public class ProfileTaskQueryService implements BootService, Runnable, GRPCChannelListener {", "originalCommit": "f067eb9ac75d127237f3985f32e07c16f3586bfe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MTA2Ng==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363041066", "bodyText": "Tasklist in the queue list should be cached and do time window validation again. Even we did in the UI, but there could be bug or storage changed through DB directly. It is better to recheck here.\nSame rule as backend did. There should be only one task in a certain time.", "author": "wu-sheng", "createdAt": "2020-01-04T15:36:27Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionService.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Profile task executor, use {@link #addProfileTask(ProfileTask)} to add a new profile task.\n+ *\n+ * @author MrPro\n+ */\n+public class ProfileTaskExecutionService implements BootService {\n+\n+    private static volatile ScheduledExecutorService PROFILE_TASK_READY_SCHEDULE = Executors.newScheduledThreadPool(15, new DefaultNamedThreadFactory(\"PROFILE-TASK-READY-SCHEDULE\"));\n+\n+    // last command create time, use to next query task list\n+    private volatile long lastCommandCreateTime = -1;\n+\n+    /**\n+     * get profile task from OAP\n+     * @param task\n+     */\n+    public void addProfileTask(ProfileTask task) {", "originalCommit": "f067eb9ac75d127237f3985f32e07c16f3586bfe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0MTU5NQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363041595", "bodyText": "Make it \u201cfinal\u201d and remove \u201cvolatile\u201d", "author": "kezhenxu94", "createdAt": "2020-01-04T15:48:26Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionService.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Profile task executor, use {@link #addProfileTask(ProfileTask)} to add a new profile task.\n+ *\n+ * @author MrPro\n+ */\n+public class ProfileTaskExecutionService implements BootService {\n+\n+    private static volatile ScheduledExecutorService PROFILE_TASK_READY_SCHEDULE = Executors.newScheduledThreadPool(15, new DefaultNamedThreadFactory(\"PROFILE-TASK-READY-SCHEDULE\"));", "originalCommit": "f067eb9ac75d127237f3985f32e07c16f3586bfe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9aa6440562024f161950bc6841a3f02f00e09c2b", "url": "https://github.com/apache/skywalking/commit/9aa6440562024f161950bc6841a3f02f00e09c2b", "message": "fix es error", "committedDate": "2020-01-04T15:55:38Z", "type": "commit"}, {"oid": "9aa12bbf5d865520880042acece733efc6ec44b9", "url": "https://github.com/apache/skywalking/commit/9aa12bbf5d865520880042acece733efc6ec44b9", "message": "1. add @DefaultImplementor on the sniffer profile task service\n2. change ProfileTaskExecutionService#PROFILE_TASK_READY_SCHEDULE to final and remove volatile\n2. fix style error", "committedDate": "2020-01-04T16:14:23Z", "type": "commit"}, {"oid": "14d4629194490a2f5cd7c7691a8ed4819e841402", "url": "https://github.com/apache/skywalking/commit/14d4629194490a2f5cd7c7691a8ed4819e841402", "message": "change timeFromStartMills use `<` to compare", "committedDate": "2020-01-04T16:18:29Z", "type": "commit"}, {"oid": "6b4c18fac7c7c954210c02f32dd2b0f52d79957d", "url": "https://github.com/apache/skywalking/commit/6b4c18fac7c7c954210c02f32dd2b0f52d79957d", "message": "1. add `maxSamplingCount` to profile task\n2. make profile task limit to the common package", "committedDate": "2020-01-05T04:31:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MTU5Mg==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363071592", "bodyText": "All these should be used in ProfileTaskCommandExecutor#execute. Once check fails, warning logs should output and the task wouldn't add into the scheduler.", "author": "wu-sheng", "createdAt": "2020-01-05T06:04:10Z", "path": "apm-protocol/apm-network/src/main/java/org/apache/skywalking/apm/network/constants/ProfileConstants.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package org.apache.skywalking.apm.network.constants;\n+\n+/**\n+ * profile task limit constants\n+ *\n+ * @author MrPro\n+ */\n+public class ProfileConstants {", "originalCommit": "6b4c18fac7c7c954210c02f32dd2b0f52d79957d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3Njk1Mw==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363076953", "bodyText": "Add the check info ProfileTaskExecutionService#addProfileTask, there saved task list and do the recheck.", "author": "mrproliu", "createdAt": "2020-01-05T08:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MTU5Mg=="}], "type": "inlineReview"}, {"oid": "c82b079ffddbefe825c1ff1085ce4436ef48dd28", "url": "https://github.com/apache/skywalking/commit/c82b079ffddbefe825c1ff1085ce4436ef48dd28", "message": "1. change `agent.active_profile` to `profile.active` and make true on default\n2. add `maxSamplingCount` in profile task\n3. use `createTime` to check has new command list\n4. add task re-check before process profile task", "committedDate": "2020-01-05T08:19:14Z", "type": "commit"}, {"oid": "14a92ef1eca70a360f34a5d54e8c79ef53699dfb", "url": "https://github.com/apache/skywalking/commit/14a92ef1eca70a360f34a5d54e8c79ef53699dfb", "message": "Merge branch 'master' into profile_task_downstream_sniffer", "committedDate": "2020-01-06T01:58:49Z", "type": "commit"}, {"oid": "052e0b69084796f0d7b5d3f70b25322ef52af87c", "url": "https://github.com/apache/skywalking/commit/052e0b69084796f0d7b5d3f70b25322ef52af87c", "message": "Merge branch 'master' into profile_task_downstream_sniffer", "committedDate": "2020-01-06T13:29:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3Nzc4OA==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363777788", "bodyText": "You are creating a big thread pool here, could you share why? Is 15 really necessary?", "author": "wu-sheng", "createdAt": "2020-01-07T14:39:37Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionService.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultImplementor;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.network.constants.ProfileConstants;\n+import org.apache.skywalking.apm.util.StringUtil;\n+\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.*;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * Profile task executor, use {@link #addProfileTask(ProfileTask)} to add a new profile task.\n+ *\n+ * @author MrPro\n+ */\n+@DefaultImplementor\n+public class ProfileTaskExecutionService implements BootService {\n+\n+    private static final ILog logger = LogManager.getLogger(ProfileTaskExecutionService.class);\n+\n+    private final static ScheduledExecutorService PROFILE_TASK_READY_SCHEDULE = Executors.newScheduledThreadPool(15, new DefaultNamedThreadFactory(\"PROFILE-TASK-READY-SCHEDULE\"));", "originalCommit": "052e0b69084796f0d7b5d3f70b25322ef52af87c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3ODI5Ng==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363778296", "bodyText": "All tasks should be no conflicts, then it should be a single thread task scheduler.", "author": "wu-sheng", "createdAt": "2020-01-07T14:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3Nzc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3ODY3OQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363778679", "bodyText": "Same question for this scheduler. The task should only start after the prev one finished, right? If so, why two schedulers?", "author": "wu-sheng", "createdAt": "2020-01-07T14:41:31Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionService.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultImplementor;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.network.constants.ProfileConstants;\n+import org.apache.skywalking.apm.util.StringUtil;\n+\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.*;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * Profile task executor, use {@link #addProfileTask(ProfileTask)} to add a new profile task.\n+ *\n+ * @author MrPro\n+ */\n+@DefaultImplementor\n+public class ProfileTaskExecutionService implements BootService {\n+\n+    private static final ILog logger = LogManager.getLogger(ProfileTaskExecutionService.class);\n+\n+    private final static ScheduledExecutorService PROFILE_TASK_READY_SCHEDULE = Executors.newScheduledThreadPool(15, new DefaultNamedThreadFactory(\"PROFILE-TASK-READY-SCHEDULE\"));\n+    private final static ScheduledExecutorService PROFILE_TASK_FINISH_SCHEDULE = Executors.newScheduledThreadPool(2, new DefaultNamedThreadFactory(\"PROFILE-TASK-FINISH-SHCEDULE\"));", "originalCommit": "052e0b69084796f0d7b5d3f70b25322ef52af87c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3OTg0OQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363779849", "bodyText": "Why say NoneStream? There is no stream related thing here.", "author": "wu-sheng", "createdAt": "2020-01-07T14:43:51Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/cache/CacheUpdateTimer.java", "diffHunk": "@@ -115,4 +121,25 @@ private void updateNetAddressInventory(ModuleDefineHolder moduleDefineHolder) {\n             }\n         });\n     }\n+\n+    /**\n+     * update all profile task list for each service\n+     * @param moduleDefineHolder\n+     */\n+    private void updateProfileTaskNoneStream(ModuleDefineHolder moduleDefineHolder) {", "originalCommit": "052e0b69084796f0d7b5d3f70b25322ef52af87c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc4MTcxNw==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363781717", "bodyText": "Why related to NoneStream?", "author": "wu-sheng", "createdAt": "2020-01-07T14:47:21Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/CoreModuleConfig.java", "diffHunk": "@@ -67,6 +67,11 @@\n     private long maxSizeOfEndpointInventory = 1_000_000L;\n     private long maxSizeOfNetworkInventory = 1_000_000L;\n \n+    /**\n+     * Following are cache setting for none stream(s)\n+     */\n+    private long maxSizeOfProfileTaskNoneStream = 10_000L;", "originalCommit": "052e0b69084796f0d7b5d3f70b25322ef52af87c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc4MjQ1NQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363782455", "bodyText": "If this is only used internally, it should not be a public method.", "author": "wu-sheng", "createdAt": "2020-01-07T14:48:43Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/cache/ProfileTaskCache.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.cache;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import org.apache.skywalking.oap.server.core.CoreModuleConfig;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.query.entity.ProfileTask;\n+import org.apache.skywalking.oap.server.core.storage.StorageModule;\n+import org.apache.skywalking.oap.server.core.storage.profile.IProfileTaskQueryDAO;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.module.Service;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * cache need to execute profile task\n+ *\n+ * @author MrPro\n+ */\n+public class ProfileTaskCache implements Service {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ProfileTaskCache.class);\n+\n+    private final Cache<Integer, List<ProfileTask>> profileTaskCache;\n+\n+    private final ModuleManager moduleManager;\n+    private IProfileTaskQueryDAO profileTaskQueryDAO;\n+\n+    public ProfileTaskCache(ModuleManager moduleManager, CoreModuleConfig moduleConfig) {\n+        this.moduleManager = moduleManager;\n+\n+        long initialSize = moduleConfig.getMaxSizeOfProfileTaskNoneStream() / 10L;\n+        int initialCapacitySize = (int)(initialSize > Integer.MAX_VALUE ? Integer.MAX_VALUE : initialSize);\n+\n+        profileTaskCache = CacheBuilder.newBuilder().initialCapacity(initialCapacitySize).maximumSize(moduleConfig.getMaxSizeOfProfileTaskNoneStream())\n+                // remove old profile task data\n+                .expireAfterWrite(Duration.ofMinutes(1)).build();\n+    }\n+\n+    public IProfileTaskQueryDAO getProfileTaskQueryDAO() {", "originalCommit": "052e0b69084796f0d7b5d3f70b25322ef52af87c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc4MzE3Nw==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363783177", "bodyText": "Your cache already has auto-refresh mechanism, there is no need to read again.", "author": "wu-sheng", "createdAt": "2020-01-07T14:50:05Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/cache/ProfileTaskCache.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.cache;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import org.apache.skywalking.oap.server.core.CoreModuleConfig;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.query.entity.ProfileTask;\n+import org.apache.skywalking.oap.server.core.storage.StorageModule;\n+import org.apache.skywalking.oap.server.core.storage.profile.IProfileTaskQueryDAO;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.module.Service;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * cache need to execute profile task\n+ *\n+ * @author MrPro\n+ */\n+public class ProfileTaskCache implements Service {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ProfileTaskCache.class);\n+\n+    private final Cache<Integer, List<ProfileTask>> profileTaskCache;\n+\n+    private final ModuleManager moduleManager;\n+    private IProfileTaskQueryDAO profileTaskQueryDAO;\n+\n+    public ProfileTaskCache(ModuleManager moduleManager, CoreModuleConfig moduleConfig) {\n+        this.moduleManager = moduleManager;\n+\n+        long initialSize = moduleConfig.getMaxSizeOfProfileTaskNoneStream() / 10L;\n+        int initialCapacitySize = (int)(initialSize > Integer.MAX_VALUE ? Integer.MAX_VALUE : initialSize);\n+\n+        profileTaskCache = CacheBuilder.newBuilder().initialCapacity(initialCapacitySize).maximumSize(moduleConfig.getMaxSizeOfProfileTaskNoneStream())\n+                // remove old profile task data\n+                .expireAfterWrite(Duration.ofMinutes(1)).build();\n+    }\n+\n+    public IProfileTaskQueryDAO getProfileTaskQueryDAO() {\n+        if (Objects.isNull(profileTaskQueryDAO)) {\n+            profileTaskQueryDAO = moduleManager.find(StorageModule.NAME).provider().getService(IProfileTaskQueryDAO.class);\n+        }\n+        return profileTaskQueryDAO;\n+    }\n+\n+    /**\n+     * query executable profile task\n+     * @param serviceId\n+     * @return\n+     */\n+    public List<ProfileTask> getProfileTaskList(int serviceId) {\n+        List<ProfileTask> profileTaskList = profileTaskCache.getIfPresent(serviceId);\n+\n+        if (Objects.isNull(profileTaskList)) {", "originalCommit": "052e0b69084796f0d7b5d3f70b25322ef52af87c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc4MzM4OQ==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r363783389", "bodyText": "If this section is not required, #getProfileTaskQueryDAO method is not required too.", "author": "wu-sheng", "createdAt": "2020-01-07T14:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc4MzE3Nw=="}], "type": "inlineReview"}, {"oid": "722aeef0e0cef4fd4d3b06da2d9aceff5da80a4b", "url": "https://github.com/apache/skywalking/commit/722aeef0e0cef4fd4d3b06da2d9aceff5da80a4b", "message": "1. add `profile-receiver` document\n2. change `ProfileTaskExecutionService` use single schedule thread pool\n3. cache dont need fetch data when no data, use auto-fresh mechanism only", "committedDate": "2020-01-08T04:02:47Z", "type": "commit"}, {"oid": "457f5ccbc6aaeedcf557ecf9fe6c02b61cebb55d", "url": "https://github.com/apache/skywalking/commit/457f5ccbc6aaeedcf557ecf9fe6c02b61cebb55d", "message": "Merge branch 'master' into profile_task_downstream_sniffer", "committedDate": "2020-01-08T04:04:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA5NTg5Ng==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r364095896", "bodyText": "I think we don't need this part. All tasks should be in the PROFILE_TASK_SCHEDULE. Could you share why we need this?", "author": "wu-sheng", "createdAt": "2020-01-08T07:39:39Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionService.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultImplementor;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.network.constants.ProfileConstants;\n+import org.apache.skywalking.apm.util.StringUtil;\n+\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.*;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * Profile task executor, use {@link #addProfileTask(ProfileTask)} to add a new profile task.\n+ *\n+ * @author MrPro\n+ */\n+@DefaultImplementor\n+public class ProfileTaskExecutionService implements BootService {\n+\n+    private static final ILog logger = LogManager.getLogger(ProfileTaskExecutionService.class);\n+\n+    // add a schedule while waiting for the task to start or finish\n+    private final static ScheduledExecutorService PROFILE_TASK_SCHEDULE = Executors.newSingleThreadScheduledExecutor(new DefaultNamedThreadFactory(\"PROFILE-TASK-SCHEDULE\"));\n+\n+    // last command create time, use to next query task list\n+    private volatile long lastCommandCreateTime = -1;\n+\n+    // current processing profile task context\n+    private final AtomicReference<ProfileTaskExecutionContext> taskExecutionContext = new AtomicReference<>();\n+\n+    // profile task list, include running and waiting running tasks\n+    private final List<ProfileTask> profileTaskList = Collections.synchronizedList(new LinkedList<>());\n+\n+    /**\n+     * get profile task from OAP\n+     * @param task\n+     */\n+    public void addProfileTask(ProfileTask task) {\n+        // update last command create time\n+        if (task.getCreateTime() > lastCommandCreateTime) {\n+            lastCommandCreateTime = task.getCreateTime();\n+        }\n+\n+        // check profile task limit\n+        final String dataError = checkProfileTaskSuccess(task);\n+        if (dataError != null) {\n+            logger.warn(\"check command error, cannot process this profile task. reason: {}\", dataError);\n+            return;\n+        }\n+\n+        // add task to list\n+        profileTaskList.add(task);\n+\n+        // check task start now or make a schedule\n+        long timeFromStartMills = task.getStartTime() - System.currentTimeMillis();\n+        if (timeFromStartMills < 0) {", "originalCommit": "457f5ccbc6aaeedcf557ecf9fe6c02b61cebb55d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEwNDM5NA==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r364104394", "bodyText": "If sniffer restart, It will also get the task from OAP, maybe some task before the current time. I used to think that the schedule could not pass in negative numbers, and I found that there would be no errors. resolved.", "author": "mrproliu", "createdAt": "2020-01-08T08:08:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA5NTg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA5NzUwOA==", "url": "https://github.com/apache/skywalking/pull/4172#discussion_r364097508", "bodyText": "This comment is not right. Should re-word to\n\nActive the selected profile task to execution task, and start a removal task for it.", "author": "wu-sheng", "createdAt": "2020-01-08T07:44:59Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionService.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+import org.apache.skywalking.apm.agent.core.boot.BootService;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultImplementor;\n+import org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.network.constants.ProfileConstants;\n+import org.apache.skywalking.apm.util.StringUtil;\n+\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.*;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * Profile task executor, use {@link #addProfileTask(ProfileTask)} to add a new profile task.\n+ *\n+ * @author MrPro\n+ */\n+@DefaultImplementor\n+public class ProfileTaskExecutionService implements BootService {\n+\n+    private static final ILog logger = LogManager.getLogger(ProfileTaskExecutionService.class);\n+\n+    // add a schedule while waiting for the task to start or finish\n+    private final static ScheduledExecutorService PROFILE_TASK_SCHEDULE = Executors.newSingleThreadScheduledExecutor(new DefaultNamedThreadFactory(\"PROFILE-TASK-SCHEDULE\"));\n+\n+    // last command create time, use to next query task list\n+    private volatile long lastCommandCreateTime = -1;\n+\n+    // current processing profile task context\n+    private final AtomicReference<ProfileTaskExecutionContext> taskExecutionContext = new AtomicReference<>();\n+\n+    // profile task list, include running and waiting running tasks\n+    private final List<ProfileTask> profileTaskList = Collections.synchronizedList(new LinkedList<>());\n+\n+    /**\n+     * get profile task from OAP\n+     * @param task\n+     */\n+    public void addProfileTask(ProfileTask task) {\n+        // update last command create time\n+        if (task.getCreateTime() > lastCommandCreateTime) {\n+            lastCommandCreateTime = task.getCreateTime();\n+        }\n+\n+        // check profile task limit\n+        final String dataError = checkProfileTaskSuccess(task);\n+        if (dataError != null) {\n+            logger.warn(\"check command error, cannot process this profile task. reason: {}\", dataError);\n+            return;\n+        }\n+\n+        // add task to list\n+        profileTaskList.add(task);\n+\n+        // check task start now or make a schedule\n+        long timeFromStartMills = task.getStartTime() - System.currentTimeMillis();\n+        if (timeFromStartMills < 0) {\n+            // task already can start\n+            processProfileTask(task);\n+        } else {\n+            // need to be a schedule to start task\n+            PROFILE_TASK_SCHEDULE.schedule(new Runnable() {\n+                @Override\n+                public void run() {\n+                    processProfileTask(task);\n+                }\n+            }, timeFromStartMills, TimeUnit.MILLISECONDS);\n+        }\n+    }\n+\n+    /**\n+     * real process a new profile task", "originalCommit": "457f5ccbc6aaeedcf557ecf9fe6c02b61cebb55d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1b6cc49ac1db9990dbbabfc039c0516a848dc102", "url": "https://github.com/apache/skywalking/commit/1b6cc49ac1db9990dbbabfc039c0516a848dc102", "message": "remove navigate time judge, fix comment wrong meaning", "committedDate": "2020-01-08T08:08:34Z", "type": "commit"}]}