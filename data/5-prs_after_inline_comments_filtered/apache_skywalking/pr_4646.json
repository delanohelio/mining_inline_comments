{"pr_number": 4646, "pr_title": "Nginx correlation e2e test", "pr_createdAt": "2020-04-13T15:20:45Z", "pr_url": "https://github.com/apache/skywalking/pull/4646", "timeline": [{"oid": "bc1138544cdfa2e18f5e30f964a8a99c7d54156f", "url": "https://github.com/apache/skywalking/commit/bc1138544cdfa2e18f5e30f964a8a99c7d54156f", "message": "adding lua agent correlation test", "committedDate": "2020-04-12T17:12:12Z", "type": "commit"}, {"oid": "1f41d8609dfa7542fc9edb289f98d48ca1da3eba", "url": "https://github.com/apache/skywalking/commit/1f41d8609dfa7542fc9edb289f98d48ca1da3eba", "message": "if we got illegal, then we should abandon this whole section", "committedDate": "2020-04-13T05:39:42Z", "type": "commit"}, {"oid": "0f62d95a3666488e03ce40df9f74ef45a6397adc", "url": "https://github.com/apache/skywalking/commit/0f62d95a3666488e03ce40df9f74ef45a6397adc", "message": "using new commit id", "committedDate": "2020-04-13T15:13:39Z", "type": "commit"}, {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae", "url": "https://github.com/apache/skywalking/commit/33d9dfb148af3fabf3cb82792174f85cddff49ae", "message": "Merge branch 'master' into nginx_with_correlation", "committedDate": "2020-04-13T15:21:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0MTQzNQ==", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407541435", "bodyText": "correlation can't be tested in the e2e from my perspective.\n\n@wu-sheng maybe here is how @mrproliu he made it possible to test correlation in the E2E, get the correlation context in a service and expose them in an endpoint that can be verified in the test codes?", "author": "kezhenxu94", "createdAt": "2020-04-13T15:33:49Z", "path": "test/e2e/e2e-service-provider/src/main/java/org/apache/skywalking/e2e/lua/LuaController.java", "diffHunk": "@@ -36,8 +37,15 @@\n     @PostMapping(\"/nginx/entry/info\")\n     private String nginxEntry(String backend) throws MalformedURLException, URISyntaxException {\n         final URL url = new URL(\"http://nginx:8080/nginx/info\");\n+        TraceContext.putCorrelation(\"entry\", \"entry_value\");\n         final ResponseEntity<String> response = restTemplate.postForEntity(url.toURI(), null, String.class);\n         return response.getBody();\n     }\n \n+    @PostMapping(\"/nginx/end/info\")\n+    private String nginxEnd() throws MalformedURLException, URISyntaxException {\n+        return TraceContext.getCorrelation(\"entry\").orElse(\"\")\n+            + \"_\" + TraceContext.getCorrelation(\"nginx\").orElse(\"\");\n+    }", "originalCommit": "33d9dfb148af3fabf3cb82792174f85cddff49ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NDQzNA==", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407554434", "bodyText": "Here my changed, java1 -> Nginx -> java2, java1 and Nginx to put the correlation data, then I get the all correlation data in java2 and return it. So, I make a JUnit to verify the java2 result.", "author": "mrproliu", "createdAt": "2020-04-13T15:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0MTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NjQ1NA==", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407556454", "bodyText": "/nginx/end/info is the validated endpoint name, but the response entity wouldn't be tests. Please correct me if I am wrong.", "author": "wu-sheng", "createdAt": "2020-04-13T16:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0MTQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0MTcwMQ==", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407541701", "bodyText": "Let's remove the public modifier, Junit 5 doesn't require this", "author": "kezhenxu94", "createdAt": "2020-04-13T15:34:15Z", "path": "test/e2e/e2e-test/src/test/java/org/apache/skywalking/e2e/LuaE2E.java", "diffHunk": "@@ -92,14 +95,21 @@\n     public void setUp() throws Exception {\n         queryClient(swWebappHostPort);\n \n-        trafficController(entryProvider, \"/nginx/entry/info?backend=\" + nginxHostPort.host() + \":\" + nginxHostPort.port());\n+        trafficController(entryProvider, \"/nginx/entry/info\");\n     }\n \n     @AfterAll\n     public void tearDown() {\n         trafficController.stop();\n     }\n \n+    @RetryableTest\n+    public void correlation() throws Exception {", "originalCommit": "33d9dfb148af3fabf3cb82792174f85cddff49ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0OTYzNA==", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407549634", "bodyText": "Remove the declaration of nginxHostPort (line#89) if you don't need it anymore", "author": "kezhenxu94", "createdAt": "2020-04-13T15:49:19Z", "path": "test/e2e/e2e-test/src/test/java/org/apache/skywalking/e2e/LuaE2E.java", "diffHunk": "@@ -92,14 +95,21 @@\n     public void setUp() throws Exception {\n         queryClient(swWebappHostPort);\n \n-        trafficController(entryProvider, \"/nginx/entry/info?backend=\" + nginxHostPort.host() + \":\" + nginxHostPort.port());", "originalCommit": "33d9dfb148af3fabf3cb82792174f85cddff49ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NzQ4Mw==", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407557483", "bodyText": "@mrproliu Do you mean this check?", "author": "wu-sheng", "createdAt": "2020-04-13T16:03:35Z", "path": "test/e2e/e2e-test/src/test/java/org/apache/skywalking/e2e/LuaE2E.java", "diffHunk": "@@ -92,14 +95,21 @@\n     public void setUp() throws Exception {\n         queryClient(swWebappHostPort);\n \n-        trafficController(entryProvider, \"/nginx/entry/info?backend=\" + nginxHostPort.host() + \":\" + nginxHostPort.port());\n+        trafficController(entryProvider, \"/nginx/entry/info\");\n     }\n \n     @AfterAll\n     public void tearDown() {\n         trafficController.stop();\n     }\n \n+    @RetryableTest\n+    public void correlation() throws Exception {\n+        final URL url = new URL(\"http\", entryProvider.host(), entryProvider.port(), \"/nginx/entry/info\");\n+        final ResponseEntity<String> response = restTemplate.postForEntity(url.toURI(), trafficData, String.class);\n+        Assert.assertEquals(response.getBody(), \"entry_value_nginx_value\");", "originalCommit": "33d9dfb148af3fabf3cb82792174f85cddff49ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1OTA1OA==", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407559058", "bodyText": "Yes, there will check all the correlation data from java2 response.", "author": "mrproliu", "createdAt": "2020-04-13T16:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NzQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5OTIwNA==", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407799204", "bodyText": "So, once the propagation fails, this e2e will fail directly. Got it.", "author": "wu-sheng", "createdAt": "2020-04-14T00:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NzQ4Mw=="}], "type": "inlineReview"}, {"oid": "6264612e939b2754c125b2be54ac5fc3f8e6cf08", "url": "https://github.com/apache/skywalking/commit/6264612e939b2754c125b2be54ac5fc3f8e6cf08", "message": "resolve issues", "committedDate": "2020-04-13T16:24:10Z", "type": "commit"}]}