{"pr_number": 4441, "pr_title": "Add finagle plugin", "pr_createdAt": "2020-03-04T05:53:41Z", "pr_url": "https://github.com/apache/skywalking/pull/4441", "timeline": [{"oid": "e1f3391db4c93767080d40c56f6f8932642b71a9", "url": "https://github.com/apache/skywalking/commit/e1f3391db4c93767080d40c56f6f8932642b71a9", "message": "Add finagle plugin (#4433)", "committedDate": "2020-03-04T05:48:42Z", "type": "commit"}, {"oid": "e4fbe9d49476c6ae31954e47505db0e645aad088", "url": "https://github.com/apache/skywalking/commit/e4fbe9d49476c6ae31954e47505db0e645aad088", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-04T05:58:14Z", "type": "commit"}, {"oid": "58219dd5e9fb1c7166c4edc20f6d9c7cf397711d", "url": "https://github.com/apache/skywalking/commit/58219dd5e9fb1c7166c4edc20f6d9c7cf397711d", "message": "fix failed checks for pr(#4441)\n* Add licenses for some files\n* Update Supported doc\n* Add finagle to test component-libraries.yml", "committedDate": "2020-03-04T14:37:43Z", "type": "commit"}, {"oid": "2b9df1a3bd3df20b561b340223f6f23c005c9cbf", "url": "https://github.com/apache/skywalking/commit/2b9df1a3bd3df20b561b340223f6f23c005c9cbf", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-04T14:53:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MzYzMg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388193632", "bodyText": "These methods are overridden by methods in subsequent integrations. Recommend to modify these methods to abstract methods, so that the logic may be clearer.  construct like this abstract void onConstruct(EnhancedInstance objInst, Object[] allArguments, AbstractSpan span). Or they can be split into two classes like InstanceConstructorInterceptor InstanceMethodsAroundInterceptor ?", "author": null, "createdAt": "2020-03-05T10:08:49Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/AbstractInterceptor.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceConstructorInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+\n+abstract class AbstractInterceptor implements InstanceConstructorInterceptor, InstanceMethodsAroundInterceptor {\n+    @Override\n+    public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n+        if (CompatibilityChecker.isCompatible()) {\n+            onConstructImpl(objInst, allArguments);\n+        }\n+    }\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n+        if (CompatibilityChecker.isCompatible()) {\n+            beforeMethodImpl(objInst, method, allArguments, argumentsTypes, result);\n+        }\n+    }\n+\n+    @Override\n+    public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes, Object ret) throws Throwable {\n+        if (CompatibilityChecker.isCompatible()) {\n+            return afterMethodImpl(objInst, method, allArguments, argumentsTypes, ret);\n+        }\n+        return ret;\n+    }\n+\n+    @Override\n+    public void handleMethodException(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes, Throwable t) {\n+        if (CompatibilityChecker.isCompatible()) {\n+            handleMethodExceptionImpl(objInst, method, allArguments, argumentsTypes, t);\n+        }\n+    }\n+\n+    protected void onConstructImpl(EnhancedInstance objInst, Object[] allArguments) {\n+\n+    }\n+\n+    protected void beforeMethodImpl(EnhancedInstance objInst, Method method, Object[] allArguments,\n+                                    Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n+\n+    }\n+\n+    protected Object afterMethodImpl(EnhancedInstance objInst, Method method, Object[] allArguments,\n+                                     Class<?>[] argumentsTypes, Object ret) throws Throwable {\n+        return ret;\n+    }\n+\n+    protected void handleMethodExceptionImpl(EnhancedInstance objInst, Method method, Object[] allArguments,\n+                                             Class<?>[] argumentsTypes, Throwable t) {\n+\n+    }", "originalCommit": "2b9df1a3bd3df20b561b340223f6f23c005c9cbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0NDU1OQ==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388244559", "bodyText": "I will make these methods abstract.\nBecause ClientDestTracingFilterInterceptor need to implement both onConstructImpl  and beforeMethodImpl  methods and java did not support mutiple inheritance,   so they can not be split into two class.", "author": "huangyoje", "createdAt": "2020-03-05T11:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MzYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4MTk0Nw==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388281947", "bodyText": "Actually, in java, once you have set AbstractInterceptor as abstract, all these empty methods could be deleted directly :)", "author": "wu-sheng", "createdAt": "2020-03-05T13:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MzYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MzEyMg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388343122", "bodyText": "These methods we discussed above areonConstructImpl,beforeMethodImpl , they are not inherited from interface.  The purpose of  AbstractInterceptor  is a adapter for InstanceConstructorInterceptor , InstanceMethodsAroundInterceptor .", "author": "huangyoje", "createdAt": "2020-03-05T14:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MzYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1MjMwMA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388352300", "bodyText": "Let's leave this here. My review has been challenging deeper things than this code style  discussion. Please follow those first, then we could do the review again.", "author": "wu-sheng", "createdAt": "2020-03-05T15:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MzYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwMDY1Mg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388200652", "bodyText": "Exception information to be added like ContextManager.activeSpan().errorOccurred().log(t)", "author": null, "createdAt": "2020-03-05T10:21:41Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/ClientDestTracingFilterInterceptor.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import com.twitter.finagle.Address;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+import java.net.InetSocketAddress;\n+\n+import static org.apache.skywalking.apm.plugin.finagle.ContextCarrierHelper.setPeerHost;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getContextCarrier;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getSpan;\n+\n+public class ClientDestTracingFilterInterceptor extends AbstractInterceptor {\n+\n+    @Override\n+    public void onConstructImpl(EnhancedInstance enhancedInstance, Object[] objects) {\n+        enhancedInstance.setSkyWalkingDynamicField(getRemote(objects));\n+    }\n+\n+    @Override\n+    public void beforeMethodImpl(EnhancedInstance enhancedInstance, Method method, Object[] objects, Class<?>[] classes, MethodInterceptResult methodInterceptResult) throws Throwable {\n+        String peer = (String) enhancedInstance.getSkyWalkingDynamicField();\n+        AbstractSpan span = getSpan();\n+        if (span != null) {\n+            span.setPeer(peer);\n+        }\n+        SWContextCarrier swContextCarrier = getContextCarrier();\n+        if (swContextCarrier != null) {\n+            setPeerHost(swContextCarrier.carrier(), peer);\n+        }\n+    }\n+\n+    @Override\n+    public Object afterMethodImpl(EnhancedInstance enhancedInstance, Method method, Object[] objects, Class<?>[] classes, Object o) throws Throwable {\n+        return o;\n+    }\n+\n+    @Override\n+    public void handleMethodExceptionImpl(EnhancedInstance enhancedInstance, Method method, Object[] objects, Class<?>[] classes, Throwable throwable) {\n+", "originalCommit": "2b9df1a3bd3df20b561b340223f6f23c005c9cbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0Njk2Mg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388246962", "bodyText": "Sure, I will add it.", "author": "huangyoje", "createdAt": "2020-03-05T11:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwMDY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNjk0Mw==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388206943", "bodyText": "why comment this?", "author": null, "createdAt": "2020-03-05T10:33:06Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/ClientTracingFilterInterceptor.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import com.twitter.util.Future;\n+import com.twitter.util.FutureEventListener;\n+import org.apache.skywalking.apm.agent.core.context.ContextCarrier;\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.context.trace.SpanLayer;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+\n+import static org.apache.skywalking.apm.network.trace.component.ComponentsDefine.FINAGLE;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getLocalContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getMarshalledContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.SW_SPAN;\n+\n+public class ClientTracingFilterInterceptor extends AbstractInterceptor {\n+\n+    private static class CacheObjects {\n+        private ContextHolder marshlledContextHolder;\n+        private ContextHolder localContextHolder;\n+\n+        private CacheObjects(ContextHolder marshlledContextHolder, ContextHolder localContextHolder) {\n+            this.marshlledContextHolder = marshlledContextHolder;\n+            this.localContextHolder = localContextHolder;\n+        }\n+    }\n+\n+    @Override\n+    public void beforeMethodImpl(EnhancedInstance enhancedInstance, Method method, Object[] objects, Class<?>[] classes,\n+                                 MethodInterceptResult methodInterceptResult) throws Throwable {\n+        ContextCarrier contextCarrier = new ContextCarrier();\n+        AbstractSpan finagleSpan = ContextManager.createExitSpan(\"pending\", contextCarrier, \"\");\n+\n+        finagleSpan.setComponent(FINAGLE);\n+        SpanLayer.asRPCFramework(finagleSpan);\n+\n+        ContextHolder marshlledContextHolder = getMarshalledContextHolder();\n+        marshlledContextHolder.let(SWContextCarrier$.MODULE$, SWContextCarrier.of(contextCarrier));\n+\n+        ContextHolder localContextHolder = getLocalContextHolder();\n+        localContextHolder.let(SW_SPAN, finagleSpan);\n+\n+        enhancedInstance.setSkyWalkingDynamicField(new CacheObjects(marshlledContextHolder, localContextHolder));\n+    }\n+\n+    @Override\n+    public Object afterMethodImpl(EnhancedInstance enhancedInstance, Method method, Object[] objects, Class<?>[] classes, Object ret) throws Throwable {\n+        CacheObjects cacheObjects = (CacheObjects) enhancedInstance.getSkyWalkingDynamicField();\n+\n+        final AbstractSpan finagleSpan = cacheObjects.localContextHolder.remove(SW_SPAN);\n+        cacheObjects.marshlledContextHolder.remove(SWContextCarrier$.MODULE$);\n+\n+        finagleSpan.prepareForAsync();\n+        ContextManager.stopSpan(finagleSpan);\n+\n+        ((Future<?>) ret).addEventListener(new FutureEventListener<Object>() {\n+            @Override\n+            public void onSuccess(Object value) {\n+                finagleSpan.asyncFinish();\n+            }\n+\n+            @Override\n+            public void onFailure(Throwable cause) {\n+                finagleSpan.errorOccurred();\n+//                finagleSpan.log(cause);", "originalCommit": "2b9df1a3bd3df20b561b340223f6f23c005c9cbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MDIxNw==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388250217", "bodyText": "public ExitSpan log(Throwable t) {\n        if (stackDepth == 1) {\n            super.log(t);\n        }\n        return this;\n    }\nFor ExitSpan, the log will only works when stackDepth=1.  I don't understand why, Does it ok to invoke log method here?", "author": "huangyoje", "createdAt": "2020-03-05T12:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNjk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0NTA2Mg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388345062", "bodyText": "For ExitSpan, the log will only works when stackDepth=1. I don't understand why, Does it ok to invoke log method here?\n\nWhy your plugin works as depth > 1? And yes, this is designed in that way, meaning, if there is a client-side RPC works, the nested one wouldn't be captured.", "author": "wu-sheng", "createdAt": "2020-03-05T14:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNjk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0Nzc3MA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388347770", "bodyText": "Version compatibility feature is provided by a thing called witness class. If you provide that in the instrumentation definition, your plugin is activated only those class exists.", "author": "wu-sheng", "createdAt": "2020-03-05T14:59:12Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/CompatibilityChecker.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getLocalContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getMarshalledContextHolder;\n+\n+public class CompatibilityChecker {", "originalCommit": "2b9df1a3bd3df20b561b340223f6f23c005c9cbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0ODk4MQ==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388348981", "bodyText": "The ThreadLocal has low performance in the agent, and cost more CPU resources, comparing to other ways. Your codes use this in high frequency which is a potential performance issue. We only accept one way to use thread local, is there is no way to communicate between the interceptor. From your class name, this is not for that case.", "author": "wu-sheng", "createdAt": "2020-03-05T15:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0Nzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NTgzNg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389245836", "bodyText": "Version compatibility feature is provided by a thing called witness class. If you provide that in the instrumentation definition, your plugin is activated only those class exists.\n\nThe implementation detail of this plugin depend on a private class of Finagle Framework, we can not ensure that class will still exists in future versions. The mechanism of witness class can ensure this plugin can work in existing versions, it can not ensure this plugin will still work in future versions. So the purpose of the class  is to check whether this plugin is compatible with future versions, if it does't, the plugin just do nothing, avoiding unexpected runtime exceptions.\nThis has been added in comments.\nwitness has been used in this plugin to ignore versions below 6.25.0.", "author": "huangyoje", "createdAt": "2020-03-07T10:49:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0Nzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NjU3NA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389246574", "bodyText": "The ThreadLocal has low performance in the agent, and cost more CPU resources, comparing to other ways. Your codes use this in high frequency which is a potential performance issue. We only accept one way to use thread local, is there is no way to communicate between the interceptor. From your class name, this is not for that case.\n\nContextHolderFactory?  There are no ThreadLocal used directly, however, it use com.twitter.util.Local which backed by ThreadLocal, but this is necessary, please check the comments.", "author": "huangyoje", "createdAt": "2020-03-07T11:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0Nzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NjczOA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389246738", "bodyText": "First, That thing liked I said, having IP issue. And same as I said, you shouldn't implement in this way.\nI think I have said clear. Any question?", "author": "wu-sheng", "createdAt": "2020-03-07T11:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0Nzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NzA0NQ==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389247045", "bodyText": "The future versions are never being sure. So it is meaningless. That is why we have explicit version test CI process, and indicate them in support list doc. Only real test could verify that.", "author": "wu-sheng", "createdAt": "2020-03-07T11:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0Nzc3MA=="}], "type": "inlineReview"}, {"oid": "4ed9a08c741fbbccb1b0f4a298cbe2b2d233f935", "url": "https://github.com/apache/skywalking/commit/4ed9a08c741fbbccb1b0f4a298cbe2b2d233f935", "message": "Add finagle automatic tests into CI", "committedDate": "2020-03-05T15:01:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0OTk1NQ==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388349955", "bodyText": "This is not allowed, if it is copied from somewhere else, you are facing source code level LICENSE update. Also, as I commented above, I prefer to remove this.", "author": "wu-sheng", "createdAt": "2020-03-05T15:01:43Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/ContextHolder.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @see com.twitter.finagle.context.Context", "originalCommit": "2b9df1a3bd3df20b561b340223f6f23c005c9cbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NTAzMQ==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389245031", "bodyText": "I have removed this.", "author": "huangyoje", "createdAt": "2020-03-07T10:34:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0OTk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1MDM1Mg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r388350352", "bodyText": "Read my comments about witness class, and remove this.", "author": "wu-sheng", "createdAt": "2020-03-05T15:02:22Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/ContextHolderFactory.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import com.twitter.finagle.context.Context;\n+import com.twitter.finagle.context.Contexts;\n+import com.twitter.finagle.context.LocalContext;\n+import com.twitter.finagle.context.MarshalledContext;\n+import com.twitter.io.Buf;\n+import com.twitter.util.Local;\n+import scala.Option;\n+import scala.Predef;\n+import scala.Some;\n+import scala.Some$;\n+import scala.Tuple2;\n+import scala.collection.JavaConverters;\n+import scala.collection.JavaConverters$;\n+\n+import javax.annotation.Nullable;\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.function.Function;\n+\n+public class ContextHolderFactory {", "originalCommit": "2b9df1a3bd3df20b561b340223f6f23c005c9cbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NjI0Mw==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389246243", "bodyText": "Comments has been added, please check ContextHolder, ContextHolderFactory, the class is necessary for the current implementation.", "author": "huangyoje", "createdAt": "2020-03-07T10:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1MDM1Mg=="}], "type": "inlineReview"}, {"oid": "e5ccf23c988f226942614a8bd5715eba492e76b2", "url": "https://github.com/apache/skywalking/commit/e5ccf23c988f226942614a8bd5715eba492e76b2", "message": "Add comments", "committedDate": "2020-03-07T07:11:06Z", "type": "commit"}, {"oid": "4a64e210e5485d763b4671d0d6e1276314094295", "url": "https://github.com/apache/skywalking/commit/4a64e210e5485d763b4671d0d6e1276314094295", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-07T07:11:47Z", "type": "commit"}, {"oid": "2855b350592ad93b7c51c301f999e958bc16da2d", "url": "https://github.com/apache/skywalking/commit/2855b350592ad93b7c51c301f999e958bc16da2d", "message": "update comments", "committedDate": "2020-03-07T10:24:37Z", "type": "commit"}, {"oid": "426df4268c0ad624995eebfca13a6345a0bddd2e", "url": "https://github.com/apache/skywalking/commit/426df4268c0ad624995eebfca13a6345a0bddd2e", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-07T10:24:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NzMwMw==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389247303", "bodyText": "You are using a Thread local to check compatibility, why you think it makes sense?", "author": "wu-sheng", "createdAt": "2020-03-07T11:14:26Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/CompatibilityChecker.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getLocalContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getMarshalledContextHolder;\n+\n+/**\n+ * The implementation detail of this plugin depend on a private class of Finagle Framework, we can not ensure that\n+ * class will still exists in future versions. The mechanism of witness class can ensure this plugin can work in\n+ * existing versions, it can not ensure this plugin will still work in future versions. So the purpose of the class\n+ * is to check whether this plugin is compatible with future versions, if it does't, the plugin just do nothing,\n+ * avoiding unexpected runtime exceptions.\n+ */\n+public class CompatibilityChecker {\n+\n+    static ILog LOGGER = LogManager.getLogger(CompatibilityChecker.class);\n+\n+    private static boolean COMPATIBILITY = false;\n+\n+    static {\n+        try {\n+            if (FinagleCtxs.RPC != null\n+                    && FinagleCtxs.SW_SPAN != null\n+                    && checkContextHolder()) {\n+                COMPATIBILITY = true;", "originalCommit": "426df4268c0ad624995eebfca13a6345a0bddd2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0OTA0Nw==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389249047", "bodyText": "Sorry, I misunderstanding your point, I will remove this class.", "author": "huangyoje", "createdAt": "2020-03-07T11:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NzMwMw=="}], "type": "inlineReview"}, {"oid": "c519e51f7c8199d8cfbeca8b7074c34ca81c6e68", "url": "https://github.com/apache/skywalking/commit/c519e51f7c8199d8cfbeca8b7074c34ca81c6e68", "message": "Remove CompatibilityChecker", "committedDate": "2020-03-07T13:44:59Z", "type": "commit"}, {"oid": "4ab50f5dcb5e32454ef12829bceb55e113749478", "url": "https://github.com/apache/skywalking/commit/4ab50f5dcb5e32454ef12829bceb55e113749478", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-07T13:47:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjcxMg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389256712", "bodyText": "Why don't you create the exit span in the ClientDestTracingFilterInterceptor directly? ContextCarrier require the peer information, otherwise the topology will break.", "author": "wu-sheng", "createdAt": "2020-03-07T14:00:49Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/ClientTracingFilterInterceptor.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import com.twitter.util.Future;\n+import com.twitter.util.FutureEventListener;\n+import org.apache.skywalking.apm.agent.core.context.ContextCarrier;\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.context.trace.SpanLayer;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+\n+import static org.apache.skywalking.apm.network.trace.component.ComponentsDefine.FINAGLE;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getLocalContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getMarshalledContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.SW_SPAN;\n+\n+public class ClientTracingFilterInterceptor extends AbstractInterceptor {\n+\n+    private static class CacheObjects {\n+        private ContextHolder marshlledContextHolder;\n+        private ContextHolder localContextHolder;\n+\n+        private CacheObjects(ContextHolder marshlledContextHolder, ContextHolder localContextHolder) {\n+            this.marshlledContextHolder = marshlledContextHolder;\n+            this.localContextHolder = localContextHolder;\n+        }\n+    }\n+\n+    @Override\n+    protected void onConstructImpl(EnhancedInstance objInst, Object[] allArguments) {\n+\n+    }\n+\n+    @Override\n+    public void beforeMethodImpl(EnhancedInstance enhancedInstance, Method method, Object[] objects, Class<?>[] classes,\n+                                 MethodInterceptResult methodInterceptResult) throws Throwable {\n+        ContextCarrier contextCarrier = new ContextCarrier();\n+        /*\n+         * At this time, we can't know the operation name and peer address, so we just use placeholders here, the\n+         * operation name will be filled by {@link AnnotationInterceptor$Rpc} and the peer address will be filled by\n+         * {@link ClientDestTracingFilterInterceptor} later.\n+         */\n+        AbstractSpan finagleSpan = ContextManager.createExitSpan(\"pending\", contextCarrier, \"\");", "originalCommit": "4ab50f5dcb5e32454ef12829bceb55e113749478", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MDQ1OA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389260458", "bodyText": "Because ClientDestTracingFilter  may be executed in another thread, not the thread that initiated the rpc request.   It is hard to know when and where the thread change occurs.", "author": "huangyoje", "createdAt": "2020-03-07T15:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MDgyNg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389260826", "bodyText": "The peer infomation is added to ContextCarrier in ClientDestTracingFilterInterceptor by ContextCarrierHelper.", "author": "huangyoje", "createdAt": "2020-03-07T15:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzMyNQ==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389263325", "bodyText": "OK. From your codes, you are not just setting the peer later, you are hijacking the ContextCarrier.", "author": "wu-sheng", "createdAt": "2020-03-07T15:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzM2Ng==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389263366", "bodyText": "You also hijacking the op name in the ContextCarrier. Those two are uncommon case for me. Are these really necessary?", "author": "wu-sheng", "createdAt": "2020-03-07T15:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMzMzM2Mw==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389333363", "bodyText": "So far it is necessary.\n#4441 (comment)", "author": "huangyoje", "createdAt": "2020-03-08T04:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjcxMg=="}], "type": "inlineReview"}, {"oid": "66d3b2865265c0176c9507d9c053dd8ebe184a6a", "url": "https://github.com/apache/skywalking/commit/66d3b2865265c0176c9507d9c053dd8ebe184a6a", "message": "Move query-protocol submodule to the right version", "committedDate": "2020-03-07T14:51:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzQzMg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389263432", "bodyText": "Once this interceptor is not in the user thread, there is no active span.", "author": "wu-sheng", "createdAt": "2020-03-07T15:48:13Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/AnnotationInterceptor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getLocalContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getContextCarrier;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getSpan;\n+\n+/**\n+ * Finagle use Annotation to represent data that tracing system interested, usually these annotations are created by\n+ * filters after ClientTracingFilter in the rpc call stack. We can intercept annotations that we interested.\n+ */\n+public class AnnotationInterceptor {\n+\n+    abstract static class Abstract extends AbstractInterceptor {\n+\n+        @Override\n+        public void onConstructImpl(EnhancedInstance enhancedInstance, Object[] objects) {\n+            onConstruct(enhancedInstance, objects, getSpan());\n+        }\n+\n+        protected abstract void onConstruct(EnhancedInstance enhancedInstance, Object[] objects, AbstractSpan span);\n+    }\n+\n+    /**\n+     * When we create exitspan in ClientTracingFilter, we can't know the operation name, however the Rpc annotation\n+     * contains the operation name we need, so we intercept the constructor of this Annotation and set operation name\n+     * to exitspan.\n+     */\n+    public static class Rpc extends Abstract {\n+\n+        @Override\n+        protected void onConstruct(EnhancedInstance enhancedInstance, Object[] objects, AbstractSpan span) {\n+            if (objects != null && objects.length == 1) {\n+                String rpc = (String) objects[0];\n+                if (span == null) {\n+                    // in case the exitspan is created later\n+                    getLocalContextHolder().let(FinagleCtxs.RPC, rpc);\n+                } else {\n+                    span.setOperationName(rpc);\n+                }\n+                SWContextCarrier swContextCarrier = getContextCarrier();\n+                if (swContextCarrier != null) {\n+                    swContextCarrier.setOperationName(rpc);\n+                }\n+            }\n+        }\n+\n+        @Override\n+        protected void beforeMethodImpl(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes, MethodInterceptResult result) throws Throwable {\n+\n+        }\n+\n+        @Override\n+        protected Object afterMethodImpl(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes, Object ret) throws Throwable {\n+            return ret;\n+        }\n+\n+        @Override\n+        protected void handleMethodExceptionImpl(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes, Throwable t) {\n+            ContextManager.activeSpan().errorOccurred().log(t);", "originalCommit": "66d3b2865265c0176c9507d9c053dd8ebe184a6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNTUwOA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389325508", "bodyText": "I will remove this.  The AnnotationInterceptor only needs to implement InstanceConstructorInterceptor.", "author": "huangyoje", "createdAt": "2020-03-08T01:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzU1NA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389263554", "bodyText": "What does this in case mean? Why there is unexpected execution sequence?", "author": "wu-sheng", "createdAt": "2020-03-07T15:49:44Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/AnnotationInterceptor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getLocalContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getContextCarrier;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getSpan;\n+\n+/**\n+ * Finagle use Annotation to represent data that tracing system interested, usually these annotations are created by\n+ * filters after ClientTracingFilter in the rpc call stack. We can intercept annotations that we interested.\n+ */\n+public class AnnotationInterceptor {\n+\n+    abstract static class Abstract extends AbstractInterceptor {\n+\n+        @Override\n+        public void onConstructImpl(EnhancedInstance enhancedInstance, Object[] objects) {\n+            onConstruct(enhancedInstance, objects, getSpan());\n+        }\n+\n+        protected abstract void onConstruct(EnhancedInstance enhancedInstance, Object[] objects, AbstractSpan span);\n+    }\n+\n+    /**\n+     * When we create exitspan in ClientTracingFilter, we can't know the operation name, however the Rpc annotation\n+     * contains the operation name we need, so we intercept the constructor of this Annotation and set operation name\n+     * to exitspan.\n+     */\n+    public static class Rpc extends Abstract {\n+\n+        @Override\n+        protected void onConstruct(EnhancedInstance enhancedInstance, Object[] objects, AbstractSpan span) {\n+            if (objects != null && objects.length == 1) {\n+                String rpc = (String) objects[0];\n+                if (span == null) {\n+                    // in case the exitspan is created later", "originalCommit": "66d3b2865265c0176c9507d9c053dd8ebe184a6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNzQ5Mg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389327492", "bodyText": "Iniitally, here is used to set op to server entryspan(sorry for the wrong comments),  and finally, I passed op from client to server, so it is no longer needed here. The codes and comments has been modified as below:\nif (span != null) {\n    /*\n     * The Rpc Annotation is created both in client side and server side, in server side, this\n     * annotation is created only in finagle versions below 17.12.0.\n     *\n     * If the span is not null, which means we are in the client side, we just set op to the exitspan.\n     *\n     * If the span is null, which means we are in the server side with finagle version below 17.12.0.\n     * In server side, we don't need this annotation, because we can get op from Contexts.broadcast\n     * which comes from client.\n     */\n    span.setOperationName(rpc);\n}", "author": "huangyoje", "createdAt": "2020-03-08T02:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyODUxMg==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389328512", "bodyText": "Why do you plan to propagate the op name in the wire? Entry span should focus on the server side logic only. The only thing will propagate in your RPC header, is the official ContextCarrier.\nLike my other comments say, I have concern about you are hijacking the ContextCarrier. If we change it some day, even it is rarely to see, it is hard to remember the Finagle plugin has this operation.", "author": "wu-sheng", "createdAt": "2020-03-08T02:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMzMzIyNQ==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389333225", "bodyText": "Why do you plan to propagate the op name in the wire?\n\nFor finagle version 17.12.0 and above,  we can not get op name in the server side directly.  If we add finagle-{protocol}(eg: finagle-thrift) into this plugin, then we could deserialize the bytes of the request paramenter and get op name, but this will introduce more complexity becase we have to be compatible with various protocols.\n\nLike my other comments say, I have concern about you are hijacking the ContextCarrier. If we change it some day, even it is rarely to see, it is hard to remember the Finagle plugin has this operation.\n\nSo far, I can't think of a better way to do this.  When we create span and contextCarrier, we don't know the remote address and op name,  but it is difficult to  propagate trace information across finagle's inner threads and then create span untill we know remote address and op name.", "author": "huangyoje", "createdAt": "2020-03-08T04:04:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MTg0MA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389341840", "bodyText": "Take a look at #4462", "author": "wu-sheng", "createdAt": "2020-03-08T07:03:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MzU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2NDI3MA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389264270", "bodyText": "Is the enhancedInstance used in only one thread only? If there is a race condition, you can't use the dynamic field.", "author": "wu-sheng", "createdAt": "2020-03-07T16:01:04Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/ClientTracingFilterInterceptor.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import com.twitter.util.Future;\n+import com.twitter.util.FutureEventListener;\n+import org.apache.skywalking.apm.agent.core.context.ContextCarrier;\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.context.trace.SpanLayer;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+\n+import java.lang.reflect.Method;\n+\n+import static org.apache.skywalking.apm.network.trace.component.ComponentsDefine.FINAGLE;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getLocalContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getMarshalledContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.SW_SPAN;\n+\n+public class ClientTracingFilterInterceptor extends AbstractInterceptor {\n+\n+    private static class CacheObjects {\n+        private ContextHolder marshlledContextHolder;\n+        private ContextHolder localContextHolder;\n+\n+        private CacheObjects(ContextHolder marshlledContextHolder, ContextHolder localContextHolder) {\n+            this.marshlledContextHolder = marshlledContextHolder;\n+            this.localContextHolder = localContextHolder;\n+        }\n+    }\n+\n+    @Override\n+    protected void onConstructImpl(EnhancedInstance objInst, Object[] allArguments) {\n+\n+    }\n+\n+    @Override\n+    public void beforeMethodImpl(EnhancedInstance enhancedInstance, Method method, Object[] objects, Class<?>[] classes,\n+                                 MethodInterceptResult methodInterceptResult) throws Throwable {\n+        ContextCarrier contextCarrier = new ContextCarrier();\n+        /*\n+         * At this time, we can't know the operation name and peer address, so we just use placeholders here, the\n+         * operation name will be filled by {@link AnnotationInterceptor$Rpc} and the peer address will be filled by\n+         * {@link ClientDestTracingFilterInterceptor} later.\n+         */\n+        AbstractSpan finagleSpan = ContextManager.createExitSpan(\"pending\", contextCarrier, \"\");\n+\n+        finagleSpan.setComponent(FINAGLE);\n+        SpanLayer.asRPCFramework(finagleSpan);\n+\n+        ContextHolder marshlledContextHolder = getMarshalledContextHolder();\n+        marshlledContextHolder.let(SWContextCarrier$.MODULE$, SWContextCarrier.of(contextCarrier));\n+\n+        ContextHolder localContextHolder = getLocalContextHolder();\n+        localContextHolder.let(SW_SPAN, finagleSpan);\n+\n+        enhancedInstance.setSkyWalkingDynamicField(new CacheObjects(marshlledContextHolder, localContextHolder));", "originalCommit": "66d3b2865265c0176c9507d9c053dd8ebe184a6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2NDM1MA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389264350", "bodyText": "I am confused here, if the dynamic field is safe enough, why you need the ContextHolder?", "author": "wu-sheng", "createdAt": "2020-03-07T16:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2NDI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2NDUyOA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389264528", "bodyText": "dynamic field could set any customized class, from my reading, it should be used to replace the ContextHolder.\nAnyway, I think I need your further explanation about this.", "author": "wu-sheng", "createdAt": "2020-03-07T16:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2NDI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyOTk4NA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389329984", "bodyText": "Is the enhancedInstance used in only one thread only?\n\nThe  enhancedInstance  is used in mulit threads, I will remove usage of it.\n\nI am confused here, if the dynamic field is safe enough, why you need the ContextHolder?\n\nContextHolder is used to put finagleSpan,SWContextCarrier to Context, thus these two can be accessed by ClientDestTracingFilterInterceptor, even if ClientDestTracingFilter is executed in another thread.", "author": "huangyoje", "createdAt": "2020-03-08T02:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2NDI3MA=="}], "type": "inlineReview"}, {"oid": "5f398fe2e2628e38ad13c67fccd11449f336f75d", "url": "https://github.com/apache/skywalking/commit/5f398fe2e2628e38ad13c67fccd11449f336f75d", "message": "Remove `enhancedInstance.setSkyWalkingDynamicField` in `ClientTracingFilterInterceptor`.", "committedDate": "2020-03-08T02:59:09Z", "type": "commit"}, {"oid": "39a32e6c94956ee4a3d994999da7c5c7caff3a60", "url": "https://github.com/apache/skywalking/commit/39a32e6c94956ee4a3d994999da7c5c7caff3a60", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-08T03:06:29Z", "type": "commit"}, {"oid": "7ed6276b2099e956350f34b1077eadb3c3003178", "url": "https://github.com/apache/skywalking/commit/7ed6276b2099e956350f34b1077eadb3c3003178", "message": "Update expectedData.yaml of finagle tests", "committedDate": "2020-03-08T03:44:47Z", "type": "commit"}, {"oid": "79a6c6340120f828645e31a28a173ead9ced3190", "url": "https://github.com/apache/skywalking/commit/79a6c6340120f828645e31a28a173ead9ced3190", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-08T10:36:02Z", "type": "commit"}, {"oid": "1fea4ff4ee871780d337620d803739ecb2d38df6", "url": "https://github.com/apache/skywalking/commit/1fea4ff4ee871780d337620d803739ecb2d38df6", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-08T11:33:33Z", "type": "commit"}, {"oid": "c10bc9b6e876596a408e12f75c3f5fdff50e3b31", "url": "https://github.com/apache/skywalking/commit/c10bc9b6e876596a408e12f75c3f5fdff50e3b31", "message": "Use lazy ContextCarrier injection.", "committedDate": "2020-03-08T13:23:27Z", "type": "commit"}, {"oid": "3ad0d49eda45e3c86d6f98a579910941d9e5abfe", "url": "https://github.com/apache/skywalking/commit/3ad0d49eda45e3c86d6f98a579910941d9e5abfe", "message": "Merge remote-tracking branch 'github/finagle-plugin' into finagle-plugin", "committedDate": "2020-03-08T13:26:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDU5Mw==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389370593", "bodyText": "This format seems wrong.", "author": "wu-sheng", "createdAt": "2020-03-08T13:41:07Z", "path": "apm-sniffer/apm-sdk-plugin/finagle-6.25.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/finagle/ContextCarrierHelper.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.finagle;\n+\n+import org.apache.skywalking.apm.agent.core.context.ContextCarrier;\n+import org.apache.skywalking.apm.agent.core.context.trace.ExitSpan;\n+\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getLocalContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.ContextHolderFactory.getMarshalledContextHolder;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.RPC;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getOperationName;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getPeerHost;\n+import static org.apache.skywalking.apm.plugin.finagle.FinagleCtxs.getSpan;\n+\n+/**\n+ * We need set peer host to {@link ContextCarrier} in {@link ClientDestTracingFilterInterceptor}, but there is no\n+ * public method to do this, so we use this helper to achieve it.\n+ */\n+class ContextCarrierHelper {\n+\n+    static void tryInjectContext() {\n+        String operationName = getOperationName();\n+        if (operationName == null) {\n+            return;\n+        }\n+        String peer = getPeerHost();\n+        if (peer == null) {\n+            return;\n+    }", "originalCommit": "3ad0d49eda45e3c86d6f98a579910941d9e5abfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MTY2MA==", "url": "https://github.com/apache/skywalking/pull/4441#discussion_r389371660", "bodyText": "Fixed.", "author": "huangyoje", "createdAt": "2020-03-08T13:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDU5Mw=="}], "type": "inlineReview"}, {"oid": "05804658bd456aee7df26e86084f057b7a1a5ca6", "url": "https://github.com/apache/skywalking/commit/05804658bd456aee7df26e86084f057b7a1a5ca6", "message": "Add comments for `ContextCarrierHelper`", "committedDate": "2020-03-08T13:50:44Z", "type": "commit"}, {"oid": "1f8aa6f5c9fe639277e04daeccf4b4582e8c2f6f", "url": "https://github.com/apache/skywalking/commit/1f8aa6f5c9fe639277e04daeccf4b4582e8c2f6f", "message": "Fix ContextHolderFactory to avoid context pollution", "committedDate": "2020-03-10T15:55:53Z", "type": "commit"}, {"oid": "bf0acb5f26ab44318d80d7c326d294404a59db37", "url": "https://github.com/apache/skywalking/commit/bf0acb5f26ab44318d80d7c326d294404a59db37", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-10T15:58:04Z", "type": "commit"}, {"oid": "84d062aeb3a0c088d96e02a001d39a1a720ffe50", "url": "https://github.com/apache/skywalking/commit/84d062aeb3a0c088d96e02a001d39a1a720ffe50", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-11T01:00:54Z", "type": "commit"}, {"oid": "c056084f5ab00084e380a0a179cb8644ee586e05", "url": "https://github.com/apache/skywalking/commit/c056084f5ab00084e380a0a179cb8644ee586e05", "message": "Merge branch 'master' into finagle-plugin", "committedDate": "2020-03-11T02:31:12Z", "type": "commit"}]}