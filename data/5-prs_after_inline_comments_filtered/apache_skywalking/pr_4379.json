{"pr_number": 4379, "pr_title": "Fix ehcache:\u00a0 missing interceptor of private constructor and setName method", "pr_createdAt": "2020-02-17T16:23:33Z", "pr_url": "https://github.com/apache/skywalking/pull/4379", "timeline": [{"oid": "54c1cd5cb04f012ff48c8b87c11df11041e3f499", "url": "https://github.com/apache/skywalking/commit/54c1cd5cb04f012ff48c8b87c11df11041e3f499", "message": "Fix ehcache:\u00a0 missing interceptor of private constructor called by clone method", "committedDate": "2020-02-17T15:31:28Z", "type": "commit"}, {"oid": "9a7ff1661ec2182991afa8303a5a82c6ec36479b", "url": "https://github.com/apache/skywalking/commit/9a7ff1661ec2182991afa8303a5a82c6ec36479b", "message": "Merge branch 'master' into master", "committedDate": "2020-02-17T16:27:38Z", "type": "commit"}, {"oid": "74c1f7ef73d6fafa24107ae8f9433f8e4c53c6ac", "url": "https://github.com/apache/skywalking/commit/74c1f7ef73d6fafa24107ae8f9433f8e4c53c6ac", "message": "ehcache-2.x-scenario add EhcacheCloneInterceptor case", "committedDate": "2020-02-18T05:07:16Z", "type": "commit"}, {"oid": "ff76951d01caebfe3c32864e526d4f82df60ca96", "url": "https://github.com/apache/skywalking/commit/ff76951d01caebfe3c32864e526d4f82df60ca96", "message": "Merge branch 'master' of https://github.com/lsyf/skywalking", "committedDate": "2020-02-18T05:08:36Z", "type": "commit"}, {"oid": "e57176d05e00fa8893be15a206b0508f24cc56c1", "url": "https://github.com/apache/skywalking/commit/e57176d05e00fa8893be15a206b0508f24cc56c1", "message": "Fix ehcache:\u00a0 add interceptor for Cache's private constructor and setName method", "committedDate": "2020-02-18T14:33:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNDQwMA==", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381014400", "bodyText": "You don't need to use this try/catch. getConstructorsInterceptPoints returns an array, you should set up the interceptors separately. This one you didi has a performance issue.", "author": "wu-sheng", "createdAt": "2020-02-19T00:28:18Z", "path": "apm-sniffer/apm-sdk-plugin/ehcache-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/ehcache/v2/EhcacheConstructorInterceptor.java", "diffHunk": "@@ -18,18 +18,28 @@\n \n package org.apache.skywalking.apm.plugin.ehcache.v2;\n \n+import net.sf.ehcache.Cache;\n import net.sf.ehcache.config.CacheConfiguration;\n import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceConstructorInterceptor;\n \n public class EhcacheConstructorInterceptor implements InstanceConstructorInterceptor {\n     @Override\n     public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n-        CacheConfiguration cacheConfiguration = (CacheConfiguration) allArguments[0];\n+        try {\n+            CacheConfiguration cacheConfiguration = (CacheConfiguration) allArguments[0];\n \n-        // get cache name\n-        if (cacheConfiguration != null) {\n-            objInst.setSkyWalkingDynamicField(new EhcacheEnhanceInfo(cacheConfiguration.getName()));\n+            // get cache name\n+            if (cacheConfiguration != null) {\n+                objInst.setSkyWalkingDynamicField(new EhcacheEnhanceInfo(cacheConfiguration.getName()));\n+            }\n+        } catch (ClassCastException e) {", "originalCommit": "e57176d05e00fa8893be15a206b0508f24cc56c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA0OTM0OQ==", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381049349", "bodyText": "Can I use instanseof instead?\n       if (argument instanceof CacheConfiguration) {\n            CacheConfiguration cacheConfiguration = (CacheConfiguration) argument;\n\n            // get cache name\n            if (cacheConfiguration != null) {\n                objInst.setSkyWalkingDynamicField(new EhcacheEnhanceInfo(cacheConfiguration.getName()));\n            }\n\n        } else if (argument instanceof Cache) {\n            Cache cache = (Cache) argument;\n\n            // get cache name\n            if (cache != null && cache.getCacheConfiguration() != null) {\n                objInst.setSkyWalkingDynamicField(new EhcacheEnhanceInfo(cache.getCacheConfiguration().getName()));\n            }\n        }", "author": "lsyf", "createdAt": "2020-02-19T02:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNDQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA0OTc5MQ==", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381049791", "bodyText": "Why? instanceof is still much much slower than instrumentation level match.", "author": "wu-sheng", "createdAt": "2020-02-19T02:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNDQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA1MTY4MA==", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381051680", "bodyText": "ok. Thank you for your seriousness", "author": "lsyf", "createdAt": "2020-02-19T02:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNDQwMA=="}], "type": "inlineReview"}, {"oid": "b2ad63430bf9851e92e4d6bfcbcb7d96a6dcc6d7", "url": "https://github.com/apache/skywalking/commit/b2ad63430bf9851e92e4d6bfcbcb7d96a6dcc6d7", "message": "Fix ehcache:\u00a0performance issue", "committedDate": "2020-02-19T04:10:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyMTEyOQ==", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381121129", "bodyText": "Is this a code format error?", "author": "mrproliu", "createdAt": "2020-02-19T07:43:34Z", "path": "apm-sniffer/apm-sdk-plugin/ehcache-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/ehcache/v2/define/EhcachePluginInstrumentation.java", "diffHunk": "@@ -82,13 +88,41 @@\n                 public String getConstructorInterceptor() {\n                     return CONSTRUCTOR_CLASS_INTERCEPT_CLASS;\n                 }\n+            },\n+            new ConstructorInterceptPoint() {\n+                @Override\n+                public ElementMatcher<MethodDescription> getConstructorMatcher() {\n+                    return isPrivate().and(takesArgument(0, named(\"net.sf.ehcache.Cache\")));\n+                }\n+\n+                @Override\n+                public String getConstructorInterceptor() {\n+                    return PRIVATE_CONSTRUCTOR_CLASS_INTERCEPT_CLASS;\n+                }\n             }\n         };\n     }\n \n     @Override\n     public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {\n         return new InstanceMethodsInterceptPoint[] {\n+            new InstanceMethodsInterceptPoint() {\n+                @Override\n+                public ElementMatcher<MethodDescription> getMethodsMatcher() {\n+                    return named(CACHE_NAME_ENHANCE_METHOD).and(takesArgument(0, String.class));\n+                }\n+\n+                @Override\n+                public String getMethodsInterceptor() {\n+                    return CACHE_NAME_INTERCEPTOR_CLASS;\n+                }\n+\n+                @Override\n+                public boolean isOverrideArgs() {\n+                        return false;\n+                    }", "originalCommit": "b2ad63430bf9851e92e4d6bfcbcb7d96a6dcc6d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyNTU4OA==", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381125588", "bodyText": "Yes. Do I need to format and check?", "author": "lsyf", "createdAt": "2020-02-19T07:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyMTEyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE1NDg0OQ==", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381154849", "bodyText": "Yes, you should. The format check will be more strict soon for the test case.", "author": "wu-sheng", "createdAt": "2020-02-19T09:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyMTEyOQ=="}], "type": "inlineReview"}, {"oid": "102c90dc59d5ce3cc20d26eb36124a17c9aeedf8", "url": "https://github.com/apache/skywalking/commit/102c90dc59d5ce3cc20d26eb36124a17c9aeedf8", "message": "Fix ehcache:\u00a0format", "committedDate": "2020-02-19T09:23:33Z", "type": "commit"}, {"oid": "0d4714564f7f680a9d20d5cc1077044972069313", "url": "https://github.com/apache/skywalking/commit/0d4714564f7f680a9d20d5cc1077044972069313", "message": "Merge branch 'master' into master", "committedDate": "2020-02-19T10:18:31Z", "type": "commit"}]}