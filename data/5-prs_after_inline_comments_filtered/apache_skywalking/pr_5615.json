{"pr_number": 5615, "pr_title": " Support group concept in the alarm core", "pr_createdAt": "2020-10-01T05:48:17Z", "pr_url": "https://github.com/apache/skywalking/pull/5615", "timeline": [{"oid": "b53a01fbbbb6f6e10edfa4628a0d64eb7f09017e", "url": "https://github.com/apache/skywalking/commit/b53a01fbbbb6f6e10edfa4628a0d64eb7f09017e", "message": "add composite rule config", "committedDate": "2020-10-01T02:39:38Z", "type": "commit"}, {"oid": "d6e9a2d71502d91a4794760e9c6be48dc9fd4b86", "url": "https://github.com/apache/skywalking/commit/d6e9a2d71502d91a4794760e9c6be48dc9fd4b86", "message": "add test case", "committedDate": "2020-10-01T05:19:35Z", "type": "commit"}, {"oid": "b5adde1a114bbf789adb9f70f438e7de2449622b", "url": "https://github.com/apache/skywalking/commit/b5adde1a114bbf789adb9f70f438e7de2449622b", "message": "fix test case", "committedDate": "2020-10-01T05:35:03Z", "type": "commit"}, {"oid": "4553cb15eb9f975b69b3d69f91943fbf88ebb21a", "url": "https://github.com/apache/skywalking/commit/4553cb15eb9f975b69b3d69f91943fbf88ebb21a", "message": "Merge branch 'master' into group-alarm", "committedDate": "2020-10-01T06:22:33Z", "type": "commit"}, {"oid": "759b0af0a23cb752b775cec1fe6244566537f210", "url": "https://github.com/apache/skywalking/commit/759b0af0a23cb752b775cec1fe6244566537f210", "message": "Merge branch 'master' into group-alarm", "committedDate": "2020-10-01T07:08:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAzMDUwNw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498030507", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method RunningRule$Window.checkAlarm() indirectly reads without synchronization from this.values. Potentially races with write in method RunningRule$Window.add(...).\nReporting because another access to the same memory occurs on a background thread, although this access may not.", "author": "sonatype-lift", "createdAt": "2020-10-01T07:15:20Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/RunningRule.java", "diffHunk": "@@ -323,7 +328,7 @@\n             }\n         }\n \n-        public AlarmMessage checkAlarm() {\n+        public Optional<AlarmMessage> checkAlarm() {\n             if (isMatch()) {", "originalCommit": "4553cb15eb9f975b69b3d69f91943fbf88ebb21a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4NzkzNA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498087934", "bodyText": "The test cases should cover the exception cases. Such as, what happens for a_rule + b_rule, not_exist_rule && b_rule.", "author": "wu-sheng", "createdAt": "2020-10-01T08:55:35Z", "path": "oap-server/server-alarm-plugin/src/test/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluatorTest.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.ExpressionContext;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+\n+public class CompositeRuleEvaluatorTest {", "originalCommit": "759b0af0a23cb752b775cec1fe6244566537f210", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxOTQ4OA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498319488", "bodyText": "Changed onlyAsGroupCondition to onlyAsCondition.\nUpdate document\n\nPlese help to check again.", "author": "xbkaishui", "createdAt": "2020-10-01T15:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4NzkzNA=="}], "type": "inlineReview"}, {"oid": "5b288b815247072d5ae32ea0cb4e771f90af5e35", "url": "https://github.com/apache/skywalking/commit/5b288b815247072d5ae32ea0cb4e771f90af5e35", "message": "add license and more test", "committedDate": "2020-10-01T15:07:24Z", "type": "commit"}, {"oid": "b625300ed7f7fa15ff33dd01e49cbda816e9d820", "url": "https://github.com/apache/skywalking/commit/b625300ed7f7fa15ff33dd01e49cbda816e9d820", "message": "update document", "committedDate": "2020-10-01T15:07:24Z", "type": "commit"}, {"oid": "c620ad971f67252c1bd5bce921bea09959c25b42", "url": "https://github.com/apache/skywalking/commit/c620ad971f67252c1bd5bce921bea09959c25b42", "message": "revert change", "committedDate": "2020-10-01T15:11:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4NzM3OQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498587379", "bodyText": "Do we have the chance to log or raise the exception when exceptions happen?", "author": "wu-sheng", "createdAt": "2020-10-02T01:46:02Z", "path": "oap-server/server-alarm-plugin/src/test/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluatorTest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.ExpressionContext;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+\n+public class CompositeRuleEvaluatorTest {\n+\n+    private CompositeRuleEvaluator ruleEvaluator;\n+\n+    @Before\n+    public void init() {\n+        Expression expression = new Expression(new ExpressionContext());\n+        ruleEvaluator = new CompositeRuleEvaluator(expression);\n+    }\n+\n+    @Test\n+    public void testEvaluatorMessageWithAndOp() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule && b_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        List<AlarmMessage> compositeMsgs = ruleEvaluator.evaluator(compositeAlarmRules, alarmMessages);\n+        assertThat(compositeMsgs.size(), is(1));\n+        assertThat(compositeMsgs.get(0).getAlarmMessage(), is(\"composite rule triggered!\"));\n+        assertThat(compositeMsgs.get(0).getRuleName(), is(\"dummy\"));\n+    }\n+\n+    @Test\n+    public void testEvaluatorMessageWithNotExistsRule() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule && not_exist_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        List<AlarmMessage> compositeMsgs = ruleEvaluator.evaluator(compositeAlarmRules, alarmMessages);\n+        assertThat(compositeMsgs.size(), is(0));\n+    }\n+\n+    @Test\n+    public void testEvaluatorMessageWithException() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule + b_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        List<AlarmMessage> compositeMsgs = ruleEvaluator.evaluator(compositeAlarmRules, alarmMessages);\n+        assertThat(compositeMsgs.size(), is(0));", "originalCommit": "c620ad971f67252c1bd5bce921bea09959c25b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzcxNg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498807716", "bodyText": "Yes, will log the exception", "author": "xbkaishui", "createdAt": "2020-10-02T13:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4NzM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgzMDQxNg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498830416", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T13:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4NzM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4NzYzNA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498587634", "bodyText": "Does the AlarmMessage include the id0/id1/name? Please verify those.", "author": "wu-sheng", "createdAt": "2020-10-02T01:47:34Z", "path": "oap-server/server-alarm-plugin/src/test/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluatorTest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.ExpressionContext;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+\n+public class CompositeRuleEvaluatorTest {\n+\n+    private CompositeRuleEvaluator ruleEvaluator;\n+\n+    @Before\n+    public void init() {\n+        Expression expression = new Expression(new ExpressionContext());\n+        ruleEvaluator = new CompositeRuleEvaluator(expression);\n+    }\n+\n+    @Test\n+    public void testEvaluatorMessageWithAndOp() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule && b_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        List<AlarmMessage> compositeMsgs = ruleEvaluator.evaluator(compositeAlarmRules, alarmMessages);\n+        assertThat(compositeMsgs.size(), is(1));\n+        assertThat(compositeMsgs.get(0).getAlarmMessage(), is(\"composite rule triggered!\"));\n+        assertThat(compositeMsgs.get(0).getRuleName(), is(\"dummy\"));\n+    }\n+\n+    @Test\n+    public void testEvaluatorMessageWithNotExistsRule() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule && not_exist_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        List<AlarmMessage> compositeMsgs = ruleEvaluator.evaluator(compositeAlarmRules, alarmMessages);\n+        assertThat(compositeMsgs.size(), is(0));\n+    }\n+\n+    @Test\n+    public void testEvaluatorMessageWithException() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule + b_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        List<AlarmMessage> compositeMsgs = ruleEvaluator.evaluator(compositeAlarmRules, alarmMessages);\n+        assertThat(compositeMsgs.size(), is(0));\n+    }\n+\n+    private List<AlarmMessage> getAlarmMessages() {\n+        List<AlarmMessage> alarmMessages = new ArrayList<>();\n+        AlarmMessage alarmMessage = new AlarmMessage();\n+        alarmMessage.setRuleName(\"a_rule\");\n+        alarmMessage.setOnlyAsCondition(true);\n+        alarmMessage.setId0(\"11\");\n+        alarmMessage.setName(\"\");\n+        alarmMessage.setScope(\"\");\n+        alarmMessage.setScopeId(1);\n+        alarmMessages.add(alarmMessage);\n+        alarmMessage = new AlarmMessage();\n+        alarmMessage.setRuleName(\"b_rule\");\n+        alarmMessage.setOnlyAsCondition(true);\n+        alarmMessage.setId0(\"11\");\n+        alarmMessage.setName(\"\");\n+        alarmMessage.setScope(\"\");\n+        alarmMessage.setScopeId(1);\n+        alarmMessages.add(alarmMessage);\n+        return alarmMessages;\n+    }\n+\n+    @Test\n+    public void testEvaluatorMessageWithOrOp() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule || b_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        alarmMessages.remove(0);\n+        List<AlarmMessage> compositeMsgs = ruleEvaluator.evaluator(compositeAlarmRules, alarmMessages);", "originalCommit": "c620ad971f67252c1bd5bce921bea09959c25b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxOTg2MQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498819861", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T13:26:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4NzYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4OTAxOQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498589019", "bodyText": "Const#ID_CONNECTOR is _.", "author": "wu-sheng", "createdAt": "2020-10-02T01:55:13Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Evaluator composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+@AllArgsConstructor\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+\n+    /**\n+     * Evaluator composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluator(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {\n+        final List<AlarmMessage> compositeRuleMessages = new ArrayList<>();\n+        ImmutableListMultimap<String, AlarmMessage> messageMap = Multimaps.index(alarmMessages, alarmMessage -> Joiner.on(\"_\").useForNull(\"\").join(alarmMessage.getId0(), alarmMessage.getId1()));", "originalCommit": "c620ad971f67252c1bd5bce921bea09959c25b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyMDU2NA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498820564", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T13:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4OTAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4OTE0MA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498589140", "bodyText": "The coverage reports many lines are not covered, please recheck, as this method is super important for this feature.", "author": "wu-sheng", "createdAt": "2020-10-02T01:55:48Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Evaluator composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+@AllArgsConstructor\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+\n+    /**\n+     * Evaluator composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluator(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {", "originalCommit": "c620ad971f67252c1bd5bce921bea09959c25b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyMTg5OQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498821899", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T13:29:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4OTE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4OTQxMw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498589413", "bodyText": "What does this remove mean?", "author": "wu-sheng", "createdAt": "2020-10-02T01:57:33Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Evaluator composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+@AllArgsConstructor\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+\n+    /**\n+     * Evaluator composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluator(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {\n+        final List<AlarmMessage> compositeRuleMessages = new ArrayList<>();\n+        ImmutableListMultimap<String, AlarmMessage> messageMap = Multimaps.index(alarmMessages, alarmMessage -> Joiner.on(\"_\").useForNull(\"\").join(alarmMessage.getId0(), alarmMessage.getId1()));\n+        for (CompositeAlarmRule compositeAlarmRule : compositeAlarmRules) {\n+            String expr = compositeAlarmRule.getExpression();\n+            Set<String> dependencyRules = expression.analysisInputs(expr);\n+            Map<String, Object> dataContext = new HashMap<>();\n+            messageMap.asMap().forEach((key, alarmMessageList) -> {\n+                Set<String> allRuleNames = new HashSet<>(dependencyRules);\n+                alarmMessageList.forEach(alarmMessage -> {\n+                    if (allRuleNames.remove(alarmMessage.getRuleName())) {", "originalCommit": "c620ad971f67252c1bd5bce921bea09959c25b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyMjQ2MQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498822461", "bodyText": "I have refactored this logic.  please check again", "author": "xbkaishui", "createdAt": "2020-10-02T13:30:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU4OTQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU5MDE4Mw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498590183", "bodyText": "As these supported, I think name and id0/id1 are available in the message. Could you update the doc?", "author": "wu-sheng", "createdAt": "2020-10-02T02:02:06Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Evaluator composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+@AllArgsConstructor\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+\n+    /**\n+     * Evaluator composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluator(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {\n+        final List<AlarmMessage> compositeRuleMessages = new ArrayList<>();\n+        ImmutableListMultimap<String, AlarmMessage> messageMap = Multimaps.index(alarmMessages, alarmMessage -> Joiner.on(\"_\").useForNull(\"\").join(alarmMessage.getId0(), alarmMessage.getId1()));\n+        for (CompositeAlarmRule compositeAlarmRule : compositeAlarmRules) {\n+            String expr = compositeAlarmRule.getExpression();\n+            Set<String> dependencyRules = expression.analysisInputs(expr);\n+            Map<String, Object> dataContext = new HashMap<>();\n+            messageMap.asMap().forEach((key, alarmMessageList) -> {\n+                Set<String> allRuleNames = new HashSet<>(dependencyRules);\n+                alarmMessageList.forEach(alarmMessage -> {\n+                    if (allRuleNames.remove(alarmMessage.getRuleName())) {\n+                        dataContext.put(alarmMessage.getRuleName(), true);\n+                    }\n+                });\n+                allRuleNames.forEach(ruleName -> {\n+                    dataContext.put(ruleName, false);\n+                });\n+                Object matched = expression.eval(expr, dataContext);\n+                if (matched instanceof Boolean && (Boolean) matched) {\n+                    AlarmMessage headMsg = alarmMessageList.iterator().next();\n+                    AlarmMessage message = new AlarmMessage();\n+                    message.setOnlyAsCondition(false);\n+                    message.setScopeId(headMsg.getScopeId());\n+                    message.setScope(headMsg.getScope());\n+                    message.setName(headMsg.getName());\n+                    message.setId0(headMsg.getId0());\n+                    message.setId1(headMsg.getId1());", "originalCommit": "c620ad971f67252c1bd5bce921bea09959c25b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyMzA0Nw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498823047", "bodyText": "sorry.  should I update which part of the doc?", "author": "xbkaishui", "createdAt": "2020-10-02T13:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU5MDE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0MTM2MQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498841361", "bodyText": "Add message description in the rule part, https://github.com/apache/skywalking/blob/master/docs/en/setup/backend/backend-alarm.md#rules.\nAlso, should add to the composite rule part.", "author": "wu-sheng", "createdAt": "2020-10-02T14:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU5MDE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5MDQwMg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499090402", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T23:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU5MDE4Mw=="}], "type": "inlineReview"}, {"oid": "ba927b1090aed62032899a986cd4e16e7edd1976", "url": "https://github.com/apache/skywalking/commit/ba927b1090aed62032899a986cd4e16e7edd1976", "message": "refactor and add more test", "committedDate": "2020-10-02T13:25:57Z", "type": "commit"}, {"oid": "4f3264cad6097ad74673db0b8ad007206c2d317c", "url": "https://github.com/apache/skywalking/commit/4f3264cad6097ad74673db0b8ad007206c2d317c", "message": "Merge branch 'master' into group-alarm", "committedDate": "2020-10-02T14:10:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0OTc2Mg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498849762", "bodyText": "evaluator is referring to an object. You may mean evaluate.", "author": "wu-sheng", "createdAt": "2020-10-02T14:16:50Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Evaluator composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+@AllArgsConstructor\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+\n+    /**\n+     * Evaluator composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluator(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {", "originalCommit": "4f3264cad6097ad74673db0b8ad007206c2d317c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMTY1MQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498911651", "bodyText": "evaluator is referring to an object. You may mean evaluate.\n\nSame as the comments above (the method and the class)", "author": "kezhenxu94", "createdAt": "2020-10-02T16:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0OTc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4MTU2Ng==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499081566", "bodyText": "Done, thanks", "author": "xbkaishui", "createdAt": "2020-10-02T22:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0OTc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1MDI0MA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498850240", "bodyText": "If contains, then put?", "author": "wu-sheng", "createdAt": "2020-10-02T14:17:39Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Evaluator composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+@AllArgsConstructor\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+\n+    /**\n+     * Evaluator composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluator(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {\n+        final List<AlarmMessage> compositeRuleMessages = new ArrayList<>();\n+        ImmutableListMultimap<String, AlarmMessage> messageMap = Multimaps.index(alarmMessages, alarmMessage -> Joiner.on(Const.ID_CONNECTOR).useForNull(Const.EMPTY_STRING).join(alarmMessage.getId0(), alarmMessage.getId1()));\n+        for (CompositeAlarmRule compositeAlarmRule : compositeAlarmRules) {\n+            String expr = compositeAlarmRule.getExpression();\n+            Set<String> dependencyRules = expression.analysisInputs(expr);\n+            Map<String, Object> dataContext = new HashMap<>();\n+            messageMap.asMap().forEach((key, alarmMessageList) -> {\n+                dependencyRules.forEach(ruleName -> dataContext.put(ruleName, false));\n+                alarmMessageList.forEach(alarmMessage -> {\n+                    if (dependencyRules.contains(alarmMessage.getRuleName())) {\n+                        dataContext.put(alarmMessage.getRuleName(), true);", "originalCommit": "4f3264cad6097ad74673db0b8ad007206c2d317c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4MTQzMw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499081433", "bodyText": "Yes, when the composite rule contains this rulename, then put in the data context for eval the expression", "author": "xbkaishui", "createdAt": "2020-10-02T22:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1MDI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1MDk4Mg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498850982", "bodyText": "This should move to the last field of the class.", "author": "wu-sheng", "createdAt": "2020-10-02T14:18:49Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/Rules.java", "diffHunk": "@@ -31,13 +31,15 @@\n @Getter\n @ToString\n public class Rules {\n+    private List<CompositeAlarmRule> compositeRules;", "originalCommit": "4f3264cad6097ad74673db0b8ad007206c2d317c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5MDQ5OQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499090499", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T23:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1MDk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1MTA2Mw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498851063", "bodyText": "Same here.", "author": "wu-sheng", "createdAt": "2020-10-02T14:18:57Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/Rules.java", "diffHunk": "@@ -31,13 +31,15 @@\n @Getter\n @ToString\n public class Rules {\n+    private List<CompositeAlarmRule> compositeRules;\n     private List<AlarmRule> rules;\n     private List<String> webhooks;\n     private GRPCAlarmSetting grpchookSetting;\n     private SlackSettings slacks;\n     private WechatSettings wecchats;\n \n     public Rules() {\n+        this.compositeRules = new ArrayList<>();", "originalCommit": "4f3264cad6097ad74673db0b8ad007206c2d317c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5MDUxNg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499090516", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T23:44:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1MTA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MTQwNQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498861405", "bodyText": "Could you recheck what is the status if the dynamic config center pushing an illegal alarm setting?", "author": "wu-sheng", "createdAt": "2020-10-02T14:36:01Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/RulesReader.java", "diffHunk": "@@ -49,93 +50,136 @@ public Rules readRules() {\n         Rules rules = new Rules();\n \n         if (Objects.nonNull(yamlData)) {\n-            Map rulesData = (Map) yamlData.get(\"rules\");\n-            if (rulesData != null) {\n-                rules.setRules(new ArrayList<>());\n-                rulesData.forEach((k, v) -> {\n-                    if (((String) k).endsWith(\"_rule\")) {\n-                        AlarmRule alarmRule = new AlarmRule();\n-                        alarmRule.setAlarmRuleName((String) k);\n-                        Map settings = (Map) v;\n-                        Object metricsName = settings.get(\"metrics-name\");\n-                        if (metricsName == null) {\n-                            throw new IllegalArgumentException(\"metrics-name can't be null\");\n-                        }\n-\n-                        alarmRule.setMetricsName((String) metricsName);\n-                        alarmRule.setIncludeNames((ArrayList) settings.getOrDefault(\"include-names\", new ArrayList(0)));\n-                        alarmRule.setExcludeNames((ArrayList) settings.getOrDefault(\"exclude-names\", new ArrayList(0)));\n-                        alarmRule.setIncludeNamesRegex((String) settings.getOrDefault(\"include-names-regex\", \"\"));\n-                        alarmRule.setExcludeNamesRegex((String) settings.getOrDefault(\"exclude-names-regex\", \"\"));\n-                        alarmRule.setIncludeLabels(\n-                            (ArrayList) settings.getOrDefault(\"include-labels\", new ArrayList(0)));\n-                        alarmRule.setExcludeLabels(\n-                            (ArrayList) settings.getOrDefault(\"exclude-labels\", new ArrayList(0)));\n-                        alarmRule.setIncludeLabelsRegex((String) settings.getOrDefault(\"include-labels-regex\", \"\"));\n-                        alarmRule.setExcludeLabelsRegex((String) settings.getOrDefault(\"exclude-labels-regex\", \"\"));\n-                        alarmRule.setThreshold(settings.get(\"threshold\").toString());\n-                        alarmRule.setOp((String) settings.get(\"op\"));\n-                        alarmRule.setPeriod((Integer) settings.getOrDefault(\"period\", 1));\n-                        alarmRule.setCount((Integer) settings.getOrDefault(\"count\", 1));\n-                        // How many times of checks, the alarm keeps silence after alarm triggered, default as same as period.\n-                        alarmRule.setSilencePeriod((Integer) settings.getOrDefault(\"silence-period\", alarmRule.getPeriod()));\n-                        alarmRule.setMessage(\n-                            (String) settings.getOrDefault(\"message\", \"Alarm caused by Rule \" + alarmRule\n-                                .getAlarmRuleName()));\n+            readRulesConfig(rules);\n+            readCompositeRuleConfig(rules);\n+            readWebHookConfig(rules);\n+            readGrpcConfig(rules);\n+            readSlackConfig(rules);\n+            readWechatConfig(rules);\n+        }\n+        return rules;\n+    }\n \n-                        rules.getRules().add(alarmRule);\n-                    }\n-                });\n-            }\n-            List webhooks = (List) yamlData.get(\"webhooks\");\n-            if (webhooks != null) {\n-                rules.setWebhooks(new ArrayList<>());\n-                webhooks.forEach(url -> {\n-                    rules.getWebhooks().add((String) url);\n-                });\n+    private void readCompositeRuleConfig(Rules rules) {\n+        Map compositeRulesData = (Map) yamlData.get(\"composite-rules\");\n+        if (compositeRulesData == null) {\n+            return;\n+        }\n+        compositeRulesData.forEach((k, v) -> {\n+            String ruleName = (String) k;\n+            if (ruleName.endsWith(\"_rule\")) {\n+                Map settings = (Map) v;\n+                CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule();\n+                compositeAlarmRule.setAlarmRuleName(ruleName);\n+                String expression = (String) settings.get(\"expression\");\n+                if (expression == null) {\n+                    throw new IllegalArgumentException(\"expression can't be null\");", "originalCommit": "4f3264cad6097ad74673db0b8ad007206c2d317c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4MjkwMQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499082901", "bodyText": "This will throws a exception, and current new rules will not effect, the system will use old rules config,\ndo you mean I should not throws Exception ?", "author": "xbkaishui", "createdAt": "2020-10-02T23:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MTQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwMTY2Nw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499101667", "bodyText": "I didn't mean anything should be changed, I was just rechecking the status. It is good enough", "author": "wu-sheng", "createdAt": "2020-10-03T01:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MTQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNjAwNg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499106006", "bodyText": "got it", "author": "xbkaishui", "createdAt": "2020-10-03T02:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MTQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMDgyMw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498910823", "bodyText": "compositeRuleEvaluator is effectively final, and doesn't need volatile", "author": "kezhenxu94", "createdAt": "2020-10-02T16:00:14Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/AlarmRulesWatcher.java", "diffHunk": "@@ -46,16 +48,24 @@\n     private volatile Map<AlarmRule, RunningRule> alarmRuleRunningRuleMap;\n     private volatile Rules rules;\n     private volatile String settingsString;\n+    @Getter\n+    private volatile CompositeRuleEvaluator compositeRuleEvaluator;", "originalCommit": "4f3264cad6097ad74673db0b8ad007206c2d317c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5MDk0OQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499090949", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T23:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMDgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNDgxMA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r498914810", "bodyText": "Super long, please break the line", "author": "kezhenxu94", "createdAt": "2020-10-02T16:08:08Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Evaluator composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+@AllArgsConstructor\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+\n+    /**\n+     * Evaluator composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluator(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {\n+        final List<AlarmMessage> compositeRuleMessages = new ArrayList<>();\n+        ImmutableListMultimap<String, AlarmMessage> messageMap = Multimaps.index(alarmMessages, alarmMessage -> Joiner.on(Const.ID_CONNECTOR).useForNull(Const.EMPTY_STRING).join(alarmMessage.getId0(), alarmMessage.getId1()));", "originalCommit": "4f3264cad6097ad74673db0b8ad007206c2d317c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5MDk3NA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499090974", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-02T23:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNDgxMA=="}], "type": "inlineReview"}, {"oid": "f70a4ed8cd4df0b1e84c8928d99aab6e7be8d082", "url": "https://github.com/apache/skywalking/commit/f70a4ed8cd4df0b1e84c8928d99aab6e7be8d082", "message": "change naming style", "committedDate": "2020-10-02T23:43:11Z", "type": "commit"}, {"oid": "4e8366b88907769e39e0308180aca09d1f5da840", "url": "https://github.com/apache/skywalking/commit/4e8366b88907769e39e0308180aca09d1f5da840", "message": "typo", "committedDate": "2020-10-02T23:46:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNjMxMQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499106311", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class CompositeRuleEvaluate {\n          \n          \n            \n            public class CompositeRuleEvaluator {\n          \n      \n    \n    \n  \n\nThe class name should be Evaluator, method name should be evaluate. :)", "author": "wu-sheng", "createdAt": "2020-10-03T02:05:29Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluate.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import lombok.AllArgsConstructor;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Evaluate composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+@AllArgsConstructor\n+public class CompositeRuleEvaluate {", "originalCommit": "4e8366b88907769e39e0308180aca09d1f5da840", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwODEzOQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499108139", "bodyText": "ok", "author": "xbkaishui", "createdAt": "2020-10-03T02:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNjMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwODMxNw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499108317", "bodyText": "ok", "author": "xbkaishui", "createdAt": "2020-10-03T02:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNjMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNjkyOA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499106928", "bodyText": "Just for confirmation, at here, nothing will show up as log or exception, right? As not_exist_rule doesn't exist.", "author": "wu-sheng", "createdAt": "2020-10-03T02:13:17Z", "path": "oap-server/server-alarm-plugin/src/test/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluateTest.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.ExpressionContext;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+\n+public class CompositeRuleEvaluateTest {\n+\n+    private CompositeRuleEvaluate ruleEvaluate;\n+\n+    @Before\n+    public void init() {\n+        Expression expression = new Expression(new ExpressionContext());\n+        ruleEvaluate = new CompositeRuleEvaluate(expression);\n+    }\n+\n+    @Test\n+    public void testEvaluateMessageWithAndOp() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule && b_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        List<AlarmMessage> compositeMsgs = ruleEvaluate.evaluate(compositeAlarmRules, alarmMessages);\n+        assertThat(compositeMsgs.size(), is(1));\n+        assertThat(compositeMsgs.get(0).getAlarmMessage(), is(\"composite rule triggered!\"));\n+        assertThat(compositeMsgs.get(0).getRuleName(), is(\"dummy\"));\n+        assertThat(compositeMsgs.get(0).getId0(), is(\"id0\"));\n+        assertThat(compositeMsgs.get(0).getId1(), is(\"id1\"));\n+        assertThat(compositeMsgs.get(0).isOnlyAsCondition(), is(false));\n+    }\n+\n+    @Test\n+    public void testEvaluateMessageWithNotExistsRule() {\n+        List<CompositeAlarmRule> compositeAlarmRules = new ArrayList<>();\n+        CompositeAlarmRule compositeAlarmRule = new CompositeAlarmRule(\"dummy\", \"a_rule && not_exist_rule\", \"composite rule triggered!\");\n+        compositeAlarmRules.add(compositeAlarmRule);\n+        List<AlarmMessage> alarmMessages = getAlarmMessages();\n+        List<AlarmMessage> compositeMsgs = ruleEvaluate.evaluate(compositeAlarmRules, alarmMessages);", "originalCommit": "4e8366b88907769e39e0308180aca09d1f5da840", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwODMwNQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499108305", "bodyText": "Yes, the error log is in Expression.eval method", "author": "xbkaishui", "createdAt": "2020-10-03T02:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNjkyOA=="}], "type": "inlineReview"}, {"oid": "dca9216b6ce44a7e25802a0f554349d5db4c629c", "url": "https://github.com/apache/skywalking/commit/dca9216b6ce44a7e25802a0f554349d5db4c629c", "message": "add format composite rule message, change class name", "committedDate": "2020-10-03T04:50:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTM0NA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499129344", "bodyText": "Would be a compile exception?", "author": "wu-sheng", "createdAt": "2020-10-03T08:42:54Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/expression/Expression.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider.expression;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.mvel2.MVEL;\n+import org.mvel2.ParserContext;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+@Slf4j\n+public class Expression {\n+    private Map<String, Object> expressionCache;\n+    private ExpressionContext context;\n+\n+    public Expression(ExpressionContext context) {\n+        this.context = context;\n+        this.expressionCache = new ConcurrentHashMap<>();\n+    }\n+\n+    public Object eval(String expression) {\n+        return eval(expression, null);\n+    }\n+\n+    public Object eval(String expression, Map<String, Object> vars) {\n+        Object obj = compile(expression, context);\n+        try {\n+            return MVEL.executeExpression(obj, vars);\n+        } catch (Throwable e) {\n+            log.error(\"eval expression {} error\", expression, e);\n+            return null;\n+        }\n+    }\n+\n+    public Object compile(String expression, ExpressionContext pctx) {\n+        Object o = expressionCache.get(expression);\n+        if (o == null) {\n+            o = MVEL.compileExpression(expression, pctx.getContext());", "originalCommit": "dca9216b6ce44a7e25802a0f554349d5db4c629c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzNzAwNQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499137005", "bodyText": "Yes, If the expression is invalid, it will throws an runtime exception named CompileException, for example  a && * b", "author": "xbkaishui", "createdAt": "2020-10-03T10:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTc1Mg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499129752", "bodyText": "The comments are missing for the class and methods.", "author": "wu-sheng", "createdAt": "2020-10-03T08:49:24Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/expression/ExpressionContext.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider.expression;\n+\n+import lombok.Getter;\n+import org.mvel2.ParserContext;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+\n+public class ExpressionContext {", "originalCommit": "dca9216b6ce44a7e25802a0f554349d5db4c629c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzOTg3Ng==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499139876", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T11:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTgyMA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499129820", "bodyText": "Miss a case about {name}.", "author": "wu-sheng", "createdAt": "2020-10-03T08:50:39Z", "path": "oap-server/server-alarm-plugin/src/test/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluatorTest.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.ExpressionContext;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+\n+public class CompositeRuleEvaluatorTest {", "originalCommit": "dca9216b6ce44a7e25802a0f554349d5db4c629c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzOTg2NQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499139865", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T11:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTgzMQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499129831", "bodyText": "The comments are missing for the class and methods.", "author": "wu-sheng", "createdAt": "2020-10-03T08:50:50Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/expression/Expression.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider.expression;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.mvel2.MVEL;\n+import org.mvel2.ParserContext;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+@Slf4j\n+public class Expression {", "originalCommit": "dca9216b6ce44a7e25802a0f554349d5db4c629c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzOTg0Nw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499139847", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T11:26:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyOTgzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzMDM4Mw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499130383", "bodyText": "Comments.", "author": "wu-sheng", "createdAt": "2020-10-03T08:59:48Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.MetaInAlarm;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Evaluate composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+    private Map<String, AlarmMessageFormatter> messageFormatterCache;\n+\n+    public CompositeRuleEvaluator(Expression expression) {\n+        this.expression = expression;\n+        this.messageFormatterCache = new ConcurrentHashMap<>();\n+    }\n+\n+    /**\n+     * Evaluate composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluate(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {\n+        final List<AlarmMessage> compositeRuleMessages = new ArrayList<>();\n+        ImmutableListMultimap<String, AlarmMessage> messageMap = Multimaps.index(alarmMessages, alarmMessage ->\n+                Joiner.on(Const.ID_CONNECTOR).useForNull(Const.EMPTY_STRING).join(alarmMessage.getId0(), alarmMessage.getId1()));\n+        for (CompositeAlarmRule compositeAlarmRule : compositeAlarmRules) {\n+            String expr = compositeAlarmRule.getExpression();\n+            Set<String> dependencyRules = expression.analysisInputs(expr);\n+            Map<String, Object> dataContext = new HashMap<>();\n+            messageMap.asMap().forEach((key, alarmMessageList) -> {\n+                dependencyRules.forEach(ruleName -> dataContext.put(ruleName, false));\n+                alarmMessageList.forEach(alarmMessage -> {\n+                    if (dependencyRules.contains(alarmMessage.getRuleName())) {\n+                        dataContext.put(alarmMessage.getRuleName(), true);\n+                    }\n+                });\n+                Object matched = expression.eval(expr, dataContext);\n+                if (matched instanceof Boolean && (Boolean) matched) {\n+                    AlarmMessage headMsg = alarmMessageList.iterator().next();\n+                    AlarmMessage message = new AlarmMessage();\n+                    message.setOnlyAsCondition(false);\n+                    message.setScopeId(headMsg.getScopeId());\n+                    message.setScope(headMsg.getScope());\n+                    message.setName(headMsg.getName());\n+                    message.setId0(headMsg.getId0());\n+                    message.setId1(headMsg.getId1());\n+                    message.setStartTime(System.currentTimeMillis());\n+                    message.setRuleName(compositeAlarmRule.getAlarmRuleName());\n+                    String alarmMessage = formatMessage(message, compositeAlarmRule.getMessage());\n+                    message.setAlarmMessage(alarmMessage);\n+                    compositeRuleMessages.add(message);\n+                }\n+            });\n+        }\n+        return compositeRuleMessages;\n+    }\n+\n+    private String formatMessage(AlarmMessage alarmMessage, String message) {", "originalCommit": "dca9216b6ce44a7e25802a0f554349d5db4c629c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzOTg0Mw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499139843", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T11:26:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzMDM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzMDQyOA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499130428", "bodyText": "The metrics name should be filled as the expression literal text.", "author": "wu-sheng", "createdAt": "2020-10-03T09:00:13Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/CompositeRuleEvaluator.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.MetaInAlarm;\n+import org.apache.skywalking.oap.server.core.alarm.provider.expression.Expression;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Evaluate composite rule using expression eval\n+ *\n+ * @since 8.2.0\n+ */\n+public class CompositeRuleEvaluator {\n+\n+    private Expression expression;\n+    private Map<String, AlarmMessageFormatter> messageFormatterCache;\n+\n+    public CompositeRuleEvaluator(Expression expression) {\n+        this.expression = expression;\n+        this.messageFormatterCache = new ConcurrentHashMap<>();\n+    }\n+\n+    /**\n+     * Evaluate composite rule\n+     *\n+     * @param compositeAlarmRules compositeRules\n+     * @param alarmMessages       triggered alarm messages\n+     * @return\n+     */\n+    public List<AlarmMessage> evaluate(List<CompositeAlarmRule> compositeAlarmRules, List<AlarmMessage> alarmMessages) {\n+        final List<AlarmMessage> compositeRuleMessages = new ArrayList<>();\n+        ImmutableListMultimap<String, AlarmMessage> messageMap = Multimaps.index(alarmMessages, alarmMessage ->\n+                Joiner.on(Const.ID_CONNECTOR).useForNull(Const.EMPTY_STRING).join(alarmMessage.getId0(), alarmMessage.getId1()));\n+        for (CompositeAlarmRule compositeAlarmRule : compositeAlarmRules) {\n+            String expr = compositeAlarmRule.getExpression();\n+            Set<String> dependencyRules = expression.analysisInputs(expr);\n+            Map<String, Object> dataContext = new HashMap<>();\n+            messageMap.asMap().forEach((key, alarmMessageList) -> {\n+                dependencyRules.forEach(ruleName -> dataContext.put(ruleName, false));\n+                alarmMessageList.forEach(alarmMessage -> {\n+                    if (dependencyRules.contains(alarmMessage.getRuleName())) {\n+                        dataContext.put(alarmMessage.getRuleName(), true);\n+                    }\n+                });\n+                Object matched = expression.eval(expr, dataContext);\n+                if (matched instanceof Boolean && (Boolean) matched) {\n+                    AlarmMessage headMsg = alarmMessageList.iterator().next();\n+                    AlarmMessage message = new AlarmMessage();\n+                    message.setOnlyAsCondition(false);\n+                    message.setScopeId(headMsg.getScopeId());\n+                    message.setScope(headMsg.getScope());\n+                    message.setName(headMsg.getName());\n+                    message.setId0(headMsg.getId0());\n+                    message.setId1(headMsg.getId1());\n+                    message.setStartTime(System.currentTimeMillis());\n+                    message.setRuleName(compositeAlarmRule.getAlarmRuleName());\n+                    String alarmMessage = formatMessage(message, compositeAlarmRule.getMessage());\n+                    message.setAlarmMessage(alarmMessage);\n+                    compositeRuleMessages.add(message);\n+                }\n+            });\n+        }\n+        return compositeRuleMessages;\n+    }\n+\n+    private String formatMessage(AlarmMessage alarmMessage, String message) {\n+        return messageFormatterCache.computeIfAbsent(message, AlarmMessageFormatter::new).format(new MetaInAlarm() {\n+            @Override\n+            public String getScope() {\n+                return null;\n+            }\n+\n+            @Override\n+            public int getScopeId() {\n+                return alarmMessage.getScopeId();\n+            }\n+\n+            @Override\n+            public String getName() {\n+                return alarmMessage.getName();\n+            }\n+\n+            @Override\n+            public String getMetricsName() {\n+                return null;", "originalCommit": "dca9216b6ce44a7e25802a0f554349d5db4c629c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzOTgzOA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499139838", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T11:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzMDQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzMDQzOQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499130439", "bodyText": "Comments for these methods.", "author": "wu-sheng", "createdAt": "2020-10-03T09:00:29Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/RulesReader.java", "diffHunk": "@@ -49,93 +50,136 @@ public Rules readRules() {\n         Rules rules = new Rules();\n \n         if (Objects.nonNull(yamlData)) {\n-            Map rulesData = (Map) yamlData.get(\"rules\");\n-            if (rulesData != null) {\n-                rules.setRules(new ArrayList<>());\n-                rulesData.forEach((k, v) -> {\n-                    if (((String) k).endsWith(\"_rule\")) {\n-                        AlarmRule alarmRule = new AlarmRule();\n-                        alarmRule.setAlarmRuleName((String) k);\n-                        Map settings = (Map) v;\n-                        Object metricsName = settings.get(\"metrics-name\");\n-                        if (metricsName == null) {\n-                            throw new IllegalArgumentException(\"metrics-name can't be null\");\n-                        }\n-\n-                        alarmRule.setMetricsName((String) metricsName);\n-                        alarmRule.setIncludeNames((ArrayList) settings.getOrDefault(\"include-names\", new ArrayList(0)));\n-                        alarmRule.setExcludeNames((ArrayList) settings.getOrDefault(\"exclude-names\", new ArrayList(0)));\n-                        alarmRule.setIncludeNamesRegex((String) settings.getOrDefault(\"include-names-regex\", \"\"));\n-                        alarmRule.setExcludeNamesRegex((String) settings.getOrDefault(\"exclude-names-regex\", \"\"));\n-                        alarmRule.setIncludeLabels(\n-                            (ArrayList) settings.getOrDefault(\"include-labels\", new ArrayList(0)));\n-                        alarmRule.setExcludeLabels(\n-                            (ArrayList) settings.getOrDefault(\"exclude-labels\", new ArrayList(0)));\n-                        alarmRule.setIncludeLabelsRegex((String) settings.getOrDefault(\"include-labels-regex\", \"\"));\n-                        alarmRule.setExcludeLabelsRegex((String) settings.getOrDefault(\"exclude-labels-regex\", \"\"));\n-                        alarmRule.setThreshold(settings.get(\"threshold\").toString());\n-                        alarmRule.setOp((String) settings.get(\"op\"));\n-                        alarmRule.setPeriod((Integer) settings.getOrDefault(\"period\", 1));\n-                        alarmRule.setCount((Integer) settings.getOrDefault(\"count\", 1));\n-                        // How many times of checks, the alarm keeps silence after alarm triggered, default as same as period.\n-                        alarmRule.setSilencePeriod((Integer) settings.getOrDefault(\"silence-period\", alarmRule.getPeriod()));\n-                        alarmRule.setMessage(\n-                            (String) settings.getOrDefault(\"message\", \"Alarm caused by Rule \" + alarmRule\n-                                .getAlarmRuleName()));\n+            readRulesConfig(rules);\n+            readWebHookConfig(rules);\n+            readGrpcConfig(rules);\n+            readSlackConfig(rules);\n+            readWechatConfig(rules);\n+            readCompositeRuleConfig(rules);", "originalCommit": "dca9216b6ce44a7e25802a0f554349d5db4c629c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzOTgzMg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499139832", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T11:26:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEzMDQzOQ=="}], "type": "inlineReview"}, {"oid": "ebeb288f3b65a33ea1f0c9c5057ba9229000dbd6", "url": "https://github.com/apache/skywalking/commit/ebeb288f3b65a33ea1f0c9c5057ba9229000dbd6", "message": "Add test case and comments", "committedDate": "2020-10-03T11:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0MjA3Mw==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499142073", "bodyText": "As logs said\n\nError:  Errors:\nError:    ExpressionTest.testCompile:75 \ufffd Compile [Error: [Error: was expecting type: ja...\n[INFO]\nError:  Tests run: 50, Failures: 0, Errors: 1, Skipped: 0\n\nSeems this would cause throwing exception. Please recheck.", "author": "wu-sheng", "createdAt": "2020-10-03T12:01:21Z", "path": "oap-server/server-alarm-plugin/src/test/java/org/apache/skywalking/oap/server/core/alarm/provider/expression/ExpressionTest.java", "diffHunk": "@@ -70,7 +70,7 @@ public void testEvalWithEmptyContext() {\n \n     @Test\n     public void testCompile() {\n-        String expr = \" a && b \";\n+        String expr = \" a && * b \";", "originalCommit": "ebeb288f3b65a33ea1f0c9c5057ba9229000dbd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0NjA4OA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499146088", "bodyText": "Sorry, fixed the test case", "author": "xbkaishui", "createdAt": "2020-10-03T13:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0MjA3Mw=="}], "type": "inlineReview"}, {"oid": "3b4d46781f91505c702a2e5fbb08b73f0d87e379", "url": "https://github.com/apache/skywalking/commit/3b4d46781f91505c702a2e5fbb08b73f0d87e379", "message": "Fix test case", "committedDate": "2020-10-03T13:00:47Z", "type": "commit"}, {"oid": "caa13c61893f70666c10e9f3465ba8403c676770", "url": "https://github.com/apache/skywalking/commit/caa13c61893f70666c10e9f3465ba8403c676770", "message": "Update docs/en/setup/backend/backend-alarm.md", "committedDate": "2020-10-03T13:34:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0ODgxOA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499148818", "bodyText": "Composite operation is not atomic, replace with ConcurrentHashMap#computeIfAbsent", "author": "kezhenxu94", "createdAt": "2020-10-03T13:40:27Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/expression/Expression.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider.expression;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.mvel2.MVEL;\n+import org.mvel2.ParserContext;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Expression support eval java basic expressions, just like groovy script\n+ * The internal detail is it first compile the expression to a pareTree then execute the parseTree with data\n+ * It caches the compiled expression for sake of performance\n+ */\n+@Slf4j\n+public class Expression {\n+    private Map<String, Object> expressionCache;\n+    private ExpressionContext context;\n+\n+    public Expression(ExpressionContext context) {\n+        this.context = context;\n+        this.expressionCache = new ConcurrentHashMap<>();\n+    }\n+\n+    /**\n+     * Eval the given expression using empty data context\n+     */\n+    public Object eval(String expression) {\n+        return eval(expression, null);\n+    }\n+\n+    /**\n+     * Eval the given expression with data context\n+     */\n+    public Object eval(String expression, Map<String, Object> vars) {\n+        try {\n+            Object obj = compile(expression, context);\n+            return MVEL.executeExpression(obj, vars);\n+        } catch (Throwable e) {\n+            log.error(\"eval expression {} error\", expression, e);\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Compile the given expression to a parseTree\n+     */\n+    public Object compile(String expression, ExpressionContext pctx) {\n+        Object o = expressionCache.get(expression);\n+        if (o == null) {\n+            o = MVEL.compileExpression(expression, pctx.getContext());\n+            expressionCache.put(expression, o);\n+        }\n+        return o;", "originalCommit": "caa13c61893f70666c10e9f3465ba8403c676770", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1MTAzNA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499151034", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T14:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1MTEyMg==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499151122", "bodyText": "I have a little doubt about this. What concurrency case makes us need atomic? @kezhenxu94", "author": "wu-sheng", "createdAt": "2020-10-03T14:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1MTM2MQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499151361", "bodyText": "@wu-sheng I didn't check the real case, but since @xbkaishui he is using ConcurrentHashMap (so I assume that there is concurrency), if there is no such case, a simple HashMap is enough", "author": "kezhenxu94", "createdAt": "2020-10-03T14:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1MjYxOA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499152618", "bodyText": "OK, let's keep the ConcurrentHashMap, as it doesn't cost much. From my understanding, there is no concurrency or race condition.\nAnyway, no big issue.", "author": "wu-sheng", "createdAt": "2020-10-03T14:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0ODgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0OTAzMQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499149031", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The internal detail is it first compile the expression to a pareTree then execute the parseTree with data\n          \n          \n            \n             * The internal detail is it first compile the expression to a parseTree then execute the parseTree with data", "author": "kezhenxu94", "createdAt": "2020-10-03T13:43:36Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/expression/Expression.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider.expression;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.mvel2.MVEL;\n+import org.mvel2.ParserContext;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Expression support eval java basic expressions, just like groovy script\n+ * The internal detail is it first compile the expression to a pareTree then execute the parseTree with data", "originalCommit": "caa13c61893f70666c10e9f3465ba8403c676770", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1MTAyOQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499151029", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T14:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0OTAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0OTA1OQ==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499149059", "bodyText": "Can be final", "author": "kezhenxu94", "createdAt": "2020-10-03T13:43:58Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/expression/Expression.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider.expression;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.mvel2.MVEL;\n+import org.mvel2.ParserContext;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Expression support eval java basic expressions, just like groovy script\n+ * The internal detail is it first compile the expression to a pareTree then execute the parseTree with data\n+ * It caches the compiled expression for sake of performance\n+ */\n+@Slf4j\n+public class Expression {\n+    private Map<String, Object> expressionCache;\n+    private ExpressionContext context;", "originalCommit": "caa13c61893f70666c10e9f3465ba8403c676770", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1MTA2MA==", "url": "https://github.com/apache/skywalking/pull/5615#discussion_r499151060", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-03T14:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0OTA1OQ=="}], "type": "inlineReview"}, {"oid": "ec375e27e1a9d596849ea56ff7dad16aac830fbf", "url": "https://github.com/apache/skywalking/commit/ec375e27e1a9d596849ea56ff7dad16aac830fbf", "message": "Refactor", "committedDate": "2020-10-03T14:10:01Z", "type": "commit"}]}