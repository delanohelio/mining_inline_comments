{"pr_number": 5304, "pr_title": "Support @KafkaPollAndInvoke annotation to replace @Trace when just using the Kafka scenario agent plugin", "pr_createdAt": "2020-08-12T10:16:19Z", "pr_url": "https://github.com/apache/skywalking/pull/5304", "timeline": [{"oid": "25f821c38c4a62e43a29c279db50851bb90f47c0", "url": "https://github.com/apache/skywalking/commit/25f821c38c4a62e43a29c279db50851bb90f47c0", "message": "1", "committedDate": "2020-08-12T09:10:01Z", "type": "commit"}, {"oid": "9a0a67d8544ece01dab196d156e2bef6d0807b5d", "url": "https://github.com/apache/skywalking/commit/9a0a67d8544ece01dab196d156e2bef6d0807b5d", "message": "fix", "committedDate": "2020-08-12T10:12:47Z", "type": "commit"}, {"oid": "5fff6e95bf1ad3040e60023940f48165770b1fc1", "url": "https://github.com/apache/skywalking/commit/5fff6e95bf1ad3040e60023940f48165770b1fc1", "message": "Merge branch 'master' into zhaoyuguang_0111", "committedDate": "2020-08-12T10:26:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4NjMyNA==", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469186324", "bodyText": "No Context Carrier?", "author": "wu-sheng", "createdAt": "2020-08-12T11:20:23Z", "path": "apm-sniffer/apm-sdk-plugin/kafka-plugin/src/main/java/org/apache/skywalking/apm/plugin/kafka/KafkaConsumerInterceptor.java", "diffHunk": "@@ -66,9 +66,10 @@ public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allA\n         //\n         if (records.size() > 0) {\n             ConsumerEnhanceRequiredInfo requiredInfo = (ConsumerEnhanceRequiredInfo) objInst.getSkyWalkingDynamicField();\n-            if (ContextManager.getRuntimeContext().get(Constants.SPRING_KAFKA_FLAG) != null) {\n-                ContextManager.createEntrySpan(Constants.SPRING_KAFKA_POLL_AND_INVOKE_OPERATION_NAME, null);\n-                ((SpringKafkaContext) ContextManager.getRuntimeContext().get(Constants.SPRING_KAFKA_FLAG)).setNeedStop(true);\n+            KafkaContext context = (KafkaContext) ContextManager.getRuntimeContext().get(Constants.KAFKA_FLAG);\n+            if (context != null) {\n+                ContextManager.createEntrySpan(context.getOperationName(), null);", "originalCommit": "5fff6e95bf1ad3040e60023940f48165770b1fc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY0NzU0Mg==", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469647542", "bodyText": "yes", "author": "zhaoyuguang", "createdAt": "2020-08-13T01:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4NjMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE5MTE2NA==", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469191164", "bodyText": "I rechecked the codes, this seems not necessary. You always needStop=false. Could we consider to remove it?", "author": "wu-sheng", "createdAt": "2020-08-12T11:30:38Z", "path": "apm-sniffer/apm-sdk-plugin/kafka-commons/src/main/java/org/apache/skywalking/apm/plugin/kafka/define/KafkaContext.java", "diffHunk": "@@ -19,19 +19,30 @@\n \n package org.apache.skywalking.apm.plugin.kafka.define;\n \n-public class SpringKafkaContext {\n+public class KafkaContext {\n \n-    public SpringKafkaContext() {\n+    public KafkaContext(String operationName) {\n         needStop = false;\n+        this.operationName = operationName;\n     }\n \n     private boolean needStop;", "originalCommit": "5fff6e95bf1ad3040e60023940f48165770b1fc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY0NzUyNA==", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469647524", "bodyText": "fixed", "author": "zhaoyuguang", "createdAt": "2020-08-13T01:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE5MTE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIwOTM0Mw==", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469209343", "bodyText": "Are you forcing to create 2 consumer methods?", "author": "wu-sheng", "createdAt": "2020-08-12T12:08:44Z", "path": "test/plugin/scenarios/kafka-scenario/src/main/java/test/org/apache/skywalking/apm/testcase/kafka/controller/CaseController.java", "diffHunk": "@@ -223,29 +235,33 @@ public void run() {\n             consumerProperties.put(\"value.deserializer\", \"org.apache.kafka.common.serialization.StringDeserializer\");\n             KafkaConsumer<String, String> consumer = new KafkaConsumer<>(consumerProperties);\n             consumer.subscribe(topicPattern, new NoOpConsumerRebalanceListener());\n-            int i = 0;\n-            while (i++ <= 10) {\n-                try {\n-                    Thread.sleep(1 * 1000);\n-                } catch (InterruptedException e) {\n-                }\n+            while (true) {\n+                if (pollAndInvoke(consumer)) break;\n+            }\n+            consumer.close();\n+        }\n \n-                ConsumerRecords<String, String> records = consumer.poll(100);\n+        @KafkaPollAndInvoke\n+        private boolean pollAndInvoke(KafkaConsumer<String, String> consumer) {", "originalCommit": "5fff6e95bf1ad3040e60023940f48165770b1fc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY0NzQ5Mg==", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469647492", "bodyText": "yes", "author": "zhaoyuguang", "createdAt": "2020-08-13T01:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIwOTM0Mw=="}], "type": "inlineReview"}, {"oid": "25879b08ffd731e0978f8e2fc5086c2ba2fcf807", "url": "https://github.com/apache/skywalking/commit/25879b08ffd731e0978f8e2fc5086c2ba2fcf807", "message": "fixed", "committedDate": "2020-08-13T01:39:00Z", "type": "commit"}, {"oid": "05839c6b10826e79b7279e7a3870162fe5fe0b31", "url": "https://github.com/apache/skywalking/commit/05839c6b10826e79b7279e7a3870162fe5fe0b31", "message": "Merge branch 'zhaoyuguang_0111' of https://github.com/zhaoyuguang/incubator-skywalking into zhaoyuguang_0111", "committedDate": "2020-08-13T01:39:11Z", "type": "commit"}, {"oid": "4327b47569ccad52cb649514003f66443bba226a", "url": "https://github.com/apache/skywalking/commit/4327b47569ccad52cb649514003f66443bba226a", "message": "Merge branch 'master' into zhaoyuguang_0111", "committedDate": "2020-08-13T03:48:50Z", "type": "commit"}, {"oid": "7978950f55ff1c77069f2554c435e6ea6373eba1", "url": "https://github.com/apache/skywalking/commit/7978950f55ff1c77069f2554c435e6ea6373eba1", "message": "fixed", "committedDate": "2020-08-13T08:24:35Z", "type": "commit"}, {"oid": "93c8d2fbef33806f86c901675c097d2ee04b90e7", "url": "https://github.com/apache/skywalking/commit/93c8d2fbef33806f86c901675c097d2ee04b90e7", "message": "Merge branch 'master' into zhaoyuguang_0111", "committedDate": "2020-08-13T08:25:10Z", "type": "commit"}]}