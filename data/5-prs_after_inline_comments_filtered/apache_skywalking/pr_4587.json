{"pr_number": 4587, "pr_title": "OAP Core polish, especially storage level", "pr_createdAt": "2020-03-29T02:01:19Z", "pr_url": "https://github.com/apache/skywalking/pull/4587", "timeline": [{"oid": "4798983c4f73e6d52b5a6f85a353c8b1776363c9", "url": "https://github.com/apache/skywalking/commit/4798983c4f73e6d52b5a6f85a353c8b1776363c9", "message": "1. Add length definition with reasonable default value.\n2. Merge H2 and MySQL columntype mapping back to consistent.", "committedDate": "2020-03-29T01:58:07Z", "type": "commit"}, {"oid": "8d7a94481ee2350ba6392e5bc2234228341cc77a", "url": "https://github.com/apache/skywalking/commit/8d7a94481ee2350ba6392e5bc2234228341cc77a", "message": "Fix code style.", "committedDate": "2020-03-29T02:08:27Z", "type": "commit"}, {"oid": "db4afc9c6d088cc570cc01b37c694f1a8a395dfa", "url": "https://github.com/apache/skywalking/commit/db4afc9c6d088cc570cc01b37c694f1a8a395dfa", "message": "Fix bootstrap issue.", "committedDate": "2020-03-29T03:00:55Z", "type": "commit"}, {"oid": "90a381393f6b547c797a43283f909ca97d02b505", "url": "https://github.com/apache/skywalking/commit/90a381393f6b547c797a43283f909ca97d02b505", "message": "Remove @IDColumn, we are using object#equals now.", "committedDate": "2020-03-29T03:34:21Z", "type": "commit"}, {"oid": "943f3e4577d41f53c103a70b1391bc329284abac", "url": "https://github.com/apache/skywalking/commit/943f3e4577d41f53c103a70b1391bc329284abac", "message": "1. Support @QueryUnifiedIndex.\n2. Refactor the MySQL and H2 installers to use @Column and @QueryUnifiedIndex definitions.", "committedDate": "2020-03-29T07:58:22Z", "type": "commit"}, {"oid": "84b48db51e8b44c33a5a25d5436f7b0402fef4d7", "url": "https://github.com/apache/skywalking/commit/84b48db51e8b44c33a5a25d5436f7b0402fef4d7", "message": "Fix index name too long. Remove the old index naming rule.", "committedDate": "2020-03-29T08:36:47Z", "type": "commit"}, {"oid": "c44975e11923ed2c8d4b3024d621cca6c1af91d1", "url": "https://github.com/apache/skywalking/commit/c44975e11923ed2c8d4b3024d621cca6c1af91d1", "message": "Fix issues.", "committedDate": "2020-03-29T10:04:12Z", "type": "commit"}, {"oid": "a60c7d44592d8be801e24e33ddcbe5815201e8c6", "url": "https://github.com/apache/skywalking/commit/a60c7d44592d8be801e24e33ddcbe5815201e8c6", "message": "Update H2TableInstaller.java\n\nFix a wrong deletion.", "committedDate": "2020-03-29T11:11:34Z", "type": "commit"}, {"oid": "ab811837e6a570cef01190daded3e96fc25d1505", "url": "https://github.com/apache/skywalking/commit/ab811837e6a570cef01190daded3e96fc25d1505", "message": "Rename StorageDataType to StorageDataComplexObject", "committedDate": "2020-03-29T13:02:57Z", "type": "commit"}, {"oid": "5dc3f2413b5e145f36e5607c1573154aea4b3bfb", "url": "https://github.com/apache/skywalking/commit/5dc3f2413b5e145f36e5607c1573154aea4b3bfb", "message": "Support @MetricsExtension and insertOnly in the MetricsPersistentWorker worker.", "committedDate": "2020-03-29T15:10:13Z", "type": "commit"}, {"oid": "7bfaa8e9c0ab0d140d7ff8ed95e08d6241c1043d", "url": "https://github.com/apache/skywalking/commit/7bfaa8e9c0ab0d140d7ff8ed95e08d6241c1043d", "message": "Fix bootstrap NPE issue.", "committedDate": "2020-03-29T15:38:39Z", "type": "commit"}, {"oid": "254c3e10b879138b00438924a40ef3206c4f166a", "url": "https://github.com/apache/skywalking/commit/254c3e10b879138b00438924a40ef3206c4f166a", "message": "Fix MetricsExtension#insertOnly bug and optimize MetricsStreamProcessor", "committedDate": "2020-03-30T01:57:26Z", "type": "commit"}, {"oid": "c81fe4873743b0f8ad1383ec5846222134214bf8", "url": "https://github.com/apache/skywalking/commit/c81fe4873743b0f8ad1383ec5846222134214bf8", "message": "Fix code style.", "committedDate": "2020-03-30T02:05:48Z", "type": "commit"}, {"oid": "4f0eeb8a61e1316e2fa7031a984a4372e41d4cac", "url": "https://github.com/apache/skywalking/commit/4f0eeb8a61e1316e2fa7031a984a4372e41d4cac", "message": "Remove unnecessary comment, the endpoint_traffic has no duplicated record anymore.", "committedDate": "2020-03-30T02:43:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNjc5Mg==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399906792", "bodyText": "Why blank lines here?", "author": "hanahmily", "createdAt": "2020-03-30T03:18:05Z", "path": "oap-server/oal-rt/src/main/java/org/apache/skywalking/oal/rt/OALRuntime.java", "diffHunk": "@@ -377,10 +376,19 @@ private Class generateDispatcherClass(String scopeName,\n              */\n             String sourceClassName = SOURCE_PACKAGE + dispatcherContext.getSource();\n             SignatureAttribute.ClassSignature dispatcherSignature = new SignatureAttribute.ClassSignature(null, null,\n-                // Set interface and its generic params\n-                new SignatureAttribute.ClassType[] {\n-                    new SignatureAttribute.ClassType(SourceDispatcher.class.getCanonicalName(), new SignatureAttribute.TypeArgument[] {new SignatureAttribute.TypeArgument(new SignatureAttribute.ClassType(sourceClassName))})\n-                });\n+                                                                                                          // Set interface and its generic params\n+                                                                                                          new SignatureAttribute.ClassType[] {\n+                                                                                                              new SignatureAttribute.ClassType(\n+                                                                                                                  SourceDispatcher.class\n+                                                                                                                      .getCanonicalName(),\n+                                                                                                                  new SignatureAttribute.TypeArgument[] {\n+                                                                                                                      new SignatureAttribute.TypeArgument(\n+                                                                                                                          new SignatureAttribute.ClassType(\n+                                                                                                                              sourceClassName))\n+                                                                                                                  }\n+                                                                                                              )\n+                                                                                                          }", "originalCommit": "c81fe4873743b0f8ad1383ec5846222134214bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNzA3MQ==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399907071", "bodyText": "These are not blank :) Scroll to the right.", "author": "wu-sheng", "createdAt": "2020-03-30T03:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNjc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNzIwOA==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399907208", "bodyText": "I could reformat it manually a little.", "author": "wu-sheng", "createdAt": "2020-03-30T03:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNjc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwODc1OQ==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399908759", "bodyText": "Updated, should be better now.", "author": "wu-sheng", "createdAt": "2020-03-30T03:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNjc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwOTYzNQ==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399909635", "bodyText": "LTGM", "author": "hanahmily", "createdAt": "2020-03-30T03:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNjc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNzM2Mw==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399907363", "bodyText": "We should name it to supportUpdate or change the comment description. They are not identical.", "author": "hanahmily", "createdAt": "2020-03-30T03:20:46Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/MetricsExtension.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+import org.apache.skywalking.oap.server.core.analysis.worker.MetricsStreamProcessor;\n+\n+/**\n+ * MetricsExtension annotation defines extension attributes of the {@link Stream} with {@link MetricsStreamProcessor}.\n+ */\n+@Target(ElementType.TYPE)\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface MetricsExtension {\n+    /**\n+     * @return true if this metrics stream support down sampling.\n+     */\n+    boolean supportDownSampling();\n+\n+    /**\n+     * @return true if this metrics doesn't support update.\n+     */\n+    boolean insertOnly();", "originalCommit": "c81fe4873743b0f8ad1383ec5846222134214bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwODY4Nw==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399908687", "bodyText": "Rename insertOnly to supportUpdate. EndpointTraffic has wrong definition before.", "author": "wu-sheng", "createdAt": "2020-03-30T03:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNzM2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwOTcxNw==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399909717", "bodyText": "\ud83d\udc4d", "author": "hanahmily", "createdAt": "2020-03-30T03:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwNzM2Mw=="}], "type": "inlineReview"}, {"oid": "a64395d8c9cc55f957cc9990be45372ef7d95ee6", "url": "https://github.com/apache/skywalking/commit/a64395d8c9cc55f957cc9990be45372ef7d95ee6", "message": "Rename insertOnly to supportUpdate. EndpointTraffic has wrong definition before.", "committedDate": "2020-03-30T03:26:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwODU3OA==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399908578", "bodyText": "I suggest the storageOnly default is true in the Column annotation? Because I think most of the columns are just for storage.", "author": "mrproliu", "createdAt": "2020-03-30T03:26:51Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/annotation/Column.java", "diffHunk": "@@ -55,5 +55,12 @@\n     /**\n      * The column is just saved, never used in query.\n      */\n-    boolean content() default false;\n+    boolean storageOnly() default false;", "originalCommit": "4f0eeb8a61e1316e2fa7031a984a4372e41d4cac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwOTI3Nw==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399909277", "bodyText": "No, you can't. There are countless places in the codes, including the OAL generated codes. If you use this, we are facing more changes.\nIn your case, that will be impossible to review this PR.", "author": "wu-sheng", "createdAt": "2020-03-30T03:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwODU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwOTA4NQ==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399909085", "bodyText": "We can simplify them with System.arraycopy", "author": "hanahmily", "createdAt": "2020-03-30T03:29:07Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/model/ExtraQueryIndex.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.storage.model;\n+\n+import lombok.Getter;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+\n+/**\n+ * The extra query index if the storage could support this mode. Many NO-SQL support one column index only, in that\n+ * case, this could be ignored in the implementation level.\n+ */\n+@Getter\n+public class ExtraQueryIndex {\n+    private String[] columns;\n+\n+    public ExtraQueryIndex(String mainColumn, final String[] withColumns) {\n+        if (CollectionUtils.isNotEmpty(withColumns)) {\n+            this.columns = new String[withColumns.length + 1];\n+            for (int i = 0; i < columns.length; i++) {\n+                if (i == 0) {\n+                    columns[i] = mainColumn;\n+                } else {\n+                    columns[i] = withColumns[i - 1];\n+                }\n+            }", "originalCommit": "c81fe4873743b0f8ad1383ec5846222134214bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk1NDc2OQ==", "url": "https://github.com/apache/skywalking/pull/4587#discussion_r399954769", "bodyText": "Yes, adopted this method.", "author": "wu-sheng", "createdAt": "2020-03-30T06:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTkwOTA4NQ=="}], "type": "inlineReview"}, {"oid": "66acbcacf145d9e4e2bb99a0c182c6ffcd89cf14", "url": "https://github.com/apache/skywalking/commit/66acbcacf145d9e4e2bb99a0c182c6ffcd89cf14", "message": "Adopt System.arraycopy.", "committedDate": "2020-03-30T06:31:12Z", "type": "commit"}, {"oid": "a168c4f03a551287569b6e957010e19e530f8043", "url": "https://github.com/apache/skywalking/commit/a168c4f03a551287569b6e957010e19e530f8043", "message": "Merge branch 'master' into core-refactor", "committedDate": "2020-03-30T06:53:10Z", "type": "commit"}, {"oid": "c14d019adb2dcf6bf816ca91de61a7af98a2f724", "url": "https://github.com/apache/skywalking/commit/c14d019adb2dcf6bf816ca91de61a7af98a2f724", "message": "Some trivial polishes", "committedDate": "2020-03-30T09:05:04Z", "type": "commit"}]}