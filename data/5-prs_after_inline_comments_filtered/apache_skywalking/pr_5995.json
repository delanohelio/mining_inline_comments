{"pr_number": 5995, "pr_title": "Fix potential gRPC connection leak(not closed) for the channels among OAP instances. ", "pr_createdAt": "2020-12-12T01:51:28Z", "pr_url": "https://github.com/apache/skywalking/pull/5995", "timeline": [{"oid": "c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac", "url": "https://github.com/apache/skywalking/commit/c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac", "message": "Fix potential gRPC connection leak(not closed) for the channels among OAP instances.", "committedDate": "2020-12-12T01:47:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NzU1Mw==", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541477553", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                          && !remoteClientAction.getRemoteClient().getAddress().isSelf()\n          \n          \n            \n                                                          && \n          \n          \n            \n            remoteClientAction.getRemoteClient() != null\n          \n          \n            \n                                                          &&                                           !remoteClientAction.getRemoteClient().getAddress().isSelf()", "author": "hanahmily", "createdAt": "2020-12-12T02:16:00Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/remote/client/RemoteClientManager.java", "diffHunk": "@@ -230,7 +246,10 @@ private void reBuildRemoteClients(List<RemoteInstance> remoteInstances) {\n \n         remoteClientCollection.values()\n                               .stream()\n-                              .filter(remoteClientAction -> remoteClientAction.getAction().equals(Action.Close))\n+                              .filter(remoteClientAction ->\n+                                          remoteClientAction.getAction().equals(Action.Close)\n+                                              && !remoteClientAction.getRemoteClient().getAddress().isSelf()", "originalCommit": "c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ4MDk0OA==", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541480948", "bodyText": "This would not be null. I enhanced another by following Filter OAP instances(unassigned in booting stage) of the empty IP in KubernetesCoordinator.", "author": "wu-sheng", "createdAt": "2020-12-12T02:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NzU1Mw=="}], "type": "inlineReview"}, {"oid": "34870014eb3facb09954da00490b1ff3291867d7", "url": "https://github.com/apache/skywalking/commit/34870014eb3facb09954da00490b1ff3291867d7", "message": "Filter OAP instances(unassigned in booting stage) of the empty IP in KubernetesCoordinator.", "committedDate": "2020-12-12T02:36:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ4ODg0NQ==", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541488845", "bodyText": "NULL_DEREFERENCE:  object returned by pod.getStatus() could be null and is dereferenced at line 78.", "author": "sonatype-lift", "createdAt": "2020-12-12T03:26:12Z", "path": "oap-server/server-cluster-plugin/cluster-kubernetes-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/kubernetes/KubernetesCoordinator.java", "diffHunk": "@@ -66,23 +65,25 @@ public KubernetesCoordinator(final ModuleDefineHolder manager,\n             List<V1Pod> pods = NamespacedPodListInformer.INFORMER.listPods().orElseGet(this::selfPod);\n             if (log.isDebugEnabled()) {\n                 List<String> uidList = pods\n-                        .stream()\n-                        .map(item -> item.getMetadata().getUid())\n-                        .collect(Collectors.toList());\n+                    .stream()\n+                    .map(item -> item.getMetadata().getUid())\n+                    .collect(Collectors.toList());\n                 log.debug(\"[kubernetes cluster pods uid list]:{}\", uidList.toString());\n             }\n             if (port == -1) {\n                 port = manager.find(CoreModule.NAME).provider().getService(ConfigService.class).getGRPCPort();\n             }\n-            List<RemoteInstance> remoteInstances =  pods.stream()\n+            List<RemoteInstance> remoteInstances =\n+                pods.stream()\n+                    .filter(pod -> StringUtil.isNotBlank(pod.getStatus().getPodIP()))", "originalCommit": "34870014eb3facb09954da00490b1ff3291867d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ4ODg0OA==", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541488848", "bodyText": "NULL_DEREFERENCE:  object returned by pod.getStatus() could be null and is dereferenced at line 80.", "author": "sonatype-lift", "createdAt": "2020-12-12T03:26:13Z", "path": "oap-server/server-cluster-plugin/cluster-kubernetes-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/kubernetes/KubernetesCoordinator.java", "diffHunk": "@@ -66,23 +65,25 @@ public KubernetesCoordinator(final ModuleDefineHolder manager,\n             List<V1Pod> pods = NamespacedPodListInformer.INFORMER.listPods().orElseGet(this::selfPod);\n             if (log.isDebugEnabled()) {\n                 List<String> uidList = pods\n-                        .stream()\n-                        .map(item -> item.getMetadata().getUid())\n-                        .collect(Collectors.toList());\n+                    .stream()\n+                    .map(item -> item.getMetadata().getUid())\n+                    .collect(Collectors.toList());\n                 log.debug(\"[kubernetes cluster pods uid list]:{}\", uidList.toString());\n             }\n             if (port == -1) {\n                 port = manager.find(CoreModule.NAME).provider().getService(ConfigService.class).getGRPCPort();\n             }\n-            List<RemoteInstance> remoteInstances =  pods.stream()\n+            List<RemoteInstance> remoteInstances =\n+                pods.stream()\n+                    .filter(pod -> StringUtil.isNotBlank(pod.getStatus().getPodIP()))\n                     .map(pod -> new RemoteInstance(\n-                            new Address(pod.getStatus().getPodIP(), port, pod.getMetadata().getUid().equals(uid))))\n+                        new Address(pod.getStatus().getPodIP(), port, pod.getMetadata().getUid().equals(uid))))", "originalCommit": "34870014eb3facb09954da00490b1ff3291867d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}