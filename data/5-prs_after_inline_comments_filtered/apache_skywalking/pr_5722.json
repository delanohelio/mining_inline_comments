{"pr_number": 5722, "pr_title": "Improve Kubernetes service registry for ALS analysis", "pr_createdAt": "2020-10-25T07:09:27Z", "pr_url": "https://github.com/apache/skywalking/pull/5722", "timeline": [{"oid": "a2d90adbb383ad2916df0441d25ab0187b20d739", "url": "https://github.com/apache/skywalking/commit/a2d90adbb383ad2916df0441d25ab0187b20d739", "message": "Improve K8S ALS analysis\n\nThe current implementation of envoy ALS K8S analysis is based on the hierarchy, pod -> StatefulSet -> deployment, StatefulSet, or others. It's freaky and different from the Istio Kubernetes registry.\n\nThe new path is pod -> endpoint -> service, and we should leverage Informer API instead of raw Kubernetes API.", "committedDate": "2020-10-25T15:53:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxMzUxNg==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r511913516", "bodyText": "We had better introduce a service name rule to format it. For instance, if some users want to append a version to the service name, they have to issue an expression, like ${service.name}-${pod.labels.version}\nIf they deploy bookinfo, the service name of the service productpage might be productpage-v1, producatpage-v2 and etc.", "author": "hanahmily", "createdAt": "2020-10-26T12:12:07Z", "path": "oap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/als/K8SServiceRegistry.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.envoy.als;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import io.kubernetes.client.informer.ResourceEventHandler;\n+import io.kubernetes.client.informer.SharedInformerFactory;\n+import io.kubernetes.client.openapi.ApiClient;\n+import io.kubernetes.client.openapi.apis.CoreV1Api;\n+import io.kubernetes.client.openapi.models.V1Endpoints;\n+import io.kubernetes.client.openapi.models.V1EndpointsList;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1PodList;\n+import io.kubernetes.client.util.Config;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import static java.util.Objects.isNull;\n+import static java.util.Objects.requireNonNull;\n+\n+@Slf4j\n+class K8SServiceRegistry {\n+    final Map<String, ServiceMetaInfo> ipServiceMap;\n+\n+    final ExecutorService executor;\n+\n+    K8SServiceRegistry() {\n+        ipServiceMap = new ConcurrentHashMap<>();\n+        executor = Executors.newCachedThreadPool(\n+            new ThreadFactoryBuilder()\n+                .setNameFormat(\"K8SServiceRegistry-%d\")\n+                .setDaemon(true)\n+                .build()\n+        );\n+    }\n+\n+    void start() throws IOException {\n+        final ApiClient apiClient = Config.defaultClient();\n+        apiClient.setHttpClient(apiClient.getHttpClient()\n+                                         .newBuilder()\n+                                         .readTimeout(0, TimeUnit.SECONDS)\n+                                         .build());\n+\n+        final CoreV1Api coreV1Api = new CoreV1Api(apiClient);\n+        final SharedInformerFactory factory = new SharedInformerFactory(executor);\n+\n+        listenEndpointsEvents(coreV1Api, factory);\n+        listenPodEvents(coreV1Api, factory);\n+\n+        factory.startAllRegisteredInformers();\n+    }\n+\n+    private void listenEndpointsEvents(final CoreV1Api coreV1Api, final SharedInformerFactory factory) {\n+        factory.sharedIndexInformerFor(\n+            params -> coreV1Api.listEndpointsForAllNamespacesCall(\n+                null,\n+                null,\n+                null,\n+                null,\n+                null,\n+                null,\n+                params.resourceVersion,\n+                params.timeoutSeconds,\n+                params.watch,\n+                null\n+            ),\n+            V1Endpoints.class,\n+            V1EndpointsList.class\n+        ).addEventHandler(new ResourceEventHandler<V1Endpoints>() {\n+            @Override\n+            public void onAdd(final V1Endpoints endpoints) {\n+                addEndpoints(endpoints);\n+            }\n+\n+            @Override\n+            public void onUpdate(final V1Endpoints oldEndpoints, final V1Endpoints newEndpoints) {\n+                addEndpoints(newEndpoints);\n+            }\n+\n+            @Override\n+            public void onDelete(final V1Endpoints endpoints, final boolean deletedFinalStateUnknown) {\n+                removeEndpoints(endpoints);\n+            }\n+        });\n+    }\n+\n+    private void listenPodEvents(final CoreV1Api coreV1Api, final SharedInformerFactory factory) {\n+        factory.sharedIndexInformerFor(\n+            params -> coreV1Api.listPodForAllNamespacesCall(\n+                null,\n+                null,\n+                null,\n+                null,\n+                null,\n+                null,\n+                params.resourceVersion,\n+                params.timeoutSeconds,\n+                params.watch,\n+                null\n+            ),\n+            V1Pod.class,\n+            V1PodList.class\n+        ).addEventHandler(new ResourceEventHandler<V1Pod>() {\n+            @Override\n+            public void onAdd(final V1Pod pod) {\n+                addPod(pod);\n+            }\n+\n+            @Override\n+            public void onUpdate(final V1Pod oldPod, final V1Pod newPod) {\n+                addPod(newPod);\n+            }\n+\n+            @Override\n+            public void onDelete(final V1Pod pod, final boolean deletedFinalStateUnknown) {\n+                removePod(pod);\n+            }\n+        });\n+    }\n+\n+    private void removePod(final V1Pod pod) {\n+        log.debug(\"Removing pod {}\", pod);\n+\n+        Optional.ofNullable(pod.getStatus()).ifPresent(\n+            status -> ipServiceMap.remove(status.getPodIP())\n+        );\n+    }\n+\n+    private void addPod(final V1Pod pod) {\n+        log.debug(\"Adding pod {}\", pod);\n+\n+        Optional.ofNullable(pod.getStatus()).ifPresent(\n+            status -> {\n+                final String ip = status.getPodIP();\n+                final ServiceMetaInfo service = ipServiceMap.computeIfAbsent(ip, unused -> new ServiceMetaInfo());\n+\n+                final V1ObjectMeta podMeta = requireNonNull(pod.getMetadata());\n+                service.setServiceInstanceName(String.format(\"%s.%s\", podMeta.getName(), podMeta.getNamespace()));\n+                service.setTags(transformLabelsToTags(podMeta.getLabels()));\n+            }\n+        );\n+    }\n+\n+    private void addEndpoints(final V1Endpoints endpoints) {\n+        log.debug(\"Adding endpoints {}\", endpoints);\n+\n+        final String serviceName = requireNonNull(endpoints.getMetadata()).getName();", "originalCommit": "aeaa737115a085280a25ab9acb24cc351a16f48e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNTc4NA==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r511925784", "bodyText": "I think the key is providing the format expression. Defaut should be only service name with version, correct?", "author": "wu-sheng", "createdAt": "2020-10-26T12:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxMzUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzExOTg5OQ==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r513119899", "bodyText": "Done", "author": "kezhenxu94", "createdAt": "2020-10-28T01:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxMzUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r511915125", "bodyText": "Endpoint slice resources should be listened to either.", "author": "hanahmily", "createdAt": "2020-10-26T12:15:07Z", "path": "oap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/als/K8SServiceRegistry.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.envoy.als;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import io.kubernetes.client.informer.ResourceEventHandler;\n+import io.kubernetes.client.informer.SharedInformerFactory;\n+import io.kubernetes.client.openapi.ApiClient;\n+import io.kubernetes.client.openapi.apis.CoreV1Api;\n+import io.kubernetes.client.openapi.models.V1Endpoints;\n+import io.kubernetes.client.openapi.models.V1EndpointsList;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1PodList;\n+import io.kubernetes.client.util.Config;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import static java.util.Objects.isNull;\n+import static java.util.Objects.requireNonNull;\n+\n+@Slf4j\n+class K8SServiceRegistry {\n+    final Map<String, ServiceMetaInfo> ipServiceMap;\n+\n+    final ExecutorService executor;\n+\n+    K8SServiceRegistry() {\n+        ipServiceMap = new ConcurrentHashMap<>();\n+        executor = Executors.newCachedThreadPool(\n+            new ThreadFactoryBuilder()\n+                .setNameFormat(\"K8SServiceRegistry-%d\")\n+                .setDaemon(true)\n+                .build()\n+        );\n+    }\n+\n+    void start() throws IOException {\n+        final ApiClient apiClient = Config.defaultClient();\n+        apiClient.setHttpClient(apiClient.getHttpClient()\n+                                         .newBuilder()\n+                                         .readTimeout(0, TimeUnit.SECONDS)\n+                                         .build());\n+\n+        final CoreV1Api coreV1Api = new CoreV1Api(apiClient);\n+        final SharedInformerFactory factory = new SharedInformerFactory(executor);\n+\n+        listenEndpointsEvents(coreV1Api, factory);", "originalCommit": "aeaa737115a085280a25ab9acb24cc351a16f48e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwMTUwMQ==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r512401501", "bodyText": "@hanahmily even the latest kubernetes-client(10.0.0, 27th, Oct, 2020) doesn't support to listen to the EndpointSlice events. There is no such API to do this \ud83d\ude22 Let's postponed this resource until the newer version can do this.", "author": "kezhenxu94", "createdAt": "2020-10-27T03:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5Nzk1NQ==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r512697955", "bodyText": "If no listener, are you reading the data periodically like the old way?", "author": "wu-sheng", "createdAt": "2020-10-27T13:38:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcyMDA5Ng==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r512720096", "bodyText": "If no listener, are you reading the data periodically like the old way?\n\nNot now, as the doc says, EndpointSlice is to improve the performance of Endpoints, so I think it's OK to just ignore this kind of event for now, (p.s. EndpointSlice is still in beta now), is it OK @hanahmily ?", "author": "kezhenxu94", "createdAt": "2020-10-27T14:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIwMjE1OA==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r513202158", "bodyText": "If java client doesn't support it right now, feel free to leave it alone. But we should mention it in our document and leave todo market in codes.", "author": "hanahmily", "createdAt": "2020-10-28T06:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIwMjk2NA==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r513202964", "bodyText": "How about submitting a request to k8s java client repo about listen to the EndpointSlice ?", "author": "wu-sheng", "createdAt": "2020-10-28T06:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIwMzEzNw==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r513203137", "bodyText": "They may need a scenario about which java codes need this.", "author": "wu-sheng", "createdAt": "2020-10-28T06:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE0OTkxMQ==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r514149911", "bodyText": "How about submitting a request to k8s java client repo about listen to the EndpointSlice ?\n\nI'm thinking that they don't support it only because EndpointSlice is still in beta(after stabilization, they will), and the methods to list/watch that resources are unstable now, (e.g. need the apiGroup, version, which are changing for an alpha/beta feature).\nIMO, ignoring EndpointSlice for now is safe because the docs says\n\nAlthough the EndpointSlice API is providing a newer and more scalable alternative to the Endpoints API, the Endpoints API will continue to be considered generally available and stable.", "author": "kezhenxu94", "createdAt": "2020-10-29T10:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1MDQ0Nw==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r514150447", "bodyText": "We can revamp this after the EndpointSlice API is stabilised", "author": "kezhenxu94", "createdAt": "2020-10-29T10:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1MTU4Nw==", "url": "https://github.com/apache/skywalking/pull/5722#discussion_r514151587", "bodyText": "My point is only creating an issue to track this todo as backlog.", "author": "wu-sheng", "createdAt": "2020-10-29T10:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxNTEyNQ=="}], "type": "inlineReview"}, {"oid": "d23c4aa2c159cd81ffb3d5994b55e7516d7cd0e8", "url": "https://github.com/apache/skywalking/commit/d23c4aa2c159cd81ffb3d5994b55e7516d7cd0e8", "message": "Add service name formatter and remove unused codes", "committedDate": "2020-10-27T09:34:34Z", "type": "forcePushed"}, {"oid": "3f7cb324b0e7468c23ee5c6f0cc501111abfbf6c", "url": "https://github.com/apache/skywalking/commit/3f7cb324b0e7468c23ee5c6f0cc501111abfbf6c", "message": "Improve K8S ALS analysis\n\nThe current implementation of envoy ALS K8S analysis is based on the hierarchy, pod -> StatefulSet -> deployment, StatefulSet, or others. It's freaky and different from the Istio Kubernetes registry.\n\nThe new path is pod -> endpoint -> service, and we should leverage Informer API instead of raw Kubernetes API.", "committedDate": "2020-10-29T06:42:03Z", "type": "commit"}, {"oid": "1ef23b1805f70f789ad0fb8e19b58c3fa9773b98", "url": "https://github.com/apache/skywalking/commit/1ef23b1805f70f789ad0fb8e19b58c3fa9773b98", "message": "Add service name formatter and remove unused codes", "committedDate": "2020-10-29T06:42:09Z", "type": "commit"}, {"oid": "8c73959df2914562dc42fdb2e2df6de3399a5c73", "url": "https://github.com/apache/skywalking/commit/8c73959df2914562dc42fdb2e2df6de3399a5c73", "message": "Add new jar to LICENSE and known dependencies file", "committedDate": "2020-10-29T06:42:09Z", "type": "commit"}, {"oid": "7c386738927567d1b55abff8763da668db05d159", "url": "https://github.com/apache/skywalking/commit/7c386738927567d1b55abff8763da668db05d159", "message": "Fix E2E test", "committedDate": "2020-10-29T06:42:09Z", "type": "commit"}, {"oid": "a126423252ee467b8a2bdc21b484210e78bb613c", "url": "https://github.com/apache/skywalking/commit/a126423252ee467b8a2bdc21b484210e78bb613c", "message": "Exclude duplicated transitive dependencies", "committedDate": "2020-10-29T06:42:10Z", "type": "commit"}, {"oid": "6af3370aab05f7d0f55b50963c977a36b14fad00", "url": "https://github.com/apache/skywalking/commit/6af3370aab05f7d0f55b50963c977a36b14fad00", "message": "Update SkyWalking Kubernetes commit hash", "committedDate": "2020-10-29T06:42:10Z", "type": "commit"}, {"oid": "42e0f069f3dd5186f4b453c1f9111dc51597df26", "url": "https://github.com/apache/skywalking/commit/42e0f069f3dd5186f4b453c1f9111dc51597df26", "message": "Add unit test for class ServiceNameFormatter", "committedDate": "2020-10-29T06:42:10Z", "type": "commit"}, {"oid": "2846d619096514e323def2a9a245342811e23bba", "url": "https://github.com/apache/skywalking/commit/2846d619096514e323def2a9a245342811e23bba", "message": "Add a TODO item to listen the EndpointSlice resource", "committedDate": "2020-10-29T06:42:10Z", "type": "commit"}, {"oid": "2846d619096514e323def2a9a245342811e23bba", "url": "https://github.com/apache/skywalking/commit/2846d619096514e323def2a9a245342811e23bba", "message": "Add a TODO item to listen the EndpointSlice resource", "committedDate": "2020-10-29T06:42:10Z", "type": "forcePushed"}]}