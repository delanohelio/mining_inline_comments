{"pr_number": 4694, "pr_title": "Provide Meter(metrics) system ", "pr_createdAt": "2020-04-23T04:13:36Z", "pr_url": "https://github.com/apache/skywalking/pull/4694", "timeline": [{"oid": "1914d1fc09b8019016c7bc2929378fed3c37893f", "url": "https://github.com/apache/skywalking/commit/1914d1fc09b8019016c7bc2929378fed3c37893f", "message": "Fix meter system prototype codes.", "committedDate": "2020-04-22T09:52:39Z", "type": "commit"}, {"oid": "a37db8dacf5cf4ef05e18ee8c9b8fb8e27e85341", "url": "https://github.com/apache/skywalking/commit/a37db8dacf5cf4ef05e18ee8c9b8fb8e27e85341", "message": "Add metrics creation.", "committedDate": "2020-04-22T15:13:58Z", "type": "commit"}, {"oid": "e568dd61b22fb4a1fed249a9d72b9375ab3450f7", "url": "https://github.com/apache/skywalking/commit/e568dd61b22fb4a1fed249a9d72b9375ab3450f7", "message": "Shape the prototype", "committedDate": "2020-04-23T04:01:58Z", "type": "commit"}, {"oid": "261c2d6c792c0121eac9490b127c18d5b0842ad7", "url": "https://github.com/apache/skywalking/commit/261c2d6c792c0121eac9490b127c18d5b0842ad7", "message": "Adjust demo codes.", "committedDate": "2020-04-23T04:11:59Z", "type": "commit"}, {"oid": "552211dfb4b0d560b59fb566746a4b3017fd15b4", "url": "https://github.com/apache/skywalking/commit/552211dfb4b0d560b59fb566746a4b3017fd15b4", "message": "Move the closeMeterCreationChannel to core provider level.", "committedDate": "2020-04-23T04:21:51Z", "type": "commit"}, {"oid": "e03deb0334c34eb9c4bdc5e27bdf986a933cb8a7", "url": "https://github.com/apache/skywalking/commit/e03deb0334c34eb9c4bdc5e27bdf986a933cb8a7", "message": "Merge branch 'master' into metrics-system", "committedDate": "2020-04-23T04:51:35Z", "type": "commit"}, {"oid": "8f400de3d6b4c74c46227cf9be3760d641cf3071", "url": "https://github.com/apache/skywalking/commit/8f400de3d6b4c74c46227cf9be3760d641cf3071", "message": "Fix code style issue.", "committedDate": "2020-04-23T06:51:33Z", "type": "commit"}, {"oid": "65feb8f570ba6d9307bd54247dd8a3ba95309670", "url": "https://github.com/apache/skywalking/commit/65feb8f570ba6d9307bd54247dd8a3ba95309670", "message": "Merge branch 'metrics-system' of https://github.com/apache/skywalking into metrics-system", "committedDate": "2020-04-23T06:59:34Z", "type": "commit"}, {"oid": "7374c765f1e83daa49d5d2051fea74fc6939d9e1", "url": "https://github.com/apache/skywalking/commit/7374c765f1e83daa49d5d2051fea74fc6939d9e1", "message": "Fix wrong place of MeterSystem.closeMeterCreationChannel();.", "committedDate": "2020-04-23T08:04:31Z", "type": "commit"}, {"oid": "274cdcb854a476d9d07d96d4f47da340cdab3b5c", "url": "https://github.com/apache/skywalking/commit/274cdcb854a476d9d07d96d4f47da340cdab3b5c", "message": "Fix profile mock core missing service.", "committedDate": "2020-04-23T08:48:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMDg5MQ==", "url": "https://github.com/apache/skywalking/pull/4694#discussion_r413720891", "bodyText": "Is FetchProvider a demonstration?\nThe Metrics are reported by Prometheus client or SkyWalking Agent.", "author": "dmsolr", "createdAt": "2020-04-23T11:01:54Z", "path": "oap-server/server-fetcher-plugin/prometheus-fetcher-plugin/src/main/java/org/apache/skywalking/oap/server/fetcher/prometheus/provider/PrometheusFetcherProvider.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.fetcher.prometheus.provider;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterSystem;\n+import org.apache.skywalking.oap.server.core.analysis.meter.ScopeType;\n+import org.apache.skywalking.oap.server.core.analysis.meter.function.AcceptableValue;\n+import org.apache.skywalking.oap.server.fetcher.prometheus.module.PrometheusFetcherModule;\n+import org.apache.skywalking.oap.server.library.module.ModuleConfig;\n+import org.apache.skywalking.oap.server.library.module.ModuleDefine;\n+import org.apache.skywalking.oap.server.library.module.ModuleProvider;\n+import org.apache.skywalking.oap.server.library.module.ModuleStartException;\n+import org.apache.skywalking.oap.server.library.module.ServiceNotProvidedException;\n+\n+public class PrometheusFetcherProvider extends ModuleProvider {\n+    private final PrometheusFetcherConfig config;\n+\n+    public PrometheusFetcherProvider() {\n+        config = new PrometheusFetcherConfig();\n+    }\n+\n+    @Override\n+    public String name() {\n+        return \"default\";\n+    }\n+\n+    @Override\n+    public Class<? extends ModuleDefine> module() {\n+        return PrometheusFetcherModule.class;\n+    }\n+\n+    @Override\n+    public ModuleConfig createConfigBeanIfAbsent() {\n+        return config;\n+    }\n+\n+    @Override\n+    public void prepare() throws ServiceNotProvidedException, ModuleStartException {\n+        final MeterSystem meterSystem = MeterSystem.meterSystem(getManager());\n+        meterSystem.create(\"test_long_metrics\", \"avg\", ScopeType.SERVICE, Long.class);\n+    }\n+\n+    @Override\n+    public void start() throws ServiceNotProvidedException, ModuleStartException {\n+\n+    }\n+\n+    @Override\n+    public void notifyAfterCompleted() throws ServiceNotProvidedException, ModuleStartException {\n+        final MeterSystem service = getManager().find(CoreModule.NAME).provider().getService(MeterSystem.class);\n+        Executors.newSingleThreadScheduledExecutor().scheduleAtFixedRate(new Runnable() {\n+            @Override\n+            public void run() {\n+                final AcceptableValue<Long> value = service.buildMetrics(\"test_long_metrics\", Long.class);\n+                value.accept(MeterEntity.newService(\"abc\"), 5L);\n+                value.setTimeBucket(TimeBucket.getMinuteTimeBucket(System.currentTimeMillis()));\n+                service.doStreamingCalculation(value);\n+            }\n+        }, 2, 2, TimeUnit.SECONDS);\n+    }", "originalCommit": "274cdcb854a476d9d07d96d4f47da340cdab3b5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczMjM5OQ==", "url": "https://github.com/apache/skywalking/pull/4694#discussion_r413732399", "bodyText": "For demo, yes. Prometheus doesn't have client, OAP fetchs data from target instrumented applications.", "author": "wu-sheng", "createdAt": "2020-04-23T11:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMDg5MQ=="}], "type": "inlineReview"}, {"oid": "8b8900b1e282a801bb29b8a31c67c0765ed4c7f2", "url": "https://github.com/apache/skywalking/commit/8b8900b1e282a801bb29b8a31c67c0765ed4c7f2", "message": "Merge branch 'master' into metrics-system", "committedDate": "2020-04-23T11:21:50Z", "type": "commit"}, {"oid": "fd101a11e2b4e65afe1bdaff810c19e54b7e82de", "url": "https://github.com/apache/skywalking/commit/fd101a11e2b4e65afe1bdaff810c19e54b7e82de", "message": "Update the document for the meter system, architecture graph, fetcher, etc.", "committedDate": "2020-04-24T01:08:26Z", "type": "commit"}, {"oid": "a2b941c61ea7434f3a93e8b17fcbc64ac751bd2d", "url": "https://github.com/apache/skywalking/commit/a2b941c61ea7434f3a93e8b17fcbc64ac751bd2d", "message": "Update graph links.", "committedDate": "2020-04-24T01:09:55Z", "type": "commit"}, {"oid": "2ba582bc749bb9df59e2beb132794721e649a7dc", "url": "https://github.com/apache/skywalking/commit/2ba582bc749bb9df59e2beb132794721e649a7dc", "message": "Make demo codes clear.", "committedDate": "2020-04-24T01:33:21Z", "type": "commit"}, {"oid": "40d0e2a33e9280665d74e0fb1793d53f6390458b", "url": "https://github.com/apache/skywalking/commit/40d0e2a33e9280665d74e0fb1793d53f6390458b", "message": "Make slow trace query available in the sampled record. Logically, they are the same thing. The UI doesn't need to concern about the trace as a special case.", "committedDate": "2020-04-24T08:49:39Z", "type": "commit"}, {"oid": "a9ca06b30a5fc57b347921d75eb4d39b20112dcc", "url": "https://github.com/apache/skywalking/commit/a9ca06b30a5fc57b347921d75eb4d39b20112dcc", "message": "Merge branch 'master' into metrics-system", "committedDate": "2020-04-24T11:51:03Z", "type": "commit"}]}