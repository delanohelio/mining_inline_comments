{"pr_number": 5512, "pr_title": "Support mongo driver 4.x version.", "pr_createdAt": "2020-09-17T13:07:41Z", "pr_url": "https://github.com/apache/skywalking/pull/5512", "timeline": [{"oid": "cf6de20f3d4bb620b469a4fbbf5a30a9095c8eb6", "url": "https://github.com/apache/skywalking/commit/cf6de20f3d4bb620b469a4fbbf5a30a9095c8eb6", "message": "Complete basic adaptation work.", "committedDate": "2020-09-15T17:10:01Z", "type": "commit"}, {"oid": "95021843671502c96ed91d5b2a45c631d54b61d2", "url": "https://github.com/apache/skywalking/commit/95021843671502c96ed91d5b2a45c631d54b61d2", "message": "Complete basic adaptation work.", "committedDate": "2020-09-17T11:51:37Z", "type": "commit"}, {"oid": "798a205151e152560e360e808bae4148ff30fc35", "url": "https://github.com/apache/skywalking/commit/798a205151e152560e360e808bae4148ff30fc35", "message": "Complete basic adaptation work.", "committedDate": "2020-09-17T12:38:46Z", "type": "commit"}, {"oid": "e1a17559b3e23be76c2fe8e443563e2bb3d795bd", "url": "https://github.com/apache/skywalking/commit/e1a17559b3e23be76c2fe8e443563e2bb3d795bd", "message": "Complete basic adaptation work.", "committedDate": "2020-09-17T12:51:22Z", "type": "commit"}, {"oid": "a1e9134b24f6d5d7811ffb331bfb110f942a0735", "url": "https://github.com/apache/skywalking/commit/a1e9134b24f6d5d7811ffb331bfb110f942a0735", "message": "Complete basic adaptation work.", "committedDate": "2020-09-17T12:51:48Z", "type": "commit"}, {"oid": "b8ab1989c8a782083df3763596ecb44f184eb49a", "url": "https://github.com/apache/skywalking/commit/b8ab1989c8a782083df3763596ecb44f184eb49a", "message": "Complete basic adaptation work.", "committedDate": "2020-09-17T13:02:21Z", "type": "commit"}, {"oid": "cb7034950bc2eec87e8b44a082ed5c41c6f492b9", "url": "https://github.com/apache/skywalking/commit/cb7034950bc2eec87e8b44a082ed5c41c6f492b9", "message": "Merge branch 'master' into mongodb4.x", "committedDate": "2020-09-17T13:09:05Z", "type": "commit"}, {"oid": "b2f06557d65d5161df215a5f65a659caaa27b8ba", "url": "https://github.com/apache/skywalking/commit/b2f06557d65d5161df215a5f65a659caaa27b8ba", "message": "Complete basic adaptation work.", "committedDate": "2020-09-17T13:11:38Z", "type": "commit"}, {"oid": "1b9cdca3dc5a29e6ad16382d77f59d4dddfc3193", "url": "https://github.com/apache/skywalking/commit/1b9cdca3dc5a29e6ad16382d77f59d4dddfc3193", "message": "Merge remote-tracking branch 'origin/mongodb4.x' into mongodb4.x", "committedDate": "2020-09-17T13:11:59Z", "type": "commit"}, {"oid": "c01cde6a6318b8e1eab1d4128e0d809aba33269a", "url": "https://github.com/apache/skywalking/commit/c01cde6a6318b8e1eab1d4128e0d809aba33269a", "message": "Complete basic adaptation work.", "committedDate": "2020-09-17T13:19:27Z", "type": "commit"}, {"oid": "396ce3199ecad9fa9d2993bf4412321fbbdfb7bb", "url": "https://github.com/apache/skywalking/commit/396ce3199ecad9fa9d2993bf4412321fbbdfb7bb", "message": "Complete basic adaptation work.", "committedDate": "2020-09-17T13:37:10Z", "type": "commit"}, {"oid": "df65a8390a2b89f7b192473272c59f1b79356897", "url": "https://github.com/apache/skywalking/commit/df65a8390a2b89f7b192473272c59f1b79356897", "message": "fix ci", "committedDate": "2020-09-17T13:52:58Z", "type": "commit"}, {"oid": "3a0ad6be7a01190d9fa33f0740b4d23fa2637232", "url": "https://github.com/apache/skywalking/commit/3a0ad6be7a01190d9fa33f0740b4d23fa2637232", "message": "fix ci", "committedDate": "2020-09-17T13:53:07Z", "type": "commit"}, {"oid": "e375c29e2879ef80f0a8dae550ca58ac938fbdb3", "url": "https://github.com/apache/skywalking/commit/e375c29e2879ef80f0a8dae550ca58ac938fbdb3", "message": "fix ci", "committedDate": "2020-09-17T13:54:04Z", "type": "commit"}, {"oid": "cb41408c95a843bf2dabaa1c64fc8904dc8f42ba", "url": "https://github.com/apache/skywalking/commit/cb41408c95a843bf2dabaa1c64fc8904dc8f42ba", "message": "Merge branch 'master' into mongodb4.x", "committedDate": "2020-09-18T01:01:25Z", "type": "commit"}, {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "url": "https://github.com/apache/skywalking/commit/8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "message": "Merge branch 'master' into mongodb4.x", "committedDate": "2020-09-18T07:19:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MDI2OA==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490840268", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * same whit org.apache.skywalking.apm.plugin.mongodb.v3.define.v38.MongoDBOperationExecutorInstrumentation\n          \n          \n            \n             * same with org.apache.skywalking.apm.plugin.mongodb.v3.define.v38.MongoDBOperationExecutorInstrumentation", "author": "wu-sheng", "createdAt": "2020-09-18T10:02:09Z", "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBOperationExecutorInstrumentation.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import net.bytebuddy.matcher.ElementMatchers;\n+import org.apache.skywalking.apm.agent.core.plugin.bytebuddy.ArgumentTypeNameMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.match.NameMatch;\n+\n+/**\n+ * same whit org.apache.skywalking.apm.plugin.mongodb.v3.define.v38.MongoDBOperationExecutorInstrumentation", "originalCommit": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MDk4MQ==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490840981", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // pass remotePeer to OperationExecutor, which will be wrapper as EnhancedInstance\n          \n          \n            \n                        // pass remotePeer to OperationExecutor, which has be enhanced as EnhancedInstance", "author": "wu-sheng", "createdAt": "2020-09-18T10:03:40Z", "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBClientDelegateInterceptor.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.interceptor;\n+\n+import com.mongodb.internal.connection.Cluster;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceConstructorInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.support.MongoRemotePeerHelper;\n+\n+import java.lang.reflect.Method;\n+\n+public class MongoDBClientDelegateInterceptor implements InstanceConstructorInterceptor, InstanceMethodsAroundInterceptor {\n+\n+    private static final ILog LOGGER = LogManager.getLogger(MongoDBClientDelegateInterceptor.class);\n+\n+    @Override\n+    public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n+        Cluster cluster = (Cluster) allArguments[0];\n+        String remotePeer = MongoRemotePeerHelper.getRemotePeer(cluster);\n+        objInst.setSkyWalkingDynamicField(remotePeer);\n+    }\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        MethodInterceptResult result) {\n+        // do nothing\n+    }\n+\n+    @Override\n+    public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        Object ret) {\n+        if (ret instanceof EnhancedInstance) {\n+            // pass remotePeer to OperationExecutor, which will be wrapper as EnhancedInstance", "originalCommit": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MTE4OA==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490841188", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // @see: org.apache.skywalking.apm.plugin.mongodb.v3.define.v37.MongoDBOperationExecutorInstrumentation\n          \n          \n            \n                        // See: org.apache.skywalking.apm.plugin.mongodb.v3.define.v37.MongoDBOperationExecutorInstrumentation", "author": "wu-sheng", "createdAt": "2020-09-18T10:04:05Z", "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBClientDelegateInterceptor.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.interceptor;\n+\n+import com.mongodb.internal.connection.Cluster;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceConstructorInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.support.MongoRemotePeerHelper;\n+\n+import java.lang.reflect.Method;\n+\n+public class MongoDBClientDelegateInterceptor implements InstanceConstructorInterceptor, InstanceMethodsAroundInterceptor {\n+\n+    private static final ILog LOGGER = LogManager.getLogger(MongoDBClientDelegateInterceptor.class);\n+\n+    @Override\n+    public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n+        Cluster cluster = (Cluster) allArguments[0];\n+        String remotePeer = MongoRemotePeerHelper.getRemotePeer(cluster);\n+        objInst.setSkyWalkingDynamicField(remotePeer);\n+    }\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        MethodInterceptResult result) {\n+        // do nothing\n+    }\n+\n+    @Override\n+    public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        Object ret) {\n+        if (ret instanceof EnhancedInstance) {\n+            // pass remotePeer to OperationExecutor, which will be wrapper as EnhancedInstance\n+            // @see: org.apache.skywalking.apm.plugin.mongodb.v3.define.v37.MongoDBOperationExecutorInstrumentation", "originalCommit": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MTU4MA==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490841580", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // @see: MongoDBClientDelegateInterceptor.afterMethod\n          \n          \n            \n                    // See: MongoDBClientDelegateInterceptor.afterMethod", "author": "wu-sheng", "createdAt": "2020-09-18T10:04:52Z", "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBOperationExecutorInterceptor.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.interceptor;\n+\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.support.MongoSpanHelper;\n+\n+import java.lang.reflect.Method;\n+\n+@SuppressWarnings(\"Duplicates\")\n+public class MongoDBOperationExecutorInterceptor implements InstanceMethodsAroundInterceptor {\n+\n+    private static final ILog LOGGER = LogManager.getLogger(MongoDBOperationExecutorInterceptor.class);\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        MethodInterceptResult result) {\n+        String executeMethod = allArguments[0].getClass().getSimpleName();\n+        // OperationExecutor has be mark it's remotePeer\n+        // @see: MongoDBClientDelegateInterceptor.afterMethod", "originalCommit": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MTk3Mw==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490841973", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // OperationExecutor has be mark it's remotePeer\n          \n          \n            \n                    // OperationExecutor has included th remotePeer", "author": "wu-sheng", "createdAt": "2020-09-18T10:05:30Z", "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBOperationExecutorInterceptor.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.interceptor;\n+\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.support.MongoSpanHelper;\n+\n+import java.lang.reflect.Method;\n+\n+@SuppressWarnings(\"Duplicates\")\n+public class MongoDBOperationExecutorInterceptor implements InstanceMethodsAroundInterceptor {\n+\n+    private static final ILog LOGGER = LogManager.getLogger(MongoDBOperationExecutorInterceptor.class);\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        MethodInterceptResult result) {\n+        String executeMethod = allArguments[0].getClass().getSimpleName();\n+        // OperationExecutor has be mark it's remotePeer", "originalCommit": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MjQxMw==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490842413", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * OperationExecutor which is unified entrance of execute mongo command. we can mark OperationExecutor which connection\n          \n          \n            \n             * OperationExecutor which is unified entrance of execute mongo command. Inject the remotePeer into enhanced OperationExecutor.", "author": "wu-sheng", "createdAt": "2020-09-18T10:06:25Z", "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBClientDelegateInstrumentation.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.interceptor.MongoDBClientDelegateInterceptor;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static org.apache.skywalking.apm.agent.core.plugin.bytebuddy.ArgumentTypeNameMatch.takesArgumentWithType;\n+import static org.apache.skywalking.apm.agent.core.plugin.match.NameMatch.byName;\n+\n+/**\n+ * Enhance {@code com.mongodb.client.internal.MongoClientDelegate} instance, and intercept {@code\n+ * com.mongodb.client.internal.MongoClientDelegate#getOperationExecutor()}, this is the only way to get\n+ * OperationExecutor which is unified entrance of execute mongo command. we can mark OperationExecutor which connection", "originalCommit": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MjU3NQ==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490842575", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * belongs to.", "author": "wu-sheng", "createdAt": "2020-09-18T10:06:43Z", "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBClientDelegateInstrumentation.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.interceptor.MongoDBClientDelegateInterceptor;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static org.apache.skywalking.apm.agent.core.plugin.bytebuddy.ArgumentTypeNameMatch.takesArgumentWithType;\n+import static org.apache.skywalking.apm.agent.core.plugin.match.NameMatch.byName;\n+\n+/**\n+ * Enhance {@code com.mongodb.client.internal.MongoClientDelegate} instance, and intercept {@code\n+ * com.mongodb.client.internal.MongoClientDelegate#getOperationExecutor()}, this is the only way to get\n+ * OperationExecutor which is unified entrance of execute mongo command. we can mark OperationExecutor which connection\n+ * belongs to.", "originalCommit": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MzkwNA==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490843904", "bodyText": "Is this provided in the 3.x too? With the same config name?", "author": "wu-sheng", "createdAt": "2020-09-18T10:09:31Z", "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/support/MongoPluginConfig.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.support;\n+\n+import org.apache.skywalking.apm.agent.core.boot.PluginConfig;\n+\n+public class MongoPluginConfig {", "originalCommit": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1ODk0Mg==", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490858942", "bodyText": "Is this provided in the 3.x too? With the same config name?\n\nYes, the configuration is the same as 3.x.", "author": "harvies", "createdAt": "2020-09-18T10:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MzkwNA=="}], "type": "inlineReview"}, {"oid": "02784c29ef6b9a3c0c9bb972812711878910655c", "url": "https://github.com/apache/skywalking/commit/02784c29ef6b9a3c0c9bb972812711878910655c", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBOperationExecutorInstrumentation.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-09-18T10:23:30Z", "type": "commit"}, {"oid": "07a4a622b1ce6249a36cb4868ea1a93e2143161a", "url": "https://github.com/apache/skywalking/commit/07a4a622b1ce6249a36cb4868ea1a93e2143161a", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBClientDelegateInterceptor.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-09-18T10:25:04Z", "type": "commit"}, {"oid": "a4c96f088d3ae4593dad6379f1147590c8d42a37", "url": "https://github.com/apache/skywalking/commit/a4c96f088d3ae4593dad6379f1147590c8d42a37", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBOperationExecutorInterceptor.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-09-18T10:26:18Z", "type": "commit"}, {"oid": "0dd0ab53bf95c1530b7188191151599869b9a9be", "url": "https://github.com/apache/skywalking/commit/0dd0ab53bf95c1530b7188191151599869b9a9be", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBClientDelegateInterceptor.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-09-18T10:27:00Z", "type": "commit"}, {"oid": "3bcb45052357d148cbaf92977b14e6d3283e97e9", "url": "https://github.com/apache/skywalking/commit/3bcb45052357d148cbaf92977b14e6d3283e97e9", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBOperationExecutorInterceptor.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-09-18T10:28:15Z", "type": "commit"}, {"oid": "2316e687a5727002805ccb4f105d2f17c641874e", "url": "https://github.com/apache/skywalking/commit/2316e687a5727002805ccb4f105d2f17c641874e", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBClientDelegateInstrumentation.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-09-18T10:31:10Z", "type": "commit"}, {"oid": "8bc350999bb2d84ea339b81e34642734fc8b6c45", "url": "https://github.com/apache/skywalking/commit/8bc350999bb2d84ea339b81e34642734fc8b6c45", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBClientDelegateInstrumentation.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-09-18T10:37:31Z", "type": "commit"}, {"oid": "ddbbbc3ba6defbfa68bb60ad5448af1cba7ac956", "url": "https://github.com/apache/skywalking/commit/ddbbbc3ba6defbfa68bb60ad5448af1cba7ac956", "message": "Modified as suggested.", "committedDate": "2020-09-18T10:45:04Z", "type": "commit"}, {"oid": "a33af8c4f7d4e2aba3480b49e018b5677bc9c23f", "url": "https://github.com/apache/skywalking/commit/a33af8c4f7d4e2aba3480b49e018b5677bc9c23f", "message": "Merge remote-tracking branch 'origin/mongodb4.x' into mongodb4.x", "committedDate": "2020-09-18T10:45:35Z", "type": "commit"}, {"oid": "8babd53d410432ab7988c3c6bdf7307158049e30", "url": "https://github.com/apache/skywalking/commit/8babd53d410432ab7988c3c6bdf7307158049e30", "message": "Merge branch 'master' into mongodb4.x", "committedDate": "2020-09-18T15:49:24Z", "type": "commit"}, {"oid": "f12fc74ffff2e65ecd6fd7d882796b337f2b165c", "url": "https://github.com/apache/skywalking/commit/f12fc74ffff2e65ecd6fd7d882796b337f2b165c", "message": "add test cases", "committedDate": "2020-09-19T07:40:08Z", "type": "commit"}, {"oid": "f6b27862c1b39867c40bd8d064fc5a07de4c2553", "url": "https://github.com/apache/skywalking/commit/f6b27862c1b39867c40bd8d064fc5a07de4c2553", "message": "Merge remote-tracking branch 'remotes/upstream/master' into mongodb4.x", "committedDate": "2020-09-19T07:40:45Z", "type": "commit"}, {"oid": "f99390df036c43dd580fa0800ea17842533d14a2", "url": "https://github.com/apache/skywalking/commit/f99390df036c43dd580fa0800ea17842533d14a2", "message": "Merge branch 'mongodb4.x' of github.com:harvies/skywalking into mongodb4.x", "committedDate": "2020-09-19T07:41:25Z", "type": "commit"}, {"oid": "6ea0c92d8f2e1f3d2cc19d01eca5000a3df9bcc7", "url": "https://github.com/apache/skywalking/commit/6ea0c92d8f2e1f3d2cc19d01eca5000a3df9bcc7", "message": "Merge remote-tracking branch 'remotes/upstream/master' into mongodb4.x", "committedDate": "2020-09-21T10:39:27Z", "type": "commit"}, {"oid": "717b1da696f11fa931b2fd77414d030d7680bddf", "url": "https://github.com/apache/skywalking/commit/717b1da696f11fa931b2fd77414d030d7680bddf", "message": "replace DB_STATEMENT to DB_BIND_VARIABLES & remove executeMethod prefix", "committedDate": "2020-09-21T13:09:03Z", "type": "commit"}, {"oid": "78e87c436414165ac7503fd0b3f8006045fc9fdc", "url": "https://github.com/apache/skywalking/commit/78e87c436414165ac7503fd0b3f8006045fc9fdc", "message": "Merge remote-tracking branch 'remotes/upstream/master' into mongodb4.x", "committedDate": "2020-09-22T02:05:42Z", "type": "commit"}, {"oid": "fc012e700ea45af8cdee6fbb5865d299c920a18a", "url": "https://github.com/apache/skywalking/commit/fc012e700ea45af8cdee6fbb5865d299c920a18a", "message": "mongodb 4.x", "committedDate": "2020-09-22T03:14:02Z", "type": "commit"}, {"oid": "4793e282633be922f9e35d0e6c66676360a41ab2", "url": "https://github.com/apache/skywalking/commit/4793e282633be922f9e35d0e6c66676360a41ab2", "message": "fix ci", "committedDate": "2020-09-22T04:19:17Z", "type": "commit"}]}