{"pr_number": 4239, "pr_title": "Provide influxdb as a new storage plugin", "pr_createdAt": "2020-01-15T16:20:35Z", "pr_url": "https://github.com/apache/skywalking/pull/4239", "timeline": [{"oid": "9158c99eda501c14890dcf6d392ee5787575915f", "url": "https://github.com/apache/skywalking/commit/9158c99eda501c14890dcf6d392ee5787575915f", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-17T14:34:54Z", "type": "commit"}, {"oid": "170b15da25668c02b5c18f3a0379dff4d7d2ad0e", "url": "https://github.com/apache/skywalking/commit/170b15da25668c02b5c18f3a0379dff4d7d2ad0e", "message": "Merge branch 'influx-storage' of https://github.com/dmsolr/skywalking into influx-storage", "committedDate": "2020-02-17T14:52:18Z", "type": "commit"}, {"oid": "41143031fe46cb49cc7bf88b3a6d14b70e062f41", "url": "https://github.com/apache/skywalking/commit/41143031fe46cb49cc7bf88b3a6d14b70e062f41", "message": "remove profile_task from metabase", "committedDate": "2020-02-18T04:24:05Z", "type": "commit"}, {"oid": "4ef910d9e690e6a2b8ba9ee2202d1bc3ebb35b48", "url": "https://github.com/apache/skywalking/commit/4ef910d9e690e6a2b8ba9ee2202d1bc3ebb35b48", "message": "Update MetaTableDefine.java", "committedDate": "2020-02-18T05:51:44Z", "type": "commit"}, {"oid": "5609a5d5578a65758540d5ad9be53a2ee214907b", "url": "https://github.com/apache/skywalking/commit/5609a5d5578a65758540d5ad9be53a2ee214907b", "message": "fix issues", "committedDate": "2020-02-18T07:45:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUwOTQyNw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380509427", "bodyText": "Check ModelInstaller#overrideColumnName, you could replace the name in the storage implementation. That is a more elegant way.", "author": "wu-sheng", "createdAt": "2020-02-18T08:04:13Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/ProfileTaskQuery.java", "diffHunk": "@@ -95,7 +96,7 @@ public ProfileTask getById(final String id) throws IOException {\n         WhereQueryImpl query = select(\"ID\", ProfileTaskRecord.SERVICE_ID,\n                                       ProfileTaskRecord.ENDPOINT_NAME, ProfileTaskRecord.START_TIME,\n                                       ProfileTaskRecord.CREATE_TIME,\n-                                      ProfileTaskRecord.DURATION,\n+                                      \"\\\"\" + ProfileTaskRecord.DURATION + \"\\\"\", // scape, the 'duration' is identifier", "originalCommit": "5609a5d5578a65758540d5ad9be53a2ee214907b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3bef73af92d8743dd47288fa253c278429ac84bf", "url": "https://github.com/apache/skywalking/commit/3bef73af92d8743dd47288fa253c278429ac84bf", "message": "NoneStreamDAO, influxdb implementation", "committedDate": "2020-02-18T08:17:32Z", "type": "commit"}, {"oid": "a2a97f9ca7ca001ab05df1fd29b5733a9e4a7988", "url": "https://github.com/apache/skywalking/commit/a2a97f9ca7ca001ab05df1fd29b5733a9e4a7988", "message": "fixg", "committedDate": "2020-02-18T11:35:11Z", "type": "commit"}, {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6", "url": "https://github.com/apache/skywalking/commit/9121be6a56988bb3d606b4239268e953b16f19c6", "message": "override column name", "committedDate": "2020-02-18T16:26:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3ODk0NA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381078944", "bodyText": "recommend add a null value to judge here\uff0csubsequence queries are based on the available influx", "author": null, "createdAt": "2020-02-19T05:05:00Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ * InfluxDB connection maintainer, provides base data write/query API.\n+ */\n+@Slf4j\n+public class InfluxClient implements Client {\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag of time_bucket.\n+     */\n+    public static final String TAG_TIME_BUCKET = \"_time_bucket\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+                                         new OkHttpClient.Builder().readTimeout(3, TimeUnit.MINUTES)\n+                                                                   .writeTimeout(3, TimeUnit.MINUTES),\n+                                         InfluxDB.ResponseFormat.MSGPACK\n+        );\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.enableBatch(config.getActions(), config.getDuration(), TimeUnit.MILLISECONDS);\n+        influx.setDatabase(database);\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB.\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    private InfluxDB getInflux() {\n+        return influx;", "originalCommit": "9121be6a56988bb3d606b4239268e953b16f19c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyNjU5MA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381126590", "bodyText": "I don't think so. OAP crashes and exits, when Influx initializes failed.", "author": "dmsolr", "createdAt": "2020-02-19T07:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3ODk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA4MDE2OQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381080169", "bodyText": "change method name deleteBefore or else better\uff1f", "author": null, "createdAt": "2020-02-19T05:11:08Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ * InfluxDB connection maintainer, provides base data write/query API.\n+ */\n+@Slf4j\n+public class InfluxClient implements Client {\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag of time_bucket.\n+     */\n+    public static final String TAG_TIME_BUCKET = \"_time_bucket\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+                                         new OkHttpClient.Builder().readTimeout(3, TimeUnit.MINUTES)\n+                                                                   .writeTimeout(3, TimeUnit.MINUTES),\n+                                         InfluxDB.ResponseFormat.MSGPACK\n+        );\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.enableBatch(config.getActions(), config.getDuration(), TimeUnit.MILLISECONDS);\n+        influx.setDatabase(database);\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB.\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    private InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB and return a set of {@link QueryResult.Result}s. Normally, InfluxDB supports\n+     * combining multiple statements into one query, so that we do get multi-results.\n+     *\n+     * @throws IOException if there is an error on the InfluxDB server or communication error.\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB with a single statement.\n+     *\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        List<QueryResult.Result> results = query(query);\n+\n+        if (CollectionUtils.isEmpty(results)) {\n+            return null;\n+        }\n+        return results.get(0).getSeries();\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB with a single statement but return a single {@link QueryResult.Series}.\n+     *\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public QueryResult.Series queryForSingleSeries(Query query) throws IOException {\n+        List<QueryResult.Series> series = queryForSeries(query);\n+        if (CollectionUtils.isEmpty(series)) {\n+            return null;\n+        }\n+        return series.get(0);\n+    }\n+\n+    /**\n+     * Data management, to drop a time-series by measurement and time-series name specified. If an exception isn't\n+     * thrown, it means execution success. Notice, drop series don't support to drop series by range\n+     *\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public void dropSeries(String measurement, long timeBucket) throws IOException {\n+        Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n+        QueryResult result = getInflux().query(query);\n+\n+        if (result.hasError()) {\n+            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n+        }\n+    }\n+\n+    public void deleteByQuery(String measurement, long timestamp) throws IOException {", "originalCommit": "9121be6a56988bb3d606b4239268e953b16f19c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA4MzY0NQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381083645", "bodyText": "+1 can be deleted\uff1f delete is <", "author": null, "createdAt": "2020-02-19T05:25:55Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/HistoryDeleteDAO.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import java.io.IOException;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.config.ConfigService;\n+import org.apache.skywalking.oap.server.core.storage.IHistoryDeleteDAO;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.ttl.StorageTTL;\n+import org.apache.skywalking.oap.server.core.storage.ttl.TTLCalculator;\n+import org.apache.skywalking.oap.server.library.module.ModuleDefineHolder;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.joda.time.DateTime;\n+\n+@Slf4j\n+public class HistoryDeleteDAO implements IHistoryDeleteDAO {\n+    private final ModuleDefineHolder moduleDefineHolder;\n+    private final InfluxClient client;\n+    private final StorageTTL storageTTL;\n+\n+    public HistoryDeleteDAO(ModuleDefineHolder moduleDefineHolder, InfluxClient client, StorageTTL storageTTL) {\n+        this.moduleDefineHolder = moduleDefineHolder;\n+        this.storageTTL = storageTTL;\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public void deleteHistory(Model model, String timeBucketColumnName) throws IOException {\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"TTL execution log, model: {}\", model.getName());\n+        }\n+        try {\n+            ConfigService configService = moduleDefineHolder.find(CoreModule.NAME)\n+                                                            .provider()\n+                                                            .getService(ConfigService.class);\n+\n+            TTLCalculator ttlCalculator;\n+            if (model.isRecord()) {\n+                ttlCalculator = storageTTL.recordCalculator();\n+            } else {\n+                ttlCalculator = storageTTL.metricsCalculator(model.getDownsampling());\n+            }\n+\n+            client.deleteByQuery(\n+                model.getName(),\n+                TimeBucket.getTimestamp(ttlCalculator.timeBefore(DateTime.now(), configService.getDataTTLConfig()) + 1)", "originalCommit": "9121be6a56988bb3d606b4239268e953b16f19c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyNTA3NQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381125075", "bodyText": "The condition, we delete the history data, is less than and equal.", "author": "dmsolr", "createdAt": "2020-02-19T07:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA4MzY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0ODI0Mw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381148243", "bodyText": "why this have Nanosecond? or millisecond?", "author": null, "createdAt": "2020-02-19T08:48:06Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/NoneStreamDAO.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import java.io.IOException;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.skywalking.apm.commons.datacarrier.common.AtomicRangeInteger;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.analysis.config.NoneStream;\n+import org.apache.skywalking.oap.server.core.profile.ProfileTaskRecord;\n+import org.apache.skywalking.oap.server.core.storage.INoneStreamDAO;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.Point;\n+\n+public class NoneStreamDAO implements INoneStreamDAO {\n+    public static final String TAG_SERVICE_ID = \"_service_id\";\n+    private static final int PADDING_SIZE = 1_000_000;\n+    private static final AtomicRangeInteger SUFFIX = new AtomicRangeInteger(0, PADDING_SIZE);\n+\n+    private InfluxClient client;\n+    private StorageBuilder<NoneStream> storageBuilder;\n+\n+    public NoneStreamDAO(InfluxClient client, StorageBuilder<NoneStream> storageBuilder) {\n+        this.client = client;\n+        this.storageBuilder = storageBuilder;\n+    }\n+\n+    @Override\n+    public void insert(final Model model, final NoneStream noneStream) throws IOException {\n+        final long timestamp = TimeBucket.getTimestamp(\n+            noneStream.getTimeBucket(), model.getDownsampling()) * PADDING_SIZE + SUFFIX.getAndIncrement();\n+\n+        Point point = new InfluxInsertRequest(model, noneStream, storageBuilder)\n+            .time(timestamp, TimeUnit.NANOSECONDS)", "originalCommit": "9121be6a56988bb3d606b4239268e953b16f19c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE3NDA4NA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381174084", "bodyText": "All data in influxdb is nanosecond.", "author": "wu-sheng", "createdAt": "2020-02-19T09:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0ODI0Mw=="}], "type": "inlineReview"}, {"oid": "484e078399f90e2b11d9bc16a83c76bbc1d4921b", "url": "https://github.com/apache/skywalking/commit/484e078399f90e2b11d9bc16a83c76bbc1d4921b", "message": "provide influxdb as a new storage plugin", "committedDate": "2020-01-15T16:09:13Z", "type": "commit"}, {"oid": "01338907e2bcab62264a1050311bc7edf18bde0c", "url": "https://github.com/apache/skywalking/commit/01338907e2bcab62264a1050311bc7edf18bde0c", "message": "Introduct MySQL as an optional to store Metadata", "committedDate": "2020-01-18T13:48:18Z", "type": "commit"}, {"oid": "17261eac4f9589a5f8b496e9ad71f968dc517a6e", "url": "https://github.com/apache/skywalking/commit/17261eac4f9589a5f8b496e9ad71f968dc517a6e", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-01-18T14:13:27Z", "type": "commit"}, {"oid": "e654eda3d9e30e5af385e0bf320f3865e0f89626", "url": "https://github.com/apache/skywalking/commit/e654eda3d9e30e5af385e0bf320f3865e0f89626", "message": "Implement DAO of ProfileTask", "committedDate": "2020-01-18T19:12:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI1NzE1Mw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r368257153", "bodyText": "INoneStreamDAO is used for web interactive job, such as @mrproliu 's profiling task. Basically, this should have little data. Is the influxDB suitable for this?", "author": "wu-sheng", "createdAt": "2020-01-19T00:46:08Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/InfluxStorageDAO.java", "diffHunk": "@@ -53,6 +53,6 @@ public IRecordDAO newRecordDao(StorageBuilder<Record> storageBuilder) {\n \n     @Override\n     public INoneStreamDAO newNoneStreamDao(StorageBuilder<NoneStream> storageBuilder) {\n-        return new NoneStreamDAO();\n+        return new NoneStreamDAO(influxClient, storageBuilder);", "originalCommit": "e654eda3d9e30e5af385e0bf320f3865e0f89626", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MzA1Ng==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r368263056", "bodyText": "That sounds the relationship database better.", "author": "dmsolr", "createdAt": "2020-01-19T03:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI1NzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI3NDU3NA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r368274574", "bodyText": "There would be much data, just easy to query should be enough. Anyway, based on your decision.", "author": "wu-sheng", "createdAt": "2020-01-19T08:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI1NzE1Mw=="}], "type": "inlineReview"}, {"oid": "a879e22e007d608d44fa9b3ee9d7fbc86a07032e", "url": "https://github.com/apache/skywalking/commit/a879e22e007d608d44fa9b3ee9d7fbc86a07032e", "message": "Store NoneStream in RMDB", "committedDate": "2020-01-19T03:39:47Z", "type": "commit"}, {"oid": "fd5f94cbef14b6b585867106c225c0c3d34af12e", "url": "https://github.com/apache/skywalking/commit/fd5f94cbef14b6b585867106c225c0c3d34af12e", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-01-29T19:39:50Z", "type": "commit"}, {"oid": "3ae4263f3fd6a40ad9d356ea6adfe905dcb83c41", "url": "https://github.com/apache/skywalking/commit/3ae4263f3fd6a40ad9d356ea6adfe905dcb83c41", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-01T14:43:27Z", "type": "commit"}, {"oid": "16de42f8a311d046cf44e174c69bea7d0c150887", "url": "https://github.com/apache/skywalking/commit/16de42f8a311d046cf44e174c69bea7d0c150887", "message": "update", "committedDate": "2020-02-01T15:40:09Z", "type": "commit"}, {"oid": "08e7859dcae6393a6f8695a68c785d299a23598b", "url": "https://github.com/apache/skywalking/commit/08e7859dcae6393a6f8695a68c785d299a23598b", "message": "fix checkstyle", "committedDate": "2020-02-01T15:47:38Z", "type": "commit"}, {"oid": "63aafad4e2ca3707a2660b54683d35c6389309c9", "url": "https://github.com/apache/skywalking/commit/63aafad4e2ca3707a2660b54683d35c6389309c9", "message": "update", "committedDate": "2020-02-01T16:40:31Z", "type": "commit"}, {"oid": "11e829e4516041f2386872abdde8582c80ee5efd", "url": "https://github.com/apache/skywalking/commit/11e829e4516041f2386872abdde8582c80ee5efd", "message": "update Licenes/Dependencies", "committedDate": "2020-02-02T10:05:24Z", "type": "commit"}, {"oid": "8d36fccc74f4ea46b1e61ef0821da595b289084e", "url": "https://github.com/apache/skywalking/commit/8d36fccc74f4ea46b1e61ef0821da595b289084e", "message": "TTL instead of RetentionPolicy", "committedDate": "2020-02-02T18:03:14Z", "type": "commit"}, {"oid": "296bbaf5663b8ef5eec839a48dd6f778d065de72", "url": "https://github.com/apache/skywalking/commit/296bbaf5663b8ef5eec839a48dd6f778d065de72", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-02T18:08:06Z", "type": "commit"}, {"oid": "4b0267919de78aac31e8ffd8e15a638a3e3a3c6e", "url": "https://github.com/apache/skywalking/commit/4b0267919de78aac31e8ffd8e15a638a3e3a3c6e", "message": "polish", "committedDate": "2020-02-02T18:44:18Z", "type": "commit"}, {"oid": "0ce9dbe0d384ede33ebacd0b3b075a39da71f641", "url": "https://github.com/apache/skywalking/commit/0ce9dbe0d384ede33ebacd0b3b075a39da71f641", "message": "fix bug and fix License", "committedDate": "2020-02-03T06:13:19Z", "type": "commit"}, {"oid": "e09bd70bb138ad77ef47389df60ab62f950fbd79", "url": "https://github.com/apache/skywalking/commit/e09bd70bb138ad77ef47389df60ab62f950fbd79", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-03T06:24:04Z", "type": "commit"}, {"oid": "a014dfce71d86d77f6abf48fd1581526278c7e80", "url": "https://github.com/apache/skywalking/commit/a014dfce71d86d77f6abf48fd1581526278c7e80", "message": "merge", "committedDate": "2020-02-03T06:24:58Z", "type": "commit"}, {"oid": "6bdc09dbf541fbeb7a4366d42baeb0624657e98d", "url": "https://github.com/apache/skywalking/commit/6bdc09dbf541fbeb7a4366d42baeb0624657e98d", "message": "revert", "committedDate": "2020-02-03T06:27:29Z", "type": "commit"}, {"oid": "9128aec8aff64b68c151a710f36728fa6a1dccbf", "url": "https://github.com/apache/skywalking/commit/9128aec8aff64b68c151a710f36728fa6a1dccbf", "message": "fix checkstyle", "committedDate": "2020-02-03T06:52:37Z", "type": "commit"}, {"oid": "74d6e4d685e3107516fb2092c1ca6fe536e1a8fc", "url": "https://github.com/apache/skywalking/commit/74d6e4d685e3107516fb2092c1ca6fe536e1a8fc", "message": "remove TTL configuration from yaml & select fields only", "committedDate": "2020-02-03T16:14:13Z", "type": "commit"}, {"oid": "ffd4b9f8ce8cd7dd6c8b423871797e3f993cc1f7", "url": "https://github.com/apache/skywalking/commit/ffd4b9f8ce8cd7dd6c8b423871797e3f993cc1f7", "message": "add e2e test", "committedDate": "2020-02-03T16:15:56Z", "type": "commit"}, {"oid": "b374a246780aa8f3b274a20ae36fb5e3c831adea", "url": "https://github.com/apache/skywalking/commit/b374a246780aa8f3b274a20ae36fb5e3c831adea", "message": "enable e2e-influxdb action", "committedDate": "2020-02-03T16:50:27Z", "type": "commit"}, {"oid": "f6e28343f2e1a09a941618eb91bfdb0f4d7ab7f1", "url": "https://github.com/apache/skywalking/commit/f6e28343f2e1a09a941618eb91bfdb0f4d7ab7f1", "message": "revert", "committedDate": "2020-02-03T17:12:14Z", "type": "commit"}, {"oid": "9fdc886985a49f579dd6ede647533cca2f6c8d2d", "url": "https://github.com/apache/skywalking/commit/9fdc886985a49f579dd6ede647533cca2f6c8d2d", "message": "confuse", "committedDate": "2020-02-03T18:59:57Z", "type": "commit"}, {"oid": "f06435eb514cf47cc90741c475502b28b31aab03", "url": "https://github.com/apache/skywalking/commit/f06435eb514cf47cc90741c475502b28b31aab03", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-04T09:49:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU5NzE3OQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374597179", "bodyText": "I don't really recommend to use this kind of codes to get the current class just for logging, java.lang.invoke.MethodHandles#lookup creates new object for every call, which I don't think is necessary, and if you are trying to avoid \"copy-and-paste\" mistakes, why not just use the @Slf4j annotation of Lombok, WDYT @wu-sheng", "author": "kezhenxu94", "createdAt": "2020-02-04T10:44:28Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYzODAyNw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374638027", "bodyText": "Agree. @slf4j good enough for me.", "author": "wu-sheng", "createdAt": "2020-02-04T12:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU5NzE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYwMTg5MA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374601890", "bodyText": "As private methods cannot be meaningfully overridden, declaring them final is redundant.", "author": "kezhenxu94", "createdAt": "2020-02-04T10:54:10Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/AggregationQuery.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.query.entity.Order;\n+import org.apache.skywalking.oap.server.core.query.entity.TopNEntity;\n+import org.apache.skywalking.oap.server.core.register.EndpointInventory;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelName;\n+import org.apache.skywalking.oap.server.core.storage.query.IAggregationQueryDAO;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.SelectSubQueryImpl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.List;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.*;\n+\n+public class AggregationQuery implements IAggregationQueryDAO {\n+    private static final Logger LOG = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private final InfluxClient client;\n+\n+    public AggregationQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getServiceTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                           long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getAllServiceInstanceTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                                      long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getServiceInstanceTopN(int serviceId, String indName, String valueCName, int topN, Downsampling downsampling,\n+                                                   long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(ServiceInstanceInventory.SERVICE_ID, serviceId, indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getAllEndpointTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                               long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getEndpointTopN(int serviceId, String indName, String valueCName, int topN, Downsampling downsampling,\n+                                            long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(EndpointInventory.SERVICE_ID, serviceId, indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    private final List<TopNEntity> getTopNEntity(Downsampling downsampling, String name, SelectSubQueryImpl<SelectQueryImpl> subQuery, Order order, int topN) throws IOException {", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxMTI5Ng==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374611296", "bodyText": "remove the @authors please", "author": "kezhenxu94", "createdAt": "2020-02-04T11:15:07Z", "path": "test/e2e/e2e-influxdb/src/main/java/org/apache/skywalking/e2e/sample/client/SampleClientApplication.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.e2e.sample.client;\n+\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.data.jpa.repository.config.EnableJpaRepositories;\n+\n+/**\n+ * @author kezhenxu94\n+ */", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxMjU3MQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374612571", "bodyText": "why add unused method", "author": "kezhenxu94", "createdAt": "2020-02-04T11:18:06Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/model/Model.java", "diffHunk": "@@ -44,5 +48,11 @@ public Model(String name, List<ModelColumn> columns, boolean capableOfTimeSeries\n         this.scopeId = scopeId;\n         this.name = ModelName.build(downsampling, name);\n         this.record = record;\n+        this.storageColumns = Maps.newTreeMap();\n+        columns.forEach(column -> { storageColumns.put(column.getColumnName().getStorageName(), column); });\n+    }\n+\n+    public ModelColumn getColumnByStorageCName(String storageCName) {", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxOTY1Nw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374619657", "bodyText": "use System.lineSeparator() instead of hardcoded \\r\\n", "author": "kezhenxu94", "createdAt": "2020-02-04T11:35:39Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    public static final String TIME = \"time\";\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.setDatabase(database);\n+        influx.enableBatch();\n+    }\n+\n+    public InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + \"\\r\\nSQL Statement: \" + query.getCommand(), e);", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMzQxMA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374623410", "bodyText": "Raw use of parameterized class WhereQueryImpl", "author": "kezhenxu94", "createdAt": "2020-02-04T11:45:00Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.storage.IMetricsDAO;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n+import org.apache.skywalking.oap.server.core.storage.type.StorageDataType;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.UpdateRequest;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.contains;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+public class MetricsDAO implements IMetricsDAO {\n+    private final StorageBuilder<Metrics> storageBuilder;\n+    private final InfluxClient client;\n+\n+    public MetricsDAO(InfluxClient client, StorageBuilder<Metrics> storageBuilder) {\n+        this.client = client;\n+        this.storageBuilder = storageBuilder;\n+    }\n+\n+    @Override\n+    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n+        WhereQueryImpl query = select(\"*::field\")", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MjEyOA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374642128", "bodyText": "There is GeneralStorageTTL existing, the influxdb implementation should be as same as that one, since it also uses the core configuration.", "author": "wu-sheng", "createdAt": "2020-02-04T12:29:59Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxTTLCalculatorProvider.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import org.apache.skywalking.oap.server.core.DataTTLConfig;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.library.module.ModuleDefineHolder;\n+import org.joda.time.DateTime;\n+\n+public class InfluxTTLCalculatorProvider {", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcwODcwMQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374708701", "bodyText": "got it.", "author": "dmsolr", "createdAt": "2020-02-04T14:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MjEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1MzY2NA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374653664", "bodyText": "This class should not change and not relate to this PR, please revert.", "author": "wu-sheng", "createdAt": "2020-02-04T12:55:31Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/Metrics.java", "diffHunk": "@@ -32,8 +35,13 @@\n     public static final String TIME_BUCKET = \"time_bucket\";\n     public static final String ENTITY_ID = \"entity_id\";\n \n-    @Getter @Setter @Column(columnName = TIME_BUCKET) private long timeBucket;\n-    @Getter @Setter private long survivalTime = 0L;\n+    @Getter\n+    @Setter\n+    @Column(columnName = TIME_BUCKET)\n+    private long timeBucket;\n+    @Getter\n+    @Setter\n+    private long survivalTime = 0L;", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1NDMwNQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374654305", "bodyText": "Including all following changes of this class.", "author": "wu-sheng", "createdAt": "2020-02-04T12:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1MzY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1NDYyMA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374654620", "bodyText": "This should not be added.", "author": "wu-sheng", "createdAt": "2020-02-04T12:57:41Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/model/Model.java", "diffHunk": "@@ -35,6 +38,7 @@\n     private final List<ModelColumn> columns;\n     private final int scopeId;\n     private final boolean record;\n+    private final TreeMap<String, ModelColumn> storageColumns;", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1NDg2OQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374654869", "bodyText": "This file format seems not right.", "author": "wu-sheng", "createdAt": "2020-02-04T12:58:14Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/BatchDAO.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import org.apache.skywalking.apm.commons.datacarrier.DataCarrier;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.BulkConsumePool;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.ConsumerPoolFactory;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.IConsumer;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.storage.IBatchDAO;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.PrepareRequest;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.BatchPoints;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+\n+public class  BatchDAO implements IBatchDAO {", "originalCommit": "f06435eb514cf47cc90741c475502b28b31aab03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9ec7039d5ae450b2c9291a2646f607fff6357c37", "url": "https://github.com/apache/skywalking/commit/9ec7039d5ae450b2c9291a2646f607fff6357c37", "message": "Update test/e2e/e2e-influxdb/src/docker/rc.d/rc0-prepare.sh\n\nCo-Authored-By: kezhenxu94 <kezhenxu94@163.com>", "committedDate": "2020-02-04T14:33:08Z", "type": "commit"}, {"oid": "58587c88ce1e34be64ff2b418afda02bc1cfa5ca", "url": "https://github.com/apache/skywalking/commit/58587c88ce1e34be64ff2b418afda02bc1cfa5ca", "message": "fix things as reviewer's comment", "committedDate": "2020-02-04T14:37:07Z", "type": "commit"}, {"oid": "55f57e51d9c204c2f4dabb70a93bf73cb21a68a8", "url": "https://github.com/apache/skywalking/commit/55f57e51d9c204c2f4dabb70a93bf73cb21a68a8", "message": "update license", "committedDate": "2020-02-05T04:21:31Z", "type": "commit"}, {"oid": "edea319291658a911b12e18764302ede55c97a43", "url": "https://github.com/apache/skywalking/commit/edea319291658a911b12e18764302ede55c97a43", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-05T07:51:13Z", "type": "commit"}, {"oid": "bf641a814c65ff2daa7067c2526d480bfd51c83d", "url": "https://github.com/apache/skywalking/commit/bf641a814c65ff2daa7067c2526d480bfd51c83d", "message": "fix things as review", "committedDate": "2020-02-05T07:53:09Z", "type": "commit"}, {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "url": "https://github.com/apache/skywalking/commit/748dce814b1567ec1d1d5878de91b2891e7a75b7", "message": "update", "committedDate": "2020-02-05T07:54:10Z", "type": "commit"}, {"oid": "d1b2860ea6168656f4ac2a4dc03fa03a862a5d6c", "url": "https://github.com/apache/skywalking/commit/d1b2860ea6168656f4ac2a4dc03fa03a862a5d6c", "message": "add document for configure && update configuration", "committedDate": "2020-02-05T08:24:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExNzg2MQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375117861", "bodyText": "Empty comment?", "author": "wu-sheng", "createdAt": "2020-02-05T08:34:41Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ *", "originalCommit": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExODY0OA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375118648", "bodyText": "What does this #get(0) represent?", "author": "wu-sheng", "createdAt": "2020-02-05T08:36:35Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ *\n+ */\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.setDatabase(database);\n+        influx.enableBatch();\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    public InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Request with a {@link Query} to InfluxDB and return a set of {@link QueryResult.Result}s.\n+     *\n+     * @param query\n+     * @return a set of Result.\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Request with one statement to InfluxDB and return a set of {@link QueryResult.Series}s.\n+     *\n+     * @param query\n+     * @return a set of Series\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        return query(query).get(0).getSeries();", "originalCommit": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyODY4OQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375128689", "bodyText": "InfluxDB support user to send a request with multi statements. This is for a single statement in a request(query).\nSo, #get(0) means get the first result of the query.", "author": "dmsolr", "createdAt": "2020-02-05T08:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExODY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzMTE2Ng==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375131166", "bodyText": "Do we use multiple statements? I think #get(0) should be included #query(return series). If we have multiple stat case, we should have a different API.", "author": "wu-sheng", "createdAt": "2020-02-05T09:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExODY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE5MDk4Mw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375190983", "bodyText": "Yes.\nIn ITraceQueryDAO#queryBasicTraces(...), we have 2 statements in a request. The one gets the number of traces, and another recalls all trace data.", "author": "dmsolr", "createdAt": "2020-02-05T11:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExODY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyOTcyOQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375229729", "bodyText": "Could we add a #singleStatementQuery method for most cases?", "author": "wu-sheng", "createdAt": "2020-02-05T12:35:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExODY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI1OTc5MA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376259790", "bodyText": "Sorry, I make a mistake. This method works for single statement. InfluxClient#query() is for multi-statements", "author": "dmsolr", "createdAt": "2020-02-07T08:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExODY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExOTg3Mg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375119872", "bodyText": "Don't see anyone uses this. Please confirm. And queryForDelete is not a good idea. For time-series data, it is better to delete by time bucket only.", "author": "wu-sheng", "createdAt": "2020-02-05T08:39:27Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ *\n+ */\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.setDatabase(database);\n+        influx.enableBatch();\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    public InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Request with a {@link Query} to InfluxDB and return a set of {@link QueryResult.Result}s.\n+     *\n+     * @param query\n+     * @return a set of Result.\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Request with one statement to InfluxDB and return a set of {@link QueryResult.Series}s.\n+     *\n+     * @param query\n+     * @return a set of Series\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        return query(query).get(0).getSeries();\n+    }\n+\n+    /**\n+     * Data management, to drop a time-series by measurement and time-series name specified. If an exception isn't\n+     * thrown, it means execution success.\n+     *\n+     * @param measurement\n+     * @param timeBucket\n+     * @throws IOException\n+     */\n+    public void dropSeries(String measurement, long timeBucket) throws IOException {\n+        Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n+        QueryResult result = getInflux().query(query);\n+\n+        if (result.hasError()) {\n+            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n+        }\n+    }\n+\n+    /**\n+     * Data management, to delete data by a statement. If an exception isn't thrown, it means execution success.\n+     *\n+     * @param statement\n+     * @throws IOException\n+     */\n+    public void queryForDelete(String statement) throws IOException {", "originalCommit": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyODg5OA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375128898", "bodyText": "Yes, I will remove", "author": "dmsolr", "createdAt": "2020-02-05T08:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExOTg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMDIxNg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375120216", "bodyText": "Comments are required.", "author": "wu-sheng", "createdAt": "2020-02-05T08:40:16Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxStorageConfig.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import lombok.Getter;\n+import lombok.Setter;\n+import org.apache.skywalking.oap.server.library.module.ModuleConfig;\n+\n+@Setter\n+@Getter\n+public class InfluxStorageConfig extends ModuleConfig {", "originalCommit": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMTMwOA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375121308", "bodyText": "Is this a blocking write? Meaning, the data is queryable when this method finished.", "author": "wu-sheng", "createdAt": "2020-02-05T08:42:52Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/BatchDAO.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.apm.commons.datacarrier.DataCarrier;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.BulkConsumePool;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.ConsumerPoolFactory;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.IConsumer;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.storage.IBatchDAO;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.PrepareRequest;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.BatchPoints;\n+\n+@Slf4j\n+public class BatchDAO implements IBatchDAO {\n+    private final DataCarrier<PrepareRequest> dataCarrier;\n+    private final InfluxClient client;\n+\n+    public BatchDAO(InfluxClient client) {\n+        this.client = client;\n+\n+        String name = \"INFLUX_ASYNC_BATCH_PERSISTENT\";\n+        BulkConsumePool.Creator creator = new BulkConsumePool.Creator(name, 1, 20L);\n+\n+        try {\n+            ConsumerPoolFactory.INSTANCE.createIfAbsent(name, creator);\n+        } catch (Exception e) {\n+            throw new UnexpectedException(e.getMessage(), e);\n+        }\n+\n+        this.dataCarrier = new DataCarrier(1, 10000);\n+        this.dataCarrier.consume(ConsumerPoolFactory.INSTANCE.get(name), new InfluxBatchConsumer(this));\n+    }\n+\n+    @Override\n+    public void asynchronous(InsertRequest insertRequest) {\n+        dataCarrier.produce(insertRequest);\n+    }\n+\n+    @Override\n+    public void synchronous(List<PrepareRequest> prepareRequests) {\n+        if (CollectionUtils.isEmpty(prepareRequests)) {\n+            return;\n+        }\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"batch sql statements execute, data size: {}\", prepareRequests.size());\n+        }\n+\n+        final BatchPoints.Builder builder = BatchPoints.builder();\n+        prepareRequests.forEach(e -> {\n+            builder.point(((InfluxInsertRequest)e).getPoint());\n+        });\n+\n+        client.write(builder.build());", "originalCommit": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2NDEwOQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376264109", "bodyText": "The data is non-blocking write. They are queryable after the method executed.", "author": "dmsolr", "createdAt": "2020-02-07T08:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMTMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMjAyNQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375122025", "bodyText": "Doesn't InfluxDB have an async write mode? I remember time serious DB is good at writing.", "author": "wu-sheng", "createdAt": "2020-02-05T08:44:31Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/BatchDAO.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.apm.commons.datacarrier.DataCarrier;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.BulkConsumePool;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.ConsumerPoolFactory;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.IConsumer;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.storage.IBatchDAO;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.PrepareRequest;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.BatchPoints;\n+\n+@Slf4j\n+public class BatchDAO implements IBatchDAO {\n+    private final DataCarrier<PrepareRequest> dataCarrier;\n+    private final InfluxClient client;\n+\n+    public BatchDAO(InfluxClient client) {\n+        this.client = client;\n+\n+        String name = \"INFLUX_ASYNC_BATCH_PERSISTENT\";\n+        BulkConsumePool.Creator creator = new BulkConsumePool.Creator(name, 1, 20L);\n+\n+        try {\n+            ConsumerPoolFactory.INSTANCE.createIfAbsent(name, creator);\n+        } catch (Exception e) {\n+            throw new UnexpectedException(e.getMessage(), e);\n+        }\n+\n+        this.dataCarrier = new DataCarrier(1, 10000);\n+        this.dataCarrier.consume(ConsumerPoolFactory.INSTANCE.get(name), new InfluxBatchConsumer(this));\n+    }\n+\n+    @Override\n+    public void asynchronous(InsertRequest insertRequest) {\n+        dataCarrier.produce(insertRequest);", "originalCommit": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2MzQwOQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376263409", "bodyText": "Yes, it does. I will fix.", "author": "dmsolr", "createdAt": "2020-02-07T08:20:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMjAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3NjYzNg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376276636", "bodyText": "Then you should not require datacarrier? Right?", "author": "wu-sheng", "createdAt": "2020-02-07T08:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMjAyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMjQ2Mw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375122463", "bodyText": "=?", "author": "wu-sheng", "createdAt": "2020-02-05T08:45:26Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ *\n+ */\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.setDatabase(database);\n+        influx.enableBatch();\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    public InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Request with a {@link Query} to InfluxDB and return a set of {@link QueryResult.Result}s.\n+     *\n+     * @param query\n+     * @return a set of Result.\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Request with one statement to InfluxDB and return a set of {@link QueryResult.Series}s.\n+     *\n+     * @param query\n+     * @return a set of Series\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        return query(query).get(0).getSeries();\n+    }\n+\n+    /**\n+     * Data management, to drop a time-series by measurement and time-series name specified. If an exception isn't\n+     * thrown, it means execution success.\n+     *\n+     * @param measurement\n+     * @param timeBucket\n+     * @throws IOException\n+     */\n+    public void dropSeries(String measurement, long timeBucket) throws IOException {\n+        Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");", "originalCommit": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMjg5NA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375122894", "bodyText": "Another #get(0). What does this mean?", "author": "wu-sheng", "createdAt": "2020-02-05T08:46:25Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.storage.IMetricsDAO;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n+import org.apache.skywalking.oap.server.core.storage.type.StorageDataType;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.UpdateRequest;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.contains;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+public class MetricsDAO implements IMetricsDAO {\n+    private final StorageBuilder<Metrics> storageBuilder;\n+    private final InfluxClient client;\n+\n+    public MetricsDAO(InfluxClient client, StorageBuilder<Metrics> storageBuilder) {\n+        this.client = client;\n+        this.storageBuilder = storageBuilder;\n+    }\n+\n+    @Override\n+    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n+        WhereQueryImpl<SelectQueryImpl> query = select(\"*::field\")\n+            .from(client.getDatabase(), model.getName())\n+            .where(contains(\"id\", Joiner.on(\"|\").join(ids)));\n+        List<QueryResult.Series> series = client.queryForSeries(query);\n+        if (series == null || series.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        final List<Metrics> metrics = Lists.newArrayList();\n+        List<String> columns = series.get(0).getColumns();\n+        Map<String, String> storageAndColumnNames = Maps.newHashMap();\n+        for (ModelColumn column : model.getColumns()) {\n+            storageAndColumnNames.put(column.getColumnName().getName(), column.getColumnName().getStorageName());\n+        }\n+\n+        series.get(0).getValues().forEach(values -> {", "originalCommit": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e6981abf03c5808f8f0054311679fcd0327c449a", "url": "https://github.com/apache/skywalking/commit/e6981abf03c5808f8f0054311679fcd0327c449a", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-07T19:26:00Z", "type": "commit"}, {"oid": "6baae3e4e52941cfcdd9154cbfa6574878f03c62", "url": "https://github.com/apache/skywalking/commit/6baae3e4e52941cfcdd9154cbfa6574878f03c62", "message": "support configure batch options", "committedDate": "2020-02-07T20:32:05Z", "type": "commit"}, {"oid": "800f4de7e56338d29dc0725df34ba201cb644bd8", "url": "https://github.com/apache/skywalking/commit/800f4de7e56338d29dc0725df34ba201cb644bd8", "message": "support to configure batchOptions && polish && implement ProfileThreadSnapshotQuery", "committedDate": "2020-02-07T20:34:43Z", "type": "commit"}, {"oid": "cbbcf22e7cdcfdf2af6d065466248c1139dcf91f", "url": "https://github.com/apache/skywalking/commit/cbbcf22e7cdcfdf2af6d065466248c1139dcf91f", "message": "add e2e-ttl", "committedDate": "2020-02-07T20:36:38Z", "type": "commit"}, {"oid": "fb1b87538d949f3a2b87e2e14836f931312ee1b7", "url": "https://github.com/apache/skywalking/commit/fb1b87538d949f3a2b87e2e14836f931312ee1b7", "message": "fix checkstyle", "committedDate": "2020-02-07T20:46:58Z", "type": "commit"}, {"oid": "47a6028c86ab31be83866cae43cdf0481083c96b", "url": "https://github.com/apache/skywalking/commit/47a6028c86ab31be83866cae43cdf0481083c96b", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-08T06:50:32Z", "type": "commit"}, {"oid": "6df13a1ea91fe07c2acef9669cf956cc434c3277", "url": "https://github.com/apache/skywalking/commit/6df13a1ea91fe07c2acef9669cf956cc434c3277", "message": "update", "committedDate": "2020-02-08T08:47:18Z", "type": "commit"}, {"oid": "c148bfb6bd5ed585e39a1e1bdc2dfe061fd511f8", "url": "https://github.com/apache/skywalking/commit/c148bfb6bd5ed585e39a1e1bdc2dfe061fd511f8", "message": "merge", "committedDate": "2020-02-08T08:55:39Z", "type": "commit"}, {"oid": "2bd17170a147a1c53822eb11057d667937826392", "url": "https://github.com/apache/skywalking/commit/2bd17170a147a1c53822eb11057d667937826392", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-08T13:56:51Z", "type": "commit"}, {"oid": "8caa64da9968347afe31654b89764b9f83e05389", "url": "https://github.com/apache/skywalking/commit/8caa64da9968347afe31654b89764b9f83e05389", "message": "remove proto from e2e-ttl-influxbd && enable e2e-profile action", "committedDate": "2020-02-08T17:47:22Z", "type": "commit"}, {"oid": "f3b2563433deb525691eef534a5989c76c5cb583", "url": "https://github.com/apache/skywalking/commit/f3b2563433deb525691eef534a5989c76c5cb583", "message": "add influxdb to e2e-profile", "committedDate": "2020-02-08T19:21:01Z", "type": "commit"}, {"oid": "4cd472eb7adae926776fe0a4c97ecd3fc35278be", "url": "https://github.com/apache/skywalking/commit/4cd472eb7adae926776fe0a4c97ecd3fc35278be", "message": "fix missing ProfileTask in PointBuilder", "committedDate": "2020-02-08T19:30:02Z", "type": "commit"}, {"oid": "30408ed101f5b246229141766e22f541e8b64c1d", "url": "https://github.com/apache/skywalking/commit/30408ed101f5b246229141766e22f541e8b64c1d", "message": "Simplify InfluxClient API", "committedDate": "2020-02-08T20:33:57Z", "type": "commit"}, {"oid": "12414c80e1819ccdd6d774bede6d9d33fe6af457", "url": "https://github.com/apache/skywalking/commit/12414c80e1819ccdd6d774bede6d9d33fe6af457", "message": "update docker/docket-entrypoint.sh", "committedDate": "2020-02-08T20:34:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjE3NQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376746175", "bodyText": "I think this should be private to avoid misuse", "author": "wu-sheng", "createdAt": "2020-02-09T01:02:43Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,203 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ * InfluxDB connection maintainer, provides base data write/query API.\n+ */\n+@Slf4j\n+public class InfluxClient implements Client {\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.enableBatch(config.getActions(), config.getDuration(), TimeUnit.MILLISECONDS);\n+        influx.setDatabase(database);\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB.\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    public InfluxDB getInflux() {", "originalCommit": "12414c80e1819ccdd6d774bede6d9d33fe6af457", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "edddb52ef2d76922b008a28b2c1746dc504cbe81", "url": "https://github.com/apache/skywalking/commit/edddb52ef2d76922b008a28b2c1746dc504cbe81", "message": "fix missing record", "committedDate": "2020-02-09T06:28:20Z", "type": "commit"}, {"oid": "ab75c86a570cf949e6ec6be1f27d3b45b1917278", "url": "https://github.com/apache/skywalking/commit/ab75c86a570cf949e6ec6be1f27d3b45b1917278", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-09T08:38:29Z", "type": "commit"}, {"oid": "0a1420e8a308496cabfc10019f3270045c27ac7a", "url": "https://github.com/apache/skywalking/commit/0a1420e8a308496cabfc10019f3270045c27ac7a", "message": "update", "committedDate": "2020-02-10T14:33:36Z", "type": "commit"}, {"oid": "62bd2acfcc1c44e41af7fc096f671ffb250fe148", "url": "https://github.com/apache/skywalking/commit/62bd2acfcc1c44e41af7fc096f671ffb250fe148", "message": "refactor PointBuilder: Record conver to Point", "committedDate": "2020-02-10T15:00:50Z", "type": "commit"}, {"oid": "40787a28bcd021f8f56758114eae2bf0247bbc47", "url": "https://github.com/apache/skywalking/commit/40787a28bcd021f8f56758114eae2bf0247bbc47", "message": "update", "committedDate": "2020-02-10T16:46:10Z", "type": "commit"}, {"oid": "f8545f2489a0dfefbb15a302830323361cfef164", "url": "https://github.com/apache/skywalking/commit/f8545f2489a0dfefbb15a302830323361cfef164", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-11T06:43:41Z", "type": "commit"}, {"oid": "9efd063e08e2915588fef97143e3584aa1507ecf", "url": "https://github.com/apache/skywalking/commit/9efd063e08e2915588fef97143e3584aa1507ecf", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-11T09:34:27Z", "type": "commit"}, {"oid": "4fda55d30f5fc52400eb7c976fb92304d42d2ad4", "url": "https://github.com/apache/skywalking/commit/4fda55d30f5fc52400eb7c976fb92304d42d2ad4", "message": "reformat and new methods implemented", "committedDate": "2020-02-11T10:40:06Z", "type": "commit"}, {"oid": "3661485c8c5af09001be9eda2206fb41829ad616", "url": "https://github.com/apache/skywalking/commit/3661485c8c5af09001be9eda2206fb41829ad616", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-11T12:38:10Z", "type": "commit"}, {"oid": "0c5867f24b32ed2731126c51db0a18c0ffec8d7a", "url": "https://github.com/apache/skywalking/commit/0c5867f24b32ed2731126c51db0a18c0ffec8d7a", "message": "enable e2e-cluster action with influxdb", "committedDate": "2020-02-11T14:57:00Z", "type": "commit"}, {"oid": "69a2b579ff69cf6e06b603c678bc3b31ae930d8f", "url": "https://github.com/apache/skywalking/commit/69a2b579ff69cf6e06b603c678bc3b31ae930d8f", "message": "polish", "committedDate": "2020-02-11T15:18:27Z", "type": "commit"}, {"oid": "13719f30d07339316b707993d38b2de3e136e17b", "url": "https://github.com/apache/skywalking/commit/13719f30d07339316b707993d38b2de3e136e17b", "message": "update e2e-container to 1.4", "committedDate": "2020-02-11T15:40:08Z", "type": "commit"}, {"oid": "4c06a1dca76b9cd931cb41f3e0183b53e264e174", "url": "https://github.com/apache/skywalking/commit/4c06a1dca76b9cd931cb41f3e0183b53e264e174", "message": "update", "committedDate": "2020-02-11T15:45:33Z", "type": "commit"}, {"oid": "918673d7bec7906c4fef7f304cc86eca1534df99", "url": "https://github.com/apache/skywalking/commit/918673d7bec7906c4fef7f304cc86eca1534df99", "message": "fix e2e-profile-influxdb", "committedDate": "2020-02-12T04:20:45Z", "type": "commit"}, {"oid": "767c85af65dc656e770853f1337111d08c58e586", "url": "https://github.com/apache/skywalking/commit/767c85af65dc656e770853f1337111d08c58e586", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-12T07:35:56Z", "type": "commit"}, {"oid": "5c4100657696a7a04c16ff367b23afd24477a42f", "url": "https://github.com/apache/skywalking/commit/5c4100657696a7a04c16ff367b23afd24477a42f", "message": "fix e2e issue", "committedDate": "2020-02-12T11:07:53Z", "type": "commit"}, {"oid": "c79dc599042b49b735f09cacf6d5a113511e3dd3", "url": "https://github.com/apache/skywalking/commit/c79dc599042b49b735f09cacf6d5a113511e3dd3", "message": "Merge branch 'influx-storage' of https://github.com/dmsolr/skywalking into influx-storage", "committedDate": "2020-02-12T11:08:59Z", "type": "commit"}, {"oid": "d21d1fc7609bd946bb9117042dfca3eee8eef302", "url": "https://github.com/apache/skywalking/commit/d21d1fc7609bd946bb9117042dfca3eee8eef302", "message": "fix e2e issue", "committedDate": "2020-02-13T00:57:22Z", "type": "commit"}, {"oid": "56f360e9aa91e1f04074d642f007ce142c68af91", "url": "https://github.com/apache/skywalking/commit/56f360e9aa91e1f04074d642f007ce142c68af91", "message": "fix metabase configuration", "committedDate": "2020-02-13T07:20:21Z", "type": "commit"}, {"oid": "58c5674a7be0efa5c67e98c97e314f4f35cdf88d", "url": "https://github.com/apache/skywalking/commit/58c5674a7be0efa5c67e98c97e314f4f35cdf88d", "message": "checkstyle", "committedDate": "2020-02-13T07:27:21Z", "type": "commit"}, {"oid": "2896232f45b5f0feafb04b948e8f0144739d1a5c", "url": "https://github.com/apache/skywalking/commit/2896232f45b5f0feafb04b948e8f0144739d1a5c", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-13T08:10:49Z", "type": "commit"}, {"oid": "0580a4ae05a121bb1e70588f01c05dfdc6d58d2d", "url": "https://github.com/apache/skywalking/commit/0580a4ae05a121bb1e70588f01c05dfdc6d58d2d", "message": "rename metabase's configuration name", "committedDate": "2020-02-13T08:58:32Z", "type": "commit"}, {"oid": "3d45e9d35f6f5d2bd19545064beb757d5eed4874", "url": "https://github.com/apache/skywalking/commit/3d45e9d35f6f5d2bd19545064beb757d5eed4874", "message": "upset", "committedDate": "2020-02-13T09:57:18Z", "type": "commit"}, {"oid": "c3838428d5feb0027fc6d06bcc2b178ca347b5bf", "url": "https://github.com/apache/skywalking/commit/c3838428d5feb0027fc6d06bcc2b178ca347b5bf", "message": "fix e2e-issue", "committedDate": "2020-02-13T11:30:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg0Njk0Nw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r378846947", "bodyText": "From here, all comments about @param and @return are either empty and meaningless. Could you fix this?", "author": "wu-sheng", "createdAt": "2020-02-13T13:05:32Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ * InfluxDB connection maintainer, provides base data write/query API.\n+ */\n+@Slf4j\n+public class InfluxClient implements Client {\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+                                         new OkHttpClient.Builder().readTimeout(3, TimeUnit.MINUTES)\n+                                                                   .writeTimeout(3, TimeUnit.MINUTES),\n+                                         InfluxDB.ResponseFormat.MSGPACK\n+        );\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.enableBatch(config.getActions(), config.getDuration(), TimeUnit.MILLISECONDS);\n+        influx.setDatabase(database);\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB.\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    private InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB and return a set of {@link QueryResult.Result}s. Normally, InfluxDB supports\n+     * combining multiple statements into one query, so that we do get multi-results.\n+     *\n+     * @param query Query\n+     * @return a set of {@link QueryResult.Result}s.\n+     * @throws IOException if there is an error on the InfluxDB server or communication error.\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB with a single statement.\n+     *\n+     * @param query Query\n+     * @return a set of {@link QueryResult.Series}s\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        List<QueryResult.Result> results = query(query);\n+\n+        if (CollectionUtils.isEmpty(results)) {\n+            return null;\n+        }\n+        return results.get(0).getSeries();\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB with a single statement but return a single {@link QueryResult.Series}.\n+     *\n+     * @param query Query\n+     * @return {@link QueryResult.Series}\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public QueryResult.Series queryForSingleSeries(Query query) throws IOException {\n+        List<QueryResult.Series> series = queryForSeries(query);\n+        if (CollectionUtils.isEmpty(series)) {\n+            return null;\n+        }\n+        return series.get(0);\n+    }\n+\n+    /**\n+     * Data management, to drop a time-series by measurement and time-series name specified. If an exception isn't\n+     * thrown, it means execution success. Notice, drop series don't support to drop series by range\n+     *\n+     * @param measurement String\n+     * @param timeBucket  long\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public void dropSeries(String measurement, long timeBucket) throws IOException {\n+        Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n+        QueryResult result = getInflux().query(query);\n+\n+        if (result.hasError()) {\n+            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n+        }\n+    }\n+\n+    public void deleteByQuery(String measurement, long timestamp) throws IOException {\n+        this.query(new Query(\"delete from \" + measurement + \" where time < \" + timestamp + \"ms\"));\n+    }\n+\n+    /**\n+     * Write a {@link Point} into InfluxDB. Note that, the {@link Point} is written into buffer of InfluxDB Client and\n+     * wait for buffer flushing.\n+     *\n+     * @param point Point", "originalCommit": "c3838428d5feb0027fc6d06bcc2b178ca347b5bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyMDkwNw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379220907", "bodyText": "@dmsolr you should put the description after the parameter name and return name, NOT the type of the parameter and return object, they're meaningless, and will cheat the JavaDoc compiler, if they are already self-documented, simply remove the JavaDoc.", "author": "kezhenxu94", "createdAt": "2020-02-14T02:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg0Njk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MDQwMA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r378850400", "bodyText": "Could you explain this class a little more? I am a little confused. All existing entities have the shared prepareBatchInsert and prepareBatchUpdate logic without explicit entity name required. Using the literal string name here is highly unstable. These names could be changed in any PR, and new entity could be added.", "author": "wu-sheng", "createdAt": "2020-02-13T13:12:48Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/PointBuilder.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.skywalking.apm.commons.datacarrier.common.AtomicRangeInteger;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmRecord;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.record.Record;\n+import org.apache.skywalking.oap.server.core.analysis.topn.TopN;\n+import org.apache.skywalking.oap.server.core.profile.ProfileTaskLogRecord;\n+import org.apache.skywalking.oap.server.core.profile.ProfileThreadSnapshotRecord;\n+import org.apache.skywalking.oap.server.core.storage.StorageData;\n+import org.apache.skywalking.oap.server.core.storage.model.ColumnName;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n+import org.apache.skywalking.oap.server.core.storage.type.StorageDataType;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.Point;\n+\n+import static org.apache.skywalking.oap.server.core.analysis.TimeBucket.getTimestamp;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.ALARM;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.DATABASE_SLOW_STATEMENT;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.HTTP_ACCESS_LOG;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.PROFILE_TASK_LOG;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.PROFILE_TASK_SEGMENT_SNAPSHOT;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.SEGMENT;\n+\n+/**\n+ * A helper help to build a InfluxDB Point from StorageData.\n+ */\n+public class PointBuilder {", "originalCommit": "c3838428d5feb0027fc6d06bcc2b178ca347b5bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e6105b7f01c414b97618106f21e52b760b0e828d", "url": "https://github.com/apache/skywalking/commit/e6105b7f01c414b97618106f21e52b760b0e828d", "message": "update", "committedDate": "2020-02-15T09:26:55Z", "type": "commit"}, {"oid": "6e4375d038cd56498cd7f09365d6002136a3fd44", "url": "https://github.com/apache/skywalking/commit/6e4375d038cd56498cd7f09365d6002136a3fd44", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-15T12:23:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyODc1Mg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379828752", "bodyText": "mush -> must be", "author": "kezhenxu94", "createdAt": "2020-02-15T12:28:22Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/TimeBucket.java", "diffHunk": "@@ -32,10 +32,119 @@ public static long getRecordTimeBucket(long time) {\n         return getTimeBucket(time, Downsampling.Second);\n     }\n \n+    /**\n+     * Record time bucket format in Minute Unit.\n+     *\n+     * @param time Timestamp\n+     * @return time in minute format.\n+     */\n     public static long getMinuteTimeBucket(long time) {\n         return getTimeBucket(time, Downsampling.Minute);\n     }\n \n+    /**\n+     * Convert TimeBucket to Timestamp in millisecond.\n+     *\n+     * @param timeBucket long\n+     * @return timestamp in millisecond unit\n+     */\n+    public static long getTimestamp(long timeBucket) {\n+        if (isSecondBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Second);\n+        } else if (isMinuteBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Minute);\n+        } else if (isHourBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Hour);\n+        } else if (isDayBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Day);\n+        } else if (isMonthBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Month);\n+        } else {\n+            throw new UnexpectedException(\"Unknown downsampling value.\");\n+        }\n+    }\n+\n+    /**\n+     * The format of timeBucket in minute Unit is \"yyyyMMddHHmmss\", so which means the TimeBucket mush between", "originalCommit": "6e4375d038cd56498cd7f09365d6002136a3fd44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjI0Ng==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379832246", "bodyText": "better to use org.apache.skywalking.apm.agent.core.base64.Base64 for consistence, and the default charset here is different from other places", "author": "kezhenxu94", "createdAt": "2020-02-15T13:43:20Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/ProfileThreadSnapshotQuery.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.Lists;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Base64;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import org.apache.skywalking.apm.util.StringUtil;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.profile.ProfileThreadSnapshotRecord;\n+import org.apache.skywalking.oap.server.core.query.entity.BasicTrace;\n+import org.apache.skywalking.oap.server.core.storage.profile.IProfileThreadSnapshotQueryDAO;\n+import org.apache.skywalking.oap.server.library.util.BooleanUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.contains;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+public class ProfileThreadSnapshotQuery implements IProfileThreadSnapshotQueryDAO {\n+    private final InfluxClient client;\n+\n+    public ProfileThreadSnapshotQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public List<BasicTrace> queryProfiledSegments(String taskId) throws IOException {\n+        WhereQueryImpl query = select(ProfileThreadSnapshotRecord.SEGMENT_ID)\n+            .from(client.getDatabase(), ProfileThreadSnapshotRecord.INDEX_NAME)\n+            .where()\n+            .and(eq(ProfileThreadSnapshotRecord.TASK_ID, taskId))\n+            .and(eq(ProfileThreadSnapshotRecord.SEQUENCE, 0));\n+\n+        final LinkedList<String> segments = new LinkedList<>();\n+        QueryResult.Series series = client.queryForSingleSeries(query);\n+        if (series == null) {\n+            return Collections.emptyList();\n+        }\n+        series.getValues().forEach(values -> {\n+            segments.add((String) values.get(1));\n+        });\n+\n+        if (segments.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        query = select()\n+            .function(\"bottom\", SegmentRecord.START_TIME, segments.size())\n+            .column(SegmentRecord.SEGMENT_ID)\n+            .column(SegmentRecord.START_TIME)\n+            .column(SegmentRecord.ENDPOINT_NAME)\n+            .column(SegmentRecord.LATENCY)\n+            .column(SegmentRecord.IS_ERROR)\n+            .column(SegmentRecord.TRACE_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where()\n+            .and(contains(SegmentRecord.SEGMENT_ID, Joiner.on(\"|\").join(segments)));\n+\n+        ArrayList<BasicTrace> result = Lists.newArrayListWithCapacity(segments.size());\n+        client.queryForSingleSeries(query)\n+              .getValues()\n+              .stream()\n+              .sorted((a, b) -> Long.compare(((Number) b.get(1)).longValue(), ((Number) a.get(1)).longValue()))\n+              .forEach(values -> {\n+                  BasicTrace basicTrace = new BasicTrace();\n+\n+                  basicTrace.setSegmentId((String) values.get(2));\n+                  basicTrace.setStart(String.valueOf(values.get(3)));\n+                  basicTrace.getEndpointNames().add((String) values.get(4));\n+                  basicTrace.setDuration((int) values.get(5));\n+                  basicTrace.setError(BooleanUtils.valueToBoolean((int) values.get(6)));\n+                  String traceIds = (String) values.get(7);\n+                  basicTrace.getTraceIds().add(traceIds);\n+\n+                  result.add(basicTrace);\n+              });\n+\n+        return result;\n+    }\n+\n+    @Override\n+    public int queryMinSequence(String segmentId, long start, long end) throws IOException {\n+        return querySequenceWithAgg(\"min\", segmentId, start, end);\n+    }\n+\n+    @Override\n+    public int queryMaxSequence(String segmentId, long start, long end) throws IOException {\n+        return querySequenceWithAgg(\"max\", segmentId, start, end);\n+    }\n+\n+    @Override\n+    public List<ProfileThreadSnapshotRecord> queryRecords(String segmentId, int minSequence,\n+                                                          int maxSequence) throws IOException {\n+        WhereQueryImpl query = select(\n+            ProfileThreadSnapshotRecord.TASK_ID,\n+            ProfileThreadSnapshotRecord.SEGMENT_ID,\n+            ProfileThreadSnapshotRecord.DUMP_TIME,\n+            ProfileThreadSnapshotRecord.SEQUENCE,\n+            ProfileThreadSnapshotRecord.STACK_BINARY\n+        )\n+            .from(client.getDatabase(), ProfileThreadSnapshotRecord.INDEX_NAME)\n+            .where(eq(ProfileThreadSnapshotRecord.SEGMENT_ID, segmentId))\n+            .and(gte(ProfileThreadSnapshotRecord.SEQUENCE, minSequence))\n+            .and(lte(ProfileThreadSnapshotRecord.SEQUENCE, maxSequence));\n+\n+        ArrayList<ProfileThreadSnapshotRecord> result = new ArrayList<>(maxSequence - minSequence);\n+        client.queryForSingleSeries(query).getValues().forEach(values -> {\n+            ProfileThreadSnapshotRecord record = new ProfileThreadSnapshotRecord();\n+\n+            record.setTaskId((String) values.get(1));\n+            record.setSegmentId((String) values.get(2));\n+            record.setDumpTime(((Number) values.get(3)).longValue());\n+            record.setSequence((int) values.get(4));\n+            String dataBinaryBase64 = String.valueOf(values.get(5));\n+            if (StringUtil.isNotEmpty(dataBinaryBase64)) {\n+                record.setStackBinary(Base64.getDecoder().decode(dataBinaryBase64));", "originalCommit": "6e4375d038cd56498cd7f09365d6002136a3fd44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg3OTk1Mg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379879952", "bodyText": "This class is included in skywaking-agent-core module. We don't import it.", "author": "dmsolr", "createdAt": "2020-02-16T06:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjcyNQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379832725", "bodyText": "is there any particular reason why you paginate here instead of paginating in InfluxDB server side (using the .limit)?\nwhy do you sort them again in a different order (SEGMENT_ID?) when you already have top by QueryOrder in line 74 - 80\n\nhope I did not miss any context", "author": "kezhenxu94", "createdAt": "2020-02-15T13:52:29Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/TraceQuery.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Lists;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.Collections;\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.query.entity.BasicTrace;\n+import org.apache.skywalking.oap.server.core.query.entity.QueryOrder;\n+import org.apache.skywalking.oap.server.core.query.entity.Span;\n+import org.apache.skywalking.oap.server.core.query.entity.TraceBrief;\n+import org.apache.skywalking.oap.server.core.query.entity.TraceState;\n+import org.apache.skywalking.oap.server.core.storage.query.ITraceQueryDAO;\n+import org.apache.skywalking.oap.server.library.util.BooleanUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.base.RecordDAO;\n+import org.elasticsearch.common.Strings;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+import org.influxdb.querybuilder.clauses.Clause;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.regex;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+@Slf4j\n+public class TraceQuery implements ITraceQueryDAO {\n+    private final InfluxClient client;\n+\n+    public TraceQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public TraceBrief queryBasicTraces(long startSecondTB,\n+                                       long endSecondTB,\n+                                       long minDuration,\n+                                       long maxDuration,\n+                                       String endpointName,\n+                                       int serviceId,\n+                                       int serviceInstanceId,\n+                                       int endpointId,\n+                                       String traceId,\n+                                       int limit,\n+                                       int from,\n+                                       TraceState traceState,\n+                                       QueryOrder queryOrder)\n+        throws IOException {\n+\n+        String orderBy = SegmentRecord.START_TIME;\n+        if (queryOrder == QueryOrder.BY_DURATION) {\n+            orderBy = SegmentRecord.LATENCY;\n+        }\n+\n+        WhereQueryImpl<SelectQueryImpl> recallQuery = select()\n+            .function(\"top\", orderBy, limit + from)\n+            .column(SegmentRecord.SEGMENT_ID)\n+            .column(SegmentRecord.START_TIME)\n+            .column(SegmentRecord.ENDPOINT_NAME)\n+            .column(SegmentRecord.LATENCY)\n+            .column(SegmentRecord.IS_ERROR)\n+            .column(SegmentRecord.TRACE_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where();\n+\n+        if (startSecondTB != 0 && endSecondTB != 0) {\n+            recallQuery.and(gte(SegmentRecord.TIME_BUCKET, startSecondTB))\n+                       .and(lte(SegmentRecord.TIME_BUCKET, endSecondTB));\n+        }\n+        if (minDuration != 0) {\n+            recallQuery.and(gte(SegmentRecord.LATENCY, minDuration));\n+        }\n+        if (maxDuration != 0) {\n+            recallQuery.and(lte(SegmentRecord.LATENCY, maxDuration));\n+        }\n+        if (!Strings.isNullOrEmpty(endpointName)) {\n+            recallQuery.and(regex(SegmentRecord.ENDPOINT_NAME, \"/\" + endpointName.replaceAll(\"/\", \"\\\\\\\\/\") + \"/\"));\n+        }\n+        if (serviceId != 0) {\n+            recallQuery.and(eq(RecordDAO.TAG_SERVICE_ID, String.valueOf(serviceId)));\n+        }\n+        if (serviceInstanceId != 0) {\n+            recallQuery.and(eq(SegmentRecord.SERVICE_INSTANCE_ID, serviceInstanceId));\n+        }\n+        if (endpointId != 0) {\n+            recallQuery.and(eq(SegmentRecord.ENDPOINT_ID, endpointId));\n+        }\n+        if (!Strings.isNullOrEmpty(traceId)) {\n+            recallQuery.and(eq(SegmentRecord.TRACE_ID, traceId));\n+        }\n+        switch (traceState) {\n+            case ERROR:\n+                recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.TRUE));\n+                break;\n+            case SUCCESS:\n+                recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.FALSE));\n+                break;\n+        }\n+\n+        WhereQueryImpl<SelectQueryImpl> countQuery = select()\n+            .count(SegmentRecord.ENDPOINT_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where();\n+        for (Clause clause : recallQuery.getClauses()) {\n+            countQuery.where(clause);\n+        }\n+        Query query = new Query(countQuery.getCommand() + recallQuery.getCommand());\n+\n+        List<QueryResult.Result> results = client.query(query);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL: {} result set: {}\", query.getCommand(), results);\n+        }\n+        if (results.size() != 2) {\n+            throw new IOException(\"Expecting to get 2 Results, but it is \" + results.size());\n+        }\n+        List<QueryResult.Series> counter = results.get(0).getSeries();\n+        List<QueryResult.Series> result = results.get(1).getSeries();\n+        if (result == null || result.isEmpty()) {\n+            return new TraceBrief();\n+        }\n+\n+        TraceBrief traceBrief = new TraceBrief();\n+        traceBrief.setTotal(((Number) counter.get(0).getValues().get(0).get(1)).intValue());\n+\n+        result.get(0).getValues().stream().sorted((a, b) -> {\n+            return Long.compare(((Number) b.get(1)).longValue(), ((Number) a.get(1)).longValue());\n+        }).skip(from).forEach(values -> {\n+            BasicTrace basicTrace = new BasicTrace();\n+\n+            basicTrace.setSegmentId((String) values.get(2));\n+            basicTrace.setStart(String.valueOf((long) values.get(3)));\n+            basicTrace.getEndpointNames().add((String) values.get(4));\n+            basicTrace.setDuration((int) values.get(5));\n+            basicTrace.setError(BooleanUtils.valueToBoolean((int) values.get(6)));\n+            basicTrace.getTraceIds().add((String) values.get(7));\n+\n+            traceBrief.getTraces().add(basicTrace);\n+        });", "originalCommit": "6e4375d038cd56498cd7f09365d6002136a3fd44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2MzcxMg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379863712", "bodyText": "It took me a lot of time to get it clearly. It is a bad story.\n\ntop/bottom cannot work with limit.\nI think top/bottom collects data by PriorityQueue. And it does not re-sort them in the result set. So we get the dataset unorder. Anyway, we always get the un-ordered result set in reality.\n\nI mean, the function top works after limit, if limit enabled.", "author": "dmsolr", "createdAt": "2020-02-15T23:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2NzAzMg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379867032", "bodyText": "Resolved\nThe question is more about why you sort them in a different order without taking care of the given orderBy", "author": "kezhenxu94", "createdAt": "2020-02-16T01:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2NzEyOQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379867129", "bodyText": "And there may be performance issue when paging deeply", "author": "kezhenxu94", "createdAt": "2020-02-16T01:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg3OTQxMA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379879410", "bodyText": "I got it. InfluxDB only ORDER BY time supported at this time. As far as I know, most of TSDB have the same issue.", "author": "dmsolr", "createdAt": "2020-02-16T06:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjg3MQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379832871", "bodyText": "All the WhereQueryImpl may be replaced by  org.influxdb.dto.Query?", "author": "kezhenxu94", "createdAt": "2020-02-15T13:54:54Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/TraceQuery.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Lists;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.Collections;\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.query.entity.BasicTrace;\n+import org.apache.skywalking.oap.server.core.query.entity.QueryOrder;\n+import org.apache.skywalking.oap.server.core.query.entity.Span;\n+import org.apache.skywalking.oap.server.core.query.entity.TraceBrief;\n+import org.apache.skywalking.oap.server.core.query.entity.TraceState;\n+import org.apache.skywalking.oap.server.core.storage.query.ITraceQueryDAO;\n+import org.apache.skywalking.oap.server.library.util.BooleanUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.base.RecordDAO;\n+import org.elasticsearch.common.Strings;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+import org.influxdb.querybuilder.clauses.Clause;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.regex;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+@Slf4j\n+public class TraceQuery implements ITraceQueryDAO {\n+    private final InfluxClient client;\n+\n+    public TraceQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public TraceBrief queryBasicTraces(long startSecondTB,\n+                                       long endSecondTB,\n+                                       long minDuration,\n+                                       long maxDuration,\n+                                       String endpointName,\n+                                       int serviceId,\n+                                       int serviceInstanceId,\n+                                       int endpointId,\n+                                       String traceId,\n+                                       int limit,\n+                                       int from,\n+                                       TraceState traceState,\n+                                       QueryOrder queryOrder)\n+        throws IOException {\n+\n+        String orderBy = SegmentRecord.START_TIME;\n+        if (queryOrder == QueryOrder.BY_DURATION) {\n+            orderBy = SegmentRecord.LATENCY;\n+        }\n+\n+        WhereQueryImpl<SelectQueryImpl> recallQuery = select()\n+            .function(\"top\", orderBy, limit + from)\n+            .column(SegmentRecord.SEGMENT_ID)\n+            .column(SegmentRecord.START_TIME)\n+            .column(SegmentRecord.ENDPOINT_NAME)\n+            .column(SegmentRecord.LATENCY)\n+            .column(SegmentRecord.IS_ERROR)\n+            .column(SegmentRecord.TRACE_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where();\n+\n+        if (startSecondTB != 0 && endSecondTB != 0) {\n+            recallQuery.and(gte(SegmentRecord.TIME_BUCKET, startSecondTB))\n+                       .and(lte(SegmentRecord.TIME_BUCKET, endSecondTB));\n+        }\n+        if (minDuration != 0) {\n+            recallQuery.and(gte(SegmentRecord.LATENCY, minDuration));\n+        }\n+        if (maxDuration != 0) {\n+            recallQuery.and(lte(SegmentRecord.LATENCY, maxDuration));\n+        }\n+        if (!Strings.isNullOrEmpty(endpointName)) {\n+            recallQuery.and(regex(SegmentRecord.ENDPOINT_NAME, \"/\" + endpointName.replaceAll(\"/\", \"\\\\\\\\/\") + \"/\"));\n+        }\n+        if (serviceId != 0) {\n+            recallQuery.and(eq(RecordDAO.TAG_SERVICE_ID, String.valueOf(serviceId)));\n+        }\n+        if (serviceInstanceId != 0) {\n+            recallQuery.and(eq(SegmentRecord.SERVICE_INSTANCE_ID, serviceInstanceId));\n+        }\n+        if (endpointId != 0) {\n+            recallQuery.and(eq(SegmentRecord.ENDPOINT_ID, endpointId));\n+        }\n+        if (!Strings.isNullOrEmpty(traceId)) {\n+            recallQuery.and(eq(SegmentRecord.TRACE_ID, traceId));\n+        }\n+        switch (traceState) {\n+            case ERROR:\n+                recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.TRUE));\n+                break;\n+            case SUCCESS:\n+                recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.FALSE));\n+                break;\n+        }\n+\n+        WhereQueryImpl<SelectQueryImpl> countQuery = select()\n+            .count(SegmentRecord.ENDPOINT_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where();\n+        for (Clause clause : recallQuery.getClauses()) {\n+            countQuery.where(clause);\n+        }\n+        Query query = new Query(countQuery.getCommand() + recallQuery.getCommand());\n+\n+        List<QueryResult.Result> results = client.query(query);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL: {} result set: {}\", query.getCommand(), results);\n+        }\n+        if (results.size() != 2) {\n+            throw new IOException(\"Expecting to get 2 Results, but it is \" + results.size());\n+        }\n+        List<QueryResult.Series> counter = results.get(0).getSeries();\n+        List<QueryResult.Series> result = results.get(1).getSeries();\n+        if (result == null || result.isEmpty()) {\n+            return new TraceBrief();\n+        }\n+\n+        TraceBrief traceBrief = new TraceBrief();\n+        traceBrief.setTotal(((Number) counter.get(0).getValues().get(0).get(1)).intValue());\n+\n+        result.get(0).getValues().stream().sorted((a, b) -> {\n+            return Long.compare(((Number) b.get(1)).longValue(), ((Number) a.get(1)).longValue());\n+        }).skip(from).forEach(values -> {\n+            BasicTrace basicTrace = new BasicTrace();\n+\n+            basicTrace.setSegmentId((String) values.get(2));\n+            basicTrace.setStart(String.valueOf((long) values.get(3)));\n+            basicTrace.getEndpointNames().add((String) values.get(4));\n+            basicTrace.setDuration((int) values.get(5));\n+            basicTrace.setError(BooleanUtils.valueToBoolean((int) values.get(6)));\n+            basicTrace.getTraceIds().add((String) values.get(7));\n+\n+            traceBrief.getTraces().add(basicTrace);\n+        });\n+        return traceBrief;\n+    }\n+\n+    @Override\n+    public List<SegmentRecord> queryByTraceId(String traceId) throws IOException {\n+        WhereQueryImpl query = select().column(SegmentRecord.SEGMENT_ID)", "originalCommit": "6e4375d038cd56498cd7f09365d6002136a3fd44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2MzYwNg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379863606", "bodyText": "Could you explain more? WhereQueryImpl is harmless and easy to append clauses.", "author": "dmsolr", "createdAt": "2020-02-15T23:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2NzUxMQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379867511", "bodyText": "Could you explain more? WhereQueryImpl is harmless and easy to append clauses.\n\n\nProgram to interface not Impl\nWhereQueryImpl is generic-typed, but you simply ignored them, causing many warnings\n\nAnyway, just ignore if you don\u2019t care the warnings", "author": "kezhenxu94", "createdAt": "2020-02-16T01:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMzExMQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379833111", "bodyText": "did not find related documentation, but will .raw(\"*::field\") be more efficient?", "author": "kezhenxu94", "createdAt": "2020-02-15T13:59:16Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.storage.IMetricsDAO;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n+import org.apache.skywalking.oap.server.core.storage.type.StorageDataType;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.UpdateRequest;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.contains;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+public class MetricsDAO implements IMetricsDAO {\n+    public static final String TAG_ENTITY_ID = \"_entity_id\";\n+\n+    private final StorageBuilder<Metrics> storageBuilder;\n+    private final InfluxClient client;\n+\n+    public MetricsDAO(InfluxClient client, StorageBuilder<Metrics> storageBuilder) {\n+        this.client = client;\n+        this.storageBuilder = storageBuilder;\n+    }\n+\n+    @Override\n+    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n+        WhereQueryImpl<SelectQueryImpl> query = select()\n+            .regex(\"*::field\")", "originalCommit": "6e4375d038cd56498cd7f09365d6002136a3fd44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2MzY1Mg==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379863652", "bodyText": "They are different in name only.\nIf you think raw is more appropiate, I will fix them.", "author": "dmsolr", "createdAt": "2020-02-15T23:55:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMzExMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMzUzNA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379833534", "bodyText": "why do you need this? seems the limit doesn't include the offset", "author": "kezhenxu94", "createdAt": "2020-02-15T14:06:44Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/LogQuery.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord;\n+import org.apache.skywalking.oap.server.core.query.entity.ContentType;\n+import org.apache.skywalking.oap.server.core.query.entity.Log;\n+import org.apache.skywalking.oap.server.core.query.entity.LogState;\n+import org.apache.skywalking.oap.server.core.query.entity.Logs;\n+import org.apache.skywalking.oap.server.core.query.entity.Pagination;\n+import org.apache.skywalking.oap.server.core.storage.query.ILogQueryDAO;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.base.RecordDAO;\n+import org.elasticsearch.common.Strings;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+import org.influxdb.querybuilder.clauses.ConjunctionClause;\n+\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.CONTENT;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.CONTENT_TYPE;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.ENDPOINT_ID;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.IS_ERROR;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.SERVICE_ID;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.SERVICE_INSTANCE_ID;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.STATUS_CODE;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.TIMESTAMP;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.TRACE_ID;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+@Slf4j\n+public class LogQuery implements ILogQueryDAO {\n+    private final InfluxClient client;\n+\n+    public LogQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public Logs queryLogs(String metricName, int serviceId, int serviceInstanceId, int endpointId, String traceId,\n+                          LogState state, String stateCode, Pagination paging, int from, int limit,\n+                          long startTB, long endTB) throws IOException {\n+        WhereQueryImpl<SelectQueryImpl> recallQuery = select().regex(\"*::field\")\n+            .from(client.getDatabase(), metricName)\n+            .where();\n+        if (serviceId != Const.NONE) {\n+            recallQuery.and(eq(RecordDAO.TAG_SERVICE_ID, String.valueOf(serviceId)));\n+        }\n+        if (serviceInstanceId != Const.NONE) {\n+            recallQuery.and(eq(SERVICE_INSTANCE_ID, serviceInstanceId));\n+        }\n+        if (endpointId != Const.NONE) {\n+            recallQuery.and(eq(ENDPOINT_ID, endpointId));\n+        }\n+        if (!Strings.isNullOrEmpty(traceId)) {\n+            recallQuery.and(eq(TRACE_ID, traceId));\n+        }\n+        switch (state) {\n+            case ERROR: {\n+                recallQuery.and(eq(IS_ERROR, true));\n+                break;\n+            }\n+            case SUCCESS: {\n+                recallQuery.and(eq(IS_ERROR, false));\n+                break;\n+            }\n+        }\n+        if (!Strings.isNullOrEmpty(stateCode)) {\n+            recallQuery.and(eq(STATUS_CODE, stateCode));\n+        }\n+        recallQuery.and(gte(AbstractLogRecord.TIME_BUCKET, startTB))\n+                   .and(lte(AbstractLogRecord.TIME_BUCKET, endTB));\n+\n+        if (from > Const.NONE) {\n+            limit += from;", "originalCommit": "6e4375d038cd56498cd7f09365d6002136a3fd44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c89569139575f2433d9ca765831c9883ea4d84c6", "url": "https://github.com/apache/skywalking/commit/c89569139575f2433d9ca765831c9883ea4d84c6", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-16T01:04:02Z", "type": "commit"}, {"oid": "7997153876604bd96aee55506e6d942cce01a98a", "url": "https://github.com/apache/skywalking/commit/7997153876604bd96aee55506e6d942cce01a98a", "message": "fix typo and scape $", "committedDate": "2020-02-16T07:26:12Z", "type": "commit"}, {"oid": "13698b55ed1e501475fa4069d0fcadd133b581c5", "url": "https://github.com/apache/skywalking/commit/13698b55ed1e501475fa4069d0fcadd133b581c5", "message": "fix limit", "committedDate": "2020-02-16T07:32:37Z", "type": "commit"}, {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565", "url": "https://github.com/apache/skywalking/commit/a4e13a6f18019cb17f0092a696dcfc3631a15565", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-16T14:17:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MDg4Mw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380040883", "bodyText": "There is another missing here, PROFILE_TASK_LOG. Could you check why this is missed but still tests passed? Does InfluxDB have the profile e2e?", "author": "wu-sheng", "createdAt": "2020-02-17T08:32:45Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/installer/MetaTableDefine.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.installer;\n+\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.storage.plugin.jdbc.TableMetaInfo;\n+\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.ENDPOINT_INVENTORY;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.NETWORK_ADDRESS;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.PROFILE_TASK;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.PROFILE_TASK_SEGMENT_SNAPSHOT;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.SERVICE_INSTANCE_INVENTORY;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.SERVICE_INVENTORY;\n+\n+/**\n+ * Here defines which table is stored in metadata database(H2/MySQL).\n+ */\n+public class MetaTableDefine {\n+\n+    /**\n+     * Test a {@link Model} is stored in H2/MySQL or not.\n+     *\n+     * @param model Model\n+     * @return true if the {@link Model} is stored in H2/MySQL\n+     */\n+    public static boolean contains(Model model) {\n+        switch (model.getScopeId()) {\n+            case SERVICE_INVENTORY:\n+            case SERVICE_INSTANCE_INVENTORY:\n+            case NETWORK_ADDRESS:\n+            case ENDPOINT_INVENTORY:\n+            case PROFILE_TASK:", "originalCommit": "a4e13a6f18019cb17f0092a696dcfc3631a15565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0OTk0NA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380049944", "bodyText": "profile_task_log is not metadata. It is stored on InfluxDB.", "author": "dmsolr", "createdAt": "2020-02-17T08:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MDg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA1NDI0NA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380054244", "bodyText": "What is the principle? Could you add some comments and guidelines about this?", "author": "wu-sheng", "createdAt": "2020-02-17T09:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MDg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ0MzU4OA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380443588", "bodyText": "Use model#capableOfTimeSeries == true check. If YES, then it is a metadata table.", "author": "wu-sheng", "createdAt": "2020-02-18T03:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MDg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ0MzY3OA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380443678", "bodyText": "And PROFILE_TASK is not a metadata entity", "author": "wu-sheng", "createdAt": "2020-02-18T03:53:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MDg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NDM0MQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380044341", "bodyText": "As you mentioned last time, the result is unordered. Could you add the comments some places to ease the readers?", "author": "wu-sheng", "createdAt": "2020-02-17T08:40:56Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/AggregationQuery.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Lists;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.query.entity.Order;\n+import org.apache.skywalking.oap.server.core.query.entity.TopNEntity;\n+import org.apache.skywalking.oap.server.core.register.EndpointInventory;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelName;\n+import org.apache.skywalking.oap.server.core.storage.query.IAggregationQueryDAO;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.base.MetricsDAO;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.SelectSubQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+@Slf4j\n+public class AggregationQuery implements IAggregationQueryDAO {\n+    private InfluxClient client;\n+\n+    public AggregationQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getServiceTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                           long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getAllServiceInstanceTopN(String indName, String valueCName, int topN,\n+                                                      Downsampling downsampling,\n+                                                      long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getServiceInstanceTopN(int serviceId, String indName, String valueCName, int topN,\n+                                                   Downsampling downsampling,\n+                                                   long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(\n+            downsampling, indName,\n+            subQuery(ServiceInstanceInventory.SERVICE_ID, serviceId, indName, valueCName, startTB, endTB), order, topN\n+        );\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getAllEndpointTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                               long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getEndpointTopN(int serviceId, String indName, String valueCName, int topN,\n+                                            Downsampling downsampling,\n+                                            long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(\n+            downsampling, indName,\n+            subQuery(EndpointInventory.SERVICE_ID, serviceId, indName, valueCName, startTB, endTB), order, topN\n+        );\n+    }\n+\n+    private List<TopNEntity> getTopNEntity(Downsampling downsampling,\n+                                           String name,\n+                                           SelectSubQueryImpl<SelectQueryImpl> subQuery,\n+                                           Order order,\n+                                           int topN) throws IOException {\n+        String measurement = ModelName.build(downsampling, name);\n+        Comparator<TopNEntity> comparator = DESCENDING;\n+        String functionName = \"top\";\n+        if (order == Order.ASC) {\n+            functionName = \"bottom\";\n+            comparator = ASCENDING;\n+        }\n+\n+        SelectQueryImpl query = select().function(functionName, \"mean\", topN).as(\"value\")\n+                                        .column(MetricsDAO.TAG_ENTITY_ID)\n+                                        .from(client.getDatabase(), measurement);\n+        query.setSubQuery(subQuery);\n+\n+        List<QueryResult.Series> series = client.queryForSeries(query);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL: {} result set: {}\", query.getCommand(), series);\n+        }\n+        if (series == null || series.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        List<List<Object>> dataset = series.get(0).getValues();\n+        List<TopNEntity> entities = Lists.newArrayListWithCapacity(dataset.size());\n+        dataset.forEach(values -> {\n+            final TopNEntity entity = new TopNEntity();\n+            entity.setId((String) values.get(2));\n+            entity.setValue(((Double) values.get(1)).longValue());\n+            entities.add(entity);\n+        });\n+        Collections.sort(entities, comparator);", "originalCommit": "a4e13a6f18019cb17f0092a696dcfc3631a15565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NTM0OQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380045349", "bodyText": "remove this, and those in other files", "author": "kezhenxu94", "createdAt": "2020-02-17T08:43:20Z", "path": "test/e2e/e2e-ttl/e2e-ttl-influxdb/src/test/java/org/apache/skywalking/e2e/StorageTTLITCase.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.skywalking.e2e;\n+\n+import io.grpc.ManagedChannel;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.internal.DnsNameResolverProvider;\n+import io.grpc.netty.NettyChannelBuilder;\n+import io.grpc.stub.StreamObserver;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.apm.network.common.DetectPoint;\n+import org.apache.skywalking.apm.network.servicemesh.MeshProbeDownstream;\n+import org.apache.skywalking.apm.network.servicemesh.Protocol;\n+import org.apache.skywalking.apm.network.servicemesh.ServiceMeshMetric;\n+import org.apache.skywalking.apm.network.servicemesh.ServiceMeshMetricServiceGrpc;\n+import org.apache.skywalking.e2e.metrics.AllOfMetricsMatcher;\n+import org.apache.skywalking.e2e.metrics.AtLeastOneOfMetricsMatcher;\n+import org.apache.skywalking.e2e.metrics.Metrics;\n+import org.apache.skywalking.e2e.metrics.MetricsQuery;\n+import org.apache.skywalking.e2e.metrics.MetricsValueMatcher;\n+import org.apache.skywalking.e2e.service.Service;\n+import org.apache.skywalking.e2e.service.ServicesQuery;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+\n+import static org.apache.skywalking.e2e.metrics.MetricsQuery.SERVICE_RESP_TIME;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+/**\n+ * @author kezhenxu94\n+ */", "originalCommit": "a4e13a6f18019cb17f0092a696dcfc3631a15565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NjE1Nw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380046157", "bodyText": "Why isn't this detected by CI process?", "author": "wu-sheng", "createdAt": "2020-02-17T08:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NTM0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0ODA0NQ==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380048045", "bodyText": "Why isn't this detected by CI process?\n\nCI belongs to the root module and its submodules, e2e and plugin tests are neither of them, maybe set up the same Checkstyle plugin in e2e and plugin tests?", "author": "kezhenxu94", "createdAt": "2020-02-17T08:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NTM0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA1MjAxMA==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380052010", "bodyText": "We don't check ./test directory.", "author": "dmsolr", "createdAt": "2020-02-17T08:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NTM0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA3NzA0Mw==", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380077043", "bodyText": "I think we should do that. Creating an issue to track this?", "author": "wu-sheng", "createdAt": "2020-02-17T09:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NTM0OQ=="}], "type": "inlineReview"}, {"oid": "bc127d72ae89c24acbb54abc10a81c09adca99c0", "url": "https://github.com/apache/skywalking/commit/bc127d72ae89c24acbb54abc10a81c09adca99c0", "message": "Merge branch 'master' into influx-storage", "committedDate": "2020-02-17T09:12:18Z", "type": "commit"}, {"oid": "f32679868000c5e810cf4bdcc0ca2a80f5756e79", "url": "https://github.com/apache/skywalking/commit/f32679868000c5e810cf4bdcc0ca2a80f5756e79", "message": "polish", "committedDate": "2020-02-17T13:38:05Z", "type": "commit"}]}