{"pr_number": 5474, "pr_title": "Alarm support wechat webhook", "pr_createdAt": "2020-09-11T16:10:21Z", "pr_url": "https://github.com/apache/skywalking/pull/5474", "timeline": [{"oid": "0121c7f1b85a9c896c38de69d1dfbfe9c7025adc", "url": "https://github.com/apache/skywalking/commit/0121c7f1b85a9c896c38de69d1dfbfe9c7025adc", "message": "add wechat webhook", "committedDate": "2020-09-11T10:43:53Z", "type": "commit"}, {"oid": "9f9b947c8644cf4e95a02db06a0e2ac39ca397b9", "url": "https://github.com/apache/skywalking/commit/9f9b947c8644cf4e95a02db06a0e2ac39ca397b9", "message": "add wechat hook usage guide", "committedDate": "2020-09-11T15:24:53Z", "type": "commit"}, {"oid": "66272a497a42ad55e2aba1ee4e0334b50584bc31", "url": "https://github.com/apache/skywalking/commit/66272a497a42ad55e2aba1ee4e0334b50584bc31", "message": "fix checkstyle bug", "committedDate": "2020-09-12T00:53:15Z", "type": "commit"}, {"oid": "f09f8ba32b1d9f82a68817cea46d733430e6ad1b", "url": "https://github.com/apache/skywalking/commit/f09f8ba32b1d9f82a68817cea46d733430e6ad1b", "message": "Merge branch 'master' into enhance-alarm-webhook", "committedDate": "2020-09-12T02:37:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1OTY4Nw==", "url": "https://github.com/apache/skywalking/pull/5474#discussion_r487359687", "bodyText": "Different naming style. Please fix.", "author": "wu-sheng", "createdAt": "2020-09-12T03:10:07Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/Rules.java", "diffHunk": "@@ -34,6 +35,7 @@\n     private List<String> webhooks;\n     private GRPCAlarmSetting grpchookSetting;\n     private SlackSettings slacks;\n+    private WechatSettings wechatSetting;", "originalCommit": "f09f8ba32b1d9f82a68817cea46d733430e6ad1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1OTc3Ng==", "url": "https://github.com/apache/skywalking/pull/5474#discussion_r487359776", "bodyText": "Remove the link from the comments.", "author": "wu-sheng", "createdAt": "2020-09-12T03:10:59Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/wechat/WechatHookCallback.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider.wechat;\n+\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.http.HttpHeaders;\n+import org.apache.http.HttpStatus;\n+import org.apache.http.StatusLine;\n+import org.apache.http.client.config.RequestConfig;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.ContentType;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmCallback;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.AlarmRulesWatcher;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * Use SkyWalking alarm wechat webhook API.\n+ * See https://work.weixin.qq.com/api/doc/90000/90136/91770", "originalCommit": "f09f8ba32b1d9f82a68817cea46d733430e6ad1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM2MDMwNA==", "url": "https://github.com/apache/skywalking/pull/5474#discussion_r487360304", "bodyText": "Don't connect the literal strings with +. There is no performance issue in the JDK8+, but this is not good for reading. Please use {} for the place holder.", "author": "wu-sheng", "createdAt": "2020-09-12T03:16:54Z", "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/wechat/WechatHookCallback.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.alarm.provider.wechat;\n+\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.http.HttpHeaders;\n+import org.apache.http.HttpStatus;\n+import org.apache.http.StatusLine;\n+import org.apache.http.client.config.RequestConfig;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.ContentType;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmCallback;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmMessage;\n+import org.apache.skywalking.oap.server.core.alarm.provider.AlarmRulesWatcher;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * Use SkyWalking alarm wechat webhook API.\n+ * See https://work.weixin.qq.com/api/doc/90000/90136/91770\n+ */\n+@Slf4j\n+public class WechatHookCallback implements AlarmCallback {\n+    private static final int HTTP_CONNECT_TIMEOUT = 1000;\n+    private static final int HTTP_CONNECTION_REQUEST_TIMEOUT = 1000;\n+    private static final int HTTP_SOCKET_TIMEOUT = 10000;\n+    private AlarmRulesWatcher alarmRulesWatcher;\n+    private RequestConfig requestConfig;\n+\n+    public WechatHookCallback(final AlarmRulesWatcher alarmRulesWatcher) {\n+        this.alarmRulesWatcher = alarmRulesWatcher;\n+        this.requestConfig = RequestConfig.custom()\n+                .setConnectTimeout(HTTP_CONNECT_TIMEOUT)\n+                .setConnectionRequestTimeout(HTTP_CONNECTION_REQUEST_TIMEOUT)\n+                .setSocketTimeout(HTTP_SOCKET_TIMEOUT)\n+                .build();\n+    }\n+\n+    @Override\n+    public void doAlarm(List<AlarmMessage> alarmMessages) {\n+        if (this.alarmRulesWatcher.getWechatSettings() == null || this.alarmRulesWatcher.getWechatSettings().getWebhooks().isEmpty()) {\n+            return;\n+        }\n+        CloseableHttpClient httpClient = HttpClients.custom().build();\n+        try {\n+            this.alarmRulesWatcher.getWechatSettings().getWebhooks().forEach(url -> {\n+                alarmMessages.forEach(alarmMessage -> {\n+                    String requestBody = String.format(\n+                            this.alarmRulesWatcher.getWechatSettings().getTextTemplate(), alarmMessage.getAlarmMessage()\n+                    );\n+                    sendAlarmMessage(httpClient, url, requestBody);\n+                });\n+            });\n+        } finally {\n+            try {\n+                httpClient.close();\n+            } catch (IOException e) {\n+                log.error(e.getMessage(), e);\n+            }\n+        }\n+    }\n+\n+    private void sendAlarmMessage(CloseableHttpClient httpClient, String url, String requestBody) {\n+        try {\n+            HttpPost post = new HttpPost(url);\n+            post.setConfig(requestConfig);\n+            post.setHeader(HttpHeaders.ACCEPT, HttpHeaderValues.APPLICATION_JSON.toString());\n+            post.setHeader(HttpHeaders.CONTENT_TYPE, HttpHeaderValues.APPLICATION_JSON.toString());\n+            StringEntity entity = new StringEntity(requestBody, ContentType.APPLICATION_JSON);\n+            post.setEntity(entity);\n+            CloseableHttpResponse httpResponse = httpClient.execute(post);\n+            StatusLine statusLine = httpResponse.getStatusLine();\n+            if (statusLine != null && statusLine.getStatusCode() != HttpStatus.SC_OK) {\n+                log.error(\"send wechat alarm to \" + url + \" failure. Response code: \" + statusLine.getStatusCode());", "originalCommit": "f09f8ba32b1d9f82a68817cea46d733430e6ad1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a7403d8159f3726b16f11240035ca3faebda2a40", "url": "https://github.com/apache/skywalking/commit/a7403d8159f3726b16f11240035ca3faebda2a40", "message": "change naming style, adjust log", "committedDate": "2020-09-12T05:58:03Z", "type": "commit"}, {"oid": "345c120938b74ca83b9ef7f7e2d01ac18923a2f3", "url": "https://github.com/apache/skywalking/commit/345c120938b74ca83b9ef7f7e2d01ac18923a2f3", "message": "declaim only support Enterprise wechat", "committedDate": "2020-09-12T06:03:02Z", "type": "commit"}, {"oid": "7bb7448a4a7ec21e657bec3663ef9844920221e4", "url": "https://github.com/apache/skywalking/commit/7bb7448a4a7ec21e657bec3663ef9844920221e4", "message": "change suggestion", "committedDate": "2020-09-12T06:04:58Z", "type": "commit"}, {"oid": "40ed2779ea4c77c00542975b2f37266f5867e807", "url": "https://github.com/apache/skywalking/commit/40ed2779ea4c77c00542975b2f37266f5867e807", "message": "change suggestion", "committedDate": "2020-09-12T06:12:06Z", "type": "commit"}, {"oid": "313504ce3679cc803436d4a2091536d4caca315b", "url": "https://github.com/apache/skywalking/commit/313504ce3679cc803436d4a2091536d4caca315b", "message": "Update oap-server/server-bootstrap/src/main/resources/alarm-settings.yml", "committedDate": "2020-09-12T08:26:18Z", "type": "commit"}, {"oid": "34ae89bd32c33f5dc5670f8d3b704727cda539dc", "url": "https://github.com/apache/skywalking/commit/34ae89bd32c33f5dc5670f8d3b704727cda539dc", "message": "Update docs/en/setup/backend/backend-alarm.md", "committedDate": "2020-09-12T08:26:33Z", "type": "commit"}]}