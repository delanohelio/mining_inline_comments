{"pr_number": 5132, "pr_title": "Improve Es trace basic  query performance", "pr_createdAt": "2020-07-20T07:30:51Z", "pr_url": "https://github.com/apache/skywalking/pull/5132", "timeline": [{"oid": "002f4c2573399a96649a64fb399dc8b7e80cd175", "url": "https://github.com/apache/skywalking/commit/002f4c2573399a96649a64fb399dc8b7e80cd175", "message": "add SuperDataset tag for add super size dataset shards config in es", "committedDate": "2020-05-16T09:46:41Z", "type": "commit"}, {"oid": "3fead29fe6379c1784feb1e21b28888266242d69", "url": "https://github.com/apache/skywalking/commit/3fead29fe6379c1784feb1e21b28888266242d69", "message": "explain the meaning of indexShardsNumber and superDatasetIndexShardsFactor", "committedDate": "2020-05-16T13:40:59Z", "type": "commit"}, {"oid": "f84bf3ea704ac9c0b7d751d6533d8ad25ba94625", "url": "https://github.com/apache/skywalking/commit/f84bf3ea704ac9c0b7d751d6533d8ad25ba94625", "message": "code style format", "committedDate": "2020-05-17T08:19:36Z", "type": "commit"}, {"oid": "b9c0d17a67d7213e7426b1449410700079b0ac2a", "url": "https://github.com/apache/skywalking/commit/b9c0d17a67d7213e7426b1449410700079b0ac2a", "message": "Merge branch 'master' into master", "committedDate": "2020-05-17T08:35:47Z", "type": "commit"}, {"oid": "f176bdbb28a466f0683d341d7b5eb1782068438f", "url": "https://github.com/apache/skywalking/commit/f176bdbb28a466f0683d341d7b5eb1782068438f", "message": "code style format", "committedDate": "2020-05-17T08:55:05Z", "type": "commit"}, {"oid": "34df4295c55fb7343a4e3e3dc86ff417d44f0010", "url": "https://github.com/apache/skywalking/commit/34df4295c55fb7343a4e3e3dc86ff417d44f0010", "message": "code style format and change notes", "committedDate": "2020-05-17T08:59:25Z", "type": "commit"}, {"oid": "e698ddf0b0d522894d94b4f1143210afabffd8d5", "url": "https://github.com/apache/skywalking/commit/e698ddf0b0d522894d94b4f1143210afabffd8d5", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-05-20T08:01:53Z", "type": "commit"}, {"oid": "52e21a287727aeffa241533f3c208a7b9c4fb215", "url": "https://github.com/apache/skywalking/commit/52e21a287727aeffa241533f3c208a7b9c4fb215", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-05-27T13:54:44Z", "type": "commit"}, {"oid": "87cc6a2c405f3b31deaf8d5a47f718edd6c0eee5", "url": "https://github.com/apache/skywalking/commit/87cc6a2c405f3b31deaf8d5a47f718edd6c0eee5", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-06-10T04:41:26Z", "type": "commit"}, {"oid": "39669e67a8b738f7cf5030b3277ddc1668a88835", "url": "https://github.com/apache/skywalking/commit/39669e67a8b738f7cf5030b3277ddc1668a88835", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-06-22T09:47:59Z", "type": "commit"}, {"oid": "172145bdc3ca85d0876cbd8f0b113c571fdb8c79", "url": "https://github.com/apache/skywalking/commit/172145bdc3ca85d0876cbd8f0b113c571fdb8c79", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-07-12T14:33:34Z", "type": "commit"}, {"oid": "2c32e00ae24a9f7ec30510ce292006172356a7cf", "url": "https://github.com/apache/skywalking/commit/2c32e00ae24a9f7ec30510ce292006172356a7cf", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-07-14T07:36:38Z", "type": "commit"}, {"oid": "7be9f078d9264919eb1158e31c39fb2c5c3fdd0d", "url": "https://github.com/apache/skywalking/commit/7be9f078d9264919eb1158e31c39fb2c5c3fdd0d", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-07-20T02:13:49Z", "type": "commit"}, {"oid": "167119406406e4540e1599183719a9cc37f81cf9", "url": "https://github.com/apache/skywalking/commit/167119406406e4540e1599183719a9cc37f81cf9", "message": "Optimize Trace es basic Query", "committedDate": "2020-07-20T07:29:04Z", "type": "commit"}, {"oid": "05629316eeaa1313921fafd1b47464a796e8d508", "url": "https://github.com/apache/skywalking/commit/05629316eeaa1313921fafd1b47464a796e8d508", "message": "Merge remote-tracking branch 'upstream/master' into es-query", "committedDate": "2020-07-20T07:36:22Z", "type": "commit"}, {"oid": "77d95270f8a14ac429adfc28ed3bc74970a8e4da", "url": "https://github.com/apache/skywalking/commit/77d95270f8a14ac429adfc28ed3bc74970a8e4da", "message": "Merge branch 'master' into es-query", "committedDate": "2020-08-01T02:41:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkxMjIyOA==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r463912228", "bodyText": "traceQueryIndices -> recordQueryIndices", "author": "wu-sheng", "createdAt": "2020-08-01T02:54:46Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/TimeSeriesUtils.java", "diffHunk": "@@ -55,6 +56,21 @@ public static String latestWriteIndexName(Model model) {\n         }\n     }\n \n+    /**\n+     * @return split index name based on time bucket.\n+     */\n+    public static String[] traceQueryIndices(String indexName, long startSecondTB, long endSecondTB) {", "originalCommit": "77d95270f8a14ac429adfc28ed3bc74970a8e4da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkxMjgzNQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r463912835", "bodyText": "Still, the issue is, currently, we don't ask for time range because of trace id query.", "author": "wu-sheng", "createdAt": "2020-08-01T03:00:43Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/query/TraceQueryEs7DAO.java", "diffHunk": "@@ -115,7 +116,8 @@ public TraceBrief queryBasicTraces(long startSecondTB,\n         sourceBuilder.size(limit);\n         sourceBuilder.from(from);\n \n-        SearchResponse response = getClient().search(SegmentRecord.INDEX_NAME, sourceBuilder);\n+        String[] indices = TimeSeriesUtils.traceQueryIndices(SegmentRecord.INDEX_NAME, startSecondTB, endSecondTB);", "originalCommit": "77d95270f8a14ac429adfc28ed3bc74970a8e4da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f94da95e2fe6b780d78b0b89ff37a3e6d28a5023", "url": "https://github.com/apache/skywalking/commit/f94da95e2fe6b780d78b0b89ff37a3e6d28a5023", "message": "Merge remote-tracking branch 'upstream/master' into es-query", "committedDate": "2020-08-05T05:21:25Z", "type": "commit"}, {"oid": "fe0bcec7573de53e6941ea6ec7b7427050c5c221", "url": "https://github.com/apache/skywalking/commit/fe0bcec7573de53e6941ea6ec7b7427050c5c221", "message": "es metrics record query performance", "committedDate": "2020-08-09T14:48:31Z", "type": "commit"}, {"oid": "4cd6e8e90a9dbb7fe68984febcac235f048f8bcd", "url": "https://github.com/apache/skywalking/commit/4cd6e8e90a9dbb7fe68984febcac235f048f8bcd", "message": "Merge remote-tracking branch 'upstream/master' into es-query", "committedDate": "2020-08-10T06:57:04Z", "type": "commit"}, {"oid": "595be6d2be3bc42f77f73d130716b86646269eee", "url": "https://github.com/apache/skywalking/commit/595be6d2be3bc42f77f73d130716b86646269eee", "message": "add super dataset es query client", "committedDate": "2020-08-10T08:07:55Z", "type": "commit"}, {"oid": "cf26352290e314e33505e688403a901b9a18a494", "url": "https://github.com/apache/skywalking/commit/cf26352290e314e33505e688403a901b9a18a494", "message": "Merge branch 'es-query' of https://github.com/EvanLjp/skywalking into es-query", "committedDate": "2020-08-10T08:08:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4OTgwOQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467789809", "bodyText": "So, does this means, once the time buckets don't exist, still use the alias name, right?", "author": "wu-sheng", "createdAt": "2020-08-10T09:35:50Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/TimeSeriesUtils.java", "diffHunk": "@@ -60,6 +61,31 @@ public static String latestWriteIndexName(Model model) {\n         }\n     }\n \n+    /**\n+     * @return Concrete index name for super dataset index\n+     */\n+    public static String[] querySuperDatasetIndices(String indexName, long startTimeBucket, long endTimeBucket) {\n+        if (startTimeBucket == 0 || endTimeBucket == 0) {\n+            return new String[] {indexName};", "originalCommit": "cf26352290e314e33505e688403a901b9a18a494", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MTU4MQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467791581", "bodyText": "yes,the is plan B", "author": "EvanLjp", "createdAt": "2020-08-10T09:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4OTgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MDgxNA==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467790814", "bodyText": "Is rangeTimeName actually timeBucketColName?", "author": "wu-sheng", "createdAt": "2020-08-10T09:37:53Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/SuperDatasetRangeElasticSearchClient.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.skywalking.oap.server.library.client.elasticsearch.ElasticSearchClient;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.index.query.RangeQueryBuilder;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+\n+import static org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base.TimeSeriesUtils.querySuperDatasetIndices;\n+\n+public class SuperDatasetRangeElasticSearchClient {\n+\n+    public static SearchResponse search(ElasticSearchClient client,\n+                                        String rangeTimeName,", "originalCommit": "cf26352290e314e33505e688403a901b9a18a494", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MTMzNQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467791335", "bodyText": "yes", "author": "EvanLjp", "createdAt": "2020-08-10T09:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MDgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5Mjc1Nw==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467792757", "bodyText": "Based on the implementation, is this method should be more specific about it is for searchOnSuperDataSet? In the L40, you call #querySuperDatasetIndices directly.", "author": "wu-sheng", "createdAt": "2020-08-10T09:41:48Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/SuperDatasetRangeElasticSearchClient.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.skywalking.oap.server.library.client.elasticsearch.ElasticSearchClient;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.index.query.RangeQueryBuilder;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+\n+import static org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base.TimeSeriesUtils.querySuperDatasetIndices;\n+\n+public class SuperDatasetRangeElasticSearchClient {\n+\n+    public static SearchResponse search(ElasticSearchClient client,", "originalCommit": "cf26352290e314e33505e688403a901b9a18a494", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgwNzU2Ng==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467807566", "bodyText": "in my first option, the range query client is working on metrics or record data\nbut when i submit superdataset day step pr, i thought the query cient would not works well in mertics or normal record data.\nso i renamed the client as superdataset range query client\nthe client is designed to extract range query condition from sourcebuilder rather than input again.", "author": "EvanLjp", "createdAt": "2020-08-10T10:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5Mjc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5NTcyNQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467795725", "bodyText": "Don't add a client with static methods, that break the code style.", "author": "wu-sheng", "createdAt": "2020-08-10T09:48:04Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/SuperDatasetRangeElasticSearchClient.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.skywalking.oap.server.library.client.elasticsearch.ElasticSearchClient;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.index.query.RangeQueryBuilder;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+\n+import static org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base.TimeSeriesUtils.querySuperDatasetIndices;\n+\n+public class SuperDatasetRangeElasticSearchClient {", "originalCommit": "cf26352290e314e33505e688403a901b9a18a494", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5NjczOA==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467796738", "bodyText": "There is recursion, why?", "author": "wu-sheng", "createdAt": "2020-08-10T09:50:05Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/SuperDatasetRangeElasticSearchClient.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.skywalking.oap.server.library.client.elasticsearch.ElasticSearchClient;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.index.query.RangeQueryBuilder;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+\n+import static org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base.TimeSeriesUtils.querySuperDatasetIndices;\n+\n+public class SuperDatasetRangeElasticSearchClient {\n+\n+    public static SearchResponse search(ElasticSearchClient client,\n+                                        String rangeTimeName,\n+                                        String indexName,\n+                                        SearchSourceBuilder searchSourceBuilder) throws IOException {\n+        Optional<RangeQueryBuilder> timeRangeQueryBuilder = findTimeRangeQueryBuilder(searchSourceBuilder, rangeTimeName);\n+        String[] indexNames = timeRangeQueryBuilder.map(item -> querySuperDatasetIndices(indexName, (Long) item.from(), (Long) item.to()))\n+                                                   .orElseGet(() -> new String[] {indexName});\n+        return client.search(indexNames, searchSourceBuilder);\n+    }\n+\n+    /**\n+     * query rangeQueryBuilder on different query ways\n+     *\n+     * @param searchSourceBuilder es query params\n+     * @param rangeTimeName       the range time name define in es query params\n+     * @return the time range query builder\n+     */\n+    private static Optional<RangeQueryBuilder> findTimeRangeQueryBuilder(final SearchSourceBuilder searchSourceBuilder,\n+                                                                         final String rangeTimeName) {\n+        QueryBuilder query = searchSourceBuilder.query();\n+        if (query instanceof RangeQueryBuilder) {\n+            RangeQueryBuilder rangeQueryBuilder = (RangeQueryBuilder) query;\n+            return rangeQueryBuilder.fieldName().equals(rangeTimeName) ? Optional.of(rangeQueryBuilder) : Optional.empty();\n+        } else if (query instanceof BoolQueryBuilder) {\n+            return findTimeRangeQueryBuilder(rangeTimeName, ((BoolQueryBuilder) query).must(), ((BoolQueryBuilder) query).filter());", "originalCommit": "cf26352290e314e33505e688403a901b9a18a494", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgwNTMxOA==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r467805318", "bodyText": "it is just a overload method", "author": "EvanLjp", "createdAt": "2020-08-10T10:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5NjczOA=="}], "type": "inlineReview"}, {"oid": "73cf2f9d50a397d307fa941746dc6aedc0ea03a1", "url": "https://github.com/apache/skywalking/commit/73cf2f9d50a397d307fa941746dc6aedc0ea03a1", "message": "add IndexNameMaker FunctionalInterface", "committedDate": "2020-08-10T15:04:20Z", "type": "commit"}, {"oid": "d882fc278e2adcd41555190bb4e2f081a44cbd28", "url": "https://github.com/apache/skywalking/commit/d882fc278e2adcd41555190bb4e2f081a44cbd28", "message": "Merge remote-tracking branch 'upstream/master' into es-query", "committedDate": "2020-08-11T08:53:18Z", "type": "commit"}, {"oid": "2d7ff376c8f9a8febac52a473e4e511abe8d3565", "url": "https://github.com/apache/skywalking/commit/2d7ff376c8f9a8febac52a473e4e511abe8d3565", "message": "format", "committedDate": "2020-08-11T10:12:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ3NjMxNQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468476315", "bodyText": "I think we don't need this method in public, right?", "author": "wu-sheng", "createdAt": "2020-08-11T10:19:37Z", "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "diffHunk": "@@ -331,9 +333,25 @@ public boolean deleteTemplate(String indexName) throws IOException {\n         return response.getStatusLine().getStatusCode() == HttpStatus.SC_OK;\n     }\n \n+    public SearchResponse search(IndexNameMaker indexNameMaker, SearchSourceBuilder searchSourceBuilder) throws IOException {\n+        String[] indexNames = Arrays.stream(indexNameMaker.make()).map(this::formatIndexName).toArray(String[]::new);\n+        return search(indexNames, searchSourceBuilder);\n+    }\n+\n     public SearchResponse search(String indexName, SearchSourceBuilder searchSourceBuilder) throws IOException {\n         indexName = formatIndexName(indexName);\n-        SearchRequest searchRequest = new SearchRequest(indexName);\n+        return doSearch(searchSourceBuilder, indexName);\n+    }\n+\n+    public SearchResponse search(String[] indexNames, SearchSourceBuilder searchSourceBuilder) throws IOException {", "originalCommit": "2d7ff376c8f9a8febac52a473e4e511abe8d3565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYwMzczOA==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468603738", "bodyText": "yes", "author": "EvanLjp", "createdAt": "2020-08-11T14:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ3NjMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ3NzY3NQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468477675", "bodyText": "Could you explain a little more about why we need this?", "author": "wu-sheng", "createdAt": "2020-08-11T10:22:12Z", "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "diffHunk": "@@ -331,9 +333,25 @@ public boolean deleteTemplate(String indexName) throws IOException {\n         return response.getStatusLine().getStatusCode() == HttpStatus.SC_OK;\n     }\n \n+    public SearchResponse search(IndexNameMaker indexNameMaker, SearchSourceBuilder searchSourceBuilder) throws IOException {\n+        String[] indexNames = Arrays.stream(indexNameMaker.make()).map(this::formatIndexName).toArray(String[]::new);\n+        return search(indexNames, searchSourceBuilder);\n+    }\n+\n     public SearchResponse search(String indexName, SearchSourceBuilder searchSourceBuilder) throws IOException {\n         indexName = formatIndexName(indexName);\n-        SearchRequest searchRequest = new SearchRequest(indexName);\n+        return doSearch(searchSourceBuilder, indexName);\n+    }\n+\n+    public SearchResponse search(String[] indexNames, SearchSourceBuilder searchSourceBuilder) throws IOException {\n+        indexNames = Arrays.stream(indexNames).map(this::formatIndexName).toArray(String[]::new);\n+        return doSearch(searchSourceBuilder, indexNames);\n+    }\n+\n+    private SearchResponse doSearch(SearchSourceBuilder searchSourceBuilder,\n+                                    String... indexNames) throws IOException {\n+        SearchRequest searchRequest = new SearchRequest(indexNames);\n+        searchRequest.indicesOptions(IndicesOptions.fromOptions(true, true, true, false));", "originalCommit": "2d7ff376c8f9a8febac52a473e4e511abe8d3565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYwMzY1OQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468603659", "bodyText": "for example:\nif user select a time range : 2020.08.01==>2020.08.31\nour index only has xxx-segment-2020.08.10\nif pass so many unavailable index to before search,we will got a exception notice  xxx index is not exist\nso the param is to ignore unexist index", "author": "EvanLjp", "createdAt": "2020-08-11T14:02:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ3NzY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYxMTYwNg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468611606", "bodyText": "Are other values default?", "author": "wu-sheng", "createdAt": "2020-08-11T14:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ3NzY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY3NDAwMg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468674002", "bodyText": "i read the source code, in my opion, this config nedd to be manually set", "author": "EvanLjp", "createdAt": "2020-08-11T15:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ3NzY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUzNTA4NQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468535085", "bodyText": "I think this should be renamed to superDatasetIndexName, right?", "author": "wu-sheng", "createdAt": "2020-08-11T12:16:01Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/TimeSeriesUtils.java", "diffHunk": "@@ -60,6 +61,31 @@ public static String latestWriteIndexName(Model model) {\n         }\n     }\n \n+    /**\n+     * @return Concrete index name for super dataset index\n+     */\n+    public static String[] querySuperDatasetIndices(String indexName, long startTimeBucket, long endTimeBucket) {", "originalCommit": "2d7ff376c8f9a8febac52a473e4e511abe8d3565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYwMzkzOA==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468603938", "bodyText": "ok", "author": "EvanLjp", "createdAt": "2020-08-11T14:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUzNTA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Njg5Nw==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468556897", "bodyText": "I think basically, we don't need this method. Read Joda lib, such as  LocalDateTime.now().truncatedTo(ChronoUnit.MINUTES)", "author": "wu-sheng", "createdAt": "2020-08-11T12:54:48Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/TimeSeriesUtils.java", "diffHunk": "@@ -60,6 +61,31 @@ public static String latestWriteIndexName(Model model) {\n         }\n     }\n \n+    /**\n+     * @return Concrete index name for super dataset index\n+     */\n+    public static String[] querySuperDatasetIndices(String indexName, long startTimeBucket, long endTimeBucket) {\n+        if (startTimeBucket == 0 || endTimeBucket == 0) {\n+            return new String[] {indexName};\n+        }\n+        long startDay = compressTimeBucket(convert2DayTimeBucket(startTimeBucket), SUPER_DATASET_DAY_STEP);\n+        long endDay = compressTimeBucket(convert2DayTimeBucket(endTimeBucket), SUPER_DATASET_DAY_STEP);\n+        DateTime startDateTime = TIME_BUCKET_FORMATTER.parseDateTime(startDay + \"\");\n+        DateTime endDateTime = TIME_BUCKET_FORMATTER.parseDateTime(endDay + \"\");\n+\n+        int steps = Math.max((Days.daysBetween(startDateTime, endDateTime).getDays()) / SUPER_DATASET_DAY_STEP, 0);\n+        return IntStream.rangeClosed(0, steps)\n+                        .mapToObj(step -> indexName + Const.LINE + startDateTime.plusDays(Math.toIntExact(SUPER_DATASET_DAY_STEP * step)).toString(TIME_BUCKET_FORMATTER))\n+                        .toArray(String[]::new);\n+    }\n+\n+    private static long convert2DayTimeBucket(long timeBucket) {", "originalCommit": "2d7ff376c8f9a8febac52a473e4e511abe8d3565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYwNDI5NQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468604295", "bodyText": "thx for your notice", "author": "EvanLjp", "createdAt": "2020-08-11T14:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Njg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyMTczMw==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468621733", "bodyText": "the method is to convert input time bucket to yyyyMMdd.\nfor example the input long maybe following:\n\nyyyyMMdd\nyyyyMMddHH\n2.yyyyMMddHHmm\n3.yyyyMMddHHmmss", "author": "EvanLjp", "createdAt": "2020-08-11T14:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Njg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNzA2NA==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468627064", "bodyText": "Really? From my check, all these are running for TimeRangeIndexNameMaker and Trace query, the input parameter is always startSecondTB? Why it could be different formats?", "author": "wu-sheng", "createdAt": "2020-08-11T14:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Njg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY3MTQzNg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468671436", "bodyText": "sorry.i am wrong.", "author": "EvanLjp", "createdAt": "2020-08-11T15:30:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Njg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Nzg2Mg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468557862", "bodyText": "Max with 0? Do you avoid negative value? What happens when the steps == 0?", "author": "wu-sheng", "createdAt": "2020-08-11T12:56:23Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/TimeSeriesUtils.java", "diffHunk": "@@ -60,6 +61,31 @@ public static String latestWriteIndexName(Model model) {\n         }\n     }\n \n+    /**\n+     * @return Concrete index name for super dataset index\n+     */\n+    public static String[] querySuperDatasetIndices(String indexName, long startTimeBucket, long endTimeBucket) {\n+        if (startTimeBucket == 0 || endTimeBucket == 0) {\n+            return new String[] {indexName};\n+        }\n+        long startDay = compressTimeBucket(convert2DayTimeBucket(startTimeBucket), SUPER_DATASET_DAY_STEP);\n+        long endDay = compressTimeBucket(convert2DayTimeBucket(endTimeBucket), SUPER_DATASET_DAY_STEP);\n+        DateTime startDateTime = TIME_BUCKET_FORMATTER.parseDateTime(startDay + \"\");\n+        DateTime endDateTime = TIME_BUCKET_FORMATTER.parseDateTime(endDay + \"\");\n+\n+        int steps = Math.max((Days.daysBetween(startDateTime, endDateTime).getDays()) / SUPER_DATASET_DAY_STEP, 0);", "originalCommit": "2d7ff376c8f9a8febac52a473e4e511abe8d3565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1OTA1NQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468559055", "bodyText": "I think this method should simply follow this logic,\n\nList all days between startTime and endTime.\nUse compressTimeBucket to get all indexes(could have duplicated records)\nDistinct the list.", "author": "wu-sheng", "createdAt": "2020-08-11T12:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Nzg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1OTg2NQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r468559865", "bodyText": "The above processes may need a little refactor about the compressTimeBucket method, I should be able to accept DateTime as one parameter too.", "author": "wu-sheng", "createdAt": "2020-08-11T12:59:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Nzg2Mg=="}], "type": "inlineReview"}, {"oid": "d368f7dbc22ac71f565b8c979db798f705296894", "url": "https://github.com/apache/skywalking/commit/d368f7dbc22ac71f565b8c979db798f705296894", "message": "refractor codes in TimeSeriesUtils", "committedDate": "2020-08-11T15:47:26Z", "type": "commit"}, {"oid": "93faf6ad50be28c574d737114b35c902c3b87965", "url": "https://github.com/apache/skywalking/commit/93faf6ad50be28c574d737114b35c902c3b87965", "message": "convert public to private in org.apache.skywalking.oap.server.library.client.elasticsearch.ElasticSearchClient.search(java.lang.String[], org.elasticsearch.search.builder.SearchSourceBuilder)", "committedDate": "2020-08-11T15:49:45Z", "type": "commit"}, {"oid": "252ff71ebad1e90d297521641bd070f134135c21", "url": "https://github.com/apache/skywalking/commit/252ff71ebad1e90d297521641bd070f134135c21", "message": "Merge remote-tracking branch 'upstream/master' into es-query", "committedDate": "2020-08-12T05:24:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4NDg0MQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r469084841", "bodyText": "Why need and call search again? And in both methods, you are only doing the formatIndexName. I think the namespace would be added twice.", "author": "wu-sheng", "createdAt": "2020-08-12T08:15:06Z", "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "diffHunk": "@@ -331,9 +333,25 @@ public boolean deleteTemplate(String indexName) throws IOException {\n         return response.getStatusLine().getStatusCode() == HttpStatus.SC_OK;\n     }\n \n+    public SearchResponse search(IndexNameMaker indexNameMaker, SearchSourceBuilder searchSourceBuilder) throws IOException {\n+        String[] indexNames = Arrays.stream(indexNameMaker.make()).map(this::formatIndexName).toArray(String[]::new);\n+        return search(indexNames, searchSourceBuilder);", "originalCommit": "252ff71ebad1e90d297521641bd070f134135c21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4NTYyOQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r469085629", "bodyText": "What happens if the indexNames#size == 0?", "author": "wu-sheng", "createdAt": "2020-08-12T08:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4NDg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4Nzg4Mw==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r469087883", "bodyText": "get real index name by String[] indexNames = Arrays.stream(indexNameMaker.make()).map(this::formatIndexName).toArray(String[]::new);\ndo search search(indexNames, searchSourceBuilder) input is real indexNames.\n\nin TimeSeriesUtils, the default name is alias name ,so the input would not be empty", "author": "EvanLjp", "createdAt": "2020-08-12T08:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4NDg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEwNDUxNw==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r469104517", "bodyText": "You are calling another search, not doSearch. That is what I am asking. Please recheck the codes.", "author": "wu-sheng", "createdAt": "2020-08-12T08:47:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4NDg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEwNjExNg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r469106116", "bodyText": "sorry", "author": "EvanLjp", "createdAt": "2020-08-12T08:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4NDg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEwODc1NQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r469108755", "bodyText": "Do we still need another search(array)?", "author": "wu-sheng", "createdAt": "2020-08-12T08:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4NDg0MQ=="}], "type": "inlineReview"}, {"oid": "824187d8714675f7c1d68bc0d77fd010fa9a1128", "url": "https://github.com/apache/skywalking/commit/824187d8714675f7c1d68bc0d77fd010fa9a1128", "message": "fix error", "committedDate": "2020-08-12T08:52:21Z", "type": "commit"}, {"oid": "c060d64f47fc77d7b83cf76a7673dde0f6e03c17", "url": "https://github.com/apache/skywalking/commit/c060d64f47fc77d7b83cf76a7673dde0f6e03c17", "message": "fix error", "committedDate": "2020-08-12T08:55:38Z", "type": "commit"}, {"oid": "28cfea8e5b176ac521a9bf47c39985992004c462", "url": "https://github.com/apache/skywalking/commit/28cfea8e5b176ac521a9bf47c39985992004c462", "message": "Merge branch 'master' into es-query", "committedDate": "2020-08-12T23:55:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ2NTI1Mg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470465252", "bodyText": "You refactor this method, but forgot the indexName = formatIndexName(indexName);, which is used to exist.\nI think that is the reason, your PR is not working.", "author": "wu-sheng", "createdAt": "2020-08-14T07:47:48Z", "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "diffHunk": "@@ -325,15 +327,24 @@ public boolean createTemplate(String indexName, Map<String, Object> settings,\n \n     public boolean deleteTemplate(String indexName) throws IOException {\n         indexName = formatIndexName(indexName);\n-\n-        Response response = client.getLowLevelClient()\n-                                  .performRequest(HttpDelete.METHOD_NAME, \"/_template/\" + indexName);\n+        Response response = client.getLowLevelClient().performRequest(HttpDelete.METHOD_NAME, \"/_template/\" + indexName);\n         return response.getStatusLine().getStatusCode() == HttpStatus.SC_OK;\n     }\n \n+    public SearchResponse search(IndexNameMaker indexNameMaker, SearchSourceBuilder searchSourceBuilder) throws IOException {\n+        String[] indexNames = Arrays.stream(indexNameMaker.make()).map(this::formatIndexName).toArray(String[]::new);\n+        return doSearch(searchSourceBuilder, indexNames);\n+    }\n+\n     public SearchResponse search(String indexName, SearchSourceBuilder searchSourceBuilder) throws IOException {\n         indexName = formatIndexName(indexName);\n-        SearchRequest searchRequest = new SearchRequest(indexName);\n+        return doSearch(searchSourceBuilder, indexName);", "originalCommit": "28cfea8e5b176ac521a9bf47c39985992004c462", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e6554e958fbfb0b2de41c43e58c1a3f4ab6d342", "url": "https://github.com/apache/skywalking/commit/5e6554e958fbfb0b2de41c43e58c1a3f4ab6d342", "message": "fix bug", "committedDate": "2020-08-14T09:50:44Z", "type": "commit"}, {"oid": "344593aff340085258c9624c659c9e7d6f2c8903", "url": "https://github.com/apache/skywalking/commit/344593aff340085258c9624c659c9e7d6f2c8903", "message": "Merge branch 'es-query' of https://github.com/EvanLjp/skywalking into es-query", "committedDate": "2020-08-14T09:51:18Z", "type": "commit"}, {"oid": "3c74c91bc50cec9ad13d664798e486480104fe95", "url": "https://github.com/apache/skywalking/commit/3c74c91bc50cec9ad13d664798e486480104fe95", "message": "Merge remote-tracking branch 'upstream/master' into es-query", "committedDate": "2020-08-14T09:53:00Z", "type": "commit"}, {"oid": "f48bcfa85521310d2979cd2cd5d302136e9d1830", "url": "https://github.com/apache/skywalking/commit/f48bcfa85521310d2979cd2cd5d302136e9d1830", "message": "Merge branch 'master' into es-query", "committedDate": "2020-08-14T10:03:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NTIyMQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470595221", "bodyText": "I think ES7 and ES6 should use different ESClient implementation because of SearchResponse or more things , due to different package name or something like that. Please recheck.", "author": "wu-sheng", "createdAt": "2020-08-14T12:31:56Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/query/TraceQueryEs7DAO.java", "diffHunk": "@@ -124,8 +125,7 @@ public TraceBrief queryBasicTraces(long startSecondTB,\n         }\n         sourceBuilder.size(limit);\n         sourceBuilder.from(from);\n-\n-        SearchResponse response = getClient().search(SegmentRecord.INDEX_NAME, sourceBuilder);\n+        SearchResponse response = getClient().search(new TimeRangeIndexNameMaker(SegmentRecord.INDEX_NAME, startSecondTB, endSecondTB), sourceBuilder);", "originalCommit": "f48bcfa85521310d2979cd2cd5d302136e9d1830", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NjMxNA==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470596314", "bodyText": "You could find this in the e2e logs. And es7 e2e is going to fail because of the error.", "author": "wu-sheng", "createdAt": "2020-08-14T12:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NTIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwMjYxMQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470602611", "bodyText": "Notice in the current codes, ElasticSearch7Client and ElasticSearchClient have their own #search methods, your new #doSearch method has not been included in the ES 7 client.", "author": "wu-sheng", "createdAt": "2020-08-14T12:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NTIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTA4Mg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470615082", "bodyText": "today i test the codes in our test env  and find the bug,already fix it ,and pass the tests", "author": "EvanLjp", "createdAt": "2020-08-14T13:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NTIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTQ2NQ==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470615465", "bodyText": "waiting to  pass all ci proesses", "author": "EvanLjp", "createdAt": "2020-08-14T13:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NTIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY1NDEwNg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470654106", "bodyText": "This is a very tricky bug due to Elastic changed the package name, but with the same class name.", "author": "wu-sheng", "createdAt": "2020-08-14T14:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NTIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4MTkxMg==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470681912", "bodyText": "yes,the error is no such method exception when testiing,i realize may be jars conflict.but took so many time to  find it", "author": "EvanLjp", "createdAt": "2020-08-14T15:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NTIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4Mjc2Mw==", "url": "https://github.com/apache/skywalking/pull/5132#discussion_r470682763", "bodyText": "Finally, we get this method working, and it should be helpful to many users.", "author": "wu-sheng", "createdAt": "2020-08-14T15:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NTIyMQ=="}], "type": "inlineReview"}, {"oid": "cd10bcd7846b8a0aeb2e89adf9b9f22c7669383c", "url": "https://github.com/apache/skywalking/commit/cd10bcd7846b8a0aeb2e89adf9b9f22c7669383c", "message": "fix es7 query bug", "committedDate": "2020-08-14T13:08:59Z", "type": "commit"}, {"oid": "967203cd86185b06c969a27dc25bc63be0d06185", "url": "https://github.com/apache/skywalking/commit/967203cd86185b06c969a27dc25bc63be0d06185", "message": "Merge remote-tracking branch 'upstream/master' into es-query", "committedDate": "2020-08-14T13:09:33Z", "type": "commit"}, {"oid": "4aa09525f72c6b4eeef75511dbd61019a2753655", "url": "https://github.com/apache/skywalking/commit/4aa09525f72c6b4eeef75511dbd61019a2753655", "message": "Merge branch 'es-query' of https://github.com/EvanLjp/skywalking into es-query", "committedDate": "2020-08-14T13:10:17Z", "type": "commit"}]}