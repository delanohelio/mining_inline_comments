{"pr_number": 6091, "pr_title": "Enhance Envoy metrics service analyzer by MAL", "pr_createdAt": "2020-12-28T07:34:36Z", "pr_url": "https://github.com/apache/skywalking/pull/6091", "timeline": [{"oid": "916e20a138a23a103ba6c498bd409f7789d8295b", "url": "https://github.com/apache/skywalking/commit/916e20a138a23a103ba6c498bd409f7789d8295b", "message": "Enhance Envoy metrics service analyzer by MAL", "committedDate": "2020-12-28T07:35:17Z", "type": "commit"}, {"oid": "916e20a138a23a103ba6c498bd409f7789d8295b", "url": "https://github.com/apache/skywalking/commit/916e20a138a23a103ba6c498bd409f7789d8295b", "message": "Enhance Envoy metrics service analyzer by MAL", "committedDate": "2020-12-28T07:35:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI0NjQ5NQ==", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r549246495", "bodyText": "Metrics names in Envoy contain ., hence this is necessary", "author": "kezhenxu94", "createdAt": "2020-12-28T07:40:06Z", "path": "oap-server/analyzer/meter-analyzer/src/main/java/org/apache/skywalking/oap/meter/analyzer/prometheus/PrometheusMetricConverter.java", "diffHunk": "@@ -141,6 +141,11 @@ public void toMeter(Stream<Metric> metricStream) {\n         if (ss.length < 1) {\n             return Optional.empty();\n         }\n-        return Optional.of(Tuple.of(metric.getName(), SampleFamilyBuilder.newBuilder(ss).build()));\n+        return Optional.of(Tuple.of(escapedName(metric.getName()), SampleFamilyBuilder.newBuilder(ss).build()));\n+    }\n+\n+    // Returns the escaped name of the given one, with \".\" replaced by \"_\"\n+    protected String escapedName(final String name) {\n+        return name.replaceAll(\"\\\\.\", \"_\");\n     }", "originalCommit": "916e20a138a23a103ba6c498bd409f7789d8295b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d44af04794a03d38f69d95a814cfd7447d7e57b9", "url": "https://github.com/apache/skywalking/commit/d44af04794a03d38f69d95a814cfd7447d7e57b9", "message": "Make the original tests pass first", "committedDate": "2020-12-28T08:29:08Z", "type": "commit"}, {"oid": "434c476b1b9cd7d26eea74adabcca5430d687ff0", "url": "https://github.com/apache/skywalking/commit/434c476b1b9cd7d26eea74adabcca5430d687ff0", "message": "Set up the E2E skeleton first", "committedDate": "2020-12-29T15:43:29Z", "type": "commit"}, {"oid": "7659c5a8eef367306757283cc42bd2816690e013", "url": "https://github.com/apache/skywalking/commit/7659c5a8eef367306757283cc42bd2816690e013", "message": "Merge branch 'master' into envoy/mal", "committedDate": "2020-12-29T16:08:22Z", "type": "commit"}, {"oid": "7659c5a8eef367306757283cc42bd2816690e013", "url": "https://github.com/apache/skywalking/commit/7659c5a8eef367306757283cc42bd2816690e013", "message": "Merge branch 'master' into envoy/mal", "committedDate": "2020-12-29T16:08:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NjE5MA==", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r549776190", "bodyText": "NULL_DEREFERENCE:  object returned by ProtoMetricFamily2MetricsAdapter.metricFamily.getType() could be null and is dereferenced at line 36.", "author": "sonatype-lift", "createdAt": "2020-12-29T16:55:51Z", "path": "oap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/metrics/adapters/ProtoMetricFamily2MetricsAdapter.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.envoy.metrics.adapters;\n+\n+import io.prometheus.client.Metrics;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+import lombok.RequiredArgsConstructor;\n+import org.apache.skywalking.oap.server.library.util.prometheus.metrics.Gauge;\n+import org.apache.skywalking.oap.server.library.util.prometheus.metrics.Metric;\n+\n+import static java.util.stream.Collectors.toMap;\n+\n+@RequiredArgsConstructor\n+public class ProtoMetricFamily2MetricsAdapter {\n+    protected final Metrics.MetricFamily metricFamily;\n+\n+    public Stream<Metric> adapt() {\n+        // TODO: should adapt more types\n+        switch (metricFamily.getType()) {", "originalCommit": "7659c5a8eef367306757283cc42bd2816690e013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkzNzU4Mg==", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r549937582", "bodyText": "Can't be null actually", "author": "kezhenxu94", "createdAt": "2020-12-30T05:12:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NjE5MA=="}], "type": "inlineReview"}, {"oid": "8e40d6d5f9ab71346baa6a0875a84814f06037c6", "url": "https://github.com/apache/skywalking/commit/8e40d6d5f9ab71346baa6a0875a84814f06037c6", "message": "Ignore `parent_connections_used` since it's not involved in this case", "committedDate": "2020-12-30T04:14:30Z", "type": "commit"}, {"oid": "6e0a5a783e441cd25cab3a59ae71739b675b614b", "url": "https://github.com/apache/skywalking/commit/6e0a5a783e441cd25cab3a59ae71739b675b614b", "message": "Add more metrics to data plane", "committedDate": "2020-12-30T05:09:01Z", "type": "commit"}, {"oid": "bfac6c1a3ce0815cc23e3a173804197fd24acbe8", "url": "https://github.com/apache/skywalking/commit/bfac6c1a3ce0815cc23e3a173804197fd24acbe8", "message": "Remove unnecessary config rule", "committedDate": "2020-12-30T05:12:54Z", "type": "commit"}, {"oid": "9605d0977b8b6213b3f35846445a02b293350fb5", "url": "https://github.com/apache/skywalking/commit/9605d0977b8b6213b3f35846445a02b293350fb5", "message": "Update EnvoyMetricReceiverConfig.java", "committedDate": "2020-12-30T07:10:28Z", "type": "commit"}, {"oid": "fd1310158994b7f154bae40b46c3fe6498e1964a", "url": "https://github.com/apache/skywalking/commit/fd1310158994b7f154bae40b46c3fe6498e1964a", "message": "Merge branch 'master' into envoy/mal", "committedDate": "2020-12-30T07:25:29Z", "type": "commit"}, {"oid": "02b5eb0cb680288dde15efef9cdb041739879732", "url": "https://github.com/apache/skywalking/commit/02b5eb0cb680288dde15efef9cdb041739879732", "message": "Fix E2E", "committedDate": "2020-12-30T10:26:45Z", "type": "commit"}, {"oid": "14c8eafee7ec4e8661f565b96b34ea5d0e1f9b50", "url": "https://github.com/apache/skywalking/commit/14c8eafee7ec4e8661f565b96b34ea5d0e1f9b50", "message": "Update instances-istio::reviews.default.yml", "committedDate": "2020-12-30T11:11:28Z", "type": "commit"}, {"oid": "aff25f59861b44ec42376b66d5549891eb342054", "url": "https://github.com/apache/skywalking/commit/aff25f59861b44ec42376b66d5549891eb342054", "message": "Lift data plane to level 1 of dashboard", "committedDate": "2020-12-31T03:30:49Z", "type": "commit"}, {"oid": "763c807840383583c025697d07d8ab8451e513ef", "url": "https://github.com/apache/skywalking/commit/763c807840383583c025697d07d8ab8451e513ef", "message": "Merge remote-tracking branch 'origin/master' into envoy/mal\n\n# Conflicts:\n#\tCHANGES.md", "committedDate": "2020-12-31T03:32:20Z", "type": "commit"}, {"oid": "4ba7244a8520d06cffed469bb115e96f637c909d", "url": "https://github.com/apache/skywalking/commit/4ba7244a8520d06cffed469bb115e96f637c909d", "message": "Revert istio ctrl plane svc group name", "committedDate": "2020-12-31T03:41:52Z", "type": "commit"}, {"oid": "0fab4e40637a21a5476c59f4e11cb4050785f2ae", "url": "https://github.com/apache/skywalking/commit/0fab4e40637a21a5476c59f4e11cb4050785f2ae", "message": "Fix test", "committedDate": "2020-12-31T05:02:48Z", "type": "commit"}, {"oid": "6754a3d6d2a68bc509efb516f3482b1438c00edb", "url": "https://github.com/apache/skywalking/commit/6754a3d6d2a68bc509efb516f3482b1438c00edb", "message": "Fix test", "committedDate": "2020-12-31T09:34:06Z", "type": "commit"}, {"oid": "cfbf5b3a62ad7f8395d998ba49564f9939c977d4", "url": "https://github.com/apache/skywalking/commit/cfbf5b3a62ad7f8395d998ba49564f9939c977d4", "message": "Fix invalid file name in Windows", "committedDate": "2020-12-31T11:21:17Z", "type": "commit"}, {"oid": "f4aeb7b53627cbf62310b856e9713407f10873ad", "url": "https://github.com/apache/skywalking/commit/f4aeb7b53627cbf62310b856e9713407f10873ad", "message": "Merge remote-tracking branch 'origin/master' into envoy/mal", "committedDate": "2020-12-31T13:07:18Z", "type": "commit"}, {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "url": "https://github.com/apache/skywalking/commit/75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "message": "Fix test", "committedDate": "2020-12-31T13:07:35Z", "type": "commit"}, {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "url": "https://github.com/apache/skywalking/commit/75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "message": "Fix test", "committedDate": "2020-12-31T13:07:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc0ODI0NQ==", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550748245", "bodyText": "This is the logic we used to do, but I think we should share the ALS logic. Then in future integration, the entity names of sidecar metrics will be as same as the traffic related metrics.", "author": "wu-sheng", "createdAt": "2021-01-01T08:59:16Z", "path": "oap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/MetricServiceGRPCHandler.java", "diffHunk": "@@ -79,17 +93,15 @@ public void onNext(StreamMetricsMessage message) {\n                     isFirst = false;\n                     StreamMetricsMessage.Identifier identifier = message.getIdentifier();\n                     Node node = identifier.getNode();\n-                    if (node != null) {\n-                        String nodeId = node.getId();\n-                        if (!StringUtil.isEmpty(nodeId)) {\n-                            serviceInstanceName = nodeId;\n-                        }\n-                        String cluster = node.getCluster();\n-                        if (!StringUtil.isEmpty(cluster)) {\n-                            serviceName = cluster;\n-                            if (serviceInstanceName == null) {\n-                                serviceInstanceName = serviceName;\n-                            }\n+                    String nodeId = node.getId();\n+                    if (!StringUtil.isEmpty(nodeId)) {\n+                        serviceInstanceName = nodeId;\n+                    }\n+                    String cluster = node.getCluster();\n+                    if (!StringUtil.isEmpty(cluster)) {\n+                        serviceName = cluster;\n+                        if (serviceInstanceName == null) {\n+                            serviceInstanceName = serviceName;", "originalCommit": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc3Nzg2NQ==", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550777865", "bodyText": "The service names in metrics service have a service group prefix (istio-dp::) while those in ALS don't have, do we want to add service group in ALS as well?", "author": "kezhenxu94", "createdAt": "2021-01-01T15:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc0ODI0NQ=="}], "type": "inlineReview"}, {"oid": "d9b1f2fbc83d99f0c7b8354546f45fa7e1b0b56a", "url": "https://github.com/apache/skywalking/commit/d9b1f2fbc83d99f0c7b8354546f45fa7e1b0b56a", "message": "Merge branch 'master' into envoy/mal\n\n# Conflicts:\n#\tCHANGES.md\n#\toap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/EnvoyMetricReceiverProvider.java", "committedDate": "2021-01-01T14:23:23Z", "type": "commit"}, {"oid": "54efea65c22e316a8679a0f864063501f39e3279", "url": "https://github.com/apache/skywalking/commit/54efea65c22e316a8679a0f864063501f39e3279", "message": "Unify the Service & ServiceInstance names with ALS", "committedDate": "2021-01-01T15:18:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MDc3MQ==", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550780771", "bodyText": "ServiceMetaInfoAdapter is for meta exchange only, right? Where is the ip-mapping mechanism?", "author": "wu-sheng", "createdAt": "2021-01-01T15:57:08Z", "path": "oap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/MetricServiceGRPCHandler.java", "diffHunk": "@@ -60,111 +69,65 @@ public MetricServiceGRPCHandler(ModuleManager moduleManager) {\n             \"envoy_metric_in_latency\", \"The process latency of service metrics receiver\", MetricsTag.EMPTY_KEY,\n             MetricsTag.EMPTY_VALUE\n         );\n+\n+        final MeterSystem meterSystem = moduleManager.find(CoreModule.NAME).provider().getService(MeterSystem.class);\n+\n+        converters = config.rules()\n+                           .stream()\n+                           .map(rule -> new PrometheusMetricConverter(rule, meterSystem))\n+                           .collect(Collectors.toList());\n     }\n \n     @Override\n     public StreamObserver<StreamMetricsMessage> streamMetrics(StreamObserver<StreamMetricsResponse> responseObserver) {\n         return new StreamObserver<StreamMetricsMessage>() {\n             private volatile boolean isFirst = true;\n-            private String serviceName = null;\n-            private String serviceInstanceName = null;\n+            private ServiceMetaInfo service;\n \n             @Override\n+            @SneakyThrows\n             public void onNext(StreamMetricsMessage message) {\n                 if (log.isDebugEnabled()) {\n                     log.debug(\"Received msg {}\", message);\n                 }\n \n                 if (isFirst) {\n                     isFirst = false;\n-                    StreamMetricsMessage.Identifier identifier = message.getIdentifier();\n-                    Node node = identifier.getNode();\n-                    if (node != null) {\n-                        String nodeId = node.getId();\n-                        if (!StringUtil.isEmpty(nodeId)) {\n-                            serviceInstanceName = nodeId;\n-                        }\n-                        String cluster = node.getCluster();\n-                        if (!StringUtil.isEmpty(cluster)) {\n-                            serviceName = cluster;\n-                            if (serviceInstanceName == null) {\n-                                serviceInstanceName = serviceName;\n-                            }\n-                        }\n-                    }\n-\n-                    if (serviceName == null) {\n-                        serviceName = serviceInstanceName;\n-                    }\n+                    service = new ServiceMetaInfoAdapter(message.getIdentifier().getNode().getMetadata());", "originalCommit": "54efea65c22e316a8679a0f864063501f39e3279", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgxOTU4MA==", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550819580", "bodyText": "Pls add more unit tests to cover these functions", "author": "hanahmily", "createdAt": "2021-01-01T23:28:30Z", "path": "oap-server/analyzer/meter-analyzer/src/main/java/org/apache/skywalking/oap/meter/analyzer/dsl/SampleFamily.java", "diffHunk": "@@ -161,12 +162,32 @@ public SampleFamily div(SampleFamily another) {\n \n     /* Aggregation operators */\n     public SampleFamily sum(List<String> by) {\n+        return aggregate(by, Double::sum);\n+    }\n+\n+    public SampleFamily max(List<String> by) {\n+        return aggregate(by, Double::max);\n+    }\n+\n+    public SampleFamily min(List<String> by) {\n+        return aggregate(by, Double::min);", "originalCommit": "54efea65c22e316a8679a0f864063501f39e3279", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "71b9ddd8704a0bf4eb1d9549a80f88a7a73f0fbc", "url": "https://github.com/apache/skywalking/commit/71b9ddd8704a0bf4eb1d9549a80f88a7a73f0fbc", "message": "Address review comments, add tests, fix tests", "committedDate": "2021-01-02T03:11:24Z", "type": "commit"}, {"oid": "20aae2649a054f4bf14b137edc997a79e418ca44", "url": "https://github.com/apache/skywalking/commit/20aae2649a054f4bf14b137edc997a79e418ca44", "message": "Adjust expected data", "committedDate": "2021-01-02T03:57:17Z", "type": "commit"}, {"oid": "9f3224e61c8c8acec6a6e992a9b7356149cd8ca0", "url": "https://github.com/apache/skywalking/commit/9f3224e61c8c8acec6a6e992a9b7356149cd8ca0", "message": "Add doc, fix test", "committedDate": "2021-01-02T04:30:51Z", "type": "commit"}]}