{"pr_number": 4846, "pr_title": "New feature provided : new plugin for influxdb-java client", "pr_createdAt": "2020-05-31T09:29:26Z", "pr_url": "https://github.com/apache/skywalking/pull/4846", "timeline": [{"oid": "fafcf290b0467f6122d43bc4b7478785295f5906", "url": "https://github.com/apache/skywalking/commit/fafcf290b0467f6122d43bc4b7478785295f5906", "message": "Bulk executed with failures\uff0cthen log detail message", "committedDate": "2020-05-31T05:14:48Z", "type": "commit"}, {"oid": "81d07c0c03c736e451c9d679c7a97fefb22b9143", "url": "https://github.com/apache/skywalking/commit/81d07c0c03c736e451c9d679c7a97fefb22b9143", "message": "Merge branch 'master' into master", "committedDate": "2020-05-31T05:25:19Z", "type": "commit"}, {"oid": "dcc9a71acdb7122d497c4f1afa1216eaf845d1bf", "url": "https://github.com/apache/skywalking/commit/dcc9a71acdb7122d497c4f1afa1216eaf845d1bf", "message": "add new java sdk plugin : InfluxDB", "committedDate": "2020-05-31T08:59:30Z", "type": "commit"}, {"oid": "d28d344f8e801fa51e489dc6058048e2684ce7a1", "url": "https://github.com/apache/skywalking/commit/d28d344f8e801fa51e489dc6058048e2684ce7a1", "message": "Merge branch 'master' into master", "committedDate": "2020-05-31T09:29:44Z", "type": "commit"}, {"oid": "d7a5d8a23512e16c1194929b57cf55f690d60fae", "url": "https://github.com/apache/skywalking/commit/d7a5d8a23512e16c1194929b57cf55f690d60fae", "message": "Merge branch 'master' into master", "committedDate": "2020-06-03T13:33:46Z", "type": "commit"}, {"oid": "7121812dfbfa9fa2cf41ac0dd770e484386ae231", "url": "https://github.com/apache/skywalking/commit/7121812dfbfa9fa2cf41ac0dd770e484386ae231", "message": "plugin-test : influxdb-scenario", "committedDate": "2020-06-03T13:35:18Z", "type": "commit"}, {"oid": "2f9938100a5f64f4e4dcaefde1ac312f86c8aa1b", "url": "https://github.com/apache/skywalking/commit/2f9938100a5f64f4e4dcaefde1ac312f86c8aa1b", "message": "plugin-test : influxdb-scenario\nsupport-version.list modify form old version and healthCheck use ping() api", "committedDate": "2020-06-03T14:55:16Z", "type": "commit"}, {"oid": "2e0c63495ae626275d66ea729acce708f1eb9d3b", "url": "https://github.com/apache/skywalking/commit/2e0c63495ae626275d66ea729acce708f1eb9d3b", "message": "plugin-test : upgrade influxdb-scenario support-version.list form 2.5 ~ 2.17", "committedDate": "2020-06-03T15:00:58Z", "type": "commit"}, {"oid": "129689027f6ce0e71ff688bcdf9e7aaa7459419d", "url": "https://github.com/apache/skywalking/commit/129689027f6ce0e71ff688bcdf9e7aaa7459419d", "message": "plugin-test : add influxdb-scenario to Github Actions Job.", "committedDate": "2020-06-03T15:12:15Z", "type": "commit"}, {"oid": "9caa661c64a5eca8d32c7708cd1e7dc05f9cf3f3", "url": "https://github.com/apache/skywalking/commit/9caa661c64a5eca8d32c7708cd1e7dc05f9cf3f3", "message": "Merge branch 'master' into master", "committedDate": "2020-06-03T15:14:00Z", "type": "commit"}, {"oid": "b151ad3f231c5c90b555003fcbc5d82fa9dc600a", "url": "https://github.com/apache/skywalking/commit/b151ad3f231c5c90b555003fcbc5d82fa9dc600a", "message": "raf check : exclude [jacoco] dir --> generated file from test agent plugin scenarios", "committedDate": "2020-06-04T16:33:30Z", "type": "commit"}, {"oid": "ca855b4a5837bf490727b3c9357ade2c38753a64", "url": "https://github.com/apache/skywalking/commit/ca855b4a5837bf490727b3c9357ade2c38753a64", "message": "influxdb plugin : resolve raf problem and unit test case", "committedDate": "2020-06-04T16:33:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTAzOQ==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436245039", "bodyText": "Capitalize the first letter of the sentence please", "author": "kezhenxu94", "createdAt": "2020-06-06T06:54:50Z", "path": "apm-sniffer/apm-sdk-plugin/influxdb-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/influxdb/define/InfluxDBInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.influxdb.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.match.NameMatch;\n+import org.apache.skywalking.apm.plugin.influxdb.InfluxDBMethodMatch;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * enhance InfluxDB InfluxDBFactory\n+ * really impl class {@link org.influxdb.impl.InfluxDBImpl}\n+ *\n+ * @since  2020/05/22", "originalCommit": "ca855b4a5837bf490727b3c9357ade2c38753a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3ODk4NQ==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436278985", "bodyText": "What does since date mean? Quiet unusual, from my understanding. We coulf know when be added through git log directly", "author": "wu-sheng", "createdAt": "2020-06-06T15:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3OTEyNA==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436279124", "bodyText": "What does since date mean? Quiet unusual, from my understanding. We coulf know when be added through git log directly", "author": "wu-sheng", "createdAt": "2020-06-06T15:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MTI3NA==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436281274", "bodyText": "ok,I'll removesince", "author": "dagmom", "createdAt": "2020-06-06T16:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTExNA==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436245114", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final String INFLUXDB_METHOD_INTERCEPT_CLASS = \"org.apache.skywalking.apm.plugin.influxdb.interceptor.InfluxDBMethodInterceptor\";\n          \n          \n            \n                private static final String INFLUXDB_METHOD_INTERCEPT_CLASS = \"org.apache.skywalking.apm.plugin.influxdb.interceptor.InfluxDBMethodInterceptor\";", "author": "kezhenxu94", "createdAt": "2020-06-06T06:55:55Z", "path": "apm-sniffer/apm-sdk-plugin/influxdb-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/influxdb/define/InfluxDBInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.influxdb.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.match.NameMatch;\n+import org.apache.skywalking.apm.plugin.influxdb.InfluxDBMethodMatch;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * enhance InfluxDB InfluxDBFactory\n+ * really impl class {@link org.influxdb.impl.InfluxDBImpl}\n+ *\n+ * @since  2020/05/22\n+ */\n+public class InfluxDBInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {\n+\n+    private static final String ENHANCE_CLASS = \"org.influxdb.impl.InfluxDBImpl\";\n+    private static final String INTERCEPTOR_CLASS = \"org.apache.skywalking.apm.plugin.influxdb.interceptor.InfluxDBConstructorInterceptor\";\n+  private static final String INFLUXDB_METHOD_INTERCEPT_CLASS = \"org.apache.skywalking.apm.plugin.influxdb.interceptor.InfluxDBMethodInterceptor\";", "originalCommit": "ca855b4a5837bf490727b3c9357ade2c38753a64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTE2OA==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436245168", "bodyText": "Remove if useless, or fix it if assertion is failed", "author": "kezhenxu94", "createdAt": "2020-06-06T06:56:55Z", "path": "apm-sniffer/apm-sdk-plugin/influxdb-2.x-plugin/src/test/java/org/apache/skywalking/apm/plugin/influxdb/InfluxDBMethodInterceptorTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.influxdb;\n+\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractTracingSpan;\n+import org.apache.skywalking.apm.agent.core.context.trace.LogDataEntity;\n+import org.apache.skywalking.apm.agent.core.context.trace.SpanLayer;\n+import org.apache.skywalking.apm.agent.core.context.trace.TraceSegment;\n+import org.apache.skywalking.apm.agent.core.context.util.TagValuePair;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.test.helper.SegmentHelper;\n+import org.apache.skywalking.apm.agent.test.helper.SpanHelper;\n+import org.apache.skywalking.apm.agent.test.tools.AgentServiceRule;\n+import org.apache.skywalking.apm.agent.test.tools.SegmentStorage;\n+import org.apache.skywalking.apm.agent.test.tools.SegmentStoragePoint;\n+import org.apache.skywalking.apm.agent.test.tools.TracingSegmentRunner;\n+import org.apache.skywalking.apm.network.trace.component.ComponentsDefine;\n+import org.apache.skywalking.apm.plugin.influxdb.interceptor.InfluxDBMethodInterceptor;\n+import org.hamcrest.CoreMatchers;\n+import org.influxdb.InfluxDBException;\n+import org.influxdb.dto.Point;\n+import org.influxdb.impl.InfluxDBImpl;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+import org.powermock.modules.junit4.PowerMockRunnerDelegate;\n+\n+import java.lang.reflect.Method;\n+import java.util.List;\n+\n+import static junit.framework.TestCase.assertNotNull;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(PowerMockRunner.class)\n+@PowerMockRunnerDelegate(TracingSegmentRunner.class)\n+public class InfluxDBMethodInterceptorTest {\n+\n+    @SegmentStoragePoint\n+    private SegmentStorage segmentStorage;\n+\n+    @Rule\n+    public AgentServiceRule serviceRule = new AgentServiceRule();\n+\n+    @Mock\n+    private EnhancedInstance enhancedInstance;\n+\n+    private InfluxDBMethodInterceptor interceptor;\n+\n+    private Object[] allArgument;\n+\n+    private Class[] argumentType;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        allArgument = new Object[] {\n+            Point.measurement(\"cpu\")\n+                .tag(\"host\", \"127.0.0.1\")\n+                .addField(\"use_idle\", 0.8)\n+                .build()\n+        };\n+        argumentType = new Class[] {\n+            Point.class\n+        };\n+\n+        interceptor = new InfluxDBMethodInterceptor();\n+        when(enhancedInstance.getSkyWalkingDynamicField()).thenReturn(\"http://127.0.0.1:8086\");\n+    }\n+\n+    @Test\n+    public void testIntercept() throws Throwable {\n+        interceptor.beforeMethod(enhancedInstance, getMockWriteMethod(), allArgument, argumentType, null);\n+        interceptor.afterMethod(enhancedInstance, getMockWriteMethod(), allArgument, argumentType, null);\n+\n+        TraceSegment traceSegment = segmentStorage.getTraceSegments().get(0);\n+        List<AbstractTracingSpan> spans = SegmentHelper.getSpans(traceSegment);\n+        assertThat(spans.size(), is(1));\n+        assertInfluxDBSpan(spans.get(0));\n+    }\n+\n+    @Test\n+    public void testInterceptWithException() throws Throwable {\n+        interceptor.beforeMethod(enhancedInstance, getMockWriteMethod(), allArgument, argumentType, null);\n+        interceptor.handleMethodException(enhancedInstance, getMockWriteMethod(), allArgument, argumentType, new InfluxDBException(\"test exception\"));\n+        interceptor.afterMethod(enhancedInstance, getMockWriteMethod(), allArgument, argumentType, null);\n+\n+        TraceSegment traceSegment = segmentStorage.getTraceSegments().get(0);\n+        List<AbstractTracingSpan> spans = SegmentHelper.getSpans(traceSegment);\n+        assertThat(spans.size(), is(1));\n+        assertInfluxDBSpan(spans.get(0));\n+\n+        assertLogData(SpanHelper.getLogs(spans.get(0)));\n+    }\n+\n+    private void assertLogData(List<LogDataEntity> logDataEntities) {\n+        assertThat(logDataEntities.size(), is(1));\n+        LogDataEntity logData = logDataEntities.get(0);\n+        Assert.assertThat(logData.getLogs().size(), is(4));\n+        Assert.assertThat(logData.getLogs().get(0).getValue(), CoreMatchers.<Object>is(\"error\"));\n+        Assert.assertThat(logData.getLogs()\n+                                 .get(1)\n+                                 .getValue(), CoreMatchers.<Object>is(InfluxDBException.class.getName()));\n+        Assert.assertEquals(\"test exception\", logData.getLogs().get(2).getValue());\n+        assertNotNull(logData.getLogs().get(3).getValue());\n+    }\n+\n+    private void assertInfluxDBSpan(AbstractTracingSpan span) {\n+        assertThat(span.getOperationName(), is(\"InfluxDB/write\"));\n+        assertThat(span.isExit(), is(true));\n+        assertThat(SpanHelper.getComponentId(span), is(ComponentsDefine.INFLUXDB_JAVA.getId()));\n+        List<TagValuePair> tags = SpanHelper.getTags(span);\n+        assertThat(tags.get(0).getValue(), is(\"InfluxDB\"));\n+//        assertThat(tags.get(1).getValue(), is(\"write \".concat(allArgument[0].toString())));", "originalCommit": "ca855b4a5837bf490727b3c9357ade2c38753a64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTMxNA==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436245314", "bodyText": "Remove author tag", "author": "kezhenxu94", "createdAt": "2020-06-06T06:59:06Z", "path": "test/plugin/scenarios/influxdb-scenario/src/main/java/org/apache/skywalking/apm/testcase/influxdb/executor/InfluxDBExecutor.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.testcase.influxdb.executor;\n+\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Pong;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+\n+/**\n+ * InfluxDBExecutor\n+ *\n+ * @author guhao\n+ * @since 2020/6/3", "originalCommit": "ca855b4a5837bf490727b3c9357ade2c38753a64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTM2Mg==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436245362", "bodyText": "Remove this if it's useless", "author": "kezhenxu94", "createdAt": "2020-06-06T07:00:05Z", "path": "test/plugin/scenarios/influxdb-scenario/src/test/java/org/apache/skywalking/apm/testcase/influxdb/executor/InfluxDBExecutorTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.testcase.influxdb.executor;\n+\n+/**\n+ * InfluxDBExecutorTest\n+ *\n+ * @author guhao\n+ * @since 2020/6/3\n+ */\n+public class InfluxDBExecutorTest {\n+\n+//  @Test\n+//  public void testPing(){\n+//    InfluxDBExecutor executor = new InfluxDBExecutor(\"http://localhost:8086\");\n+//    Pong pong = executor.ping();\n+//    System.out.println(pong.getVersion());\n+//    Assert.assertNotNull(pong.getVersion());\n+//  }\n+\n+}", "originalCommit": "ca855b4a5837bf490727b3c9357ade2c38753a64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTk1NQ==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436245955", "bodyText": "This is good for encapsulation, but it's a pitfall that we check third-party classes in classes whose name end with *Instrumentation\n\n  \n    \n      skywalking/apm-checkstyle/checkStyle.xml\n    \n    \n        Lines 122 to 129\n      in\n      f3d907b\n    \n    \n    \n    \n\n        \n          \n           <module name=\"ImportControl\"> \n        \n\n        \n          \n               <property name=\"file\" value=\"${import.control}\"/> \n        \n\n        \n          \n               <property name=\"path\" value=\"apm-sniffer/(apm-sdk-plugin|bootstrap-plugins|optional-plugins)/.+/src/main/.+Instrumentation.java$\"/> \n        \n\n        \n          \n           </module> \n        \n\n        \n          \n            \n        \n\n        \n          \n           <module name=\"ImportControl\"> \n        \n\n        \n          \n               <property name=\"file\" value=\"${import.control}\"/> \n        \n\n        \n          \n               <property name=\"path\" value=\"apm-sniffer/apm-toolkit-activation/.+/src/main/.+Activation.java$\"/> \n        \n    \n  \n\n\nto avoid issues like this #2871 , but this breaks the checks, although there is no third-party class in the InfluxDBMethodMatch for now, other reviewers should pay attention to this class in the future, FYI @wu-sheng", "author": "kezhenxu94", "createdAt": "2020-06-06T07:09:05Z", "path": "apm-sniffer/apm-sdk-plugin/influxdb-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/influxdb/define/InfluxDBInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.influxdb.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.match.NameMatch;\n+import org.apache.skywalking.apm.plugin.influxdb.InfluxDBMethodMatch;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * enhance InfluxDB InfluxDBFactory\n+ * really impl class {@link org.influxdb.impl.InfluxDBImpl}\n+ *\n+ * @since  2020/05/22\n+ */\n+public class InfluxDBInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {\n+\n+    private static final String ENHANCE_CLASS = \"org.influxdb.impl.InfluxDBImpl\";\n+    private static final String INTERCEPTOR_CLASS = \"org.apache.skywalking.apm.plugin.influxdb.interceptor.InfluxDBConstructorInterceptor\";\n+  private static final String INFLUXDB_METHOD_INTERCEPT_CLASS = \"org.apache.skywalking.apm.plugin.influxdb.interceptor.InfluxDBMethodInterceptor\";\n+\n+    @Override\n+    protected ClassMatch enhanceClass() {\n+        return NameMatch.byName(ENHANCE_CLASS);\n+    }\n+\n+    @Override\n+    public ConstructorInterceptPoint[] getConstructorsInterceptPoints() {\n+        return new ConstructorInterceptPoint[] {\n+            new ConstructorInterceptPoint() {\n+                @Override\n+                public ElementMatcher<MethodDescription> getConstructorMatcher() {\n+                    return takesArgument(0, String.class);\n+                }\n+\n+                @Override\n+                public String getConstructorInterceptor() {\n+                    return INTERCEPTOR_CLASS;\n+                }\n+            }\n+        };\n+    }\n+\n+    @Override\n+    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {\n+      return new InstanceMethodsInterceptPoint[] {\n+          new InstanceMethodsInterceptPoint() {\n+            @Override\n+            public ElementMatcher<MethodDescription> getMethodsMatcher() {\n+              return InfluxDBMethodMatch.INSTANCE.getInfluxDBMethodMatcher();", "originalCommit": "ca855b4a5837bf490727b3c9357ade2c38753a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3OTM0Nw==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436279347", "bodyText": "Question, why need this singleton. This method is not called in high frequently, and nothing cached there.", "author": "wu-sheng", "createdAt": "2020-06-06T15:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDA0NQ==", "url": "https://github.com/apache/skywalking/pull/4846#discussion_r436280045", "bodyText": "I did it the other way", "author": "dagmom", "createdAt": "2020-06-06T16:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTk1NQ=="}], "type": "inlineReview"}, {"oid": "5818b7e106cc9de9eacdc09df821c77c901fd031", "url": "https://github.com/apache/skywalking/commit/5818b7e106cc9de9eacdc09df821c77c901fd031", "message": "[PHP-E2E] Support v8 (#4862)", "committedDate": "2020-06-06T13:12:39Z", "type": "commit"}, {"oid": "fa94bb5507e87f94533c55e1403bf99e92fa3699", "url": "https://github.com/apache/skywalking/commit/fa94bb5507e87f94533c55e1403bf99e92fa3699", "message": "Remove nacos (#4867)\n\n* Add annotation(AlarmCore.start)\r\n\r\n* Upgrade nacos version to 1.2.0\r\n\r\n* Revert \"Upgrade nacos version to 1.2.0\"\r\n\r\nThis reverts commit 4d7b06f6d20ee09ad377ad6ef736aeab429314e0.\r\n\r\n* Update nacos version to 1.2.0(Solve the security problem of the old version of fastsjon)\r\n\r\n* Recovery annotation\r\n\r\n* Recovery annotation\r\n\r\n* Update nacos version to 1.2.0\r\n\r\n* Update tls_key_generate.sh path\r\n\r\nUpdate tls_key_generate.sh path\r\n\r\n* Add annotation(AlarmCore.start)\r\n\r\n* Revert \"Upgrade nacos version to 1.2.0\"\r\n\r\nThis reverts commit 4d7b06f6d20ee09ad377ad6ef736aeab429314e0.\r\n\r\n* Update nacos version to 1.2.0(Solve the security problem of the old version of fastsjon)\r\n\r\n* Recovery annotation\r\n\r\n* Recovery annotation\r\n\r\n* Update tls_key_generate.sh path\r\n\r\n* Execution Authority\r\n\r\n* Remove nacos\r\n\r\n* remove nacos code\r\n\r\n* remove nacos\r\n\r\nremove nacos\r\n\r\n* remove nacos\r\n\r\nremove nacos\r\n\r\n* remove nacos\r\n\r\n* remove nacos\r\n\r\nCo-authored-by: songzhendong <289505773@qq.com>\r\nCo-authored-by: songzhendong <songzhendong@xiaomi.com>\r\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-06-06T13:12:39Z", "type": "commit"}, {"oid": "916a018ad6c0975fe082b1630b77d0e48ac17de5", "url": "https://github.com/apache/skywalking/commit/916a018ad6c0975fe082b1630b77d0e48ac17de5", "message": "influxdb plugin : Some review comments fix", "committedDate": "2020-06-06T15:50:45Z", "type": "commit"}, {"oid": "ef35816b0f0ba7295ede7611e9b50fc7ea3d0299", "url": "https://github.com/apache/skywalking/commit/ef35816b0f0ba7295ede7611e9b50fc7ea3d0299", "message": "influxdb plugin : Some review comments fix", "committedDate": "2020-06-06T15:52:18Z", "type": "commit"}, {"oid": "dadb56e56b461ace63c55efd5b894ae753f00bf5", "url": "https://github.com/apache/skywalking/commit/dadb56e56b461ace63c55efd5b894ae753f00bf5", "message": "Merge branch 'master' into master", "committedDate": "2020-06-06T15:55:49Z", "type": "commit"}, {"oid": "59a168d3ecea8a217aa1c5503d9b4c72f041d1ff", "url": "https://github.com/apache/skywalking/commit/59a168d3ecea8a217aa1c5503d9b4c72f041d1ff", "message": "influxdb plugin : remove since date", "committedDate": "2020-06-06T15:57:50Z", "type": "commit"}, {"oid": "c6b379bf33cfe51ddfe524446efae5dad3e2866e", "url": "https://github.com/apache/skywalking/commit/c6b379bf33cfe51ddfe524446efae5dad3e2866e", "message": "Merge remote-tracking branch 'upstream/master'\n\n# Conflicts:\n#\toap-server/server-bootstrap/src/main/resources/component-libraries.yml", "committedDate": "2020-06-14T03:05:43Z", "type": "commit"}, {"oid": "55b2b24e90f303cd07424195676b6cfd1fc4573e", "url": "https://github.com/apache/skywalking/commit/55b2b24e90f303cd07424195676b6cfd1fc4573e", "message": "update influxdb plugin version.", "committedDate": "2020-06-14T04:56:14Z", "type": "commit"}, {"oid": "8387f0468dc058d0bd6dff6be01cfc03a69660b8", "url": "https://github.com/apache/skywalking/commit/8387f0468dc058d0bd6dff6be01cfc03a69660b8", "message": "Merge branch 'master' into master", "committedDate": "2020-06-14T12:04:46Z", "type": "commit"}, {"oid": "4889fa960aa7a0865c3063e0a244d2176da4927f", "url": "https://github.com/apache/skywalking/commit/4889fa960aa7a0865c3063e0a244d2176da4927f", "message": "add component-libraries.yml and update Supported-list.md", "committedDate": "2020-06-14T12:46:57Z", "type": "commit"}, {"oid": "e28d7fd2045ef7072e1fc26c2d597dab389a7cf1", "url": "https://github.com/apache/skywalking/commit/e28d7fd2045ef7072e1fc26c2d597dab389a7cf1", "message": "influxdb support db.statement tag, like influxql,lineProtocol value", "committedDate": "2020-06-18T00:01:17Z", "type": "commit"}, {"oid": "168f7f6d9242d54dae490bded26edbb76e6e1fe8", "url": "https://github.com/apache/skywalking/commit/168f7f6d9242d54dae490bded26edbb76e6e1fe8", "message": "Update skywalking-ui", "committedDate": "2020-06-18T00:38:48Z", "type": "commit"}, {"oid": "36811ea24bab01f0e99669ce6234551c1ce53650", "url": "https://github.com/apache/skywalking/commit/36811ea24bab01f0e99669ce6234551c1ce53650", "message": "remove local ut", "committedDate": "2020-06-18T16:08:39Z", "type": "commit"}, {"oid": "8744795a75a595e659518019b86d341ff33242be", "url": "https://github.com/apache/skywalking/commit/8744795a75a595e659518019b86d341ff33242be", "message": "update submodule\n\nupdate submodule", "committedDate": "2020-06-18T16:22:23Z", "type": "commit"}, {"oid": "da0181e718943c6b217d25f3762fe28129fff6c2", "url": "https://github.com/apache/skywalking/commit/da0181e718943c6b217d25f3762fe28129fff6c2", "message": "Merge branch 'master' into master", "committedDate": "2020-06-19T13:53:09Z", "type": "commit"}, {"oid": "e272e753b82db34098485e8d8c0c58ebe02e0995", "url": "https://github.com/apache/skywalking/commit/e272e753b82db34098485e8d8c0c58ebe02e0995", "message": "fixed influxdb-scenario `expectedData.yaml` assert value", "committedDate": "2020-06-20T12:41:32Z", "type": "commit"}, {"oid": "4d9e13762b47f89f3a2fdb63e1c18166f50a1f20", "url": "https://github.com/apache/skywalking/commit/4d9e13762b47f89f3a2fdb63e1c18166f50a1f20", "message": "Merge branch 'master' into master", "committedDate": "2020-06-20T13:30:41Z", "type": "commit"}, {"oid": "0838ef5ffee24f96c317a87aa2ab9b4a6c2ce096", "url": "https://github.com/apache/skywalking/commit/0838ef5ffee24f96c317a87aa2ab9b4a6c2ce096", "message": "Mischange when merge remote-tracing branch", "committedDate": "2020-06-20T13:38:40Z", "type": "commit"}, {"oid": "f77f8f39c59e483cb1038730e01cd078cb5648d6", "url": "https://github.com/apache/skywalking/commit/f77f8f39c59e483cb1038730e01cd078cb5648d6", "message": "Revert \"update submodule\"\n\nThis reverts commit 8744795a75a595e659518019b86d341ff33242be.", "committedDate": "2020-06-20T14:06:30Z", "type": "commit"}, {"oid": "d4c4515ae6924c6bbda4f7f9565948ca3951b7b4", "url": "https://github.com/apache/skywalking/commit/d4c4515ae6924c6bbda4f7f9565948ca3951b7b4", "message": "make submodule commit id is as same as the master branch.", "committedDate": "2020-06-20T14:14:08Z", "type": "commit"}, {"oid": "15884f122a34b5fae992b08501be4e386b2e7114", "url": "https://github.com/apache/skywalking/commit/15884f122a34b5fae992b08501be4e386b2e7114", "message": "exclude scenario test gen files", "committedDate": "2020-06-20T14:15:07Z", "type": "commit"}, {"oid": "f85be1bebd699b2fbd3152191ecdc3f9771eab15", "url": "https://github.com/apache/skywalking/commit/f85be1bebd699b2fbd3152191ecdc3f9771eab15", "message": "Merge remote-tracking branch 'remotes/upstream/master'\n\n# Conflicts:\n#\tapm-protocol/apm-network/src/main/java/org/apache/skywalking/apm/network/trace/component/ComponentsDefine.java\n#\toap-server/server-bootstrap/src/main/resources/component-libraries.yml\n#\toap-server/server-core/src/test/resources/component-libraries.yml", "committedDate": "2020-06-21T02:50:49Z", "type": "commit"}, {"oid": "da55955ab04ce9f56ff175ebbbe1b8705ea2f04b", "url": "https://github.com/apache/skywalking/commit/da55955ab04ce9f56ff175ebbbe1b8705ea2f04b", "message": "change componentId", "committedDate": "2020-06-21T03:22:28Z", "type": "commit"}, {"oid": "d6b32dff414f4cbe30355c8911aae6f4e4ce7409", "url": "https://github.com/apache/skywalking/commit/d6b32dff414f4cbe30355c8911aae6f4e4ce7409", "message": "add `agent/config/agent.config` : plugin.influxdb.trace_influxql", "committedDate": "2020-06-21T04:02:08Z", "type": "commit"}, {"oid": "43af6268e95def8cea78bd720bff201278e42fa8", "url": "https://github.com/apache/skywalking/commit/43af6268e95def8cea78bd720bff201278e42fa8", "message": "Component id defined in class ComponentsDefine should be the same as that in component-libraries.yml", "committedDate": "2020-06-21T10:35:41Z", "type": "commit"}, {"oid": "d2854247b96547989b3fae1924f6ac4bd03dc47c", "url": "https://github.com/apache/skywalking/commit/d2854247b96547989b3fae1924f6ac4bd03dc47c", "message": "Merge branch 'master' into master", "committedDate": "2020-06-21T13:38:13Z", "type": "commit"}, {"oid": "03ac12353bcd11660f50e55089075b245a6d309a", "url": "https://github.com/apache/skywalking/commit/03ac12353bcd11660f50e55089075b245a6d309a", "message": "Revert \"add `agent/config/agent.config` : plugin.influxdb.trace_influxql\"\n\nThis reverts commit d6b32dff", "committedDate": "2020-06-21T13:40:18Z", "type": "commit"}]}