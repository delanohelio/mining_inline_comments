{"pr_number": 5784, "pr_title": "Cluster manager health v2", "pr_createdAt": "2020-11-03T12:48:35Z", "pr_url": "https://github.com/apache/skywalking/pull/5784", "timeline": [{"oid": "107fde23f3edf1de5a4d78558884cc4474d28322", "url": "https://github.com/apache/skywalking/commit/107fde23f3edf1de5a4d78558884cc4474d28322", "message": "Add health checker for cluster management module", "committedDate": "2020-10-14T01:01:18Z", "type": "commit"}, {"oid": "6bd81afa75da8c69ce853aff301553e95c946bee", "url": "https://github.com/apache/skywalking/commit/6bd81afa75da8c69ce853aff301553e95c946bee", "message": "Fix test case problem", "committedDate": "2020-10-14T03:47:44Z", "type": "commit"}, {"oid": "0609dce78c98fcdb8a51130c88b6331bfa7ddd9a", "url": "https://github.com/apache/skywalking/commit/0609dce78c98fcdb8a51130c88b6331bfa7ddd9a", "message": "revert to core name", "committedDate": "2020-10-14T03:54:42Z", "type": "commit"}, {"oid": "078fd1890db5afaa19b1be133b32cd7ac4efe410", "url": "https://github.com/apache/skywalking/commit/078fd1890db5afaa19b1be133b32cd7ac4efe410", "message": "Fix test case", "committedDate": "2020-10-14T04:09:05Z", "type": "commit"}, {"oid": "59e8e1e51c5685b5594aaa16b06824450c804c4d", "url": "https://github.com/apache/skywalking/commit/59e8e1e51c5685b5594aaa16b06824450c804c4d", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-14T04:09:49Z", "type": "commit"}, {"oid": "789ec8a5a2bef1119932db095bb52d5042acab4e", "url": "https://github.com/apache/skywalking/commit/789ec8a5a2bef1119932db095bb52d5042acab4e", "message": "Fix test case", "committedDate": "2020-10-14T06:18:41Z", "type": "commit"}, {"oid": "49e3bdd7bd6c267f7e933ac1bc42f840133c9379", "url": "https://github.com/apache/skywalking/commit/49e3bdd7bd6c267f7e933ac1bc42f840133c9379", "message": "Fix test case", "committedDate": "2020-10-14T06:54:43Z", "type": "commit"}, {"oid": "ce024e5c548e4ae786445818b318eccb7a5db654", "url": "https://github.com/apache/skywalking/commit/ce024e5c548e4ae786445818b318eccb7a5db654", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-15T00:57:19Z", "type": "commit"}, {"oid": "ed24a79614d41a918db72d76d3b6b4a58b221601", "url": "https://github.com/apache/skywalking/commit/ed24a79614d41a918db72d76d3b6b4a58b221601", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-15T04:58:48Z", "type": "commit"}, {"oid": "eb0608b7475c93ff373e598e16a6852f246113fd", "url": "https://github.com/apache/skywalking/commit/eb0608b7475c93ff373e598e16a6852f246113fd", "message": "Refactor change DelegatedHealthChecker to HealthCheckMetrics", "committedDate": "2020-10-15T05:45:03Z", "type": "commit"}, {"oid": "fdc68379775946b0fd77de2dd8a17a7fd22192c7", "url": "https://github.com/apache/skywalking/commit/fdc68379775946b0fd77de2dd8a17a7fd22192c7", "message": "Support Nacos auth", "committedDate": "2020-10-15T06:14:40Z", "type": "commit"}, {"oid": "e92a6695f784ce79703fa20b94cc334c606a2535", "url": "https://github.com/apache/skywalking/commit/e92a6695f784ce79703fa20b94cc334c606a2535", "message": "Fix test case null pointer", "committedDate": "2020-10-15T06:31:39Z", "type": "commit"}, {"oid": "b85961ea107f37f05ba14e8c94b1acf2244c2374", "url": "https://github.com/apache/skywalking/commit/b85961ea107f37f05ba14e8c94b1acf2244c2374", "message": "remove library client", "committedDate": "2020-10-15T12:47:48Z", "type": "commit"}, {"oid": "c446772de24a6ee6d0e271cb4360497c62e89999", "url": "https://github.com/apache/skywalking/commit/c446772de24a6ee6d0e271cb4360497c62e89999", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-16T01:26:20Z", "type": "commit"}, {"oid": "af861b758cdf43f670b8180698fcc3943d1591bd", "url": "https://github.com/apache/skywalking/commit/af861b758cdf43f670b8180698fcc3943d1591bd", "message": "merge master", "committedDate": "2020-10-16T09:18:50Z", "type": "commit"}, {"oid": "691925895c146e2a0b74d566c157824876281705", "url": "https://github.com/apache/skywalking/commit/691925895c146e2a0b74d566c157824876281705", "message": "fix conflict", "committedDate": "2020-10-16T09:26:20Z", "type": "commit"}, {"oid": "8a135477056b6a51c3159f678a9ccf0a9ceb8df3", "url": "https://github.com/apache/skywalking/commit/8a135477056b6a51c3159f678a9ccf0a9ceb8df3", "message": "Refactor remove HealthCheckable", "committedDate": "2020-10-16T14:07:54Z", "type": "commit"}, {"oid": "94de5eff6e012f53aff941383d218d882bf01f10", "url": "https://github.com/apache/skywalking/commit/94de5eff6e012f53aff941383d218d882bf01f10", "message": "fix checkstyle", "committedDate": "2020-10-16T14:17:52Z", "type": "commit"}, {"oid": "774a62b35210061f1dfbfb2af80bb7be8588d290", "url": "https://github.com/apache/skywalking/commit/774a62b35210061f1dfbfb2af80bb7be8588d290", "message": "fix checkstyle", "committedDate": "2020-10-16T14:31:27Z", "type": "commit"}, {"oid": "22a55dec4350f4428f357ebd24f652f3a0d21c38", "url": "https://github.com/apache/skywalking/commit/22a55dec4350f4428f357ebd24f652f3a0d21c38", "message": "Add health check for localhost or 127.0.0.1", "committedDate": "2020-10-17T00:37:20Z", "type": "commit"}, {"oid": "412e0a204be919ca2ae8385db2fca946a0039e4b", "url": "https://github.com/apache/skywalking/commit/412e0a204be919ca2ae8385db2fca946a0039e4b", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-19T10:40:20Z", "type": "commit"}, {"oid": "cda402bf3b442e8c58edab11852ec20ebb983cc7", "url": "https://github.com/apache/skywalking/commit/cda402bf3b442e8c58edab11852ec20ebb983cc7", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-19T10:40:35Z", "type": "commit"}, {"oid": "1a132a50924940396786c39d18d5fc1d663363c4", "url": "https://github.com/apache/skywalking/commit/1a132a50924940396786c39d18d5fc1d663363c4", "message": "Refactor change HealthCheckUtil to OAPNodeChecker", "committedDate": "2020-10-19T13:15:15Z", "type": "commit"}, {"oid": "12b7de2ef31041e53931fa09736096e8cc677f9d", "url": "https://github.com/apache/skywalking/commit/12b7de2ef31041e53931fa09736096e8cc677f9d", "message": "Refactor move healthChecker to init constructor, move check duplicate addresses to OAPNodeChecker", "committedDate": "2020-10-20T01:07:09Z", "type": "commit"}, {"oid": "c49dbf872c51c9c8e37088090e24b83d72f251ec", "url": "https://github.com/apache/skywalking/commit/c49dbf872c51c9c8e37088090e24b83d72f251ec", "message": "fix log error", "committedDate": "2020-10-20T10:24:59Z", "type": "commit"}, {"oid": "1c67cac5ec4a64b24644fa089cb4c49bd346ee0a", "url": "https://github.com/apache/skywalking/commit/1c67cac5ec4a64b24644fa089cb4c49bd346ee0a", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-20T10:25:12Z", "type": "commit"}, {"oid": "f5a50a15bd71fe37801315708dcfa06b1acc1871", "url": "https://github.com/apache/skywalking/commit/f5a50a15bd71fe37801315708dcfa06b1acc1871", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-20T10:25:55Z", "type": "commit"}, {"oid": "a3107c49b51e868b3f30003a8d8b51fa4cce6562", "url": "https://github.com/apache/skywalking/commit/a3107c49b51e868b3f30003a8d8b51fa4cce6562", "message": "refactor move all check health logic to OAPNodeChecker", "committedDate": "2020-10-21T08:00:09Z", "type": "commit"}, {"oid": "614f35118835aa3ffbab5dd0eb216c5097ece084", "url": "https://github.com/apache/skywalking/commit/614f35118835aa3ffbab5dd0eb216c5097ece084", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-21T08:00:35Z", "type": "commit"}, {"oid": "3c1362f88216ac9e991085aa5a30f2522e69a410", "url": "https://github.com/apache/skywalking/commit/3c1362f88216ac9e991085aa5a30f2522e69a410", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-21T08:00:56Z", "type": "commit"}, {"oid": "163810d2b39931b0f7727cca866f949119d5667a", "url": "https://github.com/apache/skywalking/commit/163810d2b39931b0f7727cca866f949119d5667a", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-21T09:32:08Z", "type": "commit"}, {"oid": "99c0af733b94704a782dfe3fce03a66c5a1b39a8", "url": "https://github.com/apache/skywalking/commit/99c0af733b94704a782dfe3fce03a66c5a1b39a8", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-21T09:32:27Z", "type": "commit"}, {"oid": "6a88fcd0923541de8139bf8bb02b1d09c7050a5c", "url": "https://github.com/apache/skywalking/commit/6a88fcd0923541de8139bf8bb02b1d09c7050a5c", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-21T12:54:51Z", "type": "commit"}, {"oid": "6303ccad7d09603369c5c84090ab5579989abe09", "url": "https://github.com/apache/skywalking/commit/6303ccad7d09603369c5c84090ab5579989abe09", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-21T13:03:54Z", "type": "commit"}, {"oid": "93e26982ef8e0520068405927259f9a4f2651f4f", "url": "https://github.com/apache/skywalking/commit/93e26982ef8e0520068405927259f9a4f2651f4f", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-25T07:59:16Z", "type": "commit"}, {"oid": "3133bc8f8f882f9f618579e0af92c17bfb108aac", "url": "https://github.com/apache/skywalking/commit/3133bc8f8f882f9f618579e0af92c17bfb108aac", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-26T03:22:21Z", "type": "commit"}, {"oid": "a55e261aeb4449ee353d8d57b57dcb06a51663df", "url": "https://github.com/apache/skywalking/commit/a55e261aeb4449ee353d8d57b57dcb06a51663df", "message": "Update powered-by.md (#5723)", "committedDate": "2020-10-26T03:23:56Z", "type": "commit"}, {"oid": "d89a850f286b4f27ceeb2dcc4f0cb39efdab870a", "url": "https://github.com/apache/skywalking/commit/d89a850f286b4f27ceeb2dcc4f0cb39efdab870a", "message": "Reformat ui dockerfile. (#5724)", "committedDate": "2020-10-26T03:23:56Z", "type": "commit"}, {"oid": "83c94b1a3a92612bd2720c219cbec28369203026", "url": "https://github.com/apache/skywalking/commit/83c94b1a3a92612bd2720c219cbec28369203026", "message": "Remove apollo default ip. (#5725)", "committedDate": "2020-10-26T03:23:56Z", "type": "commit"}, {"oid": "459dacc55877564237662e458f691128a2a37ca0", "url": "https://github.com/apache/skywalking/commit/459dacc55877564237662e458f691128a2a37ca0", "message": "Fix mockito class not found exception", "committedDate": "2020-10-26T08:50:24Z", "type": "commit"}, {"oid": "afc493801495d6554fd970349f6e11fe9865c59b", "url": "https://github.com/apache/skywalking/commit/afc493801495d6554fd970349f6e11fe9865c59b", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-27T09:46:54Z", "type": "commit"}, {"oid": "54f59592f9f3df1e887656fcb0373efde95abf5e", "url": "https://github.com/apache/skywalking/commit/54f59592f9f3df1e887656fcb0373efde95abf5e", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-27T09:47:15Z", "type": "commit"}, {"oid": "d565108d883f4ae3efad96d1bfa7e91c56df46f6", "url": "https://github.com/apache/skywalking/commit/d565108d883f4ae3efad96d1bfa7e91c56df46f6", "message": "fix it test fail", "committedDate": "2020-10-27T12:33:51Z", "type": "commit"}, {"oid": "28ffdf7b77bf701deb8eae6ee9651d7bb10087b3", "url": "https://github.com/apache/skywalking/commit/28ffdf7b77bf701deb8eae6ee9651d7bb10087b3", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-28T03:29:42Z", "type": "commit"}, {"oid": "c9be395e214705daeaf9288cc840ef8bde295f66", "url": "https://github.com/apache/skywalking/commit/c9be395e214705daeaf9288cc840ef8bde295f66", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-28T05:24:27Z", "type": "commit"}, {"oid": "c0622b6c9648ecd782c9b9bdcf9e62ed402de3bd", "url": "https://github.com/apache/skywalking/commit/c0622b6c9648ecd782c9b9bdcf9e62ed402de3bd", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-31T09:57:04Z", "type": "commit"}, {"oid": "304019624ae10e2652503235ce3a8a6f5a3488bd", "url": "https://github.com/apache/skywalking/commit/304019624ae10e2652503235ce3a8a6f5a3488bd", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-10-31T14:17:29Z", "type": "commit"}, {"oid": "70608730ae0812ebbc926eca467c79320863cc59", "url": "https://github.com/apache/skywalking/commit/70608730ae0812ebbc926eca467c79320863cc59", "message": "Merge branch 'master' into cluster-manager-health", "committedDate": "2020-10-31T14:26:48Z", "type": "commit"}, {"oid": "623ecb7f223a7f89d48526f41192cf3388bd3c33", "url": "https://github.com/apache/skywalking/commit/623ecb7f223a7f89d48526f41192cf3388bd3c33", "message": "Fix dependency check bug, can't call moduleManager.find in provider prepare method", "committedDate": "2020-10-31T14:57:22Z", "type": "commit"}, {"oid": "c2baacc8cecce55ad8dbacb55fb493aa98c7dbb8", "url": "https://github.com/apache/skywalking/commit/c2baacc8cecce55ad8dbacb55fb493aa98c7dbb8", "message": "Fix bug, null pointer exception", "committedDate": "2020-11-01T00:54:58Z", "type": "commit"}, {"oid": "8aeb5fb7ee0c89d436bad56ee64e33dd82a71efd", "url": "https://github.com/apache/skywalking/commit/8aeb5fb7ee0c89d436bad56ee64e33dd82a71efd", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-11-01T00:57:48Z", "type": "commit"}, {"oid": "ee02c20342b0b6c28e5aad4d0b2beebccbe4d14d", "url": "https://github.com/apache/skywalking/commit/ee02c20342b0b6c28e5aad4d0b2beebccbe4d14d", "message": "add change log", "committedDate": "2020-11-01T01:19:16Z", "type": "commit"}, {"oid": "4c23f1fd7f8b198f6b172044cb18b31c84e03505", "url": "https://github.com/apache/skywalking/commit/4c23f1fd7f8b198f6b172044cb18b31c84e03505", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-11-01T07:08:15Z", "type": "commit"}, {"oid": "8ca8e01b048af37e1f25b4e35344a22729429c04", "url": "https://github.com/apache/skywalking/commit/8ca8e01b048af37e1f25b4e35344a22729429c04", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-11-01T09:17:50Z", "type": "commit"}, {"oid": "a1a894ed2832e7dec6ef2780637bd018fefdcbba", "url": "https://github.com/apache/skywalking/commit/a1a894ed2832e7dec6ef2780637bd018fefdcbba", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-11-03T10:18:41Z", "type": "commit"}, {"oid": "749093ea52f387ffc9955afb258742b849cce0c7", "url": "https://github.com/apache/skywalking/commit/749093ea52f387ffc9955afb258742b849cce0c7", "message": "Refactor add unhealth reason", "committedDate": "2020-11-03T12:44:36Z", "type": "commit"}, {"oid": "90998d5dbff1f2a2d6abe39ce6f330bd47ab4fb5", "url": "https://github.com/apache/skywalking/commit/90998d5dbff1f2a2d6abe39ce6f330bd47ab4fb5", "message": "Merge branch 'master' of https://github.com/apache/skywalking", "committedDate": "2020-11-03T12:50:18Z", "type": "commit"}, {"oid": "d725b2d8b2f182c43c801423b5dc34737313ddca", "url": "https://github.com/apache/skywalking/commit/d725b2d8b2f182c43c801423b5dc34737313ddca", "message": "Merge branch 'master' into cluster-manager-health-v2", "committedDate": "2020-11-03T12:51:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MDgwOQ==", "url": "https://github.com/apache/skywalking/pull/5784#discussion_r516670809", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method ZookeeperCoordinator.queryRemoteNodes() indirectly writes to field this.healthChecker outside of synchronization.\nReporting because another access to the same memory occurs on a background thread, although this access may not.", "author": "sonatype-lift", "createdAt": "2020-11-03T13:37:53Z", "path": "oap-server/server-cluster-plugin/cluster-zookeeper-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/zookeeper/ZookeeperCoordinator.java", "diffHunk": "@@ -73,28 +85,49 @@ public synchronized void registerRemote(RemoteInstance remoteInstance) throws Se\n             serviceDiscovery.registerService(thisInstance);\n \n             this.selfAddress = remoteInstance.getAddress();\n-        } catch (Exception e) {\n+            this.healthChecker.health();\n+        } catch (Throwable e) {\n+            this.healthChecker.unHealth(e);\n             throw new ServiceRegisterException(e.getMessage());\n         }\n     }\n \n     @Override\n     public List<RemoteInstance> queryRemoteNodes() {\n-        List<RemoteInstance> remoteInstanceDetails = new ArrayList<>(20);\n-        List<ServiceInstance<RemoteInstance>> serviceInstances = serviceCache.getInstances();\n-        serviceInstances.forEach(serviceInstance -> {\n-            RemoteInstance instance = serviceInstance.getPayload();\n-            if (instance.getAddress().equals(selfAddress)) {\n-                instance.getAddress().setSelf(true);\n+        List<RemoteInstance> remoteInstances = new ArrayList<>(20);\n+        try {\n+            initHealthChecker();", "originalCommit": "749093ea52f387ffc9955afb258742b849cce0c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MDgyMA==", "url": "https://github.com/apache/skywalking/pull/5784#discussion_r516670820", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method ZookeeperCoordinator.setHealthChecker(...) writes to field this.healthChecker outside of synchronization.\nReporting because another access to the same memory occurs on a background thread, although this access may not.", "author": "sonatype-lift", "createdAt": "2020-11-03T13:37:54Z", "path": "oap-server/server-cluster-plugin/cluster-zookeeper-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/zookeeper/ZookeeperCoordinator.java", "diffHunk": "@@ -22,29 +22,40 @@\n import java.util.ArrayList;\n import java.util.List;\n import java.util.UUID;\n+\n+import lombok.Setter;\n import org.apache.curator.x.discovery.ServiceCache;\n import org.apache.curator.x.discovery.ServiceDiscovery;\n import org.apache.curator.x.discovery.ServiceInstance;\n+import org.apache.skywalking.oap.server.core.cluster.ClusterHealthStatus;\n import org.apache.skywalking.oap.server.core.cluster.ClusterNodesQuery;\n import org.apache.skywalking.oap.server.core.cluster.ClusterRegister;\n+import org.apache.skywalking.oap.server.core.cluster.OAPNodeChecker;\n import org.apache.skywalking.oap.server.core.cluster.RemoteInstance;\n+import org.apache.skywalking.oap.server.core.cluster.ServiceQueryException;\n import org.apache.skywalking.oap.server.core.cluster.ServiceRegisterException;\n import org.apache.skywalking.oap.server.core.remote.client.Address;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import org.apache.skywalking.oap.server.library.module.ModuleDefineHolder;\n+import org.apache.skywalking.oap.server.telemetry.TelemetryModule;\n+import org.apache.skywalking.oap.server.telemetry.api.HealthCheckMetrics;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsCreator;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsTag;\n \n public class ZookeeperCoordinator implements ClusterRegister, ClusterNodesQuery {\n-    private static final Logger LOGGER = LoggerFactory.getLogger(ZookeeperCoordinator.class);\n \n     private static final String REMOTE_NAME_PATH = \"remote\";\n \n     private final ClusterModuleZookeeperConfig config;\n     private final ServiceDiscovery<RemoteInstance> serviceDiscovery;\n     private final ServiceCache<RemoteInstance> serviceCache;\n     private volatile Address selfAddress;\n+    @Setter", "originalCommit": "749093ea52f387ffc9955afb258742b849cce0c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3NDQxMQ==", "url": "https://github.com/apache/skywalking/pull/5784#discussion_r516674411", "bodyText": "Move final to following other final fields in the top of the list.", "author": "wu-sheng", "createdAt": "2020-11-03T13:43:23Z", "path": "oap-server/server-cluster-plugin/cluster-zookeeper-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/zookeeper/ZookeeperCoordinator.java", "diffHunk": "@@ -22,29 +22,40 @@\n import java.util.ArrayList;\n import java.util.List;\n import java.util.UUID;\n+\n+import lombok.Setter;\n import org.apache.curator.x.discovery.ServiceCache;\n import org.apache.curator.x.discovery.ServiceDiscovery;\n import org.apache.curator.x.discovery.ServiceInstance;\n+import org.apache.skywalking.oap.server.core.cluster.ClusterHealthStatus;\n import org.apache.skywalking.oap.server.core.cluster.ClusterNodesQuery;\n import org.apache.skywalking.oap.server.core.cluster.ClusterRegister;\n+import org.apache.skywalking.oap.server.core.cluster.OAPNodeChecker;\n import org.apache.skywalking.oap.server.core.cluster.RemoteInstance;\n+import org.apache.skywalking.oap.server.core.cluster.ServiceQueryException;\n import org.apache.skywalking.oap.server.core.cluster.ServiceRegisterException;\n import org.apache.skywalking.oap.server.core.remote.client.Address;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import org.apache.skywalking.oap.server.library.module.ModuleDefineHolder;\n+import org.apache.skywalking.oap.server.telemetry.TelemetryModule;\n+import org.apache.skywalking.oap.server.telemetry.api.HealthCheckMetrics;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsCreator;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsTag;\n \n public class ZookeeperCoordinator implements ClusterRegister, ClusterNodesQuery {\n-    private static final Logger LOGGER = LoggerFactory.getLogger(ZookeeperCoordinator.class);\n \n     private static final String REMOTE_NAME_PATH = \"remote\";\n \n     private final ClusterModuleZookeeperConfig config;\n     private final ServiceDiscovery<RemoteInstance> serviceDiscovery;\n     private final ServiceCache<RemoteInstance> serviceCache;\n     private volatile Address selfAddress;\n+    @Setter\n+    private HealthCheckMetrics healthChecker;\n+    private final ModuleDefineHolder manager;", "originalCommit": "d725b2d8b2f182c43c801423b5dc34737313ddca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3NDc1Nw==", "url": "https://github.com/apache/skywalking/pull/5784#discussion_r516674757", "bodyText": "You don't need the setter I think. Please don't open unnecessary access.", "author": "wu-sheng", "createdAt": "2020-11-03T13:43:52Z", "path": "oap-server/server-cluster-plugin/cluster-zookeeper-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/zookeeper/ZookeeperCoordinator.java", "diffHunk": "@@ -22,29 +22,40 @@\n import java.util.ArrayList;\n import java.util.List;\n import java.util.UUID;\n+\n+import lombok.Setter;\n import org.apache.curator.x.discovery.ServiceCache;\n import org.apache.curator.x.discovery.ServiceDiscovery;\n import org.apache.curator.x.discovery.ServiceInstance;\n+import org.apache.skywalking.oap.server.core.cluster.ClusterHealthStatus;\n import org.apache.skywalking.oap.server.core.cluster.ClusterNodesQuery;\n import org.apache.skywalking.oap.server.core.cluster.ClusterRegister;\n+import org.apache.skywalking.oap.server.core.cluster.OAPNodeChecker;\n import org.apache.skywalking.oap.server.core.cluster.RemoteInstance;\n+import org.apache.skywalking.oap.server.core.cluster.ServiceQueryException;\n import org.apache.skywalking.oap.server.core.cluster.ServiceRegisterException;\n import org.apache.skywalking.oap.server.core.remote.client.Address;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import org.apache.skywalking.oap.server.library.module.ModuleDefineHolder;\n+import org.apache.skywalking.oap.server.telemetry.TelemetryModule;\n+import org.apache.skywalking.oap.server.telemetry.api.HealthCheckMetrics;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsCreator;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsTag;\n \n public class ZookeeperCoordinator implements ClusterRegister, ClusterNodesQuery {\n-    private static final Logger LOGGER = LoggerFactory.getLogger(ZookeeperCoordinator.class);\n \n     private static final String REMOTE_NAME_PATH = \"remote\";\n \n     private final ClusterModuleZookeeperConfig config;\n     private final ServiceDiscovery<RemoteInstance> serviceDiscovery;\n     private final ServiceCache<RemoteInstance> serviceCache;\n     private volatile Address selfAddress;\n+    @Setter", "originalCommit": "d725b2d8b2f182c43c801423b5dc34737313ddca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e018ecd7ecefc83f9a3be53aacc9debd1440b119", "url": "https://github.com/apache/skywalking/commit/e018ecd7ecefc83f9a3be53aacc9debd1440b119", "message": "Merge branch 'master' into cluster-manager-health-v2", "committedDate": "2020-11-03T14:03:00Z", "type": "commit"}, {"oid": "20015a7133c33d956b497dd81771199e314a497b", "url": "https://github.com/apache/skywalking/commit/20015a7133c33d956b497dd81771199e314a497b", "message": "format checkstyle", "committedDate": "2020-11-03T14:17:38Z", "type": "commit"}]}