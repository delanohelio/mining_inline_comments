{"pr_number": 5320, "pr_title": "spring annotation enhance", "pr_createdAt": "2020-08-15T05:59:23Z", "pr_url": "https://github.com/apache/skywalking/pull/5320", "timeline": [{"oid": "26acc3939dcd05c1225339b354160dc6c606a5bd", "url": "https://github.com/apache/skywalking/commit/26acc3939dcd05c1225339b354160dc6c606a5bd", "message": "spring annotation enhance", "committedDate": "2020-08-15T05:56:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0NDEyOA==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r470944128", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        public static String REGEX_EXPRESSION = \".*Service.*,.*Dao.*,.*Repository.*\";\n          \n          \n            \n                        public static String REGEX_EXPRESSION = \".*Service$,.*Dao$,.*DAO$,.*Repository$\";", "author": "kezhenxu94", "createdAt": "2020-08-15T06:15:56Z", "path": "apm-sniffer/optional-plugins/optional-spring-plugins/spring-annotation-plugin/src/main/java/org/apache/skywalking/apm/plugin/spring/annotations/SpringAnnotationConfig.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.spring.annotations;\n+\n+import org.apache.skywalking.apm.agent.core.boot.PluginConfig;\n+\n+public class SpringAnnotationConfig {\n+\n+    public static class Plugin {\n+        @PluginConfig(root = SpringAnnotationConfig.class)\n+        public static class SpringAnnotation {\n+            /**\n+             * regex expression to match spring bean\n+             */\n+            public static String REGEX_EXPRESSION = \".*Service.*,.*Dao.*,.*Repository.*\";", "originalCommit": "26acc3939dcd05c1225339b354160dc6c606a5bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0NjMxOA==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r470946318", "bodyText": "This should not You set this works in default, which could make users confused, because, once their classes are not matching these default rules, they will not be traced.\nSo, this should be default OFF.", "author": "wu-sheng", "createdAt": "2020-08-15T06:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0NDEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0NDQzNQ==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r470944435", "bodyText": "This class is very case-specific, please consider reusing org.apache.skywalking.apm.agent.core.plugin.match.logical.LogicalMatchOperation to perform the logical operations", "author": "kezhenxu94", "createdAt": "2020-08-15T06:20:37Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/plugin/match/ClassAnnotationPackageRegexMatch.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.plugin.match;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import net.bytebuddy.description.annotation.AnnotationDescription;\n+import net.bytebuddy.description.annotation.AnnotationList;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+import static net.bytebuddy.matcher.ElementMatchers.isInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.nameMatches;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+\n+/**\n+ * Match the class by the given annotations and regex expression matching package name.\n+ */\n+public class ClassAnnotationPackageRegexMatch implements IndirectMatch {", "originalCommit": "26acc3939dcd05c1225339b354160dc6c606a5bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ed16a898ccc0e861890c3cc5186823fbe2332a2", "url": "https://github.com/apache/skywalking/commit/5ed16a898ccc0e861890c3cc5186823fbe2332a2", "message": "spring annotation enhance", "committedDate": "2020-08-16T09:47:07Z", "type": "commit"}, {"oid": "8ec8173f7f0e9de455aefc1a935cc07e6cf53a91", "url": "https://github.com/apache/skywalking/commit/8ec8173f7f0e9de455aefc1a935cc07e6cf53a91", "message": "Merge remote-tracking branch 'upstream/master' into enhance-spring-annotation", "committedDate": "2020-08-16T10:04:55Z", "type": "commit"}, {"oid": "b486f6376c94299ae913d09f025f9e6134342833", "url": "https://github.com/apache/skywalking/commit/b486f6376c94299ae913d09f025f9e6134342833", "message": "spring annotation enhance", "committedDate": "2020-08-16T11:39:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExNTA1NA==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471115054", "bodyText": "I think this is the Class Name match? Not a package name?\nThe default value should be empty, which is more high-efficiency.", "author": "wu-sheng", "createdAt": "2020-08-16T13:45:25Z", "path": "apm-sniffer/optional-plugins/optional-spring-plugins/spring-annotation-plugin/src/main/java/org/apache/skywalking/apm/plugin/spring/annotations/SpringAnnotationConfig.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.spring.annotations;\n+\n+import org.apache.skywalking.apm.agent.core.boot.PluginConfig;\n+\n+public class SpringAnnotationConfig {\n+\n+    public static class Plugin {\n+        @PluginConfig(root = SpringAnnotationConfig.class)\n+        public static class SpringAnnotation {\n+            /**\n+             * regex expression to match spring bean\n+             */\n+            public static String PACKAGE_MATCH_REGEX_EXPRESSION = \".*\";", "originalCommit": "b486f6376c94299ae913d09f025f9e6134342833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExNzQ1Mw==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471117453", "bodyText": "resolved", "author": "EvanLjp", "createdAt": "2020-08-16T14:09:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExNTA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExNTI3Mw==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471115273", "bodyText": "Should only activate and byRegexMatch if the  #getRegexExpressions return not null. Then, it is better for matching mechanism performance.", "author": "wu-sheng", "createdAt": "2020-08-16T13:47:47Z", "path": "apm-sniffer/optional-plugins/optional-spring-plugins/spring-annotation-plugin/src/main/java/org/apache/skywalking/apm/plugin/spring/annotations/services/SpringServicesInstrumentation.java", "diffHunk": "@@ -19,16 +19,21 @@\n package org.apache.skywalking.apm.plugin.spring.annotations.services;\n \n import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.match.logical.LogicalMatchOperation;\n import org.apache.skywalking.apm.plugin.spring.annotations.AbstractSpringBeanInstrumentation;\n \n import static org.apache.skywalking.apm.agent.core.plugin.match.ClassAnnotationMatch.byClassAnnotationMatch;\n+import static org.apache.skywalking.apm.agent.core.plugin.match.RegexMatch.byRegexMatch;\n \n public class SpringServicesInstrumentation extends AbstractSpringBeanInstrumentation {\n \n     public static final String ENHANCE_ANNOTATION = \"org.springframework.stereotype.Service\";\n \n     @Override\n     protected ClassMatch enhanceClass() {\n-        return byClassAnnotationMatch(new String[] {ENHANCE_ANNOTATION});\n+        return LogicalMatchOperation.and(", "originalCommit": "b486f6376c94299ae913d09f025f9e6134342833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExNzQ0NA==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471117444", "bodyText": "resolved", "author": "EvanLjp", "createdAt": "2020-08-16T14:09:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExNTI3Mw=="}], "type": "inlineReview"}, {"oid": "79b149a67eeeeb058a2d9cfb6545cca10b938887", "url": "https://github.com/apache/skywalking/commit/79b149a67eeeeb058a2d9cfb6545cca10b938887", "message": "change to CLASSNAME_MATCH_REGEX_EXPRESSION", "committedDate": "2020-08-16T14:08:08Z", "type": "commit"}, {"oid": "57a6f5dd2d14871c953bd53225acc858ed29a95b", "url": "https://github.com/apache/skywalking/commit/57a6f5dd2d14871c953bd53225acc858ed29a95b", "message": "change doc description", "committedDate": "2020-08-16T14:48:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTEyMjExMg==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471122112", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Match the class by the given annotations and regex expression matching package name.\n          \n          \n            \n             * Match the class by the given annotations and regex expression matching class name.", "author": "wu-sheng", "createdAt": "2020-08-16T14:52:35Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/plugin/match/RegexMatch.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.plugin.match;\n+\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.nameMatches;\n+\n+/**\n+ * Match the class by the given annotations and regex expression matching package name.", "originalCommit": "57a6f5dd2d14871c953bd53225acc858ed29a95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTEyOTIxMg==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471129212", "bodyText": "thx for your notice. Has been resolved. Would be careful next time.", "author": "EvanLjp", "createdAt": "2020-08-16T16:01:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTEyMjExMg=="}], "type": "inlineReview"}, {"oid": "df617439d1103839a58f5323ad5c94b7bf20f0c6", "url": "https://github.com/apache/skywalking/commit/df617439d1103839a58f5323ad5c94b7bf20f0c6", "message": "change java doc", "committedDate": "2020-08-16T15:58:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4MzQ1NA==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471183454", "bodyText": "Question, this is a one-line method, why need this?", "author": "wu-sheng", "createdAt": "2020-08-17T00:50:51Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/plugin/match/RegexMatch.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.plugin.match;\n+\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.nameMatches;\n+\n+/**\n+ * Match the class by given class name regex expression.\n+ */\n+public class RegexMatch implements IndirectMatch {\n+    private String[] regexExpressions;\n+\n+    private RegexMatch(String... regexExpressions) {\n+        if (regexExpressions == null || regexExpressions.length == 0) {\n+            throw new IllegalArgumentException(\"annotations is null\");\n+        }\n+        this.regexExpressions = regexExpressions;\n+    }\n+\n+    @Override\n+    public ElementMatcher.Junction buildJunction() {\n+        ElementMatcher.Junction regexJunction = null;\n+        for (String regexExpression : regexExpressions) {\n+            if (regexJunction == null) {\n+                regexJunction = buildEachMatchExpression(regexExpression);\n+            } else {\n+                regexJunction = regexJunction.or(buildEachMatchExpression(regexExpression));\n+            }\n+        }\n+        return regexJunction;\n+    }\n+\n+    @Override\n+    public boolean isMatch(TypeDescription typeDescription) {\n+        boolean isMatch = false;\n+        for (String matchExpression : regexExpressions) {\n+            isMatch = isMatch || typeDescription.getTypeName().matches(matchExpression);\n+        }\n+        return isMatch;\n+    }\n+\n+    private ElementMatcher.Junction buildEachMatchExpression(String matchExpression) {", "originalCommit": "df617439d1103839a58f5323ad5c94b7bf20f0c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4NTA2Mw==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471185063", "bodyText": "sorry,has been removed", "author": "EvanLjp", "createdAt": "2020-08-17T01:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4MzQ1NA=="}], "type": "inlineReview"}, {"oid": "7290031724823da57ceb4bc38a04cd1dcb320574", "url": "https://github.com/apache/skywalking/commit/7290031724823da57ceb4bc38a04cd1dcb320574", "message": "remove unnecessary method", "committedDate": "2020-08-17T01:00:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4NzMwNg==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471187306", "bodyText": "This is just a reminder, (I don't know whether existing matches have this issue), even a type has been matched, it still needs to iterate the whole expression array. There should be a break.", "author": "wu-sheng", "createdAt": "2020-08-17T01:14:48Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/plugin/match/RegexMatch.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.plugin.match;\n+\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.nameMatches;\n+\n+/**\n+ * Match the class by given class name regex expression.\n+ */\n+public class RegexMatch implements IndirectMatch {\n+    private String[] regexExpressions;\n+\n+    private RegexMatch(String... regexExpressions) {\n+        if (regexExpressions == null || regexExpressions.length == 0) {\n+            throw new IllegalArgumentException(\"annotations is null\");\n+        }\n+        this.regexExpressions = regexExpressions;\n+    }\n+\n+    @Override\n+    public ElementMatcher.Junction buildJunction() {\n+        ElementMatcher.Junction regexJunction = null;\n+        for (String regexExpression : regexExpressions) {\n+            if (regexJunction == null) {\n+                regexJunction = nameMatches(regexExpression);\n+            } else {\n+                regexJunction = regexJunction.or(nameMatches(regexExpression));\n+            }\n+        }\n+        return regexJunction;\n+    }\n+\n+    @Override\n+    public boolean isMatch(TypeDescription typeDescription) {\n+        boolean isMatch = false;\n+        for (String matchExpression : regexExpressions) {\n+            isMatch = isMatch || typeDescription.getTypeName().matches(matchExpression);", "originalCommit": "7290031724823da57ceb4bc38a04cd1dcb320574", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4ODQ0OA==", "url": "https://github.com/apache/skywalking/pull/5320#discussion_r471188448", "bodyText": "thx for your notice.already add break", "author": "EvanLjp", "createdAt": "2020-08-17T01:22:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4NzMwNg=="}], "type": "inlineReview"}, {"oid": "69f8d1d66f24e5f88e9cb503eba24849f1a1cf5b", "url": "https://github.com/apache/skywalking/commit/69f8d1d66f24e5f88e9cb503eba24849f1a1cf5b", "message": "enhance org.apache.skywalking.apm.agent.core.plugin.match.RegexMatch#isMatch", "committedDate": "2020-08-17T01:20:46Z", "type": "commit"}]}