{"pr_number": 569, "pr_title": "feat: add basic functions of demo mode", "pr_createdAt": "2020-02-14T08:27:27Z", "pr_url": "https://github.com/halo-dev/halo/pull/569", "timeline": [{"oid": "7933bc172058aee53ada61f23b5e8a93da848e13", "url": "https://github.com/halo-dev/halo/commit/7933bc172058aee53ada61f23b5e8a93da848e13", "message": "feat: add basic functions of demo mode", "committedDate": "2020-02-14T08:25:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzExMg==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379303112", "bodyText": "\u53ef\u4ee5\u5220\u6389\u4e86", "author": "ruibaby", "createdAt": "2020-02-14T08:30:44Z", "path": "src/main/java/run/halo/app/handler/aspect/DisableApiAspect.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package run.halo.app.handler.aspect;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import run.halo.app.Application;\n+import run.halo.app.model.annotation.DisableApi;\n+import run.halo.app.model.enums.Mode;\n+import run.halo.app.model.support.BaseResponse;\n+\n+/**\n+ * \u81ea\u5b9a\u4e49\u6ce8\u89e3DisableApi\u7684\u5207\u9762\n+ * @author guqing\n+ * @date 2020-02-14 14:08\n+ */\n+@Aspect\n+@Component\n+public class DisableApiAspect {\n+    @Value(\"${spring.profiles.active:prod}\")\n+    private String activeProfile;\n+\n+    @Pointcut(\"@annotation(run.halo.app.model.annotation.DisableApi)\")\n+    public void pointcut(){}\n+\n+    @Around(\"pointcut() && @annotation(disableApi)\")\n+    public Object around(ProceedingJoinPoint joinPoint,\n+                         DisableApi disableApi){\n+        Mode mode = disableApi.mode();\n+        System.out.println(activeProfile);", "originalCommit": "7933bc172058aee53ada61f23b5e8a93da848e13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379303608", "bodyText": "\u4e0d\u6b62\u5bc6\u7801\uff0c\u8fd8\u6709\u4fee\u6539\u7cfb\u7edf\u8bbe\u7f6e", "author": "ruibaby", "createdAt": "2020-02-14T08:32:02Z", "path": "src/main/java/run/halo/app/controller/admin/api/UserController.java", "diffHunk": "@@ -49,6 +50,7 @@ public UserDTO updateProfile(@RequestBody UserParam userParam, User user) {\n     }\n \n     @PutMapping(\"profiles/password\")\n+    @DisableApi", "originalCommit": "7933bc172058aee53ada61f23b5e8a93da848e13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzg5Mw==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379303893", "bodyText": "\u8fd8\u6709\u5f00\u53d1\u8005\u9009\u9879\u91cc\u9762\u7684\u4e00\u4e9b API", "author": "ruibaby", "createdAt": "2020-02-14T08:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwNjMwNg==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379306306", "bodyText": "\u8fd8\u6ca1\u5199\u5b8c  \u4e00\u4f1a\u513f\u6539\ud83d\ude02\u8fd8\u6709\u5b9a\u65f6\u590d\u539f\u7684\u529f\u80fd", "author": "guqing", "createdAt": "2020-02-14T08:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwNzY3OQ==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379307679", "bodyText": "run.halo.app.controller.admin.api.OptionController#saveOptions\nrun.halo.app.controller.admin.api.OptionController#createBy\nrun.halo.app.controller.admin.api.OptionController#updateBy\nrun.halo.app.controller.admin.api.OptionController#deletePermanently\nrun.halo.app.controller.admin.api.OptionController#saveOptionsWithMapView\nrun.halo.app.controller.admin.api.AdminController#resetPassword\nrun.halo.app.controller.admin.api.AdminController#updateSpringApplicationConfig\nrun.halo.app.controller.admin.api.AdminController#restartApplication", "author": "ruibaby", "createdAt": "2020-02-14T08:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwNzkzNw==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379307937", "bodyText": "\u597d\u7684", "author": "guqing", "createdAt": "2020-02-14T08:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwODQyMg==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379308422", "bodyText": "\u8fd8\u6ca1\u5199\u5b8c \u4e00\u4f1a\u513f\u6539\ud83d\ude02\u8fd8\u6709\u5b9a\u65f6\u590d\u539f\u7684\u529f\u80fd\n\n\u5b9a\u65f6\u590d\u539f\u7684\u903b\u8f91\u4e5f\u8981\u52a0\u5417\uff1f", "author": "ruibaby", "createdAt": "2020-02-14T08:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMxNjgxMA==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379316810", "bodyText": "\u4f60\u4eec\u4e0d\u662f\u90fd\u8bf4\u9700\u8981\u8fd9\u4e2a\u529f\u80fd\u5417\uff0c\u4e0d\u8981\u4e5f\u53ef\u4ee5\u4e0d\u5199", "author": "guqing", "createdAt": "2020-02-14T09:04:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM2NDIyNw==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379364227", "bodyText": "\u4e0d\u5efa\u8bae\u52a0\u5728 halo \u91cc\u9762", "author": "ruibaby", "createdAt": "2020-02-14T10:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM2NDc4Mw==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379364783", "bodyText": "\u597d\u7684", "author": "guqing", "createdAt": "2020-02-14T10:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwODE5Mg==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379308192", "bodyText": "\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u629b\u51fa ForbiddenException", "author": "ruibaby", "createdAt": "2020-02-14T08:44:05Z", "path": "src/main/java/run/halo/app/handler/aspect/DisableApiAspect.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package run.halo.app.handler.aspect;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import run.halo.app.Application;\n+import run.halo.app.model.annotation.DisableApi;\n+import run.halo.app.model.enums.Mode;\n+import run.halo.app.model.support.BaseResponse;\n+\n+/**\n+ * \u81ea\u5b9a\u4e49\u6ce8\u89e3DisableApi\u7684\u5207\u9762\n+ * @author guqing\n+ * @date 2020-02-14 14:08\n+ */\n+@Aspect\n+@Component\n+public class DisableApiAspect {\n+    @Value(\"${spring.profiles.active:prod}\")\n+    private String activeProfile;\n+\n+    @Pointcut(\"@annotation(run.halo.app.model.annotation.DisableApi)\")\n+    public void pointcut(){}\n+\n+    @Around(\"pointcut() && @annotation(disableApi)\")\n+    public Object around(ProceedingJoinPoint joinPoint,\n+                         DisableApi disableApi){\n+        Mode mode = disableApi.mode();\n+        System.out.println(activeProfile);\n+        System.out.println(mode.name());\n+        if(StringUtils.equalsIgnoreCase(mode.name(), activeProfile)) {\n+            return new BaseResponse<>(HttpStatus.FORBIDDEN.value(), \"\u7981\u6b62\u8bbf\u95ee\",null);", "originalCommit": "7933bc172058aee53ada61f23b5e8a93da848e13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwODc2Mg==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379308762", "bodyText": "\u629b\u5f02\u5e38\u4e0d\u592a\u53cb\u597d\u5427", "author": "guqing", "createdAt": "2020-02-14T08:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwODE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMxMjA2Mg==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379312062", "bodyText": "\u76f4\u63a5\u629b\u5f02\u5e38\u5373\u53ef", "author": "JohnNiang", "createdAt": "2020-02-14T08:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwODE5Mg=="}], "type": "inlineReview"}, {"oid": "5143ed9d1736dc40b9edd6e935b09a3a7ff0bfdf", "url": "https://github.com/halo-dev/halo/commit/5143ed9d1736dc40b9edd6e935b09a3a7ff0bfdf", "message": "feat: add @disableApi annotation to some API that should be disabled", "committedDate": "2020-02-14T08:57:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMxNDk3NQ==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379314975", "bodyText": "\u5efa\u8bae\u7528 log \u8fdb\u884c\u6253\u5370\u65e5\u5fd7\uff0c\u5c3d\u53ef\u80fd\u4e0d\u8981\u4f7f\u7528 System.out\u3002", "author": "JohnNiang", "createdAt": "2020-02-14T09:00:03Z", "path": "src/main/java/run/halo/app/handler/aspect/DisableApiAspect.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package run.halo.app.handler.aspect;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import run.halo.app.Application;\n+import run.halo.app.model.annotation.DisableApi;\n+import run.halo.app.model.enums.Mode;\n+import run.halo.app.model.support.BaseResponse;\n+\n+/**\n+ * \u81ea\u5b9a\u4e49\u6ce8\u89e3DisableApi\u7684\u5207\u9762\n+ * @author guqing\n+ * @date 2020-02-14 14:08\n+ */\n+@Aspect\n+@Component\n+public class DisableApiAspect {\n+    @Value(\"${spring.profiles.active:prod}\")\n+    private String activeProfile;\n+\n+    @Pointcut(\"@annotation(run.halo.app.model.annotation.DisableApi)\")\n+    public void pointcut(){}\n+\n+    @Around(\"pointcut() && @annotation(disableApi)\")\n+    public Object around(ProceedingJoinPoint joinPoint,\n+                         DisableApi disableApi){\n+        Mode mode = disableApi.mode();\n+        System.out.println(activeProfile);", "originalCommit": "7933bc172058aee53ada61f23b5e8a93da848e13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMxNjQyNg==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379316426", "bodyText": "\u4e0d\u8981\u76f4\u63a5 printStackTrace()\uff0c\u7528  log.error \u66ff\u4ee3\u3002\u800c\u4e14\uff0c\u5982\u679c\u8fd9\u91cc\u5ffd\u7565\u4e86\u5f02\u5e38\uff0c\u90a3\u4e48\u5728 Filter \u540e\u9762\u5c31\u65e0\u6cd5\u6355\u6349\u5230\u5f02\u5e38\u4e86\uff0c\u5bfc\u81f4 Service\uff0cDao \u4e2d\u629b\u51fa\u7684\u5f02\u5e38\u90fd\u5c06\u5931\u6548\u3002", "author": "JohnNiang", "createdAt": "2020-02-14T09:03:04Z", "path": "src/main/java/run/halo/app/handler/aspect/DisableApiAspect.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package run.halo.app.handler.aspect;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import run.halo.app.Application;\n+import run.halo.app.model.annotation.DisableApi;\n+import run.halo.app.model.enums.Mode;\n+import run.halo.app.model.support.BaseResponse;\n+\n+/**\n+ * \u81ea\u5b9a\u4e49\u6ce8\u89e3DisableApi\u7684\u5207\u9762\n+ * @author guqing\n+ * @date 2020-02-14 14:08\n+ */\n+@Aspect\n+@Component\n+public class DisableApiAspect {\n+    @Value(\"${spring.profiles.active:prod}\")\n+    private String activeProfile;\n+\n+    @Pointcut(\"@annotation(run.halo.app.model.annotation.DisableApi)\")\n+    public void pointcut(){}\n+\n+    @Around(\"pointcut() && @annotation(disableApi)\")\n+    public Object around(ProceedingJoinPoint joinPoint,\n+                         DisableApi disableApi){\n+        Mode mode = disableApi.mode();\n+        System.out.println(activeProfile);\n+        System.out.println(mode.name());\n+        if(StringUtils.equalsIgnoreCase(mode.name(), activeProfile)) {\n+            return new BaseResponse<>(HttpStatus.FORBIDDEN.value(), \"\u7981\u6b62\u8bbf\u95ee\",null);\n+        }\n+        Object proceed = null;\n+        try {\n+            proceed = joinPoint.proceed();\n+        } catch (Throwable throwable) {\n+            throwable.printStackTrace();", "originalCommit": "7933bc172058aee53ada61f23b5e8a93da848e13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMyNzMzNA==", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379327334", "bodyText": "\u597d\u7684", "author": "guqing", "createdAt": "2020-02-14T09:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMxNjQyNg=="}], "type": "inlineReview"}, {"oid": "1302ec33c251c56de8de5b279725f401e42dbefa", "url": "https://github.com/halo-dev/halo/commit/1302ec33c251c56de8de5b279725f401e42dbefa", "message": "feat: add DisableApi test case", "committedDate": "2020-02-14T09:50:33Z", "type": "commit"}, {"oid": "0c93babea0291526c6c8d25184a184f6b8f3c134", "url": "https://github.com/halo-dev/halo/commit/0c93babea0291526c6c8d25184a184f6b8f3c134", "message": "fix: change DisableApi annotation name to DisableOnConditation", "committedDate": "2020-02-14T11:51:50Z", "type": "commit"}, {"oid": "7f944330799fa8c82e42a7e52e90274781df6755", "url": "https://github.com/halo-dev/halo/commit/7f944330799fa8c82e42a7e52e90274781df6755", "message": "Merge branch 'master' into demo", "committedDate": "2020-02-14T12:58:52Z", "type": "commit"}, {"oid": "8fd9f39fd02b8dcf03fedfdd6dd7cc6203243fbb", "url": "https://github.com/halo-dev/halo/commit/8fd9f39fd02b8dcf03fedfdd6dd7cc6203243fbb", "message": "Fix test cases", "committedDate": "2020-02-14T13:53:17Z", "type": "commit"}, {"oid": "0aa07c4f36681a44d0e4871d85f1a676933b2dea", "url": "https://github.com/halo-dev/halo/commit/0aa07c4f36681a44d0e4871d85f1a676933b2dea", "message": "Add more strict test on failing case", "committedDate": "2020-02-14T14:00:52Z", "type": "commit"}, {"oid": "fbef42a13f36374d2faff59d865b42f36a3e5c45", "url": "https://github.com/halo-dev/halo/commit/fbef42a13f36374d2faff59d865b42f36a3e5c45", "message": "Merge pull request #2 from JohnNiang/fix/disable-api-test-case\n\nFix test cases", "committedDate": "2020-02-14T14:03:14Z", "type": "commit"}]}