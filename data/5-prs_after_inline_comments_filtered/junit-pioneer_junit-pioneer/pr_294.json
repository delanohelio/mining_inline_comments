{"pr_number": 294, "pr_title": "Added variables to ReportEntry", "pr_createdAt": "2020-07-09T17:09:02Z", "pr_url": "https://github.com/junit-pioneer/junit-pioneer/pull/294", "timeline": [{"oid": "7081a4c045e3de79007f0f09fc55ad118ab90cd9", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/7081a4c045e3de79007f0f09fc55ad118ab90cd9", "message": "Added variables to ReportEntry\nRefer to test method arguments with numbers between curly braces, starting with {0}.\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-09T17:07:35Z", "type": "commit"}, {"oid": "714be7ce2964c863252e239b500383723a100243", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/714be7ce2964c863252e239b500383723a100243", "message": "Added new tests, documentation and exception for variable in key\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-14T20:44:03Z", "type": "commit"}, {"oid": "6658f321bd6f5e15c80567274ac3d67225b3dd3e", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/6658f321bd6f5e15c80567274ac3d67225b3dd3e", "message": "Merge branch 'master' of https://github.com/junit-pioneer/junit-pioneer into issue/179-report-entry-improvement\n\n\u0001 Conflicts:\n\u0001\tsrc/test/java/org/junitpioneer/jupiter/ReportEntryExtensionTests.java", "committedDate": "2020-07-14T20:47:13Z", "type": "commit"}, {"oid": "72e74af37c4bcf3924916bd3b124d2b2dc8d9471", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/72e74af37c4bcf3924916bd3b124d2b2dc8d9471", "message": "Changed tests - now they need Pioneer assertion updates.\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-15T08:37:58Z", "type": "commit"}, {"oid": "bec4ceade4a3a16055070a1114d7af7c3a7f6b2e", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/bec4ceade4a3a16055070a1114d7af7c3a7f6b2e", "message": "Fixed a mistake in documentation\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-15T08:43:08Z", "type": "commit"}, {"oid": "dccf86090cda246d3876550dd57d5f5be483403e", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/dccf86090cda246d3876550dd57d5f5be483403e", "message": "Remove unused import\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-15T08:51:19Z", "type": "commit"}, {"oid": "65c6f9fcc5e3d4d5561fe122e33d961c98911010", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/65c6f9fcc5e3d4d5561fe122e33d961c98911010", "message": "WIP commit\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-17T13:36:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5NjY5OA==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456896698", "bodyText": "This seems that this message only works if the method has one parameter less than the ReportEntry? What if there are multiple missing?  This misconfiguration should also be mentioned in the docs, as the error messages is only clear (to me) when knowing the  context.", "author": "Bukama", "createdAt": "2020-07-19T11:28:19Z", "path": "src/main/java/org/junitpioneer/jupiter/ReportEntryExtension.java", "diffHunk": "@@ -16,26 +16,62 @@\n import static org.junitpioneer.jupiter.ReportEntry.PublishCondition.ON_FAILURE;\n import static org.junitpioneer.jupiter.ReportEntry.PublishCondition.ON_SUCCESS;\n \n+import java.lang.reflect.Method;\n import java.util.Arrays;\n+import java.util.List;\n import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n import java.util.stream.Stream;\n \n import org.junit.jupiter.api.extension.BeforeEachCallback;\n import org.junit.jupiter.api.extension.ExtensionConfigurationException;\n import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.api.extension.InvocationInterceptor;\n+import org.junit.jupiter.api.extension.ReflectiveInvocationContext;\n import org.junit.jupiter.api.extension.TestWatcher;\n \n-class ReportEntryExtension implements TestWatcher, BeforeEachCallback {\n+class ReportEntryExtension implements TestWatcher, BeforeEachCallback, InvocationInterceptor {\n+\n+\tprivate static final ExtensionContext.Namespace NAMESPACE = ExtensionContext.Namespace\n+\t\t\t.create(ReportEntryExtension.class);\n+\n+\tprivate static final String KEY = \"ReportEntry\";\n \n \t@Override\n \tpublic void beforeEach(ExtensionContext context) {\n-\t\tfindAnnotations(context).forEach(ReportEntryExtension::verifyKeyValueAreNotBlank);\n+\t\tfindAnnotations(context).forEach(entry -> verifyReportEntry(context, entry));\n \t}\n \n \tprivate Stream<ReportEntry> findAnnotations(ExtensionContext context) {\n \t\treturn PioneerAnnotationUtils.findAllEnclosingRepeatableAnnotations(context, ReportEntry.class);\n \t}\n \n+\tprivate static void verifyReportEntry(ExtensionContext context, ReportEntry entry) {\n+\t\tverifyParameterCount(context, entry);\n+\t\tverifyKeyValueAreNotBlank(entry);\n+\t\tverifyKeyNotParameterized(entry);\n+\t}\n+\n+\tprivate static void verifyKeyNotParameterized(ReportEntry entry) {\n+\t\tif (entry.key().matches(\".*\\\\{([0-9])+}.*\")) {\n+\t\t\tString message = \"Report entry can not have variables in the key: { key=\\\"%s\\\" value=\\\"%s\\\" }\";\n+\t\t\tthrow new ExtensionConfigurationException(format(message, entry.key(), entry.value()));\n+\t\t}\n+\t}\n+\n+\tprivate static void verifyParameterCount(ExtensionContext context, ReportEntry entry) {\n+\t\tMatcher matcher = Pattern.compile(\"\\\\{([0-9])+}\").matcher(entry.value());\n+\t\tint variableCount = 0;\n+\t\twhile (matcher.find())\n+\t\t\tvariableCount++;\n+\n+\t\tif (context.getRequiredTestMethod().getParameterCount() < variableCount) {\n+\t\t\tString message = \"Report entry contains unresolved variable(s): { key=\\\"%s\\\" value=\\\"%s\\\" }\";\n+\t\t\tthrow new ExtensionConfigurationException(format(message, entry.key(), entry.value()));", "originalCommit": "dccf86090cda246d3876550dd57d5f5be483403e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkzNTk0NA==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456935944", "bodyText": "Why does it seem that way? I don't see it. Could you elaborate?", "author": "Michael1993", "createdAt": "2020-07-19T17:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5NjY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MzI4MA==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456943280", "bodyText": "Because there is one key/value reported and an exception thrown, so no more are tested. Or do I have a mind bug?", "author": "Bukama", "createdAt": "2020-07-19T19:04:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5NjY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0NTY4MQ==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456945681", "bodyText": "No, I see what you mean. This is incorrect. Will fix shortly.", "author": "Michael1993", "createdAt": "2020-07-19T19:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5NjY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk2MDUwNQ==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456960505", "bodyText": "Should be fixed now.", "author": "Michael1993", "createdAt": "2020-07-19T21:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5NjY5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5Njk3NQ==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456896975", "bodyText": "Shouldn't there be a start of line and end of line symbol in the regEx?", "author": "Bukama", "createdAt": "2020-07-19T11:31:12Z", "path": "src/main/java/org/junitpioneer/jupiter/ReportEntryExtension.java", "diffHunk": "@@ -60,16 +96,35 @@ public void testAborted(ExtensionContext context, Throwable cause) {\n \n \t@Override\n \tpublic void testFailed(ExtensionContext context, Throwable cause) {\n-\t\tpublishOnConditions(context, ALWAYS, ON_FAILURE);\n+\t\tif (!(cause instanceof ExtensionConfigurationException)) {\n+\t\t\tpublishOnConditions(context, ALWAYS, ON_FAILURE);\n+\t\t}\n \t}\n \n \tprivate void publishOnConditions(ExtensionContext context, ReportEntry.PublishCondition... conditions) {\n \t\tfindAnnotations(context)\n \t\t\t\t.filter(entry -> Arrays.asList(conditions).contains(entry.when()))\n-\t\t\t\t// we filter for empty keys/values because this is called if the test failed -\n-\t\t\t\t// even if it's due to bad extension configuration (but we don't publish for those)\n-\t\t\t\t.filter(entry -> !entry.key().isEmpty() && !entry.value().isEmpty())\n-\t\t\t\t.forEach(entry -> context.publishReportEntry(entry.key(), entry.value()));\n+\t\t\t\t.forEach(entry -> context.publishReportEntry(entry.key(), parseVariables(entry.value(), context)));\n+\t}\n+\n+\tprivate String parseVariables(String value, ExtensionContext context) {\n+\t\tif (!value.matches(\".*\\\\{.*}.*\"))", "originalCommit": "dccf86090cda246d3876550dd57d5f5be483403e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5NzI2OA==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456897268", "bodyText": "I don't understand the regex. The \\\\ means you check for \\ (first backslash is to escape second baskslash), but why even check for a baskslash? Then inside the curly braces you check for any character which may or may not be there (there can be no character between the curly braces). But I think (look below in line 117) you search for numeric (interger) values. So why you don't check for them inside the regex?", "author": "Bukama", "createdAt": "2020-07-19T11:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5Njk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkzNTgyMA==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456935820", "bodyText": "We don't really care where we find the regex inside the String so there is no need for boundary matchers.\n{ and } are 'special' characters in regexes (quantifiers?). For example a{5} means exactly five a characters. Because of this, the opening { needs to be \"escaped\" in the regex. Normally this would be done with \\{ however, in Java, \\ is an escape character already (e.g.: \\n is newline). So, we have to put \\\\ in the regex - first, to escape from the String, then to escape from the regex. Worse than Alcatraz, really.\nThis is an early return, checking for a negative - if there are no curly braces in the value, we return immediately because there are no variables in the @ReportEntry value. If there are, we try to parse them and throw an exception if they cannot be parsed. An argument could be made that empty curly braces, i.e.: {} should not throw an exception - if you think that should be changed, let me know.", "author": "Michael1993", "createdAt": "2020-07-19T17:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5Njk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0NDkwOQ==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r456944909", "bodyText": "I should stop reviewing, of course \\\\{ is the regex and not \\{ \ud83e\udd26", "author": "Bukama", "createdAt": "2020-07-19T19:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5Njk3NQ=="}], "type": "inlineReview"}, {"oid": "19939552d9f7854e6150889685425907f7358890", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/19939552d9f7854e6150889685425907f7358890", "message": "Incorporate code review feedback\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-19T21:58:23Z", "type": "commit"}, {"oid": "8bf381e45ea72a9a371c50f9ff29c8627e1da5cb", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/8bf381e45ea72a9a371c50f9ff29c8627e1da5cb", "message": "Remove unnecessary parentheses from regex\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-19T22:06:33Z", "type": "commit"}, {"oid": "690ddcc1cf53d65acad1e60cc4f08582fad9a537", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/690ddcc1cf53d65acad1e60cc4f08582fad9a537", "message": "Small edits", "committedDate": "2020-07-28T20:31:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2MTgxMg==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r461861812", "bodyText": "Maybe extract matches(\".*\\\\{[0-9]+}.*\") into a method?", "author": "nipafx", "createdAt": "2020-07-28T20:34:57Z", "path": "src/main/java/org/junitpioneer/jupiter/ReportEntryExtension.java", "diffHunk": "@@ -16,33 +16,78 @@\n import static org.junitpioneer.jupiter.ReportEntry.PublishCondition.ON_FAILURE;\n import static org.junitpioneer.jupiter.ReportEntry.PublishCondition.ON_SUCCESS;\n \n+import java.lang.reflect.Method;\n import java.util.Arrays;\n+import java.util.List;\n import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n import java.util.stream.Stream;\n \n import org.junit.jupiter.api.extension.BeforeEachCallback;\n import org.junit.jupiter.api.extension.ExtensionConfigurationException;\n import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.api.extension.InvocationInterceptor;\n+import org.junit.jupiter.api.extension.ReflectiveInvocationContext;\n import org.junit.jupiter.api.extension.TestWatcher;\n \n-class ReportEntryExtension implements TestWatcher, BeforeEachCallback {\n+class ReportEntryExtension implements TestWatcher, BeforeEachCallback, InvocationInterceptor {\n+\n+\tprivate static final ExtensionContext.Namespace NAMESPACE = ExtensionContext.Namespace\n+\t\t\t.create(ReportEntryExtension.class);\n+\n+\tprivate static final String KEY = \"ReportEntry\";\n \n \t@Override\n \tpublic void beforeEach(ExtensionContext context) {\n-\t\tfindAnnotations(context).forEach(ReportEntryExtension::verifyKeyValueAreNotBlank);\n+\t\tfindAnnotations(context).forEach(entry -> verifyReportEntry(context, entry));\n \t}\n \n \tprivate Stream<ReportEntry> findAnnotations(ExtensionContext context) {\n \t\treturn PioneerAnnotationUtils.findAllEnclosingRepeatableAnnotations(context, ReportEntry.class);\n \t}\n \n+\tprivate static void verifyReportEntry(ExtensionContext context, ReportEntry entry) {\n+\t\tverifyParameterCount(context, entry);\n+\t\tverifyKeyValueAreNotBlank(entry);\n+\t\tverifyKeyNotParameterized(entry);\n+\t}\n+\n+\tprivate static void verifyParameterCount(ExtensionContext context, ReportEntry entry) {\n+\t\tboolean valueReferencesNumberedParameter = entry.value().matches(\".*\\\\{[0-9]+}.*\");", "originalCommit": "690ddcc1cf53d65acad1e60cc4f08582fad9a537", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkzODI1NA==", "url": "https://github.com/junit-pioneer/junit-pioneer/pull/294#discussion_r463938254", "bodyText": "Agree, extracted and slightly refactored.", "author": "Michael1993", "createdAt": "2020-08-01T08:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2MTgxMg=="}], "type": "inlineReview"}, {"oid": "fe17c3cc4be4c5b739dfb600b510d4b373d7c24c", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/fe17c3cc4be4c5b739dfb600b510d4b373d7c24c", "message": "Small changes following feedback\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-07-29T12:42:41Z", "type": "commit"}, {"oid": "e4af654b97a678767f310282682063c6bf1aecf5", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/e4af654b97a678767f310282682063c6bf1aecf5", "message": "Merge branch 'master' into issue/179-report-entry-improvement\n\n# Conflicts:\n#\tREADME.md\n#\tdocs/report-entries.adoc", "committedDate": "2020-08-05T12:40:55Z", "type": "commit"}, {"oid": "736ff8f2103d9644d94d47997a73b2c2b0be4fc3", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/736ff8f2103d9644d94d47997a73b2c2b0be4fc3", "message": "Fix tests\n\nSigned-off-by: Mihaly Verhas <misi.verhas@gmail.com>", "committedDate": "2020-08-05T21:49:50Z", "type": "commit"}, {"oid": "6afcb6cc85e8485cbd958ec977efdec1821a7b20", "url": "https://github.com/junit-pioneer/junit-pioneer/commit/6afcb6cc85e8485cbd958ec977efdec1821a7b20", "message": "Mention `MessageFormat`", "committedDate": "2020-09-26T09:18:33Z", "type": "commit"}]}