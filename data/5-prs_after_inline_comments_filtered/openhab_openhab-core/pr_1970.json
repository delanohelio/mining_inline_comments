{"pr_number": 1970, "pr_title": "[automation] Added ItemStateUpdate action", "pr_createdAt": "2020-12-20T11:01:09Z", "pr_url": "https://github.com/openhab/openhab-core/pull/1970", "timeline": [{"oid": "9263a9c205411afdeb2f5b66b175a966441ccef4", "url": "https://github.com/openhab/openhab-core/commit/9263a9c205411afdeb2f5b66b175a966441ccef4", "message": "Added ItemUpdate action\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-20T10:59:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2MDkzMQ==", "url": "https://github.com/openhab/openhab-core/pull/1970#discussion_r546360931", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This is an implementation of an ActionHandler. It send state updates for items.\n          \n          \n            \n             * This is an implementation of an ActionHandler. It sends state updates for items.", "author": "kaikreuzer", "createdAt": "2020-12-20T11:06:26Z", "path": "bundles/org.openhab.core.automation/src/main/java/org/openhab/core/automation/internal/module/handler/ItemUpdateActionHandler.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.automation.internal.module.handler;\n+\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.automation.Action;\n+import org.openhab.core.automation.handler.BaseActionModuleHandler;\n+import org.openhab.core.config.core.Configuration;\n+import org.openhab.core.events.EventPublisher;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemNotFoundException;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.events.ItemEventFactory;\n+import org.openhab.core.items.events.ItemStateEvent;\n+import org.openhab.core.types.State;\n+import org.openhab.core.types.TypeParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is an implementation of an ActionHandler. It send state updates for items.", "originalCommit": "9263a9c205411afdeb2f5b66b175a966441ccef4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2MTM2MQ==", "url": "https://github.com/openhab/openhab-core/pull/1970#discussion_r546361361", "bodyText": "We have ItemStateEvents for this and we generally refer to ItemStateUpdates in order to distinguish them from ItemUpdates (i.e. changes to the item itself). I'd hence prefer to also keep it here this way and name this core.ItemStateUpdateAction.", "author": "kaikreuzer", "createdAt": "2020-12-20T11:10:03Z", "path": "bundles/org.openhab.core.automation/src/main/java/org/openhab/core/automation/internal/module/handler/ItemUpdateActionHandler.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.automation.internal.module.handler;\n+\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.automation.Action;\n+import org.openhab.core.automation.handler.BaseActionModuleHandler;\n+import org.openhab.core.config.core.Configuration;\n+import org.openhab.core.events.EventPublisher;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemNotFoundException;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.events.ItemEventFactory;\n+import org.openhab.core.items.events.ItemStateEvent;\n+import org.openhab.core.types.State;\n+import org.openhab.core.types.TypeParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is an implementation of an ActionHandler. It send state updates for items.\n+ *\n+ * @author Christoph Weitkamp - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ItemUpdateActionHandler extends BaseActionModuleHandler {\n+\n+    public static final String ITEM_UPDATE_ACTION = \"core.ItemUpdateAction\";", "originalCommit": "9263a9c205411afdeb2f5b66b175a966441ccef4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2MTY0OA==", "url": "https://github.com/openhab/openhab-core/pull/1970#discussion_r546361648", "bodyText": "The ItemCommandActionHandler does this check only within execute, but not within the constructor. I think that's the much better approach, because the item might not be defined at rule definition time, while this should not cause the rule to not initialize.", "author": "kaikreuzer", "createdAt": "2020-12-20T11:12:46Z", "path": "bundles/org.openhab.core.automation/src/main/java/org/openhab/core/automation/internal/module/handler/ItemUpdateActionHandler.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.automation.internal.module.handler;\n+\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.automation.Action;\n+import org.openhab.core.automation.handler.BaseActionModuleHandler;\n+import org.openhab.core.config.core.Configuration;\n+import org.openhab.core.events.EventPublisher;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemNotFoundException;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.events.ItemEventFactory;\n+import org.openhab.core.items.events.ItemStateEvent;\n+import org.openhab.core.types.State;\n+import org.openhab.core.types.TypeParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is an implementation of an ActionHandler. It send state updates for items.\n+ *\n+ * @author Christoph Weitkamp - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ItemUpdateActionHandler extends BaseActionModuleHandler {\n+\n+    public static final String ITEM_UPDATE_ACTION = \"core.ItemUpdateAction\";\n+    public static final String ITEM_NAME = \"itemName\";\n+    public static final String STATE = \"state\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(ItemUpdateActionHandler.class);\n+\n+    private final EventPublisher eventPublisher;\n+\n+    private final Item item;\n+    private final @Nullable State state;\n+\n+    /**\n+     * constructs a new ItemCommandActionHandler\n+     *\n+     * @param module\n+     * @param moduleTypes\n+     */\n+    public ItemUpdateActionHandler(Action module, EventPublisher eventPublisher, ItemRegistry itemRegistry) {\n+        super(module);\n+\n+        this.eventPublisher = eventPublisher;\n+\n+        final Configuration config = module.getConfiguration();\n+\n+        final String itemName = (String) config.get(ITEM_NAME);\n+        try {\n+            this.item = itemRegistry.getItem(itemName);\n+        } catch (ItemNotFoundException e) {", "originalCommit": "9263a9c205411afdeb2f5b66b175a966441ccef4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2MTkwMg==", "url": "https://github.com/openhab/openhab-core/pull/1970#discussion_r546361902", "bodyText": "The item should not be cached here as it can potentially change over time. Get the latest item in execute instead.", "author": "kaikreuzer", "createdAt": "2020-12-20T11:15:00Z", "path": "bundles/org.openhab.core.automation/src/main/java/org/openhab/core/automation/internal/module/handler/ItemUpdateActionHandler.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.automation.internal.module.handler;\n+\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.automation.Action;\n+import org.openhab.core.automation.handler.BaseActionModuleHandler;\n+import org.openhab.core.config.core.Configuration;\n+import org.openhab.core.events.EventPublisher;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemNotFoundException;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.events.ItemEventFactory;\n+import org.openhab.core.items.events.ItemStateEvent;\n+import org.openhab.core.types.State;\n+import org.openhab.core.types.TypeParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is an implementation of an ActionHandler. It send state updates for items.\n+ *\n+ * @author Christoph Weitkamp - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ItemUpdateActionHandler extends BaseActionModuleHandler {\n+\n+    public static final String ITEM_UPDATE_ACTION = \"core.ItemUpdateAction\";\n+    public static final String ITEM_NAME = \"itemName\";\n+    public static final String STATE = \"state\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(ItemUpdateActionHandler.class);\n+\n+    private final EventPublisher eventPublisher;\n+\n+    private final Item item;", "originalCommit": "9263a9c205411afdeb2f5b66b175a966441ccef4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13d7f31cc5089ce1d6d2b84ebccba4281b222771", "url": "https://github.com/openhab/openhab-core/commit/13d7f31cc5089ce1d6d2b84ebccba4281b222771", "message": "Incorporated comments from review\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-20T11:33:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2NTI1Mw==", "url": "https://github.com/openhab/openhab-core/pull/1970#discussion_r546365253", "bodyText": "Looking closer into the code, I am not 100% certain that the module configuration cannot be changed during the lifetime of the handler. I at least found ConfigurationNormalizer.normalizeConfiguration, which reads the configuration object and modifies it. I'd hence feel safer if this would be re-read in execute, just as it is done for the ItemCommandActionHandler.", "author": "kaikreuzer", "createdAt": "2020-12-20T11:44:50Z", "path": "bundles/org.openhab.core.automation/src/main/java/org/openhab/core/automation/internal/module/handler/ItemStateUpdateActionHandler.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.automation.internal.module.handler;\n+\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.automation.Action;\n+import org.openhab.core.automation.handler.BaseActionModuleHandler;\n+import org.openhab.core.config.core.Configuration;\n+import org.openhab.core.events.EventPublisher;\n+import org.openhab.core.items.Item;\n+import org.openhab.core.items.ItemNotFoundException;\n+import org.openhab.core.items.ItemRegistry;\n+import org.openhab.core.items.events.ItemEventFactory;\n+import org.openhab.core.items.events.ItemStateEvent;\n+import org.openhab.core.types.State;\n+import org.openhab.core.types.TypeParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is an implementation of an ActionHandler. It sends state updates for items.\n+ *\n+ * @author Christoph Weitkamp - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ItemStateUpdateActionHandler extends BaseActionModuleHandler {\n+\n+    public static final String ITEM_STATE_UPDATE_ACTION = \"core.ItemStateUpdateAction\";\n+    public static final String ITEM_NAME = \"itemName\";\n+    public static final String STATE = \"state\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(ItemStateUpdateActionHandler.class);\n+\n+    private final EventPublisher eventPublisher;\n+    private final ItemRegistry itemRegistry;\n+\n+    private final String itemName;\n+    private final String state;\n+\n+    public ItemStateUpdateActionHandler(Action module, EventPublisher eventPublisher, ItemRegistry itemRegistry) {\n+        super(module);\n+\n+        this.eventPublisher = eventPublisher;\n+        this.itemRegistry = itemRegistry;\n+\n+        final Configuration config = module.getConfiguration();", "originalCommit": "13d7f31cc5089ce1d6d2b84ebccba4281b222771", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM3MzAwNA==", "url": "https://github.com/openhab/openhab-core/pull/1970#discussion_r546373004", "bodyText": "I applied these suggestions. But I have to investigate later on that because IIRC I contributed other automation modules doing it in the same way.", "author": "cweitkamp", "createdAt": "2020-12-20T12:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2NTI1Mw=="}], "type": "inlineReview"}, {"oid": "f0e67e542d84a948001ad445e88a2aee35af6f38", "url": "https://github.com/openhab/openhab-core/commit/f0e67e542d84a948001ad445e88a2aee35af6f38", "message": "Incorporated comments from review\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-20T12:49:14Z", "type": "commit"}]}