{"pr_number": 1451, "pr_title": "Replaced \"classic\" rule engine by a DSLRuleProvider for the NGRE", "pr_createdAt": "2020-04-28T20:55:55Z", "pr_url": "https://github.com/openhab/openhab-core/pull/1451", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE1MDI1NQ==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r417150255", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This is a ModuleHandler implementation for Triggers which trigger the rule if a certain system events occurs.\n          \n          \n            \n             * This is a ModuleHandler implementation for Triggers which trigger the rule if a certain system event occurs.", "author": "ghys", "createdAt": "2020-04-29T08:31:11Z", "path": "bundles/org.openhab.core.automation/src/main/java/org/openhab/core/automation/internal/module/handler/SystemTriggerHandler.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.automation.internal.module.handler;\n+\n+import java.math.BigDecimal;\n+import java.util.Collections;\n+import java.util.Dictionary;\n+import java.util.HashMap;\n+import java.util.Hashtable;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.automation.ModuleHandlerCallback;\n+import org.openhab.core.automation.Trigger;\n+import org.openhab.core.automation.handler.BaseTriggerModuleHandler;\n+import org.openhab.core.automation.handler.TriggerHandlerCallback;\n+import org.openhab.core.events.Event;\n+import org.openhab.core.events.EventFilter;\n+import org.openhab.core.events.EventSubscriber;\n+import org.openhab.core.events.system.StartlevelEvent;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.ServiceRegistration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This is a ModuleHandler implementation for Triggers which trigger the rule if a certain system events occurs.", "originalCommit": "90324e733ec2ec703a8ed79931d012b60595241a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "97ddc118b378ca9e5870d53d8e697c53fce6fd8d", "url": "https://github.com/openhab/openhab-core/commit/97ddc118b378ca9e5870d53d8e697c53fce6fd8d", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-04-29T16:51:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc5MjQ5Nw==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r417792497", "bodyText": "This doesn't work on Windows, you'll want to add this as well:\n        if (s.startsWith(\"\\r\\n\")) {\n            s = s.substring(2);\n        }\nMaybe also add a final newline if it doesn't exist (that would make the YAML multiline control a simple | instead of |-)", "author": "ghys", "createdAt": "2020-04-30T06:53:30Z", "path": "bundles/org.openhab.core.model.rule.runtime/src/org/openhab/core/model/rule/runtime/internal/DSLRuleProvider.java", "diffHunk": "@@ -264,14 +265,26 @@ private Rule toRule(String modelName, boolean hasContext, org.openhab.core.model\n         XBlockExpression expression = rule.getScript();\n         String script = NodeModelUtils.findActualNodeFor(expression).getText();\n         Configuration cfg = new Configuration();\n-        cfg.put(\"script\", context + script);\n+        cfg.put(\"script\", context + removeIndentation(script));\n         cfg.put(\"type\", MIMETYPE_OPENHAB_DSL_RULE);\n         List<Action> actions = Collections.singletonList(ActionBuilder.create().withId(\"script\")\n                 .withTypeUID(\"script.ScriptAction\").withConfiguration(cfg).build());\n \n         return RuleBuilder.create(uid).withName(name).withTriggers(triggers).withActions(actions).build();\n     }\n \n+    private String removeIndentation(String script) {\n+        String s = script;\n+        if (s.startsWith(\"\\n\")) {\n+            s = s.substring(1);\n+        }", "originalCommit": "d73757d0d2ea5ba9b4c7502f5fb9bbee6b91e5eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0NTA1NA==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r418245054", "bodyText": "These Windows users ;-)\nDone!", "author": "kaikreuzer", "createdAt": "2020-04-30T19:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc5MjQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3NTg1MQ==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r418975851", "bodyText": "Isn't that supposed to be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    enrichedRuleDto.editable = managedRuleProvider.get(enrichedRuleDto.name) != null;\n          \n          \n            \n                    enrichedRuleDto.editable = managedRuleProvider.get(enrichedRuleDto.uid) != null;", "author": "ghys", "createdAt": "2020-05-02T16:04:50Z", "path": "bundles/org.openhab.core.automation.rest/src/main/java/org/openhab/core/automation/rest/internal/dto/EnrichedRuleDTOMapper.java", "diffHunk": "@@ -20,13 +21,16 @@\n  * This is a utility class to convert between the respective object and its DTO.\n  *\n  * @author Markus Rathgeb - Initial contribution\n+ * @author Kai Kreuzer - added editable field\n  */\n public class EnrichedRuleDTOMapper extends RuleDTOMapper {\n \n-    public static EnrichedRuleDTO map(final Rule rule, final RuleManager ruleEngine) {\n+    public static EnrichedRuleDTO map(final Rule rule, final RuleManager ruleEngine,\n+            final ManagedRuleProvider managedRuleProvider) {\n         final EnrichedRuleDTO enrichedRuleDto = new EnrichedRuleDTO();\n         fillProperties(rule, enrichedRuleDto);\n         enrichedRuleDto.status = ruleEngine.getStatusInfo(rule.getUID());\n+        enrichedRuleDto.editable = managedRuleProvider.get(enrichedRuleDto.name) != null;", "originalCommit": "857ada833862af0c5dac5525d45ffa3390f7fbda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk4MTQyMw==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r418981423", "bodyText": "I should have tested it myself, sorry. Fixed it.", "author": "kaikreuzer", "createdAt": "2020-05-02T16:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3NTg1MQ=="}], "type": "inlineReview"}, {"oid": "076edb33fb4f67f37fd107a689796f06f2d614b5", "url": "https://github.com/openhab/openhab-core/commit/076edb33fb4f67f37fd107a689796f06f2d614b5", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-05-15T19:54:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzNjA5OA==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r426136098", "bodyText": "By the way @kaikreuzer, have you noticed the \"o\" gets capitalized between here and the UI? I don't think it's done client-side, so not sure where it happens.", "author": "ghys", "createdAt": "2020-05-16T09:16:30Z", "path": "bundles/org.openhab.core.model.script.runtime/src/org/openhab/core/model/script/runtime/internal/engine/DSLScriptEngine.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.model.script.runtime.internal.engine;\n+\n+import java.io.Reader;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.script.Bindings;\n+import javax.script.ScriptContext;\n+import javax.script.ScriptEngine;\n+import javax.script.ScriptEngineFactory;\n+import javax.script.ScriptException;\n+import javax.script.SimpleScriptContext;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.xtext.naming.QualifiedName;\n+import org.eclipse.xtext.xbase.XExpression;\n+import org.eclipse.xtext.xbase.interpreter.IEvaluationContext;\n+import org.eclipse.xtext.xbase.interpreter.impl.DefaultEvaluationContext;\n+import org.openhab.core.model.script.engine.ScriptExecutionException;\n+import org.openhab.core.model.script.engine.ScriptParsingException;\n+import org.openhab.core.model.script.runtime.DSLScriptContextProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * A basic implementation of the {@link javax.script.ScriptEngine} interface for using DSL scripts\n+ * within a jsr223 scripting context in Java.\n+ * Most methods are left empty, because they aren't used in our rule engine.\n+ * The most important methods are the ones that return metadata about the script engine factory.\n+ *\n+ * Note: This class is not marked as NonNullByDefault as almost all parameters of all methods are\n+ * nullable as the interface is declared without null annotations.\n+ *\n+ * @author Kai Kreuzer - Initial contribution\n+ */\n+public class DSLScriptEngine implements javax.script.ScriptEngine {\n+\n+    public static final String MIMETYPE_OPENHAB_DSL_RULE = \"application/vnd.openhab.dsl.rule\";\n+\n+    private static final Map<String, String> implicitVars = Map.of(\"command\", \"receivedCommand\", \"event\",\n+            \"receivedEvent\", \"newState\", \"newState\", \"oldState\", \"previousState\", \"triggeringItem\", \"triggeringItem\");\n+\n+    private final Logger logger = LoggerFactory.getLogger(DSLScriptEngine.class);\n+\n+    private final org.openhab.core.model.script.engine.ScriptEngine scriptEngine;\n+    private final @Nullable DSLScriptContextProvider contextProvider;\n+    private final ScriptContext context = new SimpleScriptContext();\n+\n+    public DSLScriptEngine(org.openhab.core.model.script.engine.ScriptEngine scriptEngine,\n+            @Nullable DSLScriptContextProvider contextProvider) {\n+        this.scriptEngine = scriptEngine;\n+        this.contextProvider = contextProvider;\n+    }\n+\n+    @Override\n+    public Object eval(String script, ScriptContext context) throws ScriptException {\n+        return null;\n+    }\n+\n+    @Override\n+    public Object eval(Reader reader, ScriptContext context) throws ScriptException {\n+        return null;\n+    }\n+\n+    @Override\n+    public Object eval(String script) throws ScriptException {\n+        String modelName = null;\n+        try {\n+            IEvaluationContext specificContext = null;\n+            org.openhab.core.model.script.engine.Script s = null;\n+            if (script.stripLeading().startsWith(DSLScriptContextProvider.CONTEXT_IDENTIFIER)) {\n+                String contextString = script.stripLeading().substring(\n+                        DSLScriptContextProvider.CONTEXT_IDENTIFIER.length(), script.stripLeading().indexOf('\\n'));\n+                String[] segments = contextString.split(\"-\");\n+                if (segments.length == 2) {\n+                    modelName = segments[0];\n+                    String ruleIndex = segments[1];\n+                    if (contextProvider != null) {\n+                        DSLScriptContextProvider cp = contextProvider;\n+                        logger.debug(\"Script uses context '{}'.\", contextString);\n+                        specificContext = cp.getContext(modelName);\n+                        XExpression xExpression = cp.getParsedScript(modelName, ruleIndex);\n+                        s = scriptEngine.newScriptFromXExpression(xExpression);\n+                    } else {\n+                        logger.error(\"Script references context '{}', but no context provider is registered!\",\n+                                contextString);\n+                        return null;\n+                    }\n+                } else {\n+                    logger.error(\"Script has an invalid context reference '{}'!\", contextString);\n+                    return null;\n+                }\n+            } else {\n+                s = scriptEngine.newScriptFromString(script);\n+            }\n+            IEvaluationContext evalContext = createEvaluationContext(specificContext);\n+            s.execute(evalContext);\n+        } catch (ScriptExecutionException | ScriptParsingException e) {\n+            throw new ScriptException(e.getMessage(), modelName, -1);\n+        }\n+        return null;\n+    }\n+\n+    private DefaultEvaluationContext createEvaluationContext(IEvaluationContext specificContext) {\n+        DefaultEvaluationContext evalContext = new DefaultEvaluationContext(specificContext);\n+        for (Map.Entry<String, String> entry : implicitVars.entrySet()) {\n+            Object value = context.getAttribute(entry.getKey());\n+            if (value != null) {\n+                evalContext.newValue(QualifiedName.create(entry.getValue()), value);\n+            }\n+        }\n+        return evalContext;\n+    }\n+\n+    @Override\n+    public Object eval(Reader reader) throws ScriptException {\n+        return null;\n+    }\n+\n+    @Override\n+    public Object eval(String script, Bindings n) throws ScriptException {\n+        return null;\n+    }\n+\n+    @Override\n+    public Object eval(Reader reader, Bindings n) throws ScriptException {\n+        return null;\n+    }\n+\n+    @Override\n+    public void put(String key, Object value) {\n+\n+    }\n+\n+    @Override\n+    public Object get(String key) {\n+        return null;\n+    }\n+\n+    @Override\n+    public Bindings getBindings(int scope) {\n+        return null;\n+    }\n+\n+    @Override\n+    public void setBindings(Bindings bindings, int scope) {\n+    }\n+\n+    @Override\n+    public Bindings createBindings() {\n+        return null;\n+    }\n+\n+    @Override\n+    public ScriptContext getContext() {\n+        return context;\n+    }\n+\n+    @Override\n+    public void setContext(ScriptContext context) {\n+\n+    }\n+\n+    @Override\n+    public ScriptEngineFactory getFactory() {\n+        return new ScriptEngineFactory() {\n+\n+            @Override\n+            public ScriptEngine getScriptEngine() {\n+                return null;\n+            }\n+\n+            @Override\n+            public String getProgram(String... statements) {\n+                return null;\n+            }\n+\n+            @Override\n+            public Object getParameter(String key) {\n+                return null;\n+            }\n+\n+            @Override\n+            public String getOutputStatement(String toDisplay) {\n+                return null;\n+            }\n+\n+            @Override\n+            public List<String> getNames() {\n+                return null;\n+            }\n+\n+            @Override\n+            public List<String> getMimeTypes() {\n+                return Collections.singletonList(MIMETYPE_OPENHAB_DSL_RULE);\n+            }\n+\n+            @Override\n+            public String getMethodCallSyntax(String obj, String m, String... args) {\n+                return null;\n+            }\n+\n+            @Override\n+            public String getLanguageVersion() {\n+                return \"v1\";\n+            }\n+\n+            @Override\n+            public String getLanguageName() {\n+                return \"openHAB Rule DSL\";", "originalCommit": "0471d124038fc2a05ea18136872dfaea302bab08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMDI1NA==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r428320254", "bodyText": "Yes, I had noticed this as well. I assume it must be the javax.script implementation that capitalizes it. I've now simply changed the name to \"Rule DSL\", so we don't have to bother anymore ;-)", "author": "kaikreuzer", "createdAt": "2020-05-20T21:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzNjA5OA=="}], "type": "inlineReview"}, {"oid": "682ac0dfc023af74a66d87d63bc149168f720d63", "url": "https://github.com/openhab/openhab-core/commit/682ac0dfc023af74a66d87d63bc149168f720d63", "message": "changed script name\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-05-20T21:26:05Z", "type": "forcePushed"}, {"oid": "f817b534dd398bc2dfa547a8f53730e131a27fcd", "url": "https://github.com/openhab/openhab-core/commit/f817b534dd398bc2dfa547a8f53730e131a27fcd", "message": "some small fixes\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-05-24T18:48:48Z", "type": "forcePushed"}, {"oid": "eb356757d3f458b86ee71876449904267863b2ff", "url": "https://github.com/openhab/openhab-core/commit/eb356757d3f458b86ee71876449904267863b2ff", "message": "optimized rule refresher and other improvements\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-05-31T22:25:59Z", "type": "forcePushed"}, {"oid": "493e81e0b5941064248bd0d737a75b07b574b4a1", "url": "https://github.com/openhab/openhab-core/commit/493e81e0b5941064248bd0d737a75b07b574b4a1", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-06T23:15:39Z", "type": "forcePushed"}, {"oid": "379ebac59c4efc7267466e7d13448084d6e538e2", "url": "https://github.com/openhab/openhab-core/commit/379ebac59c4efc7267466e7d13448084d6e538e2", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-06T23:26:15Z", "type": "forcePushed"}, {"oid": "1649382c837657688c5e16211ad14c5249459de4", "url": "https://github.com/openhab/openhab-core/commit/1649382c837657688c5e16211ad14c5249459de4", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-06T23:41:23Z", "type": "forcePushed"}, {"oid": "41df022e3b5f584f98dc7d305ef1c657e994d293", "url": "https://github.com/openhab/openhab-core/commit/41df022e3b5f584f98dc7d305ef1c657e994d293", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-07T00:17:04Z", "type": "forcePushed"}, {"oid": "95af1edb4195cc1ded25eb03ef84c1459bc5b804", "url": "https://github.com/openhab/openhab-core/commit/95af1edb4195cc1ded25eb03ef84c1459bc5b804", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-07T21:12:30Z", "type": "forcePushed"}, {"oid": "02fdb34c404f34710dc78cf2f7914e36a2f52d19", "url": "https://github.com/openhab/openhab-core/commit/02fdb34c404f34710dc78cf2f7914e36a2f52d19", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-07T21:52:28Z", "type": "forcePushed"}, {"oid": "c10d13bb9d02f3a090a17b4625acb601ae6869e9", "url": "https://github.com/openhab/openhab-core/commit/c10d13bb9d02f3a090a17b4625acb601ae6869e9", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-07T22:07:17Z", "type": "commit"}, {"oid": "c10d13bb9d02f3a090a17b4625acb601ae6869e9", "url": "https://github.com/openhab/openhab-core/commit/c10d13bb9d02f3a090a17b4625acb601ae6869e9", "message": "Replaced rule engine by DSLRuleProvider for NGRE\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-07T22:07:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNDA2Ng==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r439724066", "bodyText": "Can you inject these fields using constructor injection instead? That allows for making them final and also makes it easier to write unit tests for this class without having to resort to reflection tricks.", "author": "wborn", "createdAt": "2020-06-13T09:17:16Z", "path": "bundles/org.openhab.core.model.rule.runtime/src/org/openhab/core/model/rule/runtime/internal/DSLRuleProvider.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.model.rule.runtime.internal;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.eclipse.emf.ecore.EObject;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.xtext.nodemodel.util.NodeModelUtils;\n+import org.eclipse.xtext.xbase.XBlockExpression;\n+import org.eclipse.xtext.xbase.XExpression;\n+import org.eclipse.xtext.xbase.interpreter.IEvaluationContext;\n+import org.openhab.core.automation.Action;\n+import org.openhab.core.automation.Rule;\n+import org.openhab.core.automation.RuleProvider;\n+import org.openhab.core.automation.Trigger;\n+import org.openhab.core.automation.util.ActionBuilder;\n+import org.openhab.core.automation.util.RuleBuilder;\n+import org.openhab.core.automation.util.TriggerBuilder;\n+import org.openhab.core.common.registry.ProviderChangeListener;\n+import org.openhab.core.config.core.Configuration;\n+import org.openhab.core.model.core.EventType;\n+import org.openhab.core.model.core.ModelRepository;\n+import org.openhab.core.model.core.ModelRepositoryChangeListener;\n+import org.openhab.core.model.rule.jvmmodel.RulesRefresher;\n+import org.openhab.core.model.rule.rules.ChangedEventTrigger;\n+import org.openhab.core.model.rule.rules.CommandEventTrigger;\n+import org.openhab.core.model.rule.rules.EventEmittedTrigger;\n+import org.openhab.core.model.rule.rules.EventTrigger;\n+import org.openhab.core.model.rule.rules.GroupMemberChangedEventTrigger;\n+import org.openhab.core.model.rule.rules.GroupMemberCommandEventTrigger;\n+import org.openhab.core.model.rule.rules.GroupMemberUpdateEventTrigger;\n+import org.openhab.core.model.rule.rules.RuleModel;\n+import org.openhab.core.model.rule.rules.SystemOnShutdownTrigger;\n+import org.openhab.core.model.rule.rules.SystemOnStartupTrigger;\n+import org.openhab.core.model.rule.rules.ThingStateChangedEventTrigger;\n+import org.openhab.core.model.rule.rules.ThingStateUpdateEventTrigger;\n+import org.openhab.core.model.rule.rules.TimerTrigger;\n+import org.openhab.core.model.rule.rules.UpdateEventTrigger;\n+import org.openhab.core.model.script.runtime.DSLScriptContextProvider;\n+import org.openhab.core.service.ReadyMarker;\n+import org.openhab.core.service.ReadyMarkerFilter;\n+import org.openhab.core.service.ReadyService;\n+import org.openhab.core.service.ReadyService.ReadyTracker;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This RuleProvider provides rules that are defined in DSL rule files.\n+ * All rules consist out of a list of triggers and a single script action.\n+ * No rule conditions are used as this concept does not exist for DSL rules.\n+ *\n+ * @author Kai Kreuzer - Initial contribution\n+ */\n+@NonNullByDefault\n+@Component(immediate = true, service = { DSLRuleProvider.class, RuleProvider.class, DSLScriptContextProvider.class })\n+public class DSLRuleProvider\n+        implements RuleProvider, ModelRepositoryChangeListener, DSLScriptContextProvider, ReadyTracker {\n+\n+    private static final String RULES_MODEL_NAME = \"rules\";\n+    private static final String ITEMS_MODEL_NAME = \"items\";\n+    private static final String THINGS_MODEL_NAME = \"things\";\n+    static final String MIMETYPE_OPENHAB_DSL_RULE = \"application/vnd.openhab.dsl.rule\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(DSLRuleProvider.class);\n+    private final Collection<ProviderChangeListener<Rule>> listeners = new ArrayList<>();\n+    private final Map<String, Rule> rules = new HashMap<>();\n+    private final Map<String, IEvaluationContext> contexts = new HashMap<>();\n+    private final Map<String, XExpression> xExpressions = new HashMap<>();\n+    private int triggerId = 0;\n+    private Set<String> markers = new HashSet<>();\n+\n+    @Reference\n+    private @NonNullByDefault({}) ModelRepository modelRepository;\n+\n+    @Reference\n+    private @NonNullByDefault({}) ReadyService readyService;", "originalCommit": "c10d13bb9d02f3a090a17b4625acb601ae6869e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNDgwNw==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r439724807", "bodyText": "Personally I never use @Reference on fields because it complicates writing unit tests or perhaps you know an easy way to inject these fields in tests?", "author": "wborn", "createdAt": "2020-06-13T09:29:14Z", "path": "bundles/org.openhab.core.model.rule/src/org/openhab/core/model/rule/jvmmodel/RulesRefresher.java", "diffHunk": "@@ -29,51 +49,133 @@\n  * @author Kai Kreuzer - added delayed execution\n  * @author Maoliang Huang - refactor\n  */\n-public class RulesRefresher {\n+@Component(immediate = true, service = {})\n+public class RulesRefresher implements ReadyTracker {\n \n-    // delay before rule resources are refreshed after items or services have changed\n-    private static final long REFRESH_DELAY = 2000;\n+    // delay in ms before rule resources are refreshed after items or services have changed\n+    private static final long REFRESH_DELAY = 5000;\n+\n+    private static final String POOL_NAME = \"automation\";\n+    public static final String RULES_REFRESH = \"rules_refresh\";\n \n     private final Logger logger = LoggerFactory.getLogger(RulesRefresher.class);\n \n-    ModelRepository modelRepository;\n-    private ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor();\n     private ScheduledFuture<?> job;\n+    private ScheduledExecutorService scheduler = ThreadPoolManager.getScheduledPool(POOL_NAME);\n+    private boolean started;\n+    private ReadyMarker marker = new ReadyMarker(\"dsl\", RULES_REFRESH);\n \n-    public void setModelRepository(ModelRepository modelRepository) {\n-        this.modelRepository = modelRepository;\n-    }\n+    private ItemRegistryChangeListener itemRegistryChangeListener;\n+    private ThingRegistryChangeListener thingRegistryChangeListener;\n+\n+    @Reference\n+    protected ModelRepository modelRepository;\n+\n+    @Reference\n+    protected ItemRegistry itemRegistry;\n+\n+    @Reference\n+    protected ThingRegistry thingRegistry;\n \n-    public void unsetModelRepository(ModelRepository modelRepository) {\n-        this.modelRepository = null;\n+    @Reference\n+    protected EventPublisher eventPublisher;\n+\n+    @Reference\n+    protected ReadyService readyService;", "originalCommit": "c10d13bb9d02f3a090a17b4625acb601ae6869e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNDk2MQ==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r439724961", "bodyText": "Can this TODO be done in this PR?", "author": "wborn", "createdAt": "2020-06-13T09:31:31Z", "path": "bundles/org.openhab.core.model.rule/src/org/openhab/core/model/rule/jvmmodel/RulesRefresher.java", "diffHunk": "@@ -29,51 +49,133 @@\n  * @author Kai Kreuzer - added delayed execution\n  * @author Maoliang Huang - refactor\n  */\n-public class RulesRefresher {\n+@Component(immediate = true, service = {})\n+public class RulesRefresher implements ReadyTracker {\n \n-    // delay before rule resources are refreshed after items or services have changed\n-    private static final long REFRESH_DELAY = 2000;\n+    // delay in ms before rule resources are refreshed after items or services have changed\n+    private static final long REFRESH_DELAY = 5000;\n+\n+    private static final String POOL_NAME = \"automation\";\n+    public static final String RULES_REFRESH = \"rules_refresh\";\n \n     private final Logger logger = LoggerFactory.getLogger(RulesRefresher.class);\n \n-    ModelRepository modelRepository;\n-    private ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor();\n     private ScheduledFuture<?> job;\n+    private ScheduledExecutorService scheduler = ThreadPoolManager.getScheduledPool(POOL_NAME);\n+    private boolean started;\n+    private ReadyMarker marker = new ReadyMarker(\"dsl\", RULES_REFRESH);\n \n-    public void setModelRepository(ModelRepository modelRepository) {\n-        this.modelRepository = modelRepository;\n-    }\n+    private ItemRegistryChangeListener itemRegistryChangeListener;\n+    private ThingRegistryChangeListener thingRegistryChangeListener;\n+\n+    @Reference\n+    protected ModelRepository modelRepository;\n+\n+    @Reference\n+    protected ItemRegistry itemRegistry;\n+\n+    @Reference\n+    protected ThingRegistry thingRegistry;\n \n-    public void unsetModelRepository(ModelRepository modelRepository) {\n-        this.modelRepository = null;\n+    @Reference\n+    protected EventPublisher eventPublisher;\n+\n+    @Reference\n+    protected ReadyService readyService;\n+\n+    @Activate\n+    protected void activate() {\n+        readyService.registerTracker(this, new ReadyMarkerFilter().withType(\"dsl\").withIdentifier(\"rules\"));\n     }\n \n+    @Reference(cardinality = ReferenceCardinality.MULTIPLE, policy = ReferencePolicy.DYNAMIC)\n     protected void addActionService(ActionService actionService) {\n-        scheduleRuleRefresh();\n+        if (started) {\n+            scheduleRuleRefresh();\n+        }\n     }\n \n     protected void removeActionService(ActionService actionService) {\n-        scheduleRuleRefresh();\n+        if (started) {\n+            scheduleRuleRefresh();\n+        }\n     }\n \n     protected synchronized void scheduleRuleRefresh() {\n         if (job != null && !job.isDone()) {\n             job.cancel(false);\n         }\n-        job = scheduler.schedule(runnable, REFRESH_DELAY, TimeUnit.MILLISECONDS);\n-    }\n-\n-    Runnable runnable = new Runnable() {\n-        @Override\n-        public void run() {\n+        job = scheduler.schedule(() -> {\n             try {\n-                if (modelRepository != null) {\n-                    modelRepository.reloadAllModelsOfType(\"rules\");\n-                }\n+                modelRepository.reloadAllModelsOfType(\"rules\");\n             } catch (Exception e) {\n                 logger.debug(\"Exception occurred during execution: {}\", e.getMessage(), e);\n             }\n+            readyService.markReady(marker);\n+        }, REFRESH_DELAY, TimeUnit.MILLISECONDS);\n+        readyService.unmarkReady(marker);\n+    }\n+\n+    private void setStartLevel() {\n+        if (!started) {\n+            started = true;\n+            // TODO: This is still a very dirty hack in the absence of a proper system start level management.", "originalCommit": "c10d13bb9d02f3a090a17b4625acb601ae6869e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2MjU5Nw==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r439762597", "bodyText": "No, definitely not - this is about eclipse-archived/smarthome#1896, which will be a huge new PR in itself.", "author": "kaikreuzer", "createdAt": "2020-06-13T19:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNDk2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNTQ5NQ==", "url": "https://github.com/openhab/openhab-core/pull/1451#discussion_r439725495", "bodyText": "Use constructor injection here instead?", "author": "wborn", "createdAt": "2020-06-13T09:40:53Z", "path": "bundles/org.openhab.core.model.script.runtime/src/org/openhab/core/model/script/runtime/internal/engine/DSLScriptEngineFactory.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.model.script.runtime.internal.engine;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.automation.module.script.ScriptEngineFactory;\n+import org.openhab.core.model.script.engine.ScriptEngine;\n+import org.openhab.core.model.script.runtime.DSLScriptContextProvider;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.osgi.service.component.annotations.ReferenceCardinality;\n+\n+/**\n+ * An implementation of {@link ScriptEngineFactory} for DSL scripts.\n+ *\n+ * @author Kai Kreuzer - Initial contribution\n+ */\n+@NonNullByDefault\n+@Component(service = ScriptEngineFactory.class)\n+public class DSLScriptEngineFactory implements ScriptEngineFactory {\n+\n+    private static final String SCRIPT_TYPE = \"dsl\";\n+\n+    private @NonNullByDefault({}) DSLScriptEngine dslScriptEngine;\n+\n+    @Reference\n+    protected @NonNullByDefault({}) ScriptEngine scriptEngine;", "originalCommit": "c10d13bb9d02f3a090a17b4625acb601ae6869e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "44c627d81fb4d186405846acaf97b1faa87d8b29", "url": "https://github.com/openhab/openhab-core/commit/44c627d81fb4d186405846acaf97b1faa87d8b29", "message": "addressed review comments\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-13T19:32:16Z", "type": "commit"}, {"oid": "44c627d81fb4d186405846acaf97b1faa87d8b29", "url": "https://github.com/openhab/openhab-core/commit/44c627d81fb4d186405846acaf97b1faa87d8b29", "message": "addressed review comments\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-06-13T19:32:16Z", "type": "forcePushed"}]}