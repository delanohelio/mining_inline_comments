{"pr_number": 1617, "pr_title": "Improved add-on installation logic", "pr_createdAt": "2020-09-02T20:12:57Z", "pr_url": "https://github.com/openhab/openhab-core/pull/1617", "timeline": [{"oid": "d968120ed011f31be7a2f75519162d143e6377c7", "url": "https://github.com/openhab/openhab-core/commit/d968120ed011f31be7a2f75519162d143e6377c7", "message": "improved add-on installation logic\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-09-02T20:08:19Z", "type": "commit"}, {"oid": "f36b22558a995874fefaeffba94c43c77b469094", "url": "https://github.com/openhab/openhab-core/commit/f36b22558a995874fefaeffba94c43c77b469094", "message": "enable retry mechanism on failed installs\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>", "committedDate": "2020-09-03T08:38:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg4NjU5MQ==", "url": "https://github.com/openhab/openhab-core/pull/1617#discussion_r482886591", "bodyText": "At the time we use String.strip() it might be better to check for isBlank() here.", "author": "cweitkamp", "createdAt": "2020-09-03T10:50:39Z", "path": "bundles/org.openhab.core.karaf/src/main/java/org/openhab/core/karaf/internal/FeatureInstaller.java", "diffHunk": "@@ -336,15 +339,19 @@ private synchronized void installAddons(final FeaturesService service, final Map\n                     Feature[] features = service.listInstalledFeatures();\n                     for (String addon : entries) {\n                         if (addon != null && !addon.isEmpty()) {", "originalCommit": "f36b22558a995874fefaeffba94c43c77b469094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzNjI0NQ==", "url": "https://github.com/openhab/openhab-core/pull/1617#discussion_r483536245", "bodyText": "It would prevent warnings when there is only whitespace between commas: \"addon1, ,addon2\"", "author": "wborn", "createdAt": "2020-09-04T10:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg4NjU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzODEzNQ==", "url": "https://github.com/openhab/openhab-core/pull/1617#discussion_r483538135", "bodyText": "Though the whitespace would probably cause the new check (service.getFeature(id) != null) to return null \ud83d\ude09", "author": "wborn", "createdAt": "2020-09-04T10:42:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg4NjU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzODU3MA==", "url": "https://github.com/openhab/openhab-core/pull/1617#discussion_r483538570", "bodyText": "But it will still trigger the warning logic:\n                            logger.warn(\"The {} add-on '{}' does not exist - ignoring it.\", type, addon.strip());", "author": "wborn", "createdAt": "2020-09-04T10:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg4NjU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg4NzIxNw==", "url": "https://github.com/openhab/openhab-core/pull/1617#discussion_r482887217", "bodyText": "Should we use the combination of isBlank() / strip() in this loop too?", "author": "cweitkamp", "createdAt": "2020-09-03T10:51:46Z", "path": "bundles/org.openhab.core.karaf/src/main/java/org/openhab/core/karaf/internal/FeatureInstaller.java", "diffHunk": "@@ -336,15 +339,19 @@ private synchronized void installAddons(final FeaturesService service, final Map\n                     Feature[] features = service.listInstalledFeatures();\n                     for (String addon : entries) {\n                         if (addon != null && !addon.isEmpty()) {\n-                            String id = PREFIX + type + \"-\" + addon.trim();\n-                            targetAddons.add(id);\n-                            if (!isInstalled(features, id)) {\n-                                installAddons.add(id);\n+                            String id = PREFIX + type + \"-\" + addon.strip();\n+                            if (service.getFeature(id) != null) {\n+                                targetAddons.add(id);\n+                                if (!isInstalled(features, id)) {\n+                                    installAddons.add(id);\n+                                }\n+                            } else {\n+                                logger.warn(\"The {} add-on '{}' does not exist - ignoring it.\", type, addon.strip());\n                             }\n                         }\n                     }\n \n-                    // we collect all installed addons\n+                    // we collect all installed add-ons\n                     for (String addon : getAllAddonsOfType(service, type)) {\n                         if (addon != null && !addon.isEmpty()) {", "originalCommit": "f36b22558a995874fefaeffba94c43c77b469094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzNTIyNQ==", "url": "https://github.com/openhab/openhab-core/pull/1617#discussion_r483535225", "bodyText": "I think it would be better to move any such checks to getAllAddonsOfType so it doesn't return unusable add-ons.", "author": "wborn", "createdAt": "2020-09-04T10:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg4NzIxNw=="}], "type": "inlineReview"}]}