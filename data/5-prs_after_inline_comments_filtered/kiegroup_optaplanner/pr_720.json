{"pr_number": 720, "pr_title": "[PLANNER-1867] Add JSONB support for Score JSON in optaplanner-persistence-jsonb", "pr_createdAt": "2020-03-16T21:41:15Z", "pr_url": "https://github.com/kiegroup/optaplanner/pull/720", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM2MTg0NA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393361844", "bodyText": "Did you consider using JsonbAdapter? It would bring the serializer and deserializer under one roof, and from what I've seen in this PR, you don't need the advanced access to parser that the deserializer provides.", "author": "triceo", "createdAt": "2020-03-16T23:12:22Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/main/java/org/optaplanner/persistence/jsonb/api/score/AbstractScoreJsonbDeserializer.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score;\n+\n+import javax.json.bind.serializer.JsonbDeserializer;\n+\n+import org.optaplanner.core.api.score.Score;\n+\n+/**\n+ * JSONB binding support for a {@link Score} type.\n+ * <p>\n+ * For example: use {@code @JsonbTypeSerializer(HardSoftScoreJsonbSerializer.class) @JsonbTypeDeserializer(HardSoftScoreJsonbDeserializer.class)}\n+ * on a {@code HardSoftScore score} field and it will marshalled to JSON as {@code \"score\":\"-999hard/-999soft\"}.\n+ * @see Score\n+ * @param <Score_> the actual score type\n+ */\n+public abstract class AbstractScoreJsonbDeserializer<Score_ extends Score<Score_>>", "originalCommit": "1e528ef56836c6748bc6ee7a4a446fa53454d354", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc0NTM3MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393745371", "bodyText": "@triceo Hmm, good question. I did a quick POC with JsonbAdapter, and it worked just as well with less code. I'll do a refactor, good catch! The end goal of this is to integrate it in the quarkus-optaplanner extension, and de/serializers offer more customization. But it seems Adapters do the job just fine.", "author": "cuijulian", "createdAt": "2020-03-17T15:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM2MTg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMDQ4MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393810481", "bodyText": "I agree that, in some cases, the customization is required. Here, Score already has methods that convert to and from String, and therefore JsonbAdapter is just enough - with the extra benefit of eliminating some code.", "author": "triceo", "createdAt": "2020-03-17T16:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM2MTg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5NjA3MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393896071", "bodyText": "Refactored to use JsonbAdapter instead. Changes have been pushed.", "author": "cuijulian", "createdAt": "2020-03-17T18:45:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM2MTg0NA=="}], "type": "inlineReview"}, {"oid": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "url": "https://github.com/kiegroup/optaplanner/commit/700d6bcb9c0db8d832fad7706717d6fddf49c16d", "message": "Add JSONB adapters for Score de/serialization + tests", "committedDate": "2020-03-17T18:43:14Z", "type": "commit"}, {"oid": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "url": "https://github.com/kiegroup/optaplanner/commit/700d6bcb9c0db8d832fad7706717d6fddf49c16d", "message": "Add JSONB adapters for Score de/serialization + tests", "committedDate": "2020-03-17T18:43:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyMjI5Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393922297", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * on a {@code HardSoftScore score} field and it will serialized to JSON as {@code \"score\":\"-999hard/-999soft\"}.\n          \n          \n            \n             * on a {@code HardSoftScore score} field and it will be serialized to JSON as {@code \"score\":\"-999hard/-999soft\"}.", "author": "triceo", "createdAt": "2020-03-17T19:35:37Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/main/java/org/optaplanner/persistence/jsonb/api/score/AbstractScoreJsonbAdapter.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score;\n+\n+import javax.json.bind.adapter.JsonbAdapter;\n+\n+import org.optaplanner.core.api.score.Score;\n+\n+/**\n+ * JSON-B binding support for a {@link Score} type.\n+ * <p>\n+ * For example: use {@code @JsonbTypeAdapter(HardSoftScoreJsonbAdapter.class)}\n+ * on a {@code HardSoftScore score} field and it will serialized to JSON as {@code \"score\":\"-999hard/-999soft\"}.", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyMjk4NA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393922984", "bodyText": "I have not seen this line anywhere in core or examples. Is there any particular reason why you included it?", "author": "triceo", "createdAt": "2020-03-17T19:36:52Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/main/java/org/optaplanner/persistence/jsonb/api/score/buildin/bendable/BendableScoreJsonbAdapter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score.buildin.bendable;\n+\n+import org.optaplanner.core.api.score.buildin.bendable.BendableScore;\n+import org.optaplanner.persistence.jsonb.api.score.AbstractScoreJsonbAdapter;\n+\n+@SuppressWarnings(\"checkstyle:javadocstyle\")", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkzOTQzMQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393939431", "bodyText": "It's everywhere in optaplanner-persistence-*, mainly in ScoreAdapters and Serializers. Here's the PR that added it with explanation: #291", "author": "cuijulian", "createdAt": "2020-03-17T20:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyMjk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyMzc5MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393923791", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * JSON-B binders for {@link org.optaplanner.core.api.score.Score}.\n          \n          \n            \n             * JSON-B bindings for {@link org.optaplanner.core.api.score.Score}.", "author": "triceo", "createdAt": "2020-03-17T19:38:27Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/main/java/org/optaplanner/persistence/jsonb/api/score/package-info.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/**\n+ * JSON-B binders for {@link org.optaplanner.core.api.score.Score}.", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNTA4OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393925089", "bodyText": "I don't much like regexes in Java, as they become very hard to read. Did you consider using \\Q no need to escape in here \\E to reduce some of that escaping?", "author": "triceo", "createdAt": "2020-03-17T19:40:59Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/score/AbstractScoreJsonbAdapterTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score;\n+\n+import java.io.Serializable;\n+\n+import javax.json.bind.Jsonb;\n+import javax.json.bind.JsonbBuilder;\n+import javax.json.bind.JsonbException;\n+\n+import org.optaplanner.core.api.score.Score;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class AbstractScoreJsonbAdapterTest {\n+\n+    // ************************************************************************\n+    // Helper methods\n+    // ************************************************************************\n+\n+    protected <S extends Score, W extends TestScoreWrapper<S>> void assertSerializeAndDeserialize(S expectedScore, W input) {\n+        String jsonString;\n+        W output;\n+        try {\n+            Jsonb jsonb = JsonbBuilder.create();\n+            jsonString = jsonb.toJson(input);\n+            output = (W) jsonb.fromJson(jsonString, input.getClass());\n+        } catch (JsonbException e) {\n+            throw new IllegalStateException(\"Marshalling or unmarshalling for input (\" + input + \") failed.\", e);\n+        }\n+        assertEquals(expectedScore, output.getScore());\n+\n+        String newLine = System.lineSeparator();\n+        String regex;\n+        if (expectedScore != null) {\n+            regex = \"\\\\{\\\"score\\\":\\\"\" // Start of element\n+                    + expectedScore.toString().replaceAll(\"\\\\[\", \"\\\\\\\\[\").replaceAll(\"\\\\]\", \"\\\\\\\\]\") // Score\n+                    + \"\\\"\\\\}\"; // End of element\n+        } else {\n+            regex = \"\\\\{\\\\}\";", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0MzcxMQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393943711", "bodyText": "What do you mean by \\Q no need to escape in here \\E? Though I do agree that these Java regexes are very ugly, see another example in optaplanner-persistence-jaxb. This PR actually is consistent with that style, though we might as well overhaul all of them in a separate PR. @ge0ffrey WDYT?", "author": "cuijulian", "createdAt": "2020-03-17T20:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0NDE1MA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393944150", "bodyText": "In a Java regex string, you can use \\Q to start a sequence in which escaping is not necessary. \\E ends that sequence.", "author": "triceo", "createdAt": "2020-03-17T20:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NzQ5Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393957496", "bodyText": "I see, yes that would be a lot cleaner. In any case, we would have to change this for all the other modules, so I'm going to hide behind scope creep for this PR.", "author": "cuijulian", "createdAt": "2020-03-17T20:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNTA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNTk4NA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393925984", "bodyText": "Suggestion: instead of using a regex, consider parsing the JSON again and make sure it has the structure you're expecting it to. This will make sure the JSON is valid, without you having to deal with the actual JSON syntax.", "author": "triceo", "createdAt": "2020-03-17T19:42:49Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/score/AbstractScoreJsonbAdapterTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score;\n+\n+import java.io.Serializable;\n+\n+import javax.json.bind.Jsonb;\n+import javax.json.bind.JsonbBuilder;\n+import javax.json.bind.JsonbException;\n+\n+import org.optaplanner.core.api.score.Score;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class AbstractScoreJsonbAdapterTest {\n+\n+    // ************************************************************************\n+    // Helper methods\n+    // ************************************************************************\n+\n+    protected <S extends Score, W extends TestScoreWrapper<S>> void assertSerializeAndDeserialize(S expectedScore, W input) {\n+        String jsonString;\n+        W output;\n+        try {\n+            Jsonb jsonb = JsonbBuilder.create();\n+            jsonString = jsonb.toJson(input);\n+            output = (W) jsonb.fromJson(jsonString, input.getClass());\n+        } catch (JsonbException e) {\n+            throw new IllegalStateException(\"Marshalling or unmarshalling for input (\" + input + \") failed.\", e);\n+        }\n+        assertEquals(expectedScore, output.getScore());\n+\n+        String newLine = System.lineSeparator();\n+        String regex;\n+        if (expectedScore != null) {\n+            regex = \"\\\\{\\\"score\\\":\\\"\" // Start of element\n+                    + expectedScore.toString().replaceAll(\"\\\\[\", \"\\\\\\\\[\").replaceAll(\"\\\\]\", \"\\\\\\\\]\") // Score\n+                    + \"\\\"\\\\}\"; // End of element\n+        } else {\n+            regex = \"\\\\{\\\\}\";\n+        }\n+        if (!jsonString.matches(regex)) {\n+            fail(\"Regular expression match failed.\" + newLine + \"Expected regular expression: \" + regex + newLine +\n+                         \"Actual string: \" + jsonString);\n+        }", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0NDg5Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393944897", "bodyText": "Similar to my comment above, this is currently the practice in the other optaplanner modules. The mentioned overhaul would address this, but I don't see this regex json check as a blocker for this specific PR (not in scope imo).", "author": "cuijulian", "createdAt": "2020-03-17T20:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNTk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNjM3OA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393926378", "bodyText": "Abstract class without any methods? Looks like an interface to me. :-)", "author": "triceo", "createdAt": "2020-03-17T19:43:34Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/score/AbstractScoreJsonbAdapterTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score;\n+\n+import java.io.Serializable;\n+\n+import javax.json.bind.Jsonb;\n+import javax.json.bind.JsonbBuilder;\n+import javax.json.bind.JsonbException;\n+\n+import org.optaplanner.core.api.score.Score;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class AbstractScoreJsonbAdapterTest {\n+\n+    // ************************************************************************\n+    // Helper methods\n+    // ************************************************************************\n+\n+    protected <S extends Score, W extends TestScoreWrapper<S>> void assertSerializeAndDeserialize(S expectedScore, W input) {\n+        String jsonString;\n+        W output;\n+        try {\n+            Jsonb jsonb = JsonbBuilder.create();\n+            jsonString = jsonb.toJson(input);\n+            output = (W) jsonb.fromJson(jsonString, input.getClass());\n+        } catch (JsonbException e) {\n+            throw new IllegalStateException(\"Marshalling or unmarshalling for input (\" + input + \") failed.\", e);\n+        }\n+        assertEquals(expectedScore, output.getScore());\n+\n+        String newLine = System.lineSeparator();\n+        String regex;\n+        if (expectedScore != null) {\n+            regex = \"\\\\{\\\"score\\\":\\\"\" // Start of element\n+                    + expectedScore.toString().replaceAll(\"\\\\[\", \"\\\\\\\\[\").replaceAll(\"\\\\]\", \"\\\\\\\\]\") // Score\n+                    + \"\\\"\\\\}\"; // End of element\n+        } else {\n+            regex = \"\\\\{\\\\}\";\n+        }\n+        if (!jsonString.matches(regex)) {\n+            fail(\"Regular expression match failed.\" + newLine + \"Expected regular expression: \" + regex + newLine +\n+                         \"Actual string: \" + jsonString);\n+        }\n+    }\n+\n+    public static abstract class TestScoreWrapper<S extends Score> implements Serializable {", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNjgzNw==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393926837", "bodyText": "Also, as you're using it from a whole bunch of subclasses, I feel that it should be a top-level interface.", "author": "triceo", "createdAt": "2020-03-17T19:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0NzY4OA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393947688", "bodyText": "Normally I would agree with you, but this class is closely tied and used immediately in the same file. Also note that we see this practice here. This overhaul is looking more and more convincing.", "author": "cuijulian", "createdAt": "2020-03-17T20:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0ODIxNA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393948214", "bodyText": "Putting this abstract class in the same file helps with readability, but that's my opinion.", "author": "cuijulian", "createdAt": "2020-03-17T20:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1MzA1NA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393953054", "bodyText": "OK, I don't have a strong preference either way. Consistency wins.", "author": "triceo", "createdAt": "2020-03-17T20:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNjM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNzU0Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393927542", "bodyText": "Not sure why does this method have the score argument, when it also has the wrapper which can return the score?", "author": "triceo", "createdAt": "2020-03-17T19:45:51Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/score/buildin/bendable/BendableScoreJsonbAdapterTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score.buildin.bendable;\n+\n+import javax.json.bind.annotation.JsonbTypeAdapter;\n+\n+import org.junit.Test;\n+import org.optaplanner.core.api.score.buildin.bendable.BendableScore;\n+import org.optaplanner.persistence.jsonb.api.score.AbstractScoreJsonbAdapterTest;\n+\n+public class BendableScoreJsonbAdapterTest extends AbstractScoreJsonbAdapterTest {\n+\n+    @Test\n+    public void serializeAndDeserialize() {\n+        assertSerializeAndDeserialize(null, new TestBendableScoreWrapper(null));", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1Mjk5MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393952991", "bodyText": "The score arg is used as a reference to assert that the Wrapper is serialized, then deserialized to contain the same score result. This approach is also used in the other modules, but we could discuss changing them all in a future PR.", "author": "cuijulian", "createdAt": "2020-03-17T20:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyNzU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyODUzNw==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393928537", "bodyText": "Suggestion: put a comment in the empty constructor, saying something like \"Required by JSON-B.\" People won't have to spend time thinking why the unused constructor is there.", "author": "triceo", "createdAt": "2020-03-17T19:47:42Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/score/buildin/bendable/BendableScoreJsonbAdapterTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score.buildin.bendable;\n+\n+import javax.json.bind.annotation.JsonbTypeAdapter;\n+\n+import org.junit.Test;\n+import org.optaplanner.core.api.score.buildin.bendable.BendableScore;\n+import org.optaplanner.persistence.jsonb.api.score.AbstractScoreJsonbAdapterTest;\n+\n+public class BendableScoreJsonbAdapterTest extends AbstractScoreJsonbAdapterTest {\n+\n+    @Test\n+    public void serializeAndDeserialize() {\n+        assertSerializeAndDeserialize(null, new TestBendableScoreWrapper(null));\n+        BendableScore score = BendableScore.of(new int[]{1000, 200}, new int[]{34});\n+        assertSerializeAndDeserialize(score, new TestBendableScoreWrapper(score));\n+        score = BendableScore.ofUninitialized(-7, new int[]{1000, 200}, new int[]{34});\n+        assertSerializeAndDeserialize(score, new TestBendableScoreWrapper(score));\n+    }\n+\n+    public static class TestBendableScoreWrapper extends TestScoreWrapper<BendableScore> {\n+\n+        @JsonbTypeAdapter(BendableScoreJsonbAdapter.class)\n+        private BendableScore score;\n+\n+        @SuppressWarnings(\"unused\")\n+        public TestBendableScoreWrapper() {", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyOTE4MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393929181", "bodyText": "Some of the test classes don't have the blank lines in here. I don't mind if you want to keep them - but in that case, be consistent, please.", "author": "triceo", "createdAt": "2020-03-17T19:48:51Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/score/buildin/bendablelong/BendableLongScoreJsonbAdapterTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score.buildin.bendablelong;\n+\n+import javax.json.bind.annotation.JsonbTypeAdapter;\n+\n+import org.junit.Test;\n+import org.optaplanner.core.api.score.buildin.bendablelong.BendableLongScore;\n+import org.optaplanner.persistence.jsonb.api.score.AbstractScoreJsonbAdapterTest;\n+\n+public class BendableLongScoreJsonbAdapterTest extends AbstractScoreJsonbAdapterTest {\n+\n+    @Test\n+    public void serializeAndDeserialize() {\n+        assertSerializeAndDeserialize(null, new TestBendableLongScoreWrapper(null));\n+\n+        BendableLongScore score = BendableLongScore.of(new long[]{1000L, 200L}, new long[]{34L});\n+        assertSerializeAndDeserialize(score, new TestBendableLongScoreWrapper(score));\n+", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1OTE0Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393959146", "bodyText": "Removing them for consistency with other modules.", "author": "cuijulian", "createdAt": "2020-03-17T20:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyOTE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyOTU1Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r393929557", "bodyText": "Our friend, the code style. :-) We don't align on columns.\nAnyway... leave it as it is, let's wait for Radek to bring his unifying PR.", "author": "triceo", "createdAt": "2020-03-17T19:49:37Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/score/buildin/hardmediumsoftbigdecimal/HardMediumSoftBigDecimalScoreJsonbAdapterTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score.buildin.hardmediumsoftbigdecimal;\n+\n+import java.math.BigDecimal;\n+\n+import javax.json.bind.annotation.JsonbTypeAdapter;\n+\n+import org.junit.Test;\n+import org.optaplanner.core.api.score.buildin.hardmediumsoftbigdecimal.HardMediumSoftBigDecimalScore;\n+import org.optaplanner.persistence.jsonb.api.score.AbstractScoreJsonbAdapterTest;\n+\n+public class HardMediumSoftBigDecimalScoreJsonbAdapterTest extends AbstractScoreJsonbAdapterTest {\n+\n+    @Test\n+    public void serializeAndDeserialize() {\n+        assertSerializeAndDeserialize(null, new TestHardMediumSoftBigDecimalScoreWrapper(null));\n+\n+        HardMediumSoftBigDecimalScore score = HardMediumSoftBigDecimalScore.of(new BigDecimal(\"1200.0021\"),\n+                                                                               new BigDecimal(\"-3.1415\"),\n+                                                                               new BigDecimal(\"34.4300\"));", "originalCommit": "700d6bcb9c0db8d832fad7706717d6fddf49c16d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aded4f60bbbc0367feecbee8582b2e9b5f56c87c", "url": "https://github.com/kiegroup/optaplanner/commit/aded4f60bbbc0367feecbee8582b2e9b5f56c87c", "message": "Minor formatting and typo fixes", "committedDate": "2020-03-17T20:47:47Z", "type": "commit"}, {"oid": "ea642bfc0a80c7299e1116e871f71e241b2a0af6", "url": "https://github.com/kiegroup/optaplanner/commit/ea642bfc0a80c7299e1116e871f71e241b2a0af6", "message": "Add OptaPlannerJsonbConfig + tests", "committedDate": "2020-03-19T02:15:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgzNzI5Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r394837296", "bodyText": "In light of your recent changes, I was wondering... could we get rid of the Test...ScoreWrappers, if we use the new OptaplannerJsonbConfig here, @cuijulian ?\nUnless there's some technical hurdle I'm overlooking, this could remove a lot of code from this PR.", "author": "triceo", "createdAt": "2020-03-19T07:39:48Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/score/AbstractScoreJsonbAdapterTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api.score;\n+\n+import java.io.Serializable;\n+\n+import javax.json.bind.Jsonb;\n+import javax.json.bind.JsonbBuilder;\n+import javax.json.bind.JsonbException;\n+\n+import org.optaplanner.core.api.score.Score;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class AbstractScoreJsonbAdapterTest {\n+\n+    // ************************************************************************\n+    // Helper methods\n+    // ************************************************************************\n+\n+    protected <S extends Score, W extends TestScoreWrapper<S>> void assertSerializeAndDeserialize(S expectedScore, W input) {\n+        String jsonString;\n+        W output;\n+        try {\n+            Jsonb jsonb = JsonbBuilder.create();", "originalCommit": "ea642bfc0a80c7299e1116e871f71e241b2a0af6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg5MzgzMg==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r394893832", "bodyText": "Any such changes must also be applied to the jacksons tests (and potentially jaxb and xstream), for consistency.\n\n\nNot sure about reusing the OptaPlannerJsonbConfig here: on one hand the philosophy of HardSoftScoreJsonbAdapterTest etc is to test the adaptor (= binding) in isolation, as a unit test. On the other hand, we want everyone to use the OptaPlannerJsonbConfig. So I am fine either way, as long is 1) is adhered to, with a slight preference to status quo. For Julian's sake, if we do it, I suggest in a follow up PR?", "author": "ge0ffrey", "createdAt": "2020-03-19T09:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgzNzI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAzNDg1NQ==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r395034855", "bodyText": "This is currently consistent with the Jackson tests, any refactors will have to be done in a separate PR on all existing modules like Jackson, Jaxb, etc. As Geoffrey mentioned in his comment below, these individual Score Adapter tests are not quite a duplicate of the OptaPlannerJsonbConfig test. The latter tests that the Config object (which contains all the Score Adapters) actually works when used on a Wrapper with multiple Score types.", "author": "cuijulian", "createdAt": "2020-03-19T13:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgzNzI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg5MTgwNg==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r394891806", "bodyText": "For moment, I got confused that this test duplicates HardSoftScoreJsonbAdapterTest, but it doesn't.\nThe jackson version of this has 2 Scores, including a \"generic Score\", something not supported by JSON-B (which is fine).\nSuggestion: Add a BendableScore too in this test (so it has 2 scores). Also add a BendableScore in the jackson version of this test (so it has 3 scores).\nThis does give us some extra test code coverage, to prove that bendables also work without explicit annotations :)", "author": "ge0ffrey", "createdAt": "2020-03-19T09:28:42Z", "path": "optaplanner-persistence/optaplanner-persistence-jsonb/src/test/java/org/optaplanner/persistence/jsonb/api/OptaPlannerJsonbConfigTest.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jsonb.api;\n+\n+import javax.json.bind.Jsonb;\n+import javax.json.bind.JsonbBuilder;\n+import javax.json.bind.JsonbConfig;\n+\n+import org.junit.Test;\n+\n+import org.optaplanner.core.api.score.buildin.hardsoft.HardSoftScore;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class OptaPlannerJsonbConfigTest extends AbstractJsonbJsonAdapterTest {\n+\n+    @Test\n+    public void jsonbConfigSerializeAndDeserialize() {\n+        JsonbConfig config = OptaPlannerJsonbConfig.createConfig();\n+        Jsonb jsonb = JsonbBuilder.create(config);\n+\n+        TestOptaPlannerJsonbConfigWrapper input = new TestOptaPlannerJsonbConfigWrapper();\n+        input.setHardSoftScore(HardSoftScore.of(-1, -20));\n+        TestOptaPlannerJsonbConfigWrapper output = serializeAndDeserialize(jsonb, input);\n+        assertEquals(HardSoftScore.of(-1, -20), output.getHardSoftScore());\n+    }\n+\n+    public static class TestOptaPlannerJsonbConfigWrapper {\n+\n+        private HardSoftScore hardSoftScore;", "originalCommit": "ea642bfc0a80c7299e1116e871f71e241b2a0af6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAzNTY2MA==", "url": "https://github.com/kiegroup/optaplanner/pull/720#discussion_r395035660", "bodyText": "Will do.", "author": "cuijulian", "createdAt": "2020-03-19T13:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg5MTgwNg=="}], "type": "inlineReview"}, {"oid": "5a295b748aaa31a9fa9776424a193bb034e35189", "url": "https://github.com/kiegroup/optaplanner/commit/5a295b748aaa31a9fa9776424a193bb034e35189", "message": "Add BendableScore in JacksonModule and JsonbConfig tests", "committedDate": "2020-03-19T14:08:36Z", "type": "commit"}]}