{"pr_number": 834, "pr_title": "PLANNER-2024 Switch solver configuration from XStream to JAXB", "pr_createdAt": "2020-07-13T15:36:37Z", "pr_url": "https://github.com/kiegroup/optaplanner/pull/834", "timeline": [{"oid": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "url": "https://github.com/kiegroup/optaplanner/commit/3eaa5c60439b61368dc3276f9d61c44772353e5a", "message": "Remove unused XStreamConfigReader", "committedDate": "2020-07-14T07:21:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE1NTk5MA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454155990", "bodyText": "TODO: check if we need such an adapter for JAXB too.", "author": "rsynek", "createdAt": "2020-07-14T07:23:53Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/solver/io/XStreamConfigReader.java", "diffHunk": "@@ -1,90 +0,0 @@\n-/*\n- * Copyright 2019 Red Hat, Inc. and/or its affiliates.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package org.optaplanner.core.impl.solver.io;\n-\n-import java.io.File;\n-\n-import org.optaplanner.core.api.domain.solution.PlanningSolution;\n-import org.optaplanner.core.config.solver.SolverConfig;\n-\n-import com.thoughtworks.xstream.XStream;\n-import com.thoughtworks.xstream.converters.extended.FileConverter;\n-\n-public final class XStreamConfigReader {\n-\n-    /**\n-     * Builds the {@link XStream} setup which is used to read/write {@link SolverConfig solver configs} and benchmark configs.\n-     * It should never be used to read/write {@link PlanningSolution solutions}.\n-     * Use XStreamSolutionFileIO for that instead.\n-     *\n-     * @return never null.\n-     */\n-    public static XStream buildXStream() {\n-        XStream xStream = new XStream();\n-        xStream.setMode(XStream.ID_REFERENCES);\n-        xStream.aliasSystemAttribute(\"xStreamId\", \"id\");\n-        xStream.aliasSystemAttribute(\"xStreamRef\", \"reference\");\n-        xStream.processAnnotations(SolverConfig.class);\n-        XStream.setupDefaultSecurity(xStream);\n-        xStream.allowTypesByRegExp(new String[] { \"org\\\\.optaplanner\\\\.\\\\w+\\\\.config\\\\..*\" });\n-        return xStream;\n-    }\n-\n-    /**\n-     * As defined by {@link #buildXStream()}.\n-     *\n-     * @param classLoader sometimes null, ignored if null\n-     * @return never null\n-     */\n-    public static XStream buildXStream(ClassLoader classLoader) {\n-        XStream xStream = buildXStream();\n-        if (classLoader != null) {\n-            xStream.setClassLoader(classLoader);\n-        }\n-        return xStream;\n-    }\n-\n-    public static XStream buildXStream(ClassLoader classLoader, Class... xStreamAnnotations) {\n-        XStream xStream = buildXStream(classLoader);\n-        if (xStreamAnnotations.length > 0) {\n-            xStream.processAnnotations(xStreamAnnotations);\n-            xStream.allowTypes(xStreamAnnotations);\n-        }\n-        return xStream;\n-    }\n-\n-    public static XStream buildXStreamPortable(ClassLoader classLoader, Class... xStreamAnnotations) {", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE1ODI0OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454158249", "bodyText": "I think that this is a reason to throw.", "author": "triceo", "createdAt": "2020-07-14T07:28:08Z", "path": "optaplanner-benchmark/src/main/java/org/optaplanner/benchmark/impl/io/jaxb/OffsetDateTimeJaxbAdapter.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.benchmark.impl.io.jaxb;\n+\n+import java.time.DateTimeException;\n+import java.time.OffsetDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.temporal.ChronoField;\n+\n+import javax.xml.bind.annotation.adapters.XmlAdapter;\n+\n+public class OffsetDateTimeJaxbAdapter extends XmlAdapter<String, OffsetDateTime> {\n+    private final DateTimeFormatter formatter;\n+\n+    public OffsetDateTimeJaxbAdapter() {\n+        formatter = new DateTimeFormatterBuilder()\n+                .appendPattern(\"uuuu-MM-dd'T'HH:mm:ss\")\n+                .appendFraction(ChronoField.NANO_OF_SECOND, 0, 9, true)\n+                .appendOffsetId()\n+                .toFormatter();\n+    }\n+\n+    @Override\n+    public OffsetDateTime unmarshal(String offsetDateTimeString) {\n+        if (offsetDateTimeString == null || offsetDateTimeString.isEmpty()) {\n+            return null;\n+        }", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE3Mjc3OA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454172778", "bodyText": "I see. Some fields of the serialized model, though, can be null and in such a case throwing an exception is not an option. Let me see if JAXB can do something about it without just passing null to the adapter.", "author": "rsynek", "createdAt": "2020-07-14T07:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE1ODI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNTE1Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454215156", "bodyText": "Unfortunately, JAXB keeps passing null values into the adapters despite corresponding fields are marked with @XmlElement(nillable = true).", "author": "rsynek", "createdAt": "2020-07-14T09:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE1ODI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE1ODQxMA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454158410", "bodyText": "Likewise.", "author": "triceo", "createdAt": "2020-07-14T07:28:29Z", "path": "optaplanner-benchmark/src/main/java/org/optaplanner/benchmark/impl/io/jaxb/OffsetDateTimeJaxbAdapter.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.benchmark.impl.io.jaxb;\n+\n+import java.time.DateTimeException;\n+import java.time.OffsetDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.temporal.ChronoField;\n+\n+import javax.xml.bind.annotation.adapters.XmlAdapter;\n+\n+public class OffsetDateTimeJaxbAdapter extends XmlAdapter<String, OffsetDateTime> {\n+    private final DateTimeFormatter formatter;\n+\n+    public OffsetDateTimeJaxbAdapter() {\n+        formatter = new DateTimeFormatterBuilder()\n+                .appendPattern(\"uuuu-MM-dd'T'HH:mm:ss\")\n+                .appendFraction(ChronoField.NANO_OF_SECOND, 0, 9, true)\n+                .appendOffsetId()\n+                .toFormatter();\n+    }\n+\n+    @Override\n+    public OffsetDateTime unmarshal(String offsetDateTimeString) {\n+        if (offsetDateTimeString == null || offsetDateTimeString.isEmpty()) {\n+            return null;\n+        }\n+        try {\n+            return OffsetDateTime.from(formatter.parse(offsetDateTimeString));\n+        } catch (DateTimeException e) {\n+            throw new IllegalStateException(\"Failed to convert string (\" + offsetDateTimeString + \") to type (\"\n+                    + OffsetDateTime.class.getName() + \").\");\n+        }\n+    }\n+\n+    @Override\n+    public String marshal(OffsetDateTime offsetDateTimeObject) {\n+        if (offsetDateTimeObject == null) {\n+            return null;\n+        }", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE1OTI5Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454159292", "bodyText": "For the sake of consistency, I'd use Objects.equals() here as well.", "author": "triceo", "createdAt": "2020-07-14T07:30:06Z", "path": "optaplanner-benchmark/src/main/java/org/optaplanner/benchmark/impl/loader/InstanceProblemProvider.java", "diffHunk": "@@ -57,22 +67,24 @@ public void writeSolution(Solution_ solution, SubSingleBenchmarkResult subSingle\n     public boolean equals(Object o) {\n         if (this == o) {\n             return true;\n-        } else if (o instanceof InstanceProblemProvider) {\n-            InstanceProblemProvider other = (InstanceProblemProvider) o;\n-            return problem.equals(other.problem);\n-        } else {\n+        }\n+        if (!(o instanceof InstanceProblemProvider)) {\n             return false;\n         }\n+        InstanceProblemProvider<?> that = (InstanceProblemProvider<?>) o;\n+        return problemName.equals(that.problemName) &&", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MTc4Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454161786", "bodyText": "Are we sure JAXB doesn't already have an exception that could be used?", "author": "triceo", "createdAt": "2020-07-14T07:34:59Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/io/XmlUnmarshallingException.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.core.impl.io;\n+\n+public class XmlUnmarshallingException extends RuntimeException {", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE3MTE1Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454171152", "bodyText": "Sure it does: JAXBException [1], which is checked. Also, I want to avoid leaking the JAXB-specific code in OptaPlanner codebase.\n[1] https://docs.oracle.com/javase/8/docs/api/javax/xml/bind/JAXBException.html", "author": "rsynek", "createdAt": "2020-07-14T07:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MTc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MjU5MA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454192590", "bodyText": "If it leaks too deep, I see. If it doesn't, I'd rather we use it directly.", "author": "triceo", "createdAt": "2020-07-14T08:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MTc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIwODczMA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454208730", "bodyText": "It would leak to classes that read benchmark config, solver config, and benchmark report. And all corresponding tests. I prefer keeping the translated exception.", "author": "rsynek", "createdAt": "2020-07-14T08:58:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MTc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MjI3Mw==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454162273", "bodyText": "Personally, I don't see a need for this. It's in impl, so we needn't worry about backwards compatibility or exposing public methods. You might've as well used the class directly.", "author": "triceo", "createdAt": "2020-07-14T07:35:49Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/io/XmlIO.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.core.impl.io;\n+\n+import java.io.Reader;\n+import java.io.Writer;\n+\n+/**\n+ * Generic XML read/write facility.\n+ */\n+public interface XmlIO<T> {", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE3MTE4NA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454171184", "bodyText": "As in my answer to the previous comment, the main motivation is to avoid leaking JAXB and make it easily replaceable by any future XML marshalling technology, if needed.", "author": "rsynek", "createdAt": "2020-07-14T07:52:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MjI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MzIwMA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454193200", "bodyText": "XML is dying, cool kids use JSON now, there won't be any other XML technology. :-)", "author": "triceo", "createdAt": "2020-07-14T08:31:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MjI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIwNzkzNA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454207934", "bodyText": "I agree the interface is not necessary for our purposes, will remove it.\nBut I disagree with the JSON, cool kids use YAML nowadays.", "author": "rsynek", "createdAt": "2020-07-14T08:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MjI3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MjcwMg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454162702", "bodyText": "Again, I think that null and empty string is the incorrect input here. It should throw, not silently fail.", "author": "triceo", "createdAt": "2020-07-14T07:36:45Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/io/jaxb/JaxbDurationAdapter.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.core.impl.io.jaxb;\n+\n+import java.time.Duration;\n+\n+import javax.xml.bind.annotation.adapters.XmlAdapter;\n+\n+public class JaxbDurationAdapter extends XmlAdapter<String, Duration> {\n+\n+    @Override\n+    public Duration unmarshal(String durationString) {\n+        if (durationString == null || durationString.isEmpty()) {\n+            return null;\n+        }", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MzkwMg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454163902", "bodyText": "Personally, I think that Objects.requireNonNull() at use site would sufficehere. You're just replacing one exception with another.", "author": "triceo", "createdAt": "2020-07-14T07:39:06Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/io/jaxb/JaxbIO.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.core.impl.io.jaxb;\n+\n+import java.io.Reader;\n+import java.io.Writer;\n+import java.nio.charset.StandardCharsets;\n+\n+import javax.xml.bind.JAXBContext;\n+import javax.xml.bind.JAXBException;\n+import javax.xml.bind.Marshaller;\n+import javax.xml.bind.Unmarshaller;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+\n+import org.optaplanner.core.impl.io.XmlIO;\n+import org.optaplanner.core.impl.io.XmlUnmarshallingException;\n+\n+public final class JaxbIO<T> implements XmlIO<T> {\n+    private static final int DEFAULT_INDENTATION = 2;\n+\n+    private final Unmarshaller unmarshaller;\n+    private final Marshaller marshaller;\n+    private final Class<T> rootClass;\n+    private final int indentation;\n+\n+    public JaxbIO(Class<T> rootClass) {\n+        this(rootClass, DEFAULT_INDENTATION);\n+    }\n+\n+    public JaxbIO(Class<T> rootClass, int indentation) {\n+        if (rootClass == null) {\n+            throw new IllegalArgumentException(\"Root element class cannot be null.\");\n+        }\n+        this.rootClass = rootClass;\n+        this.indentation = indentation;\n+        try {\n+            JAXBContext jaxbContext = JAXBContext.newInstance(rootClass);\n+            unmarshaller = jaxbContext.createUnmarshaller();\n+            marshaller = jaxbContext.createMarshaller();\n+            marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);\n+            marshaller.setProperty(Marshaller.JAXB_ENCODING, StandardCharsets.UTF_8.toString());\n+        } catch (JAXBException jaxbException) {\n+            String errMessage = String.format(\"Unable to create JAXB marshaller or unmarshaller for a root element class %s.\",\n+                    rootClass.getName());\n+            throw new IllegalStateException(errMessage, jaxbException);\n+        }\n+    }\n+\n+    public T read(Reader reader) {\n+        if (reader == null) {\n+            throw new IllegalArgumentException(\"Reader cannot be null.\");\n+        }", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2Mzk3Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454163972", "bodyText": "Dtto.", "author": "triceo", "createdAt": "2020-07-14T07:39:14Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/io/jaxb/JaxbIO.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.core.impl.io.jaxb;\n+\n+import java.io.Reader;\n+import java.io.Writer;\n+import java.nio.charset.StandardCharsets;\n+\n+import javax.xml.bind.JAXBContext;\n+import javax.xml.bind.JAXBException;\n+import javax.xml.bind.Marshaller;\n+import javax.xml.bind.Unmarshaller;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+\n+import org.optaplanner.core.impl.io.XmlIO;\n+import org.optaplanner.core.impl.io.XmlUnmarshallingException;\n+\n+public final class JaxbIO<T> implements XmlIO<T> {\n+    private static final int DEFAULT_INDENTATION = 2;\n+\n+    private final Unmarshaller unmarshaller;\n+    private final Marshaller marshaller;\n+    private final Class<T> rootClass;\n+    private final int indentation;\n+\n+    public JaxbIO(Class<T> rootClass) {\n+        this(rootClass, DEFAULT_INDENTATION);\n+    }\n+\n+    public JaxbIO(Class<T> rootClass, int indentation) {\n+        if (rootClass == null) {\n+            throw new IllegalArgumentException(\"Root element class cannot be null.\");\n+        }\n+        this.rootClass = rootClass;\n+        this.indentation = indentation;\n+        try {\n+            JAXBContext jaxbContext = JAXBContext.newInstance(rootClass);\n+            unmarshaller = jaxbContext.createUnmarshaller();\n+            marshaller = jaxbContext.createMarshaller();\n+            marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);\n+            marshaller.setProperty(Marshaller.JAXB_ENCODING, StandardCharsets.UTF_8.toString());\n+        } catch (JAXBException jaxbException) {\n+            String errMessage = String.format(\"Unable to create JAXB marshaller or unmarshaller for a root element class %s.\",\n+                    rootClass.getName());\n+            throw new IllegalStateException(errMessage, jaxbException);\n+        }\n+    }\n+\n+    public T read(Reader reader) {\n+        if (reader == null) {\n+            throw new IllegalArgumentException(\"Reader cannot be null.\");\n+        }\n+        try {\n+            return (T) unmarshaller.unmarshal(reader);\n+        } catch (JAXBException jaxbException) {\n+            String errMessage = String.format(\"Unable to read the %s from XML.\", rootClass.getName());\n+            throw new XmlUnmarshallingException(errMessage, jaxbException);\n+        }\n+    }\n+\n+    public void write(T root, Writer writer) {\n+        if (writer == null) {\n+            throw new IllegalArgumentException(\"Writer cannot be null.\");\n+        }", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2NDIwOA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454164208", "bodyText": "Same comment on Objects.requireNonNull().", "author": "triceo", "createdAt": "2020-07-14T07:39:42Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/io/jaxb/JaxbIO.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.core.impl.io.jaxb;\n+\n+import java.io.Reader;\n+import java.io.Writer;\n+import java.nio.charset.StandardCharsets;\n+\n+import javax.xml.bind.JAXBContext;\n+import javax.xml.bind.JAXBException;\n+import javax.xml.bind.Marshaller;\n+import javax.xml.bind.Unmarshaller;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+\n+import org.optaplanner.core.impl.io.XmlIO;\n+import org.optaplanner.core.impl.io.XmlUnmarshallingException;\n+\n+public final class JaxbIO<T> implements XmlIO<T> {\n+    private static final int DEFAULT_INDENTATION = 2;\n+\n+    private final Unmarshaller unmarshaller;\n+    private final Marshaller marshaller;\n+    private final Class<T> rootClass;\n+    private final int indentation;\n+\n+    public JaxbIO(Class<T> rootClass) {\n+        this(rootClass, DEFAULT_INDENTATION);\n+    }\n+\n+    public JaxbIO(Class<T> rootClass, int indentation) {\n+        if (rootClass == null) {\n+            throw new IllegalArgumentException(\"Root element class cannot be null.\");\n+        }\n+        this.rootClass = rootClass;", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2NDkzOQ==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454164939", "bodyText": "Wouldn't this warn of try-with-resources violation?\n(It's not an issue, since StringWriter can't leak anything, but I don't think IDEs are so smart.)", "author": "triceo", "createdAt": "2020-07-14T07:41:04Z", "path": "optaplanner-core/src/test/java/org/optaplanner/core/config/solver/SolverConfigTest.java", "diffHunk": "@@ -19,66 +19,43 @@\n import static org.assertj.core.api.Assertions.assertThat;\n \n import java.io.IOException;\n-import java.io.InputStream;\n+import java.io.InputStreamReader;\n import java.io.Reader;\n import java.io.StringReader;\n import java.io.StringWriter;\n import java.io.Writer;\n import java.nio.charset.StandardCharsets;\n \n-import javax.xml.bind.JAXBContext;\n-import javax.xml.bind.JAXBException;\n-import javax.xml.bind.Marshaller;\n-import javax.xml.bind.Unmarshaller;\n-import javax.xml.transform.OutputKeys;\n-import javax.xml.transform.Transformer;\n-import javax.xml.transform.TransformerException;\n-import javax.xml.transform.TransformerFactory;\n-import javax.xml.transform.dom.DOMResult;\n-import javax.xml.transform.dom.DOMSource;\n-import javax.xml.transform.stream.StreamResult;\n-\n import org.apache.commons.io.IOUtils;\n import org.junit.jupiter.api.Test;\n import org.optaplanner.core.api.score.stream.ConstraintProvider;\n-import org.optaplanner.core.api.solver.SolverFactory;\n import org.optaplanner.core.config.constructionheuristic.ConstructionHeuristicPhaseConfig;\n import org.optaplanner.core.config.heuristic.selector.move.generic.ChangeMoveSelectorConfig;\n import org.optaplanner.core.config.heuristic.selector.value.ValueSelectorConfig;\n import org.optaplanner.core.impl.heuristic.selector.common.decorator.SelectionFilter;\n import org.optaplanner.core.impl.heuristic.selector.move.factory.MoveIteratorFactory;\n import org.optaplanner.core.impl.heuristic.selector.move.factory.MoveListFactory;\n import org.optaplanner.core.impl.heuristic.selector.move.generic.ChangeMove;\n+import org.optaplanner.core.impl.io.XmlIO;\n+import org.optaplanner.core.impl.io.jaxb.JaxbIO;\n import org.optaplanner.core.impl.partitionedsearch.partitioner.SolutionPartitioner;\n import org.optaplanner.core.impl.score.director.easy.EasyScoreCalculator;\n import org.optaplanner.core.impl.score.director.incremental.IncrementalScoreCalculator;\n-import org.optaplanner.core.impl.solver.io.XStreamConfigReader;\n import org.optaplanner.core.impl.testdata.domain.TestdataEntity;\n import org.optaplanner.core.impl.testdata.domain.TestdataSolution;\n import org.optaplanner.core.impl.testdata.domain.TestdataValue;\n \n-import com.thoughtworks.xstream.XStream;\n-\n public class SolverConfigTest {\n     private static final String TEST_SOLVER_CONFIG = \"testSolverConfig.xml\";\n \n-    private final Unmarshaller unmarshaller;\n-    private final Marshaller marshaller;\n-\n-    public SolverConfigTest() throws JAXBException {\n-        JAXBContext jaxbContext = JAXBContext.newInstance(SolverConfig.class);\n-        unmarshaller = jaxbContext.createUnmarshaller();\n-        marshaller = jaxbContext.createMarshaller();\n-        marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);\n-        marshaller.setProperty(Marshaller.JAXB_ENCODING, StandardCharsets.UTF_8.toString());\n-    }\n+    private final XmlIO<SolverConfig> xmlIO = new JaxbIO<>(SolverConfig.class);\n \n     @Test\n     public void jaxbXmlConfigFileRemainsSameAfterReadWrite() throws IOException {\n         SolverConfig jaxbSolverConfig = unmarshallSolverConfigFromResource(TEST_SOLVER_CONFIG);\n \n         Writer stringWriter = new StringWriter();\n-        marshall(jaxbSolverConfig, stringWriter);\n+        xmlIO.write(jaxbSolverConfig, stringWriter);", "originalCommit": "3eaa5c60439b61368dc3276f9d61c44772353e5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2NzgyMA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454167820", "bodyText": "No warning by my IDE at all.", "author": "rsynek", "createdAt": "2020-07-14T07:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2NDkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5NDE2NA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454194164", "bodyText": "FYI you can use requireNonNull() like this:\nmarshaller.marshal(requireNonNull(root), domResult);", "author": "triceo", "createdAt": "2020-07-14T08:33:36Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/io/jaxb/JaxbIO.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.core.impl.io.jaxb;\n+\n+import java.io.Reader;\n+import java.io.Writer;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Objects;\n+\n+import javax.xml.bind.JAXBContext;\n+import javax.xml.bind.JAXBException;\n+import javax.xml.bind.Marshaller;\n+import javax.xml.bind.Unmarshaller;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+\n+import org.optaplanner.core.impl.io.XmlIO;\n+import org.optaplanner.core.impl.io.XmlUnmarshallingException;\n+\n+public final class JaxbIO<T> implements XmlIO<T> {\n+    private static final int DEFAULT_INDENTATION = 2;\n+\n+    private final Unmarshaller unmarshaller;\n+    private final Marshaller marshaller;\n+    private final Class<T> rootClass;\n+    private final int indentation;\n+\n+    public JaxbIO(Class<T> rootClass) {\n+        this(rootClass, DEFAULT_INDENTATION);\n+    }\n+\n+    public JaxbIO(Class<T> rootClass, int indentation) {\n+        Objects.requireNonNull(rootClass);\n+        this.rootClass = rootClass;\n+        this.indentation = indentation;\n+        try {\n+            JAXBContext jaxbContext = JAXBContext.newInstance(rootClass);\n+            unmarshaller = jaxbContext.createUnmarshaller();\n+            marshaller = jaxbContext.createMarshaller();\n+            marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);\n+            marshaller.setProperty(Marshaller.JAXB_ENCODING, StandardCharsets.UTF_8.toString());\n+        } catch (JAXBException jaxbException) {\n+            String errMessage = String.format(\"Unable to create JAXB marshaller or unmarshaller for a root element class %s.\",\n+                    rootClass.getName());\n+            throw new IllegalStateException(errMessage, jaxbException);\n+        }\n+    }\n+\n+    public T read(Reader reader) {\n+        Objects.requireNonNull(reader);\n+        try {\n+            return (T) unmarshaller.unmarshal(reader);\n+        } catch (JAXBException jaxbException) {\n+            String errMessage = String.format(\"Unable to read the %s from XML.\", rootClass.getName());\n+            throw new XmlUnmarshallingException(errMessage, jaxbException);\n+        }\n+    }\n+\n+    public void write(T root, Writer writer) {\n+        Objects.requireNonNull(root);\n+        Objects.requireNonNull(writer);\n+        DOMResult domResult = new DOMResult();\n+        try {\n+            marshaller.marshal(root, domResult);", "originalCommit": "de0e77ee2c0bf169bc4a954c708b59a3daa570e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1MTA5Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454251096", "bodyText": "Thanks, but I prefer keeping it - if checking input parameters, let's check them in the same order in which they come.", "author": "rsynek", "createdAt": "2020-07-14T10:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5NDE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0MDM4Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454940382", "bodyText": "Is there any work being doing to support java.time out of the box in a new version of JAXB (maybe at Jakarta)?\nIf so, it would nice to have TODO comment with an expiration condition and an url link.", "author": "ge0ffrey", "createdAt": "2020-07-15T10:07:07Z", "path": "optaplanner-benchmark/src/main/java/org/optaplanner/benchmark/impl/io/jaxb/OffsetDateTimeJaxbAdapter.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.benchmark.impl.io.jaxb;\n+\n+import java.time.DateTimeException;\n+import java.time.OffsetDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.temporal.ChronoField;\n+\n+import javax.xml.bind.annotation.adapters.XmlAdapter;\n+\n+public class OffsetDateTimeJaxbAdapter extends XmlAdapter<String, OffsetDateTime> {", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzMzk3Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455033977", "bodyText": "Already discussed. For the others:\n\nwe merge these adapters (I will first doublecheck if there is anything available in the KIE group)\nI will try to push this upstream", "author": "rsynek", "createdAt": "2020-07-15T13:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0MDM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA0MDc5MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455040791", "bodyText": "Can we move this Adaptor next to the Duration one and on both add a // TODO <link to jakarta repo issue>", "author": "ge0ffrey", "createdAt": "2020-07-15T13:14:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0MDM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0MzMxNg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454943316", "bodyText": "(just thinking aloud, no action needed)\nThis is basically saying that all classes within the org.optaplanner namespace aren't exploitable.\nThat included org.optaplanner.examples, which did has this code in the dinner party example:\n  <customPhase>\n    <customPhaseCommandClass>org.optaplanner.examples.dinnerparty.solver.solution.initializer.DinnerPartySolutionInitializer</customPhaseCommandClass>\n  </customPhase>\n\nThat has test coverage, so all is well with JAXB, I presume?", "author": "ge0ffrey", "createdAt": "2020-07-15T10:12:39Z", "path": "optaplanner-benchmark/src/main/java/org/optaplanner/benchmark/impl/result/BenchmarkResultIO.java", "diffHunk": "@@ -33,36 +33,24 @@\n import org.optaplanner.benchmark.impl.statistic.ProblemStatistic;\n import org.optaplanner.benchmark.impl.statistic.PureSubSingleStatistic;\n import org.optaplanner.core.config.solver.SolverConfig;\n-import org.optaplanner.core.impl.solver.io.XStreamConfigReader;\n-import org.optaplanner.persistence.xstream.api.score.AbstractScoreXStreamConverter;\n+import org.optaplanner.core.impl.io.XmlUnmarshallingException;\n+import org.optaplanner.core.impl.io.jaxb.JaxbIO;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.thoughtworks.xstream.XStream;\n-import com.thoughtworks.xstream.XStreamException;\n-import com.thoughtworks.xstream.converters.ConversionException;\n-\n public class BenchmarkResultIO {\n \n     private static final String PLANNER_BENCHMARK_RESULT_FILENAME = \"plannerBenchmarkResult.xml\";\n \n     protected final transient Logger logger = LoggerFactory.getLogger(getClass());\n \n-    private final XStream xStream;\n-\n-    public BenchmarkResultIO() {\n-        xStream = XStreamConfigReader.buildXStream();\n-        xStream.processAnnotations(PlannerBenchmarkResult.class);\n-        xStream.allowTypesByRegExp(new String[] { \"org\\\\.optaplanner\\\\.\\\\w+\\\\.api\\\\..*\" });\n-        xStream.allowTypesByRegExp(new String[] { \"org\\\\.optaplanner\\\\.\\\\w+\\\\.impl\\\\..*\" });", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1ODUxMg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455058512", "bodyText": "JAXB accepts classes you specifically define when creating the JAXBContext. These are eligible to act as root elements. Then, it accepts any type it has to serialize in the object graph under these root element types.\nThis particular example is not about DinnerPartySolutionInitializer, though. The type to be (de)serialized here is Class.", "author": "rsynek", "createdAt": "2020-07-15T13:39:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0MzMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0NTYyNA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454945624", "bodyText": "(code style, very soft): the first letter after \"// \" should be a capital, so \"// Required ...\", even if it's not a sentance\nBasically same principles as javadocs.\n((If it's a sentence (subject + verb + ...), it must end with a \".\", otherwise it shouldn't. This is already correct.))", "author": "ge0ffrey", "createdAt": "2020-07-15T10:16:57Z", "path": "optaplanner-benchmark/src/main/java/org/optaplanner/benchmark/impl/result/SingleBenchmarkResult.java", "diffHunk": "@@ -46,13 +50,21 @@\n @XStreamAlias(\"singleBenchmarkResult\")\n public class SingleBenchmarkResult implements BenchmarkResult {\n \n-    private static final Logger logger = LoggerFactory.getLogger(SingleBenchmarkResult.class);\n+    // required by JAXB to refer to existing instances of this class", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0NzMwNw==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454947307", "bodyText": "(thinking aloud, feel free to ignore)\nThis was there to avoid xstream ID references in the html report that shows the source XML.\nBasically, the source XML must be copyable and not introduce any changes from having been parsed and unparsed, except for inheriting the inheritedSolver of the benchmark xml.\nSo no id's add that weren't there, no null fields becoming defaulted fields etc.\nI presume this is all fine, as IIRC we do have a test that covers it.", "author": "ge0ffrey", "createdAt": "2020-07-15T10:20:19Z", "path": "optaplanner-benchmark/src/main/java/org/optaplanner/benchmark/impl/result/SolverBenchmarkResult.java", "diffHunk": "@@ -257,10 +266,11 @@ public SingleBenchmarkResult findSingleBenchmark(ProblemBenchmarkResult problemB\n     }\n \n     public String getSolverConfigAsHtmlEscapedXml() {\n-        // TODO reuse a single XStream instance for the entire report\n-        XStream xStream = XStreamConfigReader.buildXStream();\n-        xStream.setMode(XStream.NO_REFERENCES);", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1MDU5Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455050596", "bodyText": "Thanks for pointing this out; with JAXB one cannot turn IDs on and off, and there is one place where we have to use the reference, as otherwise, aggregation won't work.\nDo you think it blocks merging or can this be resolved in a separate JIRA?", "author": "rsynek", "createdAt": "2020-07-15T13:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0NzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyODc5NA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455128794", "bodyText": "https://issues.redhat.com/browse/PLANNER-2063", "author": "rsynek", "createdAt": "2020-07-15T15:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0NzMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0ODMxMA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454948310", "bodyText": "(soft) No space after \"//\", also nice to start with captical \"R\".", "author": "ge0ffrey", "createdAt": "2020-07-15T10:22:08Z", "path": "optaplanner-benchmark/src/main/java/org/optaplanner/benchmark/impl/result/SubSingleBenchmarkResult.java", "diffHunk": "@@ -73,6 +93,10 @@\n     // Constructors and simple getters/setters\n     // ************************************************************************\n \n+    private SubSingleBenchmarkResult() {\n+        //required by JAXB", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1MTgxMg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454951812", "bodyText": "Do we want to normalize the newlines?\nThe XML in the benchmark report (so they can easily copy paste it from there into a solverConfig.xml) should contain linux line endings, even on windows.\nDo we want the xmlIO to always use linux line ending, regardless of the platform?", "author": "ge0ffrey", "createdAt": "2020-07-15T10:28:47Z", "path": "optaplanner-benchmark/src/test/java/org/optaplanner/benchmark/config/PlannerBenchmarkConfigTest.java", "diffHunk": "@@ -193,57 +167,21 @@ public void calculateWarmUpTimeMillisSpentLimit() {\n \n     @Test\n     public void xmlConfigFileRemainsSameAfterReadWrite() throws IOException {\n-        String benchmarkConfigResource = \"org/optaplanner/benchmark/config/testdataBenchmarkConfigNoInheritence.xml\";\n-        String originalXml = IOUtils.toString(\n-                getClass().getClassLoader().getResourceAsStream(benchmarkConfigResource), StandardCharsets.UTF_8);\n-        PlannerBenchmarkConfig benchmarkConfig = PlannerBenchmarkConfig.createFromXmlResource(benchmarkConfigResource);\n-        assertThat(PlannerBenchmarkFactory.create(benchmarkConfig).buildPlannerBenchmark(new TestdataSolution())).isNotNull();\n-        XStream xStream = XStreamConfigReader.buildXStreamPortable(getClass().getClassLoader(), PlannerBenchmarkConfig.class);\n-        xStream.setMode(XStream.NO_REFERENCES);\n-        String savedXml = xStream.toXML(benchmarkConfig);\n-        assertThat(savedXml.trim()).isEqualTo(originalXml.trim());\n-    }\n+        JaxbIO<PlannerBenchmarkConfig> xmlIO = new JaxbIO<>(PlannerBenchmarkConfig.class);\n+        PlannerBenchmarkConfig jaxbBenchmarkConfig;\n \n-    @Test\n-    public void jaxbXmlConfigFileRemainsSameAfterReadWrite() throws IOException {\n-        PlannerBenchmarkConfig jaxbBenchmarkConfig = unmarshallBenchmarkConfigFromResource(TEST_PLANNER_BENCHMARK_CONFIG);\n+        try (Reader reader =\n+                new InputStreamReader(PlannerBenchmarkConfigTest.class.getResourceAsStream(TEST_PLANNER_BENCHMARK_CONFIG))) {\n+            jaxbBenchmarkConfig = xmlIO.read(reader);\n+        }\n \n         Writer stringWriter = new StringWriter();\n-        marshall(jaxbBenchmarkConfig, stringWriter);\n+        xmlIO.write(jaxbBenchmarkConfig, stringWriter);\n         String jaxbString = stringWriter.toString();\n \n         String originalXml = IOUtils.toString(\n                 PlannerBenchmarkConfigTest.class.getResourceAsStream(TEST_PLANNER_BENCHMARK_CONFIG), StandardCharsets.UTF_8);\n \n         assertThat(jaxbString.trim()).isEqualToNormalizingNewlines(originalXml.trim());", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1NDI5MA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455054290", "bodyText": "I will look into this for the BenchmarkReport, together with portable file paths, which is already something on my list to fix. Are you fine with me addressing it in a separate PR?", "author": "rsynek", "createdAt": "2020-07-15T13:33:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1MTgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyODYzNA==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455128634", "bodyText": "https://issues.redhat.com/browse/PLANNER-2062", "author": "rsynek", "createdAt": "2020-07-15T15:11:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1MTgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1MjU5OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454952599", "bodyText": "Should this be in optaplanner-persistence-jaxb's package instead? Definitely impl indeed", "author": "ge0ffrey", "createdAt": "2020-07-15T10:30:14Z", "path": "optaplanner-benchmark/src/test/java/org/optaplanner/benchmark/impl/io/jaxb/OffsetDateTimeJaxbAdapterTest.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.benchmark.impl.io.jaxb;", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA0NDIyNg==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455044226", "bodyText": "I am not in favor of moving the adapter to the optaplanner-persistence-jaxb module.\nThe optaplanner-persistence-* modules care about OptaPlanner-specific types, which at the moment are only the Score types.", "author": "rsynek", "createdAt": "2020-07-15T13:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1MjU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1NDEyMw==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454954123", "bodyText": "this makes me worry.\nIn XStream, Jackson, etc, modern versions always support java.time out of the box, entirely.\nAre we using an old version of jaxb? Or is jaxb dead?", "author": "ge0ffrey", "createdAt": "2020-07-15T10:33:04Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/config/solver/termination/TerminationConfig.java", "diffHunk": "@@ -51,13 +53,15 @@\n \n     private TerminationCompositionStyle terminationCompositionStyle = null;\n \n+    @XmlJavaTypeAdapter(JaxbDurationAdapter.class)", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzNzM3Mw==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r455037373", "bodyText": "Already discussed (see above).", "author": "rsynek", "createdAt": "2020-07-15T13:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1NDEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1NjAwMQ==", "url": "https://github.com/kiegroup/optaplanner/pull/834#discussion_r454956001", "bodyText": "The jackson version of this is in package  org.optaplanner.persistence.jackson.api.score.\nSo not in \"buildin\".\nThat should be consistent. Let's move this one, one level up. Or the other one to the buildin package (= BC breaking... so rather not)", "author": "ge0ffrey", "createdAt": "2020-07-15T10:36:38Z", "path": "optaplanner-persistence/optaplanner-persistence-jaxb/src/main/java/org/optaplanner/persistence/jaxb/api/score/buildin/PolymorphicScoreJaxbAdapter.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.persistence.jaxb.api.score.buildin;", "originalCommit": "2c27c17627a67956ebcc5d8cf2ed4dcf59c8410f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f936fc250a35c89e11fc972e49c35eb133dc6b4", "url": "https://github.com/kiegroup/optaplanner/commit/9f936fc250a35c89e11fc972e49c35eb133dc6b4", "message": "Fix JAXB serialization of Duration type", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "11df4b4d7ea3dc09b5709eb2021e0e7aa8ea994b", "url": "https://github.com/kiegroup/optaplanner/commit/11df4b4d7ea3dc09b5709eb2021e0e7aa8ea994b", "message": "Introduce a generic XmlIO for JAXB", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "1cd68851bbb85f03ac39257b410af749fa2e9d20", "url": "https://github.com/kiegroup/optaplanner/commit/1cd68851bbb85f03ac39257b410af749fa2e9d20", "message": "Move JAXB adapters to io.jaxb package", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "e554aeaeebfbd627231ea420c32fbf800f780cb5", "url": "https://github.com/kiegroup/optaplanner/commit/e554aeaeebfbd627231ea420c32fbf800f780cb5", "message": "PLANNER-2024 Switch SolverConfig to JAXB", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "4a10ce3b035f8531bc8dddca2723fd60bddfd625", "url": "https://github.com/kiegroup/optaplanner/commit/4a10ce3b035f8531bc8dddca2723fd60bddfd625", "message": "Add JAXB adapter for score", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "87c203c02b2e19fdc1b864522391c2f10cf3e430", "url": "https://github.com/kiegroup/optaplanner/commit/87c203c02b2e19fdc1b864522391c2f10cf3e430", "message": "Switch BenchmarkConfig to JAXB", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "1c4d9b15c915d7930a31e0de6353df6c0e531bb1", "url": "https://github.com/kiegroup/optaplanner/commit/1c4d9b15c915d7930a31e0de6353df6c0e531bb1", "message": "Convert benchmark results into JAXB", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "93dc52ff143fbc846a03b5b17187e1bdda8705c7", "url": "https://github.com/kiegroup/optaplanner/commit/93dc52ff143fbc846a03b5b17187e1bdda8705c7", "message": "Remove unused method with deprecated call", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "05dae873532835a3195f126f2bb5d2801add97be", "url": "https://github.com/kiegroup/optaplanner/commit/05dae873532835a3195f126f2bb5d2801add97be", "message": "Make XML indentation configurable", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "284d6a7bda66464a16066099beae6dcee39b7bcc", "url": "https://github.com/kiegroup/optaplanner/commit/284d6a7bda66464a16066099beae6dcee39b7bcc", "message": "Remove unused XStreamConfigReader", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "783cb14864142fb5bd4a239ed8f260022b15d02e", "url": "https://github.com/kiegroup/optaplanner/commit/783cb14864142fb5bd4a239ed8f260022b15d02e", "message": "Return back the XML escaping\n\nIt turned out it's used by some of the .ftl benchmark templates", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "9a1e9b9d7bb900c6437544df26602e21c5d6f365", "url": "https://github.com/kiegroup/optaplanner/commit/9a1e9b9d7bb900c6437544df26602e21c5d6f365", "message": "Replace null checks with Objects.requireNotNull", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "01ccec399091aeb6920b702c2ed17cad0d06033b", "url": "https://github.com/kiegroup/optaplanner/commit/01ccec399091aeb6920b702c2ed17cad0d06033b", "message": "Use Objects.equals consistently", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "f9750c1dfc366ec60fcf5280b230b1e99a1e0dbd", "url": "https://github.com/kiegroup/optaplanner/commit/f9750c1dfc366ec60fcf5280b230b1e99a1e0dbd", "message": "Remove unnecessary prefix from a test method", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "131e104a50f9fc93fa5edcf993135d00f335f3df", "url": "https://github.com/kiegroup/optaplanner/commit/131e104a50f9fc93fa5edcf993135d00f335f3df", "message": "Make java.time.* adapters more strict about input", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "81dc793386612c790aeb68dba9ce7752a64e5739", "url": "https://github.com/kiegroup/optaplanner/commit/81dc793386612c790aeb68dba9ce7752a64e5739", "message": "Simplify toString() of InstanceProblemProvider", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "f1724016d31aed0b32d307e12c104d40dc191535", "url": "https://github.com/kiegroup/optaplanner/commit/f1724016d31aed0b32d307e12c104d40dc191535", "message": "Remove the XmlIO interface", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "70709a5e82b52f8d1bcffa7e741a42cca22f312a", "url": "https://github.com/kiegroup/optaplanner/commit/70709a5e82b52f8d1bcffa7e741a42cca22f312a", "message": "Address review comments", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "fe8e24c2597385198c416aed9aec0ab64308dea4", "url": "https://github.com/kiegroup/optaplanner/commit/fe8e24c2597385198c416aed9aec0ab64308dea4", "message": "Fix duplicate classes (enforcer)", "committedDate": "2020-07-15T16:30:54Z", "type": "commit"}, {"oid": "fe8e24c2597385198c416aed9aec0ab64308dea4", "url": "https://github.com/kiegroup/optaplanner/commit/fe8e24c2597385198c416aed9aec0ab64308dea4", "message": "Fix duplicate classes (enforcer)", "committedDate": "2020-07-15T16:30:54Z", "type": "forcePushed"}]}