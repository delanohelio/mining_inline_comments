{"pr_number": 1065, "pr_title": "PLANNER-2265 Add score-drl property", "pr_createdAt": "2020-12-07T15:21:30Z", "pr_url": "https://github.com/kiegroup/optaplanner/pull/1065", "timeline": [{"oid": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "url": "https://github.com/kiegroup/optaplanner/commit/5c36263858a5f3774745b0326ea4f2193e2c69ee", "message": "PLANNER-2265 Add constraints-drl property", "committedDate": "2020-12-07T18:30:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4Mjk0NQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539082945", "bodyText": "It's not a simple getter and it's for a toString, so how about we call it composeScoreDrlAndScoreDrlFileToString?\nIt might not be clear for everyone that DrlResourcesAndFiles applies to scoreDrl and scoreDrlFile.", "author": "ge0ffrey", "createdAt": "2020-12-09T07:56:21Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/director/ScoreDirectorFactoryFactory.java", "diffHunk": "@@ -139,6 +144,29 @@ public ScoreDirectorFactoryFactory(ScoreDirectorFactoryConfig config) {\n         return scoreDirectorFactory;\n     }\n \n+    protected String getDrlResourcesAndFilesOverview() {", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4NjQyNA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539086424", "bodyText": "Update: I think we can remove this entire method if we add ConfigUtils.abbreviate(List<String> list) which calls ConfigUtils.abbreviate(list, 3) (also a new method to implement) for which 3 is the limit size.", "author": "ge0ffrey", "createdAt": "2020-12-09T08:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4Mjk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMDEwNA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539130104", "bodyText": "Sure thing; I like the idea of reposrting the DrlList and DrlFileList separately, which makes this method obsolete.", "author": "rsynek", "createdAt": "2020-12-09T09:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4Mjk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4MzQzOA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539083438", "bodyText": "It might not be clear for everyone that droolsScoreDirectorFactory applies to scoreDrl and scoreDrlFile in their solverConfig.xml, making it much harder to fix the error.", "author": "ge0ffrey", "createdAt": "2020-12-09T07:57:10Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/director/ScoreDirectorFactoryFactory.java", "diffHunk": "@@ -108,16 +109,20 @@ public ScoreDirectorFactoryFactory(ScoreDirectorFactoryConfig config) {\n                 .filter(Objects::nonNull).count() > 1) {\n             List<String> scoreDirectorFactoryPropertyList = new ArrayList<>(4);\n             if (easyScoreDirectorFactory != null) {\n-                scoreDirectorFactoryPropertyList.add(\"an easyScoreCalculatorClass\");\n+                scoreDirectorFactoryPropertyList\n+                        .add(\"an easyScoreCalculatorClass (\" + config.getEasyScoreCalculatorClass().getName() + \")\");\n             }\n             if (constraintStreamScoreDirectorFactory != null) {\n-                scoreDirectorFactoryPropertyList.add(\"a constraintProviderClass\");\n+                scoreDirectorFactoryPropertyList\n+                        .add(\"a constraintProviderClass (\" + config.getConstraintProviderClass().getName() + \")\");\n             }\n             if (incrementalScoreDirectorFactory != null) {\n-                scoreDirectorFactoryPropertyList.add(\"an incrementalScoreCalculatorClass\");\n+                scoreDirectorFactoryPropertyList.add(\n+                        \"an incrementalScoreCalculatorClass (\" + config.getIncrementalScoreCalculatorClass().getName() + \")\");\n             }\n             if (droolsScoreDirectorFactory != null) {\n-                scoreDirectorFactoryPropertyList.add(\"a droolsScoreDirectorFactory\");\n+                scoreDirectorFactoryPropertyList\n+                        .add(\"a droolsScoreDirectorFactory (\" + getDrlResourcesAndFilesOverview() + \")\");", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4NTM0MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539085341", "bodyText": "Can we do something like this?\n                        .add(\"a scoreDrlList (\" + ConfigUtils.abbreviate(solverConfig.getScoreDrlList())\n                        + \") or a scoreDrlFileList (\" + ConfigUtils.abbreviate(solverConfig.getScoreFileDrlList().stream().map(File::getName).toList()) + \"));", "author": "ge0ffrey", "createdAt": "2020-12-09T08:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4MzQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5NDA1NQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539094055", "bodyText": "None of the other properties have a hard coded string like this in the non-test classes. Can we move it to the test class?\nI am a fan of hard coded strings in tests, especially if those strings are part of the public API,\njust like I am of hard coding values in tests:\nassertjEquals(calculator.plus(3, 4), 7)\nis better than\nassertjEquals(calculator.plus(SUM_PART_1, SUM_PART_2), SUM_TOTAL)\nI think.", "author": "ge0ffrey", "createdAt": "2020-12-09T08:13:16Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerBuildTimeConfig.java", "diffHunk": "@@ -31,6 +32,8 @@\n public class OptaPlannerBuildTimeConfig {\n \n     public static final String DEFAULT_SOLVER_CONFIG_URL = \"solverConfig.xml\";\n+    public static final String DEFAULT_CONSTRAINTS_DRL_URL = \"constraints.drl\";\n+    public static final String CONSTRAINTS_DRL_PROPERTY = \"quarkus.optaplanner.constraints-drl\";", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5NjE0MA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539096140", "bodyText": "I see your point, however, the property name is used also in exception messages when we fail fast.", "author": "rsynek", "createdAt": "2020-12-09T08:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5NDA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5NjY2Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539096662", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * This property must NOT be defined in case a {@link ConstraintProvider} implementation exists.\n          \n          \n            \n                 * Do note define this property when a {@link ConstraintProvider}, {@link EasyScoreCalculator} or {@link IncrementalScoreCalculator} class exists.", "author": "ge0ffrey", "createdAt": "2020-12-09T08:17:24Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerBuildTimeConfig.java", "diffHunk": "@@ -40,6 +43,14 @@\n     @ConfigItem\n     Optional<String> solverConfigXml;\n \n+    /**\n+     * A classpath resource to read the solver score DRL.\n+     * Defaults to \"{@link #DEFAULT_CONSTRAINTS_DRL_URL}\".\n+     * This property must NOT be defined in case a {@link ConstraintProvider} implementation exists.", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMTQ0NA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539101444", "bodyText": "(important)\nShould this be constraintsDrl or scoreDRL? (regardless of what we decided before)\nI'd argue there is no point in naming things in application.properties and solverConfig.xml differently if they do the same thing. It just creates unneeded complexity and takes a user's brainpower unnecessarily. Wdyt?", "author": "ge0ffrey", "createdAt": "2020-12-09T08:25:15Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerBuildTimeConfig.java", "diffHunk": "@@ -40,6 +43,14 @@\n     @ConfigItem\n     Optional<String> solverConfigXml;\n \n+    /**\n+     * A classpath resource to read the solver score DRL.\n+     * Defaults to \"{@link #DEFAULT_CONSTRAINTS_DRL_URL}\".\n+     * This property must NOT be defined in case a {@link ConstraintProvider} implementation exists.\n+     */\n+    @ConfigItem\n+    Optional<String> constraintsDrl;", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMjA2Mw==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539102063", "bodyText": "On the other hand, it does indeed default to constraints.drl, something we changed intentionally from scoreRules.drl", "author": "ge0ffrey", "createdAt": "2020-12-09T08:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMjI3Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539102276", "bodyText": "Worth discussing I think on bluejeans. Let me finish the review first.", "author": "ge0ffrey", "createdAt": "2020-12-09T08:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1OTg0Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539159842", "bodyText": "Agreed to change the property name to optaplanner.constraints-drl later(TODO: file Jira).\noptaplanner.score-drl\nThe default stays constraints.drl.", "author": "rsynek", "createdAt": "2020-12-09T09:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4ODEyMw==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539288123", "bodyText": "https://issues.redhat.com/browse/PLANNER-2285", "author": "rsynek", "createdAt": "2020-12-09T13:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMTQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNDY0OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539114649", "bodyText": "I'd argue that this fail fast duplicates a fail-fast in SolverFactory.create(solverConfig).\nAlso, if we ever support SolverConfigCustomizer in Spring Boot, we can do these checks here yet, because the customer might \"fix it\".", "author": "ge0ffrey", "createdAt": "2020-12-09T08:45:42Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerProcessor.java", "diffHunk": "@@ -211,31 +214,77 @@ private void applySolverProperties(RecorderContext recorderContext,\n     }\n \n     private void applyScoreDirectorFactoryProperties(IndexView indexView, SolverConfig solverConfig) {\n+        Optional<String> constraintsDrlFromProperty = constraintsDrl();\n+        Optional<String> defaultConstraintsDrl = defaultConstraintsDrl();\n+        Optional<String> effectiveConstraintsDrl = constraintsDrlFromProperty.map(Optional::of).orElse(defaultConstraintsDrl);\n         if (solverConfig.getScoreDirectorFactoryConfig() == null) {\n-            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = new ScoreDirectorFactoryConfig();\n-            scoreDirectorFactoryConfig.setEasyScoreCalculatorClass(\n-                    findImplementingClass(DotNames.EASY_SCORE_CALCULATOR, indexView));\n-            scoreDirectorFactoryConfig.setConstraintProviderClass(\n-                    findImplementingClass(DotNames.CONSTRAINT_PROVIDER, indexView));\n-            scoreDirectorFactoryConfig.setIncrementalScoreCalculatorClass(\n-                    findImplementingClass(DotNames.INCREMENTAL_SCORE_CALCULATOR, indexView));\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig =\n+                    defaultScoreDirectoryFactoryConfig(indexView, effectiveConstraintsDrl);\n+            solverConfig.setScoreDirectorFactoryConfig(scoreDirectorFactoryConfig);\n+        } else {\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = solverConfig.getScoreDirectorFactoryConfig();\n+            if (constraintsDrlFromProperty.isPresent()) {\n+                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(constraintsDrlFromProperty.get()));\n+            } else {\n+                if (scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n+                    defaultConstraintsDrl.ifPresent((resolvedConstraintsDrl) -> scoreDirectorFactoryConfig\n+                            .setScoreDrlList(Collections.singletonList(resolvedConstraintsDrl)));\n+                }\n+            }\n+        }\n+\n+        if (solverConfig.getScoreDirectorFactoryConfig().getScoreDrlList() != null) {\n             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n-            if (classLoader.getResource(SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL) != null) {\n-                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(\n-                        SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL));\n+            try {\n+                Class.forName(\"org.drools.dynamic.DynamicComponentsSupplier\", false, classLoader);\n+            } catch (ClassNotFoundException e) {\n+                throw new IllegalStateException(\n+                        \"Constraints DRL has been detected, but drools-core-dynamic is not on classpath.\"\n+                                + \" Maybe try adding it. Please note that constraints DRL does not work in the native mode.\");\n             }\n-            if (scoreDirectorFactoryConfig.getEasyScoreCalculatorClass() == null\n-                    && scoreDirectorFactoryConfig.getConstraintProviderClass() == null\n-                    && scoreDirectorFactoryConfig.getIncrementalScoreCalculatorClass() == null\n-                    && scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n-                throw new IllegalStateException(\"No classes found that implement \"\n-                        + EasyScoreCalculator.class.getSimpleName() + \", \"\n-                        + ConstraintProvider.class.getSimpleName() + \" or \"\n-                        + IncrementalScoreCalculator.class.getSimpleName() + \", nor a \"\n-                        + SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL + \" resource.\");\n+        }\n+    }\n+\n+    private Optional<String> constraintsDrl() {\n+        if (optaPlannerBuildTimeConfig.constraintsDrl.isPresent()) {\n+            String constraintsDrl = optaPlannerBuildTimeConfig.constraintsDrl.get();\n+            ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n+            if (classLoader.getResource(constraintsDrl) == null) {\n+                throw new IllegalStateException(\"Invalid \" + OptaPlannerBuildTimeConfig.CONSTRAINTS_DRL_PROPERTY\n+                        + \" property (\" + constraintsDrl + \"): that classpath resource does not exist.\");\n             }\n-            solverConfig.setScoreDirectorFactoryConfig(scoreDirectorFactoryConfig);\n         }\n+        return optaPlannerBuildTimeConfig.constraintsDrl;\n+    }\n+\n+    private Optional<String> defaultConstraintsDrl() {\n+        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n+        return classLoader.getResource(OptaPlannerBuildTimeConfig.DEFAULT_CONSTRAINTS_DRL_URL) != null\n+                ? Optional.of(OptaPlannerBuildTimeConfig.DEFAULT_CONSTRAINTS_DRL_URL)\n+                : Optional.empty();\n+    }\n+\n+    private ScoreDirectorFactoryConfig defaultScoreDirectoryFactoryConfig(IndexView indexView, Optional<String> constrainsDrl) {\n+        ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = new ScoreDirectorFactoryConfig();\n+        scoreDirectorFactoryConfig.setEasyScoreCalculatorClass(\n+                findImplementingClass(DotNames.EASY_SCORE_CALCULATOR, indexView));\n+        scoreDirectorFactoryConfig.setConstraintProviderClass(\n+                findImplementingClass(DotNames.CONSTRAINT_PROVIDER, indexView));\n+        scoreDirectorFactoryConfig.setIncrementalScoreCalculatorClass(\n+                findImplementingClass(DotNames.INCREMENTAL_SCORE_CALCULATOR, indexView));\n+        constrainsDrl.ifPresent(value -> scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(value)));\n+        if (scoreDirectorFactoryConfig.getEasyScoreCalculatorClass() == null\n+                && scoreDirectorFactoryConfig.getConstraintProviderClass() == null\n+                && scoreDirectorFactoryConfig.getIncrementalScoreCalculatorClass() == null\n+                && scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n+            throw new IllegalStateException(\"No classes found that implement \"\n+                    + EasyScoreCalculator.class.getSimpleName() + \", \"\n+                    + ConstraintProvider.class.getSimpleName() + \" or \"\n+                    + IncrementalScoreCalculator.class.getSimpleName() + \".\\n\"\n+                    + \"Neither was a property \" + OptaPlannerBuildTimeConfig.CONSTRAINTS_DRL_PROPERTY + \" defined, nor a \"\n+                    + OptaPlannerBuildTimeConfig.DEFAULT_CONSTRAINTS_DRL_URL + \" resource found.\\n\");", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNTcyOA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539115728", "bodyText": "So far my philosophy has been that the Spring Boot starter and Quarkus extension should not duplicate fail fasts that\n\nare detected as fail-fasts in SolverConfig later itself, once the SolverFActory is created\nhave a good error message.\n\nNow, the 2) is debatable here, indeed.", "author": "ge0ffrey", "createdAt": "2020-12-09T08:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNDY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNjA3Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539116077", "bodyText": "=> bluejeans topic?", "author": "ge0ffrey", "createdAt": "2020-12-09T08:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNDY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyNDQ3Nw==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539124477", "bodyText": "The error a user gets if we remove this check is:\n\"The scoreDirectorFactory lacks a configuration for an easyScoreCalculatorClass, a constraintProviderClass, an incrementalScoreCalculatorClass or a droolsScoreDirectorFactory.\"\nEspecially the \"lacks a configuration\" suggests to me that there is no detection in place and everything needs to be configured via the SolverConfig.\n+1 for discussing this.", "author": "rsynek", "createdAt": "2020-12-09T08:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNDY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2MDkxNg==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539160916", "bodyText": "Agreed to leave as it is.", "author": "rsynek", "createdAt": "2020-12-09T09:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNDY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyODM1OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539128359", "bodyText": "Ow, it was here already...", "author": "ge0ffrey", "createdAt": "2020-12-09T09:05:36Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerProcessor.java", "diffHunk": "@@ -211,31 +214,77 @@ private void applySolverProperties(RecorderContext recorderContext,\n     }\n \n     private void applyScoreDirectorFactoryProperties(IndexView indexView, SolverConfig solverConfig) {\n+        Optional<String> constraintsDrlFromProperty = constraintsDrl();\n+        Optional<String> defaultConstraintsDrl = defaultConstraintsDrl();\n+        Optional<String> effectiveConstraintsDrl = constraintsDrlFromProperty.map(Optional::of).orElse(defaultConstraintsDrl);\n         if (solverConfig.getScoreDirectorFactoryConfig() == null) {\n-            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = new ScoreDirectorFactoryConfig();\n-            scoreDirectorFactoryConfig.setEasyScoreCalculatorClass(\n-                    findImplementingClass(DotNames.EASY_SCORE_CALCULATOR, indexView));\n-            scoreDirectorFactoryConfig.setConstraintProviderClass(\n-                    findImplementingClass(DotNames.CONSTRAINT_PROVIDER, indexView));\n-            scoreDirectorFactoryConfig.setIncrementalScoreCalculatorClass(\n-                    findImplementingClass(DotNames.INCREMENTAL_SCORE_CALCULATOR, indexView));\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig =\n+                    defaultScoreDirectoryFactoryConfig(indexView, effectiveConstraintsDrl);\n+            solverConfig.setScoreDirectorFactoryConfig(scoreDirectorFactoryConfig);\n+        } else {\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = solverConfig.getScoreDirectorFactoryConfig();\n+            if (constraintsDrlFromProperty.isPresent()) {\n+                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(constraintsDrlFromProperty.get()));\n+            } else {\n+                if (scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n+                    defaultConstraintsDrl.ifPresent((resolvedConstraintsDrl) -> scoreDirectorFactoryConfig\n+                            .setScoreDrlList(Collections.singletonList(resolvedConstraintsDrl)));\n+                }\n+            }\n+        }\n+\n+        if (solverConfig.getScoreDirectorFactoryConfig().getScoreDrlList() != null) {\n             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n-            if (classLoader.getResource(SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL) != null) {\n-                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(\n-                        SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL));\n+            try {\n+                Class.forName(\"org.drools.dynamic.DynamicComponentsSupplier\", false, classLoader);\n+            } catch (ClassNotFoundException e) {\n+                throw new IllegalStateException(\n+                        \"Constraints DRL has been detected, but drools-core-dynamic is not on classpath.\"\n+                                + \" Maybe try adding it. Please note that constraints DRL does not work in the native mode.\");\n             }\n-            if (scoreDirectorFactoryConfig.getEasyScoreCalculatorClass() == null\n-                    && scoreDirectorFactoryConfig.getConstraintProviderClass() == null\n-                    && scoreDirectorFactoryConfig.getIncrementalScoreCalculatorClass() == null\n-                    && scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n-                throw new IllegalStateException(\"No classes found that implement \"\n-                        + EasyScoreCalculator.class.getSimpleName() + \", \"\n-                        + ConstraintProvider.class.getSimpleName() + \" or \"\n-                        + IncrementalScoreCalculator.class.getSimpleName() + \", nor a \"\n-                        + SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL + \" resource.\");", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMDY5OA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539130698", "bodyText": ":) oh yes, but nevermind, it's a good topic to go through.", "author": "rsynek", "createdAt": "2020-12-09T09:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyODM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMTEyNg==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539131126", "bodyText": "We put a newline between the \"error fact\" and the \"error maybe suggestion\":\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"Constraints DRL has been detected, but drools-core-dynamic is not on classpath.\"\n          \n          \n            \n                                    \"Using scoreDRL in Quarkus, but the dependency drools-core-dynamic is not on the classpath.\\n\"", "author": "ge0ffrey", "createdAt": "2020-12-09T09:09:22Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerProcessor.java", "diffHunk": "@@ -211,31 +214,77 @@ private void applySolverProperties(RecorderContext recorderContext,\n     }\n \n     private void applyScoreDirectorFactoryProperties(IndexView indexView, SolverConfig solverConfig) {\n+        Optional<String> constraintsDrlFromProperty = constraintsDrl();\n+        Optional<String> defaultConstraintsDrl = defaultConstraintsDrl();\n+        Optional<String> effectiveConstraintsDrl = constraintsDrlFromProperty.map(Optional::of).orElse(defaultConstraintsDrl);\n         if (solverConfig.getScoreDirectorFactoryConfig() == null) {\n-            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = new ScoreDirectorFactoryConfig();\n-            scoreDirectorFactoryConfig.setEasyScoreCalculatorClass(\n-                    findImplementingClass(DotNames.EASY_SCORE_CALCULATOR, indexView));\n-            scoreDirectorFactoryConfig.setConstraintProviderClass(\n-                    findImplementingClass(DotNames.CONSTRAINT_PROVIDER, indexView));\n-            scoreDirectorFactoryConfig.setIncrementalScoreCalculatorClass(\n-                    findImplementingClass(DotNames.INCREMENTAL_SCORE_CALCULATOR, indexView));\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig =\n+                    defaultScoreDirectoryFactoryConfig(indexView, effectiveConstraintsDrl);\n+            solverConfig.setScoreDirectorFactoryConfig(scoreDirectorFactoryConfig);\n+        } else {\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = solverConfig.getScoreDirectorFactoryConfig();\n+            if (constraintsDrlFromProperty.isPresent()) {\n+                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(constraintsDrlFromProperty.get()));\n+            } else {\n+                if (scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n+                    defaultConstraintsDrl.ifPresent((resolvedConstraintsDrl) -> scoreDirectorFactoryConfig\n+                            .setScoreDrlList(Collections.singletonList(resolvedConstraintsDrl)));\n+                }\n+            }\n+        }\n+\n+        if (solverConfig.getScoreDirectorFactoryConfig().getScoreDrlList() != null) {\n             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n-            if (classLoader.getResource(SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL) != null) {\n-                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(\n-                        SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL));\n+            try {\n+                Class.forName(\"org.drools.dynamic.DynamicComponentsSupplier\", false, classLoader);\n+            } catch (ClassNotFoundException e) {\n+                throw new IllegalStateException(\n+                        \"Constraints DRL has been detected, but drools-core-dynamic is not on classpath.\"", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMzQwOA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539133408", "bodyText": "I tend to avoid \"it\" references in the \"error maybe fix\" to the previous line, so users can \"just fix it and move on\" faster. Especially if the \"error fact\" is very long and complex to parse (hard to see in a console window, especially if it doesn't wrap and because the error message only starts at column 70 or so)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            + \" Maybe try adding it. Please note that constraints DRL does not work in the native mode.\");\n          \n          \n            \n                                            + \"\\nMaybe add the dependency org.kie.kogito:drools-core-dynamic and exclude the dependency org.kie.kogito:drools-core-static.\");", "author": "ge0ffrey", "createdAt": "2020-12-09T09:12:28Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerProcessor.java", "diffHunk": "@@ -211,31 +214,77 @@ private void applySolverProperties(RecorderContext recorderContext,\n     }\n \n     private void applyScoreDirectorFactoryProperties(IndexView indexView, SolverConfig solverConfig) {\n+        Optional<String> constraintsDrlFromProperty = constraintsDrl();\n+        Optional<String> defaultConstraintsDrl = defaultConstraintsDrl();\n+        Optional<String> effectiveConstraintsDrl = constraintsDrlFromProperty.map(Optional::of).orElse(defaultConstraintsDrl);\n         if (solverConfig.getScoreDirectorFactoryConfig() == null) {\n-            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = new ScoreDirectorFactoryConfig();\n-            scoreDirectorFactoryConfig.setEasyScoreCalculatorClass(\n-                    findImplementingClass(DotNames.EASY_SCORE_CALCULATOR, indexView));\n-            scoreDirectorFactoryConfig.setConstraintProviderClass(\n-                    findImplementingClass(DotNames.CONSTRAINT_PROVIDER, indexView));\n-            scoreDirectorFactoryConfig.setIncrementalScoreCalculatorClass(\n-                    findImplementingClass(DotNames.INCREMENTAL_SCORE_CALCULATOR, indexView));\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig =\n+                    defaultScoreDirectoryFactoryConfig(indexView, effectiveConstraintsDrl);\n+            solverConfig.setScoreDirectorFactoryConfig(scoreDirectorFactoryConfig);\n+        } else {\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = solverConfig.getScoreDirectorFactoryConfig();\n+            if (constraintsDrlFromProperty.isPresent()) {\n+                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(constraintsDrlFromProperty.get()));\n+            } else {\n+                if (scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n+                    defaultConstraintsDrl.ifPresent((resolvedConstraintsDrl) -> scoreDirectorFactoryConfig\n+                            .setScoreDrlList(Collections.singletonList(resolvedConstraintsDrl)));\n+                }\n+            }\n+        }\n+\n+        if (solverConfig.getScoreDirectorFactoryConfig().getScoreDrlList() != null) {\n             ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n-            if (classLoader.getResource(SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL) != null) {\n-                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(\n-                        SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL));\n+            try {\n+                Class.forName(\"org.drools.dynamic.DynamicComponentsSupplier\", false, classLoader);\n+            } catch (ClassNotFoundException e) {\n+                throw new IllegalStateException(\n+                        \"Constraints DRL has been detected, but drools-core-dynamic is not on classpath.\"\n+                                + \" Maybe try adding it. Please note that constraints DRL does not work in the native mode.\");", "originalCommit": "5c36263858a5f3774745b0326ea4f2193e2c69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzNDc2Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539134766", "bodyText": "For the part about not working in native mode: that doesn't belong here, but in the Quarkus integration chapter docs, especially on the constraints-drl property.\nAlso, if the do try to run it in native mode with a scoreDRL, the error message should be proper - but that's a different check than this one - can we somehow detect that?", "author": "ge0ffrey", "createdAt": "2020-12-09T09:14:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMzQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzNTAzNg==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539135036", "bodyText": "Also, what's the error message if I add dynamic to the classpath but forget to exclude static?", "author": "ge0ffrey", "createdAt": "2020-12-09T09:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMzQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2NTQ3MA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r539165470", "bodyText": "Agreed: let's provide fail fast checks for both.\n\"Maybe\" suggestion for native: either use ConstraintProvider or don't use native.", "author": "rsynek", "createdAt": "2020-12-09T09:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMzQwOA=="}], "type": "inlineReview"}, {"oid": "1c966135a585d3e32c0e93994396752673729961", "url": "https://github.com/kiegroup/optaplanner/commit/1c966135a585d3e32c0e93994396752673729961", "message": "PLANNER-2265 Add score-drl property", "committedDate": "2020-12-10T12:54:03Z", "type": "forcePushed"}, {"oid": "06e5dec11a36b66a139595790438aca42cb67ee3", "url": "https://github.com/kiegroup/optaplanner/commit/06e5dec11a36b66a139595790438aca42cb67ee3", "message": "PLANNER-2265 Add score-drl property", "committedDate": "2020-12-10T13:01:30Z", "type": "forcePushed"}, {"oid": "2a7efd601a823fec1b02b71af708b5f9bca6d403", "url": "https://github.com/kiegroup/optaplanner/commit/2a7efd601a823fec1b02b71af708b5f9bca6d403", "message": "PLANNER-2265 Add score-drl property", "committedDate": "2020-12-11T08:03:42Z", "type": "commit"}, {"oid": "00216e957a68dc065eaf07646e311105b78b6707", "url": "https://github.com/kiegroup/optaplanner/commit/00216e957a68dc065eaf07646e311105b78b6707", "message": "Improve test coverage", "committedDate": "2020-12-11T08:20:00Z", "type": "commit"}, {"oid": "00216e957a68dc065eaf07646e311105b78b6707", "url": "https://github.com/kiegroup/optaplanner/commit/00216e957a68dc065eaf07646e311105b78b6707", "message": "Improve test coverage", "committedDate": "2020-12-11T08:20:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMzOTI5MA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r543339290", "bodyText": "Nitpick:\nI personally think the method should not accept null lists. Just add a javadoc that has \"@param list never null\"\nBut if should accept null too, we treat is as an exceptionally situation (so handle it with an if statement before doing the real code)\n\nif (list == null) {\n   return \"\";\n}\nString abbreviation = ...", "author": "ge0ffrey", "createdAt": "2020-12-15T13:27:06Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/config/util/ConfigUtils.java", "diffHunk": "@@ -414,6 +414,21 @@ public static int resolvePoolSize(String propertyName, String value, String... m\n         return memberAccessor;\n     }\n \n+    public static String abbreviate(List<String> list, int limit) {\n+        String abbreviation = \"\";\n+        if (list != null) {", "originalCommit": "00216e957a68dc065eaf07646e311105b78b6707", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0MDAzNQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r543340035", "bodyText": "ah, I see below it's easier for it to also accept null.", "author": "ge0ffrey", "createdAt": "2020-12-15T13:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMzOTI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0NTMxNQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r543345315", "bodyText": "Nitpick: Personally, I'd inline these booleans in the if statements, as they are only used once.", "author": "ge0ffrey", "createdAt": "2020-12-15T13:35:33Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerProcessor.java", "diffHunk": "@@ -210,32 +213,95 @@ private void applySolverProperties(RecorderContext recorderContext,\n                 .collect(Collectors.toList());\n     }\n \n-    private void applyScoreDirectorFactoryProperties(IndexView indexView, SolverConfig solverConfig) {\n+    protected void applyScoreDirectorFactoryProperties(IndexView indexView, SolverConfig solverConfig) {\n+        Optional<String> constraintsDrlFromProperty = constraintsDrl();\n+        Optional<String> defaultConstraintsDrl = defaultConstraintsDrl();\n+        Optional<String> effectiveConstraintsDrl = constraintsDrlFromProperty.map(Optional::of).orElse(defaultConstraintsDrl);\n         if (solverConfig.getScoreDirectorFactoryConfig() == null) {\n-            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = new ScoreDirectorFactoryConfig();\n-            scoreDirectorFactoryConfig.setEasyScoreCalculatorClass(\n-                    findImplementingClass(DotNames.EASY_SCORE_CALCULATOR, indexView));\n-            scoreDirectorFactoryConfig.setConstraintProviderClass(\n-                    findImplementingClass(DotNames.CONSTRAINT_PROVIDER, indexView));\n-            scoreDirectorFactoryConfig.setIncrementalScoreCalculatorClass(\n-                    findImplementingClass(DotNames.INCREMENTAL_SCORE_CALCULATOR, indexView));\n-            ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n-            if (classLoader.getResource(SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL) != null) {\n-                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(\n-                        SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL));\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig =\n+                    defaultScoreDirectoryFactoryConfig(indexView, effectiveConstraintsDrl);\n+            solverConfig.setScoreDirectorFactoryConfig(scoreDirectorFactoryConfig);\n+        } else {\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = solverConfig.getScoreDirectorFactoryConfig();\n+            if (constraintsDrlFromProperty.isPresent()) {\n+                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(constraintsDrlFromProperty.get()));\n+            } else {\n+                if (scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n+                    defaultConstraintsDrl.ifPresent(resolvedConstraintsDrl -> scoreDirectorFactoryConfig\n+                            .setScoreDrlList(Collections.singletonList(resolvedConstraintsDrl)));\n+                }\n             }\n-            if (scoreDirectorFactoryConfig.getEasyScoreCalculatorClass() == null\n-                    && scoreDirectorFactoryConfig.getConstraintProviderClass() == null\n-                    && scoreDirectorFactoryConfig.getIncrementalScoreCalculatorClass() == null\n-                    && scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n-                throw new IllegalStateException(\"No classes found that implement \"\n-                        + EasyScoreCalculator.class.getSimpleName() + \", \"\n-                        + ConstraintProvider.class.getSimpleName() + \" or \"\n-                        + IncrementalScoreCalculator.class.getSimpleName() + \", nor a \"\n-                        + SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL + \" resource.\");\n+        }\n+\n+        if (solverConfig.getScoreDirectorFactoryConfig().getScoreDrlList() != null) {\n+            boolean isDroolsDynamicPresent = isClassDefined(\"org.drools.dynamic.DynamicServiceRegistrySupplier\");\n+            boolean isDroolsStaticPresent = isClassDefined(\"org.drools.statics.StaticServiceRegistrySupplier\");", "originalCommit": "00216e957a68dc065eaf07646e311105b78b6707", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1MDc3MA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r543350770", "bodyText": "Myself, I don't see the DRY principle as the only motivation for creating methods or, in this case, local variables. The variable name clearly states what's the purpose of the check. In contrast to that, isClassDefined(\"org.drools.dynamic.DynamicServiceRegistrySupplier\") is not so clear about it's purpose as I just deliberately picked the class DynamicServiceRegistrySupplier as something pointing to the presence of the drools-core-dynamic. The local variables serve here rather in the role of comments.", "author": "rsynek", "createdAt": "2020-12-15T13:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0NTMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0OTY1NA==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r543349654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            + \" org.kie.kogito:drools-core-static. Use a ConstraintProvider for a native compilation.\");\n          \n          \n            \n                                            + \" org.kie.kogito:drools-core-static.\"\n          \n          \n            \n                                            + \"\\nOr instead, maybe use a \" + ConstraintProvider.class.getSimpleName() + \" instead of scoreDRL.\");", "author": "ge0ffrey", "createdAt": "2020-12-15T13:41:34Z", "path": "optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerProcessor.java", "diffHunk": "@@ -210,32 +213,95 @@ private void applySolverProperties(RecorderContext recorderContext,\n                 .collect(Collectors.toList());\n     }\n \n-    private void applyScoreDirectorFactoryProperties(IndexView indexView, SolverConfig solverConfig) {\n+    protected void applyScoreDirectorFactoryProperties(IndexView indexView, SolverConfig solverConfig) {\n+        Optional<String> constraintsDrlFromProperty = constraintsDrl();\n+        Optional<String> defaultConstraintsDrl = defaultConstraintsDrl();\n+        Optional<String> effectiveConstraintsDrl = constraintsDrlFromProperty.map(Optional::of).orElse(defaultConstraintsDrl);\n         if (solverConfig.getScoreDirectorFactoryConfig() == null) {\n-            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = new ScoreDirectorFactoryConfig();\n-            scoreDirectorFactoryConfig.setEasyScoreCalculatorClass(\n-                    findImplementingClass(DotNames.EASY_SCORE_CALCULATOR, indexView));\n-            scoreDirectorFactoryConfig.setConstraintProviderClass(\n-                    findImplementingClass(DotNames.CONSTRAINT_PROVIDER, indexView));\n-            scoreDirectorFactoryConfig.setIncrementalScoreCalculatorClass(\n-                    findImplementingClass(DotNames.INCREMENTAL_SCORE_CALCULATOR, indexView));\n-            ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n-            if (classLoader.getResource(SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL) != null) {\n-                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(\n-                        SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL));\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig =\n+                    defaultScoreDirectoryFactoryConfig(indexView, effectiveConstraintsDrl);\n+            solverConfig.setScoreDirectorFactoryConfig(scoreDirectorFactoryConfig);\n+        } else {\n+            ScoreDirectorFactoryConfig scoreDirectorFactoryConfig = solverConfig.getScoreDirectorFactoryConfig();\n+            if (constraintsDrlFromProperty.isPresent()) {\n+                scoreDirectorFactoryConfig.setScoreDrlList(Collections.singletonList(constraintsDrlFromProperty.get()));\n+            } else {\n+                if (scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n+                    defaultConstraintsDrl.ifPresent(resolvedConstraintsDrl -> scoreDirectorFactoryConfig\n+                            .setScoreDrlList(Collections.singletonList(resolvedConstraintsDrl)));\n+                }\n             }\n-            if (scoreDirectorFactoryConfig.getEasyScoreCalculatorClass() == null\n-                    && scoreDirectorFactoryConfig.getConstraintProviderClass() == null\n-                    && scoreDirectorFactoryConfig.getIncrementalScoreCalculatorClass() == null\n-                    && scoreDirectorFactoryConfig.getScoreDrlList() == null) {\n-                throw new IllegalStateException(\"No classes found that implement \"\n-                        + EasyScoreCalculator.class.getSimpleName() + \", \"\n-                        + ConstraintProvider.class.getSimpleName() + \" or \"\n-                        + IncrementalScoreCalculator.class.getSimpleName() + \", nor a \"\n-                        + SolverBuildTimeConfig.DEFAULT_SCORE_DRL_URL + \" resource.\");\n+        }\n+\n+        if (solverConfig.getScoreDirectorFactoryConfig().getScoreDrlList() != null) {\n+            boolean isDroolsDynamicPresent = isClassDefined(\"org.drools.dynamic.DynamicServiceRegistrySupplier\");\n+            boolean isDroolsStaticPresent = isClassDefined(\"org.drools.statics.StaticServiceRegistrySupplier\");\n+\n+            if (!isDroolsDynamicPresent) {\n+                throw new IllegalStateException(\n+                        \"Using scoreDRL in Quarkus, but the dependency drools-core-dynamic is not on the classpath.\\n\"\n+                                + \"Maybe add the dependency org.kie.kogito:drools-core-dynamic and exclude the dependency\"\n+                                + \" org.kie.kogito:drools-core-static. Use a ConstraintProvider for a native compilation.\");", "originalCommit": "00216e957a68dc065eaf07646e311105b78b6707", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1MDMxMw==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r543350313", "bodyText": "I don't think native compilation should be mentioned here - this is not a check related to native compilation.\nThe benefits of using ConstraintProvider over scoreDRL should be in the docs instead.", "author": "ge0ffrey", "createdAt": "2020-12-15T13:42:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0OTY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1OTUzOQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1065#discussion_r543359539", "bodyText": "(non blocking)\nPersonally, I am not a fan of using Optional outside of Streams - a nullable var works just as well - see Stuart's and Goetz's talks around this topic.", "author": "ge0ffrey", "createdAt": "2020-12-15T13:54:52Z", "path": "optaplanner-spring-integration/optaplanner-spring-boot-autoconfigure/src/main/java/org/optaplanner/spring/boot/autoconfigure/OptaPlannerAutoConfiguration.java", "diffHunk": "@@ -200,33 +201,69 @@ private void applySolverProperties(SolverConfig solverConfig) {\n         return new ArrayList<>(entityClassSet);\n     }\n \n-    private void applyScoreDirectorFactoryProperties(SolverConfig solverConfig) {\n+    protected void applyScoreDirectorFactoryProperties(SolverConfig solverConfig) {\n+        Optional<String> constraintsDrlFromProperty = constraintsDrl();\n+        Optional<String> defaultConstraintsDrl = defaultConstraintsDrl();\n+        Optional<String> effectiveConstraintsDrl = constraintsDrlFromProperty.map(Optional::of).orElse(defaultConstraintsDrl);", "originalCommit": "00216e957a68dc065eaf07646e311105b78b6707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e936d265662bdab52e5426749b0c3bfcf8eb7995", "url": "https://github.com/kiegroup/optaplanner/commit/e936d265662bdab52e5426749b0c3bfcf8eb7995", "message": "Update optaplanner-quarkus-integration/optaplanner-quarkus/deployment/src/main/java/org/optaplanner/quarkus/deployment/OptaPlannerProcessor.java\n\nCo-authored-by: Geoffrey De Smet <gds.geoffrey.de.smet@gmail.com>", "committedDate": "2020-12-15T17:08:35Z", "type": "commit"}, {"oid": "64b8e75f76b818ccb7d2542fe2199fa9c0eb8ddc", "url": "https://github.com/kiegroup/optaplanner/commit/64b8e75f76b818ccb7d2542fe2199fa9c0eb8ddc", "message": "Address review comments", "committedDate": "2020-12-15T19:32:48Z", "type": "commit"}, {"oid": "64b8e75f76b818ccb7d2542fe2199fa9c0eb8ddc", "url": "https://github.com/kiegroup/optaplanner/commit/64b8e75f76b818ccb7d2542fe2199fa9c0eb8ddc", "message": "Address review comments", "committedDate": "2020-12-15T19:32:48Z", "type": "forcePushed"}]}