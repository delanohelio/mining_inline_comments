{"pr_number": 652, "pr_title": "PLANNER-1764 groupBy on TriStreams", "pr_createdAt": "2020-01-08T10:00:58Z", "pr_url": "https://github.com/kiegroup/optaplanner/pull/652", "timeline": [{"oid": "ebfe7033064fad1801f41698f440fdb916c48ce3", "url": "https://github.com/kiegroup/optaplanner/commit/ebfe7033064fad1801f41698f440fdb916c48ce3", "message": "Introduce all the target API methods", "committedDate": "2020-01-08T09:27:58Z", "type": "commit"}, {"oid": "29faffb9499d50711e2e8ca86435d686f4103078", "url": "https://github.com/kiegroup/optaplanner/commit/29faffb9499d50711e2e8ca86435d686f4103078", "message": "Implement tri collectors", "committedDate": "2020-01-08T09:57:52Z", "type": "commit"}, {"oid": "09847df58afb022712d672605b95b50539038f5d", "url": "https://github.com/kiegroup/optaplanner/commit/09847df58afb022712d672605b95b50539038f5d", "message": "Implement the final uni groupBy operation", "committedDate": "2020-01-08T11:29:37Z", "type": "commit"}, {"oid": "cd7e88cba441244ebc210fd8b8439e652230267a", "url": "https://github.com/kiegroup/optaplanner/commit/cd7e88cba441244ebc210fd8b8439e652230267a", "message": "Implement the final bi groupBy operation", "committedDate": "2020-01-08T11:53:28Z", "type": "commit"}, {"oid": "f55b6bb9fe2cfccc75d0b2f60fe30a0b57caf07a", "url": "https://github.com/kiegroup/optaplanner/commit/f55b6bb9fe2cfccc75d0b2f60fe30a0b57caf07a", "message": "Add the same method for tri stream", "committedDate": "2020-01-08T12:31:50Z", "type": "commit"}, {"oid": "45de6e2b06bc80340b2d6bd1e9c7e20ef6b25204", "url": "https://github.com/kiegroup/optaplanner/commit/45de6e2b06bc80340b2d6bd1e9c7e20ef6b25204", "message": "Unify accumulator code", "committedDate": "2020-01-08T14:35:25Z", "type": "commit"}, {"oid": "f020a6c74256e4a1d14091a09b67818bcaaa8c81", "url": "https://github.com/kiegroup/optaplanner/commit/f020a6c74256e4a1d14091a09b67818bcaaa8c81", "message": "Unify grouping code", "committedDate": "2020-01-08T14:52:52Z", "type": "commit"}, {"oid": "0261226446c2b88bfdea259a0a2088337ef7338b", "url": "https://github.com/kiegroup/optaplanner/commit/0261226446c2b88bfdea259a0a2088337ef7338b", "message": "Finally unify invoker code", "committedDate": "2020-01-08T15:44:42Z", "type": "commit"}, {"oid": "3a9993e94a5245f122b8b3479ba721670345ebc3", "url": "https://github.com/kiegroup/optaplanner/commit/3a9993e94a5245f122b8b3479ba721670345ebc3", "message": "First tri groupBy(), requires a code change to Drools", "committedDate": "2020-01-08T21:06:25Z", "type": "commit"}, {"oid": "acd7925dbdae3436933b74343b7a9fd5d026758e", "url": "https://github.com/kiegroup/optaplanner/commit/acd7925dbdae3436933b74343b7a9fd5d026758e", "message": "Improve grouping performance", "committedDate": "2020-01-10T17:12:40Z", "type": "commit"}, {"oid": "c1e754d9966e5dda6d2abc80cf54cdc191182b9b", "url": "https://github.com/kiegroup/optaplanner/commit/c1e754d9966e5dda6d2abc80cf54cdc191182b9b", "message": "Yet another groupBy", "committedDate": "2020-01-11T12:47:30Z", "type": "commit"}, {"oid": "d52a89c4bf4c0af9342e165a4db13e07625efbba", "url": "https://github.com/kiegroup/optaplanner/commit/d52a89c4bf4c0af9342e165a4db13e07625efbba", "message": "Add the penultimate tri groupBy()", "committedDate": "2020-01-11T12:58:06Z", "type": "commit"}, {"oid": "80773a016e6e960df63034981d43a112a262c33d", "url": "https://github.com/kiegroup/optaplanner/commit/80773a016e6e960df63034981d43a112a262c33d", "message": "Add the final tri groupBy()", "committedDate": "2020-01-11T13:07:54Z", "type": "commit"}, {"oid": "e393fb7673447a87b600e4ffe6af29c871940bc6", "url": "https://github.com/kiegroup/optaplanner/commit/e393fb7673447a87b600e4ffe6af29c871940bc6", "message": "Reuse some code", "committedDate": "2020-01-11T13:21:42Z", "type": "commit"}, {"oid": "4140a106578c3c9f409b6ba49877e83027cddb01", "url": "https://github.com/kiegroup/optaplanner/commit/4140a106578c3c9f409b6ba49877e83027cddb01", "message": "Unify collect exec model", "committedDate": "2020-01-11T14:05:50Z", "type": "commit"}, {"oid": "8b4fbcc15106db4172cf50981bb7d0390eb2f9d3", "url": "https://github.com/kiegroup/optaplanner/commit/8b4fbcc15106db4172cf50981bb7d0390eb2f9d3", "message": "Unify group exec model", "committedDate": "2020-01-11T14:17:29Z", "type": "commit"}, {"oid": "e8940b09c31ace224a404cb56323f719af011719", "url": "https://github.com/kiegroup/optaplanner/commit/e8940b09c31ace224a404cb56323f719af011719", "message": "Refactor uni groupAndCollect", "committedDate": "2020-01-11T15:18:11Z", "type": "commit"}, {"oid": "ec845ca5fcb0abe0fd8c47b030e6bf4bd26997fa", "url": "https://github.com/kiegroup/optaplanner/commit/ec845ca5fcb0abe0fd8c47b030e6bf4bd26997fa", "message": "Unify groupWithCollect code", "committedDate": "2020-01-11T15:28:24Z", "type": "commit"}, {"oid": "6df9deca4a537872bc7abf0e4b64160e78634330", "url": "https://github.com/kiegroup/optaplanner/commit/6df9deca4a537872bc7abf0e4b64160e78634330", "message": "Unify groupBi", "committedDate": "2020-01-11T15:42:30Z", "type": "commit"}, {"oid": "39fb2eec0cdd6373afca3e5045de1d4af8518978", "url": "https://github.com/kiegroup/optaplanner/commit/39fb2eec0cdd6373afca3e5045de1d4af8518978", "message": "All groupBy code unified", "committedDate": "2020-01-11T15:47:15Z", "type": "commit"}, {"oid": "4a20db3f618572b9ed4705ccda1aa7bd77438934", "url": "https://github.com/kiegroup/optaplanner/commit/4a20db3f618572b9ed4705ccda1aa7bd77438934", "message": "Unification moves on", "committedDate": "2020-01-11T16:14:25Z", "type": "commit"}, {"oid": "d2e4b429b2ccce132af6134c6c733f4eed346684", "url": "https://github.com/kiegroup/optaplanner/commit/d2e4b429b2ccce132af6134c6c733f4eed346684", "message": "Finish the refactor", "committedDate": "2020-01-11T17:02:28Z", "type": "commit"}, {"oid": "c3638cfac22d39482ced89e5d0ef250d3bfcadd2", "url": "https://github.com/kiegroup/optaplanner/commit/c3638cfac22d39482ced89e5d0ef250d3bfcadd2", "message": "A bit more type safety", "committedDate": "2020-01-12T12:05:40Z", "type": "commit"}, {"oid": "5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "url": "https://github.com/kiegroup/optaplanner/commit/5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "message": "Remove unused code", "committedDate": "2020-01-12T12:41:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0MDY3OA==", "url": "https://github.com/kiegroup/optaplanner/pull/652#discussion_r365740678", "bodyText": "suggestion: \"fall in\" -> \"belong to\"?\n\"fall in\" sounds like a non-english expression translated word by word (happens a lot from Dutch too).", "author": "ge0ffrey", "createdAt": "2020-01-13T10:49:18Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/api/score/stream/bi/BiConstraintStream.java", "diffHunk": "@@ -251,14 +251,23 @@\n     <GroupKeyA_, GroupKeyB_> BiConstraintStream<GroupKeyA_, GroupKeyB_> groupBy(\n             BiFunction<A, B, GroupKeyA_> groupKeyAMapping, BiFunction<A, B, GroupKeyB_> groupKeyBMapping);\n \n-    /*\n-    // TODO implement this\n-    <GroupKeyA_, GroupKeyB_, ResultContainer_, Result_>\n-    TriConstraintStream<GroupKeyA_, GroupKeyB_, Result_> groupBy(\n-            BiFunction<A, B, GroupKeyA_> groupKeyAMapping,\n-            BiFunction<A, B, GroupKeyB_> groupKeyBMapping,\n-            BiConstraintCollector<A, B, ResultContainer_, Result_> collector);\n+    /**\n+     * Combines the semantics of {@link #groupBy(BiFunction, BiFunction)} and {@link #groupBy(BiConstraintCollector)}.\n+     * That is, the first and second facts in the tuple follow the {@link #groupBy(BiFunction, BiFunction)} semantics,\n+     * and the third fact is the result of applying {@link BiConstraintCollector#finisher()} on all the tuples of the\n+     * original {@link UniConstraintStream} that fall in the group.", "originalCommit": "5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0Mjk3NQ==", "url": "https://github.com/kiegroup/optaplanner/pull/652#discussion_r365742975", "bodyText": "missing \"the\" before \"first fact\"\nThese 2 lines are incorrect:\n\"... to convert the first fact in the original tuple ...\" and \"... the second fact ...\"\nEach groupMaping converts the entire tuple, not a fact of it. They both get A and B as input.\n=> \"groupKeyAMapping never null, function to convert the original tuple into a first fact\"\n\"groupKeyBMapping never null, function to convert the original tuple into a second fact\"", "author": "ge0ffrey", "createdAt": "2020-01-13T10:54:32Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/api/score/stream/bi/BiConstraintStream.java", "diffHunk": "@@ -251,14 +251,23 @@\n     <GroupKeyA_, GroupKeyB_> BiConstraintStream<GroupKeyA_, GroupKeyB_> groupBy(\n             BiFunction<A, B, GroupKeyA_> groupKeyAMapping, BiFunction<A, B, GroupKeyB_> groupKeyBMapping);\n \n-    /*\n-    // TODO implement this\n-    <GroupKeyA_, GroupKeyB_, ResultContainer_, Result_>\n-    TriConstraintStream<GroupKeyA_, GroupKeyB_, Result_> groupBy(\n-            BiFunction<A, B, GroupKeyA_> groupKeyAMapping,\n-            BiFunction<A, B, GroupKeyB_> groupKeyBMapping,\n-            BiConstraintCollector<A, B, ResultContainer_, Result_> collector);\n+    /**\n+     * Combines the semantics of {@link #groupBy(BiFunction, BiFunction)} and {@link #groupBy(BiConstraintCollector)}.\n+     * That is, the first and second facts in the tuple follow the {@link #groupBy(BiFunction, BiFunction)} semantics,\n+     * and the third fact is the result of applying {@link BiConstraintCollector#finisher()} on all the tuples of the\n+     * original {@link UniConstraintStream} that fall in the group.\n+     * @param groupKeyAMapping never null, function to convert first fact in the original tuple to a different fact\n+     * @param groupKeyBMapping never null, function to convert second fact in the original tuple to a different fact", "originalCommit": "5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0MzQyMA==", "url": "https://github.com/kiegroup/optaplanner/pull/652#discussion_r365743420", "bodyText": "Where's C?", "author": "ge0ffrey", "createdAt": "2020-01-13T10:55:27Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/api/score/stream/tri/TriConstraintCollector.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.optaplanner.core.api.score.stream.tri;\n+\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collector;\n+\n+import org.optaplanner.core.api.function.QuadFunction;\n+import org.optaplanner.core.api.function.TriFunction;\n+import org.optaplanner.core.api.score.stream.ConstraintCollectors;\n+import org.optaplanner.core.api.score.stream.ConstraintStream;\n+\n+/**\n+ * Usually created with {@link ConstraintCollectors}.\n+ * Used by {@link TriConstraintStream#groupBy(TriFunction, TriConstraintCollector)}, ...\n+ * <p>\n+ * Loosely based on JDK's {@link Collector}, but it returns an undo operation for each accumulation\n+ * to enable incremental score calculation in {@link ConstraintStream constraint streams}.\n+ * @param <A> the type of the first fact of the tuple in the source {@link TriConstraintStream}\n+ * @param <B> the type of the second fact of the tuple in the source {@link TriConstraintStream}", "originalCommit": "5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NDQ1OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/652#discussion_r365744459", "bodyText": "the other javadocs start with \"convert tri into uni\".\nFor maintenance, I recommend we keep the javadocs in the same same structure, same order (as much copy pasted as possible even maybe), so \"convert into what\" before \"how\" (like in other javadocs, this javadocs does it in reverse order).", "author": "ge0ffrey", "createdAt": "2020-01-13T10:57:50Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/api/score/stream/tri/TriConstraintStream.java", "diffHunk": "@@ -196,6 +198,80 @@\n         return join(otherClass, AbstractQuadJoiner.merge(joiners));\n     }\n \n+    // ************************************************************************\n+    // Group by\n+    // ************************************************************************\n+\n+    /**\n+     * Runs all tuples of the stream through a given @{@link TriConstraintCollector} and converts them into a new", "originalCommit": "5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NTMzMA==", "url": "https://github.com/kiegroup/optaplanner/pull/652#discussion_r365745330", "bodyText": "avoid future tense \"will\".\nNice to have: in a javadoc, if a line ends, start a new line for the next one (so \\n before between \"stream.\" and \"Neither\". The javadocs html puts them together anyway, but this gives us \"ventilated proze\" in the source file, which is easier to author and maintain.", "author": "ge0ffrey", "createdAt": "2020-01-13T10:59:57Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/api/score/stream/tri/TriConstraintStream.java", "diffHunk": "@@ -196,6 +198,80 @@\n         return join(otherClass, AbstractQuadJoiner.merge(joiners));\n     }\n \n+    // ************************************************************************\n+    // Group by\n+    // ************************************************************************\n+\n+    /**\n+     * Runs all tuples of the stream through a given @{@link TriConstraintCollector} and converts them into a new\n+     * {@link UniConstraintStream} which only has a single tuple, the result of applying {@link TriConstraintCollector}.\n+     * @param collector never null, the collector to perform the grouping operation with\n+     * @param <ResultContainer_> the mutable accumulation type (often hidden as an implementation detail)\n+     * @param <Result_> the type of a fact in the destination {@link UniConstraintStream}'s tuple\n+     * @return never null\n+     */\n+    <ResultContainer_, Result_> UniConstraintStream<Result_> groupBy(\n+            TriConstraintCollector<A, B, C, ResultContainer_, Result_> collector);\n+\n+    /**\n+     * Convert the {@link TriConstraintStream} to a {@link UniConstraintStream}, containing the set of tuples resulting\n+     * from applying the group key mapping function on all tuples of the original stream. Neither tuple of the new\n+     * stream will {@link Objects#equals(Object, Object)} any other.", "originalCommit": "5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NTg5Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/652#discussion_r365745896", "bodyText": "\"incoming tuple\" first line, \"incoming tuples\" second line. Either both singular or both plural (across all javadocs)", "author": "ge0ffrey", "createdAt": "2020-01-13T11:01:17Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/api/score/stream/tri/TriConstraintStream.java", "diffHunk": "@@ -196,6 +198,80 @@\n         return join(otherClass, AbstractQuadJoiner.merge(joiners));\n     }\n \n+    // ************************************************************************\n+    // Group by\n+    // ************************************************************************\n+\n+    /**\n+     * Runs all tuples of the stream through a given @{@link TriConstraintCollector} and converts them into a new\n+     * {@link UniConstraintStream} which only has a single tuple, the result of applying {@link TriConstraintCollector}.\n+     * @param collector never null, the collector to perform the grouping operation with\n+     * @param <ResultContainer_> the mutable accumulation type (often hidden as an implementation detail)\n+     * @param <Result_> the type of a fact in the destination {@link UniConstraintStream}'s tuple\n+     * @return never null\n+     */\n+    <ResultContainer_, Result_> UniConstraintStream<Result_> groupBy(\n+            TriConstraintCollector<A, B, C, ResultContainer_, Result_> collector);\n+\n+    /**\n+     * Convert the {@link TriConstraintStream} to a {@link UniConstraintStream}, containing the set of tuples resulting\n+     * from applying the group key mapping function on all tuples of the original stream. Neither tuple of the new\n+     * stream will {@link Objects#equals(Object, Object)} any other.\n+     * @param groupKeyMapping never null, mapping function to convert each element in the stream to a different element\n+     * @param <GroupKey_> the type of a fact in the destination {@link UniConstraintStream}'s tuple\n+     * @return never null\n+     */\n+    <GroupKey_> UniConstraintStream<GroupKey_> groupBy(TriFunction<A, B, C, GroupKey_> groupKeyMapping);\n+\n+    /**\n+     * Convert the {@link TriConstraintStream} to a {@link BiConstraintStream}, consisting of unique tuples.\n+     * <p>\n+     * The first fact is the return value of the first group key mapping function, applied on the incoming tuple.\n+     * The second fact is the return value of a given {@link TriConstraintCollector} applied on incoming tuples with the", "originalCommit": "5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NjcxMg==", "url": "https://github.com/kiegroup/optaplanner/pull/652#discussion_r365746712", "bodyText": "Why not use variable names \"a\" and \"b\" instead of \"_1\" and \"_2\"?", "author": "ge0ffrey", "createdAt": "2020-01-13T11:03:25Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/drools/common/BiTuple.java", "diffHunk": "@@ -18,15 +18,15 @@\n \n import java.util.Objects;\n \n-public final class BiTuple<K,V> {\n-    public final K key;\n-    public final V value;\n+public final class BiTuple<A, B> {\n+    public final A _1;\n+    public final B _2;\n     private final int hashCode;\n \n-    public BiTuple(K key, V value) {\n-        this.key = key;\n-        this.value = value;\n-        this.hashCode = Objects.hash(key, value);\n+    public BiTuple(A _1, B _2) {", "originalCommit": "5d1c157d40fc6b4a76ff78fd3be06a5482267d69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc2ODM5OA==", "url": "https://github.com/kiegroup/optaplanner/pull/652#discussion_r365768398", "bodyText": "It's all the same to me. I can change it.", "author": "triceo", "createdAt": "2020-01-13T12:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NjcxMg=="}], "type": "inlineReview"}, {"oid": "a61ff763d57c098665a43e49782c9bd972304599", "url": "https://github.com/kiegroup/optaplanner/commit/a61ff763d57c098665a43e49782c9bd972304599", "message": "Rename tuple variables", "committedDate": "2020-01-13T12:30:10Z", "type": "commit"}]}