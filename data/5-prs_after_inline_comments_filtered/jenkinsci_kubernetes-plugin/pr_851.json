{"pr_number": 851, "pr_title": "Specify jnlp container limits through system properties", "pr_createdAt": "2020-09-30T13:44:51Z", "pr_url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851", "timeline": [{"oid": "019eb96ad1fa2eb2d38d5a7936c6e104d62e3d52", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/019eb96ad1fa2eb2d38d5a7936c6e104d62e3d52", "message": "fix: set limits for defaults", "committedDate": "2020-09-30T13:33:02Z", "type": "commit"}, {"oid": "c74e2f0c7585581aa58876d805938379e6aeee0c", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/c74e2f0c7585581aa58876d805938379e6aeee0c", "message": "Merge branch 'master' into jnlp-limits", "committedDate": "2020-10-07T14:30:41Z", "type": "commit"}, {"oid": "ff007a722bee7f3beea535aba2ed60b1c44f97e1", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/ff007a722bee7f3beea535aba2ed60b1c44f97e1", "message": "fix(DefualtLimit):", "committedDate": "2020-10-07T21:11:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMTA0MQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r501521041", "bodyText": "Should use different system property name.", "author": "Vlatombe", "createdAt": "2020-10-08T07:59:01Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -103,6 +103,11 @@\n     static final String DEFAULT_JNLP_CONTAINER_CPU_REQUEST = System\n             .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuRequest\", \"100m\");\n \n+    static final String DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT = System\n+            .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryRequest\", null);", "originalCommit": "ff007a722bee7f3beea535aba2ed60b1c44f97e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMTI4Mg==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r501521282", "bodyText": "This is wrong. It is overriding the default request since you're starting from an empty ContainerBuilder.", "author": "Vlatombe", "createdAt": "2020-10-08T07:59:26Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -261,6 +266,14 @@ public Pod build() {\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n             jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST)).endResources().build().getResources());\n+\n+            if (DEFAULT_JNLP_CONTAINER_CPU_LIMIT!=null) {\n+                jnlp.setResources(new ContainerBuilder().editOrNewResources().addToLimits(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_LIMIT)).endResources().build().getResources());", "originalCommit": "ff007a722bee7f3beea535aba2ed60b1c44f97e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0OTI3Nw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r530149277", "bodyText": "fix", "author": "KrapivinAndrey", "createdAt": "2020-11-25T07:10:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMTI4Mg=="}], "type": "inlineReview"}, {"oid": "da377eff58105a0d3210ac28e76404ac7275b3b8", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/da377eff58105a0d3210ac28e76404ac7275b3b8", "message": "fix", "committedDate": "2020-11-15T16:48:48Z", "type": "commit"}, {"oid": "0aa4d994aab69d6ab0179c3d78220f087c2ee2f1", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/0aa4d994aab69d6ab0179c3d78220f087c2ee2f1", "message": "fix", "committedDate": "2020-11-15T17:24:45Z", "type": "commit"}, {"oid": "e936579c4dede0666e1bdc2ef89202f38ecd9be6", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/e936579c4dede0666e1bdc2ef89202f38ecd9be6", "message": "fix", "committedDate": "2020-11-15T17:34:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc5MzQyNg==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r523793426", "bodyText": "Probably don't need to have a call to editOrNewResources for each request/limit.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        containerBuilder = new ContainerBuilder();\n          \n          \n            \n                        ResourcesNested<ContainerBuilder> containerResources = new ContainerBuilder().editOrNewResources();", "author": "cwholmes", "createdAt": "2020-11-15T18:18:24Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -260,7 +265,20 @@ public Pod build() {\n         envVars.putAll(jnlp.getEnv().stream().collect(Collectors.toMap(EnvVar::getName, Function.identity())));\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n-            jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST)).endResources().build().getResources());\n+\n+            containerBuilder = new ContainerBuilder();", "originalCommit": "e936579c4dede0666e1bdc2ef89202f38ecd9be6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzNTgxMA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r523935810", "bodyText": "fix", "author": "KrapivinAndrey", "createdAt": "2020-11-16T07:17:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc5MzQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc5MzUzOQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r523793539", "bodyText": "The endResourcesMethod is on the ResourcesNested class and not the ContainerBuilerClass. The suggestion above will probably help with what this line is trying to do.", "author": "cwholmes", "createdAt": "2020-11-15T18:19:25Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -260,7 +265,20 @@ public Pod build() {\n         envVars.putAll(jnlp.getEnv().stream().collect(Collectors.toMap(EnvVar::getName, Function.identity())));\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n-            jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST)).endResources().build().getResources());\n+\n+            containerBuilder = new ContainerBuilder();\n+            containerBuilder.editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST));\n+\n+            if (DEFAULT_JNLP_CONTAINER_CPU_LIMIT!=null) {\n+                containerBuilder.editOrNewResources().addToLimits(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_LIMIT));\n+            }\n+\n+            if (DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT!=null) {\n+                containerBuilder.editOrNewResources().addToLimits(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT))\n+            }\n+\n+            jnlp.setResources(containerBuilder.endResources().build().getResources());", "originalCommit": "e936579c4dede0666e1bdc2ef89202f38ecd9be6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzNTg0OQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r523935849", "bodyText": "fix", "author": "KrapivinAndrey", "createdAt": "2020-11-16T07:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc5MzUzOQ=="}], "type": "inlineReview"}, {"oid": "d69d70017186c4d3f5a0a451574383842d6de8f4", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/d69d70017186c4d3f5a0a451574383842d6de8f4", "message": "fix", "committedDate": "2020-11-15T18:23:18Z", "type": "commit"}, {"oid": "fe9c1d243bcba3872f22248c292a7e9e4931c304", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/fe9c1d243bcba3872f22248c292a7e9e4931c304", "message": "use containerResources instead \u0441ontainerBuilder", "committedDate": "2020-11-16T05:11:23Z", "type": "commit"}, {"oid": "4133f4850256c562f63cf9bf62d60f71624a8f4e", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4133f4850256c562f63cf9bf62d60f71624a8f4e", "message": "Revert \"use containerResources instead \u0441ontainerBuilder\"\n\nThis reverts commit fe9c1d243bcba3872f22248c292a7e9e4931c304.", "committedDate": "2020-11-16T05:35:18Z", "type": "commit"}, {"oid": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/7b2ff34a507f8b8c963cd841bddeadc4b1f215c9", "message": "fix", "committedDate": "2020-11-16T05:49:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3NTU1NA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r530275554", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryLimit\", null);\n          \n          \n            \n                        .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryLimit\");", "author": "Vlatombe", "createdAt": "2020-11-25T10:44:03Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -103,6 +104,11 @@\n     static final String DEFAULT_JNLP_CONTAINER_CPU_REQUEST = System\n             .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuRequest\", \"100m\");\n \n+    static final String DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT = System\n+            .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryLimit\", null);", "originalCommit": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3NTY0Ng==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r530275646", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuLimit\", null);\n          \n          \n            \n                        .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuLimit\");", "author": "Vlatombe", "createdAt": "2020-11-25T10:44:12Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -103,6 +104,11 @@\n     static final String DEFAULT_JNLP_CONTAINER_CPU_REQUEST = System\n             .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuRequest\", \"100m\");\n \n+    static final String DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT = System\n+            .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultMemoryLimit\", null);\n+    static final String DEFAULT_JNLP_CONTAINER_CPU_LIMIT = System\n+            .getProperty(PodTemplateStepExecution.class.getName() + \".defaultContainer.defaultCpuLimit\", null);", "originalCommit": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3NzcyNQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/851#discussion_r530277725", "bodyText": "Can be simplified by using new ResourceRequirementsBuilder()", "author": "Vlatombe", "createdAt": "2020-11-25T10:47:29Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -260,7 +266,20 @@ public Pod build() {\n         envVars.putAll(jnlp.getEnv().stream().collect(Collectors.toMap(EnvVar::getName, Function.identity())));\n         jnlp.setEnv(new ArrayList<>(envVars.values()));\n         if (jnlp.getResources() == null) {\n-            jnlp.setResources(new ContainerBuilder().editOrNewResources().addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST)).endResources().build().getResources());\n+\n+            ResourcesNested<ContainerBuilder> containerBuilder = new ContainerBuilder().withNewResources();\n+            containerBuilder.addToRequests(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_REQUEST)).addToRequests(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_REQUEST));\n+\n+            if (DEFAULT_JNLP_CONTAINER_CPU_LIMIT!=null) {\n+                containerBuilder.addToLimits(\"cpu\", new Quantity(DEFAULT_JNLP_CONTAINER_CPU_LIMIT));\n+            }\n+\n+            if (DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT!=null) {\n+                containerBuilder.addToLimits(\"memory\", new Quantity(DEFAULT_JNLP_CONTAINER_MEMORY_LIMIT));\n+            }\n+\n+            jnlp.setResources(containerBuilder.endResources().build().getResources());", "originalCommit": "7b2ff34a507f8b8c963cd841bddeadc4b1f215c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f0057219f5ba14fb1caa2719132d8f722dce470c", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/f0057219f5ba14fb1caa2719132d8f722dce470c", "message": "fix after review", "committedDate": "2020-12-02T17:22:31Z", "type": "commit"}, {"oid": "f13e89151f09bce4042913fe0ca989089e3d97ef", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/f13e89151f09bce4042913fe0ca989089e3d97ef", "message": "check", "committedDate": "2020-12-02T18:15:45Z", "type": "commit"}, {"oid": "9cbdc280be83b7275a585abd1b26a0e59b7a04d8", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/9cbdc280be83b7275a585abd1b26a0e59b7a04d8", "message": "fix", "committedDate": "2020-12-02T18:35:44Z", "type": "commit"}]}