{"pr_number": 835, "pr_title": "Rework concurrency limits using the number provided in Cloud API", "pr_createdAt": "2020-09-02T14:13:03Z", "pr_url": "https://github.com/jenkinsci/kubernetes-plugin/pull/835", "timeline": [{"oid": "9e0e9abe6ee05ce36d20af2bb925071a47a33738", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/9e0e9abe6ee05ce36d20af2bb925071a47a33738", "message": "Rework concurrency limits using the number provided in Cloud API", "committedDate": "2020-09-02T14:05:51Z", "type": "commit"}, {"oid": "dcb8786a442b7f81a9f4d52aa63a998aff2f1219", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/dcb8786a442b7f81a9f4d52aa63a998aff2f1219", "message": "Bump core", "committedDate": "2020-09-03T15:42:49Z", "type": "commit"}, {"oid": "0fa552749b1df967c98ac5ab8760542ccdedca10", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/0fa552749b1df967c98ac5ab8760542ccdedca10", "message": "Merge branch 'master' into concurrency-limits-core-patch", "committedDate": "2020-09-16T11:59:23Z", "type": "commit"}, {"oid": "8bc1558fe81120140b257295243677d27b73d84d", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/8bc1558fe81120140b257295243677d27b73d84d", "message": "Merge branch 'master' into concurrency-limits-core-patch", "committedDate": "2020-09-23T12:25:02Z", "type": "commit"}, {"oid": "646f3c7801e927beb91e56a39d84b58460420b37", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/646f3c7801e927beb91e56a39d84b58460420b37", "message": "Add some tests and clarify method names", "committedDate": "2020-09-23T12:52:22Z", "type": "commit"}, {"oid": "b32e968f493469cd9e20dcf79e087cdc1ff522e8", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b32e968f493469cd9e20dcf79e087cdc1ff522e8", "message": "Bump to next LTS baseline", "committedDate": "2020-10-23T12:58:14Z", "type": "commit"}, {"oid": "a32ced8462799b22a75a71f51b21b7c11d54b772", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/a32ced8462799b22a75a71f51b21b7c11d54b772", "message": "Noting https://github.com/jenkinsci/bom/pull/339", "committedDate": "2020-10-23T13:04:05Z", "type": "commit"}, {"oid": "2e1b236a458ea2365ba7e413a6762cbad217dba1", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/2e1b236a458ea2365ba7e413a6762cbad217dba1", "message": "Merge branch 'master' into concurrency-limits-core-patch", "committedDate": "2020-11-03T09:13:36Z", "type": "commit"}, {"oid": "b6550b53dce3e837d6a1d90d5847660613c1f787", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b6550b53dce3e837d6a1d90d5847660613c1f787", "message": "Update to LTS", "committedDate": "2020-11-03T09:15:08Z", "type": "commit"}, {"oid": "51ad650bff0ca8f70416e12a30f3459121b5dbac", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/51ad650bff0ca8f70416e12a30f3459121b5dbac", "message": "Merge remote-tracking branch 'Vlatombe/concurrency-limits-core-patch' into concurrency-limits-core-patch", "committedDate": "2020-11-03T09:16:49Z", "type": "commit"}, {"oid": "944284a1b5d80168bafcef2ba90c2061811bbb43", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/944284a1b5d80168bafcef2ba90c2061811bbb43", "message": "Use getter instead of direct field access", "committedDate": "2020-11-03T09:50:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc4Mzg1NA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/835#discussion_r516783854", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                LOGGER.log(Level.FINE, \"Global slots left for \\\"{0}\\\": {1}\", new Object[]{name, remainingGlobalSlots});\n          \n          \n            \n                                LOGGER.fine(() -> \"Global slots left for \" + name + \": \" + remainingGlobalSlots);\n          \n      \n    \n    \n  \n\nif you like", "author": "jglick", "createdAt": "2020-11-03T16:09:59Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java", "diffHunk": "@@ -527,31 +527,49 @@ public KubernetesClient connect() throws KubernetesAuthException, IOException {\n     }\n \n     @Override\n-    public synchronized Collection<NodeProvisioner.PlannedNode> provision(@CheckForNull final Label label, final int excessWorkload) {\n+    public synchronized Collection<NodeProvisioner.PlannedNode> provision(@NonNull final Cloud.CloudState state, final int excessWorkload) {\n         try {\n-            Set<String> allInProvisioning = InProvisioning.getAllInProvisioning(label);\n+            Label label = state.getLabel();\n+            int plannedCapacity = state.getAdditionalPlannedCapacity(); // Planned nodes, will be launched on the next round of NodeProvisioner\n+            Set<String> allInProvisioning = InProvisioning.getAllInProvisioning(label); // Nodes being launched\n             LOGGER.log(Level.FINE, () -> \"In provisioning : \" + allInProvisioning);\n             int toBeProvisioned = Math.max(0, excessWorkload - allInProvisioning.size());\n-            LOGGER.log(Level.INFO, \"Excess workload after pending Kubernetes agents: {0}\", toBeProvisioned);\n-\n-            List<NodeProvisioner.PlannedNode> r = new ArrayList<NodeProvisioner.PlannedNode>();\n-\n-            for (PodTemplate t: getTemplatesFor(label)) {\n-                LOGGER.log(Level.INFO, \"Template for label {0}: {1}\", new Object[] { label, t.getName() });\n-                for (int i = 0; i < toBeProvisioned; i++) {\n-                    if (!mayAddProvisionedSlave(t, label, i)) {\n-                        break;\n+            Set<Node> nodes = getNodes(label);\n+            int currentExecutorsCount = (int) nodes.stream().filter(KubernetesSlave.class::isInstance).map(Node::getNumExecutors).count();\n+            int launchingExecutorsCount = (int) nodes.stream().filter(KubernetesSlave.class::isInstance).filter(n -> n.toComputer() != null && ((KubernetesComputer)n.toComputer()).isLaunching()).map(Node::getNumExecutors).count();\n+            LOGGER.log(Level.INFO, \"Label \\\"{0}\\\" excess workload: {1},\" +\n+                    \" executors: {2},\" +\n+                    \" plannedCapacity: {3},\" +\n+                            \" launching: {4}\",\n+                    new Object[] {label, toBeProvisioned, currentExecutorsCount, plannedCapacity, launchingExecutorsCount});\n+            List<NodeProvisioner.PlannedNode> plannedNodes = new ArrayList<>();\n+            List<Pod> pods = getPodsWithLabels(namespace, getPodLabelsMap());\n+            if (pods != null) {\n+                // Count planned and executors not yet launching (e.g. everything that is not in kubernetes yet)\n+                int plannedCount = plannedCapacity + currentExecutorsCount - launchingExecutorsCount;\n+                int remainingGlobalSlots = getRemainingGlobalSlots(pods, plannedCount);\n+                if (remainingGlobalSlots > 0) {\n+                    LOGGER.log(Level.FINE, \"Global slots left for \\\"{0}\\\": {1}\", new Object[]{name, remainingGlobalSlots});", "originalCommit": "944284a1b5d80168bafcef2ba90c2061811bbb43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8ba6a2e97c5f3d7cffcdbf90fefc1c0de361fbb", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/f8ba6a2e97c5f3d7cffcdbf90fefc1c0de361fbb", "message": "Update src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java\n\nCo-authored-by: Jesse Glick <jglick@cloudbees.com>", "committedDate": "2020-11-04T13:41:37Z", "type": "commit"}]}