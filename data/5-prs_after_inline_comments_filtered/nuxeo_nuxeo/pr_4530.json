{"pr_number": 4530, "pr_title": "NXP-29798: Implement a Capabilities Service", "pr_createdAt": "2020-12-09T11:06:56Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4530", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxODAzNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539218036", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (var entry : entity.get().entrySet()) {\n          \n          \n            \n                        jg.writeObjectField(entry.getKey(), entry.getValue());\n          \n          \n            \n                    }\n          \n          \n            \n                    entity.get().entrySet().forEach(e -> jg.writeObjectField(e.getKey(), e.getValue());", "author": "efge", "createdAt": "2020-12-09T11:12:50Z", "path": "modules/platform/rest-api/nuxeo-rest-api-io/src/main/java/org/nuxeo/ecm/restapi/jaxrs/io/capabilities/CapabilitiesJsonWriter.java", "diffHunk": "@@ -19,37 +19,33 @@\n \n package org.nuxeo.ecm.restapi.jaxrs.io.capabilities;\n \n-import static org.nuxeo.common.function.ThrowableConsumer.asConsumer;\n import static org.nuxeo.ecm.core.io.registry.reflect.Instantiations.SINGLETON;\n import static org.nuxeo.ecm.core.io.registry.reflect.Priorities.REFERENCE;\n \n import java.io.IOException;\n \n import org.nuxeo.ecm.core.io.marshallers.json.ExtensibleEntityJsonWriter;\n import org.nuxeo.ecm.core.io.registry.reflect.Setup;\n+import org.nuxeo.runtime.capabilities.Capabilities;\n \n import com.fasterxml.jackson.core.JsonGenerator;\n \n /**\n  * @since 11.5\n  */\n @Setup(mode = SINGLETON, priority = REFERENCE)\n-public class ServerInfoJsonWriter extends ExtensibleEntityJsonWriter<ServerInfo> {\n+public class CapabilitiesJsonWriter extends ExtensibleEntityJsonWriter<Capabilities> {\n \n-    public static final String ENTITY_TYPE = \"server\";\n+    public static final String ENTITY_TYPE = \"capabilities\";\n \n-    public ServerInfoJsonWriter() {\n-        super(ENTITY_TYPE, ServerInfo.class);\n+    public CapabilitiesJsonWriter() {\n+        super(ENTITY_TYPE, Capabilities.class);\n     }\n \n     @Override\n-    protected void writeEntityBody(ServerInfo entity, JsonGenerator jg) throws IOException {\n-        jg.writeStringField(\"distributionName\", entity.getDistributionName());\n-        jg.writeStringField(\"distributionVersion\", entity.getDistributionVersion());\n-        jg.writeStringField(\"distributionServer\", entity.getDistributionServer());\n-        entity.getHotfixVersion().ifPresent(asConsumer(h -> jg.writeStringField(\"hotfixVersion\", h)));\n-        jg.writeBooleanField(\"clusterEnabled\", entity.isClusterEnabled());\n-        jg.writeStringField(\"clusterNodeId\", entity.getClusterNodeId());\n-\n+    protected void writeEntityBody(Capabilities entity, JsonGenerator jg) throws IOException {\n+        for (var entry : entity.get().entrySet()) {\n+            jg.writeObjectField(entry.getKey(), entry.getValue());\n+        }", "originalCommit": "13869fa58d07a68b7022126aadb6f85be7836157", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwNzE3Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539307176", "bodyText": "I added the ThrowableBiConsumer functional interface as writeObjectField throws an IOException in order to do the forEach directly on the Map.", "author": "kevinleturc", "createdAt": "2020-12-09T13:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxODAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxODg3MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539218870", "bodyText": "Add a bit of Javadoc", "author": "efge", "createdAt": "2020-12-09T11:14:10Z", "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/capabilities/Capabilities.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.runtime.capabilities;\n+\n+import java.util.Map;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class Capabilities {", "originalCommit": "13869fa58d07a68b7022126aadb6f85be7836157", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxOTMxMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539219311", "bodyText": "\"a capabilities\" is not grammatical", "author": "efge", "createdAt": "2020-12-09T11:14:43Z", "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/capabilities/CapabilitiesService.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.runtime.capabilities;\n+\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Service holding the server capabilities.\n+ *\n+ * @since 11.5\n+ */\n+public interface CapabilitiesService {\n+\n+    /**\n+     * Registers a capabilities.", "originalCommit": "13869fa58d07a68b7022126aadb6f85be7836157", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyMTMyOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539221328", "bodyText": "This probably needs a getApplicationStartedOrder() with a very low value to be sure that all other services requiring it are started afterwards.", "author": "efge", "createdAt": "2020-12-09T11:17:48Z", "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/capabilities/CapabilitiesServiceImpl.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.runtime.capabilities;\n+\n+import static java.util.stream.Collectors.collectingAndThen;\n+import static java.util.stream.Collectors.toMap;\n+import static org.apache.commons.lang3.StringUtils.isNotBlank;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_HOTFIX;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_NAME;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_SERVER;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_VERSION;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.model.ComponentContext;\n+import org.nuxeo.runtime.model.ComponentManager;\n+import org.nuxeo.runtime.model.DefaultComponent;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class CapabilitiesServiceImpl extends DefaultComponent implements CapabilitiesService {", "originalCommit": "13869fa58d07a68b7022126aadb6f85be7836157", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5ODUwOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539298509", "bodyText": "This is not strictly required in this case as the start method execution is not required to make the mechanism working.\nBut it is still a good practice and doesn't cost much, I will add it.", "author": "kevinleturc", "createdAt": "2020-12-09T13:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyMTMyOA=="}], "type": "inlineReview"}, {"oid": "c194676a4230f66ded688a0f121bb7c01bac7c38", "url": "https://github.com/nuxeo/nuxeo/commit/c194676a4230f66ded688a0f121bb7c01bac7c38", "message": "NXP-29798: Implement a Capabilities Service", "committedDate": "2020-12-09T13:31:16Z", "type": "forcePushed"}, {"oid": "5297e82ddaba7c329146b0d6395d1bb58128bba6", "url": "https://github.com/nuxeo/nuxeo/commit/5297e82ddaba7c329146b0d6395d1bb58128bba6", "message": "NXP-29798: Implement a Capabilities Service", "committedDate": "2020-12-09T13:46:40Z", "type": "forcePushed"}, {"oid": "82448c9a43dcd90ed1b1b3ab7f894e0e043492af", "url": "https://github.com/nuxeo/nuxeo/commit/82448c9a43dcd90ed1b1b3ab7f894e0e043492af", "message": "NXP-29798: Implement a Capabilities Service", "committedDate": "2020-12-09T13:57:21Z", "type": "forcePushed"}, {"oid": "96360a0d6f0197f8b41d193cede6a3e242e23ff4", "url": "https://github.com/nuxeo/nuxeo/commit/96360a0d6f0197f8b41d193cede6a3e242e23ff4", "message": "NXP-29798: Implement a Capabilities Service", "committedDate": "2020-12-11T09:04:55Z", "type": "forcePushed"}, {"oid": "1c172814b95725da89181eb88a216a8df248a4da", "url": "https://github.com/nuxeo/nuxeo/commit/1c172814b95725da89181eb88a216a8df248a4da", "message": "NXP-29798: Implement a Capabilities Service", "committedDate": "2020-12-14T16:18:02Z", "type": "commit"}, {"oid": "1c172814b95725da89181eb88a216a8df248a4da", "url": "https://github.com/nuxeo/nuxeo/commit/1c172814b95725da89181eb88a216a8df248a4da", "message": "NXP-29798: Implement a Capabilities Service", "committedDate": "2020-12-14T16:18:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEzODU0Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r547138546", "bodyText": "FYI this listener should be uninstalled too: in unit tests i see mutliple instances of this listener being piled up on the component manager (working on #4544)", "author": "atchertchian", "createdAt": "2020-12-22T08:31:48Z", "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/capabilities/CapabilitiesServiceImpl.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.runtime.capabilities;\n+\n+import static java.util.stream.Collectors.collectingAndThen;\n+import static java.util.stream.Collectors.toMap;\n+import static org.apache.commons.lang3.StringUtils.isNotBlank;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_HOTFIX;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_NAME;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_SERVER;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_VERSION;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.model.ComponentContext;\n+import org.nuxeo.runtime.model.ComponentManager;\n+import org.nuxeo.runtime.model.ComponentStartOrders;\n+import org.nuxeo.runtime.model.DefaultComponent;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class CapabilitiesServiceImpl extends DefaultComponent implements CapabilitiesService {\n+\n+    public static final String CAPABILITY_SERVER = \"server\";\n+\n+    protected final Map<String, Supplier<Map<String, Object>>> capabilitiesSuppliers = new HashMap<>();\n+\n+    @Override\n+    public void activate(ComponentContext context) {\n+        super.activate(context);\n+        new ComponentManager.Listener() {\n+            @Override\n+            public void beforeStart(ComponentManager mgr, boolean isResume) {\n+                capabilitiesSuppliers.clear();\n+            }\n+        }.install();", "originalCommit": "1c172814b95725da89181eb88a216a8df248a4da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI3MTg1NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r547271855", "bodyText": "Thanks for the notice, could I wait for #4544 to be merged to fix it?", "author": "kevinleturc", "createdAt": "2020-12-22T13:16:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEzODU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI3Mjg2NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r547272865", "bodyText": "Yes as #4544 will fix it (I migrated it so it will be uninstalled automatically), that was just as heads up in case this is backported on 10.10 or on the 2021 LTS branch (#4544 is not planned to be on the LTS for now)", "author": "atchertchian", "createdAt": "2020-12-22T13:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEzODU0Ng=="}], "type": "inlineReview"}]}