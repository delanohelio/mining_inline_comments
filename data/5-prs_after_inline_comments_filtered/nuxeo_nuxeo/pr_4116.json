{"pr_number": 4116, "pr_title": "Feature NXP-29190 add profile mechanism", "pr_createdAt": "2020-06-04T16:18:20Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxOTc4Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r435419786", "bodyText": "I'd use \"\" instead of EMPTY, it's shorter and doesn't require a dependency \ud83d\ude04", "author": "efge", "createdAt": "2020-06-04T17:16:45Z", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/ConfigurationGenerator.java", "diffHunk": "@@ -112,7 +113,13 @@\n     /** @since 11.1 */\n     public static final String NUXEO_ENVIRONMENT = System.getenv(\"NUXEO_ENVIRONMENT\");\n \n-    /** @since 6.0 */\n+    /** @since 11.1 */\n+    public static final String NUXEO_PROFILES = System.getenv().getOrDefault(\"NUXEO_PROFILES\", EMPTY);", "originalCommit": "af61543a70856e24fb9765e10459298d88d418e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a7ee14b09083f9dec46ea74c5c621bf95054ac1a", "url": "https://github.com/nuxeo/nuxeo/commit/a7ee14b09083f9dec46ea74c5c621bf95054ac1a", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-08T08:52:58Z", "type": "forcePushed"}, {"oid": "d5b51b156d553387c7580985bbbaeddcf0a24b25", "url": "https://github.com/nuxeo/nuxeo/commit/d5b51b156d553387c7580985bbbaeddcf0a24b25", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-08T10:57:31Z", "type": "forcePushed"}, {"oid": "9774426be8907bf5328fa4faf4a1c89397e4a5aa", "url": "https://github.com/nuxeo/nuxeo/commit/9774426be8907bf5328fa4faf4a1c89397e4a5aa", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-08T10:58:36Z", "type": "forcePushed"}, {"oid": "ba53804d8c34ae49cbb13a2016aad3b9cc514674", "url": "https://github.com/nuxeo/nuxeo/commit/ba53804d8c34ae49cbb13a2016aad3b9cc514674", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-08T11:03:15Z", "type": "forcePushed"}, {"oid": "83575fc90b344b78034db1d2dd8885d8c258bd11", "url": "https://github.com/nuxeo/nuxeo/commit/83575fc90b344b78034db1d2dd8885d8c258bd11", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-08T11:04:52Z", "type": "forcePushed"}, {"oid": "bce57a4e7995f12dd5bd4a9145948d3bb4951d86", "url": "https://github.com/nuxeo/nuxeo/commit/bce57a4e7995f12dd5bd4a9145948d3bb4951d86", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-08T11:09:41Z", "type": "forcePushed"}, {"oid": "38cfdbf865e0a2e6d341d1ad56d17d052c1c4760", "url": "https://github.com/nuxeo/nuxeo/commit/38cfdbf865e0a2e6d341d1ad56d17d052c1c4760", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-08T11:10:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0NTQyNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r436645426", "bodyText": "Unused import?", "author": "troger", "createdAt": "2020-06-08T12:08:29Z", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/info/ConfigurationInfo.java", "diffHunk": "@@ -19,6 +19,8 @@\n \n package org.nuxeo.launcher.info;\n \n+import org.apache.commons.collections.CollectionUtils;", "originalCommit": "38cfdbf865e0a2e6d341d1ad56d17d052c1c4760", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "836a5caed9ef74be51ae2f036396ece6d4900811", "url": "https://github.com/nuxeo/nuxeo/commit/836a5caed9ef74be51ae2f036396ece6d4900811", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-08T12:17:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwNjUzNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r436706536", "bodyText": "wouldn't you want to use the other signature of getEnvironment() with a default ?\nThe signature with a default is used in the public setProperties() method (line 1677) so it may be more consistent ?\nThe documentation says this signature (without a default) is only for tests. But it seems to be used in several internal methods. Maybe it's outdated ?\n\n\n@APinote exists to be overridden by tests", "author": "NourNuxeo", "createdAt": "2020-06-08T13:37:04Z", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/ConfigurationGenerator.java", "diffHunk": "@@ -2032,10 +2049,28 @@ protected String getJavaOptsString() {\n     }\n \n     /**\n-     * @return the value of an environment variable. Overriden for testing.\n+     * @return the value of an environment variable\n      * @since 9.1\n+     * @apiNote exists to be overridden by tests\n      */\n-    protected String getEnvironmentVariableValue(String key) {\n+    protected String getEnvironment(String key) {\n         return System.getenv(key);\n     }\n+\n+    /**\n+     * @return the value of an environment variable\n+     * @since 11.1\n+     * @see #getEnvironment(String)\n+     */\n+    protected String getEnvironment(String key, String defaultValue) {\n+        return Objects.requireNonNullElse(getEnvironment(key), defaultValue);\n+    }\n+\n+    /**\n+     * @return the nuxeo.defaults file for current {@code NUXEO_ENVIRONMENT}\n+     * @since 11.1\n+     */\n+    protected String getNuxeoEnvironmentConfName() {\n+        return String.format(NUXEO_ENVIRONMENT_CONF_FORMAT, getEnvironment(NUXEO_ENVIRONMENT));", "originalCommit": "836a5caed9ef74be51ae2f036396ece6d4900811", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0NTc2Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437245767", "bodyText": "There're several things in your comment.\n\nwouldn't you want to use the other signature of getEnvironment() with a default ?\n\nWhich default do you want to use?\n\nThe signature with a default is used in the public setProperties() method (line 1677) so it may be more consistent?\n\nBecause I use the String#isBlank method and so I can't have null.\n\nThe documentation says this signature (without a default) is only for tests. But it seems to be used in several internal methods. Maybe it's outdated?\n@APinote exists to be overridden by tests\n\nThe sentence doesn't say it's used by tests, it says that the method exists in order to let let test override it to provide a mock (see the tests).", "author": "kevinleturc", "createdAt": "2020-06-09T08:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMzMTg1OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437331859", "bodyText": "1- I assumed this is to avoid null so I would have given \"\" like line 1677 (like you explain in your second point)\n2- yes\n3 - Ok thanks for the explenation !", "author": "NourNuxeo", "createdAt": "2020-06-09T11:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2NzQ3MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437367471", "bodyText": "Probably, but this is not needed here. Furthermore, if the code evolves, I prefer to have nuxeo.null which clearly shows there's something wrong than nuxeo..", "author": "kevinleturc", "createdAt": "2020-06-09T12:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwNjUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0NTA4Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r436745083", "bodyText": "this is only used once line 148, is this for clarity ?", "author": "NourNuxeo", "createdAt": "2020-06-08T14:18:16Z", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/ServerConfigurator.java", "diffHunk": "@@ -141,8 +143,9 @@ public String getContextName() {\n      */\n     protected void parseAndCopy(Properties config) throws IOException, TemplateException, ConfigurationException {\n         // FilenameFilter for excluding \"nuxeo.defaults\" files from copy\n+        String nuxeoEnvironmentConf = generator.getNuxeoEnvironmentConfName();", "originalCommit": "836a5caed9ef74be51ae2f036396ece6d4900811", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0Njc0OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437246749", "bodyText": "What do you mean?", "author": "kevinleturc", "createdAt": "2020-06-09T08:56:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0NTA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMyNTQyMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437325420", "bodyText": "The variable is defined here and seems to be used only once right after on line 148 so I would have just made a call to generator.getNuxeoEnvironmentConfName(); there instead of defining a variable. Unless you did this to make the call shorter and clearer on line 148 ?", "author": "NourNuxeo", "createdAt": "2020-06-09T11:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0NTA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2NTQyNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437365424", "bodyText": "If I correctly remember, the line you're talking about is a function and it is called several times. That's the reason we get the variable before, otherwise, we will call it several times.\nNote: for future reviews, comment on line(s) you want to talk about.", "author": "kevinleturc", "createdAt": "2020-06-09T12:21:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0NTA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0NjM1MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r436746351", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            Arrays.asList(generator.getEnvironment(NUXEO_PROFILES, \"\").split(TEMPLATE_SEPARATOR)));\n          \n          \n            \n                            List.of(generator.getEnvironment(NUXEO_PROFILES, \"\").split(TEMPLATE_SEPARATOR)));", "author": "NourNuxeo", "createdAt": "2020-06-08T14:20:13Z", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/ServerConfigurator.java", "diffHunk": "@@ -614,8 +617,11 @@ public InstanceInfo getInfo(String clid, List<LocalPackage> pkgs) {\n             nxInstance.packages.add(info);\n             pkgTemplates.addAll(info.templates);\n         }\n-        // templates\n         nxInstance.config = new ConfigurationInfo();\n+        // profiles\n+        nxInstance.config.profiles.addAll(\n+                Arrays.asList(generator.getEnvironment(NUXEO_PROFILES, \"\").split(TEMPLATE_SEPARATOR)));", "originalCommit": "836a5caed9ef74be51ae2f036396ece6d4900811", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0NzAyNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437247025", "bodyText": "Not in this case, we get an array so it makes sense to use Arrays API.", "author": "kevinleturc", "createdAt": "2020-06-09T08:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0NjM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1NTYzMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r436755630", "bodyText": "no more Boolean.TRUE ?", "author": "NourNuxeo", "createdAt": "2020-06-08T14:33:20Z", "path": "modules/runtime/nuxeo-launcher-commons/src/test/java/org/nuxeo/launcher/config/ConfigurationGeneratorTest.java", "diffHunk": "@@ -531,4 +543,22 @@ public void testCheckEncoding() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testIncludeProfile() {\n+        String profileToTest = \"testprofile\";\n+        assertFalse(\"Profile should not be included\", isTemplateIncluded(profileToTest));\n+        assertNotEquals(\"true\", configGenerator.getUserConfig().getProperty(\"nuxeo.profile.added.by.test\"));", "originalCommit": "836a5caed9ef74be51ae2f036396ece6d4900811", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0NzIyNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437247224", "bodyText": "Check the type, we get String.", "author": "kevinleturc", "createdAt": "2020-06-09T08:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1NTYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1NjE1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r436756152", "bodyText": "same question about Boolean.TRUE", "author": "NourNuxeo", "createdAt": "2020-06-08T14:34:09Z", "path": "modules/runtime/nuxeo-launcher-commons/src/test/java/org/nuxeo/launcher/config/ConfigurationGeneratorTest.java", "diffHunk": "@@ -531,4 +543,22 @@ public void testCheckEncoding() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testIncludeProfile() {\n+        String profileToTest = \"testprofile\";\n+        assertFalse(\"Profile should not be included\", isTemplateIncluded(profileToTest));\n+        assertNotEquals(\"true\", configGenerator.getUserConfig().getProperty(\"nuxeo.profile.added.by.test\"));\n+\n+        env.put(NUXEO_PROFILES, profileToTest);\n+\n+        configGenerator.init(true);\n+\n+        assertTrue(\"Profile should be included\", isTemplateIncluded(profileToTest));\n+        assertEquals(\"true\", configGenerator.getUserConfig().getProperty(\"nuxeo.profile.added.by.test\"));", "originalCommit": "836a5caed9ef74be51ae2f036396ece6d4900811", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0NzI4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437247287", "bodyText": "Same answer.", "author": "kevinleturc", "createdAt": "2020-06-09T08:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc1NjE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0NDQ3Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r437244473", "bodyText": "@since 11.1 maybe, though the class existed inline before?", "author": "ataillefer", "createdAt": "2020-06-09T08:53:44Z", "path": "modules/runtime/nuxeo-launcher-commons/src/test/java/org/nuxeo/launcher/config/LogCaptureAppender.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *  \n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *  \n+ *  Contributors:\n+ *      Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.launcher.config;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.appender.AbstractAppender;\n+import org.apache.logging.log4j.core.config.Property;\n+\n+public class LogCaptureAppender extends AbstractAppender {", "originalCommit": "c5ad7719e5f3e1182d93eefe4ce8f528e9285089", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEyNjI5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r438126290", "bodyText": "Good catch, thx \ud83d\udc4d", "author": "kevinleturc", "createdAt": "2020-06-10T13:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0NDQ3Mw=="}], "type": "inlineReview"}, {"oid": "5783514af922feb8194ab9dbae9ed981d3510666", "url": "https://github.com/nuxeo/nuxeo/commit/5783514af922feb8194ab9dbae9ed981d3510666", "message": "NXP-29190: Cleanup / Format", "committedDate": "2020-06-10T13:34:59Z", "type": "commit"}, {"oid": "c4256faf9f948312ee852a515f72959e5a7ebe56", "url": "https://github.com/nuxeo/nuxeo/commit/c4256faf9f948312ee852a515f72959e5a7ebe56", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-10T13:35:04Z", "type": "commit"}, {"oid": "c4256faf9f948312ee852a515f72959e5a7ebe56", "url": "https://github.com/nuxeo/nuxeo/commit/c4256faf9f948312ee852a515f72959e5a7ebe56", "message": "NXP-29190: Add Nuxeo Profiles notion", "committedDate": "2020-06-10T13:35:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIxODQ0NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r438218445", "bodyText": "For strings I prefer StringUtils's defautString but I guess requireNonNullElse works too", "author": "efge", "createdAt": "2020-06-10T15:35:22Z", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/ConfigurationGenerator.java", "diffHunk": "@@ -2032,10 +2049,28 @@ protected String getJavaOptsString() {\n     }\n \n     /**\n-     * @return the value of an environment variable. Overriden for testing.\n+     * @return the value of an environment variable\n      * @since 9.1\n+     * @apiNote exists to be overridden by tests\n      */\n-    protected String getEnvironmentVariableValue(String key) {\n+    protected String getEnvironment(String key) {\n         return System.getenv(key);\n     }\n+\n+    /**\n+     * @return the value of an environment variable\n+     * @since 11.1\n+     * @see #getEnvironment(String)\n+     */\n+    protected String getEnvironment(String key, String defaultValue) {\n+        return Objects.requireNonNullElse(getEnvironment(key), defaultValue);", "originalCommit": "c4256faf9f948312ee852a515f72959e5a7ebe56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIyMzYzNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4116#discussion_r438223634", "bodyText": "Here I just want to default when the env value is null and not blank, I chose Objects because its in the JDK.", "author": "kevinleturc", "createdAt": "2020-06-10T15:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIxODQ0NQ=="}], "type": "inlineReview"}]}