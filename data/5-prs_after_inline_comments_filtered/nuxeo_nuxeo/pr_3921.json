{"pr_number": 3921, "pr_title": "Backport NXP-28763 NXP-26704 NXP-28900 NXP-28919 to 10.10", "pr_createdAt": "2020-04-14T21:35:04Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3921", "timeline": [{"oid": "c119acaf51e6f863dbab83a33abadb27e2190012", "url": "https://github.com/nuxeo/nuxeo/commit/c119acaf51e6f863dbab83a33abadb27e2190012", "message": "NXP-28763: optimized MongoDB ids", "committedDate": "2020-04-14T20:07:45Z", "type": "commit"}, {"oid": "cd8097dca3f9c4346a853c3dc2a6ce594a220cd6", "url": "https://github.com/nuxeo/nuxeo/commit/cd8097dca3f9c4346a853c3dc2a6ce594a220cd6", "message": "NXP-26704: move fulltext-related test features to nuxeo-core-test", "committedDate": "2020-04-14T20:14:19Z", "type": "commit"}, {"oid": "18dd82d65f110d8fc307786b84bbe91b04329cee", "url": "https://github.com/nuxeo/nuxeo/commit/18dd82d65f110d8fc307786b84bbe91b04329cee", "message": "NXP-26704: align internal property names in VCS and DBS, for simpler blob dispatcher config", "committedDate": "2020-04-14T20:17:04Z", "type": "commit"}, {"oid": "46f05163340750f0985d405bfcb3c016cb082222", "url": "https://github.com/nuxeo/nuxeo/commit/46f05163340750f0985d405bfcb3c016cb082222", "message": "NXP-26704: allow storing fulltext in blobs", "committedDate": "2020-04-14T20:56:46Z", "type": "commit"}, {"oid": "8f9afd8721141cd21b0901a018b7784ad2c56387", "url": "https://github.com/nuxeo/nuxeo/commit/8f9afd8721141cd21b0901a018b7784ad2c56387", "message": "NXP-26704: use constant for binarytext key in map", "committedDate": "2020-04-14T21:04:02Z", "type": "commit"}, {"oid": "feb68d7525a4c48358ca0a3607ffc3864d5404b4", "url": "https://github.com/nuxeo/nuxeo/commit/feb68d7525a4c48358ca0a3607ffc3864d5404b4", "message": "NXP-28900: allow blob provider to access document when reading blob", "committedDate": "2020-04-14T21:14:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcyNzMxNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3921#discussion_r408727317", "bodyText": "Don't we want to keep the existing constructor/methods for backward compatibility, to be safe? (I know it's mostly internal stuff)", "author": "troger", "createdAt": "2020-04-15T10:04:25Z", "path": "nuxeo-core/nuxeo-core-storage-mongodb/src/main/java/org/nuxeo/ecm/core/storage/mongodb/MongoDBConverter.java", "diffHunk": "@@ -57,22 +64,35 @@\n     /** The key to use in memory to map the database native \"_id\". */\n     protected final String idKey;\n \n+    /** The keys for booleans whose value is true or null (instead of false). */\n+    protected final Set<String> trueOrNullBooleanKeys;\n+\n+    /** The keys whose values are ids and are stored as longs. */\n+    protected final Set<String> idValuesKeys;\n+\n     /**\n      * Constructor for a converter that does not map the MongoDB native \"_id\".\n      *\n      * @since 10.3\n      */\n     public MongoDBConverter() {\n-        this(null);\n+        this(null, Collections.emptySet(), Collections.emptySet());\n     }\n \n     /**\n      * Constructor for a converter that also knows to optionally translate the native MongoDB \"_id\" into a custom id.\n+     * <p>\n+     * When {@code idValuesKeys} are provided, the ids are stored as longs.\n      *\n      * @param idKey the key to use to map the native \"_id\" in memory, if not {@code null}\n+     * @param trueOrNullBooleanKeys the keys corresponding to boolean values that are only true or null (instead of\n+     *            false)\n+     * @param idValuesKeys the keys corresponding to values that are ids\n      */\n-    public MongoDBConverter(String idKey) {", "originalCommit": "f22f08ce03ad612b473ef193825868abb4b1ed6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NjM5Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3921#discussion_r408786396", "bodyText": "This is too low-level internals to make sense.", "author": "efge", "createdAt": "2020-04-15T11:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcyNzMxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODczMjU0Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3921#discussion_r408732547", "bodyText": "Maybe a default impl?", "author": "troger", "createdAt": "2020-04-15T10:13:42Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManager.java", "diffHunk": "@@ -35,14 +35,27 @@\n  */\n public interface DocumentBlobManager {\n \n+    /**\n+     * Reads a {@link Blob} from storage.\n+     *\n+     * @param blobInfo the blob information\n+     * @param doc the document to which this blob belongs\n+     * @param xpath the xpath of the blob in the document\n+     * @return a managed blob\n+     * @since 11.1\n+     */\n+    Blob readBlob(BlobInfo blobInfo, Document doc, String xpath) throws IOException;", "originalCommit": "f22f08ce03ad612b473ef193825868abb4b1ed6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NzEzNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3921#discussion_r408787135", "bodyText": "As it's a service with only one implementation not really worth it, and it has to be implemented anyway.", "author": "efge", "createdAt": "2020-04-15T11:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODczMjU0Nw=="}], "type": "inlineReview"}, {"oid": "1348916f73c4911b043a05b442bb7733e6df2037", "url": "https://github.com/nuxeo/nuxeo/commit/1348916f73c4911b043a05b442bb7733e6df2037", "message": "NXP-28919: simplify ManagedBlob logic", "committedDate": "2020-04-15T11:53:10Z", "type": "commit"}, {"oid": "3fedf43e3aa8606faeb335cc01887c8b11f23d23", "url": "https://github.com/nuxeo/nuxeo/commit/3fedf43e3aa8606faeb335cc01887c8b11f23d23", "message": "NXP-28919: move ByteRange to nuxeo-core-api", "committedDate": "2020-04-15T11:53:10Z", "type": "commit"}, {"oid": "99f3c5755baef0e17d40ef39e531e47ece15d49f", "url": "https://github.com/nuxeo/nuxeo/commit/99f3c5755baef0e17d40ef39e531e47ece15d49f", "message": "NXP-28919: allow blob provider to do optimized byte range requests", "committedDate": "2020-04-15T11:53:10Z", "type": "commit"}, {"oid": "99f3c5755baef0e17d40ef39e531e47ece15d49f", "url": "https://github.com/nuxeo/nuxeo/commit/99f3c5755baef0e17d40ef39e531e47ece15d49f", "message": "NXP-28919: allow blob provider to do optimized byte range requests", "committedDate": "2020-04-15T11:53:10Z", "type": "forcePushed"}]}