{"pr_number": 3884, "pr_title": "feature-NXP-28602-Transfer-document-in-S3-Glacier-Manual-action-in-WebUI-for-a-resultset-of-documents", "pr_createdAt": "2020-04-01T21:32:52Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3884", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyNzAzNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402127037", "bodyText": "This behaves differently from moveContent when save is true. In moveContent you are returning the saved document while here the documents in result are not the ones returned by CoreSession#saveDocument.\nLooking at the saveDocuments implementation, you could do your own iteration/stream :)\nBTW, why not letting moveContent save the document? This would avoid multiple if(save).", "author": "troger", "createdAt": "2020-04-02T08:08:21Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorage.java", "diffHunk": "@@ -50,8 +55,28 @@\n     @Param(name = \"save\", required = false, values = \"true\")\n     protected boolean save = true;\n \n-    @OperationMethod(collector = DocumentModelCollector.class)\n-    public DocumentModel run(DocumentModel doc) {\n+    @OperationMethod\n+    public DocumentModelList run(DocumentModelList documents) {\n+        DocumentModelList result = new DocumentModelListImpl();\n+        for (DocumentModel documentModel : documents) {\n+            try {\n+                result.add(moveContent(documentModel, false));\n+            } catch (Exception e) {\n+                log.error(\"Unable to move document: {} to cold storage\", documentModel.getId(), e);\n+            }\n+        }\n+        if (save) {\n+            session.saveDocuments(result.toArray(new DocumentModel[0]));\n+        }\n+        return result;", "originalCommit": "8c4fa36cc607f8d47934a3b2dd04e37f5af151a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1MjAzMA==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402152030", "bodyText": "This behaves differently from moveContent when save is true. In moveContent you are returning the saved document while here the documents in result are not the ones returned by CoreSession#saveDocument.\n\ngood point thanks\n\nLooking at the saveDocuments implementation, you could do your own iteration/stream :)\n\nI agree and I thought my self same thing, but after a short reflection I told myself i prefers use the existing one to mainly if in future we re-write the CoreSession one to be for example more performante ... I will benefit\n\nBTW, why not letting moveContent save the document? This would avoid multiple if(save).\n\nyou mean save doc by doc, instead of save them ?", "author": "RSalem07", "createdAt": "2020-04-02T08:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyNzAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402128067", "bodyText": "Why catching Exception here? Do not forget https://doc.nuxeo.com/corg/catching-exceptions/#never-catch-exception :)", "author": "troger", "createdAt": "2020-04-02T08:10:09Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorage.java", "diffHunk": "@@ -50,8 +55,28 @@\n     @Param(name = \"save\", required = false, values = \"true\")\n     protected boolean save = true;\n \n-    @OperationMethod(collector = DocumentModelCollector.class)\n-    public DocumentModel run(DocumentModel doc) {\n+    @OperationMethod\n+    public DocumentModelList run(DocumentModelList documents) {\n+        DocumentModelList result = new DocumentModelListImpl();\n+        for (DocumentModel documentModel : documents) {\n+            try {\n+                result.add(moveContent(documentModel, false));\n+            } catch (Exception e) {", "originalCommit": "8c4fa36cc607f8d47934a3b2dd04e37f5af151a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1MzMyOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402153328", "bodyText": "I completely agree and i am not in favour of catch Exception level, I was going to cache NuxeoException but the move of documents can be see as a batch process (i asked on slack channel) and the idea is to be able to continue the move even one document fails this is the reason why i ended by catching Exception", "author": "RSalem07", "createdAt": "2020-04-02T08:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE5MjkxMw==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402192913", "bodyText": "@troger , what is usually the approach for this kind of use cases?\nI can see that we have a some operations that just loop the desired method which means that it will stop at the first failure. Should be this the pattern we want?", "author": "nmpcunha", "createdAt": "2020-04-02T09:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI4MTk5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402281990", "bodyText": "If you have to deal with catching Exception then follow the documentation to deal with InterruptedException: https://doc.nuxeo.com/corg/catching-exceptions/#methods-that-want-to-keep-running-after-an-exception", "author": "troger", "createdAt": "2020-04-02T12:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI4Mzc2OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402283768", "bodyText": "Anyway, I still think that you need to just catch NuxeoException, so you continue if there is an issue in Nuxeo related code. Other runtime exceptions should just break the code anyway... wdyt @efge?", "author": "troger", "createdAt": "2020-04-02T12:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI4ODYwNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402288606", "bodyText": "yes i had a look at the document, InterruptedException is type of Exception and not a runtime one, with catch it will make an error compilation. Which means i should add the InterruptedException into the public DocumentModel run(DocumentModel document) throws InterruptedException if we agree i do the modification.", "author": "RSalem07", "createdAt": "2020-04-02T12:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI4OTk3NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402289975", "bodyText": "catching NuxeoException is another solution why not, my wondering was about any other affect to avoid blocking the whole move. but if we all agree let add the NuxeoException only.", "author": "RSalem07", "createdAt": "2020-04-02T12:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwNTcyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402905729", "bodyText": "I would go for NuxeoException only, other runtime exceptions must break.", "author": "troger", "createdAt": "2020-04-03T10:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwNjE1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402906152", "bodyText": "ok I agree it is what i did yesterday", "author": "RSalem07", "createdAt": "2020-04-03T10:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyOTI5OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402129299", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected void checkMoveContent(List<DocumentModel> expectedDocs, List<DocumentModel> foundedDocs)\n          \n          \n            \n                protected void checkMoveContent(List<DocumentModel> expectedDocs, List<DocumentModel> actualDocs)\n          \n      \n    \n    \n  \n\n?", "author": "troger", "createdAt": "2020-04-02T08:12:26Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/AbstractTestColdStorageOperation.java", "diffHunk": "@@ -66,18 +68,52 @@ protected void moveContentToColdStorage(CoreSession session, DocumentModel docum\n         try (OperationContext context = new OperationContext(session)) {\n             context.setInput(documentModel);\n             DocumentModel updatedDocModel = (DocumentModel) automationService.run(context, MoveToColdStorage.ID);\n+            checkMoveContent(List.of(documentModel), List.of(updatedDocModel));\n+        }\n+    }\n+\n+    protected void moveContentToColdStorage(CoreSession session, List<DocumentModel> documents)\n+            throws OperationException, IOException {\n+        List<String> documentIds = documents.stream().map(DocumentModel::getId).collect(Collectors.toList());\n+        try (OperationContext context = new OperationContext(session)) {\n+            context.setInput(documents);\n+            checkMoveContent(documents, (DocumentModelList) automationService.run(context, MoveToColdStorage.ID));\n+        }\n+    }\n+\n+    protected void checkMoveContent(List<DocumentModel> expectedDocs, List<DocumentModel> foundedDocs)", "originalCommit": "8c4fa36cc607f8d47934a3b2dd04e37f5af151a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyOTYxOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402129618", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (DocumentModel updatedDocModel : foundedDocs) {\n          \n          \n            \n                    for (DocumentModel updatedDoc : foundedDocs) {", "author": "troger", "createdAt": "2020-04-02T08:12:58Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/AbstractTestColdStorageOperation.java", "diffHunk": "@@ -66,18 +68,52 @@ protected void moveContentToColdStorage(CoreSession session, DocumentModel docum\n         try (OperationContext context = new OperationContext(session)) {\n             context.setInput(documentModel);\n             DocumentModel updatedDocModel = (DocumentModel) automationService.run(context, MoveToColdStorage.ID);\n+            checkMoveContent(List.of(documentModel), List.of(updatedDocModel));\n+        }\n+    }\n+\n+    protected void moveContentToColdStorage(CoreSession session, List<DocumentModel> documents)\n+            throws OperationException, IOException {\n+        List<String> documentIds = documents.stream().map(DocumentModel::getId).collect(Collectors.toList());\n+        try (OperationContext context = new OperationContext(session)) {\n+            context.setInput(documents);\n+            checkMoveContent(documents, (DocumentModelList) automationService.run(context, MoveToColdStorage.ID));\n+        }\n+    }\n+\n+    protected void checkMoveContent(List<DocumentModel> expectedDocs, List<DocumentModel> foundedDocs)\n+            throws IOException {\n+        assertEquals(expectedDocs.size(), foundedDocs.size());\n+        List<String> expectedDocIds = expectedDocs.stream().map(DocumentModel::getId).collect(Collectors.toList());\n+        for (DocumentModel updatedDocModel : foundedDocs) {", "originalCommit": "8c4fa36cc607f8d47934a3b2dd04e37f5af151a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNTMxOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402135318", "bodyText": "The assertEquals messages are not really needed, and it makes the code/test hardly understandable IMO.", "author": "troger", "createdAt": "2020-04-02T08:23:17Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/AbstractTestColdStorageOperation.java", "diffHunk": "@@ -66,18 +68,52 @@ protected void moveContentToColdStorage(CoreSession session, DocumentModel docum\n         try (OperationContext context = new OperationContext(session)) {\n             context.setInput(documentModel);\n             DocumentModel updatedDocModel = (DocumentModel) automationService.run(context, MoveToColdStorage.ID);\n+            checkMoveContent(List.of(documentModel), List.of(updatedDocModel));\n+        }\n+    }\n+\n+    protected void moveContentToColdStorage(CoreSession session, List<DocumentModel> documents)\n+            throws OperationException, IOException {\n+        List<String> documentIds = documents.stream().map(DocumentModel::getId).collect(Collectors.toList());\n+        try (OperationContext context = new OperationContext(session)) {\n+            context.setInput(documents);\n+            checkMoveContent(documents, (DocumentModelList) automationService.run(context, MoveToColdStorage.ID));\n+        }\n+    }\n+\n+    protected void checkMoveContent(List<DocumentModel> expectedDocs, List<DocumentModel> foundedDocs)\n+            throws IOException {\n+        assertEquals(expectedDocs.size(), foundedDocs.size());\n+        List<String> expectedDocIds = expectedDocs.stream().map(DocumentModel::getId).collect(Collectors.toList());\n+        for (DocumentModel updatedDocModel : foundedDocs) {\n             Blob fileContent = (Blob) updatedDocModel.getPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY);\n             Blob coldStorageContent = (Blob) updatedDocModel.getPropertyValue(\n                     ColdStorageHelper.COLD_STORAGE_CONTENT_PROPERTY);\n-            assertEquals(documentModel.getRef(), updatedDocModel.getRef());\n-            assertTrue(updatedDocModel.hasFacet(FacetNames.COLD_STORAGE));\n-            assertEquals(DummyThumbnailFactory.DUMMY_THUMBNAIL_CONTENT, fileContent.getString());\n-            assertEquals(FILE_CONTENT, coldStorageContent.getString());\n+\n+            // check document\n+            assertTrue(String.format(\"Doc: %s must one of %s\", updatedDocModel, expectedDocs),\n+                    expectedDocIds.contains(updatedDocModel.getId()));\n+            assertTrue(String.format(\"Doc: %s must have the %s Facet\", updatedDocModel, FacetNames.COLD_STORAGE),\n+                    updatedDocModel.hasFacet(FacetNames.COLD_STORAGE));\n+\n+            // check blobs\n+            assertEquals(String.format(\"Doc: %s must have %s in 'file:content'\", //\n+                    updatedDocModel, DummyThumbnailFactory.DUMMY_THUMBNAIL_CONTENT), //\n+                    DummyThumbnailFactory.DUMMY_THUMBNAIL_CONTENT, fileContent.getString());\n+            assertEquals(String.format(\"Doc: %s must have %s in 'coldstorage:coldContent'\", //\n+                    updatedDocModel, FILE_CONTENT), //\n+                    FILE_CONTENT, coldStorageContent.getString());", "originalCommit": "8c4fa36cc607f8d47934a3b2dd04e37f5af151a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NTAyNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402155026", "bodyText": "yes, ;) it is mainly what I did in the past, but since I had a discussion wiht Florent on the assertion in theses cases (loop) he advised me to add a message to make easier the comprehension of things when the test failed. but no pbs if we all agree i can remove them :)", "author": "RSalem07", "createdAt": "2020-04-02T08:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNTMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3NjY5NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402176695", "bodyText": "I took into account your suggestion :), I let the conversation open to get more feedbacks", "author": "RSalem07", "createdAt": "2020-04-02T09:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNTMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwNzYyNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402907627", "bodyText": "I mark the conversation as resolved, I made the modification to suit your suggestions. I thinks these kind of interrogation; static import, message in assertion will be more global and I think will be part of the guideline that you are going to do :)", "author": "RSalem07", "createdAt": "2020-04-03T10:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNTMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNjI4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402136287", "bodyText": "What about just removing this method used 2 times, and give a doc name to both calls?", "author": "troger", "createdAt": "2020-04-02T08:24:48Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/AbstractTestColdStorageOperation.java", "diffHunk": "@@ -66,18 +68,52 @@ protected void moveContentToColdStorage(CoreSession session, DocumentModel docum\n         try (OperationContext context = new OperationContext(session)) {\n             context.setInput(documentModel);\n             DocumentModel updatedDocModel = (DocumentModel) automationService.run(context, MoveToColdStorage.ID);\n+            checkMoveContent(List.of(documentModel), List.of(updatedDocModel));\n+        }\n+    }\n+\n+    protected void moveContentToColdStorage(CoreSession session, List<DocumentModel> documents)\n+            throws OperationException, IOException {\n+        List<String> documentIds = documents.stream().map(DocumentModel::getId).collect(Collectors.toList());\n+        try (OperationContext context = new OperationContext(session)) {\n+            context.setInput(documents);\n+            checkMoveContent(documents, (DocumentModelList) automationService.run(context, MoveToColdStorage.ID));\n+        }\n+    }\n+\n+    protected void checkMoveContent(List<DocumentModel> expectedDocs, List<DocumentModel> foundedDocs)\n+            throws IOException {\n+        assertEquals(expectedDocs.size(), foundedDocs.size());\n+        List<String> expectedDocIds = expectedDocs.stream().map(DocumentModel::getId).collect(Collectors.toList());\n+        for (DocumentModel updatedDocModel : foundedDocs) {\n             Blob fileContent = (Blob) updatedDocModel.getPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY);\n             Blob coldStorageContent = (Blob) updatedDocModel.getPropertyValue(\n                     ColdStorageHelper.COLD_STORAGE_CONTENT_PROPERTY);\n-            assertEquals(documentModel.getRef(), updatedDocModel.getRef());\n-            assertTrue(updatedDocModel.hasFacet(FacetNames.COLD_STORAGE));\n-            assertEquals(DummyThumbnailFactory.DUMMY_THUMBNAIL_CONTENT, fileContent.getString());\n-            assertEquals(FILE_CONTENT, coldStorageContent.getString());\n+\n+            // check document\n+            assertTrue(String.format(\"Doc: %s must one of %s\", updatedDocModel, expectedDocs),\n+                    expectedDocIds.contains(updatedDocModel.getId()));\n+            assertTrue(String.format(\"Doc: %s must have the %s Facet\", updatedDocModel, FacetNames.COLD_STORAGE),\n+                    updatedDocModel.hasFacet(FacetNames.COLD_STORAGE));\n+\n+            // check blobs\n+            assertEquals(String.format(\"Doc: %s must have %s in 'file:content'\", //\n+                    updatedDocModel, DummyThumbnailFactory.DUMMY_THUMBNAIL_CONTENT), //\n+                    DummyThumbnailFactory.DUMMY_THUMBNAIL_CONTENT, fileContent.getString());\n+            assertEquals(String.format(\"Doc: %s must have %s in 'coldstorage:coldContent'\", //\n+                    updatedDocModel, FILE_CONTENT), //\n+                    FILE_CONTENT, coldStorageContent.getString());\n         }\n+\n     }\n \n     protected DocumentModel createFileDocument(CoreSession session, boolean withBlobContent, ACE... aces) {\n-        DocumentModel documentModel = session.createDocumentModel(\"/\", \"MyFile\", \"File\");\n+        return createFileDocument(session, withBlobContent, \"MyFile\", aces);\n+    }", "originalCommit": "8c4fa36cc607f8d47934a3b2dd04e37f5af151a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NzE5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402157190", "bodyText": "you mean just give the same name to all callers ? or mainly your idea is to keep only the method that take a name and i will do a little refactoring :)", "author": "RSalem07", "createdAt": "2020-04-02T08:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNjI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3NzMzNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402177337", "bodyText": "I remove the new method and i use the same name and the listener responsible of renaming will take it into account.", "author": "RSalem07", "createdAt": "2020-04-02T09:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNjI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzODIxNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402138215", "bodyText": "Is this expected to create the documents with \"linda\" aces?", "author": "troger", "createdAt": "2020-04-02T08:28:10Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorageTest.java", "diffHunk": "@@ -80,6 +81,29 @@ public void shouldMoveToColdStorage() throws OperationException, IOException {\n         moveContentToColdStorage(session, documentModel);\n     }\n \n+    @Test\n+    public void shouldMoveDocsToColdStorage() throws OperationException, IOException {\n+        // with regular user with \"WriteColdStorage\" permission\n+        ACE[] aces = { new ACE(\"linda\", SecurityConstants.READ, true), //\n+                new ACE(\"linda\", SecurityConstants.WRITE, true), //\n+                new ACE(\"linda\", SecurityConstants.WRITE_COLD_STORAGE, true) };\n+\n+        List<DocumentModel> documents = List.of(createFileDocument(session, true, \"MyFile1\", aces), //\n+                createFileDocument(session, true, \"MyFile2\", aces), //\n+                createFileDocument(session, true, \"MyFile3\", aces));\n+\n+        try (CloseableCoreSession userSession = CoreInstance.openCoreSession(session.getRepositoryName(), \"linda\")) {\n+            moveContentToColdStorage(userSession, documents);\n+        }\n+\n+        // with Administrator\n+        documents = List.of(createFileDocument(session, true, \"MyFile4\", aces), //\n+                createFileDocument(session, true, \"MyFile5\", aces), //\n+                createFileDocument(session, true, \"MyFile6\", aces));", "originalCommit": "8c4fa36cc607f8d47934a3b2dd04e37f5af151a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1Nzk0MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402157941", "bodyText": "good point thanks, wrong copy / past", "author": "RSalem07", "createdAt": "2020-04-02T08:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzODIxNQ=="}], "type": "inlineReview"}, {"oid": "faaf7adfee0a8ae58bac2205dbcfc0b1866c31cd", "url": "https://github.com/nuxeo/nuxeo/commit/faaf7adfee0a8ae58bac2205dbcfc0b1866c31cd", "message": "NXP-28602: Add ability to move documents contents to cold storage", "committedDate": "2020-04-02T09:19:34Z", "type": "forcePushed"}, {"oid": "d6626ad3214588c8222bdb1c09f1519b8731532f", "url": "https://github.com/nuxeo/nuxeo/commit/d6626ad3214588c8222bdb1c09f1519b8731532f", "message": "NXP-28602: Add ability to move documents contents to cold storage", "committedDate": "2020-04-02T09:27:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE5NjUzNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r402196537", "bodyText": "If we confirm that we want this kind of pattern, should we also add a test for it? i.e. for the exception situation", "author": "nmpcunha", "createdAt": "2020-04-02T10:02:26Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorage.java", "diffHunk": "@@ -67,4 +73,17 @@ public DocumentModel run(DocumentModel doc) {\n         return documentModel;\n     }\n \n+    @OperationMethod\n+    public DocumentModelList run(DocumentModelList documents) {\n+        DocumentModelList result = new DocumentModelListImpl();\n+        for (DocumentModel documentModel : documents) {\n+            try {\n+                result.add(run(documentModel));\n+            } catch (Exception e) {\n+                log.error(\"Unable to move document: {} to cold storage\", documentModel.getId(), e);\n+            }", "originalCommit": "d6626ad3214588c8222bdb1c09f1519b8731532f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3a9018745d2475419931e655ce09d0702b7c0846", "url": "https://github.com/nuxeo/nuxeo/commit/3a9018745d2475419931e655ce09d0702b7c0846", "message": "NXP-28602: Add ability to move documents contents to cold storage", "committedDate": "2020-04-02T12:56:55Z", "type": "forcePushed"}, {"oid": "4e313a181470cdcdd4bb751bcaf343d2db3c2373", "url": "https://github.com/nuxeo/nuxeo/commit/4e313a181470cdcdd4bb751bcaf343d2db3c2373", "message": "NXP-28602: Add ability to move documents contents to cold storage", "committedDate": "2020-04-02T13:07:42Z", "type": "commit"}, {"oid": "4e313a181470cdcdd4bb751bcaf343d2db3c2373", "url": "https://github.com/nuxeo/nuxeo/commit/4e313a181470cdcdd4bb751bcaf343d2db3c2373", "message": "NXP-28602: Add ability to move documents contents to cold storage", "committedDate": "2020-04-02T13:07:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEyMzM4MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r403123381", "bodyText": "We use doc in lots of places to refer to DocumentModel instances, not sure why it's worth changing here.", "author": "efge", "createdAt": "2020-04-03T16:21:42Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorage.java", "diffHunk": "@@ -50,13 +57,13 @@\n     @Param(name = \"save\", required = false, values = \"true\")\n     protected boolean save = true;\n \n-    @OperationMethod(collector = DocumentModelCollector.class)\n-    public DocumentModel run(DocumentModel doc) {\n+    @OperationMethod\n+    public DocumentModel run(DocumentModel document) {\n         // retrieve the thumbnail which will be used to replace the content, once the move done\n-        Blob thumbnail = Framework.getService(ThumbnailService.class).getThumbnail(doc, session);\n+        Blob thumbnail = Framework.getService(ThumbnailService.class).getThumbnail(document, session);", "originalCommit": "4e313a181470cdcdd4bb751bcaf343d2db3c2373", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEyMzc2Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3884#discussion_r403123766", "bodyText": "doc would be fine here too", "author": "efge", "createdAt": "2020-04-03T16:22:09Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorage.java", "diffHunk": "@@ -67,4 +74,17 @@ public DocumentModel run(DocumentModel doc) {\n         return documentModel;\n     }\n \n+    @OperationMethod\n+    public DocumentModelList run(DocumentModelList documents) {\n+        DocumentModelList result = new DocumentModelListImpl();\n+        for (DocumentModel documentModel : documents) {", "originalCommit": "4e313a181470cdcdd4bb751bcaf343d2db3c2373", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}