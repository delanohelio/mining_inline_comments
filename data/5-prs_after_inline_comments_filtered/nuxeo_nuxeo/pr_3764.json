{"pr_number": 3764, "pr_title": "NXP-27654: add a unique index on ecm:id in MongoDB", "pr_createdAt": "2020-02-19T15:11:42Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3764", "timeline": [{"oid": "1c3b7356169240e721b7bc7fadec2ee3b8649ee8", "url": "https://github.com/nuxeo/nuxeo/commit/1c3b7356169240e721b7bc7fadec2ee3b8649ee8", "message": "NXP-27654: add a unique index on ecm:id in MongoDB", "committedDate": "2020-02-19T14:30:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ4NzU1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3764#discussion_r381487552", "bodyText": "is the message useful, or could it be richer?", "author": "ataillefer", "createdAt": "2020-02-19T19:14:41Z", "path": "nuxeo-core/nuxeo-core-storage-mongodb/src/main/java/org/nuxeo/ecm/core/storage/mongodb/MongoDBRepository.java", "diffHunk": "@@ -345,7 +345,7 @@ public void createStates(List<State> states) {\n             // Avoid hiding any others bulk errors\n             if (duplicates.size() == mbwe.getWriteErrors().size()) {\n                 log.trace(\"MongoDB:    -> DUPLICATE KEY: {}\", duplicates);\n-                ConcurrentUpdateException concurrentUpdateException = new ConcurrentUpdateException();\n+                ConcurrentUpdateException concurrentUpdateException = new ConcurrentUpdateException(\"Concurrent update\");", "originalCommit": "1c3b7356169240e721b7bc7fadec2ee3b8649ee8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUzNjM4OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3764#discussion_r381536389", "bodyText": "The lines below this one call addInfo with the details of the duplicates. I'm adding \"Concurrent update\" here to be in sync in with what's done in VCS and have unit tests that work for both DBS and VCS.", "author": "efge", "createdAt": "2020-02-19T20:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ4NzU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ4OTA4NA==", "url": "https://github.com/nuxeo/nuxeo/pull/3764#discussion_r381489084", "bodyText": "could/should these 2 lines be replaced by\ntransactionalFeature.nextTransaction()\n\nThough it's probably for backport purpose, don't we want to benefit from it on master?", "author": "ataillefer", "createdAt": "2020-02-19T19:17:30Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -3743,6 +3743,61 @@ public void testImport() {\n         assertFalse(doc.isProxy());\n     }\n \n+    @Test\n+    public void testImportDuplicateIdSameSession() {\n+        DocumentModel doc = session.createDocumentModel(\"/\", \"doc\", \"File\");\n+        doc = session.createDocument(doc);\n+        session.save();\n+        nextTransaction();", "originalCommit": "1c3b7356169240e721b7bc7fadec2ee3b8649ee8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUzODY3Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3764#discussion_r381538677", "bodyText": "For tests I don't always bother to try to find the optimal sequence if it's not important to the test. Also I prefer to do the save explicitly because in some of the tests it's at save time that a failure occurs, and hiding it inside the commit's flush wouldn't help make things obvious. Finally save + nextTransaction is already used in a number of other places in this same file.", "author": "efge", "createdAt": "2020-02-19T20:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ4OTA4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg1NDM3MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3764#discussion_r381854371", "bodyText": "OK, we really need to write these unit testing guidelines as such statements aren't always obvious.", "author": "ataillefer", "createdAt": "2020-02-20T08:44:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ4OTA4NA=="}], "type": "inlineReview"}]}