{"pr_number": 3735, "pr_title": "Fix nxp 28620 fix comment migration failure", "pr_createdAt": "2020-02-10T09:12:06Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3735", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk1MDk3Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r376950976", "bodyText": "because its parent. his is for humans", "author": "NourNuxeo", "createdAt": "2020-02-10T09:37:38Z", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java", "diffHunk": "@@ -250,6 +250,13 @@ protected void migrateCommentsFromPropertyToSecured(CoreSession session, Comment\n         }\n \n         DocumentRef parentDocRef = new IdRef(parentId);\n+        if (!session.exists(parentDocRef)) {\n+            log.warn(\n+                    \"The comment document model with IdRef: {} cannot be migrated, because his parent: {} cannot be found\",", "originalCommit": "79267f5373a8ff6849f17e4daad5e056ea497a10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c85a64bd7174b4f969d77311e774541caec56285", "url": "https://github.com/nuxeo/nuxeo/commit/c85a64bd7174b4f969d77311e774541caec56285", "message": "NXP-28620: Fix Comment Migration failure", "committedDate": "2020-02-10T10:48:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcwNjA1MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r377706051", "bodyText": "You assert everything has been caught (the 51 warns) but you don't assert there are only 51 (no duplicates, erronous messages). Maybe that would be overkill ? I leave it to you !", "author": "NourNuxeo", "createdAt": "2020-02-11T15:26:02Z", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/TestCommentsMigrator.java", "diffHunk": "@@ -233,6 +236,48 @@ public void testMigrationFromPropertyToSecuredWithCommentsNotCorrectlyFilled() {\n             assertTrue(caughtEventMessages.contains(message));\n             assertTrue(session.exists(new IdRef(docId)));\n         }\n+\n+    }\n+\n+    /**\n+     * Test the migration in the case where the {@code comment:parentId} is not empty, but it doesn't exist.\n+     */\n+    @Test\n+    @LogCaptureFeature.FilterOn(logLevel = \"WARN\")\n+    @Deploy(\"org.nuxeo.ecm.platform.comment.tests:OSGI-INF/disable-removing-comment-children-listener.xml\")\n+    public void testMigrationFromPropertyToSecuredWithRemovedParentComment() {\n+        // NB_COMMENTS_BY_FILE*4 + NB_COMMENT_TO_REPLY_ON_IT*NB_REPLY_BY_COMMENT (5 levels of reply) = 200 + 50\n+        createCommentsAsProperty(false, true);\n+\n+        // Second step of migrate: from 'Property' to 'Secured'\n+        migrateFromPropertyToSecured(new CommentsMigrator(), false, true);\n+        transactionalFeature.nextTransaction();\n+\n+        List<LogEvent> events = logCaptureResult.getCaughtEvents();\n+        assertEquals(NB_COMMENTS_BY_FILE + 1, events.size());\n+\n+        String query = String.format(\"SELECT %s FROM Comment WHERE %s = '%s'\", ECM_UUID, COMMENT_PARENT_ID,\n+                fileToCommentAndRemove.getId());\n+        List<String> unMigratedCommentDocIds = session.queryProjection(query, 0, 0)\n+                                                      .stream()\n+                                                      .map(m -> (String) m.get(ECM_UUID))\n+                                                      .collect(Collectors.toList());\n+\n+        // The comments not migrated should be there but, not under 'fileToCommentAndRemove'\n+        assertEquals(NB_COMMENTS_BY_FILE, unMigratedCommentDocIds.size());\n+        List<String> caughtEventMessages = logCaptureResult.getCaughtEventMessages();\n+\n+        assertTrue(caughtEventMessages.contains(String.format(\n+                \"Some comments have not been migrated, see logs for more information. The folder containing these comments will be renamed to %s\",\n+                UNMIGRATED_COMMENTS_FOLDER_NAME)));\n+\n+        for (String docId : unMigratedCommentDocIds) {\n+            String message = String.format(\n+                    \"The comment document model with IdRef: %s cannot be migrated, because its parent: %s cannot be found\",\n+                    docId, fileToCommentAndRemove.getId());\n+            assertTrue(caughtEventMessages.contains(message));", "originalCommit": "c85a64bd7174b4f969d77311e774541caec56285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0MjA3MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r377742071", "bodyText": "My idea here is to be sure that all my expected things are here not on the whole process, i mean if a new warn can be logged by another process (for example once who deploy, others services...) i will not be impacted by it as the main message will be logged as WARN. this a first thing in other hand have look here i check that the 50 comments will be not migrated", "author": "RSalem07", "createdAt": "2020-02-11T16:19:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcwNjA1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0NTI4OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r377745289", "bodyText": "My question is about asserting the number of warns generated introduced by your changes is equal and not superior to the number of comments not migrated, I'm not talking about checking the effective comments non-migrated as you already assert you have the right warn for each one.\nIt's up to you as I said !", "author": "NourNuxeo", "createdAt": "2020-02-11T16:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcwNjA1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1NzIzOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r377757239", "bodyText": "yes this check is already done see here this check ensure that at least i have the warn messages of my comments but to check the inverse i don't think is really needed", "author": "RSalem07", "createdAt": "2020-02-11T16:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcwNjA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4MTI2OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r378181268", "bodyText": "Not sure about this change.", "author": "kevinleturc", "createdAt": "2020-02-12T11:02:27Z", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java", "diffHunk": "@@ -215,22 +215,22 @@ protected void migrateSessionPropertyToSecured(CoreSession session, MigrationCon\n \n             session.removeDocuments(documentsToRemove);\n \n-            reportProgress(\"Done Migrating from Property to Secured\", totalOfComments, totalOfComments);\n+            reportProgress(\"Done Migration from Property to Secured\", totalOfComments, totalOfComments);", "originalCommit": "c85a64bd7174b4f969d77311e774541caec56285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4NjA3Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r378186077", "bodyText": "this was a warning of my spell checking IDE plugin, and i changed it. if you want i can rollback this part", "author": "RSalem07", "createdAt": "2020-02-12T11:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4MTI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4NzIzNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r378187237", "bodyText": "Probably because your dictionary doesn't have this word, it can happen. Yes, I'm in favor of not changing it and adding the word to the dictionary to remove the warning.", "author": "kevinleturc", "createdAt": "2020-02-12T11:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4MTI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4NzgyNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r378187826", "bodyText": "The first one seems more correct. If spell checking is not happy maybe you can say\n\n\"Migrated from Property to Secured\"", "author": "NourNuxeo", "createdAt": "2020-02-12T11:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4MTI2OA=="}], "type": "inlineReview"}, {"oid": "3207438757649752625f73af4896302f0c7cec90", "url": "https://github.com/nuxeo/nuxeo/commit/3207438757649752625f73af4896302f0c7cec90", "message": "NXP-28620: Cleanup / Format", "committedDate": "2020-02-12T13:24:45Z", "type": "commit"}, {"oid": "5422a4bdd9792f109f9f2337afdb86562354200b", "url": "https://github.com/nuxeo/nuxeo/commit/5422a4bdd9792f109f9f2337afdb86562354200b", "message": "NXP-28620: Fix Comment Migration failure", "committedDate": "2020-02-12T13:24:45Z", "type": "commit"}, {"oid": "5422a4bdd9792f109f9f2337afdb86562354200b", "url": "https://github.com/nuxeo/nuxeo/commit/5422a4bdd9792f109f9f2337afdb86562354200b", "message": "NXP-28620: Fix Comment Migration failure", "committedDate": "2020-02-12T13:24:45Z", "type": "forcePushed"}]}