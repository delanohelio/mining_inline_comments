{"pr_number": 4451, "pr_title": "NXP-29689: fix null version for copied documents", "pr_createdAt": "2020-11-09T13:09:35Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4451", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgzNTYzMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4451#discussion_r519835631", "bodyText": "You could have an extra line for readability/debugging purpose:\nDocumentRef sourceRef = session.checkIn(source.getRef(), VersioningOption.MAJOR, null);\n\nAlso, I would pass null or a non-empty comment as check-in comment.", "author": "ataillefer", "createdAt": "2020-11-09T14:02:08Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-core/src/test/java/org/nuxeo/ecm/automation/core/operations/document/CopyDocumentTest.java", "diffHunk": "@@ -129,4 +130,27 @@ public void testLifeCycleResetOnCopy() throws OperationException {\n             assertEquals(initialLifeCycleState, result.getCurrentLifeCycleState());\n         }\n     }\n+\n+    @Test\n+    public void testVersionNotNullOnCopy() throws OperationException {\n+        DocumentModel source = session.createDocumentModel(ROOT, \"Source\", FILE);\n+        source = session.createDocument(source);\n+        source = session.getDocument(session.checkIn(source.getRef(), VersioningOption.MAJOR, \"\"));", "originalCommit": "027bc1863744c052ed268de8bbfa06261fbdda9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1MjUzOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4451#discussion_r519852539", "bodyText": "In fact, is there any point in versioning the created document and verifying its version numbers?\nAren't we only interested in the copied document in this test?", "author": "ataillefer", "createdAt": "2020-11-09T14:26:30Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-core/src/test/java/org/nuxeo/ecm/automation/core/operations/document/CopyDocumentTest.java", "diffHunk": "@@ -129,4 +130,27 @@ public void testLifeCycleResetOnCopy() throws OperationException {\n             assertEquals(initialLifeCycleState, result.getCurrentLifeCycleState());\n         }\n     }\n+\n+    @Test\n+    public void testVersionNotNullOnCopy() throws OperationException {\n+        DocumentModel source = session.createDocumentModel(ROOT, \"Source\", FILE);\n+        source = session.createDocument(source);\n+        source = session.getDocument(session.checkIn(source.getRef(), VersioningOption.MAJOR, \"\"));\n+\n+        assertEquals(1, (long) source.getPropertyValue(\"uid:major_version\"));\n+        assertEquals(0, (long) source.getPropertyValue(\"uid:minor_version\"));", "originalCommit": "027bc1863744c052ed268de8bbfa06261fbdda9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1MzYyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4451#discussion_r519853629", "bodyText": "This line is not needed since you're directly manipulating the output document of the Automation service call (not passing through the HTTP layer to execute the operation then re-fetching the document afterwards).", "author": "ataillefer", "createdAt": "2020-11-09T14:27:53Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-core/src/test/java/org/nuxeo/ecm/automation/core/operations/document/CopyDocumentTest.java", "diffHunk": "@@ -129,4 +130,27 @@ public void testLifeCycleResetOnCopy() throws OperationException {\n             assertEquals(initialLifeCycleState, result.getCurrentLifeCycleState());\n         }\n     }\n+\n+    @Test\n+    public void testVersionNotNullOnCopy() throws OperationException {\n+        DocumentModel source = session.createDocumentModel(ROOT, \"Source\", FILE);\n+        source = session.createDocument(source);\n+        source = session.getDocument(session.checkIn(source.getRef(), VersioningOption.MAJOR, \"\"));\n+\n+        assertEquals(1, (long) source.getPropertyValue(\"uid:major_version\"));\n+        assertEquals(0, (long) source.getPropertyValue(\"uid:minor_version\"));\n+\n+        Map<String, Serializable> params = Map.of(TARGET_PROPERTY_KEY, ROOT, NAME_PROPERTY_KEY, COPY_DOC_NAME);\n+\n+        try (OperationContext context = new OperationContext(session)) {\n+            context.setInput(source);\n+            DocumentModel result = (DocumentModel) automationService.run(context, CopyDocument.ID, params);\n+            txFeature.nextTransaction();", "originalCommit": "027bc1863744c052ed268de8bbfa06261fbdda9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cef8600866baa0499edd39836e645393b6b3bd53", "url": "https://github.com/nuxeo/nuxeo/commit/cef8600866baa0499edd39836e645393b6b3bd53", "message": "NXP-29689: fix null version for copied documents", "committedDate": "2020-11-09T15:47:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzODUyNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4451#discussion_r520538527", "bodyText": "Please start the method name with test instead of check. This makes it easier when navigating or searching to isolate test methods from others, and is the convention we have in most of our code.", "author": "efge", "createdAt": "2020-11-10T12:52:55Z", "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryVersioning.java", "diffHunk": "@@ -610,6 +610,17 @@ public void testVersionLabelOfCopy() {\n         assertEquals(\"0.1\", version.getVersionLabel());\n     }\n \n+    @Test\n+    public void checkVersionNotNullOnCopy() {", "originalCommit": "cef8600866baa0499edd39836e645393b6b3bd53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzOTE4OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4451#discussion_r520539189", "bodyText": "Remove extra empty line.", "author": "efge", "createdAt": "2020-11-10T12:53:55Z", "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryVersioning.java", "diffHunk": "@@ -610,6 +610,17 @@ public void testVersionLabelOfCopy() {\n         assertEquals(\"0.1\", version.getVersionLabel());\n     }\n \n+    @Test\n+    public void checkVersionNotNullOnCopy() {\n+        DocumentModel doc = session.createDocumentModel(\"/\", \"file\", \"File\");\n+        doc = session.createDocument(doc);\n+        session.save();\n+        DocumentModel copy = session.copy(doc.getRef(), new PathRef(\"/\"), \"copy\");\n+        assertEquals(0, (long) copy.getPropertyValue(\"uid:major_version\"));\n+        assertEquals(0, (long) copy.getPropertyValue(\"uid:minor_version\"));\n+", "originalCommit": "cef8600866baa0499edd39836e645393b6b3bd53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MjEzOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4451#discussion_r520542138", "bodyText": "Remove extra empty line.", "author": "efge", "createdAt": "2020-11-10T12:58:42Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-core/src/test/java/org/nuxeo/ecm/automation/core/operations/document/CopyDocumentTest.java", "diffHunk": "@@ -129,4 +129,22 @@ public void testLifeCycleResetOnCopy() throws OperationException {\n             assertEquals(initialLifeCycleState, result.getCurrentLifeCycleState());\n         }\n     }\n+\n+    @Test\n+    public void testVersionNotNullOnCopy() throws OperationException {\n+        DocumentModel source = session.createDocumentModel(ROOT, \"Source\", FILE);\n+        source = session.createDocument(source);\n+\n+        Map<String, Serializable> params = Map.of(TARGET_PROPERTY_KEY, ROOT, NAME_PROPERTY_KEY, COPY_DOC_NAME);\n+\n+        try (OperationContext context = new OperationContext(session)) {\n+            context.setInput(source);\n+            DocumentModel result = (DocumentModel) automationService.run(context, CopyDocument.ID, params);\n+\n+            assertEquals(0, (long) result.getPropertyValue(\"uid:major_version\"));\n+            assertEquals(0, (long) result.getPropertyValue(\"uid:minor_version\"));\n+        }\n+", "originalCommit": "cef8600866baa0499edd39836e645393b6b3bd53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ff43ea8f49dcce7795e0385ea3cb3eedf8749ec", "url": "https://github.com/nuxeo/nuxeo/commit/1ff43ea8f49dcce7795e0385ea3cb3eedf8749ec", "message": "NXP-29689: fix null version for copied documents", "committedDate": "2020-11-10T13:03:57Z", "type": "commit"}, {"oid": "1ff43ea8f49dcce7795e0385ea3cb3eedf8749ec", "url": "https://github.com/nuxeo/nuxeo/commit/1ff43ea8f49dcce7795e0385ea3cb3eedf8749ec", "message": "NXP-29689: fix null version for copied documents", "committedDate": "2020-11-10T13:03:57Z", "type": "forcePushed"}]}