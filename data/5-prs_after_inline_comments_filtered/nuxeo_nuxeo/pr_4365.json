{"pr_number": 4365, "pr_title": "NXP-29670: Enforce Workflow Activation Filter", "pr_createdAt": "2020-10-09T03:41:39Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4365", "timeline": [{"oid": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "url": "https://github.com/nuxeo/nuxeo/commit/14af41b34ae85e9b8e171aa2bebfaa1031e63371", "message": "NXP-29670: Enforce Workflow Activation Filter", "committedDate": "2020-10-09T03:44:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTA5Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502949093", "bodyText": "This will need to be updated to @since 11.4 now everywhere.", "author": "efge", "createdAt": "2020-10-11T18:24:15Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-api/src/main/java/org/nuxeo/ecm/platform/routing/api/DocumentRoutingService.java", "diffHunk": "@@ -622,4 +622,19 @@ void grantPermissionToTaskDelegatedActors(CoreSession session, String permission\n      */\n     boolean isWorkflowModel(final DocumentRoute documentRoute);\n \n+    /**\n+     * Returns true if the workflowModel can be started on the document list\n+     * @param documentIds\n+     * @param worflowModelName\n+     * @since 11.3", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODI0Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503108243", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTA5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTIwMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502949203", "bodyText": "Returns {@code true} if the workflow model can be started on the document list.", "author": "efge", "createdAt": "2020-10-11T18:25:11Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-api/src/main/java/org/nuxeo/ecm/platform/routing/api/DocumentRoutingService.java", "diffHunk": "@@ -622,4 +622,19 @@ void grantPermissionToTaskDelegatedActors(CoreSession session, String permission\n      */\n     boolean isWorkflowModel(final DocumentRoute documentRoute);\n \n+    /**\n+     * Returns true if the workflowModel can be started on the document list", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODMwMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503108303", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzIwNzEyMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503207121", "bodyText": "Thanks. Just a \ud83d\udc4d on my comment and resolving the conversation is enough notification for me \ud83d\ude00", "author": "efge", "createdAt": "2020-10-12T10:45:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTI2MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502949260", "bodyText": "Returns a list of runnable document routes for the input document IDs.", "author": "efge", "createdAt": "2020-10-11T18:25:42Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-api/src/main/java/org/nuxeo/ecm/platform/routing/api/DocumentRoutingService.java", "diffHunk": "@@ -622,4 +622,19 @@ void grantPermissionToTaskDelegatedActors(CoreSession session, String permission\n      */\n     boolean isWorkflowModel(final DocumentRoute documentRoute);\n \n+    /**\n+     * Returns true if the workflowModel can be started on the document list\n+     * @param documentIds\n+     * @param worflowModelName\n+     * @since 11.3\n+     */\n+    boolean canCreateInstance(CoreSession session, List<String> documentIds, String worflowModelName);\n+\n+    /**\n+     * Returns a list of runnable DocumentRoute for the input document IDs", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODQ4MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503108481", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTM1NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502949355", "bodyText": "the the ->the\nMaybe log the ids too in the exception?", "author": "efge", "createdAt": "2020-10-11T18:26:44Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/api/operation/StartWorkflowOperation.java", "diffHunk": "@@ -97,6 +98,10 @@ public DocumentModel run(DocumentModel doc) {\n     }\n \n     protected void startNewInstance(List<String> ids) {\n+        if (!documentRoutingService.canCreateInstance(session, ids, id)) {\n+            throw new NuxeoException(\n+                    String.format(\"Cannot start the the worflow model %s for the input documents\", id));", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODU4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503108587", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTQ2OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502949469", "bodyText": "No need for Javadoc on the implementation, it's already on the interface.", "author": "efge", "createdAt": "2020-10-11T18:28:02Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/impl/DocumentRoutingServiceImpl.java", "diffHunk": "@@ -1388,4 +1392,52 @@ public void invalidateRouteModelsCache() {\n     public boolean isWorkflowModel(final DocumentRoute documentRoute) {\n         return documentRoute.isValidated();\n     }\n+\n+    /**\n+     * @since 11.3\n+     */\n+    @Override", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODY0NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503108644", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTY1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502949650", "bodyText": "Move the definition of docs further down, just before its use.", "author": "efge", "createdAt": "2020-10-11T18:29:18Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/impl/DocumentRoutingServiceImpl.java", "diffHunk": "@@ -1388,4 +1392,52 @@ public void invalidateRouteModelsCache() {\n     public boolean isWorkflowModel(final DocumentRoute documentRoute) {\n         return documentRoute.isValidated();\n     }\n+\n+    /**\n+     * @since 11.3\n+     */\n+    @Override\n+    public boolean canCreateInstance(CoreSession session, List<String> documentIds, String workflowModelName) {\n+\n+        DocumentModelList docs = session.getDocuments(documentIds.stream().map(IdRef::new).toArray(DocumentRef[]::new));", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODc0NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503108744", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk0OTY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MDM5NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502950394", "bodyText": "Please rename to WorkflowActivationFilterTest.", "author": "efge", "createdAt": "2020-10-11T18:35:38Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/WorkflowActivationFilter.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Guillaume Renard\n+ *     Michael Vachette\n+ */\n+package org.nuxeo.ecm.platform.routing.test;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoutingService;\n+import org.nuxeo.ecm.platform.routing.core.impl.GraphNode;\n+import org.nuxeo.ecm.platform.routing.core.impl.GraphRoute;\n+import org.nuxeo.ecm.webengine.test.WebEngineFeatureCore;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+/**\n+ * @since 11.3\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ WorkflowFeature.class, WebEngineFeatureCore.class })\n+@Deploy(\"org.nuxeo.ecm.platform.routing.core:OSGI-INF/test-document-routing-activation-filters.xml\")\n+public class WorkflowActivationFilter extends AbstractGraphRouteTest {", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwODc5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503108790", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MDM5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MDQzMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502950430", "bodyText": "protected (same below)", "author": "efge", "createdAt": "2020-10-11T18:36:01Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/WorkflowActivationFilter.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Guillaume Renard\n+ *     Michael Vachette\n+ */\n+package org.nuxeo.ecm.platform.routing.test;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoutingService;\n+import org.nuxeo.ecm.platform.routing.core.impl.GraphNode;\n+import org.nuxeo.ecm.platform.routing.core.impl.GraphRoute;\n+import org.nuxeo.ecm.webengine.test.WebEngineFeatureCore;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+/**\n+ * @since 11.3\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ WorkflowFeature.class, WebEngineFeatureCore.class })\n+@Deploy(\"org.nuxeo.ecm.platform.routing.core:OSGI-INF/test-document-routing-activation-filters.xml\")\n+public class WorkflowActivationFilter extends AbstractGraphRouteTest {\n+\n+    @Inject\n+    CoreSession session;", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwOTAwNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503109007", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MDQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MDQ4OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502950488", "bodyText": "Setting the title is probably not necessary for the test.", "author": "efge", "createdAt": "2020-10-11T18:36:31Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/WorkflowActivationFilter.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Guillaume Renard\n+ *     Michael Vachette\n+ */\n+package org.nuxeo.ecm.platform.routing.test;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoutingService;\n+import org.nuxeo.ecm.platform.routing.core.impl.GraphNode;\n+import org.nuxeo.ecm.platform.routing.core.impl.GraphRoute;\n+import org.nuxeo.ecm.webengine.test.WebEngineFeatureCore;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+/**\n+ * @since 11.3\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ WorkflowFeature.class, WebEngineFeatureCore.class })\n+@Deploy(\"org.nuxeo.ecm.platform.routing.core:OSGI-INF/test-document-routing-activation-filters.xml\")\n+public class WorkflowActivationFilter extends AbstractGraphRouteTest {\n+\n+    @Inject\n+    CoreSession session;\n+\n+    @Inject\n+    DocumentRoutingService routing;\n+\n+    @Before\n+    public void setUp() {\n+        doc = session.createDocumentModel(\"/\", \"file\", \"File\");\n+        doc.setPropertyValue(\"dc:title\", \"file\");", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwOTEwOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503109108", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MDQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MDY2Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502950663", "bodyText": "Please do a static import of all the assert* methods.", "author": "efge", "createdAt": "2020-10-11T18:38:09Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/WorkflowActivationFilter.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Guillaume Renard\n+ *     Michael Vachette\n+ */\n+package org.nuxeo.ecm.platform.routing.test;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoutingService;\n+import org.nuxeo.ecm.platform.routing.core.impl.GraphNode;\n+import org.nuxeo.ecm.platform.routing.core.impl.GraphRoute;\n+import org.nuxeo.ecm.webengine.test.WebEngineFeatureCore;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+/**\n+ * @since 11.3\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ WorkflowFeature.class, WebEngineFeatureCore.class })\n+@Deploy(\"org.nuxeo.ecm.platform.routing.core:OSGI-INF/test-document-routing-activation-filters.xml\")\n+public class WorkflowActivationFilter extends AbstractGraphRouteTest {\n+\n+    @Inject\n+    CoreSession session;\n+\n+    @Inject\n+    DocumentRoutingService routing;\n+\n+    @Before\n+    public void setUp() {\n+        doc = session.createDocumentModel(\"/\", \"file\", \"File\");\n+        doc.setPropertyValue(\"dc:title\", \"file\");\n+        doc = session.createDocument(doc);\n+    }\n+\n+    public void setRoute(String activationFiltername) {\n+        routeDoc = createRoute(\"myroute\", session);\n+        DocumentModel node1 = createNode(routeDoc, \"node1\", session);\n+        node1.setPropertyValue(GraphNode.PROP_START, Boolean.TRUE);\n+        node1.setPropertyValue(GraphNode.PROP_STOP, Boolean.TRUE);\n+        session.saveDocument(node1);\n+        routeDoc.setPropertyValue(GraphRoute.PROP_VARIABLES_FACET, \"FacetRoute1\");\n+        routeDoc.setPropertyValue(GraphRoute.PROP_AVAILABILITY_FILTER, activationFiltername);\n+        routeDoc.addFacet(\"FacetRoute1\");\n+        routeDoc = session.saveDocument(routeDoc);\n+        validate(routeDoc, session);\n+    }\n+\n+    @Test\n+    public void testWorkflowWithoutFilterCanBeStarted() {\n+        setRoute(null);\n+        Assert.assertTrue(routing.canCreateInstance(session, List.of(doc.getId()), routeDoc.getName()));", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwOTE3Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503109176", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MDY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MTA0NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502951044", "bodyText": "Please put ctx.getCoreSession(), workflowRequest.getAttachedDocumentIds() and workflowRequest.getWorkflowModelName(), which are used several times, in local variables.\ngetContext().getCoreSession() could also use the same session local variable.", "author": "efge", "createdAt": "2020-10-11T18:41:48Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/routing/WorkflowObject.java", "diffHunk": "@@ -67,12 +67,17 @@ protected void initialize(Object... args) {\n \n     @POST\n     public Response createWorkflowInstance(WorkflowRequest workflowRequest) {\n-        final String workflowInstanceId = documentRoutingService.createNewInstance(\n-                workflowRequest.getWorkflowModelName(), workflowRequest.getAttachedDocumentIds(),\n-                workflowRequest.getVariables(), ctx.getCoreSession(), true);\n-        DocumentModel workflowInstance = getContext().getCoreSession().getDocument(new IdRef(workflowInstanceId));\n-        DocumentRoute route = workflowInstance.getAdapter(DocumentRoute.class);\n-        return Response.ok(route).status(Status.CREATED).build();\n+        if (documentRoutingService.canCreateInstance(ctx.getCoreSession(), workflowRequest.getAttachedDocumentIds(),", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwOTI0Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503109242", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:03:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MTA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MTE5Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502951192", "bodyText": "Same comment about local variables than in WorkflowObject.", "author": "efge", "createdAt": "2020-10-11T18:43:49Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/routing/adapter/WorkflowAdapter.java", "diffHunk": "@@ -50,13 +50,18 @@\n     @POST\n     public Response doPost(WorkflowRequest routingRequest) {\n         DocumentModel doc = getTarget().getAdapter(DocumentModel.class);\n-        final String workflowInstanceId = Framework.getService(DocumentRoutingService.class)\n-                                                   .createNewInstance(routingRequest.getWorkflowModelName(),\n-                                                           List.of(doc.getId()), routingRequest.getVariables(),\n-                                                           ctx.getCoreSession(), true);\n-        DocumentModel result = getContext().getCoreSession().getDocument(new IdRef(workflowInstanceId));\n-        DocumentRoute route = result.getAdapter(DocumentRoute.class);\n-        return Response.ok(route).status(Status.CREATED).build();\n+        DocumentRoutingService documentRoutingService = Framework.getService(DocumentRoutingService.class);\n+        if (documentRoutingService.canCreateInstance(doc.getCoreSession(), List.of(doc.getId()),", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwOTMxNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503109316", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MTE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MTIyMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502951221", "bodyText": "final can be removed while we're changing this code.", "author": "efge", "createdAt": "2020-10-11T18:44:07Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/routing/adapter/WorkflowAdapter.java", "diffHunk": "@@ -50,13 +50,18 @@\n     @POST\n     public Response doPost(WorkflowRequest routingRequest) {\n         DocumentModel doc = getTarget().getAdapter(DocumentModel.class);\n-        final String workflowInstanceId = Framework.getService(DocumentRoutingService.class)\n-                                                   .createNewInstance(routingRequest.getWorkflowModelName(),\n-                                                           List.of(doc.getId()), routingRequest.getVariables(),\n-                                                           ctx.getCoreSession(), true);\n-        DocumentModel result = getContext().getCoreSession().getDocument(new IdRef(workflowInstanceId));\n-        DocumentRoute route = result.getAdapter(DocumentRoute.class);\n-        return Response.ok(route).status(Status.CREATED).build();\n+        DocumentRoutingService documentRoutingService = Framework.getService(DocumentRoutingService.class);\n+        if (documentRoutingService.canCreateInstance(doc.getCoreSession(), List.of(doc.getId()),\n+                routingRequest.getWorkflowModelName())) {\n+            final String workflowInstanceId = documentRoutingService.createNewInstance(", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwOTQxNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503109414", "bodyText": "done", "author": "michaelva", "createdAt": "2020-10-12T08:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MTIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MTQzOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r502951439", "bodyText": "I'm not sure about FORBIDDEN here, does @nelsonsilva or @nuxeo/platform have an opinion with respect to REST API best practices? Maybe a 400?", "author": "efge", "createdAt": "2020-10-11T18:45:54Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/routing/WorkflowObject.java", "diffHunk": "@@ -67,12 +67,17 @@ protected void initialize(Object... args) {\n \n     @POST\n     public Response createWorkflowInstance(WorkflowRequest workflowRequest) {\n-        final String workflowInstanceId = documentRoutingService.createNewInstance(\n-                workflowRequest.getWorkflowModelName(), workflowRequest.getAttachedDocumentIds(),\n-                workflowRequest.getVariables(), ctx.getCoreSession(), true);\n-        DocumentModel workflowInstance = getContext().getCoreSession().getDocument(new IdRef(workflowInstanceId));\n-        DocumentRoute route = workflowInstance.getAdapter(DocumentRoute.class);\n-        return Response.ok(route).status(Status.CREATED).build();\n+        if (documentRoutingService.canCreateInstance(ctx.getCoreSession(), workflowRequest.getAttachedDocumentIds(),\n+                workflowRequest.getWorkflowModelName())) {\n+            final String workflowInstanceId = documentRoutingService.createNewInstance(\n+                    workflowRequest.getWorkflowModelName(), workflowRequest.getAttachedDocumentIds(),\n+                    workflowRequest.getVariables(), ctx.getCoreSession(), true);\n+            DocumentModel workflowInstance = getContext().getCoreSession().getDocument(new IdRef(workflowInstanceId));\n+            DocumentRoute route = workflowInstance.getAdapter(DocumentRoute.class);\n+            return Response.ok(route).status(Status.CREATED).build();\n+        } else {\n+            return Response.status(Status.FORBIDDEN).build();", "originalCommit": "14af41b34ae85e9b8e171aa2bebfaa1031e63371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQwNTM4MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r503405381", "bodyText": "@michaelva after some discussions it seems that Status.BAD_REQUEST would be better.", "author": "efge", "createdAt": "2020-10-12T16:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk1MTQzOQ=="}], "type": "inlineReview"}, {"oid": "12cddb5dae961495322e89cc3b408cd63e79273a", "url": "https://github.com/nuxeo/nuxeo/commit/12cddb5dae961495322e89cc3b408cd63e79273a", "message": "NXP-29670: Enforce Workflow Activation Filter", "committedDate": "2020-10-12T07:59:55Z", "type": "forcePushed"}, {"oid": "b4e3ed0145a8bd3fb5532d9c6d421dcf0f727a26", "url": "https://github.com/nuxeo/nuxeo/commit/b4e3ed0145a8bd3fb5532d9c6d421dcf0f727a26", "message": "NXP-29670: Enforce Workflow Activation Filter", "committedDate": "2020-10-12T23:52:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1NjM0NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r508456345", "bodyText": "To remove.", "author": "kevinleturc", "createdAt": "2020-10-20T12:25:46Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-api/src/main/java/org/nuxeo/ecm/platform/routing/api/DocumentRoutingService.java", "diffHunk": "@@ -622,4 +622,19 @@ void grantPermissionToTaskDelegatedActors(CoreSession session, String permission\n      */\n     boolean isWorkflowModel(final DocumentRoute documentRoute);\n \n+    /**\n+     * Returns {@code true} if the workflow model can be started on the document list.\n+     * @param documentIds\n+     * @param worflowModelName", "originalCommit": "b4e3ed0145a8bd3fb5532d9c6d421dcf0f727a26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1NjQ1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r508456450", "bodyText": "To remove.", "author": "kevinleturc", "createdAt": "2020-10-20T12:25:56Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-api/src/main/java/org/nuxeo/ecm/platform/routing/api/DocumentRoutingService.java", "diffHunk": "@@ -622,4 +622,19 @@ void grantPermissionToTaskDelegatedActors(CoreSession session, String permission\n      */\n     boolean isWorkflowModel(final DocumentRoute documentRoute);\n \n+    /**\n+     * Returns {@code true} if the workflow model can be started on the document list.\n+     * @param documentIds\n+     * @param worflowModelName\n+     * @since 11.4\n+     */\n+    boolean canCreateInstance(CoreSession session, List<String> documentIds, String worflowModelName);\n+\n+    /**\n+     * Returns a list of runnable document routes for the input document IDs.\n+     * @param documentIds", "originalCommit": "b4e3ed0145a8bd3fb5532d9c6d421dcf0f727a26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MDU0MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r508460541", "bodyText": "Missing newline between description and @param.", "author": "troger", "createdAt": "2020-10-20T12:32:20Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-api/src/main/java/org/nuxeo/ecm/platform/routing/api/DocumentRoutingService.java", "diffHunk": "@@ -622,4 +622,19 @@ void grantPermissionToTaskDelegatedActors(CoreSession session, String permission\n      */\n     boolean isWorkflowModel(final DocumentRoute documentRoute);\n \n+    /**\n+     * Returns {@code true} if the workflow model can be started on the document list.\n+     * @param documentIds", "originalCommit": "b4e3ed0145a8bd3fb5532d9c6d421dcf0f727a26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MDU5NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4365#discussion_r508460594", "bodyText": "Missing newline between description and @param.", "author": "troger", "createdAt": "2020-10-20T12:32:24Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-api/src/main/java/org/nuxeo/ecm/platform/routing/api/DocumentRoutingService.java", "diffHunk": "@@ -622,4 +622,19 @@ void grantPermissionToTaskDelegatedActors(CoreSession session, String permission\n      */\n     boolean isWorkflowModel(final DocumentRoute documentRoute);\n \n+    /**\n+     * Returns {@code true} if the workflow model can be started on the document list.\n+     * @param documentIds\n+     * @param worflowModelName\n+     * @since 11.4\n+     */\n+    boolean canCreateInstance(CoreSession session, List<String> documentIds, String worflowModelName);\n+\n+    /**\n+     * Returns a list of runnable document routes for the input document IDs.\n+     * @param documentIds", "originalCommit": "b4e3ed0145a8bd3fb5532d9c6d421dcf0f727a26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "92f83c98e9457024cb3258bc1dc57c7777477bdb", "url": "https://github.com/nuxeo/nuxeo/commit/92f83c98e9457024cb3258bc1dc57c7777477bdb", "message": "NXP-29670: Enforce Workflow Activation Filter", "committedDate": "2020-10-21T13:03:02Z", "type": "forcePushed"}, {"oid": "447c1d95e1fc62624d5a0fe74fc6b24469650690", "url": "https://github.com/nuxeo/nuxeo/commit/447c1d95e1fc62624d5a0fe74fc6b24469650690", "message": "NXP-29670: Enforce Workflow Activation Filter", "committedDate": "2020-10-28T09:25:52Z", "type": "commit"}, {"oid": "447c1d95e1fc62624d5a0fe74fc6b24469650690", "url": "https://github.com/nuxeo/nuxeo/commit/447c1d95e1fc62624d5a0fe74fc6b24469650690", "message": "NXP-29670: Enforce Workflow Activation Filter", "committedDate": "2020-10-28T09:25:52Z", "type": "forcePushed"}]}