{"pr_number": 3843, "pr_title": "NXP-28600: add WriteColdStorage permission", "pr_createdAt": "2020-03-18T09:52:18Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3843", "timeline": [{"oid": "c2b075a5344fe335d6c315aa2efe39831151bd5d", "url": "https://github.com/nuxeo/nuxeo/commit/c2b075a5344fe335d6c315aa2efe39831151bd5d", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-18T15:02:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NzU1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394497552", "bodyText": "You don't need to check session.getPrincipal().isAdministrator(), as hasPermission already takes administrators into account.", "author": "efge", "createdAt": "2020-03-18T16:54:22Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -71,24 +73,27 @@\n \n     /**\n      * Moves the main content associated with the document of the given {@link DocumentRef} to a cold storage.\n+     * The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required.\n      *\n      * @return the updated document model if the move succeeds\n      * @throws NuxeoException if the main content is already in the cold storage, or if there is no main content\n      *             associated with the given document\n      */\n     public static DocumentModel moveContentToColdStorage(CoreSession session, DocumentRef documentRef) {\n         DocumentModel documentModel = session.getDocument(documentRef);\n+        Serializable mainContent = documentModel.getPropertyValue(FILE_CONTENT_PROPERTY);\n         log.debug(\"Move to cold storage the main content of document: {}\", documentModel);\n \n-        if (documentModel.hasFacet(FacetNames.COLD_STORAGE)\n+        if (!session.getPrincipal().isAdministrator()\n+                && !session.hasPermission(documentRef, SecurityConstants.WRITE_COLD_STORAGE)) {", "originalCommit": "c2b075a5344fe335d6c315aa2efe39831151bd5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0NTE5Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394545197", "bodyText": "Thanks! \ud83d\udc4d", "author": "nmpcunha", "createdAt": "2020-03-18T18:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NzU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5OTIwNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394499206", "bodyText": "Please remove the two else that you added, error checks are \"early exit\" cases and can be standalone.\nIt will also make the diff simpler.", "author": "efge", "createdAt": "2020-03-18T16:56:50Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -71,24 +73,27 @@\n \n     /**\n      * Moves the main content associated with the document of the given {@link DocumentRef} to a cold storage.\n+     * The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required.\n      *\n      * @return the updated document model if the move succeeds\n      * @throws NuxeoException if the main content is already in the cold storage, or if there is no main content\n      *             associated with the given document\n      */\n     public static DocumentModel moveContentToColdStorage(CoreSession session, DocumentRef documentRef) {\n         DocumentModel documentModel = session.getDocument(documentRef);\n+        Serializable mainContent = documentModel.getPropertyValue(FILE_CONTENT_PROPERTY);\n         log.debug(\"Move to cold storage the main content of document: {}\", documentModel);\n \n-        if (documentModel.hasFacet(FacetNames.COLD_STORAGE)\n+        if (!session.getPrincipal().isAdministrator()\n+                && !session.hasPermission(documentRef, SecurityConstants.WRITE_COLD_STORAGE)) {\n+            throw new NuxeoException(String.format(\"The document cannot be moved to cold storage\", documentRef),\n+                    SC_FORBIDDEN);\n+        } else if (documentModel.hasFacet(FacetNames.COLD_STORAGE)", "originalCommit": "c2b075a5344fe335d6c315aa2efe39831151bd5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUwMDQ3MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394500471", "bodyText": "Remove the catch/fail, just let the test method throw the exception if there's a problem.", "author": "efge", "createdAt": "2020-03-18T16:58:41Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -109,6 +119,50 @@ public void shouldMoveToColdStorage() throws IOException {\n         assertEquals(\"dummy\", ((ManagedBlob) content).getProviderId());\n     }\n \n+    @Test\n+    public void shouldMoveToColdStorageWhenUserHaveWriteColdStoragePermission() throws IOException {\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        ACP acp = documentModel.getACP();\n+        ACL acl = acp.getOrCreateACL();\n+        acl.add(new ACE(\"john\", SecurityConstants.READ, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true));\n+        documentModel.setACP(acp, true);\n+\n+        try (CloseableCoreSession userSession = coreFeature.openCoreSession(\"john\")) {\n+            documentModel = ColdStorageHelper.moveContentToColdStorage(userSession, documentModel.getRef());\n+            userSession.saveDocument(documentModel);\n+            transactionalFeature.nextTransaction();\n+            documentModel.refresh();\n+\n+            assertTrue(documentModel.hasFacet(FacetNames.COLD_STORAGE));\n+            assertNull(documentModel.getPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY));\n+\n+            // check if the `coldstorage:coldContent` property contains the original file content\n+            Blob content = (Blob) documentModel.getPropertyValue(ColdStorageHelper.COLD_STORAGE_CONTENT_PROPERTY);\n+            assertNotNull(content);\n+            assertEquals(FILE_CONTENT, content.getString());\n+        } catch (NuxeoException e) {\n+            fail(\"It was not expected a failure while moving document to cold storage since user has the required permissions\");", "originalCommit": "c2b075a5344fe335d6c315aa2efe39831151bd5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUwMTM1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394501352", "bodyText": "Remove the catch/fail, just let the test method throw the exception if there's a problem.", "author": "efge", "createdAt": "2020-03-18T16:59:57Z", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorageTest.java", "diffHunk": "@@ -42,8 +50,44 @@\n     @Inject\n     protected CoreSession session;\n \n+    @Inject\n+    protected CoreFeature coreFeature;\n+\n+    @Test\n+    public void shouldFailWhenUserDoNotHaveWriteColdStoragePermission() throws OperationException, IOException {\n+        DocumentModel documentModel = createFileDocument(session, true);\n+        ACP acp = documentModel.getACP();\n+        ACL acl = acp.getOrCreateACL();\n+        acl.add(new ACE(\"john\", SecurityConstants.READ, true));\n+        documentModel.setACP(acp, true);\n+\n+        try (CloseableCoreSession userSession = coreFeature.openCoreSession(\"john\")) {\n+            moveContentToColdStorage(userSession, documentModel);\n+            fail(\"Should fail because the user does not have permissions to move document to cold storage\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+        }\n+    }\n+\n+    @Test\n+    public void shouldSucceedWhenUserHaveWriteColdStoragePermission() throws OperationException, IOException {\n+        DocumentModel documentModel = createFileDocument(session, true);\n+        ACP acp = documentModel.getACP();\n+        ACL acl = acp.getOrCreateACL();\n+        acl.add(new ACE(\"john\", SecurityConstants.READ, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true));\n+        documentModel.setACP(acp, true);\n+\n+        try (CloseableCoreSession userSession = coreFeature.openCoreSession(\"john\")) {\n+            moveContentToColdStorage(userSession, documentModel);\n+        } catch (NuxeoException e) {\n+            fail(\"It was not expected an exception while moving document to cold storage since user has the required permissions\");", "originalCommit": "c2b075a5344fe335d6c315aa2efe39831151bd5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0OTczOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394549738", "bodyText": "Thanks for your input!\nDo you have any opinion about the \"duplication\" of tests here? Since we have generically the same tests on MoveToColdStorageTest and TestColdStorage classes.\nThe first one could, eventually, just ensure ColdStorageHelper is called and that a thumbnail is inserted as main content. But, in fact, this helper has static methods and we won't easily mock them unless we insert new dependencies and so on.\nShould this helper become a service? Any clear trade off with that approach?", "author": "nmpcunha", "createdAt": "2020-03-18T18:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUwMTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4MzkyNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394583927", "bodyText": "I don't know the code in detail but yes test duplication is not ideal. I don't know the tests enough to give an opinion on how to best clean this up. If you decide to do a cleanup then please do it in a separate commit btw.\nThe helper could become a service yes, but that's more code to write. If there's a benefit then yes it could be done.", "author": "efge", "createdAt": "2020-03-18T19:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUwMTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3MDUyNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394870525", "bodyText": "As discussed, the main purpose of adding tests on the operation code is to ensure the correct integration between low level code (helper class) and the operation code (because the whole layer are part of cold storage feature) => mainly Integration Test:\n\nI ensure that the returned document in operation is correctly updated: the reason why I added some checks that exist on low level, plus others related to the thumbnail, notifications...\non others tests on operations I followed the same logic about integration tests\n\nI asked myself question, should I or not add the seconds check on operations, initially as i explained I tried to add a Mock like you tried, but Mockito don't allow the mock of static class, and even i tried to add the PowerMock library / dependency which allows the mock of statics class, but I abandoned it because it's more things and when we started the developments the idea to fo further in the dev, but we discussed with Florent/Antoine that perhaps in a future we will change the low level into service and i ended by adding the tests as explained above which allow more flexibility on mocking things ....\nIf we use this feature (cold storing) in others feature, and we test these new features than we must not do any check on the cold storage, if we do then it's a duplicate tests...\nthat's my point of view :)", "author": "RSalem07", "createdAt": "2020-03-19T08:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUwMTM1Mg=="}], "type": "inlineReview"}, {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "url": "https://github.com/nuxeo/nuxeo/commit/bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-18T18:17:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3NDIxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394874210", "bodyText": "Permission needed to move/transfer documents to cold storage. -> can you please rename to include the fact that we transfer the main content of the document instead of move/transfer documents to cold storage. -> the idea is to be consistent with what we did:\nfor example javadoc of the move method on the helper:\nMoves the main content associated with the document of the given {@link DocumentRef} to a cold storage...", "author": "RSalem07", "createdAt": "2020-03-19T08:57:11Z", "path": "nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/SecurityConstants.java", "diffHunk": "@@ -132,4 +132,10 @@\n      */\n     String MANAGE_LEGAL_HOLD = \"ManageLegalHold\";\n \n+    /**\n+     * Permission needed to move/transfer documents to cold storage.\n+     *", "originalCommit": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3NTY2MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394875661", "bodyText": "ManageLegalHold  should be added in a xml contribution to be visible outer internal Nuxeo code,  can you have a look at here I think without this contribution, the permission will not be visible on the web-ui ...to check", "author": "RSalem07", "createdAt": "2020-03-19T08:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3NDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk0Mjk0Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394942946", "bodyText": "I'll do it, thanks! \ud83d\udc4d", "author": "nmpcunha", "createdAt": "2020-03-19T10:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3NDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAxNjgyOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395016828", "bodyText": "thanks, sorry i meant WriteColdStorage but i think you got it", "author": "RSalem07", "createdAt": "2020-03-19T13:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3NDIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3NzMyNA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394877324", "bodyText": "can you remove this injection and replace the open of the core session with:\n try (CloseableCoreSession jamesSession = CoreInstance.openCoreSession(doc.getRepositoryName(), \"john\")) { .... }\ncomplete example here", "author": "RSalem07", "createdAt": "2020-03-19T09:02:47Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -88,8 +95,11 @@\n     @Inject\n     protected DownloadService downloadService;\n \n+    @Inject\n+    protected CoreFeature coreFeature;\n+", "originalCommit": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4MDU3NA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394880574", "bodyText": "I am wondering if we can keep the methods names shorter as possible ->\nshouldFailWithoutRightPermissions we don't need to explicitly put the permission in the name of the method, which will avoid renaming the method if the permission changes its names in the future", "author": "RSalem07", "createdAt": "2020-03-19T09:09:07Z", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorageTest.java", "diffHunk": "@@ -42,8 +50,42 @@\n     @Inject\n     protected CoreSession session;\n \n+    @Inject\n+    protected CoreFeature coreFeature;\n+\n+    @Test\n+    public void shouldFailWhenUserDoNotHaveWriteColdStoragePermission() throws OperationException, IOException {\n+        DocumentModel documentModel = createFileDocument(session, true);", "originalCommit": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk0NzMxNA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394947314", "bodyText": "We can, but I would say it may not be a consensual approach.\nSome schools of thought advocate that unit test names should be clear and map specific requirements/acceptance criteria and, in this case, we can end with long names. Because, at the end of the day, who reads the test name should understand what is being tested.\nIf the permissions change in future, the requirements changed and we probably want to change the tests too \ud83d\ude42\nAnyway, I can try to follow other approach for consistency sake. What is our convention?", "author": "nmpcunha", "createdAt": "2020-03-19T11:06:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4MDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0MDkyMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395040921", "bodyText": "@nmpcunha, unfortunately, for now, we don't have such conventions.\nWe plan to provide them in a near future.\nSo, I guess it's the responsibility of the writer to choose something that is at least consistent with the rest of the test/package/Maven module.\nIn this case, I would at least replace WhenUserDoesNotHave by the suggested Without.\nWe really want to keep the test names as short as possible for readability in the test logs, the CI unit test reports, etc.\nAs for the permission name, that's your choice, though personally I like @RSalem07 's approach, simply because it's shorter.", "author": "ataillefer", "createdAt": "2020-03-19T13:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4MDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzODY0OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395138648", "bodyText": "Thanks for your input! \ud83d\udc4d\nI've reworked the tests according to your suggestions. Hopefully we can work together on those conventions \ud83d\ude42", "author": "nmpcunha", "createdAt": "2020-03-19T16:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4MDU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4MzQxMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394883411", "bodyText": "I think we can group the tests within the permissions to:\n\nkeep the name shorted\ngroup the tests related to same things on the same tests\n\nas we have a helper method, i think we can use a name:\nshouldMoveToColdStorage which can test with an Admin and after that with a regular user that has the right permission", "author": "RSalem07", "createdAt": "2020-03-19T09:14:05Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -109,6 +119,48 @@ public void shouldMoveToColdStorage() throws IOException {\n         assertEquals(\"dummy\", ((ManagedBlob) content).getProviderId());\n     }", "originalCommit": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk4OTkxNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394989916", "bodyText": "As we discussed, I'll wait for more input on this. I confess I'm not completely comfortable with this approach since we are violating some unit tests principles.\nObviously we can argue if we are doing unit or integration tests and it may influence the decision.\nAt the end I'll go with the more consensual approach but hoping that this discussion could help creating some awareness for this subjects \ud83d\ude42", "author": "nmpcunha", "createdAt": "2020-03-19T12:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4MzQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NTQyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394885429", "bodyText": "I am wondering if we can reduce this part of code and if we do wan reduce code on others parts. For example i was thinking if we can transform the createFileDocument to:\n    protected DocumentModel createFileDocument(CoreSession session, boolean withBlobContent, ACE... aces) {\n        DocumentModel documentModel = session.createDocumentModel(\"/\", \"MyFile\", \"File\");\n        if (withBlobContent) {\n            documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n                    (Serializable) Blobs.createBlob(FILE_CONTENT));\n        }\n        DocumentModel document = session.createDocument(documentModel);\n        if(aces.length > 0) {\n            ACP acp = documentModel.getACP();\n            ACL acl = acp.getOrCreateACL();\n            acl.addAll(List.of(aces));\n            document.setACP(acp, true);\n        }\n        return document;\n    }\n\nand the callers can be:\nDocumentModel documentModel = createFileDocument(session, true, new ACE(\"john\", SecurityConstants.READ, true));\nor\n ACE[] aces = { new ACE(\"john\", SecurityConstants.READ, true), //\n                new ACE(\"john\", SecurityConstants.WRITE, true), //\n                new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true) };\n\n        DocumentModel documentModel = createFileDocument(session, true, aces);", "author": "RSalem07", "createdAt": "2020-03-19T09:17:41Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -109,6 +119,48 @@ public void shouldMoveToColdStorage() throws IOException {\n         assertEquals(\"dummy\", ((ManagedBlob) content).getProviderId());\n     }\n \n+    @Test\n+    public void shouldMoveToColdStorageWhenUserHaveWriteColdStoragePermission() throws IOException {\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        ACP acp = documentModel.getACP();\n+        ACL acl = acp.getOrCreateACL();\n+        acl.add(new ACE(\"john\", SecurityConstants.READ, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true));\n+        documentModel.setACP(acp, true);\n+", "originalCommit": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk1MTQxNA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394951414", "bodyText": "Yes, we can do it.\nAgain, we'll duplicate similar logic on the following files:\n\nAbstractTestColdStorageOperation (https://github.com/nuxeo/nuxeo/blob/master/nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/AbstractTestColdStorageOperation.java#L75-L82)\nTestColdStorage (https://github.com/nuxeo/nuxeo/blob/master/nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java#L241-L247)", "author": "nmpcunha", "createdAt": "2020-03-19T11:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NTEwMA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394975100", "bodyText": "Ok! Let's factor the ACEs \ud83d\udc4d", "author": "nmpcunha", "createdAt": "2020-03-19T12:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NTQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NzE0Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394887146", "bodyText": "can you add <p/> before the new line The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required. and can you complete the @throws NuxeoException", "author": "RSalem07", "createdAt": "2020-03-19T09:20:40Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -71,6 +73,7 @@\n \n     /**\n      * Moves the main content associated with the document of the given {@link DocumentRef} to a cold storage.\n+     * The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required.", "originalCommit": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "677c80d586e261c8a53862b2e4f962ddd77e9e7e", "url": "https://github.com/nuxeo/nuxeo/commit/677c80d586e261c8a53862b2e4f962ddd77e9e7e", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-19T12:03:16Z", "type": "forcePushed"}, {"oid": "068a203b7bea069dbe8463aea5155380b3afb8b4", "url": "https://github.com/nuxeo/nuxeo/commit/068a203b7bea069dbe8463aea5155380b3afb8b4", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-19T15:26:58Z", "type": "forcePushed"}, {"oid": "3cf90f513ca97993390b63a59f5ae10ecd4219ef", "url": "https://github.com/nuxeo/nuxeo/commit/3cf90f513ca97993390b63a59f5ae10ecd4219ef", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-20T12:40:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MDkwNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395770907", "bodyText": "Can you please add the case where the current user doesn't have the required permission?", "author": "ataillefer", "createdAt": "2020-03-20T16:59:22Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -71,6 +73,8 @@\n \n     /**\n      * Moves the main content associated with the document of the given {@link DocumentRef} to a cold storage.\n+     * <p/>\n+     * The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required.\n      *\n      * @return the updated document model if the move succeeds\n      * @throws NuxeoException if the main content is already in the cold storage, or if there is no main content", "originalCommit": "3cf90f513ca97993390b63a59f5ae10ecd4219ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4MTA0MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395781041", "bodyText": "Thanks! Nice catch! \ud83d\ude42", "author": "nmpcunha", "createdAt": "2020-03-20T17:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc5MDc1OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395790758", "bodyText": "For debugging purposes I understand that it would be interesting to have more details.\nBut, if I am not mistaken, this exception will be sent to client side and, for security purposes, we should not provide too much details (IMHO).", "author": "nmpcunha", "createdAt": "2020-03-20T17:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc5NjkyNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395796925", "bodyText": "You are referring to #3843 (comment).\nDon't know if it's considered\nas a security issue or if we want to provide this information to the client, @efge WDYT?", "author": "ataillefer", "createdAt": "2020-03-20T17:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwMzkyOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395803928", "bodyText": "@ataillefer, not sure how the comment ended here \ud83d\ude05\nMoved to the correct thread!", "author": "nmpcunha", "createdAt": "2020-03-20T17:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0OTU0MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396349540", "bodyText": "It seems you haven't updated the javadoc for @throws NuxeoException to add the permission case.", "author": "ataillefer", "createdAt": "2020-03-23T10:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MDkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MjI4NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395772285", "bodyText": "You could be more precise on the message about the missing required permission.", "author": "ataillefer", "createdAt": "2020-03-20T17:01:48Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -80,6 +84,11 @@ public static DocumentModel moveContentToColdStorage(CoreSession session, Docume\n         DocumentModel documentModel = session.getDocument(documentRef);\n         log.debug(\"Move to cold storage the main content of document: {}\", documentModel);\n \n+        if (!session.hasPermission(documentRef, SecurityConstants.WRITE_COLD_STORAGE)) {\n+            throw new NuxeoException(String.format(\"The document: %s cannot be moved to cold storage\", documentRef),", "originalCommit": "3cf90f513ca97993390b63a59f5ae10ecd4219ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwMzk1Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395803956", "bodyText": "For debugging purposes I understand that it would be interesting to have more details.\nBut, if I am not mistaken, this exception will be sent to client side and, for security purposes, we should not provide too much details (IMHO).", "author": "nmpcunha", "createdAt": "2020-03-20T17:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MjI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxODg4Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395818883", "bodyText": "Yes we try to avoid too many details in the exceptions especially when related to security. It can be worth adding log.debug statements with the details if you feel then can be useful.\nHowever in this particular case \"cannot be moved to cold storage\" seems sufficient to understand the issue.", "author": "efge", "createdAt": "2020-03-20T18:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MjI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMzMDg4OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396330889", "bodyText": "log.debug added!\nThanks for your input @efge and @ataillefer!", "author": "nmpcunha", "createdAt": "2020-03-23T09:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MjI4NQ=="}], "type": "inlineReview"}, {"oid": "446f62022fda0083108506c40a74971045611e0d", "url": "https://github.com/nuxeo/nuxeo/commit/446f62022fda0083108506c40a74971045611e0d", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-23T09:57:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMzNzM2NA==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396337364", "bodyText": "If I'm not mistaken, this second case is for the Administrator user, so:\n\nit doesn't need aces when creating the document\nit deserves a comment above like \"// with administrator user\"", "author": "ataillefer", "createdAt": "2020-03-23T10:09:16Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -90,23 +97,34 @@\n \n     @Test\n     public void shouldMoveToColdStorage() throws IOException {\n-        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        // with regular user with \"WriteColdStorage\" permission\n+        ACE[] aces = { new ACE(\"john\", SecurityConstants.READ, true), //\n+                new ACE(\"john\", SecurityConstants.WRITE, true), //\n+                new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true) };\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true, aces);\n+\n+        try (CloseableCoreSession userSession = CoreInstance.openCoreSession(documentModel.getRepositoryName(),\n+                \"john\")) {\n+            moveAndVerifyContent(userSession, documentModel);\n+        }\n \n+        documentModel = createFileDocument(DEFAULT_DOC_NAME, true, aces);\n         // move the blob to cold storage\n-        documentModel = ColdStorageHelper.moveContentToColdStorage(session, documentModel.getRef());\n-        session.saveDocument(documentModel);\n-        transactionalFeature.nextTransaction();\n-        documentModel.refresh();\n-\n-        assertTrue(documentModel.hasFacet(FacetNames.COLD_STORAGE));\n-\n-        assertNull(documentModel.getPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY));\n+        moveAndVerifyContent(session, documentModel);", "originalCommit": "446f62022fda0083108506c40a74971045611e0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMzOTk4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396339987", "bodyText": "For consistency, since you've renamed the test in MoveToColdStorageTest#shouldFailWithoutRightPermissions, don't you want to have the same name here?", "author": "ataillefer", "createdAt": "2020-03-23T10:13:38Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -90,23 +97,34 @@\n \n     @Test\n     public void shouldMoveToColdStorage() throws IOException {\n-        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        // with regular user with \"WriteColdStorage\" permission\n+        ACE[] aces = { new ACE(\"john\", SecurityConstants.READ, true), //\n+                new ACE(\"john\", SecurityConstants.WRITE, true), //\n+                new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true) };\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true, aces);\n+\n+        try (CloseableCoreSession userSession = CoreInstance.openCoreSession(documentModel.getRepositoryName(),\n+                \"john\")) {\n+            moveAndVerifyContent(userSession, documentModel);\n+        }\n \n+        documentModel = createFileDocument(DEFAULT_DOC_NAME, true, aces);\n         // move the blob to cold storage\n-        documentModel = ColdStorageHelper.moveContentToColdStorage(session, documentModel.getRef());\n-        session.saveDocument(documentModel);\n-        transactionalFeature.nextTransaction();\n-        documentModel.refresh();\n-\n-        assertTrue(documentModel.hasFacet(FacetNames.COLD_STORAGE));\n-\n-        assertNull(documentModel.getPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY));\n+        moveAndVerifyContent(session, documentModel);\n+    }\n \n-        // check if the `coldstorage:coldContent` property contains the original file content\n-        Blob content = (Blob) documentModel.getPropertyValue(ColdStorageHelper.COLD_STORAGE_CONTENT_PROPERTY);\n-        assertNotNull(content);\n-        assertEquals(FILE_CONTENT, content.getString());\n-        assertEquals(\"dummy\", ((ManagedBlob) content).getProviderId());\n+    @Test\n+    public void shouldFailWhenUserDoNotHaveWriteColdStoragePermission() {", "originalCommit": "446f62022fda0083108506c40a74971045611e0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0MzA1Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396343056", "bodyText": "Nice catch, thanks!\nYes, clearly a side of effect of maintaining duplicated tests... \ud83d\ude1e", "author": "nmpcunha", "createdAt": "2020-03-23T10:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMzOTk4Nw=="}], "type": "inlineReview"}, {"oid": "78a55f2746843bbc4aec8dda9922aac82911a3d8", "url": "https://github.com/nuxeo/nuxeo/commit/78a55f2746843bbc4aec8dda9922aac82911a3d8", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-23T10:16:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM1MTA4Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396351086", "bodyText": "Can you please use a lambda here to avoid systematically fetching the principal?\nsession::getPrincipal, () -> documentModel", "author": "ataillefer", "createdAt": "2020-03-23T10:32:22Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -80,6 +84,13 @@ public static DocumentModel moveContentToColdStorage(CoreSession session, Docume\n         DocumentModel documentModel = session.getDocument(documentRef);\n         log.debug(\"Move to cold storage the main content of document: {}\", documentModel);\n \n+        if (!session.hasPermission(documentRef, SecurityConstants.WRITE_COLD_STORAGE)) {\n+            log.debug(\"The user {} does not have the right permissions to move the content of document {}\",\n+                    session.getPrincipal(), documentModel);", "originalCommit": "78a55f2746843bbc4aec8dda9922aac82911a3d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fe22d2be00ee85d862f5de0b9e1f785f47d9eede", "url": "https://github.com/nuxeo/nuxeo/commit/fe22d2be00ee85d862f5de0b9e1f785f47d9eede", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-23T12:00:04Z", "type": "forcePushed"}, {"oid": "483ae9cebf109fed6b5b0e21535467d4bd4bec87", "url": "https://github.com/nuxeo/nuxeo/commit/483ae9cebf109fed6b5b0e21535467d4bd4bec87", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-23T12:01:48Z", "type": "commit"}, {"oid": "483ae9cebf109fed6b5b0e21535467d4bd4bec87", "url": "https://github.com/nuxeo/nuxeo/commit/483ae9cebf109fed6b5b0e21535467d4bd4bec87", "message": "NXP-28600: add WriteColdStorage permission", "committedDate": "2020-03-23T12:01:48Z", "type": "forcePushed"}]}