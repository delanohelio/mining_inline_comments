{"pr_number": 4078, "pr_title": "NXP-29103: explorer bundle groups review", "pr_createdAt": "2020-05-26T18:47:07Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4078", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxNzk4Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430917986", "bodyText": "This was < 2 in the original code, is there really a need to change this and do a split if size is 1?", "author": "efge", "createdAt": "2020-05-27T07:41:45Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());\n+    }\n+\n+    protected void generateGroups(String version) {\n+        // post process bundle groups\n+        List<String> mvnGroupNames = new ArrayList<>();\n+        mvnGroupNames.addAll(mavenGroups.keySet());\n+\n+        for (String mvnGroupName : mvnGroupNames) {\n+            List<String> artifactIds = mavenGroups.get(mvnGroupName);\n+            Collections.sort(artifactIds);\n+            Set<String> subGroups = new LinkedHashSet<>();\n+            for (String id : artifactIds) {\n+                if (id.contains(\".\")) {\n+                    String suffix = id.substring(id.lastIndexOf(\".\") + 1);\n+                    if (BLACKLIST_SUFFIX.contains(suffix.toLowerCase())) {\n+                        continue;\n+                    }\n+                    String grpName = id.substring(0, id.lastIndexOf(\".\"));\n+                    String grp = BundleGroup.PREFIX + grpName;\n+                    if (grp.equals(mvnGroupName) || BLACKLIST.contains(grpName.toLowerCase())) {\n+                        continue;\n+                    }\n+                    subGroups.add(grp);\n+                }\n+            }\n+            if (subGroups.size() < 1) {", "originalCommit": "76a883437b4b6b7abaaa17c87cd8eb5c29977680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyMjc1Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430922753", "bodyText": "I did the extraction in a separate step to show the differences indeed.\nThis change allows to extract a group for \"grp:org.nuxeo.ecm.platform.restapi\" (visible in unit tests) as well a proper restoration of the apidoc group in json legacy tests (with only 2 bundles, apidoc-core and apidoc-repo --> the group would not be extracted in this case).\nOverall the \"< 2\" felt arbitrary to me. I kept 1 instead of 0 because it might not make sense to keep a subgroup for only one bundle.", "author": "atchertchian", "createdAt": "2020-05-27T07:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxNzk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODM5Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430918392", "bodyText": "protected static class", "author": "efge", "createdAt": "2020-05-27T07:42:29Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.core.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.junit.Test;\n+import org.nuxeo.apidoc.api.BundleGroup;\n+import org.nuxeo.apidoc.api.BundleGroupExtractor;\n+import org.nuxeo.apidoc.api.BundleInfo;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class TestBundleGroupExtractor {\n+\n+    class MockBundle {", "originalCommit": "76a883437b4b6b7abaaa17c87cd8eb5c29977680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyMzM3Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430923372", "bodyText": "This did not feel necessary for an inner class in a (very) unit test: can you please elaborate on what it would bring here?", "author": "atchertchian", "createdAt": "2020-05-27T07:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMDY0MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430930641", "bodyText": "Just to avoid warnings in tools that consider that the implicit package-private is wrong.", "author": "efge", "createdAt": "2020-05-27T08:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NTgzMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430945830", "bodyText": "Alright \ud83d\udc4d", "author": "atchertchian", "createdAt": "2020-05-27T08:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODU0Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430918543", "bodyText": "protected fields", "author": "efge", "createdAt": "2020-05-27T07:42:42Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.core.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.junit.Test;\n+import org.nuxeo.apidoc.api.BundleGroup;\n+import org.nuxeo.apidoc.api.BundleGroupExtractor;\n+import org.nuxeo.apidoc.api.BundleInfo;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class TestBundleGroupExtractor {\n+\n+    class MockBundle {\n+\n+        String id;\n+\n+        String groupId;\n+\n+        String artifactId;", "originalCommit": "76a883437b4b6b7abaaa17c87cd8eb5c29977680", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyODQ5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430928490", "bodyText": "You could use computeIfAbsent:\nmavenGroups.computeIfAbsent(groupId, k -> new ArrayList<>()).add(bundle.getId()));", "author": "kevinleturc", "createdAt": "2020-05-27T07:59:57Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());", "originalCommit": "76a883437b4b6b7abaaa17c87cd8eb5c29977680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NjUzMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430946531", "bodyText": "Will do, this is legacy code i did not touch, so please tell if you see any other potential simplifications (i did not bother to review it, i admit, but i do have unit tests for it now!)", "author": "atchertchian", "createdAt": "2020-05-27T08:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyODQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjUwNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430952505", "bodyText": "Could be\n    return parents.stream()\n                  .map(doc -> doc.getAdapter(BundleGroup.class))\n                  .filter(Objects::nonNull)\n                  .map(BundleGroup::getId)\n                  .collect(Collectors.toList());", "author": "efge", "createdAt": "2020-05-27T08:40:36Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "diffHunk": "@@ -136,9 +137,23 @@ public String getArtifactType() {\n         return TYPE_NAME;\n     }\n \n+    @Override\n+    public BundleGroup getParentGroup() {\n+        return getCoreSession().getParentDocument(doc.getRef()).getAdapter(BundleGroup.class);\n+    }\n+\n     @Override\n     public List<String> getParentIds() {\n-        throw new UnsupportedOperationException();\n+        List<DocumentModel> parents = getCoreSession().getParentDocuments(doc.getRef());\n+        Collections.reverse(parents);\n+        List<String> res = new ArrayList<>();\n+        for (DocumentModel doc : parents) {\n+            BundleGroup bgroup = doc.getAdapter(BundleGroup.class);\n+            if (bgroup != null) {\n+                res.add(bgroup.getId());\n+            }\n+        }\n+        return res;", "originalCommit": "76a883437b4b6b7abaaa17c87cd8eb5c29977680", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1Mjk0Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430952943", "bodyText": "Could be bundles.values().forEach(this::registerBundle)", "author": "efge", "createdAt": "2020-05-27T08:41:19Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }", "originalCommit": "76a883437b4b6b7abaaa17c87cd8eb5c29977680", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MzkxNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430953914", "bodyText": "Could be grpArtifactIds.forEach(artifactIds::remove)", "author": "efge", "createdAt": "2020-05-27T08:42:55Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());\n+    }\n+\n+    protected void generateGroups(String version) {\n+        // post process bundle groups\n+        List<String> mvnGroupNames = new ArrayList<>();\n+        mvnGroupNames.addAll(mavenGroups.keySet());\n+\n+        for (String mvnGroupName : mvnGroupNames) {\n+            List<String> artifactIds = mavenGroups.get(mvnGroupName);\n+            Collections.sort(artifactIds);\n+            Set<String> subGroups = new LinkedHashSet<>();\n+            for (String id : artifactIds) {\n+                if (id.contains(\".\")) {\n+                    String suffix = id.substring(id.lastIndexOf(\".\") + 1);\n+                    if (BLACKLIST_SUFFIX.contains(suffix.toLowerCase())) {\n+                        continue;\n+                    }\n+                    String grpName = id.substring(0, id.lastIndexOf(\".\"));\n+                    String grp = BundleGroup.PREFIX + grpName;\n+                    if (grp.equals(mvnGroupName) || BLACKLIST.contains(grpName.toLowerCase())) {\n+                        continue;\n+                    }\n+                    subGroups.add(grp);\n+                }\n+            }\n+            if (subGroups.size() < 1) {\n+                // no need to split the maven group into subGroups\n+            } else {\n+                for (String grp : subGroups) {\n+                    List<String> grpArtifactIds = new ArrayList<>();\n+                    for (String aid : artifactIds) {\n+                        if (aid.startsWith(grp) || (BundleGroup.PREFIX + aid).startsWith(grp)) {\n+                            grpArtifactIds.add(aid);\n+                        }\n+                    }\n+                    if (grpArtifactIds.size() > 1) {\n+                        for (String aid : grpArtifactIds) {\n+                            artifactIds.remove(aid);\n+                        }", "originalCommit": "76a883437b4b6b7abaaa17c87cd8eb5c29977680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1NDM5NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430954394", "bodyText": "Actually artifactIds.removeAll(grpArtifactIds) is even better", "author": "efge", "createdAt": "2020-05-27T08:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MzkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk4NzYxNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430987614", "bodyText": "should not have pushed this", "author": "atchertchian", "createdAt": "2020-05-27T09:36:46Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/AbstractApidocTest.java", "diffHunk": "@@ -38,7 +38,7 @@\n public abstract class AbstractApidocTest {\n \n     // helper for quicker update when running tests locally\n-    public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = false;\n+    public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = true;", "originalCommit": "abf51fc350847842072da6841d5ded31ea3119e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f6e1fd4c0a51cf148d690216b38e4a210504c4a", "url": "https://github.com/nuxeo/nuxeo/commit/4f6e1fd4c0a51cf148d690216b38e4a210504c4a", "message": "NXP-29103: code cleanup (lambda feast)", "committedDate": "2020-05-27T10:16:43Z", "type": "forcePushed"}, {"oid": "ddde734f6a969ca7eae95182201fbfb276abc1ad", "url": "https://github.com/nuxeo/nuxeo/commit/ddde734f6a969ca7eae95182201fbfb276abc1ad", "message": "NXP-29103: fix subgroup extraction logics for connect bundles use case", "committedDate": "2020-05-27T14:44:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc5NzY0MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r431797640", "bodyText": "Suggestion:\n        return docs.stream()\n                   .map(doc -> doc.getAdapter(BundleInfo.class))\n                   .filter(Objects::nonNull)\n                   .map(BundleInfo::getId)\n                   .filter(Predicate.isEqual(getId()))\n                   .collect(Collectors.toList());\nThe main difference is that getId is called only once, otherwise it is just style.", "author": "kevinleturc", "createdAt": "2020-05-28T12:29:18Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "diffHunk": "@@ -81,16 +85,14 @@ public BundleGroupDocAdapter(DocumentModel doc) {\n \n     @Override\n     public List<String> getBundleIds() {\n-        List<String> bundles = new ArrayList<>();\n-        String query = QueryHelper.select(BundleInfo.TYPE_NAME, doc);\n-        DocumentModelList docs = getCoreSession().query(query + QueryHelper.ORDER_BY_POS);\n-        for (DocumentModel child : docs) {\n-            BundleInfo bi = child.getAdapter(BundleInfo.class);\n-            if (bi != null && !bi.getId().equals(getId())) {\n-                bundles.add(bi.getId());\n-            }\n-        }\n-        return bundles;\n+        String query = QueryHelper.select(BundleInfo.TYPE_NAME, doc, NXQL.ECM_POS);\n+        DocumentModelList docs = getCoreSession().query(query);\n+        return docs.stream()\n+                   .map(doc -> doc.getAdapter(BundleInfo.class))\n+                   .filter(Objects::nonNull)\n+                   .filter(b -> !b.getId().equals(getId()))\n+                   .map(BundleInfo::getId)\n+                   .collect(Collectors.toList());", "originalCommit": "ddde734f6a969ca7eae95182201fbfb276abc1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM2MDMyMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r432360320", "bodyText": "should have actually been\n   .filter(Predicate.not(Predicate.isEqual(getId()))\n(caught by ftests)", "author": "atchertchian", "createdAt": "2020-05-29T09:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc5NzY0MA=="}], "type": "inlineReview"}, {"oid": "67e202a9f3c0f2a25acac598a78cc01edf4c0946", "url": "https://github.com/nuxeo/nuxeo/commit/67e202a9f3c0f2a25acac598a78cc01edf4c0946", "message": "NXP-29103: fix subgroup extraction logics for connect bundles use case", "committedDate": "2020-05-28T13:51:01Z", "type": "forcePushed"}, {"oid": "812bef53a69a3394cc11ad2db610d1fa15753cec", "url": "https://github.com/nuxeo/nuxeo/commit/812bef53a69a3394cc11ad2db610d1fa15753cec", "message": "NXP-29103: revert test paths commited by mistake for NXP-28995", "committedDate": "2020-05-29T06:52:16Z", "type": "commit"}, {"oid": "bebc64077e97e913d290676a602dc73263258ef2", "url": "https://github.com/nuxeo/nuxeo/commit/bebc64077e97e913d290676a602dc73263258ef2", "message": "NXP-29025: adjust legacy json export to operation chain fix", "committedDate": "2020-05-29T06:52:16Z", "type": "commit"}, {"oid": "f54189df67d5f1306d9717698fd8a3a538883fe5", "url": "https://github.com/nuxeo/nuxeo/commit/f54189df67d5f1306d9717698fd8a3a538883fe5", "message": "NXP-29103: fix explorer 'version' property on bundle group json", "committedDate": "2020-05-29T06:52:46Z", "type": "commit"}, {"oid": "914625dd971991047140eee32157fa23c4d559cf", "url": "https://github.com/nuxeo/nuxeo/commit/914625dd971991047140eee32157fa23c4d559cf", "message": "NXP-29103: review bundle group json export", "committedDate": "2020-05-29T06:54:58Z", "type": "commit"}, {"oid": "93c9f39e41341547228b61acb2576c4c84e6ee68", "url": "https://github.com/nuxeo/nuxeo/commit/93c9f39e41341547228b61acb2576c4c84e6ee68", "message": "NXP-29103: extract bundle group introspection, add tests", "committedDate": "2020-05-29T06:55:00Z", "type": "commit"}, {"oid": "d4fd255746337628e43419618033f9fdee361e24", "url": "https://github.com/nuxeo/nuxeo/commit/d4fd255746337628e43419618033f9fdee361e24", "message": "NXP-29103: review bundle group introspection", "committedDate": "2020-05-29T06:57:21Z", "type": "commit"}, {"oid": "79bee44ceac24c2c3aee589285995ee2696e6ca8", "url": "https://github.com/nuxeo/nuxeo/commit/79bee44ceac24c2c3aee589285995ee2696e6ca8", "message": "NXP-29103: review bundle group display", "committedDate": "2020-05-29T09:04:45Z", "type": "commit"}, {"oid": "079d004325461a83da63be2b7b5c33bdce1147cb", "url": "https://github.com/nuxeo/nuxeo/commit/079d004325461a83da63be2b7b5c33bdce1147cb", "message": "NXP-29103: code cleanup (lambda feast)", "committedDate": "2020-05-29T09:34:44Z", "type": "commit"}, {"oid": "a1bffc7579063bdb7ad7782a98b3c96bc4386a99", "url": "https://github.com/nuxeo/nuxeo/commit/a1bffc7579063bdb7ad7782a98b3c96bc4386a99", "message": "NXP-29103: add connect bundles use case to higlight bundle group extraction issue", "committedDate": "2020-05-29T09:34:44Z", "type": "commit"}, {"oid": "c9b59c5886e88215e21892ea5d1eabaa4f476bed", "url": "https://github.com/nuxeo/nuxeo/commit/c9b59c5886e88215e21892ea5d1eabaa4f476bed", "message": "NXP-29103: fix subgroup extraction logics for connect bundles use case", "committedDate": "2020-05-29T09:34:44Z", "type": "commit"}, {"oid": "c9b59c5886e88215e21892ea5d1eabaa4f476bed", "url": "https://github.com/nuxeo/nuxeo/commit/c9b59c5886e88215e21892ea5d1eabaa4f476bed", "message": "NXP-29103: fix subgroup extraction logics for connect bundles use case", "committedDate": "2020-05-29T09:34:44Z", "type": "forcePushed"}]}