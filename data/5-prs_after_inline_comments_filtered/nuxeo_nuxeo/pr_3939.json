{"pr_number": 3939, "pr_title": "NXP-28952: fix retention/legal hold with transactional blob stores", "pr_createdAt": "2020-04-18T17:47:54Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3939", "timeline": [{"oid": "c4b3809be0c7ae7b0b3c075b9224202ca9a156d2", "url": "https://github.com/nuxeo/nuxeo/commit/c4b3809be0c7ae7b0b3c075b9224202ca9a156d2", "message": "NXP-28952: fix retention/legal hold with transactional blob stores", "committedDate": "2020-04-20T18:14:46Z", "type": "forcePushed"}, {"oid": "0e0cd6974366e0dbd8e369d08c016287daa69a52", "url": "https://github.com/nuxeo/nuxeo/commit/0e0cd6974366e0dbd8e369d08c016287daa69a52", "message": "NXP-28952: fix retention/legal hold with transactional blob stores", "committedDate": "2020-04-21T02:06:45Z", "type": "commit"}, {"oid": "0e0cd6974366e0dbd8e369d08c016287daa69a52", "url": "https://github.com/nuxeo/nuxeo/commit/0e0cd6974366e0dbd8e369d08c016287daa69a52", "message": "NXP-28952: fix retention/legal hold with transactional blob stores", "committedDate": "2020-04-21T02:06:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIyNzIwOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3939#discussion_r412227209", "bodyText": "If Optional creation is not an issue, you could save some lines:\nreturn Optional.ofNullable(result.getObjectLockConfiguration())\n                .map(ObjectLockConfiguration:: getRule)\n                .map(ObjectLockRule:: getDefaultRetention)\n                .map(DefaultRetention::getMode)\n                .map(ObjectLockRetentionMode::valueOf)\n                .orElse(DEFAULT_RETENTION_MODE);", "author": "kevinleturc", "createdAt": "2020-04-21T14:19:52Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/blob/s3/S3BlobStoreConfiguration.java", "diffHunk": "@@ -412,6 +423,33 @@ protected TransferManager createTransferManager() {\n                                      .build();\n     }\n \n+    protected ObjectLockRetentionMode getRetentionMode() {\n+        GetObjectLockConfigurationRequest request = new GetObjectLockConfigurationRequest().withBucketName(bucketName);\n+        GetObjectLockConfigurationResult result;\n+        try {\n+            result = amazonS3.getObjectLockConfiguration(request);\n+        } catch (AmazonServiceException e) {\n+            return DEFAULT_RETENTION_MODE;\n+        }\n+        ObjectLockConfiguration config = result.getObjectLockConfiguration();\n+        if (config == null) {\n+            return DEFAULT_RETENTION_MODE;\n+        }\n+        ObjectLockRule rule = config.getRule();\n+        if (rule == null) {\n+            return DEFAULT_RETENTION_MODE;\n+        }\n+        DefaultRetention defaultRetention = rule.getDefaultRetention();\n+        if (defaultRetention == null) {\n+            return DEFAULT_RETENTION_MODE;\n+        }\n+        String mode = defaultRetention.getMode();\n+        if (mode == null) {\n+            return DEFAULT_RETENTION_MODE;\n+        }\n+        return ObjectLockRetentionMode.valueOf(mode);\n+    }", "originalCommit": "c9d6fa055c9e21db7e0a4b28da5dab17a09fe2a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzNzMwNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3939#discussion_r412237307", "bodyText": "Nice, I updated the code.", "author": "efge", "createdAt": "2020-04-21T14:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIyNzIwOQ=="}], "type": "inlineReview"}, {"oid": "8ca5afc9713ad312609557320af1262c50dd4157", "url": "https://github.com/nuxeo/nuxeo/commit/8ca5afc9713ad312609557320af1262c50dd4157", "message": "NXP-28952: use bucket config for retention mode", "committedDate": "2020-04-21T14:30:29Z", "type": "commit"}, {"oid": "8ca5afc9713ad312609557320af1262c50dd4157", "url": "https://github.com/nuxeo/nuxeo/commit/8ca5afc9713ad312609557320af1262c50dd4157", "message": "NXP-28952: use bucket config for retention mode", "committedDate": "2020-04-21T14:30:29Z", "type": "forcePushed"}]}