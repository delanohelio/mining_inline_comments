{"pr_number": 3995, "pr_title": "Fix nxp 29066 Init of the ACL document root occurs many times", "pr_createdAt": "2020-05-04T10:57:20Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3995", "timeline": [{"oid": "c5370d74b88dc462dba6a3819c9318654e65c962", "url": "https://github.com/nuxeo/nuxeo/commit/c5370d74b88dc462dba6a3819c9318654e65c962", "message": " NXP-29048: Init only once the root template acl", "committedDate": "2020-05-04T14:12:56Z", "type": "forcePushed"}, {"oid": "e40533982b952aa203d1a536725aaf3eaff35fd1", "url": "https://github.com/nuxeo/nuxeo/commit/e40533982b952aa203d1a536725aaf3eaff35fd1", "message": "NXP-29048: Init only once the root template acl", "committedDate": "2020-05-05T10:26:38Z", "type": "forcePushed"}, {"oid": "df678388a19256014a2d284bcd8a6738fed95ffa", "url": "https://github.com/nuxeo/nuxeo/commit/df678388a19256014a2d284bcd8a6738fed95ffa", "message": "NXP-29066: Init only once the root template acl", "committedDate": "2020-05-05T10:40:21Z", "type": "forcePushed"}, {"oid": "acb38334b62f0f792535aa94dfb432354c5e8905", "url": "https://github.com/nuxeo/nuxeo/commit/acb38334b62f0f792535aa94dfb432354c5e8905", "message": "NXP-29066: Init only once the root template acl", "committedDate": "2020-05-05T11:08:31Z", "type": "forcePushed"}, {"oid": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "url": "https://github.com/nuxeo/nuxeo/commit/6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "message": "NXP-29066: Init only once the root template acl", "committedDate": "2020-05-05T11:27:50Z", "type": "commit"}, {"oid": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "url": "https://github.com/nuxeo/nuxeo/commit/6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "message": "NXP-29066: Init only once the root template acl", "committedDate": "2020-05-05T11:27:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3MTI2Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3995#discussion_r420171266", "bodyText": "In the future please use L instead of l for readability. l is very easily confused with 1.", "author": "efge", "createdAt": "2020-05-05T14:51:37Z", "path": "nuxeo-features/nuxeo-platform-audit/nuxeo-platform-audit-core/src/test/java/org/nuxeo/ecm/platform/audit/TestSimpleTemplateBasedRootAudit.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.audit;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.Serializable;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.api.security.ACE;\n+import org.nuxeo.ecm.core.api.security.ACL;\n+import org.nuxeo.ecm.core.api.security.ACP;\n+import org.nuxeo.ecm.platform.audit.api.LogEntry;\n+import org.nuxeo.ecm.platform.query.api.PageProvider;\n+import org.nuxeo.ecm.platform.query.api.PageProviderService;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+/**\n+ * The root init acl which happens at\n+ * {@link org.nuxeo.ecm.platform.content.template.factories.SimpleTemplateBasedRootFactory}. Should occur only once, at\n+ * the beginning when we add the first children of the root document.\n+ * <p>\n+ * Deploying a new contribution for a given test method, will call the {@code SimpleTemplateBasedRootFactory} for a\n+ * second time, but as the root documents already contains children, we should not init the acl of the root document.\n+ * \n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features(AuditFeature.class)\n+public class TestSimpleTemplateBasedRootAudit {\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected PageProviderService pps;\n+\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.audit.tests:test-add-content-template-contrib.xml\")\n+    public void shouldInitRootAclOnlyOnce() {\n+        DocumentModel root = session.getDocument(new PathRef(\"/\"));\n+        @SuppressWarnings(\"unchecked\")\n+        PageProvider<LogEntry> pp = (PageProvider<LogEntry>) pps.getPageProvider(\"DOCUMENT_HISTORY_PROVIDER\", null, 3l,\n+                0l, new HashMap<String, Serializable>(), root);", "originalCommit": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}