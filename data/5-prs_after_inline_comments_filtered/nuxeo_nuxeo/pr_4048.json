{"pr_number": 4048, "pr_title": "NXP-20646 Explorer ftests + misc bugfixes", "pr_createdAt": "2020-05-18T08:42:15Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4048", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY0MzkzMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r426643932", "bodyText": "You should use doc.putContextData() directly.", "author": "efge", "createdAt": "2020-05-18T13:55:10Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "diffHunk": "@@ -64,6 +65,8 @@ public static BundleGroupDocAdapter create(BundleGroup bundleGroup, CoreSession\n             files.add(item);\n         }\n         doc.setPropertyValue(PROP_READMES, files);\n+\n+        doc.getContextData().put(ThumbnailConstants.DISABLE_THUMBNAIL_COMPUTATION, true);", "originalCommit": "ef10d32f988fb2934e2f225b260268b8ef633ef1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d87cc4744a7c222f39eb0f5de0eee7ae429141ac", "url": "https://github.com/nuxeo/nuxeo/commit/d87cc4744a7c222f39eb0f5de0eee7ae429141ac", "message": "NXP-20646/NXP-28928: disable thumbnail conversion on explorer distribution persistence", "committedDate": "2020-05-18T17:12:39Z", "type": "commit"}, {"oid": "dfb145071b1823352ea04598f7b271aa55b7534f", "url": "https://github.com/nuxeo/nuxeo/commit/dfb145071b1823352ea04598f7b271aa55b7534f", "message": "NXP-20646: autofocus on searches in explorer listings :gift:", "committedDate": "2020-05-18T17:12:39Z", "type": "forcePushed"}, {"oid": "7e5ca51716acd9c58b3b2185f9a5239368cfd29b", "url": "https://github.com/nuxeo/nuxeo/commit/7e5ca51716acd9c58b3b2185f9a5239368cfd29b", "message": "NXP-20646: autofocus on searches in explorer listings :gift:", "committedDate": "2020-05-19T07:31:58Z", "type": "forcePushed"}, {"oid": "305d9d139f52f0ef3e360e5c3506d397bf8b4e8d", "url": "https://github.com/nuxeo/nuxeo/commit/305d9d139f52f0ef3e360e5c3506d397bf8b4e8d", "message": "NXP-20646: autofocus on searches in explorer listings :gift:", "committedDate": "2020-05-19T08:24:56Z", "type": "forcePushed"}, {"oid": "b998dd6a5eedc9014f1e076a26fff79f2bf597a2", "url": "https://github.com/nuxeo/nuxeo/commit/b998dd6a5eedc9014f1e076a26fff79f2bf597a2", "message": "NXP-20646: autofocus on searches in explorer listings :gift:", "committedDate": "2020-05-19T09:51:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4ODg1MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r427488851", "bodyText": "Remove redundant = null", "author": "efge", "createdAt": "2020-05-19T17:49:55Z", "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/ITExplorerAdminTest.java", "diffHunk": "@@ -32,6 +64,46 @@\n  */\n public class ITExplorerAdminTest extends AbstractExplorerTest {\n \n+    public static File downloadDir = null;", "originalCommit": "b998dd6a5eedc9014f1e076a26fff79f2bf597a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5Mzc4Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r427493783", "bodyText": "If you don't need the value of i itself but just to get the next element sometimes, you can work with an iterator:\nfor (Iterator<String> lineIter = lines.iterator(); lineIter.hasNext(); ) {\n    String path = lineIter.next();\n    ...\n    ... Integer.valueOf(lineIter.next()) ...\n}", "author": "efge", "createdAt": "2020-05-19T17:57:34Z", "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/ITExplorerAdminTest.java", "diffHunk": "@@ -62,4 +136,171 @@ public void testDistribAdminPage() {\n         page.check();\n     }\n \n+    @Test\n+    public void testHomePageLiveDistrib() {\n+        ExplorerHomePage home = goHome();\n+        home.check();\n+        // check upload form is here for admin\n+        asPage(UploadFragment.class);\n+    }\n+\n+    protected String getDistribId(String name, String version) {\n+        return String.format(\"%s-%s\", name, version);\n+    }\n+\n+    protected String getDistribExportName(String distribId) {\n+        return String.format(\"nuxeo-distribution-%s.zip\", distribId);\n+    }\n+\n+    protected void checkLiveDistrib(String distribId) {\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_BUNDLEGROUPS);\n+        checkBundleGroups();\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_BUNDLES);\n+        checkBundles(false);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_COMPONENTS);\n+        checkComponents(false);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_EXTENSIONPOINTS);\n+        checkExtensionPoints(false);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_SERVICES);\n+        checkServices(false);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_CONTRIBUTIONS);\n+        checkContributions(false);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_OPERATIONS);\n+        checkOperations(false);\n+    }\n+\n+    @Test\n+    public void testLiveDistribExportAndImport() {\n+        String distribName = \"my-server\";\n+        open(DistribAdminPage.URL);\n+        String version = asPage(DistribAdminPage.class).saveCurrentLiveDistrib(distribName, false);\n+        String distribId = getDistribId(distribName, version);\n+        asPage(ExplorerHomePage.class).checkPersistedDistrib(distribId);\n+        checkLiveDistrib(distribId);\n+\n+        // check importing it back\n+        open(DistribAdminPage.URL);\n+        String filename = getDistribExportName(distribId);\n+        File file = asPage(DistribAdminPage.class).exportFirstPersistedDistrib(downloadDir, filename);\n+\n+        open(DistribAdminPage.URL);\n+        String newDistribName = \"imported-server\";\n+        String newVersion = \"1.0.0\";\n+        asPage(DistribAdminPage.class).importPersistedDistrib(file, newDistribName, newVersion, null);\n+        open(ExplorerHomePage.URL);\n+        String newDistribId = getDistribId(newDistribName, newVersion);\n+        asPage(ExplorerHomePage.class).checkPersistedDistrib(newDistribId);\n+        checkLiveDistrib(newDistribId);\n+    }\n+\n+    protected void checkPartialDistrib(String virtualBundleGroup, String distribId) {\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_BUNDLEGROUPS);\n+        checkPartialBundleGroup(virtualBundleGroup);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_BUNDLES);\n+        checkBundles(true);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_COMPONENTS);\n+        checkComponents(true);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_EXTENSIONPOINTS);\n+        checkExtensionPoints(true);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_SERVICES);\n+        checkServices(true);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_CONTRIBUTIONS);\n+        checkContributions(true);\n+        open(ExplorerHomePage.URL + distribId + \"/\" + ApiBrowserConstants.LIST_OPERATIONS);\n+        checkOperations(true);\n+    }\n+\n+    // will be easier to maintain as a reference when a specific bundle group is used for explorer...\n+    protected void checkPartialBundleGroup(String distribName) {\n+        Locator.findElementWaitUntilEnabledAndClick(By.linkText(distribName));\n+        BundleGroupArtifactPage apage = asPage(BundleGroupArtifactPage.class);\n+        apage.checkDocumentationText(null);\n+        apage.checkSubGroup(null);\n+        apage.checkBundle(\"org.nuxeo.apidoc.core\");\n+        apage.checkBundle(\"org.nuxeo.apidoc.repo\");\n+        apage.checkBundle(\"org.nuxeo.apidoc.webengine\");\n+    }\n+\n+    @Test\n+    public void testLivePartialDistribExportAndImport() {\n+        String distribName = \"my-partial-server\";\n+        open(DistribAdminPage.URL);\n+        String version = asPage(DistribAdminPage.class).saveCurrentLiveDistrib(distribName, true);\n+        String distribId = getDistribId(distribName, version);\n+        asPage(ExplorerHomePage.class).checkPersistedDistrib(distribId);\n+        checkPartialDistrib(distribName, distribId);\n+\n+        // check importing it back\n+        open(DistribAdminPage.URL);\n+        String filename = getDistribExportName(distribId);\n+        File file = asPage(DistribAdminPage.class).exportFirstPersistedDistrib(downloadDir, filename);\n+\n+        open(DistribAdminPage.URL);\n+        String newDistribName = \"partial-imported-server\";\n+        String newVersion = \"1.0.0\";\n+        asPage(DistribAdminPage.class).importPersistedDistrib(file, newDistribName, newVersion, null);\n+        open(ExplorerHomePage.URL);\n+        String newDistribId = getDistribId(newDistribName, newVersion);\n+        asPage(ExplorerHomePage.class).checkPersistedDistrib(newDistribId);\n+        checkPartialDistrib(distribName, newDistribId);\n+    }\n+\n+    protected void createSampleZip(String sourceDirPath, String zipFilePath, boolean addMarker) throws IOException {\n+        Path p = Files.createFile(Paths.get(zipFilePath));\n+        try (ZipOutputStream zs = new ZipOutputStream(Files.newOutputStream(p))) {\n+            if (addMarker) {\n+                ZipEntry zipEntry = new ZipEntry(\".nuxeo-archive\");\n+                zs.putNextEntry(zipEntry);\n+                zs.closeEntry();\n+            }\n+            // read paths from reference file as NuxeoArchiveReader requires a given order and extra info\n+            List<String> lines = Files.readAllLines(Paths.get(sourceDirPath, \"entries.txt\"));\n+            for (int i = 0; i < lines.size(); i++) {\n+                String path = lines.get(i);", "originalCommit": "b998dd6a5eedc9014f1e076a26fff79f2bf597a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg2NTYwMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r427865602", "bodyText": "I'd rather not change these logics now because i'm getting the next next line sometimes (to fill extra info on the zip entry), and because i fought with NuxeoArchiveReader expected format.\nBut i'll keep that in mind \ud83d\udc4d", "author": "atchertchian", "createdAt": "2020-05-20T09:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5Mzc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMTc3Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r428011773", "bodyText": "Well my suggestion doesn't change the logic, just how we write the code. It does the same thing.", "author": "efge", "createdAt": "2020-05-20T13:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5Mzc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxNTAxNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r428015017", "bodyText": "Yes i got that, still in some cases i have an extra ++ so i kind of need the index here not to complicate things (at least for me)", "author": "atchertchian", "createdAt": "2020-05-20T13:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5Mzc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2MDM5OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r429060399", "bodyText": "After all see related commit with #4059", "author": "atchertchian", "createdAt": "2020-05-22T06:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5Mzc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NTAyOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r427495028", "bodyText": "Asyn -> Async", "author": "efge", "createdAt": "2020-05-19T17:59:28Z", "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/pages/AbstractExplorerPage.java", "diffHunk": "@@ -53,6 +71,17 @@ public void checkTitle(String expected) {\n         assertEquals(expected, driver.getTitle());\n     }\n \n+    /**\n+     * Waits for indexing to be done.\n+     */\n+    public void waitForAsynWork() {", "originalCommit": "b998dd6a5eedc9014f1e076a26fff79f2bf597a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NjI4MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r427496281", "bodyText": "Could put header.getText() (used 3 times) in a local variable", "author": "efge", "createdAt": "2020-05-19T18:01:24Z", "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/pages/DistributionHomePage.java", "diffHunk": "@@ -69,7 +70,15 @@ public DistributionHomePage(WebDriver driver) {\n     @Override\n     public void check() {\n         checkTitle(\"Nuxeo Platform Explorer\");\n-        assertTrue(header.getText(), header.getText().startsWith(\"Browsing Distribution\"));\n+        checkHeader(null);\n+    }\n+\n+    public void checkHeader(String distribId) {\n+        if (distribId != null) {\n+            assertEquals(String.format(\"Browsing Distribution '%s'\", distribId), header.getText());", "originalCommit": "b998dd6a5eedc9014f1e076a26fff79f2bf597a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUwMjAwMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4048#discussion_r427502000", "bodyText": "If you want you could build the whole string directly as:\nString s = bids.stream().map(snapshot::getBundle).map(this::represent).collect(Collectors.joining());", "author": "efge", "createdAt": "2020-05-19T18:10:51Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestSnapshotPersist.java", "diffHunk": "@@ -125,61 +145,86 @@ protected String represent(NuxeoArtifact artifact) {\n         return res;\n     }\n \n-    protected void checkBundles(DistributionSnapshot snapshot) throws IOException {\n+    protected void checkBundles(DistributionSnapshot snapshot, boolean partial) throws IOException {\n         List<String> bids = snapshot.getBundleIds();\n \n         StringBuilder sb = new StringBuilder();\n         bids.forEach(bid -> sb.append(represent(snapshot.getBundle(bid))));", "originalCommit": "b998dd6a5eedc9014f1e076a26fff79f2bf597a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a05bd36d0a88a12454312cd96ba6c5c01ca8b9d7", "url": "https://github.com/nuxeo/nuxeo/commit/a05bd36d0a88a12454312cd96ba6c5c01ca8b9d7", "message": "NXP-20646: test export and import of live distribution", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "ee7d6fa34d5770cf1329f0bde465edee273b39c0", "url": "https://github.com/nuxeo/nuxeo/commit/ee7d6fa34d5770cf1329f0bde465edee273b39c0", "message": "NXP-20646: cleanup + visual improvements + ease up functional testing", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "3e2f55fb6c92bc98ca750992d566f637a8831d05", "url": "https://github.com/nuxeo/nuxeo/commit/3e2f55fb6c92bc98ca750992d566f637a8831d05", "message": "NXP-20646/NXP-29117: test partial persistence (unit)", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "2ddeae91764faa591abbc67eb78c99bb2f2f3f2a", "url": "https://github.com/nuxeo/nuxeo/commit/2ddeae91764faa591abbc67eb78c99bb2f2f3f2a", "message": "NXP-20646/NXP-29117: fix & test partial persistence (functional)", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "b95540c6f5c0356cd7da453f5c9f70d57350baf1", "url": "https://github.com/nuxeo/nuxeo/commit/b95540c6f5c0356cd7da453f5c9f70d57350baf1", "message": "NXP-20646: fix navigation to persisted bundle group (follow up of 27f3180adb4475759207c20a73ad4955ef32d554 done with NXP-28995).\nBe resilient to group id being prefixed or not + use constant + make retrieval efficient.", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "dee89e96c4e53e2fe11adf289eb7acec7485cc68", "url": "https://github.com/nuxeo/nuxeo/commit/dee89e96c4e53e2fe11adf289eb7acec7485cc68", "message": "NXP-20646/NXP-29123: fix fulltext filter on persisted contributions", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "1f0ceecda9441b8042c21a780c05a197de29bea9", "url": "https://github.com/nuxeo/nuxeo/commit/1f0ceecda9441b8042c21a780c05a197de29bea9", "message": "NXP-20646/NXP-29124: fix js error on empty explorer listings", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "a0d85acd9c09f6f1f120a35dcfd53ac25c5f9028", "url": "https://github.com/nuxeo/nuxeo/commit/a0d85acd9c09f6f1f120a35dcfd53ac25c5f9028", "message": "NXP-20646: add pristine sample export for tests", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "c362213a7533ba8668cddeab418c402c234aeace", "url": "https://github.com/nuxeo/nuxeo/commit/c362213a7533ba8668cddeab418c402c234aeace", "message": "NXP-20646: add sample import tests", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "c967930dde321239477cd40adf1ece047cd3711e", "url": "https://github.com/nuxeo/nuxeo/commit/c967930dde321239477cd40adf1ece047cd3711e", "message": "NXP-20646: check live, partial and sample distributions", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "c430b3b7d161c93881747f1bf1063277de053929", "url": "https://github.com/nuxeo/nuxeo/commit/c430b3b7d161c93881747f1bf1063277de053929", "message": "NXP-20646: autofocus on searches in explorer listings :gift:", "committedDate": "2020-05-20T09:30:08Z", "type": "commit"}, {"oid": "d5db56a5eff83b8a6e7bc704cdfd3251172092d5", "url": "https://github.com/nuxeo/nuxeo/commit/d5db56a5eff83b8a6e7bc704cdfd3251172092d5", "message": "NXP-20646: make new ftests less prone to randoms", "committedDate": "2020-05-20T09:50:53Z", "type": "commit"}, {"oid": "d5db56a5eff83b8a6e7bc704cdfd3251172092d5", "url": "https://github.com/nuxeo/nuxeo/commit/d5db56a5eff83b8a6e7bc704cdfd3251172092d5", "message": "NXP-20646: make new ftests less prone to randoms", "committedDate": "2020-05-20T09:50:53Z", "type": "forcePushed"}]}