{"pr_number": 3986, "pr_title": "Fix nxp 28709 log silent failure in automation bulk.run action", "pr_createdAt": "2020-04-29T16:19:27Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3986", "timeline": [{"oid": "ed41900008d375f3f5c0fcbc6ac6dafe3899d236", "url": "https://github.com/nuxeo/nuxeo/commit/ed41900008d375f3f5c0fcbc6ac6dafe3899d236", "message": "NXP-28709: get the right status for failing bulk operations", "committedDate": "2020-04-29T16:20:16Z", "type": "forcePushed"}, {"oid": "c6afaaf1511f21c960a33a18c8b3813cc0f3294a", "url": "https://github.com/nuxeo/nuxeo/commit/c6afaaf1511f21c960a33a18c8b3813cc0f3294a", "message": "NXP-28709: get the right status for failing bulk operations", "committedDate": "2020-04-29T19:13:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMwNDE2OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r419304169", "bodyText": "So now each normal call to /status costs 2 round trips, one to the transient store to check for an error and one to the kv to get the status.", "author": "bdelbosc", "createdAt": "2020-05-04T09:11:13Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/adapters/AsyncOperationAdapter.java", "diffHunk": "@@ -200,11 +201,11 @@ public OperationException onError(OperationException error) {\n     @GET\n     @Path(\"{executionId}/status\")\n     public Object status(@PathParam(\"executionId\") String executionId) throws IOException, MessagingException {\n+        String error = getError(executionId);", "originalCommit": "c6afaaf1511f21c960a33a18c8b3813cc0f3294a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQxNjAyMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r419416021", "bodyText": "The whole problem comes from not checking errors on incomplete async operations. We need to make sure there is no error completed or not.\nNot a dream state but 2 calls vs 1 call is still constant complexity-wise \ud83e\udd37", "author": "NourNuxeo", "createdAt": "2020-05-04T12:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMwNDE2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3MTQwMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r420171402", "bodyText": "when setError is called is also calls setCompleted, in which case do we have errors with an execution not marked as completed ?", "author": "nelsonsilva", "createdAt": "2020-05-05T14:51:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMwNDE2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2NzA4Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r421567086", "bodyText": "when failing while compiling the operation chain, isCompleted() is never true so I guess setCompleted() isn't called. Since isCompleted() conditions the call to getErrors() we never see the error. So we made the call to getErrors() independant and preceding isCompleted(): 028ad6c#diff-632d12880ac130d2edc7fa897f2779eaR205-L207", "author": "NourNuxeo", "createdAt": "2020-05-07T14:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMwNDE2OQ=="}], "type": "inlineReview"}, {"oid": "028ad6c66f4120654dfdaec4b0391cde20220e1f", "url": "https://github.com/nuxeo/nuxeo/commit/028ad6c66f4120654dfdaec4b0391cde20220e1f", "message": "NXP-28709: get the right status for failing bulk operations", "committedDate": "2020-05-04T11:35:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE2Mzg4NA==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r420163884", "bodyText": "I would have added a new method setError(String, Throwable) to handle the unwrapException logic (and deprecate the existing setError method probably as it won't be used anymore).", "author": "troger", "createdAt": "2020-05-05T14:42:32Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/adapters/AsyncOperationAdapter.java", "diffHunk": "@@ -164,7 +165,7 @@ public void onOperationExit(Object output) {\n \n             @Override\n             public OperationException onError(OperationException error) {\n-                setError(executionId, error.getMessage());\n+                setError(executionId, ExceptionHelper.unwrapException(error).getMessage());", "originalCommit": "028ad6c66f4120654dfdaec4b0391cde20220e1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec8c4cbc95ec8f7349f81f934e681ad112f299a7", "url": "https://github.com/nuxeo/nuxeo/commit/ec8c4cbc95ec8f7349f81f934e681ad112f299a7", "message": "NXP-28709: get the right status for failing bulk operations", "committedDate": "2020-05-07T16:08:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzMzk1OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r423533959", "bodyText": "You should add @deprecated since 11.1, because unused and use the deprecated method in the new one as the code is the same.", "author": "kevinleturc", "createdAt": "2020-05-12T07:54:32Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/adapters/AsyncOperationAdapter.java", "diffHunk": "@@ -289,6 +290,13 @@ protected void enterMethod(String executionId, InvokableMethod method) {\n         }\n     }\n \n+    protected void setError(String executionId, Throwable t) {\n+        getTransientStore().putParameter(executionId, TRANSIENT_STORE_ERROR,\n+                ExceptionHelper.unwrapException(t).getMessage());\n+        setCompleted(executionId);\n+    }\n+\n+    @Deprecated\n     protected void setError(String executionId, String error) {\n         getTransientStore().putParameter(executionId, TRANSIENT_STORE_ERROR, error);\n         setCompleted(executionId);", "originalCommit": "ec8c4cbc95ec8f7349f81f934e681ad112f299a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1NzM4Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r423557383", "bodyText": "I was wondering what would happen when the deprecated method is automatically removed. I guess there is some mechanism around that ?", "author": "NourNuxeo", "createdAt": "2020-05-12T08:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzMzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1ODYxMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r423558612", "bodyText": "Deprecated methods are not removed automatically. This is us who remove them during a Cleanup / Format commit or a dedicated ticket if there's a lot to remove.", "author": "kevinleturc", "createdAt": "2020-05-12T08:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzMzk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzNzc1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r423537750", "bodyText": "Can we just put \"{}\" without calling the MAPPER? writeValueAsString is used to serialize an object to JSON (or other), here you're giving to it a String. My first thought is: writing a string as string will return the input string. If it's not the case, having the final value in the test will help us to understand what makes it fail and what we want to control/catch.", "author": "kevinleturc", "createdAt": "2020-05-12T08:00:34Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-test/src/test/java/org/nuxeo/ecm/automation/server/test/AsyncOperationAdapterTest.java", "diffHunk": "@@ -222,6 +222,19 @@ public void testAsyncBulkAction() throws Exception {\n         assertEquals(\"foo\", getTitle(folder));\n     }\n \n+    @Test\n+    public void testFailingBulkAction() throws Exception {\n+        String result = async.newRequest(BulkRunAction.ID) //\n+                             .set(\"action\", AutomationBulkAction.ACTION_NAME)\n+                             .set(\"query\", \"SELECT * FROM Folder\")\n+                             .set(\"bucketSize\", \"10\")\n+                             .set(\"batchSize\", \"5\")\n+                             .set(\"parameters\", MAPPER.writeValueAsString(\"{}\"))", "originalCommit": "ec8c4cbc95ec8f7349f81f934e681ad112f299a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "946d5b89494f41bc77de50e910650aa94d3a613e", "url": "https://github.com/nuxeo/nuxeo/commit/946d5b89494f41bc77de50e910650aa94d3a613e", "message": "NXP-28709: get the right status for failing bulk operations", "committedDate": "2020-05-12T09:44:36Z", "type": "forcePushed"}, {"oid": "321e8c4ca83011e90bea963413439cc67917227c", "url": "https://github.com/nuxeo/nuxeo/commit/321e8c4ca83011e90bea963413439cc67917227c", "message": "NXP-28709: get the right status for failing bulk operations", "committedDate": "2020-05-12T09:46:16Z", "type": "commit"}, {"oid": "321e8c4ca83011e90bea963413439cc67917227c", "url": "https://github.com/nuxeo/nuxeo/commit/321e8c4ca83011e90bea963413439cc67917227c", "message": "NXP-28709: get the right status for failing bulk operations", "committedDate": "2020-05-12T09:46:16Z", "type": "forcePushed"}]}