{"pr_number": 4008, "pr_title": "NXP-28798: Gracefully log missing DocumentRoutes", "pr_createdAt": "2020-05-05T17:51:18Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4008", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMwMjYyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420302623", "bodyText": "If you want to log the stack trace you need log.error(e, e).\nIf you don't, please add a comment saying so because it's surprising to hide it.", "author": "efge", "createdAt": "2020-05-05T18:00:40Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -219,6 +224,9 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n \n                 jg.writeEndObject();\n             }\n+        } catch (DocumentNotFoundException e) {\n+            // If the DocumentRoute is not found (deleted for example), the TaskWriter fails.\n+            log.error(e);", "originalCommit": "cb9bbbae1bc29ffae3bb8011b875b8651927473b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMwNTcyMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420305720", "bodyText": "Yes no special reason to hide the stack! Fixed!", "author": "NourNuxeo", "createdAt": "2020-05-05T18:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMwMjYyMw=="}], "type": "inlineReview"}, {"oid": "242974b82be90e4da47a3742b1055151d85c636b", "url": "https://github.com/nuxeo/nuxeo/commit/242974b82be90e4da47a3742b1055151d85c636b", "message": "NXP-28798: Gracefully log missing document routs", "committedDate": "2020-05-05T18:07:18Z", "type": "forcePushed"}, {"oid": "a875bf2a02bafa3d8935390a0c386216164d46cd", "url": "https://github.com/nuxeo/nuxeo/commit/a875bf2a02bafa3d8935390a0c386216164d46cd", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-05T18:58:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420352453", "bodyText": "If a sysadmin can't do much about it and the application can keep functioning, I'd prefer a WARN.\nAlso where is the exception being thrown exactly? Could you add a full stack trace in the NXP ticket please. I'm asking because the try/catch has a very large scope, which is bad if we can have a smaller one.\nFrom a quick test it seems to appear in nodeAccessRunner.runUnrestricted() so the try/catch should be around that, and you should log.warn(\"Failed to get workflow instance\", e)", "author": "efge", "createdAt": "2020-05-05T19:26:11Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -219,6 +224,9 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n \n                 jg.writeEndObject();\n             }\n+        } catch (DocumentNotFoundException e) {\n+            // If the DocumentRoute is not found (deleted for example), the TaskWriter fails.\n+            log.error(e, e);", "originalCommit": "a875bf2a02bafa3d8935390a0c386216164d46cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MDU1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420460550", "bodyText": "Making it a warn and updating the ticket!\nYes indeed, I just catched there because there was already a try clause and because I was certain about the context this is called in (by context I mean while writing a task to json). The UnrestrictedSessionRunner.runUnrestricted() is called in so many places I didn't want to catch in it.\nI could also make a sub try catch around the nodeAccessRunner.runUnrestricted();call in TaskWriter.writeEntityBody() line 116. to make sure I only catch errors on the runUnrestricted().\nAt first I wanted to avoid doing a sub try catch.", "author": "NourNuxeo", "createdAt": "2020-05-05T23:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwOTI0NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420509244", "bodyText": "Yes I mean around the call to nodeAccessRunner.runUnrestricted at line 116. It helps the reader to know where the exception can come from.", "author": "efge", "createdAt": "2020-05-06T02:10:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3MzYyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420573629", "bodyText": "Done!", "author": "NourNuxeo", "createdAt": "2020-05-06T06:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYyMDY2Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420620662", "bodyText": "After moving the catch, now the faulty task contains more info in the response. I have updated the jira ticket with a response containing a corrupted task first and then a well formed one. Also Kevin has identified some issues we'd like to have your opinion about: #4008 (comment)", "author": "NourNuxeo", "createdAt": "2020-05-06T08:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw=="}], "type": "inlineReview"}, {"oid": "cf17228d10bda9b5de0422fe7e35979c73a6c9d1", "url": "https://github.com/nuxeo/nuxeo/commit/cf17228d10bda9b5de0422fe7e35979c73a6c9d1", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-05T23:11:39Z", "type": "forcePushed"}, {"oid": "05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "url": "https://github.com/nuxeo/nuxeo/commit/05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-06T06:39:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4NDA3Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420584073", "bodyText": "Why not fixing the root cause in NodeAccessRunner instead of catching?", "author": "kevinleturc", "createdAt": "2020-05-06T07:06:48Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -108,7 +113,12 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n             if (StringUtils.isNotBlank(workflowInstanceId)) {\n                 NodeAccessRunner nodeAccessRunner = new NodeAccessRunner(wrapper.getSession(), workflowInstanceId,\n                         nodeId);\n-                nodeAccessRunner.runUnrestricted();\n+                try {\n+                    nodeAccessRunner.runUnrestricted();", "originalCommit": "05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYxODQ0NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420618445", "bodyText": "As we discussed on slack the root cause is a DocumentNotFound exception we can only catch where we need to.\nWe have identified other issues as well:\n\nthe NodeAccessRunner is also called by org.nuxeo.ecm.platform.routing.core.io.TaskCompletionRequestJsonReader.readEntity(JsonNode)\nWhen we list the tasks, corrupted tasks show, but obviously miss information, which we may want to avoid in the UI.\nHere is a sample response with a first corrupted task and a well formed task:\nhttps://jira.nuxeo.com/browse/NXP-28798?focusedCommentId=453928&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-453928", "author": "NourNuxeo", "createdAt": "2020-05-06T08:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4NDA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ5OTQxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r421499410", "bodyText": "As @efge said in one of his comments, you should log something meaningful if possible:\nlog.warn(\"Failed to get workflow instance\", e)\n\nBTW, do we want the whole stack trace for a WARN? (cc @kevinleturc)", "author": "troger", "createdAt": "2020-05-07T13:23:08Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -108,7 +113,12 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n             if (StringUtils.isNotBlank(workflowInstanceId)) {\n                 NodeAccessRunner nodeAccessRunner = new NodeAccessRunner(wrapper.getSession(), workflowInstanceId,\n                         nodeId);\n-                nodeAccessRunner.runUnrestricted();\n+                try {\n+                    nodeAccessRunner.runUnrestricted();\n+                } catch (DocumentNotFoundException e) {\n+                    // If the DocumentRoute is not found (deleted for example), the TaskWriter fails.\n+                    log.warn(e, e);", "originalCommit": "05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwNDkzNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r421504935", "bodyText": "I would say no as this is a valid error case, I'm wondering if we still want it behind a debug/trace level.", "author": "kevinleturc", "createdAt": "2020-05-07T13:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ5OTQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE1NjE5Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r425156196", "bodyText": "So a simple:\nlog.warn(\"Failed to get workflow instance: {}\", workflowInstanceId);\nlog.debug(e, e);\n\n?", "author": "troger", "createdAt": "2020-05-14T13:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ5OTQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4NzI4NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r425187285", "bodyText": "Looks good \ud83d\udc4d", "author": "kevinleturc", "createdAt": "2020-05-14T14:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ5OTQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwMDQ5NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r421500494", "bodyText": "The comment is not accurate, the TaskWriter does not fail anymore with your fix. Keep it simple...\n// Workflow instance not found\n\nI'm not sure it's even needed according to the DocumentNotFoundException and the log message?", "author": "troger", "createdAt": "2020-05-07T13:24:39Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -108,7 +113,12 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n             if (StringUtils.isNotBlank(workflowInstanceId)) {\n                 NodeAccessRunner nodeAccessRunner = new NodeAccessRunner(wrapper.getSession(), workflowInstanceId,\n                         nodeId);\n-                nodeAccessRunner.runUnrestricted();\n+                try {\n+                    nodeAccessRunner.runUnrestricted();\n+                } catch (DocumentNotFoundException e) {\n+                    // If the DocumentRoute is not found (deleted for example), the TaskWriter fails.", "originalCommit": "05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwMjc3Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r421502776", "bodyText": "At the begining the catch was at the end of the try resource (way more line below) so I explained why I was catching.\nI should have removed it when I made a very local try catch", "author": "NourNuxeo", "createdAt": "2020-05-07T13:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwMDQ5NA=="}], "type": "inlineReview"}, {"oid": "19e6e7255150b49435aad16f49bd344eac6e9f96", "url": "https://github.com/nuxeo/nuxeo/commit/19e6e7255150b49435aad16f49bd344eac6e9f96", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-07T13:48:32Z", "type": "forcePushed"}, {"oid": "53cdce0b4a8c15ca319b9416037f3d95b38ed2ca", "url": "https://github.com/nuxeo/nuxeo/commit/53cdce0b4a8c15ca319b9416037f3d95b38ed2ca", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-07T13:49:41Z", "type": "forcePushed"}, {"oid": "32b83de855f85bcc38b0e397b5bce412996b19a6", "url": "https://github.com/nuxeo/nuxeo/commit/32b83de855f85bcc38b0e397b5bce412996b19a6", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-12T16:51:43Z", "type": "forcePushed"}, {"oid": "95fb469720cd0cd415e5b81fa2a4e258605a430f", "url": "https://github.com/nuxeo/nuxeo/commit/95fb469720cd0cd415e5b81fa2a4e258605a430f", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-12T16:56:28Z", "type": "forcePushed"}, {"oid": "6d6596b558ea5ac0a7f0923622370e07892ac840", "url": "https://github.com/nuxeo/nuxeo/commit/6d6596b558ea5ac0a7f0923622370e07892ac840", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-13T08:36:55Z", "type": "forcePushed"}, {"oid": "39494bd67fbab7001d5214e717042db144b058d8", "url": "https://github.com/nuxeo/nuxeo/commit/39494bd67fbab7001d5214e717042db144b058d8", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-13T08:57:28Z", "type": "forcePushed"}, {"oid": "f1931077add39813fe3deb98bf5e1bf11325d194", "url": "https://github.com/nuxeo/nuxeo/commit/f1931077add39813fe3deb98bf5e1bf11325d194", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-13T09:20:22Z", "type": "forcePushed"}, {"oid": "959e893f1bb40a6f3e7f56f9cefada415135c9f4", "url": "https://github.com/nuxeo/nuxeo/commit/959e893f1bb40a6f3e7f56f9cefada415135c9f4", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-13T09:26:56Z", "type": "forcePushed"}, {"oid": "da7342e0dd54288c63073fec57ff57354199d979", "url": "https://github.com/nuxeo/nuxeo/commit/da7342e0dd54288c63073fec57ff57354199d979", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-14T15:10:59Z", "type": "forcePushed"}, {"oid": "cd73c8ec7730004f97985eef288e71c74bf9e3ff", "url": "https://github.com/nuxeo/nuxeo/commit/cd73c8ec7730004f97985eef288e71c74bf9e3ff", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-14T15:12:47Z", "type": "commit"}, {"oid": "a455f292f864a07f7e93239027de1611254f891c", "url": "https://github.com/nuxeo/nuxeo/commit/a455f292f864a07f7e93239027de1611254f891c", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-14T15:13:02Z", "type": "forcePushed"}, {"oid": "479fce0e5c4917e0b22dfab4f93649494cabce4d", "url": "https://github.com/nuxeo/nuxeo/commit/479fce0e5c4917e0b22dfab4f93649494cabce4d", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-05-20T14:19:03Z", "type": "forcePushed"}, {"oid": "547ad04d66709304d92307555f1794058aa83e94", "url": "https://github.com/nuxeo/nuxeo/commit/547ad04d66709304d92307555f1794058aa83e94", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-05-20T14:20:39Z", "type": "forcePushed"}, {"oid": "1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "url": "https://github.com/nuxeo/nuxeo/commit/1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-05-20T15:13:10Z", "type": "forcePushed"}, {"oid": "f54b65fe4cda0a66e4357dce4c373b92790fd34a", "url": "https://github.com/nuxeo/nuxeo/commit/f54b65fe4cda0a66e4357dce4c373b92790fd34a", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-05-20T15:29:55Z", "type": "forcePushed"}, {"oid": "bcbd4b29bf6ab24ea93412f006b83e668da3939b", "url": "https://github.com/nuxeo/nuxeo/commit/bcbd4b29bf6ab24ea93412f006b83e668da3939b", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-06-04T09:55:44Z", "type": "forcePushed"}, {"oid": "60f843918ec32efa03c4992dc0fbf859c85ad9db", "url": "https://github.com/nuxeo/nuxeo/commit/60f843918ec32efa03c4992dc0fbf859c85ad9db", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-06-08T14:49:45Z", "type": "forcePushed"}, {"oid": "48fa1a0049f4ec36f9a3d002ff80bfbc081a39fe", "url": "https://github.com/nuxeo/nuxeo/commit/48fa1a0049f4ec36f9a3d002ff80bfbc081a39fe", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-06-09T10:36:18Z", "type": "commit"}, {"oid": "48fa1a0049f4ec36f9a3d002ff80bfbc081a39fe", "url": "https://github.com/nuxeo/nuxeo/commit/48fa1a0049f4ec36f9a3d002ff80bfbc081a39fe", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-06-09T10:36:18Z", "type": "forcePushed"}]}