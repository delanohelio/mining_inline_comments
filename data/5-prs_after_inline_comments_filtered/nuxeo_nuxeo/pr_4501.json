{"pr_number": 4501, "pr_title": "NXP-29798: Implement get server info endpoint", "pr_createdAt": "2020-12-01T15:37:58Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4501", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUxNDIwMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4501#discussion_r533514201", "bodyText": "isClusterEnabled would be useful too I think", "author": "efge", "createdAt": "2020-12-01T15:44:23Z", "path": "modules/platform/nuxeo-admin-center/nuxeo-admin-center-core/src/main/java/org/nuxeo/ecm/admin/runtime/ServerInfo.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.admin.runtime;\n+\n+import static org.nuxeo.common.Environment.DISTRIBUTION_HOTFIX;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_NAME;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_SERVER;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_VERSION;\n+\n+import java.util.Optional;\n+\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.cluster.ClusterService;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class ServerInfo {\n+\n+    protected String distributionName;\n+\n+    protected String distributionVersion;\n+\n+    protected String distributionServer;\n+\n+    protected String hotfixVersion;\n+\n+    protected String clusterNodeId;\n+\n+    protected ServerInfo() {\n+    }\n+\n+    public String getDistributionName() {\n+        return distributionName;\n+    }\n+\n+    public String getDistributionVersion() {\n+        return distributionVersion;\n+    }\n+\n+    public String getDistributionServer() {\n+        return distributionServer;\n+    }\n+\n+    public Optional<String> getHotfixVersion() {\n+        return Optional.ofNullable(hotfixVersion);\n+    }\n+\n+    public String getClusterNodeId() {", "originalCommit": "f43244556866257fb32f599e7cec79991e565323", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc7edf313098a8312bce8400371fa43ff749deb7", "url": "https://github.com/nuxeo/nuxeo/commit/cc7edf313098a8312bce8400371fa43ff749deb7", "message": "NXP-29798: Implement get server info endpoint", "committedDate": "2020-12-03T08:37:51Z", "type": "forcePushed"}, {"oid": "3fa215837bcedec98731d58899e8db1686dcfc1f", "url": "https://github.com/nuxeo/nuxeo/commit/3fa215837bcedec98731d58899e8db1686dcfc1f", "message": "NXP-29798: Implement get server info endpoint", "committedDate": "2020-12-04T15:13:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIxMTEzNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4501#discussion_r536211135", "bodyText": "Can you assert clusterEnabled too?", "author": "efge", "createdAt": "2020-12-04T16:12:30Z", "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/server/jaxrs/TestServerInfoObject.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.restapi.server.jaxrs;\n+\n+import static javax.ws.rs.core.MediaType.WILDCARD;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_HOTFIX;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_NAME;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_SERVER;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_VERSION;\n+import static org.nuxeo.ecm.core.io.registry.MarshallingConstants.ENTITY_FIELD_NAME;\n+\n+import java.io.IOException;\n+\n+import javax.inject.Inject;\n+import javax.servlet.http.HttpServletResponse;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.io.APIVersion;\n+import org.nuxeo.ecm.restapi.jaxrs.io.capabilities.ServerInfoJsonWriter;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.jaxrs.test.CloseableClientResponse;\n+import org.nuxeo.jaxrs.test.HttpClientTestRule;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.ServletContainerFeature;\n+import org.nuxeo.runtime.test.runner.WithFrameworkProperty;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+/**\n+ * @since 11.5\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features(RestServerFeature.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:test-cluster.xml\")\n+public class TestServerInfoObject {\n+\n+    @Inject\n+    protected ServletContainerFeature servletContainerFeature;\n+\n+    protected HttpClientTestRule httpClientRule;\n+\n+    protected ObjectMapper mapper = new ObjectMapper();\n+\n+    protected HttpClientTestRule getRule() {\n+        String url = String.format(\"http://localhost:%d/api/v%d\", servletContainerFeature.getPort(),\n+                APIVersion.latest().toInt());\n+        return new HttpClientTestRule.Builder().url(url).adminCredentials().accept(WILDCARD).build();\n+    }\n+\n+    @Before\n+    public void before() {\n+        httpClientRule = getRule();\n+        httpClientRule.starting();\n+    }\n+\n+    @After\n+    public void after() {\n+        httpClientRule.finished();\n+    }\n+\n+    @Test\n+    @WithFrameworkProperty(name = DISTRIBUTION_NAME, value = DISTRIBUTION_NAME)\n+    @WithFrameworkProperty(name = DISTRIBUTION_VERSION, value = DISTRIBUTION_VERSION)\n+    @WithFrameworkProperty(name = DISTRIBUTION_SERVER, value = DISTRIBUTION_SERVER)\n+    public void testGet() throws IOException {\n+        try (CloseableClientResponse response = httpClientRule.get(\"/server\")) {\n+            assertEquals(HttpServletResponse.SC_OK, response.getStatus());\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+\n+            assertEquals(ServerInfoJsonWriter.ENTITY_TYPE, node.get(ENTITY_FIELD_NAME).asText());\n+            assertEquals(DISTRIBUTION_NAME, node.get(\"distributionName\").asText());\n+            assertEquals(DISTRIBUTION_VERSION, node.get(\"distributionVersion\").asText());\n+            assertEquals(DISTRIBUTION_SERVER, node.get(\"distributionServer\").asText());\n+            assertNull(node.get(\"hotfixVersion\"));\n+            assertEquals(\"123\", node.get(\"clusterNodeId\").asText());", "originalCommit": "3fa215837bcedec98731d58899e8db1686dcfc1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d679e15ada6e6965ee5985f1777eb180a39dc00", "url": "https://github.com/nuxeo/nuxeo/commit/3d679e15ada6e6965ee5985f1777eb180a39dc00", "message": "NXP-29798: Implement get server info endpoint", "committedDate": "2020-12-07T09:24:18Z", "type": "commit"}, {"oid": "3d679e15ada6e6965ee5985f1777eb180a39dc00", "url": "https://github.com/nuxeo/nuxeo/commit/3d679e15ada6e6965ee5985f1777eb180a39dc00", "message": "NXP-29798: Implement get server info endpoint", "committedDate": "2020-12-07T09:24:18Z", "type": "forcePushed"}]}