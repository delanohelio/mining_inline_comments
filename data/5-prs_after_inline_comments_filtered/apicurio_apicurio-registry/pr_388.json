{"pr_number": 388, "pr_title": "Autodetect xml type", "pr_createdAt": "2020-04-20T14:19:59Z", "pr_url": "https://github.com/Apicurio/apicurio-registry/pull/388", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MDE1Mw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411580153", "bodyText": "Can you remove this?  It's not needed.", "author": "EricWittmann", "createdAt": "2020-04-20T18:00:09Z", "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -29,29 +38,49 @@\n  * @author eric.wittmann@gmail.com\n  */\n public final class ArtifactTypeUtil {\n-    \n+\n     private static final ObjectMapper mapper = new ObjectMapper();\n-    \n+\n+    protected static ThreadLocal<DocumentBuilder> threadLocaldocBuilder = new ThreadLocal<DocumentBuilder>() {\n+        @Override\n+        protected DocumentBuilder initialValue() {\n+            DocumentBuilder builder = null;\n+            try {\n+                DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+                factory.setNamespaceAware(true);\n+                builder = factory.newDocumentBuilder();\n+            } catch (ParserConfigurationException e) {\n+                throw new RuntimeException(e);\n+            }\n+            return builder;\n+        }\n+\n+        @Override\n+        public DocumentBuilder get() {\n+            return super.get();\n+        }", "originalCommit": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MTk4Mw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411581983", "bodyText": "This should be the \"else\" clause in this logic.  Should be:  if isXsd() else if isWsdl() else { type = XML }", "author": "EricWittmann", "createdAt": "2020-04-20T18:03:00Z", "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -84,20 +113,47 @@ public static ArtifactType discoverType(ContentHandle content, String contentTyp\n         } catch (Exception e) {\n             // Apparently it's not JSON.\n         }\n-        \n+\n         // Try protobuf (only if we haven't already)\n         if (!triedProto) {\n             ArtifactType type = tryProto(content);\n             if (type != null) {\n                 return type;\n             }\n         }\n-        \n+\n         // Try GraphQL (SDL)\n         if (tryGraphQL(content)) {\n             return ArtifactType.GRAPHQL;\n         }\n-        \n+\n+        // Try the various XML formatted types\n+        try (InputStream stream = content.stream()) {\n+            Document xmlDocument = threadLocaldocBuilder.get().parse(stream);\n+            Element root = xmlDocument.getDocumentElement();\n+            String ns = root.getNamespaceURI();\n+\n+            if (ns == null) {\n+                // XML\n+                return ArtifactType.XML;\n+            }", "originalCommit": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MzAwOA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411583008", "bodyText": "Note that you can have a XML file with a namespace that is not null.  This is very common.  For example:\n<ns:foo xmlns:ns=\"uri:my-custom-ns\">\n</ns:foo>\nThat is a simple XML file where the root element has a namespace of uri:my-custom-ns.", "author": "EricWittmann", "createdAt": "2020-04-20T18:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MTk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYwNzAzNQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411607035", "bodyText": "Yep I was catching that with the last return XML - better to do it this way", "author": "cfoskin", "createdAt": "2020-04-20T18:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MTk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYxNDk5Nw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411614997", "bodyText": "Ah yes OK I missed that.", "author": "EricWittmann", "createdAt": "2020-04-20T18:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MTk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NDEzMw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411584133", "bodyText": "We need to be more specific here - don't use contains.  Use equals and specifically check for the XSD namespace:  http://www.w3.org/2001/XMLSchema", "author": "EricWittmann", "createdAt": "2020-04-20T18:06:36Z", "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -84,20 +113,47 @@ public static ArtifactType discoverType(ContentHandle content, String contentTyp\n         } catch (Exception e) {\n             // Apparently it's not JSON.\n         }\n-        \n+\n         // Try protobuf (only if we haven't already)\n         if (!triedProto) {\n             ArtifactType type = tryProto(content);\n             if (type != null) {\n                 return type;\n             }\n         }\n-        \n+\n         // Try GraphQL (SDL)\n         if (tryGraphQL(content)) {\n             return ArtifactType.GRAPHQL;\n         }\n-        \n+\n+        // Try the various XML formatted types\n+        try (InputStream stream = content.stream()) {\n+            Document xmlDocument = threadLocaldocBuilder.get().parse(stream);\n+            Element root = xmlDocument.getDocumentElement();\n+            String ns = root.getNamespaceURI();\n+\n+            if (ns == null) {\n+                // XML\n+                return ArtifactType.XML;\n+            }\n+\n+            // XSD\n+            if (ns.contains(\"www.w3.org/2001/XMLSchema\")) {\n+                return ArtifactType.XSD;\n+            }", "originalCommit": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NTIzNw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411585237", "bodyText": "I do not believe there are multiple versions of XML Schema that we have to check for.", "author": "EricWittmann", "createdAt": "2020-04-20T18:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NDEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NzYyNA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411587624", "bodyText": "\ud83d\udc4d", "author": "cfoskin", "createdAt": "2020-04-20T18:12:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NDEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NzMzNw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411587337", "bodyText": "We should look for specific namespace(s) here rather than use contains.  I think we need to check both of these:\n\nhttp://schemas.xmlsoap.org/wsdl/\nhttp://www.w3.org/ns/wsdl\n\nI do not believe that 2nd namespace ever got much traction, but that is WSDL 2.0's namespace.", "author": "EricWittmann", "createdAt": "2020-04-20T18:11:42Z", "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -84,20 +113,47 @@ public static ArtifactType discoverType(ContentHandle content, String contentTyp\n         } catch (Exception e) {\n             // Apparently it's not JSON.\n         }\n-        \n+\n         // Try protobuf (only if we haven't already)\n         if (!triedProto) {\n             ArtifactType type = tryProto(content);\n             if (type != null) {\n                 return type;\n             }\n         }\n-        \n+\n         // Try GraphQL (SDL)\n         if (tryGraphQL(content)) {\n             return ArtifactType.GRAPHQL;\n         }\n-        \n+\n+        // Try the various XML formatted types\n+        try (InputStream stream = content.stream()) {\n+            Document xmlDocument = threadLocaldocBuilder.get().parse(stream);\n+            Element root = xmlDocument.getDocumentElement();\n+            String ns = root.getNamespaceURI();\n+\n+            if (ns == null) {\n+                // XML\n+                return ArtifactType.XML;\n+            }\n+\n+            // XSD\n+            if (ns.contains(\"www.w3.org/2001/XMLSchema\")) {\n+                return ArtifactType.XSD;\n+            }\n+\n+            // WSDL\n+            if (ns.contains(\"schemas.xmlsoap.org/wsdl\")) {\n+                return ArtifactType.WSDL;\n+            }", "originalCommit": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYxNTc1NA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411615754", "bodyText": "Now I see better why you had the null check up top.  But this is good I think.", "author": "EricWittmann", "createdAt": "2020-04-20T18:57:35Z", "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -84,20 +108,41 @@ public static ArtifactType discoverType(ContentHandle content, String contentTyp\n         } catch (Exception e) {\n             // Apparently it's not JSON.\n         }\n-        \n+\n         // Try protobuf (only if we haven't already)\n         if (!triedProto) {\n             ArtifactType type = tryProto(content);\n             if (type != null) {\n                 return type;\n             }\n         }\n-        \n+\n         // Try GraphQL (SDL)\n         if (tryGraphQL(content)) {\n             return ArtifactType.GRAPHQL;\n         }\n-        \n+\n+        // Try the various XML formatted types\n+        try (InputStream stream = content.stream()) {\n+            Document xmlDocument = threadLocaldocBuilder.get().parse(stream);\n+            Element root = xmlDocument.getDocumentElement();\n+            String ns = root.getNamespaceURI();\n+\n+            // XSD\n+            if (ns != null && ns.equals(\"http://www.w3.org/2001/XMLSchema\")) {\n+                return ArtifactType.XSD;\n+            } // WSDL\n+            else if (ns != null && (ns.equals(\"http://schemas.xmlsoap.org/wsdl/\")\n+                    || ns.equals(\"http://www.w3.org/ns/wsdl/\"))) {\n+                return ArtifactType.WSDL;\n+            } else {\n+                // default to XML since its been parsed\n+                return ArtifactType.XML;\n+            }", "originalCommit": "28ea0b94c377ad02d85e0086b721576fe57346d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyMDIyNw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411620227", "bodyText": "\ud83d\udc4d", "author": "cfoskin", "createdAt": "2020-04-20T19:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYxNTc1NA=="}], "type": "inlineReview"}, {"oid": "5deb6f3600c1ed39c877ec7a4719a893234fa372", "url": "https://github.com/Apicurio/apicurio-registry/commit/5deb6f3600c1ed39c877ec7a4719a893234fa372", "message": "feedback", "committedDate": "2020-04-20T18:54:16Z", "type": "forcePushed"}, {"oid": "392bb6d67d1468f9b8123be7dfa692803c2c3105", "url": "https://github.com/Apicurio/apicurio-registry/commit/392bb6d67d1468f9b8123be7dfa692803c2c3105", "message": "added autodetection for xml,wsdl or xsd", "committedDate": "2020-04-20T19:02:44Z", "type": "commit"}, {"oid": "e793c25d01175d95760953023fd4e0bd812f75a9", "url": "https://github.com/Apicurio/apicurio-registry/commit/e793c25d01175d95760953023fd4e0bd812f75a9", "message": "removed unused import", "committedDate": "2020-04-20T19:02:44Z", "type": "commit"}, {"oid": "9683d45234d8915b5712747798eec1d868085d9a", "url": "https://github.com/Apicurio/apicurio-registry/commit/9683d45234d8915b5712747798eec1d868085d9a", "message": "feedback", "committedDate": "2020-04-20T19:02:44Z", "type": "commit"}, {"oid": "9683d45234d8915b5712747798eec1d868085d9a", "url": "https://github.com/Apicurio/apicurio-registry/commit/9683d45234d8915b5712747798eec1d868085d9a", "message": "feedback", "committedDate": "2020-04-20T19:02:44Z", "type": "forcePushed"}]}