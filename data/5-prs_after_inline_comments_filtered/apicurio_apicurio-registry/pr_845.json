{"pr_number": 845, "pr_title": "Add TLS auth support to rest client calls", "pr_createdAt": "2020-09-16T14:49:26Z", "pr_url": "https://github.com/Apicurio/apicurio-registry/pull/845", "timeline": [{"oid": "fffc888c18a47ae704d0b43413604fa38ce01baf", "url": "https://github.com/Apicurio/apicurio-registry/commit/fffc888c18a47ae704d0b43413604fa38ce01baf", "message": "Add TLS auth support to rest client calls\n\n - This commit adds support for HTTPS calls to apicurio-registry with or\nwithout TLS client auth. Supported configuration keys are:\n   - `apicurio.registry.request.ssl.truststore.location`\n   - `apicurio.registry.request.ssl.truststore.password`\n   - `apicurio.registry.request.ssl.truststore.type`\n   - `apicurio.registry.request.ssl.keystore.location`\n   - `apicurio.registry.request.ssl.keystore.password`\n   - `apicurio.registry.request.ssl.keystore.type`\n   - `apicurio.registry.request.ssl.key.password`\n - It also refactors the request header handling code to move it out of\nthe serdes code and into the RegistryRestClient, so all clients can use\nit. This includes the basic auth handling for when the username and\npassword are encoded in the URL.\n\nSigned-off-by: Andrew Borley <borley@uk.ibm.com>", "committedDate": "2020-09-16T16:16:27Z", "type": "forcePushed"}, {"oid": "ec5308a5918ceedad6576250c4608a2eb0e0ce48", "url": "https://github.com/Apicurio/apicurio-registry/commit/ec5308a5918ceedad6576250c4608a2eb0e0ce48", "message": "Add TLS auth support to rest client calls\n\n - This commit adds support for HTTPS calls to apicurio-registry with or\nwithout TLS client auth. Supported configuration keys are:\n   - `apicurio.registry.request.ssl.truststore.location`\n   - `apicurio.registry.request.ssl.truststore.password`\n   - `apicurio.registry.request.ssl.truststore.type`\n   - `apicurio.registry.request.ssl.keystore.location`\n   - `apicurio.registry.request.ssl.keystore.password`\n   - `apicurio.registry.request.ssl.keystore.type`\n   - `apicurio.registry.request.ssl.key.password`\n - It also refactors the request header handling code to move it out of\nthe serdes code and into the RegistryRestClient, so all clients can use\nit. This includes the basic auth handling for when the username and\npassword are encoded in the URL.\n\nSigned-off-by: Andrew Borley <borley@uk.ibm.com>", "committedDate": "2020-09-16T21:13:43Z", "type": "commit"}, {"oid": "ec5308a5918ceedad6576250c4608a2eb0e0ce48", "url": "https://github.com/Apicurio/apicurio-registry/commit/ec5308a5918ceedad6576250c4608a2eb0e0ce48", "message": "Add TLS auth support to rest client calls\n\n - This commit adds support for HTTPS calls to apicurio-registry with or\nwithout TLS client auth. Supported configuration keys are:\n   - `apicurio.registry.request.ssl.truststore.location`\n   - `apicurio.registry.request.ssl.truststore.password`\n   - `apicurio.registry.request.ssl.truststore.type`\n   - `apicurio.registry.request.ssl.keystore.location`\n   - `apicurio.registry.request.ssl.keystore.password`\n   - `apicurio.registry.request.ssl.keystore.type`\n   - `apicurio.registry.request.ssl.key.password`\n - It also refactors the request header handling code to move it out of\nthe serdes code and into the RegistryRestClient, so all clients can use\nit. This includes the basic auth handling for when the username and\npassword are encoded in the URL.\n\nSigned-off-by: Andrew Borley <borley@uk.ibm.com>", "committedDate": "2020-09-16T21:13:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAxODU1Mw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/845#discussion_r490018553", "bodyText": "Maybe these checks could be extracted to separated methods?", "author": "carlesarnal", "createdAt": "2020-09-17T07:09:10Z", "path": "rest-client/src/main/java/io/apicurio/registry/client/RegistryRestClientImpl.java", "diffHunk": "@@ -79,31 +112,84 @@\n         initServices(retrofit);\n     }\n \n-    RegistryRestClientImpl(String baseUrl, Map<String, String> headers) {\n-        if (!baseUrl.endsWith(\"/\")) {\n-            baseUrl += \"/\";\n-        }\n+    private static OkHttpClient createHttpClientWithConfig(String baseUrl, Map<String, Object> configs) {\n+        OkHttpClient.Builder okHttpClientBuilder = new OkHttpClient.Builder();\n+        okHttpClientBuilder = addHeaders(okHttpClientBuilder, baseUrl, configs);\n+        okHttpClientBuilder = addSSL(okHttpClientBuilder, configs);\n+        return okHttpClientBuilder.build();\n+    }\n \n-        final OkHttpClient okHttpClient = createWithHeaders(headers);\n+    private static OkHttpClient.Builder addHeaders(OkHttpClient.Builder okHttpClientBuilder, String baseUrl, Map<String, Object> configs) {\n \n-        this.retrofit = new Retrofit.Builder()\n-                .client(okHttpClient)\n-                .addConverterFactory(JacksonConverterFactory.create())\n-                .baseUrl(baseUrl)\n-                .build();\n+        Map<String, String> requestHeaders = configs.entrySet().stream()\n+            .filter(map -> map.getKey().startsWith(REGISTRY_REQUEST_HEADERS_PREFIX))\n+            .collect(Collectors.toMap(map -> map.getKey()\n+                .replace(REGISTRY_REQUEST_HEADERS_PREFIX, \"\"), map -> map.getValue().toString()));\n \n-        this.requestHandler = new RequestHandler();\n+        if(!requestHeaders.containsKey(\"Authorization\")) {\n+            // Check if url includes user/password\n+            // and add auth header if it does\n+            HttpUrl url = HttpUrl.parse(baseUrl);\n+            String user = url.encodedUsername();\n+            String pwd = url.encodedPassword();\n+            if (user != null && !user.isEmpty()) {\n+                String credentials = Credentials.basic(user, pwd);\n+                requestHeaders.put(\"Authorization\", credentials);\n+            }\n+        }\n \n-        initServices(retrofit);\n+        if(!requestHeaders.isEmpty()) {\n+            final Interceptor headersInterceptor = new HeadersInterceptor(requestHeaders);\n+            return okHttpClientBuilder.addInterceptor(headersInterceptor);\n+        } else {\n+            return okHttpClientBuilder;\n+        }\n     }\n \n-    private static OkHttpClient createWithHeaders(Map<String, String> headers) {\n-\n-        final Interceptor headersInterceptor = new HeadersInterceptor(headers);\n-\n-        return new OkHttpClient.Builder()\n-                .addInterceptor(headersInterceptor)\n-                .build();\n+    private static OkHttpClient.Builder addSSL(OkHttpClient.Builder okHttpClientBuilder, Map<String, Object> configs) {\n+\n+        try {\n+            KeyManager[] keyManagers = null;\n+            TrustManager[] trustManagers = null;\n+\n+            if (configs.containsKey(REGISTRY_REQUEST_KEYSTORE_LOCATION)) {", "originalCommit": "ec5308a5918ceedad6576250c4608a2eb0e0ce48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5NDk1OA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/845#discussion_r490094958", "bodyText": "Good idea - I have refactored in my latest commit \ud83d\udc4d", "author": "ajborley", "createdAt": "2020-09-17T09:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAxODU1Mw=="}], "type": "inlineReview"}, {"oid": "50f5beef66449a8bc13a016a92cc06e966cb5f0a", "url": "https://github.com/Apicurio/apicurio-registry/commit/50f5beef66449a8bc13a016a92cc06e966cb5f0a", "message": "Address review comments\n\n - Refactor the `addSSL` method to separate out the KeyManager and\nTrustManager retrieval.\n\nSigned-off-by: Andrew Borley <borley@uk.ibm.com>", "committedDate": "2020-09-17T09:06:29Z", "type": "commit"}]}