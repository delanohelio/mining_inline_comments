{"pr_number": 1835, "pr_title": "Migrate pillar and formula data on minion id change", "pr_createdAt": "2020-01-27T16:28:21Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/1835", "timeline": [{"oid": "4d3d0bea0ce982556f1f61e6fc338d0e21b1845c", "url": "https://github.com/uyuni-project/uyuni/commit/4d3d0bea0ce982556f1f61e6fc338d0e21b1845c", "message": "Migrate pillar and formula data on minion id change", "committedDate": "2020-02-03T13:31:14Z", "type": "forcePushed"}, {"oid": "ce090dee1c6ea2687f62f0ef44a1b2d1d478f432", "url": "https://github.com/uyuni-project/uyuni/commit/ce090dee1c6ea2687f62f0ef44a1b2d1d478f432", "message": "Allow twenties in copyright year", "committedDate": "2020-02-03T16:20:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE3ODg5Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/1835#discussion_r375178892", "bodyText": "Nitpick: just inline the Optional.of(oldMinionId) directly in method parameter", "author": "admd", "createdAt": "2020-02-05T10:38:00Z", "path": "java/code/src/com/suse/manager/reactor/messaging/RegisterMinionEventMessageAction.java", "diffHunk": "@@ -225,15 +225,21 @@ public boolean checkIfMinionAlreadyRegistered(String minionId,\n             if (!minionId.equals(oldMinionId)) {\n                 LOG.warn(\"Minion '\" + oldMinionId + \"' already registered, updating \" +\n                         \"profile to '\" + minionId + \"' [\" + machineId + \"]\");\n+\n                 registeredMinion.setName(minionId);\n                 registeredMinion.setMinionId(minionId);\n                 ServerFactory.save(registeredMinion);\n-                SystemManager.addHistoryEvent(registeredMinion, \"Duplicate Machine ID\", \"Minion '\" +\n-                        oldMinionId + \"' has been updated to '\" + minionId + \"'\");\n \n-                if (!minionId.equals(oldMinionId)) {\n-                    SALT_SERVICE.deleteKey(oldMinionId);\n-                }\n+                SaltStateGeneratorService.INSTANCE.generatePillar(registeredMinion);\n+                SaltStateGeneratorService.INSTANCE.removePillar(oldMinionId);\n+\n+                Optional<String> optOldMinionId = Optional.of(oldMinionId);\n+                migrateMinionFormula(minionId, optOldMinionId);", "originalCommit": "ce090dee1c6ea2687f62f0ef44a1b2d1d478f432", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE3OTgzNA==", "url": "https://github.com/uyuni-project/uyuni/pull/1835#discussion_r375179834", "bodyText": "Nitpick: We are not checking here if the server is minion, rather it is already assumed so maybe update the method docs accordingly.", "author": "admd", "createdAt": "2020-02-05T10:39:53Z", "path": "java/code/src/com/suse/manager/webui/services/SaltStateGeneratorService.java", "diffHunk": "@@ -384,9 +384,17 @@ private String getImagePillarFileName(OSImageInspectSlsResult.Bundle bundle) {\n      * @param minion the minion server\n      */\n     public void removePillar(MinionServer minion) {\n-        LOG.debug(\"Removing pillar file for minion: \" + minion.getMinionId());\n+        removePillar(minion.getMinionId());\n+    }\n+\n+    /**\n+     * Remove the corresponding pillar data if the server is a minion.", "originalCommit": "ce090dee1c6ea2687f62f0ef44a1b2d1d478f432", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "496735686962fb29651f6ec00c46ec2b55f47191", "url": "https://github.com/uyuni-project/uyuni/commit/496735686962fb29651f6ec00c46ec2b55f47191", "message": "Allow twenties in copyright year", "committedDate": "2020-02-05T12:46:02Z", "type": "forcePushed"}, {"oid": "465732b4f679d3f1a2d6b1243f1fd73570938a2a", "url": "https://github.com/uyuni-project/uyuni/commit/465732b4f679d3f1a2d6b1243f1fd73570938a2a", "message": "Migrate pillar and formula data on minion id change", "committedDate": "2020-02-06T13:00:46Z", "type": "commit"}, {"oid": "465732b4f679d3f1a2d6b1243f1fd73570938a2a", "url": "https://github.com/uyuni-project/uyuni/commit/465732b4f679d3f1a2d6b1243f1fd73570938a2a", "message": "Migrate pillar and formula data on minion id change", "committedDate": "2020-02-06T13:00:46Z", "type": "forcePushed"}]}