{"pr_number": 2317, "pr_title": "Virt disks", "pr_createdAt": "2020-06-10T09:54:21Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2317", "timeline": [{"oid": "7c93cc9b53c10c5557030ac6125ae695511403ce", "url": "https://github.com/uyuni-project/uyuni/commit/7c93cc9b53c10c5557030ac6125ae695511403ce", "message": "Don't remove the virtual instance when deleting a virtual system\n\nWhen a virtual instance's host is known don't remove it when deleting\nthe system otherwise the VM will disappear from the guests list of the\nhost too.", "committedDate": "2020-06-12T12:35:06Z", "type": "forcePushed"}, {"oid": "87afc2c9d7e4b54472425f0580ea5d9e85240cdb", "url": "https://github.com/uyuni-project/uyuni/commit/87afc2c9d7e4b54472425f0580ea5d9e85240cdb", "message": "Don't remove the virtual instance when deleting a virtual system\n\nWhen a virtual instance's host is known don't remove it when deleting\nthe system otherwise the VM will disappear from the guests list of the\nhost too.", "committedDate": "2020-06-15T08:14:37Z", "type": "forcePushed"}, {"oid": "fd598ffa885933eeb6f26bb829c62128a7505ee6", "url": "https://github.com/uyuni-project/uyuni/commit/fd598ffa885933eeb6f26bb829c62128a7505ee6", "message": "Update changelogs", "committedDate": "2020-06-17T13:43:54Z", "type": "forcePushed"}, {"oid": "b34cb5b6d0f8cc7ba7984333d566e9533ee24bd2", "url": "https://github.com/uyuni-project/uyuni/commit/b34cb5b6d0f8cc7ba7984333d566e9533ee24bd2", "message": "VM properties dialog: convert disks fields into components\n\nThe existing code was not using React components enough. Converting\nbefore heavy changes.", "committedDate": "2020-06-19T09:54:45Z", "type": "commit"}, {"oid": "51d00ae7169184275d378dd7ef885013f7d059ee", "url": "https://github.com/uyuni-project/uyuni/commit/51d00ae7169184275d378dd7ef885013f7d059ee", "message": "Remove the disk type from the VM properties dialog\n\nThe user doesn't need to specify the disk type for each disk: this will\nbe guessed from the source value. Either it is a file path or a volume\nname.", "committedDate": "2020-06-19T09:54:46Z", "type": "commit"}, {"oid": "aa98fd0053e131d60086046ada5fcaa5b4dbf00b", "url": "https://github.com/uyuni-project/uyuni/commit/aa98fd0053e131d60086046ada5fcaa5b4dbf00b", "message": "Convert GuestProperties to a function component", "committedDate": "2020-06-19T09:54:46Z", "type": "commit"}, {"oid": "6d91b19d5c60b3e51f09a1bef5ea759305063408", "url": "https://github.com/uyuni-project/uyuni/commit/6d91b19d5c60b3e51f09a1bef5ea759305063408", "message": "VM editing dialog: split disk fields into one component per type\n\nSince disk of various types may have different uses and fields, split\nthose into multiple components.", "committedDate": "2020-06-19T09:54:46Z", "type": "commit"}, {"oid": "4ea83437096825487f5b0fba7d73e9a05be7859c", "url": "https://github.com/uyuni-project/uyuni/commit/4ea83437096825487f5b0fba7d73e9a05be7859c", "message": "virt: handle cdrom devices as disks of file type\n\ncdrom devices are pretty likely not to be volumes. Use the file type for\nthem so that users can select file path or URL for the ISO.\n\nAlso remove the paravirtualized items from the busses list since those\naren't supporting cdrom devices.", "committedDate": "2020-06-19T09:54:46Z", "type": "commit"}, {"oid": "5deea3b02e7269162862b4f6a183888dfed00e3a", "url": "https://github.com/uyuni-project/uyuni/commit/5deea3b02e7269162862b4f6a183888dfed00e3a", "message": "virt: add volumes listbox for disks of volume type\n\nTo allow the user to select an existing volume add a volume listbox in\nthe GuestDiskVolumeFields component.", "committedDate": "2020-06-19T09:54:46Z", "type": "commit"}, {"oid": "5f9144743ed1381b9f54693a1d4b9c4d7beb8477", "url": "https://github.com/uyuni-project/uyuni/commit/5f9144743ed1381b9f54693a1d4b9c4d7beb8477", "message": "virt: get pool capabilities in GuestProperties\n\nThe pool capabilities will come in helpful to populate the disk fields.", "committedDate": "2020-06-19T09:54:46Z", "type": "commit"}, {"oid": "c12b5f92a3a32ef8f7d5c0815b9a93889d9dc787", "url": "https://github.com/uyuni-project/uyuni/commit/c12b5f92a3a32ef8f7d5c0815b9a93889d9dc787", "message": "virt: add disk format field\n\nSo far we are defaulting the disk format to qcow2... which works in the\nmajority of cases, but we need to handle other formats. This is even\nmore important when dealing with non-file disks or cdroms devices.", "committedDate": "2020-06-19T09:54:46Z", "type": "commit"}, {"oid": "dbd721d246a04c023330c4faf9dcc1614af0c3be", "url": "https://github.com/uyuni-project/uyuni/commit/dbd721d246a04c023330c4faf9dcc1614af0c3be", "message": "Set the disk volume name in query and state\n\nSalt uses the source_file property to reuse an existing volume in a\npool. Use this property in the UI and query for that too.", "committedDate": "2020-06-19T09:54:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0MjczMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2317#discussion_r442742732", "bodyText": "Nitpick:  Arrays.asList(\"rbd\", \"gluster\") can be extracted into a constant.", "author": "mateiw", "createdAt": "2020-06-19T09:48:33Z", "path": "java/code/src/com/suse/manager/virtualization/GuestDiskDef.java", "diffHunk": "@@ -187,6 +190,31 @@ public static GuestDiskDef parse(Element node) throws IllegalArgumentException {\n                     }\n                 });\n             }\n+\n+            // virt.vm_info provides consolidated file using pools when possible, use it\n+            Optional<VmInfoDiskJson> diskInfo = vmInfo.map(info -> info.getDisks().get(disk.getTarget()));\n+            diskInfo.ifPresent(info -> {\n+                if (\"network\".equals(disk.getType())) {\n+                    String protocol = (String)source.get(\"protocol\");\n+                    // RBD and gluster volumes are automatically converted to network disks. Take the infos from Salt\n+                    if (Arrays.asList(\"rbd\", \"gluster\").contains(protocol) &&", "originalCommit": "fd598ffa885933eeb6f26bb829c62128a7505ee6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0MDIxOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2317#discussion_r442840219", "bodyText": "Done. Thanks", "author": "cbosdo", "createdAt": "2020-06-19T13:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0MjczMg=="}], "type": "inlineReview"}, {"oid": "bcb9f512a89b7291f862597f6df812296a73648d", "url": "https://github.com/uyuni-project/uyuni/commit/bcb9f512a89b7291f862597f6df812296a73648d", "message": "Update changelogs", "committedDate": "2020-06-19T10:12:44Z", "type": "forcePushed"}, {"oid": "42a5cd80c5238637b56518b077a4e3825f268abd", "url": "https://github.com/uyuni-project/uyuni/commit/42a5cd80c5238637b56518b077a4e3825f268abd", "message": "virt getDefinition: merge data from virt.get_xml and virt.vm_info\n\nvirt.vm_info holds the proper pool and volume pair while the XML\ndefinition may have something different like in the RBD case. Merge the\nvirt.vm_info disks data into the existing GuestDefinition", "committedDate": "2020-06-19T13:27:26Z", "type": "commit"}, {"oid": "2a20cf7657ed2ed960061b71eae204136d09067a", "url": "https://github.com/uyuni-project/uyuni/commit/2a20cf7657ed2ed960061b71eae204136d09067a", "message": "VM create/edit: make cdrom path editable", "committedDate": "2020-06-19T13:27:26Z", "type": "commit"}, {"oid": "80e30cf076194c1d07418ab27862d86192bea026", "url": "https://github.com/uyuni-project/uyuni/commit/80e30cf076194c1d07418ab27862d86192bea026", "message": "VM events: don't flag VM as stopped in live updates\n\nWhen updating a VM that is running we need to keep its state rather than\nforcing it marked as stopped.", "committedDate": "2020-06-19T13:27:26Z", "type": "commit"}, {"oid": "65ffbed049078f68c9209e42f5878b8322fc202e", "url": "https://github.com/uyuni-project/uyuni/commit/65ffbed049078f68c9209e42f5878b8322fc202e", "message": "Timeout version of 'I wait until table row for \"test-vm\" contains button \"Resume\"'\n\nSince we want to have longer timeout for this step in the Xen virtual\nhost case, add another step allowing to set how much we wnt to wait.", "committedDate": "2020-06-19T13:27:26Z", "type": "commit"}, {"oid": "100eab85716f753bfab601e5c58fb68d138266bb", "url": "https://github.com/uyuni-project/uyuni/commit/100eab85716f753bfab601e5c58fb68d138266bb", "message": "testsuite: fix minxen feature to pass on nested Xen\n\nIn order to automate the virtualization featutes tests on Xen hypervisor\nwe need to use a nested Xen setup... but this introduces some latencies.\nIncrease some timeouts to handle this.\n\nWe also need to reduce the amount of memory allocated to each test VM.\nWith a 2GB virtual-host, even if we only set 800MB for Dom0 we can't\nspend too much on the VMs.\n\nThis commit also fixes a few Xen-related testsuite issues, like:\n\n * the console file log is a KVM-only feature: use a file console\n   instead.\n * fix the storage pool tests: default pool doesn't exist in the test.", "committedDate": "2020-06-19T13:27:26Z", "type": "commit"}, {"oid": "970312b760601dd5ce94b8df585b378fcdc5dba4", "url": "https://github.com/uyuni-project/uyuni/commit/970312b760601dd5ce94b8df585b378fcdc5dba4", "message": "Test the virtualization host formula", "committedDate": "2020-06-19T13:27:27Z", "type": "commit"}, {"oid": "1e578d43ecb812f9cf17700290f4463dd4764571", "url": "https://github.com/uyuni-project/uyuni/commit/1e578d43ecb812f9cf17700290f4463dd4764571", "message": "testsuite: KVM restart the minion after applying entitlement", "committedDate": "2020-06-19T13:27:27Z", "type": "commit"}, {"oid": "4b1be6c11ea602054fb4c1baf41f23f71112051c", "url": "https://github.com/uyuni-project/uyuni/commit/4b1be6c11ea602054fb4c1baf41f23f71112051c", "message": "virt: update tests to handle volume disks\n\nSince the disks are now handled as volumes in pools, the tests need to\nbe adjusted.", "committedDate": "2020-06-19T13:27:27Z", "type": "commit"}, {"oid": "e7267335dd1a04edc9003e56b1fcf885ae8017d5", "url": "https://github.com/uyuni-project/uyuni/commit/e7267335dd1a04edc9003e56b1fcf885ae8017d5", "message": "testsuite: Test cdrom attach and volume selection", "committedDate": "2020-06-19T13:27:27Z", "type": "commit"}, {"oid": "1d338512ea3940f782eaec5077a1cfca6840685c", "url": "https://github.com/uyuni-project/uyuni/commit/1d338512ea3940f782eaec5077a1cfca6840685c", "message": "Update changelogs", "committedDate": "2020-06-19T13:27:27Z", "type": "commit"}, {"oid": "1d338512ea3940f782eaec5077a1cfca6840685c", "url": "https://github.com/uyuni-project/uyuni/commit/1d338512ea3940f782eaec5077a1cfca6840685c", "message": "Update changelogs", "committedDate": "2020-06-19T13:27:27Z", "type": "forcePushed"}]}