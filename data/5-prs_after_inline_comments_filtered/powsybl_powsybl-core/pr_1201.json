{"pr_number": 1201, "pr_title": "Cgmes update simple update sv file", "pr_createdAt": "2020-03-03T17:39:08Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1201", "timeline": [{"oid": "de47779ee06033672b959e9f934154fdc5060a78", "url": "https://github.com/powsybl/powsybl-core/commit/de47779ee06033672b959e9f934154fdc5060a78", "message": "use getVoltageLevelStream() in StateVariablesAdder for svStatus\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-11T10:13:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYyNzM2Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391627362", "bodyText": "You can replace Arrays.asList(CgmesNames.GRAPH) by Collections.singletonList(CgmesNames.GRAPH)", "author": "MioRtia", "createdAt": "2020-03-12T13:41:15Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -7,86 +7,205 @@\n package com.powsybl.cgmes.conversion.update;\n \n import java.util.Arrays;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n \n+import org.apache.commons.math3.complex.Complex;\n+import org.apache.commons.math3.complex.ComplexUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import com.powsybl.cgmes.model.CgmesModel;\n import com.powsybl.cgmes.model.CgmesNames;\n import com.powsybl.cgmes.model.CgmesSubset;\n import com.powsybl.cgmes.model.triplestore.CgmesModelTripleStore;\n+import com.powsybl.iidm.network.Battery;\n import com.powsybl.iidm.network.Bus;\n+import com.powsybl.iidm.network.Connectable;\n+import com.powsybl.iidm.network.DanglingLine;\n import com.powsybl.iidm.network.Generator;\n import com.powsybl.iidm.network.Load;\n import com.powsybl.iidm.network.Network;\n import com.powsybl.iidm.network.ShuntCompensator;\n+import com.powsybl.iidm.network.StaticVarCompensator;\n import com.powsybl.iidm.network.Terminal;\n+import com.powsybl.iidm.network.ThreeWindingsTransformer;\n import com.powsybl.iidm.network.TwoWindingsTransformer;\n+import com.powsybl.iidm.network.VoltageLevel;\n+import com.powsybl.iidm.network.util.LinkData;\n+import com.powsybl.iidm.network.util.LinkData.BranchAdmittanceMatrix;\n import com.powsybl.triplestore.api.PropertyBag;\n import com.powsybl.triplestore.api.PropertyBags;\n \n /**\n  * @author Marcos de Miguel <demiguelm at aia.es>\n  * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Elena Kaltakova <kaltakovae at aia.es>\n  */\n-public final class StateVariablesAdder {\n+public class StateVariablesAdder {\n \n-    private StateVariablesAdder() {\n+    public StateVariablesAdder(CgmesModel cgmes, Network n) {\n+        this.cgmes = Objects.requireNonNull(cgmes);\n+        this.network = Objects.requireNonNull(n);\n+        this.cimVersion = ((CgmesModelTripleStore) cgmes).getCimVersion();\n+        this.originalTerminals = cgmes.terminals();\n+        this.originalFullModel = cgmes.fullModel(CgmesSubset.STATE_VARIABLES.getProfile());\n+        this.originalTopologicalIslands = cgmes.topologicalIslands();\n+        this.originalSVcontext = originalSVcontext();\n+        this.boundaryNodesFromDanglingLines = boundaryNodesFromDanglingLines();\n     }\n \n-    public static void add(Network n, CgmesModel cgmes) {\n-        // TODO Add full model data with proper profile (StateVariables)\n-        // FullModel is defined in ModelDescription:\n-        // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private String originalSVcontext() {\n+        PropertyBags pbs = cgmes.graph();\n+        PropertyBag defaultSvContext = new PropertyBag(Arrays.asList(CgmesNames.GRAPH));", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5ODQyNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391698424", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-12T15:24:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYyNzM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYyODg5NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391628895", "bodyText": "You can replace boundaryNodesFromDanglingLines.entrySet().forEach(entry -> {...}); by boundaryNodesFromDanglingLines.forEach((key, value) -> {...});", "author": "MioRtia", "createdAt": "2020-03-12T13:43:44Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -7,86 +7,205 @@\n package com.powsybl.cgmes.conversion.update;\n \n import java.util.Arrays;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n \n+import org.apache.commons.math3.complex.Complex;\n+import org.apache.commons.math3.complex.ComplexUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import com.powsybl.cgmes.model.CgmesModel;\n import com.powsybl.cgmes.model.CgmesNames;\n import com.powsybl.cgmes.model.CgmesSubset;\n import com.powsybl.cgmes.model.triplestore.CgmesModelTripleStore;\n+import com.powsybl.iidm.network.Battery;\n import com.powsybl.iidm.network.Bus;\n+import com.powsybl.iidm.network.Connectable;\n+import com.powsybl.iidm.network.DanglingLine;\n import com.powsybl.iidm.network.Generator;\n import com.powsybl.iidm.network.Load;\n import com.powsybl.iidm.network.Network;\n import com.powsybl.iidm.network.ShuntCompensator;\n+import com.powsybl.iidm.network.StaticVarCompensator;\n import com.powsybl.iidm.network.Terminal;\n+import com.powsybl.iidm.network.ThreeWindingsTransformer;\n import com.powsybl.iidm.network.TwoWindingsTransformer;\n+import com.powsybl.iidm.network.VoltageLevel;\n+import com.powsybl.iidm.network.util.LinkData;\n+import com.powsybl.iidm.network.util.LinkData.BranchAdmittanceMatrix;\n import com.powsybl.triplestore.api.PropertyBag;\n import com.powsybl.triplestore.api.PropertyBags;\n \n /**\n  * @author Marcos de Miguel <demiguelm at aia.es>\n  * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Elena Kaltakova <kaltakovae at aia.es>\n  */\n-public final class StateVariablesAdder {\n+public class StateVariablesAdder {\n \n-    private StateVariablesAdder() {\n+    public StateVariablesAdder(CgmesModel cgmes, Network n) {\n+        this.cgmes = Objects.requireNonNull(cgmes);\n+        this.network = Objects.requireNonNull(n);\n+        this.cimVersion = ((CgmesModelTripleStore) cgmes).getCimVersion();\n+        this.originalTerminals = cgmes.terminals();\n+        this.originalFullModel = cgmes.fullModel(CgmesSubset.STATE_VARIABLES.getProfile());\n+        this.originalTopologicalIslands = cgmes.topologicalIslands();\n+        this.originalSVcontext = originalSVcontext();\n+        this.boundaryNodesFromDanglingLines = boundaryNodesFromDanglingLines();\n     }\n \n-    public static void add(Network n, CgmesModel cgmes) {\n-        // TODO Add full model data with proper profile (StateVariables)\n-        // FullModel is defined in ModelDescription:\n-        // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private String originalSVcontext() {\n+        PropertyBags pbs = cgmes.graph();\n+        PropertyBag defaultSvContext = new PropertyBag(Arrays.asList(CgmesNames.GRAPH));\n+        defaultSvContext.put(CgmesNames.GRAPH, CgmesSubset.STATE_VARIABLES.toString());\n+        return pbs.stream()\n+            .filter(graph -> graph.getId(CgmesNames.GRAPH).contains(CgmesSubset.STATE_VARIABLES.getIdentifier()))\n+            .findAny()\n+            .orElse(defaultSvContext)\n+            .getId(CgmesNames.GRAPH);\n+    }\n+\n+    public void addStateVariablesToCgmes() {\n+        if (cgmes.isNodeBreaker()) {\n+            // TODO we need to export SV file data for NodeBraker\n+            LOG.warn(\"NodeBreaker view require further investigation to map correctly Topological Nodes\");\n+            return;\n+        }\n+        // Clear the previous SV data in CGMES model\n+        // and fill it with the Network current state values\n+        cgmes.clear(CgmesSubset.STATE_VARIABLES);\n+\n+        if (cimVersion != 14) {\n+            addModelDescriptionToCgmes();\n+            addTopologicalIslandsToCgmes();\n+        }\n+\n+        addVoltagesForTopologicalNodes();\n+\n+        addVoltagesForBoundaryNodes();\n+\n+        addPowerFlowToCgmes();\n \n+        addShuntCompensatorSectionsToCgmes();\n+\n+        addTapStepToCgmes();\n+\n+        addStatusToCgmes();\n+    }\n+\n+    private void addVoltagesForTopologicalNodes() {\n         PropertyBags voltages = new PropertyBags();\n-        for (Bus b : n.getBusBreakerView().getBuses()) {\n+        // add voltages for TpNodes existing in the Model\n+        for (PropertyBag tn : cgmes.topologicalNodes()) {\n+            Bus b = network.getBusBreakerView().getBus(tn.getId(CgmesNames.TOPOLOGICAL_NODE));\n             PropertyBag p = new PropertyBag(SV_VOLTAGE_PROPERTIES);\n-            p.put(CgmesNames.ANGLE, fs(b.getAngle()));\n-            p.put(CgmesNames.VOLTAGE, fs(b.getV()));\n-            p.put(\"TopologicalNode\", topologicalNodeFromBusId(b.getId()));\n-            voltages.add(p);\n+            if (b != null) {\n+                p.put(CgmesNames.ANGLE, fs(b.getAngle()));\n+                p.put(CgmesNames.VOLTAGE, fs(b.getV()));\n+                p.put(CgmesNames.TOPOLOGICAL_NODE, tn.getId(CgmesNames.TOPOLOGICAL_NODE));\n+                voltages.add(p);\n+            }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvVoltage\", voltages);\n+        cgmes.add(originalSVcontext, \"SvVoltage\", voltages);\n+    }\n \n+    private void addVoltagesForBoundaryNodes() {\n+        PropertyBags voltages = new PropertyBags();\n+        // add voltages for TpNodes existing in the Model's boundaries\n+        boundaryNodesFromDanglingLines.entrySet().forEach(entry -> {", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwODg4Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391708887", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-12T15:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYyODg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0MDMzNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391640335", "bodyText": "To lower this method's complexity, create an intermediary method:\nprivate <I extends Injection> void addInjectionPowerFlowToCgmes(PropertyBags powerFlows, Iterable<I> injectionStream) {\n        injectionStream.forEach(i -> {\n            PropertyBag p = createPowerFlowProperties(i.getTerminal());\n            if (p != null) {\n                powerFlows.add(p);\n            } else if (i instanceof Load) {\n                // FIXME CGMES SvInjection objects created as loads\n                LOG.error(\"No SvPowerFlow created for load {}\", i.getId());\n            }\n        });\n    }\nYou can then call:\nPropertyBags powerFlows = new PropertyBags();\naddInjectionPowerFlowToCgmes(powerFlows, network.getLoads());\naddInjectionPowerFlowToCgmes(powerFlows, network.getGenerators());\naddInjectionPowerFlowToCgmes(powerFlows, network.getShuntCompensators());\naddInjectionPowerFlowToCgmes(powerFlows, network.getStaticVarCompensators());\naddInjectionPowerFlowToCgmes(powerFlows, network.getBatteries());", "author": "MioRtia", "createdAt": "2020-03-12T14:00:54Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -7,86 +7,205 @@\n package com.powsybl.cgmes.conversion.update;\n \n import java.util.Arrays;\n+import java.util.HashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n \n+import org.apache.commons.math3.complex.Complex;\n+import org.apache.commons.math3.complex.ComplexUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import com.powsybl.cgmes.model.CgmesModel;\n import com.powsybl.cgmes.model.CgmesNames;\n import com.powsybl.cgmes.model.CgmesSubset;\n import com.powsybl.cgmes.model.triplestore.CgmesModelTripleStore;\n+import com.powsybl.iidm.network.Battery;\n import com.powsybl.iidm.network.Bus;\n+import com.powsybl.iidm.network.Connectable;\n+import com.powsybl.iidm.network.DanglingLine;\n import com.powsybl.iidm.network.Generator;\n import com.powsybl.iidm.network.Load;\n import com.powsybl.iidm.network.Network;\n import com.powsybl.iidm.network.ShuntCompensator;\n+import com.powsybl.iidm.network.StaticVarCompensator;\n import com.powsybl.iidm.network.Terminal;\n+import com.powsybl.iidm.network.ThreeWindingsTransformer;\n import com.powsybl.iidm.network.TwoWindingsTransformer;\n+import com.powsybl.iidm.network.VoltageLevel;\n+import com.powsybl.iidm.network.util.LinkData;\n+import com.powsybl.iidm.network.util.LinkData.BranchAdmittanceMatrix;\n import com.powsybl.triplestore.api.PropertyBag;\n import com.powsybl.triplestore.api.PropertyBags;\n \n /**\n  * @author Marcos de Miguel <demiguelm at aia.es>\n  * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Elena Kaltakova <kaltakovae at aia.es>\n  */\n-public final class StateVariablesAdder {\n+public class StateVariablesAdder {\n \n-    private StateVariablesAdder() {\n+    public StateVariablesAdder(CgmesModel cgmes, Network n) {\n+        this.cgmes = Objects.requireNonNull(cgmes);\n+        this.network = Objects.requireNonNull(n);\n+        this.cimVersion = ((CgmesModelTripleStore) cgmes).getCimVersion();\n+        this.originalTerminals = cgmes.terminals();\n+        this.originalFullModel = cgmes.fullModel(CgmesSubset.STATE_VARIABLES.getProfile());\n+        this.originalTopologicalIslands = cgmes.topologicalIslands();\n+        this.originalSVcontext = originalSVcontext();\n+        this.boundaryNodesFromDanglingLines = boundaryNodesFromDanglingLines();\n     }\n \n-    public static void add(Network n, CgmesModel cgmes) {\n-        // TODO Add full model data with proper profile (StateVariables)\n-        // FullModel is defined in ModelDescription:\n-        // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private String originalSVcontext() {\n+        PropertyBags pbs = cgmes.graph();\n+        PropertyBag defaultSvContext = new PropertyBag(Arrays.asList(CgmesNames.GRAPH));\n+        defaultSvContext.put(CgmesNames.GRAPH, CgmesSubset.STATE_VARIABLES.toString());\n+        return pbs.stream()\n+            .filter(graph -> graph.getId(CgmesNames.GRAPH).contains(CgmesSubset.STATE_VARIABLES.getIdentifier()))\n+            .findAny()\n+            .orElse(defaultSvContext)\n+            .getId(CgmesNames.GRAPH);\n+    }\n+\n+    public void addStateVariablesToCgmes() {\n+        if (cgmes.isNodeBreaker()) {\n+            // TODO we need to export SV file data for NodeBraker\n+            LOG.warn(\"NodeBreaker view require further investigation to map correctly Topological Nodes\");\n+            return;\n+        }\n+        // Clear the previous SV data in CGMES model\n+        // and fill it with the Network current state values\n+        cgmes.clear(CgmesSubset.STATE_VARIABLES);\n+\n+        if (cimVersion != 14) {\n+            addModelDescriptionToCgmes();\n+            addTopologicalIslandsToCgmes();\n+        }\n+\n+        addVoltagesForTopologicalNodes();\n+\n+        addVoltagesForBoundaryNodes();\n+\n+        addPowerFlowToCgmes();\n \n+        addShuntCompensatorSectionsToCgmes();\n+\n+        addTapStepToCgmes();\n+\n+        addStatusToCgmes();\n+    }\n+\n+    private void addVoltagesForTopologicalNodes() {\n         PropertyBags voltages = new PropertyBags();\n-        for (Bus b : n.getBusBreakerView().getBuses()) {\n+        // add voltages for TpNodes existing in the Model\n+        for (PropertyBag tn : cgmes.topologicalNodes()) {\n+            Bus b = network.getBusBreakerView().getBus(tn.getId(CgmesNames.TOPOLOGICAL_NODE));\n             PropertyBag p = new PropertyBag(SV_VOLTAGE_PROPERTIES);\n-            p.put(CgmesNames.ANGLE, fs(b.getAngle()));\n-            p.put(CgmesNames.VOLTAGE, fs(b.getV()));\n-            p.put(\"TopologicalNode\", topologicalNodeFromBusId(b.getId()));\n-            voltages.add(p);\n+            if (b != null) {\n+                p.put(CgmesNames.ANGLE, fs(b.getAngle()));\n+                p.put(CgmesNames.VOLTAGE, fs(b.getV()));\n+                p.put(CgmesNames.TOPOLOGICAL_NODE, tn.getId(CgmesNames.TOPOLOGICAL_NODE));\n+                voltages.add(p);\n+            }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvVoltage\", voltages);\n+        cgmes.add(originalSVcontext, \"SvVoltage\", voltages);\n+    }\n \n+    private void addVoltagesForBoundaryNodes() {\n+        PropertyBags voltages = new PropertyBags();\n+        // add voltages for TpNodes existing in the Model's boundaries\n+        boundaryNodesFromDanglingLines.entrySet().forEach(entry -> {\n+            PropertyBag p = new PropertyBag(SV_VOLTAGE_PROPERTIES);\n+            DanglingLine dl = network.getDanglingLine(entry.getKey());\n+            Bus b = dl.getTerminal().getBusBreakerView().getBus();\n+            if (b != null) {\n+                // calculate complex voltage value: abs for VOLTAGE, degrees for ANGLE\n+                Complex v2 = complexVoltage(dl.getR(), dl.getX(), dl.getG(), dl.getB(), b.getV(), b.getAngle(),\n+                    dl.getP0(), dl.getQ0());\n+                p.put(CgmesNames.ANGLE, fs(Math.toDegrees(v2.getArgument())));\n+                p.put(CgmesNames.VOLTAGE, fs(v2.abs()));\n+                p.put(CgmesNames.TOPOLOGICAL_NODE, entry.getValue());\n+            } else {\n+                p.put(CgmesNames.ANGLE, fs(0.0));\n+                p.put(CgmesNames.VOLTAGE, fs(0.0));\n+                p.put(CgmesNames.TOPOLOGICAL_NODE, entry.getValue());\n+            }\n+            voltages.add(p);\n+        });\n+        cgmes.add(originalSVcontext, \"SvVoltage\", voltages);\n+    }\n+\n+    private void addPowerFlowToCgmes() {", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyMDYwNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391720605", "bodyText": "Done.\nThank you Miora, that's really good, I'll try to use this pattern in future.", "author": "kaltakovae", "createdAt": "2020-03-12T15:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0MDMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NTY4MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391645680", "bodyText": "You can replace Arrays.asList(CgmesNames.NAME) by Collections.singletonList(...)", "author": "MioRtia", "createdAt": "2020-03-12T14:08:41Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -127,22 +325,106 @@ private static PropertyBag createPowerFlowProperties(CgmesModel cgmes, Terminal\n         return p;\n     }\n \n+    // added TopologicalIsland as it was in cgmes : original topology is\n+    // preserved.\n+    private void addTopologicalIslandsToCgmes() {\n+        if (!originalTopologicalIslands.isEmpty()) {\n+            // For properties such as \"cim:TopologicalIsland.TopologicalNodes\", which might\n+            // have arbitrary number of values, SPARQL will return multiple result sets.\n+            // All properties values will be equal, except the multiValued property\n+            // TopologicalNodes.\n+            // Also, there can be > 1 TopologicalIsland, so we need to re-group PropertyBags\n+            // by TopologicalIsland ID.\n+            Map<String, PropertyBags> byTopologicalIslandId = new HashMap<>();\n+            originalTopologicalIslands.forEach(pb -> {\n+                String island = pb.getId(CgmesNames.TOPOLOGICAL_ISLAND);\n+                if (byTopologicalIslandId.keySet().contains(island)) {\n+                    byTopologicalIslandId.get(island).add(pb);\n+                } else {\n+                    PropertyBags pbs = new PropertyBags();\n+                    pbs.add(pb);\n+                    byTopologicalIslandId.put(island, pbs);\n+                }\n+            });\n+            // now we can process all TPNodes from each island, and put them in one\n+            // multivaluedProperty.\n+            PropertyBags topologicalIslands = new PropertyBags();\n+            byTopologicalIslandId.values().forEach(island -> {\n+                PropertyBag topologicalIsland = new PropertyBag(SV_TOPOLOGICALISLAND_PROPERTIES);\n+                topologicalIsland.setClassPropertyNames(Arrays.asList(CgmesNames.NAME));", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNDAwMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391724002", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-12T16:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NTY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NTg2Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391645862", "bodyText": "You can replace Arrays.asList(TopologicalNodes) by Collections.singletonList(...)", "author": "MioRtia", "createdAt": "2020-03-12T14:08:58Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -127,22 +325,106 @@ private static PropertyBag createPowerFlowProperties(CgmesModel cgmes, Terminal\n         return p;\n     }\n \n+    // added TopologicalIsland as it was in cgmes : original topology is\n+    // preserved.\n+    private void addTopologicalIslandsToCgmes() {\n+        if (!originalTopologicalIslands.isEmpty()) {\n+            // For properties such as \"cim:TopologicalIsland.TopologicalNodes\", which might\n+            // have arbitrary number of values, SPARQL will return multiple result sets.\n+            // All properties values will be equal, except the multiValued property\n+            // TopologicalNodes.\n+            // Also, there can be > 1 TopologicalIsland, so we need to re-group PropertyBags\n+            // by TopologicalIsland ID.\n+            Map<String, PropertyBags> byTopologicalIslandId = new HashMap<>();\n+            originalTopologicalIslands.forEach(pb -> {\n+                String island = pb.getId(CgmesNames.TOPOLOGICAL_ISLAND);\n+                if (byTopologicalIslandId.keySet().contains(island)) {\n+                    byTopologicalIslandId.get(island).add(pb);\n+                } else {\n+                    PropertyBags pbs = new PropertyBags();\n+                    pbs.add(pb);\n+                    byTopologicalIslandId.put(island, pbs);\n+                }\n+            });\n+            // now we can process all TPNodes from each island, and put them in one\n+            // multivaluedProperty.\n+            PropertyBags topologicalIslands = new PropertyBags();\n+            byTopologicalIslandId.values().forEach(island -> {\n+                PropertyBag topologicalIsland = new PropertyBag(SV_TOPOLOGICALISLAND_PROPERTIES);\n+                topologicalIsland.setClassPropertyNames(Arrays.asList(CgmesNames.NAME));\n+                topologicalIsland.setMultivaluedProperty(Arrays.asList(\"TopologicalNodes\"));", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNDI2Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391724262", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-12T16:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NTg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NjM1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391646352", "bodyText": "You can replace Arrays.asList(CgmesNames.DEPENDENT_ON) by Collections.singletonList(...)", "author": "MioRtia", "createdAt": "2020-03-12T14:09:41Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -127,22 +325,106 @@ private static PropertyBag createPowerFlowProperties(CgmesModel cgmes, Terminal\n         return p;\n     }\n \n+    // added TopologicalIsland as it was in cgmes : original topology is\n+    // preserved.\n+    private void addTopologicalIslandsToCgmes() {\n+        if (!originalTopologicalIslands.isEmpty()) {\n+            // For properties such as \"cim:TopologicalIsland.TopologicalNodes\", which might\n+            // have arbitrary number of values, SPARQL will return multiple result sets.\n+            // All properties values will be equal, except the multiValued property\n+            // TopologicalNodes.\n+            // Also, there can be > 1 TopologicalIsland, so we need to re-group PropertyBags\n+            // by TopologicalIsland ID.\n+            Map<String, PropertyBags> byTopologicalIslandId = new HashMap<>();\n+            originalTopologicalIslands.forEach(pb -> {\n+                String island = pb.getId(CgmesNames.TOPOLOGICAL_ISLAND);\n+                if (byTopologicalIslandId.keySet().contains(island)) {\n+                    byTopologicalIslandId.get(island).add(pb);\n+                } else {\n+                    PropertyBags pbs = new PropertyBags();\n+                    pbs.add(pb);\n+                    byTopologicalIslandId.put(island, pbs);\n+                }\n+            });\n+            // now we can process all TPNodes from each island, and put them in one\n+            // multivaluedProperty.\n+            PropertyBags topologicalIslands = new PropertyBags();\n+            byTopologicalIslandId.values().forEach(island -> {\n+                PropertyBag topologicalIsland = new PropertyBag(SV_TOPOLOGICALISLAND_PROPERTIES);\n+                topologicalIsland.setClassPropertyNames(Arrays.asList(CgmesNames.NAME));\n+                topologicalIsland.setMultivaluedProperty(Arrays.asList(\"TopologicalNodes\"));\n+                topologicalIsland.put(CgmesNames.NAME, island.get(0).getId(\"name\"));\n+                topologicalIsland.put(CgmesNames.ANGLEREF_TOPOLOGICALNODE,\n+                    island.get(0).getId(CgmesNames.ANGLEREF_TOPOLOGICALNODE));\n+                topologicalIsland.put(CgmesNames.TOPOLOGICAL_NODES,\n+                    String.join(\",\", island.pluckLocals(CgmesNames.TOPOLOGICAL_NODES)));\n+                topologicalIslands.add(topologicalIsland);\n+            });\n+            cgmes.add(originalSVcontext, CgmesNames.TOPOLOGICAL_ISLAND, topologicalIslands);\n+        }\n+    }\n+\n+    // Added full model data with proper profile (StateVariables)\n+    // FullModel is defined in ModelDescription:\n+    // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private void addModelDescriptionToCgmes() {\n+        PropertyBags fullModelSV = new PropertyBags();\n+        // for properties such as \"md:Model.DependentOn\" which might have arbitrary\n+        // number of values, SPARQL will return multiple result sets.\n+        // All are equal, except the multiValued property value.\n+        if (!originalFullModel.isEmpty()) {\n+            PropertyBag newModelDescription = new PropertyBag(SV_FULLMODEL_PROPERTIES);\n+            newModelDescription\n+                .setClassPropertyNames(\n+                    Arrays.asList(CgmesNames.SCENARIO_TIME, CgmesNames.CREATED, CgmesNames.DESCRIPTION,\n+                        CgmesNames.VERSION, CgmesNames.DEPENDENT_ON, CgmesNames.PROFILE,\n+                        CgmesNames.MODELING_AUTHORITY_SET));\n+            newModelDescription.setMultivaluedProperty(Arrays.asList(CgmesNames.DEPENDENT_ON));", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNDY0Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391724642", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-12T16:03:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NjM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NzM0NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391647345", "bodyText": "All these fields can be final.", "author": "MioRtia", "createdAt": "2020-03-12T14:11:06Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -127,22 +325,106 @@ private static PropertyBag createPowerFlowProperties(CgmesModel cgmes, Terminal\n         return p;\n     }\n \n+    // added TopologicalIsland as it was in cgmes : original topology is\n+    // preserved.\n+    private void addTopologicalIslandsToCgmes() {\n+        if (!originalTopologicalIslands.isEmpty()) {\n+            // For properties such as \"cim:TopologicalIsland.TopologicalNodes\", which might\n+            // have arbitrary number of values, SPARQL will return multiple result sets.\n+            // All properties values will be equal, except the multiValued property\n+            // TopologicalNodes.\n+            // Also, there can be > 1 TopologicalIsland, so we need to re-group PropertyBags\n+            // by TopologicalIsland ID.\n+            Map<String, PropertyBags> byTopologicalIslandId = new HashMap<>();\n+            originalTopologicalIslands.forEach(pb -> {\n+                String island = pb.getId(CgmesNames.TOPOLOGICAL_ISLAND);\n+                if (byTopologicalIslandId.keySet().contains(island)) {\n+                    byTopologicalIslandId.get(island).add(pb);\n+                } else {\n+                    PropertyBags pbs = new PropertyBags();\n+                    pbs.add(pb);\n+                    byTopologicalIslandId.put(island, pbs);\n+                }\n+            });\n+            // now we can process all TPNodes from each island, and put them in one\n+            // multivaluedProperty.\n+            PropertyBags topologicalIslands = new PropertyBags();\n+            byTopologicalIslandId.values().forEach(island -> {\n+                PropertyBag topologicalIsland = new PropertyBag(SV_TOPOLOGICALISLAND_PROPERTIES);\n+                topologicalIsland.setClassPropertyNames(Arrays.asList(CgmesNames.NAME));\n+                topologicalIsland.setMultivaluedProperty(Arrays.asList(\"TopologicalNodes\"));\n+                topologicalIsland.put(CgmesNames.NAME, island.get(0).getId(\"name\"));\n+                topologicalIsland.put(CgmesNames.ANGLEREF_TOPOLOGICALNODE,\n+                    island.get(0).getId(CgmesNames.ANGLEREF_TOPOLOGICALNODE));\n+                topologicalIsland.put(CgmesNames.TOPOLOGICAL_NODES,\n+                    String.join(\",\", island.pluckLocals(CgmesNames.TOPOLOGICAL_NODES)));\n+                topologicalIslands.add(topologicalIsland);\n+            });\n+            cgmes.add(originalSVcontext, CgmesNames.TOPOLOGICAL_ISLAND, topologicalIslands);\n+        }\n+    }\n+\n+    // Added full model data with proper profile (StateVariables)\n+    // FullModel is defined in ModelDescription:\n+    // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private void addModelDescriptionToCgmes() {\n+        PropertyBags fullModelSV = new PropertyBags();\n+        // for properties such as \"md:Model.DependentOn\" which might have arbitrary\n+        // number of values, SPARQL will return multiple result sets.\n+        // All are equal, except the multiValued property value.\n+        if (!originalFullModel.isEmpty()) {\n+            PropertyBag newModelDescription = new PropertyBag(SV_FULLMODEL_PROPERTIES);\n+            newModelDescription\n+                .setClassPropertyNames(\n+                    Arrays.asList(CgmesNames.SCENARIO_TIME, CgmesNames.CREATED, CgmesNames.DESCRIPTION,\n+                        CgmesNames.VERSION, CgmesNames.DEPENDENT_ON, CgmesNames.PROFILE,\n+                        CgmesNames.MODELING_AUTHORITY_SET));\n+            newModelDescription.setMultivaluedProperty(Arrays.asList(CgmesNames.DEPENDENT_ON));\n+            newModelDescription.put(CgmesNames.SCENARIO_TIME, originalFullModel.get(0).getId(\"scenarioTime\"));\n+            newModelDescription.put(CgmesNames.CREATED, originalFullModel.get(0).getId(\"created\"));\n+            newModelDescription.put(CgmesNames.DESCRIPTION, originalFullModel.get(0).getId(\"description\"));\n+            newModelDescription.put(CgmesNames.VERSION, originalFullModel.get(0).getId(\"version\"));\n+            newModelDescription.put(CgmesNames.DEPENDENT_ON,\n+                String.join(\",\", originalFullModel.pluckLocals(\"DependentOn\")));\n+            newModelDescription.put(CgmesNames.PROFILE, originalFullModel.get(0).getId(\"profile\"));\n+            newModelDescription.put(CgmesNames.MODELING_AUTHORITY_SET,\n+                originalFullModel.get(0).getId(\"modelingAuthoritySet\"));\n+            fullModelSV.add(newModelDescription);\n+            cgmes.add(originalSVcontext, CgmesNames.FULL_MODEL, fullModelSV);\n+        }\n+    }\n+\n     private static String fs(double value) {\n-        return String.valueOf(value);\n+        return Double.isNaN(value) ? String.valueOf(0.0) : String.valueOf(value);\n     }\n \n     private static String is(int value) {\n         return String.valueOf(value);\n     }\n \n-    private static String topologicalNodeFromBusId(String iidmBusId) {\n-        // TODO Consider potential namingStrategy transformations\n-        return iidmBusId;\n-    }\n+    private CgmesModel cgmes;\n+    private Network network;\n+    private int cimVersion;\n+    private PropertyBags originalTerminals;\n+    private PropertyBags originalFullModel;\n+    private PropertyBags originalTopologicalIslands;\n+    private String originalSVcontext;\n+    private Map<String, String> boundaryNodesFromDanglingLines;", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTczMDkxMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391730911", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-12T16:13:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NzM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MTAwMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391651000", "bodyText": "Add a default implementation to prevent breaking changes", "author": "MioRtia", "createdAt": "2020-03-12T14:16:28Z", "path": "cgmes/cgmes-model/src/main/java/com/powsybl/cgmes/model/CgmesModel.java", "diffHunk": "@@ -29,6 +29,8 @@\n \n     Properties getProperties();\n \n+    PropertyBags fullModel(String cgmesProfile);", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA1NTI1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392055252", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-13T06:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MTAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MTA5NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391651094", "bodyText": "Same remark", "author": "MioRtia", "createdAt": "2020-03-12T14:16:36Z", "path": "cgmes/cgmes-model/src/main/java/com/powsybl/cgmes/model/CgmesModel.java", "diffHunk": "@@ -130,10 +132,16 @@\n \n     PropertyBags dcTerminalsTP();\n \n+    PropertyBags topologicalIslands();\n+\n+    PropertyBags graph();", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA1NjY0MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392056640", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-13T06:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MTA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MTE0OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391651148", "bodyText": "Same remark", "author": "MioRtia", "createdAt": "2020-03-12T14:16:42Z", "path": "cgmes/cgmes-model/src/main/java/com/powsybl/cgmes/model/CgmesModel.java", "diffHunk": "@@ -130,10 +132,16 @@\n \n     PropertyBags dcTerminalsTP();\n \n+    PropertyBags topologicalIslands();\n+\n+    PropertyBags graph();\n+\n     void clear(CgmesSubset subset);\n \n     void add(CgmesSubset subset, String type, PropertyBags objects);\n \n+    void add(String context, String type, PropertyBags objects);", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA2MjY4Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392062683", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-13T07:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MTE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1Mjg5OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391652899", "bodyText": "If you want to set this.resourceNames, you will need to clear it before calling addAll:\nthis.resourceNames.clear();\nthis.resourceNames.addAll(...);", "author": "MioRtia", "createdAt": "2020-03-12T14:19:20Z", "path": "triple-store/triple-store-api/src/main/java/com/powsybl/triplestore/api/PropertyBag.java", "diffHunk": "@@ -184,24 +183,36 @@ public String namespacePrefix(String name) {\n     }\n \n     public void setResourceNames(List<String> resourceNames) {\n-        this.resourceNames = Objects.requireNonNull(resourceNames);\n+        this.resourceNames.addAll(Objects.requireNonNull(resourceNames));", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1MTcyMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391751720", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-12T16:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1Mjg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MzAxNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391653014", "bodyText": "Same remark", "author": "MioRtia", "createdAt": "2020-03-12T14:19:31Z", "path": "triple-store/triple-store-api/src/main/java/com/powsybl/triplestore/api/PropertyBag.java", "diffHunk": "@@ -184,24 +183,36 @@ public String namespacePrefix(String name) {\n     }\n \n     public void setResourceNames(List<String> resourceNames) {\n-        this.resourceNames = Objects.requireNonNull(resourceNames);\n+        this.resourceNames.addAll(Objects.requireNonNull(resourceNames));\n     }\n \n     public void setClassPropertyNames(List<String> classPropertyNames) {\n-        this.classPropertyNames = Objects.requireNonNull(classPropertyNames);\n+        this.classPropertyNames.addAll(Objects.requireNonNull(classPropertyNames));", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA2Mzk1OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392063958", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-13T07:19:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MzAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MzEwMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r391653102", "bodyText": "Same remark", "author": "MioRtia", "createdAt": "2020-03-12T14:19:39Z", "path": "triple-store/triple-store-api/src/main/java/com/powsybl/triplestore/api/PropertyBag.java", "diffHunk": "@@ -184,24 +183,36 @@ public String namespacePrefix(String name) {\n     }\n \n     public void setResourceNames(List<String> resourceNames) {\n-        this.resourceNames = Objects.requireNonNull(resourceNames);\n+        this.resourceNames.addAll(Objects.requireNonNull(resourceNames));\n     }\n \n     public void setClassPropertyNames(List<String> classPropertyNames) {\n-        this.classPropertyNames = Objects.requireNonNull(classPropertyNames);\n+        this.classPropertyNames.addAll(Objects.requireNonNull(classPropertyNames));\n     }\n \n     public boolean isClassProperty(String name) {\n         return classPropertyNames.contains(name);\n     }\n \n+    public void setMultivaluedProperty(List<String> multiValuedPropertyNames) {\n+        this.multiValuedPropertyNames.addAll(Objects.requireNonNull(multiValuedPropertyNames));", "originalCommit": "de47779ee06033672b959e9f934154fdc5060a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA2NDE4OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392064189", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-13T07:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MzEwMg=="}], "type": "inlineReview"}, {"oid": "e093b258fbc5d83a34f1c9756c0cf2f43410c065", "url": "https://github.com/powsybl/powsybl-core/commit/e093b258fbc5d83a34f1c9756c0cf2f43410c065", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-12T15:23:29Z", "type": "commit"}, {"oid": "125675c0761b6873a337f15bc453f93313bfbf00", "url": "https://github.com/powsybl/powsybl-core/commit/125675c0761b6873a337f15bc453f93313bfbf00", "message": "use singletonList; reduce complexity for addPowerFlowToCgmes(); set as final fields StateVariablesAdder; add default implementation in CgmesModel new methods; clear PropertyBag local fields before addAll\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-13T09:45:40Z", "type": "commit"}, {"oid": "27bfaf640a665af273e04e42a7ab415c4ed856ab", "url": "https://github.com/powsybl/powsybl-core/commit/27bfaf640a665af273e04e42a7ab415c4ed856ab", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-13T09:46:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjg0OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392306848", "bodyText": "You should use leg.hasPhaseTapChanger() that is more human readable.", "author": "mathbagu", "createdAt": "2020-03-13T15:41:05Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +203,99 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : network.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3()).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {", "originalCommit": "27bfaf640a665af273e04e42a7ab415c4ed856ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkxMTk5Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392911993", "bodyText": "The hasPhaseTapChanger() is not available for Leg. Theses methods are in TapChangerParent interface. Would you like us to modify iidm Leg - add hasPhaseTapChanger() ? or make the method in TapChangerParent available for Leg?", "author": "kaltakovae", "createdAt": "2020-03-16T10:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkyNDM5MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392924390", "bodyText": "Alternatively, I can add private methods like this to StateVariableAdder:\nprivate boolean hasRatioTapChanger(Leg leg) {\nreturn leg.getRatioTapChanger() != null;\n}\nprivate boolean hasPhaseTapChanger(Leg leg) {\n    return leg.getPhaseTapChanger() != null;\n}", "author": "kaltakovae", "createdAt": "2020-03-16T10:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkyOTk5Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392929993", "bodyText": "I don't think it is a good idea to make this evolution in this PR... Keep the code here as it is for now, I am opening an issue to add convenient methods such as hasPhaseTapChanger() on APIs.", "author": "miovd", "createdAt": "2020-03-16T10:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkzNTgwNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392935805", "bodyText": "Alternatively, I can add private methods like this to StateVariableAdder:\nprivate boolean hasRatioTapChanger(Leg leg) {\nreturn leg.getRatioTapChanger() != null;\n}\nprivate boolean hasPhaseTapChanger(Leg leg) {\n    return leg.getPhaseTapChanger() != null;\n}\n\n\nThis is a good idea, it will make it easier to \"clean\" the code, once the API change will be implemented.", "author": "miovd", "createdAt": "2020-03-16T10:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MDY5Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392950692", "bodyText": "@MioRtia  what do you think if we use this version:\nprivate boolean hasPhaseTapChanger(Object leg) {\nif (leg instanceof Leg) {\nreturn ((Leg) leg).getPhaseTapChanger() != null;\n} else if (leg instanceof TwoWindingsTransformer) {\nreturn ((TwoWindingsTransformer) leg).getPhaseTapChanger() != null;\n}\nreturn false;\n}\nWe could use it for both 2 and 3 wing transformes in addTapStepToCgmes()", "author": "kaltakovae", "createdAt": "2020-03-16T11:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAwMDA3OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r393000079", "bodyText": "it works for me!", "author": "miovd", "createdAt": "2020-03-16T12:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA3ODM0Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r393078342", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-16T14:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNjg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNzE0Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392307143", "bodyText": "Same improvement using leg.hasRatioTapChanger()", "author": "mathbagu", "createdAt": "2020-03-13T15:41:31Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +203,99 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : network.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3()).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {", "originalCommit": "27bfaf640a665af273e04e42a7ab415c4ed856ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkzMjU1Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392932556", "bodyText": "Same remark", "author": "miovd", "createdAt": "2020-03-16T10:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNzE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNzkzMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392307932", "bodyText": "It could be a good idea to add this convenient feature to the network.", "author": "mathbagu", "createdAt": "2020-03-13T15:42:51Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +203,99 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : network.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3()).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getRatioTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.ratioTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                }\n+            });\n+        }\n+\n+        cgmes.add(originalSVcontext, \"SvTapStep\", tapSteps);\n+    }\n+\n+    private void addStatusToCgmes() {\n+        // create SvStatus, iterate on Connectables, check Terminal status, add\n+        // to SvStatus\n+        PropertyBags svStatus = new PropertyBags();\n+        network.getVoltageLevelStream()\n+            .flatMap(VoltageLevel::getConnectableStream)\n+            .distinct()", "originalCommit": "27bfaf640a665af273e04e42a7ab415c4ed856ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkzMjc3Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392932772", "bodyText": "I will write an issue related to that", "author": "miovd", "createdAt": "2020-03-16T10:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNzkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwODkzNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392308937", "bodyText": "Not sure this is OK: If a line is connected on side 1 but disconnected on side 2, I'm not sure the IN_SERVICE should be true.", "author": "mathbagu", "createdAt": "2020-03-13T15:44:32Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +203,99 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : network.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3()).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getRatioTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.ratioTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                }\n+            });\n+        }\n+\n+        cgmes.add(originalSVcontext, \"SvTapStep\", tapSteps);\n+    }\n+\n+    private void addStatusToCgmes() {\n+        // create SvStatus, iterate on Connectables, check Terminal status, add\n+        // to SvStatus\n+        PropertyBags svStatus = new PropertyBags();\n+        network.getVoltageLevelStream()\n+            .flatMap(VoltageLevel::getConnectableStream)\n+            .distinct()\n+            .forEach(c -> {\n+                PropertyBag p = new PropertyBag(SV_SVSTATUS_PROPERTIES);\n+                for (Terminal t : ((Connectable<?>) c).getTerminals()) {\n+                    p.put(IN_SERVICE, Boolean.toString(t.isConnected()));", "originalCommit": "27bfaf640a665af273e04e42a7ab415c4ed856ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxOTEzMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392319133", "bodyText": "@MioRtia @zamarrenolm What do you think?", "author": "mathbagu", "createdAt": "2020-03-13T15:59:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwODkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MDE2Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392940163", "bodyText": "I agree with @mathbagu, not sure what is put in the property bag, it always is the connectivity status of the last terminal, right? Is it what we want?", "author": "miovd", "createdAt": "2020-03-16T11:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwODkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAwODA1NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r393008055", "bodyText": "The definition for inService attribute for a ConductingEquipment states that it is: The in service status as a result of topology processing.\nFor me: if a conducting equipment with multiple terminals has at least one terminal connected, it should be considered in-service. At least it makes sense from a modeling point of view, and its impact in the network could be calculated.", "author": "zamarrenolm", "createdAt": "2020-03-16T13:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwODkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyOTU2MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r393029560", "bodyText": "In fact Miora seems to say that we only keep the status of the last terminal we have checked. So what is the good solution to put inService when at least one terminal is connected ?", "author": "annetill", "createdAt": "2020-03-16T13:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwODkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4MzY4Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r393083687", "bodyText": "We will change it for \"any\" terminal, instead of \"last\"", "author": "kaltakovae", "createdAt": "2020-03-16T14:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwODkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE5OTc0Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r393199747", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-16T17:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwODkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwOTQzNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392309435", "bodyText": "Are you sure this check is needed: in which case the terminal is null?", "author": "mathbagu", "createdAt": "2020-03-13T15:45:24Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +203,99 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : network.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3()).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getRatioTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.ratioTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                }\n+            });\n+        }\n+\n+        cgmes.add(originalSVcontext, \"SvTapStep\", tapSteps);\n+    }\n+\n+    private void addStatusToCgmes() {\n+        // create SvStatus, iterate on Connectables, check Terminal status, add\n+        // to SvStatus\n+        PropertyBags svStatus = new PropertyBags();\n+        network.getVoltageLevelStream()\n+            .flatMap(VoltageLevel::getConnectableStream)\n+            .distinct()\n+            .forEach(c -> {\n+                PropertyBag p = new PropertyBag(SV_SVSTATUS_PROPERTIES);\n+                for (Terminal t : ((Connectable<?>) c).getTerminals()) {\n+                    p.put(IN_SERVICE, Boolean.toString(t.isConnected()));\n+                }\n+                p.put(CgmesNames.CONDUCTING_EQUIPMENT, c.getId());\n+                svStatus.add(p);\n+            });\n+\n+        // SvStatus at boundaries set as it was in original cgmes.\n+        for (PropertyBag terminal : originalTerminals) {\n+            Objects.requireNonNull(terminal);", "originalCommit": "27bfaf640a665af273e04e42a7ab415c4ed856ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgyNTA4Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392825082", "bodyText": "Removed unnecessary check", "author": "kaltakovae", "createdAt": "2020-03-16T07:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwOTQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxMTk1OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392311959", "bodyText": "This test is not necessary, the for-each at line 323 seems sufficient. If it's empty the `byTopologicalIslandId will be empty, and the for-each loop at line 336 won't loop.", "author": "mathbagu", "createdAt": "2020-03-13T15:49:28Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -127,22 +309,106 @@ private static PropertyBag createPowerFlowProperties(CgmesModel cgmes, Terminal\n         return p;\n     }\n \n+    // added TopologicalIsland as it was in cgmes : original topology is\n+    // preserved.\n+    private void addTopologicalIslandsToCgmes() {\n+        if (!originalTopologicalIslands.isEmpty()) {", "originalCommit": "27bfaf640a665af273e04e42a7ab415c4ed856ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0ODU3MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r392348571", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-13T16:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxMTk1OQ=="}], "type": "inlineReview"}, {"oid": "264b1727ef26a77de07652028b3328d10177a8f7", "url": "https://github.com/powsybl/powsybl-core/commit/264b1727ef26a77de07652028b3328d10177a8f7", "message": "fix changes requested for PR 1201 in StateVariablesAdder\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-16T11:04:04Z", "type": "commit"}, {"oid": "457e6cfa4b2228682f8fd9cba9fc8c57f670d497", "url": "https://github.com/powsybl/powsybl-core/commit/457e6cfa4b2228682f8fd9cba9fc8c57f670d497", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-16T14:34:14Z", "type": "commit"}, {"oid": "64a9c024b6dde5f3ef90b74139506e42c50b8cc4", "url": "https://github.com/powsybl/powsybl-core/commit/64a9c024b6dde5f3ef90b74139506e42c50b8cc4", "message": "added hasPhaseTapChanger and hasRatioTapChanger methods; svStatus is get from any connected Terminal\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-16T15:02:16Z", "type": "commit"}, {"oid": "d086521d6f0a955c867927bd827b196208732527", "url": "https://github.com/powsybl/powsybl-core/commit/d086521d6f0a955c867927bd827b196208732527", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file", "committedDate": "2020-03-17T14:01:52Z", "type": "commit"}, {"oid": "d457762ead2373221373eceaf84cddd72ae12790", "url": "https://github.com/powsybl/powsybl-core/commit/d457762ead2373221373eceaf84cddd72ae12790", "message": "Add clone functionality for triplestore and cgmes implementations", "committedDate": "2019-10-30T10:01:03Z", "type": "commit"}, {"oid": "7015c51fb785cc129b5090055c08cdb2608528c8", "url": "https://github.com/powsybl/powsybl-core/commit/7015c51fb785cc129b5090055c08cdb2608528c8", "message": "clean up tests for clone; clean redundant method in blazegraph", "committedDate": "2019-10-30T13:44:35Z", "type": "commit"}, {"oid": "754f6a8623263ce480aaf41894e402ba9f066a47", "url": "https://github.com/powsybl/powsybl-core/commit/754f6a8623263ce480aaf41894e402ba9f066a47", "message": "name of test resource\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-10-30T14:36:28Z", "type": "commit"}, {"oid": "e055a7915b7ea032d518ad70347ee2e17dfe1d91", "url": "https://github.com/powsybl/powsybl-core/commit/e055a7915b7ea032d518ad70347ee2e17dfe1d91", "message": "changes in model will not be included in this pr", "committedDate": "2019-10-30T15:44:56Z", "type": "commit"}, {"oid": "e03f9bd0d92ea2e1540284a82c68ff6a2da418bd", "url": "https://github.com/powsybl/powsybl-core/commit/e03f9bd0d92ea2e1540284a82c68ff6a2da418bd", "message": "rename test for triplestore copy; complete test for triplestore clear\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-10-31T12:13:10Z", "type": "commit"}, {"oid": "64eb4f25b91a61b1a7854c5223cde5e2d6010948", "url": "https://github.com/powsybl/powsybl-core/commit/64eb4f25b91a61b1a7854c5223cde5e2d6010948", "message": "triplestore factory copy; fix copy test (store copies of all triplestore implementations)\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-10-31T12:40:16Z", "type": "commit"}, {"oid": "b88b5ad9a1110e7521ef992f2d04fc046129d140", "url": "https://github.com/powsybl/powsybl-core/commit/b88b5ad9a1110e7521ef992f2d04fc046129d140", "message": "copy receives only source triplestore; uniform naming; simplify copy loops; test same namespaces in source and target\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-10-31T17:31:22Z", "type": "commit"}, {"oid": "c3cd73703d3b91db3ba83592cf699fa44b5c7b39", "url": "https://github.com/powsybl/powsybl-core/commit/c3cd73703d3b91db3ba83592cf699fa44b5c7b39", "message": "Add update functionality for triplestore implementations\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-05T11:03:16Z", "type": "commit"}, {"oid": "5c9232667cc20d1b3e41bd9e0f909165e322407d", "url": "https://github.com/powsybl/powsybl-core/commit/5c9232667cc20d1b3e41bd9e0f909165e322407d", "message": "Merge branch 'master' into cmges_update_triplestore_update", "committedDate": "2019-11-05T11:22:24Z", "type": "commit"}, {"oid": "1e56852cd6cffddc91b0c6c6d92b6cfa45966a6f", "url": "https://github.com/powsybl/powsybl-core/commit/1e56852cd6cffddc91b0c6c6d92b6cfa45966a6f", "message": "Merge branch 'master' into cmges_update_triplestore_update", "committedDate": "2019-11-06T09:14:03Z", "type": "commit"}, {"oid": "e046536866ade78238e826c1e33204fcfd9f6fa2", "url": "https://github.com/powsybl/powsybl-core/commit/e046536866ade78238e826c1e33204fcfd9f6fa2", "message": "merge changes from cmges_update_triplestore_copy branch; prepare current for PR", "committedDate": "2019-11-06T11:09:29Z", "type": "commit"}, {"oid": "edc12cddfb3a37e03bc8d9292bbaa31d7f667881", "url": "https://github.com/powsybl/powsybl-core/commit/edc12cddfb3a37e03bc8d9292bbaa31d7f667881", "message": "merge changes from cmges_update_triplestore_copy branch; prepare current for PR\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-06T15:17:27Z", "type": "commit"}, {"oid": "b7bf3afe8bf50ee7a3faff45d42955cd373ef88f", "url": "https://github.com/powsybl/powsybl-core/commit/b7bf3afe8bf50ee7a3faff45d42955cd373ef88f", "message": "Merge branch 'master' into cmges_update_triplestore_update\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>\n\n# Conflicts:\n#\ttriple-store/triple-store-impl-blazegraph/src/main/java/com/powsybl/triplestore/impl/blazegraph/TripleStoreBlazegraph.java\n#\ttriple-store/triple-store-impl-jena/src/main/java/com/powsybl/triplestore/impl/jena/TripleStoreJena.java\n#\ttriple-store/triple-store-impl-rdf4j/src/main/java/com/powsybl/triplestore/impl/rdf4j/TripleStoreRDF4J.java\n#\ttriple-store/triple-store-test/src/test/java/com/powsybl/triplestore/test/TripleStoreCopyTest.java\n#\ttriple-store/triple-store-test/src/test/java/com/powsybl/triplestore/test/TripleStoreTester.java\n#\ttriple-store/triple-store-test/src/test/resources/foaf/foaf.sparql", "committedDate": "2019-11-11T15:53:28Z", "type": "commit"}, {"oid": "317edc2f9c082ddf628ccb644100aa5d9c8b7fd3", "url": "https://github.com/powsybl/powsybl-core/commit/317edc2f9c082ddf628ccb644100aa5d9c8b7fd3", "message": "reload data for every update test; format queries\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-11T16:23:03Z", "type": "commit"}, {"oid": "7d6fe8d957086af6dc5ab3ef40d0ba7b38b602fa", "url": "https://github.com/powsybl/powsybl-core/commit/7d6fe8d957086af6dc5ab3ef40d0ba7b38b602fa", "message": "Merge branch 'master' into cmges_update_triplestore_update", "committedDate": "2019-11-12T08:38:06Z", "type": "commit"}, {"oid": "e684d7e91b11be23774d730b048b9b9c6f08efe2", "url": "https://github.com/powsybl/powsybl-core/commit/e684d7e91b11be23774d730b048b9b9c6f08efe2", "message": "load test data from @Before for each test\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-12T10:18:03Z", "type": "commit"}, {"oid": "d3fc5680af73c11e578d292d632e3cf770b08e90", "url": "https://github.com/powsybl/powsybl-core/commit/d3fc5680af73c11e578d292d632e3cf770b08e90", "message": "Merge branch 'cmges_update_triplestore_update' into cgmes_update_v2\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-12T17:30:48Z", "type": "commit"}, {"oid": "fc79f87d39dfc27b16105e88aa5b1886f5b31ddc", "url": "https://github.com/powsybl/powsybl-core/commit/fc79f87d39dfc27b16105e88aa5b1886f5b31ddc", "message": "perform only simple updates on CGMES model\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-14T16:53:48Z", "type": "commit"}, {"oid": "fdaa31fefd67a30fe13727c94b37681a333e094a", "url": "https://github.com/powsybl/powsybl-core/commit/fdaa31fefd67a30fe13727c94b37681a333e094a", "message": "Merge branch 'master' into cgmes_update_simple_update\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>\n\n# Conflicts:\n#\ttriple-store/triple-store-test/src/test/java/com/powsybl/triplestore/test/TripleStoreUpdateTest.java", "committedDate": "2019-11-14T16:56:41Z", "type": "commit"}, {"oid": "905b729588fea9a9f7880b5fb058460dab807926", "url": "https://github.com/powsybl/powsybl-core/commit/905b729588fea9a9f7880b5fb058460dab807926", "message": "use CGMES subset as context (graph) reference\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-14T17:24:36Z", "type": "commit"}, {"oid": "cfc8d35cbfa655dbd1d96b965149d963a0398d5b", "url": "https://github.com/powsybl/powsybl-core/commit/cfc8d35cbfa655dbd1d96b965149d963a0398d5b", "message": "optimize value replacement in update query\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-15T09:07:26Z", "type": "commit"}, {"oid": "5d9fe63501b456275f8a758783897f4ba4edb308", "url": "https://github.com/powsybl/powsybl-core/commit/5d9fe63501b456275f8a758783897f4ba4edb308", "message": "Merge branch 'master' into cgmes_update_simple_update", "committedDate": "2019-11-15T13:33:52Z", "type": "commit"}, {"oid": "a61d7f939f3cad3b0fa1463b6a405513890cedfd", "url": "https://github.com/powsybl/powsybl-core/commit/a61d7f939f3cad3b0fa1463b6a405513890cedfd", "message": "Correct TripleStoreChangeParams and SPARQL Update query\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-15T16:03:22Z", "type": "commit"}, {"oid": "90c85362148ff5f8f1d961bd5523053abe3195a1", "url": "https://github.com/powsybl/powsybl-core/commit/90c85362148ff5f8f1d961bd5523053abe3195a1", "message": "refine valid name check for CGMES subsets\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-15T16:28:37Z", "type": "commit"}, {"oid": "b71e6839703beb634cf6d638532235189a2674b0", "url": "https://github.com/powsybl/powsybl-core/commit/b71e6839703beb634cf6d638532235189a2674b0", "message": "log additional info if error is found writing CGMES\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-15T16:29:22Z", "type": "commit"}, {"oid": "5752d469834b8b388958b28d1940841c634fb039", "url": "https://github.com/powsybl/powsybl-core/commit/5752d469834b8b388958b28d1940841c634fb039", "message": "perform and check simple updates (one to one mapping to CGMES attributes)\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-15T16:30:59Z", "type": "commit"}, {"oid": "ec4d44c45a3683f5f73af79ea944197eec661501", "url": "https://github.com/powsybl/powsybl-core/commit/ec4d44c45a3683f5f73af79ea944197eec661501", "message": "license and author information\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-15T16:46:45Z", "type": "commit"}, {"oid": "4111dab939e8ecedd316507a160d5cecd87c2a51", "url": "https://github.com/powsybl/powsybl-core/commit/4111dab939e8ecedd316507a160d5cecd87c2a51", "message": "add tests, fix valid name for CGMES boundary subsets\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-15T17:22:52Z", "type": "commit"}, {"oid": "5600666cafada1779632a722bc1eaa4ede2843cf", "url": "https://github.com/powsybl/powsybl-core/commit/5600666cafada1779632a722bc1eaa4ede2843cf", "message": "add test for general network change\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-19T07:35:02Z", "type": "commit"}, {"oid": "a94c40994640bbc6024e86c2a966332d2dfafc68", "url": "https://github.com/powsybl/powsybl-core/commit/a94c40994640bbc6024e86c2a966332d2dfafc68", "message": "merging changes from remote\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-19T07:55:31Z", "type": "commit"}, {"oid": "445fbcb64e3af30e07603e11d45807ba0c0c6bab", "url": "https://github.com/powsybl/powsybl-core/commit/445fbcb64e3af30e07603e11d45807ba0c0c6bab", "message": "Add test for cloned Variant; format SPARQL update query\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-19T10:05:41Z", "type": "commit"}, {"oid": "10d2e843836410cbf9f1bf6737ea4fca7303ac32", "url": "https://github.com/powsybl/powsybl-core/commit/10d2e843836410cbf9f1bf6737ea4fca7303ac32", "message": "Merge branch 'master' into cgmes_update_simple_update", "committedDate": "2019-11-19T10:08:42Z", "type": "commit"}, {"oid": "dc5ffd44af524484bd09a13c171f2ea627256324", "url": "https://github.com/powsybl/powsybl-core/commit/dc5ffd44af524484bd09a13c171f2ea627256324", "message": "consider changes on base and changes that are variant-specific\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-19T11:42:36Z", "type": "commit"}, {"oid": "287eb8717db1123e105ede72a2eb134a53fa83da", "url": "https://github.com/powsybl/powsybl-core/commit/287eb8717db1123e105ede72a2eb134a53fa83da", "message": "Implement variant test for base changes and variant specific\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-19T14:14:24Z", "type": "commit"}, {"oid": "7c70d5b44a4e40f53ae32a371ec4482118286a49", "url": "https://github.com/powsybl/powsybl-core/commit/7c70d5b44a4e40f53ae32a371ec4482118286a49", "message": "comments\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-19T15:16:11Z", "type": "commit"}, {"oid": "42b46df12b20fe84091623e73ac753dd8d837c22", "url": "https://github.com/powsybl/powsybl-core/commit/42b46df12b20fe84091623e73ac753dd8d837c22", "message": "Merge branch 'master' into cgmes_update_simple_update\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-19T15:17:43Z", "type": "commit"}, {"oid": "3a98b0f0ef1eb1dd6755deb23f9f8c4e7c16f373", "url": "https://github.com/powsybl/powsybl-core/commit/3a98b0f0ef1eb1dd6755deb23f9f8c4e7c16f373", "message": "adjust comment\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-19T15:27:00Z", "type": "commit"}, {"oid": "80ce2ec1e35c3a6bf3c0d56b344ef2005d205033", "url": "https://github.com/powsybl/powsybl-core/commit/80ce2ec1e35c3a6bf3c0d56b344ef2005d205033", "message": "fix PR review issues\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-20T13:49:37Z", "type": "commit"}, {"oid": "61ba192e08d5809e7df4f0687b26916a2aad9577", "url": "https://github.com/powsybl/powsybl-core/commit/61ba192e08d5809e7df4f0687b26916a2aad9577", "message": "adjust error messages; new value on update change may be null\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-20T14:19:59Z", "type": "commit"}, {"oid": "63eb977bf4e45757e41e708f6234b4318617ce32", "url": "https://github.com/powsybl/powsybl-core/commit/63eb977bf4e45757e41e708f6234b4318617ce32", "message": "add nonNull assert\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-20T15:11:07Z", "type": "commit"}, {"oid": "34b9537fa90e2d0aeda4cadfe5f96f153520c842", "url": "https://github.com/powsybl/powsybl-core/commit/34b9537fa90e2d0aeda4cadfe5f96f153520c842", "message": "Remove Profiling code\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-20T16:46:22Z", "type": "commit"}, {"oid": "5a25f7bd2f6a78e516bbeff037ae8d83319d0fda", "url": "https://github.com/powsybl/powsybl-core/commit/5a25f7bd2f6a78e516bbeff037ae8d83319d0fda", "message": "remove unneeded code\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2019-11-21T09:48:56Z", "type": "commit"}, {"oid": "80d950dfd7d87049d4df64691f816d04accffba5", "url": "https://github.com/powsybl/powsybl-core/commit/80d950dfd7d87049d4df64691f816d04accffba5", "message": "add test for Creation / Removal events being added to changelog\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-21T13:55:02Z", "type": "commit"}, {"oid": "62f2b8b7589418910f267de72499ddcf73d900e4", "url": "https://github.com/powsybl/powsybl-core/commit/62f2b8b7589418910f267de72499ddcf73d900e4", "message": "remove unused code\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-21T15:22:52Z", "type": "commit"}, {"oid": "055c8f5ae14b440be8fb51e789af3ff301fdec58", "url": "https://github.com/powsybl/powsybl-core/commit/055c8f5ae14b440be8fb51e789af3ff301fdec58", "message": "Merge branch 'master' into cgmes_update_simple_update\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-11-29T10:04:35Z", "type": "commit"}, {"oid": "b457c5471b06d307e139547823a3758b62a81524", "url": "https://github.com/powsybl/powsybl-core/commit/b457c5471b06d307e139547823a3758b62a81524", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_bus_tp\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-04T10:51:37Z", "type": "commit"}, {"oid": "d3ea9acc06db905e2b806b27a171f460f73aaaf5", "url": "https://github.com/powsybl/powsybl-core/commit/d3ea9acc06db905e2b806b27a171f460f73aaaf5", "message": "add logic for getting Model related TopologicalNodes from boundaries\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-10T12:19:15Z", "type": "commit"}, {"oid": "832ef4d843ca4a753be1fb09112558d28a90cc8e", "url": "https://github.com/powsybl/powsybl-core/commit/832ef4d843ca4a753be1fb09112558d28a90cc8e", "message": "add logic for getting Model related TopologicalNodes from boundaries, for SV data\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-10T16:57:54Z", "type": "commit"}, {"oid": "253d8122ea8139c8c5f91c0fb64e1a3dc112d4e5", "url": "https://github.com/powsybl/powsybl-core/commit/253d8122ea8139c8c5f91c0fb64e1a3dc112d4e5", "message": "Adjust method naming\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-11T08:27:52Z", "type": "commit"}, {"oid": "280bfe1eb0ea45c1372f63e66e3b5d471c86cfcc", "url": "https://github.com/powsybl/powsybl-core/commit/280bfe1eb0ea45c1372f63e66e3b5d471c86cfcc", "message": "Add calculation for complex voltage for boundary TopologicalNodes\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-11T15:58:55Z", "type": "commit"}, {"oid": "642961cf7c7b8530d2a1e9079bb1b8da42fe92ef", "url": "https://github.com/powsybl/powsybl-core/commit/642961cf7c7b8530d2a1e9079bb1b8da42fe92ef", "message": "add SvStatus calculation\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-16T11:04:10Z", "type": "commit"}, {"oid": "d5b8380bbc9130c32c4cd9afcd7a6564d6f27af6", "url": "https://github.com/powsybl/powsybl-core/commit/d5b8380bbc9130c32c4cd9afcd7a6564d6f27af6", "message": "PowerFlow at boundaries set as it was in original cgmes.\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-16T16:29:42Z", "type": "commit"}, {"oid": "1e47f592996c3481618647f2034b607751520b9f", "url": "https://github.com/powsybl/powsybl-core/commit/1e47f592996c3481618647f2034b607751520b9f", "message": "merge master into head branch\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-16T17:04:50Z", "type": "commit"}, {"oid": "abb577c7d1721106963b54662089057c2a12ac91", "url": "https://github.com/powsybl/powsybl-core/commit/abb577c7d1721106963b54662089057c2a12ac91", "message": "add SvStatus for ConductingEquipment for TopologicalNodes in boundaries\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-17T14:13:45Z", "type": "commit"}, {"oid": "e52a38cb1d36240e290be866acf53c08c1f47e1d", "url": "https://github.com/powsybl/powsybl-core/commit/e52a38cb1d36240e290be866acf53c08c1f47e1d", "message": "Add FullModel statements for exported cgmes model\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-19T14:43:14Z", "type": "commit"}, {"oid": "2bcc8e9bdfdc24383513dae67ce60c822cfddb03", "url": "https://github.com/powsybl/powsybl-core/commit/2bcc8e9bdfdc24383513dae67ce60c822cfddb03", "message": "Add TopologicalIsland statements for exported cgmes model\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-20T12:20:53Z", "type": "commit"}, {"oid": "a2f96ca8be0988d2fd140ce0179b3dc98fb59e9e", "url": "https://github.com/powsybl/powsybl-core/commit/a2f96ca8be0988d2fd140ce0179b3dc98fb59e9e", "message": "Add constants for CgmenNames and fix string usage; move check for multiValue to PropertiBag object; Fix namig for new methods, fix writing modelDescription :about\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-23T11:58:57Z", "type": "commit"}, {"oid": "ca9aca8408cc19e7dc0603fde6a3afdd4c17c38b", "url": "https://github.com/powsybl/powsybl-core/commit/ca9aca8408cc19e7dc0603fde6a3afdd4c17c38b", "message": "tmp test for SV hsould not be run, will be removed\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-23T13:32:03Z", "type": "commit"}, {"oid": "1cfd4f16390c8c83c6d5bfd51955142e1b690e9e", "url": "https://github.com/powsybl/powsybl-core/commit/1cfd4f16390c8c83c6d5bfd51955142e1b690e9e", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_bus_tp\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-23T13:34:12Z", "type": "commit"}, {"oid": "3f4fc96c77be9a0a0be489c984d0cd7b732d425f", "url": "https://github.com/powsybl/powsybl-core/commit/3f4fc96c77be9a0a0be489c984d0cd7b732d425f", "message": "add null checks\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-27T10:46:35Z", "type": "commit"}, {"oid": "6ca8a8ec0f5a53d8ef441d7b9cf824eb3bacd291", "url": "https://github.com/powsybl/powsybl-core/commit/6ca8a8ec0f5a53d8ef441d7b9cf824eb3bacd291", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-30T08:41:27Z", "type": "commit"}, {"oid": "f9a0d32601aa6cb08dcff1242b0d5bd68506ec81", "url": "https://github.com/powsybl/powsybl-core/commit/f9a0d32601aa6cb08dcff1242b0d5bd68506ec81", "message": "Add IdentifiedObject.name to topologicalIslands; move multiValued properties and fullModel handling from rdf4j to PropertyBag; fix constants for SonarLint\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-30T15:45:06Z", "type": "commit"}, {"oid": "e31277b671128cba0651516ace242e36821359dc", "url": "https://github.com/powsybl/powsybl-core/commit/e31277b671128cba0651516ace242e36821359dc", "message": "fix topologicalIsland SV creation\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2019-12-30T16:05:46Z", "type": "commit"}, {"oid": "9327af4e1a58a522c38d1567129efba626a044e9", "url": "https://github.com/powsybl/powsybl-core/commit/9327af4e1a58a522c38d1567129efba626a044e9", "message": "LinkDataTmp included temporarily, until is merged into master from its branch\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-02T11:26:57Z", "type": "commit"}, {"oid": "4c9a8424446b1bec079666cf469375d2c4e129af", "url": "https://github.com/powsybl/powsybl-core/commit/4c9a8424446b1bec079666cf469375d2c4e129af", "message": "merge from master\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-22T09:42:41Z", "type": "commit"}, {"oid": "ae3103b6bb65977d81e9eca0e7f18b0ca4bfe80a", "url": "https://github.com/powsybl/powsybl-core/commit/ae3103b6bb65977d81e9eca0e7f18b0ca4bfe80a", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-22T13:10:58Z", "type": "commit"}, {"oid": "407aaa3fe07d2bec992897cc74cad78a59ff4e4f", "url": "https://github.com/powsybl/powsybl-core/commit/407aaa3fe07d2bec992897cc74cad78a59ff4e4f", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-23T13:13:55Z", "type": "commit"}, {"oid": "b975a9c97aa98125eefc511a483ce32ff497afc5", "url": "https://github.com/powsybl/powsybl-core/commit/b975a9c97aa98125eefc511a483ce32ff497afc5", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-30T11:17:53Z", "type": "commit"}, {"oid": "0d5540a6f82bba36bf12bf42b87fe26c7905626e", "url": "https://github.com/powsybl/powsybl-core/commit/0d5540a6f82bba36bf12bf42b87fe26c7905626e", "message": "Add original context name for CGMES SV output file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-31T10:05:37Z", "type": "commit"}, {"oid": "a52e4ee4a5f4ecf00e302acb4d9407e8cee0beb4", "url": "https://github.com/powsybl/powsybl-core/commit/a52e4ee4a5f4ecf00e302acb4d9407e8cee0beb4", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-31T10:26:01Z", "type": "commit"}, {"oid": "ce5db44516c2616cce706ebecfabc8131b5f5fbe", "url": "https://github.com/powsybl/powsybl-core/commit/ce5db44516c2616cce706ebecfabc8131b5f5fbe", "message": "use LinkData class for CGMES StateVariablesAdder, remove LinkDataTmp\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-31T10:56:29Z", "type": "commit"}, {"oid": "bb11be98249b8ce1031442fcc9ac52f888bfb549", "url": "https://github.com/powsybl/powsybl-core/commit/bb11be98249b8ce1031442fcc9ac52f888bfb549", "message": "improve original context name for CGMES SV output file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-31T11:45:40Z", "type": "commit"}, {"oid": "dd3f3730f5be1b54ca463347c71269b593c8ae73", "url": "https://github.com/powsybl/powsybl-core/commit/dd3f3730f5be1b54ca463347c71269b593c8ae73", "message": "add ThreeWindingsTransformer SvTapStep to cgmes SV context and output\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-31T13:52:06Z", "type": "commit"}, {"oid": "c5be98aafd40b63ff073c949b5a30b91e30fe461", "url": "https://github.com/powsybl/powsybl-core/commit/c5be98aafd40b63ff073c949b5a30b91e30fe461", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-02-05T08:37:03Z", "type": "commit"}, {"oid": "005676ef4af65e39bc290489deb8dc94de0e1c87", "url": "https://github.com/powsybl/powsybl-core/commit/005676ef4af65e39bc290489deb8dc94de0e1c87", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-02-20T11:23:23Z", "type": "commit"}, {"oid": "71871a589a27649f1790dcdf43ce9cd2fa7ae9c0", "url": "https://github.com/powsybl/powsybl-core/commit/71871a589a27649f1790dcdf43ce9cd2fa7ae9c0", "message": "Reorganize methods in StateVariableAdder class\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-02-20T13:59:21Z", "type": "commit"}, {"oid": "496949a615876f879d5a6b34d1ccc2018878c502", "url": "https://github.com/powsybl/powsybl-core/commit/496949a615876f879d5a6b34d1ccc2018878c502", "message": "correct NodeBraker warning; add UnmodifiableList to Tx3 legs list; Move Terminals loop inside Connectable in SvStatus; fix check for cimVersion; fix NaN value for double\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-02-21T15:27:22Z", "type": "commit"}, {"oid": "2dbfd8663a5e17901cf897603a5a2d5deb34d42a", "url": "https://github.com/powsybl/powsybl-core/commit/2dbfd8663a5e17901cf897603a5a2d5deb34d42a", "message": "In StateVariablesAdder: Reorganized add() method to reduce its Cognitive Complexity;Network moved to be an instance variable; cgmes.clear() moved inside add method;\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-02-21T17:26:10Z", "type": "commit"}, {"oid": "8e55b52b86ff75572a558b4dca5cab0a5e0dfce6", "url": "https://github.com/powsybl/powsybl-core/commit/8e55b52b86ff75572a558b4dca5cab0a5e0dfce6", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-02-21T17:27:15Z", "type": "commit"}, {"oid": "977068f72c7e1bcf9644af421626f93dac824da0", "url": "https://github.com/powsybl/powsybl-core/commit/977068f72c7e1bcf9644af421626f93dac824da0", "message": "SvAdder: rename methods; if NodeBraker di return\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-02-24T08:15:10Z", "type": "commit"}, {"oid": "a2f27bd2920ce493fe4a532946279f77fbc34d07", "url": "https://github.com/powsybl/powsybl-core/commit/a2f27bd2920ce493fe4a532946279f77fbc34d07", "message": "store originalSV data as attributes; remove terminalsSV sparql; parametriza fullModel sparql query; add constant for full model to AbstractPowsyblTripleStore; add MD namespace to CgmesNamespace class; fix original cgmes SV context search from new \"graph\" sparql\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-01T19:38:51Z", "type": "commit"}, {"oid": "42dd38f405c2aaf3a3d3e6d188d743b96a9f213f", "url": "https://github.com/powsybl/powsybl-core/commit/42dd38f405c2aaf3a3d3e6d188d743b96a9f213f", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-01T19:40:27Z", "type": "commit"}, {"oid": "d2805a3c5f0f4bec3deb4167f1572c8ab2b84ef8", "url": "https://github.com/powsybl/powsybl-core/commit/d2805a3c5f0f4bec3deb4167f1572c8ab2b84ef8", "message": "add default context for SV adder\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-02T12:11:11Z", "type": "commit"}, {"oid": "1a8e6590a78585ba7279969cf27785cf5085a691", "url": "https://github.com/powsybl/powsybl-core/commit/1a8e6590a78585ba7279969cf27785cf5085a691", "message": "cosmetic fixes in SV adder clas: rename, split methods, others\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-02T16:58:38Z", "type": "commit"}, {"oid": "949bf6f2e5647f221ba15fa358f2a83a08685d48", "url": "https://github.com/powsybl/powsybl-core/commit/949bf6f2e5647f221ba15fa358f2a83a08685d48", "message": "add test for StateVariablesAdder\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-03T15:48:24Z", "type": "commit"}, {"oid": "4e7a6aa3baf37286b36686e7cac6abe0e222f88b", "url": "https://github.com/powsybl/powsybl-core/commit/4e7a6aa3baf37286b36686e7cac6abe0e222f88b", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-03T16:57:21Z", "type": "commit"}, {"oid": "8c5803a57c016ccc073c447f2f0b81bf799fd123", "url": "https://github.com/powsybl/powsybl-core/commit/8c5803a57c016ccc073c447f2f0b81bf799fd123", "message": "add license to StateVariablesAdderTest\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-03T17:20:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMxODgxNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388318817", "bodyText": "Can be static", "author": "MioRtia", "createdAt": "2020-03-05T14:15:09Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -17,42 +26,122 @@\n import com.powsybl.cgmes.model.CgmesSubset;\n import com.powsybl.cgmes.model.triplestore.CgmesModelTripleStore;\n import com.powsybl.iidm.network.Bus;\n+import com.powsybl.iidm.network.Connectable;\n+import com.powsybl.iidm.network.DanglingLine;\n import com.powsybl.iidm.network.Generator;\n import com.powsybl.iidm.network.Load;\n import com.powsybl.iidm.network.Network;\n import com.powsybl.iidm.network.ShuntCompensator;\n import com.powsybl.iidm.network.Terminal;\n+import com.powsybl.iidm.network.ThreeWindingsTransformer;\n import com.powsybl.iidm.network.TwoWindingsTransformer;\n+import com.powsybl.iidm.network.VoltageLevel;\n+import com.powsybl.iidm.network.util.LinkData;\n+import com.powsybl.iidm.network.util.LinkData.BranchAdmittanceMatrix;\n import com.powsybl.triplestore.api.PropertyBag;\n import com.powsybl.triplestore.api.PropertyBags;\n \n /**\n  * @author Marcos de Miguel <demiguelm at aia.es>\n  * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Elena Kaltakova <kaltakovae at aia.es>\n  */\n-public final class StateVariablesAdder {\n+public class StateVariablesAdder {\n \n-    private StateVariablesAdder() {\n+    public StateVariablesAdder(CgmesModel cgmes, Network n) {\n+        this.cgmes = Objects.requireNonNull(cgmes);\n+        this.n = Objects.requireNonNull(n);\n+        this.cimVersion = ((CgmesModelTripleStore) cgmes).getCimVersion();\n+        this.originalTerminals = cgmes.terminals();\n+        this.originalFullModel = cgmes.fullModel(CgmesSubset.STATE_VARIABLES.getProfile());\n+        this.originalTopologicalIslands = cgmes.topologicalIslands();\n+        this.originalSVcontext = originalSVcontext();\n+        this.boundaryNodesFromDanglingLines = boundaryNodesFromDanglingLines();\n     }\n \n-    public static void add(Network n, CgmesModel cgmes) {\n-        // TODO Add full model data with proper profile (StateVariables)\n-        // FullModel is defined in ModelDescription:\n-        // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private String originalSVcontext() {", "originalCommit": "8c5803a57c016ccc073c447f2f0b81bf799fd123", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMTA1NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388801055", "bodyText": "I don't think so because it uses the cgmes attribute.", "author": "mathbagu", "createdAt": "2020-03-06T09:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMxODgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNTQ4Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388325483", "bodyText": "Does it work from a node/breaker CGMES file? In this case, topological nodes ID are not kept, are they?", "author": "MioRtia", "createdAt": "2020-03-05T14:25:34Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -17,42 +26,122 @@\n import com.powsybl.cgmes.model.CgmesSubset;\n import com.powsybl.cgmes.model.triplestore.CgmesModelTripleStore;\n import com.powsybl.iidm.network.Bus;\n+import com.powsybl.iidm.network.Connectable;\n+import com.powsybl.iidm.network.DanglingLine;\n import com.powsybl.iidm.network.Generator;\n import com.powsybl.iidm.network.Load;\n import com.powsybl.iidm.network.Network;\n import com.powsybl.iidm.network.ShuntCompensator;\n import com.powsybl.iidm.network.Terminal;\n+import com.powsybl.iidm.network.ThreeWindingsTransformer;\n import com.powsybl.iidm.network.TwoWindingsTransformer;\n+import com.powsybl.iidm.network.VoltageLevel;\n+import com.powsybl.iidm.network.util.LinkData;\n+import com.powsybl.iidm.network.util.LinkData.BranchAdmittanceMatrix;\n import com.powsybl.triplestore.api.PropertyBag;\n import com.powsybl.triplestore.api.PropertyBags;\n \n /**\n  * @author Marcos de Miguel <demiguelm at aia.es>\n  * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Elena Kaltakova <kaltakovae at aia.es>\n  */\n-public final class StateVariablesAdder {\n+public class StateVariablesAdder {\n \n-    private StateVariablesAdder() {\n+    public StateVariablesAdder(CgmesModel cgmes, Network n) {\n+        this.cgmes = Objects.requireNonNull(cgmes);\n+        this.n = Objects.requireNonNull(n);\n+        this.cimVersion = ((CgmesModelTripleStore) cgmes).getCimVersion();\n+        this.originalTerminals = cgmes.terminals();\n+        this.originalFullModel = cgmes.fullModel(CgmesSubset.STATE_VARIABLES.getProfile());\n+        this.originalTopologicalIslands = cgmes.topologicalIslands();\n+        this.originalSVcontext = originalSVcontext();\n+        this.boundaryNodesFromDanglingLines = boundaryNodesFromDanglingLines();\n     }\n \n-    public static void add(Network n, CgmesModel cgmes) {\n-        // TODO Add full model data with proper profile (StateVariables)\n-        // FullModel is defined in ModelDescription:\n-        // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private String originalSVcontext() {\n+        PropertyBags pbs = cgmes.graph();\n+        PropertyBag defaultSvContext = new PropertyBag(Arrays.asList(\"graph\"));\n+        defaultSvContext.put(\"graph\", CgmesSubset.STATE_VARIABLES.toString());\n+        return pbs.stream()\n+            .filter(graph -> graph.getId(\"graph\").contains(CgmesSubset.STATE_VARIABLES.getIdentifier()))\n+            .findAny()\n+            .orElse(defaultSvContext)\n+            .getId(\"graph\");\n+    }\n+\n+    public void addStateVariablesToCgmes() {\n+        if (cgmes.isNodeBreaker()) {\n+            // TODO we need to export SV file data for NodeBraker\n+            LOG.warn(\"NodeBreaker view require further investigation to map correctly Topological Nodes\");\n+            return;\n+        }\n+        // Clear the previous SV data in CGMES model\n+        // and fill it with the Network current state values\n+        cgmes.clear(CgmesSubset.STATE_VARIABLES);\n+\n+        if (cimVersion != 14) {\n+            addModelDescriptionToCgmes();\n+            addTopologicalIslandsToCgmes();\n+        }\n+\n+        addVoltagesForTopologicalNodes();\n+\n+        addVoltagesForBoundaryNodes();\n+\n+        addPowerFlowToCgmes();\n \n+        addShuntCompensatorSectionsToCgmes();\n+\n+        addTapStepToCgmes();\n+\n+        addStatusToCgmes();\n+    }\n+\n+    private void addVoltagesForTopologicalNodes() {\n         PropertyBags voltages = new PropertyBags();\n-        for (Bus b : n.getBusBreakerView().getBuses()) {\n+        // add voltages for TpNodes existing in the Model\n+        for (PropertyBag tn : cgmes.topologicalNodes()) {\n+            Bus b = n.getBusBreakerView().getBus(tn.getId(CgmesNames.TOPOLOGICAL_NODE));", "originalCommit": "8c5803a57c016ccc073c447f2f0b81bf799fd123", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUyNjc5OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389526799", "bodyText": "Correct, NodeBreaker view require further investigation to map correctly Topological Nodes. It will be done with the next iteration.", "author": "kaltakovae", "createdAt": "2020-03-09T08:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNTQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUzMDg0MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389530840", "bodyText": "Okay!", "author": "miovd", "createdAt": "2020-03-09T09:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNTQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNDE1NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388334155", "bodyText": "Why are you wrapping it in unmodifiableList? It should work with Arrays.asList(...).forEach(...)", "author": "MioRtia", "createdAt": "2020-03-05T14:38:52Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +210,109 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : n.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Collections.unmodifiableList(Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3())).forEach(leg -> {", "originalCommit": "8c5803a57c016ccc073c447f2f0b81bf799fd123", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MjU0NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389542544", "bodyText": "you're right, we don't keep the object here, the list is already immutable. I'll clean out the 'unmodifiable'", "author": "kaltakovae", "createdAt": "2020-03-09T09:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNDE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1Njk3MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388356970", "bodyText": "Does the case c.getId() == null happen? If not, it may not be necessary to test it.", "author": "MioRtia", "createdAt": "2020-03-05T15:12:21Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +210,109 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : n.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Collections.unmodifiableList(Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3())).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getRatioTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.ratioTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                }\n+            });\n+        }\n+\n+        cgmes.add(originalSVcontext, \"SvTapStep\", tapSteps);\n+    }\n+\n+    private void addStatusToCgmes() {\n+        // create SvStatus, iterate on Connectables, check Terminal status, add\n+        // to SvStatus\n+        PropertyBags svStatus = new PropertyBags();\n+        Set<String> addedConnectables = new HashSet<>();\n+        for (VoltageLevel v : n.getVoltageLevels()) {\n+            for (Connectable<?> c : v.getConnectables()) {\n+                // need to check if connectable was already added\n+                if (!addedConnectables.contains(c.getId())) {\n+                    addedConnectables.add(c.getId());\n+                    if (c.getId() != null) {", "originalCommit": "8c5803a57c016ccc073c447f2f0b81bf799fd123", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0NTA1Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389545057", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-09T09:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1Njk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1ODAxMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388358010", "bodyText": "Again, I don't think this case can happen (in IIDM, when a connectable is created, at least one terminal is created with it).", "author": "MioRtia", "createdAt": "2020-03-05T15:13:46Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +210,109 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : n.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Collections.unmodifiableList(Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3())).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getRatioTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.ratioTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                }\n+            });\n+        }\n+\n+        cgmes.add(originalSVcontext, \"SvTapStep\", tapSteps);\n+    }\n+\n+    private void addStatusToCgmes() {\n+        // create SvStatus, iterate on Connectables, check Terminal status, add\n+        // to SvStatus\n+        PropertyBags svStatus = new PropertyBags();\n+        Set<String> addedConnectables = new HashSet<>();\n+        for (VoltageLevel v : n.getVoltageLevels()) {\n+            for (Connectable<?> c : v.getConnectables()) {\n+                // need to check if connectable was already added\n+                if (!addedConnectables.contains(c.getId())) {\n+                    addedConnectables.add(c.getId());\n+                    if (c.getId() != null) {\n+                        PropertyBag p = new PropertyBag(SV_SVSTATUS_PROPERTIES);\n+                        for (Terminal t : c.getTerminals()) {\n+                            if (t == null) {", "originalCommit": "8c5803a57c016ccc073c447f2f0b81bf799fd123", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0NTg4Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389545886", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-09T09:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1ODAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3MDkyOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388370929", "bodyText": "can be static", "author": "MioRtia", "createdAt": "2020-03-05T15:32:45Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -127,22 +326,115 @@ private static PropertyBag createPowerFlowProperties(CgmesModel cgmes, Terminal\n         return p;\n     }\n \n+    // added TopologicalIsland as it was in cgmes : original topology is\n+    // preserved.\n+    private void addTopologicalIslandsToCgmes() {\n+        if (!originalTopologicalIslands.isEmpty()) {\n+            // For properties such as \"cim:TopologicalIsland.TopologicalNodes\", which might\n+            // have arbitrary number of values, SPARQL will return multiple result sets.\n+            // All properties values will be equal, except the multiValued property\n+            // TopologicalNodes.\n+            // Also, there can be > 1 TopologicalIsland, so we need to re-group PropertyBags\n+            // by TopologicalIsland ID.\n+            Map<String, PropertyBags> byTopologicalIslandId = new HashMap<>();\n+            originalTopologicalIslands.forEach(pb -> {\n+                String island = pb.getId(CgmesNames.TOPOLOGICAL_ISLAND);\n+                if (byTopologicalIslandId.keySet().contains(island)) {\n+                    byTopologicalIslandId.get(island).add(pb);\n+                } else {\n+                    PropertyBags pbs = new PropertyBags();\n+                    pbs.add(pb);\n+                    byTopologicalIslandId.put(island, pbs);\n+                }\n+            });\n+            // now we can process all TPNodes from each island, and put them in one\n+            // multivaluedProperty.\n+            PropertyBags topologicalIslands = new PropertyBags();\n+            byTopologicalIslandId.values().forEach(value -> {\n+                PropertyBag topologicalIsland = new PropertyBag(SV_TOPOLOGICALISLAND_PROPERTIES);\n+                topologicalIsland.setClassPropertyNames(Arrays.asList(CgmesNames.NAME));\n+                topologicalIsland.setMultivaluedProperty(Arrays.asList(\"TopologicalNodes\"));\n+                topologicalIsland.put(CgmesNames.NAME, value.get(0).getId(\"name\"));\n+                topologicalIsland.put(CgmesNames.ANGLEREF_TOPOLOGICALNODE,\n+                    value.get(0).getId(CgmesNames.ANGLEREF_TOPOLOGICALNODE));\n+                topologicalIsland.put(CgmesNames.TOPOLOGICAL_NODES,\n+                    getMultivaluedProperty(value, CgmesNames.TOPOLOGICAL_NODES));\n+                topologicalIslands.add(topologicalIsland);\n+            });\n+            cgmes.add(originalSVcontext, CgmesNames.TOPOLOGICAL_ISLAND, topologicalIslands);\n+        }\n+    }\n+\n+    // Added full model data with proper profile (StateVariables)\n+    // FullModel is defined in ModelDescription:\n+    // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private void addModelDescriptionToCgmes() {\n+        PropertyBags fullModelSV = new PropertyBags();\n+        // for properties such as \"md:Model.DependentOn\" which might have arbitrary\n+        // number of values, SPARQL will return multiple result sets.\n+        // All are equal, except the multiValued property value.\n+        if (!originalFullModel.isEmpty()) {\n+            PropertyBag newModelDescription = new PropertyBag(SV_FULLMODEL_PROPERTIES);\n+            newModelDescription\n+                .setClassPropertyNames(\n+                    Arrays.asList(CgmesNames.SCENARIO_TIME, CgmesNames.CREATED, CgmesNames.DESCRIPTION,\n+                        CgmesNames.VERSION, CgmesNames.DEPENDENT_ON, CgmesNames.PROFILE,\n+                        CgmesNames.MODELING_AUTHORITY_SET));\n+            newModelDescription.setMultivaluedProperty(Arrays.asList(CgmesNames.DEPENDENT_ON));\n+            newModelDescription.put(CgmesNames.SCENARIO_TIME, originalFullModel.get(0).getId(\"scenarioTime\"));\n+            newModelDescription.put(CgmesNames.CREATED, originalFullModel.get(0).getId(\"created\"));\n+            newModelDescription.put(CgmesNames.DESCRIPTION, originalFullModel.get(0).getId(\"description\"));\n+            newModelDescription.put(CgmesNames.VERSION, originalFullModel.get(0).getId(\"version\"));\n+            newModelDescription.put(CgmesNames.DEPENDENT_ON,\n+                getMultivaluedProperty(originalFullModel, \"DependentOn\"));\n+            newModelDescription.put(CgmesNames.PROFILE, originalFullModel.get(0).getId(\"profile\"));\n+            newModelDescription.put(CgmesNames.MODELING_AUTHORITY_SET,\n+                originalFullModel.get(0).getId(\"modelingAuthoritySet\"));\n+            fullModelSV.add(newModelDescription);\n+            cgmes.add(originalSVcontext, CgmesNames.FULL_MODEL, fullModelSV);\n+        }\n+    }\n+\n+    private String getMultivaluedProperty(PropertyBags pb, String multivaluedPropertyName) {", "originalCommit": "8c5803a57c016ccc073c447f2f0b81bf799fd123", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0NjcxNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389546716", "bodyText": "Done. Eventually, we removed the method at all, as we realized it could be done using existing methods PropertyBags.pluckLocals()", "author": "kaltakovae", "createdAt": "2020-03-09T09:34:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3MDkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzQwNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388403406", "bodyText": "set this as a copy to be protected against unsafe changes:\nthis.multiValuedPropertyNames = new ArrayList<>(Objects.requireNonNull(multiValuePropertyNames));", "author": "MioRtia", "createdAt": "2020-03-05T16:19:18Z", "path": "triple-store/triple-store-api/src/main/java/com/powsybl/triplestore/api/PropertyBag.java", "diffHunk": "@@ -195,10 +197,19 @@ public boolean isClassProperty(String name) {\n         return classPropertyNames.contains(name);\n     }\n \n+    public void setMultivaluedProperty(List<String> multiValuedPropertyNames) {\n+        this.multiValuedPropertyNames = Objects.requireNonNull(multiValuedPropertyNames);", "originalCommit": "8c5803a57c016ccc073c447f2f0b81bf799fd123", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU1ODI4OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389558289", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-09T09:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzQwNg=="}], "type": "inlineReview"}, {"oid": "24c7c81771f354c7c36c0290e364726d10162b25", "url": "https://github.com/powsybl/powsybl-core/commit/24c7c81771f354c7c36c0290e364726d10162b25", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file", "committedDate": "2020-03-06T07:14:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMjM2OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388802368", "bodyText": "I don't think this is really needed.", "author": "mathbagu", "createdAt": "2020-03-06T09:41:36Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -61,30 +150,51 @@ public static void add(Network n, CgmesModel cgmes) {\n             }\n         }\n         for (Generator g : n.getGenerators()) {\n-            PropertyBag p = createPowerFlowProperties(cgmes, g.getTerminal());\n+            PropertyBag p = createPowerFlowProperties(g.getTerminal());\n             if (p != null) {\n                 powerFlows.add(p);\n             }\n         }\n         for (ShuntCompensator s : n.getShuntCompensators()) {\n-            PropertyBag p = createPowerFlowProperties(cgmes, s.getTerminal());\n+            PropertyBag p = createPowerFlowProperties(s.getTerminal());\n             if (p != null) {\n-                powerFlows.add(createPowerFlowProperties(cgmes, s.getTerminal()));\n+                powerFlows.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvPowerFlow\", powerFlows);\n \n+        // PowerFlow at boundaries set as it was in original cgmes.\n+        for (PropertyBag terminal : originalTerminals) {\n+            Objects.requireNonNull(terminal);", "originalCommit": "24c7c81771f354c7c36c0290e364726d10162b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU2MDkwNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389560907", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-09T10:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMjM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNDE2OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388804169", "bodyText": "Consider replacing String.valueOf by Boolean.toString", "author": "mathbagu", "createdAt": "2020-03-06T09:45:02Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +210,109 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : n.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Collections.unmodifiableList(Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3())).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getRatioTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.ratioTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                }\n+            });\n+        }\n+\n+        cgmes.add(originalSVcontext, \"SvTapStep\", tapSteps);\n+    }\n+\n+    private void addStatusToCgmes() {\n+        // create SvStatus, iterate on Connectables, check Terminal status, add\n+        // to SvStatus\n+        PropertyBags svStatus = new PropertyBags();\n+        Set<String> addedConnectables = new HashSet<>();\n+        for (VoltageLevel v : n.getVoltageLevels()) {\n+            for (Connectable<?> c : v.getConnectables()) {\n+                // need to check if connectable was already added\n+                if (!addedConnectables.contains(c.getId())) {\n+                    addedConnectables.add(c.getId());\n+                    if (c.getId() != null) {\n+                        PropertyBag p = new PropertyBag(SV_SVSTATUS_PROPERTIES);\n+                        for (Terminal t : c.getTerminals()) {\n+                            if (t == null) {\n+                                continue;\n+                            }\n+                            p.put(IN_SERVICE, String.valueOf(t.isConnected()));", "originalCommit": "24c7c81771f354c7c36c0290e364726d10162b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU2NTE0OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389565149", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-09T10:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNDE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNTI5OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388805299", "bodyText": "Use the stream API to collect boundadyNodes:\nList<String> boundaryNodes = cgmes.boundaryNodes().map(X::getId).collect(Collectors.toList());\n\nReplace X by the name of the class of node.", "author": "mathbagu", "createdAt": "2020-03-06T09:47:09Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +210,109 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : n.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Collections.unmodifiableList(Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3())).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getRatioTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.ratioTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                }\n+            });\n+        }\n+\n+        cgmes.add(originalSVcontext, \"SvTapStep\", tapSteps);\n+    }\n+\n+    private void addStatusToCgmes() {\n+        // create SvStatus, iterate on Connectables, check Terminal status, add\n+        // to SvStatus\n+        PropertyBags svStatus = new PropertyBags();\n+        Set<String> addedConnectables = new HashSet<>();\n+        for (VoltageLevel v : n.getVoltageLevels()) {\n+            for (Connectable<?> c : v.getConnectables()) {\n+                // need to check if connectable was already added\n+                if (!addedConnectables.contains(c.getId())) {\n+                    addedConnectables.add(c.getId());\n+                    if (c.getId() != null) {\n+                        PropertyBag p = new PropertyBag(SV_SVSTATUS_PROPERTIES);\n+                        for (Terminal t : c.getTerminals()) {\n+                            if (t == null) {\n+                                continue;\n+                            }\n+                            p.put(IN_SERVICE, String.valueOf(t.isConnected()));\n+                        }\n+                        p.put(CgmesNames.CONDUCTING_EQUIPMENT, c.getId());\n+                        svStatus.add(p);\n+                    }\n+                }\n+            }\n+        }\n+\n+        // SvStatus at boundaries set as it was in original cgmes.\n+        for (PropertyBag terminal : originalTerminals) {\n+            Objects.requireNonNull(terminal);\n+            if (terminal.getId(\"SvStatus\") == null) {\n+                continue;\n+            }\n+            boundaryNodesFromDanglingLines.values().forEach(value -> {\n+                if (terminal.getId(CgmesNames.TOPOLOGICAL_NODE).equals(value)) {\n+                    PropertyBag p = new PropertyBag(SV_SVSTATUS_PROPERTIES);\n+                    p.put(IN_SERVICE, terminal.getId(IN_SERVICE));\n+                    p.put(CgmesNames.CONDUCTING_EQUIPMENT, terminal.getId(CgmesNames.CONDUCTING_EQUIPMENT));\n+                    svStatus.add(p);\n+                }\n+            });\n+        }\n+        cgmes.add(originalSVcontext, \"SvStatus\", svStatus);\n+    }\n+\n+    private Map<String, String> boundaryNodesFromDanglingLines() {\n+        Map<String, String> nodesFromLines = new HashMap<>();\n+        List<String> boundaryNodes = new ArrayList<>();\n+        cgmes.boundaryNodes().forEach(node -> boundaryNodes.add(node.getId(\"Node\")));", "originalCommit": "24c7c81771f354c7c36c0290e364726d10162b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU5MTk1OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389591958", "bodyText": "Done. Replaced by PropertyBags.pluckLocals(String property)", "author": "kaltakovae", "createdAt": "2020-03-09T11:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNTI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNzEzMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388807131", "bodyText": "Use the stream API to initialize list. If there is no stream() method in PropertyBags, you should consider to add one.", "author": "mathbagu", "createdAt": "2020-03-06T09:50:38Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -127,22 +326,115 @@ private static PropertyBag createPowerFlowProperties(CgmesModel cgmes, Terminal\n         return p;\n     }\n \n+    // added TopologicalIsland as it was in cgmes : original topology is\n+    // preserved.\n+    private void addTopologicalIslandsToCgmes() {\n+        if (!originalTopologicalIslands.isEmpty()) {\n+            // For properties such as \"cim:TopologicalIsland.TopologicalNodes\", which might\n+            // have arbitrary number of values, SPARQL will return multiple result sets.\n+            // All properties values will be equal, except the multiValued property\n+            // TopologicalNodes.\n+            // Also, there can be > 1 TopologicalIsland, so we need to re-group PropertyBags\n+            // by TopologicalIsland ID.\n+            Map<String, PropertyBags> byTopologicalIslandId = new HashMap<>();\n+            originalTopologicalIslands.forEach(pb -> {\n+                String island = pb.getId(CgmesNames.TOPOLOGICAL_ISLAND);\n+                if (byTopologicalIslandId.keySet().contains(island)) {\n+                    byTopologicalIslandId.get(island).add(pb);\n+                } else {\n+                    PropertyBags pbs = new PropertyBags();\n+                    pbs.add(pb);\n+                    byTopologicalIslandId.put(island, pbs);\n+                }\n+            });\n+            // now we can process all TPNodes from each island, and put them in one\n+            // multivaluedProperty.\n+            PropertyBags topologicalIslands = new PropertyBags();\n+            byTopologicalIslandId.values().forEach(value -> {\n+                PropertyBag topologicalIsland = new PropertyBag(SV_TOPOLOGICALISLAND_PROPERTIES);\n+                topologicalIsland.setClassPropertyNames(Arrays.asList(CgmesNames.NAME));\n+                topologicalIsland.setMultivaluedProperty(Arrays.asList(\"TopologicalNodes\"));\n+                topologicalIsland.put(CgmesNames.NAME, value.get(0).getId(\"name\"));\n+                topologicalIsland.put(CgmesNames.ANGLEREF_TOPOLOGICALNODE,\n+                    value.get(0).getId(CgmesNames.ANGLEREF_TOPOLOGICALNODE));\n+                topologicalIsland.put(CgmesNames.TOPOLOGICAL_NODES,\n+                    getMultivaluedProperty(value, CgmesNames.TOPOLOGICAL_NODES));\n+                topologicalIslands.add(topologicalIsland);\n+            });\n+            cgmes.add(originalSVcontext, CgmesNames.TOPOLOGICAL_ISLAND, topologicalIslands);\n+        }\n+    }\n+\n+    // Added full model data with proper profile (StateVariables)\n+    // FullModel is defined in ModelDescription:\n+    // http://iec.ch/TC57/61970-552/ModelDescription/1#\n+    private void addModelDescriptionToCgmes() {\n+        PropertyBags fullModelSV = new PropertyBags();\n+        // for properties such as \"md:Model.DependentOn\" which might have arbitrary\n+        // number of values, SPARQL will return multiple result sets.\n+        // All are equal, except the multiValued property value.\n+        if (!originalFullModel.isEmpty()) {\n+            PropertyBag newModelDescription = new PropertyBag(SV_FULLMODEL_PROPERTIES);\n+            newModelDescription\n+                .setClassPropertyNames(\n+                    Arrays.asList(CgmesNames.SCENARIO_TIME, CgmesNames.CREATED, CgmesNames.DESCRIPTION,\n+                        CgmesNames.VERSION, CgmesNames.DEPENDENT_ON, CgmesNames.PROFILE,\n+                        CgmesNames.MODELING_AUTHORITY_SET));\n+            newModelDescription.setMultivaluedProperty(Arrays.asList(CgmesNames.DEPENDENT_ON));\n+            newModelDescription.put(CgmesNames.SCENARIO_TIME, originalFullModel.get(0).getId(\"scenarioTime\"));\n+            newModelDescription.put(CgmesNames.CREATED, originalFullModel.get(0).getId(\"created\"));\n+            newModelDescription.put(CgmesNames.DESCRIPTION, originalFullModel.get(0).getId(\"description\"));\n+            newModelDescription.put(CgmesNames.VERSION, originalFullModel.get(0).getId(\"version\"));\n+            newModelDescription.put(CgmesNames.DEPENDENT_ON,\n+                getMultivaluedProperty(originalFullModel, \"DependentOn\"));\n+            newModelDescription.put(CgmesNames.PROFILE, originalFullModel.get(0).getId(\"profile\"));\n+            newModelDescription.put(CgmesNames.MODELING_AUTHORITY_SET,\n+                originalFullModel.get(0).getId(\"modelingAuthoritySet\"));\n+            fullModelSV.add(newModelDescription);\n+            cgmes.add(originalSVcontext, CgmesNames.FULL_MODEL, fullModelSV);\n+        }\n+    }\n+\n+    private String getMultivaluedProperty(PropertyBags pb, String multivaluedPropertyName) {\n+        // for properties such as \"md:Model.DependentOn\" which might have arbitrary\n+        // number of values, SPARQL will return multiple result sets. We will loop\n+        // through all and collect all values for multiValued property.\n+        List<String> list = new ArrayList<>();\n+        pb.forEach(m -> list.add(m.getId(multivaluedPropertyName)));", "originalCommit": "24c7c81771f354c7c36c0290e364726d10162b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxMTg1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389611852", "bodyText": "Done. PropertyBags.pluckLocals(String property) does what we need, I missed it initially.", "author": "kaltakovae", "createdAt": "2020-03-09T11:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNzEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwODczMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388808731", "bodyText": "I think you should make this map static. Change also the case of profile to upper case.", "author": "mathbagu", "createdAt": "2020-03-06T09:53:34Z", "path": "cgmes/cgmes-model/src/main/java/com/powsybl/cgmes/model/CgmesSubset.java", "diffHunk": "@@ -71,11 +72,26 @@ public String getIdentifier() {\n         return identifier;\n     }\n \n+    public String getProfile() {\n+        return profileName;\n+    }\n+\n     public boolean isValidName(String contextName) {\n         return contextName.contains(validName0) || contextName.contains(validName1);\n     }\n \n     private static boolean isBoundary(String contextName) {\n         return contextName.contains(\"_BD\") || contextName.contains(\"BOUNDARY\");\n     }\n+\n+    private final String identifier;\n+    private final String validName0;\n+    private final String validName1;\n+    private String profileName;\n+    private final Map<String, String> profile = ImmutableMap.of(", "originalCommit": "24c7c81771f354c7c36c0290e364726d10162b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNTg2NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389705865", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-09T14:05:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwODczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwODg1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388808852", "bodyText": "should probably be final", "author": "mathbagu", "createdAt": "2020-03-06T09:53:49Z", "path": "cgmes/cgmes-model/src/main/java/com/powsybl/cgmes/model/CgmesSubset.java", "diffHunk": "@@ -71,11 +72,26 @@ public String getIdentifier() {\n         return identifier;\n     }\n \n+    public String getProfile() {\n+        return profileName;\n+    }\n+\n     public boolean isValidName(String contextName) {\n         return contextName.contains(validName0) || contextName.contains(validName1);\n     }\n \n     private static boolean isBoundary(String contextName) {\n         return contextName.contains(\"_BD\") || contextName.contains(\"BOUNDARY\");\n     }\n+\n+    private final String identifier;\n+    private final String validName0;\n+    private final String validName1;\n+    private String profileName;", "originalCommit": "24c7c81771f354c7c36c0290e364726d10162b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY3MzExOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389673119", "bodyText": "Done. Eventually, we removed profileName at all.", "author": "kaltakovae", "createdAt": "2020-03-09T13:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwODg1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgxMDE3NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388810175", "bodyText": "Replace Stream.of by Arrays.asList. This list should be static and final ?", "author": "mathbagu", "createdAt": "2020-03-06T09:56:18Z", "path": "triple-store/triple-store-api/src/main/java/com/powsybl/triplestore/api/PropertyBag.java", "diffHunk": "@@ -173,9 +174,10 @@ public final boolean equals(Object obj) {\n \n     public boolean isResource(String name) {\n         // TODO do not rely on property name, use metadata or answer based on value?\n-        return name.equals(\"TopologicalNode\") || name.equals(\"Terminal\")\n-                || name.equals(\"ShuntCompensator\") || name.equals(\"TapChanger\")\n-                || resourceNames.contains(name);\n+        List<String> list = Stream.of(\"TopologicalNode\", \"Terminal\", \"ShuntCompensator\",\n+            \"TapChanger\", \"ConductingEquipment\", \"Model.DependentOn\", \"TopologicalNodes\",\n+            \"AngleRefTopologicalNode\").collect(Collectors.toList());", "originalCommit": "24c7c81771f354c7c36c0290e364726d10162b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczNjc1Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r389736756", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-03-09T14:45:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgxMDE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgxMDQ5Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r388810492", "bodyText": "All these lists should be final?", "author": "mathbagu", "createdAt": "2020-03-06T09:56:51Z", "path": "triple-store/triple-store-api/src/main/java/com/powsybl/triplestore/api/PropertyBag.java", "diffHunk": "@@ -195,10 +197,19 @@ public boolean isClassProperty(String name) {\n         return classPropertyNames.contains(name);\n     }\n \n+    public void setMultivaluedProperty(List<String> multiValuedPropertyNames) {\n+        this.multiValuedPropertyNames = Objects.requireNonNull(multiValuedPropertyNames);\n+    }\n+\n+    public boolean isMultivaluedProperty(String name) {\n+        return multiValuedPropertyNames.contains(name);\n+    }\n+\n     private final List<String> propertyNames;\n     private final boolean removeInitialUnderscoreForIdentifiers;\n     private List<String> resourceNames = new ArrayList<>();\n     private List<String> classPropertyNames = new ArrayList<>();\n+    private List<String> multiValuedPropertyNames = new ArrayList<>();", "originalCommit": "24c7c81771f354c7c36c0290e364726d10162b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE5ODE5NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r390198194", "bodyText": "yes, we set them as finals", "author": "kaltakovae", "createdAt": "2020-03-10T09:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgxMDQ5Mg=="}], "type": "inlineReview"}, {"oid": "d522b1551c4046892850e731c279f3a4bfdc44bd", "url": "https://github.com/powsybl/powsybl-core/commit/d522b1551c4046892850e731c279f3a4bfdc44bd", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-09T08:47:28Z", "type": "commit"}, {"oid": "6494c5646500b4c4c5b893eba1717df518c2a146", "url": "https://github.com/powsybl/powsybl-core/commit/6494c5646500b4c4c5b893eba1717df518c2a146", "message": "fix PR 1201 requested changes\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-09T15:34:57Z", "type": "commit"}, {"oid": "5736f2d6d7f81eda439c1742d7bb431557def054", "url": "https://github.com/powsybl/powsybl-core/commit/5736f2d6d7f81eda439c1742d7bb431557def054", "message": "Add StaticVarCompensators and Batteries PowerFlow to StateVariablesAdder\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-10T08:45:36Z", "type": "commit"}, {"oid": "cb41031b5fcfd26425078b6dc071552e60f73476", "url": "https://github.com/powsybl/powsybl-core/commit/cb41031b5fcfd26425078b6dc071552e60f73476", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-10T08:46:27Z", "type": "commit"}, {"oid": "dead38e5ff1f33080feef197b2ac34ea2b8399a6", "url": "https://github.com/powsybl/powsybl-core/commit/dead38e5ff1f33080feef197b2ac34ea2b8399a6", "message": "Merge branch 'cgmes_update_simple_update_sv_file' of https://github.com/powsybl/powsybl-core into cgmes_update_simple_update_sv_file", "committedDate": "2020-03-10T08:59:55Z", "type": "commit"}, {"oid": "526acd05138572fcd0eac65c86109b9d3d5f49a1", "url": "https://github.com/powsybl/powsybl-core/commit/526acd05138572fcd0eac65c86109b9d3d5f49a1", "message": "fix changes requested for PR 1201\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-10T09:26:32Z", "type": "commit"}, {"oid": "b3ba2f6ae7bc866b20bced962dea0510b481834a", "url": "https://github.com/powsybl/powsybl-core/commit/b3ba2f6ae7bc866b20bced962dea0510b481834a", "message": "fix changes requested for PR 1201\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-10T09:50:07Z", "type": "commit"}, {"oid": "fd8333f28ebd2758f545c82d7e239db457488e9f", "url": "https://github.com/powsybl/powsybl-core/commit/fd8333f28ebd2758f545c82d7e239db457488e9f", "message": "Remove white spaces between cgmes elements in PowsyblWriter, requested for PR 1201\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-10T10:27:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzODM5Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r390438393", "bodyText": "@mathbagu We discussed it but I don't really like that getConnectables() does not ensure that the elements are distinct\n@kaltakovae Do you have a case in which the same Connectable is met several times? In any case, I think you should drop this check, I will make another PR to ensure the list/stream is distinct. Besides, you can use the stream API here.", "author": "MioRtia", "createdAt": "2020-03-10T16:18:18Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/StateVariablesAdder.java", "diffHunk": "@@ -100,20 +221,103 @@ public static void add(Network n, CgmesModel cgmes) {\n                 tapSteps.add(p);\n             }\n         }\n-        cgmes.add(CgmesSubset.STATE_VARIABLES, \"SvTapStep\", tapSteps);\n+\n+        for (ThreeWindingsTransformer t : network.getThreeWindingsTransformers()) {\n+            PropertyBag p = new PropertyBag(svTapStepProperties);\n+            Arrays.asList(t.getLeg1(), t.getLeg2(), t.getLeg3()).forEach(leg -> {\n+                if (leg.getPhaseTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getPhaseTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.phaseTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                } else if (leg.getRatioTapChanger() != null) {\n+                    p.put(tapChangerPositionName, is(leg.getRatioTapChanger().getTapPosition()));\n+                    p.put(CgmesNames.TAP_CHANGER, cgmes.ratioTapChangerForPowerTransformer(t.getId()));\n+                    tapSteps.add(p);\n+                }\n+            });\n+        }\n+\n+        cgmes.add(originalSVcontext, \"SvTapStep\", tapSteps);\n+    }\n+\n+    private void addStatusToCgmes() {\n+        // create SvStatus, iterate on Connectables, check Terminal status, add\n+        // to SvStatus\n+        PropertyBags svStatus = new PropertyBags();\n+        Set<String> addedConnectables = new HashSet<>();\n+        for (VoltageLevel v : network.getVoltageLevels()) {\n+            for (Connectable<?> c : v.getConnectables()) {\n+                // need to check if connectable was already added\n+                if (!addedConnectables.contains(c.getId())) {", "originalCommit": "fd8333f28ebd2758f545c82d7e239db457488e9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgzNTYxMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r390835611", "bodyText": "Currently we observe multiple duplicates, e.g. for each Line or Transformer getConnectables() duplicates results. We've tested with MicroGrid and HOPS test cases.\nBut, even if getConnectables() results in distincts, we still need the check for duplicates here:\nWithout this check any Connectables which are in different VoltageLevels (e.g Transformers) will be duplicated or triplicated.", "author": "kaltakovae", "createdAt": "2020-03-11T09:19:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzODM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg0NjYwNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r390846605", "bodyText": "Thank you for your input! I made a PR to check for duplicates in a same voltage level. As for your code, thank your for the clarification! I think you can optimize it as such:\nPropertyBags svStatus = new PropertyBags();\nnetwork.getVoltageLevelStream()\n                .flatMap(VoltageLevel::getConnectableStream)\n                .distinct()\n                .forEach(c -> {\n                    PropertyBag p = new PropertyBag(SV_SVSTATUS_PROPERTIES);\n                    for (Terminal t : ((Connectable<?>) c).getTerminals()) {\n                        p.put(IN_SERVICE, Boolean.toString(t.isConnected()));\n                    }\n                    p.put(CgmesNames.CONDUCTING_EQUIPMENT, c.getId());\n                    svStatus.add(p);\n});", "author": "miovd", "createdAt": "2020-03-11T09:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzODM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg0Njg2Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r390846867", "bodyText": "About finding duplicates:\nThere is no getConnectables at Network level, so to obtain all connectables of the network we must iterate first over the voltage levels, then its connectables.\nThis means that we have to account for potential duplicates: lines and 2w transformers will be found twice, once for every end, and 3w transformers will appear three times during the iteration.\nSo, unless we have a getConnectables at Network level, we have to take into account for potential duplicates.\nAn alternative could be to iterate over specific types of equipment (getLines, getTransformers, getGenerators, getLoads, ...) but that would mean to have a long list of method calls, and leave the risk of omitting new types when they are added to the Network (in the future). I mean, leaving a long list of specific dependencies when a generic treatment over all kind of equipment can be done.", "author": "zamarrenolm", "createdAt": "2020-03-11T09:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzODM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg2MTc2Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1201#discussion_r390861763", "bodyText": "@MioRtia  Thank you Miora, this mathes perfectly to what we wanted. I've done the change.", "author": "kaltakovae", "createdAt": "2020-03-11T10:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzODM5Mw=="}], "type": "inlineReview"}, {"oid": "83fcff70dd4a13e1cc3f3663a905aa0df53e889c", "url": "https://github.com/powsybl/powsybl-core/commit/83fcff70dd4a13e1cc3f3663a905aa0df53e889c", "message": "Merge branch 'master' into cgmes_update_simple_update_sv_file\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-03-11T08:57:05Z", "type": "commit"}]}