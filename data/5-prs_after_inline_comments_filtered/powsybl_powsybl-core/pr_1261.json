{"pr_number": 1261, "pr_title": "Add sub-network reduction predicate", "pr_createdAt": "2020-04-05T19:33:10Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1261", "timeline": [{"oid": "015782610ad037105c577ac3588f2a26590b6cfe", "url": "https://github.com/powsybl/powsybl-core/commit/015782610ad037105c577ac3588f2a26590b6cfe", "message": "Add sub-network reduction predicate\n\nSigned-off-by: Geoffroy Jamgotchian <geoffroy.jamgotchian@rte-france.com>", "committedDate": "2020-04-05T19:31:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzNzA2Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1261#discussion_r404637062", "bodyText": "Declare these variables final.", "author": "mathbagu", "createdAt": "2020-04-07T08:39:51Z", "path": "iidm/iidm-reducer/src/main/java/com/powsybl/iidm/reducer/SubNetworkPredicate.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.reducer;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.LinkedHashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * A network reducer predicate that allow reduction based on a center voltage level and all other voltage level neighbors\n+ * within a specified depth.\n+ *\n+ * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ */\n+public class SubNetworkPredicate implements NetworkPredicate {\n+\n+    private String voltageLevelId;\n+\n+    private int maxDepth;", "originalCommit": "015782610ad037105c577ac3588f2a26590b6cfe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzOTE3OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1261#discussion_r404639178", "bodyText": "I think it's not a good design: the delegate is in fact final (you skip this part if the delegate is already initialized), but initialized after the constructor. I propose to make it delegate final, and initialize the SubNetworkPredicate using a VoltageLevel instead of its ID.\nIf you want to reuse the SubAreaNetwork for different VL or networks, the init() method should return the predicate and you should use a local variable.", "author": "mathbagu", "createdAt": "2020-04-07T08:43:17Z", "path": "iidm/iidm-reducer/src/main/java/com/powsybl/iidm/reducer/SubNetworkPredicate.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.reducer;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.LinkedHashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * A network reducer predicate that allow reduction based on a center voltage level and all other voltage level neighbors\n+ * within a specified depth.\n+ *\n+ * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ */\n+public class SubNetworkPredicate implements NetworkPredicate {\n+\n+    private String voltageLevelId;\n+\n+    private int maxDepth;\n+\n+    private IdentifierNetworkPredicate delegate;\n+\n+    public SubNetworkPredicate(String voltageLevelId, int maxDepth) {\n+        this.voltageLevelId = Objects.requireNonNull(voltageLevelId);\n+        if (maxDepth < 0) {\n+            throw new IllegalArgumentException(\"Invalid max depth value: \" + maxDepth);\n+        }\n+        this.maxDepth = maxDepth;\n+    }\n+\n+    private void init(Network network) {\n+        if (delegate != null) {\n+            return;\n+        }\n+        VoltageLevel vl = network.getVoltageLevel(voltageLevelId);\n+        if (vl == null) {\n+            throw new PowsyblException(\"Voltage level '\" + voltageLevelId + \"' not found\");\n+        }\n+        Set<String> voltageLevelIds = new LinkedHashSet<>();\n+        traverse(vl, 0, maxDepth, voltageLevelIds);\n+        delegate = new IdentifierNetworkPredicate(voltageLevelIds);", "originalCommit": "015782610ad037105c577ac3588f2a26590b6cfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDczNDYzMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1261#discussion_r404734633", "bodyText": "Ok done", "author": "geofjamg", "createdAt": "2020-04-07T11:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzOTE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzOTYwNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1261#discussion_r404639607", "bodyText": "Make this method private", "author": "mathbagu", "createdAt": "2020-04-07T08:44:00Z", "path": "iidm/iidm-reducer/src/main/java/com/powsybl/iidm/reducer/SubNetworkPredicate.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.reducer;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.LinkedHashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * A network reducer predicate that allow reduction based on a center voltage level and all other voltage level neighbors\n+ * within a specified depth.\n+ *\n+ * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ */\n+public class SubNetworkPredicate implements NetworkPredicate {\n+\n+    private String voltageLevelId;\n+\n+    private int maxDepth;\n+\n+    private IdentifierNetworkPredicate delegate;\n+\n+    public SubNetworkPredicate(String voltageLevelId, int maxDepth) {\n+        this.voltageLevelId = Objects.requireNonNull(voltageLevelId);\n+        if (maxDepth < 0) {\n+            throw new IllegalArgumentException(\"Invalid max depth value: \" + maxDepth);\n+        }\n+        this.maxDepth = maxDepth;\n+    }\n+\n+    private void init(Network network) {\n+        if (delegate != null) {\n+            return;\n+        }\n+        VoltageLevel vl = network.getVoltageLevel(voltageLevelId);\n+        if (vl == null) {\n+            throw new PowsyblException(\"Voltage level '\" + voltageLevelId + \"' not found\");\n+        }\n+        Set<String> voltageLevelIds = new LinkedHashSet<>();\n+        traverse(vl, 0, maxDepth, voltageLevelIds);\n+        delegate = new IdentifierNetworkPredicate(voltageLevelIds);\n+    }\n+\n+    private static void traverse(VoltageLevel vl, int depth, int maxDepth, Set<String> voltageLevelIds) {\n+        if (voltageLevelIds.contains(vl.getId()) || depth > maxDepth) {\n+            return;\n+        }\n+\n+        voltageLevelIds.add(vl.getId());\n+\n+        vl.visitEquipments(new DefaultTopologyVisitor() {\n+            public void visitBranch(Branch branch, Branch.Side side) {", "originalCommit": "015782610ad037105c577ac3588f2a26590b6cfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDczNDY5OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1261#discussion_r404734699", "bodyText": "Done", "author": "geofjamg", "createdAt": "2020-04-07T11:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzOTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzOTgzNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1261#discussion_r404639835", "bodyText": "You should visit HVDC lines also?", "author": "mathbagu", "createdAt": "2020-04-07T08:44:21Z", "path": "iidm/iidm-reducer/src/main/java/com/powsybl/iidm/reducer/SubNetworkPredicate.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.reducer;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.LinkedHashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * A network reducer predicate that allow reduction based on a center voltage level and all other voltage level neighbors\n+ * within a specified depth.\n+ *\n+ * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ */\n+public class SubNetworkPredicate implements NetworkPredicate {\n+\n+    private String voltageLevelId;\n+\n+    private int maxDepth;\n+\n+    private IdentifierNetworkPredicate delegate;\n+\n+    public SubNetworkPredicate(String voltageLevelId, int maxDepth) {\n+        this.voltageLevelId = Objects.requireNonNull(voltageLevelId);\n+        if (maxDepth < 0) {\n+            throw new IllegalArgumentException(\"Invalid max depth value: \" + maxDepth);\n+        }\n+        this.maxDepth = maxDepth;\n+    }\n+\n+    private void init(Network network) {\n+        if (delegate != null) {\n+            return;\n+        }\n+        VoltageLevel vl = network.getVoltageLevel(voltageLevelId);\n+        if (vl == null) {\n+            throw new PowsyblException(\"Voltage level '\" + voltageLevelId + \"' not found\");\n+        }\n+        Set<String> voltageLevelIds = new LinkedHashSet<>();\n+        traverse(vl, 0, maxDepth, voltageLevelIds);\n+        delegate = new IdentifierNetworkPredicate(voltageLevelIds);\n+    }\n+\n+    private static void traverse(VoltageLevel vl, int depth, int maxDepth, Set<String> voltageLevelIds) {\n+        if (voltageLevelIds.contains(vl.getId()) || depth > maxDepth) {\n+            return;\n+        }\n+\n+        voltageLevelIds.add(vl.getId());\n+\n+        vl.visitEquipments(new DefaultTopologyVisitor() {\n+            public void visitBranch(Branch branch, Branch.Side side) {\n+                switch (side) {\n+                    case ONE:\n+                        traverse(branch.getTerminal2().getVoltageLevel(), depth + 1, maxDepth, voltageLevelIds);\n+                        break;\n+                    case TWO:\n+                        traverse(branch.getTerminal1().getVoltageLevel(), depth + 1, maxDepth, voltageLevelIds);\n+                        break;\n+                    default:\n+                        throw new IllegalStateException(\"Unknown side: \" + side);\n+                }\n+            }\n+\n+            @Override\n+            public void visitLine(Line line, Line.Side side) {\n+                visitBranch(line, side);\n+            }\n+\n+            @Override\n+            public void visitTwoWindingsTransformer(TwoWindingsTransformer transformer, TwoWindingsTransformer.Side side) {\n+                visitBranch(transformer, side);\n+            }\n+\n+            @Override\n+            public void visitThreeWindingsTransformer(ThreeWindingsTransformer transformer, ThreeWindingsTransformer.Side side) {\n+                switch (side) {\n+                    case ONE:\n+                        traverse(transformer.getLeg2().getTerminal().getVoltageLevel(), depth + 1, maxDepth, voltageLevelIds);\n+                        traverse(transformer.getLeg3().getTerminal().getVoltageLevel(), depth + 1, maxDepth, voltageLevelIds);\n+                        break;\n+                    case TWO:\n+                        traverse(transformer.getLeg1().getTerminal().getVoltageLevel(), depth + 1, maxDepth, voltageLevelIds);\n+                        traverse(transformer.getLeg3().getTerminal().getVoltageLevel(), depth + 1, maxDepth, voltageLevelIds);\n+                        break;\n+                    case THREE:\n+                        traverse(transformer.getLeg1().getTerminal().getVoltageLevel(), depth + 1, maxDepth, voltageLevelIds);\n+                        traverse(transformer.getLeg2().getTerminal().getVoltageLevel(), depth + 1, maxDepth, voltageLevelIds);\n+                        break;\n+                    default:\n+                        throw new IllegalStateException(\"Unknown side: \" + side);\n+                }\n+            }", "originalCommit": "015782610ad037105c577ac3588f2a26590b6cfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDczNjQ0MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1261#discussion_r404736441", "bodyText": "Good question. In my own use case, I didn't want to traverse HVDC lines. I can imagine in some other use case, it would make sense.\nWhat should I do?\n\nlet as it is and if somebody wants one day, we will consider to add it.\noptionally add it right now", "author": "geofjamg", "createdAt": "2020-04-07T11:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzOTgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMxNjA3Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1261#discussion_r405316076", "bodyText": "It makes sense to do it now. Do we consider it's an option enabled by a boolean or do we consider it always traverse the HVDC lines\nDepending on what we chose to do, we can merge it, or do it later (an issue has to be filled)", "author": "mathbagu", "createdAt": "2020-04-08T07:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzOTgzNQ=="}], "type": "inlineReview"}, {"oid": "c4bca0bcf602ccffeb9d4e6216c4c24607f8e42b", "url": "https://github.com/powsybl/powsybl-core/commit/c4bca0bcf602ccffeb9d4e6216c4c24607f8e42b", "message": "Refactoring\n\nSigned-off-by: Geoffroy Jamgotchian <geoffroy.jamgotchian@rte-france.com>", "committedDate": "2020-04-07T11:22:54Z", "type": "commit"}, {"oid": "31a151f85590edafbdeaed5ebb9f03c36901fde5", "url": "https://github.com/powsybl/powsybl-core/commit/31a151f85590edafbdeaed5ebb9f03c36901fde5", "message": "change visibility to private\n\nSigned-off-by: Geoffroy Jamgotchian <geoffroy.jamgotchian@rte-france.com>", "committedDate": "2020-04-07T11:24:21Z", "type": "commit"}, {"oid": "7e99990d85041e015dc4ba69df3b54f3240213bc", "url": "https://github.com/powsybl/powsybl-core/commit/7e99990d85041e015dc4ba69df3b54f3240213bc", "message": "Fix Sonar issues\n\nSigned-off-by: Geoffroy Jamgotchian <geoffroy.jamgotchian@rte-france.com>", "committedDate": "2020-04-07T11:34:03Z", "type": "commit"}, {"oid": "2fbfe69b97943b00637a6e786d0a9aaca9466680", "url": "https://github.com/powsybl/powsybl-core/commit/2fbfe69b97943b00637a6e786d0a9aaca9466680", "message": "Merge branch 'master' into subnetwork_filter", "committedDate": "2020-04-14T15:43:28Z", "type": "commit"}]}