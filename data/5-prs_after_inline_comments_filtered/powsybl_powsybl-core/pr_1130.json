{"pr_number": 1130, "pr_title": "Merging view step : MergedLine adapter implementation", "pr_createdAt": "2020-01-22T16:13:46Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1130", "timeline": [{"oid": "c98c6df4d11f11e4a2d79e49ab9dbdb166eb56cf", "url": "https://github.com/powsybl/powsybl-core/commit/c98c6df4d11f11e4a2d79e49ab9dbdb166eb56cf", "message": "Merging view step : MergedLine adapter implementation\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2020-01-22T16:24:44Z", "type": "forcePushed"}, {"oid": "79178b40bb571f67f9d87817322cf704a162e681", "url": "https://github.com/powsybl/powsybl-core/commit/79178b40bb571f67f9d87817322cf704a162e681", "message": "Merging view step : MergedLine adapter implementation\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2020-01-22T17:16:15Z", "type": "commit"}, {"oid": "79178b40bb571f67f9d87817322cf704a162e681", "url": "https://github.com/powsybl/powsybl-core/commit/79178b40bb571f67f9d87817322cf704a162e681", "message": "Merging view step : MergedLine adapter implementation\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2020-01-22T17:16:15Z", "type": "forcePushed"}, {"oid": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "url": "https://github.com/powsybl/powsybl-core/commit/f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "message": "Include MergedLine into Branch & Identifiable searches\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2020-01-23T09:31:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0MzE5OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371143199", "bodyText": "Detail: rename dll to dl (DanglingLine)", "author": "mathbagu", "createdAt": "2020-01-27T09:49:14Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/DanglingLineAdderAdapter.java", "diffHunk": "@@ -21,7 +21,9 @@\n     @Override\n     public DanglingLine add() {\n         checkAndSetUniqueId();\n-        return getIndex().getDanglingLine(getDelegate().add());\n+        final DanglingLine dll = getDelegate().add();", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0MzQxOA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371143418", "bodyText": "Add license information", "author": "mathbagu", "createdAt": "2020-01-27T09:49:41Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/LineAdderAdapter.java", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.powsybl.iidm.mergingview;", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0MzUwMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371143501", "bodyText": "Add @author information", "author": "mathbagu", "createdAt": "2020-01-27T09:49:54Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/LineAdderAdapter.java", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.Objects;\n+\n+class LineAdderAdapter implements LineAdder {", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0NzcxNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371147714", "bodyText": "I think it's not needed to have this if/else. Integrity tests are done in the add method:\n    ...\n    .setBus1(bus1)\n    .setConnectableBus1(connectableBus1)\n    .setNode1(node1)\n    ...", "author": "mathbagu", "createdAt": "2020-01-27T09:58:45Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/LineAdderAdapter.java", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.Objects;\n+\n+class LineAdderAdapter implements LineAdder {\n+\n+    private final MergingViewIndex index;\n+\n+    private String id;\n+\n+    private String name;\n+\n+    private boolean ensureIdUnicity;\n+\n+    private Integer node1;\n+\n+    private String bus1;\n+\n+    private String connectableBus1;\n+\n+    private String voltageLevelId1;\n+\n+    private Integer node2;\n+\n+    private String bus2;\n+\n+    private String connectableBus2;\n+\n+    private String voltageLevelId2;\n+\n+    private double r = Double.NaN;\n+\n+    private double x = Double.NaN;\n+\n+    private double g1 = Double.NaN;\n+\n+    private double b1 = Double.NaN;\n+\n+    private double g2 = Double.NaN;\n+\n+    private double b2 = Double.NaN;\n+\n+    LineAdderAdapter(final MergingViewIndex index) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+    }\n+\n+    @Override\n+    public Line add() {\n+        Line newLine = null;\n+        final Network n1 = checkAndGetNetwork1();\n+        final Network n2 = checkAndGetNetwork2();\n+        if (n1 == n2) {\n+            newLine = index.getLine(addLine(n1));\n+        } else {\n+            // Creation of 2 dangling lines\n+            throw MergingView.NOT_IMPLEMENTED_EXCEPTION;\n+        }\n+        return newLine;\n+    }\n+\n+    private Line addLine(final Network network) {\n+        final LineAdder adder = network.newLine()\n+                .setId(id)\n+                .setEnsureIdUnicity(ensureIdUnicity)\n+                .setName(name)\n+                .setR(r)\n+                .setX(x)\n+                .setG1(g1)\n+                .setB1(b1)\n+                .setG2(g2)\n+                .setB2(b2)\n+                .setVoltageLevel1(voltageLevelId1)\n+                .setVoltageLevel2(voltageLevelId2);\n+        if (network.getVoltageLevel(voltageLevelId1).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus1(bus1)\n+                 .setConnectableBus1(connectableBus1);\n+        } else {\n+            adder.setNode1(node1);\n+        }", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY3NTk4NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371675985", "bodyText": "To do this, i need to change interface BranchAdder setNode1 & setNode2 methods as following :\nsetNode1(int node1) -> setNode1(Integer node1)\nsetNode2(int node1) -> setNode2(Integer node1)\nOtherwise a NullPointerException is raised.", "author": "tadam50", "createdAt": "2020-01-28T09:01:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0NzcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0Nzc2NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371147764", "bodyText": "Same remark here", "author": "mathbagu", "createdAt": "2020-01-27T09:58:52Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/LineAdderAdapter.java", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.Objects;\n+\n+class LineAdderAdapter implements LineAdder {\n+\n+    private final MergingViewIndex index;\n+\n+    private String id;\n+\n+    private String name;\n+\n+    private boolean ensureIdUnicity;\n+\n+    private Integer node1;\n+\n+    private String bus1;\n+\n+    private String connectableBus1;\n+\n+    private String voltageLevelId1;\n+\n+    private Integer node2;\n+\n+    private String bus2;\n+\n+    private String connectableBus2;\n+\n+    private String voltageLevelId2;\n+\n+    private double r = Double.NaN;\n+\n+    private double x = Double.NaN;\n+\n+    private double g1 = Double.NaN;\n+\n+    private double b1 = Double.NaN;\n+\n+    private double g2 = Double.NaN;\n+\n+    private double b2 = Double.NaN;\n+\n+    LineAdderAdapter(final MergingViewIndex index) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+    }\n+\n+    @Override\n+    public Line add() {\n+        Line newLine = null;\n+        final Network n1 = checkAndGetNetwork1();\n+        final Network n2 = checkAndGetNetwork2();\n+        if (n1 == n2) {\n+            newLine = index.getLine(addLine(n1));\n+        } else {\n+            // Creation of 2 dangling lines\n+            throw MergingView.NOT_IMPLEMENTED_EXCEPTION;\n+        }\n+        return newLine;\n+    }\n+\n+    private Line addLine(final Network network) {\n+        final LineAdder adder = network.newLine()\n+                .setId(id)\n+                .setEnsureIdUnicity(ensureIdUnicity)\n+                .setName(name)\n+                .setR(r)\n+                .setX(x)\n+                .setG1(g1)\n+                .setB1(b1)\n+                .setG2(g2)\n+                .setB2(b2)\n+                .setVoltageLevel1(voltageLevelId1)\n+                .setVoltageLevel2(voltageLevelId2);\n+        if (network.getVoltageLevel(voltageLevelId1).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus1(bus1)\n+                 .setConnectableBus1(connectableBus1);\n+        } else {\n+            adder.setNode1(node1);\n+        }\n+        if (network.getVoltageLevel(voltageLevelId2).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus2(bus2)\n+                 .setConnectableBus2(connectableBus2);\n+        } else {\n+            adder.setNode2(node2);\n+        }", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY3NjE4Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371676187", "bodyText": "Same answer", "author": "tadam50", "createdAt": "2020-01-28T09:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0Nzc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0OTI5MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371149291", "bodyText": "To be discussed: if we have performance issue, we should consider to add a private-package method to get the underlying network instead of iterating over the networks.", "author": "mathbagu", "createdAt": "2020-01-27T10:01:58Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/LineAdderAdapter.java", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.Objects;\n+\n+class LineAdderAdapter implements LineAdder {\n+\n+    private final MergingViewIndex index;\n+\n+    private String id;\n+\n+    private String name;\n+\n+    private boolean ensureIdUnicity;\n+\n+    private Integer node1;\n+\n+    private String bus1;\n+\n+    private String connectableBus1;\n+\n+    private String voltageLevelId1;\n+\n+    private Integer node2;\n+\n+    private String bus2;\n+\n+    private String connectableBus2;\n+\n+    private String voltageLevelId2;\n+\n+    private double r = Double.NaN;\n+\n+    private double x = Double.NaN;\n+\n+    private double g1 = Double.NaN;\n+\n+    private double b1 = Double.NaN;\n+\n+    private double g2 = Double.NaN;\n+\n+    private double b2 = Double.NaN;\n+\n+    LineAdderAdapter(final MergingViewIndex index) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+    }\n+\n+    @Override\n+    public Line add() {\n+        Line newLine = null;\n+        final Network n1 = checkAndGetNetwork1();\n+        final Network n2 = checkAndGetNetwork2();\n+        if (n1 == n2) {\n+            newLine = index.getLine(addLine(n1));\n+        } else {\n+            // Creation of 2 dangling lines\n+            throw MergingView.NOT_IMPLEMENTED_EXCEPTION;\n+        }\n+        return newLine;\n+    }\n+\n+    private Line addLine(final Network network) {\n+        final LineAdder adder = network.newLine()\n+                .setId(id)\n+                .setEnsureIdUnicity(ensureIdUnicity)\n+                .setName(name)\n+                .setR(r)\n+                .setX(x)\n+                .setG1(g1)\n+                .setB1(b1)\n+                .setG2(g2)\n+                .setB2(b2)\n+                .setVoltageLevel1(voltageLevelId1)\n+                .setVoltageLevel2(voltageLevelId2);\n+        if (network.getVoltageLevel(voltageLevelId1).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus1(bus1)\n+                 .setConnectableBus1(connectableBus1);\n+        } else {\n+            adder.setNode1(node1);\n+        }\n+        if (network.getVoltageLevel(voltageLevelId2).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus2(bus2)\n+                 .setConnectableBus2(connectableBus2);\n+        } else {\n+            adder.setNode2(node2);\n+        }\n+        return adder.add();\n+    }\n+\n+    private Network checkAndGetNetwork1() {\n+        if (voltageLevelId1 == null) {\n+            throw new PowsyblException(\"first voltage level is not set\");\n+        }\n+        Network network = index.getNetworkStream()\n+                .filter(n -> n.getVoltageLevel(voltageLevelId1) != null)\n+                .findFirst()\n+                .orElse(null);\n+        if (network == null) {\n+            throw new PowsyblException(\"first voltage level '\" + voltageLevelId1 + \"' not found\");\n+        }\n+        return network;", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0OTQ0MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371149440", "bodyText": "Typo: Second", "author": "mathbagu", "createdAt": "2020-01-27T10:02:19Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/LineAdderAdapter.java", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.Objects;\n+\n+class LineAdderAdapter implements LineAdder {\n+\n+    private final MergingViewIndex index;\n+\n+    private String id;\n+\n+    private String name;\n+\n+    private boolean ensureIdUnicity;\n+\n+    private Integer node1;\n+\n+    private String bus1;\n+\n+    private String connectableBus1;\n+\n+    private String voltageLevelId1;\n+\n+    private Integer node2;\n+\n+    private String bus2;\n+\n+    private String connectableBus2;\n+\n+    private String voltageLevelId2;\n+\n+    private double r = Double.NaN;\n+\n+    private double x = Double.NaN;\n+\n+    private double g1 = Double.NaN;\n+\n+    private double b1 = Double.NaN;\n+\n+    private double g2 = Double.NaN;\n+\n+    private double b2 = Double.NaN;\n+\n+    LineAdderAdapter(final MergingViewIndex index) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+    }\n+\n+    @Override\n+    public Line add() {\n+        Line newLine = null;\n+        final Network n1 = checkAndGetNetwork1();\n+        final Network n2 = checkAndGetNetwork2();\n+        if (n1 == n2) {\n+            newLine = index.getLine(addLine(n1));\n+        } else {\n+            // Creation of 2 dangling lines\n+            throw MergingView.NOT_IMPLEMENTED_EXCEPTION;\n+        }\n+        return newLine;\n+    }\n+\n+    private Line addLine(final Network network) {\n+        final LineAdder adder = network.newLine()\n+                .setId(id)\n+                .setEnsureIdUnicity(ensureIdUnicity)\n+                .setName(name)\n+                .setR(r)\n+                .setX(x)\n+                .setG1(g1)\n+                .setB1(b1)\n+                .setG2(g2)\n+                .setB2(b2)\n+                .setVoltageLevel1(voltageLevelId1)\n+                .setVoltageLevel2(voltageLevelId2);\n+        if (network.getVoltageLevel(voltageLevelId1).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus1(bus1)\n+                 .setConnectableBus1(connectableBus1);\n+        } else {\n+            adder.setNode1(node1);\n+        }\n+        if (network.getVoltageLevel(voltageLevelId2).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus2(bus2)\n+                 .setConnectableBus2(connectableBus2);\n+        } else {\n+            adder.setNode2(node2);\n+        }\n+        return adder.add();\n+    }\n+\n+    private Network checkAndGetNetwork1() {\n+        if (voltageLevelId1 == null) {\n+            throw new PowsyblException(\"first voltage level is not set\");\n+        }\n+        Network network = index.getNetworkStream()\n+                .filter(n -> n.getVoltageLevel(voltageLevelId1) != null)\n+                .findFirst()\n+                .orElse(null);\n+        if (network == null) {\n+            throw new PowsyblException(\"first voltage level '\" + voltageLevelId1 + \"' not found\");\n+        }\n+        return network;\n+    }\n+\n+    private Network checkAndGetNetwork2() {\n+        if (voltageLevelId2 == null) {\n+            throw new PowsyblException(\"second voltage level is not set\");\n+        }\n+        Network network = index.getNetworkStream()\n+                .filter(n -> n.getVoltageLevel(voltageLevelId2) != null)\n+                .findFirst()\n+                .orElse(null);\n+        if (network == null) {\n+            throw new PowsyblException(\"second voltage level '\" + voltageLevelId2 + \"' not found\");", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0OTUxMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371149510", "bodyText": "Typo: First", "author": "mathbagu", "createdAt": "2020-01-27T10:02:28Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/LineAdderAdapter.java", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.Objects;\n+\n+class LineAdderAdapter implements LineAdder {\n+\n+    private final MergingViewIndex index;\n+\n+    private String id;\n+\n+    private String name;\n+\n+    private boolean ensureIdUnicity;\n+\n+    private Integer node1;\n+\n+    private String bus1;\n+\n+    private String connectableBus1;\n+\n+    private String voltageLevelId1;\n+\n+    private Integer node2;\n+\n+    private String bus2;\n+\n+    private String connectableBus2;\n+\n+    private String voltageLevelId2;\n+\n+    private double r = Double.NaN;\n+\n+    private double x = Double.NaN;\n+\n+    private double g1 = Double.NaN;\n+\n+    private double b1 = Double.NaN;\n+\n+    private double g2 = Double.NaN;\n+\n+    private double b2 = Double.NaN;\n+\n+    LineAdderAdapter(final MergingViewIndex index) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+    }\n+\n+    @Override\n+    public Line add() {\n+        Line newLine = null;\n+        final Network n1 = checkAndGetNetwork1();\n+        final Network n2 = checkAndGetNetwork2();\n+        if (n1 == n2) {\n+            newLine = index.getLine(addLine(n1));\n+        } else {\n+            // Creation of 2 dangling lines\n+            throw MergingView.NOT_IMPLEMENTED_EXCEPTION;\n+        }\n+        return newLine;\n+    }\n+\n+    private Line addLine(final Network network) {\n+        final LineAdder adder = network.newLine()\n+                .setId(id)\n+                .setEnsureIdUnicity(ensureIdUnicity)\n+                .setName(name)\n+                .setR(r)\n+                .setX(x)\n+                .setG1(g1)\n+                .setB1(b1)\n+                .setG2(g2)\n+                .setB2(b2)\n+                .setVoltageLevel1(voltageLevelId1)\n+                .setVoltageLevel2(voltageLevelId2);\n+        if (network.getVoltageLevel(voltageLevelId1).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus1(bus1)\n+                 .setConnectableBus1(connectableBus1);\n+        } else {\n+            adder.setNode1(node1);\n+        }\n+        if (network.getVoltageLevel(voltageLevelId2).getTopologyKind() == TopologyKind.BUS_BREAKER) {\n+            adder.setBus2(bus2)\n+                 .setConnectableBus2(connectableBus2);\n+        } else {\n+            adder.setNode2(node2);\n+        }\n+        return adder.add();\n+    }\n+\n+    private Network checkAndGetNetwork1() {\n+        if (voltageLevelId1 == null) {\n+            throw new PowsyblException(\"first voltage level is not set\");\n+        }\n+        Network network = index.getNetworkStream()\n+                .filter(n -> n.getVoltageLevel(voltageLevelId1) != null)\n+                .findFirst()\n+                .orElse(null);\n+        if (network == null) {\n+            throw new PowsyblException(\"first voltage level '\" + voltageLevelId1 + \"' not found\");", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MDE0NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371150145", "bodyText": "Fix this license header: 2020 and RTE instead of 2016 and iTesla", "author": "mathbagu", "createdAt": "2020-01-27T10:03:47Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,391 @@\n+/**\n+ * Copyright (c) 2016, All partners of the iTesla project (http://www.itesla-project.eu/consortium)", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MDYyMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371150623", "bodyText": "For readability, make a private static utility function", "author": "mathbagu", "createdAt": "2020-01-27T10:04:48Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,391 @@\n+/**\n+ * Copyright (c) 2016, All partners of the iTesla project (http://www.itesla-project.eu/consortium)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;\n+\n+    MergedLine(final MergingViewIndex index, final DanglingLine dl1, final DanglingLine dl2) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+        this.dl1 = Objects.requireNonNull(dl1, \"dangling line 1 is null\");\n+        this.dl2 = Objects.requireNonNull(dl2, \"dangling line 2 is null\");\n+        this.id = dl1.getId().compareTo(dl2.getId()) < 0 ? dl1.getId() + \" + \" + dl2.getId() : dl2.getId() + \" + \" + dl1.getId();", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MDkzNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371150935", "bodyText": "Add a message: \"Unexpected side value: \" + side", "author": "mathbagu", "createdAt": "2020-01-27T10:05:26Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,391 @@\n+/**\n+ * Copyright (c) 2016, All partners of the iTesla project (http://www.itesla-project.eu/consortium)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;\n+\n+    MergedLine(final MergingViewIndex index, final DanglingLine dl1, final DanglingLine dl2) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+        this.dl1 = Objects.requireNonNull(dl1, \"dangling line 1 is null\");\n+        this.dl2 = Objects.requireNonNull(dl2, \"dangling line 2 is null\");\n+        this.id = dl1.getId().compareTo(dl2.getId()) < 0 ? dl1.getId() + \" + \" + dl2.getId() : dl2.getId() + \" + \" + dl1.getId();\n+    }\n+\n+    @Override\n+    public ConnectableType getType() {\n+        return ConnectableType.LINE;\n+    }\n+\n+    @Override\n+    public boolean isTieLine() {\n+        return false;\n+    }\n+\n+    @Override\n+    public MergingView getNetwork() {\n+        return index.getView();\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getTerminal1();\n+            case TWO:\n+                return getTerminal2();\n+            default:\n+                throw new AssertionError();", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MTQxOA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371151418", "bodyText": "Same remark here", "author": "mathbagu", "createdAt": "2020-01-27T10:06:23Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,391 @@\n+/**\n+ * Copyright (c) 2016, All partners of the iTesla project (http://www.itesla-project.eu/consortium)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;\n+\n+    MergedLine(final MergingViewIndex index, final DanglingLine dl1, final DanglingLine dl2) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+        this.dl1 = Objects.requireNonNull(dl1, \"dangling line 1 is null\");\n+        this.dl2 = Objects.requireNonNull(dl2, \"dangling line 2 is null\");\n+        this.id = dl1.getId().compareTo(dl2.getId()) < 0 ? dl1.getId() + \" + \" + dl2.getId() : dl2.getId() + \" + \" + dl1.getId();\n+    }\n+\n+    @Override\n+    public ConnectableType getType() {\n+        return ConnectableType.LINE;\n+    }\n+\n+    @Override\n+    public boolean isTieLine() {\n+        return false;\n+    }\n+\n+    @Override\n+    public MergingView getNetwork() {\n+        return index.getView();\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getTerminal1();\n+            case TWO:\n+                return getTerminal2();\n+            default:\n+                throw new AssertionError();\n+        }\n+    }\n+\n+    @Override\n+    public Terminal getTerminal1() {\n+        return index.getTerminal(dl1.getTerminal());\n+    }\n+\n+    @Override\n+    public Terminal getTerminal2() {\n+        return index.getTerminal(dl2.getTerminal());\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getCurrentLimits1();\n+            case TWO:\n+                return getCurrentLimits2();\n+            default:\n+                throw new AssertionError();", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MTk5NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371151994", "bodyText": "Rename to terminal1 and terminal2", "author": "mathbagu", "createdAt": "2020-01-27T10:07:39Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,391 @@\n+/**\n+ * Copyright (c) 2016, All partners of the iTesla project (http://www.itesla-project.eu/consortium)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;\n+\n+    MergedLine(final MergingViewIndex index, final DanglingLine dl1, final DanglingLine dl2) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+        this.dl1 = Objects.requireNonNull(dl1, \"dangling line 1 is null\");\n+        this.dl2 = Objects.requireNonNull(dl2, \"dangling line 2 is null\");\n+        this.id = dl1.getId().compareTo(dl2.getId()) < 0 ? dl1.getId() + \" + \" + dl2.getId() : dl2.getId() + \" + \" + dl1.getId();\n+    }\n+\n+    @Override\n+    public ConnectableType getType() {\n+        return ConnectableType.LINE;\n+    }\n+\n+    @Override\n+    public boolean isTieLine() {\n+        return false;\n+    }\n+\n+    @Override\n+    public MergingView getNetwork() {\n+        return index.getView();\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getTerminal1();\n+            case TWO:\n+                return getTerminal2();\n+            default:\n+                throw new AssertionError();\n+        }\n+    }\n+\n+    @Override\n+    public Terminal getTerminal1() {\n+        return index.getTerminal(dl1.getTerminal());\n+    }\n+\n+    @Override\n+    public Terminal getTerminal2() {\n+        return index.getTerminal(dl2.getTerminal());\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getCurrentLimits1();\n+            case TWO:\n+                return getCurrentLimits2();\n+            default:\n+                throw new AssertionError();\n+        }\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits1() {\n+        return dl1.getCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimitsAdder newCurrentLimits1() {\n+        return dl1.newCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits2() {\n+        return dl2.getCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimitsAdder newCurrentLimits2() {\n+        return dl2.newCurrentLimits();\n+    }\n+\n+    @Override\n+    public String getId() {\n+        return id;\n+    }\n+\n+    @Override\n+    public double getR() {\n+        return dl1.getR() + dl2.getR();\n+    }\n+\n+    @Override\n+    public Line setR(final double r) {\n+        dl1.setR(r / 2.0d);\n+        dl2.setR(r / 2.0d);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getX() {\n+        return dl1.getX() + dl2.getX();\n+    }\n+\n+    @Override\n+    public Line setX(final double x) {\n+        dl1.setX(x / 2.0d);\n+        dl2.setX(x / 2.0d);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getG1() {\n+        return dl1.getG();\n+    }\n+\n+    @Override\n+    public Line setG1(final double g1) {\n+        dl1.setG(g1);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getG2() {\n+        return dl2.getG();\n+    }\n+\n+    @Override\n+    public Line setG2(final double g2) {\n+        dl2.setG(g2);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getB1() {\n+        return dl1.getB();\n+    }\n+\n+    @Override\n+    public Line setB1(final double b1) {\n+        dl1.setB(b1);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getB2() {\n+        return dl2.getB();\n+    }\n+\n+    @Override\n+    public Line setB2(final double b2) {\n+        dl2.setB(b2);\n+        return this;\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final String voltageLevelId) {\n+        Objects.requireNonNull(voltageLevelId);\n+\n+        Terminal termDl1 = dl1.getTerminal();\n+        Terminal termDl2 = dl2.getTerminal();", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MjI5MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371152290", "bodyText": "Add a message", "author": "mathbagu", "createdAt": "2020-01-27T10:08:21Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,391 @@\n+/**\n+ * Copyright (c) 2016, All partners of the iTesla project (http://www.itesla-project.eu/consortium)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;\n+\n+    MergedLine(final MergingViewIndex index, final DanglingLine dl1, final DanglingLine dl2) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+        this.dl1 = Objects.requireNonNull(dl1, \"dangling line 1 is null\");\n+        this.dl2 = Objects.requireNonNull(dl2, \"dangling line 2 is null\");\n+        this.id = dl1.getId().compareTo(dl2.getId()) < 0 ? dl1.getId() + \" + \" + dl2.getId() : dl2.getId() + \" + \" + dl1.getId();\n+    }\n+\n+    @Override\n+    public ConnectableType getType() {\n+        return ConnectableType.LINE;\n+    }\n+\n+    @Override\n+    public boolean isTieLine() {\n+        return false;\n+    }\n+\n+    @Override\n+    public MergingView getNetwork() {\n+        return index.getView();\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getTerminal1();\n+            case TWO:\n+                return getTerminal2();\n+            default:\n+                throw new AssertionError();\n+        }\n+    }\n+\n+    @Override\n+    public Terminal getTerminal1() {\n+        return index.getTerminal(dl1.getTerminal());\n+    }\n+\n+    @Override\n+    public Terminal getTerminal2() {\n+        return index.getTerminal(dl2.getTerminal());\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getCurrentLimits1();\n+            case TWO:\n+                return getCurrentLimits2();\n+            default:\n+                throw new AssertionError();\n+        }\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits1() {\n+        return dl1.getCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimitsAdder newCurrentLimits1() {\n+        return dl1.newCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits2() {\n+        return dl2.getCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimitsAdder newCurrentLimits2() {\n+        return dl2.newCurrentLimits();\n+    }\n+\n+    @Override\n+    public String getId() {\n+        return id;\n+    }\n+\n+    @Override\n+    public double getR() {\n+        return dl1.getR() + dl2.getR();\n+    }\n+\n+    @Override\n+    public Line setR(final double r) {\n+        dl1.setR(r / 2.0d);\n+        dl2.setR(r / 2.0d);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getX() {\n+        return dl1.getX() + dl2.getX();\n+    }\n+\n+    @Override\n+    public Line setX(final double x) {\n+        dl1.setX(x / 2.0d);\n+        dl2.setX(x / 2.0d);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getG1() {\n+        return dl1.getG();\n+    }\n+\n+    @Override\n+    public Line setG1(final double g1) {\n+        dl1.setG(g1);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getG2() {\n+        return dl2.getG();\n+    }\n+\n+    @Override\n+    public Line setG2(final double g2) {\n+        dl2.setG(g2);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getB1() {\n+        return dl1.getB();\n+    }\n+\n+    @Override\n+    public Line setB1(final double b1) {\n+        dl1.setB(b1);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getB2() {\n+        return dl2.getB();\n+    }\n+\n+    @Override\n+    public Line setB2(final double b2) {\n+        dl2.setB(b2);\n+        return this;\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final String voltageLevelId) {\n+        Objects.requireNonNull(voltageLevelId);\n+\n+        Terminal termDl1 = dl1.getTerminal();\n+        Terminal termDl2 = dl2.getTerminal();\n+        if (voltageLevelId.equals(termDl1.getVoltageLevel().getId())) {\n+            return termDl1;\n+        } else if (voltageLevelId.equals(termDl2.getVoltageLevel().getId())) {\n+            return termDl2;\n+        } else {\n+            throw new PowsyblException(\"No terminal connected to voltage level \" + voltageLevelId);\n+        }\n+    }\n+\n+    @Override\n+    public Side getSide(final Terminal terminal) {\n+        Objects.requireNonNull(terminal);\n+\n+        Terminal term = terminal;\n+        if (term instanceof AbstractAdapter) {\n+            term = ((AbstractAdapter<Terminal>) term).getDelegate();\n+        }\n+        if (term == dl1.getTerminal()) {\n+            return Side.ONE;\n+        } else if (term == dl2.getTerminal()) {\n+            return Side.TWO;\n+        } else {\n+            throw new PowsyblException(\"The terminal is not connected to this branch\");\n+        }\n+    }\n+\n+    @Override\n+    public boolean isOverloaded() {\n+        return isOverloaded(1.0f);\n+    }\n+\n+    @Override\n+    public boolean isOverloaded(final float limitReduction) {\n+        return checkPermanentLimit1(limitReduction) || checkPermanentLimit2(limitReduction);\n+    }\n+\n+    @Override\n+    public int getOverloadDuration() {\n+        Branch.Overload o1 = checkTemporaryLimits1();\n+        Branch.Overload o2 = checkTemporaryLimits2();\n+        int duration1 = o1 != null ? o1.getTemporaryLimit().getAcceptableDuration() : Integer.MAX_VALUE;\n+        int duration2 = o2 != null ? o2.getTemporaryLimit().getAcceptableDuration() : Integer.MAX_VALUE;\n+        return Math.min(duration1, duration2);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit(final Side side, final float limitReduction) {\n+        Objects.requireNonNull(side);\n+        switch (side) {\n+            case ONE:\n+                return checkPermanentLimit1(limitReduction);\n+\n+            case TWO:\n+                return checkPermanentLimit2(limitReduction);\n+\n+            default:\n+                throw new AssertionError();\n+        }\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit(final Side side) {\n+        return checkPermanentLimit(side, 1f);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit1(final float limitReduction) {\n+        return LimitViolationUtils.checkPermanentLimit(this, Side.ONE, limitReduction, getTerminal1().getI());\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit1() {\n+        return checkPermanentLimit1(1f);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit2(final float limitReduction) {\n+        return LimitViolationUtils.checkPermanentLimit(this, Side.TWO, limitReduction, getTerminal2().getI());\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit2() {\n+        return checkPermanentLimit2(1f);\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits(final Side side, final float limitReduction) {\n+        Objects.requireNonNull(side);\n+        switch (side) {\n+            case ONE:\n+                return checkTemporaryLimits1(limitReduction);\n+\n+            case TWO:\n+                return checkTemporaryLimits2(limitReduction);\n+\n+            default:\n+                throw new AssertionError();", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MzE2MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371153160", "bodyText": "Refactor this code, by introducing a function that takes an ID and a Consumer?", "author": "mathbagu", "createdAt": "2020-01-27T10:10:14Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingView.java", "diffHunk": "@@ -735,12 +749,16 @@ public int getLineCount() {\n \n     @Override\n     public Line getLine(final String id) {\n-        return index.getNetworkStream()\n-                .map(n -> n.getLine(id))\n-                .filter(Objects::nonNull)\n-                .map(index::getLine)\n-                .findFirst()\n-                .orElse(null);\n+        Line line = index.getMergedLine(id);\n+        if (Objects.isNull(line)) {\n+            line = index.getNetworkStream()\n+                        .map(n -> n.getLine(id))\n+                        .filter(Objects::nonNull)\n+                        .map(index::getLine)\n+                        .findFirst()\n+                        .orElse(null);\n+        }\n+        return line;", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MzM3MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371153371", "bodyText": "Should be private?", "author": "mathbagu", "createdAt": "2020-01-27T10:10:44Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingViewIndex.java", "diffHunk": "@@ -68,6 +71,29 @@ void checkAndAdd(final Network other) {\n         ValidationUtil.checkUniqueIds(other, this);\n         // Local storage for mergeable network\n         networks.add(other);\n+        // Manage DanglingLines\n+        other.getDanglingLineStream().forEach(this::checkNewDanglingLine);\n+    }\n+\n+    void checkNewDanglingLine(final DanglingLine dll2) {", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzMzc3Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371933773", "bodyText": "Is used by : MergingNetworkListener & DanglingLineAdderAdapter", "author": "tadam50", "createdAt": "2020-01-28T17:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MzM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MzQ0Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371153443", "bodyText": "Should be private?", "author": "mathbagu", "createdAt": "2020-01-27T10:10:52Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingViewIndex.java", "diffHunk": "@@ -68,6 +71,29 @@ void checkAndAdd(final Network other) {\n         ValidationUtil.checkUniqueIds(other, this);\n         // Local storage for mergeable network\n         networks.add(other);\n+        // Manage DanglingLines\n+        other.getDanglingLineStream().forEach(this::checkNewDanglingLine);\n+    }\n+\n+    void checkNewDanglingLine(final DanglingLine dll2) {\n+        Objects.requireNonNull(dll2, \"DanglingLine is null\");\n+        // Manage DanglingLines\n+        final String code = dll2.getUcteXnodeCode();\n+        // Find other DanglingLine if exist\n+        final Set<DanglingLine> danglingLines = getNetworkStream().flatMap(Network::getDanglingLineStream).filter(d -> d.getUcteXnodeCode().equals(code)).collect(Collectors.toSet());\n+        for (DanglingLine dll1 : danglingLines) {\n+            if (dll1 != dll2) {\n+                // Create MergedLine from 2 dangling lines\n+                mergedLineCached.computeIfAbsent(code, key -> new MergedLine(this, dll1, dll2));\n+            }\n+        }\n+    }\n+\n+    Line getMergedLine(final String id) {", "originalCommit": "f5f71a522dd8aa9b85b27d52ecd605d0c5575c39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzNDQzMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r371934433", "bodyText": "Is used by :  MergingView", "author": "tadam50", "createdAt": "2020-01-28T17:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE1MzQ0Mw=="}], "type": "inlineReview"}, {"oid": "4d0eb8ebba81cf538e032ea06934eb06235f9245", "url": "https://github.com/powsybl/powsybl-core/commit/4d0eb8ebba81cf538e032ea06934eb06235f9245", "message": "Taking into account MR reviews\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2020-01-28T17:04:18Z", "type": "commit"}, {"oid": "9b501e91755caa8e147690f35cd9697dce936d4f", "url": "https://github.com/powsybl/powsybl-core/commit/9b501e91755caa8e147690f35cd9697dce936d4f", "message": "Missing message on assertion\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2020-01-29T09:19:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEzMjYwNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r374132604", "bodyText": "I'm not sure this is a good idea. Is it to avoid a test for null and/or a NullPointerException?", "author": "mathbagu", "createdAt": "2020-02-03T14:29:39Z", "path": "iidm/iidm-api/src/main/java/com/powsybl/iidm/network/BranchAdder.java", "diffHunk": "@@ -14,15 +14,15 @@\n \n     T setVoltageLevel1(String voltageLevelId1);\n \n-    T setNode1(int node1);\n+    T setNode1(Integer node1);", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzOTU2OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375139569", "bodyText": "See above: maybe we can just have a test for Null only for these two setters", "author": "mathbagu", "createdAt": "2020-02-05T09:21:47Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/LineAdderAdapter.java", "diffHunk": "@@ -0,0 +1,221 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.iidm.network.*;\n+\n+import java.util.Objects;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class LineAdderAdapter implements LineAdder {\n+\n+    private final MergingViewIndex index;\n+\n+    private String id;\n+\n+    private String name;\n+\n+    private boolean ensureIdUnicity;\n+\n+    private Integer node1;\n+\n+    private String bus1;\n+\n+    private String connectableBus1;\n+\n+    private String voltageLevelId1;\n+\n+    private Integer node2;\n+\n+    private String bus2;\n+\n+    private String connectableBus2;\n+\n+    private String voltageLevelId2;\n+\n+    private double r = Double.NaN;\n+\n+    private double x = Double.NaN;\n+\n+    private double g1 = Double.NaN;\n+\n+    private double b1 = Double.NaN;\n+\n+    private double g2 = Double.NaN;\n+\n+    private double b2 = Double.NaN;\n+\n+    LineAdderAdapter(final MergingViewIndex index) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+    }\n+\n+    @Override\n+    public Line add() {\n+        Line newLine = null;\n+        final Network n1 = checkAndGetNetwork1();\n+        final Network n2 = checkAndGetNetwork2();\n+        if (n1 == n2) {\n+            newLine = index.getLine(addLine(n1));\n+        } else {\n+            // Creation of 2 dangling lines\n+            throw MergingView.NOT_IMPLEMENTED_EXCEPTION;\n+        }\n+        return newLine;\n+    }\n+\n+    private Line addLine(final Network network) {\n+        LineAdder adder = network.newLine()\n+                    .setId(id)\n+                    .setEnsureIdUnicity(ensureIdUnicity)\n+                    .setName(name)\n+                    .setR(r)\n+                    .setX(x)\n+                    .setG1(g1)\n+                    .setB1(b1)\n+                    .setG2(g2)\n+                    .setB2(b2)\n+                    .setVoltageLevel1(voltageLevelId1)\n+                    .setVoltageLevel2(voltageLevelId2)\n+                    .setBus1(bus1)\n+                    .setConnectableBus1(connectableBus1)\n+                    .setBus2(bus2)\n+                    .setConnectableBus2(connectableBus2)\n+                    .setNode1(node1)\n+                    .setNode2(node2);", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MDQ3Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375140472", "bodyText": "You have to ensure the unicity of this ID (or throw depending on the policy)", "author": "mathbagu", "createdAt": "2020-02-05T09:23:36Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,401 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;\n+\n+    MergedLine(final MergingViewIndex index, final DanglingLine dl1, final DanglingLine dl2) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+        this.dl1 = Objects.requireNonNull(dl1, \"dangling line 1 is null\");\n+        this.dl2 = Objects.requireNonNull(dl2, \"dangling line 2 is null\");\n+        this.id = buildId(dl1, dl2);", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMwNjgyMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375306820", "bodyText": "How can i get the current policy here ?\nNo ensureIdUnicity field is given here ...", "author": "tadam50", "createdAt": "2020-02-05T14:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MDQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MDUyNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375140525", "bodyText": "Make it final.", "author": "mathbagu", "createdAt": "2020-02-05T09:23:44Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,401 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MTEzMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375141133", "bodyText": "Is that true?", "author": "mathbagu", "createdAt": "2020-02-05T09:25:01Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,401 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;\n+\n+    MergedLine(final MergingViewIndex index, final DanglingLine dl1, final DanglingLine dl2) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+        this.dl1 = Objects.requireNonNull(dl1, \"dangling line 1 is null\");\n+        this.dl2 = Objects.requireNonNull(dl2, \"dangling line 2 is null\");\n+        this.id = buildId(dl1, dl2);\n+    }\n+\n+    private static String buildId(final DanglingLine dl1, final DanglingLine dl2) {\n+        String id;\n+        if (dl1.getId().compareTo(dl2.getId()) < 0) {\n+            id = dl1.getId() + \" + \" + dl2.getId();\n+        } else {\n+            id = dl2.getId() + \" + \" + dl1.getId();\n+        }\n+        return id;\n+    }\n+\n+    @Override\n+    public ConnectableType getType() {\n+        return ConnectableType.LINE;\n+    }\n+\n+    @Override\n+    public boolean isTieLine() {\n+        return false;\n+    }\n+\n+    @Override\n+    public MergingView getNetwork() {\n+        return index.getView();\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getTerminal1();\n+            case TWO:\n+                return getTerminal2();\n+            default:\n+                throw new AssertionError(\"Unexpected side value: \" + side);\n+        }\n+    }\n+\n+    @Override\n+    public Terminal getTerminal1() {\n+        return index.getTerminal(dl1.getTerminal());\n+    }\n+\n+    @Override\n+    public Terminal getTerminal2() {\n+        return index.getTerminal(dl2.getTerminal());\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getCurrentLimits1();\n+            case TWO:\n+                return getCurrentLimits2();\n+            default:\n+                throw new AssertionError(\"Unexpected side value: \" + side);\n+        }\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits1() {\n+        return dl1.getCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimitsAdder newCurrentLimits1() {\n+        return dl1.newCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits2() {\n+        return dl2.getCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimitsAdder newCurrentLimits2() {\n+        return dl2.newCurrentLimits();\n+    }\n+\n+    @Override\n+    public String getId() {\n+        return id;\n+    }\n+\n+    @Override\n+    public double getR() {\n+        return dl1.getR() + dl2.getR();\n+    }\n+\n+    @Override\n+    public Line setR(final double r) {\n+        dl1.setR(r / 2.0d);\n+        dl2.setR(r / 2.0d);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getX() {\n+        return dl1.getX() + dl2.getX();\n+    }\n+\n+    @Override\n+    public Line setX(final double x) {\n+        dl1.setX(x / 2.0d);\n+        dl2.setX(x / 2.0d);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getG1() {\n+        return dl1.getG();\n+    }\n+\n+    @Override\n+    public Line setG1(final double g1) {\n+        dl1.setG(g1);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getG2() {\n+        return dl2.getG();\n+    }\n+\n+    @Override\n+    public Line setG2(final double g2) {\n+        dl2.setG(g2);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getB1() {\n+        return dl1.getB();\n+    }\n+\n+    @Override\n+    public Line setB1(final double b1) {\n+        dl1.setB(b1);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getB2() {\n+        return dl2.getB();\n+    }\n+\n+    @Override\n+    public Line setB2(final double b2) {\n+        dl2.setB(b2);\n+        return this;\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final String voltageLevelId) {\n+        Objects.requireNonNull(voltageLevelId);\n+\n+        Terminal terminal1 = dl1.getTerminal();\n+        Terminal terminal2 = dl2.getTerminal();\n+        if (voltageLevelId.equals(terminal1.getVoltageLevel().getId())) {\n+            return terminal1;\n+        } else if (voltageLevelId.equals(terminal2.getVoltageLevel().getId())) {\n+            return terminal2;\n+        } else {\n+            throw new PowsyblException(\"No terminal connected to voltage level \" + voltageLevelId);\n+        }\n+    }\n+\n+    @Override\n+    public Side getSide(final Terminal terminal) {\n+        Objects.requireNonNull(terminal);\n+\n+        Terminal term = terminal;\n+        if (term instanceof AbstractAdapter) {\n+            term = ((AbstractAdapter<Terminal>) term).getDelegate();\n+        }\n+        if (term == dl1.getTerminal()) {\n+            return Side.ONE;\n+        } else if (term == dl2.getTerminal()) {\n+            return Side.TWO;\n+        } else {\n+            throw new PowsyblException(\"The terminal is not connected to this branch\");\n+        }\n+    }\n+\n+    @Override\n+    public boolean isOverloaded() {\n+        return isOverloaded(1.0f);\n+    }\n+\n+    @Override\n+    public boolean isOverloaded(final float limitReduction) {\n+        return checkPermanentLimit1(limitReduction) || checkPermanentLimit2(limitReduction);\n+    }\n+\n+    @Override\n+    public int getOverloadDuration() {\n+        Branch.Overload o1 = checkTemporaryLimits1();\n+        Branch.Overload o2 = checkTemporaryLimits2();\n+        int duration1 = o1 != null ? o1.getTemporaryLimit().getAcceptableDuration() : Integer.MAX_VALUE;\n+        int duration2 = o2 != null ? o2.getTemporaryLimit().getAcceptableDuration() : Integer.MAX_VALUE;\n+        return Math.min(duration1, duration2);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit(final Side side, final float limitReduction) {\n+        Objects.requireNonNull(side);\n+        switch (side) {\n+            case ONE:\n+                return checkPermanentLimit1(limitReduction);\n+\n+            case TWO:\n+                return checkPermanentLimit2(limitReduction);\n+\n+            default:\n+                throw new AssertionError(\"Unexpected side value: \" + side);\n+        }\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit(final Side side) {\n+        return checkPermanentLimit(side, 1f);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit1(final float limitReduction) {\n+        return LimitViolationUtils.checkPermanentLimit(this, Side.ONE, limitReduction, getTerminal1().getI());\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit1() {\n+        return checkPermanentLimit1(1f);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit2(final float limitReduction) {\n+        return LimitViolationUtils.checkPermanentLimit(this, Side.TWO, limitReduction, getTerminal2().getI());\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit2() {\n+        return checkPermanentLimit2(1f);\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits(final Side side, final float limitReduction) {\n+        Objects.requireNonNull(side);\n+        switch (side) {\n+            case ONE:\n+                return checkTemporaryLimits1(limitReduction);\n+\n+            case TWO:\n+                return checkTemporaryLimits2(limitReduction);\n+\n+            default:\n+                throw new AssertionError(\"Unexpected side value: \" + side);\n+        }\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits(final Side side) {\n+        return checkTemporaryLimits(side, 1f);\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits1(final float limitReduction) {\n+        return LimitViolationUtils.checkTemporaryLimits(this, Side.ONE, limitReduction, getTerminal1().getI());\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits1() {\n+        return checkTemporaryLimits1(1f);\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits2(final float limitReduction) {\n+        return LimitViolationUtils.checkTemporaryLimits(this, Side.TWO, limitReduction, getTerminal2().getI());\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits2() {\n+        return checkTemporaryLimits2(1f);\n+    }\n+\n+    @Override\n+    public List<? extends Terminal> getTerminals() {\n+        return Stream.concat(dl1.getTerminals().stream(),\n+                             dl2.getTerminals().stream())\n+                     .map(index::getTerminal)\n+                     .collect(Collectors.toList());\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return this.id;", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MTgyNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375141824", "bodyText": "Maybe you have to look in the UCTEImporter code. @murgeyseb make a change recently to manage this differently. For instance, what happens if both dangling lines have the property defined, but not equal.", "author": "mathbagu", "createdAt": "2020-02-05T09:26:28Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergedLine.java", "diffHunk": "@@ -0,0 +1,401 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.mergingview;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.network.util.LimitViolationUtils;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+class MergedLine implements Line {\n+\n+    private final MergingViewIndex index;\n+\n+    private final DanglingLine dl1;\n+\n+    private final DanglingLine dl2;\n+\n+    private String id;\n+\n+    MergedLine(final MergingViewIndex index, final DanglingLine dl1, final DanglingLine dl2) {\n+        this.index = Objects.requireNonNull(index, \"merging view index is null\");\n+        this.dl1 = Objects.requireNonNull(dl1, \"dangling line 1 is null\");\n+        this.dl2 = Objects.requireNonNull(dl2, \"dangling line 2 is null\");\n+        this.id = buildId(dl1, dl2);\n+    }\n+\n+    private static String buildId(final DanglingLine dl1, final DanglingLine dl2) {\n+        String id;\n+        if (dl1.getId().compareTo(dl2.getId()) < 0) {\n+            id = dl1.getId() + \" + \" + dl2.getId();\n+        } else {\n+            id = dl2.getId() + \" + \" + dl1.getId();\n+        }\n+        return id;\n+    }\n+\n+    @Override\n+    public ConnectableType getType() {\n+        return ConnectableType.LINE;\n+    }\n+\n+    @Override\n+    public boolean isTieLine() {\n+        return false;\n+    }\n+\n+    @Override\n+    public MergingView getNetwork() {\n+        return index.getView();\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getTerminal1();\n+            case TWO:\n+                return getTerminal2();\n+            default:\n+                throw new AssertionError(\"Unexpected side value: \" + side);\n+        }\n+    }\n+\n+    @Override\n+    public Terminal getTerminal1() {\n+        return index.getTerminal(dl1.getTerminal());\n+    }\n+\n+    @Override\n+    public Terminal getTerminal2() {\n+        return index.getTerminal(dl2.getTerminal());\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits(final Side side) {\n+        switch (side) {\n+            case ONE:\n+                return getCurrentLimits1();\n+            case TWO:\n+                return getCurrentLimits2();\n+            default:\n+                throw new AssertionError(\"Unexpected side value: \" + side);\n+        }\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits1() {\n+        return dl1.getCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimitsAdder newCurrentLimits1() {\n+        return dl1.newCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimits getCurrentLimits2() {\n+        return dl2.getCurrentLimits();\n+    }\n+\n+    @Override\n+    public CurrentLimitsAdder newCurrentLimits2() {\n+        return dl2.newCurrentLimits();\n+    }\n+\n+    @Override\n+    public String getId() {\n+        return id;\n+    }\n+\n+    @Override\n+    public double getR() {\n+        return dl1.getR() + dl2.getR();\n+    }\n+\n+    @Override\n+    public Line setR(final double r) {\n+        dl1.setR(r / 2.0d);\n+        dl2.setR(r / 2.0d);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getX() {\n+        return dl1.getX() + dl2.getX();\n+    }\n+\n+    @Override\n+    public Line setX(final double x) {\n+        dl1.setX(x / 2.0d);\n+        dl2.setX(x / 2.0d);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getG1() {\n+        return dl1.getG();\n+    }\n+\n+    @Override\n+    public Line setG1(final double g1) {\n+        dl1.setG(g1);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getG2() {\n+        return dl2.getG();\n+    }\n+\n+    @Override\n+    public Line setG2(final double g2) {\n+        dl2.setG(g2);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getB1() {\n+        return dl1.getB();\n+    }\n+\n+    @Override\n+    public Line setB1(final double b1) {\n+        dl1.setB(b1);\n+        return this;\n+    }\n+\n+    @Override\n+    public double getB2() {\n+        return dl2.getB();\n+    }\n+\n+    @Override\n+    public Line setB2(final double b2) {\n+        dl2.setB(b2);\n+        return this;\n+    }\n+\n+    @Override\n+    public Terminal getTerminal(final String voltageLevelId) {\n+        Objects.requireNonNull(voltageLevelId);\n+\n+        Terminal terminal1 = dl1.getTerminal();\n+        Terminal terminal2 = dl2.getTerminal();\n+        if (voltageLevelId.equals(terminal1.getVoltageLevel().getId())) {\n+            return terminal1;\n+        } else if (voltageLevelId.equals(terminal2.getVoltageLevel().getId())) {\n+            return terminal2;\n+        } else {\n+            throw new PowsyblException(\"No terminal connected to voltage level \" + voltageLevelId);\n+        }\n+    }\n+\n+    @Override\n+    public Side getSide(final Terminal terminal) {\n+        Objects.requireNonNull(terminal);\n+\n+        Terminal term = terminal;\n+        if (term instanceof AbstractAdapter) {\n+            term = ((AbstractAdapter<Terminal>) term).getDelegate();\n+        }\n+        if (term == dl1.getTerminal()) {\n+            return Side.ONE;\n+        } else if (term == dl2.getTerminal()) {\n+            return Side.TWO;\n+        } else {\n+            throw new PowsyblException(\"The terminal is not connected to this branch\");\n+        }\n+    }\n+\n+    @Override\n+    public boolean isOverloaded() {\n+        return isOverloaded(1.0f);\n+    }\n+\n+    @Override\n+    public boolean isOverloaded(final float limitReduction) {\n+        return checkPermanentLimit1(limitReduction) || checkPermanentLimit2(limitReduction);\n+    }\n+\n+    @Override\n+    public int getOverloadDuration() {\n+        Branch.Overload o1 = checkTemporaryLimits1();\n+        Branch.Overload o2 = checkTemporaryLimits2();\n+        int duration1 = o1 != null ? o1.getTemporaryLimit().getAcceptableDuration() : Integer.MAX_VALUE;\n+        int duration2 = o2 != null ? o2.getTemporaryLimit().getAcceptableDuration() : Integer.MAX_VALUE;\n+        return Math.min(duration1, duration2);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit(final Side side, final float limitReduction) {\n+        Objects.requireNonNull(side);\n+        switch (side) {\n+            case ONE:\n+                return checkPermanentLimit1(limitReduction);\n+\n+            case TWO:\n+                return checkPermanentLimit2(limitReduction);\n+\n+            default:\n+                throw new AssertionError(\"Unexpected side value: \" + side);\n+        }\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit(final Side side) {\n+        return checkPermanentLimit(side, 1f);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit1(final float limitReduction) {\n+        return LimitViolationUtils.checkPermanentLimit(this, Side.ONE, limitReduction, getTerminal1().getI());\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit1() {\n+        return checkPermanentLimit1(1f);\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit2(final float limitReduction) {\n+        return LimitViolationUtils.checkPermanentLimit(this, Side.TWO, limitReduction, getTerminal2().getI());\n+    }\n+\n+    @Override\n+    public boolean checkPermanentLimit2() {\n+        return checkPermanentLimit2(1f);\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits(final Side side, final float limitReduction) {\n+        Objects.requireNonNull(side);\n+        switch (side) {\n+            case ONE:\n+                return checkTemporaryLimits1(limitReduction);\n+\n+            case TWO:\n+                return checkTemporaryLimits2(limitReduction);\n+\n+            default:\n+                throw new AssertionError(\"Unexpected side value: \" + side);\n+        }\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits(final Side side) {\n+        return checkTemporaryLimits(side, 1f);\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits1(final float limitReduction) {\n+        return LimitViolationUtils.checkTemporaryLimits(this, Side.ONE, limitReduction, getTerminal1().getI());\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits1() {\n+        return checkTemporaryLimits1(1f);\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits2(final float limitReduction) {\n+        return LimitViolationUtils.checkTemporaryLimits(this, Side.TWO, limitReduction, getTerminal2().getI());\n+    }\n+\n+    @Override\n+    public Overload checkTemporaryLimits2() {\n+        return checkTemporaryLimits2(1f);\n+    }\n+\n+    @Override\n+    public List<? extends Terminal> getTerminals() {\n+        return Stream.concat(dl1.getTerminals().stream(),\n+                             dl2.getTerminals().stream())\n+                     .map(index::getTerminal)\n+                     .collect(Collectors.toList());\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return this.id;\n+    }\n+\n+    @Override\n+    public boolean hasProperty() {\n+        return dl1.hasProperty() || dl2.hasProperty();\n+    }\n+\n+    @Override\n+    public boolean hasProperty(final String key) {\n+        return dl1.hasProperty(key) || dl2.hasProperty(key);", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MjQ0Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375142446", "bodyText": "search == null is more common?", "author": "mathbagu", "createdAt": "2020-02-05T09:27:31Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingView.java", "diffHunk": "@@ -289,12 +277,11 @@ public int getCountryCount() {\n \n     @Override\n     public Identifiable<?> getIdentifiable(final String id) {\n-        return index.getNetworkStream()\n-                .map(n -> n.getIdentifiable(id))\n-                .filter(Objects::nonNull)\n-                .map(index::getIdentifiable)\n-                .findFirst()\n-                .orElse(null);\n+        Identifiable<?> search = index.getMergedLine(id);\n+        if (Objects.isNull(search)) {", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MzA2MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375143060", "bodyText": "I think you can use an Optional there. Something like this:\nreturn Optional.ofNullable(index.getMergedLine()).orElse(index.get(...));\n\nTell me if it's cleaner (more readable) or keep like this and ignore the next comments otherwise", "author": "mathbagu", "createdAt": "2020-02-05T09:28:42Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingView.java", "diffHunk": "@@ -289,12 +277,11 @@ public int getCountryCount() {\n \n     @Override\n     public Identifiable<?> getIdentifiable(final String id) {\n-        return index.getNetworkStream()\n-                .map(n -> n.getIdentifiable(id))\n-                .filter(Objects::nonNull)\n-                .map(index::getIdentifiable)\n-                .findFirst()\n-                .orElse(null);\n+        Identifiable<?> search = index.getMergedLine(id);\n+        if (Objects.isNull(search)) {\n+            search = index.get(n -> n.getIdentifiable(id), index::getIdentifiable);\n+        }\n+        return search;", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MzIzNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375143235", "bodyText": "Same remark here", "author": "mathbagu", "createdAt": "2020-02-05T09:28:59Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingView.java", "diffHunk": "@@ -657,23 +584,17 @@ public int getHvdcConverterStationCount() {\n \n     @Override\n     public HvdcConverterStation<?> getHvdcConverterStation(final String id) {\n-        return index.getNetworkStream()\n-                .map(n -> n.getHvdcConverterStation(id))\n-                .filter(Objects::nonNull)\n-                .map(index::getHvdcConverterStation)\n-                .findFirst()\n-                .orElse(null);\n+        return index.get(n -> n.getHvdcConverterStation(id), index::getHvdcConverterStation);\n     }\n \n     // Branches\n     @Override\n     public Branch getBranch(final String id) {\n-        return index.getNetworkStream()\n-                .map(n -> n.getBranch(id))\n-                .filter(Objects::nonNull)\n-                .map(index::getBranch)\n-                .findFirst()\n-                .orElse(null);\n+        Branch search = index.getMergedLine(id);\n+        if (Objects.isNull(search)) {\n+            search = index.get(n -> n.getBranch(id), index::getBranch);\n+        }\n+        return search;", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MzMxNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375143315", "bodyText": "Same remark here", "author": "mathbagu", "createdAt": "2020-02-05T09:29:09Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingView.java", "diffHunk": "@@ -735,12 +656,11 @@ public int getLineCount() {\n \n     @Override\n     public Line getLine(final String id) {\n-        return index.getNetworkStream()\n-                .map(n -> n.getLine(id))\n-                .filter(Objects::nonNull)\n-                .map(index::getLine)\n-                .findFirst()\n-                .orElse(null);\n+        Line search = index.getMergedLine(id);\n+        if (Objects.isNull(search)) {\n+            search = index.get(n -> n.getLine(id), index::getLine);\n+        }\n+        return search;", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MzkzNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375143935", "bodyText": "I'm not sure to understand the name of this method: is it a way to check if the danglingLine is merged or not?", "author": "mathbagu", "createdAt": "2020-02-05T09:30:29Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingView.java", "diffHunk": "@@ -761,12 +681,8 @@ public int getDanglingLineCount() {\n \n     @Override\n     public DanglingLine getDanglingLine(final String id) {\n-        return index.getNetworkStream()\n-                .map(n -> n.getDanglingLine(id))\n-                .filter(Objects::nonNull)\n-                .map(index::getDanglingLine)\n-                .findFirst()\n-                .orElse(null);\n+        final DanglingLine dl = index.get(n -> n.getDanglingLine(id), index::getDanglingLine);\n+        return index.asDanglingLine(dl) ? dl : null;", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM0NzM4OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375347388", "bodyText": "yes", "author": "tadam50", "createdAt": "2020-02-05T16:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MzkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0NDczMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375144731", "bodyText": "See above: maybe you should rename this method to isMerged()", "author": "mathbagu", "createdAt": "2020-02-05T09:31:56Z", "path": "iidm/iidm-mergingview/src/main/java/com/powsybl/iidm/mergingview/MergingViewIndex.java", "diffHunk": "@@ -243,17 +269,22 @@ Identifiable getIdentifiable(final Identifiable identifiable) {\n     }\n \n     Collection<Line> getLines() {\n-        // Search Line into merging & working networks\n-        return getNetworkStream()\n-                .flatMap(Network::getLineStream)\n-                .map(this::getLine)\n+        // Search Line into merging & working networks, and MergedLines\n+        return Stream.concat(getNetworkStream().flatMap(Network::getLineStream)\n+                        .map(this::getLine),\n+                mergedLineCached.values().stream())\n                 .collect(Collectors.toList());\n     }\n \n+    boolean asDanglingLine(final DanglingLine dl) {", "originalCommit": "9b501e91755caa8e147690f35cd9697dce936d4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM0NzM0MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1130#discussion_r375347340", "bodyText": "ok", "author": "tadam50", "createdAt": "2020-02-05T16:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0NDczMQ=="}], "type": "inlineReview"}, {"oid": "bb4c5d50067a470e85db0ded8e9b9f493e1ff431", "url": "https://github.com/powsybl/powsybl-core/commit/bb4c5d50067a470e85db0ded8e9b9f493e1ff431", "message": "Revert BranchAdder changes on setNode methods\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2020-02-05T13:58:17Z", "type": "commit"}, {"oid": "f02cd16d536610eb30ffccd27964dac1d33ab218", "url": "https://github.com/powsybl/powsybl-core/commit/f02cd16d536610eb30ffccd27964dac1d33ab218", "message": "Taking into account MR reviews\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2020-02-13T13:57:45Z", "type": "commit"}, {"oid": "276e54de892482cfda674b6e11ed783957fc21aa", "url": "https://github.com/powsybl/powsybl-core/commit/276e54de892482cfda674b6e11ed783957fc21aa", "message": "Merge branch 'master' into iidm_merging_view_part_15_merged_line_v2", "committedDate": "2020-02-14T08:53:54Z", "type": "commit"}]}