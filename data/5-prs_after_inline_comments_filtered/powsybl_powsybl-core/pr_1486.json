{"pr_number": 1486, "pr_title": "[iAL] fix encoding", "pr_createdAt": "2020-09-25T07:52:44Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1486", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1OTk3Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1486#discussion_r494959977", "bodyText": "I think for more flexibility we should use a more generic object here, like a Writer.\nActually, after more thoughts, I think to keep the best of both worlds we could use a PrintWriter here, which has the same methods as PrintStream for writing primitives/objects.\nThen we could propose 2 constructors, one based on a Writer, and one based on an OutputStream as today (both wrapping it into a PrintWriter).\nThen to create a String we will input a StringWriter indeed.\nWhat do you think about it ?", "author": "sylvlecl", "createdAt": "2020-09-25T12:41:11Z", "path": "dsl/src/main/java/com/powsybl/dsl/ast/ExpressionPrinter.java", "diffHunk": "@@ -6,133 +6,136 @@\n  */\n package com.powsybl.dsl.ast;\n \n-import org.apache.commons.io.output.WriterOutputStream;\n-\n+import java.io.IOException;\n import java.io.PrintStream;\n import java.io.StringWriter;\n-import java.nio.charset.StandardCharsets;\n+import java.io.UncheckedIOException;\n import java.util.Objects;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n  */\n public class ExpressionPrinter extends DefaultExpressionVisitor<Void, Void> {\n \n-    protected final PrintStream out;\n+    protected final StringWriter out;", "originalCommit": "74e2c9f4d3274d571582d06343242069a5461fc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAwNDcyNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1486#discussion_r495004724", "bodyText": "(Otherwise, strictly speaking, removing the constructor based on a PrintStream is a breaking change. No big issue, but we can avoid it :) )", "author": "sylvlecl", "createdAt": "2020-09-25T13:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1OTk3Nw=="}], "type": "inlineReview"}, {"oid": "d18bd6abd2a920d38a72f9665405c983c53f14c8", "url": "https://github.com/powsybl/powsybl-core/commit/d18bd6abd2a920d38a72f9665405c983c53f14c8", "message": "Fix expression printer.\n\nSigned-off-by: yichen88 <tang.yichenyves@gmail.com>", "committedDate": "2020-09-28T08:40:47Z", "type": "forcePushed"}, {"oid": "8a5e15f5d86237cf3e816fe9502a99369becb103", "url": "https://github.com/powsybl/powsybl-core/commit/8a5e15f5d86237cf3e816fe9502a99369becb103", "message": "Fix expression printer.\n\nSigned-off-by: yichen88 <tang.yichenyves@gmail.com>", "committedDate": "2020-09-28T15:49:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQwMzA2Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1486#discussion_r499403062", "bodyText": "Looking at the javadoc it's not clear to me why we could not have a constructor that takes an OutputStream instead of a PrintStream. That will make ExpressionPrinter and ActionExpressionPrinter more convenient to use as we just wrap the objects in a PrintWriter that seems to work well with a simple OutputStream.", "author": "mathbagu", "createdAt": "2020-10-05T07:50:36Z", "path": "dsl/src/main/java/com/powsybl/dsl/ast/ExpressionPrinter.java", "diffHunk": "@@ -37,102 +33,110 @@ public static void print(ExpressionNode node, PrintStream out) {\n         node.accept(new ExpressionPrinter(out), null);\n     }\n \n+    private static void write(ExpressionNode node, StringWriter out) {\n+        node.accept(new ExpressionPrinter(out), null);\n+    }\n+\n     public ExpressionPrinter(PrintStream out) {\n-        this.out = Objects.requireNonNull(out);\n+        this.out = new PrintWriter(Objects.requireNonNull(out));\n+    }\n+\n+    public ExpressionPrinter(Writer writer) {\n+        out = new PrintWriter(Objects.requireNonNull(writer));\n     }", "originalCommit": "8a5e15f5d86237cf3e816fe9502a99369becb103", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIxNTc5Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1486#discussion_r500215793", "bodyText": "Agreed. The only thing which is not completely clear now is that this constructor will use \"default charset\" to write to the output stream: I think we should mention it in javadoc of the constructor.", "author": "sylvlecl", "createdAt": "2020-10-06T11:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQwMzA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQwNDE5Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1486#discussion_r499404192", "bodyText": "Same question here: do we really need a StringWriter? It seems a Writer is sufficient here. You should change constructors of both classes to take the highest interface you can from the inheritance tree.", "author": "mathbagu", "createdAt": "2020-10-05T07:52:33Z", "path": "action/action-dsl/src/main/java/com/powsybl/action/dsl/ast/ActionExpressionPrinter.java", "diffHunk": "@@ -21,20 +21,28 @@\n public class ActionExpressionPrinter extends ExpressionPrinter implements ActionExpressionVisitor<Void, Void> {\n \n     public static String toString(ExpressionNode node) {\n-        StringWriter writer = new StringWriter();\n-        try (PrintStream os = new PrintStream(new WriterOutputStream(writer, StandardCharsets.UTF_8))) {\n-            print(node, os);\n+        try (StringWriter writer = new StringWriter()) {\n+            write(node, writer);\n+            return writer.toString();\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n         }\n+    }\n \n-        return writer.toString();\n+    private static void write(ExpressionNode node, StringWriter out) {\n+        node.accept(new ActionExpressionPrinter(out), null);\n     }\n \n     public static void print(ExpressionNode node) {\n         print(node, System.out);\n     }\n \n     public static void print(ExpressionNode node, PrintStream out) {\n-        node.accept(new ActionExpressionPrinter(out), null);\n+        out.print(toString(node));\n+    }\n+\n+    public ActionExpressionPrinter(StringWriter out) {\n+        super(out);\n     }", "originalCommit": "8a5e15f5d86237cf3e816fe9502a99369becb103", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIxNTkyMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1486#discussion_r500215923", "bodyText": "Agreed", "author": "sylvlecl", "createdAt": "2020-10-06T11:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQwNDE5Mg=="}], "type": "inlineReview"}, {"oid": "c0bfdd2f5f9f6252fc62f9da718286bd6f65d3fe", "url": "https://github.com/powsybl/powsybl-core/commit/c0bfdd2f5f9f6252fc62f9da718286bd6f65d3fe", "message": "Fix expression printer.\n\nSigned-off-by: yichen88 <tang.yichenyves@gmail.com>", "committedDate": "2020-10-06T08:27:57Z", "type": "forcePushed"}, {"oid": "0a5d9c71ef40287d62b77a5c3d328e84ffc46f52", "url": "https://github.com/powsybl/powsybl-core/commit/0a5d9c71ef40287d62b77a5c3d328e84ffc46f52", "message": "Fix expression printer.\n\nSigned-off-by: yichen88 <tang.yichenyves@gmail.com>", "committedDate": "2020-10-08T12:51:35Z", "type": "commit"}, {"oid": "0a5d9c71ef40287d62b77a5c3d328e84ffc46f52", "url": "https://github.com/powsybl/powsybl-core/commit/0a5d9c71ef40287d62b77a5c3d328e84ffc46f52", "message": "Fix expression printer.\n\nSigned-off-by: yichen88 <tang.yichenyves@gmail.com>", "committedDate": "2020-10-08T12:51:35Z", "type": "forcePushed"}, {"oid": "4062ef8642da83dfd278c15fe6864759373eb71c", "url": "https://github.com/powsybl/powsybl-core/commit/4062ef8642da83dfd278c15fe6864759373eb71c", "message": "Small fixes\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>", "committedDate": "2020-10-08T16:00:09Z", "type": "commit"}, {"oid": "a522680f75fef1dc403711ca613bdce7bf573ada", "url": "https://github.com/powsybl/powsybl-core/commit/a522680f75fef1dc403711ca613bdce7bf573ada", "message": "Merge branch 'master' into fix-iAL-encoding", "committedDate": "2020-10-08T16:10:38Z", "type": "commit"}, {"oid": "acbe9615286523c82b80b8a3cc19f4ba048ebc05", "url": "https://github.com/powsybl/powsybl-core/commit/acbe9615286523c82b80b8a3cc19f4ba048ebc05", "message": "Flush after writing\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>", "committedDate": "2020-10-09T08:09:06Z", "type": "commit"}]}