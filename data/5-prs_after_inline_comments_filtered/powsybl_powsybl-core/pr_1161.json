{"pr_number": 1161, "pr_title": "Delete node count", "pr_createdAt": "2020-02-17T16:07:20Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1161", "timeline": [{"oid": "18d8cc406d9bde9bb06a5df000236835e11986ed", "url": "https://github.com/powsybl/powsybl-core/commit/18d8cc406d9bde9bb06a5df000236835e11986ed", "message": "Delete nodeCount attribute and related methods in IIDM node/breaker voltage levels\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\ntmp\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-02-17T16:13:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzMzA0MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r381233041", "bodyText": "Create a complete message instead and use it in Message.format()", "author": "mathbagu", "createdAt": "2020-02-19T11:25:52Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/util/IidmXmlUtil.java", "diffHunk": "@@ -21,6 +21,8 @@\n  */\n public final class IidmXmlUtil {\n \n+    private static final String FOR_IIDM_XML_VERSION = \" for IIDM-XML version \";", "originalCommit": "0a2f04ccb898f103878728e5accfbfdad8b676bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNDM4Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r381234386", "bodyText": "I'm not sure it's what we discussed. Adding a vertex will create a terminal. The idea is to create a terminal only if you need to attach something. As you remove the call to clean(), the unnecessary terminals are not removed.\nIt's compliant with the current version of powsybl, but I thought we wanted to go further.", "author": "mathbagu", "createdAt": "2020-02-19T11:29:02Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NodeBreakerVoltageLevel.java", "diffHunk": "@@ -872,13 +863,23 @@ private void checkTerminal(TerminalExt terminal) {\n         }\n     }\n \n+    private void addNodes(int node) {\n+        int oldCount = graph.getVertexCount();\n+        if (node >= oldCount) {\n+            for (int i = oldCount; i < node + 1; i++) {\n+                graph.addVertex();\n+            }\n+        }\n+    }", "originalCommit": "0a2f04ccb898f103878728e5accfbfdad8b676bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI2MTk3OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r381261978", "bodyText": "Okay, I was not really sure about the conclusion of what had been decided last time... If we want to create a vertex only each time a Terminal is created, we might not need a clean method (the vertex will be deleted when not used and created again if reused: the topology is always \"clean\" as there never is an unused vertex).", "author": "miovd", "createdAt": "2020-02-19T12:33:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNDM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNDk5OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r381234999", "bodyText": "I think I will rename this method to reserveNodes or ensureNode. The s in the name of the method seems strange for someone who reads the code. You have to go in the implementation to understand why you put an s.", "author": "mathbagu", "createdAt": "2020-02-19T11:30:31Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NodeBreakerVoltageLevel.java", "diffHunk": "@@ -166,6 +166,8 @@ public Switch add() {\n             }\n             SwitchImpl aSwitch = new SwitchImpl(NodeBreakerVoltageLevel.this, id, getName(), kind, open, retained, fictitious);\n             getNetwork().getIndex().checkAndAdd(aSwitch);\n+            addNodes(node1);", "originalCommit": "0a2f04ccb898f103878728e5accfbfdad8b676bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNTIwNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r381235207", "bodyText": "Maybe we could keep the name of the old method?", "author": "mathbagu", "createdAt": "2020-02-19T11:31:00Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/BusBreakerVoltageLevel.java", "diffHunk": "@@ -757,7 +752,7 @@ public void detach(final TerminalExt terminal) {\n     }\n \n     @Override\n-    public void clean() {\n+    public void cleanTopology() {", "originalCommit": "0a2f04ccb898f103878728e5accfbfdad8b676bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df8619798258a20ad990fa5f9e827dd0fd8b1e44", "url": "https://github.com/powsybl/powsybl-core/commit/df8619798258a20ad990fa5f9e827dd0fd8b1e44", "message": "Delete nodeCount attribute and related methods in IIDM node/breaker voltage levels\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\n correct code smells\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\nUpdate javadoc on VoltageLevel.cleanTopology()\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\nAdd removeInternalConnection + Change mechanism (delete cleanTopology and auto-clean each time a connectable, a switch or an internal connection is removed)\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-02-28T14:29:20Z", "type": "forcePushed"}, {"oid": "e37d22571265ecf946df4c68e58cad7876e91c59", "url": "https://github.com/powsybl/powsybl-core/commit/e37d22571265ecf946df4c68e58cad7876e91c59", "message": "Add test for removing internal connections\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-04T08:23:05Z", "type": "forcePushed"}, {"oid": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "url": "https://github.com/powsybl/powsybl-core/commit/6510c45bf33389c1a5a041d4d9958aaf3034aba8", "message": "Use fail() method rather than a boolean\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-05T13:51:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NDE2MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388774160", "bodyText": "Please add Javadoc on this method to well understand what is expected", "author": "mathbagu", "createdAt": "2020-03-06T08:41:15Z", "path": "iidm/iidm-api/src/main/java/com/powsybl/iidm/network/VoltageLevel.java", "diffHunk": "@@ -358,20 +358,28 @@\n         }\n \n         /**\n-         * Get the number of node.\n+         * Get the count of used nodes (nodes attached to an equipment, a switch or an internal connection).\n+         *\n+         * @deprecated Depending on your use case, use {@link #getMaximumNodeIndex()} or {@link #getNodeCapacity()}.\n          */\n-        int getNodeCount();\n+        @Deprecated\n+        default int getNodeCount() {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        default int getMaximumNodeIndex() {", "originalCommit": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NDIzMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388774232", "bodyText": "Please add Javadoc on this method to well understand what is expected", "author": "mathbagu", "createdAt": "2020-03-06T08:41:27Z", "path": "iidm/iidm-api/src/main/java/com/powsybl/iidm/network/VoltageLevel.java", "diffHunk": "@@ -358,20 +358,28 @@\n         }\n \n         /**\n-         * Get the number of node.\n+         * Get the count of used nodes (nodes attached to an equipment, a switch or an internal connection).\n+         *\n+         * @deprecated Depending on your use case, use {@link #getMaximumNodeIndex()} or {@link #getNodeCapacity()}.\n          */\n-        int getNodeCount();\n+        @Deprecated\n+        default int getNodeCount() {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        default int getMaximumNodeIndex() {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        default int getNodeCapacity() {", "originalCommit": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk0Njc3Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388946776", "bodyText": "At the end, I deleted this method since it always returns getMaximumNodeIndex() + 1. It was useful before having cleanVertices.", "author": "miovd", "createdAt": "2020-03-06T14:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NDIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NTM2Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388775362", "bodyText": "I think you should also get edges between node2 and node1 (the graph is not directed)", "author": "mathbagu", "createdAt": "2020-03-06T08:44:01Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NodeBreakerVoltageLevel.java", "diffHunk": "@@ -647,6 +653,21 @@ public int getNode2() {\n                     });\n         }\n \n+        @Override\n+        public void removeInternalConnections(int node1, int node2) {\n+            int[] internalConnectionsToBeRemoved = Arrays.stream(graph.getEdges())\n+                    .filter(e -> graph.getEdgeObject(e) == null)\n+                    .filter(e -> graph.getEdgeVertex1(e) == node1 && graph.getEdgeVertex2(e) == node2)", "originalCommit": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NjY1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388776652", "bodyText": "Add a Javadoc also there", "author": "mathbagu", "createdAt": "2020-03-06T08:47:11Z", "path": "math/src/main/java/com/powsybl/math/graph/UndirectedGraph.java", "diffHunk": "@@ -49,6 +56,10 @@\n      */\n     int getVertexCount();\n \n+    default int getMaximumVertexIndex() {", "originalCommit": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk0MzY5Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388943693", "bodyText": "At the end, I deleted the method since it is basically getVertexCapacity() - 1", "author": "miovd", "createdAt": "2020-03-06T14:47:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NjY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NzYwMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388777602", "bodyText": "Are you sure this is efficient: should we store the removedVertices in another container (ordered) like a set?", "author": "mathbagu", "createdAt": "2020-03-06T08:49:17Z", "path": "math/src/main/java/com/powsybl/math/graph/UndirectedGraphImpl.java", "diffHunk": "@@ -129,6 +129,24 @@ public int addVertex() {\n         return v;\n     }\n \n+    @Override\n+    public void addVertexIfNotPresent(int v) {\n+        if (v < vertices.size()) {\n+            if (removedVertices.contains(v)) {", "originalCommit": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NzkxMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388777911", "bodyText": "Maybe we should also rename removedVertices to availableVertices`", "author": "mathbagu", "createdAt": "2020-03-06T08:50:02Z", "path": "math/src/main/java/com/powsybl/math/graph/UndirectedGraphImpl.java", "diffHunk": "@@ -129,6 +129,24 @@ public int addVertex() {\n         return v;\n     }\n \n+    @Override\n+    public void addVertexIfNotPresent(int v) {\n+        if (v < vertices.size()) {\n+            if (removedVertices.contains(v)) {\n+                vertices.set(v, new Vertex<>());\n+                removedVertices.remove(v);\n+            }\n+        } else {\n+            for (int i = vertices.size(); i < v; i++) {\n+                vertices.add(null);\n+                removedVertices.add(i);", "originalCommit": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3ODI0Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388778243", "bodyText": "I'm not sure it is really effecient to have a recursion here where a for-loop looks OK", "author": "mathbagu", "createdAt": "2020-03-06T08:50:47Z", "path": "math/src/main/java/com/powsybl/math/graph/UndirectedGraphImpl.java", "diffHunk": "@@ -149,11 +167,29 @@ public V removeVertex(int v) {\n         return obj;\n     }\n \n+    private void cleanVertices(int v) {\n+        vertices.remove(v);\n+        removedVertices.remove(v);\n+        if (removedVertices.contains(v - 1)) {\n+            cleanVertices(v - 1);\n+        }", "originalCommit": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3OTQ0Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388779446", "bodyText": "I'm not sure to understand what this method does:\nif (!removedVertices.contains(i - 1)) seems equivalent to if (vertices.at(i) != null ?\nIs it really possible to have null vertices at the end of the list. The cleanVertices should avoid that situation?", "author": "mathbagu", "createdAt": "2020-03-06T08:53:30Z", "path": "math/src/main/java/com/powsybl/math/graph/UndirectedGraphImpl.java", "diffHunk": "@@ -149,11 +167,29 @@ public V removeVertex(int v) {\n         return obj;\n     }\n \n+    private void cleanVertices(int v) {\n+        vertices.remove(v);\n+        removedVertices.remove(v);\n+        if (removedVertices.contains(v - 1)) {\n+            cleanVertices(v - 1);\n+        }\n+    }\n+\n     @Override\n     public int getVertexCount() {\n         return vertices.size() - removedVertices.size();\n     }\n \n+    @Override\n+    public int getMaximumVertexIndex() {\n+        for (int i = vertices.size(); i > 0; i--) {\n+            if (!removedVertices.contains(i - 1)) {\n+                return i - 1;\n+            }\n+        }\n+        return -1;\n+    }", "originalCommit": "6510c45bf33389c1a5a041d4d9958aaf3034aba8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgxNDE1NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388814155", "bodyText": "Yes, this was coded before I thought of doing cleanVertices, i will modify it", "author": "miovd", "createdAt": "2020-03-06T10:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3OTQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1MjUzNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1161#discussion_r388952537", "bodyText": "At the end, I deleted this method as it is redundant with getNodeCapacity", "author": "miovd", "createdAt": "2020-03-06T15:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3OTQ0Ng=="}], "type": "inlineReview"}, {"oid": "ac54661bac2420b8722c6a45f4719e93cb255721", "url": "https://github.com/powsybl/powsybl-core/commit/ac54661bac2420b8722c6a45f4719e93cb255721", "message": "Delete nodeCount attribute and related methods in IIDM node/breaker voltage levels\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\n correct code smells\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\nUpdate javadoc on VoltageLevel.cleanTopology()\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\nAdd removeInternalConnection + Change mechanism (delete cleanTopology and auto-clean each time a connectable, a switch or an internal connection is removed)\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:54:56Z", "type": "commit"}, {"oid": "a74c2efe1169b98c02574508fa1f81ee8adb50fa", "url": "https://github.com/powsybl/powsybl-core/commit/a74c2efe1169b98c02574508fa1f81ee8adb50fa", "message": "Delete unused method\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:54:56Z", "type": "commit"}, {"oid": "34a569e1db7cbf9a5881d70b13b0cf6c3bec5912", "url": "https://github.com/powsybl/powsybl-core/commit/34a569e1db7cbf9a5881d70b13b0cf6c3bec5912", "message": "Change removeInternalConnection into removeInternalConnections\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:54:56Z", "type": "commit"}, {"oid": "1b25d2267b5c9ce67de1a220d38ac28da31ffeb2", "url": "https://github.com/powsybl/powsybl-core/commit/1b25d2267b5c9ce67de1a220d38ac28da31ffeb2", "message": "Add test for removing internal connections\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:54:56Z", "type": "commit"}, {"oid": "857120c91a996351bfc4136918269de1c4b59e3c", "url": "https://github.com/powsybl/powsybl-core/commit/857120c91a996351bfc4136918269de1c4b59e3c", "message": "delete last use of getNodeCount()\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:54:56Z", "type": "commit"}, {"oid": "1e68909d96fbf7aeebc0a2229acd545f9ecca66a", "url": "https://github.com/powsybl/powsybl-core/commit/1e68909d96fbf7aeebc0a2229acd545f9ecca66a", "message": "Use fail() method rather than a boolean\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:54:56Z", "type": "commit"}, {"oid": "aed145649bbffb5d79bf670172976acbfe288296", "url": "https://github.com/powsybl/powsybl-core/commit/aed145649bbffb5d79bf670172976acbfe288296", "message": "Take reviews into account: add javadoc + simplify code + small renaming\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:55:23Z", "type": "commit"}, {"oid": "35c28921c726d37ba7d9a024f6017f7b446a1d7a", "url": "https://github.com/powsybl/powsybl-core/commit/35c28921c726d37ba7d9a024f6017f7b446a1d7a", "message": "removeInternalConnections is not oriented\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:55:23Z", "type": "commit"}, {"oid": "72b9414e727c9fc3abdcc52e80dd29bc9ff37e93", "url": "https://github.com/powsybl/powsybl-core/commit/72b9414e727c9fc3abdcc52e80dd29bc9ff37e93", "message": "Apply reviews: make availableVertices a TIntHashSet\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T08:55:23Z", "type": "commit"}, {"oid": "4567a02c884a1c25542d53efcf1fa15d2d9c4247", "url": "https://github.com/powsybl/powsybl-core/commit/4567a02c884a1c25542d53efcf1fa15d2d9c4247", "message": "Resolve conflict after rebasing\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T09:01:07Z", "type": "forcePushed"}, {"oid": "861d75225de2facf39a92f4e72b4dd8138be95d4", "url": "https://github.com/powsybl/powsybl-core/commit/861d75225de2facf39a92f4e72b4dd8138be95d4", "message": "Corrections after rebasing master\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T09:16:39Z", "type": "commit"}, {"oid": "861d75225de2facf39a92f4e72b4dd8138be95d4", "url": "https://github.com/powsybl/powsybl-core/commit/861d75225de2facf39a92f4e72b4dd8138be95d4", "message": "Corrections after rebasing master\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-09T09:16:39Z", "type": "forcePushed"}, {"oid": "a5a4ca9888fe8fe004629ffbe7dc9c82bc48fa63", "url": "https://github.com/powsybl/powsybl-core/commit/a5a4ca9888fe8fe004629ffbe7dc9c82bc48fa63", "message": "Merge branch 'master' into delete_node_count", "committedDate": "2020-03-11T08:36:24Z", "type": "commit"}]}