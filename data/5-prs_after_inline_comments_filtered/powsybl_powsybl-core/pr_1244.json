{"pr_number": 1244, "pr_title": "Support XIIDM serialization/deserialization with new shunt API", "pr_createdAt": "2020-03-25T15:25:25Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1244", "timeline": [{"oid": "38a7b203caa52ef9378678ba8fcaf1c12581c6fe", "url": "https://github.com/powsybl/powsybl-core/commit/38a7b203caa52ef9378678ba8fcaf1c12581c6fe", "message": "add basic test for non linear shunts\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-26T14:09:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMzA0NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r400003044", "bodyText": "I think I wouldn't serialize the type: it's a redundant information with the model you will have to check. As you do not use the same XML element name, it's not necessary.", "author": "mathbagu", "createdAt": "2020-03-30T08:12:35Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/ShuntXml.java", "diffHunk": "@@ -34,13 +40,30 @@ protected boolean hasSubElements(ShuntCompensator sc) {\n         return sc != sc.getRegulatingTerminal().getConnectable();\n     }\n \n+    @Override\n+    protected boolean hasSubElements(ShuntCompensator sc, NetworkXmlWriterContext context) {\n+        return context.getVersion().compareTo(IidmXmlVersion.V_1_2) >= 0 || hasSubElements(sc);\n+    }\n+\n     @Override\n     protected void writeRootElementAttributes(ShuntCompensator sc, VoltageLevel vl, NetworkXmlWriterContext context) throws XMLStreamException {\n-        if (ShuntCompensatorModelType.NON_LINEAR.equals(sc.getModelType())) {\n-            throw new PowsyblException(\"Non linear shunt not yet supported\");\n-        }\n-        XmlUtil.writeDouble(\"bPerSection\", sc.getModel(ShuntCompensatorLinearModel.class).getbPerSection(), context.getWriter());\n-        context.getWriter().writeAttribute(\"maximumSectionCount\", Integer.toString(sc.getMaximumSectionCount()));\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(ShuntCompensatorModelType.NON_LINEAR.equals(sc.getModelType()), ROOT_ELEMENT_NAME,\n+                NON_LINEAR_MODEL, IidmXmlUtil.ErrorMessage.NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n+        IidmXmlUtil.runUntilMaximumVersion(IidmXmlVersion.V_1_1, context, () -> {\n+            try {\n+                XmlUtil.writeDouble(B_PER_SECTION, sc.getModel(ShuntCompensatorLinearModel.class).getbPerSection(), context.getWriter());\n+                context.getWriter().writeAttribute(MAXIMUM_SECTION_COUNT, Integer.toString(sc.getMaximumSectionCount()));\n+            } catch (XMLStreamException e) {\n+                throw new UncheckedXmlStreamException(e);\n+            }\n+        });\n+        IidmXmlUtil.runFromMinimumVersion(IidmXmlVersion.V_1_2, context, () -> {\n+            try {\n+                context.getWriter().writeAttribute(MODEL, sc.getModelType().name());", "originalCommit": "8e99d3eee05d614ed6e3ed9e40212eebe5297be3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwMDYzMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r401700631", "bodyText": "I changed linearModel and nonLinearModel rather than this attribute (it simplifies the file)", "author": "miovd", "createdAt": "2020-04-01T15:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMzA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMzUzNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r400003534", "bodyText": "To make the code simpler, maybe you should move the try catch in the writeModel method.", "author": "mathbagu", "createdAt": "2020-03-30T08:13:21Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/ShuntXml.java", "diffHunk": "@@ -54,35 +77,84 @@ protected void writeRootElementAttributes(ShuntCompensator sc, VoltageLevel vl,\n \n     @Override\n     protected void writeSubElements(ShuntCompensator sc, VoltageLevel vl, NetworkXmlWriterContext context) throws XMLStreamException {\n+        IidmXmlUtil.runFromMinimumVersion(IidmXmlVersion.V_1_2, context, () -> {\n+            try {\n+                writeModel(sc, context);\n+            } catch (XMLStreamException e) {\n+                throw new UncheckedXmlStreamException(e);\n+            }", "originalCommit": "8e99d3eee05d614ed6e3ed9e40212eebe5297be3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDczMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r400004731", "bodyText": "Is it a bit strange? Maybe we should create a default Linear Model, like we did for ReactiveLimits? And allow to change the model of a shunt after its creation.", "author": "mathbagu", "createdAt": "2020-03-30T08:15:18Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/ShuntXml.java", "diffHunk": "@@ -54,35 +77,84 @@ protected void writeRootElementAttributes(ShuntCompensator sc, VoltageLevel vl,\n \n     @Override\n     protected void writeSubElements(ShuntCompensator sc, VoltageLevel vl, NetworkXmlWriterContext context) throws XMLStreamException {\n+        IidmXmlUtil.runFromMinimumVersion(IidmXmlVersion.V_1_2, context, () -> {\n+            try {\n+                writeModel(sc, context);\n+            } catch (XMLStreamException e) {\n+                throw new UncheckedXmlStreamException(e);\n+            }\n+        });\n         if (sc != sc.getRegulatingTerminal().getConnectable()) {\n             IidmXmlUtil.assertMinimumVersion(ROOT_ELEMENT_NAME, REGULATING_TERMINAL, IidmXmlUtil.ErrorMessage.NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n             TerminalRefXml.writeTerminalRef(sc.getRegulatingTerminal(), context, REGULATING_TERMINAL);\n         }\n     }\n \n+    private static void writeModel(ShuntCompensator sc, NetworkXmlWriterContext context) throws XMLStreamException {\n+        if (ShuntCompensatorModelType.LINEAR.equals(sc.getModelType())) {\n+            context.getWriter().writeEmptyElement(context.getVersion().getNamespaceURI(), LINEAR_MODEL);\n+            XmlUtil.writeDouble(B_PER_SECTION, sc.getModel(ShuntCompensatorLinearModel.class).getbPerSection(), context.getWriter());\n+            XmlUtil.writeDouble(\"gPerSection\", sc.getModel(ShuntCompensatorLinearModel.class).getgPerSection(), context.getWriter());\n+            context.getWriter().writeAttribute(MAXIMUM_SECTION_COUNT, Integer.toString(sc.getMaximumSectionCount()));\n+        } else if (ShuntCompensatorModelType.NON_LINEAR.equals(sc.getModelType())) {\n+            context.getWriter().writeStartElement(context.getVersion().getNamespaceURI(), NON_LINEAR_MODEL);\n+            sc.getModel(ShuntCompensatorNonLinearModel.class).getSections().forEach((sectionNum, section) -> {\n+                try {\n+                    context.getWriter().writeEmptyElement(context.getVersion().getNamespaceURI(), \"section\");\n+                    context.getWriter().writeAttribute(\"num\", Integer.toString(sectionNum));\n+                    XmlUtil.writeDouble(\"b\", section.getB(), context.getWriter());\n+                    XmlUtil.writeDouble(\"g\", section.getG(), context.getWriter());\n+                } catch (XMLStreamException e) {\n+                    throw new UncheckedXmlStreamException(e);\n+                }\n+            });\n+            context.getWriter().writeEndElement();\n+        } else {\n+            throw new PowsyblException(String.format(\"Unexpected shunt model type for %s: %s\", sc.getId(), sc.getModelType().name()));\n+        }\n+    }\n+\n     @Override\n     protected ShuntCompensatorAdder createAdder(VoltageLevel vl) {\n         return vl.newShuntCompensator();\n     }\n \n     @Override\n     protected ShuntCompensator readRootElementAttributes(ShuntCompensatorAdder adder, NetworkXmlReaderContext context) {\n-        double bPerSection = XmlUtil.readDoubleAttribute(context.getReader(), \"bPerSection\");\n-        int maximumSectionCount = XmlUtil.readIntAttribute(context.getReader(), \"maximumSectionCount\");\n         int currentSectionCount = XmlUtil.readIntAttribute(context.getReader(), \"currentSectionCount\");\n+        IidmXmlUtil.runUntilMaximumVersion(IidmXmlVersion.V_1_1, context, () -> {\n+            double bPerSection = XmlUtil.readDoubleAttribute(context.getReader(), B_PER_SECTION);\n+            int maximumSectionCount = XmlUtil.readIntAttribute(context.getReader(), MAXIMUM_SECTION_COUNT);\n+            adder.newLinearModel()\n+                    .setMaximumSectionCount(maximumSectionCount)\n+                    .setbPerSection(bPerSection)\n+                    .add();\n+        });\n         IidmXmlUtil.runFromMinimumVersion(IidmXmlVersion.V_1_2, context, () -> {\n             boolean voltageRegulatorOn = XmlUtil.readBoolAttribute(context.getReader(), \"voltageRegulatorOn\");\n             double targetV = XmlUtil.readOptionalDoubleAttribute(context.getReader(), \"targetV\");\n             double targetDeadband = XmlUtil.readOptionalDoubleAttribute(context.getReader(), \"targetDeadband\");\n             adder.setVoltageRegulatorOn(voltageRegulatorOn)\n                     .setTargetV(targetV)\n                     .setTargetDeadband(targetDeadband);\n+            ShuntCompensatorModelType modelType = ShuntCompensatorModelType.valueOf(context.getReader().getAttributeValue(null, MODEL));\n+            if (ShuntCompensatorModelType.LINEAR.equals(modelType)) { // default value for linear shunt (always overwritten)\n+                adder.newLinearModel()\n+                        .setMaximumSectionCount(currentSectionCount + 1) // maximumSectionCount must be > 0\n+                        .setbPerSection(Double.MIN_VALUE)\n+                        .add();\n+            } else if (ShuntCompensatorModelType.NON_LINEAR.equals(modelType)) { // default value for non linear shunt (always overwritten)\n+                adder.newNonLinearModel()\n+                        .beginSection()\n+                            .setSectionNum(currentSectionCount)\n+                            .setB(Double.MIN_VALUE)\n+                        .endSection()", "originalCommit": "8e99d3eee05d614ed6e3ed9e40212eebe5297be3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMDkyMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r400100923", "bodyText": "It may be a good solution but there are two questions:\n\nWhat default value for bPerSection do we want?\nDoes that mean that we are allowing to modify the shunt model of a built shunt? (we wanted to prevent that at first, given that a modification of shunt model may not really make sense...)", "author": "miovd", "createdAt": "2020-03-30T10:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY2NzA2OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r401667068", "bodyText": "Ok, I put another solution that only requires default values for non linear shunt.... what do you think?", "author": "miovd", "createdAt": "2020-04-01T14:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwNDczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU4ODYyNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404588626", "bodyText": "General advice: sometimes a simple for-loop is fine :)", "author": "mathbagu", "createdAt": "2020-04-07T07:19:49Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NonLinearShuntXml.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.xml;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.exceptions.UncheckedXmlStreamException;\n+import com.powsybl.commons.xml.XmlUtil;\n+import com.powsybl.iidm.network.*;\n+import com.powsybl.iidm.xml.util.IidmXmlUtil;\n+\n+import javax.xml.stream.XMLStreamException;\n+import java.util.*;\n+\n+/**\n+ * @author Miora Ralambotiana <miora.ralambotiana at rte-france.com>\n+ */\n+public class NonLinearShuntXml extends AbstractConnectableXml<ShuntCompensator, ShuntCompensatorAdder, VoltageLevel> {\n+\n+    static final NonLinearShuntXml INSTANCE = new NonLinearShuntXml();\n+\n+    static final String ROOT_ELEMENT_NAME = \"nonLinearShunt\";\n+\n+    @Override\n+    protected String getRootElementName() {\n+        return ROOT_ELEMENT_NAME;\n+    }\n+\n+    @Override\n+    protected boolean hasSubElements(ShuntCompensator sc) {\n+        return true;\n+    }\n+\n+    @Override\n+    protected void writeRootElementAttributes(ShuntCompensator sc, VoltageLevel parent, NetworkXmlWriterContext context) throws XMLStreamException {\n+        context.getWriter().writeAttribute(\"currentSectionCount\", Integer.toString(sc.getCurrentSectionCount()));\n+        context.getWriter().writeAttribute(\"voltageRegulatorOn\", Boolean.toString(sc.isVoltageRegulatorOn()));\n+        XmlUtil.writeDouble(\"targetV\", sc.getTargetV(), context.getWriter());\n+        XmlUtil.writeDouble(\"targetDeadband\", sc.getTargetDeadband(), context.getWriter());\n+        writeNodeOrBus(null, sc.getTerminal(), context);\n+        writePQ(null, sc.getTerminal(), context.getWriter());\n+    }\n+\n+    @Override\n+    protected void writeSubElements(ShuntCompensator sc, VoltageLevel vl, NetworkXmlWriterContext context) throws XMLStreamException {\n+        writeSections(sc, context);\n+        if (sc != sc.getRegulatingTerminal().getConnectable()) {\n+            TerminalRefXml.writeTerminalRef(sc.getRegulatingTerminal(), context, \"regulatingTerminal\");\n+        }\n+    }\n+\n+    private static void writeSections(ShuntCompensator sc, NetworkXmlWriterContext context) {\n+        sc.getModel(ShuntCompensatorNonLinearModel.class).getSections().forEach((sectionNum, section) -> {\n+            try {\n+                context.getWriter().writeEmptyElement(context.getVersion().getNamespaceURI(), \"section\");\n+                context.getWriter().writeAttribute(\"num\", Integer.toString(sectionNum));\n+                XmlUtil.writeDouble(\"b\", section.getB(), context.getWriter());\n+                XmlUtil.writeDouble(\"g\", section.getG(), context.getWriter());\n+            } catch (XMLStreamException e) {\n+                throw new UncheckedXmlStreamException(e);\n+            }\n+        });", "originalCommit": "608d6a339c0375845ef47e9a710666b25566a2f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyNzUyNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404627525", "bodyText": "Is there a bug there (and elsewhere)? If an identifiable has properties, then he has sub elements.", "author": "mathbagu", "createdAt": "2020-04-07T08:24:48Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/ShuntXml.java", "diffHunk": "@@ -22,67 +22,53 @@\n \n     static final String ROOT_ELEMENT_NAME = \"shunt\";\n \n-    private static final String REGULATING_TERMINAL = \"regulatingTerminal\";\n-\n     @Override\n     protected String getRootElementName() {\n         return ROOT_ELEMENT_NAME;\n     }\n \n     @Override\n     protected boolean hasSubElements(ShuntCompensator sc) {\n-        return sc != sc.getRegulatingTerminal().getConnectable();\n+        return false;", "originalCommit": "608d6a339c0375845ef47e9a710666b25566a2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzMzcyNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404833725", "bodyText": "No, in AbstractIdentifiableXml, we have it checks if (hasSubElements || identifiable.hasProperty()), not only what hasSubElements returns.", "author": "miovd", "createdAt": "2020-04-07T14:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyNzUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyNzk3NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404627975", "bodyText": "Everytime we writeSubElements, we should write properties. I think we make this bug everywhere?", "author": "mathbagu", "createdAt": "2020-04-07T08:25:28Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/ShuntXml.java", "diffHunk": "@@ -22,67 +22,53 @@\n \n     static final String ROOT_ELEMENT_NAME = \"shunt\";\n \n-    private static final String REGULATING_TERMINAL = \"regulatingTerminal\";\n-\n     @Override\n     protected String getRootElementName() {\n         return ROOT_ELEMENT_NAME;\n     }\n \n     @Override\n     protected boolean hasSubElements(ShuntCompensator sc) {\n-        return sc != sc.getRegulatingTerminal().getConnectable();\n+        return false;\n     }\n \n     @Override\n     protected void writeRootElementAttributes(ShuntCompensator sc, VoltageLevel vl, NetworkXmlWriterContext context) throws XMLStreamException {\n         if (ShuntCompensatorModelType.NON_LINEAR.equals(sc.getModelType())) {\n-            throw new PowsyblException(\"Non linear shunt not yet supported\");\n+            throw new PowsyblException(\"Non linear shunts are not supported for IIDM-XML version \" + context.getVersion().toString(\".\")\n+                    + \". IIDM-XML version should be >= 1.2\");\n         }\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(sc.isVoltageRegulatorOn(), ROOT_ELEMENT_NAME, \"voltageRegulatorOn\",\n+                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(!Double.isNaN(sc.getTargetV()), ROOT_ELEMENT_NAME, \"targetV\",\n+                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(!Double.isNaN(sc.getTargetDeadband()), ROOT_ELEMENT_NAME, \"targetDeadband\",\n+                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(sc.getRegulatingTerminal().getConnectable() != sc, ROOT_ELEMENT_NAME, \"regulatingTerminal\",\n+                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n         XmlUtil.writeDouble(\"bPerSection\", sc.getModel(ShuntCompensatorLinearModel.class).getbPerSection(), context.getWriter());\n         context.getWriter().writeAttribute(\"maximumSectionCount\", Integer.toString(sc.getMaximumSectionCount()));\n         context.getWriter().writeAttribute(\"currentSectionCount\", Integer.toString(sc.getCurrentSectionCount()));\n-        IidmXmlUtil.writeBooleanAttributeFromMinimumVersion(ROOT_ELEMENT_NAME, \"voltageRegulatorOn\", sc.isVoltageRegulatorOn(), false,\n-                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n-        IidmXmlUtil.writeDoubleAttributeFromMinimumVersion(ROOT_ELEMENT_NAME, \"targetV\", sc.getTargetV(),\n-                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n-        IidmXmlUtil.writeDoubleAttributeFromMinimumVersion(ROOT_ELEMENT_NAME, \"targetDeadband\",\n-                sc.getTargetDeadband(), IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n         writeNodeOrBus(null, sc.getTerminal(), context);\n         writePQ(null, sc.getTerminal(), context.getWriter());\n     }\n \n-    @Override\n-    protected void writeSubElements(ShuntCompensator sc, VoltageLevel vl, NetworkXmlWriterContext context) throws XMLStreamException {", "originalCommit": "608d6a339c0375845ef47e9a710666b25566a2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzNDM2NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404834365", "bodyText": "It is written in super.readSubElements(...) from AbstractIdentifiableXml", "author": "miovd", "createdAt": "2020-04-07T14:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyNzk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyODMyMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404628321", "bodyText": "in IIDM v1.2, we should not use this class anymore?", "author": "mathbagu", "createdAt": "2020-04-07T08:26:01Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/ShuntXml.java", "diffHunk": "@@ -22,67 +22,53 @@\n \n     static final String ROOT_ELEMENT_NAME = \"shunt\";\n \n-    private static final String REGULATING_TERMINAL = \"regulatingTerminal\";\n-\n     @Override\n     protected String getRootElementName() {\n         return ROOT_ELEMENT_NAME;\n     }\n \n     @Override\n     protected boolean hasSubElements(ShuntCompensator sc) {\n-        return sc != sc.getRegulatingTerminal().getConnectable();\n+        return false;\n     }\n \n     @Override\n     protected void writeRootElementAttributes(ShuntCompensator sc, VoltageLevel vl, NetworkXmlWriterContext context) throws XMLStreamException {\n         if (ShuntCompensatorModelType.NON_LINEAR.equals(sc.getModelType())) {\n-            throw new PowsyblException(\"Non linear shunt not yet supported\");\n+            throw new PowsyblException(\"Non linear shunts are not supported for IIDM-XML version \" + context.getVersion().toString(\".\")\n+                    + \". IIDM-XML version should be >= 1.2\");\n         }\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(sc.isVoltageRegulatorOn(), ROOT_ELEMENT_NAME, \"voltageRegulatorOn\",\n+                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(!Double.isNaN(sc.getTargetV()), ROOT_ELEMENT_NAME, \"targetV\",\n+                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(!Double.isNaN(sc.getTargetDeadband()), ROOT_ELEMENT_NAME, \"targetDeadband\",\n+                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);\n+        IidmXmlUtil.assertMinimumVersionIfNotDefault(sc.getRegulatingTerminal().getConnectable() != sc, ROOT_ELEMENT_NAME, \"regulatingTerminal\",\n+                IidmXmlUtil.ErrorMessage.NOT_DEFAULT_NOT_SUPPORTED, IidmXmlVersion.V_1_2, context);", "originalCommit": "608d6a339c0375845ef47e9a710666b25566a2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzNTY5NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404835694", "bodyText": "These lines do not check the version, they check if the shunt is regulating/has a target value/has a regulating terminal/etc... and if it does, it throws an exception because it is not supported in serialization in version older than v1.2.", "author": "miovd", "createdAt": "2020-04-07T14:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyODMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg0Mjc2OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404842768", "bodyText": "Hum... So you check that the Shunt (in V1.2) is compatible with an old version (the new attributes have the default value)? Do I understand well?", "author": "mathbagu", "createdAt": "2020-04-07T14:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyODMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MTAyNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1244#discussion_r404881024", "bodyText": "Yes!", "author": "miovd", "createdAt": "2020-04-07T15:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyODMyMQ=="}], "type": "inlineReview"}, {"oid": "93265f586c39b3494cadc4027dcc460be1d474a7", "url": "https://github.com/powsybl/powsybl-core/commit/93265f586c39b3494cadc4027dcc460be1d474a7", "message": "First try: write/read new shunts\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\ncorrection\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\ncorrection non linear shunt\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\ncorrect message error\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "4cf43ac98dc0a5709060070a7688f19f79bc6b23", "url": "https://github.com/powsybl/powsybl-core/commit/4cf43ac98dc0a5709060070a7688f19f79bc6b23", "message": "correct tests\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "da26741e45b058b231e0c7d26728cf8118fa6923", "url": "https://github.com/powsybl/powsybl-core/commit/da26741e45b058b231e0c7d26728cf8118fa6923", "message": "add basic test for non linear shunts\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "b47690c07bce56123912d621b47b075594f20b73", "url": "https://github.com/powsybl/powsybl-core/commit/b47690c07bce56123912d621b47b075594f20b73", "message": "add tests for faulty shunt files\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "5bed1cb2535acd802a8e3286648278d30448b68f", "url": "https://github.com/powsybl/powsybl-core/commit/5bed1cb2535acd802a8e3286648278d30448b68f", "message": "writeModel() throws uncheckedxmlstreamexception\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "ae629fb096868196e9b8985762090a80fd746c2c", "url": "https://github.com/powsybl/powsybl-core/commit/ae629fb096868196e9b8985762090a80fd746c2c", "message": "Second proposition for shunt serialisation\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "ad1f51ee3631b959da18e63843f1cb7b927cccc3", "url": "https://github.com/powsybl/powsybl-core/commit/ad1f51ee3631b959da18e63843f1cb7b927cccc3", "message": "correct tests\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "6438bc2396ee67764b1523c07f0e20c38574075a", "url": "https://github.com/powsybl/powsybl-core/commit/6438bc2396ee67764b1523c07f0e20c38574075a", "message": "Third proposition for shunt XIIDM serializations\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "485c0b2d1a801b95e414082af07d244af6d5f07c", "url": "https://github.com/powsybl/powsybl-core/commit/485c0b2d1a801b95e414082af07d244af6d5f07c", "message": "correct tests\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "fe5f242b9f117d911214419b5c10cec90dd97f47", "url": "https://github.com/powsybl/powsybl-core/commit/fe5f242b9f117d911214419b5c10cec90dd97f47", "message": "apply reviewer comments\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "commit"}, {"oid": "fe5f242b9f117d911214419b5c10cec90dd97f47", "url": "https://github.com/powsybl/powsybl-core/commit/fe5f242b9f117d911214419b5c10cec90dd97f47", "message": "apply reviewer comments\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-04-07T15:29:11Z", "type": "forcePushed"}, {"oid": "5f5c3508d63ea63f0189e90045ecb3acd90db1da", "url": "https://github.com/powsybl/powsybl-core/commit/5f5c3508d63ea63f0189e90045ecb3acd90db1da", "message": "Merge branch 'master' into new_shunt_xml", "committedDate": "2020-04-08T07:27:27Z", "type": "commit"}]}