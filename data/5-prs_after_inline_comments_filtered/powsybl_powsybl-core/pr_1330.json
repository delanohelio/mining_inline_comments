{"pr_number": 1330, "pr_title": "Dynamic curves provider", "pr_createdAt": "2020-05-27T17:33:47Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1330", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2NTEwNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r431365107", "bodyText": "What about naming this class as DynamicSimulationDataProvider or DynamicSimulationInputsProvider ?", "author": "zamarrenolm", "createdAt": "2020-05-27T18:45:53Z", "path": "dynamic-simulation/dynamic-simulation-api/src/main/java/com/powsybl/dynamicsimulation/Provider.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+\n+package com.powsybl.dynamicsimulation;\n+\n+import com.powsybl.iidm.network.Network;\n+\n+import java.util.List;\n+\n+/**\n+ * @author Mathieu Bague <mathieu.bague@rte-france.com>\n+ */\n+public interface Provider<T> {", "originalCommit": "4096bf7a67e092fb48daa0b3d607f973ef2b92ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNjE5NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r431406194", "bodyText": "With @agnesLeroy we think this could be moved in a more common module, so we wouldn't add a Dynamic prefix. Looking to the Javadoc, the good name should be Supplier. The Supplier class is a generic class that have only one method get. In our case, it's the same concept, except that the get method takes one argument.", "author": "mathbagu", "createdAt": "2020-05-27T19:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2NTEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY0MzM4Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r431643386", "bodyText": "We should fix this TODO before merging this PR. @mathbagu did you leave it for @marcosmc to complete?", "author": "agnesLeroy", "createdAt": "2020-05-28T07:45:04Z", "path": "dynamic-simulation/dynamic-simulation-tool/src/main/java/com/powsybl/dynamicsimulation/tool/DynamicSimulationTool.java", "diffHunk": "@@ -118,22 +120,30 @@ public void run(CommandLine line, ToolRunningContext context) throws Exception {\n         }\n \n         context.getOutputStream().println(\"Loading network '\" + caseFile + \"'\");\n-        Properties inputParams = readProperties(line, ConversionToolUtils.OptionType.IMPORT, context);\n+        Properties inputParams = ConversionToolUtils.readProperties(line, ConversionToolUtils.OptionType.IMPORT, context);\n         ImportConfig importConfig = (!skipPostProc) ? ImportConfig.load() : new ImportConfig();\n         Network network = Importers.loadNetwork(caseFile, context.getShortTimeExecutionComputationManager(),\n             importConfig, inputParams);\n         if (network == null) {\n             throw new PowsyblException(\"Case '\" + caseFile + \"' not found\");\n         }\n \n+        DynamicSimulation.Runner runner = DynamicSimulation.find();\n+\n+        CurvesProvider curvesProvider = CurvesProvider.empty();\n+        if (line.hasOption(CURVES_FILE)) {\n+            Path curvesFile = context.getFileSystem().getPath(line.getOptionValue(CURVES_FILE));\n+            curvesProvider = createCurvesProvider(curvesFile, runner.getName());\n+        }\n+\n         DynamicSimulationParameters params = DynamicSimulationParameters.load();\n         if (line.hasOption(PARAMETERS_FILE)) {\n             Path parametersFile = context.getFileSystem().getPath(line.getOptionValue(PARAMETERS_FILE));\n             JsonDynamicSimulationParameters.update(params, parametersFile);\n         }\n \n-        DynamicSimulationResult result = DynamicSimulation.run(network,\n-            context.getShortTimeExecutionComputationManager(), params);\n+        // TODO: use the curvesProvider", "originalCommit": "a21533259797c2eeaeec5d536ba5bc76823af1ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3NjQ3MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r431676470", "bodyText": "Done.", "author": "marcosmc", "createdAt": "2020-05-28T08:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY0MzM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxNDk3MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r431714971", "bodyText": "@marcosmc In this class we would like to have all the combinations of possible calls of run and runAsync. Could you add them? There are 11 possibilities aside from the one you've done here to provide. Let me know if it's unclear to you.", "author": "agnesLeroy", "createdAt": "2020-05-28T09:49:23Z", "path": "dynamic-simulation/dynamic-simulation-api/src/main/java/com/powsybl/dynamicsimulation/DynamicSimulation.java", "diffHunk": "@@ -71,6 +71,11 @@ public DynamicSimulationResult run(Network network, CurvesProvider curvesProvide\n             return runAsync(network, curvesProvider, workingVariantId, computationManager, parameters).join();\n         }\n \n+        public DynamicSimulationResult run(Network network, CurvesProvider curvesProvider, ComputationManager computationManager,\n+            DynamicSimulationParameters parameters) {\n+            return run(network, curvesProvider, network.getVariantManager().getWorkingVariantId(), computationManager, parameters);\n+        }\n+", "originalCommit": "c5d89351d2032fe909bbf15b0739c29111043f60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgyODg0MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r431828840", "bodyText": "Done", "author": "marcosmc", "createdAt": "2020-05-28T13:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxNDk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU3MzE2OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r434573168", "bodyText": "Here it seems computationManager and workingVariantId are inverted", "author": "agnesLeroy", "createdAt": "2020-06-03T13:39:01Z", "path": "dynamic-simulation/dynamic-simulation-api/src/main/java/com/powsybl/dynamicsimulation/DynamicSimulation.java", "diffHunk": "@@ -32,43 +32,70 @@ public Runner(DynamicSimulationProvider provider) {\n             this.provider = Objects.requireNonNull(provider);\n         }\n \n-        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, String workingStateId,\n-            ComputationManager computationManager, DynamicSimulationParameters parameters) {\n-            Objects.requireNonNull(workingStateId);\n-            Objects.requireNonNull(parameters);\n-            return provider.run(network, computationManager, workingStateId, parameters);\n+        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, CurvesSupplier curvesSupplier, String workingVariantId,\n+                                                                   ComputationManager computationManager, DynamicSimulationParameters parameters) {\n+            return provider.run(network, curvesSupplier, computationManager, workingVariantId, parameters);", "originalCommit": "03501fff117c402fc404686506c83f7f99409338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU3NTI5OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r434575298", "bodyText": "Here shouldn't we return run(network, CurvesSuplier.empty(), workingVariantId, computationManager, parameters) instead?", "author": "agnesLeroy", "createdAt": "2020-06-03T13:41:25Z", "path": "dynamic-simulation/dynamic-simulation-api/src/main/java/com/powsybl/dynamicsimulation/DynamicSimulation.java", "diffHunk": "@@ -32,43 +32,70 @@ public Runner(DynamicSimulationProvider provider) {\n             this.provider = Objects.requireNonNull(provider);\n         }\n \n-        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, String workingStateId,\n-            ComputationManager computationManager, DynamicSimulationParameters parameters) {\n-            Objects.requireNonNull(workingStateId);\n-            Objects.requireNonNull(parameters);\n-            return provider.run(network, computationManager, workingStateId, parameters);\n+        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, CurvesSupplier curvesSupplier, String workingVariantId,\n+                                                                   ComputationManager computationManager, DynamicSimulationParameters parameters) {\n+            return provider.run(network, curvesSupplier, computationManager, workingVariantId, parameters);\n         }\n \n-        public CompletableFuture<DynamicSimulationResult> runAsync(Network network,\n-            ComputationManager computationManager, DynamicSimulationParameters parameters) {\n+        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, String workingVariantId, ComputationManager computationManager,\n+                                                                   DynamicSimulationParameters parameters) {\n+            return runAsync(network, CurvesSupplier.empty(), workingVariantId, computationManager, parameters);\n+        }\n+\n+        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, CurvesSupplier curvesSupplier, ComputationManager computationManager,\n+                                                                   DynamicSimulationParameters parameters) {\n+            return runAsync(network, curvesSupplier, network.getVariantManager().getWorkingVariantId(), computationManager, parameters);\n+        }\n+\n+        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, ComputationManager computationManager, DynamicSimulationParameters parameters) {\n             return runAsync(network, network.getVariantManager().getWorkingVariantId(), computationManager, parameters);\n         }\n \n-        public CompletableFuture<DynamicSimulationResult> runAsync(Network network,\n-            DynamicSimulationParameters parameters) {\n+        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, CurvesSupplier curvesSupplier, DynamicSimulationParameters parameters) {\n+            return runAsync(network, curvesSupplier, LocalComputationManager.getDefault(), parameters);\n+        }\n+\n+        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, DynamicSimulationParameters parameters) {\n             return runAsync(network, LocalComputationManager.getDefault(), parameters);\n         }\n \n+        public CompletableFuture<DynamicSimulationResult> runAsync(Network network, CurvesSupplier curvesSupplier) {\n+            return runAsync(network, curvesSupplier, DynamicSimulationParameters.load());\n+        }\n+\n         public CompletableFuture<DynamicSimulationResult> runAsync(Network network) {\n             return runAsync(network, DynamicSimulationParameters.load());\n         }\n \n-        public DynamicSimulationResult run(Network network, String workingStateId,\n-            ComputationManager computationManager, DynamicSimulationParameters parameters) {\n-            Objects.requireNonNull(workingStateId);\n-            Objects.requireNonNull(parameters);\n-            return provider.run(network, computationManager, workingStateId, parameters).join();\n+        public DynamicSimulationResult run(Network network, CurvesSupplier curvesSupplier, String workingVariantId, ComputationManager computationManager,\n+                                           DynamicSimulationParameters parameters) {\n+            return runAsync(network, curvesSupplier, workingVariantId, computationManager, parameters).join();\n         }\n \n-        public DynamicSimulationResult run(Network network, ComputationManager computationManager,\n-            DynamicSimulationParameters parameters) {\n+        public DynamicSimulationResult run(Network network, String workingVariantId, ComputationManager computationManager, DynamicSimulationParameters parameters) {\n+            return runAsync(network, workingVariantId, computationManager, parameters).join();", "originalCommit": "03501fff117c402fc404686506c83f7f99409338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU3Nzg2MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r434577861", "bodyText": "We also need all the run and runAsync combinations in this part of the file please.", "author": "agnesLeroy", "createdAt": "2020-06-03T13:44:57Z", "path": "dynamic-simulation/dynamic-simulation-api/src/main/java/com/powsybl/dynamicsimulation/DynamicSimulation.java", "diffHunk": "@@ -113,9 +140,9 @@ public static Runner find() {\n         return find().runAsync(network);\n     }\n ", "originalCommit": "03501fff117c402fc404686506c83f7f99409338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91c86db42ccb58503ace0ffa4dd1defac5c1d8bf", "url": "https://github.com/powsybl/powsybl-core/commit/91c86db42ccb58503ace0ffa4dd1defac5c1d8bf", "message": "Curves management for dynamic simulation\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-05T09:46:27Z", "type": "commit"}, {"oid": "91c86db42ccb58503ace0ffa4dd1defac5c1d8bf", "url": "https://github.com/powsybl/powsybl-core/commit/91c86db42ccb58503ace0ffa4dd1defac5c1d8bf", "message": "Curves management for dynamic simulation\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-05T09:46:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzNjU1MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r435836550", "bodyText": "Just a question about the semantics of the Versionable interface.\nI assume the name and version strings returned by a DynamicSimulationProvider should be interpreted as the name and version of the external simulator that this provider is integrating in PowSyBl ?\nFor example for Dynawo, getName() would return \"Dynawo\" and getVersion() \"1.1.0\".\nOr should it be related to a specific version of the provider, internal to powsybl, and used consistently for later potential updates of the same \"kind\" of provider ?\nAs an example: we start with a Dynawo provider with version \"1\" that connects only with Dynawo 1.1.0. Later we create an updated Dynawo provider, version \"2\", that is able to connect with multiple versions of Dynawo, starting from 1.1.x and up to Dynawo 2.0.0.\nHow the version attribute is planned to be used in PowSyBl ?", "author": "zamarrenolm", "createdAt": "2020-06-05T10:35:06Z", "path": "dynamic-simulation/dynamic-simulation-api/src/main/java/com/powsybl/dynamicsimulation/DynamicSimulationProvider.java", "diffHunk": "@@ -18,6 +18,6 @@\n  */\n public interface DynamicSimulationProvider extends Versionable, PlatformConfigNamedProvider {", "originalCommit": "91c86db42ccb58503ace0ffa4dd1defac5c1d8bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkyODI0NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1330#discussion_r435928244", "bodyText": "No idea how we'll use it in powsybl. From my point of view, the provider should use this to ensure that it is compatible with the binary it will run. It's how we use it in RTE for Hades2.\nBut I don't know if we already discuss (and agree) on how it will be used. Versionable is a really old interface... coming from iTesla project.", "author": "mathbagu", "createdAt": "2020-06-05T13:40:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzNjU1MA=="}], "type": "inlineReview"}]}