{"pr_number": 1088, "pr_title": "[IPC Part 1] Separate communication logic from business logic", "pr_createdAt": "2020-10-21T00:39:38Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088", "timeline": [{"oid": "6676ed14a4d684272ba30ffa4b4a5c334e1173cc", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6676ed14a4d684272ba30ffa4b4a5c334e1173cc", "message": "[Part 1] Separate communication logic from business logic", "committedDate": "2020-10-21T00:37:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDg5Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509464896", "bodyText": "Pretty sure that this should implement an interface.", "author": "AdamBJohnsonx", "createdAt": "2020-10-21T17:17:22Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/BoundServiceClient.java", "diffHunk": "@@ -0,0 +1,156 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.broker;\n+\n+import android.content.Context;\n+import android.content.Intent;\n+import android.content.pm.ResolveInfo;\n+import android.os.Bundle;\n+import android.os.IInterface;\n+import android.os.RemoteException;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.ClientException;\n+import com.microsoft.identity.common.internal.broker.ipc.BrokerOperationBundle;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import static com.microsoft.identity.common.exception.ClientException.BOUND_SERVICE_UNAVAILABLE_OR_NOT_SUPPORTED;\n+\n+/**\n+ * Base class for a Bound Service client.\n+ * A separate client is required for each AIDL interface (android.os.IInterface)\n+ */\n+public abstract class BoundServiceClient {", "originalCommit": "fb01abf72670c70dbc70fb7ad0e6f98cf85f26a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ5NDkxOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509494918", "bodyText": "This is different from the strategy. Given the nature of bound service (we're not passing a 'flag' inside the bundle, but we'll be picking a method to call), we can't truly make the ipc strategy generic.\ntherefore, I'm extracting the 'client' part out of the strategy. each .aidl (interface) file will have its own client.", "author": "rpdome", "createdAt": "2020-10-21T17:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYwOTIxNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509609216", "bodyText": "I'm not sure what being generic has to do with implementing an interface.   Just that most classes should implement some interface, and since this is an abstract class, I assume that means that somewhere in the code you'll be referencing it by name... and in that spot we should reference its interface instead of any implentation, even an abstract one, unless there's some very powerful reason to care about the implementation.", "author": "AdamBJohnsonx", "createdAt": "2020-10-21T19:29:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgyMjk2Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509822966", "bodyText": "I don't think it's likely important.", "author": "AdamBJohnsonx", "createdAt": "2020-10-22T01:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2Nzg2MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509467860", "bodyText": "Can we just use a SettableFuture here?", "author": "AdamBJohnsonx", "createdAt": "2020-10-21T17:20:22Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/BoundServiceFuture.java", "diffHunk": "@@ -23,18 +23,24 @@\n \n package com.microsoft.identity.common.internal.broker;\n \n-import com.microsoft.identity.client.IMicrosoftAuthService;\n+import android.os.IInterface;\n+\n+import androidx.annotation.NonNull;\n \n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.ExecutionException;\n import java.util.concurrent.Future;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.TimeoutException;\n \n-public class MicrosoftAuthServiceFuture implements Future<IMicrosoftAuthService> {\n+/**\n+ * A Future object for bound service.\n+ * Will block until a bound service connection is established.\n+ */\n+public class BoundServiceFuture implements Future<IInterface> {", "originalCommit": "fb01abf72670c70dbc70fb7ad0e6f98cf85f26a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUxMDM1OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509510358", "bodyText": "by importing com.google.guava:guava:28.1-android, yes.", "author": "rpdome", "createdAt": "2020-10-21T17:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2Nzg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUxMzc5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509513790", "bodyText": "(although I don't think it's worth it for one-time use - since this will also inflate the customer's apk size).", "author": "rpdome", "createdAt": "2020-10-21T17:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2Nzg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTU4MDU1OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509580558", "bodyText": "I was more thinking androidx.  I guess the point is that it adds a class for them, period, whereas if they used one of these other libraries there would be no incremental increase in number of classes.  But I'll bet our avoidance of it has led to multiple implementations.  I know of at least 2, now.", "author": "AdamBJohnsonx", "createdAt": "2020-10-21T18:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2Nzg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgwOTY0Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509809647", "bodyText": "replaced BoundServiceFuture with common's ResultFuture", "author": "rpdome", "createdAt": "2020-10-22T00:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2Nzg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYzOTQ0MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509639441", "bodyText": "This thing is a Chain. https://en.wikipedia.org/wiki/Chain-of-responsibility_pattern", "author": "AdamBJohnsonx", "createdAt": "2020-10-21T20:03:33Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BrokerOperationExecutor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.controllers;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.exception.ClientException;\n+import com.microsoft.identity.common.exception.ErrorStrings;\n+import com.microsoft.identity.common.internal.broker.ipc.IIpcStrategy;\n+import com.microsoft.identity.common.internal.broker.ipc.BrokerOperationBundle;\n+import com.microsoft.identity.common.internal.commands.parameters.CommandParameters;\n+import com.microsoft.identity.common.internal.telemetry.Telemetry;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiEndEvent;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiStartEvent;\n+\n+import java.util.List;\n+\n+/**\n+ * Classes for executing Broker operations.\n+ * It takes in a list of IIpcStrategy, and will try to connect to the broker with each strategy. one by one.\n+ * - If the current strategy succeeds, it will return the result right away.\n+ * - If the current strategy fails due to an internal Broker error, it will return the result right away.\n+ * - If the current strategy fails to connect to the broker, it will try the next one until the list is exhausted.\n+ */\n+public class BrokerOperationExecutor {", "originalCommit": "fb01abf72670c70dbc70fb7ad0e6f98cf85f26a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxOTEwNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509819104", "bodyText": "OK, so I know what's been bothering me about this. Typically these would be Handlers (BoundServiceHandler, etc.) and then this would be a BrokerOperationHandlerChain where we'd try the handlers in sequence until one worked.  Because we're not selecting a strategy, we're trying a bunch of them until one works.  It's not a big difference, really, so it's not a hill worth dying on.", "author": "AdamBJohnsonx", "createdAt": "2020-10-22T01:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYzOTQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY0NzI5OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509647298", "bodyText": "Can we keep all of them and dump them all if we fail?  More modern java has fancy methods for this by attaching suppressed exceptions to other exceptions, but we should try to do something.", "author": "AdamBJohnsonx", "createdAt": "2020-10-21T20:10:46Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BrokerOperationExecutor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.controllers;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.exception.ClientException;\n+import com.microsoft.identity.common.exception.ErrorStrings;\n+import com.microsoft.identity.common.internal.broker.ipc.IIpcStrategy;\n+import com.microsoft.identity.common.internal.broker.ipc.BrokerOperationBundle;\n+import com.microsoft.identity.common.internal.commands.parameters.CommandParameters;\n+import com.microsoft.identity.common.internal.telemetry.Telemetry;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiEndEvent;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiStartEvent;\n+\n+import java.util.List;\n+\n+/**\n+ * Classes for executing Broker operations.\n+ * It takes in a list of IIpcStrategy, and will try to connect to the broker with each strategy. one by one.\n+ * - If the current strategy succeeds, it will return the result right away.\n+ * - If the current strategy fails due to an internal Broker error, it will return the result right away.\n+ * - If the current strategy fails to connect to the broker, it will try the next one until the list is exhausted.\n+ */\n+public class BrokerOperationExecutor {\n+\n+    private static final String TAG = BrokerOperationExecutor.class.getSimpleName();\n+\n+    /**\n+     * Info of a broker operation to be performed with available strategies.\n+     */\n+    public interface BrokerOperation<T> {\n+\n+        /**\n+         * Trigger any prerequisite works before making the actual request.\n+         * This was added because the existing MSAL-Broker logic has a separate hello() call.\n+         */\n+        void performPrerequisites(@NonNull IIpcStrategy strategy) throws BaseException;\n+\n+        /**\n+         * Gets a BrokerOperationBundle bundle to pass to each IpcStrategies.\n+         */\n+        @NonNull BrokerOperationBundle getBundle();\n+\n+        /**\n+         * Extracts the result object from a bundle returned by an IpcStrategy.\n+         * If the broker returns an error, this will throw an exception.\n+         */\n+        @NonNull T extractResultBundle(@Nullable final Bundle resultBundle) throws BaseException;\n+\n+        /**\n+         * Returns method name (for logging/telemetry purpose).\n+         */\n+        @NonNull String getMethodName();\n+\n+        /**\n+         * ID of the telemetry API event associated to this strategy task.\n+         * If this value returns null, no telemetry event will be emitted.\n+         */\n+        @Nullable String getTelemetryApiId();\n+\n+        /**\n+         * A method that will be invoked before the success event is emitted.\n+         * If the calling operation wants to put any value in the success event, put it here.\n+         */\n+        void putValueInSuccessEvent(ApiEndEvent event, T result);\n+    }\n+\n+    private final List<IIpcStrategy> mStrategies;\n+\n+    /**\n+     * @param strategies list of IIpcStrategy to be invoked.\n+     */\n+    public BrokerOperationExecutor(@NonNull final List<IIpcStrategy> strategies) {\n+        mStrategies = strategies;\n+    }\n+\n+    /**\n+     * A generic method that would initialize and iterate through available strategies.\n+     * It will return a result immediately if any of the strategy succeeds, or throw an exception if all of the strategies fails.\n+     */\n+    public <T extends CommandParameters, U> U execute(@NonNull final T parameters,\n+                                                      @NonNull final BrokerOperation<U> operation)\n+            throws BaseException {\n+\n+        if (operation.getTelemetryApiId() != null) {\n+            Telemetry.emit(\n+                    new ApiStartEvent()\n+                            .putProperties(parameters)\n+                            .putApiId(operation.getTelemetryApiId())\n+            );\n+        }\n+\n+        U result = null;\n+        Exception lastCaughtException = null;\n+        for (int ii = 0; ii < mStrategies.size(); ii++) {\n+            final IIpcStrategy strategy = mStrategies.get(ii);\n+            try {\n+                com.microsoft.identity.common.internal.logging.Logger.info(\n+                        TAG + operation.getMethodName(),\n+                        \"Executing with broker strategy: \"\n+                                + strategy.getClass().getSimpleName()\n+                );\n+\n+                operation.performPrerequisites(strategy);\n+\n+                final BrokerOperationBundle brokerOperationBundle = operation.getBundle();\n+                final Bundle resultBundle = strategy.communicateToBroker(brokerOperationBundle);\n+                result = operation.extractResultBundle(resultBundle);\n+\n+                break;\n+            } catch (final BrokerCommunicationException communicationException) {\n+                // These are known Broker communication exception. Try next strategy.\n+                lastCaughtException = communicationException;\n+            } catch (final BaseException exception) {\n+                // MSAL is aware of these exceptions. throw.\n+                if (operation.getTelemetryApiId() != null) {\n+                    Telemetry.emit(\n+                            new ApiEndEvent()\n+                                    .putException(exception)\n+                                    .putApiId(operation.getTelemetryApiId())\n+                    );\n+                }\n+                throw exception;\n+            } catch (final Exception exception) {\n+                // We know for a fact that in some OEM, bind service might throw a runtime exception.\n+                // Given that the type of exception here could be unpredictable,\n+                // it is better to catch 'every' exception so that we could try the next strategy - which could work.\n+                lastCaughtException = exception;", "originalCommit": "fb01abf72670c70dbc70fb7ad0e6f98cf85f26a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MjcyNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510492727", "bodyText": "I'll put them in a list. if we fail all strategies, then i'l log all BrokerCommunicationException and return a ClientException without any internal exception object. I'll specify that if you want to see why it fails, please refer to MSAL logs.", "author": "rpdome", "createdAt": "2020-10-22T22:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY0NzI5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxMzU3Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509813577", "bodyText": "Should we have these comments here?", "author": "AdamBJohnsonx", "createdAt": "2020-10-22T00:40:02Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/BrokerOperationBundle.java", "diffHunk": "@@ -0,0 +1,78 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import lombok.Getter;\n+\n+/**\n+ * An object that acts as a bridge between business logic and communication layer.\n+ * - Business logic will provide a request bundle, and specify which operation it wants to perform.\n+ * - Communication layer will determine how to communicate to the broker via the provided operation,\n+ * and pass the request bundle to the broker accordingly.\n+ */\n+public class BrokerOperationBundle {\n+\n+    public enum Operation {\n+        MSAL_HELLO,\n+        MSAL_GET_INTENT_FOR_INTERACTIVE_REQUEST,\n+        MSAL_ACQUIRE_TOKEN_SILENT,\n+        MSAL_GET_ACCOUNTS,\n+        MSAL_REMOVE_ACCOUNT,\n+        MSAL_GET_DEVICE_MODE,\n+        MSAL_GET_CURRENT_ACCOUNT_IN_SHARED_DEVICE,\n+        MSAL_SIGN_OUT_FROM_SHARED_DEVICE,\n+        BROKER_CONNECT_TO_INACTIVE_BROKER\n+    }\n+\n+    @Getter\n+    @NonNull\n+    final private Operation operation;\n+\n+    @Getter\n+    @Nullable\n+    final private Bundle bundle;\n+\n+    public BrokerOperationBundle(@NonNull final Operation operation,\n+                                 @Nullable final Bundle requestBundle) {\n+        this.operation = operation;\n+        this.bundle = requestBundle;\n+    }\n+\n+    public String getOperationName() {\n+        return this.operation.name();\n+    }\n+\n+//    public String getAccountManagerOperationKey(){\n+//        // TODO\n+//    }\n+//\n+//    public String getContentProviderUriPath(){\n+//        // TODO\n+//    }", "originalCommit": "3385547f1b6af5a712e93d475397c23326e3c5c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5ODI4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510398284", "bodyText": "These will be added in the next PRs.... so ... more like a reminder for myself (That the work in common is not done until these are implemented).", "author": "rpdome", "createdAt": "2020-10-22T19:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxMzU3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNDM2OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509814369", "bodyText": "So here, we'd dump all of the exception information.", "author": "AdamBJohnsonx", "createdAt": "2020-10-22T00:43:02Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BrokerOperationExecutor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.controllers;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.exception.ClientException;\n+import com.microsoft.identity.common.exception.ErrorStrings;\n+import com.microsoft.identity.common.internal.broker.ipc.IIpcStrategy;\n+import com.microsoft.identity.common.internal.broker.ipc.BrokerOperationBundle;\n+import com.microsoft.identity.common.internal.commands.parameters.CommandParameters;\n+import com.microsoft.identity.common.internal.telemetry.Telemetry;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiEndEvent;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiStartEvent;\n+\n+import java.util.List;\n+\n+/**\n+ * Classes for executing Broker operations.\n+ * It takes in a list of IIpcStrategy, and will try to connect to the broker with each strategy. one by one.\n+ * - If the current strategy succeeds, it will return the result right away.\n+ * - If the current strategy fails due to an internal Broker error, it will return the result right away.\n+ * - If the current strategy fails to connect to the broker, it will try the next one until the list is exhausted.\n+ */\n+public class BrokerOperationExecutor {\n+\n+    private static final String TAG = BrokerOperationExecutor.class.getSimpleName();\n+\n+    /**\n+     * Info of a broker operation to be performed with available strategies.\n+     */\n+    public interface BrokerOperation<T> {\n+\n+        /**\n+         * Trigger any prerequisite works before making the actual request.\n+         * This was added because the existing MSAL-Broker logic has a separate hello() call.\n+         */\n+        void performPrerequisites(@NonNull IIpcStrategy strategy) throws BaseException;\n+\n+        /**\n+         * Gets a BrokerOperationBundle bundle to pass to each IpcStrategies.\n+         */\n+        @NonNull BrokerOperationBundle getBundle();\n+\n+        /**\n+         * Extracts the result object from a bundle returned by an IpcStrategy.\n+         * If the broker returns an error, this will throw an exception.\n+         */\n+        @NonNull T extractResultBundle(@Nullable final Bundle resultBundle) throws BaseException;\n+\n+        /**\n+         * Returns method name (for logging/telemetry purpose).\n+         */\n+        @NonNull String getMethodName();\n+\n+        /**\n+         * ID of the telemetry API event associated to this strategy task.\n+         * If this value returns null, no telemetry event will be emitted.\n+         */\n+        @Nullable String getTelemetryApiId();\n+\n+        /**\n+         * A method that will be invoked before the success event is emitted.\n+         * If the calling operation wants to put any value in the success event, put it here.\n+         */\n+        void putValueInSuccessEvent(ApiEndEvent event, T result);\n+    }\n+\n+    private final List<IIpcStrategy> mStrategies;\n+\n+    /**\n+     * @param strategies list of IIpcStrategy to be invoked.\n+     */\n+    public BrokerOperationExecutor(@NonNull final List<IIpcStrategy> strategies) {\n+        mStrategies = strategies;\n+    }\n+\n+    /**\n+     * A generic method that would initialize and iterate through available strategies.\n+     * It will return a result immediately if any of the strategy succeeds, or throw an exception if all of the strategies fails.\n+     */\n+    public <T extends CommandParameters, U> U execute(@NonNull final T parameters,\n+                                                      @NonNull final BrokerOperation<U> operation)\n+            throws BaseException {\n+\n+        if (operation.getTelemetryApiId() != null) {\n+            Telemetry.emit(\n+                    new ApiStartEvent()\n+                            .putProperties(parameters)\n+                            .putApiId(operation.getTelemetryApiId())\n+            );\n+        }\n+\n+        U result = null;\n+        Exception lastCaughtException = null;\n+        for (int ii = 0; ii < mStrategies.size(); ii++) {\n+            final IIpcStrategy strategy = mStrategies.get(ii);\n+            try {\n+                com.microsoft.identity.common.internal.logging.Logger.info(\n+                        TAG + operation.getMethodName(),\n+                        \"Executing with broker strategy: \"\n+                                + strategy.getClass().getSimpleName()\n+                );\n+\n+                operation.performPrerequisites(strategy);\n+\n+                final BrokerOperationBundle brokerOperationBundle = operation.getBundle();\n+                final Bundle resultBundle = strategy.communicateToBroker(brokerOperationBundle);\n+                result = operation.extractResultBundle(resultBundle);\n+\n+                break;\n+            } catch (final BrokerCommunicationException communicationException) {\n+                // These are known Broker communication exception. Try next strategy.\n+                lastCaughtException = communicationException;\n+            } catch (final BaseException exception) {\n+                // MSAL is aware of these exceptions. throw.\n+                if (operation.getTelemetryApiId() != null) {\n+                    Telemetry.emit(\n+                            new ApiEndEvent()\n+                                    .putException(exception)\n+                                    .putApiId(operation.getTelemetryApiId())\n+                    );\n+                }\n+                throw exception;\n+            } catch (final Exception exception) {\n+                // We know for a fact that in some OEM, bind service might throw a runtime exception.\n+                // Given that the type of exception here could be unpredictable,\n+                // it is better to catch 'every' exception so that we could try the next strategy - which could work.\n+                lastCaughtException = exception;\n+            }\n+        }\n+\n+        // This means that we've tried every strategies...\n+        if (result == null) {\n+            final ClientException exception = new ClientException(\n+                    ErrorStrings.BROKER_BIND_SERVICE_FAILED,\n+                    \"Unable to connect to the broker\",\n+                    lastCaughtException);", "originalCommit": "3385547f1b6af5a712e93d475397c23326e3c5c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTEwOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509815109", "bodyText": "Can we give them a getName()?", "author": "AdamBJohnsonx", "createdAt": "2020-10-22T00:45:49Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/IIpcStrategy.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+\n+/**\n+ * an interface for inter-process communication strategies.\n+ */\n+public interface IIpcStrategy {", "originalCommit": "3385547f1b6af5a712e93d475397c23326e3c5c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4Nzg0NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510487845", "bodyText": "I'll make this as part of the ests telemetry work.", "author": "rpdome", "createdAt": "2020-10-22T22:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTY3OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r509815679", "bodyText": "Here we can time the strategy execution from outside, by using the getName() method which, for bonus points, is by contract the telemetry name.", "author": "AdamBJohnsonx", "createdAt": "2020-10-22T00:48:00Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BrokerOperationExecutor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.controllers;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.exception.ClientException;\n+import com.microsoft.identity.common.exception.ErrorStrings;\n+import com.microsoft.identity.common.internal.broker.ipc.IIpcStrategy;\n+import com.microsoft.identity.common.internal.broker.ipc.BrokerOperationBundle;\n+import com.microsoft.identity.common.internal.commands.parameters.CommandParameters;\n+import com.microsoft.identity.common.internal.telemetry.Telemetry;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiEndEvent;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiStartEvent;\n+\n+import java.util.List;\n+\n+/**\n+ * Classes for executing Broker operations.\n+ * It takes in a list of IIpcStrategy, and will try to connect to the broker with each strategy. one by one.\n+ * - If the current strategy succeeds, it will return the result right away.\n+ * - If the current strategy fails due to an internal Broker error, it will return the result right away.\n+ * - If the current strategy fails to connect to the broker, it will try the next one until the list is exhausted.\n+ */\n+public class BrokerOperationExecutor {\n+\n+    private static final String TAG = BrokerOperationExecutor.class.getSimpleName();\n+\n+    /**\n+     * Info of a broker operation to be performed with available strategies.\n+     */\n+    public interface BrokerOperation<T> {\n+\n+        /**\n+         * Trigger any prerequisite works before making the actual request.\n+         * This was added because the existing MSAL-Broker logic has a separate hello() call.\n+         */\n+        void performPrerequisites(@NonNull IIpcStrategy strategy) throws BaseException;\n+\n+        /**\n+         * Gets a BrokerOperationBundle bundle to pass to each IpcStrategies.\n+         */\n+        @NonNull BrokerOperationBundle getBundle();\n+\n+        /**\n+         * Extracts the result object from a bundle returned by an IpcStrategy.\n+         * If the broker returns an error, this will throw an exception.\n+         */\n+        @NonNull T extractResultBundle(@Nullable final Bundle resultBundle) throws BaseException;\n+\n+        /**\n+         * Returns method name (for logging/telemetry purpose).\n+         */\n+        @NonNull String getMethodName();\n+\n+        /**\n+         * ID of the telemetry API event associated to this strategy task.\n+         * If this value returns null, no telemetry event will be emitted.\n+         */\n+        @Nullable String getTelemetryApiId();\n+\n+        /**\n+         * A method that will be invoked before the success event is emitted.\n+         * If the calling operation wants to put any value in the success event, put it here.\n+         */\n+        void putValueInSuccessEvent(ApiEndEvent event, T result);\n+    }\n+\n+    private final List<IIpcStrategy> mStrategies;\n+\n+    /**\n+     * @param strategies list of IIpcStrategy to be invoked.\n+     */\n+    public BrokerOperationExecutor(@NonNull final List<IIpcStrategy> strategies) {\n+        mStrategies = strategies;\n+    }\n+\n+    /**\n+     * A generic method that would initialize and iterate through available strategies.\n+     * It will return a result immediately if any of the strategy succeeds, or throw an exception if all of the strategies fails.\n+     */\n+    public <T extends CommandParameters, U> U execute(@NonNull final T parameters,\n+                                                      @NonNull final BrokerOperation<U> operation)\n+            throws BaseException {\n+\n+        if (operation.getTelemetryApiId() != null) {\n+            Telemetry.emit(\n+                    new ApiStartEvent()\n+                            .putProperties(parameters)\n+                            .putApiId(operation.getTelemetryApiId())\n+            );\n+        }\n+\n+        U result = null;\n+        Exception lastCaughtException = null;\n+        for (int ii = 0; ii < mStrategies.size(); ii++) {\n+            final IIpcStrategy strategy = mStrategies.get(ii);", "originalCommit": "3385547f1b6af5a712e93d475397c23326e3c5c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4NzgyNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510487824", "bodyText": "I'll make this as part of the ests telemetry work.", "author": "rpdome", "createdAt": "2020-10-22T22:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTY3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwNjMxMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510506310", "bodyText": "We have API 19+, right?  We can add all the exceptions that you caught in this processed as suppressedExceptions to the exception that you throw by calling addSuppressed(e) on it.", "author": "AdamBJohnsonx", "createdAt": "2020-10-22T23:06:28Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BrokerOperationExecutor.java", "diffHunk": "@@ -0,0 +1,203 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.controllers;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.exception.ClientException;\n+import com.microsoft.identity.common.exception.ErrorStrings;\n+import com.microsoft.identity.common.internal.broker.ipc.IIpcStrategy;\n+import com.microsoft.identity.common.internal.broker.ipc.BrokerOperationBundle;\n+import com.microsoft.identity.common.internal.commands.parameters.CommandParameters;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.telemetry.Telemetry;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiEndEvent;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiStartEvent;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Classes for executing IPC service operations.\n+ * It takes in a list of IIpcStrategy, and will try to connect to the broker with each strategy. one by one.\n+ * - If the current strategy succeeds, it will return the result right away.\n+ * - If the service returns an error, it will return the result right away.\n+ * - If the current strategy fails to connect to the targeted service, it will try the next one until the list is exhausted.\n+ */\n+public class BrokerOperationExecutor {\n+\n+    private static final String TAG = BrokerOperationExecutor.class.getSimpleName();\n+\n+    /**\n+     * Info of a service operation to be performed with available strategies.\n+     */\n+    public interface BrokerOperation<T> {\n+\n+        /**\n+         * Trigger any prerequisite works before making the actual request.\n+         * This was added because the existing MSAL-Broker logic has a separate hello() call.\n+         */\n+        void performPrerequisites(@NonNull IIpcStrategy strategy) throws BaseException;\n+\n+        /**\n+         * Gets a BrokerOperationBundle bundle to pass to each IpcStrategies.\n+         */\n+        @NonNull BrokerOperationBundle getBundle();\n+\n+        /**\n+         * Extracts the result object from a bundle returned by an IpcStrategy.\n+         * If the broker returns an error, this will throw an exception.\n+         */\n+        @NonNull T extractResultBundle(@Nullable final Bundle resultBundle) throws BaseException;\n+\n+        /**\n+         * Returns method name (for logging/telemetry purpose).\n+         */\n+        @NonNull String getMethodName();\n+\n+        /**\n+         * ID of the telemetry API event associated to this strategy task.\n+         * If this value returns null, no telemetry event will be emitted.\n+         */\n+        @Nullable String getTelemetryApiId();\n+\n+        /**\n+         * A method that will be invoked before the success event is emitted.\n+         * If the calling operation wants to put any value in the success event, put it here.\n+         */\n+        void putValueInSuccessEvent(ApiEndEvent event, T result);\n+    }\n+\n+    private final List<IIpcStrategy> mStrategies;\n+\n+    /**\n+     * @param strategies list of IIpcStrategy to be invoked.\n+     */\n+    public BrokerOperationExecutor(@NonNull final List<IIpcStrategy> strategies) {\n+        mStrategies = strategies;\n+    }\n+\n+    /**\n+     * A generic method that would initialize and iterate through available strategies.\n+     * It will return a result immediately if any of the strategy succeeds, or throw an exception if all of the strategies fails.\n+     */\n+    public <T extends CommandParameters, U> U execute(@NonNull final T parameters,\n+                                                      @NonNull final BrokerOperation<U> operation)\n+            throws BaseException {\n+        final String methodName = \":execute\";\n+\n+        emitOperationStartEvent(parameters, operation);\n+\n+        if (mStrategies.size() == 0) {\n+            final ClientException exception = new ClientException(\n+                    ErrorStrings.BROKER_BIND_SERVICE_FAILED,\n+                    \"No strategies can be used to connect to the broker.\");\n+            emitOperationFailureEvent(operation, exception);\n+            throw exception;\n+        }\n+\n+        final List<BrokerCommunicationException> communicationExceptionStack = new ArrayList<>();\n+        for (final IIpcStrategy strategy : mStrategies) {\n+            try {\n+                final U result = performStrategy(strategy, operation);\n+                emitOperationSuccessEvent(operation, result);\n+                return result;\n+            } catch (final BrokerCommunicationException communicationException) {\n+                // Fails to communicate to the . Try next strategy.\n+                communicationExceptionStack.add(communicationException);\n+            } catch (final BaseException exception) {\n+                emitOperationFailureEvent((BrokerOperation<U>) operation, exception);\n+                throw exception;\n+            }\n+        }\n+\n+        // This means that we've tried every strategies... log everything...\n+        for (final BrokerCommunicationException e : communicationExceptionStack) {\n+            Logger.error(TAG + methodName, e.getMessage(), e);\n+        }\n+        final ClientException exception = new ClientException(", "originalCommit": "eb93cb55a2bf851e5adac4c23fe7716b2fbf1bd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwODk4MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510508981", "bodyText": "min is 16. I could add this\nif (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\nexception.addSuppressed(e);\n}", "author": "rpdome", "createdAt": "2020-10-22T23:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwNjMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwNzQ3NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510507474", "bodyText": "nit: @AllArgsConstructor?", "author": "AdamBJohnsonx", "createdAt": "2020-10-22T23:10:35Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/BrokerOperationBundle.java", "diffHunk": "@@ -0,0 +1,79 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import lombok.Getter;\n+\n+/**\n+ * An object that acts as a bridge between business logic and communication layer.\n+ * - Business logic will provide a request bundle, and specify which operation it wants to perform.\n+ * - Communication layer will determine how to communicate to the targeted service via the provided operation,\n+ * and pass the request bundle to the service accordingly.\n+ * <p>\n+ * Generally, the targeted service is the active broker.\n+ */\n+public class BrokerOperationBundle {\n+\n+    public enum Operation {\n+        MSAL_HELLO,\n+        MSAL_GET_INTENT_FOR_INTERACTIVE_REQUEST,\n+        MSAL_ACQUIRE_TOKEN_SILENT,\n+        MSAL_GET_ACCOUNTS,\n+        MSAL_REMOVE_ACCOUNT,\n+        MSAL_GET_DEVICE_MODE,\n+        MSAL_GET_CURRENT_ACCOUNT_IN_SHARED_DEVICE,\n+        MSAL_SIGN_OUT_FROM_SHARED_DEVICE,\n+        BROKER_GET_KEY_FROM_INACTIVE_BROKER\n+    }\n+\n+    @Getter\n+    @NonNull final private Operation operation;\n+\n+    @Getter\n+    @NonNull final private String targetBrokerAppPackageName;\n+\n+    @Getter\n+    @Nullable final private Bundle bundle;\n+\n+    public BrokerOperationBundle(@NonNull final Operation operation,", "originalCommit": "eb93cb55a2bf851e5adac4c23fe7716b2fbf1bd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUyOTM0MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510529341", "bodyText": "Thought experiment: should this be specified in a configuration?", "author": "AdamBJohnsonx", "createdAt": "2020-10-23T00:17:40Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BrokerOperationExecutor.java", "diffHunk": "@@ -0,0 +1,203 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.controllers;\n+\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.exception.ClientException;\n+import com.microsoft.identity.common.exception.ErrorStrings;\n+import com.microsoft.identity.common.internal.broker.ipc.IIpcStrategy;\n+import com.microsoft.identity.common.internal.broker.ipc.BrokerOperationBundle;\n+import com.microsoft.identity.common.internal.commands.parameters.CommandParameters;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.telemetry.Telemetry;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiEndEvent;\n+import com.microsoft.identity.common.internal.telemetry.events.ApiStartEvent;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Classes for executing IPC service operations.\n+ * It takes in a list of IIpcStrategy, and will try to connect to the broker with each strategy. one by one.\n+ * - If the current strategy succeeds, it will return the result right away.\n+ * - If the service returns an error, it will return the result right away.\n+ * - If the current strategy fails to connect to the targeted service, it will try the next one until the list is exhausted.\n+ */\n+public class BrokerOperationExecutor {\n+\n+    private static final String TAG = BrokerOperationExecutor.class.getSimpleName();\n+\n+    /**\n+     * Info of a service operation to be performed with available strategies.\n+     */\n+    public interface BrokerOperation<T> {\n+\n+        /**\n+         * Trigger any prerequisite works before making the actual request.\n+         * This was added because the existing MSAL-Broker logic has a separate hello() call.\n+         */\n+        void performPrerequisites(@NonNull IIpcStrategy strategy) throws BaseException;\n+\n+        /**\n+         * Gets a BrokerOperationBundle bundle to pass to each IpcStrategies.\n+         */\n+        @NonNull BrokerOperationBundle getBundle();\n+\n+        /**\n+         * Extracts the result object from a bundle returned by an IpcStrategy.\n+         * If the broker returns an error, this will throw an exception.\n+         */\n+        @NonNull T extractResultBundle(@Nullable final Bundle resultBundle) throws BaseException;\n+\n+        /**\n+         * Returns method name (for logging/telemetry purpose).\n+         */\n+        @NonNull String getMethodName();\n+\n+        /**\n+         * ID of the telemetry API event associated to this strategy task.\n+         * If this value returns null, no telemetry event will be emitted.\n+         */\n+        @Nullable String getTelemetryApiId();\n+\n+        /**\n+         * A method that will be invoked before the success event is emitted.\n+         * If the calling operation wants to put any value in the success event, put it here.\n+         */\n+        void putValueInSuccessEvent(ApiEndEvent event, T result);\n+    }\n+\n+    private final List<IIpcStrategy> mStrategies;\n+\n+    /**\n+     * @param strategies list of IIpcStrategy to be invoked.\n+     */\n+    public BrokerOperationExecutor(@NonNull final List<IIpcStrategy> strategies) {", "originalCommit": "eb93cb55a2bf851e5adac4c23fe7716b2fbf1bd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzODczNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1088#discussion_r510538736", "bodyText": "IMO, this kind of stuff is too low-level and we should decide what's best for the devs/users - with telemetry.\n(e.g. once bind service is 'on the way out' in MSAL, there's no reason to let the devs pick it. we should just remove it).", "author": "rpdome", "createdAt": "2020-10-23T00:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUyOTM0MQ=="}], "type": "inlineReview"}, {"oid": "9b03cdd37779db74c23fc71ad3ed9b486aba4647", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9b03cdd37779db74c23fc71ad3ed9b486aba4647", "message": "[Part 1] Separate communication logic from business logic", "committedDate": "2020-10-23T01:01:16Z", "type": "commit"}, {"oid": "9b03cdd37779db74c23fc71ad3ed9b486aba4647", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9b03cdd37779db74c23fc71ad3ed9b486aba4647", "message": "[Part 1] Separate communication logic from business logic", "committedDate": "2020-10-23T01:01:16Z", "type": "forcePushed"}]}