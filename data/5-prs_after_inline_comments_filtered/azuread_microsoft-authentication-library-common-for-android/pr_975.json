{"pr_number": 975, "pr_title": "DCF PR: Adding Command/Controller code", "pr_createdAt": "2020-07-23T18:39:39Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975", "timeline": [{"oid": "cc914858709b4840ac63563e6d6be02c51b7493f", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/cc914858709b4840ac63563e6d6be02c51b7493f", "message": "Added abstract methods to BaseController, command body, new fields in MicrosoftStsAuthorizationResponse object", "committedDate": "2020-07-23T18:32:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNjIxMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459716211", "bodyText": "Double check these error strings with @hamiltonha", "author": "rpdome", "createdAt": "2020-07-23T20:42:20Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/DeviceCodeFlowCommand.java", "diffHunk": "@@ -38,6 +40,16 @@\n  * exception handling.\n  */\n public class DeviceCodeFlowCommand extends TokenCommand {\n+\n+    public final static String AUTH_DECLINED_CODE = \"authorization_declined\";\n+    public final static String AUTH_DECLINED_MSG = \"The end user has denied the authorization request. Re-run the Device Code Flow Protocol with another user.\";", "originalCommit": "cc914858709b4840ac63563e6d6be02c51b7493f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAyMDYxMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r460020613", "bodyText": "The error codes or the error messages?", "author": "t-fadura", "createdAt": "2020-07-24T12:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNjIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTIyMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r461065220", "bodyText": "error messages.", "author": "rpdome", "createdAt": "2020-07-27T17:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNjIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMDcyMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r461120722", "bodyText": "Ok, I'll be sure to sync up with @hamiltonha as I add more error messages in the next PR.", "author": "t-fadura", "createdAt": "2020-07-27T19:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNjIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcyMTQxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459721414", "bodyText": "nit: add an extra line", "author": "rpdome", "createdAt": "2020-07-23T20:52:58Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -143,6 +144,11 @@ public abstract boolean getDeviceMode(final CommandParameters parameters)\n     public abstract boolean removeCurrentAccount(final RemoveAccountCommandParameters parameters)\n             throws Exception;\n \n+    public abstract AuthorizationResult deviceCodeFlowAuthRequest(final DeviceCodeFlowCommandParameters parameters)\n+            throws Exception;\n+    public abstract AcquireTokenResult acquireDeviceCodeFlowToken(final AuthorizationResult authorizationResult, DeviceCodeFlowCommandParameters commandParameters)", "originalCommit": "cc914858709b4840ac63563e6d6be02c51b7493f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTEwNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459749104", "bodyText": "I don't think these should live here. They should instead be in ErrorStrings.java", "author": "shahzaibj", "createdAt": "2020-07-23T21:53:01Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/DeviceCodeFlowCommand.java", "diffHunk": "@@ -38,6 +40,16 @@\n  * exception handling.\n  */\n public class DeviceCodeFlowCommand extends TokenCommand {\n+\n+    public final static String AUTH_DECLINED_CODE = \"authorization_declined\";\n+    public final static String AUTH_DECLINED_MSG = \"The end user has denied the authorization request. Re-run the Device Code Flow Protocol with another user.\";\n+    public final static String EXPIRED_TOKEN_CODE = \"expired_token\";\n+    public final static String EXPIRED_TOKEN_MSG = \"The token has expired, therefore authentication is no longer possible with this flow attempt. Re-run the Device Code Flow Protocol to try again.\";\n+    // Add more errors\n+\n+    // Use this message for when DCF fails with an error code that doesn't match any of the codes above\n+    public final static String DEFAULT_ERROR_MSG = \"Device Code Flow has failed with an unexpected error. The error code shown was received from the authorization result.\";", "originalCommit": "cc914858709b4840ac63563e6d6be02c51b7493f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTQ1Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459749453", "bodyText": "Also following the same pattern in that class, let's use complete variable names", "author": "shahzaibj", "createdAt": "2020-07-23T21:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2MTU4MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459761581", "bodyText": "+1 on this feedback, let's organize these constants into ErrorStrings", "author": "iambmelt", "createdAt": "2020-07-23T22:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0ODEwMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r460048103", "bodyText": "Done!", "author": "t-fadura", "createdAt": "2020-07-24T13:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0OTEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MDY5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459750690", "bodyText": "This is wrong as stated on CR on an earlier PR. This would use the BrokerMsalController if a broker is present on the device.\nThis should instead be getControllers() and loop over them to execute for each controller. For an example, see SilentTokenCommand.java", "author": "shahzaibj", "createdAt": "2020-07-23T21:56:38Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/commands/DeviceCodeFlowCommand.java", "diffHunk": "@@ -47,8 +59,30 @@ public DeviceCodeFlowCommand(@NonNull DeviceCodeFlowCommandParameters parameters\n \n     @Override\n     public AcquireTokenResult execute() throws Exception {\n-        // TODO: Implement execute body in next PR, when DCF methods have been declared/defined in LocalMsalController\n-        return null;\n+\n+        // Get the controller used to execute the command\n+        final BaseController controller = getDefaultController();", "originalCommit": "cc914858709b4840ac63563e6d6be02c51b7493f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MzAzMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459753033", "bodyText": "This is not supported in broker. so either we find a way to inject LocalMsalController as the default controller elsewhere, or we simply just hard code it here and add some comment.\nAlso, given that this is an interactive flow, I don't think we should loop through the controllers.", "author": "rpdome", "createdAt": "2020-07-23T22:02:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MDY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1Mzk5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459753990", "bodyText": "Then we should use getControllers().get(0) - The command object has at least one controller to begin with. In this case, that is the LocalMsalController as that is being supplied to the command during creation via the method in PCA", "author": "shahzaibj", "createdAt": "2020-07-23T22:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MDY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAyODg4MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r460028881", "bodyText": "@shahzaibj getDefaultController() here actually points to a method in BaseController that simply calls controllers.get(0) (controllers being the object that would be returned by getControllers()), so it's the same code either way I think. And yes, since the command object was created with a LocalMsalController in PublicClientApplication, LocalMsalController should be the \"default\" controller.", "author": "t-fadura", "createdAt": "2020-07-24T12:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MDY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjUwMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r461016501", "bodyText": "@t-fadura Okay, I see. We have multiple methods called getDefaultController and each of them do different things. Thanks for pointing out.", "author": "shahzaibj", "createdAt": "2020-07-27T16:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MDY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2Mzg3Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r459763873", "bodyText": "Most of these properties are going to be unfamiliar to us, as we're just now adding support for DCF. Despite the other getters not having javadoc in this class, can I request we add it for these new methods? I think it's is particularly important to call out that these getters and their values will return null in non-DCF cases, and that these values may be applicable only in DC flows", "author": "iambmelt", "createdAt": "2020-07-23T22:30:32Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/MicrosoftAuthorizationResponse.java", "diffHunk": "@@ -85,6 +105,15 @@ public void setCorrelationId(final String correlationId) {\n \n     public String getSessionState() { return mSessionState;}\n \n+    public String getDeviceCode() { return mDeviceCode;}", "originalCommit": "cc914858709b4840ac63563e6d6be02c51b7493f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAyMDc1MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r460020750", "bodyText": "done!", "author": "t-fadura", "createdAt": "2020-07-24T12:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2Mzg3Mw=="}], "type": "inlineReview"}, {"oid": "d10c9d732456f17da82459baf305af7e187ca4ee", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d10c9d732456f17da82459baf305af7e187ca4ee", "message": "Merge branch 'dev' of https://github.com/AzureAD/microsoft-authentication-library-common-for-android into t-fadura/dcf-main", "committedDate": "2020-07-24T11:04:36Z", "type": "commit"}, {"oid": "5036cf73774718d6b95842783b370deb9342b2c1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/5036cf73774718d6b95842783b370deb9342b2c1", "message": "Merge branch 'dev' into t-fadura/dcf-main", "committedDate": "2020-07-24T11:05:44Z", "type": "commit"}, {"oid": "b59441fb5a37d9ba13333b8c735ee54d2bbf1c44", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b59441fb5a37d9ba13333b8c735ee54d2bbf1c44", "message": "Merge branch 't-fadura/dcf-main' of https://github.com/AzureAD/microsoft-authentication-library-common-for-android into t-fadura/dcf-main", "committedDate": "2020-07-24T12:15:35Z", "type": "commit"}, {"oid": "028d4d12b7a594e9ce99b04c43a69295ef39afc4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/028d4d12b7a594e9ce99b04c43a69295ef39afc4", "message": "All DCF fields now strings, added JavaDocs", "committedDate": "2020-07-24T13:00:04Z", "type": "commit"}, {"oid": "31efc4925d143c0fa6d410b200fb74773056a3df", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/31efc4925d143c0fa6d410b200fb74773056a3df", "message": "moved errors from DeviceCodeFlowCommand to ErrorStrings", "committedDate": "2020-07-24T13:26:31Z", "type": "commit"}, {"oid": "89e646c50ecc74494efdc22e35660058ce3ebfea", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/89e646c50ecc74494efdc22e35660058ce3ebfea", "message": "Merge branch 'dev' into t-fadura/dcf-main", "committedDate": "2020-07-24T19:56:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzOTk3MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r461039971", "bodyText": "nit: What requires this import?", "author": "AdamBJohnsonx", "createdAt": "2020-07-27T17:07:45Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/microsoftsts/MicrosoftStsAuthorizationResponse.java", "diffHunk": "@@ -24,6 +24,7 @@\n \n import com.microsoft.identity.common.internal.providers.microsoft.MicrosoftAuthorizationResponse;\n \n+import java.net.URL;", "originalCommit": "89e646c50ecc74494efdc22e35660058ce3ebfea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NzY5Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/975#discussion_r461067692", "bodyText": "It was left here from previous code by mistake, will remove", "author": "t-fadura", "createdAt": "2020-07-27T17:55:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzOTk3MQ=="}], "type": "inlineReview"}]}