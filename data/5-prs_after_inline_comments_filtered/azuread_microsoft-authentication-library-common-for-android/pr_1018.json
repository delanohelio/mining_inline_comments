{"pr_number": 1018, "pr_title": "Place cap on the number failed request data in Last Request Telemetry at any given time", "pr_createdAt": "2020-08-28T22:56:23Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018", "timeline": [{"oid": "6d33a2d698908d977f9644434fb93a0bc51bafad", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6d33a2d698908d977f9644434fb93a0bc51bafad", "message": "Put a cap on failed requests saved to cache in last request telemetry", "committedDate": "2020-08-28T22:45:47Z", "type": "commit"}, {"oid": "2dc4bc60c0bf9d67628b3d673517030218bd6650", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2dc4bc60c0bf9d67628b3d673517030218bd6650", "message": "Add unit test for last request telemetry cap", "committedDate": "2020-08-28T22:46:18Z", "type": "commit"}, {"oid": "f1ea0056fe685c82db853ef728ce2681f6da2a50", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f1ea0056fe685c82db853ef728ce2681f6da2a50", "message": "Merge branch 'dev' into shahzaibj/ests-telemetry-size-fix", "committedDate": "2020-08-28T22:46:36Z", "type": "commit"}, {"oid": "963e9b79f53b11b84ca8a12af387bf6c8d666f44", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/963e9b79f53b11b84ca8a12af387bf6c8d666f44", "message": "Catch OOM while restoring last request telemetry from shared pref", "committedDate": "2020-08-28T23:35:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MTA4Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479571082", "bodyText": "Package-private, right?", "author": "AdamBJohnsonx", "createdAt": "2020-08-28T23:17:22Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/eststelemetry/LastRequestTelemetry.java", "diffHunk": "@@ -47,7 +50,7 @@\n     }\n \n     List<FailedRequest> getFailedRequests() {", "originalCommit": "f1ea0056fe685c82db853ef728ce2681f6da2a50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3ODU3Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479578577", "bodyText": "It is package private", "author": "shahzaibj", "createdAt": "2020-08-28T23:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3ODY5NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479578695", "bodyText": "Are you looking for some comment indicating that or what?", "author": "shahzaibj", "createdAt": "2020-08-28T23:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3OTAzMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479579033", "bodyText": "Because the authors left it out of the language, I've always taken it upon myself to say so using comments.\n/* package */ void aPackagePrivateFunction()", "author": "AdamBJohnsonx", "createdAt": "2020-08-28T23:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MDg1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479580857", "bodyText": "Addressed here: 89e243e", "author": "shahzaibj", "createdAt": "2020-08-29T00:10:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MTA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MjkwMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479572900", "bodyText": "This doesn't take a safe-copy, right?", "author": "AdamBJohnsonx", "createdAt": "2020-08-28T23:27:10Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/eststelemetry/LastRequestTelemetry.java", "diffHunk": "@@ -47,7 +50,7 @@\n     }\n \n     List<FailedRequest> getFailedRequests() {\n-        return failedRequests;\n+        return Collections.unmodifiableList(failedRequests);", "originalCommit": "f1ea0056fe685c82db853ef728ce2681f6da2a50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3OTA0Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479579043", "bodyText": "Not sure what you mean here, can you tell more?", "author": "shahzaibj", "createdAt": "2020-08-28T23:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MjkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3OTEyNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479579126", "bodyText": "This is more about being sure that whoever is using this is OK with the list changing underneath them.", "author": "AdamBJohnsonx", "createdAt": "2020-08-29T00:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MjkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MDM1NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479580354", "bodyText": "Yes, they are okay with that. Added javadoc here as well about being unmodifiable: d71f93b", "author": "shahzaibj", "createdAt": "2020-08-29T00:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MjkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3NDA4Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479574083", "bodyText": "I'm not sure at all that this is what we want to do.  subList returns a view on the original list.  So, as I read it, over time you'll end up with an ever expanding chain of references to new sublists (see SubList.subList).\nhttps://cs.android.com/android/platform/superproject/+/master:libcore/ojluni/src/main/java/java/util/ArrayList.java;drc=6bd07db6e4f0806b658fc44bfee5dbef2c409540;l=1007\nIf we're only doing 100 of these, it might be better to just declare your own array and use it like a circular buffer, even though it means you'll have more complex code when somebody requests a view.  I see that this object gets recycled a lot, too.  So this is only a concern for a lot of request failures when this isn't being persisted.\nTo note: this has been fixed in OpenJDK: http://hg.openjdk.java.net/jdk9/jdk9/jdk/rev/d7a4b04e3fc9", "author": "AdamBJohnsonx", "createdAt": "2020-08-28T23:33:16Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/eststelemetry/LastRequestTelemetry.java", "diffHunk": "@@ -76,10 +79,22 @@ void resetSilentSuccessCount() {\n \n \n     void appendFailedRequest(final String apiId, final String correlationId, final String error) {\n-        failedRequests.add(new FailedRequest(apiId, correlationId, error));\n+        appendFailedRequest(new FailedRequest(apiId, correlationId, error));\n     }\n \n     void appendFailedRequest(final FailedRequest failedRequest) {\n+        // this should usually not be greater than - at most should be equal to the cap\n+        // because the only we to add to this list is via this append method.\n+        // The only time this could be greater than the cap is for some existing devices that may\n+        // have caught themselves in a bad state after accumulating too much telemetry in\n+        // Shared Preferences. (of course prior to the cap being put in place).\n+        // So will just take the last (most recent) 100 items here to get those out of the bad state,\n+        // and also to avoid having too much telemetry in the cache going forward.\n+        if (failedRequests.size() >= FAILED_REQUEST_CAP) {\n+            final int beginIndex = failedRequests.size() - FAILED_REQUEST_CAP + 1;\n+            final int endIndex = failedRequests.size();\n+            failedRequests = failedRequests.subList(beginIndex, endIndex);", "originalCommit": "f1ea0056fe685c82db853ef728ce2681f6da2a50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTI0NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479581245", "bodyText": "Yeah, I would say let's keep the code simple for now. What do you say?", "author": "shahzaibj", "createdAt": "2020-08-29T00:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3NDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUzOTM0OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r482539349", "bodyText": "Synced offline - @AdamBJohnsonx will write up a circular buffer and we can pick it up in the future.", "author": "shahzaibj", "createdAt": "2020-09-02T22:26:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3NDA4Mw=="}], "type": "inlineReview"}, {"oid": "89e243e0f75a7d427e781d36a7687773162dd1da", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/89e243e0f75a7d427e781d36a7687773162dd1da", "message": "Address comments", "committedDate": "2020-08-29T00:03:37Z", "type": "commit"}, {"oid": "d71f93b10e05f31e6d3768f07117004b30837621", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d71f93b10e05f31e6d3768f07117004b30837621", "message": "Improve javadoc", "committedDate": "2020-08-29T00:06:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479581444", "bodyText": "There's not really any recovery from OOM.", "author": "AdamBJohnsonx", "createdAt": "2020-08-29T00:14:51Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/eststelemetry/SharedPreferencesLastRequestTelemetryCache.java", "diffHunk": "@@ -66,28 +66,35 @@ ISharedPreferencesFileManager getSharedPreferencesFileManager() {\n     public synchronized RequestTelemetry getRequestTelemetryFromCache() {\n         final String methodName = \":getRequestTelemetryFromCache\";\n \n-        final String cacheValue = mSharedPreferencesFileManager.getString(LAST_TELEMETRY_OBJECT_CACHE_KEY);\n+        try {\n+            final String cacheValue = mSharedPreferencesFileManager.getString(LAST_TELEMETRY_OBJECT_CACHE_KEY);\n \n-        if (cacheValue == null) {\n-            Logger.info(TAG + methodName, \"There is no last request telemetry saved in \" +\n-                    \"the cache. Returning NULL\");\n+            if (cacheValue == null) {\n+                Logger.info(TAG + methodName, \"There is no last request telemetry saved in \" +\n+                        \"the cache. Returning NULL\");\n \n-            return null;\n-        }\n+                return null;\n+            }\n \n-        try {\n-            LastRequestTelemetry lastRequestTelemetry = mGson.fromJson(cacheValue, LastRequestTelemetry.class);\n+            final LastRequestTelemetry lastRequestTelemetry = mGson.fromJson(cacheValue, LastRequestTelemetry.class);\n \n             if (lastRequestTelemetry == null) {\n                 Logger.warn(TAG + methodName,\n                         \"Last Request Telemetry deserialization failed\");\n             }\n \n             return lastRequestTelemetry;\n-        } catch (JsonSyntaxException e) {\n+        } catch (final JsonSyntaxException e) {\n             Logger.error(TAG + methodName,\n                     \"Last Request Telemetry deserialization failed\", e);\n             return null;\n+        } catch (final OutOfMemoryError e) {\n+            Logger.error(TAG + methodName,\n+                    \"Encountered OOM while restoring last request telemetry from \" +\n+                            \"Shared Preferences. Clearing telemetry cache to recover and returning \" +\n+                            \"null.\", e);\n+            mSharedPreferencesFileManager.clear();\n+            return null;", "originalCommit": "d71f93b10e05f31e6d3768f07117004b30837621", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTY5Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479581693", "bodyText": "Yeah, if we can't load the String in memory, then can't do much from there. So just clearing that telemetry from cache to allow the device/user to avoid the crash.", "author": "shahzaibj", "createdAt": "2020-08-29T00:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MjA3NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479582075", "bodyText": "But in the mean time, other operations have failed in potentially other threads.  You probably can't even call logger, and can't execute TAG+methodName.  We've already bounded the side of the returned telemetry - I don't know that we need to try this.", "author": "AdamBJohnsonx", "createdAt": "2020-08-29T00:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4Mjc1MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479582751", "bodyText": "Why can't we call logger and TAG? This is in catch block so it should execute right?\nEven though we've bounded the telemetry, that means we're good for the future, but we still need to account for a scenario where the telemetry String in Shared Pref (from earlier before this fix gets out), may be too huge that Android isn't able to fit the String in memory. So in that case, we just clear the cache so it doesn't happen again and return null here as we don't have any telemetry that we can safely return from cache.", "author": "shahzaibj", "createdAt": "2020-08-29T00:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MzcxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479583714", "bodyText": "You're OOM.  If logger needs to allocate, it might not be able to.  The new string that gets created by TAG+methodName might also cause an OOM.", "author": "AdamBJohnsonx", "createdAt": "2020-08-29T00:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NDExMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479584111", "bodyText": "Wouldn't we fail to allocate the large string thus keeping sufficient heap space free to keep allocating smaller strings?\nThinking about the notes in this SO answer\nhttps://stackoverflow.com/a/2680784", "author": "iambmelt", "createdAt": "2020-08-29T00:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NDIxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479584214", "bodyText": "@AdamBJohnsonx But the TAG+methodName String is going to be much smaller so it should get memory allocated for it. The OOM we ran into here for telemetry was that JAVA was trying to allocated about 9MB \ud83d\ude01so we're trying to protect against that.", "author": "shahzaibj", "createdAt": "2020-08-29T00:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NTEzMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479585132", "bodyText": "The stack overflow people seem to also think that they only thing to do at that point is shut down the application.  But we're not the application, we're a library.  We could be handing back control to a JVM that's utterly destroyed and we really have no way of knowing what's gone wrong in the mean time.", "author": "AdamBJohnsonx", "createdAt": "2020-08-29T00:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NTMyNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479585326", "bodyText": "In that case, should we wipe the SharedPrefs and rethrow the error?", "author": "iambmelt", "createdAt": "2020-08-29T00:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NTQ3OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479585479", "bodyText": "That would seem to be the most-ideal from a state-perspective right? Clear out what we failed to allocate and don't continue in an undefined state?", "author": "iambmelt", "createdAt": "2020-08-29T00:42:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NTUxOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479585518", "bodyText": "If we can.  I'm looking to shared preferences now, to see if there's a way to get the object size before we try to read it.", "author": "AdamBJohnsonx", "createdAt": "2020-08-29T00:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NTY0MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479585640", "bodyText": "If we can find the size of the string in advance, we can avoid this by putting a reasonable bound on it.", "author": "AdamBJohnsonx", "createdAt": "2020-08-29T00:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NTgwMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479585801", "bodyText": "Thing is, it's just an assumption that this allocation caused the OOM - we could be wrong here.", "author": "AdamBJohnsonx", "createdAt": "2020-08-29T00:45:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUzODU0MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r482538540", "bodyText": "Addressed here: 57d2359", "author": "shahzaibj", "createdAt": "2020-09-02T22:26:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA=="}], "type": "inlineReview"}, {"oid": "f46c0d6c54c207dc047a73565127230dbde4aee1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f46c0d6c54c207dc047a73565127230dbde4aee1", "message": "Merge branch 'dev' into shahzaibj/ests-telemetry-size-fix", "committedDate": "2020-09-02T22:02:35Z", "type": "commit"}, {"oid": "57d235941d4ed4ffd451cb3e40197f10f30fa652", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/57d235941d4ed4ffd451cb3e40197f10f30fa652", "message": "Address comment", "committedDate": "2020-09-02T22:25:49Z", "type": "commit"}]}