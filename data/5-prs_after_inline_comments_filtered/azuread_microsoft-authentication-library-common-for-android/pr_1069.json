{"pr_number": 1069, "pr_title": "Provide a getter to access Secure Hardware State Information", "pr_createdAt": "2020-10-06T01:04:18Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069", "timeline": [{"oid": "a6b75ca9ec7203ab9df3a095d1205b98f13807cf", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a6b75ca9ec7203ab9df3a095d1205b98f13807cf", "message": "Provide a getter to access Secure Hardware State Information", "committedDate": "2020-10-06T01:02:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwMjc4Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500002786", "bodyText": "Add a specific code for UNKNOWN_DOWNLEVEL", "author": "iambmelt", "createdAt": "2020-10-06T04:44:35Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -146,6 +146,29 @@ public String toString() {\n         }\n     }\n \n+    /**\n+     * Information about the backing of the underlying keystore.\n+     */\n+    enum SecureHardwareState {\n+        /**\n+         * Return if the underlying private key resides inside secure hardware (e.g., Trusted\n+         * Execution Environment (TEE) or Secure Element (SE)). No mechanism of attestation is\n+         * provided or specified.\n+         */\n+        TRUE_UNATTESTED,\n+\n+        /**\n+         * The the underlying private key is not inside secure hardware.\n+         */\n+        FALSE,\n+\n+        /**\n+         * It is unknown where the underlying key resides, due to lack of API support for\n+         * determination.\n+         */\n+        UNKNOWN", "originalCommit": "a6b75ca9ec7203ab9df3a095d1205b98f13807cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwMzIyMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500003220", "bodyText": "and UNKNOWN_QRY_ERR", "author": "iambmelt", "createdAt": "2020-10-06T04:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwMjc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyOTQyNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500429425", "bodyText": "79411eb", "author": "iambmelt", "createdAt": "2020-10-06T16:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwMjc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxODg5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500418890", "bodyText": "We don't need to capture the returned value here?", "author": "shahzaibj", "createdAt": "2020-10-06T16:04:01Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -1044,7 +1080,7 @@ private KeyPair generateNewRsaKeyPair(@NonNull final Context context,\n \n             // If the key material is hidden (HSM or otherwise) the length is -1\n             if (length >= minKeySize || length < 0) {\n-                logSecureHardwareState(kp);\n+                getSecureHardwareState(kp);", "originalCommit": "a6b75ca9ec7203ab9df3a095d1205b98f13807cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyNjIxMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500426212", "bodyText": "Not here, no -- just using this method for its logging purposes", "author": "iambmelt", "createdAt": "2020-10-06T16:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxODg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyOTgzMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500429830", "bodyText": "Will add a comment to clarify this usage", "author": "iambmelt", "createdAt": "2020-10-06T16:20:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxODg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMDQ3Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500430476", "bodyText": "I think it is fine -- just a bit misleading when reading the code", "author": "shahzaibj", "createdAt": "2020-10-06T16:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxODg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMTAyNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500431026", "bodyText": "18db49f", "author": "iambmelt", "createdAt": "2020-10-06T16:22:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxODg5MA=="}], "type": "inlineReview"}, {"oid": "2db9601e8a7c5405088413c6587d1973001f566d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2db9601e8a7c5405088413c6587d1973001f566d", "message": "Merge branch 'dev' into iambmelt/add-pop-hardware-state", "committedDate": "2020-10-06T16:15:08Z", "type": "commit"}, {"oid": "79411ebddaf2fcdb829c4573526de840a342cc73", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/79411ebddaf2fcdb829c4573526de840a342cc73", "message": "Adds new states to account for errors during interrogation & lack of API", "committedDate": "2020-10-06T16:18:41Z", "type": "commit"}, {"oid": "18db49fcb0166da6802345ce53ee7cb1679fd781", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/18db49fcb0166da6802345ce53ee7cb1679fd781", "message": "Add a comment explaining why the return value of this method is being\ndiscarded", "committedDate": "2020-10-06T16:21:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzNjg4OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500436888", "bodyText": "Can we have more details (comment) on what could cause this?", "author": "rpdome", "createdAt": "2020-10-06T16:31:10Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -808,6 +808,42 @@ public String decrypt(@NonNull final Cipher cipher,\n         throw clientException;\n     }\n \n+    @Override\n+    public SecureHardwareState getSecureHardwareState() throws ClientException {\n+        final String errCode;\n+        final Exception exception;\n+\n+        final KeyStore.Entry keyEntry;\n+        try {\n+            keyEntry = mKeyStore.getEntry(mKeyAlias, null);\n+            final KeyPair rsaKeyPair = getKeyPairForEntry(keyEntry);\n+            return getSecureHardwareState(rsaKeyPair);\n+        } catch (final KeyStoreException e) {\n+            errCode = KEYSTORE_NOT_INITIALIZED;\n+            exception = e;\n+        } catch (final NoSuchAlgorithmException e) {\n+            errCode = NO_SUCH_ALGORITHM;\n+            exception = e;\n+        } catch (final UnrecoverableEntryException e) {\n+            errCode = INVALID_PROTECTION_PARAMS;", "originalCommit": "18db49fcb0166da6802345ce53ee7cb1679fd781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NjMxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500476314", "bodyText": "fb6577a", "author": "iambmelt", "createdAt": "2020-10-06T17:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzNjg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1Nzg5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500457890", "bodyText": "What is QRY?", "author": "shahzaibj", "createdAt": "2020-10-06T17:04:11Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -146,6 +146,35 @@ public String toString() {\n         }\n     }\n \n+    /**\n+     * Information about the backing of the underlying keystore.\n+     */\n+    enum SecureHardwareState {\n+        /**\n+         * Return if the underlying private key resides inside secure hardware (e.g., Trusted\n+         * Execution Environment (TEE) or Secure Element (SE)). No mechanism of attestation is\n+         * provided or specified.\n+         */\n+        TRUE_UNATTESTED,\n+\n+        /**\n+         * The the underlying private key is not inside secure hardware.\n+         */\n+        FALSE,\n+\n+        /**\n+         * It is unknown where the underlying key resides, due to lack of API support for\n+         * determination.\n+         */\n+        UNKNOWN_DOWNLEVEL,\n+\n+        /**\n+         * It is unknown where the underlying key resides, due to an error during keystore\n+         * interrogation.\n+         */\n+        UNKNOWN_QRY_ERR", "originalCommit": "18db49fcb0166da6802345ce53ee7cb1679fd781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTE5MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500461191", "bodyText": "It's query -- @AdamBJohnsonx had same question -- will rename for clarity\n#1069 (comment)", "author": "iambmelt", "createdAt": "2020-10-06T17:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1Nzg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2Nzk2OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500467969", "bodyText": "910b236", "author": "iambmelt", "createdAt": "2020-10-06T17:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1Nzg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NzkwNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500457905", "bodyText": "Do we need this?", "author": "AdamBJohnsonx", "createdAt": "2020-10-06T17:04:12Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -1058,7 +1095,7 @@ private KeyPair generateNewRsaKeyPair(@NonNull final Context context,\n         );\n     }\n \n-    private void logSecureHardwareState(@NonNull final KeyPair kp) {\n+    private SecureHardwareState getSecureHardwareState(@NonNull final KeyPair kp) {\n         String msg;", "originalCommit": "18db49fcb0166da6802345ce53ee7cb1679fd781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTMwMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500461303", "bodyText": "Can remove", "author": "iambmelt", "createdAt": "2020-10-06T17:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NzkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODcwOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500468709", "bodyText": "ad0fd74", "author": "iambmelt", "createdAt": "2020-10-06T17:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NzkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTQxMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500459410", "bodyText": "Can we spare some characters to make this UNKNOWN_QUERY_ERROR, or is this specified elsewhere?  If it is specified elsewhere, can we generate this enumeration based on that data?", "author": "AdamBJohnsonx", "createdAt": "2020-10-06T17:06:43Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -146,6 +146,35 @@ public String toString() {\n         }\n     }\n \n+    /**\n+     * Information about the backing of the underlying keystore.\n+     */\n+    enum SecureHardwareState {\n+        /**\n+         * Return if the underlying private key resides inside secure hardware (e.g., Trusted\n+         * Execution Environment (TEE) or Secure Element (SE)). No mechanism of attestation is\n+         * provided or specified.\n+         */\n+        TRUE_UNATTESTED,\n+\n+        /**\n+         * The the underlying private key is not inside secure hardware.\n+         */\n+        FALSE,\n+\n+        /**\n+         * It is unknown where the underlying key resides, due to lack of API support for\n+         * determination.\n+         */\n+        UNKNOWN_DOWNLEVEL,\n+\n+        /**\n+         * It is unknown where the underlying key resides, due to an error during keystore\n+         * interrogation.\n+         */\n+        UNKNOWN_QRY_ERR", "originalCommit": "18db49fcb0166da6802345ce53ee7cb1679fd781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MDc3OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500460779", "bodyText": "Sure - will rename", "author": "iambmelt", "createdAt": "2020-10-06T17:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODA2OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500468068", "bodyText": "910b236", "author": "iambmelt", "createdAt": "2020-10-06T17:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTM4OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500461388", "bodyText": "Also, since this is interface-level, do we want to reserve a keyword for TRUE_ATTESTED or something?", "author": "AdamBJohnsonx", "createdAt": "2020-10-06T17:09:58Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -146,6 +146,35 @@ public String toString() {\n         }\n     }\n \n+    /**\n+     * Information about the backing of the underlying keystore.\n+     */\n+    enum SecureHardwareState {", "originalCommit": "18db49fcb0166da6802345ce53ee7cb1679fd781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NjU1OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500466558", "bodyText": "It just makes things easier if we retain interface compatibility when launching a new feature.  So it's worth taking a second here and making sure that we're providing the whole space of possibilities for this value even if they're not available yet.  They should pick up that documentation though.  Unfortunate that we can't use @experimental, thought that's not strong enough.", "author": "AdamBJohnsonx", "createdAt": "2020-10-06T17:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODUyMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500468521", "bodyText": "23bec71", "author": "iambmelt", "createdAt": "2020-10-06T17:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTM4OA=="}], "type": "inlineReview"}, {"oid": "910b23617bc37c764902aade03e990844ea7ef06", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/910b23617bc37c764902aade03e990844ea7ef06", "message": "Rename enum value (UNKNOWN_QUERY_ERROR)", "committedDate": "2020-10-06T17:12:38Z", "type": "commit"}, {"oid": "23bec7130d997b92d507b8c01656055974060bfc", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/23bec7130d997b92d507b8c01656055974060bfc", "message": "Add enum value for attested key", "committedDate": "2020-10-06T17:18:01Z", "type": "commit"}, {"oid": "ad0fd74e0745a105a3cf05b6d7dcba8bbf37f79c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/ad0fd74e0745a105a3cf05b6d7dcba8bbf37f79c", "message": "Formatting cleanup", "committedDate": "2020-10-06T17:19:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MDYxNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500470617", "bodyText": "This is a really broad catch.  Can we narrow this at all, or, if we cannot, can we at least log some exception information here so that we can eventually narrow this down?  And if we have the ability to stuff back some telemetry, the class of the exception that's thrown here might be very interesting.", "author": "AdamBJohnsonx", "createdAt": "2020-10-06T17:24:55Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -1069,15 +1104,19 @@ private void logSecureHardwareState(@NonNull final KeyPair kp) {\n                 );\n                 final KeyInfo info = factory.getKeySpec(privateKey, KeyInfo.class);\n                 final boolean isInsideSecureHardware = info.isInsideSecureHardware();\n-                msg = \"SecretKey is secure hardware backed? \" + isInsideSecureHardware;\n+                Logger.info(TAG, \"SecretKey is secure hardware backed? \" + isInsideSecureHardware);\n+                return isInsideSecureHardware\n+                        ? SecureHardwareState.TRUE_UNATTESTED\n+                        : SecureHardwareState.FALSE;\n             } catch (final Exception e) {\n-                msg = \"Failed to query secure hardware state.\";\n+                Logger.info(TAG, \"Failed to query secure hardware state.\");\n+                return SecureHardwareState.UNKNOWN_QUERY_ERROR;", "originalCommit": "ad0fd74e0745a105a3cf05b6d7dcba8bbf37f79c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NjE2Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1069#discussion_r500486166", "bodyText": "Added better logging, reduced the scope of the catch block\n8ae660a", "author": "iambmelt", "createdAt": "2020-10-06T17:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MDYxNw=="}], "type": "inlineReview"}, {"oid": "fb6577a6747c4962148455fa7978336157bd83b6", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/fb6577a6747c4962148455fa7978336157bd83b6", "message": "Clarify error message.", "committedDate": "2020-10-06T17:33:16Z", "type": "commit"}, {"oid": "8ae660a5e690dfbc092331ff2ab77668ff568ad0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/8ae660a5e690dfbc092331ff2ab77668ff568ad0", "message": "Cleanup exception handling + logging", "committedDate": "2020-10-06T17:36:14Z", "type": "commit"}]}