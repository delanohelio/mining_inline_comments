{"pr_number": 787, "pr_title": "JENA-1950 Replace Nashorn with GraalVM-based JavaScript engine", "pr_createdAt": "2020-08-26T17:17:25Z", "pr_url": "https://github.com/apache/jena/pull/787", "timeline": [{"oid": "1de7d2da3a58188aaf4fa9529b4b47ec1f26fff6", "url": "https://github.com/apache/jena/commit/1de7d2da3a58188aaf4fa9529b4b47ec1f26fff6", "message": "JENA-1950 Replace Nashorn with GraalVM-based JavaScript engine", "committedDate": "2020-08-26T17:16:22Z", "type": "commit"}, {"oid": "6e131fd769c6cf3a1ccff361e0aeedb5abb51e0f", "url": "https://github.com/apache/jena/commit/6e131fd769c6cf3a1ccff361e0aeedb5abb51e0f", "message": "Move GraalVM dependencies before test dependencies", "committedDate": "2020-08-26T17:21:29Z", "type": "commit"}, {"oid": "55a3354a5deaf40761f5e93efc673d5dd0b4f8dd", "url": "https://github.com/apache/jena/commit/55a3354a5deaf40761f5e93efc673d5dd0b4f8dd", "message": "Make Graal VM a provided dependency", "committedDate": "2020-09-15T19:10:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM4MDE2NA==", "url": "https://github.com/apache/jena/pull/787#discussion_r489380164", "bodyText": "I would remove the \"else\" branch.\nIf on Java 8, this warning comes out whereas before there wasn't one.\nThe JDK prints warns its warning anyway on Java11 and Java14:\n\n\"Warning: Nashorn engine is planned to be removed from a future JDK release\"\n\nso we get two.", "author": "afs", "createdAt": "2020-09-16T11:58:02Z", "path": "jena-arq/src/main/java/org/apache/jena/sparql/function/js/JSEngine.java", "diffHunk": "@@ -55,24 +50,31 @@ public static JSEngine createFromFile(String functionLibFile) {\n         return new JSEngine(null, functionLibFile);\n     }\n     \n-    /*package*/ JSEngine(String functions, String functionLibFile) { \n-        this.functions = functions;\n-        this.functionLibFile = functionLibFile;\n+    /*package*/ JSEngine(String functions, String functionLibFile) {\n         invoc = build(functions, functionLibFile);\n     }\n \n     private static Invocable build(String functions, String functionLibFile) {\n         if ( functions == null && functionLibFile == null )\n-            throw new ARQException(\"Both script string and script filename are null\"); \n+            throw new ARQException(\"Both script string and script filename are null\");\n \n         ScriptEngineManager manager = new ScriptEngineManager();\n-        ScriptEngine scriptEngine = manager.getEngineByName(\"nashorn\");\n-        \n+        ScriptEngine scriptEngine = manager.getEngineByName(\"javascript\");\n+        if (scriptEngine == null) {\n+            throw new ARQException(\"Could not load JavaScript script engine. \" +\n+                    \"Make sure that org.graalvm.js:js and org.graalvm.js:js-scriptengine are added to the class path\");\n+        }\n+\n+        if (scriptEngine.getFactory().getEngineName().equals(\"Graal.js\")) {\n+            scriptEngine.getContext().setAttribute(\"polyglot.js.nashorn-compat\", true, ScriptContext.ENGINE_SCOPE);\n+        } else if (scriptEngine.getFactory().getNames().contains(\"Nashorn\")) {\n+            Log.warn(JSEngine.class, \"Nashorn will be permanently removed in JDK 15. Consider switching to Graal VM.\");", "originalCommit": "55a3354a5deaf40761f5e93efc673d5dd0b4f8dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUyNjExMg==", "url": "https://github.com/apache/jena/pull/787#discussion_r489526112", "bodyText": "makes sense", "author": "strangepleasures", "createdAt": "2020-09-16T15:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM4MDE2NA=="}], "type": "inlineReview"}, {"oid": "c257ef6eb50f882d30cce6cb99fcc18df47d91a1", "url": "https://github.com/apache/jena/commit/c257ef6eb50f882d30cce6cb99fcc18df47d91a1", "message": "Make Graal VM dependencies optional", "committedDate": "2020-09-16T15:28:54Z", "type": "commit"}, {"oid": "c5b0dc3522d496d0918af6a0243efd52e3e7ee7a", "url": "https://github.com/apache/jena/commit/c5b0dc3522d496d0918af6a0243efd52e3e7ee7a", "message": "Remove Nashorn deprecation warning", "committedDate": "2020-09-16T15:29:35Z", "type": "commit"}]}