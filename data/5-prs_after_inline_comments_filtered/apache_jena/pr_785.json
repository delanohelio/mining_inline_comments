{"pr_number": 785, "pr_title": "JENA-1936: Value-equality indexing for binary datatypes", "pr_createdAt": "2020-08-23T10:15:35Z", "pr_url": "https://github.com/apache/jena/pull/785", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM0MjE5OQ==", "url": "https://github.com/apache/jena/pull/785#discussion_r478342199", "bodyText": "Consider caching the hash\nprivate int hash;\n\n/*package*/ ByteArray(byte[] bytes) {\n  this.bytes = bytes;\n}\n\n@Override\npublic int hashCode() {\n    if (hash == 0) {\n      hash = Arrays..hashCode(bytes);\n    }\n    return hash;\n}", "author": "strangepleasures", "createdAt": "2020-08-27T11:20:29Z", "path": "jena-core/src/main/java/org/apache/jena/graph/impl/LiteralLabelImpl.java", "diffHunk": "@@ -303,20 +304,59 @@ public String getLexicalForm() {\n \t\treturn lexicalForm;\n \t}\n     \n-    /** \n-     \tAnswer the value used to index this literal\n-        TODO Consider pushing indexing decisions down to the datatype\n-    */\n+    /**\n+     * Answer an object used to index this literal. This object must provide\n+     * {@link Object#equals} and {@link Object#hashCode} based on values, not object\n+     * instance identity.\n+     */\n     @Override\n     public Object getIndexingValue() {\n-        return\n-            isXML() ? this\n-            : !lang.equals( \"\" ) ? getLexicalForm() + \"@\" + lang.toLowerCase(Locale.ROOT)\n-            : wellformed ? getValue()\n-            : getLexicalForm() \n-            ;\n+        if ( isXML() )\n+            return this;\n+        if ( !lang.equals(\"\") )\n+            return getLexicalForm() + \"@\" + lang.toLowerCase(Locale.ROOT);\n+        if ( wellformed ) {\n+            Object value = getValue();\n+            // JENA-1936\n+            // byte[] does not provide hashCode/equals based on the contents of the array.\n+            if ( value instanceof byte[] )\n+                return new ByteArray((byte[])value);\n+            return value;\n+        }\n+        return getLexicalForm();\n     }\n \n+    /**\n+     * {@code byte[]} wrapper that provides {@code hashCode} and {@code equals} based\n+     * on the value of the array.\n+     */\n+    static class ByteArray {\n+        private final byte[] bytes;\n+        /*package*/ ByteArray(byte[] bytes) {", "originalCommit": "651ba80b2d6d1318d8e96545cd19862d9b875e48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUwODk5Nw==", "url": "https://github.com/apache/jena/pull/785#discussion_r478508997", "bodyText": "OK - done. We are assuming the byte[] isn't changing.", "author": "afs", "createdAt": "2020-08-27T15:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM0MjE5OQ=="}], "type": "inlineReview"}, {"oid": "72a6ec6b26d6740f1096c521d22d33327899b084", "url": "https://github.com/apache/jena/commit/72a6ec6b26d6740f1096c521d22d33327899b084", "message": "JENA-1936: Value-equality indexing for binary datatypes", "committedDate": "2020-08-27T19:36:05Z", "type": "commit"}, {"oid": "72a6ec6b26d6740f1096c521d22d33327899b084", "url": "https://github.com/apache/jena/commit/72a6ec6b26d6740f1096c521d22d33327899b084", "message": "JENA-1936: Value-equality indexing for binary datatypes", "committedDate": "2020-08-27T19:36:05Z", "type": "forcePushed"}]}