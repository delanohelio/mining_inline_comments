{"pr_number": 822, "pr_title": "Add Fuseki /$/compact/* endpoint (JENA-1987)", "pr_createdAt": "2020-11-02T14:58:57Z", "pr_url": "https://github.com/apache/jena/pull/822", "timeline": [{"oid": "15be63482c7644d154b75fa505f9f648c565c1ac", "url": "https://github.com/apache/jena/commit/15be63482c7644d154b75fa505f9f648c565c1ac", "message": "Add Fuseki /$/compact/* endpoint (JENA-1987)\n\nSome of the implementation for adding a /$/compact/* endpoint to a\nFuseki server that allows live database compaction via the REST API", "committedDate": "2020-11-02T14:52:11Z", "type": "commit"}, {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869", "url": "https://github.com/apache/jena/commit/c7ab131ab01881dc26435f7c047ec1299415e869", "message": "Simplify code (JENA-1987)", "committedDate": "2020-11-02T14:57:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwOTkyMA==", "url": "https://github.com/apache/jena/pull/822#discussion_r516109920", "bodyText": "Not sure this is possible because jena-fuseki-main does not depend on jena-fuseki-webapp from which the backup and compact functionality originate.", "author": "rvesse", "createdAt": "2020-11-02T16:49:26Z", "path": "jena-fuseki2/jena-fuseki-main/src/main/java/org/apache/jena/fuseki/main/FusekiServer.java", "diffHunk": "@@ -1021,6 +1021,7 @@ private void servletsAndFilters(ServletContextHandler context) {\n                 addServlet(context, \"/$/stats/*\", new ActionStats());\n             if ( withMetrics )\n                 addServlet(context, \"/$/metrics\", new ActionMetrics());\n+            // TODO Should we support registering other functionality e.g. /$/backup/* and /$/compact/*", "originalCommit": "c7ab131ab01881dc26435f7c047ec1299415e869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxNjc5OQ==", "url": "https://github.com/apache/jena/pull/822#discussion_r516816799", "bodyText": "There are a couple of big issues here.\n\nSecurity. So far fuseki-main additional operations under /$/are \"mostly harmless\" but this is a step more impactful.\nThe general area of admin for Fuseki/main where my concern is that we are building in a URL pattern and maybe a better design is add it as a service on the /myTDB2dataset/compact.\n\nSuggestion: add this admin function now for fuseki-webapp and fuseki-main later.\nLet's discuss on the JIRA ticket as it is not about the jena-webapps code which looks fine.", "author": "afs", "createdAt": "2020-11-03T16:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwOTkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA==", "url": "https://github.com/apache/jena/pull/822#discussion_r516808958", "bodyText": "Maybe test it is the right species of DatrasetGraph and return an error if it is not.\nSee TDBOps in fuseki-core.", "author": "afs", "createdAt": "2020-11-03T16:45:35Z", "path": "jena-fuseki2/jena-fuseki-webapp/src/main/java/org/apache/jena/fuseki/mgt/ActionCompact.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.jena.fuseki.mgt;\n+\n+import static java.lang.String.format;\n+\n+import org.apache.jena.fuseki.ctl.ActionAsyncTask;\n+import org.apache.jena.fuseki.ctl.TaskBase;\n+import org.apache.jena.fuseki.servlets.HttpAction;\n+import org.apache.jena.fuseki.servlets.ServletOps;\n+import org.apache.jena.tdb2.DatabaseMgr;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ActionCompact extends ActionAsyncTask\n+{\n+    public ActionCompact() { super(\"Compact\"); }\n+\n+    @Override\n+    public void validate(HttpAction action) {}\n+\n+    @Override\n+    protected Runnable createRunnable(HttpAction action) {\n+        String name = getItemName(action);\n+        if ( name == null ) {\n+            action.log.error(\"Null for dataset name in item request\");\n+            ServletOps.errorOccurred(\"Null for dataset name in item request\");\n+            return null;\n+        }\n+", "originalCommit": "c7ab131ab01881dc26435f7c047ec1299415e869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0MzEwMQ==", "url": "https://github.com/apache/jena/pull/822#discussion_r517443101", "bodyText": "DatabaseMgr.compact() already does this checking so didn't seem relevant to duplicate that here.  Either the dataset can be compacted or calling compact() will throw a relevant error", "author": "rvesse", "createdAt": "2020-11-04T15:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNzk2NQ==", "url": "https://github.com/apache/jena/pull/822#discussion_r517627965", "bodyText": "It throws TDBException(\"Not a switchable TDB database\"); so won't that mean it is \"500 internal error\" not \"400 Bad request\".", "author": "afs", "createdAt": "2020-11-04T20:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxNzAyNg==", "url": "https://github.com/apache/jena/pull/822#discussion_r517917026", "bodyText": "Well that call is going to happen on the background task thread and any failure will just get logged and not bubble up AFAICT", "author": "rvesse", "createdAt": "2020-11-05T09:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY2NzcyNA==", "url": "https://github.com/apache/jena/pull/822#discussion_r518667724", "bodyText": "If the test is in \"validate\", it is in the request cycle.\nThe existing, long-time contract of ActionAsyncTask and run() could do with some clearing up (separate to this PR!). Looks a bit messy / quick hackish. e.g. The TaskBase constructor have args for the element of the HttpAction rather than the implementation comment + single HttpAction arg.", "author": "afs", "createdAt": "2020-11-06T10:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1MDE3NA==", "url": "https://github.com/apache/jena/pull/822#discussion_r525050174", "bodyText": "Yeah there's definitely room for some clean up I was trying to figure out a way to add a success/failure flag to tasks but with the multiple layers of wrapping couldn't find a reliable way to get this working\nAsyncPool.submit() creates a Callable<Object>, that wraps a Runnable, and then creates and submits an AsyncTask which is itself the Callable<Object> that actually gets submitted to the executor service", "author": "rvesse", "createdAt": "2020-11-17T10:34:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA3MDMyOA==", "url": "https://github.com/apache/jena/pull/822#discussion_r525070328", "bodyText": "Figured this out with the latest commit, various parts of the async task code was just logging an error and continuing on rather than throwing it upwards which prevented detecting the error at the point where we could set a success flag appropriately.  Unit tests are updated to check for this flag as appropriate", "author": "rvesse", "createdAt": "2020-11-17T11:06:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA4NzQ3Mg==", "url": "https://github.com/apache/jena/pull/822#discussion_r526087472", "bodyText": "If this is done now, could you resolve the ticket? Thanks.", "author": "afs", "createdAt": "2020-11-18T13:29:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA=="}], "type": "inlineReview"}, {"oid": "3e5e7129a8fc17f9b66b290eae863080d97b5b77", "url": "https://github.com/apache/jena/commit/3e5e7129a8fc17f9b66b290eae863080d97b5b77", "message": "Remove unnecessary extra dependency (JENA-1987)", "committedDate": "2020-11-04T15:42:46Z", "type": "commit"}, {"oid": "09019c08249e4dda0eb6ec26f234b86b0dacbdbf", "url": "https://github.com/apache/jena/commit/09019c08249e4dda0eb6ec26f234b86b0dacbdbf", "message": "Unit tests for /$/compact/<dataset> (JENA-1987)", "committedDate": "2020-11-17T10:28:48Z", "type": "commit"}, {"oid": "207dcce55a2d0d2fa2736e91133c719d52083f93", "url": "https://github.com/apache/jena/commit/207dcce55a2d0d2fa2736e91133c719d52083f93", "message": "Rollback irrelevant changes (JENA-1987)", "committedDate": "2020-11-17T10:36:32Z", "type": "commit"}, {"oid": "697772891e17b3d080d69eec5e82ae6857476cd6", "url": "https://github.com/apache/jena/commit/697772891e17b3d080d69eec5e82ae6857476cd6", "message": "Rollback more irrelevant changes (JENA-1987)", "committedDate": "2020-11-17T10:40:11Z", "type": "commit"}, {"oid": "1fe930c39dbb08ab8d17aea4f0c70500c5f5520f", "url": "https://github.com/apache/jena/commit/1fe930c39dbb08ab8d17aea4f0c70500c5f5520f", "message": "Rename method for clarity (JENA-1987)", "committedDate": "2020-11-17T10:45:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NTA2NQ==", "url": "https://github.com/apache/jena/pull/822#discussion_r525055065", "bodyText": "Stumbled on this while writing some new unit tests around both /$/backup/<dataset> and /$/compact/<dataset>\nThis function didn't verify that dsg was not null so when it tried to interact with the ConcurrentHashMap that stores active backups it would NPE because concurrent maps do not permit null keys", "author": "rvesse", "createdAt": "2020-11-17T10:42:09Z", "path": "jena-fuseki2/jena-fuseki-webapp/src/main/java/org/apache/jena/fuseki/mgt/Backup.java", "diffHunk": "@@ -84,6 +84,10 @@ public static void backup(Transactional transactional, DatasetGraph dsg, String\n      * @see #backup(Transactional, DatasetGraph, String)\n      */\n     private static void backup(DatasetGraph dsg, String backupfile) {\n+        if (dsg == null) {", "originalCommit": "697772891e17b3d080d69eec5e82ae6857476cd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NTUwOQ==", "url": "https://github.com/apache/jena/pull/822#discussion_r525055509", "bodyText": "As noted elsewhere was trying to get a success flag in the Task output working but couldn't get this working, left here for future reference", "author": "rvesse", "createdAt": "2020-11-17T10:42:50Z", "path": "jena-fuseki2/jena-fuseki-core/src/main/java/org/apache/jena/fuseki/ctl/JsonConstCtl.java", "diffHunk": "@@ -25,5 +25,6 @@\n     public static final String task             = \"task\";\n     public static final String finished         = \"finished\";\n     public static final String started          = \"started\";\n+    public static final String success          = \"success\";", "originalCommit": "697772891e17b3d080d69eec5e82ae6857476cd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NjU5Mg==", "url": "https://github.com/apache/jena/pull/822#discussion_r525056592", "bodyText": "Added a TDB2 based dataset so I could test /$/compact/<dataset>, since adding and deleting this dataset might be unstable on Windows I made this and other tests that use that dataset require a non-Windows OS", "author": "rvesse", "createdAt": "2020-11-17T10:44:35Z", "path": "jena-fuseki2/jena-fuseki-webapp/src/test/java/org/apache/jena/fuseki/TestAdmin.java", "diffHunk": "@@ -187,6 +189,21 @@\n         addTestDataset(fileBase+\"config-ds-plain-2.ttl\");\n         checkExists(\"test-ds2\");\n     }\n+    \n+    @Test public void add_delete_dataset_6() {", "originalCommit": "697772891e17b3d080d69eec5e82ae6857476cd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ecccbd3d8699e509d1ca3afb2ad1d31e7f1e20f", "url": "https://github.com/apache/jena/commit/2ecccbd3d8699e509d1ca3afb2ad1d31e7f1e20f", "message": "Indicate task success/failure correctly (JENA-1987)", "committedDate": "2020-11-17T11:05:22Z", "type": "commit"}, {"oid": "2decb5d97d8dd88827ba55987199f97ffc5cc348", "url": "https://github.com/apache/jena/commit/2decb5d97d8dd88827ba55987199f97ffc5cc348", "message": "Ensure ActionSleep throws errors upwards (JENA-1987)", "committedDate": "2020-11-17T11:10:04Z", "type": "commit"}]}