{"pr_number": 229, "pr_title": "HH-104397 remove generification from KafkaProducer interface", "pr_createdAt": "2020-03-04T17:12:51Z", "pr_url": "https://github.com/hhru/nuts-and-bolts/pull/229", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODExODIxNA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/229#discussion_r388118214", "bodyText": "\u041a\u043e\u0433\u0434\u0430 \u0445\u043e\u0447\u0435\u0442\u0441\u044f \u0445\u043e\u0442\u044c \u0447\u0442\u043e-\u0442\u043e \u043d\u0430\u043f\u0438\u0441\u0430\u0442\u044c:  \u0442\u0443\u0442 \u043c\u043e\u0436\u043d\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c var :)\nvar producerRecord = new ProducerRecord<String, Object>(topicName, key, kafkaMessage);", "author": "mvxio", "createdAt": "2020-03-05T07:31:08Z", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/producer/DefaultKafkaProducer.java", "diffHunk": "@@ -1,22 +1,31 @@\n package ru.hh.nab.kafka.producer;\n \n import java.util.concurrent.CompletableFuture;\n+import org.apache.kafka.clients.producer.ProducerRecord;\n import org.springframework.kafka.core.KafkaTemplate;\n-import org.springframework.kafka.support.SendResult;\n \n-public class DefaultKafkaProducer<T> implements KafkaProducer<T> {\n+public class DefaultKafkaProducer implements KafkaProducer {\n \n-  private final KafkaTemplate<String, T> kafkaTemplate;\n+  private final KafkaTemplate<String, Object> kafkaTemplate;\n \n-  public DefaultKafkaProducer(KafkaTemplate<String, T> kafkaTemplate) {\n+  public DefaultKafkaProducer(KafkaTemplate<String, Object> kafkaTemplate) {\n     this.kafkaTemplate = kafkaTemplate;\n   }\n \n-  public CompletableFuture<SendResult<String, T>> sendMessage(String topicName, T kafkaMessage) {\n+  public <T> CompletableFuture<SendResult<T>> sendMessage(String topicName, T kafkaMessage) {\n     return sendMessage(topicName, null, kafkaMessage);\n   }\n \n-  public CompletableFuture<SendResult<String, T>> sendMessage(String topicName, String key, T kafkaMessage) {\n-    return kafkaTemplate.send(topicName, key, kafkaMessage).completable();\n+  public <T> CompletableFuture<SendResult<T>> sendMessage(String topicName, String key, T kafkaMessage) {\n+    ProducerRecord<String, Object> producerRecord = new ProducerRecord<>(topicName, key, kafkaMessage);", "originalCommit": "36aa3aa9e6481099874199e4770342d8c86ca672", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyMTk3OQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/229#discussion_r388121979", "bodyText": "\u0442\u0435\u043f\u0435\u0440\u044c \u0432\u0441\u0435 \u043f\u043e-\u0447\u0435\u0441\u0442\u043d\u043e\u043c\u0443, \u0431\u0435\u0437 \u0441\u0442\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u043a\u0430\u0441\u0442\u0430. \u041d\u043e \u0441\u0438\u0433\u043d\u0430\u0442\u0443\u0440\u0430 \u0440\u0430\u0441\u043f\u0443\u0445\u043b\u0430 \u043d\u0430 +1 \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442", "author": "vorobey92", "createdAt": "2020-03-05T07:42:24Z", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/producer/DefaultKafkaProducer.java", "diffHunk": "@@ -1,22 +1,43 @@\n package ru.hh.nab.kafka.producer;\n \n import java.util.concurrent.CompletableFuture;\n+import org.apache.kafka.clients.producer.ProducerRecord;\n import org.springframework.kafka.core.KafkaTemplate;\n import org.springframework.kafka.support.SendResult;\n \n-public class DefaultKafkaProducer<T> implements KafkaProducer<T> {\n+public class DefaultKafkaProducer implements KafkaProducer {\n \n-  private final KafkaTemplate<String, T> kafkaTemplate;\n+  private final KafkaTemplate<String, Object> kafkaTemplate;\n \n-  public DefaultKafkaProducer(KafkaTemplate<String, T> kafkaTemplate) {\n+  public DefaultKafkaProducer(KafkaTemplate<String, Object> kafkaTemplate) {\n     this.kafkaTemplate = kafkaTemplate;\n   }\n \n-  public CompletableFuture<SendResult<String, T>> sendMessage(String topicName, T kafkaMessage) {\n-    return sendMessage(topicName, null, kafkaMessage);\n+  public <T> CompletableFuture<KafkaSendResult<T>> sendMessage(String topicName, Class<T> messageType, T kafkaMessage) {\n+    return sendMessage(topicName, null, messageType, kafkaMessage);\n   }\n \n-  public CompletableFuture<SendResult<String, T>> sendMessage(String topicName, String key, T kafkaMessage) {\n-    return kafkaTemplate.send(topicName, key, kafkaMessage).completable();\n+  public <T> CompletableFuture<KafkaSendResult<T>> sendMessage(String topicName, String key, Class<T> messageType, T kafkaMessage) {\n+    return kafkaTemplate.send(topicName, key, kafkaMessage)\n+        .completable()\n+        .thenApply(springResult -> convertSpringSendResult(springResult, messageType));\n+  }\n+\n+  private <T> KafkaSendResult<T> convertSpringSendResult(SendResult<String, Object> springResult, Class<T> messageType) {\n+    return new KafkaSendResult<>(\n+        convertProducerRecord(springResult.getProducerRecord(), messageType),\n+        springResult.getRecordMetadata()\n+    );\n+  }\n+\n+  private <T> ProducerRecord<String, T> convertProducerRecord(ProducerRecord<String, Object> initial, Class<T> messageType) {\n+    return new ProducerRecord<>(\n+        initial.topic(),\n+        initial.partition(),\n+        initial.timestamp(),\n+        initial.key(),\n+        messageType.cast(initial.value()),", "originalCommit": "b54ffe029dcbd3cc8462a9e59375ae15470d35df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2fd8291a75855f666733d6d8d9662f8aa26cdaea", "url": "https://github.com/hhru/nuts-and-bolts/commit/2fd8291a75855f666733d6d8d9662f8aa26cdaea", "message": "HH-104397 remove generification from KafkaProducer interface", "committedDate": "2020-03-05T07:54:03Z", "type": "commit"}, {"oid": "2fd8291a75855f666733d6d8d9662f8aa26cdaea", "url": "https://github.com/hhru/nuts-and-bolts/commit/2fd8291a75855f666733d6d8d9662f8aa26cdaea", "message": "HH-104397 remove generification from KafkaProducer interface", "committedDate": "2020-03-05T07:54:03Z", "type": "forcePushed"}]}