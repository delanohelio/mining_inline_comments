{"pr_number": 280, "pr_title": "HH-120026 consul de\\registration fix", "pr_createdAt": "2020-11-23T12:43:56Z", "pr_url": "https://github.com/hhru/nuts-and-bolts/pull/280", "timeline": [{"oid": "9a9e765d4bf38a3e8828e80a35aa5b7a20008753", "url": "https://github.com/hhru/nuts-and-bolts/commit/9a9e765d4bf38a3e8828e80a35aa5b7a20008753", "message": "HH-120026 fix serviceId", "committedDate": "2020-11-20T14:13:21Z", "type": "commit"}, {"oid": "8cede7688f70325b9fc4a14269e8e823c450b529", "url": "https://github.com/hhru/nuts-and-bolts/commit/8cede7688f70325b9fc4a14269e8e823c450b529", "message": "HH-120026 make registration setting more clear", "committedDate": "2020-11-23T09:34:30Z", "type": "commit"}, {"oid": "caa28fe63969632cbe77af3c8e056e6b342f4b76", "url": "https://github.com/hhru/nuts-and-bolts/commit/caa28fe63969632cbe77af3c8e056e6b342f4b76", "message": "HH-120026 fix de\\registration lifecycle", "committedDate": "2020-11-23T12:42:28Z", "type": "commit"}, {"oid": "0aff8da5d3241e51fc515a2eac4cc3333c555e96", "url": "https://github.com/hhru/nuts-and-bolts/commit/0aff8da5d3241e51fc515a2eac4cc3333c555e96", "message": "HH-120026 fix example", "committedDate": "2020-11-23T12:42:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4OTU2Mw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/280#discussion_r528689563", "bodyText": "interruptedFlag?", "author": "pvorlov", "createdAt": "2020-11-23T13:06:52Z", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -98,14 +98,22 @@ public void register() {\n     return kvClient.getValueAsString(String.format(\"host/%s/weight\", hostName));\n   }\n \n-  @PreDestroy\n-  void deregister() {\n+  public void deregister() {\n     if (enabled) {\n       agentClient.deregister(service.getId());\n+      LOGGER.debug(\"De-registered id: {} from consul, going to sleep {}ms to wait possible requests\", id, sleepAfterDeregisterMillis);\n+      trySleep();\n       LOGGER.info(\"De-registered id: {} from consul\", id);\n     }\n   }\n \n+  private void trySleep() {\n+    try {\n+      Thread.sleep(sleepAfterDeregisterMillis);\n+    } catch (InterruptedException ignored) {", "originalCommit": "0aff8da5d3241e51fc515a2eac4cc3333c555e96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "86f07d282ee082f74d2253421564870029aa9454", "url": "https://github.com/hhru/nuts-and-bolts/commit/86f07d282ee082f74d2253421564870029aa9454", "message": "HH-120026 throw interruptedexception if any", "committedDate": "2020-11-23T15:52:04Z", "type": "commit"}]}