{"pr_number": 286, "pr_title": "HH-121275 move test loggins into logback configurator + small build log cleanup", "pr_createdAt": "2020-12-13T19:37:51Z", "pr_url": "https://github.com/hhru/nuts-and-bolts/pull/286", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTU5Mg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r541991592", "bodyText": "\u043c\u043d\u0435 \u043d\u0443\u0436\u043d\u043e \u0431\u044b\u043b\u043e \u0447\u0442\u043e\u0431\u044b \u0430\u043f\u043f\u0435\u043d\u0434\u0435\u0440 \u043c\u043e\u0433 \u043f\u0438\u0441\u0430\u0442\u044c \u0432 \u0444\u0430\u0439\u043b \u0434\u0430\u0436\u0435 \u0441 \u0432\u043a\u043b\u044e\u0447\u0435\u043d\u043d\u044b\u043c \u043f\u0440\u043e\u043f\u0435\u0440\u0442\u0438 LOG_TO_CONSOLE_PROPERTY_KEY, \u043d\u0438\u0447\u0435\u0433\u043e \u043b\u0443\u0447\u0448\u0435 \u043d\u0435 \u043f\u0440\u0438\u0434\u0443\u043c\u0430\u043b, \u0447\u0442\u043e\u0431\u044b \u043d\u0435 \u043f\u0440\u0438\u0448\u043b\u043e\u0441\u044c \u0432\u043e \u0432\u0441\u0435\u0445 \u043f\u0440\u043e\u0435\u043a\u0442\u0430\u0445 \u043f\u0440\u0430\u0432\u0438\u0442\u044c (", "author": "SCREEN88", "createdAt": "2020-12-13T19:46:08Z", "path": "nab-logging/src/main/java/ru/hh/nab/logging/HhMultiAppender.java", "diffHunk": "@@ -11,31 +11,36 @@\n import ch.qos.logback.core.encoder.LayoutWrappingEncoder;\n import ch.qos.logback.core.spi.ContextAware;\n import ch.qos.logback.core.spi.LifeCycle;\n+import static java.util.Optional.ofNullable;\n import java.util.function.Supplier;\n-\n import org.apache.commons.lang3.StringUtils;\n import ru.hh.nab.logging.json.NabJsonEncoder;\n import ru.hh.nab.logging.json.NabJsonLayout;\n-import static java.util.Optional.ofNullable;\n \n public class HhMultiAppender extends UnsynchronizedAppenderBase<ILoggingEvent> {\n-\n-  public HhMultiAppender() {\n-  }\n-\n-  public HhMultiAppender(boolean json) {\n-    this.json = json;\n-  }\n-\n   public static final String LOG_TO_CONSOLE_PROPERTY_KEY = \"log.toConsole\";\n   public static final String LOG_PATTERN_PROPERTY_KEY = \"log.pattern\";\n+  private final boolean logToConsole;\n \n   protected Appender<ILoggingEvent> appender;\n   protected Supplier<Layout<ILoggingEvent>> layoutSupplier;\n   protected Supplier<Encoder<ILoggingEvent>> encoderSupplier;\n   protected String pattern;\n   protected boolean json;\n \n+  public HhMultiAppender() {\n+    this.logToConsole = true;\n+  }\n+\n+  public HhMultiAppender(boolean json, boolean logToConsole) {", "originalCommit": "8a4fcb828d1e2fe03e4cab11b4d36a6e1e9c1e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5Nzk2NA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543297964", "bodyText": "\u0440\u0430\u0441\u0441\u043a\u0430\u0436\u0438 \u0447\u0443\u0442\u044c \u0431\u043e\u043b\u044c\u0448\u0435. \u0438\u0437 \u043a\u043e\u0434\u0430 \u0432\u043e\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u043d\u0435 \u043c\u043e\u0433\u0443", "author": "dzharikhin", "createdAt": "2020-12-15T12:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxMTczNw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543311737", "bodyText": "\u0435\u0441\u043b\u0438 \u0432\u043e\u0442 \u0442\u0443\u0442 https://github.com/hhru/nuts-and-bolts/pull/286/files#diff-576068c88458d107c252cf9fea0f4a3494ae55dea0226ddff47420cb345c9ce7L78  \u043f\u0440\u0438\u043b\u0435\u0442\u0438\u0442 true, \u0442\u043e \u043c\u044b \u0432\u0441\u0435\u0433\u0434\u0430 \u0431\u0443\u0434\u0435\u043c \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e ConsoleAppender", "author": "SCREEN88", "createdAt": "2020-12-15T12:46:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQwMzc2Nw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543403767", "bodyText": "\u043d\u0443 \u044d\u0442\u043e \u0436 \u0442\u0430\u043a \u0438 \u0434\u043e\u043b\u0436\u043d\u043e \u0440\u0430\u0431\u043e\u0442\u0430\u0442\u044c - \u0435\u0441\u043b\u0438 \u043d\u0430\u0434\u043e \u043d\u0435 \u0432 \u043a\u043e\u043d\u0441\u043e\u043b\u044c - \u043d\u0435 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0439 \u043f\u0440\u043e\u043f\u0435\u0440\u0442\u044e", "author": "dzharikhin", "createdAt": "2020-12-15T14:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTg2MA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r541991860", "bodyText": "\u0447\u0442\u043e\u0431\u044b \u043c\u043e\u0436\u043d\u043e \u0431\u044b\u043b\u043e \u043e\u0442\u043a\u043b\u044e\u0447\u0430\u0442\u044c StatusListener \u0434\u043b\u044f \u0442\u0435\u0441\u0442\u043e\u0432, Properties \u043f\u0435\u0440\u0435\u0434\u0430\u044e \u0447\u0442\u043e\u0431\u044b \u043c\u043e\u0436\u043d\u043e \u0431\u044b\u043b\u043e \u044d\u0442\u043e \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c", "author": "SCREEN88", "createdAt": "2020-12-13T19:47:33Z", "path": "nab-logging/src/main/java/ru/hh/nab/logging/NabLoggingConfiguratorTemplate.java", "diffHunk": "@@ -44,6 +41,12 @@ public final void configure(LoggerContext context) {\n     appenders = null;\n   }\n \n+  protected void statusListener(LoggerContext context, Properties properties) {", "originalCommit": "8a4fcb828d1e2fe03e4cab11b4d36a6e1e9c1e5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTk4OA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r541991988", "bodyText": "\u0434\u043e\u0431\u0430\u0432\u0438\u043b ch.qos.logback.classic.Level \u043f\u043e\u0442\u043e\u043c\u0443-\u0447\u0442\u043e \u0432 spy \u043d\u0435\u0442 Level.OFF", "author": "SCREEN88", "createdAt": "2020-12-13T19:48:34Z", "path": "nab-logging/src/main/java/ru/hh/nab/logging/NabLoggingConfiguratorTemplate.java", "diffHunk": "@@ -106,8 +109,13 @@ public LoggerWrapper createLogger(LoggingContextWrapper context, Class<?> aClass\n \n   public LoggerWrapper createLogger(LoggingContextWrapper context, String name, Level level, boolean additivity,\n       Collection<Appender> appenders) {\n+    return createLogger(context, name, ch.qos.logback.classic.Level.toLevel(level.toString()), additivity, appenders);\n+  }\n+\n+  public LoggerWrapper createLogger(LoggingContextWrapper context, String name, ch.qos.logback.classic.Level level, boolean additivity,", "originalCommit": "8a4fcb828d1e2fe03e4cab11b4d36a6e1e9c1e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwMjY4Ng==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543302686", "bodyText": "\u043c\u044b \u043d\u0435 \u0442\u043e\u0440\u0447\u0438\u043c \u0438\u043c \u043d\u0430\u0440\u0443\u0436\u0443 - \u044d\u0442\u043e \u0440\u0435\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f. \u043c\u043e\u0436\u0435\u043c \u0442\u043e\u0440\u0447\u0430\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e api", "author": "dzharikhin", "createdAt": "2020-12-15T12:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxMjM4Ng==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543312386", "bodyText": "\u043d\u0435 \u043f\u043e\u043d\u044f\u043b (", "author": "SCREEN88", "createdAt": "2020-12-15T12:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQwNzU3MA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543407570", "bodyText": "slf4j \u043f\u043e\u043c\u043e\u0433\u0430\u0435\u0442 \u0435\u0441\u043b\u0438 \u0437\u0430\u0445\u043e\u0447\u0435\u0442\u0441\u044f \u043f\u043e\u0434\u043c\u0435\u043d\u0438\u0442\u044c \u0431\u044d\u043a\u0435\u043d\u0434 \u043b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f - \u043d\u0430\u0434\u043e\u0435\u0441\u0442 \u043b\u043e\u0433\u0431\u044d\u043a, \u043f\u043e\u043c\u0435\u043d\u044f\u0435\u043c.\n\u0435\u0441\u043b\u0438 \u043b\u043e\u0433\u0431\u044d\u043a \u0431\u0443\u0434\u0435\u0442 \u0442\u043e\u0440\u0447\u0430\u0442\u044c \u043d\u0430\u0440\u0443\u0436\u0443 - \u044d\u0442\u043e \u0441\u0442\u0430\u043d\u0435\u0442 \u043d\u0435\u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e.\n\u043d\u043e OFF \u0442\u0430\u043c \u0440\u0435\u0430\u043b\u044c\u043d\u043e \u043d\u0435\u0442. \u0432\u043e \u0432\u0442\u043e\u0440\u0443\u044e \u0432\u0435\u0440\u0441\u0438\u044e \u0434\u043e\u0431\u0430\u0432\u0438\u043b\u0438, \u043d\u043e \u043e\u043d\u0430 \u0432\u0441\u0435 \u043d\u0438\u043a\u0430\u043a \u0438\u0437 \u0430\u043b\u044c\u0444\u044b \u043d\u0435 \u0432\u044b\u0439\u0434\u0435\u0442. \u043f\u043e\u044d\u0442\u043e\u043c\u0443 \u043f\u043e\u043a\u0430 \u043c\u043e\u0436\u043d\u043e \u043b\u0438\u0431\u043e \u043f\u043e\u0434 \u0441\u0442\u0440\u043e\u0447\u043a\u0443 \u043c\u0435\u0442\u043e\u0434\u044b \u0432\u044b\u0441\u0442\u0430\u0432\u0438\u0442\u044c(\u043d\u0435\u043f\u0440\u0438\u044f\u0442\u043d\u043e, \u0437\u0430\u0442\u043e \u0443\u043d\u0438\u0432\u0435\u0440\u0441\u0430\u043b\u044c\u043d\u043e), \u043b\u0438\u0431\u043e \u0441\u0432\u043e\u0439 \u0435\u043d\u0443\u043c\u0447\u0438\u043a, \u0447\u0442\u043e\u0431\u044b \u043d\u0435 \u0442\u043e\u0440\u0447\u0430\u0442\u044c \u0432 \u0430\u043f\u0438 \u043b\u043e\u0433\u0431\u044d\u043a\u043e\u043c", "author": "dzharikhin", "createdAt": "2020-12-15T14:45:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MTk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MjIwMQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r541992201", "bodyText": "\u0438\u043d\u043e\u0433\u0434\u0430 \u0443\u0434\u043e\u0431\u043d\u043e \u0432\u044b\u0442\u0430\u0449\u0438\u0442\u044c \u043b\u043e\u0433\u0433\u0435\u0440, \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0430\u043f\u043f\u0435\u043d\u0434\u0435\u0440 \u0438 \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u0432\u043e\u0439, \u0447\u0442\u043e\u0431\u044b \u043d\u0435 \u043f\u0435\u0440\u0435\u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0442\u044c \u043b\u0438\u0448\u043d\u0438\u0439 \u0440\u0430\u0437", "author": "SCREEN88", "createdAt": "2020-12-13T19:49:45Z", "path": "nab-logging/src/main/java/ru/hh/nab/logging/NabLoggingConfiguratorTemplate.java", "diffHunk": "@@ -155,6 +167,14 @@ public void setAdditivity(boolean additivity) {\n     public void addAppenders(Appender... appenders) {\n       Stream.of(appenders).forEach(logger::addAppender);\n     }\n+\n+    public void addAppenders(Collection<Appender> appenders) {\n+      appenders.forEach(logger::addAppender);\n+    }\n+\n+    public void detachAppenders(Appender... appenders) {", "originalCommit": "8a4fcb828d1e2fe03e4cab11b4d36a6e1e9c1e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwMjE5Mg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543302192", "bodyText": "\u0437\u0430\u0447\u0435\u043c \u0432\u0430\u0440\u0430\u0440\u0433? \u043d\u0443 \u043a\u043e\u043b\u043b\u0435\u043a\u0446\u0438\u044e \u0438 \u043f\u0435\u0440\u0435\u0434\u0430\u0432\u0430\u0439", "author": "dzharikhin", "createdAt": "2020-12-15T12:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxMjQ5NA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543312494", "bodyText": "\u043e\u043a", "author": "SCREEN88", "createdAt": "2020-12-15T12:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MjIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MjQwNg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r541992406", "bodyText": "\u0443\u0434\u0430\u043b\u0438\u043b \u0442\u0443\u0442 logback.xml, \u0434\u043e\u0431\u0430\u0432\u0438\u043b \u043f\u0440\u0438\u043c\u0438\u0442\u0438\u0432\u043d\u044b\u0439 Configurator, \u0438\u0437 testCaseBase \u043f\u043e\u0434\u0442\u044f\u043d\u0443\u0442\u044c \u043d\u0435\u043b\u044c\u0437\u044f", "author": "SCREEN88", "createdAt": "2020-12-13T19:51:02Z", "path": "nab-starter/src/test/java/ru/hh/nab/starter/NabStarterTestLogbackBaseConfigurator.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package ru.hh.nab.starter;\n+\n+import ch.qos.logback.classic.Level;\n+import java.util.Properties;\n+import static ru.hh.nab.common.properties.PropertiesUtils.SETINGS_DIR_PROPERTY;\n+import ru.hh.nab.logging.NabLoggingConfiguratorTemplate;\n+\n+public class NabStarterTestLogbackBaseConfigurator extends NabLoggingConfiguratorTemplate {", "originalCommit": "8a4fcb828d1e2fe03e4cab11b4d36a6e1e9c1e5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5Mjg2Mw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r541992863", "bodyText": "\u043a\u0430\u0436\u0435\u0442\u0441\u044f \u0447\u0442\u043e \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u0438\u043d\u043e\u0433\u0434\u0430 \u043f\u043e\u043b\u0435\u0437\u043d\u043e \u043f\u0438\u0441\u0430\u0442\u044c \u0432\u0435\u0441\u044c \u043b\u043e\u0433 \u0432 \u043e\u0434\u0438\u043d \u0444\u0430\u0439\u043b", "author": "SCREEN88", "createdAt": "2020-12-13T19:53:27Z", "path": "nab-testbase/src/main/java/ru/hh/nab/testbase/TestLogbackBaseConfigurator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package ru.hh.nab.testbase;\n+\n+import ch.qos.logback.classic.Level;\n+import ch.qos.logback.classic.LoggerContext;\n+import ch.qos.logback.core.Appender;\n+import ch.qos.logback.core.status.NopStatusListener;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import static ru.hh.nab.common.properties.PropertiesUtils.SETINGS_DIR_PROPERTY;\n+import ru.hh.nab.logging.HhMultiAppender;\n+import ru.hh.nab.logging.NabLoggingConfiguratorTemplate;\n+import static ru.hh.nab.testbase.NabTestConfig.TEST_PROPERTIES_FILE_NAME;\n+\n+@SuppressWarnings(\"rawtypes\")\n+public class TestLogbackBaseConfigurator extends NabLoggingConfiguratorTemplate {\n+\n+  @Override\n+  protected Properties createLoggingProperties() {\n+    System.setProperty(SETINGS_DIR_PROPERTY, \".\");\n+    Properties properties = createProperties();\n+    setPropertyIfNotSet(properties, \"log.pattern\", \"[%date{ISO8601}] %-5level %logger{36}:%line mdc={%mdc} - %msg%n\");\n+    setPropertyIfNotSet(properties, \"log.dir\", \"logs\");\n+    setPropertyIfNotSet(properties, \"log.immediate.flush\", Boolean.TRUE.toString());\n+    return properties;\n+  }\n+\n+  @Override\n+  protected void statusListener(LoggerContext context, Properties properties) {\n+    if (Boolean.parseBoolean(properties.getProperty(\"log.show.status\", \"false\"))) {\n+      super.statusListener(context, properties);\n+    } else {\n+      context.getStatusManager().add(new NopStatusListener());\n+    }\n+  }\n+\n+  @Override\n+  public final void configure(LoggingContextWrapper context) {\n+    var rootLogger = getRootLogger(context);\n+    Level rootLevel = context.getProperty(\"log.root.level\", Level.ERROR, level -> Level.valueOf(level.toUpperCase()));\n+    rootLogger.setLevel(rootLevel);\n+    Set<Appender> appenders = new HashSet<>();\n+    if (Boolean.parseBoolean(context.getProperty(\"log.toConsole\", \"true\"))) {\n+      appenders.add(createAppender(context, \"console\", () -> new HhMultiAppender(false)));\n+    }\n+    if (Boolean.parseBoolean(context.getProperty(\"log.write.into.file\", \"false\"))\n+        || Boolean.parseBoolean(context.getProperty(\"log.toFile\", \"false\"))) {\n+      String logFileName = context.getProperty(\"log.filename\", \"tests\");\n+      appenders.add(createAppender(context, logFileName, () -> new HhMultiAppender(false, false)));", "originalCommit": "8a4fcb828d1e2fe03e4cab11b4d36a6e1e9c1e5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MzAwNA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r541993004", "bodyText": "\u0432\u0437\u044f\u043b \u043a\u0430\u043a\u0438\u0435-\u0442\u043e \u0431\u0430\u0437\u043e\u0432\u044b\u0435 \u0432\u0435\u0449\u0438, \u043e\u0431\u0441\u0443\u0436\u0434\u0430\u0435\u043c\u043e", "author": "SCREEN88", "createdAt": "2020-12-13T19:54:30Z", "path": "nab-testbase/src/main/java/ru/hh/nab/testbase/TestLogbackBaseConfigurator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package ru.hh.nab.testbase;\n+\n+import ch.qos.logback.classic.Level;\n+import ch.qos.logback.classic.LoggerContext;\n+import ch.qos.logback.core.Appender;\n+import ch.qos.logback.core.status.NopStatusListener;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import static ru.hh.nab.common.properties.PropertiesUtils.SETINGS_DIR_PROPERTY;\n+import ru.hh.nab.logging.HhMultiAppender;\n+import ru.hh.nab.logging.NabLoggingConfiguratorTemplate;\n+import static ru.hh.nab.testbase.NabTestConfig.TEST_PROPERTIES_FILE_NAME;\n+\n+@SuppressWarnings(\"rawtypes\")\n+public class TestLogbackBaseConfigurator extends NabLoggingConfiguratorTemplate {\n+\n+  @Override\n+  protected Properties createLoggingProperties() {\n+    System.setProperty(SETINGS_DIR_PROPERTY, \".\");\n+    Properties properties = createProperties();\n+    setPropertyIfNotSet(properties, \"log.pattern\", \"[%date{ISO8601}] %-5level %logger{36}:%line mdc={%mdc} - %msg%n\");\n+    setPropertyIfNotSet(properties, \"log.dir\", \"logs\");\n+    setPropertyIfNotSet(properties, \"log.immediate.flush\", Boolean.TRUE.toString());\n+    return properties;\n+  }\n+\n+  @Override\n+  protected void statusListener(LoggerContext context, Properties properties) {\n+    if (Boolean.parseBoolean(properties.getProperty(\"log.show.status\", \"false\"))) {\n+      super.statusListener(context, properties);\n+    } else {\n+      context.getStatusManager().add(new NopStatusListener());\n+    }\n+  }\n+\n+  @Override\n+  public final void configure(LoggingContextWrapper context) {\n+    var rootLogger = getRootLogger(context);\n+    Level rootLevel = context.getProperty(\"log.root.level\", Level.ERROR, level -> Level.valueOf(level.toUpperCase()));\n+    rootLogger.setLevel(rootLevel);\n+    Set<Appender> appenders = new HashSet<>();\n+    if (Boolean.parseBoolean(context.getProperty(\"log.toConsole\", \"true\"))) {\n+      appenders.add(createAppender(context, \"console\", () -> new HhMultiAppender(false)));\n+    }\n+    if (Boolean.parseBoolean(context.getProperty(\"log.write.into.file\", \"false\"))\n+        || Boolean.parseBoolean(context.getProperty(\"log.toFile\", \"false\"))) {\n+      String logFileName = context.getProperty(\"log.filename\", \"tests\");\n+      appenders.add(createAppender(context, logFileName, () -> new HhMultiAppender(false, false)));\n+    }\n+    loggers().forEach((name, level) -> createLogger(context, name, rootLevel, false, appenders));\n+    rootLogger.addAppenders(appenders);\n+  }\n+\n+  protected Map<String, Level> loggers() {\n+    return new HashMap<>() {{\n+      put(\"org.hibernate.tool.hbm2ddl\", Level.INFO);\n+      put(\"org.hibernate.orm.deprecation\", Level.OFF);\n+      put(\"com.opentable.db.postgres.embedded\", Level.INFO);\n+      put(\"org.testcontainers\", Level.INFO);\n+      put(\"org.testcontainers.utility.ResourceReaper\", Level.OFF);", "originalCommit": "8a4fcb828d1e2fe03e4cab11b4d36a6e1e9c1e5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce6789f6f064cff42e21bc2509ad874a831c2aaa", "url": "https://github.com/hhru/nuts-and-bolts/commit/ce6789f6f064cff42e21bc2509ad874a831c2aaa", "message": "HH-121275 move test loggins into logback configurator + small build log cleanup", "committedDate": "2020-12-13T22:57:27Z", "type": "forcePushed"}, {"oid": "232b9e151a2226acbfb1b2b4afed4618d3099b88", "url": "https://github.com/hhru/nuts-and-bolts/commit/232b9e151a2226acbfb1b2b4afed4618d3099b88", "message": "HH-121275 move test loggins into logback configurator + small build log cleanup", "committedDate": "2020-12-13T22:58:43Z", "type": "commit"}, {"oid": "232b9e151a2226acbfb1b2b4afed4618d3099b88", "url": "https://github.com/hhru/nuts-and-bolts/commit/232b9e151a2226acbfb1b2b4afed4618d3099b88", "message": "HH-121275 move test loggins into logback configurator + small build log cleanup", "committedDate": "2020-12-13T22:58:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNDY2NA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543304664", "bodyText": "\u043f\u043e\u0432\u044b\u0448\u0435\u043d\u043d\u0430\u044f \u0435\u043b\u043e\u0447\u043d\u043e\u0441\u0442\u044c. \u043c\u043e\u0436\u0435\u0442 \u043a\u0430\u043a-\u0442\u043e \u0432\u0441\u0435 \u0432 \u043e\u0434\u0438\u043d try \u0441 \u043b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\u043c \u0438 new Properties() \u0435\u0441\u043b\u0438 \u0447\u0442\u043e-\u0442\u043e \u0438\u0434\u0435\u0442 \u043d\u0435 \u0442\u0430\u043a?", "author": "dzharikhin", "createdAt": "2020-12-15T12:35:05Z", "path": "nab-testbase/src/main/java/ru/hh/nab/testbase/TestLogbackBaseConfigurator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package ru.hh.nab.testbase;\n+\n+import ch.qos.logback.classic.Level;\n+import ch.qos.logback.classic.LoggerContext;\n+import ch.qos.logback.core.Appender;\n+import ch.qos.logback.core.status.NopStatusListener;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import static ru.hh.nab.common.properties.PropertiesUtils.SETINGS_DIR_PROPERTY;\n+import ru.hh.nab.logging.HhMultiAppender;\n+import ru.hh.nab.logging.NabLoggingConfiguratorTemplate;\n+import static ru.hh.nab.testbase.NabTestConfig.TEST_PROPERTIES_FILE_NAME;\n+\n+@SuppressWarnings(\"rawtypes\")\n+public class TestLogbackBaseConfigurator extends NabLoggingConfiguratorTemplate {\n+\n+  @Override\n+  protected Properties createLoggingProperties() {\n+    System.setProperty(SETINGS_DIR_PROPERTY, \".\");\n+    Properties properties = createProperties();\n+    setPropertyIfNotSet(properties, \"log.pattern\", \"[%date{ISO8601}] %-5level %logger{36}:%line mdc={%mdc} - %msg%n\");\n+    setPropertyIfNotSet(properties, \"log.dir\", \"logs\");\n+    setPropertyIfNotSet(properties, \"log.immediate.flush\", Boolean.TRUE.toString());\n+    return properties;\n+  }\n+\n+  @Override\n+  protected void statusListener(LoggerContext context, Properties properties) {\n+    if (Boolean.parseBoolean(properties.getProperty(\"log.show.status\", \"false\"))) {\n+      super.statusListener(context, properties);\n+    } else {\n+      context.getStatusManager().add(new NopStatusListener());\n+    }\n+  }\n+\n+  @Override\n+  public final void configure(LoggingContextWrapper context) {\n+    var rootLogger = getRootLogger(context);\n+    Level rootLevel = context.getProperty(\"log.root.level\", Level.ERROR, level -> Level.valueOf(level.toUpperCase()));\n+    rootLogger.setLevel(rootLevel);\n+    Set<Appender> appenders = new HashSet<>();\n+    if (Boolean.parseBoolean(context.getProperty(\"log.toConsole\", \"true\"))) {\n+      appenders.add(createAppender(context, \"console\", () -> new HhMultiAppender(false)));\n+    }\n+    if (Boolean.parseBoolean(context.getProperty(\"log.write.into.file\", \"false\"))\n+        || Boolean.parseBoolean(context.getProperty(\"log.toFile\", \"false\"))) {\n+      String logFileName = context.getProperty(\"log.filename\", \"tests\");\n+      appenders.add(createAppender(context, logFileName, () -> new HhMultiAppender(false, false)));\n+    }\n+    loggers().forEach((name, level) -> createLogger(context, name, rootLevel, false, appenders));\n+    rootLogger.addAppenders(appenders);\n+  }\n+\n+  protected Map<String, Level> loggers() {\n+    return new HashMap<>() {{\n+      put(\"org.hibernate.tool.hbm2ddl\", Level.INFO);\n+      put(\"org.hibernate.orm.deprecation\", Level.OFF);\n+      put(\"com.opentable.db.postgres.embedded\", Level.INFO);\n+      put(\"org.testcontainers\", Level.INFO);\n+      put(\"org.testcontainers.utility.ResourceReaper\", Level.OFF);\n+    }};\n+  }\n+\n+  protected Properties createProperties() {\n+    InputStream inputStream = this.getClass().getResourceAsStream(TEST_PROPERTIES_FILE_NAME);\n+    if (inputStream == null) {\n+      return new Properties();\n+    }\n+    try {\n+      Properties properties = new Properties();\n+      properties.load(inputStream);\n+      return properties;\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(e);", "originalCommit": "232b9e151a2226acbfb1b2b4afed4618d3099b88", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxMzMwNQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543313305", "bodyText": "\u0442\u043e\u0433\u0434\u0430 \u043f\u0440\u0438\u0434\u0435\u0442\u0441\u044f \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0434\u0432\u0430 catch, \u043e\u0434\u0438\u043d \u0434\u043b\u044f NullPointerException, \u0432\u0442\u043e\u0440\u043e\u0439 IOException, \u043e\u0431\u044a\u0435\u0434\u0438\u043d\u0438\u0442\u044c \u0438\u0445 \u043d\u0435 \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c\u0441\u044f", "author": "SCREEN88", "createdAt": "2020-12-15T12:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNDY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQwOTEwMw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543409103", "bodyText": "\u043d\u0443 \u043a\u0430\u043a \u043f\u043e \u043c\u043d\u0435 \u044d\u0442\u043e \u043b\u0443\u0447\u0448\u0435 \u0441\u043c\u043e\u0442\u0440\u0438\u0442\u0441\u044f", "author": "dzharikhin", "createdAt": "2020-12-15T14:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNDY2NA=="}], "type": "inlineReview"}, {"oid": "9e6783826d5558eac8799fa3955ca553b8913cec", "url": "https://github.com/hhru/nuts-and-bolts/commit/9e6783826d5558eac8799fa3955ca553b8913cec", "message": "HH-121275 fixes after review - 1", "committedDate": "2020-12-15T15:33:16Z", "type": "commit"}, {"oid": "9e6783826d5558eac8799fa3955ca553b8913cec", "url": "https://github.com/hhru/nuts-and-bolts/commit/9e6783826d5558eac8799fa3955ca553b8913cec", "message": "HH-121275 fixes after review - 1", "committedDate": "2020-12-15T15:33:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1OTI3NA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/286#discussion_r543459274", "bodyText": "\u0442\u0443\u0442 \u043a\u0430\u0436\u0435\u0442\u0441\u044f \u0442\u043e\u043b\u044c\u043a\u043e \u043e\u0442\u0441\u0442\u0443\u043f\u044b \u043f\u0435\u0440\u0435\u043a\u043b\u0430\u0434\u044b\u0432\u0430\u043d\u0438\u044f", "author": "dzharikhin", "createdAt": "2020-12-15T15:45:56Z", "path": "nab-logging/src/main/java/ru/hh/nab/logging/HhMultiAppender.java", "diffHunk": "@@ -36,6 +27,13 @@ public HhMultiAppender(boolean json) {\n   protected String pattern;\n   protected boolean json;\n \n+  public HhMultiAppender() {", "originalCommit": "9e6783826d5558eac8799fa3955ca553b8913cec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}