{"pr_number": 261, "pr_title": "HH-115630 migrate consul to orbitz", "pr_createdAt": "2020-09-04T09:30:14Z", "pr_url": "https://github.com/hhru/nuts-and-bolts/pull/261", "timeline": [{"oid": "a476f28e51a2894f143968e9d3770db9fa3dfbd3", "url": "https://github.com/hhru/nuts-and-bolts/commit/a476f28e51a2894f143968e9d3770db9fa3dfbd3", "message": "HH-115630 migrate consul to orbitz", "committedDate": "2020-09-04T09:29:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNzA4OA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/261#discussion_r484507088", "bodyText": "\u0420\u0430\u0437 \u0442\u0435\u043f\u0435\u0440\u044c \u044d\u0442\u043e \u0431\u0438\u043d, \u0442\u043e \u0434\u0443\u043c\u0430\u044e \u044d\u0442\u043e\u0442 \u0433\u0435\u0442\u0442\u0435\u0440 \u0431\u0435\u0441\u0441\u043c\u044b\u0441\u043b\u0435\u043d\u0435\u043d. \u0410 \u0447\u0442\u043e \u0434\u0435\u043b\u0430\u0442\u044c \u0435\u0441\u043b\u0438 \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u043c \u043f\u043e\u043d\u0430\u0434\u043e\u0431\u044f\u0442\u0441\u044f \u0434\u0440\u0443\u0433\u0438\u0435 \u043a\u043b\u0438\u0435\u043d\u0442\u044b? ConsulClient \u043e\u0442 ecwid \u043e\u0431\u044a\u0435\u0434\u0438\u043d\u044f\u043b \u0438\u0445 \u0444\u0430\u043a\u0442\u0438\u0447\u0435\u0441\u043a\u0438. logginig-configurator \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 catalog client. \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c\u0441\u044f \u043d\u0430 \u044d\u0442\u0443 \u0432\u0435\u0440\u0441\u0438\u044e \u043d\u0435 \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u0441\u044f, \u043f\u0440\u0438\u0434\u0451\u0442\u0441\u044f \u0441\u043d\u0430\u0447\u0430\u043b\u0430 \u043f\u0438\u0441\u0430\u0442\u044c \u043a\u043e\u0434 \u0432 nab \u043f\u043e\u0442\u043e\u043c \u043e\u0431\u043d\u043e\u0432\u043b\u044f\u0442\u044c \u0441\u0435\u0440\u0432\u0438\u0441. \u041a\u0430\u043a-\u0442\u043e \u0448\u0430\u0442\u043a\u043e \u043f\u043e\u043b\u0443\u0447\u0438\u043b\u043e\u0441\u044c.", "author": "pvorlov", "createdAt": "2020-09-07T16:04:34Z", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -37,39 +40,39 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    NewService.Check check = new NewService.Check();\n-    check.setHttp(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\");\n-    check.setTimeout(fileSettings.getString(\"consul.check.timeout\"));\n-    check.setInterval(fileSettings.getString(\"consul.check.interval\"));\n-    check.setMethod(\"GET\");\n-    check.setStatus(\"passing\");\n-\n-    NewService service = new NewService();\n-    service.setId(id);\n-    service.setName(fileSettings.getString(\"serviceName\"));\n-    service.setPort(applicationPort);\n-    service.setAddress(address);\n-    service.setCheck(check);\n-    service.setTags(tags);\n-    service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n-\n-    this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n-    );\n+    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n+            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+            .interval(fileSettings.getString(\"consul.check.interval\"))\n+            .timeout(fileSettings.getString(\"consul.check.timeout\"))\n+            .build();\n+\n+    Registration service = ImmutableRegistration.builder()\n+            .id(id)\n+            .name(fileSettings.getString(\"serviceName\"))\n+            .port(applicationPort)\n+            .address(address)\n+\n+            .check(regCheck)\n+\n+            .tags(tags)\n+            .meta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()))\n+\n+            .build();\n+    agentClient.register(service);\n+\n     this.service = service;\n     this.id = id;\n     this.enabled = Optional.ofNullable(fileSettings.getBoolean(\"consul.enabled\")).orElse(true);\n   }\n \n-  public ConsulClient getClient() {\n-    return client;\n+  public AgentClient getClient() {", "originalCommit": "a476f28e51a2894f143968e9d3770db9fa3dfbd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwODM4MA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/261#discussion_r484508380", "bodyText": "\u0421 \u0434\u0440\u0443\u0433\u043e\u0439 \u0441\u0442\u043e\u0440\u043e\u043d\u044b, \u043d\u0430\u0432\u0435\u0440\u043d\u043e\u0435, \u043c\u043e\u0436\u043d\u043e \u0441\u043a\u043e\u043f\u0438\u043f\u0430\u0441\u0442\u0438\u0442\u044c \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u043a\u0430\u0442\u0430\u043b\u043e\u0433 \u043a\u043b\u0438\u0435\u043d\u0442\u0430. \u0412\u0440\u044f\u0434 \u043b\u0438 \u0443 \u043d\u0430\u0441 \u0431\u0443\u0434\u0435\u0442 \u043c\u043d\u043e\u0433\u043e \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432 \u043a\u0430\u043a logging-configurator, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u0445\u043e\u0434\u044f\u0442 \u0432 \u043a\u043e\u043d\u0441\u0443\u043b.", "author": "pvorlov", "createdAt": "2020-09-07T16:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNzA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcxMzg4OA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/261#discussion_r484713888", "bodyText": "\u0437\u0430\u0432\u0435\u043b \u0442\u0430\u0441\u043a\u0443 https://jira.hh.ru/browse/HH-115787", "author": "heruv1m", "createdAt": "2020-09-08T07:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNzA4OA=="}], "type": "inlineReview"}, {"oid": "aa988d3e7fab5acc48c5a28c42fc40dda59f5d6f", "url": "https://github.com/hhru/nuts-and-bolts/commit/aa988d3e7fab5acc48c5a28c42fc40dda59f5d6f", "message": "HH-115630 remove getClient", "committedDate": "2020-09-08T07:44:51Z", "type": "commit"}, {"oid": "fd0af9966a062f0c08b3ed8d0bca3e502e34dfd5", "url": "https://github.com/hhru/nuts-and-bolts/commit/fd0af9966a062f0c08b3ed8d0bca3e502e34dfd5", "message": "HH-115630 fix tests", "committedDate": "2020-09-08T09:06:46Z", "type": "commit"}]}