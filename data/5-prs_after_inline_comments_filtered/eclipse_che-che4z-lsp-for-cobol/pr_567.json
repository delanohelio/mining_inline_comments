{"pr_number": 567, "pr_title": "Move unsupported files notification into problems console #173", "pr_createdAt": "2020-10-20T13:47:35Z", "pr_url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUyMDg3Ng==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567#discussion_r508520876", "bodyText": "safer check: !\"testCancelProgressNotification()\".equals(info.getDisplayName())", "author": "asatklichov", "createdAt": "2020-10-20T13:50:12Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/service/delegates/communications/ServerCommunicationsTest.java", "diffHunk": "@@ -16,42 +16,157 @@\n package com.broadcom.lsp.cobol.service.delegates.communications;\n \n import com.broadcom.lsp.cobol.service.utils.FileSystemService;\n-import org.eclipse.lsp4j.MessageParams;\n-import org.eclipse.lsp4j.MessageType;\n+import com.google.inject.Provider;\n+import org.eclipse.lsp4j.*;\n import org.eclipse.lsp4j.services.LanguageClient;\n+import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n-import org.mockito.ArgumentCaptor;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.internal.util.reflection.FieldSetter;\n+import org.mockito.junit.jupiter.MockitoExtension;\n \n+import java.util.*;\n+\n+import static com.broadcom.lsp.cobol.service.delegates.communications.ServerCommunications.*;\n import static com.broadcom.lsp.cobol.service.delegates.validations.UseCaseUtils.DOCUMENT_URI;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.mockito.ArgumentCaptor.forClass;\n+import static org.eclipse.lsp4j.MessageType.Error;\n+import static org.eclipse.lsp4j.MessageType.Info;\n import static org.mockito.Mockito.*;\n \n /** This unit tests verifies the capabilities of {@link ServerCommunications} */\n+@ExtendWith(MockitoExtension.class)\n class ServerCommunicationsTest {\n-  // TODO: Cover the rest of the methods\n+\n+  private static final int TEST_TIMEOUT = 10000;\n+\n+  @Mock\n+  private Provider<LanguageClient> provider;\n+\n+  @Mock\n+  private LanguageClient client;\n+\n+  @Mock\n+  private FileSystemService files;\n+\n+  @Mock\n+  private HashSet<String> uriInProgress;\n+\n+  @InjectMocks\n+  private ServerCommunications communications;\n+\n+  @BeforeEach\n+  void init(TestInfo info) {\n+    if (!info.getDisplayName().equals(\"testCancelProgressNotification()\")) {", "originalCommit": "4acae56be8ace0f5a83af4d9fbe5774bd08d5a01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUyNzI4MA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567#discussion_r508527280", "bodyText": "The actual fix", "author": "Nurkambay", "createdAt": "2020-10-20T13:56:23Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/delegates/communications/ServerCommunications.java", "diffHunk": "@@ -109,7 +115,7 @@ public void notifyThatDocumentAnalysed(String uri) {\n    */\n   @Override\n   public void notifyThatExtensionIsUnsupported(String extension) {\n-    runAsync(() -> showMessage(Error, \"The given document extension is unsupported: \" + extension));\n+    runAsync(() -> logMessage(Error, EXTENSION_UNSUPPORTED + extension));", "originalCommit": "4acae56be8ace0f5a83af4d9fbe5774bd08d5a01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUyNzEwMQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567#discussion_r508527101", "bodyText": "Java 9 Map.of   can be used if we do not modify the map", "author": "asatklichov", "createdAt": "2020-10-20T13:56:16Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/service/delegates/communications/ServerCommunicationsTest.java", "diffHunk": "@@ -16,42 +16,157 @@\n package com.broadcom.lsp.cobol.service.delegates.communications;\n \n import com.broadcom.lsp.cobol.service.utils.FileSystemService;\n-import org.eclipse.lsp4j.MessageParams;\n-import org.eclipse.lsp4j.MessageType;\n+import com.google.inject.Provider;\n+import org.eclipse.lsp4j.*;\n import org.eclipse.lsp4j.services.LanguageClient;\n+import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n-import org.mockito.ArgumentCaptor;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.internal.util.reflection.FieldSetter;\n+import org.mockito.junit.jupiter.MockitoExtension;\n \n+import java.util.*;\n+\n+import static com.broadcom.lsp.cobol.service.delegates.communications.ServerCommunications.*;\n import static com.broadcom.lsp.cobol.service.delegates.validations.UseCaseUtils.DOCUMENT_URI;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.mockito.ArgumentCaptor.forClass;\n+import static org.eclipse.lsp4j.MessageType.Error;\n+import static org.eclipse.lsp4j.MessageType.Info;\n import static org.mockito.Mockito.*;\n \n /** This unit tests verifies the capabilities of {@link ServerCommunications} */\n+@ExtendWith(MockitoExtension.class)\n class ServerCommunicationsTest {\n-  // TODO: Cover the rest of the methods\n+\n+  private static final int TEST_TIMEOUT = 10000;\n+\n+  @Mock\n+  private Provider<LanguageClient> provider;\n+\n+  @Mock\n+  private LanguageClient client;\n+\n+  @Mock\n+  private FileSystemService files;\n+\n+  @Mock\n+  private HashSet<String> uriInProgress;\n+\n+  @InjectMocks\n+  private ServerCommunications communications;\n+\n+  @BeforeEach\n+  void init(TestInfo info) {\n+    if (!info.getDisplayName().equals(\"testCancelProgressNotification()\")) {\n+      when(provider.get()).thenReturn(client);\n+    }\n+  }\n+\n   /**\n    * Method {@link ServerCommunications#notifyThatDocumentAnalysed(String)} should asynchronously\n    * call logging on the client for a specific message with a document name retrieved from uri\n    */\n   @Test\n-  void testNotifyThatDocumentAnalysed() {\n+  void testNotifyThatDocumentAnalysed_multi_segment_uri() {\n     assertDocumentAnalysedNotification(DOCUMENT_URI, \"document.cbl\");\n     assertDocumentAnalysedNotification(\"document.cbl\", \"document.cbl\");\n     assertDocumentAnalysedNotification(\"\", \"\");\n   }\n \n+  /**\n+   * Method {@link ServerCommunications#notifyThatEngineNotFound(String)} should asynchronously\n+   * populate message with a language type on the client\n+   */\n+  @Test\n+  void testNotifyThatEngineNotFound() {\n+    String data = UUID.randomUUID().toString();\n+    communications.notifyThatEngineNotFound(data);\n+    verify(client, timeout(TEST_TIMEOUT)).showMessage(eq(new MessageParams(Error, CANNOT_FIND_LANGUAGE_ENGINE + data)));\n+  }\n+\n+  /**\n+   * Method {@link ServerCommunications#notifyThatLoadingInProgress(String)} should asynchronously\n+   * populate message with an URI on the client\n+   */\n+  @Test\n+  void testNotifyThatLoadingInProgress() {\n+    String data = UUID.randomUUID().toString();\n+    when(files.decodeURI(data)).thenReturn(data);\n+\n+    communications.notifyThatLoadingInProgress(data);\n+    verify(client, timeout(TEST_TIMEOUT)).showMessage(eq(new MessageParams(Info, data + SYNTAX_ANALYSIS_IN_PROGRESS)));\n+  }\n+\n+  /**\n+   * Method {@link ServerCommunications#notifyThatDocumentAnalysed(String)} should asynchronously\n+   * call logging on the client for a specific message with an URI\n+   */\n+  @Test\n+  void testNotifyThatDocumentAnalysed() {\n+    String data = UUID.randomUUID().toString();\n+    when(files.decodeURI(data)).thenReturn(data);\n+\n+    communications.notifyThatDocumentAnalysed(data);\n+    verify(client, timeout(TEST_TIMEOUT)).logMessage(eq(new MessageParams(Info, NO_SYNTAX_ERRORS + data)));\n+  }\n+\n+  /**\n+   * Method {@link ServerCommunications#notifyThatExtensionIsUnsupported(String)} should asynchronously\n+   * call logging on the client for a specific message with an extension\n+   */\n+  @Test\n+  void testNotifyThatExtensionIsUnsupported() {\n+    String data = UUID.randomUUID().toString();\n+\n+    communications.notifyThatExtensionIsUnsupported(data);\n+    verify(client, timeout(TEST_TIMEOUT)).logMessage(eq(new MessageParams(Error, EXTENSION_UNSUPPORTED + data)));\n+  }\n+\n+  /**\n+   * Method {@link ServerCommunications#publishDiagnostics(Map)} should\n+   * raise a diagnostic message to the client with syntax error retrieved by the COBOL\n+   * LSP server for related files.\n+   */\n+  @Test\n+  void testPublishDiagnostics() {\n+    String uri = UUID.randomUUID().toString();\n+\n+    // Prepare diagnostic map\n+    Map<String, List<Diagnostic>> map = new HashMap<>();", "originalCommit": "4acae56be8ace0f5a83af4d9fbe5774bd08d5a01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUzOTY2OQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567#discussion_r508539669", "bodyText": "Fixed", "author": "Nurkambay", "createdAt": "2020-10-20T14:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUyNzEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUzMDUwOA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567#discussion_r508530508", "bodyText": "From Guice docs: Avoid using field injection with final fields, which has weak semantics.", "author": "temanbrcom", "createdAt": "2020-10-20T13:58:56Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/delegates/communications/ServerCommunications.java", "diffHunk": "@@ -43,8 +43,14 @@\n  */\n @Slf4j\n public class ServerCommunications implements Communications {\n-  private Provider<LanguageClient> provider;\n-  private FileSystemService files;\n+\n+  static final String CANNOT_FIND_LANGUAGE_ENGINE = \"Cannot find a language engine for the given language ID: \";\n+  static final String SYNTAX_ANALYSIS_IN_PROGRESS = \": Syntax analysis in progress\";\n+  static final String NO_SYNTAX_ERRORS = \"No syntax errors detected in \";\n+  static final String EXTENSION_UNSUPPORTED = \"The given document extension is unsupported: \";\n+\n+  private final Provider<LanguageClient> provider;\n+  private final FileSystemService files;\n \n   private final ScheduledExecutorService executor = Executors.newScheduledThreadPool(5);\n   private final Set<String> uriInProgress = new HashSet<>();", "originalCommit": "4acae56be8ace0f5a83af4d9fbe5774bd08d5a01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU0MjI3NA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567#discussion_r508542274", "bodyText": "Fixed", "author": "Nurkambay", "createdAt": "2020-10-20T14:11:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUzMDUwOA=="}], "type": "inlineReview"}, {"oid": "5a447e0d5df67d06b134d225e10f8c1e1469f8c9", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/5a447e0d5df67d06b134d225e10f8c1e1469f8c9", "message": "fix: Move unsupported files notification into problems console #173\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-20T14:08:19Z", "type": "forcePushed"}, {"oid": "db160424d449ca91975bfc89d87c2a8677bce07a", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/db160424d449ca91975bfc89d87c2a8677bce07a", "message": "fix: Move unsupported files notification into problems console #173\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-20T14:10:56Z", "type": "forcePushed"}, {"oid": "254db8d462536afe6150cc852d1a3069add53517", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/254db8d462536afe6150cc852d1a3069add53517", "message": "fix: Move unsupported files notification into problems console #173\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-20T14:30:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3MDI4Mg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567#discussion_r508570282", "bodyText": "clean-up needed", "author": "asatklichov", "createdAt": "2020-10-20T14:43:29Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/service/delegates/communications/ServerCommunicationsTest.java", "diffHunk": "@@ -16,42 +16,156 @@\n package com.broadcom.lsp.cobol.service.delegates.communications;\n \n import com.broadcom.lsp.cobol.service.utils.FileSystemService;\n-import org.eclipse.lsp4j.MessageParams;\n-import org.eclipse.lsp4j.MessageType;\n+import com.google.inject.Provider;\n+import org.eclipse.lsp4j.*;\n import org.eclipse.lsp4j.services.LanguageClient;\n+import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n-import org.mockito.ArgumentCaptor;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.internal.util.reflection.FieldSetter;\n+import org.mockito.junit.jupiter.MockitoExtension;\n \n+import java.util.*;\n+\n+import static com.broadcom.lsp.cobol.service.delegates.communications.ServerCommunications.*;\n import static com.broadcom.lsp.cobol.service.delegates.validations.UseCaseUtils.DOCUMENT_URI;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.mockito.ArgumentCaptor.forClass;\n+import static org.eclipse.lsp4j.MessageType.Error;\n+import static org.eclipse.lsp4j.MessageType.Info;\n import static org.mockito.Mockito.*;\n \n /** This unit tests verifies the capabilities of {@link ServerCommunications} */\n+@ExtendWith(MockitoExtension.class)\n class ServerCommunicationsTest {\n-  // TODO: Cover the rest of the methods\n+\n+  private static final int TEST_TIMEOUT = 10000;\n+\n+  @Mock\n+  private Provider<LanguageClient> provider;\n+\n+  @Mock\n+  private LanguageClient client;\n+\n+  @Mock\n+  private FileSystemService files;\n+\n+  @Mock\n+  private HashSet<String> uriInProgress;\n+\n+  @InjectMocks\n+  private ServerCommunications communications;\n+\n+  @BeforeEach\n+  void init(TestInfo info) {\n+    if (!\"testCancelProgressNotification()\".equals(info.getDisplayName())) {\n+      when(provider.get()).thenReturn(client);\n+    }\n+  }\n+\n   /**\n    * Method {@link ServerCommunications#notifyThatDocumentAnalysed(String)} should asynchronously\n    * call logging on the client for a specific message with a document name retrieved from uri\n    */\n   @Test\n-  void testNotifyThatDocumentAnalysed() {\n+  void testNotifyThatDocumentAnalysed_multi_segment_uri() {\n     assertDocumentAnalysedNotification(DOCUMENT_URI, \"document.cbl\");\n     assertDocumentAnalysedNotification(\"document.cbl\", \"document.cbl\");\n     assertDocumentAnalysedNotification(\"\", \"\");\n   }\n \n+  /**\n+   * Method {@link ServerCommunications#notifyThatEngineNotFound(String)} should asynchronously\n+   * populate message with a language type on the client\n+   */\n+  @Test\n+  void testNotifyThatEngineNotFound() {\n+    String data = UUID.randomUUID().toString();\n+    communications.notifyThatEngineNotFound(data);\n+    verify(client, timeout(TEST_TIMEOUT)).showMessage(eq(new MessageParams(Error, CANNOT_FIND_LANGUAGE_ENGINE + data)));\n+  }\n+\n+  /**\n+   * Method {@link ServerCommunications#notifyThatLoadingInProgress(String)} should asynchronously\n+   * populate message with an URI on the client\n+   */\n+  @Test\n+  void testNotifyThatLoadingInProgress() {\n+    String data = UUID.randomUUID().toString();\n+    when(files.decodeURI(data)).thenReturn(data);\n+\n+    communications.notifyThatLoadingInProgress(data);\n+    verify(client, timeout(TEST_TIMEOUT)).showMessage(eq(new MessageParams(Info, data + SYNTAX_ANALYSIS_IN_PROGRESS)));\n+  }\n+\n+  /**\n+   * Method {@link ServerCommunications#notifyThatDocumentAnalysed(String)} should asynchronously\n+   * call logging on the client for a specific message with an URI\n+   */\n+  @Test\n+  void testNotifyThatDocumentAnalysed() {\n+    String data = UUID.randomUUID().toString();\n+    when(files.decodeURI(data)).thenReturn(data);\n+\n+    communications.notifyThatDocumentAnalysed(data);\n+    verify(client, timeout(TEST_TIMEOUT)).logMessage(eq(new MessageParams(Info, NO_SYNTAX_ERRORS + data)));\n+  }\n+\n+  /**\n+   * Method {@link ServerCommunications#notifyThatExtensionIsUnsupported(String)} should asynchronously\n+   * call logging on the client for a specific message with an extension\n+   */\n+  @Test\n+  void testNotifyThatExtensionIsUnsupported() {\n+    String data = UUID.randomUUID().toString();\n+\n+    communications.notifyThatExtensionIsUnsupported(data);\n+    verify(client, timeout(TEST_TIMEOUT)).logMessage(eq(new MessageParams(Error, EXTENSION_UNSUPPORTED + data)));\n+  }\n+\n+  /**\n+   * Method {@link ServerCommunications#publishDiagnostics(Map)} should\n+   * raise a diagnostic message to the client with syntax error retrieved by the COBOL\n+   * LSP server for related files.\n+   */\n+  @Test\n+  void testPublishDiagnostics() {\n+    String uri = UUID.randomUUID().toString();\n+\n+    // Prepare diagnostic map\n+    Diagnostic diagnostic = new Diagnostic(new Range(), \"\\r\\ntest\\r\\n\");\n+    List<Diagnostic> diagnostics = List.of(diagnostic);\n+    //map.put(uri, diagnostics);", "originalCommit": "254db8d462536afe6150cc852d1a3069add53517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3MTYyMw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/567#discussion_r508571623", "bodyText": "Fixed", "author": "Nurkambay", "createdAt": "2020-10-20T14:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3MDI4Mg=="}], "type": "inlineReview"}, {"oid": "98f455c34aa945753c9ebfb8c68fbddc660f6b25", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/98f455c34aa945753c9ebfb8c68fbddc660f6b25", "message": "fix: Move unsupported files notification into problems console #173\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-20T14:44:57Z", "type": "commit"}, {"oid": "98f455c34aa945753c9ebfb8c68fbddc660f6b25", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/98f455c34aa945753c9ebfb8c68fbddc660f6b25", "message": "fix: Move unsupported files notification into problems console #173\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-20T14:44:57Z", "type": "forcePushed"}]}