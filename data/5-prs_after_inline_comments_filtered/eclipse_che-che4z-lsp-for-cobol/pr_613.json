{"pr_number": 613, "pr_title": "Support Termination Requests #590", "pr_createdAt": "2020-11-05T09:12:57Z", "pr_url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg5OTA5Nw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r517899097", "bodyText": "As per LSP spec, after this call no other service call can/should be handled. Should we have a logic to return no-valid from all our service after this call is made.\nWhy I didn't implement it?\nVScode actually never waits for us to call exit. Upon closing, it fires a shutdown call and then fires an exit call.\nDetails mentioned in the PR comment.", "author": "ap891843", "createdAt": "2020-11-05T09:16:12Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolLanguageServer.java", "diffHunk": "@@ -124,14 +125,21 @@ private void getLocaleFromClient() {\n     settingsService.getConfiguration(LOCALE.label).thenAccept(localeStore.notifyLocaleStore());\n   }\n \n+  public int getExitCode() {\n+    return exitCode;\n+  }\n+\n   @Override\n   public CompletableFuture<Object> shutdown() {\n+    LOG.info(\"LS for COBOL received shutdown request\");", "originalCommit": "8a0f40f85fb4b78b97a6de2aea54a61e31621a7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwMzk3OA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r517903978", "bodyText": "We support different IDEs, should it would be better not to rely on the client implementation", "author": "temanbrcom", "createdAt": "2020-11-05T09:23:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg5OTA5Nw=="}], "type": "inlineReview"}, {"oid": "a937bedb1e9f5635b0bcd9ac7662d2c1c326f13c", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/a937bedb1e9f5635b0bcd9ac7662d2c1c326f13c", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-05T14:17:16Z", "type": "forcePushed"}, {"oid": "eaecb7b206caf31ae0a57991f10369bfcd2d1ebc", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/eaecb7b206caf31ae0a57991f10369bfcd2d1ebc", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-06T09:38:13Z", "type": "forcePushed"}, {"oid": "34809dd3bd3a5cbc782375ce73145d2790781735", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/34809dd3bd3a5cbc782375ce73145d2790781735", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-06T09:45:41Z", "type": "forcePushed"}, {"oid": "46dd72f92204022be93287a288a51758dda8b42b", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/46dd72f92204022be93287a288a51758dda8b42b", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-06T09:59:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTIyMg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518649222", "bodyText": "Please, add a Javadoc", "author": "temanbrcom", "createdAt": "2020-11-06T10:09:08Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/annotation/CheckServerShutdownState.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package com.broadcom.lsp.cobol.core.annotation;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target(ElementType.METHOD)\n+public @interface CheckServerShutdownState {}", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTM4Mw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518649383", "bodyText": "Missing copyright header", "author": "temanbrcom", "createdAt": "2020-11-06T10:09:26Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/annotation/CheckServerShutdownState.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package com.broadcom.lsp.cobol.core.annotation;", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MDg5MA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519640890", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T08:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTQ1NQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518649455", "bodyText": "Missing copyright header", "author": "temanbrcom", "createdAt": "2020-11-06T10:09:32Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/annotation/HandleShutdownState.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.broadcom.lsp.cobol.core.annotation;", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MDk1MA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519640950", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T08:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTg3NA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518649874", "bodyText": "Missing Javadoc", "author": "temanbrcom", "createdAt": "2020-11-06T10:10:17Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/annotation/HandleShutdownState.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.broadcom.lsp.cobol.core.annotation;\n+\n+import com.broadcom.lsp.cobol.service.DisposableLanguageServer;\n+import com.google.inject.Inject;\n+import lombok.extern.slf4j.Slf4j;\n+import org.aopalliance.intercept.MethodInterceptor;\n+import org.aopalliance.intercept.MethodInvocation;\n+import org.eclipse.lsp4j.services.LanguageServer;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+@Slf4j\n+public class HandleShutdownState implements MethodInterceptor {", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1MTY0MQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518651641", "bodyText": "Not an LSP request, no need to check it", "author": "temanbrcom", "createdAt": "2020-11-06T10:13:37Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolTextDocumentService.java", "diffHunk": "@@ -213,11 +224,13 @@ private void interruptAnalysis(String uri) {\n   }\n \n   @Override\n+  @CheckServerShutdownState\n   public void didSave(DidSaveTextDocumentParams params) {\n     LOG.info(\"Document saved...\");\n   }\n \n   @Override\n+  @CheckServerShutdownState", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NDg2OQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519644869", "bodyText": "I spent major time here. Using interceptor actually leads to some proxy classes and it seems without this annotation here, this method is marked final which leads to error while spying. I get the below error\n\njava.lang.VerifyError: class com.broadcom.lsp.cobol.service.CobolTextDocumentService$$EnhancerByGuice$$c86ee31e$MockitoMock$565924183 overrides final method com.broadcom.lsp.cobol.service.CobolTextDocumentService$$EnhancerByGuice$$c86ee31e.observerCallback(Ljava/lang/Object;)\n\nThis confuses me if guice interceptors are the right approach.  This is a question to all reviewers, if you feel the same , I will re-work this with some other approach.\nFor now, I have kept this annotation as is.", "author": "ap891843", "createdAt": "2020-11-09T08:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1MTY0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc2MjY4Nw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519762687", "bodyText": "It deserves some further investigation, but ok, let's leave the annotation there.", "author": "temanbrcom", "createdAt": "2020-11-09T12:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1MTY0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NjI3MQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518656271", "bodyText": "Nice idea to create a class for it, but it should be either static or a separate class because it is not strongly connected with the outer class.", "author": "temanbrcom", "createdAt": "2020-11-06T10:22:20Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolLanguageServer.java", "diffHunk": "@@ -145,4 +187,11 @@ private ExecuteCommandOptions collectExecuteCommandList() {\n     return new ExecuteCommandOptions(\n         stream(ErrorCode.values()).map(ErrorCode::name).collect(toList()));\n   }\n+\n+  /** Represents the JSON RPC response structure for shutdown command as per LSP specification */\n+  @AllArgsConstructor\n+  private class ShutdownResponse {", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NDk4Ng==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519644986", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T08:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NjI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NzA2Mw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518657063", "bodyText": "A misplaced comma in the comment, as well as in a comment below", "author": "temanbrcom", "createdAt": "2020-11-06T10:23:52Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolLanguageServer.java", "diffHunk": "@@ -124,14 +127,53 @@ private void getLocaleFromClient() {\n     settingsService.getConfiguration(LOCALE.label).thenAccept(localeStore.notifyLocaleStore());\n   }\n \n+  @Override\n+  public int getExitCode() {\n+    return exitCode;\n+  }\n+\n   @Override\n   public CompletableFuture<Object> shutdown() {\n-    return supplyAsync(() -> TRUE);\n+    LOG.info(\"LS for COBOL received shutdown request\");\n+    exitCode = 0;\n+    try {\n+      cancelAllProcessing();\n+    } catch (Exception exception) {\n+      return supplyAsync(() -> new ShutdownResponse(null, exception.getMessage()));\n+    }\n+    return supplyAsync(() -> new ShutdownResponse(null, String.valueOf(exitCode)));\n+  }\n+\n+  /**\n+   * Attempts to stop all actively executing tasks, halts the processing of waiting tasks, and\n+   * returns a list of the tasks that were awaiting execution. These tasks are drained (removed)\n+   * from the task queue upon return from this method.\n+   *\n+   * <p>There are no guarantees beyond best-effort attempts to stop processing actively executing\n+   * tasks. This implementation cancels tasks via Thread.interrupt(), so any task that fails to\n+   * respond to interrupts may never terminate.\n+   *\n+   * <p>Source:\n+   * https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ThreadPoolExecutor.html#shutdownNow--\n+   */\n+  private void cancelAllProcessing() {\n+    // NOTE: shutdownNow principally is not a bad practice when we know what we are doing.\n+    //      Here in this case, since we are only stopping our own threads which don't\n+    //      require any clean up.It's ok. Java doc doesn't mention any bad practice for this.\n+\n+    // cancels all the running task and clears empty queue ,initiated on forkJoinPool.", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NTA2OQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519645069", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T08:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NzA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1Nzc2Nw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518657767", "bodyText": "Why did you remove this class?", "author": "temanbrcom", "createdAt": "2020-11-06T10:25:09Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/strategy/Messages.java", "diffHunk": "@@ -1,51 +0,0 @@\n-/*", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMjI2OQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518822269", "bodyText": "I guess we don't use this class now and all the messages are being handled through the resource bundle. I will check this again. Did see this yesterday in the Coverity Scan, so thought of removing it.", "author": "ap891843", "createdAt": "2020-11-06T15:23:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1Nzc2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0MTAwOQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518841009", "bodyText": "I agree to delete it, but please do it as a separate commit not to bring a mess to this one", "author": "temanbrcom", "createdAt": "2020-11-06T15:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1Nzc2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NTIxNg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519645216", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T08:57:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1Nzc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY2MDQ0MQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r518660441", "bodyText": "Please, don't use this type of DI in tests", "author": "temanbrcom", "createdAt": "2020-11-06T10:29:57Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/service/CobolTextDocumentServiceTest.java", "diffHunk": "@@ -437,6 +441,58 @@ void testImmediateClosingOfDocumentDoNotCauseNPE() {\n     verify(communications, timeout(2000)).cancelProgressNotification(UseCaseUtils.DOCUMENT_URI);\n   }\n \n+  /**\n+   * This method tests that after a shutdown request, {@link TextDocumentService} always return\n+   * SHUTDOWN_RESPONSE\n+   *\n+   * @throws ExecutionException\n+   * @throws InterruptedException\n+   */\n+  @Test\n+  void whenShutdownIsFired_ThenNewRequestReturnInvalidResponse()\n+      throws ExecutionException, InterruptedException {\n+    CobolTextDocumentService service =\n+        (CobolTextDocumentService)\n+            LangServerCtx.getInjector().getInstance(TextDocumentService.class);\n+    LanguageServer server = LangServerCtx.getInjector().getInstance(LanguageServer.class);", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0ODIyNA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519648224", "bodyText": "working on it, seems like I overlooked", "author": "ap891843", "createdAt": "2020-11-09T09:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY2MDQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1MjEzMw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519652133", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T09:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY2MDQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4MjU0Mg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519182542", "bodyText": "You don't really need to resolve this future asynchronously. Please, use this instead:\nreturn CompletableFuture.completedFuture(SHUTDOWN_RESPONSE);", "author": "grianbrcom", "createdAt": "2020-11-07T14:24:53Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/annotation/HandleShutdownState.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.broadcom.lsp.cobol.core.annotation;\n+\n+import com.broadcom.lsp.cobol.service.DisposableLanguageServer;\n+import com.google.inject.Inject;\n+import lombok.extern.slf4j.Slf4j;\n+import org.aopalliance.intercept.MethodInterceptor;\n+import org.aopalliance.intercept.MethodInvocation;\n+import org.eclipse.lsp4j.services.LanguageServer;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+@Slf4j\n+public class HandleShutdownState implements MethodInterceptor {\n+  private static final String SHUTDOWN_RESPONSE = \"InvalidRequest\";\n+  private LanguageServer server;\n+\n+  @Inject\n+  public void setServer(LanguageServer server) {\n+    this.server = server;\n+  }\n+\n+  @Override\n+  public Object invoke(MethodInvocation invocation) throws Throwable {\n+    if (server instanceof DisposableLanguageServer) {\n+      DisposableLanguageServer languageServer = (DisposableLanguageServer) server;\n+      if (languageServer.getExitCode() == DisposableLanguageServer.SHUTDOWN_EXIT_CODE) {\n+        LOG.info(invocation.getMethod().getName() + \" invoked after shutdown\");\n+        return CompletableFuture.supplyAsync(() -> SHUTDOWN_RESPONSE);", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NTkzNw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519645937", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T08:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4MjU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4MzExNA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519183114", "bodyText": "You can use CompletableFuture.completedFuture in both returns.", "author": "grianbrcom", "createdAt": "2020-11-07T14:31:16Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolLanguageServer.java", "diffHunk": "@@ -124,14 +127,53 @@ private void getLocaleFromClient() {\n     settingsService.getConfiguration(LOCALE.label).thenAccept(localeStore.notifyLocaleStore());\n   }\n \n+  @Override\n+  public int getExitCode() {\n+    return exitCode;\n+  }\n+\n   @Override\n   public CompletableFuture<Object> shutdown() {\n-    return supplyAsync(() -> TRUE);\n+    LOG.info(\"LS for COBOL received shutdown request\");\n+    exitCode = 0;\n+    try {\n+      cancelAllProcessing();\n+    } catch (Exception exception) {\n+      return supplyAsync(() -> new ShutdownResponse(null, exception.getMessage()));", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NjA3NQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519646075", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T08:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4MzExNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4MzQ1NQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519183455", "bodyText": "It makes sense to update exitCode after successfully done the cancelAllProcessing call.", "author": "grianbrcom", "createdAt": "2020-11-07T14:35:02Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolLanguageServer.java", "diffHunk": "@@ -124,14 +127,53 @@ private void getLocaleFromClient() {\n     settingsService.getConfiguration(LOCALE.label).thenAccept(localeStore.notifyLocaleStore());\n   }\n \n+  @Override\n+  public int getExitCode() {\n+    return exitCode;\n+  }\n+\n   @Override\n   public CompletableFuture<Object> shutdown() {\n-    return supplyAsync(() -> TRUE);\n+    LOG.info(\"LS for COBOL received shutdown request\");\n+    exitCode = 0;", "originalCommit": "46dd72f92204022be93287a288a51758dda8b42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NjIwMw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519646203", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-09T08:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4MzQ1NQ=="}], "type": "inlineReview"}, {"oid": "1558c42217b30cdc020cb322080086604886f646", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/1558c42217b30cdc020cb322080086604886f646", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-09T08:48:12Z", "type": "forcePushed"}, {"oid": "6ceba3083767dcd1c9c3e81491e2552bba4445b9", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/6ceba3083767dcd1c9c3e81491e2552bba4445b9", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-09T09:07:04Z", "type": "forcePushed"}, {"oid": "da14f00c21184317c3d317d00dd596b2d91123e7", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/da14f00c21184317c3d317d00dd596b2d91123e7", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-09T13:01:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMwOTg5MA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521309890", "bodyText": "I just tested it and noticed that this message should be \"COBOL LS server exits with code:\"", "author": "temanbrcom", "createdAt": "2020-11-11T12:01:24Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolLanguageServer.java", "diffHunk": "@@ -126,12 +134,45 @@ private void getLocaleFromClient() {\n \n   @Override\n   public CompletableFuture<Object> shutdown() {\n-    return supplyAsync(() -> TRUE);\n+    LOG.info(\"LS for COBOL received shutdown request\");\n+    try {\n+      cancelAllProcessing();\n+      exitCode = 0;\n+    } catch (Exception exception) {\n+      return CompletableFuture.completedFuture(new ShutdownResponse(null, exception.getMessage()));\n+    }\n+    return CompletableFuture.completedFuture(new ShutdownResponse(null, String.valueOf(exitCode)));\n+  }\n+\n+  /**\n+   * Attempts to stop all actively executing tasks, halts the processing of waiting tasks, and\n+   * returns a list of the tasks that were awaiting execution. These tasks are drained (removed)\n+   * from the task queue upon return from this method.\n+   *\n+   * <p>There are no guarantees beyond best-effort attempts to stop processing actively executing\n+   * tasks. This implementation cancels tasks via Thread.interrupt(), so any task that fails to\n+   * respond to interrupts may never terminate.\n+   *\n+   * <p>Source:\n+   * https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ThreadPoolExecutor.html#shutdownNow--\n+   */\n+  private void cancelAllProcessing() {\n+    // NOTE: shutdownNow principally is not a bad practice when we know what we are doing.\n+    //      Here in this case, since we are only stopping our own threads which don't\n+    //      require any clean up.It's ok. Java doc doesn't mention any bad practice for this.\n+\n+    // cancels all the running task and clears empty queue on forkJoinPool.\n+    ForkJoinPool.commonPool().shutdownNow();\n+\n+    // cancels all the running task and clears empty queue on CobolTextDocumentService executor.\n+    ((CobolTextDocumentService) getTextDocumentService()).disposeAllOperation(this);\n+    LOG.info(\"All processing abandoned as per shutdown call\");\n   }\n \n   @Override\n   public void exit() {\n-    // not supported\n+    LOG.info(\"LS for COBOL exiting with code: \" + exitCode);", "originalCommit": "da14f00c21184317c3d317d00dd596b2d91123e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3NjIzOQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521376239", "bodyText": "Done", "author": "ap891843", "createdAt": "2020-11-11T13:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMwOTg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMDI2NA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521310264", "bodyText": "Should be \"COBOL LS received shutdown request\"", "author": "temanbrcom", "createdAt": "2020-11-11T12:02:11Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolLanguageServer.java", "diffHunk": "@@ -126,12 +134,45 @@ private void getLocaleFromClient() {\n \n   @Override\n   public CompletableFuture<Object> shutdown() {\n-    return supplyAsync(() -> TRUE);\n+    LOG.info(\"LS for COBOL received shutdown request\");", "originalCommit": "da14f00c21184317c3d317d00dd596b2d91123e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3NjE2OA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521376168", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-11T13:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMDI2NA=="}], "type": "inlineReview"}, {"oid": "f27c36e208b5c505752a6ca748c88433e9eddf97", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/f27c36e208b5c505752a6ca748c88433e9eddf97", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-11T13:58:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxMzg4OA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521413888", "bodyText": "Reverting back custom thread pool changes for this class.\nReason:\nManage thread for the process we initiate and let LSP4J manage its thread. This helps in the shutdown process where we shutdown the custom thread pool to shutdown all current processes.\n@asatklichov\n@grianbrcom\n@Nurkambay\n@temanbrcom", "author": "ap891843", "createdAt": "2020-11-11T14:54:31Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/LangServerBootstrap.java", "diffHunk": "@@ -56,23 +54,19 @@ public static void main(String[] args)\n     Injector injector = initCtx();\n     LanguageServer server = injector.getInstance(LanguageServer.class);\n     ClientProvider provider = injector.getInstance(ClientProvider.class);\n-    CustomThreadPoolExecutor customExecutor = injector.getInstance(CustomThreadPoolExecutor.class);\n \n-    start(args, server, provider, customExecutor.getThreadPoolExecutor());\n+    start(args, server, provider);", "originalCommit": "f27c36e208b5c505752a6ca748c88433e9eddf97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzNDEzNA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521434134", "bodyText": "But in this case, we still have a separate executor for LSP4J and another one for the data bus and other stuff, right?", "author": "temanbrcom", "createdAt": "2020-11-11T15:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxMzg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzNzgwMg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521437802", "bodyText": "Yes, LSP4J uses a new cached thread pool for its use, if we don't provide (it creates using Executors.newCachedThreadPool()).\nAnd our process will use the custom thread pool (dataBus/ textDocumnetService etc).", "author": "ap891843", "createdAt": "2020-11-11T15:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxMzg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzNTI5MA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521435290", "bodyText": "Should we shutdown also the scheduled pool here?", "author": "temanbrcom", "createdAt": "2020-11-11T15:25:04Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolLanguageServer.java", "diffHunk": "@@ -126,12 +138,45 @@ private void getLocaleFromClient() {\n \n   @Override\n   public CompletableFuture<Object> shutdown() {\n-    return supplyAsync(() -> TRUE);\n+    LOG.info(\"COBOL LS received shutdown request\");\n+    try {\n+      cancelAllProcessing();\n+      exitCode = 0;\n+    } catch (Exception exception) {\n+      return CompletableFuture.completedFuture(new ShutdownResponse(null, exception.getMessage()));\n+    }\n+    return CompletableFuture.completedFuture(new ShutdownResponse(null, String.valueOf(exitCode)));\n+  }\n+\n+  /**\n+   * Attempts to stop all actively executing tasks, halts the processing of waiting tasks, and\n+   * returns a list of the tasks that were awaiting execution. These tasks are drained (removed)\n+   * from the task queue upon return from this method.\n+   *\n+   * <p>There are no guarantees beyond best-effort attempts to stop processing actively executing\n+   * tasks. This implementation cancels tasks via Thread.interrupt(), so any task that fails to\n+   * respond to interrupts may never terminate.\n+   *\n+   * <p>Source:\n+   * https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ThreadPoolExecutor.html#shutdownNow--\n+   */\n+  private void cancelAllProcessing() {\n+    // NOTE: shutdownNow principally is not a bad practice when we know what we are doing.\n+    //      Here in this case, since we are only stopping our own threads which don't\n+    //      require any clean up.It's ok. Java doc doesn't mention any bad practice for this.\n+\n+    // cancels all the running task and clears empty queue on forkJoinPool.\n+    ForkJoinPool.commonPool().shutdownNow();\n+\n+    // cancels all the running task on COBOL LS custom executor service.\n+    customThreadPoolExecutor.getThreadPoolExecutor().shutdownNow();", "originalCommit": "f27c36e208b5c505752a6ca748c88433e9eddf97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ2NTgwNA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521465804", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-11T16:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzNTI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzNjUzMg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521436532", "bodyText": "Optional: this name seems very wordy, especially on the usages. Maybe, executors would be enough?", "author": "temanbrcom", "createdAt": "2020-11-11T15:26:52Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolTextDocumentService.java", "diffHunk": "@@ -87,14 +92,16 @@\n       Completions completions,\n       Occurrences occurrences,\n       DataBusBroker dataBus,\n-      CodeActions actions) {\n+      CodeActions actions,\n+      CustomThreadPoolExecutor customThreadPoolExecutor) {", "originalCommit": "f27c36e208b5c505752a6ca748c88433e9eddf97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ2NTcxMA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521465710", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-11T16:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzNjUzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTI2Nw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521439267", "bodyText": "Replaceable with builder", "author": "temanbrcom", "createdAt": "2020-11-11T15:30:45Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/service/CobolTextDocumentServiceTest.java", "diffHunk": "@@ -178,7 +183,14 @@ void disableCopybookAnalysisOnExtendedDoc() {\n \n   private CobolTextDocumentService buildServiceWithMockEngine(LanguageEngineFacade engine) {\n     return new CobolTextDocumentService(\n-        mock(Communications.class), engine, null, null, null, mock(DataBusBroker.class), null);\n+        mock(Communications.class),\n+        engine,\n+        null,\n+        null,\n+        null,\n+        mock(DataBusBroker.class),\n+        null,\n+        getCustomExecutor());", "originalCommit": "f27c36e208b5c505752a6ca748c88433e9eddf97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ2NTY1MQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521465651", "bodyText": "done", "author": "ap891843", "createdAt": "2020-11-11T16:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTI2Nw=="}], "type": "inlineReview"}, {"oid": "c1f079d128a2a4953172addb695dc16f86dc73c2", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/c1f079d128a2a4953172addb695dc16f86dc73c2", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-11T16:06:23Z", "type": "commit"}, {"oid": "c1f079d128a2a4953172addb695dc16f86dc73c2", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/c1f079d128a2a4953172addb695dc16f86dc73c2", "message": "feat: Support Termination Requests #590\n\nSigned-off-by: ap891843 <aman.prashant@broadcom.com>", "committedDate": "2020-11-11T16:06:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ3NTM5Nw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r521475397", "bodyText": "In this case, we will create a connection to DI that we are actually want to get rid of. Will work for now; may be fixed in #261", "author": "temanbrcom", "createdAt": "2020-11-11T16:22:39Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/service/DocumentExtensionTests.java", "diffHunk": "@@ -34,7 +35,7 @@\n  * extensions. If an extension of a document is unsupported (i.e. not \"cob\", \"cbl\" or \"cobol\"\n  * ignoring case) then the according to notification should be sent.\n  */\n-class DocumentExtensionTests {\n+class DocumentExtensionTests extends ConfigurableTest {", "originalCommit": "c1f079d128a2a4953172addb695dc16f86dc73c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1NTg1Nw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r519655857", "bodyText": "What if we write methods in lambda way?", "author": "asatklichov", "createdAt": "2020-11-09T09:15:26Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/annotation/NonSyntheticMethodMatcher.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *    Broadcom, Inc. - initial API and implementation\n+ *\n+ */\n+\n+package com.broadcom.lsp.cobol.core.annotation;\n+\n+import com.google.inject.matcher.AbstractMatcher;\n+\n+import java.lang.reflect.Method;\n+\n+/**\n+ * Custom {@link com.google.inject.matcher.Matcher} to identify any synthetic method and returns\n+ * false if the method is synthetic\n+ */\n+public class NonSyntheticMethodMatcher extends AbstractMatcher<Method> {\n+\n+  /**\n+   * match any synthetic method and returns false if the method is synthetic\n+   *\n+   * @param method\n+   * @return true if method is non-synthetic and false otherwise\n+   */\n+  @Override\n+  public boolean matches(Method method) {\n+    return !method.isSynthetic();", "originalCommit": "6ceba3083767dcd1c9c3e81491e2552bba4445b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA0NDE4OA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/613#discussion_r522044188", "bodyText": "\ud83d\udc4d", "author": "asatklichov", "createdAt": "2020-11-12T11:43:07Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/CobolTextDocumentService.java", "diffHunk": "@@ -108,70 +115,85 @@\n   }\n \n   @Override\n+  @CheckServerShutdownState\n   public CompletableFuture<Either<List<CompletionItem>, CompletionList>> completion(\n       CompletionParams params) {\n     String uri = params.getTextDocument().getUri();\n     return CompletableFuture.<Either<List<CompletionItem>, CompletionList>>supplyAsync(\n-            () -> Either.forRight(completions.collectFor(docs.get(uri), params)))\n+            () -> Either.forRight(completions.collectFor(docs.get(uri), params)),\n+            executors.getThreadPoolExecutor())", "originalCommit": "c1f079d128a2a4953172addb695dc16f86dc73c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}