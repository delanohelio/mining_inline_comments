{"pr_number": 465, "pr_title": "Remove unnecessary token operations on replacing", "pr_createdAt": "2020-08-20T10:56:50Z", "pr_url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/465", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzMDE3NQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/465#discussion_r473930175", "bodyText": "why only this \"by\" was made lowercase?", "author": "zacanbrcom", "createdAt": "2020-08-20T12:25:12Z", "path": "com.ca.lsp.cobol/lsp-service-cobol/src/test/java/com/ca/lsp/cobol/usecases/TestReplacingPseudoTextReplacesLevelNumber.java", "diffHunk": "@@ -34,7 +34,7 @@\n           + \"2      DATA DIVISION.\\n\"\n           + \"3      WORKING-STORAGE SECTION.\\n\"\n           + \"4      01  {$*PARENT}.\\n\"\n-          + \"5      COPY {~REPL} REPLACING == 01 AA-PARENT == BY == 05  EE-PARENT ==\\n\"\n+          + \"5      COPY {~REPL} REPLACING == 01 AA-PARENT == by == 05  EE-PARENT ==\\n\"", "originalCommit": "15f4c3ec0b4ae5851263abacc953e94c52e49bbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzMjAwMg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/465#discussion_r473932002", "bodyText": "Here and later it is just to assert case-insensitivity. This exact test class was chosen randomly", "author": "temanbrcom", "createdAt": "2020-08-20T12:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzMDE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzMDUxNA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/465#discussion_r473930514", "bodyText": "is there a type on bY?", "author": "zacanbrcom", "createdAt": "2020-08-20T12:25:45Z", "path": "com.ca.lsp.cobol/lsp-core-cobol-parser/src/test/java/com/ca/lsp/core/cobol/preprocessor/sub/util/impl/ReplacingServiceImplTest.java", "diffHunk": "@@ -15,214 +15,57 @@\n \n package com.ca.lsp.core.cobol.preprocessor.sub.util.impl;\n \n-import com.ca.lsp.core.cobol.parser.CobolPreprocessor.*;\n import com.ca.lsp.core.cobol.preprocessor.sub.util.ReplacingService;\n-import com.ca.lsp.core.cobol.preprocessor.sub.util.TokenUtils;\n-import org.antlr.v4.runtime.BufferedTokenStream;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.junit.jupiter.api.Test;\n \n import java.util.List;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.when;\n \n /** This test checks the logic of {@link ReplacingServiceImpl} */\n class ReplacingServiceImplTest {\n-\n   @Test\n-  void applyReplacingPseudoText() {\n-    String original = \" A    1 \";\n-    String expected = \" B 2 \";\n-\n-    BufferedTokenStream tokenStream = mock(BufferedTokenStream.class);\n-    TokenUtils tokenUtils = mock(TokenUtils.class);\n-\n-    ReplaceClauseContext aToB = mock(ReplaceClauseContext.class);\n-\n-    ReplacePseudoTextContext aToBLiteral = mock(ReplacePseudoTextContext.class);\n-\n-    PseudoReplaceableContext aReplaceable = mock(PseudoReplaceableContext.class);\n-    PseudoReplacementContext bReplacement = mock(PseudoReplacementContext.class);\n-\n-    List<ReplaceClauseContext> replaceClauses = List.of(aToB);\n-\n-    when(aToB.replacePseudoText()).thenReturn(aToBLiteral);\n-    when(aToBLiteral.pseudoReplaceable()).thenReturn(aReplaceable);\n-    when(aToBLiteral.pseudoReplacement()).thenReturn(bReplacement);\n-    when(tokenUtils.retrieveTextIncludingHiddenTokens(aReplaceable, tokenStream))\n-        .thenReturn(\"==A 1 ==\");\n-    when(tokenUtils.retrieveTextIncludingHiddenTokens(bReplacement, tokenStream))\n-        .thenReturn(\"== B    2 ==\");\n-\n-    ReplacingService replacingService = new ReplacingServiceImpl(tokenUtils);\n-    String actual = replacingService.applyReplacing(original, replaceClauses, tokenStream);\n-\n-    assertEquals(expected, actual);\n+  void testApplyReplacing() {\n+    ReplacingService replacingService = new ReplacingServiceImpl();\n+    assertEquals(\n+        \"   05\\n\\r.   .CHILD23\\r\\n.\",\n+        replacingService.applyReplacing(\n+            \"   01\\n\\r.   .CHILD13\\r\\n.\",\n+            List.of(\n+                Pair.of(\"(?<=[\\\\.\\\\s\\\\r\\\\n])01(?=[\\\\.\\\\s\\\\r\\\\n])\", \"05\"),\n+                Pair.of(\"CHILD1\", \"CHILD2\"))));\n+\n+    assertEquals(\"01 ABC.\", replacingService.applyReplacing(\"01 ABC.\", List.of(Pair.of(\"\", \"\"))));\n   }\n \n   @Test\n-  void applyReplacingTwoCobolWords() {\n-    String original = \" A A 1 \";\n-    String expected = \" B B 2 \";\n-\n-    BufferedTokenStream tokenStream = mock(BufferedTokenStream.class);\n-    TokenUtils tokenUtils = mock(TokenUtils.class);\n-\n-    ReplaceClauseContext aToB = mock(ReplaceClauseContext.class);\n-    ReplaceClauseContext oneTo2 = mock(ReplaceClauseContext.class);\n-\n-    ReplaceliteralContext aToBLiteral = mock(ReplaceliteralContext.class);\n-    ReplaceliteralContext oneTo2Literal = mock(ReplaceliteralContext.class);\n-\n-    ReplaceableContext aReplaceable = mock(ReplaceableContext.class);\n-    ReplacementContext bReplacement = mock(ReplacementContext.class);\n-\n-    ReplaceableContext oneReplaceable = mock(ReplaceableContext.class);\n-    ReplacementContext twoReplacement = mock(ReplacementContext.class);\n-\n-    ReplaceSameElementContext aReplaceableElement = mock(ReplaceSameElementContext.class);\n-    ReplaceSameElementContext bReplacementElement = mock(ReplaceSameElementContext.class);\n-\n-    ReplaceSameElementContext oneReplaceableElement = mock(ReplaceSameElementContext.class);\n-    ReplaceSameElementContext twoReplacementElement = mock(ReplaceSameElementContext.class);\n-    CobolWordContext cobolWordContext = mock(CobolWordContext.class);\n-\n-    List<ReplaceClauseContext> replaceClauses = List.of(aToB, oneTo2);\n-\n-    when(aToB.replaceliteral()).thenReturn(aToBLiteral);\n-    when(oneTo2.replaceliteral()).thenReturn(oneTo2Literal);\n-    when(aToBLiteral.replaceable()).thenReturn(aReplaceable);\n-    when(aToBLiteral.replacement()).thenReturn(bReplacement);\n-    when(oneTo2Literal.replaceable()).thenReturn(oneReplaceable);\n-    when(oneTo2Literal.replacement()).thenReturn(twoReplacement);\n-    when(aReplaceable.replaceSameElement()).thenReturn(aReplaceableElement);\n-    when(bReplacement.replaceSameElement()).thenReturn(bReplacementElement);\n-    when(oneReplaceable.replaceSameElement()).thenReturn(oneReplaceableElement);\n-    when(twoReplacement.replaceSameElement()).thenReturn(twoReplacementElement);\n-    when(aReplaceableElement.cobolWord()).thenReturn(cobolWordContext);\n-    when(bReplacementElement.cobolWord()).thenReturn(cobolWordContext);\n-    when(oneReplaceableElement.cobolWord()).thenReturn(cobolWordContext);\n-    when(twoReplacementElement.cobolWord()).thenReturn(cobolWordContext);\n-    when(aReplaceableElement.getText()).thenReturn(\"A\");\n-    when(bReplacementElement.getText()).thenReturn(\"B\");\n-    when(oneReplaceableElement.getText()).thenReturn(\"1\");\n-    when(twoReplacementElement.getText()).thenReturn(\"2\");\n-\n-    ReplacingService replacingService = new ReplacingServiceImpl(tokenUtils);\n-    String actual = replacingService.applyReplacing(original, replaceClauses, tokenStream);\n-\n-    assertEquals(expected, actual);\n+  void retrievePseudoTextReplacingPattern() {\n+    ReplacingService replacingService = new ReplacingServiceImpl();\n+    assertEquals(\n+        Pair.of(\"01\", \"05\"),\n+        replacingService.retrievePseudoTextReplacingPattern(\"==01== BY ==05==\"));\n+    assertEquals(Pair.of(\"\", \"\"), replacingService.retrievePseudoTextReplacingPattern(\"\"));\n+    assertEquals(\n+        Pair.of(\"a +b +\\nc\", \"\"),\n+        replacingService.retrievePseudoTextReplacingPattern(\"==a   b  \\nc== bY ====\"));", "originalCommit": "15f4c3ec0b4ae5851263abacc953e94c52e49bbe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzNzY3MA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/465#discussion_r473937670", "bodyText": "great job to simplify the test, I would recommend a line of comment that explain what we provide as input and what is returned as output by the replacing service", "author": "zacanbrcom", "createdAt": "2020-08-20T12:38:43Z", "path": "com.ca.lsp.cobol/lsp-core-cobol-parser/src/test/java/com/ca/lsp/core/cobol/preprocessor/sub/util/impl/ReplacingServiceImplTest.java", "diffHunk": "@@ -15,214 +15,57 @@\n \n package com.ca.lsp.core.cobol.preprocessor.sub.util.impl;\n \n-import com.ca.lsp.core.cobol.parser.CobolPreprocessor.*;\n import com.ca.lsp.core.cobol.preprocessor.sub.util.ReplacingService;\n-import com.ca.lsp.core.cobol.preprocessor.sub.util.TokenUtils;\n-import org.antlr.v4.runtime.BufferedTokenStream;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.junit.jupiter.api.Test;\n \n import java.util.List;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.when;\n \n /** This test checks the logic of {@link ReplacingServiceImpl} */", "originalCommit": "15f4c3ec0b4ae5851263abacc953e94c52e49bbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1NzQzNA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/465#discussion_r474057434", "bodyText": "Yeah, makes sense", "author": "temanbrcom", "createdAt": "2020-08-20T15:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzNzY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2Mzg3MQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/465#discussion_r474063871", "bodyText": "I think that you could delete this line.", "author": "grianbrcom", "createdAt": "2020-08-20T15:18:54Z", "path": "com.ca.lsp.cobol/lsp-core-cobol-parser/src/test/java/com/ca/lsp/core/cobol/preprocessor/sub/document/impl/GrammarPreprocessorListenerImplTest.java", "diffHunk": "@@ -403,18 +404,18 @@ void testMissingCopybook() {\n             tokens,\n             new ArrayDeque<>(),\n             CPY_MODE_ENABLED,\n-            tokenUtils,\n+            //            tokenUtils,", "originalCommit": "15f4c3ec0b4ae5851263abacc953e94c52e49bbe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2NDM1MQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/465#discussion_r474064351", "bodyText": "And here too.", "author": "grianbrcom", "createdAt": "2020-08-20T15:19:31Z", "path": "com.ca.lsp.cobol/lsp-core-cobol-parser/src/test/java/com/ca/lsp/core/cobol/preprocessor/sub/document/impl/GrammarPreprocessorListenerImplTest.java", "diffHunk": "@@ -456,33 +457,36 @@ void testCopybookProcessingDisabled() {\n \n   @Test\n   void testCompilerOptionsExcluded() {\n-    CompilerOptionsContext context = mock(CompilerOptionsContext.class);\n-\n     BufferedTokenStream tokens = mock(BufferedTokenStream.class);\n-    TokenUtils tokenUtils = mock(TokenUtils.class);\n+    Token hidden = mock(Token.class);\n+    when(hidden.getText()).thenReturn(\" \");\n+    when(tokens.getHiddenTokensToLeft(anyInt(), anyInt())).thenReturn(List.of(hidden));\n+    CompilerOptionsContext context = mock(CompilerOptionsContext.class);\n     when(context.getSourceInterval()).thenReturn(new Interval(1, 4));\n \n-    when(tokenUtils.retrieveHiddenTextToLeft(anyInt(), eq(tokens))).thenReturn(\"\");\n-    when(tokenUtils.retrieveHiddenTextToLeft(eq(7), eq(tokens))).thenReturn(\" \");\n-\n-    when(tokenUtils.notEOF(any(TerminalNode.class))).thenReturn(true);\n-\n     GrammarPreprocessorListenerImpl listener =\n         new GrammarPreprocessorListenerImpl(\n-            DOCUMENT_URI, tokens, null, null, tokenUtils, null, null, null);\n+            DOCUMENT_URI,\n+            tokens,\n+            null,\n+            null,\n+            //                tokenUtils,", "originalCommit": "15f4c3ec0b4ae5851263abacc953e94c52e49bbe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a593526182e9259dbb30e6a329363fe9686e8e0", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/0a593526182e9259dbb30e6a329363fe9686e8e0", "message": "perf: Remove unnecessary token operations on replacing\nSimplify replacing logic by reusing text collector in the grammar listener.", "committedDate": "2020-08-20T15:35:55Z", "type": "commit"}, {"oid": "0a593526182e9259dbb30e6a329363fe9686e8e0", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/0a593526182e9259dbb30e6a329363fe9686e8e0", "message": "perf: Remove unnecessary token operations on replacing\nSimplify replacing logic by reusing text collector in the grammar listener.", "committedDate": "2020-08-20T15:35:55Z", "type": "forcePushed"}, {"oid": "8389f3ba5c3cfb0d84f8fcb0d593e1c1044ad8ef", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/8389f3ba5c3cfb0d84f8fcb0d593e1c1044ad8ef", "message": "Merge branch 'development' into in-place-token-utils", "committedDate": "2020-08-21T11:51:13Z", "type": "commit"}]}