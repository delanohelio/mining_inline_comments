{"pr_number": 579, "pr_title": "improvement: Improve Semantic Analysis for Paragraphs #526", "pr_createdAt": "2020-10-26T12:18:25Z", "pr_url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579", "timeline": [{"oid": "b885c99a41c757c43516467dfbab57d7d549985b", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/b885c99a41c757c43516467dfbab57d7d549985b", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T12:18:59Z", "type": "forcePushed"}, {"oid": "246fe514880f7c47f5f081c0400cd7549afd8339", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/246fe514880f7c47f5f081c0400cd7549afd8339", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T12:19:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxOTgyNg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511919826", "bodyText": "we have i18n service now, should be externalized", "author": "asatklichov", "createdAt": "2020-10-26T12:24:15Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/visitor/CobolVisitor.java", "diffHunk": "@@ -63,10 +63,14 @@\n   private static final String INVALID_DEF_MSG = \"Invalid definition for: \";\n   private static final String MISSPELLED_WORD = \"A misspelled word, maybe you want to put \";\n   private static final String PROGRAM_ID_ISSUE_MSG = \"There is an issue with PROGRAM-ID paragraph\";\n+  private static final String PARAGRAPH_NOT_DEFINED_MSG = \"The following paragraph is not defined: \";", "originalCommit": "246fe514880f7c47f5f081c0400cd7549afd8339", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNjAxNQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511926015", "bodyText": "Great, can you point me to an example of how to do that?", "author": "Nurkambay", "createdAt": "2020-10-26T12:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxOTgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNzk3Nw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511927977", "bodyText": "MessageService#getMessage(key)", "author": "asatklichov", "createdAt": "2020-10-26T12:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxOTgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMDUxMA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511930510", "bodyText": "@Nurkambay probably, if you pull changes from dev branch, these would be unused we can get rid of them. Apart from the newly introduced. For which you would have to introduce your key in messages_en.properties file and use.", "author": "ap891843", "createdAt": "2020-10-26T12:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxOTgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MTQ5Ng==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511941496", "bodyText": "Thanks! Done.", "author": "Nurkambay", "createdAt": "2020-10-26T13:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkxOTgyNg=="}], "type": "inlineReview"}, {"oid": "82c7b5319d738adc68da31bf8794e18ad6e7118c", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/82c7b5319d738adc68da31bf8794e18ad6e7118c", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T12:54:14Z", "type": "forcePushed"}, {"oid": "e4b1ec82d4bf4a8b26742ab49fce850a594d1e0d", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/e4b1ec82d4bf4a8b26742ab49fce850a594d1e0d", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T13:01:56Z", "type": "forcePushed"}, {"oid": "6d3b63be6198ba241b4fa1a4d3195e027bd1ca10", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/6d3b63be6198ba241b4fa1a4d3195e027bd1ca10", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T13:04:09Z", "type": "forcePushed"}, {"oid": "c0bc9fb78e99b46d792a1b2081b5c9b8d0f263f4", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/c0bc9fb78e99b46d792a1b2081b5c9b8d0f263f4", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T13:05:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1MjE2OA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511952168", "bodyText": "The name is already in UpperCase. It's done in visitParagraphNameUsage method.", "author": "grianbrcom", "createdAt": "2020-10-26T13:19:36Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/visitor/CobolVisitor.java", "diffHunk": "@@ -436,12 +444,21 @@ private void addUsage(SubContext<?> langContext, String name, @NonNull Location\n     langContext.addUsage(name.toUpperCase(), location);\n   }\n \n+  private void addParagraphUsage(String name, @NonNull Locality locality) {\n+    paragraphs.addUsage(name.toUpperCase(), locality.toLocation());", "originalCommit": "c0bc9fb78e99b46d792a1b2081b5c9b8d0f263f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk3OTAwOA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511979008", "bodyText": "Thanks, fixed.", "author": "Nurkambay", "createdAt": "2020-10-26T13:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1MjE2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1Njc2NQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511956765", "bodyText": "I think that you can wrap PRINT-DATA like:\n+ \"           PERFORM {#PRINT-DATA}.\";\n\nIt will calculate the position automatically. Please, refer to UseCaseEngine docs for details. I didn't have a chance to use it but want to try someday. So, my suggestion can be wrong.", "author": "grianbrcom", "createdAt": "2020-10-26T13:26:25Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/usecases/TestParagraphNotDefined.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.broadcom.lsp.cobol.usecases;\n+\n+import org.eclipse.lsp4j.Diagnostic;\n+import org.eclipse.lsp4j.DiagnosticSeverity;\n+import org.eclipse.lsp4j.Position;\n+import org.eclipse.lsp4j.Range;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+class TestParagraphNotDefined extends NegativeUseCase {\n+    private static final String TEXT =\n+            \"        IDENTIFICATION DIVISION.\\r\\n\"\n+                    + \"        PROGRAM-ID. test1.\\r\\n\"\n+                    + \"        DATA DIVISION.\\r\\n\"\n+                    + \"        WORKING-STORAGE SECTION.\\r\\n\"\n+                    + \"        PROCEDURE DIVISION.\\r\\n\"\n+                    + \"        PROGA.\\r\\n\"\n+                    + \"           PERFORM PRINT-DATA.\";", "originalCommit": "c0bc9fb78e99b46d792a1b2081b5c9b8d0f263f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4MDUwMQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r511980501", "bodyText": "In that case there will be 2 diagnostic errors. One of them will be that counts for usages and declarations do not match. To avoid this I did not use {#PRINT-DATA}", "author": "Nurkambay", "createdAt": "2020-10-26T13:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1Njc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAzMDIzOQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512030239", "bodyText": "Fixed with Andrei's help :-)", "author": "Nurkambay", "createdAt": "2020-10-26T15:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1Njc2NQ=="}], "type": "inlineReview"}, {"oid": "8ad095af209e4daada9a2fa2c6126ed970f190a3", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/8ad095af209e4daada9a2fa2c6126ed970f190a3", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T13:59:30Z", "type": "forcePushed"}, {"oid": "8075fc942522fcf54c5f2c998e31aa8a23baebcc", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/8075fc942522fcf54c5f2c998e31aa8a23baebcc", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T14:04:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNDc4NA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512004784", "bodyText": "PROGA is a paragraph definition, you need to wrap it also\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                + \"        PROGA.\\r\\n\"\n          \n          \n            \n                                + \"           PERFORM PRINT-DATA.\";\n          \n          \n            \n                                + \"        {#*PROGA}.\\r\\n\"\n          \n          \n            \n                                + \"           PERFORM {#PRINT-DATA}.\";", "author": "temanbrcom", "createdAt": "2020-10-26T14:31:24Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/usecases/TestParagraphNotDefined.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.broadcom.lsp.cobol.usecases;\n+\n+import org.eclipse.lsp4j.Diagnostic;\n+import org.eclipse.lsp4j.DiagnosticSeverity;\n+import org.eclipse.lsp4j.Position;\n+import org.eclipse.lsp4j.Range;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+class TestParagraphNotDefined extends NegativeUseCase {\n+    private static final String TEXT =\n+            \"        IDENTIFICATION DIVISION.\\r\\n\"\n+                    + \"        PROGRAM-ID. test1.\\r\\n\"\n+                    + \"        DATA DIVISION.\\r\\n\"\n+                    + \"        WORKING-STORAGE SECTION.\\r\\n\"\n+                    + \"        PROCEDURE DIVISION.\\r\\n\"\n+                    + \"        PROGA.\\r\\n\"\n+                    + \"           PERFORM PRINT-DATA.\";", "originalCommit": "8075fc942522fcf54c5f2c998e31aa8a23baebcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyOTk5Ng==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512029996", "bodyText": "Done", "author": "Nurkambay", "createdAt": "2020-10-26T15:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNDc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNTY1Ng==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512005656", "bodyText": "Please, provide a description of what do you check here and what is the expected behavior", "author": "temanbrcom", "createdAt": "2020-10-26T14:32:25Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/usecases/TestParagraphSectionDefined.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.broadcom.lsp.cobol.usecases;\n+\n+import com.broadcom.lsp.cobol.usecases.engine.UseCaseEngine;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+class TestParagraphSectionDefined {", "originalCommit": "8075fc942522fcf54c5f2c998e31aa8a23baebcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyOTg4NQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512029885", "bodyText": "Done", "author": "Nurkambay", "createdAt": "2020-10-26T15:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNTY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNTkxOA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512005918", "bodyText": "Please, remove the empty lines", "author": "temanbrcom", "createdAt": "2020-10-26T14:32:46Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/usecases/TestParagraphSectionDefined.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.broadcom.lsp.cobol.usecases;\n+\n+import com.broadcom.lsp.cobol.usecases.engine.UseCaseEngine;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+class TestParagraphSectionDefined {\n+  private static final String TEXT =\n+\"       IDENTIFICATION DIVISION.\\n\" +\n+        \"          PROGRAM-ID. TEST1.\\n\" +\n+        \"          DATA DIVISION.\\n\" +\n+        \"          WORKING-STORAGE SECTION.\\n\" +\n+        \"    \\n\" +", "originalCommit": "8075fc942522fcf54c5f2c998e31aa8a23baebcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyOTc5OA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512029798", "bodyText": "Done", "author": "Nurkambay", "createdAt": "2020-10-26T15:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNTkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxMjg5MQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512012891", "bodyText": "Ok, will work for now. We will change the paragraph context to accept localities later on, altogether with the same late check for variables.", "author": "temanbrcom", "createdAt": "2020-10-26T14:41:27Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/visitor/CobolVisitor.java", "diffHunk": "@@ -55,19 +55,15 @@\n  */\n @Slf4j\n public class CobolVisitor extends CobolParserBaseVisitor<Class> {\n-  private static final String AREA_A_WARNING_MSG = \"The following token must start in Area A: \";\n-  private static final String AREA_B_WARNING_MSG = \"The following token must start in Area B: \";\n-  private static final String IDENTICAL_PROGRAM_MSG =\n-      \"Program-name must be identical to the program-name of the corresponding PROGRAM-ID paragraph: \";\n   private static final String DECLARATIVE_SAME_MSG =\n       \"The following token cannot be on the same line as a DECLARATIVE token: \";\n-  private static final String INVALID_DEF_MSG = \"Invalid definition for: \";\n-  private static final String MISSPELLED_WORD = \"A misspelled word, maybe you want to put \";\n-  private static final String PROGRAM_ID_ISSUE_MSG = \"There is an issue with PROGRAM-ID paragraph\";\n \n-  @Getter private List<SyntaxError> errors = new ArrayList<>();\n+  private List<SyntaxError> errors = new ArrayList<>();\n \n   private SubContext<String> paragraphs = new NamedSubContext();\n+  private Multimap<String, Locality> paragraphUsageLocalities = HashMultimap.create();\n+  private Multimap<String, Locality> paragraphDefinitionLocalities = HashMultimap.create();", "originalCommit": "8075fc942522fcf54c5f2c998e31aa8a23baebcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjY4Mw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512026683", "bodyText": "Yep. Better to use Locality instead of Location internally and only for publishing to the client convert map values to Location.", "author": "Nurkambay", "createdAt": "2020-10-26T14:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxMjg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNTY1OA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512015658", "bodyText": "A section is not a paragraph, it should not be consumed here", "author": "temanbrcom", "createdAt": "2020-10-26T14:44:57Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/visitor/CobolVisitor.java", "diffHunk": "@@ -190,6 +194,10 @@ public Class visitProgramUnit(ProgramUnitContext ctx) {\n   public Class visitProcedureSection(ProcedureSectionContext ctx) {\n     throwWarning(ctx.getStart());\n     outlineTreeBuilder.addNode(ctx.getStart().getText(), NodeType.PROCEDURE_SECTION, ctx);\n+\n+    String name = ctx.getStart().getText().toUpperCase();\n+    getLocality(ctx.getStart())\n+        .ifPresent(locality -> paragraphDefinitionLocalities.put(name, locality));", "originalCommit": "8075fc942522fcf54c5f2c998e31aa8a23baebcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNzAwNQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/579#discussion_r512027005", "bodyText": "Discussed in the chat. Closed.", "author": "Nurkambay", "createdAt": "2020-10-26T14:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNTY1OA=="}], "type": "inlineReview"}, {"oid": "944e0c0ecbd0db16f2e43b2a20f3a0f0b6cfe15b", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/944e0c0ecbd0db16f2e43b2a20f3a0f0b6cfe15b", "message": "improvement: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T15:03:01Z", "type": "forcePushed"}, {"oid": "b3dddaebf900ad7b1870493d0a3bdc8373f76f99", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/b3dddaebf900ad7b1870493d0a3bdc8373f76f99", "message": "feat: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T15:30:58Z", "type": "commit"}, {"oid": "b3dddaebf900ad7b1870493d0a3bdc8373f76f99", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/b3dddaebf900ad7b1870493d0a3bdc8373f76f99", "message": "feat: Improve Semantic Analysis for Paragraphs #526\n\nSigned-off-by: Leonid Baranov <leonid.baranov@broadcom.com>", "committedDate": "2020-10-26T15:30:58Z", "type": "forcePushed"}]}