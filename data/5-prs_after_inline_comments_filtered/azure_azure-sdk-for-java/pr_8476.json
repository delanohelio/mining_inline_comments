{"pr_number": 8476, "pr_title": "Fixing OkHttp Async Client early stream closing", "pr_createdAt": "2020-02-25T19:46:45Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/8476", "timeline": [{"oid": "9db1f40c282ef85ad98b7c2c6fcf70f40239850a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9db1f40c282ef85ad98b7c2c6fcf70f40239850a", "message": "Fixing OkHttp Async Client early stream closing", "committedDate": "2020-02-25T20:14:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEwODI0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8476#discussion_r384108246", "bodyText": "Do we still need the null check for mocking (a) and cacheResponse, networkResponse etc (b)?", "author": "srnagar", "createdAt": "2020-02-25T20:28:33Z", "path": "sdk/core/azure-core-http-okhttp/src/main/java/com/azure/core/http/okhttp/OkHttpAsyncHttpClient.java", "diffHunk": "@@ -178,29 +178,21 @@ public void onResponse(okhttp3.Call call, okhttp3.Response response) {\n     private static class OkHttpResponse extends HttpResponse {\n         private final int statusCode;\n         private final HttpHeaders headers;\n-        private final Mono<ResponseBody> responseBodyMono;\n+        private final ResponseBody responseBody;\n         // using 4K as default buffer size: https://stackoverflow.com/a/237495/1473510\n         private static final int BYTE_BUFFER_CHUNK_SIZE = 4096;\n \n         OkHttpResponse(Response innerResponse, HttpRequest request) {\n             super(request);\n             this.statusCode = innerResponse.code();\n             this.headers = fromOkHttpHeaders(innerResponse.headers());\n-            if (innerResponse.body() == null) {\n-                // innerResponse.body() getter will not return null for server returned responses.\n-                // It can be null:\n-                // [a]. if response is built manually with null body (e.g for mocking)\n-                // [b]. for the cases described here\n-                // [ref](https://square.github.io/okhttp/4.x/okhttp/okhttp3/-response/body/).\n-                //\n-                this.responseBodyMono = Mono.empty();\n-            } else {\n-                this.responseBodyMono = Mono.using(innerResponse::body,\n-                    Mono::just,\n-                    // Resource cleanup\n-                    // square.github.io/okhttp/4.x/okhttp/okhttp3/-response-body/#the-response-body-must-be-closed\n-                    ResponseBody::close, /* Change in behavior since reactor-core 3.3.0.RELEASE */ false);\n-            }\n+            // innerResponse.body() getter will not return null for server returned responses.\n+            // It can be null:\n+            // [a]. if response is built manually with null body (e.g for mocking)\n+            // [b]. for the cases described here\n+            // [ref](https://square.github.io/okhttp/4.x/okhttp/okhttp3/-response/body/).\n+            //\n+            this.responseBody = innerResponse.body();", "originalCommit": "9db1f40c282ef85ad98b7c2c6fcf70f40239850a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExMTE2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8476#discussion_r384111163", "bodyText": "we do that in each of the places this.responseBody is used.", "author": "anuchandy", "createdAt": "2020-02-25T20:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEwODI0Ng=="}], "type": "inlineReview"}, {"oid": "d2b4ff9e16b0dc79671bf9566f39de5abc342e11", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d2b4ff9e16b0dc79671bf9566f39de5abc342e11", "message": "Fixing OkHttp Async Client early stream closing", "committedDate": "2020-02-25T22:11:02Z", "type": "forcePushed"}, {"oid": "d1097ddf5f30abd632822cb35dcd89aa2920e631", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d1097ddf5f30abd632822cb35dcd89aa2920e631", "message": "Fixing OkHttp Async Client early stream closing", "committedDate": "2020-02-25T23:19:13Z", "type": "commit"}, {"oid": "d1097ddf5f30abd632822cb35dcd89aa2920e631", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d1097ddf5f30abd632822cb35dcd89aa2920e631", "message": "Fixing OkHttp Async Client early stream closing", "committedDate": "2020-02-25T23:19:13Z", "type": "forcePushed"}, {"oid": "e8efd396da7150fd8dff699ce492f095eefcb1c9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8efd396da7150fd8dff699ce492f095eefcb1c9", "message": "sync upstream", "committedDate": "2020-03-24T21:17:14Z", "type": "commit"}, {"oid": "7801052cd001aa3669e837fd6a73c75cc281df91", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7801052cd001aa3669e837fd6a73c75cc281df91", "message": "use regex based spotbug pattern for okhttp PZLA_PREFER_ZERO_LENGTH_ARRAYS", "committedDate": "2020-03-24T21:40:38Z", "type": "commit"}]}