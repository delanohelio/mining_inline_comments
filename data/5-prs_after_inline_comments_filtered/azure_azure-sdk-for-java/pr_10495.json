{"pr_number": 10495, "pr_title": "Sync Sender Client :  Adding Schedule and cancel schedule", "pr_createdAt": "2020-04-24T19:28:39Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10495", "timeline": [{"oid": "e8af3b5953bb890151416e7b1adc50f3f9d46b61", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8af3b5953bb890151416e7b1adc50f3f9d46b61", "message": "Adding schedule and scncel schedule in sync sender", "committedDate": "2020-04-24T19:27:11Z", "type": "commit"}, {"oid": "3179e87b29fc9e78a6622fc3bb4d1fa061cd8ef2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3179e87b29fc9e78a6622fc3bb4d1fa061cd8ef2", "message": "Adding some test details", "committedDate": "2020-04-24T19:30:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxNzYwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10495#discussion_r414817609", "bodyText": "Queue or topic?", "author": "conniey", "createdAt": "2020-04-24T19:38:56Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderClient.java", "diffHunk": "@@ -70,6 +72,32 @@ public void send(ServiceBusMessage message) {\n         asyncClient.send(message).block(tryTimeout);\n     }\n \n+    /**\n+     * Sends a scheduled message to the Azure Service Bus entity this sender is connected to. A scheduled message is\n+     * enqueued and made available to receivers only at the scheduled enqueue time.\n+     *\n+     * @param message Message to be sent to the Service Bus Queue.", "originalCommit": "3179e87b29fc9e78a6622fc3bb4d1fa061cd8ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxNzgyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10495#discussion_r414817825", "bodyText": "service bus -> Service Bus", "author": "conniey", "createdAt": "2020-04-24T19:39:22Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderClient.java", "diffHunk": "@@ -70,6 +72,32 @@ public void send(ServiceBusMessage message) {\n         asyncClient.send(message).block(tryTimeout);\n     }\n \n+    /**\n+     * Sends a scheduled message to the Azure Service Bus entity this sender is connected to. A scheduled message is\n+     * enqueued and made available to receivers only at the scheduled enqueue time.\n+     *\n+     * @param message Message to be sent to the Service Bus Queue.\n+     * @param scheduledEnqueueTime Instant at which the message should appear in the Service Bus queue or topic.\n+     *\n+     * @return The sequence number of the scheduled message which can be used to cancel the scheduling of the message.\n+     *\n+     * @throws NullPointerException if {@code message} or {@code scheduledEnqueueTime} is {@code null}.\n+     */\n+    public long scheduleMessage(ServiceBusMessage message, Instant scheduledEnqueueTime) {\n+        return asyncClient.scheduleMessage(message, scheduledEnqueueTime).block(tryTimeout);\n+    }\n+\n+    /**\n+     * Cancels the enqueuing of an already scheduled message, if it was not already enqueued.\n+     *\n+     * @param sequenceNumber of the scheduled message to cancel.\n+     *\n+     * @return The {@link Mono} that finishes this operation on service bus resource.", "originalCommit": "3179e87b29fc9e78a6622fc3bb4d1fa061cd8ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxODE4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10495#discussion_r414818180", "bodyText": "The sequence number can be 0 if it is in the beginning of stream.", "author": "conniey", "createdAt": "2020-04-24T19:40:02Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusSenderClientIntegrationTest.java", "diffHunk": "@@ -104,6 +106,50 @@ void nonSessionMessageBatch(MessagingEntityType entityType) {\n         }\n     }\n \n+    /**\n+     * Verifies that we can schedule a message to a non-session entity.\n+     */\n+    @MethodSource(\"receiverTypesProvider\")\n+    @ParameterizedTest\n+    void nonSessionScheduleMessage(MessagingEntityType entityType) {\n+        // Arrange\n+        setSenderAndReceiver(entityType);\n+\n+        final Instant scheduledEnqueueTime = Instant.now().plusSeconds(10);\n+        final String messageId = UUID.randomUUID().toString();\n+        final String contents = \"Some-contents\";\n+        final ServiceBusMessage message = TestUtils.getServiceBusMessage(contents, messageId);\n+\n+        // Act\n+        long sequenceNumber = sender.scheduleMessage(message, scheduledEnqueueTime);\n+\n+        // Assert\n+        Assertions.assertTrue(sequenceNumber > 0);", "originalCommit": "3179e87b29fc9e78a6622fc3bb4d1fa061cd8ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg0NDA4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10495#discussion_r414844088", "bodyText": "I am changing it to >=0 but When I try to send first message to a Queue, it always start  from 1.  But  SB docs says that  after reaching to max, it can roll over to zero.", "author": "hemanttanwar", "createdAt": "2020-04-24T20:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxODE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxODUwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10495#discussion_r414818500", "bodyText": "If this succeeds, you'll want to decrement messages pending.", "author": "conniey", "createdAt": "2020-04-24T19:40:41Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusSenderClientIntegrationTest.java", "diffHunk": "@@ -104,6 +106,50 @@ void nonSessionMessageBatch(MessagingEntityType entityType) {\n         }\n     }\n \n+    /**\n+     * Verifies that we can schedule a message to a non-session entity.\n+     */\n+    @MethodSource(\"receiverTypesProvider\")\n+    @ParameterizedTest\n+    void nonSessionScheduleMessage(MessagingEntityType entityType) {\n+        // Arrange\n+        setSenderAndReceiver(entityType);\n+\n+        final Instant scheduledEnqueueTime = Instant.now().plusSeconds(10);\n+        final String messageId = UUID.randomUUID().toString();\n+        final String contents = \"Some-contents\";\n+        final ServiceBusMessage message = TestUtils.getServiceBusMessage(contents, messageId);\n+\n+        // Act\n+        long sequenceNumber = sender.scheduleMessage(message, scheduledEnqueueTime);\n+\n+        // Assert\n+        Assertions.assertTrue(sequenceNumber > 0);\n+\n+        messagesPending.incrementAndGet();\n+    }\n+\n+    /**\n+     * Verifies that we can cancel a scheduled a message to a non-session entity.\n+     */\n+    @MethodSource(\"receiverTypesProvider\")\n+    @ParameterizedTest\n+    void nonSessionCancelScheduleMessage(MessagingEntityType entityType) {\n+        // Arrange\n+        setSenderAndReceiver(entityType);\n+\n+        final Instant scheduledEnqueueTime = Instant.now().plusSeconds(20);\n+        final String messageId = UUID.randomUUID().toString();\n+        final String contents = \"Some-contents\";\n+        final ServiceBusMessage message = TestUtils.getServiceBusMessage(contents, messageId);\n+\n+        // Assert & Act\n+        long sequenceNumber = sender.scheduleMessage(message, scheduledEnqueueTime);\n+        Assertions.assertTrue(sequenceNumber > 0);\n+\n+        sender.cancelScheduledMessage(sequenceNumber);", "originalCommit": "3179e87b29fc9e78a6622fc3bb4d1fa061cd8ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab9be343b2d6cbe1ab6ceefcd8be1d74f7cb90b5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ab9be343b2d6cbe1ab6ceefcd8be1d74f7cb90b5", "message": "Review comments", "committedDate": "2020-04-24T20:30:44Z", "type": "commit"}, {"oid": "3571c3778fc32fe8ef9e9ac3dbc1d2da8d3dc059", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3571c3778fc32fe8ef9e9ac3dbc1d2da8d3dc059", "message": "Review comments", "committedDate": "2020-04-24T22:19:37Z", "type": "commit"}]}