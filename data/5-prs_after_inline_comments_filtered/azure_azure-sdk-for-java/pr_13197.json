{"pr_number": 13197, "pr_title": "support multiple database in azure-spring-data-cosmos", "pr_createdAt": "2020-07-15T09:39:55Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13197", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2Mjc0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455162748", "bodyText": "AutoCreateContainer is an annotation property - which supports creating containers automatically in cosmosdb if not exists.\nWhy are we removing this functionality ?", "author": "kushagraThapar", "createdAt": "2020-07-15T16:03:02Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/support/SimpleReactiveCosmosRepository.java", "diffHunk": "@@ -28,22 +27,6 @@\n     private final CosmosEntityInformation<T, K> entityInformation;\n     private final ReactiveCosmosOperations cosmosOperations;\n \n-    /**\n-     * Initialization with metadata and applicationContext will create container if required\n-     *\n-     * @param metadata for entityInformation\n-     * @param applicationContext for cosmosOperations\n-     */\n-    public SimpleReactiveCosmosRepository(CosmosEntityInformation<T, K> metadata,\n-                                          ApplicationContext applicationContext) {\n-        this.cosmosOperations = applicationContext.getBean(ReactiveCosmosOperations.class);\n-        this.entityInformation = metadata;\n-\n-        if (this.entityInformation.isAutoCreateContainer()) {", "originalCommit": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2NzU3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455467574", "bodyText": "Because now we support multiple cosmos template, we update the getTargetRepository method in ReactiveCosmosRepositoryFactory.java, see here, use cosmosOperations to replace applicationContext, we don't use applicationContext any more,  so I delete this constructor method", "author": "zhoufenqin", "createdAt": "2020-07-16T02:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2Mjc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ4OTk4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455489986", "bodyText": "Okay, I guess - we will have to find some other way to respect this annotation then, because otherwise containers will not be created when an entity will be initialized, no ?\nAnd what would be the way to stop creating the containers automatically if the user wants to set this value to false.", "author": "kushagraThapar", "createdAt": "2020-07-16T03:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2Mjc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUxNDE5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455514198", "bodyText": "Now we use this constructor to create SimpleReactiveCosmosRepository,\npublic SimpleReactiveCosmosRepository(CosmosEntityInformation<T, K> metadata,\n                                          ReactiveCosmosOperations reactiveCosmosOperations) {\n        this.cosmosOperations = reactiveCosmosOperations;\n        this.entityInformation = metadata;\n\n        if (this.entityInformation.isAutoCreateContainer()) {\n            createContainerIfNotExists();\n        }\n    }\ncustomers can still use annotation property to decide to create containers or not", "author": "zhoufenqin", "createdAt": "2020-07-16T05:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2Mjc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyMTQ2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455521461", "bodyText": "Sounds good, thank you for explaining this.\nBy the way - here is the PR that brings azure-spring-data-cosmos to azure-cosmos dependency V4 - which is track 2 library : #13229\nPlease take a look if you can, your suggestions will be helpful.", "author": "kushagraThapar", "createdAt": "2020-07-16T05:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2Mjc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2Mjg5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455162890", "bodyText": "Same here -\nWhy are we removing this functionality ?", "author": "kushagraThapar", "createdAt": "2020-07-15T16:03:17Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/support/SimpleCosmosRepository.java", "diffHunk": "@@ -32,22 +31,6 @@\n     private final CosmosOperations operation;\n     private final CosmosEntityInformation<T, ID> information;\n \n-    /**\n-     * Initialization\n-     *\n-     * @param metadata for cosmos entity information\n-     * @param applicationContext to get bean of CosmosOperations class\n-     */\n-    public SimpleCosmosRepository(CosmosEntityInformation<T, ID> metadata,\n-                                  ApplicationContext applicationContext) {\n-        this.operation = applicationContext.getBean(CosmosOperations.class);\n-        this.information = metadata;\n-\n-        if (this.information.isAutoCreateContainer()) {", "originalCommit": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0c3b047c2dabfbe3b8e6e5a5251396638506d224", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0c3b047c2dabfbe3b8e6e5a5251396638506d224", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-16T01:50:32Z", "type": "forcePushed"}, {"oid": "b887df18a3073f98db6bfd9a20751c621debe3b1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b887df18a3073f98db6bfd9a20751c621debe3b1", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-16T03:08:46Z", "type": "forcePushed"}, {"oid": "c9fb39ef4c98705c8ba7a9729dee0980979bc38e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c9fb39ef4c98705c8ba7a9729dee0980979bc38e", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-16T05:06:17Z", "type": "forcePushed"}, {"oid": "7b98471d19530bdca028a7217483efb96a712369", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b98471d19530bdca028a7217483efb96a712369", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-16T06:55:55Z", "type": "forcePushed"}, {"oid": "e0d372248b3aa890a53c26726a7149f5a26227ae", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e0d372248b3aa890a53c26726a7149f5a26227ae", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-17T02:53:54Z", "type": "forcePushed"}, {"oid": "6197bd8e608fae4f2511e1d47af156b39bdba3c3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6197bd8e608fae4f2511e1d47af156b39bdba3c3", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-17T04:45:23Z", "type": "forcePushed"}, {"oid": "91b6fedadd118166d4542535534e81e21661feac", "url": "https://github.com/Azure/azure-sdk-for-java/commit/91b6fedadd118166d4542535534e81e21661feac", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-17T05:06:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMjMzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456222335", "bodyText": "Update here -> azure.cosmos.primary", "author": "kushagraThapar", "createdAt": "2020-07-17T05:14:13Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/samples/java/com/azure/cosmos/multidatasource/DatabaseConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.multidatasource;\n+\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.CosmosProperties;\n+import com.azure.spring.data.cosmos.CosmosFactory;\n+import com.azure.spring.data.cosmos.config.AbstractCosmosConfiguration;\n+import com.azure.spring.data.cosmos.config.CosmosConfig;\n+import com.azure.spring.data.cosmos.core.ReactiveCosmosTemplate;\n+import com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter;\n+import com.azure.spring.data.cosmos.repository.config.EnableReactiveCosmosRepositories;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.PropertySource;\n+\n+/**\n+ * WARNING: MODIFYING THIS FILE WILL REQUIRE CORRESPONDING UPDATES TO README.md FILE. LINE NUMBERS\n+ * ARE USED TO EXTRACT APPROPRIATE CODE SEGMENTS FROM THIS FILE. ADD NEW CODE AT THE BOTTOM TO AVOID CHANGING\n+ * LINE NUMBERS OF EXISTING CODE SAMPLES.\n+ */\n+@Configuration\n+@PropertySource(\"classpath:application.properties\")\n+public class DatabaseConfiguration extends AbstractCosmosConfiguration {\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.primary\")", "originalCommit": "91b6fedadd118166d4542535534e81e21661feac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMjM2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456222360", "bodyText": "Update here -> azure.cosmos.secondary", "author": "kushagraThapar", "createdAt": "2020-07-17T05:14:19Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/samples/java/com/azure/cosmos/multidatasource/DatabaseConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.multidatasource;\n+\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.CosmosProperties;\n+import com.azure.spring.data.cosmos.CosmosFactory;\n+import com.azure.spring.data.cosmos.config.AbstractCosmosConfiguration;\n+import com.azure.spring.data.cosmos.config.CosmosConfig;\n+import com.azure.spring.data.cosmos.core.ReactiveCosmosTemplate;\n+import com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter;\n+import com.azure.spring.data.cosmos.repository.config.EnableReactiveCosmosRepositories;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.PropertySource;\n+\n+/**\n+ * WARNING: MODIFYING THIS FILE WILL REQUIRE CORRESPONDING UPDATES TO README.md FILE. LINE NUMBERS\n+ * ARE USED TO EXTRACT APPROPRIATE CODE SEGMENTS FROM THIS FILE. ADD NEW CODE AT THE BOTTOM TO AVOID CHANGING\n+ * LINE NUMBERS OF EXISTING CODE SAMPLES.\n+ */\n+@Configuration\n+@PropertySource(\"classpath:application.properties\")\n+public class DatabaseConfiguration extends AbstractCosmosConfiguration {\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.primary\")\n+    public CosmosProperties primaryDataSourceConfiguration() {\n+        return new CosmosProperties();\n+    }\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.secondary\")", "originalCommit": "91b6fedadd118166d4542535534e81e21661feac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMjYxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456222616", "bodyText": "We also changed collection -> container.\nCan you please update it here and other places -> users-container", "author": "kushagraThapar", "createdAt": "2020-07-17T05:15:18Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/samples/java/com/azure/cosmos/multidatasource/primarydatasource/User.java", "diffHunk": "@@ -0,0 +1,70 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.multidatasource.primarydatasource;\n+\n+import com.azure.spring.data.cosmos.core.mapping.Document;\n+import com.azure.spring.data.cosmos.core.mapping.PartitionKey;\n+import org.springframework.data.annotation.Id;\n+\n+/**\n+ * WARNING: MODIFYING THIS FILE WILL REQUIRE CORRESPONDING UPDATES TO README.md FILE. LINE NUMBERS\n+ * ARE USED TO EXTRACT APPROPRIATE CODE SEGMENTS FROM THIS FILE. ADD NEW CODE AT THE BOTTOM TO AVOID CHANGING\n+ * LINE NUMBERS OF EXISTING CODE SAMPLES.\n+ */\n+\n+@Document(container = \"users-collection\", ru = \"400\")", "originalCommit": "91b6fedadd118166d4542535534e81e21661feac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMjczMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456222730", "bodyText": "Please update to book-container", "author": "kushagraThapar", "createdAt": "2020-07-17T05:15:38Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/samples/java/com/azure/cosmos/multidatasource/secondarydatasource/Book.java", "diffHunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.multidatasource.secondarydatasource;\n+\n+import com.azure.spring.data.cosmos.core.mapping.Document;\n+import org.springframework.data.annotation.Id;\n+\n+/**\n+ * WARNING: MODIFYING THIS FILE WILL REQUIRE CORRESPONDING UPDATES TO README.md FILE. LINE NUMBERS\n+ * ARE USED TO EXTRACT APPROPRIATE CODE SEGMENTS FROM THIS FILE. ADD NEW CODE AT THE BOTTOM TO AVOID CHANGING\n+ * LINE NUMBERS OF EXISTING CODE SAMPLES.\n+ */\n+\n+@Document(container = \"book-collection\", ru = \"400\")", "originalCommit": "91b6fedadd118166d4542535534e81e21661feac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d92dcbc83c8deeea6158ae53667bfa90c1f97327", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d92dcbc83c8deeea6158ae53667bfa90c1f97327", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-17T06:53:43Z", "type": "commit"}, {"oid": "d92dcbc83c8deeea6158ae53667bfa90c1f97327", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d92dcbc83c8deeea6158ae53667bfa90c1f97327", "message": "support multiple database in azure-spring-data-cosmos", "committedDate": "2020-07-17T06:53:43Z", "type": "forcePushed"}, {"oid": "c26c2a12df018bbc126c28e5a2701fea681876f0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c26c2a12df018bbc126c28e5a2701fea681876f0", "message": "Merge branch 'master' into feature/support-multiple-database-in-spring-data-cosmos", "committedDate": "2020-07-17T15:45:55Z", "type": "commit"}, {"oid": "4f09f6082d6633d7580f83981b6cdd3a188f0d96", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4f09f6082d6633d7580f83981b6cdd3a188f0d96", "message": "Re-exanding parameters", "committedDate": "2020-07-17T16:45:19Z", "type": "commit"}]}