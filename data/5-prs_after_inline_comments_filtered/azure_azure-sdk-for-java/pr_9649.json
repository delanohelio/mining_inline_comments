{"pr_number": 9649, "pr_title": "[Storage] Jumbo blob support", "pr_createdAt": "2020-03-27T20:03:13Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9649", "timeline": [{"oid": "eedfabe271f3d1925fd4e88030d46521a2259c0a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/eedfabe271f3d1925fd4e88030d46521a2259c0a", "message": "draft of stage 4gb block and upload of 200tb flux.", "committedDate": "2020-03-27T20:01:41Z", "type": "commit"}, {"oid": "6f1a6e2560cb761e0303823d56104b31f137683b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f1a6e2560cb761e0303823d56104b31f137683b", "message": "handle put block retries gracefully", "committedDate": "2020-03-28T01:02:39Z", "type": "commit"}, {"oid": "955a2f904d781172342807259210f9cb5127b98f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/955a2f904d781172342807259210f9cb5127b98f", "message": "wip", "committedDate": "2020-04-01T20:46:43Z", "type": "commit"}, {"oid": "9e776e823daa57c93f96521eaae3904d14178249", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e776e823daa57c93f96521eaae3904d14178249", "message": "wip", "committedDate": "2020-04-01T22:20:18Z", "type": "commit"}, {"oid": "dc7e025bf604bfcde4421c2bca33d0faee816baa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dc7e025bf604bfcde4421c2bca33d0faee816baa", "message": "wip", "committedDate": "2020-04-01T23:12:54Z", "type": "commit"}, {"oid": "85e4e4756167510c8d8cd4eeffa669463c627815", "url": "https://github.com/Azure/azure-sdk-for-java/commit/85e4e4756167510c8d8cd4eeffa669463c627815", "message": "Merge from stg73", "committedDate": "2020-04-01T23:30:06Z", "type": "commit"}, {"oid": "9ff81371a0a48fb5647d0a0b51d854d0aa9626d5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9ff81371a0a48fb5647d0a0b51d854d0aa9626d5", "message": "make ParallelTransferOptions fluent.", "committedDate": "2020-04-03T22:30:52Z", "type": "commit"}, {"oid": "0687e8284dea4b2340f73828215974f6e5d7491c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0687e8284dea4b2340f73828215974f6e5d7491c", "message": "fix test", "committedDate": "2020-04-03T22:48:35Z", "type": "commit"}, {"oid": "b4800189aac606f29e50de83c289d93e0b78b31c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b4800189aac606f29e50de83c289d93e0b78b31c", "message": "force int64 type on size in client generator", "committedDate": "2020-04-03T22:56:11Z", "type": "commit"}, {"oid": "e9053dd117e8e0f3eaa4a34753b8f31ddf73b81c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e9053dd117e8e0f3eaa4a34753b8f31ddf73b81c", "message": "remaining todos", "committedDate": "2020-04-06T05:29:29Z", "type": "commit"}, {"oid": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "url": "https://github.com/Azure/azure-sdk-for-java/commit/661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "message": "checkstyle...", "committedDate": "2020-04-06T06:20:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMDUxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404210515", "bodyText": "This is scoped to package private shouldn't need deprecation.", "author": "alzimmermsft", "createdAt": "2020-04-06T16:06:30Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobAsyncClient.java", "diffHunk": "@@ -88,7 +88,12 @@\n      * value will be used.\n      */\n     public static final int BLOB_DEFAULT_HTBB_UPLOAD_BLOCK_SIZE = 8 * Constants.MB;\n+    /**\n+     * @deprecated Use {@link #BLOB_MAX_UPLOAD_BLOCK_SIZE_LONG}.\n+     */\n+    @Deprecated\n     static final int BLOB_MAX_UPLOAD_BLOCK_SIZE = 100 * Constants.MB;", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2NTc1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404265756", "bodyText": "done", "author": "kasobol-msft", "createdAt": "2020-04-06T17:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMDUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMzg1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404213854", "bodyText": "Shouldn't need Long.valueOf", "author": "alzimmermsft", "createdAt": "2020-04-06T16:11:06Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/implementation/util/ModelHelper.java", "diffHunk": "@@ -26,15 +26,18 @@\n      * @return An object with defaults filled in for null values in the original.\n      */\n     public static ParallelTransferOptions populateAndApplyDefaults(ParallelTransferOptions other) {\n-        other = other == null ? new ParallelTransferOptions(null, null, null) : other;\n-        return new ParallelTransferOptions(\n-            other.getBlockSize() == null ? Integer.valueOf(BlobAsyncClient.BLOB_DEFAULT_UPLOAD_BLOCK_SIZE)\n-                : other.getBlockSize(),\n-            other.getNumBuffers() == null ? Integer.valueOf(BlobAsyncClient.BLOB_DEFAULT_NUMBER_OF_BUFFERS)\n-                : other.getNumBuffers(),\n-            other.getProgressReceiver(),\n-            other.getMaxSingleUploadSize() == null ? Integer.valueOf(BlockBlobAsyncClient.MAX_UPLOAD_BLOB_BYTES)\n-                : other.getMaxSingleUploadSize());\n+        other = other == null ? new ParallelTransferOptions() : other;\n+        return new ParallelTransferOptions()\n+            .setBlockSize(other.getBlockSizeLong() == null\n+                ? Long.valueOf(BlobAsyncClient.BLOB_DEFAULT_UPLOAD_BLOCK_SIZE)", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2NjkxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404266910", "bodyText": "I did play with valueOf in ModelHelpers. After removing I got quite legit bug report.\n\nSo I ended up reworking this code little bit.", "author": "kasobol-msft", "createdAt": "2020-04-06T17:32:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMzg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNDAxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404214013", "bodyText": "Shouldn't need Integer.valueOf", "author": "alzimmermsft", "createdAt": "2020-04-06T16:11:21Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/implementation/util/ModelHelper.java", "diffHunk": "@@ -26,15 +26,18 @@\n      * @return An object with defaults filled in for null values in the original.\n      */\n     public static ParallelTransferOptions populateAndApplyDefaults(ParallelTransferOptions other) {\n-        other = other == null ? new ParallelTransferOptions(null, null, null) : other;\n-        return new ParallelTransferOptions(\n-            other.getBlockSize() == null ? Integer.valueOf(BlobAsyncClient.BLOB_DEFAULT_UPLOAD_BLOCK_SIZE)\n-                : other.getBlockSize(),\n-            other.getNumBuffers() == null ? Integer.valueOf(BlobAsyncClient.BLOB_DEFAULT_NUMBER_OF_BUFFERS)\n-                : other.getNumBuffers(),\n-            other.getProgressReceiver(),\n-            other.getMaxSingleUploadSize() == null ? Integer.valueOf(BlockBlobAsyncClient.MAX_UPLOAD_BLOB_BYTES)\n-                : other.getMaxSingleUploadSize());\n+        other = other == null ? new ParallelTransferOptions() : other;\n+        return new ParallelTransferOptions()\n+            .setBlockSize(other.getBlockSizeLong() == null\n+                ? Long.valueOf(BlobAsyncClient.BLOB_DEFAULT_UPLOAD_BLOCK_SIZE)\n+                : other.getBlockSizeLong())\n+            .setNumBuffers(other.getNumBuffers() == null\n+                ? Integer.valueOf(BlobAsyncClient.BLOB_DEFAULT_NUMBER_OF_BUFFERS)", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2NzA0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404267045", "bodyText": "reworked (see other comment)", "author": "kasobol-msft", "createdAt": "2020-04-06T17:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNDAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNDEzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404214138", "bodyText": "Shouldn't need Long.valueOf", "author": "alzimmermsft", "createdAt": "2020-04-06T16:11:33Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/implementation/util/ModelHelper.java", "diffHunk": "@@ -26,15 +26,18 @@\n      * @return An object with defaults filled in for null values in the original.\n      */\n     public static ParallelTransferOptions populateAndApplyDefaults(ParallelTransferOptions other) {\n-        other = other == null ? new ParallelTransferOptions(null, null, null) : other;\n-        return new ParallelTransferOptions(\n-            other.getBlockSize() == null ? Integer.valueOf(BlobAsyncClient.BLOB_DEFAULT_UPLOAD_BLOCK_SIZE)\n-                : other.getBlockSize(),\n-            other.getNumBuffers() == null ? Integer.valueOf(BlobAsyncClient.BLOB_DEFAULT_NUMBER_OF_BUFFERS)\n-                : other.getNumBuffers(),\n-            other.getProgressReceiver(),\n-            other.getMaxSingleUploadSize() == null ? Integer.valueOf(BlockBlobAsyncClient.MAX_UPLOAD_BLOB_BYTES)\n-                : other.getMaxSingleUploadSize());\n+        other = other == null ? new ParallelTransferOptions() : other;\n+        return new ParallelTransferOptions()\n+            .setBlockSize(other.getBlockSizeLong() == null\n+                ? Long.valueOf(BlobAsyncClient.BLOB_DEFAULT_UPLOAD_BLOCK_SIZE)\n+                : other.getBlockSizeLong())\n+            .setNumBuffers(other.getNumBuffers() == null\n+                ? Integer.valueOf(BlobAsyncClient.BLOB_DEFAULT_NUMBER_OF_BUFFERS)\n+                : other.getNumBuffers())\n+            .setProgressReceiver(other.getProgressReceiver())\n+            .setMaxSingleUploadSize(other.getMaxSingleUploadSizeLong() == null\n+                ? Long.valueOf(BlockBlobAsyncClient.MAX_UPLOAD_BLOB_BYTES_LONG)", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2NzEwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404267103", "bodyText": "reworked (see other comment)", "author": "kasobol-msft", "createdAt": "2020-04-06T17:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNDEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzNjI1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404236257", "bodyText": "Any reason this is no longer final?", "author": "alzimmermsft", "createdAt": "2020-04-06T16:44:02Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadBufferPool.java", "diffHunk": "@@ -37,23 +40,23 @@\n     queue will not compromise the async nature of this workflow. Fluxes themselves are internally synchronized to ensure\n     only one call to onNext happens at a time.\n      */\n-    private final BlockingQueue<ByteBuffer> buffers;\n+    private final BlockingQueue<BufferAggregator> buffers;\n \n     private final int maxBuffs;\n \n     // The number of buffs we have allocated. We can query the queue for how many are available.\n     private int numBuffs;\n \n-    private final int buffSize;\n+    private long buffSize;", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2NzMwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404267303", "bodyText": "my mistake. fixed.", "author": "kasobol-msft", "createdAt": "2020-04-06T17:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzNjI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0MTA0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404241041", "bodyText": "Package private, shouldn't require a deprecation", "author": "alzimmermsft", "createdAt": "2020-04-06T16:51:21Z", "path": "sdk/storage/azure-storage-file-datalake/src/main/java/com/azure/storage/file/datalake/DataLakeFileAsyncClient.java", "diffHunk": "@@ -76,8 +77,14 @@\n \n     /**\n      * Indicates the maximum number of bytes that can be sent in a call to upload.\n+     * @deprecated Use {@link #MAX_APPEND_FILE_BYTES_LONG}\n      */\n+    @Deprecated\n     static final int MAX_APPEND_FILE_BYTES = 100 * Constants.MB;", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2NzQwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404267400", "bodyText": "done.", "author": "kasobol-msft", "createdAt": "2020-04-06T17:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0MTA0MQ=="}], "type": "inlineReview"}, {"oid": "2fd30b4e394153dad519e7bc5d6076376117f88f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2fd30b4e394153dad519e7bc5d6076376117f88f", "message": "pr feedback", "committedDate": "2020-04-06T17:23:01Z", "type": "commit"}, {"oid": "9095a12723f9035885e4f35be58d4abd935ff632", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9095a12723f9035885e4f35be58d4abd935ff632", "message": "fix test", "committedDate": "2020-04-06T17:48:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MzUyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404283522", "bodyText": "I think there's a constant for GB that we could use here", "author": "gapra-msft", "createdAt": "2020-04-06T17:59:07Z", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobAsyncClient.java", "diffHunk": "@@ -71,7 +71,7 @@\n public class EncryptedBlobAsyncClient extends BlobAsyncClient {\n \n     static final int BLOB_DEFAULT_UPLOAD_BLOCK_SIZE = 4 * Constants.MB;\n-    private static final int BLOB_MAX_UPLOAD_BLOCK_SIZE = 100 * Constants.MB;\n+    private static final long BLOB_MAX_UPLOAD_BLOCK_SIZE = 4000L * Constants.MB;", "originalCommit": "9095a12723f9035885e4f35be58d4abd935ff632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4NDU4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404284580", "bodyText": "Problem is. Jumbo block is up to exactly 4000MB. 4GB is more than that.", "author": "kasobol-msft", "createdAt": "2020-04-06T18:00:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MzUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3NTQ0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404975444", "bodyText": "Oh I see", "author": "gapra-msft", "createdAt": "2020-04-07T17:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MzUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MzczNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404283736", "bodyText": "Can we make that 4GB", "author": "gapra-msft", "createdAt": "2020-04-06T17:59:29Z", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobAsyncClient.java", "diffHunk": "@@ -313,7 +313,7 @@\n      * @param tier {@link AccessTier} for the destination blob.\n      * @param requestConditions {@link BlobRequestConditions}\n      * @return An empty response\n-     * @throws IllegalArgumentException If {@code blockSize} is less than 0 or greater than 100MB\n+     * @throws IllegalArgumentException If {@code blockSize} is less than 0 or greater than 4000MB", "originalCommit": "9095a12723f9035885e4f35be58d4abd935ff632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4NDYyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404284625", "bodyText": "Problem is. Jumbo block is up to exactly 4000MB. 4GB is more than that.", "author": "kasobol-msft", "createdAt": "2020-04-06T18:00:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MzczNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2NzQyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404367425", "bodyText": "While our property must be Long to allow for a \"not set\" option, does our setter need to be? If a user is supplying a value, should we not assume it's non-null? If we use long then users can get auto-cast from int for free. However, if we believe users need to be able to set null then I suppose this isn't an option.", "author": "jaschrep-msft", "createdAt": "2020-04-06T20:27:59Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/models/ParallelTransferOptions.java", "diffHunk": "@@ -60,35 +68,54 @@ public ParallelTransferOptions(Integer blockSize, Integer numBuffers, ProgressRe\n      * any data is sent. Must be greater than 0. May be null to accept default behavior, which is the maximum value the\n      * service accepts for uploading in a single requests and is represented by\n      * {@link BlockBlobAsyncClient#MAX_UPLOAD_BLOB_BYTES}.\n+     * @deprecated Use fluent interface to set properties instead.\n      */\n+    @Deprecated\n     public ParallelTransferOptions(Integer blockSize, Integer numBuffers, ProgressReceiver progressReceiver,\n         Integer maxSingleUploadSize) {\n-        if (blockSize != null) {\n-            StorageImplUtils.assertInBounds(\"blockSize\", blockSize, 1, BlockBlobAsyncClient.MAX_STAGE_BLOCK_BYTES);\n-        }\n-        this.blockSize = blockSize;\n-\n-        if (numBuffers != null) {\n-            StorageImplUtils.assertInBounds(\"numBuffers\", numBuffers, 2, Integer.MAX_VALUE);\n-        }\n-        this.numBuffers = numBuffers;\n-        this.progressReceiver = progressReceiver;\n-\n-        if (maxSingleUploadSize != null) {\n-            StorageImplUtils.assertInBounds(\"maxSingleUploadSize\", maxSingleUploadSize, 1,\n-                BlockBlobAsyncClient.MAX_UPLOAD_BLOB_BYTES);\n-        }\n-        this.maxSingleUploadSize = maxSingleUploadSize;\n+        this.setBlockSize(blockSize == null ? null : Long.valueOf(blockSize));\n+        this.setNumBuffers(numBuffers);\n+        this.setProgressReceiver(progressReceiver);\n+        this.setMaxSingleUploadSize(maxSingleUploadSize == null ? null : Long.valueOf(maxSingleUploadSize));\n     }\n \n     /**\n      * Gets the block size (chunk size) to transfer at a time.\n      * @return The block size.\n+     * @deprecated Use {@link #getBlockSizeLong()}.\n      */\n+    @Deprecated\n     public Integer getBlockSize() {\n+        return this.blockSize == null ? null : Math.toIntExact(this.blockSize);\n+    }\n+\n+    /**\n+     * Gets the block size (chunk size) to transfer at a time.\n+     * @return The block size.\n+     */\n+    public Long getBlockSizeLong() {\n         return this.blockSize;\n     }\n \n+    /**\n+     * Sets the block size (chunk size) to transfer at a time.\n+     * For upload, The block size is the size of each block that will be staged. This value also determines the number\n+     * of requests that need to be made. If block size is large, upload will make fewer network calls, but each\n+     * individual call will send more data and will therefore take longer. This parameter also determines the size\n+     * that each buffer uses when buffering is required and consequently amount of memory consumed by such methods may\n+     * be up to blockSize * numBuffers.\n+     *\n+     * @param blockSize The block size.\n+     * @return The ParallelTransferOptions object itself.\n+     */\n+    public ParallelTransferOptions setBlockSize(Long blockSize) {", "originalCommit": "9095a12723f9035885e4f35be58d4abd935ff632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxNjgzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404416832", "bodyText": "In such case I'd rather add non-null validation - but since it's optional customer should be able to \"unset\" it - end of day it just became mutable data structure. If I were customer where this thing is result of some computation (weird but possible) then I'd be quite upset about the need of if/else-ing. Besides if some of them are actually passing Integer around that could be null for some reason then autoboxing will blow up on nulls if they don't else/if correctly.\nOther thing. Usually in classes like that I used to see symmetry between getter and setter - they usually speak same type. It'd be quite non-idiomatic in Java if we do otherwise.", "author": "kasobol-msft", "createdAt": "2020-04-06T22:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2NzQyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2OTI0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404369244", "bodyText": "What is this indicating?", "author": "jaschrep-msft", "createdAt": "2020-04-06T20:31:12Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/models/Block.java", "diffHunk": "@@ -25,7 +25,13 @@\n      * The block size in bytes.\n      */\n     @JsonProperty(value = \"Size\", required = true)\n-    private int size;\n+    private long sizeLong;\n+\n+    /*\n+     * The size property.\n+     */", "originalCommit": "9095a12723f9035885e4f35be58d4abd935ff632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODU4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404418583", "bodyText": "That's not harmful remnant of swagger generation. See swagger/readme.md change in this PR. In order to transition from int->long I had to generate two Java properties for same field in such a way that one is actually used by Jackson parser to deserialize incoming xml and other to assure backwards compatibility - then remove data binding annotations and body so that extra property doesn't take part in deserialization process.\nThis comment is remnant of this process. I didn't manage to invent right regex that could get rid of this yet. But I can try harder.", "author": "kasobol-msft", "createdAt": "2020-04-06T22:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2OTI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3NDAwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404474007", "bodyText": "removed..", "author": "kasobol-msft", "createdAt": "2020-04-07T00:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2OTI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3MzUwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404373502", "bodyText": "Can someone chime in on why this setter is here in the first place? I thought this was a return type only.", "author": "jaschrep-msft", "createdAt": "2020-04-06T20:38:59Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/models/Block.java", "diffHunk": "@@ -48,22 +54,44 @@ public Block setName(String name) {\n     }\n \n     /**\n-     * Get the size property: The block size in bytes.\n+     * Get the sizeLong property: The block size in bytes.\n+     *\n+     * @return the sizeLong value.\n+     */\n+    public long getSizeLong() {\n+        return this.sizeLong;\n+    }\n+\n+    /**\n+     * Set the sizeLong property: The block size in bytes.\n+     *\n+     * @param sizeLong the sizeLong value to set.\n+     * @return the Block object itself.\n+     */\n+    public Block setSizeLong(long sizeLong) {\n+        this.sizeLong = sizeLong;\n+        return this;\n+    }\n+\n+    /**\n+     * Get the size property: The size property.\n      *\n      * @return the size value.\n+     * @deprecated Use {@link #getSizeLong()}\n      */\n-    public int getSize() {\n-        return this.size;\n+    @Deprecated  public int getSize() {\n+        return (int) this.sizeLong;\n     }\n \n     /**\n-     * Set the size property: The block size in bytes.\n+     * Set the size property: The size property.\n      *\n      * @param size the size value to set.\n+     * @deprecated Use {@link #setSizeLong(long)}\n      * @return the Block object itself.\n      */\n-    public Block setSize(int size) {\n-        this.size = size;\n+    @Deprecated public Block setSize(int size) {\n+        this.sizeLong = size;\n         return this;\n     }", "originalCommit": "9095a12723f9035885e4f35be58d4abd935ff632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODY5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404418694", "bodyText": "I believe Jackson parser needs that to deserialize XML.", "author": "kasobol-msft", "createdAt": "2020-04-06T22:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3MzUwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3NzQ0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404377447", "bodyText": "Hard to see in this review but what is the meaning of the value being passed in? Does it make sense for the base class constructor to get overloaded (or edited) to long? Passing max value feels weird.", "author": "jaschrep-msft", "createdAt": "2020-04-06T20:46:29Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java", "diffHunk": "@@ -159,7 +159,7 @@ void commit() {\n         private BlockBlobOutputStream(final BlobAsyncClient client,\n             final ParallelTransferOptions parallelTransferOptions, final BlobHttpHeaders headers,\n             final Map<String, String> metadata, final AccessTier tier, final BlobRequestConditions requestConditions) {\n-            super(BlockBlobClient.MAX_STAGE_BLOCK_BYTES);\n+            super(Integer.MAX_VALUE);", "originalCommit": "9095a12723f9035885e4f35be58d4abd935ff632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQyNTQ0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404425443", "bodyText": "It ends up being used here https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/StorageOutputStream.java#L54 .\nAs far as I can tell from reading inheritance tree of StorageOutputStream - this can't be changed to long because of conversion to Flux of ByteBuffers - these are constrained by int capacity - these conversions happen in subtypes.\n@gapra-msft @rickle-msft  do you guys have any context behind previously chosen value?\nI think this could be set to Math.min(Integer.MAX_VALUE, parallelTransferOptions.getBlockSizeLong()) so that it would result in ByteBuffers already trimmed nice for staging blocks (for small blocks) and largest possible ByteBuffers for jumbo blocks.", "author": "kasobol-msft", "createdAt": "2020-04-06T22:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3NzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4Mzc5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404983799", "bodyText": "Actually, specifically for BlockBlobOutputStream, after my changes to make it write via buffered upload, this this.writeThreshold isn't used. If you look at BlockBlobOutputStream, writeInternal is overridden and dispatchWrite is never called (it just returns an empty mono). Could you just add a note about that if you don't mind?", "author": "gapra-msft", "createdAt": "2020-04-07T17:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3NzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4Mzk4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404983980", "bodyText": "Basically all the write Threshold logic is handled within buffered upload", "author": "gapra-msft", "createdAt": "2020-04-07T17:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3NzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMzI1OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r405023259", "bodyText": "added comment per our discussion.", "author": "kasobol-msft", "createdAt": "2020-04-07T18:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3NzQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3ODYzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404378632", "bodyText": "Do we want to up these values to max int? I know they're deprecated but there's still a lot of room between 256MB and max int that customers can use if they want and their clamping logic would be misinformed from this.", "author": "jaschrep-msft", "createdAt": "2020-04-06T20:48:44Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlockBlobAsyncClient.java", "diffHunk": "@@ -58,14 +58,28 @@\n \n     /**\n      * Indicates the maximum number of bytes that can be sent in a call to upload.\n+     * @deprecated Use {@link #MAX_STAGE_BLOCK_BYTES_LONG}\n      */\n+    @Deprecated\n     public static final int MAX_UPLOAD_BLOB_BYTES = 256 * Constants.MB;", "originalCommit": "9095a12723f9035885e4f35be58d4abd935ff632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQyNzEyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404427127", "bodyText": "That's a good idea. However I'd rather do that only for blocks in this PR. Bumping single upload threshold deserve own PR and testing.", "author": "kasobol-msft", "createdAt": "2020-04-06T22:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3ODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5OTY4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404999687", "bodyText": "Sadly. Looks like it would be considered as breaking change.\n[ERROR] java.field.constantValueChanged: field com.azure.storage.blob.specialized.BlockBlobAsyncClient.MAX_STAGE_BLOCK_BYTES: Constant field changed value from '104857600' to '2147483647'. (breaks semantic versioning)\n[ERROR] java.field.constantValueChanged: field com.azure.storage.blob.specialized.BlockBlobClient.MAX_STAGE_BLOCK_BYTES: Constant field changed value from '104857600' to '2147483647'. (breaks semantic versioning)\n[ERROR]\n[ERROR] Consult the plugin output above for suggestions on how to ignore the found problems.```", "author": "kasobol-msft", "createdAt": "2020-04-07T17:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3ODYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NjcwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404396705", "bodyText": "Can we say 4GB?", "author": "rickle-msft", "createdAt": "2020-04-06T21:22:57Z", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobAsyncClient.java", "diffHunk": "@@ -313,7 +313,7 @@\n      * @param tier {@link AccessTier} for the destination blob.\n      * @param requestConditions {@link BlobRequestConditions}\n      * @return An empty response\n-     * @throws IllegalArgumentException If {@code blockSize} is less than 0 or greater than 100MB\n+     * @throws IllegalArgumentException If {@code blockSize} is less than 0 or greater than 4000MB", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1Njk4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404456982", "bodyText": "That has been already asked. Problem is. Jumbo block is up to exactly 4000MB. 4GB is more than that.", "author": "kasobol-msft", "createdAt": "2020-04-06T23:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NjcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzI2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404397267", "bodyText": "Should this be 4 * 1024 * MB? And should we just make it 4 * GB?", "author": "rickle-msft", "createdAt": "2020-04-06T21:23:55Z", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobAsyncClient.java", "diffHunk": "@@ -71,7 +71,7 @@\n public class EncryptedBlobAsyncClient extends BlobAsyncClient {\n \n     static final int BLOB_DEFAULT_UPLOAD_BLOCK_SIZE = 4 * Constants.MB;\n-    private static final int BLOB_MAX_UPLOAD_BLOCK_SIZE = 100 * Constants.MB;\n+    private static final long BLOB_MAX_UPLOAD_BLOCK_SIZE = 4000L * Constants.MB;", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1Njc0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404456749", "bodyText": "It is actually 4000MB and not 4096MB.", "author": "jaschrep-msft", "createdAt": "2020-04-06T23:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1NzE2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404457160", "bodyText": "Jumbo block is up to exactly 4000MB.", "author": "kasobol-msft", "createdAt": "2020-04-06T23:55:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwMTg5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404401898", "bodyText": "Oh thanks :) Definitely wasn't expecting you to update nio", "author": "rickle-msft", "createdAt": "2020-04-06T21:33:18Z", "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureFileSystem.java", "diffHunk": "@@ -142,7 +142,12 @@\n         // Read configurations and build client.\n         try {\n             this.blobServiceClient = this.buildBlobServiceClient(accountName, config);\n-            this.blockSize = (Integer) config.get(AZURE_STORAGE_UPLOAD_BLOCK_SIZE);\n+            Object blockSize = config.get(AZURE_STORAGE_UPLOAD_BLOCK_SIZE);\n+            if (blockSize instanceof Integer) {", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODQxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404418410", "bodyText": "This is floating a little oddly. Did this come out of the generator?", "author": "rickle-msft", "createdAt": "2020-04-06T22:08:56Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/models/Block.java", "diffHunk": "@@ -25,7 +25,13 @@\n      * The block size in bytes.\n      */\n     @JsonProperty(value = \"Size\", required = true)\n-    private int size;\n+    private long sizeLong;\n+\n+    /*\n+     * The size property.", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1NzYzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404457634", "bodyText": "Yes. I had to generate two bend generator to produce two properties out of one and then string.replace some parts of the code. See swagger/readme.md change in this PR.\nI didn't find good regex to get rid of this thing yet.", "author": "kasobol-msft", "createdAt": "2020-04-06T23:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3Mzg2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404473868", "bodyText": "fixed", "author": "kasobol-msft", "createdAt": "2020-04-07T00:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxOTgyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404419820", "bodyText": "Why did we switch to max long?", "author": "rickle-msft", "createdAt": "2020-04-06T22:12:20Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobOutputStream.java", "diffHunk": "@@ -159,7 +159,7 @@ void commit() {\n         private BlockBlobOutputStream(final BlobAsyncClient client,\n             final ParallelTransferOptions parallelTransferOptions, final BlobHttpHeaders headers,\n             final Map<String, String> metadata, final AccessTier tier, final BlobRequestConditions requestConditions) {\n-            super(BlockBlobClient.MAX_STAGE_BLOCK_BYTES);\n+            super(Integer.MAX_VALUE);", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1ODAyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404458029", "bodyText": "I left long comment on @jaschrep-msft  comment above and tagged you as there's a question. Could you please reply there?", "author": "kasobol-msft", "createdAt": "2020-04-06T23:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxOTgyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMjgzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r405022838", "bodyText": "added comment after offline discussion. This value has no real meaning for blockbloboutputstream.", "author": "kasobol-msft", "createdAt": "2020-04-07T18:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxOTgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MTU3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404451570", "bodyText": "Can you add some comments here describing the behavior:\nThe gate will only start emitting data after the threshold has been breached once it has been flushed. Checking the state of the threshold on receiving the first buffer means we can infer what upload operation we should do.", "author": "rickle-msft", "createdAt": "2020-04-06T23:38:07Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java", "diffHunk": "@@ -39,72 +37,25 @@\n         ParallelTransferOptions parallelTransferOptions,\n         final Function<Flux<ByteBuffer>, Mono<Response<T>>> uploadInChunks,\n         final BiFunction<Flux<ByteBuffer>, Long, Mono<Response<T>>> uploadFull) {\n-        final long[] bufferedDataSize = {0};\n-        final LinkedList<ByteBuffer> cachedBuffers = new LinkedList<>();\n \n-        /*\n-         * Window the reactive stream until either the stream completes or the windowing size is hit. If the window\n-         * size is hit the next emission will be the pointer to the rest of the reactive steam.\n-         *\n-         * Once the windowing has completed buffer the two streams, this should create a maximum overhead of ~4MB plus\n-         * the next stream emission if the window size was hit. If there are two streams buffered use Stage Blocks and\n-         * Put Block List as the upload mechanism otherwise use Put Blob.\n-         */\n+        PayloadSizeGate gate = new PayloadSizeGate(parallelTransferOptions.getMaxSingleUploadSizeLong());\n+\n         return data\n             .filter(ByteBuffer::hasRemaining)\n-            .windowUntil(buffer -> {\n-                if (bufferedDataSize[0] > parallelTransferOptions.getMaxSingleUploadSize()) {\n-                    return false;\n+            .concatMap(gate::write)", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMjI1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r405022250", "bodyText": "added comments", "author": "kasobol-msft", "createdAt": "2020-04-07T18:26:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MTU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MTgxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r404451813", "bodyText": "I think you can delete this line as there's no concept of returning buffers here.", "author": "rickle-msft", "createdAt": "2020-04-06T23:38:47Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/PayloadSizeGate.java", "diffHunk": "@@ -0,0 +1,99 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.common.implementation;\n+\n+import reactor.core.publisher.Flux;\n+\n+import java.nio.ByteBuffer;\n+import java.util.LinkedList;\n+import java.util.Queue;\n+\n+/**\n+ * This class provides ability to measure if incoming Flux of ByteBuffers is larger than a threshold.\n+ * This answers question if volume of data in bytes is larger than threshold.\n+ *\n+ * The {@link #write(ByteBuffer)} operation buffers incoming ByteBuffers until threshold is crossed.\n+ * After that it's pass-through as fact that data volume exceeds threshold is already determined.\n+ *\n+ * It is incumbent upon the caller to return the buffers after measurement is completed. It is also the caller's", "originalCommit": "661a25d42c71e0bf76f92470b3e81cbc89dc1b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMjA5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9649#discussion_r405022092", "bodyText": "deleted", "author": "kasobol-msft", "createdAt": "2020-04-07T18:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MTgxMw=="}], "type": "inlineReview"}, {"oid": "1d6cd684fc2c22dc4ab5712073178e8774198631", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1d6cd684fc2c22dc4ab5712073178e8774198631", "message": "tweak size property generation", "committedDate": "2020-04-07T00:50:45Z", "type": "commit"}, {"oid": "1bf94f704f70b766284f93e6b403bc889a4947dd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1bf94f704f70b766284f93e6b403bc889a4947dd", "message": "Pr feedback.", "committedDate": "2020-04-07T17:50:47Z", "type": "commit"}, {"oid": "cf8d347133bb6497b07b034a7998dc8437cc064e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cf8d347133bb6497b07b034a7998dc8437cc064e", "message": "API review feedback.", "committedDate": "2020-04-09T17:28:42Z", "type": "commit"}, {"oid": "93c1eaede50a05ccb5f35fd6a42a5f35b0432373", "url": "https://github.com/Azure/azure-sdk-for-java/commit/93c1eaede50a05ccb5f35fd6a42a5f35b0432373", "message": "API View feedback.", "committedDate": "2020-04-09T17:35:23Z", "type": "commit"}, {"oid": "b82086497d93fb12e822e41afe463ff472fbd53d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b82086497d93fb12e822e41afe463ff472fbd53d", "message": "Merge remote-tracking branch 'upstream/feature/storage/stg73' into feature/storage/jumbo-blob", "committedDate": "2020-04-09T20:55:38Z", "type": "commit"}]}