{"pr_number": 14237, "pr_title": "Add user agent info to ADT client, miscellaneous builder improvements", "pr_createdAt": "2020-08-18T21:45:04Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14237", "timeline": [{"oid": "58b15d0987920f5c01683b66d661f77f2289cf79", "url": "https://github.com/Azure/azure-sdk-for-java/commit/58b15d0987920f5c01683b66d661f77f2289cf79", "message": "Add user agent info to ADT client, miscellaneous builder improvements\n\nUser agent looks like: \"User-Agent=azsdk-java-azure-digitaltwins-core/1.0.0-beta.1 (1.8.0_201; Windows 10; 10.0)\" when run from a windows 10 machine", "committedDate": "2020-08-18T21:44:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMTU5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472511599", "bodyText": "This works in the sync client, but not in the async client. We'll still need the java autorest team to fix their bug so that the protocol layer actually returns the expected type", "author": "timtay-microsoft", "createdAt": "2020-08-18T21:46:15Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClient.java", "diffHunk": "@@ -53,7 +54,7 @@ public DigitalTwinsServiceVersion getServiceVersion() {\n     // this annotation lets users know this method makes a call to the service and whether it returns a single resource or a collection of resources\n     @ServiceMethod(returns = ReturnType.SINGLE)\n     // TODO This is just a temporary implementation for test purposes. This should be spruced up/replaced once this API is actually designed\n-    public DigitalTwinsGetByIdResponse getDigitalTwin(String digitalTwinId) {\n+    public Response<Object> getDigitalTwin(String digitalTwinId) {", "originalCommit": "58b15d0987920f5c01683b66d661f77f2289cf79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU2MzI0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472563243", "bodyText": "I may have missed it but what and why does it not work for async?", "author": "bikamani", "createdAt": "2020-08-19T00:18:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMTU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjI3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472512276", "bodyText": "Adding these explicitly even though they are default values so that if/when we add support for retry-after headers, it is easy to figure out that the Azure Core RetryPolicy class handles that for us as long as we tell it what our service sends as the header name and time unit", "author": "timtay-microsoft", "createdAt": "2020-08-18T21:47:43Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);", "originalCommit": "58b15d0987920f5c01683b66d661f77f2289cf79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzMTUyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473231527", "bodyText": "Doesn't RetryPolicy have null check for these values? Does it inform the calling application that it is using default values since null was supplied, or does it silently make the switch?", "author": "abhipsaMisra", "createdAt": "2020-08-19T18:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjQyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472512426", "bodyText": "Adding a default constructor so that we don't forget it exists, and also to assign some default values", "author": "timtay-microsoft", "createdAt": "2020-08-18T21:48:06Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);\n+\n+    private final Map<String, String> properties;\n+\n+    private Configuration configuration;\n+\n+    public DigitalTwinsClientBuilder()", "originalCommit": "58b15d0987920f5c01683b66d661f77f2289cf79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjcxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472512715", "bodyText": "These values come from azure-digital-twins.properties file that is added in this PR", "author": "timtay-microsoft", "createdAt": "2020-08-18T21:48:45Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);\n+\n+    private final Map<String, String> properties;\n+\n+    private Configuration configuration;\n+\n+    public DigitalTwinsClientBuilder()\n+    {\n+        additionalPolicies = new ArrayList<>();\n+        properties = CoreUtils.getProperties(DIGITAL_TWINS_PROPERTIES);\n+        httpLogOptions = new HttpLogOptions();\n+    }\n \n     private static HttpPipeline buildPipeline(TokenCredential tokenCredential, String endpoint,\n-                                              HttpLogOptions logOptions, HttpClient httpClient,\n-                                              List<HttpPipelinePolicy> additionalPolicies, RetryPolicy retryPolicy) {\n+                                              HttpLogOptions httpLogOptions, HttpClient httpClient,\n+                                              List<HttpPipelinePolicy> additionalPolicies, HttpPipelinePolicy retryPolicy,\n+                                              Configuration configuration, Map<String, String> properties) {\n         // Closest to API goes first, closest to wire goes last.\n         List<HttpPipelinePolicy> policies = new ArrayList<>();\n \n+        String clientName = properties.getOrDefault(SDK_NAME, \"UnknownName\");\n+        String clientVersion = properties.getOrDefault(SDK_VERSION, \"UnknownVersion\");", "originalCommit": "58b15d0987920f5c01683b66d661f77f2289cf79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6b54312f49d12decfa2b84ebd72dd529ef5845f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d6b54312f49d12decfa2b84ebd72dd529ef5845f", "message": "squash", "committedDate": "2020-08-18T21:49:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMzQ0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472513445", "bodyText": "In the configurations client code, their builder never overwrites the values of the instance variables in the builder. Instead it creates local copies that can be altered instead", "author": "timtay-microsoft", "createdAt": "2020-08-18T21:50:20Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -106,21 +139,39 @@ public DigitalTwinsAsyncClient buildAsyncClient() {\n         Objects.requireNonNull(tokenCredential, \"'tokenCredential' cannot be null.\");\n         Objects.requireNonNull(endpoint, \"'endpoint' cannot be null\");\n \n+        Configuration buildConfiguration = this.configuration;\n+        if (buildConfiguration == null)\n+        {\n+            buildConfiguration = Configuration.getGlobalConfiguration().clone();\n+        }", "originalCommit": "d6b54312f49d12decfa2b84ebd72dd529ef5845f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNjgwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473236806", "bodyText": "Do we know why? Is this more efficient, or is it the defined process?", "author": "abhipsaMisra", "createdAt": "2020-08-19T18:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMzQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxNTQyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472515425", "bodyText": "Used for user agent string, and other functionality. See here", "author": "timtay-microsoft", "createdAt": "2020-08-18T21:54:55Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);\n+\n+    private final Map<String, String> properties;\n+\n+    private Configuration configuration;", "originalCommit": "d6b54312f49d12decfa2b84ebd72dd529ef5845f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "19271b6d12aedd9d22e03eaf7235303e89bfaafd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/19271b6d12aedd9d22e03eaf7235303e89bfaafd", "message": "squash", "committedDate": "2020-08-18T22:20:44Z", "type": "commit"}, {"oid": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6af2a33e6bfbbbac306e1d727194a6f9f60ea278", "message": "squash", "committedDate": "2020-08-18T23:44:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNjcwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473216702", "bodyText": "Call it 'client library'. I have heard that feedback from the SDK architects.", "author": "vinagesh", "createdAt": "2020-08-19T17:51:05Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string", "originalCommit": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxOTIyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473219226", "bodyText": "I'm not a java expert but why was 'this' removed?", "author": "vinagesh", "createdAt": "2020-08-19T17:55:17Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -106,21 +139,39 @@ public DigitalTwinsAsyncClient buildAsyncClient() {\n         Objects.requireNonNull(tokenCredential, \"'tokenCredential' cannot be null.\");\n         Objects.requireNonNull(endpoint, \"'endpoint' cannot be null\");\n \n+        Configuration buildConfiguration = this.configuration;\n+        if (buildConfiguration == null)\n+        {\n+            buildConfiguration = Configuration.getGlobalConfiguration().clone();\n+        }\n+\n         // Set defaults for these fields if they were not set while building the client\n-        this.serviceVersion = this.serviceVersion != null ? this.serviceVersion : DigitalTwinsServiceVersion.getLatest();\n-        this.retryPolicy = this.retryPolicy != null ? this.retryPolicy : new RetryPolicy(); // Default is exponential backoff\n+        DigitalTwinsServiceVersion serviceVersion = this.serviceVersion;\n+        if (serviceVersion == null)\n+        {\n+            serviceVersion = DigitalTwinsServiceVersion.getLatest();\n+        }\n+\n+        // Default is exponential backoff\n+        HttpPipelinePolicy retryPolicy = this.retryPolicy;\n+        if (retryPolicy == null)\n+        {\n+            retryPolicy = DEFAULT_RETRY_POLICY;\n+        }\n \n         if (this.httpPipeline == null) {\n             this.httpPipeline = buildPipeline(\n                 this.tokenCredential,\n                 this.endpoint,\n-                this.logOptions,\n+                this.httpLogOptions,\n                 this.httpClient,\n                 this.additionalPolicies,\n-                this.retryPolicy);\n+                retryPolicy,\n+                buildConfiguration,\n+                this.properties);\n         }\n \n-        return new DigitalTwinsAsyncClient(this.httpPipeline, this.serviceVersion, this.endpoint);\n+        return new DigitalTwinsAsyncClient(this.httpPipeline, serviceVersion, this.endpoint);", "originalCommit": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyNDY4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473224682", "bodyText": "In this case, removing the \"this.\" means that I wanted to use the locally defined variable here instead of the instance variable. I've seen this pattern in the builders in track 2 where you don't assign the default value to the instance variables when building the pipeline. Instead, you create a local variable and assign its value to the default if the user never set the instance variable's value", "author": "timtay-microsoft", "createdAt": "2020-08-19T18:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxOTIyNg=="}], "type": "inlineReview"}, {"oid": "aefdb18f3b5dad6baa612c7525ed17cfa7424835", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aefdb18f3b5dad6baa612c7525ed17cfa7424835", "message": "squash", "committedDate": "2020-08-19T18:05:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzMjkxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473232915", "bodyText": "\ud83d\udc4d", "author": "abhipsaMisra", "createdAt": "2020-08-19T18:20:14Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the client library's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);\n+\n+    private final Map<String, String> properties;\n+\n+    private Configuration configuration;\n+\n+    public DigitalTwinsClientBuilder()\n+    {\n+        additionalPolicies = new ArrayList<>();\n+        properties = CoreUtils.getProperties(DIGITAL_TWINS_PROPERTIES);\n+        httpLogOptions = new HttpLogOptions();\n+    }\n \n     private static HttpPipeline buildPipeline(TokenCredential tokenCredential, String endpoint,\n-                                              HttpLogOptions logOptions, HttpClient httpClient,\n-                                              List<HttpPipelinePolicy> additionalPolicies, RetryPolicy retryPolicy) {\n+                                              HttpLogOptions httpLogOptions, HttpClient httpClient,\n+                                              List<HttpPipelinePolicy> additionalPolicies, HttpPipelinePolicy retryPolicy,\n+                                              Configuration configuration, Map<String, String> properties) {\n         // Closest to API goes first, closest to wire goes last.\n         List<HttpPipelinePolicy> policies = new ArrayList<>();\n \n+        String clientName = properties.getOrDefault(SDK_NAME, \"UnknownName\");\n+        String clientVersion = properties.getOrDefault(SDK_VERSION, \"UnknownVersion\");\n+\n+        policies.add(new UserAgentPolicy(httpLogOptions.getApplicationId(), clientName, clientVersion, configuration));\n+\n         // Adds a \"x-ms-client-request-id\" header to each request. This header is useful for tracing requests through Azure ecosystems\n         policies.add(new RequestIdPolicy());\n \n-        // Only the RequestIdPolicy will take effect prior to the retry policy\n+        // Only the RequestIdPolicy  and UserAgentPolicy will take effect prior to the retry policy since neither of those need\n+        // to change in any way upon retry", "originalCommit": "aefdb18f3b5dad6baa612c7525ed17cfa7424835", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNjMyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473236323", "bodyText": "Q - do we know if AddDatePolicy updates the date per retry attempt, or it updates the date for each http request made?", "author": "abhipsaMisra", "createdAt": "2020-08-19T18:26:41Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -67,10 +98,12 @@ private static HttpPipeline buildPipeline(TokenCredential tokenCredential, Strin\n \n         policies.addAll(additionalPolicies);\n \n-        // Custom policies, authentication policy, and add date policy all take place after the retry policy\n+        // Custom policies, authentication policy, and add date policy all take place after the retry policy which means\n+        // they will be applied once per retry. For instance, the AddDatePolicy will add a different date time header\n+        // each time the retry is attempted.", "originalCommit": "aefdb18f3b5dad6baa612c7525ed17cfa7424835", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNjc2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473236762", "bodyText": "Since that policy is applied after the retry policy, each retry message will have a date time header that fits when the retry attempt occurred", "author": "timtay-microsoft", "createdAt": "2020-08-19T18:27:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNjMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MDUxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473240512", "bodyText": "I am not sure if I understand this correctly:\n\nA client is created, date policy is set.\nMake http request (1) with this client -> current date is added to the request - request is a success.\nMake http request (2) with this client -> current date is added to the request - request fails -> retry kicks in -> new http request (3) is made.\n\nSince the current date is sent with request (1), (2) and (3), how does retry matter here?\nOr am I missing something?\nFor auth, I can understand, that the next time retrt happens, you also want the auth credentials to be refreshed; but I cannot understand why date policy is relevant with retry.", "author": "abhipsaMisra", "createdAt": "2020-08-19T18:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNjMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI1NDE3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473254174", "bodyText": "We discussed this offline, and I'm putting up another PR to address my confusing wording of this #14283", "author": "timtay-microsoft", "createdAt": "2020-08-19T19:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNjMyMw=="}], "type": "inlineReview"}]}