{"pr_number": 16032, "pr_title": "Handling SslException on channel close", "pr_createdAt": "2020-10-07T10:01:01Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16032", "timeline": [{"oid": "601b52f75647568e4c1c970ef52cd3137806a54d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/601b52f75647568e4c1c970ef52cd3137806a54d", "message": "Handling SslException on channel close", "committedDate": "2020-10-07T09:57:58Z", "type": "commit"}, {"oid": "607876341015bd80e85d1cd388de743a0f48a774", "url": "https://github.com/Azure/azure-sdk-for-java/commit/607876341015bd80e85d1cd388de743a0f48a774", "message": "Added SpotBug exception", "committedDate": "2020-10-07T13:31:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwNjkyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16032#discussion_r501106923", "bodyText": "Do similar happen for reactor http code paths also?", "author": "kirankumarkolli", "createdAt": "2020-10-07T15:29:42Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -391,10 +392,30 @@ public void close(final ChannelHandlerContext context, final ChannelPromise prom\n         final SslHandler sslHandler = context.pipeline().get(SslHandler.class);\n \n         if (sslHandler != null) {\n-            // Netty 4.1.36.Final: SslHandler.closeOutbound must be called before closing the pipeline\n-            // This ensures that all SSL engine and ByteBuf resources are released\n-            // This is something that does not occur in the call to ChannelPipeline.close that follows\n-            sslHandler.closeOutbound();\n+\n+            try {\n+                // Netty 4.1.36.Final: SslHandler.closeOutbound must be called before closing the pipeline\n+                // This ensures that all SSL engine and ByteBuf resources are released\n+                // This is something that does not occur in the call to ChannelPipeline.close that follows\n+                sslHandler.closeOutbound();\n+            } catch (Exception exception) {\n+\n+                // Netty will throw the following exception here if the outbound SSL connection has been closed already\n+                // javax.net.ssl.SSLException: SSLEngine closed already\n+                // Reducing the noise level here because multiple concurrent closes can happen due to race conditions\n+                // and there is no harm in this case\n+                if (exception instanceof SSLException) {", "originalCommit": "607876341015bd80e85d1cd388de743a0f48a774", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExMDA5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16032#discussion_r501110097", "bodyText": "For ReactorNettyClient Kushagra had some discussions with the owner of ReatorNettyClient - reactor/reactor-netty#1165\nMy understanding reading through the work item is that this addressed the issues - but I will double-check with @kushagraThapar  when he is back next week", "author": "FabianMeiswinkel", "createdAt": "2020-10-07T15:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwNjkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE0NTQ5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16032#discussion_r501145494", "bodyText": "you don't need \"{}\" for exception and also exception.toString not needed here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    exception.toString());\n          \n          \n            \n            logger.debug(\"SslException when attempting to close the outbound SSL connection\", exception);", "author": "moderakh", "createdAt": "2020-10-07T16:23:20Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -391,10 +392,30 @@ public void close(final ChannelHandlerContext context, final ChannelPromise prom\n         final SslHandler sslHandler = context.pipeline().get(SslHandler.class);\n \n         if (sslHandler != null) {\n-            // Netty 4.1.36.Final: SslHandler.closeOutbound must be called before closing the pipeline\n-            // This ensures that all SSL engine and ByteBuf resources are released\n-            // This is something that does not occur in the call to ChannelPipeline.close that follows\n-            sslHandler.closeOutbound();\n+\n+            try {\n+                // Netty 4.1.36.Final: SslHandler.closeOutbound must be called before closing the pipeline\n+                // This ensures that all SSL engine and ByteBuf resources are released\n+                // This is something that does not occur in the call to ChannelPipeline.close that follows\n+                sslHandler.closeOutbound();\n+            } catch (Exception exception) {\n+\n+                // Netty will throw the following exception here if the outbound SSL connection has been closed already\n+                // javax.net.ssl.SSLException: SSLEngine closed already\n+                // Reducing the noise level here because multiple concurrent closes can happen due to race conditions\n+                // and there is no harm in this case\n+                if (exception instanceof SSLException) {\n+                    logger.debug(\n+                        \"SslException when attempting to close the outbound SSL connection: {}\",\n+                        exception.toString());", "originalCommit": "607876341015bd80e85d1cd388de743a0f48a774", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI5ODIyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16032#discussion_r501298227", "bodyText": "Fixed", "author": "FabianMeiswinkel", "createdAt": "2020-10-07T20:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE0NTQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE0NTUzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16032#discussion_r501145532", "bodyText": "ditto.", "author": "moderakh", "createdAt": "2020-10-07T16:23:24Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -391,10 +392,30 @@ public void close(final ChannelHandlerContext context, final ChannelPromise prom\n         final SslHandler sslHandler = context.pipeline().get(SslHandler.class);\n \n         if (sslHandler != null) {\n-            // Netty 4.1.36.Final: SslHandler.closeOutbound must be called before closing the pipeline\n-            // This ensures that all SSL engine and ByteBuf resources are released\n-            // This is something that does not occur in the call to ChannelPipeline.close that follows\n-            sslHandler.closeOutbound();\n+\n+            try {\n+                // Netty 4.1.36.Final: SslHandler.closeOutbound must be called before closing the pipeline\n+                // This ensures that all SSL engine and ByteBuf resources are released\n+                // This is something that does not occur in the call to ChannelPipeline.close that follows\n+                sslHandler.closeOutbound();\n+            } catch (Exception exception) {\n+\n+                // Netty will throw the following exception here if the outbound SSL connection has been closed already\n+                // javax.net.ssl.SSLException: SSLEngine closed already\n+                // Reducing the noise level here because multiple concurrent closes can happen due to race conditions\n+                // and there is no harm in this case\n+                if (exception instanceof SSLException) {\n+                    logger.debug(\n+                        \"SslException when attempting to close the outbound SSL connection: {}\",\n+                        exception.toString());\n+                } else {\n+                    logger.warn(\n+                        \"Exception when attempting to close the outbound SSL connection: {}\",\n+                        exception.toString());", "originalCommit": "607876341015bd80e85d1cd388de743a0f48a774", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI5ODM3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16032#discussion_r501298377", "bodyText": "Fixed", "author": "FabianMeiswinkel", "createdAt": "2020-10-07T20:44:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE0NTUzMg=="}], "type": "inlineReview"}, {"oid": "9e60545f9e505c1fb339066582ce606170588bed", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e60545f9e505c1fb339066582ce606170588bed", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/RntbRequestManagerCloseExceptionHandling", "committedDate": "2020-10-07T20:42:48Z", "type": "commit"}, {"oid": "e356abd4a7d197fcef6a93c2757a282f4fd69f67", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e356abd4a7d197fcef6a93c2757a282f4fd69f67", "message": "Fxing logging of exceptions", "committedDate": "2020-10-07T20:44:40Z", "type": "commit"}]}