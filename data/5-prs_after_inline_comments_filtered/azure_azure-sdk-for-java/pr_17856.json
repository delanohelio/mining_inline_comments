{"pr_number": 17856, "pr_title": "Add simulate user login behavior test", "pr_createdAt": "2020-11-27T07:05:52Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17856", "timeline": [{"oid": "963bb61e8d787f1df4c4ecb95825747cfc388e1c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/963bb61e8d787f1df4c4ecb95825747cfc388e1c", "message": "Add simulate user login behavior test", "committedDate": "2020-11-27T06:55:17Z", "type": "commit"}, {"oid": "3296d08ade893509231871d1d49aa219afdf87b8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3296d08ade893509231871d1d49aa219afdf87b8", "message": "Add simulate user login behavior test", "committedDate": "2020-11-27T07:04:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNDg2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532304866", "bodyText": "Add\nelse {\n    throw new IllegalStateException(\"Can not recognize osName. osName = \" + osName);\n}", "author": "chenrujun", "createdAt": "2020-11-30T01:34:51Z", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/login/AADLoginIT.java", "diffHunk": "@@ -0,0 +1,128 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.test.aad.login;\n+\n+import com.azure.test.utils.AppRunner;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.Keys;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.chrome.ChromeDriver;\n+import org.openqa.selenium.chrome.ChromeDriverService;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;\n+import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;\n+import org.springframework.security.oauth2.core.oidc.user.OidcUser;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.util.function.Consumer;\n+import java.util.regex.Pattern;\n+\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_ID;\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_SECRET;\n+import static com.azure.test.oauth.OAuthUtils.AAD_TENANT_ID_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_NAME_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_PASSWORD_1;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+\n+public class AADLoginIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADLoginIT.class);\n+\n+    static {\n+        final String chromedriverLinux = \"src/test/resources/driver/chromedriver_linux64\";\n+        final String chromedriverWin32 = \"src/test/resources/driver/chromedriver_win32.exe\";\n+        final String chromedriverMac = \"src/test/resources/driver/chromedriver_mac64\";\n+        String osName = System.getProperty(\"os.name\").toLowerCase();\n+        if (Pattern.matches(\"linux.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverLinux);\n+        } else if (Pattern.matches(\"windows.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverWin32);\n+        } else if (Pattern.matches(\"mac.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverMac);\n+        }", "originalCommit": "3296d08ade893509231871d1d49aa219afdf87b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNDkzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532304931", "bodyText": "When can we enable it?", "author": "chenrujun", "createdAt": "2020-11-30T01:35:09Z", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/login/AADLoginIT.java", "diffHunk": "@@ -0,0 +1,128 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.test.aad.login;\n+\n+import com.azure.test.utils.AppRunner;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.Keys;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.chrome.ChromeDriver;\n+import org.openqa.selenium.chrome.ChromeDriverService;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;\n+import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;\n+import org.springframework.security.oauth2.core.oidc.user.OidcUser;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.util.function.Consumer;\n+import java.util.regex.Pattern;\n+\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_ID;\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_SECRET;\n+import static com.azure.test.oauth.OAuthUtils.AAD_TENANT_ID_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_NAME_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_PASSWORD_1;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+\n+public class AADLoginIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADLoginIT.class);\n+\n+    static {\n+        final String chromedriverLinux = \"src/test/resources/driver/chromedriver_linux64\";\n+        final String chromedriverWin32 = \"src/test/resources/driver/chromedriver_win32.exe\";\n+        final String chromedriverMac = \"src/test/resources/driver/chromedriver_mac64\";\n+        String osName = System.getProperty(\"os.name\").toLowerCase();\n+        if (Pattern.matches(\"linux.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverLinux);\n+        } else if (Pattern.matches(\"windows.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverWin32);\n+        } else if (Pattern.matches(\"mac.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverMac);\n+        }\n+    }\n+\n+//    @Test", "originalCommit": "3296d08ade893509231871d1d49aa219afdf87b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNzQzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532307434", "bodyText": "When you delete the application.properties", "author": "lu-cheng", "createdAt": "2020-11-30T01:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNDkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwODIwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532308203", "bodyText": "Already deleted in latest master branch. Please merge latest master branch to your branch. \ud83d\ude4f", "author": "chenrujun", "createdAt": "2020-11-30T01:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNDkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNTMzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532305339", "bodyText": "Use variable instead of String.", "author": "chenrujun", "createdAt": "2020-11-30T01:37:06Z", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/login/AADLoginIT.java", "diffHunk": "@@ -0,0 +1,128 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.test.aad.login;\n+\n+import com.azure.test.utils.AppRunner;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.Keys;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.chrome.ChromeDriver;\n+import org.openqa.selenium.chrome.ChromeDriverService;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;\n+import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;\n+import org.springframework.security.oauth2.core.oidc.user.OidcUser;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.util.function.Consumer;\n+import java.util.regex.Pattern;\n+\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_ID;\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_SECRET;\n+import static com.azure.test.oauth.OAuthUtils.AAD_TENANT_ID_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_NAME_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_PASSWORD_1;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+\n+public class AADLoginIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADLoginIT.class);\n+\n+    static {\n+        final String chromedriverLinux = \"src/test/resources/driver/chromedriver_linux64\";\n+        final String chromedriverWin32 = \"src/test/resources/driver/chromedriver_win32.exe\";\n+        final String chromedriverMac = \"src/test/resources/driver/chromedriver_mac64\";\n+        String osName = System.getProperty(\"os.name\").toLowerCase();\n+        if (Pattern.matches(\"linux.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverLinux);\n+        } else if (Pattern.matches(\"windows.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverWin32);\n+        } else if (Pattern.matches(\"mac.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverMac);\n+        }\n+    }\n+\n+//    @Test\n+    public void loginTest() {\n+        this.runTest(app -> {\n+            WebDriver driver = new ChromeDriver();\n+            WebDriverWait wait = new WebDriverWait(driver, 10);\n+            driver.get(app.root() + \"api/group1\");\n+            wait.until(presenceOfElementLocated(By.name(\"loginfmt\")))\n+                .sendKeys(System.getenv(AAD_USER_NAME_1) + Keys.ENTER);\n+            wait.until(presenceOfElementLocated(By.name(\"passwd\")))\n+                .sendKeys(System.getenv(AAD_USER_PASSWORD_1));\n+\n+            try {\n+                Thread.sleep(3000);\n+                driver.findElement(By.cssSelector(\"input[type='submit']\")).click();\n+                Thread.sleep(3000);\n+                driver.findElement(By.cssSelector(\"input[type='submit']\")).click();\n+                Thread.sleep(3000);\n+                Assert.assertEquals(\"group1\", driver.findElement(By.tagName(\"body\")).getText());\n+            } catch (InterruptedException e) {\n+                throw new RuntimeException(e);\n+            } finally {\n+                driver.quit();\n+            }\n+        });\n+    }\n+\n+    public void runTest(Consumer<AppRunner> command) {\n+        try (AppRunner app = new AppRunner(AADLoginIT.DumbApp.class)) {\n+            app.property(\"spring.security.oauth2.client.registration.azure.tenant-id\",\n+                System.getenv(\"AAD_TENANT_ID_1\"));", "originalCommit": "3296d08ade893509231871d1d49aa219afdf87b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNTc3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532305773", "bodyText": "Add // TODO here, just remind us to delete old configuration item after new aad implementation start to work.", "author": "chenrujun", "createdAt": "2020-11-30T01:39:19Z", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/login/AADLoginIT.java", "diffHunk": "@@ -0,0 +1,128 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.test.aad.login;\n+\n+import com.azure.test.utils.AppRunner;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.Keys;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.chrome.ChromeDriver;\n+import org.openqa.selenium.chrome.ChromeDriverService;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;\n+import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;\n+import org.springframework.security.oauth2.core.oidc.user.OidcUser;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.util.function.Consumer;\n+import java.util.regex.Pattern;\n+\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_ID;\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_SECRET;\n+import static com.azure.test.oauth.OAuthUtils.AAD_TENANT_ID_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_NAME_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_PASSWORD_1;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+\n+public class AADLoginIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADLoginIT.class);\n+\n+    static {\n+        final String chromedriverLinux = \"src/test/resources/driver/chromedriver_linux64\";\n+        final String chromedriverWin32 = \"src/test/resources/driver/chromedriver_win32.exe\";\n+        final String chromedriverMac = \"src/test/resources/driver/chromedriver_mac64\";\n+        String osName = System.getProperty(\"os.name\").toLowerCase();\n+        if (Pattern.matches(\"linux.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverLinux);\n+        } else if (Pattern.matches(\"windows.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverWin32);\n+        } else if (Pattern.matches(\"mac.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverMac);\n+        }\n+    }\n+\n+//    @Test\n+    public void loginTest() {\n+        this.runTest(app -> {\n+            WebDriver driver = new ChromeDriver();\n+            WebDriverWait wait = new WebDriverWait(driver, 10);\n+            driver.get(app.root() + \"api/group1\");\n+            wait.until(presenceOfElementLocated(By.name(\"loginfmt\")))\n+                .sendKeys(System.getenv(AAD_USER_NAME_1) + Keys.ENTER);\n+            wait.until(presenceOfElementLocated(By.name(\"passwd\")))\n+                .sendKeys(System.getenv(AAD_USER_PASSWORD_1));\n+\n+            try {\n+                Thread.sleep(3000);\n+                driver.findElement(By.cssSelector(\"input[type='submit']\")).click();\n+                Thread.sleep(3000);\n+                driver.findElement(By.cssSelector(\"input[type='submit']\")).click();\n+                Thread.sleep(3000);\n+                Assert.assertEquals(\"group1\", driver.findElement(By.tagName(\"body\")).getText());\n+            } catch (InterruptedException e) {\n+                throw new RuntimeException(e);\n+            } finally {\n+                driver.quit();\n+            }\n+        });\n+    }\n+\n+    public void runTest(Consumer<AppRunner> command) {\n+        try (AppRunner app = new AppRunner(AADLoginIT.DumbApp.class)) {", "originalCommit": "3296d08ade893509231871d1d49aa219afdf87b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjA0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532306048", "bodyText": "Can we use String instead of ResponseEntity?", "author": "chenrujun", "createdAt": "2020-11-30T01:40:26Z", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/login/AADLoginIT.java", "diffHunk": "@@ -0,0 +1,128 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.test.aad.login;\n+\n+import com.azure.test.utils.AppRunner;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.Keys;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.chrome.ChromeDriver;\n+import org.openqa.selenium.chrome.ChromeDriverService;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;\n+import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;\n+import org.springframework.security.oauth2.core.oidc.user.OidcUser;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.util.function.Consumer;\n+import java.util.regex.Pattern;\n+\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_ID;\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_SECRET;\n+import static com.azure.test.oauth.OAuthUtils.AAD_TENANT_ID_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_NAME_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_PASSWORD_1;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+\n+public class AADLoginIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADLoginIT.class);\n+\n+    static {\n+        final String chromedriverLinux = \"src/test/resources/driver/chromedriver_linux64\";\n+        final String chromedriverWin32 = \"src/test/resources/driver/chromedriver_win32.exe\";\n+        final String chromedriverMac = \"src/test/resources/driver/chromedriver_mac64\";\n+        String osName = System.getProperty(\"os.name\").toLowerCase();\n+        if (Pattern.matches(\"linux.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverLinux);\n+        } else if (Pattern.matches(\"windows.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverWin32);\n+        } else if (Pattern.matches(\"mac.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverMac);\n+        }\n+    }\n+\n+//    @Test\n+    public void loginTest() {\n+        this.runTest(app -> {\n+            WebDriver driver = new ChromeDriver();\n+            WebDriverWait wait = new WebDriverWait(driver, 10);\n+            driver.get(app.root() + \"api/group1\");\n+            wait.until(presenceOfElementLocated(By.name(\"loginfmt\")))\n+                .sendKeys(System.getenv(AAD_USER_NAME_1) + Keys.ENTER);\n+            wait.until(presenceOfElementLocated(By.name(\"passwd\")))\n+                .sendKeys(System.getenv(AAD_USER_PASSWORD_1));\n+\n+            try {\n+                Thread.sleep(3000);\n+                driver.findElement(By.cssSelector(\"input[type='submit']\")).click();\n+                Thread.sleep(3000);\n+                driver.findElement(By.cssSelector(\"input[type='submit']\")).click();\n+                Thread.sleep(3000);\n+                Assert.assertEquals(\"group1\", driver.findElement(By.tagName(\"body\")).getText());\n+            } catch (InterruptedException e) {\n+                throw new RuntimeException(e);\n+            } finally {\n+                driver.quit();\n+            }\n+        });\n+    }\n+\n+    public void runTest(Consumer<AppRunner> command) {\n+        try (AppRunner app = new AppRunner(AADLoginIT.DumbApp.class)) {\n+            app.property(\"spring.security.oauth2.client.registration.azure.tenant-id\",\n+                System.getenv(\"AAD_TENANT_ID_1\"));\n+            app.property(\"spring.security.oauth2.client.registration.azure.client-id\",\n+                System.getenv(AAD_MULTI_TENANT_CLIENT_ID));\n+            app.property(\"spring.security.oauth2.client.registration.azure.client-secret\",\n+                System.getenv(AAD_MULTI_TENANT_CLIENT_SECRET));\n+\n+            app.property(\"azure.activedirectory.tenant-id\", System.getenv(AAD_TENANT_ID_1));\n+            app.property(\"azure.activedirectory.client-id\", System.getenv(AAD_MULTI_TENANT_CLIENT_ID));\n+            app.property(\"azure.activedirectory.client-secret\", System.getenv(AAD_MULTI_TENANT_CLIENT_SECRET));\n+            app.property(\"azure.activedirectory.user-group.allowed-groups\", \"group1\");\n+\n+            app.start();\n+            command.accept(app);\n+        }\n+    }\n+\n+    @EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)\n+    @SpringBootApplication\n+    @RestController\n+    public static class DumbApp extends WebSecurityConfigurerAdapter {\n+\n+        @Autowired\n+        private OAuth2UserService<OidcUserRequest, OidcUser> oidcUserService;\n+\n+        @PreAuthorize(\"hasRole('ROLE_group1')\")\n+        @GetMapping(value = \"/api/group1\")\n+        public ResponseEntity<String> getRoleGroup1() {", "originalCommit": "3296d08ade893509231871d1d49aa219afdf87b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNzQ0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532307443", "bodyText": "Why?", "author": "lu-cheng", "createdAt": "2020-11-30T01:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwODQyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532308424", "bodyText": "To make code shorter.\nNever mind, keep it if you like.", "author": "chenrujun", "createdAt": "2020-11-30T01:52:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjI2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17856#discussion_r532306261", "bodyText": "Now we tested /api/group. Could you please add the following 2 apis and test them?\n\n/api/home\napi/group2", "author": "chenrujun", "createdAt": "2020-11-30T01:41:31Z", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/login/AADLoginIT.java", "diffHunk": "@@ -0,0 +1,128 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.test.aad.login;\n+\n+import com.azure.test.utils.AppRunner;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.Keys;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.chrome.ChromeDriver;\n+import org.openqa.selenium.chrome.ChromeDriverService;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;\n+import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;\n+import org.springframework.security.oauth2.core.oidc.user.OidcUser;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.util.function.Consumer;\n+import java.util.regex.Pattern;\n+\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_ID;\n+import static com.azure.test.oauth.OAuthUtils.AAD_MULTI_TENANT_CLIENT_SECRET;\n+import static com.azure.test.oauth.OAuthUtils.AAD_TENANT_ID_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_NAME_1;\n+import static com.azure.test.oauth.OAuthUtils.AAD_USER_PASSWORD_1;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+\n+public class AADLoginIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADLoginIT.class);\n+\n+    static {\n+        final String chromedriverLinux = \"src/test/resources/driver/chromedriver_linux64\";\n+        final String chromedriverWin32 = \"src/test/resources/driver/chromedriver_win32.exe\";\n+        final String chromedriverMac = \"src/test/resources/driver/chromedriver_mac64\";\n+        String osName = System.getProperty(\"os.name\").toLowerCase();\n+        if (Pattern.matches(\"linux.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverLinux);\n+        } else if (Pattern.matches(\"windows.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverWin32);\n+        } else if (Pattern.matches(\"mac.*\", osName)) {\n+            System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, chromedriverMac);\n+        }\n+    }\n+\n+//    @Test\n+    public void loginTest() {\n+        this.runTest(app -> {\n+            WebDriver driver = new ChromeDriver();\n+            WebDriverWait wait = new WebDriverWait(driver, 10);\n+            driver.get(app.root() + \"api/group1\");\n+            wait.until(presenceOfElementLocated(By.name(\"loginfmt\")))\n+                .sendKeys(System.getenv(AAD_USER_NAME_1) + Keys.ENTER);\n+            wait.until(presenceOfElementLocated(By.name(\"passwd\")))\n+                .sendKeys(System.getenv(AAD_USER_PASSWORD_1));\n+\n+            try {\n+                Thread.sleep(3000);\n+                driver.findElement(By.cssSelector(\"input[type='submit']\")).click();\n+                Thread.sleep(3000);\n+                driver.findElement(By.cssSelector(\"input[type='submit']\")).click();\n+                Thread.sleep(3000);\n+                Assert.assertEquals(\"group1\", driver.findElement(By.tagName(\"body\")).getText());\n+            } catch (InterruptedException e) {\n+                throw new RuntimeException(e);\n+            } finally {\n+                driver.quit();\n+            }\n+        });\n+    }\n+\n+    public void runTest(Consumer<AppRunner> command) {\n+        try (AppRunner app = new AppRunner(AADLoginIT.DumbApp.class)) {\n+            app.property(\"spring.security.oauth2.client.registration.azure.tenant-id\",\n+                System.getenv(\"AAD_TENANT_ID_1\"));\n+            app.property(\"spring.security.oauth2.client.registration.azure.client-id\",\n+                System.getenv(AAD_MULTI_TENANT_CLIENT_ID));\n+            app.property(\"spring.security.oauth2.client.registration.azure.client-secret\",\n+                System.getenv(AAD_MULTI_TENANT_CLIENT_SECRET));\n+\n+            app.property(\"azure.activedirectory.tenant-id\", System.getenv(AAD_TENANT_ID_1));\n+            app.property(\"azure.activedirectory.client-id\", System.getenv(AAD_MULTI_TENANT_CLIENT_ID));\n+            app.property(\"azure.activedirectory.client-secret\", System.getenv(AAD_MULTI_TENANT_CLIENT_SECRET));\n+            app.property(\"azure.activedirectory.user-group.allowed-groups\", \"group1\");\n+\n+            app.start();\n+            command.accept(app);\n+        }\n+    }\n+\n+    @EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)\n+    @SpringBootApplication\n+    @RestController\n+    public static class DumbApp extends WebSecurityConfigurerAdapter {\n+\n+        @Autowired\n+        private OAuth2UserService<OidcUserRequest, OidcUser> oidcUserService;\n+\n+        @PreAuthorize(\"hasRole('ROLE_group1')\")\n+        @GetMapping(value = \"/api/group1\")\n+        public ResponseEntity<String> getRoleGroup1() {\n+            return new ResponseEntity<>(\"group1\", HttpStatus.OK);\n+        }", "originalCommit": "3296d08ade893509231871d1d49aa219afdf87b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8d05e9673d6c4f93f0b6b9cc0900c80ebf9ffc04", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8d05e9673d6c4f93f0b6b9cc0900c80ebf9ffc04", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java into dev", "committedDate": "2020-11-30T01:53:50Z", "type": "commit"}, {"oid": "cd8f06d9b53b36622bfa8d60129b32f2b572f659", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cd8f06d9b53b36622bfa8d60129b32f2b572f659", "message": "modify", "committedDate": "2020-11-30T02:18:52Z", "type": "commit"}, {"oid": "9bcc10c90e8a548ae19e04835418b96ffdf74099", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9bcc10c90e8a548ae19e04835418b96ffdf74099", "message": "modify", "committedDate": "2020-11-30T05:51:42Z", "type": "commit"}, {"oid": "53a5fe1048cea72989857bca7dedffa2137fd9fe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/53a5fe1048cea72989857bca7dedffa2137fd9fe", "message": "modify", "committedDate": "2020-11-30T10:15:06Z", "type": "commit"}, {"oid": "9e9eea12f9fc044f8a2c0416d771954e8c137fd6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e9eea12f9fc044f8a2c0416d771954e8c137fd6", "message": "modify", "committedDate": "2020-12-01T03:16:22Z", "type": "commit"}, {"oid": "ef0df75d00b7ceba0361f1b9afab87045efe6a89", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ef0df75d00b7ceba0361f1b9afab87045efe6a89", "message": "Add judgment to the login process", "committedDate": "2020-12-01T04:05:39Z", "type": "commit"}, {"oid": "d0398d3864cce252d0167226313695a2aff2d8c8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d0398d3864cce252d0167226313695a2aff2d8c8", "message": "modify", "committedDate": "2020-12-01T06:46:37Z", "type": "commit"}, {"oid": "9d9414e465d340cd154d2e67f4e9aa1c16092fd9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9d9414e465d340cd154d2e67f4e9aa1c16092fd9", "message": "modify sleep time", "committedDate": "2020-12-01T08:52:45Z", "type": "commit"}, {"oid": "322efb2c526152a902e94b4ef61ed2d767e7fe32", "url": "https://github.com/Azure/azure-sdk-for-java/commit/322efb2c526152a902e94b4ef61ed2d767e7fe32", "message": "add log to print principal", "committedDate": "2020-12-02T02:31:45Z", "type": "commit"}, {"oid": "e23253c652ce3ae0d9f58402d59b92c6fd78a211", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e23253c652ce3ae0d9f58402d59b92c6fd78a211", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java into dev", "committedDate": "2020-12-02T03:07:04Z", "type": "commit"}, {"oid": "640ea2d71ac234f29102a6f38c1f72ad268d3da5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/640ea2d71ac234f29102a6f38c1f72ad268d3da5", "message": "modify", "committedDate": "2020-12-02T07:41:47Z", "type": "commit"}, {"oid": "53106b2b47e905ce97c8220a28649212ec517130", "url": "https://github.com/Azure/azure-sdk-for-java/commit/53106b2b47e905ce97c8220a28649212ec517130", "message": "modify", "committedDate": "2020-12-02T07:42:12Z", "type": "commit"}]}