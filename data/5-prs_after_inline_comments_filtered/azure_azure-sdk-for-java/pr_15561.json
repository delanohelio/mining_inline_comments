{"pr_number": 15561, "pr_title": "Add SNI support in Identity SDK", "pr_createdAt": "2020-09-23T16:58:31Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15561", "timeline": [{"oid": "046af3e04c67bf821934ad7272bc0779b98281a9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/046af3e04c67bf821934ad7272bc0779b98281a9", "message": "update MSAL + add cert chain support", "committedDate": "2020-09-23T16:52:32Z", "type": "commit"}, {"oid": "50f5671041585629e746c19b1285b5fd6027b0bc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/50f5671041585629e746c19b1285b5fd6027b0bc", "message": "update cert resource", "committedDate": "2020-09-23T17:02:52Z", "type": "commit"}, {"oid": "e0ebb7e08de74a0d90f52e195a86fa4d58458556", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e0ebb7e08de74a0d90f52e195a86fa4d58458556", "message": "add logging to exceptions", "committedDate": "2020-09-23T17:53:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1Nzg0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r493957842", "bodyText": "nit: The formatting looks a bit odd. Probably moving the instantiation of AuthenticationRecord outside of set() would make it more readable too.", "author": "srnagar", "createdAt": "2020-09-23T23:47:19Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/InteractiveBrowserCredential.java", "diffHunk": "@@ -119,8 +119,9 @@\n     private AccessToken updateCache(MsalToken msalToken) {\n         cachedToken.set(\n                 new MsalAuthenticationAccount(\n-                        new AuthenticationRecord(msalToken.getAuthenticationResult(),\n-                                identityClient.getTenantId(), identityClient.getClientId())));\n+                    new AuthenticationRecord(msalToken.getAuthenticationResult(),\n+                                identityClient.getTenantId(), identityClient.getClientId()),\n+                    msalToken.getAccount().getTenantProfiles()));", "originalCommit": "e0ebb7e08de74a0d90f52e195a86fa4d58458556", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzNjc0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r494636744", "bodyText": "agreed,\nwill update it.", "author": "g2vinay", "createdAt": "2020-09-24T22:05:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1Nzg0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1ODU5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r493958594", "bodyText": "Do we need to special-case this for a list with size 1? Can createFromCertificateChain handle a list that has just 1 entry?", "author": "srnagar", "createdAt": "2020-09-23T23:48:37Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -172,9 +174,15 @@ private ConfidentialClientApplication getConfidentialClientApplication() {\n                 if (certificatePassword == null) {\n                     byte[] pemCertificateBytes = Files.readAllBytes(Paths.get(certificatePath));\n \n-                    credential = ClientCredentialFactory.createFromCertificate(\n-                        CertificateUtil.privateKeyFromPem(pemCertificateBytes),\n-                        CertificateUtil.publicKeyFromPem(pemCertificateBytes));\n+                    List<X509Certificate> x509CertificateList =  CertificateUtil.publicKeyFromPem(pemCertificateBytes);\n+                    PrivateKey privateKey = CertificateUtil.privateKeyFromPem(pemCertificateBytes);\n+                    if (x509CertificateList.size() == 1) {\n+                        credential = ClientCredentialFactory.createFromCertificate(\n+                            privateKey, x509CertificateList.get(0));\n+                    } else {\n+                        credential = ClientCredentialFactory.createFromCertificateChain(\n+                            privateKey, x509CertificateList);\n+                    }", "originalCommit": "e0ebb7e08de74a0d90f52e195a86fa4d58458556", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzNjQ4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r494636484", "bodyText": "yeah, we need to special case it, to ensure that the cert chain is empty and is not sent as part of the request, when there's only one cert to send.", "author": "g2vinay", "createdAt": "2020-09-24T22:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1ODU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1OTIxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r493959212", "bodyText": "Pattern compilation is expensive. So, maybe it's good to just make this pattern into a static final constant.", "author": "srnagar", "createdAt": "2020-09-23T23:49:28Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/util/CertificateUtil.java", "diffHunk": "@@ -54,24 +56,31 @@ public static PrivateKey privateKeyFromPem(byte[] pem) {\n     }\n \n     /**\n-     * Extracts the X509Certificate certificate from a PEM certificate.\n+     * Extracts the X509Certificate certificate/certificate-chain from a PEM certificate.\n      * @param pem the contents of a PEM certificate.\n-     * @return the X509Certificate certificate\n+     * @return the {@link List} of X509Certificate certificate\n      */\n-    public static X509Certificate publicKeyFromPem(byte[] pem) {\n-        Pattern pattern = Pattern.compile(\"(?s)-----BEGIN CERTIFICATE-----.*-----END CERTIFICATE-----\");\n+    public static List<X509Certificate> publicKeyFromPem(byte[] pem) {\n+        Pattern pattern = Pattern.compile(\"(?s)-----BEGIN CERTIFICATE-----.*?-----END CERTIFICATE-----\");", "originalCommit": "e0ebb7e08de74a0d90f52e195a86fa4d58458556", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzNjE3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r494636176", "bodyText": "In this case, it is only called once during client construction and not in any API call.\nSo, having it localized will help to get it garbage collected, after use.", "author": "g2vinay", "createdAt": "2020-09-24T22:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1OTIxMg=="}], "type": "inlineReview"}, {"oid": "a3e98d2f557d1317281655c3892fb5c99074f8e0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a3e98d2f557d1317281655c3892fb5c99074f8e0", "message": "Merge remote-tracking branch 'upstream/master' into add-chained-cert-support", "committedDate": "2020-09-29T17:20:51Z", "type": "commit"}, {"oid": "f8a743d176f2778375d825dd31e4616c9f4160a1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f8a743d176f2778375d825dd31e4616c9f4160a1", "message": "update MSAL + add x5c configurability", "committedDate": "2020-09-29T19:50:35Z", "type": "commit"}, {"oid": "8ef297f321820e6436fbc3d4a51b55a6b21877a8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ef297f321820e6436fbc3d4a51b55a6b21877a8", "message": "update details", "committedDate": "2020-09-29T19:54:56Z", "type": "commit"}, {"oid": "70e90f4780dc792659790ba08f0db5c8682898e4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/70e90f4780dc792659790ba08f0db5c8682898e4", "message": "update javadocs", "committedDate": "2020-09-29T21:08:13Z", "type": "commit"}, {"oid": "7ea6dbd48d0d41d66c370cd35acea4a757dd2aa1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7ea6dbd48d0d41d66c370cd35acea4a757dd2aa1", "message": "update pom file", "committedDate": "2020-10-02T20:46:30Z", "type": "commit"}]}