{"pr_number": 8031, "pr_title": "Updates logger from using Log4j 1.x to 2.x", "pr_createdAt": "2020-02-07T19:29:12Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/8031", "timeline": [{"oid": "30888ebe2f2b562b27121904e29fff6dcd597c81", "url": "https://github.com/Azure/azure-sdk-for-java/commit/30888ebe2f2b562b27121904e29fff6dcd597c81", "message": "Update dependency commons-beanutils.", "committedDate": "2020-02-07T09:05:03Z", "type": "commit"}, {"oid": "a9cae3af41dea754bb4b41a9753f84af87185fc7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a9cae3af41dea754bb4b41a9753f84af87185fc7", "message": "Replace log4j 1.x with 2.x", "committedDate": "2020-02-07T09:05:03Z", "type": "commit"}, {"oid": "d2fe7427d943fa07ee16ee63338b6a70ae54478c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d2fe7427d943fa07ee16ee63338b6a70ae54478c", "message": "Rename properties file to match log4j2 specs.", "committedDate": "2020-02-07T09:05:03Z", "type": "commit"}, {"oid": "0d6f7e447aad081f0a91b96c274a12047347b989", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0d6f7e447aad081f0a91b96c274a12047347b989", "message": "Update properties to matching Log4j2 ones.", "committedDate": "2020-02-07T09:05:04Z", "type": "commit"}, {"oid": "1db433f43703b86c6a2171a4a2b99276bfb5fe47", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1db433f43703b86c6a2171a4a2b99276bfb5fe47", "message": "Update to use Log4j2 through SLF4J api.", "committedDate": "2020-02-07T09:05:04Z", "type": "commit"}, {"oid": "7dd65ef4d431f649fdf8d699dbad3231fad6754c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7dd65ef4d431f649fdf8d699dbad3231fad6754c", "message": "Update LogLevel tests.", "committedDate": "2020-02-07T09:05:04Z", "type": "commit"}, {"oid": "9282499d3503cc04f08e23dd0f3f85adbdd5140a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9282499d3503cc04f08e23dd0f3f85adbdd5140a", "message": "(WIP)", "committedDate": "2020-02-07T09:05:05Z", "type": "commit"}, {"oid": "a6a18526df7aa4831b32e9abe63964f572d51bd8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a6a18526df7aa4831b32e9abe63964f572d51bd8", "message": "Resetting context after each test run.", "committedDate": "2020-02-07T09:05:05Z", "type": "commit"}, {"oid": "0065bbb3fa922bc6600629bf0293c8bd84afe8ff", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0065bbb3fa922bc6600629bf0293c8bd84afe8ff", "message": "Fix ProxyHostTest.", "committedDate": "2020-02-07T09:05:05Z", "type": "commit"}, {"oid": "761371e9d83b119bf01a2465bb6d9c3ed1ce48e2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/761371e9d83b119bf01a2465bb6d9c3ed1ce48e2", "message": "Always reset logging configuration.", "committedDate": "2020-02-07T09:05:06Z", "type": "commit"}, {"oid": "292d3039f7d24083de21efc2f82b004b2ecfdffb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/292d3039f7d24083de21efc2f82b004b2ecfdffb", "message": "Update to log4j2 properties.", "committedDate": "2020-02-07T18:54:50Z", "type": "commit"}, {"oid": "bed4f419b3a104aaed322ec82bb7c812e882d5ae", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bed4f419b3a104aaed322ec82bb7c812e882d5ae", "message": "Move netty configuration back into properties file.", "committedDate": "2020-02-07T18:55:47Z", "type": "commit"}, {"oid": "256900073b7bba8eb58f3afe3b749988a905bc42", "url": "https://github.com/Azure/azure-sdk-for-java/commit/256900073b7bba8eb58f3afe3b749988a905bc42", "message": "Remove usage of slf4j-log4j12", "committedDate": "2020-02-07T18:56:06Z", "type": "commit"}, {"oid": "2d00720c0e56564e77f30151af447c7c94d215d3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2d00720c0e56564e77f30151af447c7c94d215d3", "message": "Add tests for expected log configuration.", "committedDate": "2020-02-07T19:09:32Z", "type": "commit"}, {"oid": "83d1dd3b2bd8dba89207f5d4f22a91e08ccc800f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/83d1dd3b2bd8dba89207f5d4f22a91e08ccc800f", "message": "Rename to log4j2.properties", "committedDate": "2020-02-07T19:10:39Z", "type": "commit"}, {"oid": "912178e345e7f5e382e94d9f65470b20c52a322d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/912178e345e7f5e382e94d9f65470b20c52a322d", "message": "Update to log4j 2 syntax.", "committedDate": "2020-02-07T19:20:04Z", "type": "commit"}, {"oid": "e2588ad7ae4f4a5fd7a9504bbe5f808f5b386a26", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e2588ad7ae4f4a5fd7a9504bbe5f808f5b386a26", "message": "Comment out FileAppender because it is not used.", "committedDate": "2020-02-07T19:20:17Z", "type": "commit"}, {"oid": "a772131516a3dd2ddfd2106dcf0aafd4fc16afd7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a772131516a3dd2ddfd2106dcf0aafd4fc16afd7", "message": "Remove common-beanutil udpate.", "committedDate": "2020-02-07T19:26:59Z", "type": "commit"}, {"oid": "f934d7ac4419fcc924eceda7cf692b6047bc3361", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f934d7ac4419fcc924eceda7cf692b6047bc3361", "message": "Add group back.", "committedDate": "2020-02-07T19:28:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MDMzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8031#discussion_r376580333", "bodyText": "ditto", "author": "moderakh", "createdAt": "2020-02-07T19:59:12Z", "path": "sdk/cosmos/microsoft-azure-cosmos/src/test/java/com/azure/data/cosmos/rx/LogLevelTest.java", "diffHunk": "@@ -197,16 +235,16 @@ public void createDocumentWithDebugLevelAtRoot() throws Exception {\n     /**\n      * This test will try to create document with netty wire ERROR logging and\n      * validate it.\n-     * \n+     *\n      * @throws Exception\n      */\n     @Test(groups = { \"simple\" }, timeOut = TIMEOUT)\n     public void createDocumentWithErrorClient() throws Exception {\n-        LogManager.getRootLogger().setLevel(Level.INFO);\n-        LogManager.getLogger(NETWORK_LOGGING_CATEGORY).setLevel(Level.ERROR);\n-        StringWriter consoleWriter = new StringWriter();\n-        WriterAppender appender = new WriterAppender(new PatternLayout(), consoleWriter);\n-        Logger.getLogger(NETWORK_LOGGING_CATEGORY).addAppender(appender);\n+        final StringWriter consoleWriter = new StringWriter();\n+\n+        addAppenderAndLogger(NETWORK_LOGGING_CATEGORY, Level.ERROR, APPENDER_NAME, consoleWriter);\n+        Logger logger = LoggerFactory.getLogger(NETWORK_LOGGING_CATEGORY);\n+        Assert.assertTrue(logger.isErrorEnabled());", "originalCommit": "f934d7ac4419fcc924eceda7cf692b6047bc3361", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MTcyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8031#discussion_r376581722", "bodyText": "We are using assertj for assertion, please use this instead:\nimport static org.assertj.core.api.Assertions.assertThat;\n\nassertThat(logger.isErrorEnabled()).isTrue()", "author": "moderakh", "createdAt": "2020-02-07T20:02:31Z", "path": "sdk/cosmos/microsoft-azure-cosmos-benchmark/src/test/java/com/azure/data/cosmos/benchmark/LoggerConfigurationTest.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.azure.data.cosmos.benchmark;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+public class LoggerConfigurationTest {\n+    /**\n+     * Netty logging is off. We expect error logging to be disabled.\n+     */\n+    @Test(groups = {\"unit\"})\n+    public void nettyIsDisabled() {\n+        final Logger logger = LoggerFactory.getLogger(\"io.netty\");\n+        final Logger logger2 = LoggerFactory.getLogger(\"io.netty.channel\");\n+\n+        Assert.assertFalse(logger.isErrorEnabled());", "originalCommit": "f934d7ac4419fcc924eceda7cf692b6047bc3361", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MTg4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8031#discussion_r376581883", "bodyText": "ditto\nWe are using assertj for assertion, please use this instead:\nimport static org.assertj.core.api.Assertions.assertThat;\n\nassertThat(logger.isErrorEnabled()).isFase()", "author": "moderakh", "createdAt": "2020-02-07T20:02:56Z", "path": "sdk/cosmos/microsoft-azure-cosmos-benchmark/src/test/java/com/azure/data/cosmos/benchmark/LoggerConfigurationTest.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.azure.data.cosmos.benchmark;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+public class LoggerConfigurationTest {\n+    /**\n+     * Netty logging is off. We expect error logging to be disabled.\n+     */\n+    @Test(groups = {\"unit\"})\n+    public void nettyIsDisabled() {\n+        final Logger logger = LoggerFactory.getLogger(\"io.netty\");\n+        final Logger logger2 = LoggerFactory.getLogger(\"io.netty.channel\");\n+\n+        Assert.assertFalse(logger.isErrorEnabled());\n+        Assert.assertFalse(logger2.isErrorEnabled());\n+    }\n+\n+    /**\n+     * Loggers in the cosmos package should inherit root configuration and log at info.\n+     */\n+    @Test(groups = {\"unit\"})\n+    public void defaultLoggersAtInfo() {\n+        final Logger logger = LoggerFactory.getLogger(\"com.azure.cosmos.internal.query.aggregation\");\n+        final Logger logger2 = LoggerFactory.getLogger(\"com.azure.cosmos\");\n+\n+        Assert.assertTrue(logger.isInfoEnabled());\n+        Assert.assertTrue(logger2.isInfoEnabled());\n+\n+        Assert.assertFalse(logger.isDebugEnabled());\n+        Assert.assertFalse(logger2.isDebugEnabled());", "originalCommit": "f934d7ac4419fcc924eceda7cf692b6047bc3361", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MjAzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8031#discussion_r376582030", "bodyText": "here and everywhere else please,\nditto", "author": "moderakh", "createdAt": "2020-02-07T20:03:17Z", "path": "sdk/cosmos/microsoft-azure-cosmos/src/test/java/com/azure/data/cosmos/rx/LogLevelTest.java", "diffHunk": "@@ -50,18 +60,30 @@ public void beforeClass() {\n         createdCollection = getSharedMultiPartitionCosmosContainer(client);\n     }\n \n+    @AfterMethod(groups = { \"simple\" })\n+    public void afterMethod() {\n+        resetLoggingConfiguration();\n+    }\n+\n+    @AfterClass(groups = { \"simple\" }, timeOut = SHUTDOWN_TIMEOUT)\n+    public void afterClass() {\n+        resetLoggingConfiguration();\n+    }\n+\n     /**\n      * This test will try to create document with netty wire DEBUG logging and\n      * validate it.\n-     * \n+     *\n      * @throws Exception\n      */\n     @Test(groups = { \"simple\" }, timeOut = TIMEOUT)\n     public void createDocumentWithDebugLevel() throws Exception {\n-        LogManager.getLogger(NETWORK_LOGGING_CATEGORY).setLevel(Level.DEBUG);\n-        StringWriter consoleWriter = new StringWriter();\n-        WriterAppender appender = new WriterAppender(new PatternLayout(), consoleWriter);\n-        LogManager.getLogger(NETWORK_LOGGING_CATEGORY).addAppender(appender);\n+        final StringWriter consoleWriter = new StringWriter();\n+\n+        addAppenderAndLogger(NETWORK_LOGGING_CATEGORY, Level.DEBUG, APPENDER_NAME, consoleWriter);\n+\n+        Logger logger = LoggerFactory.getLogger(NETWORK_LOGGING_CATEGORY);\n+        Assert.assertTrue(logger.isDebugEnabled());", "originalCommit": "f934d7ac4419fcc924eceda7cf692b6047bc3361", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0349e616cf71aaa03aed7b7ca539023ddc10d6c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b0349e616cf71aaa03aed7b7ca539023ddc10d6c", "message": "Update to assertj assertions.", "committedDate": "2020-02-07T20:13:37Z", "type": "commit"}]}