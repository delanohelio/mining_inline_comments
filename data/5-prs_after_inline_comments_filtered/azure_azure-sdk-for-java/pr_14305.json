{"pr_number": 14305, "pr_title": "Use next link from group membership request", "pr_createdAt": "2020-08-20T11:35:05Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14305", "timeline": [{"oid": "50118879acb60f97469b77025acee7f67736258e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/50118879acb60f97469b77025acee7f67736258e", "message": "Use next link from group membership request\n\nloadUser only gets the first 100 groups a user belongs to rather than\nusing the odata.nextLink in the response to get the full list of groups.\nFix this by checking if the response contains an odata.nextLink and then\nbuild the URL appropriately for the configured API version.\n\nFor V1, odata.nextLink contains a skip token which we extract. More\ninformation here: https://docs.microsoft.com/en-us/previous-versions/azure/ad/graph/api/users-operations#get-a-users-manager--\n\nFor V2, odata.nextLink can be used directly as the URL for the request\nas specified here: https://docs.microsoft.com/en-us/graph/paging\n\nfix #14222", "committedDate": "2020-08-20T12:07:56Z", "type": "forcePushed"}, {"oid": "42f76973a73399039ad8c4aaf264f6fca540483c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/42f76973a73399039ad8c4aaf264f6fca540483c", "message": "Use next link from group membership request\n\nloadUser only gets the first 100 groups a user belongs to rather than\nusing the odata.nextLink in the response to get the full list of groups.\nFix this by checking if the response contains an odata.nextLink and then\nbuild the URL appropriately for the configured API version.\n\nFor V1, odata.nextLink contains a skip token which we extract. More\ninformation here: https://docs.microsoft.com/en-us/previous-versions/azure/ad/graph/api/users-operations#get-a-users-manager--\n\nFor V2, odata.nextLink can be used directly as the URL for the request\nas specified here: https://docs.microsoft.com/en-us/graph/paging\n\nfix #14222", "committedDate": "2020-08-20T12:15:39Z", "type": "forcePushed"}, {"oid": "78a2aeb1c22769a7c6dda521016bf259fd6b3aed", "url": "https://github.com/Azure/azure-sdk-for-java/commit/78a2aeb1c22769a7c6dda521016bf259fd6b3aed", "message": "Use next link from group membership request\n\nloadUser only gets the first 100 groups a user belongs to rather than\nusing the odata.nextLink in the response to get the full list of groups.\nFix this by checking if the response contains an odata.nextLink and then\nbuild the URL appropriately for the configured API version.\n\nFor V1, odata.nextLink contains a skip token which we extract. More\ninformation here: https://docs.microsoft.com/en-us/previous-versions/azure/ad/graph/api/users-operations#get-a-users-manager--\n\nFor V2, odata.nextLink can be used directly as the URL for the request\nas specified here: https://docs.microsoft.com/en-us/graph/paging\n\nfix #14222", "committedDate": "2020-08-20T12:16:42Z", "type": "forcePushed"}, {"oid": "02755715d8bb277ed14f934ca253365600953e87", "url": "https://github.com/Azure/azure-sdk-for-java/commit/02755715d8bb277ed14f934ca253365600953e87", "message": "Use next link from group membership request\n\nloadUser only gets the first 100 groups a user belongs to rather than\nusing the odata.nextLink in the response to get the full list of groups.\nFix this by checking if the response contains an odata.nextLink and then\nbuild the URL appropriately for the configured API version.\n\nFor V1, odata.nextLink contains a skip token which we extract. More\ninformation here: https://docs.microsoft.com/en-us/previous-versions/azure/ad/graph/api/users-operations#get-a-users-manager--\n\nFor V2, odata.nextLink can be used directly as the URL for the request\nas specified here: https://docs.microsoft.com/en-us/graph/paging\n\nfix #14222", "committedDate": "2020-08-20T12:58:47Z", "type": "forcePushed"}, {"oid": "fd5ed7040e637bb3df6d8e04595081b099821b39", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fd5ed7040e637bb3df6d8e04595081b099821b39", "message": "Use next link from group membership request\n\nloadUser only gets the first 100 groups a user belongs to rather than\nusing the odata.nextLink in the response to get the full list of groups.\nFix this by checking if the response contains an odata.nextLink and then\nbuild the URL appropriately for the configured API version.\n\nFor V1, odata.nextLink contains a skip token which we extract. More\ninformation here: https://docs.microsoft.com/en-us/previous-versions/azure/ad/graph/api/users-operations#get-a-users-manager--\n\nFor V2, odata.nextLink can be used directly as the URL for the request\nas specified here: https://docs.microsoft.com/en-us/graph/paging\n\nfix #14222", "committedDate": "2020-08-21T09:28:36Z", "type": "forcePushed"}, {"oid": "42467b4341c1fb56f051453a19e5879247f4406c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/42467b4341c1fb56f051453a19e5879247f4406c", "message": "Use next link from group membership request\n\nloadUser only gets the first 100 groups a user belongs to rather than\nusing the odata.nextLink in the response to get the full list of groups.\nFix this by checking if the response contains an odata.nextLink and then\nbuild the URL appropriately for the configured API version.\n\nFor V1, odata.nextLink contains a skip token which we extract. More\ninformation here: https://docs.microsoft.com/en-us/previous-versions/azure/ad/graph/api/users-operations#get-a-users-manager--\n\nFor V2, odata.nextLink can be used directly as the URL for the request\nas specified here: https://docs.microsoft.com/en-us/graph/paging\n\nfix #14222", "committedDate": "2020-08-21T16:34:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ3ODA2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r475478066", "bodyText": "odataNextLink is not used?", "author": "chenrujun", "createdAt": "2020-08-24T09:46:23Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/microsoft/azure/spring/autoconfigure/aad/AzureADGraphClient.java", "diffHunk": "@@ -77,7 +77,7 @@ private void initAADMicrosoftGraphApiBool(String endpointEnv) {\n         this.aadMicrosoftGraphApiBool = endpointEnv.contains(V2_VERSION_ENV_FLAG);\n     }\n \n-    private String getUserMembershipsV1(String accessToken) throws IOException {\n+    private String getUserMemberships(String accessToken, Optional<String> odataNextLink) throws IOException {", "originalCommit": "42467b4341c1fb56f051453a19e5879247f4406c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQwOTAyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477409021", "bodyText": "It is being used now to properly build the url, depending on if the request is v1 or v2. see cc20c05", "author": "ppartarr", "createdAt": "2020-08-26T15:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ3ODA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk3MDgxNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r476970817", "bodyText": "Is Jdk8Module is used for support Optional type in json?\nCan we use null instead of Optional?", "author": "chenrujun", "createdAt": "2020-08-26T01:56:38Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/microsoft/azure/spring/autoconfigure/aad/AzureADGraphClient.java", "diffHunk": "@@ -121,22 +121,21 @@ private static String getResponseStringFromConn(HttpURLConnection conn) throws I\n     }\n \n     private List<UserGroup> loadUserGroups(String graphApiToken) throws IOException {\n-        final String responseInJson = getUserMembershipsV1(graphApiToken);\n+        String responseInJson = getUserMemberships(graphApiToken, Optional.empty());\n         final List<UserGroup> lUserGroups = new ArrayList<>();\n         final ObjectMapper objectMapper = JacksonObjectMapperFactory.getInstance();\n-        final JsonNode rootNode = objectMapper.readValue(responseInJson, JsonNode.class);\n-        final JsonNode valuesNode = rootNode.get(\"value\");\n-\n-        if (valuesNode != null) {\n-            lUserGroups\n-                .addAll(StreamSupport.stream(valuesNode.spliterator(), false).filter(this::isMatchingUserGroupKey)\n-                    .map(node -> {\n-                        final String objectID = node.\n-                            get(aadAuthenticationProperties.getUserGroup().getObjectIDKey()).asText();\n-                        final String displayName = node.get(\"displayName\").asText();\n-                        return new UserGroup(objectID, displayName);\n-                    }).collect(Collectors.toList()));\n+        objectMapper.registerModule(new Jdk8Module());", "originalCommit": "42467b4341c1fb56f051453a19e5879247f4406c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMjAzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477412039", "bodyText": "made the change in cc20c05", "author": "ppartarr", "createdAt": "2020-08-26T15:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk3MDgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5MDY2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477090665", "bodyText": "I debugged in my localhost, groupsFromJson.getOdataNextLink() will return null, not Optional.empty(), so groupsFromJson.getOdataNextLink().isPresent() will throw NullPointerExceotion.\nJson:\n\nScreenshot of IDE:", "author": "chenrujun", "createdAt": "2020-08-26T07:27:58Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/microsoft/azure/spring/autoconfigure/aad/AzureADGraphClient.java", "diffHunk": "@@ -121,22 +121,21 @@ private static String getResponseStringFromConn(HttpURLConnection conn) throws I\n     }\n \n     private List<UserGroup> loadUserGroups(String graphApiToken) throws IOException {\n-        final String responseInJson = getUserMembershipsV1(graphApiToken);\n+        String responseInJson = getUserMemberships(graphApiToken, Optional.empty());\n         final List<UserGroup> lUserGroups = new ArrayList<>();\n         final ObjectMapper objectMapper = JacksonObjectMapperFactory.getInstance();\n-        final JsonNode rootNode = objectMapper.readValue(responseInJson, JsonNode.class);\n-        final JsonNode valuesNode = rootNode.get(\"value\");\n-\n-        if (valuesNode != null) {\n-            lUserGroups\n-                .addAll(StreamSupport.stream(valuesNode.spliterator(), false).filter(this::isMatchingUserGroupKey)\n-                    .map(node -> {\n-                        final String objectID = node.\n-                            get(aadAuthenticationProperties.getUserGroup().getObjectIDKey()).asText();\n-                        final String displayName = node.get(\"displayName\").asText();\n-                        return new UserGroup(objectID, displayName);\n-                    }).collect(Collectors.toList()));\n+        objectMapper.registerModule(new Jdk8Module());\n+        UserGroups groupsFromJson = objectMapper.readValue(responseInJson, UserGroups.class);\n \n+        if (groupsFromJson.getValue() != null) {\n+            lUserGroups.addAll(groupsFromJson.getValue().stream().filter(this::isMatchingUserGroupKey)\n+                .collect(Collectors.toList()));\n+        }\n+        while (groupsFromJson.getOdataNextLink().isPresent()) {", "originalCommit": "42467b4341c1fb56f051453a19e5879247f4406c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQwNzQ3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477407472", "bodyText": "thanks for the debugging. The change from Optional<String>  to String means that getOdataNextLink() now returns a string or null if there is no odata.nextLink in the response. I replaced isPresent() with a null check in cc20c05", "author": "ppartarr", "createdAt": "2020-08-26T15:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5MDY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwMjA0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477102049", "bodyText": "Please update java doc in line 147.", "author": "chenrujun", "createdAt": "2020-08-26T07:48:35Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/microsoft/azure/spring/autoconfigure/aad/AzureADGraphClient.java", "diffHunk": "@@ -149,9 +148,8 @@ private static String getResponseStringFromConn(HttpURLConnection conn) throws I\n      *             {@link AADAuthenticationProperties.UserGroupProperties}\n      * @return true if the json node contains the correct key, and expected value to identify a user group.\n      */\n-    private boolean isMatchingUserGroupKey(final JsonNode node) {\n-        return node.get(aadAuthenticationProperties.getUserGroup().getKey()).asText()\n-            .equals(aadAuthenticationProperties.getUserGroup().getValue());\n+    private boolean isMatchingUserGroupKey(final UserGroup group) {", "originalCommit": "42467b4341c1fb56f051453a19e5879247f4406c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwNjA4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477106087", "bodyText": "When will id and objectType been used? In the json I get, it only have objectId and odata.type.", "author": "chenrujun", "createdAt": "2020-08-26T07:55:18Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/microsoft/azure/spring/autoconfigure/aad/UserGroup.java", "diffHunk": "@@ -6,21 +6,42 @@\n import java.io.Serializable;\n import java.util.Objects;\n \n+import com.fasterxml.jackson.annotation.JsonAlias;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n public class UserGroup implements Serializable {\n     private static final long serialVersionUID = 9064197572478554735L;\n \n+    @JsonProperty(\"objectId\")\n+    @JsonAlias(\"id\")\n     private String objectID;\n+\n+    @JsonProperty(\"objectType\")\n+    @JsonAlias(\"@odata.type\")", "originalCommit": "42467b4341c1fb56f051453a19e5879247f4406c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMTUxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477411515", "bodyText": "id and objectType are used depending on if the request is to Azure AD Graph API (v1) or the Microsoft Graph API (v2). See example responses here: https://github.com/Azure/azure-sdk-for-java/tree/master/sdk/spring/azure-spring-boot/src/test/resources/aad\nFor reference, here are the docs for the /memberOf request/response for both versions:\nAzure Graph API: https://docs.microsoft.com/en-us/previous-versions/azure/ad/graph/api/users-operations#get-a-users-group-and-directory-role-memberships--\nMicrosoft Graph API: https://docs.microsoft.com/en-us/graph/api/user-list-memberof?view=graph-rest-1.0&tabs=http", "author": "ppartarr", "createdAt": "2020-08-26T15:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwNjA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE1MzkxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477153918", "bodyText": "We can set default value to Optional.empty() to avoid NullPointerException.\nRefs: https://stackoverflow.com/questions/18805455/setting-default-values-to-null-fields-when-mapping-with-jackson\nBut having an Optional in a class field or in a data structure, is considered a misuse of the API,\nRefs: https://stackoverflow.com/questions/23454952/uses-for-optional\nSo I suggest to use\nprivate String odataNextLink;\n\ninstead of\nprivate Optional<String> odataNextLink;", "author": "chenrujun", "createdAt": "2020-08-26T09:12:58Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/microsoft/azure/spring/autoconfigure/aad/UserGroups.java", "diffHunk": "@@ -0,0 +1,55 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.microsoft.azure.spring.autoconfigure.aad;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class UserGroups {\n+\n+    @JsonProperty(\"odata.nextLink\")\n+    private Optional<String> odataNextLink;", "originalCommit": "42467b4341c1fb56f051453a19e5879247f4406c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQwODIxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14305#discussion_r477408211", "bodyText": "Thanks for pointing this out, using a String is the better approach! I made the change in cc20c05", "author": "ppartarr", "createdAt": "2020-08-26T15:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE1MzkxOA=="}], "type": "inlineReview"}, {"oid": "744247507590c431c83ec2d2fd2bd2375300a411", "url": "https://github.com/Azure/azure-sdk-for-java/commit/744247507590c431c83ec2d2fd2bd2375300a411", "message": "Use next link from group membership request\n\nloadUser only gets the first 100 groups a user belongs to rather than\nusing the odata.nextLink in the response to get the full list of groups.\nFix this by checking if the response contains an odata.nextLink and then\nbuild the URL appropriately for the configured API version.\n\nFor V1, odata.nextLink contains a skip token which we extract. More\ninformation here: https://docs.microsoft.com/en-us/previous-versions/azure/ad/graph/api/users-operations#get-a-users-manager--\n\nFor V2, odata.nextLink can be used directly as the URL for the request\nas specified here: https://docs.microsoft.com/en-us/graph/paging\n\nfix #14222", "committedDate": "2020-08-27T12:13:55Z", "type": "commit"}, {"oid": "b864a8eb603ab5630f0af894acaf17ec44f789bc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b864a8eb603ab5630f0af894acaf17ec44f789bc", "message": "Remove jackson datatype dep\n\nChange the type of the odata.nextLink from Optional<String> to String", "committedDate": "2020-08-27T12:13:56Z", "type": "commit"}, {"oid": "e3c832f87cf65219dd7b500ab25a998c38dab8a3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e3c832f87cf65219dd7b500ab25a998c38dab8a3", "message": "Remove unused Jdk8Module import", "committedDate": "2020-08-27T12:13:56Z", "type": "commit"}, {"oid": "e3c832f87cf65219dd7b500ab25a998c38dab8a3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e3c832f87cf65219dd7b500ab25a998c38dab8a3", "message": "Remove unused Jdk8Module import", "committedDate": "2020-08-27T12:13:56Z", "type": "forcePushed"}]}