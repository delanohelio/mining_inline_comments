{"pr_number": 13427, "pr_title": "Storage/set tier version snapshot", "pr_createdAt": "2020-07-22T22:21:41Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13427", "timeline": [{"oid": "8fb335a94caddac24a2de117ab7b27319571664e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fb335a94caddac24a2de117ab7b27319571664e", "message": "Added code to support versioning and snapshot for set access tier", "committedDate": "2020-07-22T20:21:54Z", "type": "commit"}, {"oid": "62880d82540f1d0de71eadb30ff7445e41bb4379", "url": "https://github.com/Azure/azure-sdk-for-java/commit/62880d82540f1d0de71eadb30ff7445e41bb4379", "message": "Do not break existing delete code", "committedDate": "2020-07-22T21:15:37Z", "type": "commit"}, {"oid": "7ff9f9c64204e3bc784e7557f993d268830c60ca", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7ff9f9c64204e3bc784e7557f993d268830c60ca", "message": "Do not break existing delete code", "committedDate": "2020-07-22T22:10:51Z", "type": "commit"}, {"oid": "b84413cafefaebd0c9aed64692c5edda239ee88c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b84413cafefaebd0c9aed64692c5edda239ee88c", "message": "Added test records", "committedDate": "2020-07-22T22:21:16Z", "type": "commit"}, {"oid": "4f6eda2bff16b869fe68d79d3a1e1d865b6a628a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4f6eda2bff16b869fe68d79d3a1e1d865b6a628a", "message": "Added sample", "committedDate": "2020-07-22T22:24:23Z", "type": "commit"}, {"oid": "5a65280a0a84e9dd66532914aa4a9df3a4798f74", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5a65280a0a84e9dd66532914aa4a9df3a4798f74", "message": "Added more records", "committedDate": "2020-07-22T22:45:26Z", "type": "commit"}, {"oid": "a63630730cde0118fb8dc0e2bc00fdfedfb1e5b8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a63630730cde0118fb8dc0e2bc00fdfedfb1e5b8", "message": "Added changelog support", "committedDate": "2020-07-22T23:11:10Z", "type": "commit"}, {"oid": "b63adc17d47aef4402d4fb014880a8e41ad5827b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b63adc17d47aef4402d4fb014880a8e41ad5827b", "message": "Fixed ANalyze step issues", "committedDate": "2020-07-22T23:36:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MjI4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13427#discussion_r459152283", "bodyText": "Given this is internal would it be better to splay out the BlobBatchSetBlobAccessTierOptions parameters so we don't need to instantiate short lived objects in the other overloads.", "author": "alzimmermsft", "createdAt": "2020-07-23T00:12:21Z", "path": "sdk/storage/azure-storage-blob-batch/src/main/java/com/azure/storage/blob/batch/BlobBatch.java", "diffHunk": "@@ -250,13 +254,33 @@\n      * @throws UnsupportedOperationException If this batch has already added an operation of another type.\n      */\n     public Response<Void> setBlobAccessTier(String blobUrl, AccessTier accessTier, String leaseId) {\n-        return setBlobAccessTierHelper(getUrlPath(blobUrl), accessTier, leaseId);\n+        return setBlobAccessTier(new BlobBatchSetBlobAccessTierOptions(blobUrl, accessTier).setLeaseId(leaseId));\n     }\n \n-    private Response<Void> setBlobAccessTierHelper(String urlPath, AccessTier accessTier, String leaseId) {\n+    /**\n+     * Adds a set tier operation to the batch.\n+     *\n+     * <p><strong>Code sample</strong></p>\n+     *\n+     * {@codesnippet com.azure.storage.blob.batch.BlobBatch.setBlobAccessTier#BlobBatchSetBlobAccessTierOptions}\n+     *\n+     * @param options {@link BlobBatchSetBlobAccessTierOptions}\n+     * @return a {@link Response} that will be used to associate this operation to the response when the batch is\n+     * submitted.\n+     * @throws UnsupportedOperationException If this batch has already added an operation of another type.\n+     */\n+    public Response<Void> setBlobAccessTier(BlobBatchSetBlobAccessTierOptions options) {\n+        return setBlobAccessTierHelper(options);\n+    }\n+\n+    private Response<Void> setBlobAccessTierHelper(BlobBatchSetBlobAccessTierOptions options) {", "originalCommit": "b63adc17d47aef4402d4fb014880a8e41ad5827b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1ODU3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13427#discussion_r459558579", "bodyText": "I'm not too attached to either format but this just keeps things consistent with how we deal with overloads in other places. But splaying out the parameters seems fine due to the small number of params.", "author": "gapra-msft", "createdAt": "2020-07-23T16:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MjI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MTk0MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13427#discussion_r459581940", "bodyText": "updated", "author": "gapra-msft", "createdAt": "2020-07-23T16:37:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MjI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1Mjk1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13427#discussion_r459152950", "bodyText": "Do we want to eagerly promote this in public API given it's only use is in Blob Batch?", "author": "alzimmermsft", "createdAt": "2020-07-23T00:14:49Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/Utility.java", "diffHunk": "@@ -280,4 +280,21 @@ public static OffsetDateTime parseDate(String dateString) {\n                 });\n         });\n     }\n+\n+    /**\n+     * Appends a query parameter to a url.\n+     *\n+     * @param url The url.\n+     * @param key The query key.\n+     * @param value The query value.\n+     * @return The updated url.\n+     */\n+    public static String appendQueryParameter(String url, String key, String value) {", "originalCommit": "b63adc17d47aef4402d4fb014880a8e41ad5827b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MzQyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13427#discussion_r459153423", "bodyText": "It's also used in Blob's getBlobUrl. That was actually where the method originally existed and I wanted to pull it out to prevent duplication", "author": "gapra-msft", "createdAt": "2020-07-23T00:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1Mjk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MDQ5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13427#discussion_r459580493", "bodyText": "Given there are more use cases for this sounds good to add.", "author": "alzimmermsft", "createdAt": "2020-07-23T16:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1Mjk1MA=="}], "type": "inlineReview"}, {"oid": "1067cbc3a7599541fa78cfbc51aefccd8ae473a5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1067cbc3a7599541fa78cfbc51aefccd8ae473a5", "message": "Addressed comments from PR", "committedDate": "2020-07-23T16:36:30Z", "type": "commit"}, {"oid": "06beb1021963f796543224e19e17ae80a0920d03", "url": "https://github.com/Azure/azure-sdk-for-java/commit/06beb1021963f796543224e19e17ae80a0920d03", "message": "Removed import", "committedDate": "2020-07-23T18:07:39Z", "type": "commit"}, {"oid": "8199cb36d2a16419ca8255cc1abfd5afc0a4f08a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8199cb36d2a16419ca8255cc1abfd5afc0a4f08a", "message": "Merge branch 'master' into storage/setTierVersionSnapshot", "committedDate": "2020-07-23T22:59:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4MjcxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13427#discussion_r460082712", "bodyText": "I think maybe like getBlobIdentifier might be more appropriate since it's not just the path?", "author": "rickle-msft", "createdAt": "2020-07-24T14:20:02Z", "path": "sdk/storage/azure-storage-blob-batch/src/main/java/com/azure/storage/blob/batch/options/BlobBatchSetBlobAccessTierOptions.java", "diffHunk": "@@ -0,0 +1,182 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.blob.batch.options;\n+\n+import com.azure.core.annotation.Fluent;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.blob.BlobUrlParts;\n+import com.azure.storage.blob.models.AccessTier;\n+import com.azure.storage.blob.models.RehydratePriority;\n+import com.azure.storage.common.Utility;\n+import com.azure.storage.common.implementation.StorageImplUtils;\n+\n+/**\n+ * Extended options that may be passed when batch setting tier for blobs.\n+ */\n+@Fluent\n+public class BlobBatchSetBlobAccessTierOptions {\n+\n+    private final ClientLogger logger = new ClientLogger(BlobBatchSetBlobAccessTierOptions.class);\n+\n+    private final BlobUrlParts blobUrlParts;\n+    private final AccessTier tier;\n+    private RehydratePriority priority;\n+    private String leaseId;\n+    private String tagsConditions;\n+\n+    /**\n+     * @param blobUrl Url of the blob to set access tier. Blob names must be encoded to UTF-8.\n+     * @param tier {@link AccessTier} to set on each blob.\n+     */\n+    public BlobBatchSetBlobAccessTierOptions(String blobUrl, AccessTier tier) {\n+        StorageImplUtils.assertNotNull(\"blobUrl\", blobUrl);\n+        StorageImplUtils.assertNotNull(\"tier\", tier);\n+        this.blobUrlParts = BlobUrlParts.parse(blobUrl);\n+        this.tier = tier;\n+    }\n+\n+    /**\n+     * @param containerName Name of the container to set access tier.\n+     * @param blobName Name of the blob to set access tier. Blob names must be encoded to UTF-8.\n+     * @param tier {@link AccessTier} to set on each blob.\n+     */\n+    public BlobBatchSetBlobAccessTierOptions(String containerName, String blobName, AccessTier tier) {\n+        StorageImplUtils.assertNotNull(\"containerName\", containerName);\n+        StorageImplUtils.assertNotNull(\"blobName\", blobName);\n+        StorageImplUtils.assertNotNull(\"tier\", tier);\n+        this.blobUrlParts = BlobUrlParts.parse(\"https://account.blob.core.windows.net\")\n+            .setContainerName(containerName)\n+            .setBlobName(blobName);\n+        this.tier = tier;\n+    }\n+\n+    /**\n+     * @return Url of the blob to set its access tier.\n+     */\n+    public String getBlobUrl() {\n+        return blobUrlParts.toUrl().toString();\n+    }\n+\n+    /**\n+     * @return Container of the blob to set its access tier.\n+     */\n+    public String getBlobContainerName() {\n+        return blobUrlParts.getBlobContainerName();\n+    }\n+\n+    /**\n+     * @return Name of the blob to set its access tier.\n+     */\n+    public String getBlobName() {\n+        return blobUrlParts.getBlobName();\n+    }\n+\n+    /**\n+     * @return Path of the blob to set its access tier.\n+     */\n+    public String getBlobPath() {", "originalCommit": "8199cb36d2a16419ca8255cc1abfd5afc0a4f08a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5MjM4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13427#discussion_r460992383", "bodyText": "Yeah I like that", "author": "gapra-msft", "createdAt": "2020-07-27T15:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4MjcxMg=="}], "type": "inlineReview"}, {"oid": "07a5b735432cca6582109ad97a771650a5648996", "url": "https://github.com/Azure/azure-sdk-for-java/commit/07a5b735432cca6582109ad97a771650a5648996", "message": "Changed name to identifier", "committedDate": "2020-07-27T15:53:28Z", "type": "commit"}]}