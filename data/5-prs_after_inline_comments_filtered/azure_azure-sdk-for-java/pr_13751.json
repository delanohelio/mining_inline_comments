{"pr_number": 13751, "pr_title": "Renew currently owned partitions stored in checkpointstore", "pr_createdAt": "2020-08-03T16:34:40Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13751", "timeline": [{"oid": "f72e9c88cfa924f3a7b7e725bb6bda1206265843", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f72e9c88cfa924f3a7b7e725bb6bda1206265843", "message": "Renew currently owned partitions stored in checkpointstore", "committedDate": "2020-08-03T06:44:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUzNTc0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13751#discussion_r464535743", "bodyText": "Do we need to collect this into a list if we're doing anything on the output?", "author": "conniey", "createdAt": "2020-08-03T16:50:38Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionBasedLoadBalancer.java", "diffHunk": "@@ -278,6 +258,24 @@ void loadBalance() {\n         });\n     }\n \n+    private void renewOwnership(Map<String, PartitionOwnership> partitionOwnershipMap) {\n+        // renew ownership of already owned partitions\n+        checkpointStore.claimOwnership(partitionPumpManager.getPartitionPumps().keySet()\n+            .stream()\n+            .filter(\n+                partitionId -> partitionOwnershipMap.containsKey(partitionId) && partitionOwnershipMap.get(partitionId)\n+                    .equals(this.ownerId))\n+            .map(partitionId -> createPartitionOwnershipRequest(partitionOwnershipMap, partitionId))\n+            .collect(Collectors.toList()))", "originalCommit": "f72e9c88cfa924f3a7b7e725bb6bda1206265843", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUzNTkwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13751#discussion_r464535908", "bodyText": "Is it possible to have a test for this? \ud83e\udd14", "author": "conniey", "createdAt": "2020-08-03T16:50:57Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionBasedLoadBalancer.java", "diffHunk": "@@ -218,35 +218,15 @@ void loadBalance() {\n                 // If the partitions are evenly distributed among all active event processors, no change required.\n                 logger.info(\"Load is balanced with this event processor owning {} partitions\",\n                     ownerPartitionMap.get(ownerId).size());\n-                // renew ownership of already owned partitions\n-                checkpointStore.claimOwnership(partitionPumpManager.getPartitionPumps().keySet()\n-                    .stream()\n-                    .map(partitionId -> createPartitionOwnershipRequest(partitionOwnershipMap, partitionId))\n-                    .collect(Collectors.toList()))\n-                    .subscribe(ignored -> { },\n-                        ex -> {\n-                            logger.error(\"Error renewing partition ownership\", ex);\n-                            isLoadBalancerRunning.set(false);\n-                        },\n-                        () -> isLoadBalancerRunning.set(false));\n+                renewOwnership(partitionOwnershipMap);", "originalCommit": "f72e9c88cfa924f3a7b7e725bb6bda1206265843", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7ba9649e6b19fde08dfde7e5625232b9e5a607b2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7ba9649e6b19fde08dfde7e5625232b9e5a607b2", "message": "Add unit tests", "committedDate": "2020-08-04T20:17:31Z", "type": "commit"}, {"oid": "3eaed5e2dda204d3e4e2c36bc406f431c76050f1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3eaed5e2dda204d3e4e2c36bc406f431c76050f1", "message": "Fix checkstyle", "committedDate": "2020-08-04T20:19:13Z", "type": "commit"}, {"oid": "1133253acc44ca3738f80013051a3555a6b5da2c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1133253acc44ca3738f80013051a3555a6b5da2c", "message": "Fix unit test", "committedDate": "2020-08-04T21:34:20Z", "type": "commit"}, {"oid": "af47558f199996e348c454519174cd57de387f7f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/af47558f199996e348c454519174cd57de387f7f", "message": "Fix unit test", "committedDate": "2020-08-04T21:35:24Z", "type": "commit"}]}