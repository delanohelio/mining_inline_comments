{"pr_number": 17901, "pr_title": "AADAuthorizedClinetRepo for Obo flow", "pr_createdAt": "2020-12-01T09:29:02Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17901", "timeline": [{"oid": "50a822bc355914cf8b4d486c128dd9a2663092b2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/50a822bc355914cf8b4d486c128dd9a2663092b2", "message": "obo flow repo", "committedDate": "2020-12-01T09:22:21Z", "type": "commit"}, {"oid": "6e18ba6f4b61484a5b5eac1274c8c0278ee7b6e6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6e18ba6f4b61484a5b5eac1274c8c0278ee7b6e6", "message": "AADOboAutClientRepo and sample", "committedDate": "2020-12-02T07:58:29Z", "type": "commit"}, {"oid": "73f02c0adcc69d3e0aa8957081509808832389d2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/73f02c0adcc69d3e0aa8957081509808832389d2", "message": "Merge branch 'master' of git://github.com/Azure/azure-sdk-for-java into obo-flow-repo", "committedDate": "2020-12-02T08:50:27Z", "type": "commit"}, {"oid": "d90887c34587322c2100d9fc888c503b2e54f79f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d90887c34587322c2100d9fc888c503b2e54f79f", "message": "for checkstyle", "committedDate": "2020-12-02T08:56:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU3NzQxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r534577418", "bodyText": "Hi, @sangonzal, @SomkaPe,\nWe are using msal to implement obo function in spring-framework.\nCould you please help to review this PR?", "author": "chenrujun", "createdAt": "2020-12-03T00:34:42Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/resource/server/AADOAuth2OboAuthorizedClientRepository.java", "diffHunk": "@@ -0,0 +1,135 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.resource.server;\n+\n+import com.azure.spring.aad.implementation.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IClientSecret;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import com.microsoft.aad.msal4j.UserAssertion;\n+import com.nimbusds.jwt.JWT;\n+import com.nimbusds.jwt.JWTParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AbstractOAuth2Token;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.security.oauth2.server.resource.authentication.AbstractOAuth2TokenAuthenticationToken;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.net.MalformedURLException;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+public class AADOAuth2OboAuthorizedClientRepository implements OAuth2AuthorizedClientRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(AADOAuth2OboAuthorizedClientRepository.class);\n+\n+    private final AzureClientRegistrationRepository azureClientRegistrationRepository;\n+\n+    private Map<String, ConfidentialClientApplication> confidentialClientApplicationMap = new HashMap<>();\n+\n+    public AADOAuth2OboAuthorizedClientRepository(AzureClientRegistrationRepository azureClientRegistrationRepository) {\n+        this.azureClientRegistrationRepository = azureClientRegistrationRepository;\n+        Iterator<ClientRegistration> iterator = azureClientRegistrationRepository.iterator();\n+        while (iterator.hasNext()) {\n+            ClientRegistration next = iterator.next();\n+            this.confidentialClientApplicationMap.put(next.getClientId(), createApp(next));\n+        }\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public <T extends OAuth2AuthorizedClient> T loadAuthorizedClient(String registrationId,\n+                                                                     Authentication authentication,\n+                                                                     HttpServletRequest request) {\n+        try {\n+            ClientRegistration clientRegistration = azureClientRegistrationRepository\n+                .findByRegistrationId(registrationId);\n+\n+            AbstractOAuth2TokenAuthenticationToken<AbstractOAuth2Token> authenticationToken =\n+                (AbstractOAuth2TokenAuthenticationToken)\n+                    authentication;\n+\n+            String accessToken = authenticationToken.getToken().getTokenValue();\n+\n+            OnBehalfOfParameters parameters = OnBehalfOfParameters\n+                .builder(clientRegistration.getScopes(), new UserAssertion(accessToken))\n+                .build();\n+\n+            ConfidentialClientApplication clientApplication = confidentialClientApplicationMap.get(clientRegistration\n+                .getClientId());\n+\n+            String oboAccessToken = clientApplication.acquireToken(parameters).get().accessToken();", "originalCommit": "d90887c34587322c2100d9fc888c503b2e54f79f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6d57fdd93dad8968fbbaf61c25938e8692f497fb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6d57fdd93dad8968fbbaf61c25938e8692f497fb", "message": "test", "committedDate": "2020-12-03T07:25:03Z", "type": "commit"}, {"oid": "cee53b0b6d99b7641da75a10e5b1716a2182ffe4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cee53b0b6d99b7641da75a10e5b1716a2182ffe4", "message": "Improve resource server accesses other resources scenarios; separate resource and client configuration for resource server side", "committedDate": "2020-12-04T07:54:26Z", "type": "commit"}, {"oid": "612a1ee18bb9c04a78635312844ebc8372ad88e0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/612a1ee18bb9c04a78635312844ebc8372ad88e0", "message": "Delete unused module", "committedDate": "2020-12-04T07:59:25Z", "type": "commit"}, {"oid": "52b87d7c0a631265c30f972f5c397e54e7f47af4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/52b87d7c0a631265c30f972f5c397e54e7f47af4", "message": "commit AADOboAuClientRepo UT", "committedDate": "2020-12-04T08:11:02Z", "type": "commit"}, {"oid": "287cfaeca092aace0ca426447a3dea4fca098e31", "url": "https://github.com/Azure/azure-sdk-for-java/commit/287cfaeca092aace0ca426447a3dea4fca098e31", "message": "Resolve conflicts form master", "committedDate": "2020-12-04T08:36:42Z", "type": "commit"}, {"oid": "c7df70776c0b9f6249c46be27a8b0efbfc525220", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c7df70776c0b9f6249c46be27a8b0efbfc525220", "message": "Fix conflicts", "committedDate": "2020-12-04T09:02:33Z", "type": "commit"}, {"oid": "9ceea5c59681497d7c2456ad1581b5514f4dd81e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9ceea5c59681497d7c2456ad1581b5514f4dd81e", "message": "fix AADOboAuClientRepo UT details", "committedDate": "2020-12-04T09:35:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNzIzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r536307230", "bodyText": "I'm not familiar with Spring Security - are you creating a ConfidentialClient application per request, or is one created at startup and then reused?", "author": "sangonzal", "createdAt": "2020-12-04T18:50:34Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java", "diffHunk": "@@ -0,0 +1,135 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IClientSecret;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import com.microsoft.aad.msal4j.UserAssertion;\n+import com.nimbusds.jwt.JWT;\n+import com.nimbusds.jwt.JWTParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AbstractOAuth2Token;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.security.oauth2.server.resource.authentication.AbstractOAuth2TokenAuthenticationToken;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.net.MalformedURLException;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+public class AADOAuth2OboAuthorizedClientRepository implements OAuth2AuthorizedClientRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(AADOAuth2OboAuthorizedClientRepository.class);\n+\n+    private final AzureClientRegistrationRepository azureClientRegistrationRepository;\n+\n+    private Map<String, ConfidentialClientApplication> confidentialClientApplicationMap = new HashMap<>();\n+\n+    public AADOAuth2OboAuthorizedClientRepository(AzureClientRegistrationRepository azureClientRegistrationRepository) {\n+        this.azureClientRegistrationRepository = azureClientRegistrationRepository;\n+        Iterator<ClientRegistration> iterator = azureClientRegistrationRepository.iterator();\n+        while (iterator.hasNext()) {\n+            ClientRegistration next = iterator.next();\n+            this.confidentialClientApplicationMap.put(next.getClientId(), createApp(next));\n+        }\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public <T extends OAuth2AuthorizedClient> T loadAuthorizedClient(String registrationId,\n+                                                                     Authentication authentication,\n+                                                                     HttpServletRequest request) {\n+        try {\n+            ClientRegistration clientRegistration = azureClientRegistrationRepository\n+                .findByRegistrationId(registrationId);\n+\n+            AbstractOAuth2TokenAuthenticationToken<AbstractOAuth2Token> authenticationToken =\n+                (AbstractOAuth2TokenAuthenticationToken)\n+                    authentication;\n+\n+            String accessToken = authenticationToken.getToken().getTokenValue();\n+\n+            OnBehalfOfParameters parameters = OnBehalfOfParameters\n+                .builder(clientRegistration.getScopes(), new UserAssertion(accessToken))\n+                .build();\n+\n+            ConfidentialClientApplication clientApplication = confidentialClientApplicationMap.get(clientRegistration", "originalCommit": "9ceea5c59681497d7c2456ad1581b5514f4dd81e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk5MDE2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r537990165", "bodyText": "It's created at startup and cached in the map for reusing.", "author": "saragluna", "createdAt": "2020-12-08T02:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNzIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3MzM0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r541273343", "bodyText": "Keep in mind that even though you are not using the token cache, MSAL stores tokens into an in-memory cache by default. If the ConfidentialClientApplication is reused across thousands of users (or more), the tokens for these users will be always be in the cache.\nIf you then actually plan on using the token cache, this will be a problem, as the look up logic for tokens runs in linear time. Therefore, it is recommended that you create a ConfidentialClientApplication (and therefore cache) per user.", "author": "sangonzal", "createdAt": "2020-12-11T20:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNzIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIzNTkyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r542235923", "bodyText": "Thanks for the reminder, is there a way to disable the auto-creation of the MSAL token cache? As we're not going to use MSAL token cache, the action of caching the ConfidentialClientApplication could be a memory problem. Will the token stored in memory expire ever?", "author": "saragluna", "createdAt": "2020-12-14T09:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNzIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ4NTIxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r543485210", "bodyText": "@saragluna Unfortunately there is no way to disable auto-creation of the MSAL token cache. It is highly recommended that customers use cached tokens for many reasons, including end-user experience, developer experience, as well as to reduce load on AAD service.\nTokens stored in cache due expire, but are not evicted (expired tokens will remain in the cache, unless you remove them, by calling RemoveAccounts). If you use the acquireTokenSilent API, MSAL automatically takes care of refreshing the expired tokens for you.", "author": "sangonzal", "createdAt": "2020-12-15T16:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNzIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMzMjc1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r544332751", "bodyText": "@sangonzal thanks for the detailed explanation. Since in our web API case, the application would mostly be sessionless, so we're not using the session to cache token. With your explanation, I'm thinking of three ways to handle the MSAL token cache:\n\n\n\n\nPros\nCons\n\n\n\n\nCreate ConfidentialClientApplication for each request and call acquireToken()\n- No need to worry about the memory problem.\n- The cost of construct the object.  - The cost of acquiring a token each time.\n\n\nCache the ConfidentialClientApplication at the application level and call acquireToken()\n- Save the cost of constructing ConfidentialClientApplication  at each request.\n- All tokens acquired within the application lifecycle will be cached in the MSAL token cache\n\n\nCache the ConfidentialClientApplication at the application level and call acquireTokenSilent\n- Save the cost to acquire token each time. - Automatically refresh tokens.  - Save the cost of constructing ConfidentialClientApplication  at each request.\n- All tokens will be cached in memory  - Code is not self-explanatory (need to perform obo first, check this)\n\n\n\nBut one of my concerns is considering the distributing nature of Web API, what's the benefit of caching the token in the application? Which solution do you prefer among these three, or do you have other suggestions?", "author": "saragluna", "createdAt": "2020-12-16T14:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNzIzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMTM1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r536311350", "bodyText": "You're not leveraging the MSAL Token cache here. Every time you need to get a token, you'll make a call to AAD, even if you have a valid cached token. If you want to use the MSAL token cache, we have a sample that shows how you can use the token cache with OBO:", "author": "sangonzal", "createdAt": "2020-12-04T18:57:30Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java", "diffHunk": "@@ -0,0 +1,135 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IClientSecret;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import com.microsoft.aad.msal4j.UserAssertion;\n+import com.nimbusds.jwt.JWT;\n+import com.nimbusds.jwt.JWTParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AbstractOAuth2Token;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.security.oauth2.server.resource.authentication.AbstractOAuth2TokenAuthenticationToken;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.net.MalformedURLException;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+public class AADOAuth2OboAuthorizedClientRepository implements OAuth2AuthorizedClientRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(AADOAuth2OboAuthorizedClientRepository.class);\n+\n+    private final AzureClientRegistrationRepository azureClientRegistrationRepository;\n+\n+    private Map<String, ConfidentialClientApplication> confidentialClientApplicationMap = new HashMap<>();\n+\n+    public AADOAuth2OboAuthorizedClientRepository(AzureClientRegistrationRepository azureClientRegistrationRepository) {\n+        this.azureClientRegistrationRepository = azureClientRegistrationRepository;\n+        Iterator<ClientRegistration> iterator = azureClientRegistrationRepository.iterator();\n+        while (iterator.hasNext()) {\n+            ClientRegistration next = iterator.next();\n+            this.confidentialClientApplicationMap.put(next.getClientId(), createApp(next));\n+        }\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public <T extends OAuth2AuthorizedClient> T loadAuthorizedClient(String registrationId,\n+                                                                     Authentication authentication,\n+                                                                     HttpServletRequest request) {\n+        try {\n+            ClientRegistration clientRegistration = azureClientRegistrationRepository\n+                .findByRegistrationId(registrationId);\n+\n+            AbstractOAuth2TokenAuthenticationToken<AbstractOAuth2Token> authenticationToken =\n+                (AbstractOAuth2TokenAuthenticationToken)\n+                    authentication;\n+\n+            String accessToken = authenticationToken.getToken().getTokenValue();\n+\n+            OnBehalfOfParameters parameters = OnBehalfOfParameters\n+                .builder(clientRegistration.getScopes(), new UserAssertion(accessToken))\n+                .build();\n+\n+            ConfidentialClientApplication clientApplication = confidentialClientApplicationMap.get(clientRegistration\n+                .getClientId());\n+\n+            String oboAccessToken = clientApplication.acquireToken(parameters).get().accessToken();", "originalCommit": "9ceea5c59681497d7c2456ad1581b5514f4dd81e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk5MDkwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r537990900", "bodyText": "We'll not bring the MSAL token cache in this case, since the MSAL token cache is stored in the session. However, we're implementing this OBO function targeting resource servers, which could be stateless and disable session. We'll store the token in the request level, and it will be introduced in another PR.", "author": "saragluna", "createdAt": "2020-12-08T02:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMTM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ4MzQ0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r543483448", "bodyText": "@saragluna Can go a bit more into how you plan on storing the token at the request elvel? Are you storing both the access token and the refresh token?", "author": "sangonzal", "createdAt": "2020-12-15T16:15:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMTM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMzNDEyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r544334127", "bodyText": "This is how we store the token in request level:\n\nSaving the token\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java#L102\nRetrieving the token\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java#L62-L64", "author": "saragluna", "createdAt": "2020-12-16T14:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMTM1MA=="}], "type": "inlineReview"}, {"oid": "1021dcc8e8e52e7f76f3f5e1ad0c711203787eff", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1021dcc8e8e52e7f76f3f5e1ad0c711203787eff", "message": "Add sample README.md", "committedDate": "2020-12-08T01:44:27Z", "type": "commit"}, {"oid": "cda9379708c7f053c3dec5fa4d8124146685604b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cda9379708c7f053c3dec5fa4d8124146685604b", "message": "create AADOboAuClientRepo ut", "committedDate": "2020-12-08T02:02:19Z", "type": "commit"}, {"oid": "e04c789066663f49fbf4c174df3f5e4bbc4ee669", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e04c789066663f49fbf4c174df3f5e4bbc4ee669", "message": "Refactor AADOboAuClientRepo ut", "committedDate": "2020-12-08T02:40:51Z", "type": "commit"}, {"oid": "23e5ee67baf5afced089a30472fca93a749eeaa9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/23e5ee67baf5afced089a30472fca93a749eeaa9", "message": "refactor UTs", "committedDate": "2020-12-08T03:41:54Z", "type": "commit"}, {"oid": "764196f818a6385e9423a342738aa05e6f0e347e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/764196f818a6385e9423a342738aa05e6f0e347e", "message": "- add request level cache for OAuth2AuthorizedClient\n- code format", "committedDate": "2020-12-08T07:03:04Z", "type": "commit"}, {"oid": "3e31b1b9f415a4ec52554926aad2e0768417738b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3e31b1b9f415a4ec52554926aad2e0768417738b", "message": "obo config ut", "committedDate": "2020-12-08T08:26:22Z", "type": "commit"}, {"oid": "c4f36df2309c4a5d87461d77c3182ff801271935", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c4f36df2309c4a5d87461d77c3182ff801271935", "message": "delete old obo sample in ci and add 'unchecked' to repo ut", "committedDate": "2020-12-08T09:42:58Z", "type": "commit"}, {"oid": "8e76c4027dc80f0d9078ad05cc88368b33084b44", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8e76c4027dc80f0d9078ad05cc88368b33084b44", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java into obo-flow-repo", "committedDate": "2020-12-08T09:44:42Z", "type": "commit"}, {"oid": "b0b96f7a96dcdfbd7f1c6265442f30e67fb2a119", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b0b96f7a96dcdfbd7f1c6265442f30e67fb2a119", "message": "Merge remote-tracking branch 'jackwu/obo-flow-repo' into obo-flow-repo", "committedDate": "2020-12-08T09:46:07Z", "type": "commit"}, {"oid": "ab7d21ea1924e7192127fb0ef5ef3c6b151813f9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ab7d21ea1924e7192127fb0ef5ef3c6b151813f9", "message": "Fix building issues", "committedDate": "2020-12-08T09:57:43Z", "type": "commit"}, {"oid": "21ffdee65317709a63f6cd1484ea9f0e23715424", "url": "https://github.com/Azure/azure-sdk-for-java/commit/21ffdee65317709a63f6cd1484ea9f0e23715424", "message": "Remove unused class", "committedDate": "2020-12-09T01:28:40Z", "type": "commit"}, {"oid": "889f9773c2cafd6fbefb1fe4c1b0cb17a23169de", "url": "https://github.com/Azure/azure-sdk-for-java/commit/889f9773c2cafd6fbefb1fe4c1b0cb17a23169de", "message": "Merge branch 'obo-flow-repo' of github.com:wujack778/azure-sdk-for-java into obo-flow-repo", "committedDate": "2020-12-09T02:35:04Z", "type": "commit"}, {"oid": "78344f396a7d21967c9eafbb8e297652dd4e8f92", "url": "https://github.com/Azure/azure-sdk-for-java/commit/78344f396a7d21967c9eafbb8e297652dd4e8f92", "message": "- checkStyle code format", "committedDate": "2020-12-09T02:47:21Z", "type": "commit"}, {"oid": "90427b491e83bacc906ea069f2d3d2c2acc466f1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/90427b491e83bacc906ea069f2d3d2c2acc466f1", "message": "Merge branch 'master' of git://github.com/Azure/azure-sdk-for-java into obo-flow-repo", "committedDate": "2020-12-09T03:11:42Z", "type": "commit"}, {"oid": "9c29ac9454484c27e60e8098a1096b045fdfebb9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9c29ac9454484c27e60e8098a1096b045fdfebb9", "message": "Merge remote-tracking branch 'origin/obo-flow-repo' into obo-flow-repo", "committedDate": "2020-12-09T03:13:01Z", "type": "commit"}, {"oid": "faf298607eb83795670d6aa85b34be92a18577a9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/faf298607eb83795670d6aa85b34be92a18577a9", "message": "code refactor", "committedDate": "2020-12-09T08:18:11Z", "type": "commit"}, {"oid": "fbf12761f138cdd73bafb121e2cc7bee526e3ea0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fbf12761f138cdd73bafb121e2cc7bee526e3ea0", "message": "checkstyle error fix", "committedDate": "2020-12-09T08:45:20Z", "type": "commit"}, {"oid": "6d0adb9edb38b95dd8756a7a13503de45617f1d7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6d0adb9edb38b95dd8756a7a13503de45617f1d7", "message": "Merge remote-tracking branch 'origin/obo-flow-repo' into obo-flow-repo", "committedDate": "2020-12-09T08:53:51Z", "type": "commit"}, {"oid": "c26840302da50123bd0a818c64ef7c515fab8d2d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c26840302da50123bd0a818c64ef7c515fab8d2d", "message": "Add enabled switch for web application and resource server scenario; fix building error", "committedDate": "2020-12-09T10:43:08Z", "type": "commit"}, {"oid": "e34256a18dc18fb61bc3941cd66467cfa5202033", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e34256a18dc18fb61bc3941cd66467cfa5202033", "message": "Merge remote-tracking branch 'origin/obo-flow-repo' into obo-flow-repo", "committedDate": "2020-12-09T10:44:20Z", "type": "commit"}, {"oid": "ef58b3fac0c1260c3851dca399c17c989ddd35bc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ef58b3fac0c1260c3851dca399c17c989ddd35bc", "message": "fix AzureActiveDirectoryConfigurationTest failure and delete Additional imported packages", "committedDate": "2020-12-10T02:53:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwMzYzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539803632", "bodyText": "Why do we create this in the configuration?", "author": "saragluna", "createdAt": "2020-12-10T02:48:07Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-resource-server-access-other-resources/src/main/java/com/azure/spring/sample/aad/configuration/AADSampleConfiguration.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.azure.spring.sample.aad.configuration;\n+\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProvider;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProviderBuilder;\n+import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;\n+import org.springframework.security.oauth2.client.web.DefaultOAuth2AuthorizedClientManager;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.client.web.reactive.function.client.ServletOAuth2AuthorizedClientExchangeFilterFunction;\n+import org.springframework.web.reactive.function.client.WebClient;\n+\n+@Configuration\n+public class AADSampleConfiguration {\n+\n+    @Bean\n+    public OAuth2AuthorizedClientManager authorizedClientManager(", "originalCommit": "c26840302da50123bd0a818c64ef7c515fab8d2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MzMwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539853309", "bodyText": "it's only for constructing WebClient bean, the web client is convenient to call the corresponding APIs.", "author": "moarychan", "createdAt": "2020-12-10T05:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwMzYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2MTc3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539861772", "bodyText": "Can we get this from the spring context?", "author": "saragluna", "createdAt": "2020-12-10T05:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwMzYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkyNDA4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539924083", "bodyText": "No,  there's no OAuth2AuthorizedClientManager bean in spring context, or we use ResTemplate instead.", "author": "moarychan", "createdAt": "2020-12-10T07:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwMzYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNDAyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539804026", "bodyText": "nit: refactor this to LOGGER", "author": "saragluna", "createdAt": "2020-12-10T02:49:28Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-resource-server-access-other-resources/src/main/java/com/azure/spring/sample/aad/controller/SampleController.java", "diffHunk": "@@ -0,0 +1,112 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.sample.aad.controller;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.context.SecurityContextHolder;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.annotation.RegisteredOAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+import org.springframework.web.context.request.RequestAttributes;\n+import org.springframework.web.context.request.RequestContextHolder;\n+import org.springframework.web.context.request.ServletRequestAttributes;\n+import org.springframework.web.reactive.function.client.WebClient;\n+\n+import static org.springframework.security.oauth2.client.web.reactive.function.client.ServletOAuth2AuthorizedClientExchangeFilterFunction.oauth2AuthorizedClient;\n+\n+@RestController\n+public class SampleController {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(SampleController.class);", "originalCommit": "c26840302da50123bd0a818c64ef7c515fab8d2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNDgxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539804812", "bodyText": "Is there a way to make this more concise?\nhttp.authorizeRequests()\n    .anyRequest().authenticated()", "author": "saragluna", "createdAt": "2020-12-10T02:51:43Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-resource-server-access-other-resources/src/main/java/com/azure/spring/sample/aad/security/AADSampleSecurityConfiguration.java", "diffHunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.sample.aad.security;\n+\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.config.annotation.web.configurers.oauth2.server.resource.OAuth2ResourceServerConfigurer;\n+\n+@EnableWebSecurity(debug = false)\n+@EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)\n+public class AADSampleSecurityConfiguration extends WebSecurityConfigurerAdapter {\n+\n+    @Override\n+    protected void configure(HttpSecurity http) throws Exception {\n+\t\thttp.authorizeRequests((authorizeRequests) ->", "originalCommit": "c26840302da50123bd0a818c64ef7c515fab8d2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNjc3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539806779", "bodyText": "Are we only using this for the resource server case?", "author": "saragluna", "createdAt": "2020-12-10T02:57:15Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/ClientRegistrationInitialization.java", "diffHunk": "@@ -0,0 +1,113 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad;\n+\n+import com.azure.spring.aad.webapp.AuthorizationProperties;\n+import com.azure.spring.aad.webapp.AuthorizationServerEndpoints;\n+import com.azure.spring.aad.webapp.AzureClientRegistration;\n+import com.azure.spring.autoconfigure.aad.AADAuthenticationProperties;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.core.AuthorizationGrantType;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Client registration initialization based on AAD properties. Web application and resource server will quote.\n+ */\n+public class ClientRegistrationInitialization {", "originalCommit": "ef58b3fac0c1260c3851dca399c17c989ddd35bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MzUwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539843507", "bodyText": "If yes, we should move this to the webapi package.", "author": "saragluna", "createdAt": "2020-12-10T04:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNjc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1NDcyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539854720", "bodyText": "It will be a common component, not yet replace web app auto config side.", "author": "moarychan", "createdAt": "2020-12-10T05:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNjc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNzE2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539807162", "bodyText": "Please refactor this to LOGGER", "author": "saragluna", "createdAt": "2020-12-10T02:58:21Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java", "diffHunk": "@@ -0,0 +1,148 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IClientSecret;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import com.microsoft.aad.msal4j.UserAssertion;\n+import com.nimbusds.jwt.JWT;\n+import com.nimbusds.jwt.JWTParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AbstractOAuth2Token;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.security.oauth2.server.resource.authentication.AbstractOAuth2TokenAuthenticationToken;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.net.MalformedURLException;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+/**\n+ * <p>\n+ * AADOAuth2OboAuthorizedClientRepository\n+ * </p>\n+ */\n+public class AADOAuth2OboAuthorizedClientRepository implements OAuth2AuthorizedClientRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(AADOAuth2OboAuthorizedClientRepository.class);", "originalCommit": "ef58b3fac0c1260c3851dca399c17c989ddd35bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA0Mjk0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540042942", "bodyText": "done", "author": "wujack778", "createdAt": "2020-12-10T10:13:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNzE2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MjcxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539842711", "bodyText": "We should add more test cases for client registrations. We could run the context with more properties,\nxxx:\n  graph:\n     scopes: xxx\nto check whether does the graph client exist?", "author": "saragluna", "createdAt": "2020-12-10T04:48:39Z", "path": "sdk/spring/azure-spring-boot/src/test/java/com/azure/spring/aad/webapi/AzureActiveDirectoryResourceServerClientConfigurationTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import org.junit.Test;\n+import org.springframework.boot.test.context.FilteredClassLoader;\n+import org.springframework.boot.test.context.runner.WebApplicationContextRunner;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter;\n+import org.springframework.security.oauth2.server.resource.BearerTokenAuthenticationToken;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class AzureActiveDirectoryResourceServerClientConfigurationTest {\n+\n+    private static final String AAD_PROPERTY_PREFIX = \"azure.activedirectory.\";\n+\n+    private final WebApplicationContextRunner contextRunner = new WebApplicationContextRunner()\n+        .withPropertyValues(AAD_PROPERTY_PREFIX + \"user-group.allowed-groups=group1\",\n+            AAD_PROPERTY_PREFIX + \"tenant-id=fake-tenant-id\",\n+            AAD_PROPERTY_PREFIX + \"client-id=fake-client-id\",\n+            AAD_PROPERTY_PREFIX + \"client-secret=fake-client-secret\",\n+            AAD_PROPERTY_PREFIX + \"web-application.enabled=false\");\n+\n+    @Test\n+    public void testNotExistBearerTokenAuthenticationToken() {\n+        this.contextRunner\n+            .withUserConfiguration(AzureActiveDirectoryResourceServerClientConfiguration.class)\n+            .withClassLoader(new FilteredClassLoader(BearerTokenAuthenticationToken.class))\n+            .run(context -> {\n+                assertThat(context).doesNotHaveBean(\"AADOAuth2OboAuthorizedClientRepository\");\n+            });\n+    }\n+\n+    @Test\n+    public void testNotExistOAuth2LoginAuthenticationFilter() {\n+        this.contextRunner\n+            .withUserConfiguration(AzureActiveDirectoryResourceServerClientConfiguration.class)\n+            .withClassLoader(new FilteredClassLoader(OAuth2LoginAuthenticationFilter.class))\n+            .run(context -> {\n+                assertThat(context).doesNotHaveBean(\"AADOAuth2OboAuthorizedClientRepository\");\n+            });\n+    }\n+\n+    @Test\n+    public void testOAuth2AuthorizedClientRepository() {\n+        this.contextRunner\n+            .withUserConfiguration(AzureActiveDirectoryResourceServerClientConfiguration.class)\n+            .run(context -> {\n+                final OAuth2AuthorizedClientRepository aadOboRepo = context.getBean(\n+                    AADOAuth2OboAuthorizedClientRepository.class);\n+                assertThat(aadOboRepo).isNotNull();\n+                assertThat(aadOboRepo).isExactlyInstanceOf(AADOAuth2OboAuthorizedClientRepository.class);\n+            });\n+    }\n+\n+    @Test\n+    public void testClientRegistrationRepository() {", "originalCommit": "ef58b3fac0c1260c3851dca399c17c989ddd35bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1NTQ1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539855451", "bodyText": "Means more resource dependencies to test in the sample?", "author": "moarychan", "createdAt": "2020-12-10T05:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MjcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2MTYxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539861613", "bodyText": "I don't get this\n\nMeans more resource dependencies to test in the sample?", "author": "saragluna", "createdAt": "2020-12-10T05:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MjcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg4NjkzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r539886937", "bodyText": "I mean the sample should configure more clients to use more scopes scenario, right?", "author": "moarychan", "createdAt": "2020-12-10T06:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MjcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY1MjE3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540652175", "bodyText": "No, I'm just talking about the test cases.", "author": "saragluna", "createdAt": "2020-12-11T02:53:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MjcxMQ=="}], "type": "inlineReview"}, {"oid": "ddcf6d2b18c6d5bafe604c10a1466890e3bc7fca", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ddcf6d2b18c6d5bafe604c10a1466890e3bc7fca", "message": "Improve code according reviewer comments", "committedDate": "2020-12-10T06:34:24Z", "type": "commit"}, {"oid": "cdaa241788d14c30094db9033b10c3bc856f0de7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cdaa241788d14c30094db9033b10c3bc856f0de7", "message": "Improve code according reviewer comments", "committedDate": "2020-12-10T06:52:12Z", "type": "commit"}, {"oid": "aabc660cc884f44fe6706a84317ca5c46debb416", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aabc660cc884f44fe6706a84317ca5c46debb416", "message": "rename packageName in ci and 'LOG'", "committedDate": "2020-12-10T07:15:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5MjQ5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540692498", "bodyText": "Format these as:\nhttp.authorizeRequests()\n    .anyRequest().authenticated()\n    .and()\n    .oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt);", "author": "saragluna", "createdAt": "2020-12-11T05:02:22Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-resource-server-obo/src/main/java/com/azure/spring/sample/aad/security/AADSampleSecurityConfiguration.java", "diffHunk": "@@ -0,0 +1,23 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.sample.aad.security;\n+\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.config.annotation.web.configurers.oauth2.server.resource.OAuth2ResourceServerConfigurer;\n+\n+@EnableWebSecurity\n+@EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)\n+public class AADSampleSecurityConfiguration extends WebSecurityConfigurerAdapter {\n+\n+    @Override\n+    protected void configure(HttpSecurity http) throws Exception {\n+\t\thttp.authorizeRequests().anyRequest().authenticated()\n+            .and().oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt);\n+    }", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5Mzc4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540693789", "bodyText": "Should we add the type of authentication in the error message?", "author": "saragluna", "createdAt": "2020-12-11T05:06:55Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java", "diffHunk": "@@ -0,0 +1,148 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IClientSecret;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import com.microsoft.aad.msal4j.UserAssertion;\n+import com.nimbusds.jwt.JWT;\n+import com.nimbusds.jwt.JWTParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AbstractOAuth2Token;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.security.oauth2.server.resource.authentication.AbstractOAuth2TokenAuthenticationToken;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.net.MalformedURLException;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+/**\n+ * <p>\n+ * OAuth2AuthorizedClientRepository for obo flow\n+ * </p>\n+ */\n+public class AADOAuth2OboAuthorizedClientRepository implements OAuth2AuthorizedClientRepository {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADOAuth2OboAuthorizedClientRepository.class);\n+\n+    private static final String OBO_AUTHORIZEDCLIENT_PREFIX = \"obo_authorizedclient_\";\n+\n+    private final AzureClientRegistrationRepository azureClientRegistrationRepository;\n+\n+    private final Map<String, ConfidentialClientApplication> confidentialClientApplicationMap = new HashMap<>();\n+\n+    public AADOAuth2OboAuthorizedClientRepository(AzureClientRegistrationRepository azureClientRegistrationRepository) {\n+        this.azureClientRegistrationRepository = azureClientRegistrationRepository;\n+        Iterator<ClientRegistration> iterator = azureClientRegistrationRepository.iterator();\n+        while (iterator.hasNext()) {\n+            ClientRegistration next = iterator.next();\n+            this.confidentialClientApplicationMap.put(next.getRegistrationId(), createApp(next));\n+        }\n+    }\n+\n+    @Override\n+    @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n+    public <T extends OAuth2AuthorizedClient> T loadAuthorizedClient(String registrationId,\n+                                                                     Authentication authentication,\n+                                                                     HttpServletRequest request) {\n+        try {\n+            String oboAuthorizedClientAttributeName = OBO_AUTHORIZEDCLIENT_PREFIX + registrationId;\n+            if (request.getAttribute(oboAuthorizedClientAttributeName) != null) {\n+                return (T) request.getAttribute(oboAuthorizedClientAttributeName);\n+            }\n+\n+            if (!(authentication instanceof AbstractOAuth2TokenAuthenticationToken)) {\n+                throw new IllegalStateException(\"Not support token implementation\");", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NDc3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540694770", "bodyText": "change loadAuthorizedClient to load authorized client, better log the registrationId too in the error message", "author": "saragluna", "createdAt": "2020-12-11T05:10:18Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java", "diffHunk": "@@ -0,0 +1,148 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IClientSecret;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import com.microsoft.aad.msal4j.UserAssertion;\n+import com.nimbusds.jwt.JWT;\n+import com.nimbusds.jwt.JWTParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AbstractOAuth2Token;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.security.oauth2.server.resource.authentication.AbstractOAuth2TokenAuthenticationToken;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.net.MalformedURLException;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+/**\n+ * <p>\n+ * OAuth2AuthorizedClientRepository for obo flow\n+ * </p>\n+ */\n+public class AADOAuth2OboAuthorizedClientRepository implements OAuth2AuthorizedClientRepository {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADOAuth2OboAuthorizedClientRepository.class);\n+\n+    private static final String OBO_AUTHORIZEDCLIENT_PREFIX = \"obo_authorizedclient_\";\n+\n+    private final AzureClientRegistrationRepository azureClientRegistrationRepository;\n+\n+    private final Map<String, ConfidentialClientApplication> confidentialClientApplicationMap = new HashMap<>();\n+\n+    public AADOAuth2OboAuthorizedClientRepository(AzureClientRegistrationRepository azureClientRegistrationRepository) {\n+        this.azureClientRegistrationRepository = azureClientRegistrationRepository;\n+        Iterator<ClientRegistration> iterator = azureClientRegistrationRepository.iterator();\n+        while (iterator.hasNext()) {\n+            ClientRegistration next = iterator.next();\n+            this.confidentialClientApplicationMap.put(next.getRegistrationId(), createApp(next));\n+        }\n+    }\n+\n+    @Override\n+    @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n+    public <T extends OAuth2AuthorizedClient> T loadAuthorizedClient(String registrationId,\n+                                                                     Authentication authentication,\n+                                                                     HttpServletRequest request) {\n+        try {\n+            String oboAuthorizedClientAttributeName = OBO_AUTHORIZEDCLIENT_PREFIX + registrationId;\n+            if (request.getAttribute(oboAuthorizedClientAttributeName) != null) {\n+                return (T) request.getAttribute(oboAuthorizedClientAttributeName);\n+            }\n+\n+            if (!(authentication instanceof AbstractOAuth2TokenAuthenticationToken)) {\n+                throw new IllegalStateException(\"Not support token implementation\");\n+            }\n+            AbstractOAuth2TokenAuthenticationToken<AbstractOAuth2Token> authenticationToken =\n+                (AbstractOAuth2TokenAuthenticationToken) authentication;\n+            ClientRegistration clientRegistration =\n+                azureClientRegistrationRepository.findByRegistrationId(registrationId);\n+\n+            String accessToken = authenticationToken.getToken().getTokenValue();\n+            OnBehalfOfParameters parameters = OnBehalfOfParameters\n+                .builder(clientRegistration.getScopes(), new UserAssertion(accessToken))\n+                .build();\n+            ConfidentialClientApplication clientApplication =\n+                getClientApplication(clientRegistration.getRegistrationId());\n+            String oboAccessToken = clientApplication.acquireToken(parameters).get().accessToken();\n+\n+            JWT parser = JWTParser.parse(oboAccessToken);\n+            Date iat = (Date) parser.getJWTClaimsSet().getClaim(\"iat\");\n+            Date exp = (Date) parser.getJWTClaimsSet().getClaim(\"exp\");\n+            OAuth2AccessToken oAuth2AccessToken = new OAuth2AccessToken(OAuth2AccessToken.TokenType.BEARER,\n+                oboAccessToken,\n+                Instant.ofEpochMilli(iat.getTime()),\n+                Instant.ofEpochMilli(exp.getTime()));\n+\n+            OAuth2AuthorizedClient oAuth2AuthorizedClient = new OAuth2AuthorizedClient(clientRegistration,\n+                authenticationToken.getName(), oAuth2AccessToken);\n+\n+            request.setAttribute(oboAuthorizedClientAttributeName, (T) oAuth2AuthorizedClient);\n+            return (T) oAuth2AuthorizedClient;\n+        } catch (Throwable throwable) {\n+            LOGGER.error(\"Failed to loadAuthorizedClient\", throwable);", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NTA3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540695079", "bodyText": "Please remove these empty lines.", "author": "saragluna", "createdAt": "2020-12-11T05:11:19Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java", "diffHunk": "@@ -0,0 +1,148 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IClientSecret;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import com.microsoft.aad.msal4j.UserAssertion;\n+import com.nimbusds.jwt.JWT;\n+import com.nimbusds.jwt.JWTParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AbstractOAuth2Token;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.security.oauth2.server.resource.authentication.AbstractOAuth2TokenAuthenticationToken;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.net.MalformedURLException;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+/**\n+ * <p>\n+ * OAuth2AuthorizedClientRepository for obo flow\n+ * </p>\n+ */\n+public class AADOAuth2OboAuthorizedClientRepository implements OAuth2AuthorizedClientRepository {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADOAuth2OboAuthorizedClientRepository.class);\n+\n+    private static final String OBO_AUTHORIZEDCLIENT_PREFIX = \"obo_authorizedclient_\";\n+\n+    private final AzureClientRegistrationRepository azureClientRegistrationRepository;\n+\n+    private final Map<String, ConfidentialClientApplication> confidentialClientApplicationMap = new HashMap<>();\n+\n+    public AADOAuth2OboAuthorizedClientRepository(AzureClientRegistrationRepository azureClientRegistrationRepository) {\n+        this.azureClientRegistrationRepository = azureClientRegistrationRepository;\n+        Iterator<ClientRegistration> iterator = azureClientRegistrationRepository.iterator();\n+        while (iterator.hasNext()) {\n+            ClientRegistration next = iterator.next();\n+            this.confidentialClientApplicationMap.put(next.getRegistrationId(), createApp(next));\n+        }\n+    }\n+\n+    @Override\n+    @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n+    public <T extends OAuth2AuthorizedClient> T loadAuthorizedClient(String registrationId,\n+                                                                     Authentication authentication,\n+                                                                     HttpServletRequest request) {\n+        try {\n+            String oboAuthorizedClientAttributeName = OBO_AUTHORIZEDCLIENT_PREFIX + registrationId;\n+            if (request.getAttribute(oboAuthorizedClientAttributeName) != null) {\n+                return (T) request.getAttribute(oboAuthorizedClientAttributeName);\n+            }\n+\n+            if (!(authentication instanceof AbstractOAuth2TokenAuthenticationToken)) {\n+                throw new IllegalStateException(\"Not support token implementation\");\n+            }\n+            AbstractOAuth2TokenAuthenticationToken<AbstractOAuth2Token> authenticationToken =\n+                (AbstractOAuth2TokenAuthenticationToken) authentication;\n+            ClientRegistration clientRegistration =\n+                azureClientRegistrationRepository.findByRegistrationId(registrationId);\n+\n+            String accessToken = authenticationToken.getToken().getTokenValue();\n+            OnBehalfOfParameters parameters = OnBehalfOfParameters\n+                .builder(clientRegistration.getScopes(), new UserAssertion(accessToken))\n+                .build();\n+            ConfidentialClientApplication clientApplication =\n+                getClientApplication(clientRegistration.getRegistrationId());\n+            String oboAccessToken = clientApplication.acquireToken(parameters).get().accessToken();\n+\n+            JWT parser = JWTParser.parse(oboAccessToken);\n+            Date iat = (Date) parser.getJWTClaimsSet().getClaim(\"iat\");\n+            Date exp = (Date) parser.getJWTClaimsSet().getClaim(\"exp\");\n+            OAuth2AccessToken oAuth2AccessToken = new OAuth2AccessToken(OAuth2AccessToken.TokenType.BEARER,\n+                oboAccessToken,\n+                Instant.ofEpochMilli(iat.getTime()),\n+                Instant.ofEpochMilli(exp.getTime()));\n+\n+            OAuth2AuthorizedClient oAuth2AuthorizedClient = new OAuth2AuthorizedClient(clientRegistration,\n+                authenticationToken.getName(), oAuth2AccessToken);\n+\n+            request.setAttribute(oboAuthorizedClientAttributeName, (T) oAuth2AuthorizedClient);\n+            return (T) oAuth2AuthorizedClient;\n+        } catch (Throwable throwable) {\n+            LOGGER.error(\"Failed to loadAuthorizedClient\", throwable);\n+        }\n+        return null;\n+    }\n+\n+    @Override\n+    public void saveAuthorizedClient(OAuth2AuthorizedClient oAuth2AuthorizedClient, Authentication authentication,\n+                                     HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) {\n+    }\n+\n+    @Override\n+    public void removeAuthorizedClient(String s, Authentication authentication,\n+                                       HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) {\n+    }\n+\n+    ConfidentialClientApplication getClientApplication(String registrationId) {\n+        return confidentialClientApplicationMap.get(registrationId);\n+    }\n+\n+    private ConfidentialClientApplication createApp(ClientRegistration clientRegistration) {\n+\n+        String authorizationUri = clientRegistration.getProviderDetails().getAuthorizationUri();\n+\n+        String authority = interceptAuthorizationUri(authorizationUri);\n+", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NTkxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540695915", "bodyText": "If the application happens to fail being created, it will cause NPE when load the authorized client. Maybe we should check whether the client is null in loadauthorizedclient method.", "author": "saragluna", "createdAt": "2020-12-11T05:14:28Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepository.java", "diffHunk": "@@ -0,0 +1,148 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IClientSecret;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import com.microsoft.aad.msal4j.UserAssertion;\n+import com.nimbusds.jwt.JWT;\n+import com.nimbusds.jwt.JWTParser;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AbstractOAuth2Token;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.security.oauth2.server.resource.authentication.AbstractOAuth2TokenAuthenticationToken;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.net.MalformedURLException;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+/**\n+ * <p>\n+ * OAuth2AuthorizedClientRepository for obo flow\n+ * </p>\n+ */\n+public class AADOAuth2OboAuthorizedClientRepository implements OAuth2AuthorizedClientRepository {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AADOAuth2OboAuthorizedClientRepository.class);\n+\n+    private static final String OBO_AUTHORIZEDCLIENT_PREFIX = \"obo_authorizedclient_\";\n+\n+    private final AzureClientRegistrationRepository azureClientRegistrationRepository;\n+\n+    private final Map<String, ConfidentialClientApplication> confidentialClientApplicationMap = new HashMap<>();\n+\n+    public AADOAuth2OboAuthorizedClientRepository(AzureClientRegistrationRepository azureClientRegistrationRepository) {\n+        this.azureClientRegistrationRepository = azureClientRegistrationRepository;\n+        Iterator<ClientRegistration> iterator = azureClientRegistrationRepository.iterator();\n+        while (iterator.hasNext()) {\n+            ClientRegistration next = iterator.next();\n+            this.confidentialClientApplicationMap.put(next.getRegistrationId(), createApp(next));\n+        }\n+    }\n+\n+    @Override\n+    @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n+    public <T extends OAuth2AuthorizedClient> T loadAuthorizedClient(String registrationId,\n+                                                                     Authentication authentication,\n+                                                                     HttpServletRequest request) {\n+        try {\n+            String oboAuthorizedClientAttributeName = OBO_AUTHORIZEDCLIENT_PREFIX + registrationId;\n+            if (request.getAttribute(oboAuthorizedClientAttributeName) != null) {\n+                return (T) request.getAttribute(oboAuthorizedClientAttributeName);\n+            }\n+\n+            if (!(authentication instanceof AbstractOAuth2TokenAuthenticationToken)) {\n+                throw new IllegalStateException(\"Not support token implementation\");\n+            }\n+            AbstractOAuth2TokenAuthenticationToken<AbstractOAuth2Token> authenticationToken =\n+                (AbstractOAuth2TokenAuthenticationToken) authentication;\n+            ClientRegistration clientRegistration =\n+                azureClientRegistrationRepository.findByRegistrationId(registrationId);\n+\n+            String accessToken = authenticationToken.getToken().getTokenValue();\n+            OnBehalfOfParameters parameters = OnBehalfOfParameters\n+                .builder(clientRegistration.getScopes(), new UserAssertion(accessToken))\n+                .build();\n+            ConfidentialClientApplication clientApplication =\n+                getClientApplication(clientRegistration.getRegistrationId());\n+            String oboAccessToken = clientApplication.acquireToken(parameters).get().accessToken();\n+\n+            JWT parser = JWTParser.parse(oboAccessToken);\n+            Date iat = (Date) parser.getJWTClaimsSet().getClaim(\"iat\");\n+            Date exp = (Date) parser.getJWTClaimsSet().getClaim(\"exp\");\n+            OAuth2AccessToken oAuth2AccessToken = new OAuth2AccessToken(OAuth2AccessToken.TokenType.BEARER,\n+                oboAccessToken,\n+                Instant.ofEpochMilli(iat.getTime()),\n+                Instant.ofEpochMilli(exp.getTime()));\n+\n+            OAuth2AuthorizedClient oAuth2AuthorizedClient = new OAuth2AuthorizedClient(clientRegistration,\n+                authenticationToken.getName(), oAuth2AccessToken);\n+\n+            request.setAttribute(oboAuthorizedClientAttributeName, (T) oAuth2AuthorizedClient);\n+            return (T) oAuth2AuthorizedClient;\n+        } catch (Throwable throwable) {\n+            LOGGER.error(\"Failed to loadAuthorizedClient\", throwable);\n+        }\n+        return null;\n+    }\n+\n+    @Override\n+    public void saveAuthorizedClient(OAuth2AuthorizedClient oAuth2AuthorizedClient, Authentication authentication,\n+                                     HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) {\n+    }\n+\n+    @Override\n+    public void removeAuthorizedClient(String s, Authentication authentication,\n+                                       HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) {\n+    }\n+\n+    ConfidentialClientApplication getClientApplication(String registrationId) {\n+        return confidentialClientApplicationMap.get(registrationId);\n+    }\n+\n+    private ConfidentialClientApplication createApp(ClientRegistration clientRegistration) {\n+\n+        String authorizationUri = clientRegistration.getProviderDetails().getAuthorizationUri();\n+\n+        String authority = interceptAuthorizationUri(authorizationUri);\n+\n+        IClientSecret clientCredential = ClientCredentialFactory.createFromSecret(clientRegistration.getClientSecret());\n+        try {\n+            return ConfidentialClientApplication.builder(clientRegistration.getClientId(), clientCredential)\n+                                                .authority(authority)\n+                                                .build();\n+        } catch (MalformedURLException e) {\n+            LOGGER.error(\"Failed to create ConfidentialClientApplication\", e);\n+        }\n+        return null;", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NjMwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540696309", "bodyText": "Change back to use class detection as the condition here.", "author": "saragluna", "createdAt": "2020-12-11T05:15:58Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapi/AzureActiveDirectoryResourceServerClientConfiguration.java", "diffHunk": "@@ -0,0 +1,58 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.ClientRegistrationInitialization;\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.azure.spring.autoconfigure.aad.AADAuthenticationProperties;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnResource;\n+import org.springframework.boot.context.properties.EnableConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter;\n+import org.springframework.security.oauth2.server.resource.BearerTokenAuthenticationToken;\n+\n+/**\n+ * <p>\n+ * The configuration will not be activated if no {@link OAuth2LoginAuthenticationFilter} class provided.\n+ * </p>\n+ */\n+@Configuration(proxyBeanMethods = false)\n+@ConditionalOnResource(resources = \"classpath:aad.enable.config\")\n+@EnableConfigurationProperties({ AADAuthenticationProperties.class })\n+@ConditionalOnClass({BearerTokenAuthenticationToken.class, OAuth2LoginAuthenticationFilter.class})\n+@ConditionalOnProperty(prefix = \"azure.activedirectory.resource-server.obo\", name = \"enabled\", havingValue = \"true\")", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NjQ5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540696491", "bodyText": "same here", "author": "saragluna", "createdAt": "2020-12-11T05:16:33Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureActiveDirectoryConfiguration.java", "diffHunk": "@@ -36,6 +36,8 @@\n @Configuration\n @ConditionalOnClass(ClientRegistrationRepository.class)\n @EnableConfigurationProperties(AADAuthenticationProperties.class)\n+@ConditionalOnProperty(prefix = \"azure.activedirectory.resource-server.obo\",", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NjY4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540696681", "bodyText": "Please add a test case for loading a non-existing client.", "author": "saragluna", "createdAt": "2020-12-11T05:17:16Z", "path": "sdk/spring/azure-spring-boot/src/test/java/com/azure/spring/aad/webapi/AADOAuth2OboAuthorizedClientRepositoryTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapi;\n+\n+import com.azure.spring.aad.webapp.AzureClientRegistrationRepository;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.OnBehalfOfParameters;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.context.annotation.AnnotationConfigApplicationContext;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.jwt.Jwt;\n+import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.springframework.test.context.support.TestPropertySourceUtils.addInlinedPropertiesToEnvironment;\n+\n+public class AADOAuth2OboAuthorizedClientRepositoryTest {\n+\n+    private static final String OBO_ACCESS_TOKEN =\n+        \"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6ImtnMkxZczJUMENUaklmajRydDZKSXluZW4zOCIsImtpZCI6ImtnMkxZczJUMENUaklmajRydDZKSXluZW4zOCJ9.eyJhdWQiOiJhcGk6Ly9zYW1wbGUtY2xpZW50LWlkIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMWQxYTA2YTktYjIwYS00NTEzLThhNjQtZGFiMDhkMzJjOGI2LyIsImlhdCI6MTYwNzA3NTc1MiwibmJmIjoxNjA3MDc1NzUyLCJleHAiOjE2MDcwNzk2NTIsImFjciI6IjEiLCJhaW8iOiJBVFFBeS84UkFBQUFkSllKZkluaHhoWHBQTStVUVR0TmsrcnJnWG1FQmRpL0JhQWJUOGtQT2t1amJhQ2pBSTNBeUZWcnE0NGZHdHNOIiwiYW1yIjpbInB3ZCJdLCJhcHBpZCI6ImZmMzhjYjg2LTljMzgtNGUyMS1iZTY4LWM1ODFhNTVmYjVjMCIsImFwcGlkYWNyIjoiMSIsImZhbWlseV9uYW1lIjoiY2hlbiIsImdpdmVuX25hbWUiOiJhbXkiLCJpcGFkZHIiOiIxNjcuMjIwLjI1NS42OCIsIm5hbWUiOiJhbXkgY2hlbiIsIm9pZCI6ImFiZDI4ZGUxLTljMzctNDg5ZC04ZWVjLWZlZWVmNGQyNzRhMyIsInJoIjoiMC5BQUFBcVFZYUhRcXlFMFdLWk5xd2pUTEl0b2JMT1A4NG5DRk92bWpGZ2FWZnRjQjRBQUkuIiwic2NwIjoiUmVzb3VyY2VBY2Nlc3NDdXN0b21SZXNvdXJjZXMucmVhZCBSZXNvdXJjZUFjY2Vzc0dyYXBoLnJlYWQgUmVzb3VyY2VBY2Nlc3NPdGhlclJlc291cmNlcy5yZWFkIiwic3ViIjoiS0xyMXZFQTN3Wk1MdWFFZU1IUl80ZmdTdVVVVnNJWDhHREVlOWU5M1BPYyIsInRpZCI6IjFkMWEwNmE5LWIyMGEtNDUxMy04YTY0LWRhYjA4ZDMyYzhiNiIsInVuaXF1ZV9uYW1lIjoiYW15QG1vYXJ5Lm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6ImFteUBtb2FyeS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJFTG1xXzZVUkJFS19kN3I4ZlFJR0FBIiwidmVyIjoiMS4wIn0.fM_huHrr5M243oM3rMagGGckoxkLanFkurMJz4EBthrdQlFJzl6eo13pmU0Taq2ognAzsxUka0yihImrvhqzub9IGxRtCdQ3NAvD1fAiVdSUt_aBetIFCi5Pdc6I7KJDiGMQh8RTmduM7IOdxV_3-rug6dZXhW5TTmeq5PfLGYlrKOkC2za7M5G7gn7li1D5osh98HorFBWZoCDhe1iJPd_p_m0EffwTbKFwyvOGN-PKxyzOnoCOma_VYvRABUtBa8rNBFTaH5R9EAvsOmIZ_mI98Irl_8QNr9No-R0nXOrqKCFx5sMYkUuT7mvSaVPAlNr2X8eJjY3Wi-6ishufWQ\";\n+\n+    private static final String AAD_PROPERTY_PREFIX = \"azure.activedirectory.\";\n+\n+    private AzureClientRegistrationRepository clientRegistrationsRepo;\n+\n+    @BeforeEach\n+    public void setup() {\n+        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();\n+\n+        addInlinedPropertiesToEnvironment(\n+            context,\n+            AAD_PROPERTY_PREFIX + \"user-group.allowed-groups = group1\",\n+            AAD_PROPERTY_PREFIX + \"tenant-id = fake-tenant-id\",\n+            AAD_PROPERTY_PREFIX + \"client-id = fake-client-id\",\n+            AAD_PROPERTY_PREFIX + \"client-secret = fake-client-secret\",\n+            AAD_PROPERTY_PREFIX + \"authorization.fake-graph.scopes = https://graph.microsoft.com/.default\",\n+            AAD_PROPERTY_PREFIX + \"resource-server.obo.enabled = true\"\n+        );\n+        context.register(AzureActiveDirectoryResourceServerClientConfiguration.class);\n+        context.refresh();\n+\n+        clientRegistrationsRepo = context.getBean(AzureClientRegistrationRepository.class);\n+    }\n+\n+    @Test\n+    @SuppressWarnings(\"unchecked\")\n+    public void testLoadAzureAuthorizedClient() throws ExecutionException, InterruptedException {", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NjkzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540696936", "bodyText": "Why are we changing this?", "author": "saragluna", "createdAt": "2020-12-11T05:18:00Z", "path": "sdk/spring/azure-spring-boot/src/test/java/com/azure/spring/aad/webapp/AzureActiveDirectoryConfigurationTest.java", "diffHunk": "@@ -129,8 +129,9 @@ public void aadAwareClientRepository() {\n         assertTrue(clientRepo.isAuthzClient(\"graph\"));\n \n         List<ClientRegistration> clients = collectClients(clientRepo);\n-        assertEquals(1, clients.size());\n-        assertEquals(\"azure\", clients.get(0).getRegistrationId());\n+        assertEquals(2, clients.size());", "originalCommit": "aabc660cc884f44fe6706a84317ca5c46debb416", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5Njk5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r540696994", "bodyText": "Is it because we changed some logic?", "author": "saragluna", "createdAt": "2020-12-11T05:18:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NjkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA3ODY2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17901#discussion_r542078666", "bodyText": "yes \uff0cthere are two clients now.", "author": "wujack778", "createdAt": "2020-12-14T02:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NjkzNg=="}], "type": "inlineReview"}, {"oid": "ae2ed1c04c067b500fb837313788156d97a0929b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ae2ed1c04c067b500fb837313788156d97a0929b", "message": "- add test case\n- code refactor", "committedDate": "2020-12-11T07:41:38Z", "type": "commit"}, {"oid": "a7fd67158d572de9288e5ce167c9c5a6e242a439", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a7fd67158d572de9288e5ce167c9c5a6e242a439", "message": "Remove enabled switch for resource client usage; fix code smell", "committedDate": "2020-12-11T09:11:15Z", "type": "commit"}, {"oid": "655b081d85752c21a1a5fba071b5823718d3f951", "url": "https://github.com/Azure/azure-sdk-for-java/commit/655b081d85752c21a1a5fba071b5823718d3f951", "message": "Refactor ut in webapi", "committedDate": "2020-12-14T02:37:25Z", "type": "commit"}, {"oid": "e91c92d04c799d2f059f4191bc1b11325ccc053a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e91c92d04c799d2f059f4191bc1b11325ccc053a", "message": "When used as Resource Server or Web Application, suppress compatibility properties validation", "committedDate": "2020-12-14T05:43:36Z", "type": "commit"}, {"oid": "bd0604548d319b1df073302a60f4973a8397be0d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bd0604548d319b1df073302a60f4973a8397be0d", "message": "- refactor test case", "committedDate": "2020-12-14T05:58:28Z", "type": "commit"}, {"oid": "2627e39ee3999303e6d3af51c0e84db13e4865d0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2627e39ee3999303e6d3af51c0e84db13e4865d0", "message": "merge branch master of Azure", "committedDate": "2020-12-14T05:58:29Z", "type": "commit"}, {"oid": "df2c38d5063ad08b888863eb8734ec42084bee47", "url": "https://github.com/Azure/azure-sdk-for-java/commit/df2c38d5063ad08b888863eb8734ec42084bee47", "message": "Merge branch 'obo-flow-repo' of github.com:wujack778/azure-sdk-for-java into obo-flow-repo", "committedDate": "2020-12-14T06:00:00Z", "type": "commit"}, {"oid": "c576f6c1ddbf70b31893f745469f35baebf08539", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c576f6c1ddbf70b31893f745469f35baebf08539", "message": "Merge remote-tracking branch 'jackwu/obo-flow-repo' into obo-flow-repo", "committedDate": "2020-12-14T06:00:43Z", "type": "commit"}, {"oid": "93fd7889839374881161cb4e3645f41e751c8b15", "url": "https://github.com/Azure/azure-sdk-for-java/commit/93fd7889839374881161cb4e3645f41e751c8b15", "message": "add 'unchecked' on oboTest", "committedDate": "2020-12-14T06:25:40Z", "type": "commit"}, {"oid": "3652584c0d818ad8983d57d57e8bc15ed1ef513e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3652584c0d818ad8983d57d57e8bc15ed1ef513e", "message": "Remove OAuth2ClientPropertiesBeanPostProcessor class", "committedDate": "2020-12-14T08:10:21Z", "type": "commit"}, {"oid": "a1a3fb26c7578b051257cf948b16243fc070563d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a1a3fb26c7578b051257cf948b16243fc070563d", "message": "Merge remote-tracking branch 'jackwu/obo-flow-repo' into obo-flow-repo", "committedDate": "2020-12-14T08:11:02Z", "type": "commit"}, {"oid": "39b089b8bed4c1f90b360a3dc9d2acbb160b2d65", "url": "https://github.com/Azure/azure-sdk-for-java/commit/39b089b8bed4c1f90b360a3dc9d2acbb160b2d65", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java into obo-flow-repo", "committedDate": "2020-12-15T02:16:52Z", "type": "commit"}, {"oid": "1e68ca72c94dd171de960993305f1cce81b42915", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1e68ca72c94dd171de960993305f1cce81b42915", "message": "limit telemetry coverage", "committedDate": "2020-12-15T02:18:45Z", "type": "commit"}]}