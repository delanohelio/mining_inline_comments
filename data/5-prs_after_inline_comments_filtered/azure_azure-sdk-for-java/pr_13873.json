{"pr_number": 13873, "pr_title": "Settle delivered messages on AMQP receive link", "pr_createdAt": "2020-08-07T12:22:04Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13873", "timeline": [{"oid": "f2fa98903a60997212bec45e063bc5c0c5483eff", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f2fa98903a60997212bec45e063bc5c0c5483eff", "message": "Settle delivered messaged on AMQP receive link", "committedDate": "2020-08-07T12:10:46Z", "type": "commit"}, {"oid": "e6cbb366a9543f696f289b38e592ef129f28a172", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e6cbb366a9543f696f289b38e592ef129f28a172", "message": "Fix warning", "committedDate": "2020-08-07T17:43:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyMzc1OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873#discussion_r467223759", "bodyText": "I was curious why we do decoding here? Does this break service bus? iirc, SB keeps track of deliveries when they are not in receive and delete mode to understand which ones to hold onto and when a user performs a settlement method on it, will then settle that delivery.", "author": "conniey", "createdAt": "2020-08-07T19:14:25Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/handler/ReceiveLinkHandler.java", "diffHunk": "@@ -17,28 +19,31 @@\n \n public class ReceiveLinkHandler extends LinkHandler {\n     private final String linkName;\n+    private final Function<Delivery, Message> deliveryDecoder;\n     private AtomicBoolean isFirstResponse = new AtomicBoolean(true);\n-    private final DirectProcessor<Delivery> deliveries;\n-    private FluxSink<Delivery> deliverySink;\n+    private final DirectProcessor<Message> messages;\n+    private FluxSink<Message> messageSink;\n \n-    public ReceiveLinkHandler(String connectionId, String hostname, String linkName, String entityPath) {\n+    public ReceiveLinkHandler(String connectionId, String hostname, String linkName, String entityPath,\n+        Function<Delivery, Message> deliveryDecoder) {\n         super(connectionId, hostname, entityPath, new ClientLogger(ReceiveLinkHandler.class));\n-        this.deliveries = DirectProcessor.create();\n-        this.deliverySink = deliveries.sink(FluxSink.OverflowStrategy.BUFFER);\n+        this.messages = DirectProcessor.create();\n+        this.messageSink = messages.sink(FluxSink.OverflowStrategy.BUFFER);\n         this.linkName = linkName;\n+        this.deliveryDecoder = deliveryDecoder;\n     }\n \n     public String getLinkName() {\n         return linkName;\n     }\n \n-    public Flux<Delivery> getDeliveredMessages() {\n-        return deliveries;\n+    public Flux<Message> getDeliveredMessages() {", "originalCommit": "e6cbb366a9543f696f289b38e592ef129f28a172", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e955f73c89e8ab48950dd2edaf069fd4fd4b63f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0e955f73c89e8ab48950dd2edaf069fd4fd4b63f", "message": "Fix unit tests", "committedDate": "2020-08-07T19:20:50Z", "type": "commit"}, {"oid": "d32c32bc1413515597b2870a119d8802ec031e47", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d32c32bc1413515597b2870a119d8802ec031e47", "message": "Update add link credits condition", "committedDate": "2020-08-07T20:57:04Z", "type": "commit"}, {"oid": "15b11e814d77b3852400d7414f56af179b0d8568", "url": "https://github.com/Azure/azure-sdk-for-java/commit/15b11e814d77b3852400d7414f56af179b0d8568", "message": "Remove unused imports", "committedDate": "2020-08-07T21:29:37Z", "type": "commit"}, {"oid": "3d0d88f25f76b08b316c1bcfde8ea81c91b08d93", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3d0d88f25f76b08b316c1bcfde8ea81c91b08d93", "message": "Fix indentation", "committedDate": "2020-08-07T22:19:26Z", "type": "commit"}, {"oid": "132b702b6d53d809315579e85ecdbd0d5cb8b8c1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/132b702b6d53d809315579e85ecdbd0d5cb8b8c1", "message": "Set disposition state to abandon before settling a delivery", "committedDate": "2020-08-11T08:41:20Z", "type": "commit"}, {"oid": "8ca908229cbee92b13235d5b7878452886bafd86", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ca908229cbee92b13235d5b7878452886bafd86", "message": "Merge branch 'master' into amqp-settle-message", "committedDate": "2020-08-11T18:47:01Z", "type": "commit"}]}