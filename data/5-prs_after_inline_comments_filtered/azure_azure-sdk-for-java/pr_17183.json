{"pr_number": 17183, "pr_title": "Added support for key export.", "pr_createdAt": "2020-11-04T22:43:21Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17183", "timeline": [{"oid": "5117bd98d8729975217bb7eae349ae119576405f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5117bd98d8729975217bb7eae349ae119576405f", "message": "Added support for exporting keys from an Azure Key Vault.", "committedDate": "2020-11-04T22:31:44Z", "type": "commit"}, {"oid": "6ca8083392497a466e74c8584cc34ba2e645e83c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6ca8083392497a466e74c8584cc34ba2e645e83c", "message": "Removed ExportKeyOptions.", "committedDate": "2020-11-04T22:41:14Z", "type": "commit"}, {"oid": "245304177be4a2bd2d0d4aa4d4de62620b41d0cf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/245304177be4a2bd2d0d4aa4d4de62620b41d0cf", "message": "Fixed build error.", "committedDate": "2020-11-05T07:35:41Z", "type": "commit"}, {"oid": "78aed4e478fe5efc436361f205c731648bb25ed0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/78aed4e478fe5efc436361f205c731648bb25ed0", "message": "Added samples.", "committedDate": "2020-11-05T08:18:28Z", "type": "commit"}, {"oid": "05ad9d3c8d715dedbdc8915c1cfa9ae006b3a449", "url": "https://github.com/Azure/azure-sdk-for-java/commit/05ad9d3c8d715dedbdc8915c1cfa9ae006b3a449", "message": "Fixed test issues.", "committedDate": "2020-11-05T08:30:57Z", "type": "commit"}, {"oid": "a1c0f4edd3aa1226a0476c0533e3b239d6e72b3a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a1c0f4edd3aa1226a0476c0533e3b239d6e72b3a", "message": "Fixed samples issues.", "committedDate": "2020-11-05T08:46:36Z", "type": "commit"}, {"oid": "73dd7654da488a5b4a7ba28e3b604bd9b9df3b42", "url": "https://github.com/Azure/azure-sdk-for-java/commit/73dd7654da488a5b4a7ba28e3b604bd9b9df3b42", "message": "Fixed checkstyle issues.", "committedDate": "2020-11-05T10:10:02Z", "type": "commit"}, {"oid": "4f594cb5994168c5264fa59521b12ea3f4a77bdd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4f594cb5994168c5264fa59521b12ea3f4a77bdd", "message": "Fixed spotbugs issues.", "committedDate": "2020-11-05T10:56:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ4MTgxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r518481811", "bodyText": "Was this missing from previous versions?", "author": "heaths", "createdAt": "2020-11-06T02:07:37Z", "path": "sdk/keyvault/azure-security-keyvault-keys/src/main/java/com/azure/security/keyvault/keys/KeyRequestAttributes.java", "diffHunk": "@@ -74,6 +76,12 @@\n     @JsonProperty(value = \"updated\", access = JsonProperty.Access.WRITE_ONLY)\n     private Long updated;\n \n+    /**\n+     * Indicates if the private key can be exported.\n+     */\n+    @JsonProperty(value = \"exportable\")\n+    private Boolean exportable;", "originalCommit": "4f594cb5994168c5264fa59521b12ea3f4a77bdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ5NTk0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r518495944", "bodyText": "I added the exportable property to a few places based on the new swagger. I don't think it was supposed to be there before.", "author": "vcolin7", "createdAt": "2020-11-06T02:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ4MTgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2OTkxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r519069919", "bodyText": "Version is not actually required, but you send it as an empty string? Wouldn't null make more sense, or is that not idiomatic with Java? If null is okay, I wouldn't validate that it's non-null in the overload. If they use that one and still pass null, it should be as acceptable as calling this overload.", "author": "heaths", "createdAt": "2020-11-07T00:42:25Z", "path": "sdk/keyvault/azure-security-keyvault-keys/src/main/java/com/azure/security/keyvault/keys/KeyAsyncClient.java", "diffHunk": "@@ -492,14 +496,108 @@ Duration getDefaultPollingInterval() {\n         KeyImportRequestParameters parameters = new KeyImportRequestParameters()\n             .setKey(importKeyOptions.getKey())\n             .setHsm(importKeyOptions.isHardwareProtected())\n-            .setKeyAttributes(new KeyRequestAttributes(importKeyOptions));\n+            .setKeyAttributes(new KeyRequestAttributes(importKeyOptions))\n+            .setKeyReleasePolicy(importKeyOptions.getKeyReleasePolicy());\n         return service.importKey(vaultUrl, importKeyOptions.getName(), apiVersion, ACCEPT_LANGUAGE, parameters,\n             CONTENT_TYPE_HEADER_VALUE, context.addData(AZ_TRACING_NAMESPACE_KEY, KEYVAULT_TRACING_NAMESPACE_VALUE))\n             .doOnRequest(ignored -> logger.info(\"Importing key - {}\", importKeyOptions.getName()))\n             .doOnSuccess(response -> logger.info(\"Imported key - {}\", response.getValue().getName()))\n             .doOnError(error -> logger.warning(\"Failed to import key - {}\", importKeyOptions.getName(), error));\n     }\n \n+    /**\n+     * Exports the latest version of a key from the key vault. The export key operation may be used to import any key\n+     * from the Azure Key Vault as long as it is marked as exportable and its release policy is satisfied.\n+     *\n+     * <p><strong>Code Samples</strong></p>\n+     * <p>Exports a key from a key vault. Subscribes to the call asynchronously and prints out the newly exported key\n+     * details when a response has been received.</p>\n+     *\n+     * {@codesnippet com.azure.security.keyvault.keys.keyasyncclient.exportKey#String-String}\n+     *\n+     * @param name The name of the key to be exported.\n+     * @param environment The target environment assertion.\n+     * @return A {@link Mono} containing the {@link KeyVaultKey exported key}.\n+     * @throws NullPointerException If the specified {@code name} or {@code environment} are {@code null}.\n+     */\n+    @ServiceMethod(returns = ReturnType.SINGLE)\n+    public Mono<KeyVaultKey> exportKey(String name, String environment) {\n+        try {\n+            return exportKeyWithResponse(name, \"\", environment).flatMap(FluxUtil::toMono);", "originalCommit": "4f594cb5994168c5264fa59521b12ea3f4a77bdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4Njc5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r519086799", "bodyText": "Since it's a part of the path I thought it would be required. Is calling keys/{key-name}/export equivalent to calling keys/{key-name}/{key-version}/export with the latest key version?", "author": "vcolin7", "createdAt": "2020-11-07T03:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2OTkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2NTI0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r519465249", "bodyText": "Yes. I asked about this even with the older APIs. Their resolver on the backend checks the operation against the last path part. All the other APIs with optional versions also list them as required in swagger. You could elide the double slash (e.g. \"/keys/{key-name}//export\") in the URL in that case, but in my experience with the KV APIs I haven't seen it make a difference.", "author": "heaths", "createdAt": "2020-11-08T19:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2OTkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA3MTg5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r519071892", "bodyText": "Given the swagger is \"release_policy\", I think these should actually be ReleasePolicy instead of KeyReleasePolicy. That was in the original bug as well.", "author": "heaths", "createdAt": "2020-11-07T00:53:40Z", "path": "sdk/keyvault/azure-security-keyvault-keys/src/main/java/com/azure/security/keyvault/keys/KeyAsyncClient.java", "diffHunk": "@@ -213,7 +213,8 @@ Duration getDefaultPollingInterval() {\n         KeyRequestParameters parameters = new KeyRequestParameters()\n             .setKty(createKeyOptions.getKeyType())\n             .setKeyOps(createKeyOptions.getKeyOperations())\n-            .setKeyAttributes(new KeyRequestAttributes(createKeyOptions));\n+            .setKeyAttributes(new KeyRequestAttributes(createKeyOptions))\n+            .setKeyReleasePolicy(createKeyOptions.getKeyReleasePolicy());", "originalCommit": "4f594cb5994168c5264fa59521b12ea3f4a77bdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA3MzU0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r519073545", "bodyText": "No problem, thanks for pointing it out.", "author": "vcolin7", "createdAt": "2020-11-07T01:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA3MTg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA3NDE5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r519074196", "bodyText": "You also might not want to encode this. It's tight coupling. Sending null is fine (not required), in which case this is what the server should default to.", "author": "heaths", "createdAt": "2020-11-07T01:08:08Z", "path": "sdk/keyvault/azure-security-keyvault-keys/src/main/java/com/azure/security/keyvault/keys/models/KeyReleasePolicy.java", "diffHunk": "@@ -0,0 +1,67 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.security.keyvault.keys.models;\n+\n+import com.azure.core.annotation.Fluent;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+/**\n+ * Class that contains the policy rules under which the key can be exported.\n+ */\n+@Fluent\n+public class KeyReleasePolicy {\n+    /**\n+     * Content type and version of key release policy. The default value is:\n+     * 'application/json; charset=utf-8; version=1.0'.\n+     */\n+    @JsonProperty(value = \"contentType\")\n+    private String contentType = \"application/json; charset=utf-8; version=1.0\";", "originalCommit": "4f594cb5994168c5264fa59521b12ea3f4a77bdd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4MDY4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r519080685", "bodyText": "Given you're copying this around and because KeyProperties needs it anyway, perhaps we should just define it on KeyProperties, which means KeyVaultBundle.properties.releasePolicy is where'd you get it.", "author": "heaths", "createdAt": "2020-11-07T01:57:49Z", "path": "sdk/keyvault/azure-security-keyvault-keys/src/main/java/com/azure/security/keyvault/keys/KeyAsyncClient.java", "diffHunk": "@@ -659,7 +757,8 @@ Duration getDefaultPollingInterval() {\n         context = context == null ? Context.NONE : context;\n         KeyRequestParameters parameters = new KeyRequestParameters()\n             .setTags(keyProperties.getTags())\n-            .setKeyAttributes(new KeyRequestAttributes(keyProperties));\n+            .setKeyAttributes(new KeyRequestAttributes(keyProperties))\n+            .setKeyReleasePolicy(keyProperties.getKeyReleasePolicy());", "originalCommit": "4f594cb5994168c5264fa59521b12ea3f4a77bdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDI3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17183#discussion_r519084279", "bodyText": "Agreed based on a separate conversation we had. Let's keep it only in KeyProperties.", "author": "vcolin7", "createdAt": "2020-11-07T02:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4MDY4NQ=="}], "type": "inlineReview"}, {"oid": "971ac37de3c2aaea534b5a1c832c0e1dd37f48b5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/971ac37de3c2aaea534b5a1c832c0e1dd37f48b5", "message": "Applied PR feedback: renamed KeyReleasePolicy to ReleasePolicy and removed it from KeyVaultKey.", "committedDate": "2020-11-07T03:02:04Z", "type": "commit"}, {"oid": "efa5120033d92502e13282bfe132ccea3449913f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/efa5120033d92502e13282bfe132ccea3449913f", "message": "Fixed spotbugs issues.", "committedDate": "2020-11-07T03:20:51Z", "type": "commit"}, {"oid": "575190ddb8a754bcc3175365ad54b59faf366f2d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/575190ddb8a754bcc3175365ad54b59faf366f2d", "message": "Added unit tests.", "committedDate": "2020-11-09T20:41:44Z", "type": "commit"}, {"oid": "21decf5289c8089f25606556cda8375b6ecaac17", "url": "https://github.com/Azure/azure-sdk-for-java/commit/21decf5289c8089f25606556cda8375b6ecaac17", "message": "Renamed ReleasePolicy to KeyReleasePolicy. Added tests for creating an RSA key with publicExponent.", "committedDate": "2020-11-11T11:07:52Z", "type": "commit"}]}