{"pr_number": 9620, "pr_title": "Added helper function for IndexBatchException", "pr_createdAt": "2020-03-27T01:24:53Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9620", "timeline": [{"oid": "884b22841e59182fb0cbd2e7ad41ec2b3bc175b8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/884b22841e59182fb0cbd2e7ad41ec2b3bc175b8", "message": "Added helper func for IndexBatchException", "committedDate": "2020-03-27T01:24:16Z", "type": "commit"}, {"oid": "c3a33a6220b69ade5d553d456c7c8fd42ab11470", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3a33a6220b69ade5d553d456c7c8fd42ab11470", "message": "Remove extra class", "committedDate": "2020-03-27T01:26:31Z", "type": "commit"}, {"oid": "324b114a859997543dc881e76c8c88fb204a5be6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/324b114a859997543dc881e76c8c88fb204a5be6", "message": "Added imports", "committedDate": "2020-03-27T03:04:03Z", "type": "commit"}, {"oid": "1b0185852951757d4c5888ad815a930645891932", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b0185852951757d4c5888ad815a930645891932", "message": "fix compile issue", "committedDate": "2020-03-27T15:41:35Z", "type": "commit"}, {"oid": "d6238e67081bc19eecea00e9fd907f572673b436", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d6238e67081bc19eecea00e9fd907f572673b436", "message": "Fixed linting", "committedDate": "2020-03-27T15:56:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTU2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399355563", "bodyText": "Did you mean to make this public again?", "author": "alzimmermsft", "createdAt": "2020-03-27T15:39:04Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/models/IndexAction.java", "diffHunk": "@@ -29,7 +29,7 @@\n     private Map<String, Object> properties;\n \n     @JsonAnyGetter\n-    private Map<String, Object> getParamMap() {\n+    public Map<String, Object> getParamMap() {", "originalCommit": "324b114a859997543dc881e76c8c88fb204a5be6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3MTU1OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399371559", "bodyText": "For indexAction, we can define either a map (properties) or an object(document).\nIf we made this private, we cannot access properties only document.", "author": "sima-zhu", "createdAt": "2020-03-27T16:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3NDAyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399374024", "bodyText": "Could this be package private instead?", "author": "alzimmermsft", "createdAt": "2020-03-27T16:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0ODA5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399448093", "bodyText": "https://docs.microsoft.com/en-us/rest/api/searchservice/addupdate-or-delete-documents#response", "author": "sima-zhu", "createdAt": "2020-03-27T18:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2NzU4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399467589", "bodyText": "It cannot be private as we the index batch operation is supported.\npublic Mono<IndexDocumentsResult> indexDocuments(IndexDocumentsBatch<?> batch)", "author": "sima-zhu", "createdAt": "2020-03-27T18:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2OTkwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399469905", "bodyText": "What we can do is to rename it to something make more sense", "author": "sima-zhu", "createdAt": "2020-03-27T18:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NzE3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399357178", "bodyText": "Since there is a default hardcoded test resource group you can get rid of the null or empty check and just use the following here.\nString resourcegroupname = Configuration.getGlobalConfiguration().get(AZURE_RESOURCEGROUP_NAME, TEST_RESOURCE_GROUP);\nThis is effectively a get or default.", "author": "alzimmermsft", "createdAt": "2020-03-27T15:41:26Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/test/environment/setup/AzureSearchResources.java", "diffHunk": "@@ -121,7 +122,7 @@ public void createResourceGroup() {\n         String resourceGroupName = Configuration.getGlobalConfiguration().get(AZURE_RESOURCEGROUP_NAME);", "originalCommit": "324b114a859997543dc881e76c8c88fb204a5be6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MDU5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399360596", "bodyText": "This could be simplified a lot.\nreturn statusCode == 422 || statusCode == 409 || statusCode == 503;\nDefinitely add a comment for why those status codes are considered for retry but others aren't, for example 503 is allow since the server failed to process the request properly, etc", "author": "alzimmermsft", "createdAt": "2020-03-27T15:46:15Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/models/IndexBatchException.java", "diffHunk": "@@ -0,0 +1,122 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.search.documents.models;\n+\n+import com.azure.core.exception.AzureException;\n+import com.azure.search.documents.SearchDocument;\n+import com.azure.search.documents.models.*;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * An {@code IndexBatchException} is thrown whenever Azure Cognitive Search index call was only partially successful.\n+ * Users can inspect the indexingResults to determine the operation(s) that have failed.\n+ */\n+public final class IndexBatchException extends AzureException {\n+    private static final long serialVersionUID = -3478124828996650248L;\n+    private static final String MESSAGE_FORMAT = \"%s of %s indexing actions in the batch failed. The remaining\"\n+        + \" actions succeeded and modified the index. Check indexingResults for the status of each index action.\";\n+\n+    private final ArrayList<IndexingResult> results;\n+\n+    /**\n+     * Constructs an {@code IndexBatchException} from the given {@link IndexDocumentsResult}.\n+     *\n+     * @param result The DocumentIndexResult returned from the service.\n+     */\n+    public IndexBatchException(IndexDocumentsResult result) {\n+        super(createMessage(result));\n+        this.results = new ArrayList<>(result.getResults());\n+    }\n+\n+    /**\n+     * Finds all index actions in the given batch that failed and need to be retried, and returns them in a new batch.\n+     *\n+     * @param originalBatch The batch that partially failed indexing.\n+     * @param keyFieldName The name of the key field from the index schema.\n+     * @return A new batch containing all the actions from the given batch that failed and should be retried.\n+     */\n+    public IndexBatchBase<SearchDocument> findFailedActionsToRetry(IndexBatchBase<SearchDocument> originalBatch,\n+        String keyFieldName) {\n+        return findFailedActionsToRetry(originalBatch, searchDocument -> searchDocument.get(keyFieldName).toString());\n+    }\n+\n+    /**\n+     * Finds all index actions in the given batch that failed and need to be retried, and returns them in a new batch.\n+     *\n+     * @param originBatch The batch that partially failed indexing.\n+     * @param keySelector A lambda that retrieves a key value from a given document of type T.\n+     * @param <T> The CLR type that maps to the index schema. Instances of this type can be stored as documents\n+     * in the index.\n+     * @return A new batch containing all the actions from the given batch that failed and should be retried.\n+     */\n+    public <T> IndexBatchBase<T> findFailedActionsToRetry(IndexBatchBase<T> originBatch,\n+        Function<T, String> keySelector) {\n+        List<IndexAction<T>> failedActions = doFindFailedActionsToRetry(originBatch, keySelector);\n+        return new IndexBatchBase<T>().setActions(failedActions);\n+    }\n+\n+    /**\n+     * @return The indexing results returned by the service.\n+     */\n+    public List<IndexingResult> getIndexingResults() {\n+        return this.results;\n+    }\n+\n+    private static String createMessage(IndexDocumentsResult result) {\n+        long failedResultCount = result.getResults().stream()\n+            .filter(r -> !r.isSucceeded())\n+            .count();\n+        return String.format(MESSAGE_FORMAT, failedResultCount, result.getResults().size());\n+    }\n+\n+    private <T> List<IndexAction<T>> doFindFailedActionsToRetry(IndexBatchBase<T> originBatch,\n+        Function<T, String> keySelector) {\n+        Set<String> uniqueRetriableKeys = getIndexingResults().stream().filter(result ->\n+            isRetriableStatusCode(result.getStatusCode())).map(IndexingResult::getKey).collect(Collectors.toSet());\n+        return originBatch.getActions().stream().filter(action -> isActionIncluded(action,\n+            uniqueRetriableKeys, keySelector))\n+            .collect(Collectors.toList());\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <T> boolean isActionIncluded(IndexAction<T> action, Set<String> uniqueRetriableKeys,\n+        Function<T, String> keySelector) {\n+        if (action.getDocument() != null) {\n+            return uniqueRetriableKeys.contains(keySelector.apply(action.getDocument()));\n+        } else if (action.getParamMap() != null) {\n+            return uniqueRetriableKeys.contains(keySelector.apply((T) action.getParamMap()));\n+        }\n+        return false;\n+    }\n+\n+    private static boolean isRetriableStatusCode(int statusCode) {\n+        switch (statusCode) {\n+            case 200:\n+            case 201:\n+                return false;   // Don't retry on success.\n+\n+            case 404:\n+            case 400:\n+                return false;   // Don't retry on user error.\n+\n+            case 500:\n+                return false;   // Don't retry when something unexpected happened.\n+\n+            case 422:\n+            case 409:\n+            case 503:\n+                return true;    // The above cases might succeed on a subsequent retry.\n+\n+            default:\n+                // If this happens, it's a bug. Safest to assume no retry.\n+                return false;\n+        }", "originalCommit": "324b114a859997543dc881e76c8c88fb204a5be6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4Mjc4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399382785", "bodyText": "This is copied from .net. Need to double check", "author": "sima-zhu", "createdAt": "2020-03-27T16:18:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MDU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDcwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399364707", "bodyText": "You need to initialize mocking.\nMockitoAnnotations.initMocks(this);", "author": "alzimmermsft", "createdAt": "2020-03-27T15:52:03Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/models/IndexBatchExceptionTests.java", "diffHunk": "@@ -0,0 +1,216 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.search.documents.models;\n+\n+import com.azure.search.documents.SearchDocument;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mockito;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.mockito.Mockito.mock;\n+\n+public class IndexBatchExceptionTests {\n+    private static final String KEY_FIELD_NAME = \"key\";\n+    private IndexDocumentsResult result;\n+\n+    @BeforeEach\n+    public void setup() {\n+        result = mock(IndexDocumentsResult.class);", "originalCommit": "324b114a859997543dc881e76c8c88fb204a5be6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxODEwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399418108", "bodyText": "Is this needed? As I do not initialize the mock through annotation.\nInitializes objects annotated with Mockito annotations for given testClass: @Mock, @Spy, @Captor, @InjectMocks", "author": "sima-zhu", "createdAt": "2020-03-27T17:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NTA2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399365068", "bodyText": "You also need to cleanup mocking.\n@AfterEach\n    public void clearMocks() {\n        Mockito.framework().clearInlineMocks();\n    }", "author": "alzimmermsft", "createdAt": "2020-03-27T15:52:37Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/models/IndexBatchExceptionTests.java", "diffHunk": "@@ -0,0 +1,216 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.search.documents.models;\n+\n+import com.azure.search.documents.SearchDocument;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mockito;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.mockito.Mockito.mock;\n+\n+public class IndexBatchExceptionTests {\n+    private static final String KEY_FIELD_NAME = \"key\";\n+    private IndexDocumentsResult result;\n+\n+    @BeforeEach\n+    public void setup() {\n+        result = mock(IndexDocumentsResult.class);\n+    }", "originalCommit": "324b114a859997543dc881e76c8c88fb204a5be6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c9e5523c672f87cc1e475af286ffd8b72ba4cdb1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c9e5523c672f87cc1e475af286ffd8b72ba4cdb1", "message": "Remove unused", "committedDate": "2020-03-27T15:59:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3NzUzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399377532", "bodyText": "By any chance was this copied from .NET? Java doesn't have a CLR \ud83d\ude03", "author": "alzimmermsft", "createdAt": "2020-03-27T16:10:44Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/models/IndexBatchException.java", "diffHunk": "@@ -0,0 +1,120 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.search.documents.models;\n+\n+import com.azure.core.exception.AzureException;\n+import com.azure.search.documents.SearchDocument;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * An {@code IndexBatchException} is thrown whenever Azure Cognitive Search index call was only partially successful.\n+ * Users can inspect the indexingResults to determine the operation(s) that have failed.\n+ */\n+public final class IndexBatchException extends AzureException {\n+    private static final long serialVersionUID = -3478124828996650248L;\n+    private static final String MESSAGE_FORMAT = \"%s of %s indexing actions in the batch failed. The remaining\"\n+        + \" actions succeeded and modified the index. Check indexingResults for the status of each index action.\";\n+\n+    private final ArrayList<IndexingResult> results;\n+\n+    /**\n+     * Constructs an {@code IndexBatchException} from the given {@link IndexDocumentsResult}.\n+     *\n+     * @param result The DocumentIndexResult returned from the service.\n+     */\n+    public IndexBatchException(IndexDocumentsResult result) {\n+        super(createMessage(result));\n+        this.results = new ArrayList<>(result.getResults());\n+    }\n+\n+    /**\n+     * Finds all index actions in the given batch that failed and need to be retried, and returns them in a new batch.\n+     *\n+     * @param originalBatch The batch that partially failed indexing.\n+     * @param keyFieldName The name of the key field from the index schema.\n+     * @return A new batch containing all the actions from the given batch that failed and should be retried.\n+     */\n+    public IndexBatchBase<SearchDocument> findFailedActionsToRetry(IndexBatchBase<SearchDocument> originalBatch,\n+        String keyFieldName) {\n+        return findFailedActionsToRetry(originalBatch, searchDocument -> searchDocument.get(keyFieldName).toString());\n+    }\n+\n+    /**\n+     * Finds all index actions in the given batch that failed and need to be retried, and returns them in a new batch.\n+     *\n+     * @param originBatch The batch that partially failed indexing.\n+     * @param keySelector A lambda that retrieves a key value from a given document of type T.\n+     * @param <T> The CLR type that maps to the index schema. Instances of this type can be stored as documents", "originalCommit": "c9e5523c672f87cc1e475af286ffd8b72ba4cdb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4MzE0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9620#discussion_r399383144", "bodyText": "Yes, it is copied from .net. Will change.", "author": "sima-zhu", "createdAt": "2020-03-27T16:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3NzUzMg=="}], "type": "inlineReview"}, {"oid": "19543cbc74c60787bea7d88453324d0f217961b2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/19543cbc74c60787bea7d88453324d0f217961b2", "message": "Make changes", "committedDate": "2020-03-27T17:40:43Z", "type": "commit"}, {"oid": "a60e4a204b45a905063f7ac2d451f238ee192e27", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a60e4a204b45a905063f7ac2d451f238ee192e27", "message": "Fixed Javadoc", "committedDate": "2020-03-27T18:15:54Z", "type": "commit"}, {"oid": "8a25a649f771f68f3e37c9a4b5127cb2fb1404c7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8a25a649f771f68f3e37c9a4b5127cb2fb1404c7", "message": "Linting issues", "committedDate": "2020-03-27T18:41:49Z", "type": "commit"}]}