{"pr_number": 11156, "pr_title": "Support AAD Authentication in Form Recognizer", "pr_createdAt": "2020-05-13T22:51:47Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11156", "timeline": [{"oid": "71154c677556c6ec78e88bf398364f1b6da3a34c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/71154c677556c6ec78e88bf398364f1b6da3a34c", "message": "added AAD support", "committedDate": "2020-05-13T22:31:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc4MjI2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r424782265", "bodyText": "this.tokenCredential = Objects.requireNonNull(tokenCredential, \"'tokenCredential' cannot be null.\");", "author": "samvaity", "createdAt": "2020-05-13T23:11:29Z", "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/main/java/com/azure/ai/formrecognizer/FormRecognizerClientBuilder.java", "diffHunk": "@@ -232,6 +238,19 @@ public FormRecognizerClientBuilder credential(AzureKeyCredential apiKeyCredentia\n         return this;\n     }\n \n+    /**\n+     * Sets the {@link TokenCredential} used to authenticate HTTP requests.\n+     *\n+     * @param tokenCredential {@link TokenCredential} used to authenticate HTTP requests.\n+     * @return The updated {@link FormRecognizerClientBuilder} object.\n+     * @throws NullPointerException If {@code tokenCredential} is {@code null}.\n+     */\n+    public FormRecognizerClientBuilder credential(TokenCredential tokenCredential) {\n+        Objects.requireNonNull(tokenCredential, \"'tokenCredential' cannot be null.\");\n+        this.tokenCredential = tokenCredential;", "originalCommit": "71154c677556c6ec78e88bf398364f1b6da3a34c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc4MjQxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r424782413", "bodyText": "nit: .build can be on the same line.", "author": "samvaity", "createdAt": "2020-05-13T23:11:55Z", "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/samples/java/com/azure/ai/formrecognizer/ReadmeSamples.java", "diffHunk": "@@ -40,6 +42,18 @@ public void useAzureKeyCredentialSyncClient() {\n             .buildClient();\n     }\n \n+    /**\n+     * Code snippet for getting async client using AAD authentication.\n+     */\n+    public void useAadAsyncClient() {\n+        TokenCredential credential = new DefaultAzureCredentialBuilder()\n+            .build();", "originalCommit": "71154c677556c6ec78e88bf398364f1b6da3a34c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc4Mjg2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r424782861", "bodyText": "use connection string --> use AzureKeyCredential", "author": "samvaity", "createdAt": "2020-05-13T23:13:10Z", "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/test/java/com/azure/ai/formrecognizer/AadAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.ai.formrecognizer;\n+\n+import com.azure.ai.formrecognizer.models.CustomFormModelInfo;\n+import com.azure.core.credential.AzureKeyCredential;\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.test.TestBase;\n+import com.azure.core.util.Configuration;\n+import com.azure.identity.DefaultAzureCredentialBuilder;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+\n+import static com.azure.ai.formrecognizer.FormTrainingClientTestBase.AZURE_FORM_RECOGNIZER_API_KEY;\n+import static com.azure.ai.formrecognizer.FormTrainingClientTestBase.AZURE_FORM_RECOGNIZER_ENDPOINT;\n+import static com.azure.ai.formrecognizer.TestUtils.DISPLAY_NAME_WITH_ARGUMENTS;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Test for using Azure Active Directory token credential.\n+ */\n+public class AadAuthenticationTest extends TestBase {\n+    private static FormTrainingClient client;\n+\n+    private void setup(HttpClient httpClient, FormRecognizerServiceVersion serviceVersion) {\n+        final String endpoint = getEndpoint();\n+        if (interceptorManager.isPlaybackMode()) {\n+            // In playback mode use connection string because CI environment doesn't set up to support AAD", "originalCommit": "71154c677556c6ec78e88bf398364f1b6da3a34c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc4MzU0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r424783541", "bodyText": "AAD Authentication tests could be a part of the FormRecognizerBuilderTest?\nDon't need to have two different client setups?", "author": "samvaity", "createdAt": "2020-05-13T23:15:29Z", "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/test/java/com/azure/ai/formrecognizer/AadAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.ai.formrecognizer;\n+\n+import com.azure.ai.formrecognizer.models.CustomFormModelInfo;\n+import com.azure.core.credential.AzureKeyCredential;\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.test.TestBase;\n+import com.azure.core.util.Configuration;\n+import com.azure.identity.DefaultAzureCredentialBuilder;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+\n+import static com.azure.ai.formrecognizer.FormTrainingClientTestBase.AZURE_FORM_RECOGNIZER_API_KEY;\n+import static com.azure.ai.formrecognizer.FormTrainingClientTestBase.AZURE_FORM_RECOGNIZER_ENDPOINT;\n+import static com.azure.ai.formrecognizer.TestUtils.DISPLAY_NAME_WITH_ARGUMENTS;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Test for using Azure Active Directory token credential.\n+ */\n+public class AadAuthenticationTest extends TestBase {\n+    private static FormTrainingClient client;\n+\n+    private void setup(HttpClient httpClient, FormRecognizerServiceVersion serviceVersion) {\n+        final String endpoint = getEndpoint();\n+        if (interceptorManager.isPlaybackMode()) {\n+            // In playback mode use connection string because CI environment doesn't set up to support AAD\n+            client = new FormRecognizerClientBuilder()\n+                .credential(new AzureKeyCredential(getApiKey()))\n+                .endpoint(endpoint)\n+                .httpClient(interceptorManager.getPlaybackClient())\n+                .buildClient().getFormTrainingClient();\n+        } else {\n+            client = new FormRecognizerClientBuilder()\n+                .httpClient(httpClient)\n+                .credential(new DefaultAzureCredentialBuilder().build())\n+                .endpoint(endpoint)\n+                .addPolicy(interceptorManager.getRecordPolicy()) // Record\n+                .serviceVersion(serviceVersion)\n+                .buildClient().getFormTrainingClient();\n+        }\n+    }\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.ai.formrecognizer.TestUtils#getTestParameters\")\n+    public void aadAuthenticationTest(HttpClient httpClient, FormRecognizerServiceVersion serviceVersion) {", "originalCommit": "71154c677556c6ec78e88bf398364f1b6da3a34c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc4NjM3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r424786376", "bodyText": "Yup. I can do it.", "author": "mssfang", "createdAt": "2020-05-13T23:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc4MzU0MQ=="}], "type": "inlineReview"}, {"oid": "f90c67165bc4e70aa82f27f965dcd937f0caeaee", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f90c67165bc4e70aa82f27f965dcd937f0caeaee", "message": "resolve conflict", "committedDate": "2020-05-28T19:34:52Z", "type": "commit"}, {"oid": "1f744ab1d7517382cac245f936d8ad4a9c0c1cb8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1f744ab1d7517382cac245f936d8ad4a9c0c1cb8", "message": "address feedbacks", "committedDate": "2020-05-29T04:44:22Z", "type": "commit"}, {"oid": "aacc161d72d7a7cfe9935fb759e1d0f9e24b41bf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aacc161d72d7a7cfe9935fb759e1d0f9e24b41bf", "message": "resolve conflict", "committedDate": "2020-05-29T04:55:29Z", "type": "commit"}, {"oid": "dd1786ea2df5b216cf21f74abcda47d1b05d4a49", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dd1786ea2df5b216cf21f74abcda47d1b05d4a49", "message": "resolve conflict", "committedDate": "2020-05-29T16:52:22Z", "type": "commit"}, {"oid": "083b52ddfe5728932073b3301e31b7d51ca07358", "url": "https://github.com/Azure/azure-sdk-for-java/commit/083b52ddfe5728932073b3301e31b7d51ca07358", "message": "address iscai feedbacks", "committedDate": "2020-05-29T17:10:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5ODY3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r432698674", "bodyText": "Add the credential in builder docs as well. Same as this", "author": "samvaity", "createdAt": "2020-05-29T19:43:14Z", "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/main/java/com/azure/ai/formrecognizer/training/FormTrainingClientBuilder.java", "diffHunk": "@@ -242,6 +244,18 @@ public FormTrainingClientBuilder credential(AzureKeyCredential apiKeyCredential)\n         return this;\n     }\n ", "originalCommit": "083b52ddfe5728932073b3301e31b7d51ca07358", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1OTkzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r432759939", "bodyText": "updated", "author": "mssfang", "createdAt": "2020-05-29T22:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5ODY3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5OTg0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r432699848", "bodyText": "We will be using AAD for authentication in test setup?", "author": "samvaity", "createdAt": "2020-05-29T19:44:50Z", "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/test/java/com/azure/ai/formrecognizer/FormRecognizerClientTestBase.java", "diffHunk": "@@ -67,6 +73,23 @@\n     private static final String EXPECTED_MULTIPAGE_PHONE_NUMBER_VALUE = \"+15555555555\";\n     private static final String ITEMIZED_RECEIPT_VALUE = \"Itemized\";\n \n+    FormRecognizerClientBuilder getFormRecognizerClientBuilder(HttpClient httpClient,\n+        FormRecognizerServiceVersion serviceVersion) {\n+        FormRecognizerClientBuilder builder = new FormRecognizerClientBuilder()\n+            .endpoint(getEndpoint())\n+            .httpClient(httpClient == null ? interceptorManager.getPlaybackClient() : httpClient)\n+            .httpLogOptions(new HttpLogOptions().setLogLevel(HttpLogDetailLevel.BODY_AND_HEADERS))\n+            .serviceVersion(serviceVersion)\n+            .addPolicy(interceptorManager.getRecordPolicy());\n+\n+        if (getTestMode() == TestMode.PLAYBACK) {\n+            builder.credential(new AzureKeyCredential(INVALID_KEY));\n+        } else {\n+            builder.credential(new DefaultAzureCredentialBuilder().build());", "originalCommit": "083b52ddfe5728932073b3301e31b7d51ca07358", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwMDE4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r432700182", "bodyText": "If yes, should consider removing getApiKey() method.", "author": "samvaity", "createdAt": "2020-05-29T19:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5OTg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1OTkyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r432759927", "bodyText": "removed.", "author": "mssfang", "createdAt": "2020-05-29T22:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5OTg0OA=="}], "type": "inlineReview"}, {"oid": "d04924dd41dc2870e8adfd5a74c3499259085753", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d04924dd41dc2870e8adfd5a74c3499259085753", "message": "refactor", "committedDate": "2020-05-29T22:04:40Z", "type": "commit"}, {"oid": "68d1868b69b82fc727340a155503dc087f7d79b3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/68d1868b69b82fc727340a155503dc087f7d79b3", "message": "remove non-used json", "committedDate": "2020-05-29T22:15:39Z", "type": "commit"}, {"oid": "bc653df7429ea3172dc5bdf11ae835753ad85b97", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bc653df7429ea3172dc5bdf11ae835753ad85b97", "message": "add api key back", "committedDate": "2020-06-01T22:44:14Z", "type": "commit"}, {"oid": "1472dbedc2b23b1495c3c8296e7b269dbf8df98a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1472dbedc2b23b1495c3c8296e7b269dbf8df98a", "message": "add aad to training client", "committedDate": "2020-06-02T18:39:19Z", "type": "commit"}, {"oid": "e887003429bc34ea2f338146701c6cab239f3f96", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e887003429bc34ea2f338146701c6cab239f3f96", "message": "add license title", "committedDate": "2020-06-02T19:06:34Z", "type": "commit"}, {"oid": "4ee091032feca43731f736624f5ee9739a61be6b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4ee091032feca43731f736624f5ee9739a61be6b", "message": "validate null of account properoty values instead of real value", "committedDate": "2020-06-03T16:22:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0MjA2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r434742062", "bodyText": "Could you put a TODO note with the created isssue to track the inconsistent behavior we were seeing.", "author": "samvaity", "createdAt": "2020-06-03T17:39:18Z", "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/test/java/com/azure/ai/formrecognizer/FormTrainingClientTestBase.java", "diffHunk": "@@ -85,9 +109,8 @@ private static void validateErrorData(List<ErrorInformation> expectedErrors,\n         }\n     }\n \n-    static void validateAccountProperties(AccountProperties expectedAccountProperties,\n-        AccountProperties actualAccountProperties) {\n-        assertEquals(expectedAccountProperties.getCustomModelLimit(), actualAccountProperties.getCustomModelLimit());\n+    static void validateAccountProperties(AccountProperties actualAccountProperties) {\n+        assertNotNull(actualAccountProperties.getCustomModelLimit());", "originalCommit": "4ee091032feca43731f736624f5ee9739a61be6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyMDAwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11156#discussion_r434820003", "bodyText": "we should not check the exact number but not null should be the better way. Create a bug issue: #9269", "author": "mssfang", "createdAt": "2020-06-03T19:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0MjA2Mg=="}], "type": "inlineReview"}, {"oid": "70d6222b9e5fd473f87c1f7dbaf2f07c2872f86b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/70d6222b9e5fd473f87c1f7dbaf2f07c2872f86b", "message": "hide model id", "committedDate": "2020-06-03T19:53:15Z", "type": "commit"}, {"oid": "3c6a265eb13538f22a19e1473cc33a7d68d22231", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3c6a265eb13538f22a19e1473cc33a7d68d22231", "message": "minor feedbacks", "committedDate": "2020-06-03T20:00:40Z", "type": "commit"}]}