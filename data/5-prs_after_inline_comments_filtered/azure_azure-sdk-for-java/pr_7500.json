{"pr_number": 7500, "pr_title": "Adding Transport client request life cycle timeline on diagnostics", "pr_createdAt": "2020-01-16T17:16:24Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/7500", "timeline": [{"oid": "8fca1df6d7b616f19f1f287773050ce3b84c144d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fca1df6d7b616f19f1f287773050ce3b84c144d", "message": "adding transport client granular info to diagnostics", "committedDate": "2020-01-16T17:05:36Z", "type": "commit"}, {"oid": "368756cb2ffdebfeb2ae5986fd6802b269fb94cf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/368756cb2ffdebfeb2ae5986fd6802b269fb94cf", "message": "removing redundant api from RequestTimeline", "committedDate": "2020-01-16T17:26:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NDM1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r373064357", "bodyText": "do we have a specific format for request timeline? is it going to be json?", "author": "moderakh", "createdAt": "2020-01-30T16:44:57Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/ClientSideRequestStatistics.java", "diffHunk": "@@ -274,6 +280,17 @@ private void printSystemInformation(StringBuilder stringBuilder) {\n         }\n     }\n \n+    private void printTransportRequestTimeline(StringBuilder stringBuilder) {\n+        if (transportRequestTimeline != null) {\n+            stringBuilder.append(\"Transport request timeline -------\").append(System.lineSeparator());\n+            Iterator<RequestTimeline.Event> iterator = transportRequestTimeline.iterator();\n+            while (iterator.hasNext()) {\n+                RequestTimeline.Event event = iterator.next();\n+                stringBuilder.append(\"  eventName = \" + event.getName() + \",  startTime = \" + event.getStartTime() + \",  durationInMicrosec = \" + event.getDuration().toNanos()/1000L).append(System.lineSeparator());", "originalCommit": "368756cb2ffdebfeb2ae5986fd6802b269fb94cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg5MzYzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r374893637", "bodyText": "After the latest merge , it will be json , sample is in the PR description for both rntbd and http", "author": "simplynaveen20", "createdAt": "2020-02-04T20:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NDM1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NTA2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r373065068", "bodyText": "I wonder why we have mixture of Duration and Long for representing time.\nIs there a specific reason we are not using the same type?", "author": "moderakh", "createdAt": "2020-01-30T16:46:05Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RequestTimeline.java", "diffHunk": "@@ -148,25 +149,33 @@ public String toString() {\n         return RntbdObjectMapper.toString(this);\n     }\n \n-    @JsonPropertyOrder({ \"name\", \"time\", \"duration\" })\n+    @JsonPropertyOrder({ \"name\", \"startTime\", \"durationInMicroSec\" })\n     public static final class Event {\n \n-        @JsonSerialize(using = ToStringSerializer.class)\n+        @JsonIgnore\n         private final Duration duration;\n \n+        @JsonSerialize(using = ToStringSerializer.class)\n+        private final long durationInMicroSec;", "originalCommit": "368756cb2ffdebfeb2ae5986fd6802b269fb94cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg5NDY3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r374894671", "bodyText": "Reason is  these numbers will be so small,  i want to show it in micro sec , and didn't want to introduce new serializer class for this one variable , however i am good with anything , please let me know.", "author": "simplynaveen20", "createdAt": "2020-02-04T20:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NTA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NjcxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r373066711", "bodyText": "shouldn't we capture the timeline inside the response instead of the request?\nWhy are capturing the timeline in the request not the response?", "author": "moderakh", "createdAt": "2020-01-30T16:48:55Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxGatewayStoreModel.java", "diffHunk": "@@ -271,6 +276,14 @@ private String ensureSlashPrefixed(String path) {\n             return contentObservable\n                        .flatMap(content -> {\n                            try {\n+                               //Adding transport client request timeline to diagnostics\n+                               ReactorNettyRequestRecord reactorNettyRequestRecord = httpResponseTuple.getRight();\n+                               if (reactorNettyRequestRecord != null) {\n+                                   reactorNettyRequestRecord.setTimeCompleted(OffsetDateTime.now());", "originalCommit": "368756cb2ffdebfeb2ae5986fd6802b269fb94cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg4NTc3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r373885774", "bodyText": "this is just a question, please provide the reason why this should go to request not response", "author": "moderakh", "createdAt": "2020-02-02T23:45:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NjcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg5NTI4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r374895282", "bodyText": "All the diagnostic we capture in request , as it flows to different pipeline, retries , capturing different data , and once we have the response then we transfer the diagnostic from request to response.", "author": "simplynaveen20", "createdAt": "2020-02-04T20:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NjcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1MTE0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r375551143", "bodyText": "Moved ReactorNettyRequestRecord into HttpRequest", "author": "simplynaveen20", "createdAt": "2020-02-05T22:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NjcxMQ=="}], "type": "inlineReview"}, {"oid": "e33efb174588942202422423c5d92ec6484cd6bc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e33efb174588942202422423c5d92ec6484cd6bc", "message": "merge with feature v4", "committedDate": "2020-02-04T20:03:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQxNDk5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r375414990", "bodyText": "this will be somewhat a cascading change.\ndue to changing Mono< HttpResponse> to Mono< ReactorNettyRequestRecord>\nHow about making ReactorNettyRequestRecord an entry of HttpResponse? Thought?\nso the method return signature will still be Mono but this HttpResponse will be subclass of HttpResponse which will have ReactorNettyRequestRecord\nthoughts?", "author": "moderakh", "createdAt": "2020-02-05T17:58:35Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/http/ReactorNettyClient.java", "diffHunk": "@@ -106,6 +109,34 @@ private void configureChannelPipelineHandlers() {\n                 .single();\n     }\n \n+    @Override\n+    public Mono<Pair<HttpResponse, ReactorNettyRequestRecord>> send(HttpRequest request, ReactorNettyRequestRecord reactorNettyRequestRecord) {", "originalCommit": "e33efb174588942202422423c5d92ec6484cd6bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1MTQ5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r375551495", "bodyText": "Moved ReactorNettyRequestRecord into HttpRequest , and HttpResponse have the reference of  ReactorNettyRequestRecord  via HttpRequest", "author": "simplynaveen20", "createdAt": "2020-02-05T22:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQxNDk5MA=="}], "type": "inlineReview"}, {"oid": "ee44a27504a3fa57c61bc67e80dd1048f018ddd5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ee44a27504a3fa57c61bc67e80dd1048f018ddd5", "message": "moving ReactorNettyRequestRecord inside HttpRequest", "committedDate": "2020-02-05T22:39:27Z", "type": "commit"}, {"oid": "a09e096a084b6eac07d4441083446a40c0c51d1b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a09e096a084b6eac07d4441083446a40c0c51d1b", "message": "clearing unused import", "committedDate": "2020-02-05T22:45:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxMDM2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r376210363", "bodyText": "One argument per line.", "author": "kirankumarkolli", "createdAt": "2020-02-07T04:32:09Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/BridgeInternal.java", "diffHunk": "@@ -418,6 +413,10 @@ public static CosmosResponseDiagnostics createCosmosResponseDiagnostics() {\n         return new CosmosResponseDiagnostics();\n     }\n \n+    public static void setTransportClientRequestTimelineOnDiagnostics(CosmosResponseDiagnostics cosmosResponseDiagnostics, RequestTimeline requestTimeline) {", "originalCommit": "a09e096a084b6eac07d4441083446a40c0c51d1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NzM1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r376587352", "bodyText": "Done", "author": "simplynaveen20", "createdAt": "2020-02-07T20:16:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxMDM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxMDU4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r376210587", "bodyText": "What's the client stats context/scope?\nIn-case the request is retried will it override existing timeline?", "author": "kirankumarkolli", "createdAt": "2020-02-07T04:33:28Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/BridgeInternal.java", "diffHunk": "@@ -418,6 +413,10 @@ public static CosmosResponseDiagnostics createCosmosResponseDiagnostics() {\n         return new CosmosResponseDiagnostics();\n     }\n \n+    public static void setTransportClientRequestTimelineOnDiagnostics(CosmosResponseDiagnostics cosmosResponseDiagnostics, RequestTimeline requestTimeline) {\n+        cosmosResponseDiagnostics.clientSideRequestStatistics().setTransportClientRequestTimeline(requestTimeline);", "originalCommit": "a09e096a084b6eac07d4441083446a40c0c51d1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUwMzMxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r376503316", "bodyText": "It will be the transportclient stats of successful response", "author": "simplynaveen20", "createdAt": "2020-02-07T17:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxMDU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4ODc5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r376588795", "bodyText": "Handled the scenario where we create multiple sub requests for single  request in case of consistency check on other replica. Now transportRequestTimeline is moved from parent clientSideRequestStatistics to StoreResult", "author": "simplynaveen20", "createdAt": "2020-02-07T20:20:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxMDU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE4MDQ5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r376180491", "bodyText": "It is the duration of the sent event that represents the transit time.\nThis has me thinking that giving meaningful names to duration fields would be useful to us and end users in two ways:\n\nCommunicating the meaning of duration\nLabeling charts and graphs with event time on the x axis and duration on the y axis.\n\nExample:\nThe sent event follows message encoding and occurs once it is confirmed that the message is on the wire. The duration of the sent event is the time that it takes for a round-trip to the server to complete and the next event occurs: received. The time between these two events--sent and received-- is the transitTime.\nSomething like this JSON is what we should produce--perhaps word-smithed and simplified for brevity:\n{\n  \"event\": {\n    \"name\": \"sent\", \n    \"time\": \"<time-stamp>\"\n  }, \n  \"duration\": { \n    \"name\": \"transitTime\", \n    \"microseconds\": <microseconds> \n  }\n}\n\nI've discussed this with Naveen and Mo. We agreed that this work should be done on another PR. I've logged this issue to track the work which I will assign to myself for now: #8034", "author": "David-Noble-at-work", "createdAt": "2020-02-07T02:01:19Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestRecord.java", "diffHunk": "@@ -217,7 +217,7 @@ public RequestTimeline takeTimelineSnapshot() {\n                 timeQueued, timePipelined == null ? timeCompletedOrNow : timePipelined),", "originalCommit": "a09e096a084b6eac07d4441083446a40c0c51d1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NzMwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7500#discussion_r376587301", "bodyText": "Thanks David", "author": "simplynaveen20", "createdAt": "2020-02-07T20:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE4MDQ5MQ=="}], "type": "inlineReview"}, {"oid": "c2b33027b423ec0f64f1ce662c0696c5e44d694d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c2b33027b423ec0f64f1ce662c0696c5e44d694d", "message": "adding rntbd request response on each store response", "committedDate": "2020-02-07T20:13:56Z", "type": "commit"}, {"oid": "50a8859a99354ed9837ea34fbff70b2e7c3a5e1a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/50a8859a99354ed9837ea34fbff70b2e7c3a5e1a", "message": "removing extra import", "committedDate": "2020-02-07T20:28:16Z", "type": "commit"}]}