{"pr_number": 13885, "pr_title": "Add Default Log Options to Search Client Builders", "pr_createdAt": "2020-08-07T20:21:12Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13885", "timeline": [{"oid": "67d106b9b0fa1fa59beee56a660150f5bdd8e3e3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/67d106b9b0fa1fa59beee56a660150f5bdd8e3e3", "message": "Add default log options to builders and move builder pipeline creation into a common method", "committedDate": "2020-08-07T20:17:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1ODIwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13885#discussion_r467258204", "bodyText": "What's the reason of using Supplier here? The list has been loaded anyway which execute the class.", "author": "sima-zhu", "createdAt": "2020-08-07T20:38:53Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/implementation/util/Utility.java", "diffHunk": "@@ -3,19 +3,51 @@\n \n package com.azure.search.documents.implementation.util;\n \n+import com.azure.core.credential.AzureKeyCredential;\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpPipeline;\n+import com.azure.core.http.HttpPipelineBuilder;\n+import com.azure.core.http.policy.AddDatePolicy;\n+import com.azure.core.http.policy.AddHeadersFromContextPolicy;\n+import com.azure.core.http.policy.AddHeadersPolicy;\n+import com.azure.core.http.policy.AzureKeyCredentialPolicy;\n+import com.azure.core.http.policy.HttpLogOptions;\n+import com.azure.core.http.policy.HttpLoggingPolicy;\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.http.policy.HttpPolicyProviders;\n+import com.azure.core.http.policy.RequestIdPolicy;\n+import com.azure.core.http.policy.RetryPolicy;\n+import com.azure.core.http.policy.UserAgentPolicy;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.CoreUtils;\n import com.azure.core.util.serializer.JacksonAdapter;\n import com.azure.core.util.serializer.SerializerAdapter;\n import com.azure.core.util.serializer.TypeReference;\n import com.azure.search.documents.implementation.serializer.SerializationUtil;\n import com.fasterxml.jackson.databind.ObjectMapper;\n \n+import java.util.ArrayList;\n+import java.util.List;\n import java.util.Map;\n \n public final class Utility {\n     // Type reference that used across many places. Have one copy here to minimize the memory.\n     public static final TypeReference<Map<String, Object>> MAP_STRING_OBJECT_TYPE_REFERENCE =\n         new TypeReference<Map<String, Object>>() { };\n \n+    private static final HttpLogOptions DEFAULT_LOG_OPTIONS = Constants.DEFAULT_LOG_OPTIONS_SUPPLIER.get();", "originalCommit": "67d106b9b0fa1fa59beee56a660150f5bdd8e3e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI2MjUxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13885#discussion_r467262510", "bodyText": "We need to return a new reference from the methods on the builders otherwise it will change the default global. This could have been a method as well but I put it into Constants so a Supplier seems more reasonable.", "author": "alzimmermsft", "createdAt": "2020-08-07T20:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1ODIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI2MDEyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13885#discussion_r467260123", "bodyText": "Whether to allow this seems not settle yet. Can we hide it first?", "author": "sima-zhu", "createdAt": "2020-08-07T20:44:03Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/implementation/util/Constants.java", "diffHunk": "@@ -3,10 +3,43 @@\n \n package com.azure.search.documents.implementation.util;\n \n+import com.azure.core.http.policy.HttpLogOptions;\n+\n+import java.util.function.Supplier;\n+\n public class Constants {\n     public static final String ENUM_INTERNAL_ERROR_MSG = \"The enum does not exist in internally used model %s.\";\n     public static final String ENUM_EXTERNAL_ERROR_MSG = \"The enum does not exist in externally used model %s.\";\n \n     public static final String ABSTRACT_INTERNAL_ERROR_MSG = \"The subclass does not exist in internal used model %s.\";\n     public static final String ABSTRACT_EXTERNAL_ERROR_MSG = \"The subclass does not exist in external used model %s.\";\n+\n+    public static final Supplier<HttpLogOptions> DEFAULT_LOG_OPTIONS_SUPPLIER = () -> {\n+        HttpLogOptions logOptions = new HttpLogOptions();\n+\n+        logOptions.addAllowedHeaderName(\"Access-Control-Allow-Credentials\");\n+        logOptions.addAllowedHeaderName(\"Access-Control-Allow-Headers\");\n+        logOptions.addAllowedHeaderName(\"Access-Control-Allow-Methods\");\n+        logOptions.addAllowedHeaderName(\"Access-Control-Allow-Origin\");\n+        logOptions.addAllowedHeaderName(\"Access-Control-Expose-Headers\");\n+        logOptions.addAllowedHeaderName(\"Access-Control-Max-Age\");\n+        logOptions.addAllowedHeaderName(\"Access-Control-Request-Headers\");\n+        logOptions.addAllowedHeaderName(\"Access-Control-Request-Method\");\n+        logOptions.addAllowedHeaderName(\"client-request-id\");\n+        logOptions.addAllowedHeaderName(\"elapsed-time\");\n+        logOptions.addAllowedHeaderName(\"Location\");\n+        logOptions.addAllowedHeaderName(\"OData-MaxVersion\");\n+        logOptions.addAllowedHeaderName(\"OData-Version\");\n+        logOptions.addAllowedHeaderName(\"Origin\");\n+        logOptions.addAllowedHeaderName(\"Prefer\");\n+        logOptions.addAllowedHeaderName(\"request-id\");\n+        logOptions.addAllowedHeaderName(\"return-client-request-id\");\n+        logOptions.addAllowedHeaderName(\"throttle-reason\");\n+\n+        logOptions.addAllowedQueryParamName(\"api-version\");\n+        logOptions.addAllowedQueryParamName(\"allowIndexDowntime\");\n+        logOptions.addAllowedQueryParamName(\"$select\");", "originalCommit": "67d106b9b0fa1fa59beee56a660150f5bdd8e3e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI2NzIxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13885#discussion_r467267219", "bodyText": "Removed", "author": "alzimmermsft", "createdAt": "2020-08-07T21:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI2MDEyMw=="}], "type": "inlineReview"}, {"oid": "8c7a474402018aa6a4753f101b7041c13d354bed", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8c7a474402018aa6a4753f101b7041c13d354bed", "message": "Remove select from the allowed query parameters list", "committedDate": "2020-08-07T21:02:08Z", "type": "commit"}]}