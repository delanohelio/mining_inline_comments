{"pr_number": 15801, "pr_title": "Use 'tenant-id' instead of 'common' in ClientRegistration.", "pr_createdAt": "2020-09-29T09:41:53Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15801", "timeline": [{"oid": "6f3342fd0c012dc37805c5c98932dc3896255da9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f3342fd0c012dc37805c5c98932dc3896255da9", "message": "Use 'tenant-id' instead of 'common' in ClientRegistration.", "committedDate": "2020-09-29T09:41:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MDcwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15801#discussion_r496740702", "bodyText": "Will multi-tenant application still function with this change?", "author": "saragluna", "createdAt": "2020-09-29T13:59:11Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/microsoft/azure/spring/autoconfigure/aad/AADOAuth2AutoConfiguration.java", "diffHunk": "@@ -36,29 +42,69 @@\n @ConditionalOnResource(resources = \"classpath:aad.enable.config\")\n @ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)\n @ConditionalOnProperty(prefix = \"azure.activedirectory\", value = \"tenant-id\")\n-@PropertySource(value = \"classpath:aad-oauth2-common.properties\")\n @PropertySource(value = \"classpath:service-endpoints.properties\")\n @EnableConfigurationProperties({ AADAuthenticationProperties.class, ServiceEndpointsProperties.class })\n public class AADOAuth2AutoConfiguration {\n \n-    private final AADAuthenticationProperties aadAuthProps;\n-    private final ServiceEndpointsProperties serviceEndpointsProps;\n+    private final AADAuthenticationProperties aadAuthenticationProperties;\n+    private final ServiceEndpointsProperties serviceEndpointsProperties;\n \n     public AADOAuth2AutoConfiguration(AADAuthenticationProperties aadAuthProperties,\n-                                      ServiceEndpointsProperties serviceEndpointsProps) {\n-        this.aadAuthProps = aadAuthProperties;\n-        this.serviceEndpointsProps = serviceEndpointsProps;\n+                                      ServiceEndpointsProperties serviceEndpointsProperties) {\n+        this.aadAuthenticationProperties = aadAuthProperties;\n+        this.serviceEndpointsProperties = serviceEndpointsProperties;\n     }\n \n     @Bean\n     @ConditionalOnProperty(prefix = \"azure.activedirectory.user-group\", value = \"allowed-groups\")\n     public OAuth2UserService<OidcUserRequest, OidcUser> oidcUserService() {\n-        return new AADOAuth2UserService(aadAuthProps, serviceEndpointsProps);\n+        return new AADOAuth2UserService(aadAuthenticationProperties, serviceEndpointsProperties);\n+    }\n+\n+    @Bean\n+    public ClientRegistrationRepository clientRegistrationRepository() {\n+        return new InMemoryClientRegistrationRepository(azureClientRegistration());\n+    }\n+\n+    private ClientRegistration azureClientRegistration() {\n+        String tenantId = aadAuthenticationProperties.getTenantId().trim();\n+        Assert.hasText(tenantId, \"azure.activedirectory.tenant-id should have text.\");\n+        Assert.doesNotContain(tenantId, \" \", \"azure.activedirectory.tenant-id should not contain ' '.\");\n+        Assert.doesNotContain(tenantId, \"/\", \"azure.activedirectory.tenant-id should not contain '/'.\");\n+        return ClientRegistration.withRegistrationId(\"azure\")", "originalCommit": "6f3342fd0c012dc37805c5c98932dc3896255da9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIxMjA0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15801#discussion_r502212042", "bodyText": "IMU, if we set azure.activedirectory.tenant-id=common, then multi-tenant application will function.", "author": "chenrujun", "createdAt": "2020-10-09T06:22:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MDcwMg=="}], "type": "inlineReview"}, {"oid": "e63300385f4d3c552d94098cec987c793df33207", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e63300385f4d3c552d94098cec987c793df33207", "message": "1. Fix link error. 2. Use config item azure.activedirectory.xxx instead of spring.security.", "committedDate": "2020-10-09T02:34:41Z", "type": "commit"}, {"oid": "7b971c654bbe07979f86b6ea9d01f32ecc8d595e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b971c654bbe07979f86b6ea9d01f32ecc8d595e", "message": "Update document about multi tenant.", "committedDate": "2020-10-09T02:38:13Z", "type": "commit"}, {"oid": "23863c789e85694ada406bfc3cac083c70702867", "url": "https://github.com/Azure/azure-sdk-for-java/commit/23863c789e85694ada406bfc3cac083c70702867", "message": "Update CHANGELOG.md.", "committedDate": "2020-10-09T02:46:18Z", "type": "commit"}, {"oid": "ee9a67ec20f4e33e1db092ca5606f6b9b3f9aed5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ee9a67ec20f4e33e1db092ca5606f6b9b3f9aed5", "message": "Update client-id in README.md.", "committedDate": "2020-10-09T06:12:14Z", "type": "commit"}, {"oid": "58b3706d1dd59f80481462020f7874de68958b7c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/58b3706d1dd59f80481462020f7874de68958b7c", "message": "Add more log to debug.", "committedDate": "2020-10-09T06:50:43Z", "type": "commit"}, {"oid": "e6daea34fc7bd037304214cba8d8f4a07ba1f56c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e6daea34fc7bd037304214cba8d8f4a07ba1f56c", "message": "Add more log to test.", "committedDate": "2020-10-09T07:50:30Z", "type": "commit"}, {"oid": "b528cb987b06509ccbad09a50bad73ad3f3b84cf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b528cb987b06509ccbad09a50bad73ad3f3b84cf", "message": "Merge branch 'master' into use-tenant-id-instead-of-common-in-oauth-provider-info", "committedDate": "2020-10-09T08:02:15Z", "type": "commit"}, {"oid": "e4f111b4b1a127436d60ea77e85b544ce6f0513d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e4f111b4b1a127436d60ea77e85b544ce6f0513d", "message": "Add more log to debug.", "committedDate": "2020-10-09T09:17:40Z", "type": "commit"}, {"oid": "0b6fb3aa5dac22a07c3a8bb501de88d91e702c85", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0b6fb3aa5dac22a07c3a8bb501de88d91e702c85", "message": "Add DummpApp.", "committedDate": "2020-10-10T05:10:55Z", "type": "commit"}, {"oid": "909d47fd0357c8e1efda7ea8a44a7c9c5c83c933", "url": "https://github.com/Azure/azure-sdk-for-java/commit/909d47fd0357c8e1efda7ea8a44a7c9c5c83c933", "message": "Fix integration test failure caused by this commit:\nhttps://github.com/Azure/azure-sdk-for-java/commit/bc00201c632332421be48e4d40814a0b166885d4", "committedDate": "2020-10-10T05:52:17Z", "type": "commit"}, {"oid": "68888e2d5b7b5fb8e08f98e07ad14ba9288762eb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/68888e2d5b7b5fb8e08f98e07ad14ba9288762eb", "message": "Fix typo.", "committedDate": "2020-10-10T05:55:34Z", "type": "commit"}, {"oid": "e88627bb45f9307b9ba189aeb53aa3670f312da3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e88627bb45f9307b9ba189aeb53aa3670f312da3", "message": "Add configure item `azure.activedirectory.scope`, delete configure item like 'spring.security.xxx'", "committedDate": "2020-10-10T06:51:45Z", "type": "commit"}, {"oid": "d6f2303b87eb0ed12bd1e738843e9b02f62fcca2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d6f2303b87eb0ed12bd1e738843e9b02f62fcca2", "message": "Fix the java doc of scope.", "committedDate": "2020-10-10T07:06:58Z", "type": "commit"}, {"oid": "6fb5c6e821448c0ae80cd0922e3cc8fd2c98ffb3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6fb5c6e821448c0ae80cd0922e3cc8fd2c98ffb3", "message": "Fix integration test failure: azure-cosmos does not support reactor-netty:0.9.10 (included by spring-bot2.2.x)", "committedDate": "2020-10-10T08:36:13Z", "type": "commit"}, {"oid": "711ad188d81ec08dd4c0e354a3916f9a48281405", "url": "https://github.com/Azure/azure-sdk-for-java/commit/711ad188d81ec08dd4c0e354a3916f9a48281405", "message": "Use another way to fix version problem: move azure-identity to keyvault starter module.", "committedDate": "2020-10-10T09:47:53Z", "type": "commit"}, {"oid": "27c71b1e17599b837bc019617bf47106b007749b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/27c71b1e17599b837bc019617bf47106b007749b", "message": "Add azure-identity in aad-starter and servicebus-starter.", "committedDate": "2020-10-12T00:57:33Z", "type": "commit"}]}