{"pr_number": 8055, "pr_title": "Deep copy buffer", "pr_createdAt": "2020-02-09T05:54:23Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/8055", "timeline": [{"oid": "aa4ffe501e9965dbd7d0be0e37cfa86c1408f0fe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aa4ffe501e9965dbd7d0be0e37cfa86c1408f0fe", "message": "Deep copy buffer", "committedDate": "2020-02-08T22:05:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1ODExNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376758115", "bodyText": "Could this be static?", "author": "alzimmermsft", "createdAt": "2020-02-09T06:11:21Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClient.java", "diffHunk": "@@ -190,7 +195,24 @@ public HttpHeaders getHeaders() {\n                 if (!reactorNettyConnection.isDisposed()) {\n                     reactorNettyConnection.channel().eventLoop().execute(reactorNettyConnection::dispose);\n                 }\n-            }).map(ByteBuf::nioBuffer);\n+            }).map(byteBuf -> {\n+                if (this.disableBufferCopy) {\n+                    return byteBuf.nioBuffer();\n+                }\n+                return deepCopyBuffer(byteBuf);\n+            });\n+        }\n+\n+        private ByteBuffer deepCopyBuffer(ByteBuf byteBuf) {", "originalCommit": "aa4ffe501e9965dbd7d0be0e37cfa86c1408f0fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjU4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376762589", "bodyText": "yeah, this can be static too.", "author": "srnagar", "createdAt": "2020-02-09T07:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1ODExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1ODE3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376758174", "bodyText": "Should the name be inverse and take a boolean to allow for this to be flipped back?", "author": "alzimmermsft", "createdAt": "2020-02-09T06:12:30Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClientBuilder.java", "diffHunk": "@@ -203,4 +204,9 @@ private ProxyHandler getProxyHandler(AuthorizationChallengeHandler challengeHand\n                     String.format(INVALID_PROXY_MESSAGE, proxyOptions.getType())));\n         }\n     }\n+\n+    public NettyAsyncHttpClientBuilder disableBufferCopy() {", "originalCommit": "aa4ffe501e9965dbd7d0be0e37cfa86c1408f0fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjYyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376762620", "bodyText": "The name should be disable as, by default, it will be enabled. I can add a param to toggle.", "author": "srnagar", "createdAt": "2020-02-09T07:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1ODE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1ODE4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376758184", "bodyText": "Missing Javadoc", "author": "alzimmermsft", "createdAt": "2020-02-09T06:12:46Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClientBuilder.java", "diffHunk": "@@ -203,4 +204,9 @@ private ProxyHandler getProxyHandler(AuthorizationChallengeHandler challengeHand\n                     String.format(INVALID_PROXY_MESSAGE, proxyOptions.getType())));\n         }\n     }\n+\n+    public NettyAsyncHttpClientBuilder disableBufferCopy() {", "originalCommit": "aa4ffe501e9965dbd7d0be0e37cfa86c1408f0fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjY0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376762649", "bodyText": "will do all the javadoc, checkstyle, spotbugs stuff once we are happy with the shape of the code", "author": "srnagar", "createdAt": "2020-02-09T07:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1ODE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1ODgyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376758820", "bodyText": "Should this be in the bodyIntern method instead?", "author": "alzimmermsft", "createdAt": "2020-02-09T06:27:03Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClient.java", "diffHunk": "@@ -190,7 +195,24 @@ public HttpHeaders getHeaders() {\n                 if (!reactorNettyConnection.isDisposed()) {\n                     reactorNettyConnection.channel().eventLoop().execute(reactorNettyConnection::dispose);\n                 }\n-            }).map(ByteBuf::nioBuffer);\n+            }).map(byteBuf -> {", "originalCommit": "aa4ffe501e9965dbd7d0be0e37cfa86c1408f0fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjcwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376762702", "bodyText": "As discussed, changing bodyIntern will result in double copy for other getBody* methods that don't return Flux<ByteBuffer>", "author": "srnagar", "createdAt": "2020-02-09T07:51:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1ODgyMA=="}], "type": "inlineReview"}, {"oid": "c77ddb1c8728be9d2c82f3c0c671d61840ef56f4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c77ddb1c8728be9d2c82f3c0c671d61840ef56f4", "message": "Merge branch 'master' into netty-buffer-copy", "committedDate": "2020-02-09T06:40:30Z", "type": "commit"}, {"oid": "6260400bfa3bd8193efc06a538dd8073d1f28aaf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6260400bfa3bd8193efc06a538dd8073d1f28aaf", "message": "Disable buffer copy to support sync client", "committedDate": "2020-02-09T07:48:06Z", "type": "commit"}, {"oid": "ec548c331fe62230817486bccf780d09df718dea", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ec548c331fe62230817486bccf780d09df718dea", "message": "Add another overload to http client send", "committedDate": "2020-02-09T08:01:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MzM2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376763369", "bodyText": "can this be package private? given HttpPipeline type calls HttpClient::send()?", "author": "anuchandy", "createdAt": "2020-02-09T08:03:21Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/HttpPipelineCallContext.java", "diffHunk": "@@ -85,4 +85,8 @@ public HttpPipelineCallContext setHttpRequest(HttpRequest request) {\n         this.httpRequest = request;\n         return this;\n     }\n+\n+    public Context getContext() {\n+        return this.getContext();\n+    }", "originalCommit": "ec548c331fe62230817486bccf780d09df718dea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0019a56f06c4ac8f332311d8cfba0bb0f1a7d3f0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0019a56f06c4ac8f332311d8cfba0bb0f1a7d3f0", "message": "Update download overloads with context", "committedDate": "2020-02-09T08:14:59Z", "type": "commit"}, {"oid": "7f03f41fb7d7f2acdd588fa1ceb4864147447a55", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7f03f41fb7d7f2acdd588fa1ceb4864147447a55", "message": "Clean up", "committedDate": "2020-02-09T08:49:09Z", "type": "commit"}, {"oid": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "message": "Update versions", "committedDate": "2020-02-09T09:00:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2Njc5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376766792", "bodyText": "minor; maybe not now, but we could have a static empty ByteBuffer in class level and if size == 0, we can just return that, instead of creating a new empty duplicate reference every time.", "author": "anuchandy", "createdAt": "2020-02-09T09:03:25Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClient.java", "diffHunk": "@@ -235,5 +258,17 @@ private ByteBufFlux bodyIntern() {\n         Connection internConnection() {\n             return reactorNettyConnection;\n         }\n+\n+        private static ByteBuffer deepCopyBuffer(ByteBuf byteBuf) {\n+            ByteBuffer buffer = byteBuf.nioBuffer();\n+            int offset = buffer.position();\n+            int size = buffer.remaining();", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2NzMyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376767321", "bodyText": "nit: commented code.", "author": "anuchandy", "createdAt": "2020-02-09T09:12:36Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/HttpPipelineNextPolicy.java", "diffHunk": "@@ -41,7 +41,8 @@\n \n         this.currentPolicyIndex++;\n         if (this.currentPolicyIndex == size) {\n-            return this.pipeline.getHttpClient().send(this.context.getHttpRequest());\n+            return this.pipeline.getHttpClient().send(this.context.getHttpRequest(), this.context.getContext());\n+            // return this.pipeline.getHttpClient().send(this.context);", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2NzQ1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376767455", "bodyText": "nit; good to add bit more context on this const.", "author": "anuchandy", "createdAt": "2020-02-09T09:14:41Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/CoreConstants.java", "diffHunk": "@@ -0,0 +1,19 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.util;\n+\n+/**\n+ * Class to hold commonly used constants.\n+ */\n+public final class CoreConstants {\n+\n+    /**\n+     * This constant is used as key in {@link Context}.\n+     */\n+    public static final String DISABLE_BUFFER_COPY = \"disable-buffer-copy\";", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2NzUwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376767508", "bodyText": "nit; Context.NONE.addData(CoreConstants.DISABLE_BUFFER_COPY, true)", "author": "anuchandy", "createdAt": "2020-02-09T09:15:29Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java", "diffHunk": "@@ -549,8 +554,11 @@ public BlobProperties downloadToFile(String filePath, boolean overwrite) {\n         ParallelTransferOptions parallelTransferOptions, DownloadRetryOptions downloadRetryOptions,\n         BlobRequestConditions requestConditions, boolean rangeGetContentMd5, Set<OpenOption> openOptions,\n         Duration timeout, Context context) {\n+        Context updatedContext = context == null ? Context.NONE.addData(CoreConstants.DISABLE_BUFFER_COPY, true)\n+            : context.addData(\"disable-buffer-copy\", true);", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMjc2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376802762", "bodyText": "Do we need to use Context.NONE in this situation? Instead could a new Context be used?", "author": "alzimmermsft", "createdAt": "2020-02-09T18:04:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2NzUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMTQxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376811410", "bodyText": "Context doesn't have a simple helper method to create one with just 1 key-value pair. I had to create a map first and then create context, instead, I used this alternative which was simpler.", "author": "srnagar", "createdAt": "2020-02-09T20:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2NzUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMTQ3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376811477", "bodyText": "Reduce this to a one-liner: return disableBufferCopy ? byteBuf.nioBuffer() : deepCopyBuffer(byteBuf);", "author": "JonathanGiles", "createdAt": "2020-02-09T20:10:46Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClient.java", "diffHunk": "@@ -190,7 +208,12 @@ public HttpHeaders getHeaders() {\n                 if (!reactorNettyConnection.isDisposed()) {\n                     reactorNettyConnection.channel().eventLoop().execute(reactorNettyConnection::dispose);\n                 }\n-            }).map(ByteBuf::nioBuffer);\n+            }).map(byteBuf -> {\n+                if (this.disableBufferCopy) {\n+                    return byteBuf.nioBuffer();\n+                }\n+                return deepCopyBuffer(byteBuf);", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMTY0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376811645", "bodyText": "It would be good to include code here to demonstrate how to use the buffer correctly if the user chooses to disable this, and to also talk about how this will benefit throughput and memory pressure.", "author": "JonathanGiles", "createdAt": "2020-02-09T20:13:14Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClientBuilder.java", "diffHunk": "@@ -180,6 +182,22 @@ public NettyAsyncHttpClientBuilder configuration(Configuration configuration) {\n         return this;\n     }\n \n+    /**\n+     * Disables deep copy of response {@link ByteBuffer} into a heap location that is managed by this client as\n+     * opposed to the underlying netty library which may use direct buffer pool.\n+     * <br>\n+     * <b>\n+     * Caution: Disabling this is not recommended as it can lead to data corruption if the downstream consumers\n+     * of the response do not handle the byte buffers before netty releases them.\n+     * </b>", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjU3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376816573", "bodyText": "I will add more docs for this.", "author": "srnagar", "createdAt": "2020-02-09T21:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMTY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMjQxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376812413", "bodyText": "nit: Unnecessary newline", "author": "JonathanGiles", "createdAt": "2020-02-09T20:23:36Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java", "diffHunk": "@@ -385,6 +386,7 @@ public String copyFromUrl(String copySource) {\n      */\n     public void download(OutputStream stream) {\n         downloadWithResponse(stream, null, null, null, false, null, Context.NONE);\n+", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMjQ5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376812493", "bodyText": "I'd like to see this kind of repetitive (and verbose) code moved into a utility method.", "author": "JonathanGiles", "createdAt": "2020-02-09T20:24:55Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java", "diffHunk": "@@ -412,9 +414,12 @@ public void download(OutputStream stream) {\n     public BlobDownloadResponse downloadWithResponse(OutputStream stream, BlobRange range,\n         DownloadRetryOptions options, BlobRequestConditions requestConditions, boolean getRangeContentMd5,\n         Duration timeout, Context context) {\n+        Context updatedContext = context == null ? Context.NONE.addData(CoreConstants.DISABLE_BUFFER_COPY, true)\n+            : context.addData(CoreConstants.DISABLE_BUFFER_COPY, true);", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMjU2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376812569", "bodyText": "I feel a little uneasy with making this public API right now. I would rather it be impl to start with?", "author": "JonathanGiles", "createdAt": "2020-02-09T20:25:49Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/CoreConstants.java", "diffHunk": "@@ -0,0 +1,19 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.util;\n+\n+/**\n+ * Class to hold commonly used constants.\n+ */\n+public final class CoreConstants {", "originalCommit": "05a5f8e509a1e722b6b40f67d3b85dd73b7a3c0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c429c1006e2f9c90fc450181699a9ba25c8e2b9a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c429c1006e2f9c90fc450181699a9ba25c8e2b9a", "message": "Move context update to utility method", "committedDate": "2020-02-09T21:17:45Z", "type": "commit"}, {"oid": "ee15bbeede181df7cdbab65ec8dea64f5a2d9868", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ee15bbeede181df7cdbab65ec8dea64f5a2d9868", "message": "Updated design for sync clients", "committedDate": "2020-02-09T22:27:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgyMjAzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r376822030", "bodyText": "This class looks like it can now be reverted", "author": "JonathanGiles", "createdAt": "2020-02-09T22:33:50Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlobClientBase.java", "diffHunk": "@@ -550,7 +551,8 @@ public BlobProperties downloadToFile(String filePath, boolean overwrite) {\n         BlobRequestConditions requestConditions, boolean rangeGetContentMd5, Set<OpenOption> openOptions,\n         Duration timeout, Context context) {\n         Mono<Response<BlobProperties>> download = client.downloadToFileWithResponse(filePath, range,\n-            parallelTransferOptions, downloadRetryOptions, requestConditions, rangeGetContentMd5, openOptions, context);\n+            parallelTransferOptions, downloadRetryOptions, requestConditions, rangeGetContentMd5, openOptions,\n+            context);", "originalCommit": "ee15bbeede181df7cdbab65ec8dea64f5a2d9868", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b7d7e79dfcd6dc50adbc4225ab6e6503ae6f8689", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b7d7e79dfcd6dc50adbc4225ab6e6503ae6f8689", "message": "Added tests to verify deep copying and preventing deep copying", "committedDate": "2020-02-10T01:19:55Z", "type": "commit"}, {"oid": "b253bf397b0a5d69203f12041e70c0c7fd8a2b31", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b253bf397b0a5d69203f12041e70c0c7fd8a2b31", "message": "Update client to allow setting context just once", "committedDate": "2020-02-10T01:23:01Z", "type": "commit"}, {"oid": "4d94b747e1c9af6b2f3d8a6c03f6cb37a424c1d6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4d94b747e1c9af6b2f3d8a6c03f6cb37a424c1d6", "message": "Additional tests for context based configuration", "committedDate": "2020-02-10T01:59:53Z", "type": "commit"}, {"oid": "f99f0b4e6278cd9d2fe86286accf1f3621e4c49a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f99f0b4e6278cd9d2fe86286accf1f3621e4c49a", "message": "Update all builders to use deep copy context", "committedDate": "2020-02-10T02:54:47Z", "type": "commit"}, {"oid": "c3eca57631b0d8cb006af7044e5dd7ba7019ed6f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3eca57631b0d8cb006af7044e5dd7ba7019ed6f", "message": "Update ShareClientBuilder", "committedDate": "2020-02-10T04:14:48Z", "type": "commit"}, {"oid": "61666e55abe3b7953990309063e6f58c666366ec", "url": "https://github.com/Azure/azure-sdk-for-java/commit/61666e55abe3b7953990309063e6f58c666366ec", "message": "Fix checkstyles and spotbugs issues", "committedDate": "2020-02-10T08:40:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE5NDg2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377194866", "bodyText": "Since these two methods deepCopyBufferConfiguredInBuilder and ignoreDeepCopyBufferConfiguredInBuilder  only differs in boolean values for disableBufferCopy. Could we use dataprovider to pass the Boolean and just have one method which test both use cases ?", "author": "hemanttanwar", "createdAt": "2020-02-10T17:05:32Z", "path": "sdk/core/azure-core-http-netty/src/test/java/com/azure/core/http/netty/ReactorNettyClientTests.java", "diffHunk": "@@ -281,6 +291,102 @@ public void testConcurrentRequests() {\n         Assertions.fail(\"Method needs to be reimplemented\");\n     }\n \n+    /**\n+     * Tests that deep copying the buffers returned by Netty will make the stream returned to the customer resilient to\n+     * Netty reclaiming them once the 'onNext' operator chain has completed.\n+     */\n+    @Test\n+    public void deepCopyBufferConfiguredInBuilder() {\n+        HttpClient client = new NettyAsyncHttpClientBuilder().disableBufferCopy(false).build();\n+\n+        HttpResponse response = client.send(new HttpRequest(HttpMethod.GET, url(server, LONG_BODY_PATH))).block();\n+        assertNotNull(response);\n+        assertEquals(200, response.getStatusCode());\n+\n+        DelayWriteStream delayWriteStream = new DelayWriteStream();\n+        response.getBody().doOnNext(delayWriteStream::write).blockLast();\n+        assertEquals(LONG_BODY, delayWriteStream.aggregateAsString());\n+    }\n+\n+    /**\n+     * Tests that preventing deep copying the buffers returned by Netty won't make the stream returned to the customer\n+     * resilient to Netty reclaiming them once the 'onNext' operator chain has completed.\n+     */\n+    @Test\n+    public void ignoreDeepCopyBufferConfiguredInBuilder() {", "originalCommit": "61666e55abe3b7953990309063e6f58c666366ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE5NTYwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377195602", "bodyText": "Same comment , dataprovider for Boolean value ?", "author": "hemanttanwar", "createdAt": "2020-02-10T17:06:48Z", "path": "sdk/core/azure-core-http-netty/src/test/java/com/azure/core/http/netty/ReactorNettyClientTests.java", "diffHunk": "@@ -281,6 +291,102 @@ public void testConcurrentRequests() {\n         Assertions.fail(\"Method needs to be reimplemented\");\n     }\n \n+    /**\n+     * Tests that deep copying the buffers returned by Netty will make the stream returned to the customer resilient to\n+     * Netty reclaiming them once the 'onNext' operator chain has completed.\n+     */\n+    @Test\n+    public void deepCopyBufferConfiguredInBuilder() {\n+        HttpClient client = new NettyAsyncHttpClientBuilder().disableBufferCopy(false).build();\n+\n+        HttpResponse response = client.send(new HttpRequest(HttpMethod.GET, url(server, LONG_BODY_PATH))).block();\n+        assertNotNull(response);\n+        assertEquals(200, response.getStatusCode());\n+\n+        DelayWriteStream delayWriteStream = new DelayWriteStream();\n+        response.getBody().doOnNext(delayWriteStream::write).blockLast();\n+        assertEquals(LONG_BODY, delayWriteStream.aggregateAsString());\n+    }\n+\n+    /**\n+     * Tests that preventing deep copying the buffers returned by Netty won't make the stream returned to the customer\n+     * resilient to Netty reclaiming them once the 'onNext' operator chain has completed.\n+     */\n+    @Test\n+    public void ignoreDeepCopyBufferConfiguredInBuilder() {\n+        HttpClient client = new NettyAsyncHttpClientBuilder().disableBufferCopy(true).build();\n+\n+        HttpResponse response = client.send(new HttpRequest(HttpMethod.GET, url(server, LONG_BODY_PATH))).block();\n+        assertNotNull(response);\n+        assertEquals(200, response.getStatusCode());\n+\n+        DelayWriteStream delayWriteStream = new DelayWriteStream();\n+        response.getBody().doOnNext(delayWriteStream::write).blockLast();\n+        assertNotEquals(LONG_BODY, delayWriteStream.aggregateAsString());\n+    }\n+\n+    /**\n+     * Tests that deep copying of buffers is able to be configured via {@link Context}.\n+     */\n+    @Test\n+    public void deepCopyBufferConfiguredByContext() {\n+        HttpClient client = new ReactorNettyClientProvider().createInstance()\n+            .initContext(new Context(CoreConstants.DISABLE_BUFFER_COPY, false));\n+\n+        HttpResponse response = client.send(new HttpRequest(HttpMethod.GET, url(server, LONG_BODY_PATH))).block();\n+        assertNotNull(response);\n+        assertEquals(200, response.getStatusCode());\n+\n+        DelayWriteStream delayWriteStream = new DelayWriteStream();\n+        response.getBody().doOnNext(delayWriteStream::write).blockLast();\n+        assertEquals(LONG_BODY, delayWriteStream.aggregateAsString());\n+    }\n+\n+    /**\n+     * Tests that deep copying of buffers is able to be suppressed via {@link Context}.\n+     */\n+    @Test\n+    public void ignoreDeepCopyBufferConfiguredByContext() {\n+        HttpClient client = new ReactorNettyClientProvider().createInstance()", "originalCommit": "61666e55abe3b7953990309063e6f58c666366ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwMTQwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377201409", "bodyText": "Also This would be a good candidate to add sample in samples\\README.md showing how user can use this.\nAlso changelog entry for this change.", "author": "hemanttanwar", "createdAt": "2020-02-10T17:17:09Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClientBuilder.java", "diffHunk": "@@ -180,6 +182,24 @@ public NettyAsyncHttpClientBuilder configuration(Configuration configuration) {\n         return this;\n     }\n \n+    /**\n+     * Disables deep copy of response {@link ByteBuffer} into a heap location that is managed by this client as\n+     * opposed to the underlying netty library which may use direct buffer pool.\n+     * <br>\n+     * <b>\n+     * Caution: Disabling this is not recommended as it can lead to data corruption if the downstream consumers\n+     * of the response do not handle the byte buffers before netty releases them.\n+     * </b>\n+     *\n+     * @param disableBufferCopy If set to {@code true}, the client built from this builder will not deep-copy\n+     * response {@link ByteBuffer ByteBuffers}.\n+     * @return The updated {@link NettyAsyncHttpClientBuilder} object.\n+     */\n+    public NettyAsyncHttpClientBuilder disableBufferCopy(boolean disableBufferCopy) {", "originalCommit": "61666e55abe3b7953990309063e6f58c666366ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwNDM2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377404367", "bodyText": "Since this behavior is not something we want users to eagerly use, I don't want to put this in README. I have the javadoc updated with codesnippets. So, if they really want to use, they can find it's usage in javadocs.", "author": "srnagar", "createdAt": "2020-02-11T00:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwMTQwOQ=="}], "type": "inlineReview"}, {"oid": "3df1acbb6844aa0ca5f334e3d5768701ad3370bf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3df1acbb6844aa0ca5f334e3d5768701ad3370bf", "message": "Tests for buffering response in download to file tests", "committedDate": "2020-02-10T19:20:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI5MDU2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377290569", "bodyText": "Can you add some sort of comment here that mentions this method should be called when building any sync clients because the underlying issue is not a problem in those cases? I think it'll help document why we default to using this in a bunch of our builders.", "author": "rickle-msft", "createdAt": "2020-02-10T20:11:59Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/CoreUtils.java", "diffHunk": "@@ -183,4 +184,17 @@ public static boolean isNullOrEmpty(CharSequence charSequence) {\n         }\n         return Collections.emptyMap();\n     }\n+\n+    /**\n+     * Convenience method to update the input context to disable copying of HTTP response byte buffers. If the input\n+     * context is null, a new instance of context is created with a single entry to disable copying of HTTP response\n+     * byte buffers.", "originalCommit": "3df1acbb6844aa0ca5f334e3d5768701ad3370bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI5NDU4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377294583", "bodyText": "Our plan has just evolved to also do buffer copy on sync clients too. Srikanta is just beginning the process of removing these changes so that sync and async both copy the buffer. This is to remove any possibility of data loss in sync clients when there are intermediate operations during which time the buffer may still be lost.", "author": "JonathanGiles", "createdAt": "2020-02-10T20:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI5MDU2OQ=="}], "type": "inlineReview"}, {"oid": "05a89f7caf856bfee80fdedf46c3708e1de82636", "url": "https://github.com/Azure/azure-sdk-for-java/commit/05a89f7caf856bfee80fdedf46c3708e1de82636", "message": "Sync clients will deep copy by default", "committedDate": "2020-02-10T21:43:09Z", "type": "commit"}, {"oid": "5ab444657ec38fda45db1bb980963476550f62bd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5ab444657ec38fda45db1bb980963476550f62bd", "message": "Add code snippets and more documentation for disabled copy buffer option", "committedDate": "2020-02-10T21:59:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0NDAwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377344000", "bodyText": "nit: Random newline change", "author": "alzimmermsft", "createdAt": "2020-02-10T22:03:56Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/HttpPipelineBuilder.java", "diffHunk": "@@ -40,7 +40,6 @@\n     private HttpClient httpClient;\n     private List<HttpPipelinePolicy> pipelinePolicies;\n \n-", "originalCommit": "5ab444657ec38fda45db1bb980963476550f62bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0NDA5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377344095", "bodyText": "nit: Random newline change", "author": "alzimmermsft", "createdAt": "2020-02-10T22:04:05Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/implementation/http/HttpClientProviders.java", "diffHunk": "@@ -32,7 +32,6 @@ public static HttpClient createInstance() {\n         if (defaultProvider == null) {\n             throw new IllegalStateException(CANNOT_FIND_HTTP_CLIENT);\n         }\n-", "originalCommit": "5ab444657ec38fda45db1bb980963476550f62bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5d3556f96a98be2bb433cd7ce8c1d96c3db6c7d6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5d3556f96a98be2bb433cd7ce8c1d96c3db6c7d6", "message": "Remove tests that tested APIs that no longer exist", "committedDate": "2020-02-10T22:14:52Z", "type": "commit"}, {"oid": "733b297505f81e5a99f3e4090bcc0c699e223a7a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/733b297505f81e5a99f3e4090bcc0c699e223a7a", "message": "Merge branch 'netty-buffer-copy' of https://github.com/srnagar/azure-sdk-for-java into netty-buffer-copy", "committedDate": "2020-02-10T22:16:05Z", "type": "commit"}, {"oid": "a151038b9dc2c7327114f6b8251b8a30736af972", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a151038b9dc2c7327114f6b8251b8a30736af972", "message": "Fix version tags", "committedDate": "2020-02-10T22:57:46Z", "type": "commit"}, {"oid": "a1a60a0df57b97ab0595aa0199baac59a7c8d786", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a1a60a0df57b97ab0595aa0199baac59a7c8d786", "message": "Fix version tags", "committedDate": "2020-02-10T23:14:45Z", "type": "commit"}, {"oid": "a56d119336b8c3677fda35b717f349de533f8a18", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a56d119336b8c3677fda35b717f349de533f8a18", "message": "Update version tags", "committedDate": "2020-02-11T00:41:26Z", "type": "commit"}, {"oid": "dde7065bb62780dfaa2b6b1b4a8ae57f0dfb4415", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dde7065bb62780dfaa2b6b1b4a8ae57f0dfb4415", "message": "Update deep copy impl", "committedDate": "2020-02-11T01:48:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxNzM1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377417352", "bodyText": "Why not use StepVerifier here to expect next rather than blockLast()?", "author": "conniey", "createdAt": "2020-02-11T01:59:49Z", "path": "sdk/core/azure-core-http-netty/src/test/java/com/azure/core/http/netty/ReactorNettyClientTests.java", "diffHunk": "@@ -281,6 +289,56 @@ public void testConcurrentRequests() {\n         Assertions.fail(\"Method needs to be reimplemented\");\n     }\n \n+    /**\n+     * Tests that deep copying the buffers returned by Netty will make the stream returned to the customer resilient to\n+     * Netty reclaiming them once the 'onNext' operator chain has completed.\n+     */\n+    @Test\n+    public void deepCopyBufferConfiguredInBuilder() {\n+        HttpClient client = new NettyAsyncHttpClientBuilder().disableBufferCopy(false).build();\n+\n+        HttpResponse response = client.send(new HttpRequest(HttpMethod.GET, url(server, LONG_BODY_PATH))).block();\n+        assertNotNull(response);\n+        assertEquals(200, response.getStatusCode());\n+\n+        DelayWriteStream delayWriteStream = new DelayWriteStream();\n+        response.getBody().doOnNext(delayWriteStream::write).blockLast();", "originalCommit": "dde7065bb62780dfaa2b6b1b4a8ae57f0dfb4415", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxNzU1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8055#discussion_r377417554", "bodyText": "StepVerifier.create(response.getBody())\n.assertNext(body -> {\n     // deserialize and assert\n})\n.expectComplete()\n.verify();", "author": "conniey", "createdAt": "2020-02-11T02:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxNzM1Mg=="}], "type": "inlineReview"}]}