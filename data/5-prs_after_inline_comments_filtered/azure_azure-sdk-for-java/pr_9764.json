{"pr_number": 9764, "pr_title": "Search page continuation token takes extra apiVersion and nextLink", "pr_createdAt": "2020-04-02T00:57:21Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9764", "timeline": [{"oid": "855038a293b10e7e91a4723278965153f7e456c2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/855038a293b10e7e91a4723278965153f7e456c2", "message": "Search page change for json serialization", "committedDate": "2020-04-02T00:54:23Z", "type": "commit"}, {"oid": "8846c395a78782a249a20c5b9eb79711c549c025", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8846c395a78782a249a20c5b9eb79711c549c025", "message": "Fixed linting issues", "committedDate": "2020-04-02T01:39:00Z", "type": "commit"}, {"oid": "e86110a63e24a4e0b5db14ec7994a48b3ac7eec0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e86110a63e24a4e0b5db14ec7994a48b3ac7eec0", "message": "Fixed spotbugs", "committedDate": "2020-04-02T01:57:17Z", "type": "commit"}, {"oid": "4ee77f25aed9a9c2a5f352919605bdaa7f69781e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4ee77f25aed9a9c2a5f352919605bdaa7f69781e", "message": "keep the parameter for getter", "committedDate": "2020-04-02T16:59:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2Mjk2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402462966", "bodyText": "Could we just wrap the IOException in an UncheckedIOException and bubble that up.\nthrow logger.logExceptionAsError(new UncheckedIOException(e));", "author": "alzimmermsft", "createdAt": "2020-04-02T16:53:01Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/SearchIndexAsyncClient.java", "diffHunk": "@@ -643,6 +643,21 @@ private static SearchRequest createSearchRequest(String searchText, SearchOption\n         return searchRequest;\n     }\n \n+    /**\n+     * Build request from continuation token.\n+     *\n+     * @param continuationToken The token used to deserialize the SearchRequest.\n+     * @return The SearchRequest for next page.\n+     */\n+    private SearchRequest buildRequestFromToken(String continuationToken) {\n+        try {\n+            return new JacksonAdapter().deserialize(continuationToken, SearchRequest.class, SerializerEncoding.JSON);\n+        } catch (IOException e) {\n+            throw logger.logExceptionAsError(new RuntimeException(\"Failed to deserialize the token to search request\"", "originalCommit": "e86110a63e24a4e0b5db14ec7994a48b3ac7eec0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNTk3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402535976", "bodyText": "I feel like this should be thrown as an ArgumentException for an \"Invalid continuationToken\" if you folks have a similar exception in Java.  Users didn't explicitly serialize the continuationToken themselves so an error message saying it failed to deserialize might be kind of confusing given that we have a bunch of other serialization related magic happening all over the place in these APIs.", "author": "tg-msft", "createdAt": "2020-04-02T18:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2Mjk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2MzUwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402563502", "bodyText": "Based on that I would go with IllegalStateException which is meant to cover scenarios where the application ran into an unrecoverable state, IllegalArgumentException is reserved for scenarios where a user passed in a bad value.", "author": "alzimmermsft", "createdAt": "2020-04-02T19:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2Mjk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2Njg4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402566887", "bodyText": "That is the only case we're going to get an error for though - when the user passes us a continuationToken that doesn't correctly deserialize.", "author": "tg-msft", "createdAt": "2020-04-02T19:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2Mjk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NzExMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402657112", "bodyText": "Thanks for the discussion!\nnextLink and nextParameter are both provided by service.\napiVersion is sdk library enum.\nThese three things all from SDK and above, and user has no way to manipulate it.\nFor serialization code, I will go with IllegalStateException.\nFor deserialization code, user is able to pass wrong continuation token. I will go with IllegalArgumentException", "author": "sima-zhu", "createdAt": "2020-04-02T23:40:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2Mjk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2NTE0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402465148", "bodyText": "This should be implementing PagedResponse, not PagedResponseBase. Right now this is saying that we have a paged response whose value list is SearchResult and whose headers are type SearchResult.", "author": "alzimmermsft", "createdAt": "2020-04-02T16:56:24Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/util/SearchPagedResponse.java", "diffHunk": "@@ -27,24 +35,30 @@\n  * to true coverage - coverage value.\n  */\n @Immutable\n-public final class SearchPagedResponse implements ContinuablePage<SearchRequest, SearchResult>,\n-    Response<List<SearchResult>> {\n+public final class SearchPagedResponse extends PagedResponseBase<SearchResult, SearchResult> {", "originalCommit": "e86110a63e24a4e0b5db14ec7994a48b3ac7eec0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ4NjE2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402486161", "bodyText": "Changed to PagedResponseBase<Void, SearchResult> for convenience getter.", "author": "sima-zhu", "createdAt": "2020-04-02T17:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2NTE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2NjI3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402466271", "bodyText": "nit: Could we rename this createContinuationToken, this isn't setting it.", "author": "alzimmermsft", "createdAt": "2020-04-02T16:58:00Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/util/SearchPagedResponse.java", "diffHunk": "@@ -54,8 +68,27 @@ public SearchPagedResponse(SimpleResponse<SearchDocumentsResult> documentSearchR\n         this.facets = documentsResult.getFacets();\n         this.count = documentsResult.getCount();\n         this.coverage = documentsResult.getCoverage();\n+    }\n+\n+    private static String setContinuationToken(SimpleResponse<SearchDocumentsResult> documentSearchResponse,", "originalCommit": "e86110a63e24a4e0b5db14ec7994a48b3ac7eec0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33163bed160213727bcf67925499ea9a13d55864", "url": "https://github.com/Azure/azure-sdk-for-java/commit/33163bed160213727bcf67925499ea9a13d55864", "message": "Simplify", "committedDate": "2020-04-02T17:15:59Z", "type": "commit"}, {"oid": "35432e2852cacf796c70e45f9e9c87f17e3ea203", "url": "https://github.com/Azure/azure-sdk-for-java/commit/35432e2852cacf796c70e45f9e9c87f17e3ea203", "message": "Make changes to SearchPageResponse", "committedDate": "2020-04-02T17:35:03Z", "type": "commit"}, {"oid": "2eadc8fdf524bff228fe9168d74ee066a70db2f6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2eadc8fdf524bff228fe9168d74ee066a70db2f6", "message": "Fixed linting", "committedDate": "2020-04-02T18:00:42Z", "type": "commit"}, {"oid": "d39bbe739dc6afa3d35b0c09b8cb4b8f13f97ea4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d39bbe739dc6afa3d35b0c09b8cb4b8f13f97ea4", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into page_continuation", "committedDate": "2020-04-02T18:00:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTI0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402539244", "bodyText": "This isn't the full continuation token value.  You're only setting this to the serialized version of getNextPageParameters().", "author": "tg-msft", "createdAt": "2020-04-02T18:53:31Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/util/SearchPagedResponse.java", "diffHunk": "@@ -103,33 +127,13 @@ public Long getCount() {\n         return count;\n     }\n \n-    @Override\n-    public int getStatusCode() {\n-        return statusCode;\n-    }\n-\n-    @Override\n-    public HttpHeaders getHeaders() {\n-        return headers;\n-    }\n-\n-    @Override\n-    public HttpRequest getRequest() {\n-        return request;\n-    }\n-\n     @Override\n     public List<SearchResult> getValue() {\n         return value;\n     }\n \n     @Override\n-    public IterableStream<SearchResult> getElements() {\n-        return new IterableStream<>(value);\n-    }\n-\n-    @Override\n-    public SearchRequest getContinuationToken() {\n-        return nextPageParameters;\n+    public String getContinuationToken() {\n+        return nextParameters;", "originalCommit": "35432e2852cacf796c70e45f9e9c87f17e3ea203", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYxOTE1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402619156", "bodyText": "Will make this return the encoded string.", "author": "sima-zhu", "createdAt": "2020-04-02T21:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTc2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402539768", "bodyText": "Why is this changing from SearchRequest to string?  It's not actually the continuation token but just the next page params part of it.", "author": "tg-msft", "createdAt": "2020-04-02T18:54:21Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/util/SearchPagedResponse.java", "diffHunk": "@@ -27,45 +33,63 @@\n  * to true coverage - coverage value.\n  */\n @Immutable\n-public final class SearchPagedResponse implements ContinuablePage<SearchRequest, SearchResult>,\n-    Response<List<SearchResult>> {\n-    private final int statusCode;\n-    private final HttpHeaders headers;\n-    private final HttpRequest request;\n+public final class SearchPagedResponse extends PagedResponseBase<Void, SearchResult> {\n     private final List<SearchResult> value;\n \n-    private final SearchRequest nextPageParameters;\n     private final Map<String, List<FacetResult>> facets;\n     private final Long count;\n     private final Double coverage;\n+    private final String nextParameters;", "originalCommit": "35432e2852cacf796c70e45f9e9c87f17e3ea203", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYxOTg5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402619892", "bodyText": "Remove nextParameters getter and use getContinuationToken return encoded token instead.", "author": "sima-zhu", "createdAt": "2020-04-02T21:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTk2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402539962", "bodyText": "This should still give you back the SearchRequest data structure.  We should do the JSON serialization of that value in createContinuationToken.", "author": "tg-msft", "createdAt": "2020-04-02T18:54:41Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/util/SearchPagedResponse.java", "diffHunk": "@@ -27,45 +33,63 @@\n  * to true coverage - coverage value.\n  */\n @Immutable\n-public final class SearchPagedResponse implements ContinuablePage<SearchRequest, SearchResult>,\n-    Response<List<SearchResult>> {\n-    private final int statusCode;\n-    private final HttpHeaders headers;\n-    private final HttpRequest request;\n+public final class SearchPagedResponse extends PagedResponseBase<Void, SearchResult> {\n     private final List<SearchResult> value;\n \n-    private final SearchRequest nextPageParameters;\n     private final Map<String, List<FacetResult>> facets;\n     private final Long count;\n     private final Double coverage;\n+    private final String nextParameters;\n \n     /**\n      * Constructor\n      *\n-     * @param documentSearchResponse an http response with the results\n+     * @param documentSearchResponse An http response with the results.\n+     * @param serviceVersion The api version to build into continuation token.\n      */\n-    public SearchPagedResponse(SimpleResponse<SearchDocumentsResult> documentSearchResponse) {\n-        this.statusCode = documentSearchResponse.getStatusCode();\n-        this.headers = documentSearchResponse.getHeaders();\n-        this.request = documentSearchResponse.getRequest();\n+    public SearchPagedResponse(SimpleResponse<SearchDocumentsResult> documentSearchResponse,\n+        SearchServiceVersion serviceVersion) {\n+        super(documentSearchResponse.getRequest(),\n+            documentSearchResponse.getStatusCode(),\n+            documentSearchResponse.getHeaders(),\n+            documentSearchResponse.getValue().getResults(),\n+            createContinuationToken(documentSearchResponse, serviceVersion),\n+            null);\n \n         SearchDocumentsResult documentsResult = documentSearchResponse.getValue();\n         this.value = documentsResult.getResults();\n         this.facets = documentsResult.getFacets();\n         this.count = documentsResult.getCount();\n         this.coverage = documentsResult.getCoverage();\n+        this.nextParameters = getNextPageParameters(documentsResult);\n+    }\n+\n+    private static String createContinuationToken(SimpleResponse<SearchDocumentsResult> documentSearchResponse,\n+        SearchServiceVersion serviceVersion) {\n+        SearchDocumentsResult documentsResult = documentSearchResponse.getValue();\n+        if (documentsResult == null) {\n+            return null;\n+        }\n \n-        this.nextPageParameters = getNextPageParameters(documentsResult);\n+        ObjectNode tokenJson = new ObjectMapper().createObjectNode();\n+        tokenJson.put(\"apiVersion\", serviceVersion.getVersion());\n+        tokenJson.put(\"nextLink\", documentsResult.getNextLink());\n+        tokenJson.put(\"nextPageParameters\", getNextPageParameters(documentsResult));\n+\n+        return Base64.getEncoder().encodeToString(tokenJson.toString().getBytes(StandardCharsets.UTF_8));\n     }\n \n-    private static SearchRequest getNextPageParameters(SearchDocumentsResult result) {\n+    private static String getNextPageParameters(SearchDocumentsResult result) {\n         if (CoreUtils.isNullOrEmpty(result.getNextLink())\n             || result.getNextPageParameters() == null\n             || result.getNextPageParameters().getSkip() == null) {\n             return null;\n         }\n-\n-        return result.getNextPageParameters();\n+        try {\n+            return new JacksonAdapter().serialize(result.getNextPageParameters(), SerializerEncoding.JSON);\n+        } catch (IOException ex) {\n+            throw new RuntimeException(\"Failed to serialize the search request.\");\n+        }", "originalCommit": "35432e2852cacf796c70e45f9e9c87f17e3ea203", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyMDIxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402620214", "bodyText": "Yes, will make the change.", "author": "sima-zhu", "createdAt": "2020-04-02T21:58:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2ODAyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402568026", "bodyText": "I'm not sure this is correct - doesn't the continuationToken include the apiVersion and nextLink?  I think we'd only do this for the nextPageParameters property.  We also need to verify that this has an apiVersion we know how to parse and throw an exception if it has an API Version we don't recognize.", "author": "tg-msft", "createdAt": "2020-04-02T19:44:47Z", "path": "sdk/search/azure-search-documents/src/main/java/com/azure/search/documents/SearchIndexAsyncClient.java", "diffHunk": "@@ -643,6 +643,21 @@ private static SearchRequest createSearchRequest(String searchText, SearchOption\n         return searchRequest;\n     }\n \n+    /**\n+     * Build request from continuation token.\n+     *\n+     * @param continuationToken The token used to deserialize the SearchRequest.\n+     * @return The SearchRequest for next page.\n+     */\n+    private SearchRequest buildRequestFromToken(String continuationToken) {\n+        try {\n+            return new JacksonAdapter().deserialize(continuationToken, SearchRequest.class, SerializerEncoding.JSON);", "originalCommit": "35432e2852cacf796c70e45f9e9c87f17e3ea203", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyMjY0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402622646", "bodyText": "You are right when we have the getContinuationToken return encoded one, it includes more items. I will fix the code here.", "author": "sima-zhu", "createdAt": "2020-04-02T22:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2ODAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyMzMxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9764#discussion_r402623316", "bodyText": "Will do apiVersion check as well.", "author": "sima-zhu", "createdAt": "2020-04-02T22:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2ODAyNg=="}], "type": "inlineReview"}, {"oid": "7e0a2b5d1026673f2ab4bb304b3517a51f17f8b1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7e0a2b5d1026673f2ab4bb304b3517a51f17f8b1", "message": "Make change on search page getContinuationToken", "committedDate": "2020-04-02T22:34:51Z", "type": "commit"}, {"oid": "8be572f953fe961d0a4058d05ee8edfe9cda34aa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8be572f953fe961d0a4058d05ee8edfe9cda34aa", "message": "Fixed on null case", "committedDate": "2020-04-02T23:09:34Z", "type": "commit"}, {"oid": "a6215becc3d8c7d42a7510fbbe8580569f7f491d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a6215becc3d8c7d42a7510fbbe8580569f7f491d", "message": "Fixed unused fields", "committedDate": "2020-04-02T23:14:04Z", "type": "commit"}, {"oid": "26ab1da4c79454fa2f0375059c660af51ecf863e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/26ab1da4c79454fa2f0375059c660af51ecf863e", "message": "Throw right exception.", "committedDate": "2020-04-02T23:46:17Z", "type": "commit"}, {"oid": "f1d133decdb4b777fb1bb4dde0d9291852af17bd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f1d133decdb4b777fb1bb4dde0d9291852af17bd", "message": "Fixed linting", "committedDate": "2020-04-02T23:58:58Z", "type": "commit"}, {"oid": "68de3f126996e49dd1909c88e9a3526634835de0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/68de3f126996e49dd1909c88e9a3526634835de0", "message": "Added a model helper for continuation token", "committedDate": "2020-04-03T17:39:19Z", "type": "commit"}, {"oid": "6bff834dd5b1e8b68b85447b6cf6210653138bda", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6bff834dd5b1e8b68b85447b6cf6210653138bda", "message": "Fixed linting", "committedDate": "2020-04-03T17:43:34Z", "type": "commit"}, {"oid": "4fcbd83db240b0b9c041173858388cffae6ca267", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4fcbd83db240b0b9c041173858388cffae6ca267", "message": "Merge from master", "committedDate": "2020-04-03T17:55:45Z", "type": "commit"}, {"oid": "4fcbd83db240b0b9c041173858388cffae6ca267", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4fcbd83db240b0b9c041173858388cffae6ca267", "message": "Merge from master", "committedDate": "2020-04-03T17:55:45Z", "type": "forcePushed"}]}