{"pr_number": 16144, "pr_title": "mgmt make authenticate with http pipeline private access", "pr_createdAt": "2020-10-10T09:00:21Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16144", "timeline": [{"oid": "a6cac690a408c20009d1a1a071d2f7df1e7ac15a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a6cac690a408c20009d1a1a071d2f7df1e7ac15a", "message": "mgmt make authenticate with http pipeline private access", "committedDate": "2020-10-10T08:54:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2NzY4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502767684", "bodyText": "An alternative might be export com.azure.resourcemanager.resources.fluentcore.arm.models.implementation to azure-resourcemanager-test in module-info as well.", "author": "weidongxu-microsoft", "createdAt": "2020-10-10T09:08:51Z", "path": "sdk/resourcemanager/azure-resourcemanager-test/src/main/java/com/azure/resourcemanager/test/ResourceManagerTestBase.java", "diffHunk": "@@ -319,6 +321,28 @@ private void setAccessible(final Field field) {\n         });\n     }\n \n+    /**\n+     * Sets http pipeline for internal use.\n+     *\n+     * @param httpPipeline the http pipeline\n+     * @param azureConfigurable the azure configurable instance\n+     * @param impl the class type of azure configurable implementation\n+     * @param <AzureConfigurable> the type of azure configurable\n+     * @param <AzureConfigurableImpl> the type of azure configurable implementation\n+     * @return the azure configurable instance after setting internal http pipeline\n+     * @throws RuntimeException when field cannot be found or set.\n+     */\n+    protected <AzureConfigurable, AzureConfigurableImpl> AzureConfigurable setInternalHttpPipeline(HttpPipeline httpPipeline, AzureConfigurable azureConfigurable, Class<AzureConfigurableImpl> impl) {", "originalCommit": "a6cac690a408c20009d1a1a071d2f7df1e7ac15a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2ODg5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502768892", "bodyText": "No, it's similar why we use a type parameter for sdk context as azure-resourcemanager-test is the base dependency of others.", "author": "xseeseesee", "createdAt": "2020-10-10T09:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2NzY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2OTg4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502769886", "bodyText": "Ok, I see. Basically it is just T, S.", "author": "weidongxu-microsoft", "createdAt": "2020-10-10T09:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2NzY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2ODE0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502768143", "bodyText": "Do we need protected, or private would do?", "author": "weidongxu-microsoft", "createdAt": "2020-10-10T09:12:29Z", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/arm/Manager.java", "diffHunk": "@@ -56,6 +58,10 @@ protected final void withResourceManager(ResourceManager resourceManager) {\n         this.resourceManager = resourceManager;\n     }\n \n+    protected void withInternalHttpPipeline(AzureConfigurable<?> azureConfigurable, HttpPipeline httpPipeline) {", "originalCommit": "a6cac690a408c20009d1a1a071d2f7df1e7ac15a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2ODk1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502768958", "bodyText": "The protected would help reuse this method for different managers.", "author": "xseeseesee", "createdAt": "2020-10-10T09:21:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2ODE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwNjk0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r503006949", "bodyText": "better return AzureConfigurable for chaining like withInternalPipeline().authenticate()", "author": "ChenTanyi", "createdAt": "2020-10-12T02:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2ODE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2ODE5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502768191", "bodyText": "nit, maybe preconfiguredHttpPipeline would be a better name.\nNot important at this stage.", "author": "weidongxu-microsoft", "createdAt": "2020-10-10T09:13:00Z", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -36,6 +36,7 @@\n     private RetryPolicy retryPolicy;\n     private Configuration configuration;\n     private List<TokenCredential> tokens;\n+    private HttpPipeline internalHttpPipeline;", "originalCommit": "a6cac690a408c20009d1a1a071d2f7df1e7ac15a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2NzU2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502767562", "bodyText": "i think httpPipeline is enough", "author": "yungezz", "createdAt": "2020-10-10T09:07:07Z", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -36,6 +36,7 @@\n     private RetryPolicy retryPolicy;\n     private Configuration configuration;\n     private List<TokenCredential> tokens;\n+    private HttpPipeline internalHttpPipeline;", "originalCommit": "a6cac690a408c20009d1a1a071d2f7df1e7ac15a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2ODU3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502768577", "bodyText": "is there way to make this part of code resuable?", "author": "yungezz", "createdAt": "2020-10-10T09:17:47Z", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/arm/Manager.java", "diffHunk": "@@ -25,8 +26,9 @@\n     protected Manager(HttpPipeline httpPipeline, AzureProfile profile, InnerT innerManagementClient) {\n         this.httpPipeline = httpPipeline;\n         if (httpPipeline != null) {\n-            this.resourceManager = ResourceManager.authenticate(httpPipeline, profile)\n-                .withDefaultSubscription();\n+            ResourceManager.Configurable resourceConfigurable = ResourceManager.configure();", "originalCommit": "a6cac690a408c20009d1a1a071d2f7df1e7ac15a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2OTE2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r502769165", "bodyText": "The method withInternalHttpPipeline can be reused by each manager. But for .authenticate, it has to be called in each manager itself.", "author": "xseeseesee", "createdAt": "2020-10-10T09:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc2ODU3Nw=="}], "type": "inlineReview"}, {"oid": "821287be67f7f6179f43920a0217a5fc8c42838a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/821287be67f7f6179f43920a0217a5fc8c42838a", "message": "reformat pass http pipeline", "committedDate": "2020-10-12T06:46:34Z", "type": "commit"}, {"oid": "e9d05ac4711168662776f83c05dc312bbc2d68aa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e9d05ac4711168662776f83c05dc312bbc2d68aa", "message": "apply changes in storage", "committedDate": "2020-10-12T06:53:35Z", "type": "commit"}, {"oid": "5b76a3ce72adb209b71e4ffc8e9c1d84322131b6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5b76a3ce72adb209b71e4ffc8e9c1d84322131b6", "message": "apply changes for each service manager", "committedDate": "2020-10-12T11:02:06Z", "type": "commit"}, {"oid": "9d8a41d43214e5563a47895a7b3657d7de96330f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9d8a41d43214e5563a47895a7b3657d7de96330f", "message": "update azure resource manager", "committedDate": "2020-10-12T11:02:51Z", "type": "commit"}, {"oid": "94c72029f6f3be61f20c0e5abec718d27f5b35a6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/94c72029f6f3be61f20c0e5abec718d27f5b35a6", "message": "update samples", "committedDate": "2020-10-12T11:03:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY0MTA5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r503641098", "bodyText": "nit, java should be able to use (NoSuchMethodException | IllegalAccessException | InstantiationException | InvocationTargetException  ex)", "author": "weidongxu-microsoft", "createdAt": "2020-10-13T03:08:18Z", "path": "sdk/resourcemanager/azure-resourcemanager-test/src/main/java/com/azure/resourcemanager/test/ResourceManagerTestBase.java", "diffHunk": "@@ -319,6 +321,36 @@ private void setAccessible(final Field field) {\n         });\n     }\n \n+    /**\n+     * Builds the manager with provided http pipeline and profile in general manner.\n+     *\n+     * @param manager the class of the manager\n+     * @param httpPipeline the http pipeline\n+     * @param profile the azure profile\n+     * @param <T> the type of the manager\n+     * @return the manager instance\n+     * @throws RuntimeException when field cannot be found or set.\n+     */\n+    protected <T> T buildManager(Class<T> manager, HttpPipeline httpPipeline, AzureProfile profile) {\n+        try {\n+            Constructor<T> constructor = manager.getDeclaredConstructor(httpPipeline.getClass(), profile.getClass());\n+            AccessController.doPrivileged((PrivilegedAction<Object>) () -> {\n+                constructor.setAccessible(true);\n+                return null;\n+            });\n+            return constructor.newInstance(httpPipeline, profile);\n+\n+        } catch (NoSuchMethodException ex) {\n+            throw logger.logExceptionAsError(new RuntimeException(ex));\n+        } catch (IllegalAccessException ex) {\n+            throw logger.logExceptionAsError(new RuntimeException(ex));\n+        } catch (InstantiationException ex) {\n+            throw logger.logExceptionAsError(new RuntimeException(ex));\n+        } catch (InvocationTargetException ex) {", "originalCommit": "94c72029f6f3be61f20c0e5abec718d27f5b35a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY0MjAwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r503642003", "bodyText": "If this changed, we might able to delete a few overload in TestUtilities about random rg name and random guid.", "author": "weidongxu-microsoft", "createdAt": "2020-10-13T03:12:02Z", "path": "sdk/resourcemanager/azure-resourcemanager-samples/src/test/java/com/azure/resourcemanager/samples/GraphRbacTests.java", "diffHunk": "@@ -34,7 +34,7 @@ public void testManageUsersGroupsAndRoles() {\n             return;\n         }\n \n-        Assertions.assertTrue(ManageUsersGroupsAndRoles.runSample(authenticated, profile));\n+        Assertions.assertTrue(ManageUsersGroupsAndRoles.runSample(azureResourceManager, profile));", "originalCommit": "94c72029f6f3be61f20c0e5abec718d27f5b35a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY0MjIyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r503642220", "bodyText": "Could use some comment here to describe the necessity of the (a bit strange) code.", "author": "weidongxu-microsoft", "createdAt": "2020-10-13T03:13:09Z", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -125,7 +126,15 @@ public T withConfiguration(Configuration configuration) {\n         return (T) this;\n     }\n \n+    public void withHttpPipeline(HttpPipeline httpPipeline) {\n+        Objects.requireNonNull(httpPipeline);\n+        this.httpPipeline = httpPipeline;\n+    }\n+\n     protected HttpPipeline buildHttpPipeline(TokenCredential credential, AzureProfile profile) {\n+        if (this.httpPipeline != null) {\n+            return httpPipeline;\n+        }\n         Objects.requireNonNull(credential);", "originalCommit": "94c72029f6f3be61f20c0e5abec718d27f5b35a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a7169d710576e88c41c06f9cca11445e3833391d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a7169d710576e88c41c06f9cca11445e3833391d", "message": "update pom based on the changes of tests", "committedDate": "2020-10-13T05:27:14Z", "type": "commit"}, {"oid": "f888b89287f401360e4066f9bf15205fda6e19e1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f888b89287f401360e4066f9bf15205fda6e19e1", "message": "remove unused sample utils method", "committedDate": "2020-10-13T05:29:46Z", "type": "commit"}, {"oid": "9a8c3f3224d7c212f9a096e8a5a7a91c9a2f020c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9a8c3f3224d7c212f9a096e8a5a7a91c9a2f020c", "message": "update test for jacoco coverage", "committedDate": "2020-10-13T06:38:44Z", "type": "commit"}, {"oid": "8ef99cf93aa04b3627662dfaaa1a5d3ab5d90e9d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ef99cf93aa04b3627662dfaaa1a5d3ab5d90e9d", "message": "Merge branch 'master' into hide-auth-pipeline", "committedDate": "2020-10-13T07:46:26Z", "type": "commit"}, {"oid": "7fdbb1b2c7688cdc47d2276f0f74a19c74d1d33e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7fdbb1b2c7688cdc47d2276f0f74a19c74d1d33e", "message": "fix compile errors on latest code", "committedDate": "2020-10-13T08:15:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2MzYyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r503763620", "bodyText": "This will be part of the public API. Do we need this method to hide the authenticate method that uses the pipeline?", "author": "srnagar", "createdAt": "2020-10-13T08:28:23Z", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/arm/Manager.java", "diffHunk": "@@ -56,6 +58,11 @@ protected final void withResourceManager(ResourceManager resourceManager) {\n         this.resourceManager = resourceManager;\n     }\n \n+    protected <T extends AzureConfigurable<?>> T withHttpPipeline(HttpPipeline httpPipeline, T azureConfigurable) {", "originalCommit": "8ef99cf93aa04b3627662dfaaa1a5d3ab5d90e9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMjA5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16144#discussion_r503802093", "bodyText": "As discussed, move this method into AzureConfigurableImpl and make it public static.", "author": "xseeseesee", "createdAt": "2020-10-13T09:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2MzYyMA=="}], "type": "inlineReview"}, {"oid": "9c65c49fde850e75629332a95fbf32e3d0f9beab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9c65c49fde850e75629332a95fbf32e3d0f9beab", "message": "remove withHttpPipeline from Manager.java", "committedDate": "2020-10-13T09:24:49Z", "type": "commit"}, {"oid": "27f4a2b828877480139bb46899863817cafc0417", "url": "https://github.com/Azure/azure-sdk-for-java/commit/27f4a2b828877480139bb46899863817cafc0417", "message": "update pom and fix checkstyle", "committedDate": "2020-10-13T10:27:38Z", "type": "commit"}]}