{"pr_number": 10608, "pr_title": "Fixed a bug in upload where we did not copy the buffer given to us so data could be overwritten upstream. ", "pr_createdAt": "2020-04-29T22:06:16Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10608", "timeline": [{"oid": "b1cc71bf60faad2b9103cbe5a911c6b337e5b7b7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b1cc71bf60faad2b9103cbe5a911c6b337e5b7b7", "message": "Fixed a bug in buffered upload where buffer was not deepcopied", "committedDate": "2020-04-29T22:02:50Z", "type": "commit"}, {"oid": "97e430c1b6bc56d8451639eeffe33ef5dc63ae5f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/97e430c1b6bc56d8451639eeffe33ef5dc63ae5f", "message": "added commesnt", "committedDate": "2020-04-29T22:04:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY0MjU1OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#discussion_r417642559", "bodyText": "Can you add that the other copy is when we write it to the pool? Just so we don't forget what we mean later?", "author": "rickle-msft", "createdAt": "2020-04-29T22:10:06Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/PayloadSizeGate.java", "diffHunk": "@@ -38,12 +38,17 @@\n      * @return Buffered data or incoming data depending on threshold condition.\n      */\n     Flux<ByteBuffer> write(ByteBuffer buf) {\n+        /* TODO (gapra): Investigate if there is way to avoid copying the data twice since this may result in lower perf. */", "originalCommit": "97e430c1b6bc56d8451639eeffe33ef5dc63ae5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "95f2b45ca45673ad017fd771b10569083ba3857d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/95f2b45ca45673ad017fd771b10569083ba3857d", "message": "Added detail to comment", "committedDate": "2020-04-29T22:11:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MTAwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#discussion_r418091007", "bodyText": "Ups. My bad.\nI think there isn't double copy now as copying was removed buffer pool - hence regression.\nFor future. Maybe it would be good to extract copying part to separate component that's inserted into Flux transform early in the process - so that it's more explicit (as we apparently quite depend on that).", "author": "kasobol-msft", "createdAt": "2020-04-30T15:20:56Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/PayloadSizeGate.java", "diffHunk": "@@ -38,12 +38,18 @@\n      * @return Buffered data or incoming data depending on threshold condition.\n      */\n     Flux<ByteBuffer> write(ByteBuffer buf) {\n+        /* TODO (gapra): Investigate if there is way to avoid copying the data twice since this may result in lower\n+            perf. The other copy is when we write the buffer to the pool */\n+        /* Deep copy the buffer. This is required to ensure integrity of data. */\n+        ByteBuffer cachedBuffer = ByteBuffer.allocate(buf.remaining()).put(buf);\n+        cachedBuffer.flip();", "originalCommit": "95f2b45ca45673ad017fd771b10569083ba3857d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyNTM2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#discussion_r418125360", "bodyText": "#10639", "author": "gapra-msft", "createdAt": "2020-04-30T16:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MTAwNw=="}], "type": "inlineReview"}]}