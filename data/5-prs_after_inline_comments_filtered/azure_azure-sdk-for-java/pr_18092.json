{"pr_number": 18092, "pr_title": "Converting cosmos exception into json format", "pr_createdAt": "2020-12-11T20:15:03Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/18092", "timeline": [{"oid": "7f901268054397d5087f6b3ed8827af7d08b8d7d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7f901268054397d5087f6b3ed8827af7d08b8d7d", "message": "Converting cosmos exception json", "committedDate": "2020-12-11T20:08:53Z", "type": "commit"}, {"oid": "f5e2e7749409e9d47eddbcd507f62c085cb3ffba", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f5e2e7749409e9d47eddbcd507f62c085cb3ffba", "message": "fixing test case", "committedDate": "2020-12-11T20:29:43Z", "type": "commit"}, {"oid": "107d3bed5c350a784582d7079edd7db09d7c4cb5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/107d3bed5c350a784582d7079edd7db09d7c4cb5", "message": "fixing test case", "committedDate": "2020-12-11T22:45:29Z", "type": "commit"}, {"oid": "fc266132f874a9f3b4c5bf30c2e46a1df37392a7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fc266132f874a9f3b4c5bf30c2e46a1df37392a7", "message": "fixing test case", "committedDate": "2020-12-11T23:46:24Z", "type": "commit"}, {"oid": "d39a839a20e8d1b398dbf5edc5610015d00e0cd6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d39a839a20e8d1b398dbf5edc5610015d00e0cd6", "message": "Fixing spotbug", "committedDate": "2020-12-14T17:35:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc1Mzc3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18092#discussion_r542753773", "bodyText": "please use slf4j exception pladeholder.", "author": "moderakh", "createdAt": "2020-12-14T20:35:17Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosDiagnostics.java", "diffHunk": "@@ -90,4 +84,30 @@ public Duration getDuration() {\n     FeedResponseDiagnostics getFeedResponseDiagnostics() {\n         return feedResponseDiagnostics;\n     }\n+\n+    void fillCosmosDiagnostics(ObjectNode parentNode, StringBuilder stringBuilder) {\n+        if (this.feedResponseDiagnostics != null) {\n+            if (parentNode != null) {\n+                parentNode.put(USER_AGENT_KEY, USER_AGENT);\n+                parentNode.putPOJO(COSMOS_DIAGNOSTICS_KEY, feedResponseDiagnostics);\n+            }\n+\n+            if (stringBuilder != null) {\n+                stringBuilder.append(USER_AGENT_KEY +\"=\").append(USER_AGENT).append(System.lineSeparator());\n+                stringBuilder.append(feedResponseDiagnostics);\n+            }\n+        } else {\n+            if (parentNode != null) {\n+                parentNode.putPOJO(COSMOS_DIAGNOSTICS_KEY, clientSideRequestStatistics);\n+            }\n+\n+            if (stringBuilder != null) {\n+                try {\n+                    stringBuilder.append(OBJECT_MAPPER.writeValueAsString(this.clientSideRequestStatistics));\n+                } catch (JsonProcessingException e) {\n+                    LOGGER.error(\"Error while parsing diagnostics \" + e);", "originalCommit": "d39a839a20e8d1b398dbf5edc5610015d00e0cd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0NDE4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18092#discussion_r543644186", "bodyText": "done", "author": "simplynaveen20", "createdAt": "2020-12-15T19:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc1Mzc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMDU3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18092#discussion_r542820572", "bodyText": "serializing diagnostics is very expensive and will have perf impact.\nNow that we are doing that in the exception stacktrace for each exception we should exclude the business logic errors:\n\nNotFound (with no substatus code, i.e., for READ_SESSION_NOT_AVAILABLE we need diagnostics),\nConflict,\nPreconditionFailed.\n\nThese are business logic failures we don't need to the diagnostics for this.\nNotFound with READ_SESSION_NOT_AVAILABLE substatus code is a consistency failure not business logic we should have diagnostics for that.", "author": "moderakh", "createdAt": "2020-12-14T21:38:07Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosException.java", "diffHunk": "@@ -299,10 +314,39 @@ public double getRequestCharge() {\n \n     @Override\n     public String toString() {\n-        return getClass().getSimpleName() + \"{\" + \"userAgent=\" + USER_AGENT + \", error=\" + cosmosError + \", resourceAddress='\"\n-                   + resourceAddress  +  \", statusCode=\" + statusCode + \", message=\" + getMessage()\n-                   + \", causeInfo=\" + causeInfo() + \", responseHeaders=\" + responseHeaders + \", requestHeaders=\"\n-                   + filterSensitiveData(requestHeaders) + '}';\n+        try {\n+            ObjectNode exceptionMessageNode = mapper.createObjectNode();\n+            exceptionMessageNode.put(\"ClassName\", getClass().getSimpleName());\n+            exceptionMessageNode.put(USER_AGENT_KEY, USER_AGENT);\n+            exceptionMessageNode.put(\"statusCode\", statusCode);\n+            exceptionMessageNode.put(\"resourceAddress\", resourceAddress);\n+            if (cosmosError != null) {\n+                exceptionMessageNode.put(\"error\", cosmosError.toJson());\n+            }\n+\n+            exceptionMessageNode.put(\"innerErrorMessage\", innerErrorMessage());\n+            exceptionMessageNode.put(\"causeInfo\", causeInfo());\n+            if (responseHeaders != null) {\n+                exceptionMessageNode.put(\"responseHeaders\", responseHeaders.toString());\n+            }\n+\n+            List<Map.Entry<String, String>> filterRequestHeaders = filterSensitiveData(requestHeaders);\n+            if (filterRequestHeaders != null) {\n+                exceptionMessageNode.put(\"requestHeaders\", filterRequestHeaders.toString());\n+            }\n+\n+            if(this.cosmosDiagnostics != null) {\n+                cosmosDiagnostics.fillCosmosDiagnostics(exceptionMessageNode, null);", "originalCommit": "d39a839a20e8d1b398dbf5edc5610015d00e0cd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0Mzk4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18092#discussion_r543643985", "bodyText": "Before this PR we were still serializing diagnostics and putting in string on exception message. In this PR we putting diagnostics object in exception parent ObjectNode  and then serializing in json at the last. So for computation on diagnostics serialization still remain the same.\nHowever I see your point in general to avoid diagnostics serialization on regular customer business scenario like 404 not found. I would like to keep it as sperate work item, however there is down side to put custom logic based on status code, we need to maintain extra logic for future scenarios and secondly its customer who should decide  whether to fetch the whole message when there is expected failure and can be handle based on expected status code. Thoughts?", "author": "simplynaveen20", "createdAt": "2020-12-15T19:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMDU3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY1MjAwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18092#discussion_r544652003", "bodyText": "We should exclude the business logic failure (404, 409, 412) and not include in the exception due to the perf impact.\nFeel free to capture this work in a separate PR.", "author": "moderakh", "createdAt": "2020-12-16T21:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMDU3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk5ODA0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18092#discussion_r545998045", "bodyText": "#18271", "author": "simplynaveen20", "createdAt": "2020-12-18T18:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMDU3Mg=="}], "type": "inlineReview"}, {"oid": "31e37a2d37e91840d01050be77e9dce507d48aaf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/31e37a2d37e91840d01050be77e9dce507d48aaf", "message": "Merge branch 'latest-master' into users/nakumars/diagnosticFixes", "committedDate": "2020-12-15T19:23:10Z", "type": "commit"}, {"oid": "0c62e97a6e167e37024be3ec9447f28609c22588", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0c62e97a6e167e37024be3ec9447f28609c22588", "message": "resolving comments and fixing test case", "committedDate": "2020-12-15T19:42:59Z", "type": "commit"}, {"oid": "1f678823e9b614cd517eb304b519f87fba776ee2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1f678823e9b614cd517eb304b519f87fba776ee2", "message": "Fixing test case", "committedDate": "2020-12-16T18:12:41Z", "type": "commit"}]}