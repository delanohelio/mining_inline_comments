{"pr_number": 15735, "pr_title": "Internal: Fixed exception handling around GoneException and RequestTimeoutException", "pr_createdAt": "2020-09-25T23:02:52Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15735", "timeline": [{"oid": "e3f011f8a38afa4585b2277a4a9d1da80162dfde", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e3f011f8a38afa4585b2277a4a9d1da80162dfde", "message": "Fixing exception handling for Gone and Request timeouts", "committedDate": "2020-09-25T22:13:29Z", "type": "commit"}, {"oid": "758a8594061673341d07a648e014419d24d05bca", "url": "https://github.com/Azure/azure-sdk-for-java/commit/758a8594061673341d07a648e014419d24d05bca", "message": "Adding basic unit tests", "committedDate": "2020-09-25T22:48:09Z", "type": "commit"}, {"oid": "f0c6809e5d410a0f95926c638f8698456296c1bb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f0c6809e5d410a0f95926c638f8698456296c1bb", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/GoneAndRequestTimeoutExceptionHandling", "committedDate": "2020-09-25T22:51:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEwODMyOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r496108328", "bodyText": "nice! thanks.", "author": "moderakh", "createdAt": "2020-09-28T17:12:39Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -203,7 +203,7 @@ public long id() {\n             BridgeInternal.setRequestTimeline(cosmosException, record.takeTimelineSnapshot());\n             BridgeInternal.setRntbdPendingRequestQueueSize(cosmosException, record.pendingRequestQueueSize());\n             BridgeInternal.setChannelTaskQueueSize(cosmosException, record.channelTaskQueueLength());\n-\n+            BridgeInternal.setSendingRequestStarted(cosmosException, record.hasSendingRequestStarted());", "originalCommit": "f0c6809e5d410a0f95926c638f8698456296c1bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMTIxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r496111215", "bodyText": "I wonder if we should incorporate that into the RntbdRequestRecord stages as SEND_STARTED stage, and this as an event to the request timeline.\ne.g.:\nQUEUED, PIPELINED, SEND_STARTED, SENT, RECEIVED, COMPLETED", "author": "moderakh", "createdAt": "2020-09-28T17:17:52Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestRecord.java", "diffHunk": "@@ -213,13 +214,26 @@ public long transportRequestId() {\n     // region Methods\n \n     public boolean expire() {\n-        final RequestTimeoutException error = new RequestTimeoutException(this.toString(), this.args.physicalAddress());\n+        final GoneException error = new GoneException(this.toString(), null, this.args.physicalAddress());\n         BridgeInternal.setRequestHeaders(error, this.args.serviceRequest().getHeaders());\n+\n         return this.completeExceptionally(error);\n     }\n \n     public abstract Timeout newTimeout(final TimerTask task);\n \n+    /**\n+     * Provides information whether the request could have been sent to the service\n+     * @return fals if it is possible to guarantee that the request never arrived at the service - true otherwise\n+     */\n+    public boolean hasSendingRequestStarted() {\n+        return this.sendingRequestHasStarted;\n+    }\n+\n+    void setSendingRequestHasStarted() {\n+        this.sendingRequestHasStarted = true;", "originalCommit": "f0c6809e5d410a0f95926c638f8698456296c1bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNDA3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r496324079", "bodyText": "I thought about it - decided against it because I haven't found a place where I could interrupt really when starting to send on the wire. Right now I set the flag at the last point where I can guarantee that sending hasn't started yet - which is good enough for the exception handling. But when pushing it into a first-class STAGE i think we should do it really when starting to send data to the wire. So my preference would to leave this as is - are you ok with it or still disagree?", "author": "FabianMeiswinkel", "createdAt": "2020-09-29T01:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMTIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2NTI4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497765281", "bodyText": "I agree with you. Thanks.", "author": "moderakh", "createdAt": "2020-09-30T19:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMTIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMzAzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r496113039", "bodyText": "address refresh is done as part of the retry.\nIf no one retries who is going to refresh the address caches when request.requestContext.forceRefreshAddressCache set to true?", "author": "moderakh", "createdAt": "2020-09-28T17:21:02Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GoneAndRetryWithRetryPolicy.java", "diffHunk": "@@ -60,12 +60,25 @@ public GoneAndRetryWithRetryPolicy(RxDocumentServiceRequest request, Integer wai\n             !(exception instanceof RetryWithException) &&\n             !(exception instanceof PartitionIsMigratingException) &&\n             !(exception instanceof InvalidPartitionException &&\n-            (this.request.getPartitionKeyRangeIdentity() == null ||\n-            this.request.getPartitionKeyRangeIdentity().getCollectionRid() == null)) &&\n+                (this.request.getPartitionKeyRangeIdentity() == null ||\n+                this.request.getPartitionKeyRangeIdentity().getCollectionRid() == null)) &&\n             !(exception instanceof PartitionKeyRangeIsSplittingException)) {\n+\n             logger.debug(\"Operation will NOT be retried. Current attempt {}, Exception: \", this.attemptCount,\n-                    exception);\n+                exception);\n+            stopStopWatch(this.durationTimer);\n+            return Mono.just(ShouldRetryResult.noRetry());\n+        } else if (exception instanceof GoneException &&\n+            !request.isReadOnly() &&\n+            BridgeInternal.hasSendingRequestStarted((CosmosException)exception)) {\n+\n+            logger.debug(\n+                \"Operation will NOT be retried. Write operations can not be retried safely when sending the request \" +\n+                    \"to the service because they aren't idempotent. Current attempt {}, Exception: \",\n+                this.attemptCount,\n+                exception);\n             stopStopWatch(this.durationTimer);\n+            this.request.requestContext.forceRefreshAddressCache = true;", "originalCommit": "f0c6809e5d410a0f95926c638f8698456296c1bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyMzE0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r496323143", "bodyText": "Fixed", "author": "FabianMeiswinkel", "createdAt": "2020-09-29T01:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMzAzOQ=="}], "type": "inlineReview"}, {"oid": "07ac3ba6285abd909294cd64910c24da2f94baa0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/07ac3ba6285abd909294cd64910c24da2f94baa0", "message": "Really enforcing AddressRefresh after failing Gone for writes", "committedDate": "2020-09-29T01:27:29Z", "type": "commit"}, {"oid": "585dea7d460a1b50b601f75121a6188ae0f21610", "url": "https://github.com/Azure/azure-sdk-for-java/commit/585dea7d460a1b50b601f75121a6188ae0f21610", "message": "Fixing unit test regression", "committedDate": "2020-09-29T02:01:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4NTMzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r496585334", "bodyText": "Nice thanks.", "author": "kirankumarkolli", "createdAt": "2020-09-29T09:46:20Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentServiceRequest.java", "diffHunk": "@@ -83,6 +83,10 @@ public boolean isReadOnlyScript() {\n         }\n     }\n \n+    public boolean isReadOnly() {\n+        return this.isReadOnlyRequest() || this.isReadOnlyScript();", "originalCommit": "585dea7d460a1b50b601f75121a6188ae0f21610", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4ODIwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r496588201", "bodyText": "Other similar tracers are at warn below.\nWarn seems makes sense.", "author": "kirankumarkolli", "createdAt": "2020-09-29T09:50:55Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GoneAndRetryWithRetryPolicy.java", "diffHunk": "@@ -60,13 +60,27 @@ public GoneAndRetryWithRetryPolicy(RxDocumentServiceRequest request, Integer wai\n             !(exception instanceof RetryWithException) &&\n             !(exception instanceof PartitionIsMigratingException) &&\n             !(exception instanceof InvalidPartitionException &&\n-            (this.request.getPartitionKeyRangeIdentity() == null ||\n-            this.request.getPartitionKeyRangeIdentity().getCollectionRid() == null)) &&\n+                (this.request.getPartitionKeyRangeIdentity() == null ||\n+                this.request.getPartitionKeyRangeIdentity().getCollectionRid() == null)) &&\n             !(exception instanceof PartitionKeyRangeIsSplittingException)) {\n+\n             logger.debug(\"Operation will NOT be retried. Current attempt {}, Exception: \", this.attemptCount,\n-                    exception);\n+                exception);\n             stopStopWatch(this.durationTimer);\n             return Mono.just(ShouldRetryResult.noRetry());\n+        } else if (exception instanceof GoneException &&\n+            !request.isReadOnly() &&\n+            BridgeInternal.hasSendingRequestStarted((CosmosException)exception)) {\n+\n+            logger.debug(", "originalCommit": "585dea7d460a1b50b601f75121a6188ae0f21610", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f985dc35ff2dacc963b46376722a15ec8658000", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9f985dc35ff2dacc963b46376722a15ec8658000", "message": "Changing log-level to warn if we don't retry", "committedDate": "2020-09-29T10:11:24Z", "type": "commit"}, {"oid": "21ff088e2bf661db2d25ca5f5545f9ed408b60fd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/21ff088e2bf661db2d25ca5f5545f9ed408b60fd", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/GoneAndRequestTimeoutExceptionHandling", "committedDate": "2020-09-29T10:59:55Z", "type": "commit"}, {"oid": "31c603510f672116d4f58e0f6716959d445387b2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/31c603510f672116d4f58e0f6716959d445387b2", "message": "Fixing VI failure unrelated to my changes", "committedDate": "2020-09-29T19:30:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNDE0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497014142", "bodyText": "If the STAGE status is before SENT, is that enough to decide whether we should retry?\nOr maybe can use @flush() to decide whether the request is on wire? I think when calling flush(), sslHandler will start to prepare handshake etc", "author": "xinlian12", "createdAt": "2020-09-29T20:09:53Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -492,6 +492,7 @@ public void write(final ChannelHandlerContext context, final Object message, fin\n \n             final RntbdRequestRecord record = (RntbdRequestRecord) message;\n             this.timestamps.channelWriteAttempted();\n+            record.setSendingRequestHasStarted();\n ", "originalCommit": "31c603510f672116d4f58e0f6716959d445387b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NjM3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497076372", "bodyText": "No - Especially the SSL handhsake has relatively high potential for error/timeout - and at that point we would still be \"safe to retry\" - the right time is really just before we start sending the actual request on the wire. Does that make sense?", "author": "FabianMeiswinkel", "createdAt": "2020-09-29T21:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNDE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA4MTQ0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497081447", "bodyText": "Hmm, but I thought instead of creating a new flag, we probably should be safe enough to use Stage.Sent to guard the retry?\nBut this change makes sense to me~", "author": "xinlian12", "createdAt": "2020-09-29T21:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNDE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5MTMyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497091321", "bodyText": "Stage.SENT is only set after finishing sending the request on the wire - which means we could receive an error we map to 410 while sending the request - which isn't 100% safe from the idempotency perspective. Once we start sending the request we can't exclude the risk of side effects on the service (because retrieving ACK from the service and setting Stage.SENT isn't happening atomically - although I admit the risk is low. I personally don't think the additional flag is increasing overall complexity much - but as the author I am obviously biased. If there is broader concern about the complexity introduced by this additional flag I am ok with trading-in some correctness and using Stage < SENT as indication of allowing retries. @moderakh / @kirankumarkolli  / @kushagraThapar / @simplynaveen20 - Thoughts?", "author": "FabianMeiswinkel", "createdAt": "2020-09-29T22:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNDE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NzYyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497097620", "bodyText": "So currently, we are using write() not writeAndFlush(), that is why I think maybe it is safe (since the write method is only queue the message, but not really writing the message to the underlying socket).\nAnd I think maybe SENT_STARTED when write() completes, and then SENT when flush() completes.", "author": "xinlian12", "createdAt": "2020-09-29T22:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNDE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2NzI5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497867299", "bodyText": "@FabianMeiswinkel  - I am fine with adding the flag, I don't think it introduces additional complexity.", "author": "kushagraThapar", "createdAt": "2020-10-01T00:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNDE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNjIyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497016229", "bodyText": "Why need to create RequestTimeoutException as inner? would not 'error' itself enough?", "author": "xinlian12", "createdAt": "2020-09-29T20:13:59Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -799,7 +800,11 @@ private void messageReceived(final ChannelHandlerContext context, final RntbdRes\n                     break;\n \n                 case StatusCodes.REQUEST_TIMEOUT:\n-                    cause = new RequestTimeoutException(error, lsn, partitionKeyRangeId, responseHeaders);\n+                    Exception inner = new RequestTimeoutException(error, lsn, partitionKeyRangeId, responseHeaders);", "originalCommit": "31c603510f672116d4f58e0f6716959d445387b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAyNTYxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497025612", "bodyText": "To not loose context in cases where we iterate through exceptions recursively through all inner exceptions etc.", "author": "FabianMeiswinkel", "createdAt": "2020-09-29T20:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNjIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxODA1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497018051", "bodyText": "NIT: the the indent same as above line?", "author": "xinlian12", "createdAt": "2020-09-29T20:17:12Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GoneAndRetryWithRetryPolicy.java", "diffHunk": "@@ -60,13 +60,27 @@ public GoneAndRetryWithRetryPolicy(RxDocumentServiceRequest request, Integer wai\n             !(exception instanceof RetryWithException) &&\n             !(exception instanceof PartitionIsMigratingException) &&\n             !(exception instanceof InvalidPartitionException &&\n-            (this.request.getPartitionKeyRangeIdentity() == null ||\n-            this.request.getPartitionKeyRangeIdentity().getCollectionRid() == null)) &&\n+                (this.request.getPartitionKeyRangeIdentity() == null ||", "originalCommit": "31c603510f672116d4f58e0f6716959d445387b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAyNDQzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497024432", "bodyText": "No - intentional - because it is the second condition for the logical AND.", "author": "FabianMeiswinkel", "createdAt": "2020-09-29T20:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxODA1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3OTM3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497079378", "bodyText": "oh, yea, sorry, miss read )", "author": "xinlian12", "createdAt": "2020-09-29T21:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxODA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAyMDAzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497020034", "bodyText": "Why we need to refresh address here? If we reach here, it means we will not going to retry the request, is that we are trying to proactively refresh the address?", "author": "xinlian12", "createdAt": "2020-09-29T20:20:46Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RetryUtils.java", "diffHunk": "@@ -82,11 +84,20 @@\n \n                 if (!shouldRetryResult.shouldRetry) {\n                     retryPolicy.updateEndTime();\n-                    if(shouldRetryResult.exception == null) {\n-                        return Mono.error(e);\n-                    } else {\n-                        return Mono.error(shouldRetryResult.exception);\n+\n+                    final Throwable errorToReturn = shouldRetryResult.exception != null ? shouldRetryResult.exception : e;\n+                    final Mono<T> failure = Mono.error(errorToReturn);\n+\n+                    if (shouldRetryResult.policyArg != null &&\n+                        shouldRetryResult.policyArg.getValue0() != null &&\n+                        shouldRetryResult.policyArg.getValue0()) {\n+\n+                        return addressSelector.resolveAddressesAsync(", "originalCommit": "31c603510f672116d4f58e0f6716959d445387b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAyNTA1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497025052", "bodyText": "It is the Gone for write requests - before we were refreshing addresses and retry. Retrying is a problem because writes aren't idempotent. But the address refresh as reaction of all 410s should still happen", "author": "FabianMeiswinkel", "createdAt": "2020-09-29T20:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAyMDAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3OTkwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497079901", "bodyText": "I see, got it, make sense, thanks for the explanation.", "author": "xinlian12", "createdAt": "2020-09-29T21:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAyMDAzNA=="}], "type": "inlineReview"}, {"oid": "b3368ad8bca99696797bd7ae9afb909fc39828d9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b3368ad8bca99696797bd7ae9afb909fc39828d9", "message": "Update log4j2.properties", "committedDate": "2020-09-29T21:59:46Z", "type": "commit"}, {"oid": "0ac49b1e7916198afcae5fa96d9fdc409ec3a35f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0ac49b1e7916198afcae5fa96d9fdc409ec3a35f", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/GoneAndRequestTimeoutExceptionHandling", "committedDate": "2020-09-29T22:00:37Z", "type": "commit"}, {"oid": "97f95273a025bb853a52b564cd86e9fc0acac3af", "url": "https://github.com/Azure/azure-sdk-for-java/commit/97f95273a025bb853a52b564cd86e9fc0acac3af", "message": "Fixing unit test flakiness", "committedDate": "2020-09-30T18:10:02Z", "type": "commit"}, {"oid": "157db1c911c61e0e7e0b07a91161a14b3388599e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/157db1c911c61e0e7e0b07a91161a14b3388599e", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/GoneAndRequestTimeoutExceptionHandling", "committedDate": "2020-09-30T18:19:42Z", "type": "commit"}, {"oid": "9cefd308bfeec9a3e4d089adb9aa8d15d87fd747", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9cefd308bfeec9a3e4d089adb9aa8d15d87fd747", "message": "Merging with Mo's Diagnostics PR", "committedDate": "2020-09-30T18:20:09Z", "type": "commit"}, {"oid": "41ecf26d04001ac94c6f77decd913df4b8af53ad", "url": "https://github.com/Azure/azure-sdk-for-java/commit/41ecf26d04001ac94c6f77decd913df4b8af53ad", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/GoneAndRequestTimeoutExceptionHandling", "committedDate": "2020-09-30T19:16:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2MzY0MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497763640", "bodyText": "this is for refreshing address cache on a Gone Exception for write request.\nWith this approach the write response will get blocked till the unrelated address resolution completes.\nyou could instead trigger an address cache refresh in background and return the write response immediately.\nSee this as example:\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/ConsistencyWriter.java#L365-L373", "author": "moderakh", "createdAt": "2020-09-30T19:55:32Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RetryUtils.java", "diffHunk": "@@ -82,11 +84,20 @@\n \n                 if (!shouldRetryResult.shouldRetry) {\n                     retryPolicy.updateEndTime();\n-                    if(shouldRetryResult.exception == null) {\n-                        return Mono.error(e);\n-                    } else {\n-                        return Mono.error(shouldRetryResult.exception);\n+\n+                    final Throwable errorToReturn = shouldRetryResult.exception != null ? shouldRetryResult.exception : e;\n+                    final Mono<T> failure = Mono.error(errorToReturn);\n+\n+                    if (shouldRetryResult.policyArg != null &&\n+                        shouldRetryResult.policyArg.getValue0() != null &&\n+                        shouldRetryResult.policyArg.getValue0()) {\n+\n+                        return addressSelector.resolveAddressesAsync(", "originalCommit": "41ecf26d04001ac94c6f77decd913df4b8af53ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MzQyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497843421", "bodyText": "Fixed - good catch. Thanks!", "author": "FabianMeiswinkel", "createdAt": "2020-09-30T22:49:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2MzY0MA=="}], "type": "inlineReview"}, {"oid": "45cfea1f34112d4f90f274453b9ca09b7ed24a14", "url": "https://github.com/Azure/azure-sdk-for-java/commit/45cfea1f34112d4f90f274453b9ca09b7ed24a14", "message": "Moving the address refresh to a background task for writes hitting 410", "committedDate": "2020-09-30T22:48:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2NDg2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497864865", "bodyText": "Can you please add a comment here what policyArg.getValue0() is ?", "author": "kushagraThapar", "createdAt": "2020-10-01T00:00:41Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RetryUtils.java", "diffHunk": "@@ -82,11 +85,18 @@\n \n                 if (!shouldRetryResult.shouldRetry) {\n                     retryPolicy.updateEndTime();\n-                    if(shouldRetryResult.exception == null) {\n-                        return Mono.error(e);\n-                    } else {\n-                        return Mono.error(shouldRetryResult.exception);\n+\n+                    final Throwable errorToReturn = shouldRetryResult.exception != null ? shouldRetryResult.exception : e;\n+                    final Mono<T> failure = Mono.error(errorToReturn);\n+\n+                    if (shouldRetryResult.policyArg != null &&", "originalCommit": "45cfea1f34112d4f90f274453b9ca09b7ed24a14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg3NTk3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497875978", "bodyText": "Fixed in next iteration", "author": "FabianMeiswinkel", "createdAt": "2020-10-01T00:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2NDg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2NzU1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497867557", "bodyText": "typo on return value :)\nfals -> false", "author": "kushagraThapar", "createdAt": "2020-10-01T00:11:05Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestRecord.java", "diffHunk": "@@ -213,13 +214,26 @@ public long transportRequestId() {\n     // region Methods\n \n     public boolean expire() {\n-        final RequestTimeoutException error = new RequestTimeoutException(this.toString(), this.args.physicalAddress());\n+        final GoneException error = new GoneException(this.toString(), null, this.args.physicalAddress());\n         BridgeInternal.setRequestHeaders(error, this.args.serviceRequest().getHeaders());\n+\n         return this.completeExceptionally(error);\n     }\n \n     public abstract Timeout newTimeout(final TimerTask task);\n \n+    /**\n+     * Provides information whether the request could have been sent to the service\n+     * @return fals if it is possible to guarantee that the request never arrived at the service - true otherwise", "originalCommit": "45cfea1f34112d4f90f274453b9ca09b7ed24a14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2ODE4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497868186", "bodyText": "If I understand this correctly, we are saying that this API returns true if the request has been sent to the service and received it, false otherwise - meaning either the request is sent but not received by the service, or request is not sent at all ?", "author": "kushagraThapar", "createdAt": "2020-10-01T00:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2NzU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg3NDQ5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497874495", "bodyText": "No - will return true if there exists a chance that the request could have arrived at the service\nFalse if we are 100% sure the request wasn't sent on the wire", "author": "FabianMeiswinkel", "createdAt": "2020-10-01T00:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2NzU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2OTQyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497869421", "bodyText": "Not sure why the CI didn't catch this, but this is missing Microsoft copyright header information.", "author": "kushagraThapar", "createdAt": "2020-10-01T00:16:18Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/directconnectivity/ReplicatedResourceClientGoneForWriteTest.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package com.azure.cosmos.implementation.directconnectivity;", "originalCommit": "45cfea1f34112d4f90f274453b9ca09b7ed24a14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg3Mjk3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15735#discussion_r497872977", "bodyText": "Fixed in next iteration", "author": "FabianMeiswinkel", "createdAt": "2020-10-01T00:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2OTQyMQ=="}], "type": "inlineReview"}, {"oid": "6ad514f79862c51e6d1e5eb027db5d9690cc27d5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6ad514f79862c51e6d1e5eb027db5d9690cc27d5", "message": "Addressed Kushagra's PR comments", "committedDate": "2020-10-01T00:28:11Z", "type": "commit"}, {"oid": "4fac63e468ee4c4c1de5bfcaa3cc59f77e047c82", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4fac63e468ee4c4c1de5bfcaa3cc59f77e047c82", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/GoneAndRequestTimeoutExceptionHandling", "committedDate": "2020-10-01T00:28:43Z", "type": "commit"}, {"oid": "0e1472735cf604458d5535948824316b8b7bc9fb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0e1472735cf604458d5535948824316b8b7bc9fb", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/GoneAndRequestTimeoutExceptionHandling", "committedDate": "2020-10-01T20:04:12Z", "type": "commit"}, {"oid": "6f0b1421e816f854144095439ad4872317015901", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f0b1421e816f854144095439ad4872317015901", "message": "Addressing benchmark flakiness introduced due to not retrying writes which have been sent", "committedDate": "2020-10-01T22:55:51Z", "type": "commit"}]}