{"pr_number": 14531, "pr_title": "Added support for directory and delegation SAS", "pr_createdAt": "2020-08-27T20:30:05Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14531", "timeline": [{"oid": "1ef2aae7b2307cdf2c5a497a65c06f348043745e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1ef2aae7b2307cdf2c5a497a65c06f348043745e", "message": "Added code for directory and delegation SAS", "committedDate": "2020-08-25T00:27:33Z", "type": "commit"}, {"oid": "db4e48f9e77d2c221699dee61906d0373b87864a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/db4e48f9e77d2c221699dee61906d0373b87864a", "message": "Added code and tests for directory and delegation sas", "committedDate": "2020-08-25T22:18:26Z", "type": "commit"}, {"oid": "1f6b636dfdf6dbc8874c3eed9002841bb67da50b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1f6b636dfdf6dbc8874c3eed9002841bb67da50b", "message": "Added code for delegation SAS", "committedDate": "2020-08-27T20:02:32Z", "type": "commit"}, {"oid": "fe7058757112d86f8d54bcedb94b552fbeea457d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fe7058757112d86f8d54bcedb94b552fbeea457d", "message": "recorded tests", "committedDate": "2020-08-27T20:27:39Z", "type": "commit"}, {"oid": "d39b9c8602dcefd657efdebaec268c967cc2cace", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d39b9c8602dcefd657efdebaec268c967cc2cace", "message": "Added breadcrumbs", "committedDate": "2020-08-27T20:28:33Z", "type": "commit"}, {"oid": "f85165b17545e96c9a34d499d74ac04abd501293", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f85165b17545e96c9a34d499d74ac04abd501293", "message": "Merge branch 'feature/storage/stg74' into storage/delegationSas", "committedDate": "2020-08-27T20:30:47Z", "type": "commit"}, {"oid": "bd5dc6e0be6480b27a2c11c63fd097b32771a2af", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bd5dc6e0be6480b27a2c11c63fd097b32771a2af", "message": "Added Changelog", "committedDate": "2020-08-27T20:33:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4MTYyOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14531#discussion_r478681628", "bodyText": "rename to SAS_AUTHORIZED_AAD_OBJECT_ID", "author": "gapra-msft", "createdAt": "2020-08-27T20:38:11Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/Constants.java", "diffHunk": "@@ -347,6 +347,26 @@ private HeaderConstants() {\n          */\n         public static final String SAS_SIGNED_KEY_VERSION = \"skv\";\n \n+        /**\n+         * The SAS AAD object id parameter for user delegation SAS.\n+         */\n+        public static final String SAS_AAD_OBJECT_ID = \"saoid\";", "originalCommit": "bd5dc6e0be6480b27a2c11c63fd097b32771a2af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4MTc4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14531#discussion_r478681787", "bodyText": "rename to authorized", "author": "gapra-msft", "createdAt": "2020-08-27T20:38:32Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/sas/CommonSasQueryParameters.java", "diffHunk": "@@ -62,6 +63,14 @@\n \n     private final String contentType;\n \n+    private final Integer directoryDepth;\n+\n+    private final String aadObjectId;", "originalCommit": "bd5dc6e0be6480b27a2c11c63fd097b32771a2af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5a744f82047ba678b9705b3e32df0224588c254a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5a744f82047ba678b9705b3e32df0224588c254a", "message": "Updated to pass Analyze step", "committedDate": "2020-08-27T22:10:07Z", "type": "commit"}, {"oid": "599442daa4a7fca8c58b600a0e7dfb3385fb359e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/599442daa4a7fca8c58b600a0e7dfb3385fb359e", "message": "Changed the permissions to include chagne", "committedDate": "2020-08-27T22:35:39Z", "type": "commit"}, {"oid": "8c54c8b4038ec9be5aec78fc4a845303c7d89e08", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8c54c8b4038ec9be5aec78fc4a845303c7d89e08", "message": "Merge branch 'feature/storage/stg74' into storage/delegationSas", "committedDate": "2020-08-28T01:25:09Z", "type": "commit"}, {"oid": "0a0e177e62969ee2e7485a3bb1a6b7f5da099c36", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0a0e177e62969ee2e7485a3bb1a6b7f5da099c36", "message": "Merge branch 'feature/storage/stg74' into storage/delegationSas", "committedDate": "2020-08-28T17:04:41Z", "type": "commit"}, {"oid": "80acb8add4ab023970eacd8d9094f77ee76b911b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/80acb8add4ab023970eacd8d9094f77ee76b911b", "message": "Fixed line length", "committedDate": "2020-08-28T17:33:10Z", "type": "commit"}, {"oid": "524b734ccf494fa3b4bff24a255fd60f0c46ff20", "url": "https://github.com/Azure/azure-sdk-for-java/commit/524b734ccf494fa3b4bff24a255fd60f0c46ff20", "message": "Changed to use one setter", "committedDate": "2020-08-28T19:04:44Z", "type": "commit"}, {"oid": "d4db54af891aba9814e46cdbde0271839184fe2f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d4db54af891aba9814e46cdbde0271839184fe2f", "message": "removed unnecessary test", "committedDate": "2020-08-28T19:10:20Z", "type": "commit"}, {"oid": "78448a933f2ce1242d122c5db5f6654b0a32fa35", "url": "https://github.com/Azure/azure-sdk-for-java/commit/78448a933f2ce1242d122c5db5f6654b0a32fa35", "message": "Changed variable name", "committedDate": "2020-08-28T19:22:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUyODQwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14531#discussion_r482528405", "bodyText": "Can you comment these lines to explain we set it to null to force the latest version?", "author": "rickle-msft", "createdAt": "2020-09-02T22:15:54Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/implementation/util/BlobSasImplUtil.java", "diffHunk": "@@ -110,7 +110,7 @@ public BlobSasImplUtil(BlobServiceSasSignatureValues sasValues, String container\n             throw logger.logExceptionAsError(\n                 new IllegalArgumentException(\"'snapshot' and 'versionId' cannot be used at the same time.\"));\n         }\n-        this.version = sasValues.getVersion();\n+        this.version = null;", "originalCommit": "78448a933f2ce1242d122c5db5f6654b0a32fa35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU0NDEyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14531#discussion_r482544120", "bodyText": "Can you leave a comment that these only apply to hns?", "author": "rickle-msft", "createdAt": "2020-09-02T22:30:46Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/implementation/util/BlobSasImplUtil.java", "diffHunk": "@@ -314,6 +314,9 @@ private String stringToSign(final UserDelegationKey key, String canonicalName) {\n             key.getSignedExpiry() == null ? \"\" : Constants.ISO_8601_UTC_DATE_FORMATTER.format(key.getSignedExpiry()),\n             key.getSignedService() == null ? \"\" : key.getSignedService(),\n             key.getSignedVersion() == null ? \"\" : key.getSignedVersion(),\n+            \"\",", "originalCommit": "78448a933f2ce1242d122c5db5f6654b0a32fa35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU1NTE1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14531#discussion_r482555156", "bodyText": "Is this comment not true for the whole if block?", "author": "rickle-msft", "createdAt": "2020-09-02T22:40:02Z", "path": "sdk/storage/azure-storage-file-datalake/src/main/java/com/azure/storage/file/datalake/implementation/util/DataLakeSasImplUtil.java", "diffHunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.file.datalake.implementation.util;\n+\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.file.datalake.DataLakeServiceVersion;\n+import com.azure.storage.file.datalake.models.UserDelegationKey;\n+import com.azure.storage.common.StorageSharedKeyCredential;\n+import com.azure.storage.common.implementation.Constants;\n+import com.azure.storage.common.implementation.StorageImplUtils;\n+import com.azure.storage.common.sas.SasIpRange;\n+import com.azure.storage.common.sas.SasProtocol;\n+import com.azure.storage.file.datalake.sas.DataLakeServiceSasSignatureValues;\n+import com.azure.storage.file.datalake.sas.FileSystemSasPermission;\n+import com.azure.storage.file.datalake.sas.PathSasPermission;\n+\n+import java.time.OffsetDateTime;\n+import java.util.Objects;\n+\n+import static com.azure.storage.common.implementation.SasImplUtils.formatQueryParameterDate;\n+import static com.azure.storage.common.implementation.SasImplUtils.tryAppendQueryParameter;\n+\n+/**\n+ * This class provides helper methods for common datalake service sas patterns.\n+ *\n+ * RESERVED FOR INTERNAL USE.\n+ */\n+public class DataLakeSasImplUtil {\n+    /**\n+     * The SAS blob (datalake file) constant.\n+     */\n+    private static final String SAS_BLOB_CONSTANT = \"b\";\n+\n+    /**\n+     * The SAS directory (datalake directory) constant.\n+     */\n+    private static final String SAS_DIRECTORY_CONSTANT = \"d\";\n+\n+    /**\n+     * The SAS blob container (datalake file system) constant.\n+     */\n+    private static final String SAS_CONTAINER_CONSTANT = \"c\";\n+\n+    private final ClientLogger logger = new ClientLogger(DataLakeSasImplUtil.class);\n+\n+    private static String version = DataLakeServiceVersion.getLatest().getVersion();\n+\n+    private SasProtocol protocol;\n+\n+    private OffsetDateTime startTime;\n+\n+    private OffsetDateTime expiryTime;\n+\n+    private String permissions;\n+\n+    private SasIpRange sasIpRange;\n+\n+    private String fileSystemName;\n+\n+    private String pathName;\n+\n+    private String resource;\n+\n+    private String identifier;\n+\n+    private String cacheControl;\n+\n+    private String contentDisposition;\n+\n+    private String contentEncoding;\n+\n+    private String contentLanguage;\n+\n+    private String contentType;\n+\n+    private Boolean isDirectory;\n+\n+    private Integer directoryDepth;\n+\n+    private String authorizedAadObjectId;\n+\n+    private String unauthorizedAadObjectId;\n+\n+    private String correlationId;\n+\n+    /**\n+     * Creates a new {@link DataLakeSasImplUtil} with the specified parameters\n+     *\n+     * @param sasValues {@link DataLakeServiceSasSignatureValues}\n+     * @param fileSystemName The file system name\n+     */\n+    public DataLakeSasImplUtil(DataLakeServiceSasSignatureValues sasValues, String fileSystemName) {\n+        this(sasValues, fileSystemName, null, false);\n+    }\n+\n+    /**\n+     * Creates a new {@link DataLakeSasImplUtil} with the specified parameters\n+     *\n+     * @param sasValues {@link DataLakeServiceSasSignatureValues}\n+     * @param fileSystemName The file system name\n+     * @param pathName The path name\n+     * @param isDirectory Whether or not the path points to a directory.\n+     */\n+    public DataLakeSasImplUtil(DataLakeServiceSasSignatureValues sasValues, String fileSystemName, String pathName,\n+        boolean isDirectory) {\n+        Objects.requireNonNull(sasValues);\n+        this.protocol = sasValues.getProtocol();\n+        this.startTime = sasValues.getStartTime();\n+        this.expiryTime = sasValues.getExpiryTime();\n+        this.permissions = sasValues.getPermissions();\n+        this.sasIpRange = sasValues.getSasIpRange();\n+        this.fileSystemName = fileSystemName;\n+        this.pathName = pathName;\n+        this.identifier = sasValues.getIdentifier();\n+        this.cacheControl = sasValues.getCacheControl();\n+        this.contentDisposition = sasValues.getContentDisposition();\n+        this.contentEncoding = sasValues.getContentEncoding();\n+        this.contentLanguage = sasValues.getContentLanguage();\n+        this.contentType = sasValues.getContentType();\n+        if (sasValues.isPosixCheckPerformed()) {\n+            this.unauthorizedAadObjectId = sasValues.getObjectId();\n+        } else {\n+            this.authorizedAadObjectId = sasValues.getObjectId();\n+        }\n+        this.correlationId = sasValues.getCorrelationId();\n+        this.isDirectory = isDirectory;\n+    }\n+\n+    /**\n+     * Generates a Sas signed with a {@link StorageSharedKeyCredential}\n+     *\n+     * @param storageSharedKeyCredentials {@link StorageSharedKeyCredential}\n+     * @return A String representing the Sas\n+     */\n+    public String generateSas(StorageSharedKeyCredential storageSharedKeyCredentials) {\n+        StorageImplUtils.assertNotNull(\"storageSharedKeyCredentials\", storageSharedKeyCredentials);\n+\n+        ensureState();\n+\n+        // Signature is generated on the un-url-encoded values.\n+        final String canonicalName = getCanonicalName(storageSharedKeyCredentials.getAccountName());\n+        final String signature = storageSharedKeyCredentials.computeHmac256(stringToSign(canonicalName));\n+\n+        return encode(null /* userDelegationKey */, signature);\n+    }\n+\n+    /**\n+     * Generates a Sas signed with a {@link UserDelegationKey}\n+     *\n+     * @param delegationKey {@link UserDelegationKey}\n+     * @param accountName The account name\n+     * @return A String representing the Sas\n+     */\n+    public String generateUserDelegationSas(UserDelegationKey delegationKey, String accountName) {\n+        StorageImplUtils.assertNotNull(\"delegationKey\", delegationKey);\n+        StorageImplUtils.assertNotNull(\"accountName\", accountName);\n+\n+        ensureState();\n+\n+        // Signature is generated on the un-url-encoded values.\n+        final String canonicalName = getCanonicalName(accountName);\n+        String signature = StorageImplUtils.computeHMac256(\n+            delegationKey.getValue(), stringToSign(delegationKey, canonicalName));\n+\n+        return encode(delegationKey, signature);\n+    }\n+\n+    /**\n+     * Encodes a Sas from the values in this type.\n+     * @param userDelegationKey {@link UserDelegationKey}\n+     * @param signature The signature of the Sas.\n+     * @return A String representing the Sas.\n+     */\n+    private String encode(UserDelegationKey userDelegationKey, String signature) {\n+        /*\n+         We should be url-encoding each key and each value, but because we know all the keys and values will encode to\n+         themselves, we cheat except for the signature value.\n+         */\n+        StringBuilder sb = new StringBuilder();\n+\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SERVICE_VERSION, version);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_PROTOCOL, this.protocol);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_START_TIME, formatQueryParameterDate(this.startTime));\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_EXPIRY_TIME, formatQueryParameterDate(this.expiryTime));\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_IP_RANGE, this.sasIpRange);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_IDENTIFIER, this.identifier);\n+\n+        if (userDelegationKey != null) {\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_OBJECT_ID,\n+                userDelegationKey.getSignedObjectId());\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_TENANT_ID,\n+                userDelegationKey.getSignedTenantId());\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_KEY_START,\n+                formatQueryParameterDate(userDelegationKey.getSignedStart()));\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_KEY_EXPIRY,\n+                formatQueryParameterDate(userDelegationKey.getSignedExpiry()));\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_KEY_SERVICE,\n+                userDelegationKey.getSignedService());\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_KEY_VERSION,\n+                userDelegationKey.getSignedVersion());\n+\n+            /* Only parameters relevant for user delegation SAS. */", "originalCommit": "78448a933f2ce1242d122c5db5f6654b0a32fa35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEzMjU5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14531#discussion_r483132590", "bodyText": "Yeah I wanted to more be like these are the only params relevant to user delegation sas but not actually tied to the user delegation key", "author": "gapra-msft", "createdAt": "2020-09-03T17:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU1NTE1Ng=="}], "type": "inlineReview"}, {"oid": "2ef2cee14e5e89d0adba88dac575572f4cb39e94", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2ef2cee14e5e89d0adba88dac575572f4cb39e94", "message": "Merge branch 'feature/storage/stg74' into storage/delegationSas", "committedDate": "2020-09-03T17:03:02Z", "type": "commit"}, {"oid": "5b71fea6ffe7fb9514b5cc59777c1443a8d50523", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5b71fea6ffe7fb9514b5cc59777c1443a8d50523", "message": "comment related stuff", "committedDate": "2020-09-03T17:12:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyODYxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14531#discussion_r483228614", "bodyText": "NIT - remove extra new line", "author": "amnguye", "createdAt": "2020-09-03T20:14:50Z", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/sas/CommonSasQueryParameters.java", "diffHunk": "@@ -11,6 +11,7 @@\n import java.util.Map;\n import java.util.function.Function;\n \n+", "originalCommit": "5b71fea6ffe7fb9514b5cc59777c1443a8d50523", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzODIxNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14531#discussion_r483238217", "bodyText": "NIT - unrecognised -> unrecognized", "author": "amnguye", "createdAt": "2020-09-03T20:32:16Z", "path": "sdk/storage/azure-storage-file-datalake/src/main/java/com/azure/storage/file/datalake/implementation/util/DataLakeSasImplUtil.java", "diffHunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.file.datalake.implementation.util;\n+\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.file.datalake.DataLakeServiceVersion;\n+import com.azure.storage.file.datalake.models.UserDelegationKey;\n+import com.azure.storage.common.StorageSharedKeyCredential;\n+import com.azure.storage.common.implementation.Constants;\n+import com.azure.storage.common.implementation.StorageImplUtils;\n+import com.azure.storage.common.sas.SasIpRange;\n+import com.azure.storage.common.sas.SasProtocol;\n+import com.azure.storage.file.datalake.sas.DataLakeServiceSasSignatureValues;\n+import com.azure.storage.file.datalake.sas.FileSystemSasPermission;\n+import com.azure.storage.file.datalake.sas.PathSasPermission;\n+\n+import java.time.OffsetDateTime;\n+import java.util.Objects;\n+\n+import static com.azure.storage.common.implementation.SasImplUtils.formatQueryParameterDate;\n+import static com.azure.storage.common.implementation.SasImplUtils.tryAppendQueryParameter;\n+\n+/**\n+ * This class provides helper methods for common datalake service sas patterns.\n+ *\n+ * RESERVED FOR INTERNAL USE.\n+ */\n+public class DataLakeSasImplUtil {\n+    /**\n+     * The SAS blob (datalake file) constant.\n+     */\n+    private static final String SAS_BLOB_CONSTANT = \"b\";\n+\n+    /**\n+     * The SAS directory (datalake directory) constant.\n+     */\n+    private static final String SAS_DIRECTORY_CONSTANT = \"d\";\n+\n+    /**\n+     * The SAS blob container (datalake file system) constant.\n+     */\n+    private static final String SAS_CONTAINER_CONSTANT = \"c\";\n+\n+    private final ClientLogger logger = new ClientLogger(DataLakeSasImplUtil.class);\n+\n+    private static String version = DataLakeServiceVersion.getLatest().getVersion();\n+\n+    private SasProtocol protocol;\n+\n+    private OffsetDateTime startTime;\n+\n+    private OffsetDateTime expiryTime;\n+\n+    private String permissions;\n+\n+    private SasIpRange sasIpRange;\n+\n+    private String fileSystemName;\n+\n+    private String pathName;\n+\n+    private String resource;\n+\n+    private String identifier;\n+\n+    private String cacheControl;\n+\n+    private String contentDisposition;\n+\n+    private String contentEncoding;\n+\n+    private String contentLanguage;\n+\n+    private String contentType;\n+\n+    private Boolean isDirectory;\n+\n+    private Integer directoryDepth;\n+\n+    private String authorizedAadObjectId;\n+\n+    private String unauthorizedAadObjectId;\n+\n+    private String correlationId;\n+\n+    /**\n+     * Creates a new {@link DataLakeSasImplUtil} with the specified parameters\n+     *\n+     * @param sasValues {@link DataLakeServiceSasSignatureValues}\n+     * @param fileSystemName The file system name\n+     */\n+    public DataLakeSasImplUtil(DataLakeServiceSasSignatureValues sasValues, String fileSystemName) {\n+        this(sasValues, fileSystemName, null, false);\n+    }\n+\n+    /**\n+     * Creates a new {@link DataLakeSasImplUtil} with the specified parameters\n+     *\n+     * @param sasValues {@link DataLakeServiceSasSignatureValues}\n+     * @param fileSystemName The file system name\n+     * @param pathName The path name\n+     * @param isDirectory Whether or not the path points to a directory.\n+     */\n+    public DataLakeSasImplUtil(DataLakeServiceSasSignatureValues sasValues, String fileSystemName, String pathName,\n+        boolean isDirectory) {\n+        Objects.requireNonNull(sasValues);\n+        this.protocol = sasValues.getProtocol();\n+        this.startTime = sasValues.getStartTime();\n+        this.expiryTime = sasValues.getExpiryTime();\n+        this.permissions = sasValues.getPermissions();\n+        this.sasIpRange = sasValues.getSasIpRange();\n+        this.fileSystemName = fileSystemName;\n+        this.pathName = pathName;\n+        this.identifier = sasValues.getIdentifier();\n+        this.cacheControl = sasValues.getCacheControl();\n+        this.contentDisposition = sasValues.getContentDisposition();\n+        this.contentEncoding = sasValues.getContentEncoding();\n+        this.contentLanguage = sasValues.getContentLanguage();\n+        this.contentType = sasValues.getContentType();\n+        if (sasValues.isPosixCheckPerformed()) {\n+            this.unauthorizedAadObjectId = sasValues.getObjectId();\n+        } else {\n+            this.authorizedAadObjectId = sasValues.getObjectId();\n+        }\n+        this.correlationId = sasValues.getCorrelationId();\n+        this.isDirectory = isDirectory;\n+    }\n+\n+    /**\n+     * Generates a Sas signed with a {@link StorageSharedKeyCredential}\n+     *\n+     * @param storageSharedKeyCredentials {@link StorageSharedKeyCredential}\n+     * @return A String representing the Sas\n+     */\n+    public String generateSas(StorageSharedKeyCredential storageSharedKeyCredentials) {\n+        StorageImplUtils.assertNotNull(\"storageSharedKeyCredentials\", storageSharedKeyCredentials);\n+\n+        ensureState();\n+\n+        // Signature is generated on the un-url-encoded values.\n+        final String canonicalName = getCanonicalName(storageSharedKeyCredentials.getAccountName());\n+        final String signature = storageSharedKeyCredentials.computeHmac256(stringToSign(canonicalName));\n+\n+        return encode(null /* userDelegationKey */, signature);\n+    }\n+\n+    /**\n+     * Generates a Sas signed with a {@link UserDelegationKey}\n+     *\n+     * @param delegationKey {@link UserDelegationKey}\n+     * @param accountName The account name\n+     * @return A String representing the Sas\n+     */\n+    public String generateUserDelegationSas(UserDelegationKey delegationKey, String accountName) {\n+        StorageImplUtils.assertNotNull(\"delegationKey\", delegationKey);\n+        StorageImplUtils.assertNotNull(\"accountName\", accountName);\n+\n+        ensureState();\n+\n+        // Signature is generated on the un-url-encoded values.\n+        final String canonicalName = getCanonicalName(accountName);\n+        String signature = StorageImplUtils.computeHMac256(\n+            delegationKey.getValue(), stringToSign(delegationKey, canonicalName));\n+\n+        return encode(delegationKey, signature);\n+    }\n+\n+    /**\n+     * Encodes a Sas from the values in this type.\n+     * @param userDelegationKey {@link UserDelegationKey}\n+     * @param signature The signature of the Sas.\n+     * @return A String representing the Sas.\n+     */\n+    private String encode(UserDelegationKey userDelegationKey, String signature) {\n+        /*\n+         We should be url-encoding each key and each value, but because we know all the keys and values will encode to\n+         themselves, we cheat except for the signature value.\n+         */\n+        StringBuilder sb = new StringBuilder();\n+\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SERVICE_VERSION, version);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_PROTOCOL, this.protocol);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_START_TIME, formatQueryParameterDate(this.startTime));\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_EXPIRY_TIME, formatQueryParameterDate(this.expiryTime));\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_IP_RANGE, this.sasIpRange);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_IDENTIFIER, this.identifier);\n+\n+        if (userDelegationKey != null) {\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_OBJECT_ID,\n+                userDelegationKey.getSignedObjectId());\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_TENANT_ID,\n+                userDelegationKey.getSignedTenantId());\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_KEY_START,\n+                formatQueryParameterDate(userDelegationKey.getSignedStart()));\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_KEY_EXPIRY,\n+                formatQueryParameterDate(userDelegationKey.getSignedExpiry()));\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_KEY_SERVICE,\n+                userDelegationKey.getSignedService());\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_KEY_VERSION,\n+                userDelegationKey.getSignedVersion());\n+\n+            /* Only parameters relevant for user delegation SAS. */\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_AUTHORIZED_OBJECT_ID, this.authorizedAadObjectId);\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_UNAUTHORIZED_OBJECT_ID, this.unauthorizedAadObjectId);\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_CORRELATION_ID, this.correlationId);\n+        }\n+\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_RESOURCE, this.resource);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNED_PERMISSIONS, this.permissions);\n+\n+        if (this.isDirectory) {\n+            tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_DIRECTORY_DEPTH, this.directoryDepth);\n+        }\n+\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_SIGNATURE, signature);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_CACHE_CONTROL, this.cacheControl);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_CONTENT_DISPOSITION, this.contentDisposition);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_CONTENT_ENCODING, this.contentEncoding);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_CONTENT_LANGUAGE, this.contentLanguage);\n+        tryAppendQueryParameter(sb, Constants.UrlConstants.SAS_CONTENT_TYPE, this.contentType);\n+\n+        return sb.toString();\n+\n+    }\n+\n+    /**\n+     * Ensures that the builder's properties are in a consistent state.\n+\n+     * 1. If there is no identifier set, ensure expiryTime and permissions are set.\n+     * 2. Resource name is chosen by:\n+     *    a. If \"BlobName\" is _not_ set, it is a container resource.\n+     *    b. Otherwise, if \"SnapshotId\" is set, it is a blob snapshot resource.\n+     *    c. Otherwise, if \"VersionId\" is set, it is a blob version resource.\n+     *    d. Otherwise, it is a blob resource.\n+     * 3. Reparse permissions depending on what the resource is. If it is an unrecognised resource, do nothing.", "originalCommit": "5b71fea6ffe7fb9514b5cc59777c1443a8d50523", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "35f2c9b4c0537d7d722502475d014a003066f98e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/35f2c9b4c0537d7d722502475d014a003066f98e", "message": "Addressed comments and changed change to manage", "committedDate": "2020-09-08T18:24:25Z", "type": "commit"}, {"oid": "7b1a75188558c018d9cd233b4d5facc0d2000377", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b1a75188558c018d9cd233b4d5facc0d2000377", "message": "Modified public API to create 2 different setters", "committedDate": "2020-09-08T21:23:29Z", "type": "commit"}, {"oid": "7e33e91229e77f09659574456eb00eca78c604d7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7e33e91229e77f09659574456eb00eca78c604d7", "message": "Fixed another test", "committedDate": "2020-09-08T21:41:52Z", "type": "commit"}, {"oid": "971cf9a3f090aca8166fc6884d448fed822b6077", "url": "https://github.com/Azure/azure-sdk-for-java/commit/971cf9a3f090aca8166fc6884d448fed822b6077", "message": "rename of permission", "committedDate": "2020-09-09T16:50:50Z", "type": "commit"}, {"oid": "8aed155cee13588578e0f61ce0df39f3af55c6b9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8aed155cee13588578e0f61ce0df39f3af55c6b9", "message": "Changed public constants", "committedDate": "2020-09-09T17:29:23Z", "type": "commit"}, {"oid": "fa4c50bf5b3b35ec0dea08ed2fcc8994353e28b8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fa4c50bf5b3b35ec0dea08ed2fcc8994353e28b8", "message": "Analyze step", "committedDate": "2020-09-09T18:05:21Z", "type": "commit"}]}