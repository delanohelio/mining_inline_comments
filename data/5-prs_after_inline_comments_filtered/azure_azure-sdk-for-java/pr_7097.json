{"pr_number": 7097, "pr_title": "Add az namespace span attribute for App config", "pr_createdAt": "2020-01-03T21:23:44Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/7097", "timeline": [{"oid": "6f16a4eea4fc27d7f0bd9c2ac3024bfe51851201", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f16a4eea4fc27d7f0bd9c2ac3024bfe51851201", "message": "add az namespace span attribute on http", "committedDate": "2020-01-03T21:25:54Z", "type": "forcePushed"}, {"oid": "9ab295727c93832733f7507e6a8db2fa716cd808", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9ab295727c93832733f7507e6a8db2fa716cd808", "message": "add az namespace span attribute on http", "committedDate": "2020-01-03T22:10:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODMxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r362978313", "bodyText": "Does this have to be hardcoded? Can this be made configurable instead?", "author": "srnagar", "createdAt": "2020-01-03T22:11:47Z", "path": "sdk/core/azure-core-tracing-opentelemetry/src/main/java/com/azure/core/tracing/opentelemetry/implementation/HttpTraceUtil.java", "diffHunk": "@@ -121,5 +125,28 @@ public static Status parseResponseStatus(int statusCode, Throwable error) {\n                 return Status.UNKNOWN.withDescription(message);\n         }\n     }\n+\n+    /**\n+     * Parse the resource provider name from the user span name.\n+     *\n+     * @param userSpanName the span name populated in the RestProxy layer.\n+     *\n+     * @return the resource provider group name.\n+     */\n+    public static String parseNamespaceProvider(String userSpanName) {\n+        if (userSpanName.contains(\"KeyVault\")) {", "originalCommit": "9ab295727c93832733f7507e6a8db2fa716cd808", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODcyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r362978725", "bodyText": "Can we include tracing in the name of this context key? This will make it clear as to what this key is used for. AZ_NAMESPACE is too generic.", "author": "srnagar", "createdAt": "2020-01-03T22:13:23Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/tracing/Tracer.java", "diffHunk": "@@ -57,6 +57,11 @@\n      */\n     String SPAN_BUILDER_KEY = \"builder\";\n \n+    /**\n+     * Key for {@link Context} which indicates that the context contains the Azure resource provider namespace.\n+     */\n+    String AZ_NAMESPACE_KEY = \"az.namespace\";", "originalCommit": "9ab295727c93832733f7507e6a8db2fa716cd808", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4MDQ4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r362980486", "bodyText": "but wouldn't coming from Tracer class help to understand that it is coming from tracing concepts.\nI think it would repetitive to mention it in the variable name and class name too.", "author": "samvaity", "createdAt": "2020-01-03T22:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4MjY5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r362982699", "bodyText": "No, context is a property bag that is passed around quite a lot in all layers of our library. Having a key named az.namespace in context will not necessarily be clear as to what this namespace is and why it's used.", "author": "srnagar", "createdAt": "2020-01-03T22:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ2NTY0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r363465648", "bodyText": "I think there is a slight mismatch in communication here. Srikanta is talking about the string \"az.namespace\", not the variable name \"AZ_NAMESPACE_KEY\" (despite the fact he used \"AZ_NAMESPACE\" in his comment). His argument is valid - imagine have a Map or a Context full of keys, one of which is \"az.namespace\" - it isn't clear where that came from or how it is relevant. If it had a more specific value then users might better infer that it is tracing related.", "author": "JonathanGiles", "createdAt": "2020-01-06T20:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNjI2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364526263", "bodyText": "Updated both the key and value to include tracing, i.e AZ_TRACING_NAMESPACE_KEY and az.tracing.namespace. The span attribute will still have the key az.namespace.", "author": "samvaity", "createdAt": "2020-01-09T01:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3NzQ2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r362977468", "bodyText": "How reliably can we determine whether the SwaggerInterfaceParser's serviceName will contain the expected names here? Instead within RestProxy could we retrieve the name of the package where the method exists and pass through an additional context value which will be a bit more robust compared to either a codegen name/hand-written name?", "author": "alzimmermsft", "createdAt": "2020-01-03T22:08:20Z", "path": "sdk/core/azure-core-tracing-opentelemetry/src/main/java/com/azure/core/tracing/opentelemetry/implementation/HttpTraceUtil.java", "diffHunk": "@@ -121,5 +125,29 @@ public static Status parseResponseStatus(int statusCode, Throwable error) {\n                 return Status.UNKNOWN.withDescription(message);\n         }\n     }\n+\n+    /**\n+     * Parse the resource provider name from the user span name.\n+     *\n+     * @param userSpanName the span name populated in the RestProxy layer.\n+     *\n+     * @return the resource provider group name.\n+     */\n+    public static String parseNamespaceProvider(String userSpanName) {\n+        if (userSpanName.contains(\"KeyVault\")) {\n+            return \"Microsoft.KeyVault\";\n+        }\n+        if (userSpanName.contains(\"AppConfig\")) {\n+            return \"Microsoft.AppConfiguration\";\n+        }\n+        if (userSpanName.contains(\"Storage\")) {\n+            return \"Microsoft.Storage\";\n+        }\n+        if (userSpanName.contains(\"TextAnalytics\")) {\n+            return \"Microsoft.CognitiveServices\";\n+        }", "originalCommit": "6f16a4eea4fc27d7f0bd9c2ac3024bfe51851201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQyNTQ4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r363425486", "bodyText": "I agree it does not seem like a reliable/easy to maintain way to determine resource provider namespace. Could each library set some common global variable? It should also be possible to fall back to default value (null ?) and don't set az.namespace attribute in this case eliminating libraries that don't support tracing", "author": "lmolkova", "createdAt": "2020-01-06T18:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3NzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ2NjA0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r363466046", "bodyText": "I agree, this is fraught with danger. Let's find a better solution.", "author": "JonathanGiles", "createdAt": "2020-01-06T20:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3NzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNTExNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364525114", "bodyText": "Updated the approach to allow the client libraries to send in their respective Resource Provider Names to pass through the context object and skip the hand-written comparisons. Also, updated it to skip adding the attribute if az.namespace value isn't set.", "author": "samvaity", "createdAt": "2020-01-09T01:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3NzQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODYzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r362978637", "bodyText": "This is the OpenTelemetry package, should revert the comment renames.", "author": "alzimmermsft", "createdAt": "2020-01-03T22:13:03Z", "path": "sdk/core/azure-core-tracing-opentelemetry/src/main/java/com/azure/core/tracing/opentelemetry/implementation/HttpTraceUtil.java", "diffHunk": "@@ -25,21 +26,24 @@\n     private static final Status STATUS_502 = Status.UNKNOWN.withDescription(\"Bad Gateway\");\n     private static final Status STATUS_505 = Status.UNKNOWN.withDescription(\"HTTP Version not supported\");\n \n-    private HttpTraceUtil() { }\n+    private final ClientLogger logger = new ClientLogger(HttpTraceUtil.class);\n+\n+    private HttpTraceUtil() {\n+    }\n \n     /**\n-     * Parse OpenTelemetry Status from HTTP response status code.\n+     * Parse OpenCensus Status from HTTP response status code.", "originalCommit": "9ab295727c93832733f7507e6a8db2fa716cd808", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODgxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r362978819", "bodyText": "Should this add the attribute if the parsed name is \"\"? It appear in the policy it doesn't.", "author": "alzimmermsft", "createdAt": "2020-01-03T22:13:49Z", "path": "sdk/core/azure-core-tracing-opentelemetry/src/main/java/com/azure/core/tracing/opentelemetry/OpenTelemetryTracer.java", "diffHunk": "@@ -48,7 +48,10 @@ public Context start(String spanName, Context context) {\n \n         Builder spanBuilder = getSpanBuilder(spanName, context);\n         Span span = spanBuilder.startSpan();\n-\n+        if (span.isRecording()) {\n+            span.setAttribute(AZ_NAMESPACE_KEY,\n+                AttributeValue.stringAttributeValue(HttpTraceUtil.parseNamespaceProvider(spanName)));", "originalCommit": "9ab295727c93832733f7507e6a8db2fa716cd808", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNDQzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364524437", "bodyText": "updated it to not have the span attribute if it does not exist.", "author": "samvaity", "createdAt": "2020-01-09T01:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3ODgxOQ=="}], "type": "inlineReview"}, {"oid": "8fade316c1de53313e6ebc4cb4eebc0b83006f4e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fade316c1de53313e6ebc4cb4eebc0b83006f4e", "message": "update core version to unreleased", "committedDate": "2020-01-09T01:24:39Z", "type": "forcePushed"}, {"oid": "75063750978b0c5f87aff893772d1d235fc2ce6a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/75063750978b0c5f87aff893772d1d235fc2ce6a", "message": "update core version to unreleased", "committedDate": "2020-01-09T01:27:28Z", "type": "forcePushed"}, {"oid": "27c5372fd04a199085f6f742ec7eabe98fa8858b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/27c5372fd04a199085f6f742ec7eabe98fa8858b", "message": "update core version to unreleased", "committedDate": "2020-01-09T01:42:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNDU2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364524568", "bodyText": "call the other constructor from here instead of duplicating initialization code in both constructors.", "author": "srnagar", "createdAt": "2020-01-09T01:35:00Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/rest/RestProxy.java", "diffHunk": "@@ -81,6 +85,27 @@ private RestProxy(HttpPipeline httpPipeline, SerializerAdapter serializer, Swagg\n         this.interfaceParser = interfaceParser;\n         this.decoder = new HttpResponseDecoder(this.serializer);\n         this.responseConstructorsCache = new ResponseConstructorsCache();\n+        this.tracerSpanAttributes = null;", "originalCommit": "75063750978b0c5f87aff893772d1d235fc2ce6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNDkzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364524934", "bodyText": "same here - call this create method from the other create overload method", "author": "srnagar", "createdAt": "2020-01-09T01:37:07Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/rest/RestProxy.java", "diffHunk": "@@ -685,4 +729,25 @@ private static HttpPipeline createDefaultPipeline(HttpPipelinePolicy credentials\n         return (A) Proxy.newProxyInstance(swaggerInterface.getClassLoader(), new Class<?>[]{swaggerInterface},\n             restProxy);\n     }\n+\n+    /**\n+     * Create a proxy implementation of the provided Swagger interface.\n+     *\n+     * @param swaggerInterface the Swagger interface to provide a proxy implementation for\n+     * @param httpPipeline the HttpPipelinePolicy and HttpClient pipeline that will be used to send Http\n+     *     requests\n+     * @param serializer the serializer that will be used to convert POJOs to and from request and\n+     *     response bodies\n+     * @param <A> the type of the Swagger interface.\n+     * @param tracerSpanAttributes the attributes to be set on the tracer spans.\n+     * @return a proxy implementation of the provided Swagger interface\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    public static <A> A create(Class<A> swaggerInterface, HttpPipeline httpPipeline, SerializerAdapter serializer,\n+        TracerSpanAttributes tracerSpanAttributes) {\n+        final SwaggerInterfaceParser interfaceParser = new SwaggerInterfaceParser(swaggerInterface, serializer);", "originalCommit": "75063750978b0c5f87aff893772d1d235fc2ce6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNTQ2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364525465", "bodyText": "Since this has just one attribute now, I am assuming new attributes will be added later. If that's the intent, then shouldn't we make this a fluent API? A public constructor with just one attribute now will result in breaking changes if we need more attributes here later.\nAlternatively, do we need this attributes class, if all fields in here are going to be String types? Can we instead use Map<String, String> as properties bag?", "author": "srnagar", "createdAt": "2020-01-09T01:40:05Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/tracing/TracerSpanAttributes.java", "diffHunk": "@@ -0,0 +1,29 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.util.tracing;\n+\n+/**\n+ * Class to hold the attributes for tracer spans.\n+ */\n+public class TracerSpanAttributes {\n+    private final String resourceProviderName;", "originalCommit": "75063750978b0c5f87aff893772d1d235fc2ce6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk4NTU4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364985582", "bodyText": "Span attributes coming from clients would be expected to be strings and hence updating it to use a Map<String, String> instead.", "author": "samvaity", "createdAt": "2020-01-09T22:12:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNTQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNjE0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364526147", "bodyText": "Can this be marked as a @FunctionalInterface? If yes, can we instead use Java's built-in Supplier?", "author": "srnagar", "createdAt": "2020-01-09T01:43:32Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/tracing/TracerProperties.java", "diffHunk": "@@ -0,0 +1,17 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.util.tracing;\n+\n+/**\n+ * A generic interface for setting tracing properties on outgoing HTTP requests.\n+ */\n+public interface TracerProperties {", "originalCommit": "27c5372fd04a199085f6f742ec7eabe98fa8858b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk4NTExNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r364985115", "bodyText": "updated it to be  a supplier.", "author": "samvaity", "createdAt": "2020-01-09T22:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNjE0Nw=="}], "type": "inlineReview"}, {"oid": "9615c0f896459d313061f3d28c9eb9d752439509", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9615c0f896459d313061f3d28c9eb9d752439509", "message": "update map to use string values", "committedDate": "2020-01-09T22:26:14Z", "type": "forcePushed"}, {"oid": "e857b7d1a1fd2584b0b856b0683b9b16eea75be0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e857b7d1a1fd2584b0b856b0683b9b16eea75be0", "message": "add az namespace span attribute on http", "committedDate": "2020-01-10T00:45:15Z", "type": "commit"}, {"oid": "6c93e87278cc090819f98e284e79fa9d1075824a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6c93e87278cc090819f98e284e79fa9d1075824a", "message": "update app config with az namespace span attribute update", "committedDate": "2020-01-10T00:45:16Z", "type": "commit"}, {"oid": "8115bd51caad9d20024c9bef7c4a74a1249fd598", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8115bd51caad9d20024c9bef7c4a74a1249fd598", "message": "update core version to unreleased", "committedDate": "2020-01-10T00:45:17Z", "type": "commit"}, {"oid": "3f2d3d26b7921fb29f5347a20eec2be57a2415a7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3f2d3d26b7921fb29f5347a20eec2be57a2415a7", "message": "update to supplier and review feedback", "committedDate": "2020-01-10T00:45:18Z", "type": "commit"}, {"oid": "e6bdf66ed60f4f30cc30e0211eb930864c08ccfb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e6bdf66ed60f4f30cc30e0211eb930864c08ccfb", "message": "update map to use string values", "committedDate": "2020-01-10T00:45:19Z", "type": "commit"}, {"oid": "e6bdf66ed60f4f30cc30e0211eb930864c08ccfb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e6bdf66ed60f4f30cc30e0211eb930864c08ccfb", "message": "update map to use string values", "committedDate": "2020-01-10T00:45:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAwNjA4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7097#discussion_r366006088", "bodyText": "This map should be immutable.", "author": "srnagar", "createdAt": "2020-01-13T20:14:35Z", "path": "sdk/appconfiguration/azure-data-appconfiguration/src/main/java/com/azure/data/appconfiguration/ConfigurationAsyncClient.java", "diffHunk": "@@ -54,6 +58,8 @@\n     private final ClientLogger logger = new ClientLogger(ConfigurationAsyncClient.class);\n \n     private static final String ETAG_ANY = \"*\";\n+    private static final Supplier<Map<String, String>> APP_CONFIG_TRACING_PROPERTIES = () ->\n+        new HashMap<String, String>() {{ put(AZ_TRACING_NAMESPACE_KEY, \"Microsoft.AppConfiguration\"); }};", "originalCommit": "e6bdf66ed60f4f30cc30e0211eb930864c08ccfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbe9665cca3d21704401624db6195e330e88e052", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbe9665cca3d21704401624db6195e330e88e052", "message": "update unmodifiable map", "committedDate": "2020-01-14T18:58:11Z", "type": "commit"}]}