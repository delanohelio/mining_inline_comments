{"pr_number": 14324, "pr_title": "[TA] remove throwing the empty id exception manually", "pr_createdAt": "2020-08-21T01:33:51Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14324", "timeline": [{"oid": "3f939b6302e7cb5dedf91d97082c072d19844385", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3f939b6302e7cb5dedf91d97082c072d19844385", "message": "remove throwing the empty id exception manually", "committedDate": "2020-08-21T01:32:55Z", "type": "commit"}, {"oid": "084125a950cdcc18637ef7aa6aedfe60cd5f46ef", "url": "https://github.com/Azure/azure-sdk-for-java/commit/084125a950cdcc18637ef7aa6aedfe60cd5f46ef", "message": "remove unused import", "committedDate": "2020-08-21T01:39:43Z", "type": "commit"}, {"oid": "d86c8c083ff2c8e42e4a00d2d3bd48e3354e1428", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d86c8c083ff2c8e42e4a00d2d3bd48e3354e1428", "message": "add tests for the changes", "committedDate": "2020-08-21T17:59:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1Mjg5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r474852892", "bodyText": "this fix is not related to empty id but it is a quick fix for make sure the async and sync tests are verifying the same thing. Previously they are verifying the error.", "author": "mssfang", "createdAt": "2020-08-21T18:13:55Z", "path": "sdk/textanalytics/azure-ai-textanalytics/src/test/java/com/azure/ai/textanalytics/TextAnalyticsAsyncClientTest.java", "diffHunk": "@@ -268,21 +287,32 @@ public void recognizeEntitiesDuplicateIdInput(HttpClient httpClient, TextAnalyti\n                 .verifyErrorSatisfies(ex -> assertEquals(HttpResponseException.class, ex.getClass())));\n     }\n \n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.ai.textanalytics.TestUtils#getTestParameters\")\n+    public void recognizeEntitiesEmptyIdInput(HttpClient httpClient, TextAnalyticsServiceVersion serviceVersion) {\n+        client = getTextAnalyticsAsyncClient(httpClient, serviceVersion);\n+        textAnalyticsInputEmptyIdRunner(inputs ->\n+            StepVerifier.create(client.recognizeEntitiesBatchWithResponse(inputs, null))\n+                .verifyErrorSatisfies(ex -> {\n+                    HttpResponseException httpResponseException = (HttpResponseException) ex;\n+                    assertEquals(400, httpResponseException.getResponse().getStatusCode());\n+                    TextAnalyticsError textAnalyticsError = (TextAnalyticsError) httpResponseException.getValue();\n+                    // TODO: TextAnalyticsError has null values for all properties,\n+                    //       https://github.com/Azure/azure-sdk-for-java/issues/13960\n+                    // assertEquals(INVALID_DOCUMENT, textAnalyticsError.getErrorCode());\n+                }));\n+    }\n+\n     @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n     @MethodSource(\"com.azure.ai.textanalytics.TestUtils#getTestParameters\")\n     public void recognizeEntitiesBatchInputSingleError(HttpClient httpClient, TextAnalyticsServiceVersion serviceVersion) {\n         client = getTextAnalyticsAsyncClient(httpClient, serviceVersion);\n         recognizeBatchCategorizedEntitySingleErrorRunner((inputs) ->\n             StepVerifier.create(client.recognizeEntitiesBatchWithResponse(inputs, null))\n-                .assertNext(resultCollection -> {\n-                    resultCollection.getValue().forEach(result -> {\n-                        assertTrue(result.isError());\n-                        final TextAnalyticsError error = result.getError();\n-                        TextAnalyticsErrorCode errorCode = error.getErrorCode();\n-                        assertTrue(TextAnalyticsErrorCode.fromString(\"invalidDocument\").equals(errorCode));\n-                        assertTrue(\"Document text is empty.\".equals(error.getMessage()));\n-                    });\n-                }).verifyComplete());\n+                .assertNext(resultCollection -> resultCollection.getValue().forEach(recognizeEntitiesResult -> {\n+                    Exception exception = assertThrows(TextAnalyticsException.class, recognizeEntitiesResult::getEntities);\n+                    assertEquals(String.format(BATCH_ERROR_EXCEPTION_MESSAGE, \"RecognizeEntitiesResult\"), exception.getMessage());", "originalCommit": "d86c8c083ff2c8e42e4a00d2d3bd48e3354e1428", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1MzE0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r474853142", "bodyText": "same reason as https://github.com/Azure/azure-sdk-for-java/pull/14324/files#r474852892", "author": "mssfang", "createdAt": "2020-08-21T18:14:29Z", "path": "sdk/textanalytics/azure-ai-textanalytics/src/test/java/com/azure/ai/textanalytics/TextAnalyticsAsyncClientTest.java", "diffHunk": "@@ -376,21 +406,32 @@ public void recognizePiiEntitiesDuplicateIdInput(HttpClient httpClient, TextAnal\n                 .verifyErrorSatisfies(ex -> assertEquals(HttpResponseException.class, ex.getClass())));\n     }\n \n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.ai.textanalytics.TestUtils#getTestParameters\")\n+    public void recognizePiiEntitiesEmptyIdInput(HttpClient httpClient, TextAnalyticsServiceVersion serviceVersion) {\n+        client = getTextAnalyticsAsyncClient(httpClient, serviceVersion);\n+        textAnalyticsInputEmptyIdRunner(inputs ->\n+            StepVerifier.create(client.recognizePiiEntitiesBatchWithResponse(inputs, null))\n+                .verifyErrorSatisfies(ex -> {\n+                    HttpResponseException httpResponseException = (HttpResponseException) ex;\n+                    assertEquals(400, httpResponseException.getResponse().getStatusCode());\n+                    TextAnalyticsError textAnalyticsError = (TextAnalyticsError) httpResponseException.getValue();\n+                    // TODO: TextAnalyticsError has null values for all properties,\n+                    //       https://github.com/Azure/azure-sdk-for-java/issues/13960\n+                    // assertEquals(INVALID_DOCUMENT, textAnalyticsError.getErrorCode());\n+                }));\n+    }\n+\n     @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n     @MethodSource(\"com.azure.ai.textanalytics.TestUtils#getTestParameters\")\n     public void recognizePiiEntitiesBatchInputSingleError(HttpClient httpClient, TextAnalyticsServiceVersion serviceVersion) {\n         client = getTextAnalyticsAsyncClient(httpClient, serviceVersion);\n         recognizeBatchPiiEntitySingleErrorRunner((inputs) ->\n             StepVerifier.create(client.recognizePiiEntitiesBatchWithResponse(inputs, null))\n-                .assertNext(resultCollection -> {\n-                    resultCollection.getValue().forEach(result -> {\n-                        assertTrue(result.isError());\n-                        final TextAnalyticsError error = result.getError();\n-                        TextAnalyticsErrorCode errorCode = error.getErrorCode();\n-                        assertTrue(TextAnalyticsErrorCode.fromString(\"invalidDocument\").equals(errorCode));\n-                        assertTrue(\"Document text is empty.\".equals(error.getMessage()));\n-                    });\n-                }).verifyComplete());\n+                .assertNext(resultCollection -> resultCollection.getValue().forEach(recognizePiiEntitiesResult -> {", "originalCommit": "d86c8c083ff2c8e42e4a00d2d3bd48e3354e1428", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk5NjM2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r474996364", "bodyText": "Seems like form here we are getting non-null values. What exactly is missing?", "author": "samvaity", "createdAt": "2020-08-21T22:30:21Z", "path": "sdk/textanalytics/azure-ai-textanalytics/src/test/java/com/azure/ai/textanalytics/TextAnalyticsAsyncClientTest.java", "diffHunk": "@@ -198,6 +198,25 @@ public void detectLanguageDuplicateIdInput(HttpClient httpClient, TextAnalyticsS\n                 .verifyErrorSatisfies(ex -> assertEquals(HttpResponseException.class, ex.getClass())));\n     }\n \n+    /**\n+     * Verifies that an invalid document exception is returned for input documents with an empty ID.\n+     */\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.ai.textanalytics.TestUtils#getTestParameters\")\n+    public void detectLanguageEmptyIdInput(HttpClient httpClient, TextAnalyticsServiceVersion serviceVersion) {\n+        client = getTextAnalyticsAsyncClient(httpClient, serviceVersion);\n+        detectLanguageInputEmptyIdRunner(inputs ->\n+            StepVerifier.create(client.detectLanguageBatchWithResponse(inputs, null))\n+                .verifyErrorSatisfies(ex -> {\n+                    HttpResponseException httpResponseException = (HttpResponseException) ex;\n+                    assertEquals(400, httpResponseException.getResponse().getStatusCode());\n+                    TextAnalyticsError textAnalyticsError = (TextAnalyticsError) httpResponseException.getValue();\n+                    // TODO: TextAnalyticsError has null values for all properties,", "originalCommit": "d86c8c083ff2c8e42e4a00d2d3bd48e3354e1428", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEyOTY5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476129691", "bodyText": "The JSON output is same as the postman output. Java deserialization doesn't parse the \"error\" object in this case. More detail can be found in here: https://teams.microsoft.com/l/message/19:d6ff4003f5c848a2a2d6dcdfc0ebd497@thread.skype/1597103339389?tenantId=72f988bf-86f1-41af-91ab-2d7cd011db47&groupId=3e17dcb0-4257-4a30-b843-77f47f1d4121&parentMessageId=1597103339389&teamName=Azure%20SDK&channelName=Service%20-%20Text%20Analytics&createdTime=1597103339389", "author": "mssfang", "createdAt": "2020-08-25T03:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk5NjM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwMDIzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r475700238", "bodyText": "I'm not seeing tests for the error that gets thrown when too many documents are being passed (might just not have found the tests). I have tests for every endpoint except detect_language and they're all called test_too_many_documents. Here's an example of one. Even though we're no longer throwing a special error ourselves in this case, I think it's still good to have a test for it", "author": "iscai-msft", "createdAt": "2020-08-24T15:28:35Z", "path": "sdk/textanalytics/azure-ai-textanalytics/src/test/java/com/azure/ai/textanalytics/TextAnalyticsClientTestBase.java", "diffHunk": "@@ -98,6 +102,12 @@\n     @Test\n     abstract void recognizeEntitiesForFaultyText(HttpClient httpClient, TextAnalyticsServiceVersion serviceVersion);\n \n+    @Test", "originalCommit": "d86c8c083ff2c8e42e4a00d2d3bd48e3354e1428", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE0NTU0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476145546", "bodyText": "I was thinking to do it later when resolving this issue #13960. But it should be good to include the tests but keep the issue open until service resolve it.", "author": "mssfang", "createdAt": "2020-08-25T04:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwMDIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE1ODM2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476158364", "bodyText": "seems only detect_language can take more than 31 documents currently. Does it happen in Python? Other endpoints can throw errors in 10 documents.", "author": "mssfang", "createdAt": "2020-08-25T04:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwMDIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MjAzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476542038", "bodyText": "the limit is different for the different endpoints, see here.  For detect_language i don't have any tests, since if I have more than 1000 documents, I run into batch oversize error instead. The other tests I do based off of the size limit + 1", "author": "iscai-msft", "createdAt": "2020-08-25T15:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwMDIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkyMDA1OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476920059", "bodyText": "OK. then i would have no test for detect_language endpoint then", "author": "mssfang", "createdAt": "2020-08-26T00:41:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwMDIzOA=="}], "type": "inlineReview"}, {"oid": "64bb30b01cef0c1cd394a06fd0d6a96334998a81", "url": "https://github.com/Azure/azure-sdk-for-java/commit/64bb30b01cef0c1cd394a06fd0d6a96334998a81", "message": "add tooManydocumentTests", "committedDate": "2020-08-25T04:42:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MjYzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476542630", "bodyText": "nit: i'd remove this commented out code, you can't really reach too many documents with detect_language, since if you go over, you will actually run into a batch size overload error instead", "author": "iscai-msft", "createdAt": "2020-08-25T15:34:09Z", "path": "sdk/textanalytics/azure-ai-textanalytics/src/test/java/com/azure/ai/textanalytics/TextAnalyticsAsyncClientTest.java", "diffHunk": "@@ -243,6 +243,25 @@ public void detectLanguageNoneCountryHint(HttpClient httpClient, TextAnalyticsSe\n                 .verifyComplete());\n     }\n \n+//    /**", "originalCommit": "64bb30b01cef0c1cd394a06fd0d6a96334998a81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkyNTI4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476925283", "bodyText": "removed this test", "author": "mssfang", "createdAt": "2020-08-26T00:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MjYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MzM5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476543392", "bodyText": "just to clarify, you're going to start asserting the error code and message once you regenerate with the swagger fix?", "author": "iscai-msft", "createdAt": "2020-08-25T15:35:13Z", "path": "sdk/textanalytics/azure-ai-textanalytics/src/test/java/com/azure/ai/textanalytics/TextAnalyticsAsyncClientTest.java", "diffHunk": "@@ -365,6 +384,22 @@ public void recognizeEntitiesForListWithOptions(HttpClient httpClient, TextAnaly\n                 .verifyComplete());\n     }\n \n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.ai.textanalytics.TestUtils#getTestParameters\")\n+    public void recognizeEntitiesBatchTooManyDocuments(HttpClient httpClient, TextAnalyticsServiceVersion serviceVersion) {\n+        client = getTextAnalyticsAsyncClient(httpClient, serviceVersion);\n+        tooManyDocumentsRunner(inputs ->\n+            StepVerifier.create(client.recognizeEntitiesBatch(inputs, null, null))\n+                .verifyErrorSatisfies(ex -> {\n+                    HttpResponseException httpResponseException = (HttpResponseException) ex;\n+                    assertEquals(400, httpResponseException.getResponse().getStatusCode());\n+                    TextAnalyticsError textAnalyticsError = (TextAnalyticsError) httpResponseException.getValue();\n+                    // TODO: TextAnalyticsError has null values for all properties,", "originalCommit": "64bb30b01cef0c1cd394a06fd0d6a96334998a81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkxNTIzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14324#discussion_r476915234", "bodyText": "I will only assert the error code.\nJohan's comments in Cognitive Scrum chat:\n\"\"Note: we should not (in the general case) be asserting on error messages. I would not consider localizing error messages to be a breaking change, for example...\"\" and \"Yes. I assume that we don't have client library dependencies on the message itself (it's been done in the past, and it has not ended well)\"", "author": "mssfang", "createdAt": "2020-08-26T00:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MzM5Mg=="}], "type": "inlineReview"}, {"oid": "fdf025b8492cd6c0a08fdd366d32bb7fe684d06b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fdf025b8492cd6c0a08fdd366d32bb7fe684d06b", "message": "remove detect language and add tests to TestBase class", "committedDate": "2020-08-26T00:53:50Z", "type": "commit"}]}