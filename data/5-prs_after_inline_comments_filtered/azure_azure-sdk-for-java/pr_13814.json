{"pr_number": 13814, "pr_title": "added more logs to GlobalEndpointManager and ClientRetryPolicy", "pr_createdAt": "2020-08-05T20:09:40Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13814", "timeline": [{"oid": "e404c042f4e45713f22a2a1ed9afbe96ebfafcc3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e404c042f4e45713f22a2a1ed9afbe96ebfafcc3", "message": "added more logs", "committedDate": "2020-08-05T20:06:36Z", "type": "commit"}, {"oid": "54cf0fcc7f5a6e2dee806b7c0bc4fa0cc3dfeee3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/54cf0fcc7f5a6e2dee806b7c0bc4fa0cc3dfeee3", "message": "added log message", "committedDate": "2020-08-05T20:14:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MDE5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465980194", "bodyText": "If you send another iteration, can we please use variable itself in logger for canUseMultipleWriteLocations , instead of true and false", "author": "simplynaveen20", "createdAt": "2020-08-05T20:19:52Z", "path": "sdk/cosmos/microsoft-azure-cosmos/src/main/java/com/azure/data/cosmos/internal/ClientRetryPolicy.java", "diffHunk": "@@ -127,17 +128,22 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n                 if (this.sessionTokenRetryCount > endpoints.size()) {\n                     // When use multiple write locations is true and the request has been tried\n                     // on all locations, then don't retry the request\n+\n+                    logger.warn(\"SessionNotAvailable: canUseMultipleWriteLocations = true, sessionTokenRetryCount = {}, retried all locations. retry exhausted!\", sessionTokenRetryCount);\n                     return ShouldRetryResult.noRetry();\n                 } else {\n+                    logger.info(\"SessionNotAvailable: canUseMultipleWriteLocations = true, sessionTokenRetryCount = {}, going to retry on next location\", sessionTokenRetryCount);\n                     this.retryContext = new RetryContext(this.sessionTokenRetryCount - 1, this.sessionTokenRetryCount > 1);\n                     return ShouldRetryResult.retryAfter(Duration.ZERO);\n                 }\n             } else {\n                 if (this.sessionTokenRetryCount > 1) {\n                     // When cannot use multiple write locations, then don't retry the request if\n                     // we have already tried this request on the write location\n+                    logger.warn(\"SessionNotAvailable: canUseMultipleWriteLocations = false, sessionTokenRetryCount = {}, no more retries\", sessionTokenRetryCount);", "originalCommit": "54cf0fcc7f5a6e2dee806b7c0bc4fa0cc3dfeee3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NTE5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465985194", "bodyText": "what's the advantage? in the if branch the value is deterministic", "author": "moderakh", "createdAt": "2020-08-05T20:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NTcxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465985718", "bodyText": "Good point @simplynaveen20", "author": "kushagraThapar", "createdAt": "2020-08-05T20:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4OTU4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465989583", "bodyText": "intellj gives a recommendation in general to use\nif (flag) {\n  func(true)\n}\ninstead of\nif (flag) {\n  func(flag)\n}\nthat's why I am not using a variable here.", "author": "moderakh", "createdAt": "2020-08-05T20:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MDE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NTU3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465985579", "bodyText": "Since these are specifically for Walmart, why not use DEBUG and not warn, since warning logs will be difficult to diagnose, as they are a lot.", "author": "kushagraThapar", "createdAt": "2020-08-05T20:30:12Z", "path": "sdk/cosmos/microsoft-azure-cosmos/src/main/java/com/azure/data/cosmos/internal/ClientRetryPolicy.java", "diffHunk": "@@ -116,8 +117,8 @@ public ClientRetryPolicy(GlobalEndpointManager globalEndpointManager,\n \n     private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n         this.sessionTokenRetryCount++;\n-\n         if (!this.enableEndpointDiscovery) {\n+            logger.warn(\"SessionNotAvailable: no retry due to enableEndpointDiscovery=false\");", "originalCommit": "54cf0fcc7f5a6e2dee806b7c0bc4fa0cc3dfeee3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NjkzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465986935", "bodyText": "DEBUG is not feasible.", "author": "moderakh", "createdAt": "2020-08-05T20:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NTU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NTY0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465985642", "bodyText": "Same here.", "author": "kushagraThapar", "createdAt": "2020-08-05T20:30:18Z", "path": "sdk/cosmos/microsoft-azure-cosmos/src/main/java/com/azure/data/cosmos/internal/ClientRetryPolicy.java", "diffHunk": "@@ -127,17 +128,22 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n                 if (this.sessionTokenRetryCount > endpoints.size()) {\n                     // When use multiple write locations is true and the request has been tried\n                     // on all locations, then don't retry the request\n+\n+                    logger.warn(\"SessionNotAvailable: canUseMultipleWriteLocations = true, sessionTokenRetryCount = {}, retried all locations. retry exhausted!\", sessionTokenRetryCount);", "originalCommit": "54cf0fcc7f5a6e2dee806b7c0bc4fa0cc3dfeee3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NzA2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465987069", "bodyText": "DEBUG is not feasible.", "author": "moderakh", "createdAt": "2020-08-05T20:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NTY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NTg0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13814#discussion_r465985844", "bodyText": "Same here - let's use the variable", "author": "kushagraThapar", "createdAt": "2020-08-05T20:30:41Z", "path": "sdk/cosmos/microsoft-azure-cosmos/src/main/java/com/azure/data/cosmos/internal/ClientRetryPolicy.java", "diffHunk": "@@ -127,17 +128,22 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n                 if (this.sessionTokenRetryCount > endpoints.size()) {\n                     // When use multiple write locations is true and the request has been tried\n                     // on all locations, then don't retry the request\n+\n+                    logger.warn(\"SessionNotAvailable: canUseMultipleWriteLocations = true, sessionTokenRetryCount = {}, retried all locations. retry exhausted!\", sessionTokenRetryCount);\n                     return ShouldRetryResult.noRetry();\n                 } else {\n+                    logger.info(\"SessionNotAvailable: canUseMultipleWriteLocations = true, sessionTokenRetryCount = {}, going to retry on next location\", sessionTokenRetryCount);\n                     this.retryContext = new RetryContext(this.sessionTokenRetryCount - 1, this.sessionTokenRetryCount > 1);\n                     return ShouldRetryResult.retryAfter(Duration.ZERO);\n                 }\n             } else {\n                 if (this.sessionTokenRetryCount > 1) {\n                     // When cannot use multiple write locations, then don't retry the request if\n                     // we have already tried this request on the write location\n+                    logger.warn(\"SessionNotAvailable: canUseMultipleWriteLocations = false, sessionTokenRetryCount = {}, no more retries\", sessionTokenRetryCount);\n                     return ShouldRetryResult.noRetry();\n                 } else {\n+                    logger.info(\"SessionNotAvailable: canUseMultipleWriteLocations = false, sessionTokenRetryCount = {}, going to retry\", sessionTokenRetryCount);", "originalCommit": "54cf0fcc7f5a6e2dee806b7c0bc4fa0cc3dfeee3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "97d041df487e27ca7d2723157672de3652adcb7c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/97d041df487e27ca7d2723157672de3652adcb7c", "message": "fixed test", "committedDate": "2020-08-05T22:21:10Z", "type": "commit"}, {"oid": "aefd7cadca03ce08184746bc37928b2846f50928", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aefd7cadca03ce08184746bc37928b2846f50928", "message": "Fixed one more test case with indexing policy", "committedDate": "2020-08-06T05:17:25Z", "type": "commit"}, {"oid": "7821603d66324832f19b31b6610220e6e136059e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7821603d66324832f19b31b6610220e6e136059e", "message": "Missed the assertion in the test", "committedDate": "2020-08-06T16:50:31Z", "type": "commit"}, {"oid": "c5a974732abdc442c7803a873228dfe88f229b87", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5a974732abdc442c7803a873228dfe88f229b87", "message": "fixed test lazy indexing", "committedDate": "2020-08-06T18:01:10Z", "type": "commit"}]}