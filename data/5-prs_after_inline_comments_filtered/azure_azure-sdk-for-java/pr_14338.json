{"pr_number": 14338, "pr_title": "Added Nested partition key support feature", "pr_createdAt": "2020-08-21T08:46:11Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14338", "timeline": [{"oid": "0b17a98af674685113297120fddf75981db2c828", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0b17a98af674685113297120fddf75981db2c828", "message": "Added Nested partition key support feature", "committedDate": "2020-08-21T08:44:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg3NjE1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r474876156", "bodyText": "you don't need to pass the content to the request, delete doesn't expect a body. you should pass null here as content.", "author": "moderakh", "createdAt": "2020-08-21T19:06:43Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java", "diffHunk": "@@ -1437,15 +1444,33 @@ void captureSessionToken(RxDocumentServiceRequest request, RxDocumentServiceResp\n             logger.debug(\"Deleting a Document. documentLink: [{}]\", documentLink);\n             String path = Utils.joinPath(documentLink, null);\n             Map<String, String> requestHeaders = this.getRequestHeaders(options, ResourceType.Document, OperationType.Delete);\n-            RxDocumentServiceRequest request = RxDocumentServiceRequest.create(OperationType.Delete,\n-                ResourceType.Document, path, requestHeaders, options);\n+            RxDocumentServiceRequest request;\n+            ByteBuffer content = null;\n+            if (document != null) {\n+                Instant serializationStartTimeUTC = Instant.now();\n+                content = serializeJsonToByteBuffer(document);\n+                Instant serializationEndTime = Instant.now();\n+                SerializationDiagnosticsContext.SerializationDiagnostics serializationDiagnostics = new SerializationDiagnosticsContext.SerializationDiagnostics(\n+                    serializationStartTimeUTC,\n+                    serializationEndTime,\n+                    SerializationDiagnosticsContext.SerializationType.ITEM_SERIALIZATION);\n+                request = RxDocumentServiceRequest.create(OperationType.Delete,\n+                    ResourceType.Document, path, requestHeaders, options, content);", "originalCommit": "0b17a98af674685113297120fddf75981db2c828", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg3Nzg3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r474877876", "bodyText": "you don't need the content for the delete operation.", "author": "moderakh", "createdAt": "2020-08-21T19:10:32Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java", "diffHunk": "@@ -1437,15 +1444,33 @@ void captureSessionToken(RxDocumentServiceRequest request, RxDocumentServiceResp\n             logger.debug(\"Deleting a Document. documentLink: [{}]\", documentLink);\n             String path = Utils.joinPath(documentLink, null);\n             Map<String, String> requestHeaders = this.getRequestHeaders(options, ResourceType.Document, OperationType.Delete);\n-            RxDocumentServiceRequest request = RxDocumentServiceRequest.create(OperationType.Delete,\n-                ResourceType.Document, path, requestHeaders, options);\n+            RxDocumentServiceRequest request;\n+            ByteBuffer content = null;\n+            if (document != null) {\n+                Instant serializationStartTimeUTC = Instant.now();\n+                content = serializeJsonToByteBuffer(document);", "originalCommit": "0b17a98af674685113297120fddf75981db2c828", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "51b38dfde9f6bce4b9630f96e4e5cdb3a57c3b59", "url": "https://github.com/Azure/azure-sdk-for-java/commit/51b38dfde9f6bce4b9630f96e4e5cdb3a57c3b59", "message": "Fixed double serialization issue, code review comments", "committedDate": "2020-08-21T21:02:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4MTI3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r474981270", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return new InternalObjectNode(((InternalObjectNode) cosmosItem).toJson());\n          \n          \n            \n                        return cosmosItem;\n          \n      \n    \n    \n  \n\non this if branch the item is InternalObjectNode you don't need to serialze and deserialize again.", "author": "moderakh", "createdAt": "2020-08-21T21:39:09Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/InternalObjectNode.java", "diffHunk": "@@ -64,6 +64,23 @@ public InternalObjectNode(ObjectNode propertyBag) {\n         super(propertyBag);\n     }\n \n+    /**\n+     * fromObjectToInternalObjectNode returns InternalObjectNode\n+     */\n+    public static InternalObjectNode fromObjectToInternalObjectNode(Object cosmosItem) {\n+        if (cosmosItem instanceof InternalObjectNode) {\n+            return new InternalObjectNode(((InternalObjectNode) cosmosItem).toJson());", "originalCommit": "51b38dfde9f6bce4b9630f96e4e5cdb3a57c3b59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4MzE4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r474983189", "bodyText": "Good catch, fixed.", "author": "kushagraThapar", "createdAt": "2020-08-21T21:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4MTI3MA=="}], "type": "inlineReview"}, {"oid": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/21ec1522411d738576324fb63fa6ebcb8c8438c6", "message": "Fixed code review comments", "committedDate": "2020-08-21T21:44:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM1MDYyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475350629", "bodyText": "Do we need validateItemResponse(properties, itemResponse); here?", "author": "chenrujun", "createdAt": "2020-08-24T05:28:38Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/CosmosItemTest.java", "diffHunk": "@@ -127,9 +127,19 @@ public void deleteItem() throws Exception {\n         assertThat(deleteResponse.getStatusCode()).isEqualTo(204);\n     }\n \n+    @Test(groups = { \"simple\" }, timeOut = TIMEOUT)\n+    public void deleteItemUsingEntity() throws Exception {\n+        InternalObjectNode properties = getDocumentDefinition(UUID.randomUUID().toString());\n+        CosmosItemResponse<InternalObjectNode> itemResponse = container.createItem(properties);", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEwOTE5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476109191", "bodyText": "We don't, as there is no item response here. We validate the delete tests using the status code of the returned response object.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:19:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM1MDYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM1NDM2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475354366", "bodyText": "can we use containerName instead of getContainerName(objectToSave.getClass())?", "author": "chenrujun", "createdAt": "2020-08-24T05:43:15Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/core/CosmosTemplate.java", "diffHunk": "@@ -151,11 +149,22 @@ public void setApplicationContext(ApplicationContext applicationContext) throws\n      * @return the inserted item\n      */\n     public <T> T insert(T objectToSave, PartitionKey partitionKey) {\n-        Assert.notNull(objectToSave, \"domainType should not be null\");\n-\n         return insert(getContainerName(objectToSave.getClass()), objectToSave, partitionKey);\n     }\n \n+    /**\n+     * Inserts item into the given container\n+     *\n+     * @param containerName must not be {@literal null}\n+     * @param objectToSave must not be {@literal null}\n+     * @param <T> type class of domain type\n+     * @return the inserted item\n+     */\n+    @Override\n+    public <T> T insert(String containerName, T objectToSave) {\n+        return insert(getContainerName(objectToSave.getClass()), objectToSave, null);", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEwOTU3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476109571", "bodyText": "Yes, we can, updated.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM1NDM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MDM0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475360344", "bodyText": "return Optional.ofNullable(domainType)\n                .map(d -> d.getAnnotation(Container.class))\n                .map(Container::partitionKeyPath)\n                .filter(s -> !s.isEmpty())\n                .orElse(null);", "author": "chenrujun", "createdAt": "2020-08-24T06:03:42Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/CosmosEntityInformation.java", "diffHunk": "@@ -291,15 +294,22 @@ private String getContainerName(Class<?> domainType) {\n \n         final Container annotation = domainType.getAnnotation(Container.class);\n \n-        if (annotation != null\n-                && annotation.containerName() != null\n-                && !annotation.containerName().isEmpty()) {\n+        if (annotation != null && !annotation.containerName().isEmpty()) {\n             customContainerName = resolveExpression(annotation.containerName());\n         }\n \n         return customContainerName;\n     }\n \n+    private String getPartitionKeyPathValue(Class<?> domainType) {\n+        final Container annotation = domainType.getAnnotation(Container.class);\n+\n+        if (annotation != null && !annotation.partitionKeyPath().isEmpty()) {\n+            return annotation.partitionKeyPath();\n+        }\n+        return null;", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExNzMzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476117331", "bodyText": "Stream logic will make the if condition look harder to read code.\nIn my opinion, we should keep it as it is. Thoughts ?", "author": "kushagraThapar", "createdAt": "2020-08-25T03:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MDM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI2MjA0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476262041", "bodyText": "OK", "author": "chenrujun", "createdAt": "2020-08-25T08:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MDM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MTQ0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475361449", "bodyText": "getPartitionKeyPathInDomainType will make it easier to understand.", "author": "chenrujun", "createdAt": "2020-08-24T06:07:10Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/CosmosEntityInformation.java", "diffHunk": "@@ -291,15 +294,22 @@ private String getContainerName(Class<?> domainType) {\n \n         final Container annotation = domainType.getAnnotation(Container.class);\n \n-        if (annotation != null\n-                && annotation.containerName() != null\n-                && !annotation.containerName().isEmpty()) {\n+        if (annotation != null && !annotation.containerName().isEmpty()) {\n             customContainerName = resolveExpression(annotation.containerName());\n         }\n \n         return customContainerName;\n     }\n \n+    private String getPartitionKeyPathValue(Class<?> domainType) {", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExMTIwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476111208", "bodyText": "Updated to a better name.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MTQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MTU3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475361574", "bodyText": "this.partitionKeyPathInDomainType = getPartitionKeyPathInDomainType(domainType);", "author": "chenrujun", "createdAt": "2020-08-24T06:07:39Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/CosmosEntityInformation.java", "diffHunk": "@@ -74,6 +75,8 @@ public CosmosEntityInformation(Class<T> domainType) {\n         this.autoGenerateId = isIdFieldAnnotatedWithGeneratedValue(this.id);\n \n         this.containerName = getContainerName(domainType);\n+        this.partitionKeyPath = getPartitionKeyPathValue(domainType);", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExMjEzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476112132", "bodyText": "Since the annotation is called as partitionKeyPath , that is the reason I created the field with the same name.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MTU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MTYyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475361626", "bodyText": "partitionKeyPathInDomainType", "author": "chenrujun", "createdAt": "2020-08-24T06:07:48Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/CosmosEntityInformation.java", "diffHunk": "@@ -53,6 +53,7 @@\n     private final Field partitionKeyField;\n     private final Field versionField;\n     private final String containerName;\n+    private final String partitionKeyPath;", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExNzUxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476117513", "bodyText": "Since the annotation is called as partitionKeyPath , that is the reason I created the field with the same name.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:31:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NTE2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475365165", "bodyText": "return \"/\" + Optional.of(partitionKeyField)\n                                 .map(f -> f.getAnnotation(PartitionKey.class))\n                                 .map(PartitionKey::value)\n                                 .filter(s -> !s.isEmpty())\n                                 .orElseGet(partitionKeyField::getName);", "author": "chenrujun", "createdAt": "2020-08-24T06:18:38Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/CosmosEntityInformation.java", "diffHunk": "@@ -195,16 +198,16 @@ public String getVersionFieldName() {\n     }\n \n     /**\n-     * Get the field name represented by the supplied partitionKeyField object\n+     * Get the computed partition key path for container\n      *\n-     * @return partition key field name\n+     * @return partition key path\n      */\n-    public String getPartitionKeyFieldName() {\n+    public String getPartitionKeyPath() {\n         if (partitionKeyField == null) {\n-            return null;\n+            return partitionKeyPath == null ? \"/null\" : partitionKeyPath;\n         } else {\n             final PartitionKey partitionKey = partitionKeyField.getAnnotation(PartitionKey.class);\n-            return partitionKey.value().equals(\"\") ? partitionKeyField.getName() : partitionKey.value();\n+            return partitionKey.value().equals(\"\") ? \"/\" + partitionKeyField.getName() : \"/\" + partitionKey.value();", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExODI2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476118268", "bodyText": "Same here, right now we have a very straightforward if condition, changing it to this complex stream logic doesn't make sense. We don't really need java Stream's map, filter and orElseGet logic here.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NTE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2Njk5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475366998", "bodyText": "return Optional.of(domainType)\n                       .map(d -> d.getAnnotation(Container.class))\n                       .map(Container::containerName)\n                       .filter(s -> !s.isEmpty())\n                       .map(ExpressionResolver::resolveExpression)\n                       .orElseGet(domainType::getSimpleName);", "author": "chenrujun", "createdAt": "2020-08-24T06:24:05Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/CosmosEntityInformation.java", "diffHunk": "@@ -291,15 +294,22 @@ private String getContainerName(Class<?> domainType) {\n \n         final Container annotation = domainType.getAnnotation(Container.class);\n \n-        if (annotation != null\n-                && annotation.containerName() != null\n-                && !annotation.containerName().isEmpty()) {\n+        if (annotation != null && !annotation.containerName().isEmpty()) {\n             customContainerName = resolveExpression(annotation.containerName());\n         }\n \n         return customContainerName;", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExODYzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476118630", "bodyText": "Same here as above, this is very straightforward if condition. Changing this to Stream will be complicating the code in my opinion.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2Njk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NzkwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475367908", "bodyText": "To keep same code style, please use information.getPartitionKeyPath() directly instead of define partitionKeyPath.", "author": "chenrujun", "createdAt": "2020-08-24T06:26:33Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/core/CosmosTemplate.java", "diffHunk": "@@ -441,9 +459,7 @@ public CosmosContainerProperties createContainerIfNotExists(CosmosEntityInformat\n                 CosmosUtils.fillAndProcessResponseDiagnostics(this.responseDiagnosticsProcessor,\n                     cosmosDatabaseResponse.getDiagnostics(), null);\n                 final CosmosContainerProperties cosmosContainerProperties =\n-                    new CosmosContainerProperties(\n-                        information.getContainerName(), \"/\"\n-                        + information.getPartitionKeyFieldName());\n+                    new CosmosContainerProperties(information.getContainerName(), partitionKeyPath);", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExMjU0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476112542", "bodyText": "Makes sense, updated.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NzkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2OTQ2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475369467", "bodyText": "To keep same code style, please use information.getPartitionKeyPath() directly instead of define partitionKeyPath.", "author": "chenrujun", "createdAt": "2020-08-24T06:30:56Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/core/ReactiveCosmosTemplate.java", "diffHunk": "@@ -145,9 +147,7 @@ public void setApplicationContext(@NonNull ApplicationContext applicationContext\n                 CosmosUtils.fillAndProcessResponseDiagnostics(this.responseDiagnosticsProcessor,\n                     cosmosDatabaseResponse.getDiagnostics(), null);\n                 final CosmosContainerProperties cosmosContainerProperties =\n-                    new CosmosContainerProperties(\n-                        information.getContainerName(),\n-                        \"/\" + information.getPartitionKeyFieldName());\n+                    new CosmosContainerProperties(information.getContainerName(), partitionKeyPath);", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExMjk1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476112952", "bodyText": "Makes sense, updated.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2OTQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4NjE4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475386181", "bodyText": "Can we update logic in CosmosAsyncContainer#createItem\nfrom\n    public <T> Mono<CosmosItemResponse<T>> createItem(\n        T item,\n        PartitionKey partitionKey,\n        CosmosItemRequestOptions options) {\n        if (options == null) {\n            options = new CosmosItemRequestOptions();\n        }\n        ModelBridgeInternal.setPartitionKey(options, partitionKey);\n        return createItem(item, options);\n    }\n\nto\n    public <T> Mono<CosmosItemResponse<T>> createItem(\n        T item,\n        PartitionKey partitionKey,\n        CosmosItemRequestOptions options) {\n        if (options == null) {\n            options = new CosmosItemRequestOptions();\n        }\n        if (partitionKey != null) {\n            ModelBridgeInternal.setPartitionKey(options, partitionKey);\n        }\n        return createItem(item, options);\n    }\n\nSo we can delete  if (partitionKey == null) here.", "author": "chenrujun", "createdAt": "2020-08-24T07:12:46Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/core/ReactiveCosmosTemplate.java", "diffHunk": "@@ -370,21 +351,37 @@ public void setApplicationContext(@NonNull ApplicationContext applicationContext\n         generateIdIfNullAndAutoGenerationEnabled(objectToSave, domainType);\n         final JsonNode originalItem = prepareToPersistAndConvertToItemProperties(objectToSave);\n         final CosmosItemRequestOptions options = new CosmosItemRequestOptions();\n+        CosmosAsyncContainer cosmosAsyncContainer = cosmosAsyncClient.getDatabase(this.databaseName)\n+                                                                     .getContainer(containerName);\n+        Mono<CosmosItemResponse<JsonNode>> item;\n         if (partitionKey == null) {\n-            partitionKey = PartitionKey.NONE;\n+            //  if the partition key is null, SDK will get the partitionKey from the object\n+            item = cosmosAsyncContainer.createItem(originalItem, options);\n+        } else {\n+            item = cosmosAsyncContainer.createItem(originalItem, partitionKey, options);", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExNTQ5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476115493", "bodyText": "It doesn't matter, as if the partitionKey is null, SDK will compute it based on the logic mentioned below.\nI have kept the scope of this PR to touch minimal code in the Cosmos Java SDK layer.", "author": "kushagraThapar", "createdAt": "2020-08-25T03:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4NjE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI2OTcxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476269715", "bodyText": "Then can we update code from\nif (partitionKey == null) {\n    //  if the partition key is null, SDK will get the partitionKey from the object\n    item = cosmosAsyncContainer.createItem(originalItem, options);\n} else {\n    item = cosmosAsyncContainer.createItem(originalItem, partitionKey, options);\n}\n\nto\n // it's OK if partitionKey is null\nitem = cosmosAsyncContainer.createItem(originalItem, partitionKey, options);", "author": "chenrujun", "createdAt": "2020-08-25T08:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4NjE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU5NjU4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476596583", "bodyText": "Yes, good suggestion @chenrujun  - I have updated the code.", "author": "kushagraThapar", "createdAt": "2020-08-25T16:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4NjE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM5MDM0MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r475390340", "bodyText": "Where is the code about SDK will get the partitionKey from the object ?", "author": "chenrujun", "createdAt": "2020-08-24T07:21:29Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/core/ReactiveCosmosTemplate.java", "diffHunk": "@@ -370,21 +351,37 @@ public void setApplicationContext(@NonNull ApplicationContext applicationContext\n         generateIdIfNullAndAutoGenerationEnabled(objectToSave, domainType);\n         final JsonNode originalItem = prepareToPersistAndConvertToItemProperties(objectToSave);\n         final CosmosItemRequestOptions options = new CosmosItemRequestOptions();\n+        CosmosAsyncContainer cosmosAsyncContainer = cosmosAsyncClient.getDatabase(this.databaseName)\n+                                                                     .getContainer(containerName);\n+        Mono<CosmosItemResponse<JsonNode>> item;\n         if (partitionKey == null) {\n-            partitionKey = PartitionKey.NONE;\n+            //  if the partition key is null, SDK will get the partitionKey from the object", "originalCommit": "21ec1522411d738576324fb63fa6ebcb8c8438c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExNDQyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14338#discussion_r476114424", "bodyText": "Here is the logic : https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java#L1031", "author": "kushagraThapar", "createdAt": "2020-08-25T03:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM5MDM0MA=="}], "type": "inlineReview"}, {"oid": "da793304c78a6b166d24ba82920771cc8cdb9b0e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/da793304c78a6b166d24ba82920771cc8cdb9b0e", "message": "Code review comments", "committedDate": "2020-08-25T03:35:07Z", "type": "commit"}, {"oid": "85535f151baa5dc50bdfdf2dab75b46ea4e83a6c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/85535f151baa5dc50bdfdf2dab75b46ea4e83a6c", "message": "Code review comments", "committedDate": "2020-08-25T16:55:01Z", "type": "commit"}, {"oid": "23810cc6043248a32718acfe9fda732c56155dfb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/23810cc6043248a32718acfe9fda732c56155dfb", "message": "Removed unused imports", "committedDate": "2020-08-25T21:31:04Z", "type": "commit"}, {"oid": "ea3ba8eadc2e4d69f9bcb09ac6530c0caa119a4c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ea3ba8eadc2e4d69f9bcb09ac6530c0caa119a4c", "message": "Merge branch 'master' into nested_partition_key_feature", "committedDate": "2020-08-26T04:38:15Z", "type": "commit"}, {"oid": "a741e07299bbb2cc469d77c58d641dc3fb68dbdd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a741e07299bbb2cc469d77c58d641dc3fb68dbdd", "message": "Fixed query metrics test", "committedDate": "2020-08-26T05:18:42Z", "type": "commit"}]}