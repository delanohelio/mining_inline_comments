{"pr_number": 16524, "pr_title": "[Service Bus] Prepare tracing methods for message processor and scheduleMessage", "pr_createdAt": "2020-10-19T18:19:42Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16524", "timeline": [{"oid": "0ce8d23a79a855553c79b88ed5ff20d0a9ebbf1a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0ce8d23a79a855553c79b88ed5ff20d0a9ebbf1a", "message": "Remove usage of environment variable AZURE_SERVICE_BUS_CONNECTION_STRING", "committedDate": "2020-10-14T22:30:42Z", "type": "commit"}, {"oid": "e2077f63f2b23aecedd31fbc2137721bab7549e6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e2077f63f2b23aecedd31fbc2137721bab7549e6", "message": "Prepare tracing for MessageProcessor, schedule and other APIs", "committedDate": "2020-10-19T17:12:28Z", "type": "commit"}, {"oid": "cc988128405870a301960f02d2ee3d5aee11e7c1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cc988128405870a301960f02d2ee3d5aee11e7c1", "message": "Revert \"Remove usage of environment variable AZURE_SERVICE_BUS_CONNECTION_STRING\"\n\nThis reverts commit 0ce8d23a", "committedDate": "2020-10-19T17:28:53Z", "type": "commit"}, {"oid": "4db48fe4e05e102832fb6a7bb7d846ac1ad48c92", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4db48fe4e05e102832fb6a7bb7d846ac1ad48c92", "message": "Merge branch 'master' into sb_tracing", "committedDate": "2020-10-19T17:32:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTIzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r509815230", "bodyText": "Should this also include the queue name, topic name etc?", "author": "srnagar", "createdAt": "2020-10-22T00:46:14Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -253,4 +275,75 @@ private static TransactionalState getTransactionState(ByteBuffer transactionId,\n         transactionalState.setOutcome(outcome);\n         return transactionalState;\n     }\n+\n+    public static ServiceBusMessage traceMessageSpan(ServiceBusMessage serviceBusMessage,\n+        Context messageContext, String hostname, String entityPath, TracerProvider tracerProvider) {\n+        Optional<Object> eventContextData = messageContext.getData(SPAN_CONTEXT_KEY);\n+        if (eventContextData.isPresent()) {\n+            // if message has context (in case of retries), don't start a message span or add a new context\n+            return serviceBusMessage;\n+        } else {\n+            // Starting the span makes the sampling decision (nothing is logged at this time)\n+            Context newMessageContext = messageContext\n+                .addData(AZ_TRACING_NAMESPACE_KEY, AZ_TRACING_NAMESPACE_VALUE)\n+                .addData(ENTITY_PATH_KEY, entityPath)\n+                .addData(HOST_NAME_KEY, hostname);", "originalCommit": "4db48fe4e05e102832fb6a7bb7d846ac1ad48c92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5NTE4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513095185", "bodyText": "So EntityPath can be either queue or topic.", "author": "YijunXieMS", "createdAt": "2020-10-27T23:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTIzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTc2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r509815760", "bodyText": "Where is this method called from?", "author": "srnagar", "createdAt": "2020-10-22T00:48:16Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -253,4 +275,75 @@ private static TransactionalState getTransactionState(ByteBuffer transactionId,\n         transactionalState.setOutcome(outcome);\n         return transactionalState;\n     }\n+\n+    public static ServiceBusMessage traceMessageSpan(ServiceBusMessage serviceBusMessage,\n+        Context messageContext, String hostname, String entityPath, TracerProvider tracerProvider) {\n+        Optional<Object> eventContextData = messageContext.getData(SPAN_CONTEXT_KEY);\n+        if (eventContextData.isPresent()) {\n+            // if message has context (in case of retries), don't start a message span or add a new context\n+            return serviceBusMessage;\n+        } else {\n+            // Starting the span makes the sampling decision (nothing is logged at this time)\n+            Context newMessageContext = messageContext\n+                .addData(AZ_TRACING_NAMESPACE_KEY, AZ_TRACING_NAMESPACE_VALUE)\n+                .addData(ENTITY_PATH_KEY, entityPath)\n+                .addData(HOST_NAME_KEY, hostname);\n+            Context eventSpanContext = tracerProvider.startSpan(AZ_TRACING_SERVICE_NAME, newMessageContext,\n+                ProcessKind.MESSAGE);\n+            Optional<Object> eventDiagnosticIdOptional = eventSpanContext.getData(DIAGNOSTIC_ID_KEY);\n+            if (eventDiagnosticIdOptional.isPresent()) {\n+                serviceBusMessage.getApplicationProperties().put(DIAGNOSTIC_ID_KEY, eventDiagnosticIdOptional.get()\n+                    .toString());\n+                tracerProvider.endSpan(eventSpanContext, Signal.complete());\n+                serviceBusMessage.addContext(SPAN_CONTEXT_KEY, eventSpanContext);\n+            }\n+        }\n+        return serviceBusMessage;\n+    }\n+\n+    /*\n+     * Starts a new process tracing span and attaches the returned context to the EventData object for users.\n+     */\n+    public static Context startProcessTracingSpan(ServiceBusReceivedMessage receivedMessage,", "originalCommit": "4db48fe4e05e102832fb6a7bb7d846ac1ad48c92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5NTM1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513095357", "bodyText": "This is prepared for message processor.", "author": "YijunXieMS", "createdAt": "2020-10-27T23:40:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTgwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r509815807", "bodyText": "Same here. Where is this method called from? I guess this was added for the processor only but I think the async receiver should use them since the message processor is just a wrapper around the async receiver's receive method.", "author": "srnagar", "createdAt": "2020-10-22T00:48:25Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -253,4 +275,75 @@ private static TransactionalState getTransactionState(ByteBuffer transactionId,\n         transactionalState.setOutcome(outcome);\n         return transactionalState;\n     }\n+\n+    public static ServiceBusMessage traceMessageSpan(ServiceBusMessage serviceBusMessage,\n+        Context messageContext, String hostname, String entityPath, TracerProvider tracerProvider) {\n+        Optional<Object> eventContextData = messageContext.getData(SPAN_CONTEXT_KEY);\n+        if (eventContextData.isPresent()) {\n+            // if message has context (in case of retries), don't start a message span or add a new context\n+            return serviceBusMessage;\n+        } else {\n+            // Starting the span makes the sampling decision (nothing is logged at this time)\n+            Context newMessageContext = messageContext\n+                .addData(AZ_TRACING_NAMESPACE_KEY, AZ_TRACING_NAMESPACE_VALUE)\n+                .addData(ENTITY_PATH_KEY, entityPath)\n+                .addData(HOST_NAME_KEY, hostname);\n+            Context eventSpanContext = tracerProvider.startSpan(AZ_TRACING_SERVICE_NAME, newMessageContext,\n+                ProcessKind.MESSAGE);\n+            Optional<Object> eventDiagnosticIdOptional = eventSpanContext.getData(DIAGNOSTIC_ID_KEY);\n+            if (eventDiagnosticIdOptional.isPresent()) {\n+                serviceBusMessage.getApplicationProperties().put(DIAGNOSTIC_ID_KEY, eventDiagnosticIdOptional.get()\n+                    .toString());\n+                tracerProvider.endSpan(eventSpanContext, Signal.complete());\n+                serviceBusMessage.addContext(SPAN_CONTEXT_KEY, eventSpanContext);\n+            }\n+        }\n+        return serviceBusMessage;\n+    }\n+\n+    /*\n+     * Starts a new process tracing span and attaches the returned context to the EventData object for users.\n+     */\n+    public static Context startProcessTracingSpan(ServiceBusReceivedMessage receivedMessage,\n+        String hostname, String entityPath, TracerProvider tracerProvider, ProcessKind processKind) {\n+        Object diagnosticId = receivedMessage.getApplicationProperties().get(DIAGNOSTIC_ID_KEY);\n+        if (diagnosticId == null || !tracerProvider.isEnabled()) {\n+            return Context.NONE;\n+        }\n+\n+        Context spanContext = tracerProvider.extractContext(diagnosticId.toString(), Context.NONE)\n+            .addData(ENTITY_PATH_KEY, entityPath)\n+            .addData(HOST_NAME_KEY, hostname)\n+            .addData(AZ_TRACING_NAMESPACE_KEY, AZ_TRACING_NAMESPACE_VALUE);\n+        spanContext = receivedMessage.getEnqueuedTime() == null\n+            ? spanContext\n+            : spanContext.addData(MESSAGE_ENQUEUED_TIME, receivedMessage.getEnqueuedTime().toEpochSecond());\n+        return tracerProvider.startSpan(AZ_TRACING_SERVICE_NAME, spanContext, processKind);\n+    }\n+\n+    /*\n+     * Ends the process tracing span and the scope of that span.\n+     */\n+    public static void endProcessTracingSpan(Context processSpanContext, Signal<Void> signal,", "originalCommit": "4db48fe4e05e102832fb6a7bb7d846ac1ad48c92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4ODg4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r510688884", "bodyText": "We probably do same  what .Net have done for their processor.. If we just have to do tracing for each receive message, we can do in async receiver. But if there is addition tracing for processor, which .Net is doing, we should also do.\nFYI-> for receive and processor would both would be kind.Consumer ? @samvaity", "author": "hemanttanwar", "createdAt": "2020-10-23T07:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5NjM2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513096361", "bodyText": "Discussed with Srikanta. We only need to processor for GA and waiting for .Net to confirm with service team about tracing and then possibly add tracing to the receiver after GA. The minimum requirement is to have parity with EventHub, which has tracing for processor but not for consumer client.", "author": "YijunXieMS", "createdAt": "2020-10-27T23:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMjAwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513102008", "bodyText": "@hemanttanwar Following what we have for eventhubs, processor spans should be consumer spans.", "author": "samvaity", "createdAt": "2020-10-28T00:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNjczMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r509816730", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Starts a new process tracing span and attaches the returned context to the EventData object for users.\n          \n          \n            \n                 * Starts a new process tracing span and attaches the returned context to the ServiceBusReceivedMessage object for users.", "author": "srnagar", "createdAt": "2020-10-22T00:51:31Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -253,4 +275,75 @@ private static TransactionalState getTransactionState(ByteBuffer transactionId,\n         transactionalState.setOutcome(outcome);\n         return transactionalState;\n     }\n+\n+    public static ServiceBusMessage traceMessageSpan(ServiceBusMessage serviceBusMessage,\n+        Context messageContext, String hostname, String entityPath, TracerProvider tracerProvider) {\n+        Optional<Object> eventContextData = messageContext.getData(SPAN_CONTEXT_KEY);\n+        if (eventContextData.isPresent()) {\n+            // if message has context (in case of retries), don't start a message span or add a new context\n+            return serviceBusMessage;\n+        } else {\n+            // Starting the span makes the sampling decision (nothing is logged at this time)\n+            Context newMessageContext = messageContext\n+                .addData(AZ_TRACING_NAMESPACE_KEY, AZ_TRACING_NAMESPACE_VALUE)\n+                .addData(ENTITY_PATH_KEY, entityPath)\n+                .addData(HOST_NAME_KEY, hostname);\n+            Context eventSpanContext = tracerProvider.startSpan(AZ_TRACING_SERVICE_NAME, newMessageContext,\n+                ProcessKind.MESSAGE);\n+            Optional<Object> eventDiagnosticIdOptional = eventSpanContext.getData(DIAGNOSTIC_ID_KEY);\n+            if (eventDiagnosticIdOptional.isPresent()) {\n+                serviceBusMessage.getApplicationProperties().put(DIAGNOSTIC_ID_KEY, eventDiagnosticIdOptional.get()\n+                    .toString());\n+                tracerProvider.endSpan(eventSpanContext, Signal.complete());\n+                serviceBusMessage.addContext(SPAN_CONTEXT_KEY, eventSpanContext);\n+            }\n+        }\n+        return serviceBusMessage;\n+    }\n+\n+    /*\n+     * Starts a new process tracing span and attaches the returned context to the EventData object for users.", "originalCommit": "4db48fe4e05e102832fb6a7bb7d846ac1ad48c92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4NDQ1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r510684458", "bodyText": "How does Kind fits into this ?, should that be passed here ?\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/core/azure-core/src/main/java/com/azure/core/util/tracing/ProcessKind.java\n@samvaity    Can you look into this PR ?", "author": "hemanttanwar", "createdAt": "2020-10-23T07:21:33Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -253,4 +275,75 @@ private static TransactionalState getTransactionState(ByteBuffer transactionId,\n         transactionalState.setOutcome(outcome);\n         return transactionalState;\n     }\n+\n+    public static ServiceBusMessage traceMessageSpan(ServiceBusMessage serviceBusMessage,\n+        Context messageContext, String hostname, String entityPath, TracerProvider tracerProvider) {", "originalCommit": "4db48fe4e05e102832fb6a7bb7d846ac1ad48c92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5NzI4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513097282", "bodyText": "ProcessKind.MESSAGE should be used to create a message. Just like in EventHubs. \n  \n    \n      azure-sdk-for-java/sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventDataBatch.java\n    \n    \n         Line 158\n      in\n      914ab8b\n    \n    \n    \n    \n\n        \n          \n           Context eventSpanContext = tracerProvider.startSpan(AZ_TRACING_SERVICE_NAME, eventContext,", "author": "YijunXieMS", "createdAt": "2020-10-27T23:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4NDQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5ODE0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513098142", "bodyText": "The ProcessKind helps the tracer apply specific attributes on the span. For example, in the case of MESSAGE, the tracer will attribute the spanType=Producer, here", "author": "samvaity", "createdAt": "2020-10-27T23:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4NDQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5OTYxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513099619", "bodyText": "@samvaity is this javadoc misleading? It looks like MESSAGE is used for receiving.\n    /**\n     * Amqp message process call to receive data.\n     */\n    MESSAGE,", "author": "YijunXieMS", "createdAt": "2020-10-27T23:54:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4NDQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMTYyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513101626", "bodyText": "Yeah, I think we initially had this as RECEIVE and later updated to MESSAGE so the left over javadoc. But yes it should be updated to suit process kind \"message\". AMQP process kind for message spans.", "author": "samvaity", "createdAt": "2020-10-28T00:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4NDQ1OA=="}], "type": "inlineReview"}, {"oid": "ab3908c55535858faa12348778637f9998c5ef4d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ab3908c55535858faa12348778637f9998c5ef4d", "message": "Update sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java\n\nCo-authored-by: Srikanta <51379715+srnagar@users.noreply.github.com>", "committedDate": "2020-10-27T23:43:58Z", "type": "commit"}, {"oid": "ea7cecf2ecc383fd57a8a0c1df2b1d98630e6f69", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ea7cecf2ecc383fd57a8a0c1df2b1d98630e6f69", "message": "Fix checkstyle format error", "committedDate": "2020-10-27T23:56:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMDI3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513100271", "bodyText": "Need to add javadoc for this.", "author": "samvaity", "createdAt": "2020-10-27T23:56:31Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -253,4 +275,75 @@ private static TransactionalState getTransactionState(ByteBuffer transactionId,\n         transactionalState.setOutcome(outcome);\n         return transactionalState;\n     }\n+\n+    public static ServiceBusMessage traceMessageSpan(ServiceBusMessage serviceBusMessage,", "originalCommit": "ab3908c55535858faa12348778637f9998c5ef4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgxNTc5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16524#discussion_r513815796", "bodyText": "Added a simple description.", "author": "YijunXieMS", "createdAt": "2020-10-28T23:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMDI3MQ=="}], "type": "inlineReview"}, {"oid": "da71bea3492a883861a16f80170fcda61b5c460a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/da71bea3492a883861a16f80170fcda61b5c460a", "message": "Add javadoc for traceMessageSpan", "committedDate": "2020-10-28T01:49:20Z", "type": "commit"}]}