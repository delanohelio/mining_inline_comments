{"pr_number": 7837, "pr_title": "Ensure BufferedResponse type is not caching un-released buffer", "pr_createdAt": "2020-01-29T23:44:37Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/7837", "timeline": [{"oid": "05e4aa38f57f80abe0fd3c5b58a9940f46d7aba5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/05e4aa38f57f80abe0fd3c5b58a9940f46d7aba5", "message": "Making BufferedResponse to do deep caching (it was doing shallow caching)", "committedDate": "2020-01-29T17:57:42Z", "type": "commit"}, {"oid": "966d908aa203da5b2757507e592a36ba4c598f24", "url": "https://github.com/Azure/azure-sdk-for-java/commit/966d908aa203da5b2757507e592a36ba4c598f24", "message": "Make BufferedResponse really buffer and updating decoder to not to use BufferedResponse", "committedDate": "2020-01-29T23:43:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwMTUzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7837#discussion_r373201537", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .map(bytes -> ByteBuffer.wrap(bytes))\n          \n          \n            \n                        .map(ByteBuffer::wrap)", "author": "JonathanGiles", "createdAt": "2020-01-30T21:25:14Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/implementation/http/BufferedHttpResponse.java", "diffHunk": "@@ -28,7 +28,10 @@\n     public BufferedHttpResponse(HttpResponse innerHttpResponse) {\n         super(innerHttpResponse.getRequest());\n         this.innerHttpResponse = innerHttpResponse;\n-        this.cachedBody = innerHttpResponse.getBody().cache();\n+        this.cachedBody = FluxUtil.collectBytesInByteBufferStream(innerHttpResponse.getBody())\n+            .map(bytes -> ByteBuffer.wrap(bytes))", "originalCommit": "966d908aa203da5b2757507e592a36ba4c598f24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwMjEzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7837#discussion_r373202133", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return cachedBody.next().map(byteBuffer -> byteBuffer.array());\n          \n          \n            \n                    return cachedBody.next().map(ByteBuffer::array);", "author": "JonathanGiles", "createdAt": "2020-01-30T21:26:33Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/implementation/http/BufferedHttpResponse.java", "diffHunk": "@@ -53,7 +56,7 @@ public HttpHeaders getHeaders() {\n \n     @Override\n     public Mono<byte[]> getBodyAsByteArray() {\n-        return FluxUtil.collectBytesInByteBufferStream(cachedBody.map(ByteBuffer::duplicate));\n+        return cachedBody.next().map(byteBuffer -> byteBuffer.array());", "originalCommit": "966d908aa203da5b2757507e592a36ba4c598f24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8f1fdc736e671d99510441558bdd21a1cf84c8de", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8f1fdc736e671d99510441558bdd21a1cf84c8de", "message": "Update sdk/core/azure-core/src/main/java/com/azure/core/implementation/http/BufferedHttpResponse.java\n\nCo-Authored-By: Jonathan Giles <jonathan@jonathangiles.net>", "committedDate": "2020-01-30T22:31:08Z", "type": "commit"}, {"oid": "cb1fcf6b337db406edd5232ebe50d963a1cad2a9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cb1fcf6b337db406edd5232ebe50d963a1cad2a9", "message": "Update sdk/core/azure-core/src/main/java/com/azure/core/implementation/http/BufferedHttpResponse.java\n\nCo-Authored-By: Jonathan Giles <jonathan@jonathangiles.net>", "committedDate": "2020-01-30T22:31:19Z", "type": "commit"}]}