{"pr_number": 13251, "pr_title": "Single result queries", "pr_createdAt": "2020-07-16T19:21:06Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13251", "timeline": [{"oid": "0e69b125a01cf2efe476cc925e2015ca6ba04923", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0e69b125a01cf2efe476cc925e2015ca6ba04923", "message": "fix test order issue where other contact test removes container", "committedDate": "2020-07-16T19:25:24Z", "type": "forcePushed"}, {"oid": "67becaaa96b1a7820bb17c7b18441265aa55fd7f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/67becaaa96b1a7820bb17c7b18441265aa55fd7f", "message": "add support for single result queries. Works for both normal and reactive repositories.", "committedDate": "2020-07-17T16:16:15Z", "type": "commit"}, {"oid": "14e8e7a052ba8942586c21a1d0b5bc43553a3b0f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/14e8e7a052ba8942586c21a1d0b5bc43553a3b0f", "message": "fix test order issue where other contact test removes container", "committedDate": "2020-07-17T16:16:15Z", "type": "commit"}, {"oid": "14e8e7a052ba8942586c21a1d0b5bc43553a3b0f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/14e8e7a052ba8942586c21a1d0b5bc43553a3b0f", "message": "fix test order issue where other contact test removes container", "committedDate": "2020-07-17T16:16:15Z", "type": "forcePushed"}, {"oid": "bcca5455416a38563e2909b669c6332b1e81c71e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bcca5455416a38563e2909b669c6332b1e81c71e", "message": "fix references to renamed classes. Fix checkstyle issues", "committedDate": "2020-07-17T18:04:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMTc0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13251#discussion_r456601748", "bodyText": "why do we need this buffer(2) ?", "author": "kushagraThapar", "createdAt": "2020-07-17T18:18:01Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/query/ReactiveCosmosQueryExecution.java", "diffHunk": "@@ -54,6 +56,34 @@ public Object execute(DocumentQuery query, Class<?> type, String container) {\n         }\n     }\n \n+    /**\n+     * Find operation implementation to execute a find query for a single item\n+     */\n+    final class SingleEntityExecution implements ReactiveCosmosQueryExecution {\n+\n+        private final ReactiveCosmosOperations operations;\n+        private final ReturnedType returnedType;\n+\n+        public SingleEntityExecution(ReactiveCosmosOperations operations, ReturnedType returnedType) {\n+            this.operations = operations;\n+            this.returnedType = returnedType;\n+        }\n+\n+        @Override\n+        public Object execute(DocumentQuery query, Class<?> type, String container) {\n+            return operations.find(query, type, container)\n+                .buffer(2)", "originalCommit": "bcca5455416a38563e2909b669c6332b1e81c71e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMTAyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13251#discussion_r456611026", "bodyText": "We want to ensure only a single result is returned by the query. However, the results are returned as a stream. This allows us to check that the stream only contains a single item without retrieving all of the streams contents.", "author": "Blackbaud-EricSlater", "createdAt": "2020-07-17T18:37:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYyNDc4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13251#discussion_r456624788", "bodyText": "Sounds good!", "author": "kushagraThapar", "createdAt": "2020-07-17T19:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMTc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMjc5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13251#discussion_r456602794", "bodyText": "Shouldn't this also be findOneByName ?\nI am still unclear on what if there are multiple items by name ?", "author": "kushagraThapar", "createdAt": "2020-07-17T18:20:14Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/test/java/com/azure/spring/data/cosmos/repository/repository/ReactiveCourseRepository.java", "diffHunk": "@@ -34,4 +35,12 @@\n      * @return Course list\n      */\n     Flux<Course> findByNameOrDepartmentAllIgnoreCase(String name, String department);\n+\n+    /**\n+     * Find a single Course list by name\n+     * @param name name\n+     * @return Course list\n+     */\n+    Mono<Course> findByName(String name);", "originalCommit": "bcca5455416a38563e2909b669c6332b1e81c71e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwOTE2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13251#discussion_r456609163", "bodyText": "yea i will rename that for clarity. But i do want to point out that the determination of the execution path is based on the return type. We are not using the PartTree class to parse the method name to determine the users intent so it behaves the same regardless of whether the user specifies \"findOne\". The fact that the method is returning a Mono is what makes it expect one item.\nIn the event that there are multiple items returned, we will throw a CosmosAccessException with an error message saying \"Too many results - Expected Mono but query returned multiple results\".\nThis is consistent with the non reactive path and is demonstrated in the test ReactiveCourseRepositoryIT.testFindOneShouldFailIfMultipleResultsReturned", "author": "Blackbaud-EricSlater", "createdAt": "2020-07-17T18:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMjc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYyNDcwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13251#discussion_r456624706", "bodyText": "Sounds great, thank you for the explanation.", "author": "kushagraThapar", "createdAt": "2020-07-17T19:06:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMjc5NA=="}], "type": "inlineReview"}, {"oid": "e7607251035ec12b38dbba9b0ae8a955d38c2808", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e7607251035ec12b38dbba9b0ae8a955d38c2808", "message": "add unit test coverae for CosmosQuery get execution methods. Address code review feedback.", "committedDate": "2020-07-17T21:45:25Z", "type": "commit"}]}