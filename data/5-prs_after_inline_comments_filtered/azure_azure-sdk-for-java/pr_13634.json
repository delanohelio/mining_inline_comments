{"pr_number": 13634, "pr_title": "Encryption filling gaps", "pr_createdAt": "2020-07-30T05:56:52Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13634", "timeline": [{"oid": "691f8b162dde84440dafd7dd1c27eb397099c308", "url": "https://github.com/Azure/azure-sdk-for-java/commit/691f8b162dde84440dafd7dd1c27eb397099c308", "message": "minor cleanup", "committedDate": "2020-07-17T20:47:17Z", "type": "commit"}, {"oid": "8eda32c50f77257ea46091b21a02819f253e9faf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8eda32c50f77257ea46091b21a02819f253e9faf", "message": "minor cleanup", "committedDate": "2020-07-17T22:12:12Z", "type": "commit"}, {"oid": "ff37289bdc52b165166b69d2ee91420294818f23", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff37289bdc52b165166b69d2ee91420294818f23", "message": "encryptor", "committedDate": "2020-07-17T23:02:00Z", "type": "commit"}, {"oid": "77cf2ec44b4f5aa2c9f572af53485db248b22b71", "url": "https://github.com/Azure/azure-sdk-for-java/commit/77cf2ec44b4f5aa2c9f572af53485db248b22b71", "message": "static field name correction, fixed pre-condition check", "committedDate": "2020-07-17T23:05:10Z", "type": "commit"}, {"oid": "5d41cfff387576767afdf515af4587d323eca03e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5d41cfff387576767afdf515af4587d323eca03e", "message": "Merge branch 'master' into users/moderakh/encryption-minor-cleanup", "committedDate": "2020-07-20T16:38:44Z", "type": "commit"}, {"oid": "51f3cdd0fa68f3d7c072e82951be3014935601ba", "url": "https://github.com/Azure/azure-sdk-for-java/commit/51f3cdd0fa68f3d7c072e82951be3014935601ba", "message": "Merge branch 'users/moderakh/encryption-minor-cleanup' into users/moderakh/20200717-encryption", "committedDate": "2020-07-20T17:14:58Z", "type": "commit"}, {"oid": "cfc13d2ff2513f21fd461c3a23691de556945c7a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cfc13d2ff2513f21fd461c3a23691de556945c7a", "message": "move encryption hooks out of sdk", "committedDate": "2020-07-23T17:42:40Z", "type": "commit"}, {"oid": "2caa15601ede91a5ad95708843eb96ecd48cb0eb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2caa15601ede91a5ad95708843eb96ecd48cb0eb", "message": "Merge branch 'master' into users/moderakh/20200717-encryption", "committedDate": "2020-07-23T17:54:28Z", "type": "commit"}, {"oid": "7b4cd567147799e37418450ed00a2817ced1fdfe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b4cd567147799e37418450ed00a2817ced1fdfe", "message": "encryption", "committedDate": "2020-07-23T18:19:14Z", "type": "commit"}, {"oid": "e5e6f09d3634df5928ac322f9b6198cd73cbd7de", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e5e6f09d3634df5928ac322f9b6198cd73cbd7de", "message": "undid public api change to CosmosItemResponse", "committedDate": "2020-07-23T18:22:42Z", "type": "commit"}, {"oid": "5c17f86d6de14f46671de958b254b3b96d88272b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5c17f86d6de14f46671de958b254b3b96d88272b", "message": "cleanup", "committedDate": "2020-07-23T18:29:06Z", "type": "commit"}, {"oid": "6b2e69796dbf9107018009f57ad33e76def18397", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6b2e69796dbf9107018009f57ad33e76def18397", "message": "cleanup", "committedDate": "2020-07-23T18:39:03Z", "type": "commit"}, {"oid": "0a6458d95e077faae9e7398237c9461ae57c925d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0a6458d95e077faae9e7398237c9461ae57c925d", "message": "code review comments addressed", "committedDate": "2020-07-23T19:02:59Z", "type": "commit"}, {"oid": "9e9d20761317a111cb17ca10ffe1bba4b7c64b1e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e9d20761317a111cb17ca10ffe1bba4b7c64b1e", "message": "fixed compilation error", "committedDate": "2020-07-23T19:16:12Z", "type": "commit"}, {"oid": "f262d5c0dc7059d832be76326dc91cd1ca7484f7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f262d5c0dc7059d832be76326dc91cd1ca7484f7", "message": "minor code style cleanup", "committedDate": "2020-07-23T20:02:10Z", "type": "commit"}, {"oid": "a12d345d635a31d2e46c2e890257513ce4c1001f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a12d345d635a31d2e46c2e890257513ce4c1001f", "message": "check style fix", "committedDate": "2020-07-23T22:06:01Z", "type": "commit"}, {"oid": "7b79a5a8e6dc53abaed90535d10292cd9b99d3ac", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b79a5a8e6dc53abaed90535d10292cd9b99d3ac", "message": "javadoc fix", "committedDate": "2020-07-23T22:30:53Z", "type": "commit"}, {"oid": "88e984e4e32d11b6560782be1d86bd130edf9245", "url": "https://github.com/Azure/azure-sdk-for-java/commit/88e984e4e32d11b6560782be1d86bd130edf9245", "message": "javadoc fix", "committedDate": "2020-07-23T22:35:26Z", "type": "commit"}, {"oid": "6f7d590dc679c865eb081cc7c8b5acea50b94fec", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f7d590dc679c865eb081cc7c8b5acea50b94fec", "message": "check-style", "committedDate": "2020-07-23T22:49:18Z", "type": "commit"}, {"oid": "1b7ec08f10f7cd791234c8436a511d2d93bc3e21", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b7ec08f10f7cd791234c8436a511d2d93bc3e21", "message": "query basic support", "committedDate": "2020-07-24T06:17:06Z", "type": "commit"}, {"oid": "c5e67e1e2f69bc71950645c6299342e5af83502f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5e67e1e2f69bc71950645c6299342e5af83502f", "message": "Merge branch 'master' into users/moderakh/20200723-encryption", "committedDate": "2020-07-24T06:19:35Z", "type": "commit"}, {"oid": "290377d3f80c673d5a0719b526b20a936d770e8e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/290377d3f80c673d5a0719b526b20a936d770e8e", "message": "encryption for query", "committedDate": "2020-07-24T22:45:36Z", "type": "commit"}, {"oid": "ad1136cd0eebc082eef4ca453042e3e05d1d2b89", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad1136cd0eebc082eef4ca453042e3e05d1d2b89", "message": "Merge branch 'master' into users/moderakh/20200723-encryption", "committedDate": "2020-07-24T22:46:18Z", "type": "commit"}, {"oid": "e171f089fc84bcf2b7294dc2c32a6225d7623360", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e171f089fc84bcf2b7294dc2c32a6225d7623360", "message": "minor package move, cleanup", "committedDate": "2020-07-29T17:09:34Z", "type": "commit"}, {"oid": "9822e2c34844894d500cbcc8232469842a83451f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9822e2c34844894d500cbcc8232469842a83451f", "message": "Merge branch 'master' into users/moderakh/20200723-encryption", "committedDate": "2020-07-29T17:14:18Z", "type": "commit"}, {"oid": "bdb6084b68ba37f607709a86a23375f7348f6ff5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bdb6084b68ba37f607709a86a23375f7348f6ff5", "message": "code style fix", "committedDate": "2020-07-29T18:49:20Z", "type": "commit"}, {"oid": "9c7dad4144b01582b7358cc3ae13cdf6ffc5dbfa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9c7dad4144b01582b7358cc3ae13cdf6ffc5dbfa", "message": "fixed check style", "committedDate": "2020-07-29T19:55:07Z", "type": "commit"}, {"oid": "5c70b433b45b0b7f0b7b15e762f56698b6197d36", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5c70b433b45b0b7f0b7b15e762f56698b6197d36", "message": "upsert, delete, replace", "committedDate": "2020-07-30T00:13:15Z", "type": "commit"}, {"oid": "b9e0e390e9c4a513164296475a07b7e46499a948", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b9e0e390e9c4a513164296475a07b7e46499a948", "message": "replace, upsert test works", "committedDate": "2020-07-30T00:45:19Z", "type": "commit"}, {"oid": "e92dd701b4fcd55545f31a03ddcdfb8e1a007e69", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e92dd701b4fcd55545f31a03ddcdfb8e1a007e69", "message": "more tests", "committedDate": "2020-07-30T05:53:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1NzA1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13634#discussion_r462757057", "bodyText": "This publishOn will have no effect on the reactor chain, since subscribeOn will already switch the threads to Schedulers.elastic(). Take a look at this example at subscribeOn from this article: https://www.woolha.com/tutorials/project-reactor-publishon-vs-subscribeon-difference\nIf you were using different schedulers, then it would make sense to place both of them here.\nSo I guess simpler code will be something like this:\nreturn response\n .map(rsp -> {})\n .subscribeOn(Schedulers.elastic());", "author": "kushagraThapar", "createdAt": "2020-07-30T06:11:47Z", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -69,6 +69,63 @@\n             );\n     }\n \n+    private Mono<CosmosItemResponse<byte[]>> replaceItemStream(byte[] payload,\n+                                                               String itemId,\n+                                                               PartitionKey partitionKey,\n+                                                               EncryptionItemRequestOptions encryptionItemRequestOptions) {\n+        Preconditions.checkNotNull(payload, \"payload can't be null\");\n+\n+        // TODO: add diagnostics\n+        assert encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null;\n+        payload = EncryptionProcessor.encryptAsync(payload, encryptor,\n+            encryptionItemRequestOptions.getEncryptionOptions());\n+\n+        Mono<CosmosItemResponse<byte[]>> response = container.replaceItem(payload,\n+            itemId,\n+            partitionKey,\n+            encryptionItemRequestOptions);\n+\n+        return response\n+            .subscribeOn(Schedulers.elastic())\n+            .publishOn(Schedulers.elastic())", "originalCommit": "e92dd701b4fcd55545f31a03ddcdfb8e1a007e69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1OTc5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13634#discussion_r462759791", "bodyText": "you are right. copy pasted code from some other code I have. will fix shortly.\nThanks.", "author": "moderakh", "createdAt": "2020-07-30T06:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1NzA1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc2MTM4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13634#discussion_r462761387", "bodyText": "addressed.", "author": "moderakh", "createdAt": "2020-07-30T06:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1NzA1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1ODM3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13634#discussion_r462758372", "bodyText": "We should have new line at the end of the file.", "author": "kushagraThapar", "createdAt": "2020-07-30T06:15:30Z", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -246,4 +400,4 @@ ItemDeserializer getItemDeserializer() {\n             return input;\n         }\n     }\n-}\n+}", "originalCommit": "e92dd701b4fcd55545f31a03ddcdfb8e1a007e69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc2MDI5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13634#discussion_r462760291", "bodyText": "thanks will address shortly.", "author": "moderakh", "createdAt": "2020-07-30T06:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1ODM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc2MTMzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13634#discussion_r462761338", "bodyText": "addressed", "author": "moderakh", "createdAt": "2020-07-30T06:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1ODM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1ODQ5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13634#discussion_r462758498", "bodyText": "Thanks for this correction.", "author": "kushagraThapar", "createdAt": "2020-07-30T06:15:52Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncContainer.java", "diffHunk": "@@ -587,7 +587,7 @@ public String getId() {\n      * Deletes an item.\n      * <p>\n      * After subscription the operation will be performed.\n-     * The {@link Mono} upon successful completion will contain a single Cosmos item response with the replaced item.\n+     * The {@link Mono} upon successful completion will contain a single Cosmos item response with the deleted item.", "originalCommit": "e92dd701b4fcd55545f31a03ddcdfb8e1a007e69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc1ODUzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13634#discussion_r462758539", "bodyText": "Thanks!", "author": "kushagraThapar", "createdAt": "2020-07-30T06:16:01Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncContainer.java", "diffHunk": "@@ -601,7 +601,7 @@ public String getId() {\n      * Deletes the item.\n      * <p>\n      * After subscription the operation will be performed.\n-     * The {@link Mono} upon successful completion will contain a single Cosmos item response with the replaced item.\n+     * The {@link Mono} upon successful completion will contain a single Cosmos item response with the deleted item.", "originalCommit": "e92dd701b4fcd55545f31a03ddcdfb8e1a007e69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b23d5577de4206377f0924b32b7e69e76f21fc05", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b23d5577de4206377f0924b32b7e69e76f21fc05", "message": "addressed code review comments", "committedDate": "2020-07-30T06:23:28Z", "type": "commit"}]}