{"pr_number": 11040, "pr_title": "Migrate Search Live Testing to Use a Single Service Instance", "pr_createdAt": "2020-05-11T21:33:40Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11040", "timeline": [{"oid": "c3b0fe0afe3e91e75154cb3b55583f5f2969ea46", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3b0fe0afe3e91e75154cb3b55583f5f2969ea46", "message": "Update Search tests to use single resource", "committedDate": "2020-05-07T19:40:36Z", "type": "commit"}, {"oid": "766e780a85b0854b559f8ca2ea8a2ca47a626a44", "url": "https://github.com/Azure/azure-sdk-for-java/commit/766e780a85b0854b559f8ca2ea8a2ca47a626a44", "message": "Update some test code, add container creation to template", "committedDate": "2020-05-07T21:40:53Z", "type": "commit"}, {"oid": "67e702cb1f3d249d380c02ce3c8cc889dd7dcb37", "url": "https://github.com/Azure/azure-sdk-for-java/commit/67e702cb1f3d249d380c02ce3c8cc889dd7dcb37", "message": "Merge branch 'master' into AzSearch_UseSingleSearchServiceInTests", "committedDate": "2020-05-07T21:47:53Z", "type": "commit"}, {"oid": "f53ede972c27e08be9051d4a299f3063d46da486", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f53ede972c27e08be9051d4a299f3063d46da486", "message": "Updated some tests to cleanup after their run", "committedDate": "2020-05-08T17:33:44Z", "type": "commit"}, {"oid": "076f028f578e1d1e4759c90747a6d40cf80ca44a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/076f028f578e1d1e4759c90747a6d40cf80ca44a", "message": "Update more tests to track and delete resources", "committedDate": "2020-05-08T20:14:38Z", "type": "commit"}, {"oid": "f5d84ca2bd3e7d498c04eefef9a18cd414b0a668", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f5d84ca2bd3e7d498c04eefef9a18cd414b0a668", "message": "More unit test updates", "committedDate": "2020-05-08T21:41:23Z", "type": "commit"}, {"oid": "702149bdfeba11ba40a4500f5ebc15cb8dc5e36c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/702149bdfeba11ba40a4500f5ebc15cb8dc5e36c", "message": "Moving some testing code, fixed deletion of wrong resource type", "committedDate": "2020-05-08T22:55:44Z", "type": "commit"}, {"oid": "559def2633486f13a732d5f41f4c199742ed1687", "url": "https://github.com/Azure/azure-sdk-for-java/commit/559def2633486f13a732d5f41f4c199742ed1687", "message": "Merge branch 'master' into AzSearch_UseSingleSearchServiceInTests", "committedDate": "2020-05-08T23:09:19Z", "type": "commit"}, {"oid": "62a917810b6a5995a4a66dac162841efd2c68dc5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/62a917810b6a5995a4a66dac162841efd2c68dc5", "message": "Fixing failing tests", "committedDate": "2020-05-09T01:57:23Z", "type": "commit"}, {"oid": "17a1dc02edde4fad8982aa938f431d9ee37fb6d3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/17a1dc02edde4fad8982aa938f431d9ee37fb6d3", "message": "Merge branch 'master' into AzSearch_UseSingleSearchServiceInTests", "committedDate": "2020-05-11T16:14:45Z", "type": "commit"}, {"oid": "fa0e637fe01c92b15e42334c8f0fd4b9d31b44fe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fa0e637fe01c92b15e42334c8f0fd4b9d31b44fe", "message": "Finish updating tests and re-recording playback records", "committedDate": "2020-05-11T19:03:13Z", "type": "commit"}, {"oid": "93099997cc02ac17155338f82fe761bfbc4768f6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/93099997cc02ac17155338f82fe761bfbc4768f6", "message": "Merge branch 'master' into AzSearch_UseSingleSearchServiceInTests", "committedDate": "2020-05-11T20:15:34Z", "type": "commit"}, {"oid": "2b3d058521612d7fe2b573b27bd0ea22b99e37c3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2b3d058521612d7fe2b573b27bd0ea22b99e37c3", "message": "Fix linting issue, re-record a few failing tests", "committedDate": "2020-05-11T20:24:25Z", "type": "commit"}, {"oid": "4b261e6db3f78371be66495406cdf192b673a551", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4b261e6db3f78371be66495406cdf192b673a551", "message": "Update a few tests", "committedDate": "2020-05-11T20:50:00Z", "type": "commit"}, {"oid": "4b498c01e1b5bfe615007f04d775929ddcda889e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4b498c01e1b5bfe615007f04d775929ddcda889e", "message": "Merge branch 'master' into AzSearch_UsingSingleSearchServiceInTests", "committedDate": "2020-05-12T16:15:09Z", "type": "commit"}, {"oid": "1862fd0fec9d8c535f13feede3e65fad4506fa3c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1862fd0fec9d8c535f13feede3e65fad4506fa3c", "message": "Add missing ')'", "committedDate": "2020-05-12T16:27:20Z", "type": "commit"}, {"oid": "4896ea6ba69c7441a9c120fb2e50497cfd3241cd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4896ea6ba69c7441a9c120fb2e50497cfd3241cd", "message": "Fix variable name", "committedDate": "2020-05-12T16:34:45Z", "type": "commit"}, {"oid": "91110973e06fbab1996ac6d96e416cb9ff631544", "url": "https://github.com/Azure/azure-sdk-for-java/commit/91110973e06fbab1996ac6d96e416cb9ff631544", "message": "Fix deployment template", "committedDate": "2020-05-12T18:56:02Z", "type": "commit"}, {"oid": "21c892dac221dfbcec97c170c11bca344f516e65", "url": "https://github.com/Azure/azure-sdk-for-java/commit/21c892dac221dfbcec97c170c11bca344f516e65", "message": "Set parallel job limit to 2", "committedDate": "2020-05-12T19:11:55Z", "type": "commit"}, {"oid": "62e0385aaae72df57a4636e1a675e0e397bbb723", "url": "https://github.com/Azure/azure-sdk-for-java/commit/62e0385aaae72df57a4636e1a675e0e397bbb723", "message": "Merge branch 'master' into AzSearch_UsingSingleSearchServiceInTests", "committedDate": "2020-05-12T21:21:34Z", "type": "commit"}, {"oid": "db1b82af137cf126c17bb5f3c767c544cceb112e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/db1b82af137cf126c17bb5f3c767c544cceb112e", "message": "Updates based on reviews", "committedDate": "2020-05-12T21:30:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0ODY3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424048678", "bodyText": "Is it better to clean up the indexesToCleanup after test or re-initiate before run?", "author": "sima-zhu", "createdAt": "2020-05-12T21:38:16Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/CustomAnalyzerSyncTests.java", "diffHunk": "@@ -79,33 +82,32 @@\n import java.util.List;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.stream.Collectors;\n-import org.junit.jupiter.api.Assertions;\n-import org.junit.jupiter.api.Test;\n \n+import static com.azure.search.documents.TestHelpers.assertHttpResponseException;\n import static com.azure.search.documents.TestHelpers.assertObjectEquals;\n+import static com.azure.search.documents.TestHelpers.generateRequestOptions;\n+import static com.azure.search.documents.TestHelpers.waitForIndexing;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertFalse;\n \n-public class CustomAnalyzerSyncTests extends SearchServiceTestBase {\n+public class CustomAnalyzerSyncTests extends SearchTestBase {\n     private static final String NAME_PREFIX = \"azsmnet\";\n+    private static final Collection<CharFilterName> CHAR_FILTER_NAMES = new ArrayList<>(CharFilterName.values());\n \n     private SearchServiceClient searchServiceClient;\n-    private static Collection<CharFilterName> charFilterNames;\n-\n-    static {\n-        getAllCharFilterName();\n-    }\n+    private final List<String> indexesToCleanup = new ArrayList<>();\n \n     @Override\n     protected void beforeTest() {\n         super.beforeTest();\n         searchServiceClient = getSearchServiceClientBuilder().buildClient();\n     }\n \n-    private static void getAllCharFilterName() {\n-        charFilterNames = new ArrayList<>();\n-        for (CharFilterName name : CharFilterName.values()) {\n-            charFilterNames.add(name);\n+    @Override\n+    protected void afterTest() {\n+        super.afterTest();\n+        for (String index : indexesToCleanup) {", "originalCommit": "db1b82af137cf126c17bb5f3c767c544cceb112e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1Nzc2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424057764", "bodyText": "I think it would be better to cleanup after the test, this makes it so the test itself maintains all the logic it uses.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:57:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0ODY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTU1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424049552", "bodyText": "Same here.\nI have concern which the list has more sources than expected and throw no resource error.", "author": "sima-zhu", "createdAt": "2020-05-12T21:40:05Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/DataSourceSyncTests.java", "diffHunk": "@@ -6,65 +6,57 @@\n import com.azure.core.exception.HttpResponseException;\n import com.azure.core.http.rest.Response;\n import com.azure.core.util.Context;\n+import com.azure.core.util.CoreUtils;\n import com.azure.search.documents.models.DataContainer;\n import com.azure.search.documents.models.DataDeletionDetectionPolicy;\n import com.azure.search.documents.models.DataSource;\n import com.azure.search.documents.models.DataSourceCredentials;\n import com.azure.search.documents.models.DataSourceType;\n import com.azure.search.documents.models.HighWaterMarkChangeDetectionPolicy;\n import com.azure.search.documents.models.RequestOptions;\n+import com.azure.search.documents.models.SearchErrorException;\n import com.azure.search.documents.models.SoftDeleteColumnDeletionDetectionPolicy;\n import com.azure.search.documents.models.SqlIntegratedChangeTrackingPolicy;\n-import com.azure.search.documents.test.AccessConditionTests;\n-import com.azure.search.documents.test.AccessOptions;\n-import io.netty.handler.codec.http.HttpResponseStatus;\n import org.junit.jupiter.api.Test;\n \n import java.net.HttpURLConnection;\n+import java.util.ArrayList;\n import java.util.Iterator;\n-import java.util.function.BiConsumer;\n-import java.util.function.BiFunction;\n-import java.util.function.Function;\n-import java.util.function.Supplier;\n+import java.util.List;\n \n+import static com.azure.search.documents.TestHelpers.BLOB_DATASOURCE_TEST_NAME;\n+import static com.azure.search.documents.TestHelpers.assertHttpResponseException;\n+import static com.azure.search.documents.TestHelpers.generateRequestOptions;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertNotEquals;\n import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n-public class DataSourceSyncTests extends SearchServiceTestBase {\n+public class DataSourceSyncTests extends SearchTestBase {\n     private static final String FAKE_DESCRIPTION = \"Some data source\";\n     private static final String FAKE_STORAGE_CONNECTION_STRING =\n         \"DefaultEndpointsProtocol=https;AccountName=NotaRealAccount;AccountKey=fake;\";\n     private static final String FAKE_COSMOS_CONNECTION_STRING =\n         \"AccountEndpoint=https://NotaRealAccount.documents.azure.com;AccountKey=fake;Database=someFakeDatabase\";\n \n+    private final List<String> dataSourcesToDelete = new ArrayList<>();\n     private SearchServiceClient client;\n \n-    // commonly used lambda definitions\n-    private BiFunction<DataSource, AccessOptions, DataSource> createOrUpdateDataSourceFunc =\n-        (DataSource ds, AccessOptions ac) ->\n-            createOrUpdateDataSource(ds, ac.getOnlyIfUnchanged(), ac.getRequestOptions());\n-\n-    private Supplier<DataSource> newDataSourceFunc = () -> createTestBlobDataSource(null);\n-\n-    private Function<DataSource, DataSource> mutateDataSourceFunc = (DataSource ds) -> \n-        ds.setDescription(\"somethingnew\");\n-\n-    private BiConsumer<DataSource, AccessOptions> deleteDataSourceFunc = (DataSource dataSource, AccessOptions ac) ->\n-        client.deleteDataSourceWithResponse(dataSource,\n-            ac.getOnlyIfUnchanged(), ac.getRequestOptions(), Context.NONE);\n-\n     @Override\n     protected void beforeTest() {\n         super.beforeTest();\n         client = getSearchServiceClientBuilder().buildClient();\n     }\n \n-    private DataSource createOrUpdateDataSource(DataSource datasource, Boolean onlyIfUnchanged,\n-        RequestOptions requestOptions) {\n-        return client.createOrUpdateDataSourceWithResponse(datasource, onlyIfUnchanged, requestOptions, Context.NONE)\n-            .getValue();\n+    @Override\n+    protected void afterTest() {\n+        super.afterTest();\n+        for (String dataSource : dataSourcesToDelete) {", "originalCommit": "db1b82af137cf126c17bb5f3c767c544cceb112e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1ODYwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424058609", "bodyText": "The concern is that this list would contain more data sources than still existing after the test? Luckily it appears 404 is a valid response type, so it won't throw an exception.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTgxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424049813", "bodyText": "Indentation.", "author": "sima-zhu", "createdAt": "2020-05-12T21:40:38Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/DataSourceSyncTests.java", "diffHunk": "@@ -112,7 +106,8 @@ public void deleteDataSourceIsIdempotent() {\n         DataSource dataSource = createTestBlobDataSource(null);\n \n         // Try to delete before the data source exists, expect a NOT FOUND return status code\n-        Response<Void> result = client.deleteDataSourceWithResponse(dataSource, false, generateRequestOptions(), Context.NONE);\n+        Response<Void> result = client.deleteDataSourceWithResponse(dataSource, false, generateRequestOptions(),\n+            Context.NONE);", "originalCommit": "db1b82af137cf126c17bb5f3c767c544cceb112e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dd63e804dd3e96e25b9c198a22207f1f4e13c633", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dd63e804dd3e96e25b9c198a22207f1f4e13c633", "message": "Fix default Storage suffix, make azure-test-watcher a test dependency as it should be", "committedDate": "2020-05-12T22:17:23Z", "type": "commit"}, {"oid": "0d3ac3dd029d8e34d24f0b43de7a6bb63a901dd2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0d3ac3dd029d8e34d24f0b43de7a6bb63a901dd2", "message": "Add missing '.' in Search service endpoint", "committedDate": "2020-05-12T22:19:20Z", "type": "commit"}, {"oid": "e8a3f9924c2c250328c1027696e5c00862524ce6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8a3f9924c2c250328c1027696e5c00862524ce6", "message": "Use Free SKU instead of Basic", "committedDate": "2020-05-13T00:15:19Z", "type": "commit"}, {"oid": "5646988d397b17d4b14832d2c0826ec19967d613", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5646988d397b17d4b14832d2c0826ec19967d613", "message": "Update session record", "committedDate": "2020-05-13T00:16:07Z", "type": "commit"}]}