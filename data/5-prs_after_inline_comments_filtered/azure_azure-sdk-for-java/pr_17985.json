{"pr_number": 17985, "pr_title": "check if index policy has changed on repo initialization and update if needed", "pr_createdAt": "2020-12-04T21:40:54Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17985", "timeline": [{"oid": "0869c64386eff0fdcfafb7ff608f1f1a75b68daa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0869c64386eff0fdcfafb7ff608f1f1a75b68daa", "message": "check if index policy has changed on repo initialization and update if needed", "committedDate": "2020-12-04T21:38:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNDEwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r536404105", "bodyText": "i wanted to go ahead and open this PR to start discussion of this line. The issue here is that the indexPolicy object retrieved from the server will not ever compare with the index policy that is contained in CosmosEntityInformation using .equals(). This is for a few reasons....\n1.) The IndexPolicy object only contains a few instance fields and the rest of the data is contained in the serialized version of the object that is contained internally. The version of indexPolicy that is within CosmosEntityInformation will never contain a serialized version of the object that is comparable to the one retrieved from the server due to all the metadata fields that are added to the serialized json by the server.\n2.) The version of the indexPolicy object in CosmosEntityInformation is created from the parameters provided by the annotation. However the annotation does not account for any of the implied state that is set in certain cases. For instance, if you apply the CosmosIndexingPolicy annotation with no parameters, then the default indexing policy will get applied to your container. The index policy object in CosmosEntityInformation will contain an empty list for the included and excluded fields in this case. The index policy object retrieved from the server will contain an included list with \"/\"  and an excluded list with \"/_etag/\".\nSince the way the index policy is updated is by doing a container replace, it seems like this check needs to be accurate as far as detecting if the index policy actually changed so that needless container replaces are not being done.\nThe only approach i can think of to do this is to account for all the discrepancies between these objects when comparing.\nCan you guys think of a better way of determining if an index policy update is needed?", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-04T21:53:43Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/support/SimpleCosmosRepository.java", "diffHunk": "@@ -45,6 +46,32 @@ public SimpleCosmosRepository(CosmosEntityInformation<T, ID> metadata,\n         if (this.information.isAutoCreateContainer()) {\n             createContainerIfNotExists();\n         }\n+\n+        CosmosContainerProperties currentProperties = getContainerProperties();\n+        if (shouldUpdateIndexingPolicy(currentProperties)) {\n+            currentProperties.setIndexingPolicy(information.getIndexingPolicy());\n+            replaceContainerProperties(currentProperties);\n+        }\n+    }\n+\n+    private boolean shouldUpdateIndexingPolicy(CosmosContainerProperties currentProperties) {\n+        return currentProperties != null && !currentProperties.getIndexingPolicy().equals(information.getIndexingPolicy());", "originalCommit": "0869c64386eff0fdcfafb7ff608f1f1a75b68daa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4MjM2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539582368", "bodyText": "@kushagraThapar any thoughts on this? The way i see it I either need to flesh out the comparison code to account for the discrepancies mentioned above or we omit the check entirely and let the container replace run everytime. Do you know what the cost of a container replace is? If it is an inexpensive constant time operation then letting it always run is probably fine. If it is something that is expensive and scales with the size of the container then we should ensure that needless container replaces are not being executed.", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-09T19:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNDEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczNjA4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539736086", "bodyText": "@Blackbaud-EricSlater - It is an expensive call that we should not do all the times. The current equals code that you have on this PR is costly or is it fine ?", "author": "kushagraThapar", "createdAt": "2020-12-09T23:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNDEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI2NzMxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r540267315", "bodyText": "its not that the equals comparison is costly, its that it never returns true. I am working on fixing this now. I am adding definitions for .equals to the IncludedPath, ExcludedPath and Index classes and adding some additional code that accounts for the discrepancies i mentioned above.", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-10T15:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNDEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM2NTEzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r540365130", "bodyText": "Makes sense, that will be the right way to fix this.", "author": "kushagraThapar", "createdAt": "2020-12-10T17:37:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNDEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUwNzMzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r540507339", "bodyText": "this is fixed now and the logic for comparing indexPolicies is contained in IndexPolicyCompareService. Implementing .equals on ExcludedPath and IncludedPath was necessary as well", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-10T21:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNDEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzc4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r536407786", "bodyText": "This was necessary because the container replace method that is being used in azure-cosmos depends on the __self link being in the propertyBag. You can see below in SimpleCosmosRepository that I have to retrieve the CosmosContainerProperties from the server so that this field is contained in the properties bag. I cannot use one that i create myself using CosmosEntityInformation since it will not contain the __self link.\nSo, I retrieve CosmosContainerProperties from the server and then set the new indexing policy on it. This change makes it so that calling setIndexingPolicy updates that underlying json representation that is sent to the server. Without this is place, calling setIndexingPolicy() has no effect.", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-04T21:58:16Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/DocumentCollection.java", "diffHunk": "@@ -90,6 +90,7 @@ public void setIndexingPolicy(IndexingPolicy indexingPolicy) {\n         }\n \n         this.indexingPolicy = indexingPolicy;\n+        setProperty(this, Constants.Properties.INDEXING_POLICY, this.indexingPolicy);", "originalCommit": "0869c64386eff0fdcfafb7ff608f1f1a75b68daa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ0NDc1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r536444752", "bodyText": "@kushagraThapar  @Blackbaud-EricSlater\nThere is a test in com.azure.cosmos.CosmosContainerTest.replace validating replace scenario. Does this mean that test is broken?", "author": "moderakh", "createdAt": "2020-12-04T23:33:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyODE5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r538828191", "bodyText": "im not sure what i missed in my testing that made me think this was necessary, but it is working without it. The DocumentCollection is re-serialized when getV2Collection() is called on the DocumentCollection in CosmosAsyncContainer.replaceInternal. I removed the edits to this file.\nHowever, on a separate note, in looking at the test you mentioned, i did notice that it was not actually changing the index policy to a new value in the test. It was creating a container with indexMode.CONSISTENT and replacing it with a container with indexMode.CONSISTENT, which is also the default value if no policy is specified. This is not a very good validation that the indexPolicy is actually being replaced.\nI updated the test to replace the container with a different index policy (automatic = false and indexMode.NONE). This should be stronger validation", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-08T21:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgzNDk5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r538834991", "bodyText": "thank you @Blackbaud-EricSlater\n@kushagraThapar please run the full CI.", "author": "moderakh", "createdAt": "2020-12-08T21:52:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1MTE3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r538851177", "bodyText": "Thanks @Blackbaud-EricSlater for updating the tests, however on the spring side, can you please add the support for CosmosReactiveRepository as well ?\nOtherwise, when using reactiveRepositoies, the indexing policy update will not take affect.", "author": "kushagraThapar", "createdAt": "2020-12-08T22:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg3MDIxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r538870216", "bodyText": "will do", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-08T22:55:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzc4Ng=="}], "type": "inlineReview"}, {"oid": "c331d3bd08c9d39ec774573a30d4f94e8004e4c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c331d3bd08c9d39ec774573a30d4f94e8004e4c6", "message": "undo changes to DocumentCollection. CosmosContainerReplace test case to have stronger assertions. Fix checkstyle issues", "committedDate": "2020-12-08T21:22:03Z", "type": "commit"}, {"oid": "24af71b96a9d885b199b81cf89035d436b96ba42", "url": "https://github.com/Azure/azure-sdk-for-java/commit/24af71b96a9d885b199b81cf89035d436b96ba42", "message": "fix CosmosContainerTest and add integration test for updating index on startup", "committedDate": "2020-12-09T17:56:45Z", "type": "commit"}, {"oid": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6", "message": "add reactive support", "committedDate": "2020-12-09T18:18:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0ODk4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539548986", "bodyText": "header missing.", "author": "kushagraThapar", "createdAt": "2020-12-09T18:33:44Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/domain/IndexPolicyEntity.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.azure.spring.data.cosmos.domain;", "originalCommit": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3NzE5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539577195", "bodyText": "fixed", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-09T19:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0ODk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0OTA2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539549067", "bodyText": "header missing.", "author": "kushagraThapar", "createdAt": "2020-12-09T18:33:51Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/IndexPolicyUpdateIT.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.azure.spring.data.cosmos.repository.integration;", "originalCommit": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3NzAxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539577014", "bodyText": "fixed", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-09T19:15:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0OTA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0OTE1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539549157", "bodyText": "header missing.", "author": "kushagraThapar", "createdAt": "2020-12-09T18:34:00Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/ReactiveIndexPolicyUpdateIT.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.azure.spring.data.cosmos.repository.integration;", "originalCommit": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3NzE1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539577151", "bodyText": "fixed", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-09T19:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0OTE1Nw=="}], "type": "inlineReview"}, {"oid": "6c1683a8ac972697393d4e30a74ea0b3671cc20f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6c1683a8ac972697393d4e30a74ea0b3671cc20f", "message": "fix checkstyle issues. Add headers to new files", "committedDate": "2020-12-09T19:15:40Z", "type": "commit"}, {"oid": "453e00043a5072869e3e3042b822d2c1462b9b6b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/453e00043a5072869e3e3042b822d2c1462b9b6b", "message": "fix logic for determining if index policy has changed. implement equals in necessary classes. Add more test cases", "committedDate": "2020-12-10T21:15:59Z", "type": "commit"}, {"oid": "6028b5483e486aef358ee6c9186eeb9aadb4bc11", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6028b5483e486aef358ee6c9186eeb9aadb4bc11", "message": "add missing header. remove unneeded repos", "committedDate": "2020-12-10T21:20:30Z", "type": "commit"}, {"oid": "273743a23a82354ab5c681e2667ac9fa569f2445", "url": "https://github.com/Azure/azure-sdk-for-java/commit/273743a23a82354ab5c681e2667ac9fa569f2445", "message": "remove unused autowire", "committedDate": "2020-12-10T21:22:01Z", "type": "commit"}, {"oid": "be5a0ed471457c5aa5af5e36b6acb73a3dc4c2c0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/be5a0ed471457c5aa5af5e36b6acb73a3dc4c2c0", "message": "add missing javadoc and fi style issue", "committedDate": "2020-12-10T21:57:49Z", "type": "commit"}, {"oid": "d01b84aa05122ae31d295117002723afb776da34", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d01b84aa05122ae31d295117002723afb776da34", "message": "remove unused autowired client", "committedDate": "2020-12-11T22:01:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ0NjUyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r541446529", "bodyText": "@Blackbaud-EricSlater - why do we need an instance here ?\nSince this is a stateless service, creating instance here is redundant in my opinion, thoughts ?\nIt will unnecessary create multiple instances of IndexPolicyCompareService, where in case of static method, all it needs is just the Class instance, which does not pose a risk of memory leak.", "author": "kushagraThapar", "createdAt": "2020-12-12T00:13:40Z", "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/support/IndexPolicyCompareService.java", "diffHunk": "@@ -0,0 +1,62 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.spring.data.cosmos.repository.support;\n+\n+import com.azure.cosmos.models.ExcludedPath;\n+import com.azure.cosmos.models.IncludedPath;\n+import com.azure.cosmos.models.IndexingPolicy;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Class for determining if the index policy currenlt applied to the container matches the index policy that is\n+ * specified on an entities' @CosmosIndexingPolicy annotation\n+ */\n+public class IndexPolicyCompareService {\n+\n+    public static boolean policyNeedsUpdate(IndexingPolicy existingPolicy, IndexingPolicy newPolicy) {\n+        return new IndexPolicyCompareService().needsUpdate(existingPolicy, newPolicy);", "originalCommit": "d01b84aa05122ae31d295117002723afb776da34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYwODE2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r543608162", "bodyText": "@Blackbaud-EricSlater - can you please implement the above changes so we can get this PR in ?\nI am currently out on vacation, and won't be able to review after tomorrow.\nIn case you are out too, we can merge it in January.", "author": "kushagraThapar", "createdAt": "2020-12-15T19:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ0NjUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY1MDI5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r543650294", "bodyText": "fixed", "author": "Blackbaud-EricSlater", "createdAt": "2020-12-15T20:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ0NjUyOQ=="}], "type": "inlineReview"}, {"oid": "50ae6fb2c3fef20b7cfea1760cf741e58ef18d6e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/50ae6fb2c3fef20b7cfea1760cf741e58ef18d6e", "message": "make class fully static", "committedDate": "2020-12-15T20:04:54Z", "type": "commit"}]}