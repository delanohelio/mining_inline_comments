{"pr_number": 16810, "pr_title": "Add Azure Service Fabric MI Support.", "pr_createdAt": "2020-10-26T18:11:52Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16810", "timeline": [{"oid": "e4a83a20e25dc0d036328544a73a2dfb385ef99e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e4a83a20e25dc0d036328544a73a2dfb385ef99e", "message": "add service fabric MI auth logic", "committedDate": "2020-10-26T02:08:41Z", "type": "commit"}, {"oid": "c652939b18448cbaa8ed463cd431fcf5903af480", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c652939b18448cbaa8ed463cd431fcf5903af480", "message": "update code", "committedDate": "2020-11-04T19:11:37Z", "type": "commit"}, {"oid": "3377fa9787c3cbca02402679dce5a8a5b7ddf133", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3377fa9787c3cbca02402679dce5a8a5b7ddf133", "message": "update tests", "committedDate": "2020-11-04T19:13:10Z", "type": "commit"}, {"oid": "712c6b6efe10839b8262632e8834b6c3f1e37fe7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/712c6b6efe10839b8262632e8834b6c3f1e37fe7", "message": "refactor code", "committedDate": "2020-11-04T20:01:52Z", "type": "commit"}, {"oid": "452e49dc517806be06e3af0d8802f3c8cf6209b6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/452e49dc517806be06e3af0d8802f3c8cf6209b6", "message": "Merge remote-tracking branch 'upstream/master' into add-azure-services-mi-support", "committedDate": "2020-11-04T20:08:02Z", "type": "commit"}, {"oid": "8b284402e45374860e8adfdf98fe4b975d5fbe89", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8b284402e45374860e8adfdf98fe4b975d5fbe89", "message": "fix checkstyle", "committedDate": "2020-11-04T20:48:31Z", "type": "commit"}, {"oid": "b7072dfe552b939d0b0d13846dc09672edc1fdb3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b7072dfe552b939d0b0d13846dc09672edc1fdb3", "message": "refactor code", "committedDate": "2020-11-04T20:57:54Z", "type": "commit"}, {"oid": "6377db80e111bc16f2ce842fcda5a9bd5d205bd5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6377db80e111bc16f2ce842fcda5a9bd5d205bd5", "message": "refactor code", "committedDate": "2020-11-04T20:59:45Z", "type": "commit"}, {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fe913349ab413f63053bbca825d45fcfd1bbfec", "message": "refector code", "committedDate": "2020-11-04T21:15:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0NzU3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517647576", "bodyText": "Small fix:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The Managed Service Identity credential for Azure App Service.\n          \n          \n            \n             * The Managed Service Identity credential for Azure Service Fabric.", "author": "mccoyp", "createdAt": "2020-11-04T21:41:48Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/ServiceFabricMsiCredential.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.identity.implementation.IdentityClient;\n+import reactor.core.publisher.Mono;\n+\n+/**\n+ * The Managed Service Identity credential for Azure App Service.", "originalCommit": "8fe913349ab413f63053bbca825d45fcfd1bbfec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMDI0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517800247", "bodyText": "Similar to the comments in PR #13466, throw the exception here.", "author": "srnagar", "createdAt": "2020-11-05T05:27:10Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/ManagedIdentityCredential.java", "diffHunk": "@@ -36,14 +37,20 @@\n             .identityClientOptions(identityClientOptions)\n             .build();\n         Configuration configuration = Configuration.getGlobalConfiguration().clone();\n-        if (configuration.contains(Configuration.PROPERTY_MSI_ENDPOINT)\n-                || (configuration.contains(Configuration.PROPERTY_IDENTITY_ENDPOINT)\n-                        && configuration.contains(Configuration.PROPERTY_IDENTITY_HEADER))) {\n-            appServiceMSICredential = new AppServiceMsiCredential(clientId, identityClient);\n-            virtualMachineMSICredential = null;\n+        if (configuration.contains(Configuration.PROPERTY_IDENTITY_ENDPOINT)) {\n+            if (configuration.contains(Configuration.PROPERTY_IDENTITY_HEADER)) {\n+                if (configuration.contains(PROPERTY_IDENTITY_SERVER_THUMBPRINT)) {\n+                    managedIdentityServiceCredential = new ServiceFabricMsiCredential(clientId, identityClient);\n+                } else {\n+                    managedIdentityServiceCredential = new AppServiceMsiCredential(clientId, identityClient);\n+                }\n+            } else {\n+                managedIdentityServiceCredential = null;", "originalCommit": "8fe913349ab413f63053bbca825d45fcfd1bbfec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIzNzcyOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r518237728", "bodyText": "same response.", "author": "g2vinay", "createdAt": "2020-11-05T17:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMDI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTA5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517801094", "bodyText": "Can this be converted into an enum where all the environments are listed?", "author": "srnagar", "createdAt": "2020-11-05T05:30:28Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/ManagedIdentityServiceCredential.java", "diffHunk": "@@ -0,0 +1,61 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity;\n+\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.identity.implementation.IdentityClient;\n+import reactor.core.publisher.Mono;\n+\n+/**\n+ * The Managed Service Identity credential.\n+ */\n+abstract class ManagedIdentityServiceCredential {\n+    private final String clientId;\n+    private final String environment;\n+    final IdentityClient identityClient;\n+\n+    /**\n+     * Creates an instance of ManagedIdentityServiceCredential.\n+     * @param clientId the client id of user assigned or system assigned identity\n+     * @param identityClient the identity client to acquire a token with.\n+     * @param environment The service environment of the credential.\n+     */\n+    ManagedIdentityServiceCredential(String clientId, IdentityClient identityClient, String environment) {\n+        this.identityClient = identityClient;\n+        this.clientId = clientId;\n+        this.environment = environment;", "originalCommit": "8fe913349ab413f63053bbca825d45fcfd1bbfec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4ODM4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r518288384", "bodyText": "Yeah since this is not public API, internally it can be introduced as an impl detaiI.\nBut, not critically needed currently, as this info is used only in the log message currently.\nI'll introduce it in a follow up code refactor PR.", "author": "g2vinay", "createdAt": "2020-11-05T18:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTQwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517801405", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class IdentitySSLUtil {\n          \n          \n            \n            public class IdentitySslUtil {", "author": "srnagar", "createdAt": "2020-11-05T05:31:49Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/util/IdentitySSLUtil.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation.util;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.HttpsURLConnection;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.X509TrustManager;\n+import java.security.KeyManagementException;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateEncodingException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+public class IdentitySSLUtil {", "originalCommit": "8fe913349ab413f63053bbca825d45fcfd1bbfec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4ODIwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r518288205", "bodyText": "updated.", "author": "g2vinay", "createdAt": "2020-11-05T18:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTY4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517801688", "bodyText": "Since this is a static helper class, make the ctor private to avoid instantiation.", "author": "srnagar", "createdAt": "2020-11-05T05:32:59Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/util/IdentitySSLUtil.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation.util;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.HttpsURLConnection;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.X509TrustManager;\n+import java.security.KeyManagementException;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateEncodingException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+public class IdentitySSLUtil {\n+    public static final HostnameVerifier ALL_HOSTS_ACCEPT_HOSTNAME_VERIFIER;\n+\n+    static {", "originalCommit": "8fe913349ab413f63053bbca825d45fcfd1bbfec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4NzU5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r518287598", "bodyText": "updated.", "author": "g2vinay", "createdAt": "2020-11-05T18:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTgwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517801808", "bodyText": "This can be converted to a static logger.", "author": "srnagar", "createdAt": "2020-11-05T05:33:28Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/util/IdentitySSLUtil.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation.util;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.HttpsURLConnection;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.X509TrustManager;\n+import java.security.KeyManagementException;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateEncodingException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+public class IdentitySSLUtil {\n+    public static final HostnameVerifier ALL_HOSTS_ACCEPT_HOSTNAME_VERIFIER;\n+\n+    static {\n+        ALL_HOSTS_ACCEPT_HOSTNAME_VERIFIER = new HostnameVerifier() {\n+            @SuppressWarnings(\"BadHostnameVerifier\")\n+            @Override\n+            public boolean verify(String hostname, SSLSession session) {\n+                return true;\n+            }\n+        };\n+    }\n+\n+    /**\n+     *\n+     * Pins the specified HTTPS URL Connection to work against a specific server-side certificate with\n+     * the specified thumbprint only.\n+     *\n+     * @param className The class calling the method.\n+     * @param httpsUrlConnection The https url connection to configure\n+     * @param certificateThumbprint The thumbprint of the certificate\n+     */\n+    public static void addTrustedCertificateThumbprint(String className, HttpsURLConnection httpsUrlConnection,\n+                                                       String certificateThumbprint) {\n+\n+        ClientLogger logger = new ClientLogger(className);", "originalCommit": "8fe913349ab413f63053bbca825d45fcfd1bbfec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4NjcyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r518286729", "bodyText": "We have a checkstyle rule to not have static loggers.", "author": "g2vinay", "createdAt": "2020-11-05T18:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODMzODkyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r518338925", "bodyText": "For static helper classes, it's okay to use static logger and add checkstyle suppression.", "author": "srnagar", "createdAt": "2020-11-05T20:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTgwOA=="}], "type": "inlineReview"}, {"oid": "157448c1c8ec329ca0b4a2f1a20aec303236bf0b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/157448c1c8ec329ca0b4a2f1a20aec303236bf0b", "message": "address feedback", "committedDate": "2020-11-05T18:55:31Z", "type": "commit"}, {"oid": "cc1079dcbfacfb300dfdbe07bcc4fb124dd7565d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cc1079dcbfacfb300dfdbe07bcc4fb124dd7565d", "message": "update", "committedDate": "2020-11-05T18:56:45Z", "type": "commit"}]}