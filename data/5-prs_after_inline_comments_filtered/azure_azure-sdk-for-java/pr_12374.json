{"pr_number": 12374, "pr_title": "Sb track2 some live test failure fixes 1", "pr_createdAt": "2020-06-21T17:21:33Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/12374", "timeline": [{"oid": "5c3cf988ac1c65cb1c4d14e6105d1d05fcc47648", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5c3cf988ac1c65cb1c4d14e6105d1d05fcc47648", "message": "Increment package version after release of com.azure azure-messaging-servicebus", "committedDate": "2020-05-08T21:29:37Z", "type": "commit"}, {"oid": "39b9a1a6d1bfd9adf54c91fea1a90144cb02f288", "url": "https://github.com/Azure/azure-sdk-for-java/commit/39b9a1a6d1bfd9adf54c91fea1a90144cb02f288", "message": "resolve merge conflict", "committedDate": "2020-05-12T19:40:58Z", "type": "commit"}, {"oid": "f9cc7d2d82c36e62ea253071a1ec5ae29b4f1848", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f9cc7d2d82c36e62ea253071a1ec5ae29b4f1848", "message": "Merge branch 'azure-sdk-increment-package-version-servicebus-386162'", "committedDate": "2020-05-12T19:50:47Z", "type": "commit"}, {"oid": "3a4b16fd9cc42f7dbc5d746e81ffc8de94e55b6b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3a4b16fd9cc42f7dbc5d746e81ffc8de94e55b6b", "message": "merge master", "committedDate": "2020-05-13T00:26:33Z", "type": "commit"}, {"oid": "b67ac9b65651a41709584818e2c3417b6aed44ca", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b67ac9b65651a41709584818e2c3417b6aed44ca", "message": "Merge branch 'master' of github.com:hemanttanwar/azure-sdk-for-java", "committedDate": "2020-05-13T04:02:38Z", "type": "commit"}, {"oid": "510e76c7ffb58e006a09779558d7b01246f054a9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/510e76c7ffb58e006a09779558d7b01246f054a9", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-05-20T05:17:51Z", "type": "commit"}, {"oid": "663dac49d053f1cb7e6d0bb7664a551b68dab004", "url": "https://github.com/Azure/azure-sdk-for-java/commit/663dac49d053f1cb7e6d0bb7664a551b68dab004", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-05T21:43:35Z", "type": "commit"}, {"oid": "2962fabdb5ada06fba88a10c18091f9721eeb302", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2962fabdb5ada06fba88a10c18091f9721eeb302", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-08T04:37:42Z", "type": "commit"}, {"oid": "d418224ef3addb68105e241776d19e70aca32bd0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d418224ef3addb68105e241776d19e70aca32bd0", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-09T03:45:55Z", "type": "commit"}, {"oid": "6a9dc359ca5e3ba7b40fe71ab0fa2c33d0e5e91b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6a9dc359ca5e3ba7b40fe71ab0fa2c33d0e5e91b", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-09T21:00:31Z", "type": "commit"}, {"oid": "d0d0d88de524992f7e211400d2b8724691310817", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d0d0d88de524992f7e211400d2b8724691310817", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-10T04:36:54Z", "type": "commit"}, {"oid": "80bcfd7bb9cd94cb966e71532fb1b8c39831db32", "url": "https://github.com/Azure/azure-sdk-for-java/commit/80bcfd7bb9cd94cb966e71532fb1b8c39831db32", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-11T16:59:10Z", "type": "commit"}, {"oid": "136c66a13eacd2e49be05cef94879048c57115c9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/136c66a13eacd2e49be05cef94879048c57115c9", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-17T00:33:06Z", "type": "commit"}, {"oid": "ed8488ac12c07af9e1bab02403aa35b0de90456b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ed8488ac12c07af9e1bab02403aa35b0de90456b", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-18T00:32:39Z", "type": "commit"}, {"oid": "b7b39760a86078c74e1f07f309a27c0104d1fad7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b7b39760a86078c74e1f07f309a27c0104d1fad7", "message": "Keep topics separately to pollute other test", "committedDate": "2020-06-20T21:59:15Z", "type": "commit"}, {"oid": "34259f72e7fe2394122815db6e7258e3ee166c30", "url": "https://github.com/Azure/azure-sdk-for-java/commit/34259f72e7fe2394122815db6e7258e3ee166c30", "message": "Changing test to use new topic name", "committedDate": "2020-06-21T20:40:01Z", "type": "commit"}, {"oid": "0f0db6366aef53640c98022aa413451b220db88b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0f0db6366aef53640c98022aa413451b220db88b", "message": "Creating filter", "committedDate": "2020-06-22T22:32:38Z", "type": "commit"}, {"oid": "158179d90343acd7d6bb2b081af5dd0487268d73", "url": "https://github.com/Azure/azure-sdk-for-java/commit/158179d90343acd7d6bb2b081af5dd0487268d73", "message": "doing message cleanup", "committedDate": "2020-06-24T08:18:30Z", "type": "commit"}, {"oid": "874767a0ec4e8dbc72dce623ef701c96ff74c743", "url": "https://github.com/Azure/azure-sdk-for-java/commit/874767a0ec4e8dbc72dce623ef701c96ff74c743", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java", "committedDate": "2020-06-24T08:19:24Z", "type": "commit"}, {"oid": "e646baced168c351f81f3be8dc24d05265124c7a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e646baced168c351f81f3be8dc24d05265124c7a", "message": "Merge branch 'master' into sb-track2-some-livetest-failure-fixes-1", "committedDate": "2020-06-24T08:20:28Z", "type": "commit"}, {"oid": "a85b7098cc77f5407e383c38049e3e21a0ac1ac5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a85b7098cc77f5407e383c38049e3e21a0ac1ac5", "message": "improving live test", "committedDate": "2020-06-24T19:39:16Z", "type": "commit"}, {"oid": "c8551d10ee43c4835af662b79618016c93325f2f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c8551d10ee43c4835af662b79618016c93325f2f", "message": "improving live test", "committedDate": "2020-06-24T19:39:52Z", "type": "commit"}, {"oid": "fa3ca95af352cb1196120475c69f59001479c7c1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fa3ca95af352cb1196120475c69f59001479c7c1", "message": "Closing receiver in sender test", "committedDate": "2020-06-24T21:47:20Z", "type": "commit"}, {"oid": "b77c5e634648da659a780279296ddc7f873ec6ab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b77c5e634648da659a780279296ddc7f873ec6ab", "message": "Fix timeout in receive for single non rollover session in UnnamedSessionManager", "committedDate": "2020-06-25T19:03:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MDk4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r445780980", "bodyText": "Why not just an ArrayList? rather than an AtomicReference wrapping a list.", "author": "conniey", "createdAt": "2020-06-25T19:11:59Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -46,6 +46,7 @@\n class ServiceBusReceiverAsyncClientIntegrationTest extends IntegrationTestBase {\n     private final ClientLogger logger = new ClientLogger(ServiceBusReceiverAsyncClientIntegrationTest.class);\n     private final AtomicInteger messagesPending = new AtomicInteger();\n+    private final AtomicReference<List<Long>> messagesDeferredPending = new AtomicReference<>();", "originalCommit": "b77c5e634648da659a780279296ddc7f873ec6ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTY4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446365681", "bodyText": "Still unsure of why we are using an AtomicReference? Tests are run sequentially. Even then, why not a ConcurrentSet.", "author": "conniey", "createdAt": "2020-06-26T19:16:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MDk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MTE2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r445781160", "bodyText": "Clean up these messageIds.", "author": "conniey", "createdAt": "2020-06-25T19:12:17Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -117,7 +133,7 @@ void createTransactionAndRollbackMessagesTest(MessagingEntityType entityType) {\n         // Arrange\n         setSenderAndReceiver(entityType, 0, isSessionEnabled);\n \n-        final String messageId = UUID.randomUUID().toString();\n+        final String messageId = \"createTransactionAndRollbackMessagesTest\";UUID.randomUUID().toString();", "originalCommit": "b77c5e634648da659a780279296ddc7f873ec6ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MTU3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r445781574", "bodyText": "Doesn't this overlap with your pendingDeferredMessages member variable at the top?", "author": "conniey", "createdAt": "2020-06-25T19:12:58Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -988,4 +1023,12 @@ private int completeMessages(ServiceBusReceiverAsyncClient client, List<String>\n \n         return lockTokens.size();\n     }\n+\n+    private void completeDeferredMessages(ServiceBusReceiverAsyncClient client, ServiceBusReceivedMessage receivedMessage) {", "originalCommit": "b77c5e634648da659a780279296ddc7f873ec6ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM4MzM4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446383382", "bodyText": "It does not conflict, because in case of session the receiver has to be the same one which locked the session in first place.", "author": "hemanttanwar", "createdAt": "2020-06-26T19:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MTU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MjExNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r445782117", "bodyText": "This method is only used once. Why don't we roll in the functionality.", "author": "conniey", "createdAt": "2020-06-25T19:13:56Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/UnnamedSessionManagerIntegrationTest.java", "diffHunk": "@@ -92,10 +95,11 @@ void singleUnnamedSession(MessagingEntityType entityType) {\n                 .assertNext(context -> assertMessageEquals(sessionId, messageId, contents, context))\n                 .assertNext(context -> assertMessageEquals(sessionId, messageId, contents, context))\n                 .assertNext(context -> assertMessageEquals(sessionId, messageId, contents, context))\n-                .expectComplete()\n+                .thenCancel()\n                 .verify(Duration.ofMinutes(2));\n         } finally {\n             subscription.dispose();\n+            completeMessages(receiver, lockTokens, sessionId);", "originalCommit": "b77c5e634648da659a780279296ddc7f873ec6ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM4NDU1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446384556", "bodyText": "I think, it is cleaner and improve readability.", "author": "hemanttanwar", "createdAt": "2020-06-26T20:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MjExNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzMzI2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446433264", "bodyText": "I don't think so. Methods are reusable pieces of code.", "author": "conniey", "createdAt": "2020-06-26T22:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MjExNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzMzMzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446433337", "bodyText": "This is an extra 3 lines. or one statement. You don't even use the return value.", "author": "conniey", "createdAt": "2020-06-26T22:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc4MjExNw=="}], "type": "inlineReview"}, {"oid": "5de77b0144abb823d18b8fa5d8d5c6d5b32eac4b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5de77b0144abb823d18b8fa5d8d5c6d5b32eac4b", "message": "More debug for using credential test", "committedDate": "2020-06-25T21:19:06Z", "type": "commit"}, {"oid": "6b8f822951b61bf6c8e2502fb2d7faa46d0c1b93", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6b8f822951b61bf6c8e2502fb2d7faa46d0c1b93", "message": "More debug for using credential test", "committedDate": "2020-06-25T22:04:10Z", "type": "commit"}, {"oid": "b1fd71f1928ebd6be2e3433f9ee74667ee43dfab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b1fd71f1928ebd6be2e3433f9ee74667ee43dfab", "message": "More debug for using credential test", "committedDate": "2020-06-26T00:12:09Z", "type": "commit"}, {"oid": "012a41c208bf45bef8a1db640e00d998b6cf32d9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/012a41c208bf45bef8a1db640e00d998b6cf32d9", "message": "Assigned role for send and listen", "committedDate": "2020-06-26T07:15:43Z", "type": "commit"}, {"oid": "ad5023600468e9f4233aff08237c44443263239f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad5023600468e9f4233aff08237c44443263239f", "message": "more session related message clean up in integration test", "committedDate": "2020-06-26T18:25:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NDI2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446364265", "bodyText": "do we need the index parameter?", "author": "conniey", "createdAt": "2020-06-26T19:13:47Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/IntegrationTestBase.java", "diffHunk": "@@ -159,7 +154,7 @@ public String getTopicName() {\n      * @return Name of the first subscription.\n      */\n     public String getSubscriptionName(int index) {\n-        return getEntityName(getSubscriptionBaseName(), index);\n+        return getEntityName(getSubscriptionBaseName(), 0);", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NDM0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446364347", "bodyText": "Same with this. the index parameter is not used.", "author": "conniey", "createdAt": "2020-06-26T19:14:00Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/IntegrationTestBase.java", "diffHunk": "@@ -168,7 +163,7 @@ public String getSubscriptionName(int index) {\n      * @return Name of the first session-enabled subscription.\n      */\n     public String getSessionSubscriptionName(int index) {\n-        return getEntityName(getSessionSubscriptionBaseName(), index);\n+        return getEntityName(getSessionSubscriptionBaseName(), 0);", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NDU0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446364547", "bodyText": "Add back the documentation?", "author": "conniey", "createdAt": "2020-06-26T19:14:26Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/IntegrationTestBase.java", "diffHunk": "@@ -144,13 +144,8 @@ public String getSessionQueueName(int index) {\n         return getEntityName(getSessionQueueBaseName(), index);\n     }\n \n-    /**\n-     * Gets the name of the topic.\n-     *\n-     * @return Name of the topic.\n-     */\n-    public String getTopicName() {\n-        return TestUtils.getTopicName();\n+    public String getTopicName(int index) {", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTAxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446365014", "bodyText": "This is already fetched if you look at line 233.", "author": "conniey", "createdAt": "2020-06-26T19:15:27Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/IntegrationTestBase.java", "diffHunk": "@@ -233,12 +228,40 @@ protected ServiceBusClientBuilder getBuilder(boolean useCredentials) {\n             .transportType(AmqpTransportType.AMQP)\n             .scheduler(scheduler);\n \n+        logger.info(\"Getting Builder using credentials : [{}] \", useCredentials);\n         if (useCredentials) {\n             final String fullyQualifiedDomainName = getFullyQualifiedDomainName();\n \n             assumeTrue(fullyQualifiedDomainName != null && !fullyQualifiedDomainName.isEmpty(),\n                 \"AZURE_SERVICEBUS_FULLY_QUALIFIED_DOMAIN_NAME variable needs to be set when using credentials.\");\n+            String clientId = System.getenv(\"AZURE_CLIENT_ID\");\n+            String domainName = System.getenv(\"AZURE_SERVICEBUS_FULLY_QUALIFIED_DOMAIN_NAME\");", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MjYxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446392610", "bodyText": "This was for debugging in pipeline because It was working on my local but not in pipeline. I will remove this.", "author": "hemanttanwar", "createdAt": "2020-06-26T20:22:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTI0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446365243", "bodyText": "this is duplicated in subsequent lines 266.", "author": "conniey", "createdAt": "2020-06-26T19:16:01Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/IntegrationTestBase.java", "diffHunk": "@@ -233,12 +228,40 @@ protected ServiceBusClientBuilder getBuilder(boolean useCredentials) {\n             .transportType(AmqpTransportType.AMQP)\n             .scheduler(scheduler);\n \n+        logger.info(\"Getting Builder using credentials : [{}] \", useCredentials);\n         if (useCredentials) {\n             final String fullyQualifiedDomainName = getFullyQualifiedDomainName();\n \n             assumeTrue(fullyQualifiedDomainName != null && !fullyQualifiedDomainName.isEmpty(),\n                 \"AZURE_SERVICEBUS_FULLY_QUALIFIED_DOMAIN_NAME variable needs to be set when using credentials.\");\n+            String clientId = System.getenv(\"AZURE_CLIENT_ID\");", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTM3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446365371", "bodyText": "logging an error is not enough. the test should just fail with an assertNotNull", "author": "conniey", "createdAt": "2020-06-26T19:16:17Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/IntegrationTestBase.java", "diffHunk": "@@ -233,12 +228,40 @@ protected ServiceBusClientBuilder getBuilder(boolean useCredentials) {\n             .transportType(AmqpTransportType.AMQP)\n             .scheduler(scheduler);\n \n+        logger.info(\"Getting Builder using credentials : [{}] \", useCredentials);\n         if (useCredentials) {\n             final String fullyQualifiedDomainName = getFullyQualifiedDomainName();\n \n             assumeTrue(fullyQualifiedDomainName != null && !fullyQualifiedDomainName.isEmpty(),\n                 \"AZURE_SERVICEBUS_FULLY_QUALIFIED_DOMAIN_NAME variable needs to be set when using credentials.\");\n+            String clientId = System.getenv(\"AZURE_CLIENT_ID\");\n+            String domainName = System.getenv(\"AZURE_SERVICEBUS_FULLY_QUALIFIED_DOMAIN_NAME\");\n+            String clientSecret = System.getenv(\"AZURE_CLIENT_SECRET\");\n+            String tenantId = System.getenv(\"AZURE_TENANT_ID\");\n+\n+            if (domainName != null ) {\n+                logger.info(\"Getting Builder using credentials with domainName.length : [{}] \", domainName.length());\n+            } else {\n+                logger.error(\"Getting Builder using credentials domainName is null.\");", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MzA2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446393065", "bodyText": "I am removing it because  this was temporary , just for testing in pipeline.", "author": "hemanttanwar", "createdAt": "2020-06-26T20:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTk1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446365955", "bodyText": "format document. there should be a space.", "author": "conniey", "createdAt": "2020-06-26T19:17:32Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -63,26 +64,41 @@\n     @Override\n     protected void beforeTest() {\n         sessionId = UUID.randomUUID().toString();\n+        messagesDeferredPending.set(new ArrayList<>());\n     }\n \n     @Override\n     protected void afterTest() {\n         sharedBuilder =  null;\n         final int pending = messagesPending.get();\n-        if (pending < 1) {\n+        final int pendingDeferred = messagesDeferredPending.get().size();\n+        if (pending < 1 && pendingDeferred < 1) {\n             dispose(receiver, sender, receiveAndDeleteReceiver);\n             return;\n         }\n \n         // In the case that this test failed... we're going to drain the queue or subscription.\n         try {\n-            receiveAndDeleteReceiver.receive()\n-                .map(message -> {\n-                    logger.info(\"Message received: {}\", message.getMessage().getSequenceNumber());\n-                    return message;\n-                })\n-                .timeout(Duration.ofSeconds(15), Mono.empty())\n-                .blockLast();\n+            if (pending > 0) {\n+                receiveAndDeleteReceiver.receive()\n+                    .map(message -> {\n+                        logger.info(\"Message received: {}\", message.getMessage().getSequenceNumber());\n+                        return message;\n+                    })\n+                    .timeout(Duration.ofSeconds(15), Mono.empty())\n+                    .blockLast();\n+            }\n+            if (pendingDeferred > 0) {\n+                for(Long sequenceNumber: messagesDeferredPending.get()) {", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NjM2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446366368", "bodyText": "There should be a try-catch finally around each block. Even if the pending > 0 portion throws an exception, I would want messagesDeferrenedPending to still run.", "author": "conniey", "createdAt": "2020-06-26T19:18:25Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -63,26 +64,41 @@\n     @Override\n     protected void beforeTest() {\n         sessionId = UUID.randomUUID().toString();\n+        messagesDeferredPending.set(new ArrayList<>());\n     }\n \n     @Override\n     protected void afterTest() {\n         sharedBuilder =  null;\n         final int pending = messagesPending.get();\n-        if (pending < 1) {\n+        final int pendingDeferred = messagesDeferredPending.get().size();\n+        if (pending < 1 && pendingDeferred < 1) {\n             dispose(receiver, sender, receiveAndDeleteReceiver);\n             return;\n         }\n \n         // In the case that this test failed... we're going to drain the queue or subscription.\n         try {\n-            receiveAndDeleteReceiver.receive()\n-                .map(message -> {\n-                    logger.info(\"Message received: {}\", message.getMessage().getSequenceNumber());\n-                    return message;\n-                })\n-                .timeout(Duration.ofSeconds(15), Mono.empty())\n-                .blockLast();\n+            if (pending > 0) {\n+                receiveAndDeleteReceiver.receive()\n+                    .map(message -> {\n+                        logger.info(\"Message received: {}\", message.getMessage().getSequenceNumber());\n+                        return message;\n+                    })\n+                    .timeout(Duration.ofSeconds(15), Mono.empty())\n+                    .blockLast();\n+            }\n+            if (pendingDeferred > 0) {", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NjUwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446366501", "bodyText": "clean up", "author": "conniey", "createdAt": "2020-06-26T19:18:44Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -212,9 +228,9 @@ void transactionSendReceiveAndCommit(DispositionStatus dispositionStatus) {\n \n         // Arrange\n         final MessagingEntityType entityType = MessagingEntityType.QUEUE;\n-        setSenderAndReceiver(entityType, 0, isSessionEnabled);\n+        setSenderAndReceiver(entityType, TestUtils.USE_CASE_PEEK_TRANSACTION_SENDRECEIVE_AND_COMPLETE, isSessionEnabled);\n \n-        final String messageId1 = UUID.randomUUID().toString();\n+        final String messageId1 = \"transactionSendReceiveAndCommit\";//UUID.randomUUID().toString();", "originalCommit": "ad5023600468e9f4233aff08237c44443263239f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "203ff6dfeacccfae963f1befbd77aceb0ad2f917", "url": "https://github.com/Azure/azure-sdk-for-java/commit/203ff6dfeacccfae963f1befbd77aceb0ad2f917", "message": "incorporating review comments", "committedDate": "2020-06-26T20:26:56Z", "type": "commit"}, {"oid": "5cbcdc0be7e99977be6d7427b3fd12ea5327af42", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5cbcdc0be7e99977be6d7427b3fd12ea5327af42", "message": "incorporating review comments", "committedDate": "2020-06-26T21:59:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzMjIyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446432225", "bodyText": "Do we need this method? all it does is call into another method.", "author": "conniey", "createdAt": "2020-06-26T22:10:09Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/IntegrationTestBase.java", "diffHunk": "@@ -149,26 +149,26 @@ public String getSessionQueueName(int index) {\n      *\n      * @return Name of the topic.\n      */\n-    public String getTopicName() {\n-        return TestUtils.getTopicName();\n+    public String getTopicName(int index) {\n+        return getEntityName(TestUtils.getTopicBaseName(), index);\n     }\n \n     /**\n      * Gets the name of the first subscription.\n      *\n      * @return Name of the first subscription.\n      */\n-    public String getSubscriptionName(int index) {\n-        return getEntityName(getSubscriptionBaseName(), index);\n+    public String getSubscriptionName() {\n+        return getSubscriptionBaseName();\n     }\n \n     /**\n      * Gets the name of the first session-enabled subscription.\n      *\n      * @return Name of the first session-enabled subscription.\n      */\n-    public String getSessionSubscriptionName(int index) {\n-        return getEntityName(getSessionSubscriptionBaseName(), index);\n+    public String getSessionSubscriptionName() {", "originalCommit": "5cbcdc0be7e99977be6d7427b3fd12ea5327af42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzMjQxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446432418", "bodyText": "private final", "author": "conniey", "createdAt": "2020-06-26T22:10:48Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -47,6 +47,7 @@\n     private final ClientLogger logger = new ClientLogger(ServiceBusReceiverAsyncClientIntegrationTest.class);\n     private final AtomicInteger messagesPending = new AtomicInteger();\n \n+    private List<Long> messagesDeferredPending = new ArrayList<>();", "originalCommit": "5cbcdc0be7e99977be6d7427b3fd12ea5327af42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNTE0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446435142", "bodyText": "I need to initialize it everytime in beforeTest.", "author": "hemanttanwar", "createdAt": "2020-06-26T22:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzMjQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNjY3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446436674", "bodyText": "Why do we need an initialization here then? It'll be overwritten.", "author": "conniey", "createdAt": "2020-06-26T22:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzMjQxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzMzA1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446433058", "bodyText": "format document. there should be spaces.", "author": "conniey", "createdAt": "2020-06-26T22:13:13Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverClientIntegrationTest.java", "diffHunk": "@@ -827,4 +836,24 @@ private void sendMessage(ServiceBusMessage message) {\n         int number = messagesPending.incrementAndGet();\n         logger.info(\"Number sent: {}\", number);\n     }\n+\n+    private int completeMessages(ServiceBusReceiverClient client, int totalMessages) {\n+        final IterableStream<ServiceBusReceivedMessageContext> contextStream = client.receive(totalMessages, TIMEOUT);\n+        final List<ServiceBusReceivedMessageContext> asList = contextStream.stream().collect(Collectors.toList());\n+        for (ServiceBusReceivedMessageContext context:asList) {", "originalCommit": "5cbcdc0be7e99977be6d7427b3fd12ea5327af42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzMzY0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12374#discussion_r446433649", "bodyText": "nit: empty line.", "author": "conniey", "createdAt": "2020-06-26T22:15:32Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverClientIntegrationTest.java", "diffHunk": "@@ -827,4 +836,24 @@ private void sendMessage(ServiceBusMessage message) {\n         int number = messagesPending.incrementAndGet();\n         logger.info(\"Number sent: {}\", number);\n     }\n+\n+    private int completeMessages(ServiceBusReceiverClient client, int totalMessages) {\n+        final IterableStream<ServiceBusReceivedMessageContext> contextStream = client.receive(totalMessages, TIMEOUT);\n+        final List<ServiceBusReceivedMessageContext> asList = contextStream.stream().collect(Collectors.toList());\n+        for (ServiceBusReceivedMessageContext context:asList) {\n+            receiver.complete(context.getMessage());\n+        }\n+        return asList.size();\n+    }\n+\n+    private void completeDeferredMessages(ServiceBusReceiverClient client, ServiceBusReceivedMessage receivedMessage, boolean isSessionEnabled) {\n+        final ServiceBusReceivedMessage message;\n+        if (isSessionEnabled) {\n+            message = client.receiveDeferredMessage(receivedMessage.getSequenceNumber(), sessionId);\n+        } else {\n+            message = client.receiveDeferredMessage(receivedMessage.getSequenceNumber());\n+        }\n+        receiver.complete(message);\n+", "originalCommit": "5cbcdc0be7e99977be6d7427b3fd12ea5327af42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "01ca57e7574081fb45ecffc8a3192476bc734cf3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/01ca57e7574081fb45ecffc8a3192476bc734cf3", "message": "incorporating review comments", "committedDate": "2020-06-26T22:22:47Z", "type": "commit"}, {"oid": "be1870002782cd6a056e63ff7309b6d990d9d966", "url": "https://github.com/Azure/azure-sdk-for-java/commit/be1870002782cd6a056e63ff7309b6d990d9d966", "message": "incorporating review comments", "committedDate": "2020-06-26T22:31:55Z", "type": "commit"}]}