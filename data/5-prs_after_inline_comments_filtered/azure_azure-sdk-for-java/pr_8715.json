{"pr_number": 8715, "pr_title": "Add configuration for refresh token before expiry", "pr_createdAt": "2020-03-05T01:18:20Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/8715", "timeline": [{"oid": "510dc279aae807d472409eed82f89ff6e8e71659", "url": "https://github.com/Azure/azure-sdk-for-java/commit/510dc279aae807d472409eed82f89ff6e8e71659", "message": "Add configuration for refresh token before expiry", "committedDate": "2020-03-05T01:15:57Z", "type": "commit"}, {"oid": "1217579f5f1dcbaa2723d0d56560edce1ac6f1fa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1217579f5f1dcbaa2723d0d56560edce1ac6f1fa", "message": "Fix test utils in identity", "committedDate": "2020-03-05T01:17:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyODgyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388028826", "bodyText": "A better name suggestion is welcome", "author": "jianghaolu", "createdAt": "2020-03-05T01:18:48Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/CredentialBuilderBase.java", "diffHunk": "@@ -68,4 +68,17 @@ public T httpPipeline(HttpPipeline httpPipeline) {\n         this.identityClientOptions.setHttpPipeline(httpPipeline);\n         return (T) this;\n     }\n+\n+    /**\n+     * Sets the duration before the actual expiry of a token to refresh it.\n+     * This is useful when network is congested and a request containing the\n+     * token takes longer than normal to get to the server.\n+     *\n+     * @param refreshBeforeExpiry the duration before the actual expiry of a token to refresh it\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    public T setRefreshBeforeExpiry(Duration refreshBeforeExpiry) {", "originalCommit": "1217579f5f1dcbaa2723d0d56560edce1ac6f1fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA2MDU0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388060545", "bodyText": "How about `tokenRefreshOffset' or similar?", "author": "JonathanGiles", "createdAt": "2020-03-05T03:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyODgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzMTI5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388531296", "bodyText": "Using tokenRefreshOffset", "author": "jianghaolu", "createdAt": "2020-03-05T20:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyODgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyOTA4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388029087", "bodyText": "Default matches the 2 minutes in AccessToken: https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/core/azure-core/src/main/java/com/azure/core/credential/AccessToken.java#L22", "author": "jianghaolu", "createdAt": "2020-03-05T01:19:49Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClientOptions.java", "diffHunk": "@@ -21,6 +21,7 @@\n     private Function<Duration, Duration> retryTimeout;\n     private ProxyOptions proxyOptions;\n     private HttpPipeline httpPipeline;\n+    private Duration refreshBeforeExpiry = Duration.ofMinutes(2);", "originalCommit": "1217579f5f1dcbaa2723d0d56560edce1ac6f1fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyOTM3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388029374", "bodyText": "Reverts the minus 2 minutes in AccessToken: https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/core/azure-core/src/main/java/com/azure/core/credential/AccessToken.java#L22", "author": "jianghaolu", "createdAt": "2020-03-05T01:20:51Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/MsalToken.java", "diffHunk": "@@ -22,9 +22,10 @@\n      *\n      * @param msalResult the raw authentication result returned by MSAL\n      */\n-    public MsalToken(IAuthenticationResult msalResult) {\n-        super(msalResult.accessToken(), OffsetDateTime.ofInstant(msalResult.expiresOnDate().toInstant(),\n-            ZoneOffset.UTC));\n+    public MsalToken(IAuthenticationResult msalResult, IdentityClientOptions options) {\n+        super(msalResult.accessToken(), OffsetDateTime.ofInstant(\n+                msalResult.expiresOnDate().toInstant().minus(options.getRefreshBeforeExpiry()), ZoneOffset.UTC)\n+            .plusMinutes(2));", "originalCommit": "1217579f5f1dcbaa2723d0d56560edce1ac6f1fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA2NDkyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388064924", "bodyText": "I feel like we are spreading the two minute concept out throughout the code base. Can you have it as a private static final value that is referred to everywhere?", "author": "JonathanGiles", "createdAt": "2020-03-05T03:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyOTM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA2MDY0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388060646", "bodyText": "You should document what the default value is if it is not set.", "author": "JonathanGiles", "createdAt": "2020-03-05T03:27:17Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/CredentialBuilderBase.java", "diffHunk": "@@ -68,4 +68,17 @@ public T httpPipeline(HttpPipeline httpPipeline) {\n         this.identityClientOptions.setHttpPipeline(httpPipeline);\n         return (T) this;\n     }\n+\n+    /**\n+     * Sets the duration before the actual expiry of a token to refresh it.\n+     * This is useful when network is congested and a request containing the\n+     * token takes longer than normal to get to the server.", "originalCommit": "1217579f5f1dcbaa2723d0d56560edce1ac6f1fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzMTcwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388531701", "bodyText": "Documented.", "author": "jianghaolu", "createdAt": "2020-03-05T20:02:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA2MDY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA2NDcxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388064719", "bodyText": "There is duplicate code here and above for creating the AccessToken, which is a possible source of bugs in the future if they are not kept in sync. Consider creating a method to centralise it.", "author": "JonathanGiles", "createdAt": "2020-03-05T03:46:55Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -403,7 +401,9 @@\n                             .useDelimiter(\"\\\\A\");\n                     String result = s.hasNext() ? s.next() : \"\";\n \n-                    return SERIALIZER_ADAPTER.<MSIToken>deserialize(result, MSIToken.class, SerializerEncoding.JSON);\n+                    MSIToken msiToken = SERIALIZER_ADAPTER.<MSIToken>deserialize(result, MSIToken.class, SerializerEncoding.JSON);\n+                    return new AccessToken(msiToken.getToken(),\n+                            msiToken.getExpiresAt().plusMinutes(2).minus(options.getRefreshBeforeExpiry()));", "originalCommit": "1217579f5f1dcbaa2723d0d56560edce1ac6f1fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzMTQ3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388531476", "bodyText": "Moved to a common base class IdentityToken", "author": "jianghaolu", "createdAt": "2020-03-05T20:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA2NDcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA3NDc2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388074767", "bodyText": "This adjustment of expires time looks good to me, but I have a question on when should we acquire the token from MSI endpoint. This method seems to retrieve the token as soon as it is called. Let's say it is called at 1 pm so token acquired at 1.00 pm, now let's caller subscribed to the returned Mono at 1.10 pm, now caller is served with 10 min old token. Should we delay the token acquisition until the caller subscribes to the returned mono? (I mean putting the entire acquisition logic in Mono.defer).", "author": "anuchandy", "createdAt": "2020-03-05T04:39:16Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -350,7 +346,9 @@\n             Scanner s = new Scanner(connection.getInputStream(), StandardCharsets.UTF_8.name()).useDelimiter(\"\\\\A\");\n             String result = s.hasNext() ? s.next() : \"\";\n \n-            return Mono.just(SERIALIZER_ADAPTER.deserialize(result, MSIToken.class, SerializerEncoding.JSON));\n+            MSIToken msiToken = SERIALIZER_ADAPTER.deserialize(result, MSIToken.class, SerializerEncoding.JSON);\n+            return Mono.just(new AccessToken(msiToken.getToken(),\n+                    msiToken.getExpiresAt().plusMinutes(2).minus(options.getRefreshBeforeExpiry())));", "originalCommit": "1217579f5f1dcbaa2723d0d56560edce1ac6f1fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA3NTI4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r388075289", "bodyText": "yes I can move it inside a Mono.defer.", "author": "jianghaolu", "createdAt": "2020-03-05T04:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA3NDc2Nw=="}], "type": "inlineReview"}, {"oid": "a934984f22895336c51fbe443c69443ee1494353", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a934984f22895336c51fbe443c69443ee1494353", "message": "Address feedback", "committedDate": "2020-03-05T19:56:05Z", "type": "commit"}, {"oid": "3e0664454f86a2cc762bf6ce5dfbdc0ef0f6c53c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3e0664454f86a2cc762bf6ce5dfbdc0ef0f6c53c", "message": "Builder style setter", "committedDate": "2020-03-05T20:00:00Z", "type": "commit"}, {"oid": "dc7bf1d7495b77d8cc6ef3fa90de835e62136afa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dc7bf1d7495b77d8cc6ef3fa90de835e62136afa", "message": "Merge branch 'master' of github.com:Azure/azure-sdk-for-java into refreshbeforeexpiry", "committedDate": "2020-03-05T22:40:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA1MTQ1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r389051453", "bodyText": "nit; null check.", "author": "anuchandy", "createdAt": "2020-03-06T17:50:14Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClientOptions.java", "diffHunk": "@@ -125,6 +126,29 @@ public IdentityClientOptions setHttpPipeline(HttpPipeline httpPipeline) {\n         return this;\n     }\n \n+    /**\n+<<<<<<< HEAD\n+     * @return how long before the actual token expiry to refresh the token.\n+     */\n+    public Duration getTokenRefreshOffset() {\n+        return tokenRefreshOffset;\n+    }\n+\n+    /**\n+     * Sets how long before the actual token expiry to refresh the token. The\n+     * token will be considered expired at and after the time of (actual\n+     * expiry - token refresh offset). The default offset is 2 minutes.\n+     *\n+     * This is useful when network is congested and a request containing the\n+     * token takes longer than normal to get to the server.\n+     *\n+     * @param tokenRefreshOffset the duration before the actual expiry of a token to refresh it\n+     */\n+    public IdentityClientOptions setTokenRefreshOffset(Duration tokenRefreshOffset) {\n+        this.tokenRefreshOffset = tokenRefreshOffset;", "originalCommit": "dc7bf1d7495b77d8cc6ef3fa90de835e62136afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTEzMDU1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r389130551", "bodyText": "Added a nullcheck", "author": "jianghaolu", "createdAt": "2020-03-06T20:35:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA1MTQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA1MTUyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r389051523", "bodyText": "nit; <<<<<<< HEAD from conflict resoln.", "author": "anuchandy", "createdAt": "2020-03-06T17:50:23Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClientOptions.java", "diffHunk": "@@ -125,6 +126,29 @@ public IdentityClientOptions setHttpPipeline(HttpPipeline httpPipeline) {\n         return this;\n     }\n \n+    /**\n+<<<<<<< HEAD", "originalCommit": "dc7bf1d7495b77d8cc6ef3fa90de835e62136afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTEzMDM5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r389130398", "bodyText": "Removed.", "author": "jianghaolu", "createdAt": "2020-03-06T20:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA1MTUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA1Mjk5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r389052994", "bodyText": "nit; Object.requireNonNull checks.", "author": "anuchandy", "createdAt": "2020-03-06T17:53:30Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityToken.java", "diffHunk": "@@ -0,0 +1,24 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation;\n+\n+import com.azure.core.credential.AccessToken;\n+\n+import java.time.OffsetDateTime;\n+\n+/**\n+ * Type representing authentication result from the azure-identity client.\n+ */\n+public class IdentityToken extends AccessToken {\n+    /**\n+     * Creates an identity token instance.\n+     *\n+     * @param token the token string.\n+     * @param expiresAt the expiration time.\n+     * @param options the identity client options.\n+     */\n+    public IdentityToken(String token, OffsetDateTime expiresAt, IdentityClientOptions options) {\n+        super(token, expiresAt.plusMinutes(2).minus(options.getTokenRefreshOffset()));", "originalCommit": "dc7bf1d7495b77d8cc6ef3fa90de835e62136afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTEyNjI2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8715#discussion_r389126268", "bodyText": "discussed with Jinaghao offline, these are impl classes and these values are derived from service returned response. Hence we don't have to check here given we shouldn't test service behavior.", "author": "anuchandy", "createdAt": "2020-03-06T20:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA1Mjk5NA=="}], "type": "inlineReview"}, {"oid": "07a5ce9c0ae694d1e9bf34bfd90ce6527a28aec0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/07a5ce9c0ae694d1e9bf34bfd90ce6527a28aec0", "message": "Add tests and address feedback", "committedDate": "2020-03-06T20:24:01Z", "type": "commit"}]}