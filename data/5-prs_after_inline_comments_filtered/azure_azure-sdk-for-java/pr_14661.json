{"pr_number": 14661, "pr_title": "Query annotation support", "pr_createdAt": "2020-08-31T20:01:58Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14661", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgzNDg3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481834872", "bodyText": "Do we need .publishOn(Schedulers.parallel()) here?", "author": "chenrujun", "createdAt": "2020-09-02T07:33:40Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/core/ReactiveCosmosTemplate.java", "diffHunk": "@@ -578,6 +578,25 @@ public MappingCosmosConverter getConverter() {\n         return mappingCosmosConverter;\n     }\n \n+    @Override\n+    public <T> Flux<T> runQuery(SqlQuerySpec querySpec, Class<?> domainType, Class<T> returnType) {\n+        String containerName = domainType.getSimpleName();\n+        CosmosQueryRequestOptions options = new CosmosQueryRequestOptions();\n+        return cosmosAsyncClient.getDatabase(this.databaseName)\n+                   .getContainer(containerName)\n+                   .queryItems(querySpec, options, returnType)\n+                   .byPage()", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NDc1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482774755", "bodyText": "We are not doing much there on the thread, but added a Scheduler", "author": "mbhaskar", "createdAt": "2020-09-03T07:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgzNDg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg0MTg0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481841843", "bodyText": "Do we need @Override in before line 38?", "author": "chenrujun", "createdAt": "2020-09-02T07:41:51Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/AbstractReactiveCosmosQuery.java", "diffHunk": "@@ -15,7 +15,7 @@\n public abstract class AbstractReactiveCosmosQuery implements RepositoryQuery {\n \n     private final ReactiveCosmosQueryMethod method;\n-    private final ReactiveCosmosOperations operations;\n+    protected final ReactiveCosmosOperations operations;", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NTU0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482775546", "bodyText": "Yes, it should be there. Its a good practice to annotate ovverriden methods. Generally I would prefer not to touch areas beyond the ones specific to current changes, but added override in this case", "author": "mbhaskar", "createdAt": "2020-09-03T07:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg0MTg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NjE0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481876141", "bodyText": "The following code will look better:\nreturn (Optional<A>) this.annotationCache.computeIfAbsent(\n    annotationType,\n    type -> Optional.ofNullable(AnnotatedElementUtils.findMergedAnnotation(method, type))\n);", "author": "chenrujun", "createdAt": "2020-09-02T08:20:57Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -39,4 +51,42 @@ public CosmosQueryMethod(Method method, RepositoryMetadata metadata, ProjectionF\n         this.metadata = new SimpleCosmosEntityMetadata<Object>(domainType, entityInformation);\n         return this.metadata;\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Returns the query string declared in a {@link Query} annotation or {@literal null} if neither the annotation\n+     * found\n+     * nor the attribute was specified.\n+     *\n+     * @return the query string or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotation() {\n+        return findAnnotatedQuery().orElse(null);\n+    }\n+\n+    private Optional<String> findAnnotatedQuery() {\n+\n+        return lookupQueryAnnotation()\n+                   .map(Query::value)\n+                   .filter(StringUtils::hasText);\n+    }\n+\n+    Optional<Query> lookupQueryAnnotation() {\n+        return doFindAnnotation(Query.class);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <A extends Annotation> Optional<A> doFindAnnotation(Class<A> annotationType) {\n+        return (Optional<A>) this.annotationCache\n+                                 .computeIfAbsent(annotationType, it -> Optional.ofNullable(AnnotatedElementUtils\n+                                                                                .findMergedAnnotation(method, it)));", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4MjIyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481882225", "bodyText": "The parameter annotationType is always Query.class, can we remove the parameter?\nFurther more, can we delete annotationCache and method, just use the following field instead:\nprivate final String annotatedQuery;\n\nInitialize annotatedQuery in constructor.", "author": "chenrujun", "createdAt": "2020-09-02T08:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NjE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NjQ4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482776489", "bodyText": "Annotation cache would improve performance. Also, I got this idea from existing annotation spring data implementations, so I believe its good to have.", "author": "mbhaskar", "createdAt": "2020-09-03T07:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NjE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5MTQ2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r483391467", "bodyText": "Annotation cache would improve performance.\n\nIMU, even if we need cache the Annotation, we should set method as key, not annotationType as key.\n\nI got this idea from existing annotation spring data implementations\n\nCould you please share the link to related code?", "author": "chenrujun", "createdAt": "2020-09-04T05:15:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NjE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1ODA4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r483458081", "bodyText": "As discussed offline, cleaned it up!", "author": "mbhaskar", "createdAt": "2020-09-04T08:07:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NjE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4MzM2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481883364", "bodyText": "Same to CosmosQueryMethod.", "author": "chenrujun", "createdAt": "2020-09-02T08:28:42Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/ReactiveCosmosQueryMethod.java", "diffHunk": "@@ -56,4 +66,41 @@ public ReactiveCosmosQueryMethod(Method method, RepositoryMetadata metadata, Pro\n     private static boolean isReactiveWrapperClass(Class<?> clazz) {\n         return clazz.equals(Flux.class) || clazz.equals(Mono.class);\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Gets the annotated query or returns null\n+     * @return the annotated query String or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotatation() {\n+        return findAnnotatedQuery().orElse(null);\n+    }\n+\n+    private Optional<String> findAnnotatedQuery() {\n+\n+        return lookupQueryAnnotation()\n+                   .map(Query::value)\n+                   .filter(StringUtils::hasText);\n+    }\n+\n+    Optional<Query> lookupQueryAnnotation() {\n+        return doFindAnnotation(Query.class);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <A extends Annotation> Optional<A> doFindAnnotation(Class<A> annotationType) {\n+\n+        return (Optional<A>) this.annotationCache\n+                                 .computeIfAbsent(annotationType, it -> Optional.ofNullable(AnnotatedElementUtils\n+                                                                                .findMergedAnnotation(method, it)));", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NjU0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482776547", "bodyText": "Annotation cache would improve performance. Also, I got this idea from existing annotation spring data implementations, so I believe its good to have.", "author": "mbhaskar", "createdAt": "2020-09-03T07:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4MzM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1ODMwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r483458306", "bodyText": "As discussed offline, cleaned it up", "author": "mbhaskar", "createdAt": "2020-09-04T08:08:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4MzM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4ODA5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481888090", "bodyText": "Use getAnnotatedQuery instead of getQueryAnnotation.", "author": "chenrujun", "createdAt": "2020-09-02T08:33:52Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -39,4 +51,42 @@ public CosmosQueryMethod(Method method, RepositoryMetadata metadata, ProjectionF\n         this.metadata = new SimpleCosmosEntityMetadata<Object>(domainType, entityInformation);\n         return this.metadata;\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Returns the query string declared in a {@link Query} annotation or {@literal null} if neither the annotation\n+     * found\n+     * nor the attribute was specified.\n+     *\n+     * @return the query string or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotation() {", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3Njg0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482776847", "bodyText": "We are getting the query annotation here, so IMHO getQueryAnnotation would make more sense.", "author": "mbhaskar", "createdAt": "2020-09-03T07:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4ODA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5MTc3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r483391776", "bodyText": "But the return value is String, not Annotation.", "author": "chenrujun", "createdAt": "2020-09-04T05:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4ODA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5NTg4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r483395884", "bodyText": "Yes the string value of the annotation.", "author": "mbhaskar", "createdAt": "2020-09-04T05:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4ODA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5ODE3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481898171", "bodyText": "Use p.getName().orElse(\"\") instead of p.getName().get() to avoid NPE.", "author": "chenrujun", "createdAt": "2020-09-02T08:45:03Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/StringBasedCosmosQuery.java", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.spring.data.cosmos.repository.support;\n+\n+import com.azure.cosmos.models.SqlParameter;\n+import com.azure.cosmos.models.SqlQuerySpec;\n+import com.azure.spring.data.cosmos.core.CosmosOperations;\n+import com.azure.spring.data.cosmos.core.query.CosmosQuery;\n+import com.azure.spring.data.cosmos.repository.query.AbstractCosmosQuery;\n+import com.azure.spring.data.cosmos.repository.query.CosmosParameterAccessor;\n+import com.azure.spring.data.cosmos.repository.query.CosmosParameterParameterAccessor;\n+import com.azure.spring.data.cosmos.repository.query.CosmosQueryMethod;\n+import org.springframework.data.repository.query.ResultProcessor;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter.toCosmosDbValue;\n+\n+/**\n+ * Cosmos query class to handle the annotated queries. This overrides the execution and runs the query directly\n+ */\n+public class StringBasedCosmosQuery extends AbstractCosmosQuery {\n+    private final String query;\n+\n+    /**\n+     * Constructor\n+     * @param queryMethod the CosmosQueryMethod\n+     * @param dbOperations the CosmosOperations\n+     */\n+    public StringBasedCosmosQuery(CosmosQueryMethod queryMethod, CosmosOperations dbOperations) {\n+        super(queryMethod, dbOperations);\n+        this.query = queryMethod.getQueryAnnotation();\n+    }\n+\n+    @Override\n+    protected CosmosQuery createQuery(CosmosParameterAccessor accessor) {\n+        return null;\n+    }\n+\n+    @Override\n+    public Object execute(final Object[] parameters) {\n+        final CosmosParameterAccessor accessor = new CosmosParameterParameterAccessor(getQueryMethod(), parameters);\n+        final ResultProcessor processor = getQueryMethod().getResultProcessor().withDynamicProjection(accessor);\n+\n+        List<SqlParameter> sqlParameters = getQueryMethod().getParameters().stream()\n+                            .map(p -> new SqlParameter(\"@\" + p.getName().get(),", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3Njg5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482776895", "bodyText": "Done", "author": "mbhaskar", "createdAt": "2020-09-03T07:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5ODE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5ODMwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481898305", "bodyText": "Use p.getName().orElse(\"\") instead of p.getName().get() to avoid NPE.", "author": "chenrujun", "createdAt": "2020-09-02T08:45:12Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/StringBasedReactiveCosmosQuery.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.spring.data.cosmos.repository.support;\n+\n+import com.azure.cosmos.models.SqlParameter;\n+import com.azure.cosmos.models.SqlQuerySpec;\n+import com.azure.spring.data.cosmos.core.ReactiveCosmosOperations;\n+import com.azure.spring.data.cosmos.core.query.CosmosQuery;\n+import com.azure.spring.data.cosmos.repository.query.AbstractReactiveCosmosQuery;\n+import com.azure.spring.data.cosmos.repository.query.ReactiveCosmosParameterAccessor;\n+import com.azure.spring.data.cosmos.repository.query.ReactiveCosmosParameterParameterAccessor;\n+import com.azure.spring.data.cosmos.repository.query.ReactiveCosmosQueryMethod;\n+import org.springframework.data.repository.query.ResultProcessor;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter.toCosmosDbValue;\n+\n+/**\n+ * Cosmos query class to handle the annotated queries. This overrides the execution and runs the query directly\n+ */\n+public class StringBasedReactiveCosmosQuery extends AbstractReactiveCosmosQuery {\n+    private final String query;\n+\n+    /**\n+     * Constructor\n+     * @param queryMethod the query method\n+     * @param dbOperations the reactive cosmos operations\n+     */\n+    public StringBasedReactiveCosmosQuery(ReactiveCosmosQueryMethod queryMethod,\n+                                          ReactiveCosmosOperations dbOperations) {\n+        super(queryMethod, dbOperations);\n+        this.query = queryMethod.getQueryAnnotatation();\n+    }\n+\n+    @Override\n+    protected CosmosQuery createQuery(ReactiveCosmosParameterAccessor accessor) {\n+        return null;\n+    }\n+\n+    @Override\n+    public Object execute(final Object[] parameters) {\n+        final ReactiveCosmosParameterAccessor accessor = new ReactiveCosmosParameterParameterAccessor(getQueryMethod(),\n+                                                                                              parameters);\n+        final ResultProcessor processor = getQueryMethod().getResultProcessor().withDynamicProjection(accessor);\n+\n+        List<SqlParameter> sqlParameters = getQueryMethod().getParameters().stream()\n+                            .map(p -> new SqlParameter(\"@\" + p.getName().get(),", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NjkzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482776938", "bodyText": "done", "author": "mbhaskar", "createdAt": "2020-09-03T07:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5ODMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwMTgwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481901800", "bodyText": "Rename status to active.", "author": "chenrujun", "createdAt": "2020-09-02T08:48:58Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/domain/Contact.java", "diffHunk": "@@ -14,6 +14,10 @@\n \n     private String title;\n \n+    private int intValue;\n+\n+    private boolean status;", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3Njk5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482776999", "bodyText": "changed to isActive.", "author": "mbhaskar", "createdAt": "2020-09-03T07:48:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwMTgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNzAyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481907021", "bodyText": "getContactsByTitleAndValue", "author": "chenrujun", "createdAt": "2020-09-02T08:54:35Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ContactRepository.java", "diffHunk": "@@ -17,4 +21,17 @@\n     Contact findOneByTitle(String title);\n \n     Optional<Contact> findOptionallyByTitle(String title);\n+\n+    @Query(value = \"select * from c where c.title = @title and c.intValue = @value\")\n+    List<Contact> contactWithValueTitle(@Param(\"value\") int value, @Param(\"title\") String name);", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NzczNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482777734", "bodyText": "Done.\n(I wanted name to not be mistaken for derived queries and want to showcase that name doesn't matter when you have a query annotation)", "author": "mbhaskar", "createdAt": "2020-09-03T07:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNzAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwODQxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481908410", "bodyText": "getContactsWithOffsetAndLimit", "author": "chenrujun", "createdAt": "2020-09-02T08:56:04Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ContactRepository.java", "diffHunk": "@@ -17,4 +21,17 @@\n     Contact findOneByTitle(String title);\n \n     Optional<Contact> findOptionallyByTitle(String title);\n+\n+    @Query(value = \"select * from c where c.title = @title and c.intValue = @value\")\n+    List<Contact> contactWithValueTitle(@Param(\"value\") int value, @Param(\"title\") String name);\n+\n+    @Query(value = \"select * from c offset @offset limit @limit\")\n+    List<Contact> contactsWithOffsetLimit(@Param(\"offset\") int offset, @Param(\"limit\") int limit);", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3Nzc3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482777774", "bodyText": "Done", "author": "mbhaskar", "createdAt": "2020-09-03T07:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwODQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwOTQ2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481909460", "bodyText": "Rename num_ids to id_count", "author": "chenrujun", "createdAt": "2020-09-02T08:57:04Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ContactRepository.java", "diffHunk": "@@ -17,4 +21,17 @@\n     Contact findOneByTitle(String title);\n \n     Optional<Contact> findOptionallyByTitle(String title);\n+\n+    @Query(value = \"select * from c where c.title = @title and c.intValue = @value\")\n+    List<Contact> contactWithValueTitle(@Param(\"value\") int value, @Param(\"title\") String name);\n+\n+    @Query(value = \"select * from c offset @offset limit @limit\")\n+    List<Contact> contactsWithOffsetLimit(@Param(\"offset\") int offset, @Param(\"limit\") int limit);\n+\n+    @Query(value = \"select * from c where c.status= true\")\n+    List<Contact> findActiveContacts();\n+\n+    @Query(value = \"SELECT count(c.id) as num_ids, c.intValue FROM c group by c.intValue\")", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NzgzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482777833", "bodyText": "Done", "author": "mbhaskar", "createdAt": "2020-09-03T07:50:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwOTQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjEwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481916106", "bodyText": "To make test code easier to read, could you please:\n\nDelete Contact.Contact() and Contact.Contact(String logicId, String title), only keep Contact(final String logicId, final String title, final int intValue, boolean status).\nDelete all contects create in unit tests, define them as static field, just like TEST_CONTACT1 to TEST_CONTACT5", "author": "chenrujun", "createdAt": "2020-09-02T09:04:33Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/ContactRepositoryIT.java", "diffHunk": "@@ -33,7 +35,11 @@\n @ContextConfiguration(classes = TestRepositoryConfig.class)\n public class ContactRepositoryIT {\n \n-    private static final Contact TEST_CONTACT = new Contact(\"testId\", \"faketitle\");\n+    private static final Contact TEST_CONTACT = new Contact(\"testId\", \"faketitle\", 25, true);\n+    private static final Contact TEST_CONTACT2 = new Contact(\"testId2\", \"faketitle2\",  32, false);\n+    private static final Contact TEST_CONTACT3 = new Contact(\"testId3\", \"faketitle3\", 25, false);\n+    private static final Contact TEST_CONTACT4 = new Contact(\"testId4\", \"faketitle4\", 43, true);\n+    private static final Contact TEST_CONTACT5 = new Contact(\"testId5\", \"faketitle3\", 43, true);", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3ODI0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482778248", "bodyText": "Again, wan to keep the changes minimal and relevant to query annotation in this PR. I can clean the other tests in another PR", "author": "mbhaskar", "createdAt": "2020-09-03T07:50:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5MjEzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r483392133", "bodyText": "OK, Thank you. Please create an issue, and put a link here.", "author": "chenrujun", "createdAt": "2020-09-04T05:18:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5NzA5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r483397091", "bodyText": "#14828", "author": "mbhaskar", "createdAt": "2020-09-04T05:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjI5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481916297", "bodyText": "Rename to TEST_CONTACT1.", "author": "chenrujun", "createdAt": "2020-09-02T09:04:48Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/ContactRepositoryIT.java", "diffHunk": "@@ -33,7 +35,11 @@\n @ContextConfiguration(classes = TestRepositoryConfig.class)\n public class ContactRepositoryIT {\n \n-    private static final Contact TEST_CONTACT = new Contact(\"testId\", \"faketitle\");\n+    private static final Contact TEST_CONTACT = new Contact(\"testId\", \"faketitle\", 25, true);", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3ODI4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482778280", "bodyText": "Done", "author": "mbhaskar", "createdAt": "2020-09-03T07:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxOTExMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481919113", "bodyText": "getCoursesByNameAndDepartment", "author": "chenrujun", "createdAt": "2020-09-02T09:08:01Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ReactiveCourseRepository.java", "diffHunk": "@@ -43,4 +46,10 @@\n      */\n     Mono<Course> findOneByName(String name);\n \n+    @Query(value = \"select * from c where c.name = @name and c.department = @department\")\n+    Flux<Course> coursesWithNameDepartment(@Param(\"name\") String name, @Param(\"department\") String department);", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3ODM2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482778369", "bodyText": "Done", "author": "mbhaskar", "createdAt": "2020-09-03T07:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxOTExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxOTUyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481919520", "bodyText": "getCoursesGroupByDepartment.", "author": "chenrujun", "createdAt": "2020-09-02T09:08:31Z", "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ReactiveCourseRepository.java", "diffHunk": "@@ -43,4 +46,10 @@\n      */\n     Mono<Course> findOneByName(String name);\n \n+    @Query(value = \"select * from c where c.name = @name and c.department = @department\")\n+    Flux<Course> coursesWithNameDepartment(@Param(\"name\") String name, @Param(\"department\") String department);\n+\n+    @Query(value = \"select count(c.id) as num_ids, c.department from c group by c.department\")\n+    Flux<ObjectNode> coursesGroupBy();", "originalCommit": "9c8897c86cac147ac46118be15b47859528c8f26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4MTYwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r482781600", "bodyText": "Done", "author": "mbhaskar", "createdAt": "2020-09-03T07:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxOTUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE1NjAyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484156029", "bodyText": "Can we just delete field method, use stringInQueryAnnotation instead?", "author": "chenrujun", "createdAt": "2020-09-07T02:40:17Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -27,6 +33,7 @@\n      */\n     public CosmosQueryMethod(Method method, RepositoryMetadata metadata, ProjectionFactory factory) {\n         super(method, metadata, factory);\n+        this.method = method;", "originalCommit": "82bc456d19c71b49e4a01db3850622ed2560a12e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2MjQxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484262414", "bodyText": "Refactored", "author": "mbhaskar", "createdAt": "2020-09-07T08:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE1NjAyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE1NjM5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484156392", "bodyText": "Same here, we can use a field stringInQueryAnnotation  instead of calculate it  every time.", "author": "chenrujun", "createdAt": "2020-09-07T02:42:15Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/ReactiveCosmosQueryMethod.java", "diffHunk": "@@ -56,4 +61,33 @@ public ReactiveCosmosQueryMethod(Method method, RepositoryMetadata metadata, Pro\n     private static boolean isReactiveWrapperClass(Class<?> clazz) {\n         return clazz.equals(Flux.class) || clazz.equals(Mono.class);\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Gets the annotated query or returns null\n+     * @return the annotated query String or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotation() {\n+        return findAnnotatedQuery().orElse(null);\n+    }\n+\n+    private Optional<String> findAnnotatedQuery() {\n+\n+        return lookupQueryAnnotation()\n+                   .map(Query::value)\n+                   .filter(StringUtils::hasText);", "originalCommit": "82bc456d19c71b49e4a01db3850622ed2560a12e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2MjQ5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484262491", "bodyText": "Refactored", "author": "mbhaskar", "createdAt": "2020-09-07T08:08:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE1NjM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2Mzc1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484263753", "bodyText": "Can we just delete method findAnnotatedQuery, and write the code directory in constructor?", "author": "chenrujun", "createdAt": "2020-09-07T08:10:46Z", "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -64,18 +65,13 @@ public boolean hasAnnotatedQuery() {\n      */\n     @Nullable\n     public String getQueryAnnotation() {\n-        return findAnnotatedQuery().orElse(null);\n+        return annotatedQueryValue;\n     }\n \n-    private Optional<String> findAnnotatedQuery() {\n-\n-        return lookupQueryAnnotation()\n+    private Optional<String> findAnnotatedQuery(Method method) {", "originalCommit": "4722fbe0672a3cf6d6f03a197a78aa57a7a5feea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2NTQ2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484265466", "bodyText": "Good to have it in a function to keep the constructor clean", "author": "mbhaskar", "createdAt": "2020-09-07T08:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2Mzc1Mw=="}], "type": "inlineReview"}, {"oid": "a8a1360f997447e670b9823eae75df781a521c2b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a8a1360f997447e670b9823eae75df781a521c2b", "message": "This PR adds support for query annotations. This enables end users to add annotated queries to their repositories using @Query(value = \"<query>\") which opens up all the query capabilities of underlying cosmos java sdk to the cosmos spring driver.", "committedDate": "2020-09-09T04:35:43Z", "type": "commit"}, {"oid": "30adff1a4e4614cc95901e70ce9d79214659e75e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/30adff1a4e4614cc95901e70ce9d79214659e75e", "message": "Test fixes.", "committedDate": "2020-09-09T04:35:43Z", "type": "commit"}, {"oid": "302a152a450d279099e96b10ada0191c09b760b9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/302a152a450d279099e96b10ada0191c09b760b9", "message": "Test fixes.", "committedDate": "2020-09-09T04:35:44Z", "type": "commit"}, {"oid": "83353a6cd2497de81d476fe5f6d801ef3b068bee", "url": "https://github.com/Azure/azure-sdk-for-java/commit/83353a6cd2497de81d476fe5f6d801ef3b068bee", "message": "spotbug fix", "committedDate": "2020-09-09T04:35:44Z", "type": "commit"}, {"oid": "95db49a8716f7717435a9fae73282cf3a1730c0d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/95db49a8716f7717435a9fae73282cf3a1730c0d", "message": "checkstyle fix", "committedDate": "2020-09-09T04:35:44Z", "type": "commit"}, {"oid": "57e4075054446fca04aced7b16e67684618fff43", "url": "https://github.com/Azure/azure-sdk-for-java/commit/57e4075054446fca04aced7b16e67684618fff43", "message": "Implementing PR comments", "committedDate": "2020-09-09T04:35:44Z", "type": "commit"}, {"oid": "3b0818bac0e09f6650ff48a3aaaf5aa35e4586c9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3b0818bac0e09f6650ff48a3aaaf5aa35e4586c9", "message": "Implementing PR comments", "committedDate": "2020-09-09T04:35:44Z", "type": "commit"}, {"oid": "158e08a74541fddeb78f8836abfbbe5cd1fdafa1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/158e08a74541fddeb78f8836abfbbe5cd1fdafa1", "message": "checkstyle fix", "committedDate": "2020-09-09T04:35:44Z", "type": "commit"}, {"oid": "0888f19a33169d8220a9862d2e14ba60eeb1996c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0888f19a33169d8220a9862d2e14ba60eeb1996c", "message": "Refactoring couple of methods", "committedDate": "2020-09-09T04:35:45Z", "type": "commit"}, {"oid": "0888f19a33169d8220a9862d2e14ba60eeb1996c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0888f19a33169d8220a9862d2e14ba60eeb1996c", "message": "Refactoring couple of methods", "committedDate": "2020-09-09T04:35:45Z", "type": "forcePushed"}]}