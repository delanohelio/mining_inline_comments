{"pr_number": 9335, "pr_title": "receive deferred  message feature", "pr_createdAt": "2020-03-20T20:21:02Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9335", "timeline": [{"oid": "260eb46e8b29c854a07cfb2d6da5455f55799072", "url": "https://github.com/Azure/azure-sdk-for-java/commit/260eb46e8b29c854a07cfb2d6da5455f55799072", "message": "receive deferred  message feature", "committedDate": "2020-03-20T20:18:15Z", "type": "commit"}, {"oid": "64d4dd2be9db800642ee95b7becddafb0b43d22b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/64d4dd2be9db800642ee95b7becddafb0b43d22b", "message": "reduced scope of static constant", "committedDate": "2020-03-20T20:24:08Z", "type": "commit"}, {"oid": "6501cd0a915d7e6d4dff524669fa54398dcffe0e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6501cd0a915d7e6d4dff524669fa54398dcffe0e", "message": "resolved merge conflict", "committedDate": "2020-03-20T20:53:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MDgyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9335#discussion_r395890824", "bodyText": "This exists in ManagementConstants", "author": "conniey", "createdAt": "2020-03-20T21:09:22Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusMessageSerializer.java", "diffHunk": "@@ -60,6 +60,7 @@\n     private static final String REQUEST_RESPONSE_MESSAGES = \"messages\";\n     private static final String REQUEST_RESPONSE_MESSAGE = \"message\";\n     private static final String REQUEST_RESPONSE_EXPIRATIONS = \"expirations\";\n+    private static final String LOCK_TOKEN_KEY = \"lock-token\";", "originalCommit": "6501cd0a915d7e6d4dff524669fa54398dcffe0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwNDQwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9335#discussion_r395904403", "bodyText": "All the constants in ManagementConstants  are package-private  and serializer can not access them. Unless we want to change that and make them public. Thus I added it here  in serializer.", "author": "hemanttanwar", "createdAt": "2020-03-20T21:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MDgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MTU5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9335#discussion_r395891596", "bodyText": "The grammar before was correct.", "author": "conniey", "createdAt": "2020-03-20T21:11:31Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -312,15 +312,16 @@ public String getServiceBusResourceName() {\n     }\n \n     /**\n-     * Receives a deferred {@link ServiceBusMessage}. Deferred messages can only be received by using sequence number.\n+     * Receives a deferred {@link ServiceBusMessage}. Deferred message can only be received by using sequence number.", "originalCommit": "6501cd0a915d7e6d4dff524669fa54398dcffe0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5MzU4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9335#discussion_r395893588", "bodyText": "nit: use final", "author": "conniey", "createdAt": "2020-03-20T21:16:38Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -174,6 +199,47 @@\n         }));\n     }\n \n+    private Flux<ServiceBusReceivedMessage> receiveDeferredMessageBatch(ReceiveMode receiveMode, UUID sessionId,\n+            long... fromSequenceNumbers) {\n+        return isAuthorized(RECEIVE_BY_SEQUENCE_NUMBER_OPERATION).thenMany(createRequestResponse.flatMap(channel -> {\n+            final Message message = createManagementMessage(RECEIVE_BY_SEQUENCE_NUMBER_OPERATION,\n+                channel.getReceiveLinkName());\n+\n+            // set mandatory properties on AMQP message body\n+            HashMap<String, Object> requestBodyMap = new HashMap<>();", "originalCommit": "6501cd0a915d7e6d4dff524669fa54398dcffe0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5Mzk5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9335#discussion_r395893992", "bodyText": "There are operations already grouped together a top, I would put that up there.", "author": "conniey", "createdAt": "2020-03-20T21:17:38Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementConstants.java", "diffHunk": "@@ -30,4 +30,8 @@\n     static final String DEADLETTER_DESCRIPTION_KEY = \"deadletter-description\";\n     static final String PROPERTIES_TO_MODIFY_KEY = \"properties-to-modify\";\n     static final String ASSOCIATED_LINK_NAME_KEY = \"associated-link-name\";\n+    public static final String RECEIVE_BY_SEQUENCE_NUMBER_OPERATION = AmqpConstants.VENDOR", "originalCommit": "6501cd0a915d7e6d4dff524669fa54398dcffe0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5NDE0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9335#discussion_r395894149", "bodyText": "Where is the case with multiple numbers?", "author": "conniey", "createdAt": "2020-03-20T21:18:06Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -495,6 +495,23 @@ void settleMessage(DispositionStatus dispositionStatus) {\n         verify(managementNode, times(0)).updateDisposition(lockToken2, dispositionStatus, null, null, null);\n     }\n \n+    /**\n+     * Verifies that this receive deferred one messages from a sequence Number.\n+     */\n+    @Test\n+    void receiveDeferredWithSequenceOneMessage() {\n+        // Arrange\n+        final int fromSequenceNumber = 10;\n+        final ServiceBusReceivedMessage receivedMessage = mock(ServiceBusReceivedMessage.class);\n+\n+        when(managementNode.receiveDeferredMessage(receiveOptions.getReceiveMode(), fromSequenceNumber)).thenReturn(Mono.just(receivedMessage));\n+\n+        // Act & Assert\n+        StepVerifier.create(consumer.receiveDeferredMessage(fromSequenceNumber))", "originalCommit": "6501cd0a915d7e6d4dff524669fa54398dcffe0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d2b44dee1b20c0c59e93224cb735e33ee61eb5b8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d2b44dee1b20c0c59e93224cb735e33ee61eb5b8", "message": "review comments", "committedDate": "2020-03-20T21:44:19Z", "type": "commit"}, {"oid": "cd425ced523861f4502ce58ba8e33ca64806b5ba", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cd425ced523861f4502ce58ba8e33ca64806b5ba", "message": "review comments", "committedDate": "2020-03-20T21:47:39Z", "type": "commit"}, {"oid": "7aa84b1081879179c12dcb308c34782214883654", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7aa84b1081879179c12dcb308c34782214883654", "message": "review comments", "committedDate": "2020-03-20T21:48:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNzU5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9335#discussion_r395917596", "bodyText": "I noticed this and in other places, why do you use publishOn(scheduler)? It hasn't reached user code yet, so we don't need to perform work on their scheduler in the case that it is blocking.", "author": "conniey", "createdAt": "2020-03-20T22:31:22Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -131,6 +136,26 @@\n             .publishOn(scheduler);\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Mono<ServiceBusReceivedMessage> receiveDeferredMessage(ReceiveMode receiveMode, long sequenceNumber) {\n+        return receiveDeferredMessageBatch(receiveMode, null, sequenceNumber)\n+            .next()\n+            .publishOn(scheduler);", "originalCommit": "7aa84b1081879179c12dcb308c34782214883654", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b15789d6881b4d3cc015c971e71f5f079fb0f730", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b15789d6881b4d3cc015c971e71f5f079fb0f730", "message": "review comments", "committedDate": "2020-03-20T22:55:29Z", "type": "commit"}]}