{"pr_number": 16247, "pr_title": "Add more pagination testing to query and relationship tests", "pr_createdAt": "2020-10-13T18:10:40Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/16247", "timeline": [{"oid": "6c3561069719e7050f864df2ffc20b72108031b1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6c3561069719e7050f864df2ffc20b72108031b1", "message": "Add more pagination testing to query and relationship tests\n\nAlso update readme to reflect recent changes to project folder structure", "committedDate": "2020-10-13T18:01:39Z", "type": "commit"}, {"oid": "f0013409f12ac377c594b3d4fe64371fb03c6d49", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f0013409f12ac377c594b3d4fe64371fb03c6d49", "message": "fix", "committedDate": "2020-10-13T18:03:11Z", "type": "commit"}, {"oid": "b621e2042a6edcf1cfb4a80511c8f0b47b95269a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b621e2042a6edcf1cfb4a80511c8f0b47b95269a", "message": "fixup", "committedDate": "2020-10-13T18:10:14Z", "type": "commit"}, {"oid": "346e7422eb51794c88f825efd5e3f88e86e7094d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/346e7422eb51794c88f825efd5e3f88e86e7094d", "message": "fixup", "committedDate": "2020-10-13T18:14:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NDQ2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16247#discussion_r504164460", "bodyText": "pageSize++?", "author": "drwill-ms", "createdAt": "2020-10-13T18:17:45Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/DigitalTwinsRelationshipAsyncTest.java", "diffHunk": "@@ -268,39 +269,77 @@ public void relationshipListOperationWithMultiplePages(HttpClient httpClient, Di\n \n             // Connect the created twins via relationships\n             String floorContainsRoomPayload = getRelationshipWithPropertyPayload(roomTwinId, CONTAINS_RELATIONSHIP, \"isAccessRestricted\", true);\n+            String roomContainedInFloorPayload = getRelationshipPayload(floorTwinId, CONTAINED_IN_RELATIONSHIP);\n \n             // Create large number of relationships to test paging functionality\n             // Relationship list api does not have max item count request option so we have to create a large number of them to trigger paging functionality from the service.\n             // Create relationships from Floor -> Room\n-            final CountDownLatch createRelationshipsLatch = new CountDownLatch(BULK_RELATIONSHIP_COUNT);\n-\n-            for (int i = 0 ; i< BULK_RELATIONSHIP_COUNT ; i++) {\n+            for (int i = 0; i < pageSize++; i++) {", "originalCommit": "346e7422eb51794c88f825efd5e3f88e86e7094d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2ODU5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16247#discussion_r504168599", "bodyText": "Good catch, that's not right", "author": "timtay-microsoft", "createdAt": "2020-10-13T18:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NDQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NzA1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16247#discussion_r504167056", "bodyText": "Can this be something more like:\n    assertThat(\"Number of pages must be more than 1\",\n           outgoingRelationshipsPagecount.get(),\n           greaterThan(1));\nIn .NET at least, doing a comparison rather than asserting true or false gets you better test failure output.", "author": "drwill-ms", "createdAt": "2020-10-13T18:21:47Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/DigitalTwinsRelationshipAsyncTest.java", "diffHunk": "@@ -268,39 +269,77 @@ public void relationshipListOperationWithMultiplePages(HttpClient httpClient, Di\n \n             // Connect the created twins via relationships\n             String floorContainsRoomPayload = getRelationshipWithPropertyPayload(roomTwinId, CONTAINS_RELATIONSHIP, \"isAccessRestricted\", true);\n+            String roomContainedInFloorPayload = getRelationshipPayload(floorTwinId, CONTAINED_IN_RELATIONSHIP);\n \n             // Create large number of relationships to test paging functionality\n             // Relationship list api does not have max item count request option so we have to create a large number of them to trigger paging functionality from the service.\n             // Create relationships from Floor -> Room\n-            final CountDownLatch createRelationshipsLatch = new CountDownLatch(BULK_RELATIONSHIP_COUNT);\n-\n-            for (int i = 0 ; i< BULK_RELATIONSHIP_COUNT ; i++) {\n+            for (int i = 0; i < pageSize++; i++) {\n                 String relationshipId = FLOOR_CONTAINS_ROOM_RELATIONSHIP_ID + this.testResourceNamer.randomUuid();\n-                asyncClient.createRelationship(floorTwinId, relationshipId, deserializeJsonString(floorContainsRoomPayload, BasicRelationship.class), BasicRelationship.class)\n-                    .doOnSuccess(s -> createdRelationshipIds.add(relationshipId))\n-                    .doOnTerminate(createRelationshipsLatch::countDown)\n-                    .subscribe();\n+                StepVerifier.create(\n+                    asyncClient.createRelationship(\n+                        floorTwinId,\n+                        relationshipId,\n+                        deserializeJsonString(floorContainsRoomPayload, BasicRelationship.class),\n+                        BasicRelationship.class)).verifyComplete();\n+                createdRelationshipIds.add(relationshipId);\n             }\n \n-            createRelationshipsLatch.await(MAX_WAIT_TIME_ASYNC_OPERATIONS_IN_SECONDS, TimeUnit.SECONDS);\n+            // Create multiple incoming relationships to the floor. Typically a room would have relationships to multiple\n+            // different floors, but for the sake of test simplicity, we'll just add multiple relationships from the same room\n+            // to the same floor.\n+            for (int i = 0; i < pageSize + 1; i++) {\n+                String relationshipId = ROOM_CONTAINED_IN_FLOOR_RELATIONSHIP_ID + this.testResourceNamer.randomUuid();\n+                StepVerifier.create(\n+                    asyncClient.createRelationship(\n+                        roomTwinId,\n+                        relationshipId,\n+                        deserializeJsonString(roomContainedInFloorPayload, BasicRelationship.class),\n+                        BasicRelationship.class)).verifyComplete();\n+                createdRelationshipIds.add(relationshipId);\n+            }\n \n-            AtomicInteger pageCount = new AtomicInteger();\n+            AtomicInteger outgoingRelationshipsPageCount = new AtomicInteger();\n             // List models in multiple pages and verify more than one page was retrieved.\n             StepVerifier.create(asyncClient.listRelationships(floorTwinId, BasicRelationship.class).byPage())\n                 .thenConsumeWhile(\n                     page -> {\n-                        pageCount.getAndIncrement();\n-                        logger.info(\"content for this page \" + pageCount);\n+                        outgoingRelationshipsPageCount.getAndIncrement();\n+                        logger.info(\"content for this page \" + outgoingRelationshipsPageCount);\n                         for (BasicRelationship relationship : page.getValue()) {\n                             logger.info(relationship.getId());\n                         }\n+\n+                        if (page.getContinuationToken() != null) {\n+                            assertEquals(RELATIONSHIP_PAGE_SIZE_DEFAULT, page.getValue().size(), \"Unexpected page size for a non-terminal page\");\n+                        }\n+\n                         return true;\n                     })\n                 .verifyComplete();\n \n-            int finalPageCount = pageCount.get();\n+            assertTrue(outgoingRelationshipsPageCount.get() > 1, \"Number of pages must be more than one.\");", "originalCommit": "346e7422eb51794c88f825efd5e3f88e86e7094d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NzMwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16247#discussion_r504167301", "bodyText": "weird spacing issues in this statement", "author": "drwill-ms", "createdAt": "2020-10-13T18:22:15Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/DigitalTwinsRelationshipTest.java", "diffHunk": "@@ -221,22 +223,50 @@ public void relationshipListOperationWithMultiplePages(HttpClient httpClient, Di\n                 createdRelationshipIds.add(relationshipId);\n             }\n \n+            // Create multiple incoming relationships to the floor. Typically a room would have relationships to multiple\n+            // different floors, but for the sake of test simplicity, we'll just add multiple relationships from the same room\n+            // to the same floor.\n+            for (int i = 0 ; i< BULK_RELATIONSHIP_COUNT ; i++) {", "originalCommit": "346e7422eb51794c88f825efd5e3f88e86e7094d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2Nzg5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16247#discussion_r504167894", "bodyText": "hmm, I expected this to be the BULK_RELATIONSHIP_COUNT instead of pageSize", "author": "azabbasi", "createdAt": "2020-10-13T18:23:19Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/DigitalTwinsRelationshipAsyncTest.java", "diffHunk": "@@ -268,39 +269,77 @@ public void relationshipListOperationWithMultiplePages(HttpClient httpClient, Di\n \n             // Connect the created twins via relationships\n             String floorContainsRoomPayload = getRelationshipWithPropertyPayload(roomTwinId, CONTAINS_RELATIONSHIP, \"isAccessRestricted\", true);\n+            String roomContainedInFloorPayload = getRelationshipPayload(floorTwinId, CONTAINED_IN_RELATIONSHIP);\n \n             // Create large number of relationships to test paging functionality\n             // Relationship list api does not have max item count request option so we have to create a large number of them to trigger paging functionality from the service.\n             // Create relationships from Floor -> Room\n-            final CountDownLatch createRelationshipsLatch = new CountDownLatch(BULK_RELATIONSHIP_COUNT);\n-\n-            for (int i = 0 ; i< BULK_RELATIONSHIP_COUNT ; i++) {\n+            for (int i = 0; i < pageSize++; i++) {\n                 String relationshipId = FLOOR_CONTAINS_ROOM_RELATIONSHIP_ID + this.testResourceNamer.randomUuid();\n-                asyncClient.createRelationship(floorTwinId, relationshipId, deserializeJsonString(floorContainsRoomPayload, BasicRelationship.class), BasicRelationship.class)\n-                    .doOnSuccess(s -> createdRelationshipIds.add(relationshipId))\n-                    .doOnTerminate(createRelationshipsLatch::countDown)\n-                    .subscribe();\n+                StepVerifier.create(\n+                    asyncClient.createRelationship(\n+                        floorTwinId,\n+                        relationshipId,\n+                        deserializeJsonString(floorContainsRoomPayload, BasicRelationship.class),\n+                        BasicRelationship.class)).verifyComplete();\n+                createdRelationshipIds.add(relationshipId);\n             }\n \n-            createRelationshipsLatch.await(MAX_WAIT_TIME_ASYNC_OPERATIONS_IN_SECONDS, TimeUnit.SECONDS);\n+            // Create multiple incoming relationships to the floor. Typically a room would have relationships to multiple\n+            // different floors, but for the sake of test simplicity, we'll just add multiple relationships from the same room\n+            // to the same floor.\n+            for (int i = 0; i < pageSize + 1; i++) {", "originalCommit": "346e7422eb51794c88f825efd5e3f88e86e7094d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2ODIzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16247#discussion_r504168234", "bodyText": "I think in this case you are only creating 5 relationships no? that's smaller than the default page size of 10", "author": "azabbasi", "createdAt": "2020-10-13T18:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2Nzg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2OTc3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16247#discussion_r504169779", "bodyText": "Correct, I made a small mistake here. I was going to write this test the same way as the other pagination tests, but then I discovered we can't choose the page size here. I must have forgotten to revert this part after I made that discovery", "author": "timtay-microsoft", "createdAt": "2020-10-13T18:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2Nzg5NA=="}], "type": "inlineReview"}, {"oid": "7867d71ceb8b7125d55d242c5c7bbaa7b29f48e4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7867d71ceb8b7125d55d242c5c7bbaa7b29f48e4", "message": "fixup", "committedDate": "2020-10-13T18:57:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5NDA3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16247#discussion_r504194078", "bodyText": "nit: fluent assertion here", "author": "abhipsaMisra", "createdAt": "2020-10-13T19:11:13Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/QueryAsyncTests.java", "diffHunk": "@@ -60,11 +69,26 @@ public void validQuerySucceeds(HttpClient httpClient, DigitalTwinsServiceVersion\n                     return true;\n                 })\n                 .verifyComplete();\n+\n+            // Test that page size hint works, and that all returned pages either have the page size hint amount of\n+            // elements, or have no continuation token (signaling that it is the last page)\n+            AtomicInteger pageCount = new AtomicInteger(0);\n+            StepVerifier.create(asyncClient.query(queryString, BasicDigitalTwin.class, new QueryTwinsOptions().setMaxItemsPerPage(pageSize)).byPage())\n+                .thenConsumeWhile(digitalTwinsPage ->  {\n+                    pageCount.incrementAndGet();\n+                    if (digitalTwinsPage.getContinuationToken() != null) {\n+                        assertFalse(digitalTwinsPage.getValue().size() < pageSize, \"Unexpected page size for a non-terminal page\");\n+                    }\n+                    return true;\n+                })\n+                .verifyComplete();\n+\n+            assertTrue(pageCount.get() > 1, \"Expected more than one page of query results\");", "originalCommit": "7867d71ceb8b7125d55d242c5c7bbaa7b29f48e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}