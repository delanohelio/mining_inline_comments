{"pr_number": 11108, "pr_title": "Enable connection via proxy for ManagementClient", "pr_createdAt": "2020-05-12T23:40:30Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11108", "timeline": [{"oid": "43a71763adbbbe7d93c3fde0f82ffe4e1cb89c50", "url": "https://github.com/Azure/azure-sdk-for-java/commit/43a71763adbbbe7d93c3fde0f82ffe4e1cb89c50", "message": "getMessageSessions doc update", "committedDate": "2020-03-25T19:54:01Z", "type": "commit"}, {"oid": "1393e1a09413123aa5cacc2a9cbeab44afef3282", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1393e1a09413123aa5cacc2a9cbeab44afef3282", "message": "Revert \"getMessageSessions doc update\"\n\nThis reverts commit 43a71763adbbbe7d93c3fde0f82ffe4e1cb89c50.", "committedDate": "2020-03-25T22:09:45Z", "type": "commit"}, {"oid": "d64438077b4aaf172307a621ae39623558a371c2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d64438077b4aaf172307a621ae39623558a371c2", "message": "Enable ManagementClient to use proxy", "committedDate": "2020-05-12T23:31:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NDgwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r424094801", "bodyText": "I don't quite know why this sample code has this line. Since I am using localhost and the host name will be different from service bus host. If I enable this line, the proxy cannot be created properly. I don't think this line is necessary but just want to point out.", "author": "DorothySun216", "createdAt": "2020-05-12T23:42:20Z", "path": "sdk/servicebus/microsoft-azure-servicebus/src/test/java/com/microsoft/azure/servicebus/ManagementClientProxyTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.microsoft.azure.servicebus;\n+\n+import com.microsoft.azure.servicebus.management.ManagementClient;\n+import com.microsoft.azure.servicebus.management.QueueDescription;\n+import com.microsoft.azure.servicebus.primitives.ServiceBusException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import java.io.IOException;\n+import java.net.*;\n+import java.util.*;\n+import java.net.InetSocketAddress;\n+import java.net.ProxySelector;\n+import java.net.URI;\n+import java.util.LinkedList;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutionException;\n+\n+public class ManagementClientProxyTest {\n+    @Test\n+    public void managementClientWithProxy() throws InterruptedException, ServiceBusException {\n+        String proxyHostName = \"127.0.0.1\";\n+        int proxyPort = 8888;\n+        final ProxySelector systemDefaultSelector = ProxySelector.getDefault();\n+\n+        ProxySelector.setDefault(new ProxySelector() {\n+            @Override\n+            public List<Proxy> select(URI uri) {\n+                if (uri != null\n+                    && uri.getHost() != null\n+//                    && uri.getHost().equalsIgnoreCase(proxyHostName)", "originalCommit": "d64438077b4aaf172307a621ae39623558a371c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NTY4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r424095689", "bodyText": "These three methods are taken out from ProxyConnectionHandler. Will leave as a TODO to make them as a util class and shared between these two classes.", "author": "DorothySun216", "createdAt": "2020-05-12T23:45:09Z", "path": "sdk/servicebus/microsoft-azure-servicebus/src/main/java/com/microsoft/azure/servicebus/management/ManagementClientAsync.java", "diffHunk": "@@ -92,9 +92,48 @@ public ManagementClientAsync(URI namespaceEndpointURI, ClientSettings clientSett\n         DefaultAsyncHttpClientConfig.Builder clientBuilder = Dsl.config()\n                 .setConnectTimeout((int) CONNECTION_TIMEOUT.toMillis())\n                 .setRequestTimeout((int) this.clientSettings.getOperationTimeout().toMillis());\n+\n+        if(shouldUseProxy(this.namespaceEndpointURI.getHost())){\n+            InetSocketAddress address = (InetSocketAddress)this.proxies.get(0).address();\n+            String proxyHostName=address.getHostName();\n+            int proxyPort=address.getPort();\n+\n+            clientBuilder.setProxyServer(new ProxyServer.Builder(proxyHostName,proxyPort));\n+        }\n+\n         this.asyncHttpClient = asyncHttpClient(clientBuilder);\n     }\n \n+    public boolean shouldUseProxy(final String hostName) {", "originalCommit": "d64438077b4aaf172307a621ae39623558a371c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MDEzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r424590133", "bodyText": "I am wondering if it may be easier/better to set the properties in the client that enables the integration with the default mechanisms that Java networking uses for proxy configuration - documented here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .setRequestTimeout((int) this.clientSettings.getOperationTimeout().toMillis());\n          \n          \n            \n            \n          \n          \n            \n                    if(shouldUseProxy(this.namespaceEndpointURI.getHost())){\n          \n          \n            \n                        InetSocketAddress address = (InetSocketAddress)this.proxies.get(0).address();\n          \n          \n            \n                        String proxyHostName=address.getHostName();\n          \n          \n            \n                        int proxyPort=address.getPort();\n          \n          \n            \n            \n          \n          \n            \n                        clientBuilder.setProxyServer(new ProxyServer.Builder(proxyHostName,proxyPort));\n          \n          \n            \n                    }\n          \n          \n            \n                            .setUseProxySelector(true)\n          \n          \n            \n                            .setUseProxyProperties(true)\n          \n          \n            \n                            .setRequestTimeout((int) this.clientSettings.getOperationTimeout().toMillis());", "author": "giventocode", "createdAt": "2020-05-13T16:56:52Z", "path": "sdk/servicebus/microsoft-azure-servicebus/src/main/java/com/microsoft/azure/servicebus/management/ManagementClientAsync.java", "diffHunk": "@@ -92,9 +92,48 @@ public ManagementClientAsync(URI namespaceEndpointURI, ClientSettings clientSett\n         DefaultAsyncHttpClientConfig.Builder clientBuilder = Dsl.config()\n                 .setConnectTimeout((int) CONNECTION_TIMEOUT.toMillis())\n                 .setRequestTimeout((int) this.clientSettings.getOperationTimeout().toMillis());\n+\n+        if(shouldUseProxy(this.namespaceEndpointURI.getHost())){\n+            InetSocketAddress address = (InetSocketAddress)this.proxies.get(0).address();\n+            String proxyHostName=address.getHostName();\n+            int proxyPort=address.getPort();\n+\n+            clientBuilder.setProxyServer(new ProxyServer.Builder(proxyHostName,proxyPort));\n+        }", "originalCommit": "d64438077b4aaf172307a621ae39623558a371c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI5NjczNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r425296737", "bodyText": "@giventocode Thanks for pointing to this resource to offer more background. I verified that this change would have the same impact: select the default proxy set by ProxySelector, this is also what I was trying to do in my changes but don't aware that there are already system level support built into Java. I also verified this from here: https://www.javadoc.io/static/com.ning/async-http-client/1.9.31/com/ning/http/client/AsyncHttpClientConfig.Builder.html. It also discusses \"If useProxySelector is set to true but setProxyServer(ProxyServer) was used to explicitly set a proxy server, the latter is preferred.\", so should we just have .setUseProxySelector(true)? Have also verified that setting only this property will achieve the same goal in my test.", "author": "DorothySun216", "createdAt": "2020-05-14T17:07:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MDEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ0MzUyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r427443527", "bodyText": "Thanks for the additional insights. I further reviewed the code and in a nutshell: if there's a proxy selector, the proxy uri is retrieved from it and then is set explicitly as the proxy server to use.  So a few things to consider:\n\n\nOne of the benefits of implementing a proxy selector is that it allows you to filter/decide what proxy to use for a given URL - by overriding  java.util.List<Proxy> select(URI uri). The current implementation seems like it'd block this ability as the proxy selector won't be used at all.\n\n\nJava also provides a standard way to set the proxy explicitly, as per below. It seems like this also won't be possible.\n\n\nSystem.setProperty(\"http.proxyHost\", \"webcache.example.com\");\nSystem.setProperty(\"http.proxyPort\", \"8080\");\n\nAs per the suggestion, if we set the flags in the underlying config of the asynchttpclient so it enables the default Java proxy setting behavior, then users can use the Java standard way of setting the proxies and extending how proxies are used programmatically.", "author": "giventocode", "createdAt": "2020-05-19T16:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MDEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NTQ4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r428095484", "bodyText": "I have discussed with @giventocode offline and we have decided to add both .setUseProxySelector(true) (compatible with AMQP websockets to use ProxySelector for send/receive operations) and .setUseProxyProperties(true) (users can use the Java standard way of setting the proxies and extending how proxies are used programmatically for ManagementClient.)", "author": "DorothySun216", "createdAt": "2020-05-20T15:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MDEzMw=="}], "type": "inlineReview"}, {"oid": "f3eab7a8d86c30426152db8dcd8bb28f395abf8a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f3eab7a8d86c30426152db8dcd8bb28f395abf8a", "message": "draft changes", "committedDate": "2020-05-19T22:33:14Z", "type": "commit"}, {"oid": "def43718804ec39c32255bfc204a4914e9a88751", "url": "https://github.com/Azure/azure-sdk-for-java/commit/def43718804ec39c32255bfc204a4914e9a88751", "message": "working test version and modified managementclientasync", "committedDate": "2020-05-19T22:42:28Z", "type": "commit"}, {"oid": "59ef0af035949ba3756b7d0b1782d2d339568baa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/59ef0af035949ba3756b7d0b1782d2d339568baa", "message": "get rid of unnecessary dependencies", "committedDate": "2020-05-19T22:52:03Z", "type": "commit"}, {"oid": "fca8dfd778cfe00fcbb67f4cba633350f4c9677a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fca8dfd778cfe00fcbb67f4cba633350f4c9677a", "message": "add setUseProxyProperties(true) to enable setting http.Proxy\u00a0properties", "committedDate": "2020-05-20T00:09:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwNTM4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r428305385", "bodyText": "managementClientWithProxy [](start = 16, length = 25)\n\nYou can ignore this test. The CI/CD machine doens't have a proxy server and hence this won't run there.", "author": "nemakam", "createdAt": "2020-05-20T21:02:07Z", "path": "sdk/servicebus/microsoft-azure-servicebus/src/test/java/com/microsoft/azure/servicebus/ManagementClientProxyTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.microsoft.azure.servicebus;\n+\n+import com.microsoft.azure.servicebus.management.ManagementClient;\n+import com.microsoft.azure.servicebus.management.QueueDescription;\n+import com.microsoft.azure.servicebus.primitives.ServiceBusException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import java.io.IOException;\n+import java.net.*;\n+import java.util.*;\n+import java.net.InetSocketAddress;\n+import java.net.ProxySelector;\n+import java.net.URI;\n+import java.util.LinkedList;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutionException;\n+\n+public class ManagementClientProxyTest {\n+    @Test\n+    public void managementClientWithProxy() throws InterruptedException, ServiceBusException {", "originalCommit": "d64438077b4aaf172307a621ae39623558a371c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "19302d2c1ffcf92a5a8e899aea05b04e29e5af1f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/19302d2c1ffcf92a5a8e899aea05b04e29e5af1f", "message": "ignore the test", "committedDate": "2020-05-20T21:04:22Z", "type": "commit"}]}