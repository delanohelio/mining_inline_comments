{"pr_number": 10492, "pr_title": "refactor mgmt rest client and integrate azure identity", "pr_createdAt": "2020-04-24T11:28:21Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10492", "timeline": [{"oid": "2b7bd7fd4f8610065629a3664df026db7bb33e34", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2b7bd7fd4f8610065629a3664df026db7bb33e34", "message": "Refactor RestClient", "committedDate": "2020-04-24T08:16:59Z", "type": "commit"}, {"oid": "368f35706b09ced461ced72de053c1c7804b8763", "url": "https://github.com/Azure/azure-sdk-for-java/commit/368f35706b09ced461ced72de053c1c7804b8763", "message": "refactor http pipeline provider and fix javadoc", "committedDate": "2020-04-24T11:17:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4NzAxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415187016", "bodyText": "Don't clone the global configuration. It need to be changed by user some times.", "author": "ChenTanyi", "createdAt": "2020-04-26T01:42:58Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/UserAgentPolicy.java", "diffHunk": "@@ -63,7 +63,7 @@ public UserAgentPolicy(HttpLogOptions httpLogOptions, Configuration configuratio\n         }\n \n         if (configuration == null) {\n-            this.configuration = Configuration.getGlobalConfiguration();\n+            this.configuration = Configuration.getGlobalConfiguration().clone();", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTIwMTEzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415201131", "bodyText": "Okay, make sense.", "author": "xseeseesee", "createdAt": "2020-04-26T03:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4NzAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3MzkyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415273922", "bodyText": "This might be a question whether we support the users to change configuration when running the client. It's not allowed by credential from Azure Identity. Maybe we should consider to align with the same rule.", "author": "xseeseesee", "createdAt": "2020-04-26T10:16:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4NzAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxMjYyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415512623", "bodyText": "I think configuration should be decided by user no matter for any purpose.", "author": "ChenTanyi", "createdAt": "2020-04-27T05:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4NzAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4ODk5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415188999", "bodyText": "This needs to add policy.", "author": "ChenTanyi", "createdAt": "2020-04-26T01:56:23Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -24,33 +32,46 @@\n  */\n public class AzureConfigurableImpl<T extends AzureConfigurable<T>>\n         implements AzureConfigurable<T> {\n-    protected RestClientBuilder restClientBuilder;\n+    private HttpClient httpClient;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpLogDetailLevel httpLogDetailLevel;\n+    private List<HttpPipelinePolicy> policies;\n+    private List<String> scopes;\n+    private RetryPolicy retryPolicy;\n+    private Configuration configuration;\n+    private AzureEnvironment environment;\n \n     protected AzureConfigurableImpl() {\n-        this.restClientBuilder = new RestClientBuilder()\n-                .withSerializerAdapter(new AzureJacksonAdapter());\n+        policies = new ArrayList<>();\n+        scopes = new ArrayList<>();\n+        retryPolicy = new RetryPolicy();\n+        httpLogOptions = new HttpLogOptions().setLogLevel(HttpLogDetailLevel.NONE);\n+        environment = AzureEnvironment.AZURE;\n     }\n \n     @Override\n-    public T withLogOptions(HttpLogOptions level) {\n-        this.restClientBuilder = this.restClientBuilder.withHttpLogOptions(level);\n+    public T withLogOptions(HttpLogOptions httpLogOptions) {\n+        Objects.requireNonNull(httpLogOptions);\n+        this.httpLogOptions = httpLogOptions;\n         return (T) this;\n     }\n \n     @Override\n     public T withLogLevel(HttpLogDetailLevel logLevel) {\n-        this.restClientBuilder = this.restClientBuilder.withLogLevel(logLevel);\n+        Objects.requireNonNull(logLevel);\n+        this.httpLogOptions = httpLogOptions.setLogLevel(logLevel);\n         return (T) this;\n     }\n \n     @Override\n     public T withPolicy(HttpPipelinePolicy policy) {\n-        this.restClientBuilder = this.restClientBuilder.withPolicy(policy);\n+        Objects.requireNonNull(policy);\n+        policies.add(policy);\n         return (T) this;\n     }\n \n     @Override\n-    public T withAuxiliaryCredentials(AzureTokenCredential... tokens) {\n+    public T withAuxiliaryCredentials(TokenCredential... tokens) {\n         return null;", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDAwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415274000", "bodyText": "Added.", "author": "xseeseesee", "createdAt": "2020-04-26T10:17:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4ODk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4OTI5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415189295", "bodyText": "Add Before retry policy provider and after retry policy provider. Meanwhile, add ReqeustIdPolicy and DatePolicy.", "author": "ChenTanyi", "createdAt": "2020-04-26T01:58:36Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -92,21 +113,49 @@ public T withProxy(Proxy proxy) {\n         return null;\n     }\n \n-    protected RestClient buildRestClient(AzureTokenCredential credential, AzureEnvironment.Endpoint endpoint) {\n-        RestClient client = restClientBuilder\n-                .withBaseUrl(credential.getEnvironment(), endpoint)\n-                .withCredential(credential)\n-//                .withPolicy(new ProviderRegistrationPolicy())\n-//                .withPolicy(new ResourceManagerThrottlingPolicy())\n-                .buildClient();\n-        // TODO: Add proxy support\n-//        if (client.httpClient().proxy() != null) {\n-//            credentials.withProxy(client.httpClient().proxy());\n-//        }\n-        return client;\n+    @Override\n+    public T withScope(String scope) {\n+        Objects.requireNonNull(scope);\n+        this.scopes.add(scope);\n+        return (T) this;\n+    }\n+\n+    @Override\n+    public T withHttpClient(HttpClient httpClient) {\n+        Objects.requireNonNull(httpClient);\n+        this.httpClient = httpClient;\n+        return (T) this;\n+    }\n+\n+    @Override\n+    public T withConfiguration(Configuration configuration) {\n+        Objects.requireNonNull(configuration);\n+        this.configuration = configuration;\n+        return (T) this;\n+    }\n+\n+    @Override\n+    public T withEnvironment(AzureEnvironment environment) {\n+        Objects.requireNonNull(environment);\n+        this.environment = environment;\n+        return (T) this;\n+    }\n+\n+    protected HttpPipeline buildHttpPipeline(TokenCredential credential) {\n+        Objects.requireNonNull(credential);\n+\n+        List<HttpPipelinePolicy> policies = new ArrayList<>();\n+        policies.add(new UserAgentPolicy(httpLogOptions, configuration));\n+", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4OTU0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415189543", "bodyText": "Logging should be the last one. If we want user to see the network log.", "author": "ChenTanyi", "createdAt": "2020-04-26T02:00:23Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -92,21 +113,49 @@ public T withProxy(Proxy proxy) {\n         return null;\n     }\n \n-    protected RestClient buildRestClient(AzureTokenCredential credential, AzureEnvironment.Endpoint endpoint) {\n-        RestClient client = restClientBuilder\n-                .withBaseUrl(credential.getEnvironment(), endpoint)\n-                .withCredential(credential)\n-//                .withPolicy(new ProviderRegistrationPolicy())\n-//                .withPolicy(new ResourceManagerThrottlingPolicy())\n-                .buildClient();\n-        // TODO: Add proxy support\n-//        if (client.httpClient().proxy() != null) {\n-//            credentials.withProxy(client.httpClient().proxy());\n-//        }\n-        return client;\n+    @Override\n+    public T withScope(String scope) {\n+        Objects.requireNonNull(scope);\n+        this.scopes.add(scope);\n+        return (T) this;\n+    }\n+\n+    @Override\n+    public T withHttpClient(HttpClient httpClient) {\n+        Objects.requireNonNull(httpClient);\n+        this.httpClient = httpClient;\n+        return (T) this;\n+    }\n+\n+    @Override\n+    public T withConfiguration(Configuration configuration) {\n+        Objects.requireNonNull(configuration);\n+        this.configuration = configuration;\n+        return (T) this;\n+    }\n+\n+    @Override\n+    public T withEnvironment(AzureEnvironment environment) {\n+        Objects.requireNonNull(environment);\n+        this.environment = environment;\n+        return (T) this;\n+    }\n+\n+    protected HttpPipeline buildHttpPipeline(TokenCredential credential) {\n+        Objects.requireNonNull(credential);\n+\n+        List<HttpPipelinePolicy> policies = new ArrayList<>();\n+        policies.add(new UserAgentPolicy(httpLogOptions, configuration));\n+\n+        List<HttpPipelinePolicy> retryPolicies = new ArrayList<>();\n+        retryPolicies.add(retryPolicy);\n+        retryPolicies.add(new AuthenticationPolicy(credential, environment, scopes()));\n+        retryPolicies.add(new HttpLoggingPolicy(httpLogOptions));", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTIxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415191213", "bodyText": "I think this todo could be removed, since the proxy is inside http client now.", "author": "ChenTanyi", "createdAt": "2020-04-26T02:10:55Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/policy/ProviderRegistrationPolicy.java", "diffHunk": "@@ -69,13 +67,8 @@ private boolean isResponseSuccessful(HttpResponse response) {\n                             if (cloudError != null && MISSING_SUBSCRIPTION_REGISTRATION.equals(cloudError.getCode())) {\n                                 String subscriptionId = ResourceUtils.extractFromResourceId(\n                                     request.getUrl().getPath(), \"subscriptions\");\n-                                RestClient restClient = new RestClientBuilder()\n-                                        .withBaseUrl(String.format(\"%s://%s\",\n-                                            request.getUrl().getProtocol(), request.getUrl().getHost()))\n-                                        .withCredential(credential)\n-                                        .withSerializerAdapter(jacksonAdapter).buildClient();\n                                 // TODO: add proxy in rest client", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMyNTI5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416325292", "bodyText": "Why don't remove it?", "author": "ChenTanyi", "createdAt": "2020-04-28T04:53:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTMzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415191337", "bodyText": "Don't clone the global config.", "author": "ChenTanyi", "createdAt": "2020-04-26T02:11:23Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/profile/AzureProfile.java", "diffHunk": "@@ -0,0 +1,98 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.management.resources.fluentcore.profile;\n+\n+import com.azure.core.management.AzureEnvironment;\n+import com.azure.core.util.Configuration;\n+\n+/**\n+ * Azure profile for client.\n+ */\n+public class AzureProfile {\n+\n+    private String tenantId;\n+    private String subscriptionId;\n+    private AzureEnvironment environment;\n+    private final Configuration configuration = Configuration.getGlobalConfiguration().clone();", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTQ1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415191451", "bodyText": "Does it need withEnvironment?", "author": "ChenTanyi", "createdAt": "2020-04-26T02:12:17Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/profile/AzureProfile.java", "diffHunk": "@@ -0,0 +1,98 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.management.resources.fluentcore.profile;\n+\n+import com.azure.core.management.AzureEnvironment;\n+import com.azure.core.util.Configuration;\n+\n+/**\n+ * Azure profile for client.\n+ */\n+public class AzureProfile {", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI1ODI2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415258268", "bodyText": "Hmmm looks withEnvironment can be removed after I checked. The environment is prerequisite before creating Authenticated instance.", "author": "xseeseesee", "createdAt": "2020-04-26T08:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTQ1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwMzI4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415503282", "bodyText": "Should we use a Builder to make this class immutable? Do we expect user be able to change subscriptionId or tenantId in the middle of running the code.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T04:34:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTQ1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUyODc5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415528798", "bodyText": "The user might want to set subscriptionId or tenantId after listing subs/tenants via Authenticated. Inside each manager, we just keep the subscriptionId and environment instead of profile. Profile is only used in the constructor of manager.", "author": "xseeseesee", "createdAt": "2020-04-27T05:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTQ1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUzMDc5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415530795", "bodyText": "That is method inside AzureConfigure, which does not related to mutable or immutable of this class. You can always create a new AzureProfile there, like what you did to HttpPipeline, which is immutable.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T05:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTQ1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MjI0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415192243", "bodyText": "I think this name is little confused. You even add any retryPolicy in pipeline. Not sure we need such function or not.", "author": "ChenTanyi", "createdAt": "2020-04-26T02:17:36Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/utils/HttpPipelineProvider.java", "diffHunk": "@@ -0,0 +1,75 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.management.resources.fluentcore.utils;\n+\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpPipeline;\n+import com.azure.core.http.HttpPipelineBuilder;\n+import com.azure.core.http.policy.HttpLogDetailLevel;\n+import com.azure.core.http.policy.HttpLogOptions;\n+import com.azure.core.http.policy.HttpLoggingPolicy;\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.http.policy.HttpPolicyProviders;\n+import com.azure.core.management.AzureEnvironment;\n+import com.azure.management.AuthenticationPolicy;\n+import com.azure.management.UserAgentPolicy;\n+import com.azure.management.resources.fluentcore.policy.ProviderRegistrationPolicy;\n+import com.azure.management.resources.fluentcore.policy.ResourceManagerThrottlingPolicy;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * A Http Pipeline Provider.\n+ */\n+public final class HttpPipelineProvider {\n+\n+    private HttpPipelineProvider() {\n+    }\n+\n+    /**\n+     * Creates http pipeline with token credential\n+     *\n+     * @param credential the token credential\n+     * @return the http pipeline\n+     */\n+    public static HttpPipeline buildHttpPipeline(TokenCredential credential) {\n+        // TODO: basic policies should be provided\n+        List<HttpPipelinePolicy> policies = new ArrayList<>();\n+        HttpLogOptions httpLogOptions = new HttpLogOptions().setLogLevel(HttpLogDetailLevel.BASIC);\n+        policies.add(new UserAgentPolicy(httpLogOptions, null));\n+\n+        List<HttpPipelinePolicy> retryPolicies = new ArrayList<>();\n+        retryPolicies.add(new ProviderRegistrationPolicy(credential));\n+        retryPolicies.add(new ResourceManagerThrottlingPolicy());\n+        retryPolicies.add(new AuthenticationPolicy(credential, AzureEnvironment.AZURE, null));\n+        retryPolicies.add(new HttpLoggingPolicy(httpLogOptions));\n+        return buildHttpPipeline(policies, retryPolicies, null);\n+    }\n+\n+    /**\n+     * Creates http pipeline with policies and http client.\n+     *\n+     * @param policies the policies not required in retry strategy\n+     * @param retryPolicies the policies required in retry strategy\n+     * @param httpClient the http client\n+     * @return the http pipeline\n+     */\n+    public static HttpPipeline buildHttpPipeline(\n+        List<HttpPipelinePolicy> policies,\n+        List<HttpPipelinePolicy> retryPolicies,", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI1Nzc5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415257797", "bodyText": "This is mainly about how we handle the HttpPolicyProviders.addBeforeRetryPolicies and HttpPolicyProviders.addAfterRetryPolicies. We will have policies required to add before RetryPolicies as per my understanding, which is existing behavior before refactoring.", "author": "xseeseesee", "createdAt": "2020-04-26T08:52:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MjI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI2NTQyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415265429", "bodyText": "The mainly concern is what you want to do by this function. If you want customer to use, I think the pipeline builder will be more clear than such a function. If you only want to use it internally, I think the parameters should be separated.", "author": "ChenTanyi", "createdAt": "2020-04-26T09:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MjI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ2OTUwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415469500", "bodyText": "The purpose for this provider is to reuse these pieces of code when creating internal http pipeline. Maybe I should make them private.", "author": "xseeseesee", "createdAt": "2020-04-27T02:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MjI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwODIxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415508215", "bodyText": "policiesBeforeRetry policiesAfterRetry should be enough?", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T04:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MjI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MjYxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415192610", "bodyText": "Most of user will use this simple authenticate, I think maybe AzureProfile is needed. Not sure whether they need to set tenantId or not.", "author": "ChenTanyi", "createdAt": "2020-04-26T02:19:49Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/implementation/ResourceManager.java", "diffHunk": "@@ -57,24 +55,19 @@\n      * @param credential the credentials to use\n      * @return the ResourceManager instance\n      */\n-    public static ResourceManager.Authenticated authenticate(AzureTokenCredential credential) {\n-        return new AuthenticatedImpl(new RestClientBuilder()\n-                .withBaseUrl(credential.getEnvironment(), AzureEnvironment.Endpoint.RESOURCE_MANAGER)\n-                .withCredential(credential)\n-                .withSerializerAdapter(new AzureJacksonAdapter())\n-                .withPolicy(new ProviderRegistrationPolicy(credential))\n-                .withPolicy(new ResourceManagerThrottlingPolicy())\n-                .buildClient());\n+    public static ResourceManager.Authenticated authenticate(TokenCredential credential) {\n+        return new AuthenticatedImpl(HttpPipelineProvider.buildHttpPipeline(credential),\n+            new AzureProfile(AzureEnvironment.AZURE));", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI1Nzk0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415257946", "bodyText": "Agree with this, I will change it to apply AzureProfile together", "author": "xseeseesee", "createdAt": "2020-04-26T08:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MjYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MzM4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415193387", "bodyText": "I think pipeline builder is more clear", "author": "ChenTanyi", "createdAt": "2020-04-26T02:25:10Z", "path": "sdk/resources/mgmt/src/test/java/com/azure/management/resources/core/TestBase.java", "diffHunk": "@@ -213,30 +240,39 @@ public void write(int b) throws IOException {\n                     throw new IllegalArgumentException(\"When running tests in record mode either 'AZURE_AUTH_LOCATION' or 'AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_CLIENT_SECRET and AZURE_SUBSCRIPTION_ID' needs to be set\");\n                 }\n \n-                credentials = new ApplicationTokenCredential(clientId, tenantId, clientSecret, AzureEnvironment.AZURE);\n-                credentials.defaultSubscriptionId(subscriptionId);\n+                credential = new ClientSecretCredentialBuilder()\n+                    .tenantId(tenantId)\n+                    .clientId(clientId)\n+                    .clientSecret(clientSecret)\n+                    .authorityHost(AzureEnvironment.AZURE.getActiveDirectoryEndpoint())\n+                    .build();\n+                profile = new AzureProfile(tenantId, subscriptionId, AzureEnvironment.AZURE);\n+\n             }\n-            RestClientBuilder builder = new RestClientBuilder()\n-                    .withBaseUrl(this.baseUri())\n-                    .withSerializerAdapter(new AzureJacksonAdapter())\n-                    .withCredential(credentials)\n-                    .withHttpClient(generateHttpClientWithProxy(null))\n-                    .withLogLevel(HttpLogDetailLevel.BODY_AND_HEADERS)\n-                    .withPolicy(new ResourceGroupTaggingPolicy())\n-                    .withPolicy(new TimeoutPolicy(Duration.ofMinutes(1)))\n-                    .withPolicy(new CookiePolicy());\n+\n+            HttpLogOptions httpLogOptions = new HttpLogOptions().setLogLevel(HttpLogDetailLevel.BODY_AND_HEADERS);\n+            List<HttpPipelinePolicy> policies = new ArrayList<>();\n+            policies.add(new UserAgentPolicy(httpLogOptions, null));\n+            List<HttpPipelinePolicy> retryPolicies = new ArrayList<>();\n+            retryPolicies.add(new RetryPolicy());\n+            retryPolicies.add(new ResourceGroupTaggingPolicy());\n+            retryPolicies.add(new TimeoutPolicy(Duration.ofMinutes(1)));\n+            retryPolicies.add(new CookiePolicy());\n+            retryPolicies.add(new AuthenticationPolicy(credential, profile.environment(), null));\n+            retryPolicies.add(new HttpLoggingPolicy(httpLogOptions));", "originalCommit": "368f35706b09ced461ced72de053c1c7804b8763", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f76c5205196d6dcc8901ea4925b75dca85137764", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f76c5205196d6dcc8901ea4925b75dca85137764", "message": "refactor GraphRbac", "committedDate": "2020-04-26T02:33:52Z", "type": "commit"}, {"oid": "942fb7bebff6bb592386cff9adf4f437ff54e314", "url": "https://github.com/Azure/azure-sdk-for-java/commit/942fb7bebff6bb592386cff9adf4f437ff54e314", "message": "refactor msi", "committedDate": "2020-04-26T02:48:49Z", "type": "commit"}, {"oid": "490b34b7077b7ac4825d0fe1c0cbc98515477e64", "url": "https://github.com/Azure/azure-sdk-for-java/commit/490b34b7077b7ac4825d0fe1c0cbc98515477e64", "message": "refactor storage", "committedDate": "2020-04-26T02:58:35Z", "type": "commit"}, {"oid": "496ebf1c199fc8c7276dede0cba7eec609374294", "url": "https://github.com/Azure/azure-sdk-for-java/commit/496ebf1c199fc8c7276dede0cba7eec609374294", "message": "refactor network", "committedDate": "2020-04-26T08:36:03Z", "type": "commit"}, {"oid": "5e116d140f6b65e5db626dd0d1078d24da6a312f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5e116d140f6b65e5db626dd0d1078d24da6a312f", "message": "refactor monitor", "committedDate": "2020-04-26T08:36:33Z", "type": "commit"}, {"oid": "0aac49fb5651aff9d620f2dcdd5a73e99b14ce6e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0aac49fb5651aff9d620f2dcdd5a73e99b14ce6e", "message": "refactor sql", "committedDate": "2020-04-26T08:37:05Z", "type": "commit"}, {"oid": "cfdccb37aa9c8c2cb673fad26ccc48a2cfed0f72", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cfdccb37aa9c8c2cb673fad26ccc48a2cfed0f72", "message": "refactor sample", "committedDate": "2020-04-26T08:37:44Z", "type": "commit"}, {"oid": "b37201da5b03f461cb385196e7bdd451f81bfa98", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b37201da5b03f461cb385196e7bdd451f81bfa98", "message": "update resources", "committedDate": "2020-04-26T08:38:17Z", "type": "commit"}, {"oid": "122dbb62002fe67c913995af8957cbebe7eb9a9b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/122dbb62002fe67c913995af8957cbebe7eb9a9b", "message": "refactor keyvault", "committedDate": "2020-04-26T08:39:02Z", "type": "commit"}, {"oid": "2f39d583ed2533f879791e75adea53d0fc8d9011", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2f39d583ed2533f879791e75adea53d0fc8d9011", "message": "refactor compute", "committedDate": "2020-04-26T08:39:38Z", "type": "commit"}, {"oid": "86ebc0c6da12c32e3db7f1a8f06d7d5ed11c21cb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/86ebc0c6da12c32e3db7f1a8f06d7d5ed11c21cb", "message": "refactor appservice", "committedDate": "2020-04-26T08:40:27Z", "type": "commit"}, {"oid": "80a04b02104e208e87b25fc18cae578749bbf71d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/80a04b02104e208e87b25fc18cae578749bbf71d", "message": "refactor dns", "committedDate": "2020-04-26T08:40:57Z", "type": "commit"}, {"oid": "02dfc8da29c4ff5a516452729d7410627d0482d8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/02dfc8da29c4ff5a516452729d7410627d0482d8", "message": "refactor cosmos", "committedDate": "2020-04-26T08:41:38Z", "type": "commit"}, {"oid": "60fe02dca1bec704325cf69f5ef87afa77568d00", "url": "https://github.com/Azure/azure-sdk-for-java/commit/60fe02dca1bec704325cf69f5ef87afa77568d00", "message": "refactor mgmt azure client", "committedDate": "2020-04-26T08:42:28Z", "type": "commit"}, {"oid": "2202cc69ea5ac9ad4f4596a9f31201557d099b5e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2202cc69ea5ac9ad4f4596a9f31201557d099b5e", "message": "refactor container service and container registry", "committedDate": "2020-04-26T08:43:09Z", "type": "commit"}, {"oid": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "message": "update http pipeline generation with envionment", "committedDate": "2020-04-26T10:12:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMTk5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415301997", "bodyText": "is this necessary?", "author": "yungezz", "createdAt": "2020-04-26T12:42:53Z", "path": "sdk/resources/mgmt/src/test/java/com/azure/management/resources/core/AuthFile.java", "diffHunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.management.resources.core;\n+\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.implementation.TypeUtil;\n+import com.azure.core.management.AzureEnvironment;\n+import com.azure.core.management.serializer.AzureJacksonAdapter;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.util.serializer.SerializerAdapter;\n+import com.azure.core.util.serializer.SerializerEncoding;\n+import com.azure.identity.ClientCertificateCredentialBuilder;", "originalCommit": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ2NDg1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415464854", "bodyText": "AuthFile is used to  support file parsing.", "author": "xseeseesee", "createdAt": "2020-04-27T02:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMTk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMjI0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415302246", "bodyText": "what's this?", "author": "yungezz", "createdAt": "2020-04-26T12:44:12Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/arm/AzureConfigurable.java", "diffHunk": "@@ -96,4 +99,28 @@\n      * @return the configurable object itself for chaining\n      */\n     T withProxy(Proxy proxy);\n+\n+    /**\n+     * Sets the credential scope.\n+     *\n+     * @param scope the credential scope\n+     * @return the configurable object itself for chaining\n+     */\n+    T withScope(String scope);", "originalCommit": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ2NTE3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415465177", "bodyText": "The credential scope can be used in AuthenticationPolicy. @ChenTanyi should be able to suggest whether we plan to keep this.", "author": "xseeseesee", "createdAt": "2020-04-27T02:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMjI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ4Njc0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415486743", "bodyText": "https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#security-scheme-object\nCurrently we are using hardcoded /.default", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T03:35:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMjI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMjg2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415302865", "bodyText": "what's scope used for", "author": "yungezz", "createdAt": "2020-04-26T12:47:05Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -92,21 +114,45 @@ public T withProxy(Proxy proxy) {\n         return null;\n     }\n \n-    protected RestClient buildRestClient(AzureTokenCredential credential, AzureEnvironment.Endpoint endpoint) {\n-        RestClient client = restClientBuilder\n-                .withBaseUrl(credential.getEnvironment(), endpoint)\n-                .withCredential(credential)\n-//                .withPolicy(new ProviderRegistrationPolicy())\n-//                .withPolicy(new ResourceManagerThrottlingPolicy())\n-                .buildClient();\n-        // TODO: Add proxy support\n-//        if (client.httpClient().proxy() != null) {\n-//            credentials.withProxy(client.httpClient().proxy());\n-//        }\n-        return client;\n+    @Override\n+    public T withScope(String scope) {", "originalCommit": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzE1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415303153", "bodyText": "why resourcemanager use default subs, not profile.subsid?", "author": "yungezz", "createdAt": "2020-04-26T12:48:28Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/arm/implementation/ManagerBase.java", "diffHunk": "@@ -14,43 +16,52 @@\n \n     private ResourceManager resourceManager;\n     private final String subscriptionId;\n-    protected final RestClient restClient;\n+    private final AzureEnvironment environment;\n+    protected final HttpPipeline httpPipeline;\n     private SdkContext sdkContext;\n \n-    protected ManagerBase(RestClient restClient, String subscriptionId, SdkContext sdkContext) {\n-        this.restClient = restClient;\n-        if (restClient != null) {\n-            this.resourceManager = ResourceManager.authenticate(restClient)\n+    protected ManagerBase(HttpPipeline httpPipeline, AzureProfile profile, SdkContext sdkContext) {\n+        this.httpPipeline = httpPipeline;\n+        if (httpPipeline != null) {\n+            this.resourceManager = ResourceManager.authenticate(httpPipeline, profile)\n                     .withSdkContext(sdkContext)\n-                    .withSubscription(subscriptionId);\n+                    .withDefaultSubscription();", "originalCommit": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ2NjM1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415466352", "bodyText": "This is the step to create instance of ResourceManager rather than instance of ResourceManager.Authenticated. It will take subscription id from profile.", "author": "xseeseesee", "createdAt": "2020-04-27T02:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzI4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415303289", "bodyText": "what's this class used for? I think we don't need this anymore", "author": "yungezz", "createdAt": "2020-04-26T12:49:16Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/policy/AuxiliaryAuthenticationPolicy.java", "diffHunk": "@@ -30,14 +31,17 @@\n     private static final String LINKED_AUTHORIZATION_FAILED = \"LinkedAuthorizationFailed\";\n     private static final String SCHEMA_FORMAT = \"Bearer %s\";\n \n-    private final AzureTokenCredential[] tokenCredentials;\n+    private final TokenCredential[] tokenCredentials;\n+    private final AzureEnvironment environment;\n \n     /**\n      * Initialize an auxiliary authentication policy with the list of AzureTokenCredentials.\n      *\n+     * @param environment the Azure environment\n      * @param credentials the AzureTokenCredentials list\n      */\n-    public AuxiliaryAuthenticationPolicy(AzureTokenCredential... credentials) {\n+    public AuxiliaryAuthenticationPolicy(AzureEnvironment environment, TokenCredential... credentials) {", "originalCommit": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ2NjgzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415466839", "bodyText": "This is the policy used for cross tenant authentication", "author": "xseeseesee", "createdAt": "2020-04-27T02:24:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzQzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415303434", "bodyText": "same as above, if profile, why defaultsubs? what's defaultsubs?", "author": "yungezz", "createdAt": "2020-04-26T12:50:02Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/policy/ProviderRegistrationPolicy.java", "diffHunk": "@@ -67,16 +69,9 @@ private boolean isResponseSuccessful(HttpResponse response) {\n                             }\n \n                             if (cloudError != null && MISSING_SUBSCRIPTION_REGISTRATION.equals(cloudError.getCode())) {\n-                                String subscriptionId = ResourceUtils.extractFromResourceId(\n-                                    request.getUrl().getPath(), \"subscriptions\");\n-                                RestClient restClient = new RestClientBuilder()\n-                                        .withBaseUrl(String.format(\"%s://%s\",\n-                                            request.getUrl().getProtocol(), request.getUrl().getHost()))\n-                                        .withCredential(credential)\n-                                        .withSerializerAdapter(jacksonAdapter).buildClient();\n                                 // TODO: add proxy in rest client\n-                                ResourceManager resourceManager = ResourceManager.authenticate(restClient)\n-                                        .withSubscription(subscriptionId);\n+                                ResourceManager resourceManager = ResourceManager.authenticate(credential, profile)\n+                                        .withDefaultSubscription();", "originalCommit": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ2ODI0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415468247", "bodyText": "At first step, the users can create instance for ResourceManager.Authenticated without subscription id. Next step, they can use withSubscription(id) pass subs id into profile. In another case, they can use withDefaultSubscription() if profile already contains subs id.", "author": "xseeseesee", "createdAt": "2020-04-27T02:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwMzQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNDA3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415304078", "bodyText": "this file will be removed right?", "author": "yungezz", "createdAt": "2020-04-26T12:53:06Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/AzureTokenCredential.java", "diffHunk": "@@ -1,94 +1,94 @@\n // Copyright (c) Microsoft Corporation. All rights reserved.\n // Licensed under the MIT License.\n-\n-package com.azure.management;\n-\n-import com.azure.core.credential.TokenCredential;\n-import com.azure.core.management.AzureEnvironment;\n-\n-import java.net.Proxy;\n-\n-/**\n- * AzureTokenCredential represents a credential object with access to Azure Resource management.\n- */\n-public abstract class AzureTokenCredential implements TokenCredential {\n-\n-    private final AzureEnvironment environment;\n-\n-    private final String domain;\n-\n-    private String defaultSubscription;\n-\n-    private Proxy proxy;\n-\n-    /**\n-     * Initializes a new instance of the AzureTokenCredential.\n-     *\n-     * @param environment the Azure environment to use\n-     * @param domain the tenant or domain the credential is authorized to\n-     */\n-    public AzureTokenCredential(AzureEnvironment environment, String domain) {\n-        this.environment = (environment == null) ? AzureEnvironment.AZURE : environment;\n-        this.domain = domain;\n-    }\n-\n-    /**\n-     * Set default subscription ID.\n-     *\n-     * @param subscriptionId the default subscription ID.\n-     * @return the credentials object itself.\n-     */\n-    public AzureTokenCredential defaultSubscriptionId(String subscriptionId) {\n-        this.defaultSubscription = subscriptionId;\n-        return this;\n-    }\n-\n-    /**\n-     * @param proxy the proxy being used for accessing Active Directory\n-     * @return the credential itself\n-     */\n-    public AzureTokenCredential proxy(Proxy proxy) {\n-        this.proxy = proxy;\n-        return this;\n-    }\n-\n-    /**\n-     * Get default scope of MSAL for ARM\n-     *\n-     * @return default scope in string\n-     */\n-    protected String getDefaultScope() {\n-        return this.getEnvironment().getResourceManagerEndpoint() + \"/.default\";\n-    }\n-\n-    /**\n-     * Override this method to provide the domain or tenant ID the token is valid in.\n-     *\n-     * @return the domain or tenant ID string\n-     */\n-    public String getDomain() {\n-        return domain;\n-    }\n-\n-    /**\n-     * @return the environment details the credential has access to.\n-     */\n-    public AzureEnvironment getEnvironment() {\n-        return environment;\n-    }\n-\n-    /**\n-     * @return The default subscription ID, if any\n-     */\n-    public String getDefaultSubscriptionId() {\n-        return defaultSubscription;\n-    }\n-\n-\n-    /**\n-     * @return the proxy being used for accessing Active Directory.\n-     */\n-    public Proxy getProxy() {\n-        return proxy;\n-    }\n-}\n+//", "originalCommit": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ2ODM5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415468394", "bodyText": "I will remove all redundant before merging.", "author": "xseeseesee", "createdAt": "2020-04-27T02:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNDA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNDE3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415304172", "bodyText": "this file will be removed right", "author": "yungezz", "createdAt": "2020-04-26T12:53:36Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/ApplicationTokenCredential.java", "diffHunk": "@@ -1,140 +1,140 @@\n // Copyright (c) Microsoft Corporation. All rights reserved.\n // Licensed under the MIT License.\n-\n-package com.azure.management;\n-\n-import com.azure.core.credential.AccessToken;\n-import com.azure.core.credential.SimpleTokenCache;\n-import com.azure.core.credential.TokenRequestContext;\n-import com.azure.core.management.AzureEnvironment;\n-import com.azure.identity.ClientSecretCredential;\n-import com.azure.identity.ClientSecretCredentialBuilder;\n-import reactor.core.publisher.Mono;\n-\n-import java.io.File;\n-import java.io.IOException;\n-import java.util.List;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n-import java.util.function.Function;\n-\n-/**\n- * This class describes the credential for service principal.\n- */\n-public class ApplicationTokenCredential extends AzureTokenCredential {\n-\n-    private final ConcurrentMap<String, SimpleTokenCache> cache = new ConcurrentHashMap<>();\n-\n-    private final String clientId;\n-    private final String clientSecret;\n-    private final byte[] clientCertificate;\n-    private final String clientCertificatePassword;\n-    private final ClientSecretCredential clientSecretCredential;\n-\n-    /**\n-     * Initializes a new instance of the ApplicationTokenCredentials.\n-     *\n-     * @param clientId the active directory application client id. Also known as\n-     *                 Application Id which Identifies the application that is using the token.\n-     * @param domain the domain or tenant id containing this application.\n-     * @param secret the authentication secret for the application.\n-     * @param environment the Azure environment to authenticate with.\n-     *                    If null is provided, AzureEnvironment.AZURE will be used.\n-     */\n-    public ApplicationTokenCredential(String clientId, String domain, String secret, AzureEnvironment environment) {\n-        super(environment, domain);\n-        this.clientId = clientId;\n-        this.clientSecret = secret;\n-        this.clientCertificate = null;\n-        this.clientCertificatePassword = null;\n-        this.clientSecretCredential = new ClientSecretCredentialBuilder()\n-                .clientId(this.getClientId())\n-                .clientSecret(this.getClientSecret())\n-                .tenantId(getDomain())\n-                .build();\n-    }\n-\n-    /**\n-     * Initializes a new instance of the ApplicationTokenCredentials.\n-     *\n-     * @param clientId the active directory application client id. Also known as\n-     *                 Application Id which Identifies the application that is using the token.\n-     * @param domain the domain or tenant id containing this application.\n-     * @param certificate the PKCS12 certificate file content\n-     * @param password the password to the certificate file\n-     * @param environment the Azure environment to authenticate with.\n-     *                    If null is provided, AzureEnvironment.AZURE will be used.\n-     */\n-    public ApplicationTokenCredential(String clientId, String domain, byte[] certificate,\n-                                      String password, AzureEnvironment environment) {\n-        super(environment, domain);\n-        this.clientId = clientId;\n-        this.clientSecret = null;\n-        this.clientCertificate = certificate.clone();\n-        this.clientCertificatePassword = password;\n-        this.clientSecretCredential = null;\n-    }\n-\n-    /**\n-     * Initializes the credentials based on the provided credentials file.\n-     *\n-     * @param credentialFile A  file with credentials, using the standard Java properties format.\n-     * and the following keys:\n-     *     subscription=&lt;subscription-id&gt;\n-     *     tenant=&lt;tenant-id&gt;\n-     *     client=&lt;client-id&gt;\n-     *     key=&lt;client-key&gt;\n-     *     managementURI=&lt;management-URI&gt;\n-     *     baseURL=&lt;base-URL&gt;\n-     *     authURL=&lt;authentication-URL&gt;\n-     * or a JSON format and the following keys\n-     * {\n-     *     \"clientId\": \"&lt;client-id&gt;\",\n-     *     \"clientSecret\": \"&lt;client-key&gt;\",\n-     *     \"subscriptionId\": \"&lt;subscription-id&gt;\",\n-     *     \"tenantId\": \"&lt;tenant-id&gt;\",\n-     * }\n-     * and any custom endpoints listed in {@link AzureEnvironment}.\n-     *\n-     * @return The credentials based on the file.\n-     * @throws IOException exception thrown from file access errors.\n-     */\n-    public static ApplicationTokenCredential fromFile(File credentialFile) throws IOException {\n-        return AuthFile.parse(credentialFile).generateCredential();\n-    }\n-\n-    /**\n-     * Gets the active directory application client id. Also known as\n-     * Application Id which Identifies the application that is using the token.\n-     *\n-     * @return the active directory application client id.\n-     */\n-    public String getClientId() {\n-        return this.clientId;\n-    }\n-\n-    String getClientSecret() {\n-        return this.clientSecret;\n-    }\n-\n-    byte[] getClientCertificate() {\n-        return this.clientCertificate;\n-    }\n-\n-    String getClientCertificatePassword() {\n-        return this.clientCertificatePassword;\n-    }\n-\n-    @Override\n-    public Mono<AccessToken> getToken(TokenRequestContext request) {\n-        // TODO: Add client certificate token\n-        List<String> scopes = request.getScopes();\n-        String digest = String.join(\" \", scopes);\n-\n-        Function<String, SimpleTokenCache> computeSimpleTokenCache = key ->\n-                new SimpleTokenCache(() -> clientSecretCredential.getToken(request));\n-\n-        return Mono.just(cache.computeIfAbsent(digest, computeSimpleTokenCache))\n-                .flatMap(simpleTokenCache -> simpleTokenCache.getToken());\n-    }\n-}\n+//", "originalCommit": "7b4f4ba9ef59c3f3b4e90d7882d97ee7fdb8b021", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04d97d1f05230f358d764503ce77cc7ac3926215", "url": "https://github.com/Azure/azure-sdk-for-java/commit/04d97d1f05230f358d764503ce77cc7ac3926215", "message": "Merge branch 'master' into restclient-identity", "committedDate": "2020-04-27T03:22:48Z", "type": "commit"}, {"oid": "b13d462321d9013834fd6c13f2b9359f55c109b6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b13d462321d9013834fd6c13f2b9359f55c109b6", "message": "fix compile error after merging from master", "committedDate": "2020-04-27T03:45:11Z", "type": "commit"}, {"oid": "3b76f5e5eb04cd81b7e37d43dfdd2ed8ddb1f79c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3b76f5e5eb04cd81b7e37d43dfdd2ed8ddb1f79c", "message": "fix errors catched in CI pipeline", "committedDate": "2020-04-27T04:22:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ5OTI1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415499254", "bodyText": "Maybe improve to either 1. document in javadoc that AzureEnvironment.AZURE can be used as azure global; 2. or an overloaded constructor\nPrefer Objects.requireNonNull", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T04:21:02Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/profile/AzureProfile.java", "diffHunk": "@@ -0,0 +1,98 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.management.resources.fluentcore.profile;\n+\n+import com.azure.core.management.AzureEnvironment;\n+import com.azure.core.util.Configuration;\n+\n+/**\n+ * Azure profile for client.\n+ */\n+public class AzureProfile {\n+\n+    private String tenantId;\n+    private String subscriptionId;\n+    private AzureEnvironment environment;\n+    private final Configuration configuration = Configuration.getGlobalConfiguration();\n+\n+    /**\n+     * Creates AzureProfile instance with Azure environment.\n+     *\n+     * @param environment the Azure environment\n+     */\n+    public AzureProfile(AzureEnvironment environment) {", "originalCommit": "04d97d1f05230f358d764503ce77cc7ac3926215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxMjIxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415512213", "bodyText": "Agree, I will prefer javadoc.", "author": "xseeseesee", "createdAt": "2020-04-27T05:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ5OTI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ5OTk2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415499964", "bodyText": "Prefer not to have a null environment from start.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T04:23:37Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/profile/AzureProfile.java", "diffHunk": "@@ -0,0 +1,98 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.management.resources.fluentcore.profile;\n+\n+import com.azure.core.management.AzureEnvironment;\n+import com.azure.core.util.Configuration;\n+\n+/**\n+ * Azure profile for client.\n+ */\n+public class AzureProfile {\n+\n+    private String tenantId;\n+    private String subscriptionId;\n+    private AzureEnvironment environment;\n+    private final Configuration configuration = Configuration.getGlobalConfiguration();\n+\n+    /**\n+     * Creates AzureProfile instance with Azure environment.\n+     *\n+     * @param environment the Azure environment\n+     */\n+    public AzureProfile(AzureEnvironment environment) {\n+        this(null, null, environment);\n+    }\n+\n+    /**\n+     * Creates AzureProfile instance with tenant ID, subscription ID and Azure environment.\n+     *\n+     * @param tenantId the tenant ID required for Graph Rbac\n+     * @param subscriptionId the subscription ID required for resource management\n+     * @param environment the Azure environment\n+     */\n+    public AzureProfile(String tenantId, String subscriptionId, AzureEnvironment environment) {\n+        this.tenantId = tenantId;\n+        this.subscriptionId = subscriptionId;\n+        this.environment = environment;\n+    }\n+\n+    /**\n+     * Sets tenant ID to use related services within GraphRbac, AppService, KeyVault.\n+     *\n+     * @param tenantId the tenant ID required for Graph Rbac\n+     * @return the Azure profile\n+     */\n+    public AzureProfile withTenantId(String tenantId) {\n+        this.tenantId = tenantId;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets subscription ID for resource management.\n+     *\n+     * @param subscriptionId the subscription ID\n+     * @return the Azure profile\n+     */\n+    public AzureProfile withSubscriptionId(String subscriptionId) {\n+        this.subscriptionId = subscriptionId;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets tenant ID.\n+     *\n+     * @return the tenant ID\n+     */\n+    public String tenantId() {\n+        if (this.tenantId == null) {\n+            this.tenantId = configuration.get(Configuration.PROPERTY_AZURE_TENANT_ID);\n+        }\n+        return this.tenantId;\n+    }\n+\n+    /**\n+     * Gets subscription ID.\n+     *\n+     * @return the subscription ID\n+     */\n+    public String subscriptionId() {\n+        if (this.subscriptionId == null) {\n+            this.subscriptionId = configuration.get(Configuration.PROPERTY_AZURE_SUBSCRIPTION_ID);\n+        }\n+        return this.subscriptionId;\n+    }\n+\n+    /**\n+     * Gets Azure environment.\n+     *\n+     * @return the Azure environment\n+     */\n+    public AzureEnvironment environment() {\n+        if (this.environment == null) {\n+            this.environment = AzureEnvironment.AZURE;\n+        }", "originalCommit": "04d97d1f05230f358d764503ce77cc7ac3926215", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwMTMzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415501336", "bodyText": "Prefer this be settable, so user can choose to use or not use the configuration.\nIn this code they do not have the choice at all.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T04:28:21Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/profile/AzureProfile.java", "diffHunk": "@@ -0,0 +1,98 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.management.resources.fluentcore.profile;\n+\n+import com.azure.core.management.AzureEnvironment;\n+import com.azure.core.util.Configuration;\n+\n+/**\n+ * Azure profile for client.\n+ */\n+public class AzureProfile {\n+\n+    private String tenantId;\n+    private String subscriptionId;\n+    private AzureEnvironment environment;\n+    private final Configuration configuration = Configuration.getGlobalConfiguration();", "originalCommit": "04d97d1f05230f358d764503ce77cc7ac3926215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxNTg3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415515875", "bodyText": "I prefer to have boolean flag/method like allowGlobalConfiguration if we want to make it settable. I was thinking about to have a builder class, just not sure if we should apply the style of  with*() to builder class here.", "author": "xseeseesee", "createdAt": "2020-04-27T05:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwMTMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMwODgwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416308802", "bodyText": "Update?", "author": "weidongxu-microsoft", "createdAt": "2020-04-28T03:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwMTMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwNDQ0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415504442", "bodyText": "host url should be correct, same resource manager endpoint..\nPrefer re-run some live appservice sample tests before merge.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T04:38:15Z", "path": "sdk/appservice/mgmt/src/main/java/com/azure/management/appservice/implementation/FunctionAppImpl.java", "diffHunk": "@@ -92,8 +96,9 @@\n         SiteLogsConfigInner logConfig,\n         AppServiceManager manager) {\n         super(name, innerObject, siteConfig, logConfig, manager);\n-        functionAppKeyServiceHost = manager.restClient().getBaseUrl().toString();\n-        functionAppKeyService = RestProxy.create(FunctionAppKeyService.class, manager.restClient().getHttpPipeline());\n+        // TODO: confirm host url", "originalCommit": "04d97d1f05230f358d764503ce77cc7ac3926215", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwNTA5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415505098", "bodyText": "This is not correct. Should be the baseUrl above.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T04:40:35Z", "path": "sdk/appservice/mgmt/src/main/java/com/azure/management/appservice/implementation/FunctionAppImpl.java", "diffHunk": "@@ -111,16 +116,20 @@ private void initializeFunctionService() {\n             } catch (MalformedURLException e) {\n                 throw logger.logExceptionAsError(new IllegalStateException(e));\n             }\n-            RestClient client =\n-                manager()\n-                    .restClient()\n-                    .newBuilder()\n-                    .withBaseUrl(baseUrl)\n-                    .withPolicy(new FunctionAuthenticationPolicy(this))\n-                    .buildClient();\n-            functionServiceHost = client.getBaseUrl().toString();\n+\n+            List<HttpPipelinePolicy> policies = new ArrayList<>();\n+            for (int i = 0, count = manager().httpPipeline().getPolicyCount(); i < count; ++i) {\n+                policies.add(manager().httpPipeline().getPolicy(i));\n+            }\n+            policies.add(new FunctionAuthenticationPolicy(this));\n+            HttpPipeline httpPipeline= new HttpPipelineBuilder()\n+                .policies(policies.toArray(new HttpPipelinePolicy[0]))\n+                .httpClient(manager().httpPipeline().getHttpClient())\n+                .build();\n+            //TODO: confirm host url\n+            functionServiceHost = manager().environment().getResourceManagerEndpoint();", "originalCommit": "04d97d1f05230f358d764503ce77cc7ac3926215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxNjc2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415516762", "bodyText": "For my understanding, it will be resource manager endpoint too as per the flow we start from TestBase to AppServiceManager to FunctionAppImpl. It seems there isn't any code snippet to change baseUrl after we set resouce manager endpoint initially.", "author": "xseeseesee", "createdAt": "2020-04-27T05:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwNTA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUyNTUxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415525514", "bodyText": "I wrote this so I am very sure. It is not mgmt client. It is like kudu client, host of which is xxx.azurewebsite.net", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T05:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwNTA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwNzY0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415507646", "bodyText": "Improve the javadoc before merge. Restate the class name is not very useful.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T04:49:02Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/utils/HttpPipelineProvider.java", "diffHunk": "@@ -0,0 +1,77 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.management.resources.fluentcore.utils;\n+\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpPipeline;\n+import com.azure.core.http.HttpPipelineBuilder;\n+import com.azure.core.http.policy.HttpLogDetailLevel;\n+import com.azure.core.http.policy.HttpLogOptions;\n+import com.azure.core.http.policy.HttpLoggingPolicy;\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.http.policy.HttpPolicyProviders;\n+import com.azure.core.http.policy.RetryPolicy;\n+import com.azure.management.AuthenticationPolicy;\n+import com.azure.management.UserAgentPolicy;\n+import com.azure.management.resources.fluentcore.policy.ProviderRegistrationPolicy;\n+import com.azure.management.resources.fluentcore.policy.ResourceManagerThrottlingPolicy;\n+import com.azure.management.resources.fluentcore.profile.AzureProfile;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * A Http Pipeline Provider.", "originalCommit": "3b76f5e5eb04cd81b7e37d43dfdd2ed8ddb1f79c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxMzc1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415513751", "bodyText": "Does this need to be in sync with HttpPipelineProvider.buildHttpPipeline(TokenCredential credential, AzureProfile profile)?\nProviderRegistrationPolicy and ResourceManagerThrottlingPolicy seems not here?", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T05:08:08Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -92,21 +114,45 @@ public T withProxy(Proxy proxy) {\n         return null;\n     }\n \n-    protected RestClient buildRestClient(AzureTokenCredential credential, AzureEnvironment.Endpoint endpoint) {\n-        RestClient client = restClientBuilder\n-                .withBaseUrl(credential.getEnvironment(), endpoint)\n-                .withCredential(credential)\n-//                .withPolicy(new ProviderRegistrationPolicy())\n-//                .withPolicy(new ResourceManagerThrottlingPolicy())\n-                .buildClient();\n-        // TODO: Add proxy support\n-//        if (client.httpClient().proxy() != null) {\n-//            credentials.withProxy(client.httpClient().proxy());\n-//        }\n-        return client;\n+    @Override\n+    public T withScope(String scope) {\n+        Objects.requireNonNull(scope);\n+        this.scopes.add(scope);\n+        return (T) this;\n+    }\n+\n+    @Override\n+    public T withHttpClient(HttpClient httpClient) {\n+        Objects.requireNonNull(httpClient);\n+        this.httpClient = httpClient;\n+        return (T) this;\n+    }\n+\n+    @Override\n+    public T withConfiguration(Configuration configuration) {\n+        Objects.requireNonNull(configuration);\n+        this.configuration = configuration;\n+        return (T) this;\n+    }\n+\n+    protected HttpPipeline buildHttpPipeline(TokenCredential credential, AzureProfile profile) {", "originalCommit": "3b76f5e5eb04cd81b7e37d43dfdd2ed8ddb1f79c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxNTI3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415515279", "bodyText": "This is a TODO item I marked in provider class. I will discuss with @ChenTanyi for the basic policies we should provide if the users don't make customization.", "author": "xseeseesee", "createdAt": "2020-04-27T05:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxMzc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxNTk1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415515953", "bodyText": "You can delete it.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T05:14:52Z", "path": "sdk/management/azure/src/main/java/com/azure/management/Azure.java", "diffHunk": "@@ -124,76 +123,69 @@\n     private final SdkContext sdkContext;\n \n     /**\n-     * Authenticate to Azure using an Azure credentials object.\n+     * Authenticate to Azure using an Azure credential object.\n      *\n-     * @param credential the credentials object\n+     * @param credential the credential object\n+     * @param profile the profile to use\n      * @return the authenticated Azure client\n      */\n-    public static Authenticated authenticate(AzureTokenCredential credential) {\n-        return new AuthenticatedImpl(\n-            new RestClientBuilder()\n-                .withBaseUrl(credential.getEnvironment(), AzureEnvironment.Endpoint.RESOURCE_MANAGER)\n-                .withCredential(credential)\n-                .withSerializerAdapter(new AzureJacksonAdapter())\n-                .withPolicy(new ProviderRegistrationPolicy(credential))\n-                .withPolicy(new ResourceManagerThrottlingPolicy())\n-                .buildClient(),\n-            credential.getDomain());\n-    }\n-\n-    /**\n-     * Authenticates API access using a properties file containing the required credentials.\n-     *\n-     * @param credentialsFile the file containing the credentials in the standard Java properties file format, with the\n-     *     following keys:\n-     *     <p><code>\n-     *                        subscription= #subscription ID<br>\n-     *                        tenant= #tenant ID<br>\n-     *                        client= #client id<br>\n-     *                        key= #client key<br>\n-     *                        managementURI= #management URI<br>\n-     *                        baseURL= #base URL<br>\n-     *                        authURL= #authentication URL<br>\n-     *                        </code>\n-     * @return authenticated Azure client\n-     * @throws IOException exception thrown from file access\n-     */\n-    public static Authenticated authenticate(File credentialsFile) throws IOException {\n-        ApplicationTokenCredential credential = ApplicationTokenCredential.fromFile(credentialsFile);\n-        return new AuthenticatedImpl(\n-                new RestClientBuilder()\n-                    .withBaseUrl(credential.getEnvironment(), AzureEnvironment.Endpoint.RESOURCE_MANAGER)\n-                    .withCredential(credential)\n-                    .withSerializerAdapter(new AzureJacksonAdapter())\n-                    .withPolicy(new ProviderRegistrationPolicy(credential))\n-                    .withPolicy(new ResourceManagerThrottlingPolicy())\n-                    .buildClient(),\n-                credential.getDomain())\n-            .withDefaultSubscription(credential.getDefaultSubscriptionId());\n-    }\n+    public static Authenticated authenticate(TokenCredential credential, AzureProfile profile) {\n+        return new AuthenticatedImpl(HttpPipelineProvider.buildHttpPipeline(credential, profile), profile);\n+    }\n+\n+//    /**\n+//     * Authenticates API access using a properties file containing the required credential.\n+//     *\n+//     * @param credentialFile the file containing the credential in the standard Java properties file format, with the\n+//     *     following keys:\n+//     *     <p><code>\n+//     *                        subscription= #subscription ID<br>\n+//     *                        tenant= #tenant ID<br>\n+//     *                        client= #client id<br>\n+//     *                        key= #client key<br>\n+//     *                        managementURI= #management URI<br>\n+//     *                        baseURL= #base URL<br>\n+//     *                        authURL= #authentication URL<br>\n+//     *                        </code>\n+//     * @return authenticated Azure client\n+//     * @throws IOException exception thrown from file access\n+//     */\n+//    public static Authenticated authenticate(File credentialFile) throws IOException {", "originalCommit": "3b76f5e5eb04cd81b7e37d43dfdd2ed8ddb1f79c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUxNjU5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415516596", "bodyText": "Maybe do a throw if subscriptionId is null in profile? If user really want to provide a null subscriptionId, we would like them to do it explicitly in withSubscription(String subscriptionId). (or we should not allow null subscriptionId at all?)\nAlso when will CloudException happen? It is scheduled to be deleted from core-mgmt.\nOK I see, it is this.subscriptions().list(). You no longer calls this, so I think you should remove it.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T05:16:47Z", "path": "sdk/management/azure/src/main/java/com/azure/management/Azure.java", "diffHunk": "@@ -384,51 +369,43 @@ public SdkContext sdkContext() {\n \n         @Override\n         public Azure withSubscription(String subscriptionId) {\n-            return new Azure(restClient, subscriptionId, tenantId, this);\n+            profile.withSubscriptionId(subscriptionId);\n+            return new Azure(httpPipeline, profile, this);\n         }\n \n         @Override\n-        public Azure withDefaultSubscription() throws CloudException, IOException {\n-            if (this.defaultSubscription != null) {\n-                return withSubscription(this.defaultSubscription);\n-            } else {\n-                PagedIterable<Subscription> subs = this.subscriptions().list();\n-                if (subs.iterator().hasNext()) {\n-                    return withSubscription(subs.iterator().next().subscriptionId());\n-                } else {\n-                    return withSubscription(null);\n-                }\n-            }\n+        public Azure withDefaultSubscription() throws CloudException {\n+            return new Azure(httpPipeline, profile, this);", "originalCommit": "3b76f5e5eb04cd81b7e37d43dfdd2ed8ddb1f79c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04cbdc7200e93f469299a83ef554f98ef37d70bb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/04cbdc7200e93f469299a83ef554f98ef37d70bb", "message": "fix checkstyle after merging", "committedDate": "2020-04-27T05:37:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUyODEwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r415528102", "bodyText": "Just delete it. You can have a backup on your forked repo if needed.", "author": "weidongxu-microsoft", "createdAt": "2020-04-27T05:50:22Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/utils/Utils.java", "diffHunk": "@@ -193,34 +188,34 @@ public static void removeFromList(List<String> list, String value) {\n         }\n     }\n \n-    /**\n-     * Try to extract the environment the client is authenticated to based\n-     * on the information on the rest client.\n-     *\n-     * @param restClient the RestClient instance\n-     * @return the non-null AzureEnvironment\n-     */\n-    public static AzureEnvironment extractAzureEnvironment(RestClient restClient) {\n-        AzureEnvironment environment = null;\n-        if (restClient.getCredential() instanceof AzureTokenCredential) {\n-            environment = ((AzureTokenCredential) restClient.getCredential()).getEnvironment();\n-        } else {\n-            String baseUrl = restClient.getBaseUrl().toString();\n-            for (AzureEnvironment env : AzureEnvironment.knownEnvironments()) {\n-                if (env.getResourceManagerEndpoint().toLowerCase(Locale.ROOT)\n-                        .contains(baseUrl.toLowerCase(Locale.ROOT))) {\n-                    environment = env;\n-                    break;\n-                }\n-            }\n-            if (environment == null) {\n-                ClientLogger logger = new ClientLogger(Utils.class);\n-                throw logger.logExceptionAsError(\n-                    new IllegalArgumentException(\"Unknown resource manager endpoint \" + baseUrl));\n-            }\n-        }\n-        return environment;\n-    }\n+//    /**\n+//     * Try to extract the environment the client is authenticated to based\n+//     * on the information on the rest client.\n+//     *\n+//     * @param restClient the RestClient instance\n+//     * @return the non-null AzureEnvironment\n+//     */\n+//    public static AzureEnvironment extractAzureEnvironment(RestClient restClient) {", "originalCommit": "04cbdc7200e93f469299a83ef554f98ef37d70bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cb6b7ef66726bfb9760d15d0fe4520aa34d95ade", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cb6b7ef66726bfb9760d15d0fe4520aa34d95ade", "message": "update by review comments", "committedDate": "2020-04-27T10:16:42Z", "type": "commit"}, {"oid": "1be81c62db2fe639ed45e66cf00c1a23afc326d5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1be81c62db2fe639ed45e66cf00c1a23afc326d5", "message": "clean code", "committedDate": "2020-04-27T10:36:22Z", "type": "commit"}, {"oid": "a2fd96859e37e660f50545fdde28b878353f3367", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a2fd96859e37e660f50545fdde28b878353f3367", "message": "update configure APIs and javadoc", "committedDate": "2020-04-27T11:14:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxMTUxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416311519", "bodyText": "@weidongxu-microsoft The configuration is used when the user might prefer EnvironmentCredential. Instead of making configuration settable, I prefer following the way how environment credential handles configuration. At least for credential related, the user only need to set environment variables in their system.", "author": "xseeseesee", "createdAt": "2020-04-28T04:08:02Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/profile/AzureProfile.java", "diffHunk": "@@ -20,6 +20,12 @@\n \n     /**\n      * Creates AzureProfile instance with Azure environment. The global environment is {@link AzureEnvironment#AZURE}.\n+     * The tenant ID and subscription ID can be set via environment variables. The environment variables are expected", "originalCommit": "a2fd96859e37e660f50545fdde28b878353f3367", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxMzIzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416313230", "bodyText": "Like I said, I prefer user knows when configure from env is used, when it is not, and has the choice on the decision. That is the reason of the existence of EnvironmentCredential class at first place. It let user use the credential from env consciously.", "author": "weidongxu-microsoft", "createdAt": "2020-04-28T04:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxMTUxOQ=="}], "type": "inlineReview"}, {"oid": "326f7999ce776c81f0ac96f2141cdff9951eecf0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/326f7999ce776c81f0ac96f2141cdff9951eecf0", "message": "support option to load from environment variables", "committedDate": "2020-04-28T04:44:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMyMzc5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416323790", "bodyText": "Seems no need to clone it?", "author": "weidongxu-microsoft", "createdAt": "2020-04-28T04:48:18Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/profile/AzureProfile.java", "diffHunk": "@@ -28,9 +27,15 @@\n      * </ul>\n      *\n      * @param environment the Azure environment\n+     * @param loadEnvironmentVariables the boolean flag indicates whether the environment variables are set\n      */\n-    public AzureProfile(AzureEnvironment environment) {\n-        this(null, null, environment);\n+    public AzureProfile(AzureEnvironment environment, boolean loadEnvironmentVariables) {\n+        Objects.requireNonNull(environment);\n+        if (loadEnvironmentVariables) {\n+            Configuration configuration = Configuration.getGlobalConfiguration().clone();", "originalCommit": "326f7999ce776c81f0ac96f2141cdff9951eecf0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxNDIzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416314232", "bodyText": "Where do you add subId and tenantId in samples?", "author": "ChenTanyi", "createdAt": "2020-04-28T04:16:49Z", "path": "sdk/management/samples/src/main/java/com/azure/management/containerregistry/samples/ManageContainerRegistryWithWebhooks.java", "diffHunk": "@@ -201,11 +204,15 @@ public static void main(String[] args) {\n             //=============================================================\n             // Authenticate\n \n-            final File credFile = new File(System.getenv(\"AZURE_AUTH_LOCATION\"));\n+            final AzureProfile profile = new AzureProfile(AzureEnvironment.AZURE);", "originalCommit": "a2fd96859e37e660f50545fdde28b878353f3367", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxNTE2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416315160", "bodyText": "Keep this in order for default subs. Meanwhile add a with default tenant like it. Since these two could be null in profile. I think it more friendly than all need user to add.", "author": "ChenTanyi", "createdAt": "2020-04-28T04:20:18Z", "path": "sdk/management/azure/src/main/java/com/azure/management/Azure.java", "diffHunk": "@@ -384,51 +301,47 @@ public SdkContext sdkContext() {\n \n         @Override\n         public Azure withSubscription(String subscriptionId) {\n-            return new Azure(restClient, subscriptionId, tenantId, this);\n+            profile.withSubscriptionId(subscriptionId);\n+            return new Azure(httpPipeline, profile, this);\n         }\n \n         @Override\n-        public Azure withDefaultSubscription() throws CloudException, IOException {\n-            if (this.defaultSubscription != null) {\n-                return withSubscription(this.defaultSubscription);\n-            } else {\n-                PagedIterable<Subscription> subs = this.subscriptions().list();\n-                if (subs.iterator().hasNext()) {\n-                    return withSubscription(subs.iterator().next().subscriptionId());\n-                } else {\n-                    return withSubscription(null);\n-                }", "originalCommit": "a2fd96859e37e660f50545fdde28b878353f3367", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMyODMwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416328300", "bodyText": "Personally I kind of against this code. It might just pick a wrong subscription id and mess things up, without user knowing anything.\nIf there is only 1 subscription, this might be a good guess. If there is more than 1, it almost 100% wrong.", "author": "weidongxu-microsoft", "createdAt": "2020-04-28T05:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxNTE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMzMjM5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416332399", "bodyText": "em, I'm not sure how many user will use only one subs for every credential. Like me, my auth will always be only one subs.\nOk to remove it as I think it may be many beginner use the code in sample and will not set subs when call the default subs.", "author": "ChenTanyi", "createdAt": "2020-04-28T05:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxNTE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMzNzc4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416337784", "bodyText": "Yes, file usually only have one, but that is already coded in that file (and we kind of deprecate file for now). Our tenant actually got 10+ subIds, and I think you can list all of them in this stage.\nMaybe we can add e.g. withSingleSubscription if requirement arise (but still prefer only do this if there is only 1 subscriptionId avaliable, hence the mock name).", "author": "weidongxu-microsoft", "createdAt": "2020-04-28T05:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxNTE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM0MDUzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416340535", "bodyText": "No, My auth will always list one subs from azure, since I only add one subs permission to one service principal, it will not list other subs.\nI think we could use withProfileSubscription and withFirstSubscriptionFetched to distinguish if we want. Sometimes the withDefaultSubscription is a little strange.", "author": "ChenTanyi", "createdAt": "2020-04-28T05:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxNTE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMxNzY3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10492#discussion_r416317672", "bodyText": "I think addAll may be more reasonable? Like scopes", "author": "ChenTanyi", "createdAt": "2020-04-28T04:28:48Z", "path": "sdk/resources/mgmt/src/main/java/com/azure/management/resources/fluentcore/arm/implementation/AzureConfigurableImpl.java", "diffHunk": "@@ -23,90 +27,88 @@\n  * @param <T> the type of the configurable interface\n  */\n public class AzureConfigurableImpl<T extends AzureConfigurable<T>>\n-        implements AzureConfigurable<T> {\n-    protected RestClientBuilder restClientBuilder;\n+    implements AzureConfigurable<T> {\n+    private HttpClient httpClient;\n+    private HttpLogOptions httpLogOptions;\n+    private List<HttpPipelinePolicy> policies;\n+    private List<String> scopes;\n+    private RetryPolicy retryPolicy;\n+    private Configuration configuration;\n+    private TokenCredential[] tokens;\n \n     protected AzureConfigurableImpl() {\n-        this.restClientBuilder = new RestClientBuilder()\n-                .withSerializerAdapter(new AzureJacksonAdapter());\n+        policies = new ArrayList<>();\n+        scopes = new ArrayList<>();\n+        retryPolicy = new RetryPolicy();\n+        httpLogOptions = new HttpLogOptions().setLogLevel(HttpLogDetailLevel.NONE);\n     }\n \n     @Override\n-    public T withLogOptions(HttpLogOptions level) {\n-        this.restClientBuilder = this.restClientBuilder.withHttpLogOptions(level);\n+    public T withLogOptions(HttpLogOptions httpLogOptions) {\n+        Objects.requireNonNull(httpLogOptions);\n+        this.httpLogOptions = httpLogOptions;\n         return (T) this;\n     }\n \n     @Override\n     public T withLogLevel(HttpLogDetailLevel logLevel) {\n-        this.restClientBuilder = this.restClientBuilder.withLogLevel(logLevel);\n+        Objects.requireNonNull(logLevel);\n+        this.httpLogOptions = httpLogOptions.setLogLevel(logLevel);\n         return (T) this;\n     }\n \n     @Override\n     public T withPolicy(HttpPipelinePolicy policy) {\n-        this.restClientBuilder = this.restClientBuilder.withPolicy(policy);\n+        Objects.requireNonNull(policy);\n+        policies.add(policy);\n         return (T) this;\n     }\n \n     @Override\n-    public T withAuxiliaryCredentials(AzureTokenCredential... tokens) {\n-        return null;\n-    }\n-\n-//    @Override\n-//    public T withAuxiliaryCredentials(AzureTokenCredentials... tokens) {\n-//        if (tokens != null) {\n-//            if (tokens.length > 3) {\n-//                throw new IllegalArgumentException(\"Only can hold up to three auxiliary tokens.\");\n-//            }\n-//            AuxiliaryCredentialsInterceptor interceptor = new AuxiliaryCredentialsInterceptor(tokens);\n-//            this.restClientBuilder = this.restClientBuilder.withInterceptor(interceptor);\n-//        }\n-//        return (T) this;\n-//    }\n-\n-    @Override\n-    public T withUserAgent(String userAgent) {\n-        this.restClientBuilder = this.restClientBuilder.withUserAgent(userAgent);\n+    public T withAuxiliaryCredentials(TokenCredential... tokens) {\n+        Objects.requireNonNull(tokens);\n+        this.tokens = tokens;", "originalCommit": "a2fd96859e37e660f50545fdde28b878353f3367", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3cf90465254a82831bca5caa75955352835b3168", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3cf90465254a82831bca5caa75955352835b3168", "message": "update sample with new AzureProfile constructor", "committedDate": "2020-04-28T05:45:05Z", "type": "commit"}]}