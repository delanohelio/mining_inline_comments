{"pr_number": 13688, "pr_title": "FixGroupByPaging", "pr_createdAt": "2020-07-31T16:43:49Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13688", "timeline": [{"oid": "22e04d7932b3b8690212665953b03ebb10ba9fb8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/22e04d7932b3b8690212665953b03ebb10ba9fb8", "message": "FixGroupByPagingScenario", "committedDate": "2020-07-31T16:41:56Z", "type": "commit"}, {"oid": "50503046a4b9912df74df81138e58761c44e2f17", "url": "https://github.com/Azure/azure-sdk-for-java/commit/50503046a4b9912df74df81138e58761c44e2f17", "message": "fix compilation and add requestCharge test", "committedDate": "2020-07-31T17:20:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczNjk2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13688#discussion_r463736965", "bodyText": "Instead of casting it here twice (here and below), let's cast it in the createFeedResponseFromGroupingTable itself and return FeedResponse<T>\nWhat if it is null the very first time ?\nCasting will throw a NPE.", "author": "kushagraThapar", "createdAt": "2020-07-31T17:26:44Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -67,32 +68,49 @@\n     @Override\n     public Flux<FeedResponse<T>> drainAsync(int maxPageSize) {\n         return this.component.drainAsync(maxPageSize)\n-                   .collectList()\n-                   .map(superList -> {\n-                       double requestCharge = 0;\n-                       HashMap<String, String> headers = new HashMap<>();\n-                       List<Document> documentList = new ArrayList<>();\n-                       /* Do groupby stuff here */\n-                       // Stage 1:\n-                       // Drain the groupings fully from all continuation and all partitions\n-                       for (FeedResponse<T> page : superList) {\n-                           List<Document> results = (List<Document>) page.getResults();\n-                           documentList.addAll(results);\n-                       }\n-\n-                       this.aggregateGroupings(documentList);\n-\n-                       // Stage 2:\n-                       // Emit the results from the grouping table page by page\n-\n-                       List<Document> groupByResults = this.groupingTable.drain(maxPageSize);\n-\n-                       headers.put(HttpConstants.HttpHeaders.REQUEST_CHARGE, Double.toString(requestCharge));\n-                       FeedResponse<Document> frp =\n-                           BridgeInternal.createFeedResponse(groupByResults, headers);\n-\n-                       return (FeedResponse<T>) frp;\n-                   }).flux();\n+            .collectList()\n+            .map(superList -> {\n+                double requestCharge = 0;\n+                HashMap<String, String> headers = new HashMap<>();\n+                List<Document> documentList = new ArrayList<>();\n+                /* Do groupBy stuff here */\n+                // Stage 1:\n+                // Drain the groupings fully from all continuation and all partitions\n+                for (FeedResponse<T> page : superList) {\n+                    List<Document> results = (List<Document>) page.getResults();\n+                    documentList.addAll(results);\n+                    requestCharge += page.getRequestCharge();\n+                }\n+\n+                this.aggregateGroupings(documentList);\n+\n+                // Stage 2:\n+                // Emit the results from the grouping table page by page\n+                return (FeedResponse<T>)createFeedResponseFromGroupingTable(maxPageSize, requestCharge);", "originalCommit": "50503046a4b9912df74df81138e58761c44e2f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczNzU1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13688#discussion_r463737554", "bodyText": "You can do the same thing here, what you did down below, return an empty Mono to avoid NPE.", "author": "kushagraThapar", "createdAt": "2020-07-31T17:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczNjk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNTU5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13688#discussion_r464115596", "bodyText": "changed to update in the createFeedResponseFromGroupingTable", "author": "xinlian12", "createdAt": "2020-08-02T19:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczNjk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczNzE0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13688#discussion_r463737146", "bodyText": "Please add some comments to expand (explaining how it will be called second time onwards)", "author": "kushagraThapar", "createdAt": "2020-07-31T17:27:07Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -67,32 +68,49 @@\n     @Override\n     public Flux<FeedResponse<T>> drainAsync(int maxPageSize) {\n         return this.component.drainAsync(maxPageSize)\n-                   .collectList()\n-                   .map(superList -> {\n-                       double requestCharge = 0;\n-                       HashMap<String, String> headers = new HashMap<>();\n-                       List<Document> documentList = new ArrayList<>();\n-                       /* Do groupby stuff here */\n-                       // Stage 1:\n-                       // Drain the groupings fully from all continuation and all partitions\n-                       for (FeedResponse<T> page : superList) {\n-                           List<Document> results = (List<Document>) page.getResults();\n-                           documentList.addAll(results);\n-                       }\n-\n-                       this.aggregateGroupings(documentList);\n-\n-                       // Stage 2:\n-                       // Emit the results from the grouping table page by page\n-\n-                       List<Document> groupByResults = this.groupingTable.drain(maxPageSize);\n-\n-                       headers.put(HttpConstants.HttpHeaders.REQUEST_CHARGE, Double.toString(requestCharge));\n-                       FeedResponse<Document> frp =\n-                           BridgeInternal.createFeedResponse(groupByResults, headers);\n-\n-                       return (FeedResponse<T>) frp;\n-                   }).flux();\n+            .collectList()\n+            .map(superList -> {\n+                double requestCharge = 0;\n+                HashMap<String, String> headers = new HashMap<>();\n+                List<Document> documentList = new ArrayList<>();\n+                /* Do groupBy stuff here */\n+                // Stage 1:\n+                // Drain the groupings fully from all continuation and all partitions\n+                for (FeedResponse<T> page : superList) {\n+                    List<Document> results = (List<Document>) page.getResults();\n+                    documentList.addAll(results);\n+                    requestCharge += page.getRequestCharge();\n+                }\n+\n+                this.aggregateGroupings(documentList);\n+\n+                // Stage 2:\n+                // Emit the results from the grouping table page by page\n+                return (FeedResponse<T>)createFeedResponseFromGroupingTable(maxPageSize, requestCharge);\n+            }).expand(tFeedResponse -> {\n+                // Emit the results from the grouping table page by page", "originalCommit": "50503046a4b9912df74df81138e58761c44e2f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNTU3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13688#discussion_r464115570", "bodyText": "Updated", "author": "xinlian12", "createdAt": "2020-08-02T19:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczNzE0Ng=="}], "type": "inlineReview"}, {"oid": "a78110112a5656dbe59e83f838612ba1d5e4d976", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a78110112a5656dbe59e83f838612ba1d5e4d976", "message": "resolve comments", "committedDate": "2020-07-31T17:40:45Z", "type": "commit"}]}