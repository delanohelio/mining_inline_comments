{"pr_number": 10369, "pr_title": "Intellij credential", "pr_createdAt": "2020-04-20T17:05:04Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10369", "timeline": [{"oid": "8ff54d4d10aac4905f56e4ce099ca27da18d35f2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ff54d4d10aac4905f56e4ce099ca27da18d35f2", "message": "intelliJ credential changes", "committedDate": "2020-04-07T05:25:37Z", "type": "commit"}, {"oid": "a8c5226da15e3e7ab2f9a2ef162753beaf84be02", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a8c5226da15e3e7ab2f9a2ef162753beaf84be02", "message": "use persistence", "committedDate": "2020-04-14T08:53:49Z", "type": "commit"}, {"oid": "558a6e08aea673991a63ca06a4b071cbb373bd98", "url": "https://github.com/Azure/azure-sdk-for-java/commit/558a6e08aea673991a63ca06a4b071cbb373bd98", "message": "update credentials", "committedDate": "2020-04-19T07:34:42Z", "type": "commit"}, {"oid": "74a7a5388b6935422beac8811508967cda0f3929", "url": "https://github.com/Azure/azure-sdk-for-java/commit/74a7a5388b6935422beac8811508967cda0f3929", "message": "windows creds", "committedDate": "2020-04-20T13:13:44Z", "type": "commit"}, {"oid": "389f64da0b8ec0d2168e565d556dde39b5ddbdf9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/389f64da0b8ec0d2168e565d556dde39b5ddbdf9", "message": "update credentials", "committedDate": "2020-04-20T17:03:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0OTA3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r411549078", "bodyText": "I am not sure why this is required. Is this specific to an IDE? It would be good to add some description of why this change is needed.", "author": "srnagar", "createdAt": "2020-04-20T17:13:01Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/IntelliJCredential.java", "diffHunk": "@@ -0,0 +1,54 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.identity.implementation.IdentityClient;\n+import com.azure.identity.implementation.IdentityClientBuilder;\n+import com.azure.identity.implementation.IdentityClientOptions;\n+import com.azure.identity.implementation.MsalToken;\n+import reactor.core.publisher.Mono;\n+\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * A credential provider that provides token credentials based on Azure CLI\n+ * command.\n+ */\n+@Immutable\n+public class IntelliJCredential implements TokenCredential {", "originalCommit": "389f64da0b8ec0d2168e565d556dde39b5ddbdf9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bca088abf05c196123fd93d5e34a9e6ed6f6a2fa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bca088abf05c196123fd93d5e34a9e6ed6f6a2fa", "message": "refactor", "committedDate": "2020-04-22T15:26:24Z", "type": "commit"}, {"oid": "94db19ff3020291c0bccb2f2acf3aefb8af41203", "url": "https://github.com/Azure/azure-sdk-for-java/commit/94db19ff3020291c0bccb2f2acf3aefb8af41203", "message": "refactor", "committedDate": "2020-04-24T10:36:37Z", "type": "commit"}, {"oid": "ea1e85061d6a16c768168c860fbb2ccb660f02d9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ea1e85061d6a16c768168c860fbb2ccb660f02d9", "message": "merge master", "committedDate": "2020-04-24T10:43:05Z", "type": "commit"}, {"oid": "e38a30ff2f93755af72ec4a5353093be4ced3e76", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e38a30ff2f93755af72ec4a5353093be4ced3e76", "message": "fix checkstyle", "committedDate": "2020-04-24T16:29:12Z", "type": "commit"}, {"oid": "c909caacc23ae82c3e505d5df73586ddbe83e416", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c909caacc23ae82c3e505d5df73586ddbe83e416", "message": "update docs", "committedDate": "2020-04-24T16:48:24Z", "type": "commit"}, {"oid": "4d89ac4a331dc32c1d0c9a23b4b0737e94e4a92f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4d89ac4a331dc32c1d0c9a23b4b0737e94e4a92f", "message": "update docs", "committedDate": "2020-04-24T16:51:31Z", "type": "commit"}, {"oid": "dcc03a0518279de77f113f6a6344e10552d26e54", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dcc03a0518279de77f113f6a6344e10552d26e54", "message": "update docs", "committedDate": "2020-04-24T17:13:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2MTM4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r414761381", "bodyText": "This class should not be public, we're just adding the IDE style credentials to the DefaultAzureCredential but not actually exposing the types directly.", "author": "schaabs", "createdAt": "2020-04-24T17:59:16Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/IntelliJCredential.java", "diffHunk": "@@ -0,0 +1,58 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.identity.implementation.IdentityClient;\n+import com.azure.identity.implementation.IdentityClientBuilder;\n+import com.azure.identity.implementation.IdentityClientOptions;\n+import com.azure.identity.implementation.MsalToken;\n+import reactor.core.publisher.Mono;\n+\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * A credential provider that provides token credentials from Azure Tools for IntelliJ plugin credential cache.\n+ *\n+ * <p> If the developer has authenticated successfully with Azure Tools for IntelliJ plugin in the IntelliJ IDE then\n+ * this credential can be used in the development code to reuse the cached plugin credentials.</p>\n+ *\n+ * @see IntelliJCredentialBuilder\n+ */\n+@Immutable\n+public class IntelliJCredential implements TokenCredential {", "originalCommit": "dcc03a0518279de77f113f6a6344e10552d26e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MjA5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r416052094", "bodyText": "internalized.", "author": "g2vinay", "createdAt": "2020-04-27T18:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2MTM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2MTk2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r414761961", "bodyText": "This should be removed when we hide the credential class. Any configuration from this builder will have to be added to the DefaultAzureCredentialBuilder.", "author": "schaabs", "createdAt": "2020-04-24T18:00:17Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/IntelliJCredentialBuilder.java", "diffHunk": "@@ -0,0 +1,45 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity;\n+\n+import com.azure.core.util.CoreUtils;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Fluent credential builder for instantiating a {@link IntelliJCredential}.\n+ *\n+ * @see IntelliJCredential\n+ */\n+public class IntelliJCredentialBuilder extends CredentialBuilderBase<IntelliJCredentialBuilder> {", "originalCommit": "dcc03a0518279de77f113f6a6344e10552d26e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwODIwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r415408209", "bodyText": "Why this design though? Not being able to construct individual credentials has been considered a bug by our customers: #9162", "author": "jianghaolu", "createdAt": "2020-04-26T21:46:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2MTk2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2NTgxNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r414765817", "bodyText": "Looks like we're using msal extension library's KeyChainAccessor class  to access KeyChain on mac. Is no similar class available for Key Ring on linux?", "author": "schaabs", "createdAt": "2020-04-24T18:06:39Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/LinuxKeyRingAccessor.java", "diffHunk": "@@ -0,0 +1,102 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4jextensions.persistence.linux.ISecurityLibrary;\n+import com.sun.jna.Pointer;\n+import com.sun.jna.Structure;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+/**\n+ * This class exposes functions from Key Ring on Linux platform\n+ * via JNA.\n+ */\n+public class LinuxKeyRingAccessor {", "originalCommit": "dcc03a0518279de77f113f6a6344e10552d26e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzQ2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r416053461", "bodyText": "So,\nMSAL's implementation Base 64 encodes the secret/credential when writing to Key Ring.\n&& Base 64 decodes when reading from Key Ring.\nBut, IntelliJ + Vs code don't base 64 encode the credential details when writing to Key Ring, so MSAL's implementation blows up when reading it.", "author": "g2vinay", "createdAt": "2020-04-27T18:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2NTgxNw=="}], "type": "inlineReview"}, {"oid": "0133d4a6473ea69c59ab6317d18914b6860c34f5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0133d4a6473ea69c59ab6317d18914b6860c34f5", "message": "code refactor", "committedDate": "2020-04-24T18:45:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc4MTM5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r414781396", "bodyText": "Consider making this a static array instead of creating it each time this method is called.", "author": "srnagar", "createdAt": "2020-04-24T18:33:11Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IntelliJCacheAccessor.java", "diffHunk": "@@ -0,0 +1,216 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation;\n+\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.microsoft.aad.msal4jextensions.persistence.mac.KeyChainAccessor;\n+import com.sun.jna.platform.win32.Crypt32Util;\n+import org.linguafranca.pwdb.Database;\n+import org.linguafranca.pwdb.Entry;\n+import org.linguafranca.pwdb.kdbx.KdbxCreds;\n+import org.linguafranca.pwdb.kdbx.simple.SimpleDatabase;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.FileInputStream;\n+import java.nio.ByteBuffer;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Locale;\n+\n+/**\n+ * This class accesses IntelliJ Azure Tools credentials cache via JNA.\n+ */\n+public class IntelliJCacheAccessor {\n+    private final ClientLogger logger = new ClientLogger(IntelliJCacheAccessor.class);\n+    private String keepPassDatabasePath;\n+\n+    /**\n+     * Creates an instance of {@link IntelliJCacheAccessor}\n+     *\n+     * @param keepPassDatabasePath the keep pass database path.\n+     */\n+    public IntelliJCacheAccessor(String keepPassDatabasePath) {\n+        this.keepPassDatabasePath = keepPassDatabasePath;\n+    }\n+\n+    private String getAzureToolsforIntelliJPluginConfigPath() {\n+        return System.getProperty(\"user.home\") + String.format(\"%sAzureToolsForIntelliJ\", File.separator);\n+    }\n+\n+    /**\n+     * Get the current authentication method details of Azure Tools plugin in IntelliJ IDE.\n+     *\n+     * @return the {@link IntelliJAuthMethodDetails}\n+     * @throws IOException if an error is encountered while reading the auth details file.\n+     */\n+    public IntelliJAuthMethodDetails getIntelliJAuthDetails() throws IOException {\n+        StringBuilder authMethodDetailsPath = new StringBuilder(getAzureToolsforIntelliJPluginConfigPath());\n+        authMethodDetailsPath.append(String.format(\"%sAuthMethodDetails.json\", File.separator));\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        File file = new File(authMethodDetailsPath.toString());\n+        return objectMapper.readValue(file, IntelliJAuthMethodDetails.class);\n+    }\n+\n+    /**\n+     * Get the Device Code credential details of Azure Tools plugin in the IntelliJ IDE.\n+     *\n+     * @return the {@link JsonNode} holding the authentication details.\n+     * @throws IOException\n+     */\n+    public JsonNode getDeviceCodeCredentials() throws IOException {\n+        String os = System.getProperty(\"os.name\").toLowerCase(Locale.ROOT);\n+\n+        if (os.contains(\"mac\")) {\n+            KeyChainAccessor accessor = new KeyChainAccessor(null, \"ADAuthManager\",\n+                \"cachedAuthResult\");\n+\n+            String jsonCred  = new String(accessor.read());\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(jsonCred);\n+\n+        } else if (os.contains(\"nix\") || os.contains(\"nux\")) {\n+            LinuxKeyRingAccessor accessor = new LinuxKeyRingAccessor(\n+                \"com.intellij.credentialStore.Credential\",\n+                \"service\", \"ADAuthManager\",\n+                \"account\", \"cachedAuthResult\");\n+\n+            String jsonCred  = new String(accessor.read());\n+            if (jsonCred.startsWith(\"cachedAuthResult@\")) {\n+                jsonCred = jsonCred.replaceFirst(\"cachedAuthResult@\", \"\");\n+            }\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(jsonCred);\n+\n+        } else if (os.contains(\"win\")) {\n+            return getCredentialFromKdbx();\n+        } else {\n+            throw logger.logExceptionAsError(new RuntimeException(String.format(\"OS %s Platform not supported.\", os)));\n+        }\n+    }\n+\n+    /**\n+     * Get the Service Principal credential details of Azure Tools plugin in the IntelliJ IDE.\n+     *\n+     * @param credFilePath the file path holding authentication details\n+     * @return the {@link HashMap} holding auth details.\n+     * @throws IOException if an error is countered while reading the credential file.\n+     */\n+    public HashMap<String, String> getIntellijServicePrincipalDetails(String credFilePath) throws IOException {\n+        BufferedReader reader = null;\n+        HashMap<String, String> servicePrincipalDetails = new HashMap<>(8);\n+        try {\n+            reader = new BufferedReader(new FileReader(credFilePath));\n+            String line = reader.readLine();\n+            while (line != null) {\n+                String[] split = line.split(\"=\");\n+                split[1] = split[1].replace(\"\\\\\", \"\");\n+                servicePrincipalDetails.put(split[0], split[1]);\n+                // read next line\n+                line = reader.readLine();\n+            }\n+        } finally {\n+            if (reader != null) {\n+                reader.close();\n+            }\n+        }\n+        return servicePrincipalDetails;\n+    }\n+\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private JsonNode getCredentialFromKdbx() throws IOException {\n+        String extractedpwd = getKdbxPassword();\n+\n+        byte[] cryptoKey = new byte[]{0x50, 0x72, 0x6f, 0x78, 0x79, 0x20, 0x43, 0x6f, 0x6e, 0x66,\n+            0x69, 0x67, 0x20, 0x53, 0x65, 0x63};", "originalCommit": "dcc03a0518279de77f113f6a6344e10552d26e54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc4Nzk2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r414787960", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                + \" Plese login with Azure Tools for IntelliJ plugin in the IDE.\"));\n          \n          \n            \n                                + \" Please login with Azure Tools for IntelliJ plugin in the IDE.\"));", "author": "srnagar", "createdAt": "2020-04-24T18:44:32Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -148,6 +151,65 @@\n         }\n     }\n \n+\n+    public Mono<MsalToken> authenticateWithIntelliJ(TokenRequestContext request) {\n+        try {\n+            IntelliJCacheAccessor cacheAccessor = new IntelliJCacheAccessor(options.getKeepPassDatabasePath());\n+            IntelliJAuthMethodDetails authDetails = cacheAccessor.getIntelliJAuthDetails();\n+            String authType = authDetails.getAuthMethod();\n+            if (CoreUtils.isNullOrEmpty(authType)) {\n+                throw logger.logExceptionAsError(new RuntimeException(\"IntelliJ Authentication not available.\"\n+                    + \" Plese login with Azure Tools for IntelliJ plugin in the IDE.\"));", "originalCommit": "dcc03a0518279de77f113f6a6344e10552d26e54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc4ODg3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r414788871", "bodyText": "Return a Map<String, String> instead.", "author": "srnagar", "createdAt": "2020-04-24T18:46:08Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IntelliJCacheAccessor.java", "diffHunk": "@@ -0,0 +1,216 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation;\n+\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.microsoft.aad.msal4jextensions.persistence.mac.KeyChainAccessor;\n+import com.sun.jna.platform.win32.Crypt32Util;\n+import org.linguafranca.pwdb.Database;\n+import org.linguafranca.pwdb.Entry;\n+import org.linguafranca.pwdb.kdbx.KdbxCreds;\n+import org.linguafranca.pwdb.kdbx.simple.SimpleDatabase;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.FileInputStream;\n+import java.nio.ByteBuffer;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Locale;\n+\n+/**\n+ * This class accesses IntelliJ Azure Tools credentials cache via JNA.\n+ */\n+public class IntelliJCacheAccessor {\n+    private final ClientLogger logger = new ClientLogger(IntelliJCacheAccessor.class);\n+    private String keepPassDatabasePath;\n+\n+    /**\n+     * Creates an instance of {@link IntelliJCacheAccessor}\n+     *\n+     * @param keepPassDatabasePath the keep pass database path.\n+     */\n+    public IntelliJCacheAccessor(String keepPassDatabasePath) {\n+        this.keepPassDatabasePath = keepPassDatabasePath;\n+    }\n+\n+    private String getAzureToolsforIntelliJPluginConfigPath() {\n+        return System.getProperty(\"user.home\") + String.format(\"%sAzureToolsForIntelliJ\", File.separator);\n+    }\n+\n+    /**\n+     * Get the current authentication method details of Azure Tools plugin in IntelliJ IDE.\n+     *\n+     * @return the {@link IntelliJAuthMethodDetails}\n+     * @throws IOException if an error is encountered while reading the auth details file.\n+     */\n+    public IntelliJAuthMethodDetails getIntelliJAuthDetails() throws IOException {\n+        StringBuilder authMethodDetailsPath = new StringBuilder(getAzureToolsforIntelliJPluginConfigPath());\n+        authMethodDetailsPath.append(String.format(\"%sAuthMethodDetails.json\", File.separator));\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        File file = new File(authMethodDetailsPath.toString());\n+        return objectMapper.readValue(file, IntelliJAuthMethodDetails.class);\n+    }\n+\n+    /**\n+     * Get the Device Code credential details of Azure Tools plugin in the IntelliJ IDE.\n+     *\n+     * @return the {@link JsonNode} holding the authentication details.\n+     * @throws IOException\n+     */\n+    public JsonNode getDeviceCodeCredentials() throws IOException {\n+        String os = System.getProperty(\"os.name\").toLowerCase(Locale.ROOT);\n+\n+        if (os.contains(\"mac\")) {\n+            KeyChainAccessor accessor = new KeyChainAccessor(null, \"ADAuthManager\",\n+                \"cachedAuthResult\");\n+\n+            String jsonCred  = new String(accessor.read());\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(jsonCred);\n+\n+        } else if (os.contains(\"nix\") || os.contains(\"nux\")) {\n+            LinuxKeyRingAccessor accessor = new LinuxKeyRingAccessor(\n+                \"com.intellij.credentialStore.Credential\",\n+                \"service\", \"ADAuthManager\",\n+                \"account\", \"cachedAuthResult\");\n+\n+            String jsonCred  = new String(accessor.read());\n+            if (jsonCred.startsWith(\"cachedAuthResult@\")) {\n+                jsonCred = jsonCred.replaceFirst(\"cachedAuthResult@\", \"\");\n+            }\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(jsonCred);\n+\n+        } else if (os.contains(\"win\")) {\n+            return getCredentialFromKdbx();\n+        } else {\n+            throw logger.logExceptionAsError(new RuntimeException(String.format(\"OS %s Platform not supported.\", os)));\n+        }\n+    }\n+\n+    /**\n+     * Get the Service Principal credential details of Azure Tools plugin in the IntelliJ IDE.\n+     *\n+     * @param credFilePath the file path holding authentication details\n+     * @return the {@link HashMap} holding auth details.\n+     * @throws IOException if an error is countered while reading the credential file.\n+     */\n+    public HashMap<String, String> getIntellijServicePrincipalDetails(String credFilePath) throws IOException {", "originalCommit": "dcc03a0518279de77f113f6a6344e10552d26e54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b9c7d16307f25d649aceb35daf36b9b848fd6c82", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b9c7d16307f25d649aceb35daf36b9b848fd6c82", "message": "address feedback", "committedDate": "2020-04-27T16:40:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE1NzQzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r416157437", "bodyText": "Is it not \"KeePass\"?", "author": "JonathanGiles", "createdAt": "2020-04-27T21:21:33Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/DefaultAzureCredentialBuilder.java", "diffHunk": "@@ -34,6 +36,28 @@ public DefaultAzureCredentialBuilder authorityHost(String authorityHost) {\n     }\n \n \n+    /**\n+     * Specifies the keep pass database path to read IntelliJ credentials on windows platform. This is required", "originalCommit": "b9c7d16307f25d649aceb35daf36b9b848fd6c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyMTQ1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r417421457", "bodyText": "updated", "author": "g2vinay", "createdAt": "2020-04-29T15:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE1NzQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE1ODQ4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r416158483", "bodyText": "Is there ever a possibility that there might be multiple databases on a users system that might need reading?", "author": "JonathanGiles", "createdAt": "2020-04-27T21:23:19Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/DefaultAzureCredentialBuilder.java", "diffHunk": "@@ -34,6 +36,28 @@ public DefaultAzureCredentialBuilder authorityHost(String authorityHost) {\n     }\n \n \n+    /**\n+     * Specifies the keep pass database path to read IntelliJ credentials on windows platform. This is required\n+     * only on windows platform.\n+     *\n+     * <p>This path can be located in the IntelliJ IDE.\n+     * Windows: File -&gt; Settings -&gt; Appearance &amp; Behavior -&gt; System Settings -&gt; Passwords </p>\n+     *\n+     * @param databasePath the path to the keep pass database.\n+     * @throws IllegalArgumentException if {@code databasePath is either not specified or is empty}\n+     * @return An updated instance of this builder with the keep pass database path set as specified.\n+     */\n+    public DefaultAzureCredentialBuilder windowsKeepPassDatabasePath(String databasePath) {", "originalCommit": "b9c7d16307f25d649aceb35daf36b9b848fd6c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyMjAwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r417422004", "bodyText": "IDE allows users to configure only one database at a time.\nThis will only be possible, if IDE allows users to configure multiple databases.", "author": "g2vinay", "createdAt": "2020-04-29T15:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE1ODQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE1OTk4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r416159985", "bodyText": "You might want to make it clear that on other platforms we still support IntelliJ lookup, but we use the standard locations on those platforms.", "author": "JonathanGiles", "createdAt": "2020-04-27T21:25:50Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/DefaultAzureCredentialBuilder.java", "diffHunk": "@@ -34,6 +36,28 @@ public DefaultAzureCredentialBuilder authorityHost(String authorityHost) {\n     }\n \n \n+    /**\n+     * Specifies the keep pass database path to read IntelliJ credentials on windows platform. This is required\n+     * only on windows platform.", "originalCommit": "b9c7d16307f25d649aceb35daf36b9b848fd6c82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyMjA5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r417422099", "bodyText": "updated.", "author": "g2vinay", "createdAt": "2020-04-29T15:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE1OTk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE2MjE4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r416162188", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                               + \" Plese login with Azure Tools for IntelliJ plugin in the IDE.\";\n          \n          \n            \n                                               + \" Please log in with Azure Tools for IntelliJ plugin in the IDE.\";", "author": "JonathanGiles", "createdAt": "2020-04-27T21:29:31Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -91,6 +94,8 @@\n     private final String tenantId;\n     private final String clientId;\n     private HttpPipelineAdapter httpPipelineAdapter;\n+    private static final String INTELLIJ_CREDENTIAL_NOT_AVAILABLE_ERROR = \"IntelliJ Authentication not available.\"\n+                                   + \" Plese login with Azure Tools for IntelliJ plugin in the IDE.\";", "originalCommit": "b9c7d16307f25d649aceb35daf36b9b848fd6c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE2MzA4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r416163088", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                + \" Plese login with Azure Tools for IntelliJ plugin in the IDE.\"));\n          \n          \n            \n                                + \" Please log in with Azure Tools for IntelliJ plugin in the IDE.\"));", "author": "JonathanGiles", "createdAt": "2020-04-27T21:31:15Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -148,6 +153,80 @@\n         }\n     }\n \n+\n+    public Mono<MsalToken> authenticateWithIntelliJ(TokenRequestContext request) {\n+        try {\n+            IntelliJCacheAccessor cacheAccessor = new IntelliJCacheAccessor(options.getKeepPassDatabasePath());\n+            IntelliJAuthMethodDetails authDetails = cacheAccessor.getAuthDetailsIfAvailable();\n+            String authType = authDetails.getAuthMethod();\n+            if (authType.equalsIgnoreCase(\"SP\")) {\n+                Map<String, String> spDetails = cacheAccessor\n+                    .getIntellijServicePrincipalDetails(authDetails.getCredFilePath());\n+                String authorityUrl = spDetails.get(\"authURL\") + spDetails.get(\"tenant\");\n+                try {\n+                    ConfidentialClientApplication.Builder applicationBuilder =\n+                        ConfidentialClientApplication.builder(spDetails.get(\"client\"),\n+                            ClientCredentialFactory.createFromSecret(spDetails.get(\"key\")))\n+                            .authority(authorityUrl);\n+\n+                    // If http pipeline is available, then it should override the proxy options if any configured.\n+                    if (httpPipelineAdapter != null) {\n+                        applicationBuilder.httpClient(httpPipelineAdapter);\n+                    } else if (options.getProxyOptions() != null) {\n+                        applicationBuilder.proxy(proxyOptionsToJavaNetProxy(options.getProxyOptions()));\n+                    }\n+\n+                    if (options.getExecutorService() != null) {\n+                        applicationBuilder.executorService(options.getExecutorService());\n+                    }\n+\n+                    ConfidentialClientApplication application = applicationBuilder.build();\n+                    return Mono.fromFuture(application.acquireToken(\n+                        ClientCredentialParameters.builder(new HashSet<>(request.getScopes()))\n+                            .build()))\n+                               .map(ar -> new MsalToken(ar, options));\n+                } catch (MalformedURLException e) {\n+                    return Mono.error(e);\n+                }\n+            } else if (authType.equalsIgnoreCase(\"DC\")) {\n+                String authHost = cacheAccessor.getAzureAuthHost(authDetails.getAzureEnv())\n+                                      .replaceAll(\"/+$\", \"\") + \"/organizations/\" + tenantId;\n+\n+                PublicClientApplication.Builder applicationBuilder = PublicClientApplication.builder(clientId)\n+                    .authority(authHost);\n+\n+                if (httpPipelineAdapter != null) {\n+                    applicationBuilder.httpClient(httpPipelineAdapter);\n+                } else if (options.getProxyOptions() != null) {\n+                    applicationBuilder.proxy(proxyOptionsToJavaNetProxy(options.getProxyOptions()));\n+                }\n+\n+                if (options.getExecutorService() != null) {\n+                    applicationBuilder.executorService(options.getExecutorService());\n+                }\n+\n+                PublicClientApplication publicClientApplication = applicationBuilder\n+                                                                      .build();\n+\n+                JsonNode intelliJCredentials = cacheAccessor.getDeviceCodeCredentials();\n+                String refreshToken = intelliJCredentials.get(\"refreshToken\").textValue();\n+\n+                RefreshTokenParameters parameters = RefreshTokenParameters\n+                                                        .builder(new HashSet<>(request.getScopes()), refreshToken)\n+                                                        .build();\n+\n+                return Mono.defer(() -> Mono.fromFuture(publicClientApplication.acquireToken(parameters))\n+                                    .map(ar -> new MsalToken(ar, options)));\n+\n+            } else {\n+                throw logger.logExceptionAsError(new RuntimeException(\"IntelliJ Authentication not available.\"\n+                    + \" Plese login with Azure Tools for IntelliJ plugin in the IDE.\"));", "originalCommit": "b9c7d16307f25d649aceb35daf36b9b848fd6c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE2MzY1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r416163654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          + \" Please login with Azure Tools for IntelliJ plugin in the IDE.\";\n          \n          \n            \n                          + \" Please log in with Azure Tools for IntelliJ plugin in the IDE.\";", "author": "JonathanGiles", "createdAt": "2020-04-27T21:32:05Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IntelliJCacheAccessor.java", "diffHunk": "@@ -0,0 +1,261 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation;\n+\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.identity.KnownAuthorityHosts;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.microsoft.aad.msal4jextensions.persistence.mac.KeyChainAccessor;\n+import com.sun.jna.Platform;\n+import com.sun.jna.platform.win32.Crypt32Util;\n+import org.linguafranca.pwdb.Database;\n+import org.linguafranca.pwdb.Entry;\n+import org.linguafranca.pwdb.kdbx.KdbxCreds;\n+import org.linguafranca.pwdb.kdbx.simple.SimpleDatabase;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.FileInputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Paths;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This class accesses IntelliJ Azure Tools credentials cache via JNA.\n+ */\n+public class IntelliJCacheAccessor {\n+    private final ClientLogger logger = new ClientLogger(IntelliJCacheAccessor.class);\n+    private String keepPassDatabasePath;\n+    private static final String INTELLIJ_CREDENTIAL_NOT_AVAILABLE_ERROR = \"IntelliJ Authentication not available.\"\n+              + \" Please login with Azure Tools for IntelliJ plugin in the IDE.\";", "originalCommit": "b9c7d16307f25d649aceb35daf36b9b848fd6c82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ae2d30b5c6ecfda5c2787df8aa872e3e1a394b0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0ae2d30b5c6ecfda5c2787df8aa872e3e1a394b0", "message": "feedback updates", "committedDate": "2020-04-29T05:53:36Z", "type": "commit"}, {"oid": "31cd2e880bb593df05df526fbdc28ec1d465530b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/31cd2e880bb593df05df526fbdc28ec1d465530b", "message": "remove jacoco", "committedDate": "2020-04-29T06:07:35Z", "type": "commit"}, {"oid": "f8a0a0c43df3a5bede78bf2b912c970c9af3cb2e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f8a0a0c43df3a5bede78bf2b912c970c9af3cb2e", "message": "merge master", "committedDate": "2020-04-29T06:24:22Z", "type": "commit"}, {"oid": "0b8ca0e68c250c95e716ef42d139bb7bda94c94f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0b8ca0e68c250c95e716ef42d139bb7bda94c94f", "message": "revert gitignore change", "committedDate": "2020-04-29T06:29:31Z", "type": "commit"}, {"oid": "008c60f15aa39c0b3189ef42bba370b656a41f63", "url": "https://github.com/Azure/azure-sdk-for-java/commit/008c60f15aa39c0b3189ef42bba370b656a41f63", "message": "fix spotbugs", "committedDate": "2020-04-29T15:40:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY5NTQ5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r417695494", "bodyText": "Shouldn't it be referred to everywhere as 'KeePass', not 'kee pass'?", "author": "JonathanGiles", "createdAt": "2020-04-30T00:51:48Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/DefaultAzureCredentialBuilder.java", "diffHunk": "@@ -34,6 +36,29 @@ public DefaultAzureCredentialBuilder authorityHost(String authorityHost) {\n     }\n \n \n+    /**\n+     * Specifies the kee pass database path to read the cached credentials of Azure toolkit for IntelliJ plugin.", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY5NTYxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r417695614", "bodyText": "Proper capitalisation of names: 'Windows', 'macOS' and 'Linux'", "author": "JonathanGiles", "createdAt": "2020-04-30T00:52:25Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/DefaultAzureCredentialBuilder.java", "diffHunk": "@@ -34,6 +36,29 @@ public DefaultAzureCredentialBuilder authorityHost(String authorityHost) {\n     }\n \n \n+    /**\n+     * Specifies the kee pass database path to read the cached credentials of Azure toolkit for IntelliJ plugin.\n+     * The {@code databasePath} is required on windows platform. For mac and linux platform native key chain /", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY5NjM2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r417696362", "bodyText": "These are not named correctly - KeePass, not KeepPass", "author": "JonathanGiles", "createdAt": "2020-04-30T00:55:19Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClientOptions.java", "diffHunk": "@@ -194,4 +195,22 @@ public IdentityClientOptions setHttpClient(HttpClient httpClient) {\n         this.httpClient = httpClient;\n         return this;\n     }\n+\n+    /**\n+     * Specifies the database to extract intellij cached credentials from.\n+     * @param keepPassDatabasePath the database to extract intellij credentials from.\n+     * @return IdentityClientOptions\n+     */\n+    public IdentityClientOptions setKeepPassDatabasePath(String keepPassDatabasePath) {\n+        this.keepPassDatabasePath = keepPassDatabasePath;\n+        return this;\n+    }\n+\n+    /**\n+     * Get the kee pass database path.\n+     * @return the kee pass database path to extract inellij credentials from.\n+     */\n+    public String getKeepPassDatabasePath() {", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMDE5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r418220197", "bodyText": "Should this property denote that it's the KeePass database path for IntelliJ? intelliJKeyPassDatabasePath?", "author": "schaabs", "createdAt": "2020-04-30T18:52:45Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/DefaultAzureCredentialBuilder.java", "diffHunk": "@@ -34,6 +36,29 @@ public DefaultAzureCredentialBuilder authorityHost(String authorityHost) {\n     }\n \n \n+    /**\n+     * Specifies the kee pass database path to read the cached credentials of Azure toolkit for IntelliJ plugin.\n+     * The {@code databasePath} is required on windows platform. For mac and linux platform native key chain /\n+     * key ring will be accessed respectively to retrieve the cached credentials.\n+     *\n+     * <p>This path can be located in the IntelliJ IDE.\n+     * Windows: File -&gt; Settings -&gt; Appearance &amp; Behavior -&gt; System Settings -&gt; Passwords. </p>\n+     *\n+     * @param databasePath the path to the kee pass database.\n+     * @throws IllegalArgumentException if {@code databasePath is either not specified or is empty}\n+     * @return An updated instance of this builder with the kee pass database path set as specified.\n+     */\n+    public DefaultAzureCredentialBuilder keePassDatabasePath(String databasePath) {", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMDkwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r418220907", "bodyText": "Just FYI both this PR and the VsCodeCredential PR increment this to 5. After you merge one you'll need to make sure to update the other PR.", "author": "schaabs", "createdAt": "2020-04-30T18:54:03Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/DefaultAzureCredentialBuilder.java", "diffHunk": "@@ -110,7 +145,7 @@ public DefaultAzureCredential build() {\n     }\n \n     private ArrayDeque<TokenCredential> getCredentialsChain() {\n-        ArrayDeque<TokenCredential> output = new ArrayDeque<>(4);\n+        ArrayDeque<TokenCredential> output = new ArrayDeque<>(5);", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMTE5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r418221192", "bodyText": "Should move this client id into a constant somewhere.", "author": "schaabs", "createdAt": "2020-04-30T18:54:33Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/IntelliJCredential.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.identity.implementation.IdentityClient;\n+import com.azure.identity.implementation.IdentityClientBuilder;\n+import com.azure.identity.implementation.IdentityClientOptions;\n+import com.azure.identity.implementation.MsalToken;\n+import reactor.core.publisher.Mono;\n+\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * A credential provider that provides token credentials from Azure Tools for IntelliJ plugin credential cache.\n+ *\n+ * <p> If the developer has authenticated successfully with Azure Tools for IntelliJ plugin in the IntelliJ IDE then\n+ * this credential can be used in the development code to reuse the cached plugin credentials.</p>\n+ */\n+@Immutable\n+class IntelliJCredential implements TokenCredential {\n+    private final IdentityClient identityClient;\n+    private final AtomicReference<MsalToken> cachedToken;\n+\n+    /**\n+     * Creates an {@link IntelliJCredential} with default identity client options.\n+     * @param identityClientOptions the options to configure the identity client\n+     */\n+    IntelliJCredential(IdentityClientOptions identityClientOptions) {\n+        identityClient = new IdentityClientBuilder().identityClientOptions(identityClientOptions)\n+                             .clientId(\"61d65f5a-6e3b-468b-af73-a033f5098c5c\").build();", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMzA1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r418223057", "bodyText": "Same comment here as on the VsCodeCredential. You're creating a new PublicClientApplication (and a new ConfidentialClientApplication above) each time you try to get a token so there will be no caching. We don't necessarily have to fix this before merging it for our preview release but if not we should create an issue to track the work.", "author": "schaabs", "createdAt": "2020-04-30T18:57:43Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -148,6 +150,81 @@\n         }\n     }\n \n+\n+    public Mono<MsalToken> authenticateWithIntelliJ(TokenRequestContext request) {\n+        try {\n+            IntelliJCacheAccessor cacheAccessor = new IntelliJCacheAccessor(options.getKeepPassDatabasePath());\n+            IntelliJAuthMethodDetails authDetails = cacheAccessor.getAuthDetailsIfAvailable();\n+            String authType = authDetails.getAuthMethod();\n+            if (authType.equalsIgnoreCase(\"SP\")) {\n+                Map<String, String> spDetails = cacheAccessor\n+                    .getIntellijServicePrincipalDetails(authDetails.getCredFilePath());\n+                String authorityUrl = spDetails.get(\"authURL\") + spDetails.get(\"tenant\");\n+                try {\n+                    ConfidentialClientApplication.Builder applicationBuilder =\n+                        ConfidentialClientApplication.builder(spDetails.get(\"client\"),\n+                            ClientCredentialFactory.createFromSecret(spDetails.get(\"key\")))\n+                            .authority(authorityUrl);\n+\n+                    // If http pipeline is available, then it should override the proxy options if any configured.\n+                    if (httpPipelineAdapter != null) {\n+                        applicationBuilder.httpClient(httpPipelineAdapter);\n+                    } else if (options.getProxyOptions() != null) {\n+                        applicationBuilder.proxy(proxyOptionsToJavaNetProxy(options.getProxyOptions()));\n+                    }\n+\n+                    if (options.getExecutorService() != null) {\n+                        applicationBuilder.executorService(options.getExecutorService());\n+                    }\n+\n+                    ConfidentialClientApplication application = applicationBuilder.build();\n+                    return Mono.fromFuture(application.acquireToken(\n+                        ClientCredentialParameters.builder(new HashSet<>(request.getScopes()))\n+                            .build()))\n+                               .map(ar -> new MsalToken(ar, options));\n+                } catch (MalformedURLException e) {\n+                    return Mono.error(e);\n+                }\n+            } else if (authType.equalsIgnoreCase(\"DC\")) {\n+                String authHost = cacheAccessor.getAzureAuthHost(authDetails.getAzureEnv())\n+                                      .replaceAll(\"/+$\", \"\") + \"/organizations/\" + tenantId;\n+\n+                PublicClientApplication.Builder applicationBuilder = PublicClientApplication.builder(clientId)\n+                    .authority(authHost);\n+\n+                if (httpPipelineAdapter != null) {\n+                    applicationBuilder.httpClient(httpPipelineAdapter);\n+                } else if (options.getProxyOptions() != null) {\n+                    applicationBuilder.proxy(proxyOptionsToJavaNetProxy(options.getProxyOptions()));\n+                }\n+\n+                if (options.getExecutorService() != null) {\n+                    applicationBuilder.executorService(options.getExecutorService());\n+                }\n+\n+                PublicClientApplication publicClientApplication = applicationBuilder\n+                                                                      .build();", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyNDA4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r418224081", "bodyText": "Why are we adding this to the IdentityClientOptions? isn't this the base options for all credentials? Are users ever expected to create the IdentityClientOptions themselves?", "author": "schaabs", "createdAt": "2020-04-30T18:59:36Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClientOptions.java", "diffHunk": "@@ -194,4 +195,22 @@ public IdentityClientOptions setHttpClient(HttpClient httpClient) {\n         this.httpClient = httpClient;\n         return this;\n     }\n+\n+    /**\n+     * Specifies the database to extract intellij cached credentials from.\n+     * @param keepPassDatabasePath the database to extract intellij credentials from.\n+     * @return IdentityClientOptions\n+     */\n+    public IdentityClientOptions setKeepPassDatabasePath(String keepPassDatabasePath) {\n+        this.keepPassDatabasePath = keepPassDatabasePath;\n+        return this;", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyNDM4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r418224386", "bodyText": "My bad I didn't see it was in implementation", "author": "schaabs", "createdAt": "2020-04-30T19:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyNDA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MjY0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r418242649", "bodyText": "Fix typo in javadoc, variable and method names. It should be keePass.", "author": "srnagar", "createdAt": "2020-04-30T19:35:11Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClientOptions.java", "diffHunk": "@@ -194,4 +195,22 @@ public IdentityClientOptions setHttpClient(HttpClient httpClient) {\n         this.httpClient = httpClient;\n         return this;\n     }\n+\n+    /**\n+     * Specifies the database to extract intellij cached credentials from.\n+     * @param keepPassDatabasePath the database to extract intellij credentials from.\n+     * @return IdentityClientOptions\n+     */\n+    public IdentityClientOptions setKeepPassDatabasePath(String keepPassDatabasePath) {\n+        this.keepPassDatabasePath = keepPassDatabasePath;\n+        return this;", "originalCommit": "008c60f15aa39c0b3189ef42bba370b656a41f63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f9beffd965b88df44e3347b8ec37639eec69f68", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f9beffd965b88df44e3347b8ec37639eec69f68", "message": "update docs", "committedDate": "2020-05-03T20:57:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDkzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r419194931", "bodyText": "Naming mismatch between getter and setter should be resolved.", "author": "JonathanGiles", "createdAt": "2020-05-04T02:42:58Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClientOptions.java", "diffHunk": "@@ -194,4 +195,22 @@ public IdentityClientOptions setHttpClient(HttpClient httpClient) {\n         this.httpClient = httpClient;\n         return this;\n     }\n+\n+    /**\n+     * Specifies the database to extract IntelliJ cached credentials from.\n+     * @param keePassDatabasePath the database to extract intellij credentials from.\n+     * @return IdentityClientOptions\n+     */\n+    public IdentityClientOptions setKeePassDatabasePath(String keePassDatabasePath) {\n+        this.keePassDatabasePath = keePassDatabasePath;\n+        return this;\n+    }\n+\n+    /**\n+     * Get the KeePass database path.\n+     * @return the keePass database path to extract inellij credentials from.\n+     */\n+    public String getIntelliJKeePassDatabasePath() {", "originalCommit": "6f9beffd965b88df44e3347b8ec37639eec69f68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NjM3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r419196378", "bodyText": "This class is not public API.\nUpdated.", "author": "g2vinay", "createdAt": "2020-05-04T02:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NjU3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r419196570", "bodyText": "We still aim to have consistently named API even when it is not public! :)", "author": "JonathanGiles", "createdAt": "2020-05-04T02:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5Njg1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r419196858", "bodyText": "Yep, agreed.", "author": "g2vinay", "createdAt": "2020-05-04T02:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDk2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r419194965", "bodyText": "KeePass", "author": "JonathanGiles", "createdAt": "2020-05-04T02:43:22Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IntelliJCacheAccessor.java", "diffHunk": "@@ -0,0 +1,268 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation;\n+\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.identity.CredentialUnavailableException;\n+import com.azure.identity.KnownAuthorityHosts;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.microsoft.aad.msal4jextensions.persistence.mac.KeyChainAccessor;\n+import com.sun.jna.Platform;\n+import com.sun.jna.platform.win32.Crypt32Util;\n+import org.linguafranca.pwdb.Database;\n+import org.linguafranca.pwdb.Entry;\n+import org.linguafranca.pwdb.kdbx.KdbxCreds;\n+import org.linguafranca.pwdb.kdbx.simple.SimpleDatabase;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.FileInputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.nio.file.Paths;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This class accesses IntelliJ Azure Tools credentials cache via JNA.\n+ */\n+public class IntelliJCacheAccessor {\n+    private final ClientLogger logger = new ClientLogger(IntelliJCacheAccessor.class);\n+    private String keePassDatabasePath;\n+    private static final String INTELLIJ_CREDENTIAL_NOT_AVAILABLE_ERROR = \"IntelliJ Authentication not available.\"\n+              + \" Please log in with Azure Tools for IntelliJ plugin in the IDE.\";\n+    private static final byte[] CRYPTO_KEY = new byte[] {0x50, 0x72, 0x6f, 0x78, 0x79, 0x20, 0x43, 0x6f, 0x6e, 0x66,\n+        0x69, 0x67, 0x20, 0x53, 0x65, 0x63};\n+\n+\n+    /**\n+     * Creates an instance of {@link IntelliJCacheAccessor}\n+     *\n+     * @param keePassDatabasePath the KeePass database path.\n+     */\n+    public IntelliJCacheAccessor(String keePassDatabasePath) {\n+        this.keePassDatabasePath = keePassDatabasePath;\n+    }\n+\n+    private String getAzureToolsforIntelliJPluginConfigPath() {\n+        return Paths.get(System.getProperty(\"user.home\"), \"AzureToolsForIntelliJ\").toString();\n+    }\n+\n+    /**\n+     * Get the Device Code credential details of Azure Tools plugin in the IntelliJ IDE.\n+     *\n+     * @return the {@link JsonNode} holding the authentication details.\n+     * @throws IOException\n+     */\n+    public JsonNode getDeviceCodeCredentials() throws IOException {\n+        if (Platform.isMac()) {\n+            KeyChainAccessor accessor = new KeyChainAccessor(null, \"ADAuthManager\",\n+                \"cachedAuthResult\");\n+\n+            String jsonCred  = new String(accessor.read(), Charset.forName(\"UTF-8\"));\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(jsonCred);\n+\n+        } else if (Platform.isLinux()) {\n+            LinuxKeyRingAccessor accessor = new LinuxKeyRingAccessor(\n+                \"com.intellij.credentialStore.Credential\",\n+                \"service\", \"ADAuthManager\",\n+                \"account\", \"cachedAuthResult\");\n+\n+            String jsonCred  = new String(accessor.read(), Charset.forName(\"UTF-8\"));\n+            if (jsonCred.startsWith(\"cachedAuthResult@\")) {\n+                jsonCred = jsonCred.replaceFirst(\"cachedAuthResult@\", \"\");\n+            }\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(jsonCred);\n+\n+        } else if (Platform.isWindows()) {\n+            return getCredentialFromKdbx();\n+        } else {\n+            throw logger.logExceptionAsError(new RuntimeException(String.format(\"OS %s Platform not supported.\",\n+                    Platform.getOSType())));\n+        }\n+    }\n+\n+    /**\n+     * Get the Service Principal credential details of Azure Tools plugin in the IntelliJ IDE.\n+     *\n+     * @param credFilePath the file path holding authentication details\n+     * @return the {@link HashMap} holding auth details.\n+     * @throws IOException if an error is countered while reading the credential file.\n+     */\n+    public Map<String, String> getIntellijServicePrincipalDetails(String credFilePath) throws IOException {\n+        BufferedReader reader = null;\n+        HashMap<String, String> servicePrincipalDetails = new HashMap<>(8);\n+        try {\n+            reader = new BufferedReader(new FileReader(credFilePath));\n+            String line = reader.readLine();\n+            while (line != null) {\n+                String[] split = line.split(\"=\");\n+                split[1] = split[1].replace(\"\\\\\", \"\");\n+                servicePrincipalDetails.put(split[0], split[1]);\n+                // read next line\n+                line = reader.readLine();\n+            }\n+        } finally {\n+            if (reader != null) {\n+                reader.close();\n+            }\n+        }\n+        return servicePrincipalDetails;\n+    }\n+\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private JsonNode getCredentialFromKdbx() throws IOException {\n+        if (CoreUtils.isNullOrEmpty(keePassDatabasePath)) {\n+            throw logger.logExceptionAsError(\n+                    new CredentialUnavailableException(\"The keePass database path is either empty or not configured.\"", "originalCommit": "6f9beffd965b88df44e3347b8ec37639eec69f68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NTA0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10369#discussion_r419195041", "bodyText": "KeePass", "author": "JonathanGiles", "createdAt": "2020-05-04T02:43:56Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IntelliJCacheAccessor.java", "diffHunk": "@@ -0,0 +1,268 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation;\n+\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.identity.CredentialUnavailableException;\n+import com.azure.identity.KnownAuthorityHosts;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.microsoft.aad.msal4jextensions.persistence.mac.KeyChainAccessor;\n+import com.sun.jna.Platform;\n+import com.sun.jna.platform.win32.Crypt32Util;\n+import org.linguafranca.pwdb.Database;\n+import org.linguafranca.pwdb.Entry;\n+import org.linguafranca.pwdb.kdbx.KdbxCreds;\n+import org.linguafranca.pwdb.kdbx.simple.SimpleDatabase;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.FileInputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.nio.file.Paths;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This class accesses IntelliJ Azure Tools credentials cache via JNA.\n+ */\n+public class IntelliJCacheAccessor {\n+    private final ClientLogger logger = new ClientLogger(IntelliJCacheAccessor.class);\n+    private String keePassDatabasePath;\n+    private static final String INTELLIJ_CREDENTIAL_NOT_AVAILABLE_ERROR = \"IntelliJ Authentication not available.\"\n+              + \" Please log in with Azure Tools for IntelliJ plugin in the IDE.\";\n+    private static final byte[] CRYPTO_KEY = new byte[] {0x50, 0x72, 0x6f, 0x78, 0x79, 0x20, 0x43, 0x6f, 0x6e, 0x66,\n+        0x69, 0x67, 0x20, 0x53, 0x65, 0x63};\n+\n+\n+    /**\n+     * Creates an instance of {@link IntelliJCacheAccessor}\n+     *\n+     * @param keePassDatabasePath the KeePass database path.\n+     */\n+    public IntelliJCacheAccessor(String keePassDatabasePath) {\n+        this.keePassDatabasePath = keePassDatabasePath;\n+    }\n+\n+    private String getAzureToolsforIntelliJPluginConfigPath() {\n+        return Paths.get(System.getProperty(\"user.home\"), \"AzureToolsForIntelliJ\").toString();\n+    }\n+\n+    /**\n+     * Get the Device Code credential details of Azure Tools plugin in the IntelliJ IDE.\n+     *\n+     * @return the {@link JsonNode} holding the authentication details.\n+     * @throws IOException\n+     */\n+    public JsonNode getDeviceCodeCredentials() throws IOException {\n+        if (Platform.isMac()) {\n+            KeyChainAccessor accessor = new KeyChainAccessor(null, \"ADAuthManager\",\n+                \"cachedAuthResult\");\n+\n+            String jsonCred  = new String(accessor.read(), Charset.forName(\"UTF-8\"));\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(jsonCred);\n+\n+        } else if (Platform.isLinux()) {\n+            LinuxKeyRingAccessor accessor = new LinuxKeyRingAccessor(\n+                \"com.intellij.credentialStore.Credential\",\n+                \"service\", \"ADAuthManager\",\n+                \"account\", \"cachedAuthResult\");\n+\n+            String jsonCred  = new String(accessor.read(), Charset.forName(\"UTF-8\"));\n+            if (jsonCred.startsWith(\"cachedAuthResult@\")) {\n+                jsonCred = jsonCred.replaceFirst(\"cachedAuthResult@\", \"\");\n+            }\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(jsonCred);\n+\n+        } else if (Platform.isWindows()) {\n+            return getCredentialFromKdbx();\n+        } else {\n+            throw logger.logExceptionAsError(new RuntimeException(String.format(\"OS %s Platform not supported.\",\n+                    Platform.getOSType())));\n+        }\n+    }\n+\n+    /**\n+     * Get the Service Principal credential details of Azure Tools plugin in the IntelliJ IDE.\n+     *\n+     * @param credFilePath the file path holding authentication details\n+     * @return the {@link HashMap} holding auth details.\n+     * @throws IOException if an error is countered while reading the credential file.\n+     */\n+    public Map<String, String> getIntellijServicePrincipalDetails(String credFilePath) throws IOException {\n+        BufferedReader reader = null;\n+        HashMap<String, String> servicePrincipalDetails = new HashMap<>(8);\n+        try {\n+            reader = new BufferedReader(new FileReader(credFilePath));\n+            String line = reader.readLine();\n+            while (line != null) {\n+                String[] split = line.split(\"=\");\n+                split[1] = split[1].replace(\"\\\\\", \"\");\n+                servicePrincipalDetails.put(split[0], split[1]);\n+                // read next line\n+                line = reader.readLine();\n+            }\n+        } finally {\n+            if (reader != null) {\n+                reader.close();\n+            }\n+        }\n+        return servicePrincipalDetails;\n+    }\n+\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private JsonNode getCredentialFromKdbx() throws IOException {\n+        if (CoreUtils.isNullOrEmpty(keePassDatabasePath)) {\n+            throw logger.logExceptionAsError(\n+                    new CredentialUnavailableException(\"The keePass database path is either empty or not configured.\"\n+                           + \" Please configure it on the builder. It is required to use \"\n+                           + \"IntelliJ credential on the windows platform.\"));\n+        }\n+        String extractedpwd = getKdbxPassword();\n+\n+        SecretKeySpec key = new SecretKeySpec(CRYPTO_KEY, \"AES\");\n+        String password = \"\";\n+\n+        byte[] dataToDecrypt = Crypt32Util.cryptUnprotectData(Base64.getDecoder().decode(extractedpwd));\n+\n+        ByteBuffer decryptBuffer = ByteBuffer.wrap(dataToDecrypt);\n+        Cipher cipher = null;\n+        try {\n+            cipher = Cipher.getInstance(\"AES/CBC/PKCS5Padding\");\n+            int ivLen = decryptBuffer.getInt();\n+            cipher.init(Cipher.DECRYPT_MODE, key, new IvParameterSpec(dataToDecrypt, decryptBuffer.position(), ivLen));\n+            int dataOffset = decryptBuffer.position() + ivLen;\n+            byte[] decrypted = cipher.doFinal(dataToDecrypt, dataOffset, dataToDecrypt.length - dataOffset);\n+            password = new String(decrypted, Charset.forName(\"UTF-8\"));\n+        } catch (NoSuchAlgorithmException | NoSuchPaddingException | InvalidKeyException\n+                | InvalidAlgorithmParameterException | IllegalBlockSizeException | BadPaddingException e) {\n+            throw logger.logExceptionAsError(new RuntimeException(\"Unable to access cache.\", e));\n+        }\n+\n+        try {\n+            KdbxCreds creds = new KdbxCreds(password.getBytes(Charset.forName(\"UTF-8\")));\n+            InputStream inputStream = new FileInputStream(new File(keePassDatabasePath));\n+            Database database = SimpleDatabase.load(creds, inputStream);\n+\n+            List<Entry> entries = database.findEntries(\"ADAuthManager\");\n+            if (entries.size() == 0) {\n+                throw logger.logExceptionAsError(new CredentialUnavailableException(\"No credentials found in the cache.\"\n+                        + \" Please login with IntelliJ Azure Tools plugin in the IDE.\"));\n+            }\n+\n+            ObjectMapper mapper = new ObjectMapper();\n+            return mapper.readTree(entries.get(0).getPassword());\n+        } catch (Exception e) {\n+            throw logger.logExceptionAsError(new RuntimeException(\"Failed to read keePass database.\", e));", "originalCommit": "6f9beffd965b88df44e3347b8ec37639eec69f68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbe0cde342cb9975207c4bd21b4b4ca507010708", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbe0cde342cb9975207c4bd21b4b4ca507010708", "message": "update casing", "committedDate": "2020-05-04T02:53:04Z", "type": "commit"}, {"oid": "2ed92f421f54b4ef291a0ebc2f0321453444ffc9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2ed92f421f54b4ef291a0ebc2f0321453444ffc9", "message": "update post rebase with vscode", "committedDate": "2020-05-04T15:49:06Z", "type": "commit"}, {"oid": "8b6caac28007bca9a3d32cca9a21774622c4f6fa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8b6caac28007bca9a3d32cca9a21774622c4f6fa", "message": "update test", "committedDate": "2020-05-04T16:21:40Z", "type": "commit"}, {"oid": "de0d0dc1a4a14d95db34d4e0622797bf17165f56", "url": "https://github.com/Azure/azure-sdk-for-java/commit/de0d0dc1a4a14d95db34d4e0622797bf17165f56", "message": "fix spotbugs", "committedDate": "2020-05-04T17:08:42Z", "type": "commit"}]}