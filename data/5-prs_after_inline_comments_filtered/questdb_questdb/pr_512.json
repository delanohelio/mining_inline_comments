{"pr_number": 512, "pr_title": "LIKE implementation #476", "pr_createdAt": "2020-07-19T14:46:56Z", "pr_url": "https://github.com/questdb/questdb/pull/512", "timeline": [{"oid": "5ea28d11ec44a9d95e1dd78eae0affe914fad90b", "url": "https://github.com/questdb/questdb/commit/5ea28d11ec44a9d95e1dd78eae0affe914fad90b", "message": "Error while running JMH benchmark #503", "committedDate": "2020-07-13T17:40:33Z", "type": "commit"}, {"oid": "f4e5396921b07c0e0cf61ca27da2e566cf8f80f8", "url": "https://github.com/questdb/questdb/commit/f4e5396921b07c0e0cf61ca27da2e566cf8f80f8", "message": "Text Function !~ doesnt work when used with single character #505", "committedDate": "2020-07-15T05:54:12Z", "type": "commit"}, {"oid": "fc0ad447bdae15940d1b4926c455482a95a8972e", "url": "https://github.com/questdb/questdb/commit/fc0ad447bdae15940d1b4926c455482a95a8972e", "message": "LIKE implementation #476", "committedDate": "2020-07-19T14:40:49Z", "type": "commit"}, {"oid": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "url": "https://github.com/questdb/questdb/commit/6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "message": "LIKE implementation #476", "committedDate": "2020-07-21T18:31:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1MjUwNQ==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458552505", "bodyText": "SQL 'like' is case sensitive", "author": "bluestreak01", "createdAt": "2020-07-22T05:58:53Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeCharFunctionFactory.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+public class LikeCharFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Sa)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) {\n+        return new MatchFunction(\n+                position,\n+                args.getQuick(0),\n+                args.getQuick(1).getChar(null)\n+        );\n+    }\n+\n+    private static class MatchFunction extends BooleanFunction implements UnaryFunction {\n+        private final Function value;\n+        private final char expected;\n+\n+        public MatchFunction(int position, Function value, char expected) {\n+            super(position);\n+            this.value = value;\n+            this.expected = expected;\n+        }\n+\n+        @Override\n+        public boolean getBool(Record rec) {\n+            CharSequence cs = getArg().getStr(rec);\n+            return cs != null && cs.length()==1 && Character.toLowerCase(cs.charAt(0))==Character.toLowerCase(expected);", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5NzA0MA==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r462297040", "bodyText": "@bluestreak01  https://www.w3schools.com/sql/trysql.asp?filename=trysql_select_like\nTry query : SELECT * FROM Customers WHERE CustomerName LIKE 'alfreds%';\nI am getting results for Alfred. Just want to double check before making change.", "author": "mick2004", "createdAt": "2020-07-29T13:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1MjUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1MzIwNg==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458553206", "bodyText": "This message is shown to user as well as position of the error. User needs to know what to do with this. 'likeString' is not a commonly known term :)", "author": "bluestreak01", "createdAt": "2020-07-22T06:00:57Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeStrFunctionFactory.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.regex.PatternSyntaxException;\n+\n+public class LikeStrFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Ss)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) throws SqlException {\n+        Function value = args.getQuick(0);\n+\n+        CharSequence likeString=args.getQuick(1).getStr(null);\n+\n+        if (likeString == null) {\n+            throw SqlException.$(args.getQuick(1).getPosition(), \"NULL likeString\");", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5ODI5Mg==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r462298292", "bodyText": "@bluestreak01  What should be message. Is \"NULL not supported for like expression\" ok ? else suggest some message", "author": "mick2004", "createdAt": "2020-07-29T13:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1MzIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1NTA3NA==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458555074", "bodyText": "What IDE are you using? Would it be possible to format the code?", "author": "bluestreak01", "createdAt": "2020-07-22T06:06:35Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeStrFunctionFactory.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.regex.PatternSyntaxException;\n+\n+public class LikeStrFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Ss)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) throws SqlException {\n+        Function value = args.getQuick(0);\n+\n+        CharSequence likeString=args.getQuick(1).getStr(null);\n+\n+        if (likeString == null) {\n+            throw SqlException.$(args.getQuick(1).getPosition(), \"NULL likeString\");\n+        }\n+\n+        String regex = escapeSpecialChars(likeString).\n+                replace('_', '.').replace(\"%\", \".*?\");\n+\n+        try {\n+            Matcher matcher = Pattern.compile(regex,\n+                    Pattern.CASE_INSENSITIVE | Pattern.DOTALL).matcher(\"\");\n+\n+\n+            return new MatchFunction(position, value, matcher);\n+\n+\n+        } catch (PatternSyntaxException e) {\n+            throw SqlException.$(args.getQuick(1).getPosition() + e.getIndex() + 1, e.getMessage());\n+        }\n+    }\n+\n+    public static String escapeSpecialChars(CharSequence s )\n+    {\n+        int len = s.length();\n+        if (len == 0)\n+        {\n+            return \"\";\n+        }\n+\n+        StringBuilder sb = new StringBuilder(s.length() * 2);\n+        for (int i = 0; i < len; i++)\n+        {\n+            char c = s.charAt(i);\n+            if (\"[](){}.*+?$^|#\\\\\".indexOf(c) != -1)\n+            {\n+                sb.append(\"\\\\\");\n+            }\n+            sb.append(c);\n+        }\n+        return sb.toString();\n+    }\n+\n+\n+    private static class MatchFunction extends BooleanFunction implements UnaryFunction {\n+        private final Function value;\n+        private final Matcher matcher;\n+\n+        public MatchFunction(int position, Function value, Matcher matcher) {\n+            super(position);\n+            this.value = value;\n+            this.matcher = matcher;\n+        }\n+\n+        @Override\n+        public boolean getBool(Record rec) {\n+            CharSequence cs = getArg().getStr(rec);\n+            return cs != null && matcher.reset(cs).matches();\n+        }\n+\n+        @Override\n+        public Function getArg() {\n+            return value;\n+        }\n+    }\n+    }", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5ODUwNQ==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r462298505", "bodyText": "@bluestreak01  sure", "author": "mick2004", "createdAt": "2020-07-29T13:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1NTA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1NzE3Nw==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458557177", "bodyText": "StringBuilder is transient and throw-away instance. Please instead use\nMisc.getThreadLocalBuilder()", "author": "bluestreak01", "createdAt": "2020-07-22T06:12:48Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeStrFunctionFactory.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.regex.PatternSyntaxException;\n+\n+public class LikeStrFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Ss)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) throws SqlException {\n+        Function value = args.getQuick(0);\n+\n+        CharSequence likeString=args.getQuick(1).getStr(null);\n+\n+        if (likeString == null) {\n+            throw SqlException.$(args.getQuick(1).getPosition(), \"NULL likeString\");\n+        }\n+\n+        String regex = escapeSpecialChars(likeString).\n+                replace('_', '.').replace(\"%\", \".*?\");\n+\n+        try {\n+            Matcher matcher = Pattern.compile(regex,\n+                    Pattern.CASE_INSENSITIVE | Pattern.DOTALL).matcher(\"\");\n+\n+\n+            return new MatchFunction(position, value, matcher);\n+\n+\n+        } catch (PatternSyntaxException e) {\n+            throw SqlException.$(args.getQuick(1).getPosition() + e.getIndex() + 1, e.getMessage());\n+        }\n+    }\n+\n+    public static String escapeSpecialChars(CharSequence s )\n+    {\n+        int len = s.length();\n+        if (len == 0)\n+        {\n+            return \"\";\n+        }\n+\n+        StringBuilder sb = new StringBuilder(s.length() * 2);", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1NzY5OQ==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458557699", "bodyText": "this can be done in the same loop as escaping special characters, which would eliminate two extra loops and two string instances.", "author": "bluestreak01", "createdAt": "2020-07-22T06:14:15Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeStrFunctionFactory.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.regex.PatternSyntaxException;\n+\n+public class LikeStrFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Ss)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) throws SqlException {\n+        Function value = args.getQuick(0);\n+\n+        CharSequence likeString=args.getQuick(1).getStr(null);\n+\n+        if (likeString == null) {\n+            throw SqlException.$(args.getQuick(1).getPosition(), \"NULL likeString\");\n+        }\n+\n+        String regex = escapeSpecialChars(likeString).\n+                replace('_', '.').replace(\"%\", \".*?\");", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1Nzg2OA==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458557868", "bodyText": "'like' is case sensitive", "author": "bluestreak01", "createdAt": "2020-07-22T06:14:46Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeStrFunctionFactory.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.regex.PatternSyntaxException;\n+\n+public class LikeStrFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Ss)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) throws SqlException {\n+        Function value = args.getQuick(0);\n+\n+        CharSequence likeString=args.getQuick(1).getStr(null);\n+\n+        if (likeString == null) {\n+            throw SqlException.$(args.getQuick(1).getPosition(), \"NULL likeString\");\n+        }\n+\n+        String regex = escapeSpecialChars(likeString).\n+                replace('_', '.').replace(\"%\", \".*?\");\n+\n+        try {\n+            Matcher matcher = Pattern.compile(regex,\n+                    Pattern.CASE_INSENSITIVE | Pattern.DOTALL).matcher(\"\");", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1ODMzMQ==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458558331", "bodyText": "please use Chars.toString(). Instances of strings are liable to be cached in the future.", "author": "bluestreak01", "createdAt": "2020-07-22T06:15:55Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeStrFunctionFactory.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.regex.PatternSyntaxException;\n+\n+public class LikeStrFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Ss)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) throws SqlException {\n+        Function value = args.getQuick(0);\n+\n+        CharSequence likeString=args.getQuick(1).getStr(null);\n+\n+        if (likeString == null) {\n+            throw SqlException.$(args.getQuick(1).getPosition(), \"NULL likeString\");\n+        }\n+\n+        String regex = escapeSpecialChars(likeString).\n+                replace('_', '.').replace(\"%\", \".*?\");\n+\n+        try {\n+            Matcher matcher = Pattern.compile(regex,\n+                    Pattern.CASE_INSENSITIVE | Pattern.DOTALL).matcher(\"\");\n+\n+\n+            return new MatchFunction(position, value, matcher);\n+\n+\n+        } catch (PatternSyntaxException e) {\n+            throw SqlException.$(args.getQuick(1).getPosition() + e.getIndex() + 1, e.getMessage());\n+        }\n+    }\n+\n+    public static String escapeSpecialChars(CharSequence s )\n+    {\n+        int len = s.length();\n+        if (len == 0)\n+        {\n+            return \"\";\n+        }\n+\n+        StringBuilder sb = new StringBuilder(s.length() * 2);\n+        for (int i = 0; i < len; i++)\n+        {\n+            char c = s.charAt(i);\n+            if (\"[](){}.*+?$^|#\\\\\".indexOf(c) != -1)\n+            {\n+                sb.append(\"\\\\\");\n+            }\n+            sb.append(c);\n+        }\n+        return sb.toString();", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2MjEzOQ==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458562139", "bodyText": "there is no unit test that hits this line", "author": "bluestreak01", "createdAt": "2020-07-22T06:25:52Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeStrFunctionFactory.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.regex.PatternSyntaxException;\n+\n+public class LikeStrFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Ss)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) throws SqlException {\n+        Function value = args.getQuick(0);\n+\n+        CharSequence likeString=args.getQuick(1).getStr(null);\n+\n+        if (likeString == null) {\n+            throw SqlException.$(args.getQuick(1).getPosition(), \"NULL likeString\");\n+        }\n+\n+        String regex = escapeSpecialChars(likeString).\n+                replace('_', '.').replace(\"%\", \".*?\");\n+\n+        try {\n+            Matcher matcher = Pattern.compile(regex,\n+                    Pattern.CASE_INSENSITIVE | Pattern.DOTALL).matcher(\"\");\n+\n+\n+            return new MatchFunction(position, value, matcher);\n+\n+\n+        } catch (PatternSyntaxException e) {\n+            throw SqlException.$(args.getQuick(1).getPosition() + e.getIndex() + 1, e.getMessage());\n+        }\n+    }\n+\n+    public static String escapeSpecialChars(CharSequence s )\n+    {\n+        int len = s.length();\n+        if (len == 0)\n+        {\n+            return \"\";", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2MjI4MA==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458562280", "bodyText": "this code is untested", "author": "bluestreak01", "createdAt": "2020-07-22T06:26:16Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/regex/LikeStrFunctionFactory.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.regex;\n+\n+\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.cairo.sql.Record;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.engine.functions.BooleanFunction;\n+import io.questdb.griffin.engine.functions.UnaryFunction;\n+import io.questdb.std.ObjList;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.regex.PatternSyntaxException;\n+\n+public class LikeStrFunctionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"like(Ss)\";\n+    }\n+\n+    @Override\n+    public Function newInstance(ObjList<Function> args, int position, CairoConfiguration configuration) throws SqlException {\n+        Function value = args.getQuick(0);\n+\n+        CharSequence likeString=args.getQuick(1).getStr(null);\n+\n+        if (likeString == null) {\n+            throw SqlException.$(args.getQuick(1).getPosition(), \"NULL likeString\");\n+        }\n+\n+        String regex = escapeSpecialChars(likeString).\n+                replace('_', '.').replace(\"%\", \".*?\");\n+\n+        try {\n+            Matcher matcher = Pattern.compile(regex,\n+                    Pattern.CASE_INSENSITIVE | Pattern.DOTALL).matcher(\"\");\n+\n+\n+            return new MatchFunction(position, value, matcher);\n+\n+\n+        } catch (PatternSyntaxException e) {\n+            throw SqlException.$(args.getQuick(1).getPosition() + e.getIndex() + 1, e.getMessage());", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2NjQwNg==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r458566406", "bodyText": "'like' must not be a symbol (see 'and', 'not' etc.)\nThe reason is that symbols break up words, for example 'dislike' will be tokenized as 'dis' + 'like' if 'like' was a symbol. When 'like' is not a symbol - 'dislike' will remain whole and 'like' will only be tokenized as such when it is separated with whitespace, e.g.  x like '%a'", "author": "bluestreak01", "createdAt": "2020-07-22T06:36:47Z", "path": "core/src/main/java/io/questdb/griffin/OperatorExpression.java", "diffHunk": "@@ -54,6 +54,7 @@\n         add(new OperatorExpression(\"and\", 11, true, BINARY, false));\n         add(new OperatorExpression(\"or\", 11, true, BINARY, false));\n         add(new OperatorExpression(\"not\", 11, true, UNARY, false));\n+        add(new OperatorExpression(\"like\", 7, true, BINARY));", "originalCommit": "6b5e6e287a27dcfb62c41b0d96da7db1caabdf6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMwMTg5OA==", "url": "https://github.com/questdb/questdb/pull/512#discussion_r462301898", "bodyText": "@bluestreak01 understood", "author": "mick2004", "createdAt": "2020-07-29T13:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2NjQwNg=="}], "type": "inlineReview"}, {"oid": "ff96cc92f2fc0bb2268f0681ebe330f48d072a5d", "url": "https://github.com/questdb/questdb/commit/ff96cc92f2fc0bb2268f0681ebe330f48d072a5d", "message": "LIKE implementation #476", "committedDate": "2020-08-19T16:00:14Z", "type": "commit"}, {"oid": "e776bc91d249b4e332e27693541238499b2f6156", "url": "https://github.com/questdb/questdb/commit/e776bc91d249b4e332e27693541238499b2f6156", "message": "latest sync", "committedDate": "2020-08-19T16:43:36Z", "type": "commit"}]}