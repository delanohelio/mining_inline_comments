{"pr_number": 870, "pr_title": "Enables XSD validation for XML Export Jobs", "pr_createdAt": "2020-10-02T14:35:25Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/870", "timeline": [{"oid": "a56babe058cb555e9fd2a701d3f0dbf8091b9616", "url": "https://github.com/scireum/sirius-biz/commit/a56babe058cb555e9fd2a701d3f0dbf8091b9616", "message": "Adds the XML export job class from scireum-core\n\nFixes: SIRI-255", "committedDate": "2020-10-01T11:27:12Z", "type": "commit"}, {"oid": "f90b0d546fb235aafde5227fa05582033ee3e503", "url": "https://github.com/scireum/sirius-biz/commit/f90b0d546fb235aafde5227fa05582033ee3e503", "message": "Adds method to get the inputstream to a file in the process\n\nFixes: SIRI-255", "committedDate": "2020-10-02T14:02:11Z", "type": "commit"}, {"oid": "618c449060eba3ab818a869107ae362d339a8bc2", "url": "https://github.com/scireum/sirius-biz/commit/618c449060eba3ab818a869107ae362d339a8bc2", "message": "Adds a method to digest the exported file\n\nFixes: SIRI-255", "committedDate": "2020-10-02T14:04:41Z", "type": "commit"}, {"oid": "4374ed709ecc7ee615d7679b52c4930991e6a60d", "url": "https://github.com/scireum/sirius-biz/commit/4374ed709ecc7ee615d7679b52c4930991e6a60d", "message": "Adds a method to digest the exported entries of an archive export\n\nFixes: SIRI-255", "committedDate": "2020-10-02T14:05:05Z", "type": "commit"}, {"oid": "423235f0b390788dad5111e98bb5f0768a74e719", "url": "https://github.com/scireum/sirius-biz/commit/423235f0b390788dad5111e98bb5f0768a74e719", "message": "Enables XSD validation on export jobs\n\nFixes: SIRI-255", "committedDate": "2020-10-02T14:33:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MzY0NQ==", "url": "https://github.com/scireum/sirius-biz/pull/870#discussion_r498863645", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Note that it the responsibility of the caller to close the stream upon usage.\n          \n          \n            \n                 * Note that it is the responsibility of the caller to close the stream upon usage.", "author": "bwiedmann", "createdAt": "2020-10-02T14:39:51Z", "path": "src/main/java/sirius/biz/process/Processes.java", "diffHunk": "@@ -631,6 +633,24 @@ public OutputStream addFile(String processId, String filename) {\n         return process.getFiles().findOrCreateAttachedBlobByName(filename).createOutputStream(filename);\n     }\n \n+    /**\n+     * Returns an input stream to a file stored in the process.\n+     * <p>\n+     * Note that it the responsibility of the caller to close the stream upon usage.", "originalCommit": "423235f0b390788dad5111e98bb5f0768a74e719", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd", "url": "https://github.com/scireum/sirius-biz/commit/402ea5bb53185e0ef089b882b03328aa2d2229bd", "message": "Update src/main/java/sirius/biz/process/Processes.java\n\nCo-authored-by: Benjamin Wiedmann <bwi@scireum.de>", "committedDate": "2020-10-02T14:46:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxNDU2OQ==", "url": "https://github.com/scireum/sirius-biz/pull/870#discussion_r499514569", "bodyText": "Careful: super.close may throw an exception, in which case the digestExportedFile wont get executed", "author": "qw3ry", "createdAt": "2020-10-05T11:01:11Z", "path": "src/main/java/sirius/biz/jobs/batch/file/XMLExportJob.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.jobs.batch.file;\n+\n+import sirius.biz.process.ProcessContext;\n+import sirius.biz.storage.layer3.FileOrDirectoryParameter;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.xml.XMLStructuredOutput;\n+import sirius.web.resources.Resource;\n+import sirius.web.resources.Resources;\n+\n+import javax.annotation.Nonnull;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.stream.StreamSource;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+/**\n+ * Provides basic functionalities to write data into XML file entries inside an archive.\n+ */\n+public abstract class XMLExportJob extends ArchiveExportJob {\n+\n+    @Part\n+    private static Resources resources;\n+\n+    private final boolean requireValidFile;\n+    private final String xsdResourcePath;\n+    protected XMLStructuredOutput xml;\n+    private OutputStream xmlOutputStream;\n+\n+    /**\n+     * Creates a new job for the given process context.\n+     *\n+     * @param destinationParameter the parameter used to select the destination for the file being written\n+     * @param process              the context in which the process will be executed\n+     */\n+    protected XMLExportJob(@Nonnull XMLExportJobFactory factory,\n+                           FileOrDirectoryParameter destinationParameter,\n+                           ProcessContext process) {\n+        super(destinationParameter, process);\n+        requireValidFile = process.getParameter(factory.requireValidFile).orElse(false);\n+        xsdResourcePath = factory.getXsdResourcePath();\n+    }\n+\n+    protected void initializeXmlFile(String filename) throws IOException {\n+        closeOpenStream();\n+        xmlOutputStream = createEntry(filename);\n+        xml = new XMLStructuredOutput(xmlOutputStream);\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        closeOpenStream();\n+        super.close();", "originalCommit": "402ea5bb53185e0ef089b882b03328aa2d2229bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxNjQ3Mg==", "url": "https://github.com/scireum/sirius-biz/pull/870#discussion_r499516472", "bodyText": "Yup, but if we can't save the target file then there is not much to validate anyway. Besides, the job will also fail.", "author": "idlira", "createdAt": "2020-10-05T11:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxNDU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUzNzI1NQ==", "url": "https://github.com/scireum/sirius-biz/pull/870#discussion_r499537255", "bodyText": "why should this be overwritten?\nwhen is this invoked where?", "author": "andyHa", "createdAt": "2020-10-05T11:45:03Z", "path": "src/main/java/sirius/biz/jobs/batch/file/ArchiveExportJob.java", "diffHunk": "@@ -79,5 +83,28 @@ protected void collectParameters(Consumer<Parameter<?, ?>> parameterCollector) {\n             super.collectParameters(parameterCollector);\n         }\n     }\n+\n+    /**\n+     * Digests every entry of a fresh created export archive.\n+     * <p>\n+     * Override this method in order to perform validations on contents of the final archive.\n+     *\n+     * @param digester a consumer receiving the name and the {@link InputStream} of each entry\n+     */\n+    protected void digestExportedFile(BiConsumer<String, InputStream> digester) {", "originalCommit": "402ea5bb53185e0ef089b882b03328aa2d2229bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU0NDE4Nw==", "url": "https://github.com/scireum/sirius-biz/pull/870#discussion_r499544187", "bodyText": "Bad JavaDoc... method is not supposed to be overwritten but just called...\nAs the method name says, this method provides access to the InputStream of the fresh exported file (does not matter which type: could be a CSV, or a ZIP containing several files). Since getting access to this stream is not always needed, I find it more elegant that the caller explicitly does it if needed. For this there are different methods depending on the parent class (FileExportJob or ArchiveExportJob).\nXMLExportJob is one place calling this digester, in order to run the XSD validation on the export file.", "author": "idlira", "createdAt": "2020-10-05T11:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUzNzI1NQ=="}], "type": "inlineReview"}, {"oid": "f54128af45b567b5154cc01a72d04904270a0cef", "url": "https://github.com/scireum/sirius-biz/commit/f54128af45b567b5154cc01a72d04904270a0cef", "message": "Corrects JavaDoc\n\nMethods weren't meant to be overwritten but simply called if needed.\n\nSIRI-255", "committedDate": "2020-10-05T12:27:58Z", "type": "commit"}]}