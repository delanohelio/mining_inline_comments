{"pr_number": 900, "pr_title": "BREAKING: Valid languages for Translations are now customizable", "pr_createdAt": "2020-11-06T12:16:26Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/900", "timeline": [{"oid": "1c281f419d8a37eb4064333600d9074b8c8ba752", "url": "https://github.com/scireum/sirius-biz/commit/1c281f419d8a37eb4064333600d9074b8c8ba752", "message": "Makes valid languages customizable\n\nFixes: SIRI-240", "committedDate": "2020-11-06T12:04:41Z", "type": "commit"}, {"oid": "2beaee37532e04174099294a23c4565cebac44a8", "url": "https://github.com/scireum/sirius-biz/commit/2beaee37532e04174099294a23c4565cebac44a8", "message": "Adds exception text\n\nFixes: SIRI-243", "committedDate": "2020-11-06T12:05:11Z", "type": "commit"}, {"oid": "0e0c75751eab2f7f6589165396b1bced8032de1c", "url": "https://github.com/scireum/sirius-biz/commit/0e0c75751eab2f7f6589165396b1bced8032de1c", "message": "Adds test cases\n\nFixes: SIRI-243", "committedDate": "2020-11-06T12:05:50Z", "type": "commit"}, {"oid": "6f7d6a64046929bed3d259a95eeb4b23ef6a6c1a", "url": "https://github.com/scireum/sirius-biz/commit/6f7d6a64046929bed3d259a95eeb4b23ef6a6c1a", "message": "Merge branch 'master' into csc/SIRI-240_MultiLangCheck", "committedDate": "2020-11-06T12:06:54Z", "type": "commit"}, {"oid": "c3142259ffd92cf6d7c35524a88bd4f1082a172c", "url": "https://github.com/scireum/sirius-biz/commit/c3142259ffd92cf6d7c35524a88bd4f1082a172c", "message": "Restricts translations to supported languages\n\nFixes: SIRI-243", "committedDate": "2020-11-06T12:24:23Z", "type": "commit"}, {"oid": "72ee9d23dc0860c880627b0076b534d05db5e680", "url": "https://github.com/scireum/sirius-biz/commit/72ee9d23dc0860c880627b0076b534d05db5e680", "message": "Code style\n\nFixes: SIRI-240", "committedDate": "2020-11-12T07:51:30Z", "type": "commit"}, {"oid": "c0b3feec5ec8bc25018484958afea0159b494c00", "url": "https://github.com/scireum/sirius-biz/commit/c0b3feec5ec8bc25018484958afea0159b494c00", "message": "Improves handling of invalid language codes\n\nFixes: SIRI-240", "committedDate": "2020-12-16T15:08:51Z", "type": "commit"}, {"oid": "b2dbd64fc535bbad1c130119c082cf23ac73583d", "url": "https://github.com/scireum/sirius-biz/commit/b2dbd64fc535bbad1c130119c082cf23ac73583d", "message": "Typo in NLS key\n\nFixes: SIRI-240", "committedDate": "2020-12-16T15:09:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM4MzUxNg==", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r544383516", "bodyText": "Validity check for languages is already performed during the creation of a Translation entity.\nDouble-checking when getting texts with invalid (or differently spelled) language codes currently leads to exceptions making affected pages unusable. Removed the check, since returning an empty Optional is sufficient here and keeps pages functional.", "author": "cschierle", "createdAt": "2020-12-16T15:19:18Z", "path": "src/main/java/sirius/biz/translations/BasicTranslations.java", "diffHunk": "@@ -142,14 +178,8 @@ public void updateText(@Nonnull Mapping field, String lang, String text) {\n      * @param field {@link Mapping} of the translated field\n      * @param lang  language code\n      * @return {@link Optional} with translated text for the given language, or empty if none is found\n-     * @throws IllegalArgumentException if lang is not supported by the system\n      */\n     public Optional<String> getText(@Nonnull Mapping field, String lang) {\n-        if (!isSupportedLanguage(lang)) {\n-            throw new IllegalArgumentException(\n-                    \"lang must be a language code supported by the system (supportedLanguages)!\");\n-        }", "originalCommit": "b2dbd64fc535bbad1c130119c082cf23ac73583d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk1OTIyMQ==", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r544959221", "bodyText": "Humm, JournalData is not really the place to log errors.", "author": "idlira", "createdAt": "2020-12-17T09:59:10Z", "path": "src/main/java/sirius/biz/translations/BasicTranslations.java", "diffHunk": "@@ -111,15 +112,23 @@ public void updateText(@Nonnull Mapping field, String lang, String text) {\n         }\n \n         T translation = findOrCreateTranslation(field, lang, text);\n-        translation.getTranslationData().setText(text);\n-        updateTranslation(translation);\n-\n-        if (owner instanceof Journaled) {\n+        if (translation != null) {\n+            translation.getTranslationData().setText(text);\n+            updateTranslation(translation);\n+            if (owner instanceof Journaled) {\n+                JournalData.addJournalEntry(owner,\n+                                            String.format(\"Updated translated text for %s (%s): '%s'\",\n+                                                          field.getName(),\n+                                                          lang,\n+                                                          text));\n+            }\n+        } else if (owner instanceof Journaled) {\n             JournalData.addJournalEntry(owner,", "originalCommit": "c0b3feec5ec8bc25018484958afea0159b494c00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk2MzM5Nw==", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r544963397", "bodyText": "the isValidLanguage() check in findOrCreateTranslation already produces a Handled exception (and returns null) if the language is invalid. So yeah, maybe the journal entry isn't needed then?", "author": "cschierle", "createdAt": "2020-12-17T10:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk1OTIyMQ=="}], "type": "inlineReview"}, {"oid": "233a0874be91cfbfb0e49f403e5dcc386a252a92", "url": "https://github.com/scireum/sirius-biz/commit/233a0874be91cfbfb0e49f403e5dcc386a252a92", "message": "Reverts unnecessary journal entry\n\nFixes: SIRI-240", "committedDate": "2020-12-17T10:21:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0NTc4Mg==", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r545045782", "bodyText": "this is very unexpected behavior - isXXX returning true/false should never throw instead of returning false.\nRename to \"assert / ensureValidLanguage\" and remove return type?", "author": "andyHa", "createdAt": "2020-12-17T12:17:11Z", "path": "src/main/java/sirius/biz/translations/BasicTranslations.java", "diffHunk": "@@ -58,11 +74,23 @@ protected BasicTranslations(BaseEntity<?> owner) {\n     /**\n      * Provides a validator so translations can only be added for supported languages.\n      *\n-     * @param lang the language code in question\n+     * @param lang  the language code in question\n+     * @param field the name of the field to be translated\n      * @return true if language is supported by the system, false otherwise\n+     * @throws sirius.kernel.health.HandledException if lang is not supported by the system\n      */\n-    protected boolean isSupportedLanguage(String lang) {\n-        return supportedLanguages.contains(lang);\n+    protected boolean isValidLanguage(String lang, String field) {\n+        boolean isSupported = validLanguages.isEmpty() || validLanguages.contains(lang);\n+\n+        if (!isSupported) {", "originalCommit": "233a0874be91cfbfb0e49f403e5dcc386a252a92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0NjE4NQ==", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r545046185", "bodyText": "unreachable code", "author": "andyHa", "createdAt": "2020-12-17T12:17:52Z", "path": "src/main/java/sirius/biz/translations/jdbc/SQLTranslations.java", "diffHunk": "@@ -102,9 +114,8 @@ public void deleteAllTexts(@Nonnull Mapping field) {\n \n     @Override\n     protected SQLTranslation findOrCreateTranslation(@Nonnull Mapping field, String lang, String text) {\n-        if (!isSupportedLanguage(lang)) {\n-            throw new IllegalArgumentException(\n-                    \"lang must be a language code supported by the system (supportedLanguages)!\");\n+        if (!isValidLanguage(lang, field.getName())) {\n+            return null;", "originalCommit": "233a0874be91cfbfb0e49f403e5dcc386a252a92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0NjI1NQ==", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r545046255", "bodyText": "s.a.", "author": "andyHa", "createdAt": "2020-12-17T12:18:00Z", "path": "src/main/java/sirius/biz/translations/mongo/MongoTranslations.java", "diffHunk": "@@ -71,9 +83,8 @@ public void deleteAllTexts(@Nonnull Mapping field) {\n \n     @Override\n     protected MongoTranslation findOrCreateTranslation(@Nonnull Mapping field, String lang, String text) {\n-        if (!isSupportedLanguage(lang)) {\n-            throw new IllegalArgumentException(\n-                    \"lang must be a language code supported by the system (supportedLanguages)!\");\n+        if (!isValidLanguage(lang, field.getName())) {\n+            return null;", "originalCommit": "233a0874be91cfbfb0e49f403e5dcc386a252a92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fe9037a1420e10cbef50aca338398feb3f2c62bd", "url": "https://github.com/scireum/sirius-biz/commit/fe9037a1420e10cbef50aca338398feb3f2c62bd", "message": "Adjustments to remove unreachable code\n\nFixes: SIRI-240", "committedDate": "2020-12-17T12:38:38Z", "type": "commit"}, {"oid": "e66e7d6a730bf96ff0581633be7750bb8bfec54a", "url": "https://github.com/scireum/sirius-biz/commit/e66e7d6a730bf96ff0581633be7750bb8bfec54a", "message": "Renaming and removes return type\n\nFixes: SIRI-240", "committedDate": "2020-12-17T12:43:29Z", "type": "commit"}]}