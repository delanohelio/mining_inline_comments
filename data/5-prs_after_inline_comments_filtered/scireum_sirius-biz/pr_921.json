{"pr_number": 921, "pr_title": "Provides some tooling for the VFS: Downloading URLs and auto-extracting VFS roots.", "pr_createdAt": "2020-11-24T14:15:46Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/921", "timeline": [{"oid": "f5a7275aedc62a03612bf3b2898883754c436953", "url": "https://github.com/scireum/sirius-biz/commit/f5a7275aedc62a03612bf3b2898883754c436953", "message": "Extracts a common helper class to provide a VFSRoot which can start a Job.", "committedDate": "2020-11-24T14:13:15Z", "type": "commit"}, {"oid": "a6cf244af912ac93c19d90aa2f174c0d3b8aa020", "url": "https://github.com/scireum/sirius-biz/commit/a6cf244af912ac93c19d90aa2f174c0d3b8aa020", "message": "Simplifies shortening a path.", "committedDate": "2020-11-24T14:13:45Z", "type": "commit"}, {"oid": "f19e7ccd748e7657b8b0d5ddfb27644b195062f8", "url": "https://github.com/scireum/sirius-biz/commit/f19e7ccd748e7657b8b0d5ddfb27644b195062f8", "message": "Provides a base class to provide a VFSRoot which automatically extracts files into a given destination.", "committedDate": "2020-11-24T14:14:40Z", "type": "commit"}, {"oid": "4e65c36c445b9960086cca8145c1e7837e2c8b94", "url": "https://github.com/scireum/sirius-biz/commit/4e65c36c445b9960086cca8145c1e7837e2c8b94", "message": "Permits to download an store a given URL as VirtualFile.", "committedDate": "2020-11-24T14:15:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU4NjAxNw==", "url": "https://github.com/scireum/sirius-biz/pull/921#discussion_r529586017", "bodyText": "rename to createUnarchiveJob or createExtractJob?", "author": "idlira", "createdAt": "2020-11-24T14:28:02Z", "path": "src/main/java/sirius/biz/storage/layer3/AutoExtractRoot.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer3;\n+\n+import sirius.biz.jobs.JobStartingRoot;\n+import sirius.biz.jobs.presets.JobPreset;\n+import sirius.biz.jobs.presets.JobPresets;\n+import sirius.kernel.commons.Explain;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Value;\n+import sirius.kernel.di.std.Part;\n+\n+import javax.annotation.Nullable;\n+import java.util.Optional;\n+import java.util.function.Function;\n+\n+/**\n+ * Provides a base class to create a {@link VirtualFileSystem VFS} root which automatically extracts uploaded archives\n+ * like ZIP files.\n+ * <p>\n+ * This is done by automatically starting the {@link ExtractArchiveJob}.\n+ */\n+public abstract class AutoExtractRoot extends JobStartingRoot {\n+\n+    @Part\n+    protected ExtractArchiveJob extractArchiveJob;\n+\n+    @Part\n+    @Nullable\n+    protected JobPresets presets;\n+\n+    @Override\n+    protected void populateRoot(MutableVirtualFile rootDirectory) {\n+        rootDirectory.withChildren(new FindOnlyProvider(this::createUnzipJob));\n+    }\n+\n+    protected VirtualFile createUnzipJob(VirtualFile parent, String name) {", "originalCommit": "f19e7ccd748e7657b8b0d5ddfb27644b195062f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU4NzQ5Nw==", "url": "https://github.com/scireum/sirius-biz/pull/921#discussion_r529587497", "bodyText": "ctz -> processContext", "author": "sabieber", "createdAt": "2020-11-24T14:29:57Z", "path": "src/main/java/sirius/biz/jobs/JobStartingRoot.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.jobs;\n+\n+import sirius.biz.jobs.params.Parameter;\n+import sirius.biz.process.ProcessContext;\n+import sirius.biz.process.Processes;\n+import sirius.biz.process.logs.ProcessLog;\n+import sirius.biz.storage.layer2.Blob;\n+import sirius.biz.storage.layer2.BlobStorage;\n+import sirius.biz.storage.layer2.BlobStorageSpace;\n+import sirius.biz.storage.layer3.FileParameter;\n+import sirius.biz.storage.layer3.SingularVFSRoot;\n+import sirius.biz.storage.layer3.TmpRoot;\n+import sirius.biz.storage.layer3.VirtualFileSystem;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Value;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.health.HandledException;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.security.UserContext;\n+\n+import java.io.OutputStream;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Provides a base class for all roots which sooner or later start a {@link JobFactory job} for an uploaded file.\n+ */\n+public abstract class JobStartingRoot extends SingularVFSRoot {\n+\n+    @Part\n+    protected BlobStorage blobStorage;\n+\n+    @Part\n+    protected VirtualFileSystem virtualFileSystem;\n+\n+    @Part\n+    protected Processes processes;\n+\n+    /**\n+     * Creates an <tt>OutputStream</tt> which triggers the given job with the given parameters once the stream is closed.\n+     *\n+     * @param jobToRun          the job to actually run\n+     * @param parameterProvider permits to control the parameter values for the job (the file is automatically used as\n+     *                          first {@link FileParameter} of the job)\n+     * @param filename          the actual filename of the file being processed\n+     * @return an output stream which triggers the job once the stream is closed\n+     */\n+    protected OutputStream uploadAndTrigger(JobFactory jobToRun,\n+                                            Function<String, Value> parameterProvider,\n+                                            String filename) {\n+        try {\n+            BlobStorageSpace temporaryStorageSpace = blobStorage.getSpace(TmpRoot.TMP_SPACE);\n+            Blob buffer = temporaryStorageSpace.createTemporaryBlob(UserContext.getCurrentUser().getTenantId());\n+            return buffer.createOutputStream(() -> {\n+                if (buffer.getSize() > 0) {\n+                    temporaryStorageSpace.markAsUsed(buffer);\n+                    trigger(jobToRun, parameterProvider, buffer, filename);\n+                } else {\n+                    buffer.delete();\n+                }\n+            }, filename);\n+        } catch (Exception e) {\n+            throw Exceptions.handle(e);\n+        }\n+    }\n+\n+    private void trigger(JobFactory jobToRun, Function<String, Value> parameterProvider, Blob buffer, String filename) {\n+        processes.executeInStandbyProcessForCurrentTenant(getStandbyProcessType(),\n+                                                          this::getStandbyProcessDescription,\n+                                                          ctx -> triggerInProcess(jobToRun,\n+                                                                                  parameterProvider,\n+                                                                                  buffer,\n+                                                                                  filename,\n+                                                                                  ctx));\n+    }\n+\n+    /**\n+     * Returns the type for the standby process which is used to start the job.\n+     * <p>\n+     * Starting jobs happens in a standy process so that we can log any problems and provide some debiggung capabilities.\n+     *\n+     * @return the type to be used in\n+     * {@link Processes#executeInStandbyProcessForCurrentTenant(String, Supplier, Consumer)}\n+     */\n+    protected abstract String getStandbyProcessType();\n+\n+    /**\n+     * Returns the description for the standby process which is used to start the job.\n+     * <p>\n+     * Starting jobs happens in a standy process so that we can log any problems and provide some debiggung capabilities.\n+     *\n+     * @return the description to be used in\n+     * {@link Processes#executeInStandbyProcessForCurrentTenant(String, Supplier, Consumer)}\n+     */\n+    protected abstract String getStandbyProcessDescription();\n+\n+    private void triggerInProcess(JobFactory jobToRun,\n+                                  Function<String, Value> parameterProvider,\n+                                  Blob buffer,\n+                                  String filename,\n+                                  ProcessContext ctx) {", "originalCommit": "f5a7275aedc62a03612bf3b2898883754c436953", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU4ODE4Ng==", "url": "https://github.com/scireum/sirius-biz/pull/921#discussion_r529588186", "bodyText": "No i18n?", "author": "sabieber", "createdAt": "2020-11-24T14:30:50Z", "path": "src/main/java/sirius/biz/jobs/JobsRoot.java", "diffHunk": "@@ -145,77 +123,21 @@ private void listPresets(VirtualFile parent, FileSearch fileSearch) {\n     private VirtualFile unwrapPreset(VirtualFile parent, String name) {\n         JobPreset preset = parent.as(JobPreset.class);\n         MutableVirtualFile result = MutableVirtualFile.checkedCreate(parent, name);\n-        result.withOutputStreamSupplier(uploadFile -> uploadAndTrigger(preset, uploadFile.name()));\n+        result.withOutputStreamSupplier(uploadFile -> {\n+            JobConfigData jobConfigData = preset.getJobConfigData();\n+            return uploadAndTrigger(jobConfigData.getJobFactory(), jobConfigData::fetchParameter, uploadFile.name());\n+        });\n \n         return result;\n     }\n \n-    private OutputStream uploadAndTrigger(JobPreset preset, String filename) {\n-        try {\n-            BlobStorageSpace temporaryStorageSpace = blobStorage.getSpace(TmpRoot.TMP_SPACE);\n-            Blob buffer = temporaryStorageSpace.createTemporaryBlob(UserContext.getCurrentUser().getTenantId());\n-            return buffer.createOutputStream(() -> {\n-                if (buffer.getSize() > 0) {\n-                    temporaryStorageSpace.markAsUsed(buffer);\n-                    trigger(preset, buffer, filename);\n-                } else {\n-                    buffer.delete();\n-                }\n-            }, filename);\n-        } catch (Exception e) {\n-            throw Exceptions.handle(e);\n-        }\n-    }\n-\n-    private void trigger(JobPreset preset, Blob buffer, String filename) {\n-        processes.executeInStandbyProcessForCurrentTenant(\"biz-jobs-root\",\n-                                                          () -> \"/jobs Uploads\",\n-                                                          ctx -> triggerInProcess(preset, buffer, filename, ctx));\n-    }\n-\n-    private void triggerInProcess(JobPreset preset, Blob buffer, String filename, ProcessContext ctx) {\n-        if (ctx.isDebugging()) {\n-            ctx.debug(ProcessLog.info()\n-                                .withFormattedMessage(\n-                                        \"Starting preset '%s' for job '%s' and user '%s' using the uploaded file '%s' (%s')\",\n-                                        preset.getJobConfigData().getLabel(),\n-                                        preset.getJobConfigData().getJobName(),\n-                                        UserContext.getCurrentUser().getUserName(),\n-                                        buffer.getFilename(),\n-                                        NLS.formatSize(buffer.getSize())));\n-        }\n-\n-        String parameterName = findFileParameter(preset);\n-\n-        try {\n-            preset.getJobConfigData().getJobFactory().startInBackground(param -> {\n-                if (Strings.areEqual(param, parameterName)) {\n-                    return Value.of(virtualFileSystem.makePath(TmpRoot.TMP_PATH, buffer.getBlobKey(), filename));\n-                }\n-\n-                return preset.getJobConfigData().fetchParameter(param);\n-            });\n-        } catch (HandledException exception) {\n-            ctx.log(ProcessLog.error()\n-                              .withFormattedMessage(\n-                                      \"Failed to start preset '%s' for job '%s' and user '%s' using the uploaded file '%s' (%s'): %s\",\n-                                      preset.getJobConfigData().getLabel(),\n-                                      preset.getJobConfigData().getJobName(),\n-                                      UserContext.getCurrentUser().getUserName(),\n-                                      buffer.getFilename(),\n-                                      NLS.formatSize(buffer.getSize()),\n-                                      exception.getMessage()));\n-        }\n+    @Override\n+    protected String getStandbyProcessType() {\n+        return \"biz-jobs-root\";\n     }\n \n-    private String findFileParameter(JobPreset preset) {\n-        return preset.getJobConfigData()\n-                     .getJobFactory()\n-                     .getParameters()\n-                     .stream()\n-                     .filter(p -> FileParameter.class.isAssignableFrom(p.getBuilderType()))\n-                     .map(Parameter::getName)\n-                     .findFirst()\n-                     .orElse(null);\n+    @Override\n+    protected String getStandbyProcessDescription() {\n+        return \"/jobs Uploads\";", "originalCommit": "f5a7275aedc62a03612bf3b2898883754c436953", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU5MDQ3Nw==", "url": "https://github.com/scireum/sirius-biz/pull/921#discussion_r529590477", "bodyText": "something went wrong here", "author": "sabieber", "createdAt": "2020-11-24T14:34:02Z", "path": "src/main/java/sirius/biz/storage/layer3/VirtualFile.java", "diffHunk": "@@ -1230,6 +1237,69 @@ private static void defaultTunnelHandler(VirtualFile file, Response response) {\n         }\n     }\n \n+    /**\n+     * Fetches the given URL and stores the contents in this file.\n+     * <p>\n+     * If the contents of the file are not newer than the last modification date of this file, nothing will happen\n+     * unless the <tt>force</tt> parameter is set to <tt>true</tt>.\n+     *\n+     * @param url   the URL to fetch\n+     * @param force indicates whether the \"if modified since\" check should be suppressed\n+     * @return <tt>true</tt> if the file was successfully fetched or <tt>false</tt> if the contents weren't updated\n+     * as no change was detected\n+     * @throws IOException in case of any IO error while downloading the contents\n+     */\n+    public boolean loadFromUrl(URL url, boolean force) throws IOException {\n+        HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();\n+        if (!force && exists()) {\n+            urlConnection.addRequestProperty(HttpHeaderNames.IF_MODIFIED_SINCE.toString(),\n+                                             lastModifiedDate().format(DateTimeFormatter.RFC_1123_DATE_TIME));\n+        }\n+\n+        urlConnection.connect();\n+\n+        if (urlConnection.getResponseCode() == HttpResponseStatus.NOT_MODIFIED.code()) {\n+            return false;\n+        }\n+\n+        try (InputStream in = urlConnection.getInputStream()) {\n+            if (urlConnection.getContentLengthLong() >= 0) {\n+                consumeStream(in, urlConnection.getContentLengthLong());\n+            } else {\n+                try (OutputStream out = createOutputStream()) {\n+                    Streams.transfer(in, out);\n+                }\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    /**\n+     * Performs a download just as {@link #loadFromUrl(URL, boolean)} but reports to the given process.\n+     * <p>\n+     * This will increment one of the timings (downloaded or download skipped) and also directly report IO\n+     * errors to the process without spamming the system logs.\n+     *\n+     * @param url            the url to fetch\n+     * @param force          indicates whether the \"if modified since\" check should be suppressed\n+     * @param processContext the process to report to\n+     */\n+    public void loadFromUrl(URL url, boolean force, ProcessContext processContext) {\n+        try {\n+            Watch watch = Watch.start();\n+            if (loadFromUrl(url, force)) {\n+                processContext.addTiming(NLS.get(\"VirtualFile.fileDownloaded\"), watch.elapsedMillis());\n+            } else {\n+                processContext.addTiming(NLS.get(\"VirtualFile.fileDownloadSkipped\"), watch.elapsedMillis());\n+            }\n+        } catch (IOException e) {\n+            processContext.log(ProcessLog.error()\n+                                         .withNLSKey(\"#<N          XXCS  XM\")", "originalCommit": "4e65c36c445b9960086cca8145c1e7837e2c8b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1c40f220a75c7c4cce1cd02f966db3093d2c7eb0", "url": "https://github.com/scireum/sirius-biz/commit/1c40f220a75c7c4cce1cd02f966db3093d2c7eb0", "message": "Applies review comments.", "committedDate": "2020-11-24T19:49:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MDEyMQ==", "url": "https://github.com/scireum/sirius-biz/pull/921#discussion_r530140121", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Starting jobs happens in a standy process so that we can log any problems and provide some debiggung capabilities.\n          \n          \n            \n                 * Starting jobs happens in a standby process so that we can log any problems and provide some debugging capabilities.", "author": "mkeckmkeck", "createdAt": "2020-11-25T06:46:14Z", "path": "src/main/java/sirius/biz/jobs/JobStartingRoot.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.jobs;\n+\n+import sirius.biz.jobs.params.Parameter;\n+import sirius.biz.process.ProcessContext;\n+import sirius.biz.process.Processes;\n+import sirius.biz.process.logs.ProcessLog;\n+import sirius.biz.storage.layer2.Blob;\n+import sirius.biz.storage.layer2.BlobStorage;\n+import sirius.biz.storage.layer2.BlobStorageSpace;\n+import sirius.biz.storage.layer3.FileParameter;\n+import sirius.biz.storage.layer3.SingularVFSRoot;\n+import sirius.biz.storage.layer3.TmpRoot;\n+import sirius.biz.storage.layer3.VirtualFileSystem;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Value;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.health.HandledException;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.security.UserContext;\n+\n+import java.io.OutputStream;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Provides a base class for all roots which sooner or later start a {@link JobFactory job} for an uploaded file.\n+ */\n+public abstract class JobStartingRoot extends SingularVFSRoot {\n+\n+    @Part\n+    protected BlobStorage blobStorage;\n+\n+    @Part\n+    protected VirtualFileSystem virtualFileSystem;\n+\n+    @Part\n+    protected Processes processes;\n+\n+    /**\n+     * Creates an <tt>OutputStream</tt> which triggers the given job with the given parameters once the stream is closed.\n+     *\n+     * @param jobToRun          the job to actually run\n+     * @param parameterProvider permits to control the parameter values for the job (the file is automatically used as\n+     *                          first {@link FileParameter} of the job)\n+     * @param filename          the actual filename of the file being processed\n+     * @return an output stream which triggers the job once the stream is closed\n+     */\n+    protected OutputStream uploadAndTrigger(JobFactory jobToRun,\n+                                            Function<String, Value> parameterProvider,\n+                                            String filename) {\n+        try {\n+            BlobStorageSpace temporaryStorageSpace = blobStorage.getSpace(TmpRoot.TMP_SPACE);\n+            Blob buffer = temporaryStorageSpace.createTemporaryBlob(UserContext.getCurrentUser().getTenantId());\n+            return buffer.createOutputStream(() -> {\n+                if (buffer.getSize() > 0) {\n+                    temporaryStorageSpace.markAsUsed(buffer);\n+                    trigger(jobToRun, parameterProvider, buffer, filename);\n+                } else {\n+                    buffer.delete();\n+                }\n+            }, filename);\n+        } catch (Exception e) {\n+            throw Exceptions.handle(e);\n+        }\n+    }\n+\n+    private void trigger(JobFactory jobToRun, Function<String, Value> parameterProvider, Blob buffer, String filename) {\n+        processes.executeInStandbyProcessForCurrentTenant(getStandbyProcessType(),\n+                                                          this::getStandbyProcessDescription,\n+                                                          ctx -> triggerInProcess(jobToRun,\n+                                                                                  parameterProvider,\n+                                                                                  buffer,\n+                                                                                  filename,\n+                                                                                  ctx));\n+    }\n+\n+    /**\n+     * Returns the type for the standby process which is used to start the job.\n+     * <p>\n+     * Starting jobs happens in a standy process so that we can log any problems and provide some debiggung capabilities.", "originalCommit": "1c40f220a75c7c4cce1cd02f966db3093d2c7eb0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3beb741c04c71f343da314c6c60e5bc50da3ba87", "url": "https://github.com/scireum/sirius-biz/commit/3beb741c04c71f343da314c6c60e5bc50da3ba87", "message": "Update src/main/java/sirius/biz/jobs/JobStartingRoot.java\n\nCo-authored-by: Matthias Keck <60612914+mkeckmkeck@users.noreply.github.com>", "committedDate": "2020-11-25T08:59:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0MTQ5Mw==", "url": "https://github.com/scireum/sirius-biz/pull/921#discussion_r530341493", "bodyText": "Hat JobFactory noch kein @AutoRegister?", "author": "qw3ry", "createdAt": "2020-11-25T12:36:11Z", "path": "src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java", "diffHunk": "@@ -39,9 +40,29 @@\n  * This uses the {@link ArchiveExtractor} so depending if 7-ZIP is enabled this supports either a whole bunch\n  * of formats (rar, 7z, tar etc.) or \"just\" ZIP files using the Java API.\n  */\n-@Register\n+@Register(classes = {JobFactory.class, ExtractArchiveJob.class})", "originalCommit": "3beb741c04c71f343da314c6c60e5bc50da3ba87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg0MzY0Nw==", "url": "https://github.com/scireum/sirius-biz/pull/921#discussion_r530843647", "bodyText": "nope, once a classes list in @register is present, this wins over all", "author": "andyHa", "createdAt": "2020-11-26T08:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0MTQ5Mw=="}], "type": "inlineReview"}]}