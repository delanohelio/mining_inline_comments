{"pr_number": 1492, "pr_title": "[SDL 0278] Screen Manager Template Management", "pr_createdAt": "2020-09-09T21:31:55Z", "pr_url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492", "timeline": [{"oid": "b9bb7adeda58b9a96cf56eac08b3b8d9c335a2d6", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/b9bb7adeda58b9a96cf56eac08b3b8d9c335a2d6", "message": "Work in Progress", "committedDate": "2020-09-09T21:29:37Z", "type": "commit"}, {"oid": "8ff3f63f2498bca34b04372cffebcf318c31cf81", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/8ff3f63f2498bca34b04372cffebcf318c31cf81", "message": "BaseTextAndGraphicsManager changes", "committedDate": "2020-09-11T15:58:45Z", "type": "commit"}, {"oid": "ac2fd7d5418c862a35c59473dcc4f6f168bdd597", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/ac2fd7d5418c862a35c59473dcc4f6f168bdd597", "message": "TextAndGraphicsUpdateOperation updates for template management", "committedDate": "2020-09-11T16:17:09Z", "type": "commit"}, {"oid": "c67351fd572ed55820613f85b0c682eda8ce6874", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/c67351fd572ed55820613f85b0c682eda8ce6874", "message": "TextAndGraphicsState updates for template managment", "committedDate": "2020-09-11T16:17:45Z", "type": "commit"}, {"oid": "5b743fb689e05acb051205388563c5ed25b4bf26", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/5b743fb689e05acb051205388563c5ed25b4bf26", "message": "remove comment and fix existing unit test", "committedDate": "2020-09-11T17:46:21Z", "type": "commit"}, {"oid": "2fe112a4c12c68f69ddfecff55c66dd78c1952db", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/2fe112a4c12c68f69ddfecff55c66dd78c1952db", "message": "Added getTemplateConfiguration method and made currentState method package private", "committedDate": "2020-09-11T19:18:22Z", "type": "commit"}, {"oid": "f16f3d137a357f0d457dda12c5f73246390e3476", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f16f3d137a357f0d457dda12c5f73246390e3476", "message": "Add test to TextAndGraphicManagerTest", "committedDate": "2020-09-11T19:18:59Z", "type": "commit"}, {"oid": "c63de6bc6cca7ba3038c4685f31575569b44cc95", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/c63de6bc6cca7ba3038c4685f31575569b44cc95", "message": "Fix unit test and remove commented out code", "committedDate": "2020-09-11T19:29:11Z", "type": "commit"}, {"oid": "3ef95f42a447349b0a883c43671dfd320803f4de", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/3ef95f42a447349b0a883c43671dfd320803f4de", "message": "Fix test to expand code cov", "committedDate": "2020-09-11T19:48:41Z", "type": "commit"}, {"oid": "85cfa48257f2065f5ea2d414e79c6a36105b927c", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/85cfa48257f2065f5ea2d414e79c6a36105b927c", "message": "Remove added constructors and use chainable setters", "committedDate": "2020-09-11T19:57:43Z", "type": "commit"}, {"oid": "319f663758fd16ae7a2463c40878673d860bdf85", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/319f663758fd16ae7a2463c40878673d860bdf85", "message": "Fix error in shouldUpdateTemplateConfig method", "committedDate": "2020-09-14T13:32:26Z", "type": "commit"}, {"oid": "3ab6c58466ba5578071f6704c836bc56adaa663b", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/3ab6c58466ba5578071f6704c836bc56adaa663b", "message": "Added unit test to test template change", "committedDate": "2020-09-14T13:32:51Z", "type": "commit"}, {"oid": "f83ab01456163089a96f60fc2425e1d6d30038fd", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f83ab01456163089a96f60fc2425e1d6d30038fd", "message": "Added unit test", "committedDate": "2020-09-14T14:44:48Z", "type": "commit"}, {"oid": "f9b8b0e7f3a9a5acd211b2efda232c0ffda1f8be", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f9b8b0e7f3a9a5acd211b2efda232c0ffda1f8be", "message": "Added check to cancel the operation if text / layout changes and images still need to be uploaded", "committedDate": "2020-09-14T15:50:10Z", "type": "commit"}, {"oid": "c5a4b7202a5fa82b1f7cddd4c136439a32d8effd", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/c5a4b7202a5fa82b1f7cddd4c136439a32d8effd", "message": "Add unit test for if a show fails", "committedDate": "2020-09-14T15:52:40Z", "type": "commit"}, {"oid": "b8d3b1c84997fc365e458c3c7ccfee4e68e5c6e4", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/b8d3b1c84997fc365e458c3c7ccfee4e68e5c6e4", "message": "Added comments and simplified logic", "committedDate": "2020-09-14T17:43:49Z", "type": "commit"}, {"oid": "68b9b8aa061b7c92f072f523cd8c0da4583fbfe1", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/68b9b8aa061b7c92f072f523cd8c0da4583fbfe1", "message": "Fix comparing TemplateConfigurations", "committedDate": "2020-09-14T20:55:52Z", "type": "commit"}, {"oid": "587e4c44fc6a14ad5951fcea3362e35532bb4f01", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/587e4c44fc6a14ad5951fcea3362e35532bb4f01", "message": "Merge branch 'develop' into feature/issue-1327-screen-manager-template-management\n\n# Conflicts:\n#\tbase/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java\n#\tbase/src/main/java/com/smartdevicelink/managers/screen/TextsAndGraphicsState.java", "committedDate": "2020-09-14T23:26:32Z", "type": "commit"}, {"oid": "a36fa07d1217424dcbce13c73f73534d3bf9953c", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/a36fa07d1217424dcbce13c73f73534d3bf9953c", "message": "Add comments and fix formatting", "committedDate": "2020-09-15T01:41:22Z", "type": "commit"}, {"oid": "6e85413b1d0b6b0bfead16f6b111f89776c3b4c2", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/6e85413b1d0b6b0bfead16f6b111f89776c3b4c2", "message": "Add java Docs to baseScreenManager", "committedDate": "2020-09-15T01:47:12Z", "type": "commit"}, {"oid": "b8ba883eedea558cf8edd20b384b0944d6f19314", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/b8ba883eedea558cf8edd20b384b0944d6f19314", "message": "Change name of var and fix formatiing", "committedDate": "2020-09-15T01:52:56Z", "type": "commit"}, {"oid": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/9037faac9656f0b21685de1c1b4329b0d3b898e8", "message": "Added final to vars that go reverted when fixing merge conflicts", "committedDate": "2020-09-15T14:01:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDYyNw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488850627", "bodyText": "Shouldnt this be newScreenData?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tthis.softButtonManager.get().setCurrentMainField1(currentScreenData.getTextField1());\n          \n          \n            \n            \t\t\tthis.softButtonManager.get().setCurrentMainField1(newScreenData.getTextField1());", "author": "bilal-alsharifi", "createdAt": "2020-09-15T17:41:27Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/BaseTextAndGraphicManager.java", "diffHunk": "@@ -191,47 +192,74 @@ private synchronized void sdlUpdate(final CompletionListener listener) {\n \t\t}\n \n \t\t// Task can be READY, about to start and popped of the queue, so we have to cancel it, to prevent it from starting\n-\t\tif (updateOperation != null && updateOperation.getState() == Task.READY) {\n+\t\tif (updateOperation != null && updateOperation.getState() == Task.READY && supersedePreviousOperations) {\n \t\t\tupdateOperation.cancelTask();\n \t\t\tif (currentOperationListener != null) {\n \t\t\t\tcurrentOperationListener.onComplete(false);\n \t\t\t}\n \t\t}\n \n \t\t// If Task is IN_PROGRESS, it\u2019s not on the queue, we need to mark it as cancelled. The task will return at some point when it checks its status and call the listener back\n-\t\tif (updateOperation != null && updateOperation.getState() == Task.IN_PROGRESS) {\n+\t\tif (updateOperation != null && updateOperation.getState() == Task.IN_PROGRESS && supersedePreviousOperations) {\n \t\t\tupdateOperation.cancelTask();\n \t\t}\n \n \t\tcurrentOperationListener = listener;\n \n \t\tCurrentScreenDataUpdatedListener currentScreenDataUpdateListener = new CurrentScreenDataUpdatedListener() {\n \t\t\t@Override\n-\t\t\tpublic void onUpdate(Show show) {\n-\t\t\t\tupdatePendingOperationsWithNewScreenData(show);\n-\t\t\t\tcurrentScreenData = show;\n+\t\t\tpublic void onUpdate(TextsAndGraphicsState newScreenData) {\n+\t\t\t\tif(newScreenData != null) {\n+\t\t\t\t\t// Update our current screen data\n+\t\t\t\t\tcurrentScreenData = newScreenData;\n+\t\t\t\t\tupdatePendingOperationsWithNewScreenData(newScreenData);\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\t@Override\n+\t\t\tpublic void onError() {\n+\t\t\t\t// Invalidate data that's different from our current screen data\n+\t\t\t\tresetFieldsToCurrentScreenData();\n \t\t\t}\n \t\t};\n \n \t\tupdateOperation = new TextAndGraphicUpdateOperation(internalInterface, fileManager.get(), defaultMainWindowCapability, currentScreenData, currentState(), currentOperationListener, currentScreenDataUpdateListener);\n \t\ttransactionQueue.add(updateOperation, false);\n \t}\n \n+\tvoid resetFieldsToCurrentScreenData() {\n+\t\ttextField1 = currentScreenData.getTextField1();\n+\t\ttextField2 = currentScreenData.getTextField2();\n+\t\ttextField3 = currentScreenData.getTextField3();\n+\t\ttextField4 = currentScreenData.getTextField4();\n+\t\tmediaTrackTextField = currentScreenData.getMediaTrackTextField();\n+\t\ttitle = currentScreenData.getTitle();\n+\t\ttextAlignment = currentScreenData.getTextAlignment();\n+\t\ttextField1Type = currentScreenData.getTextField1Type();\n+\t\ttextField2Type = currentScreenData.getTextField2Type();\n+\t\ttextField3Type = currentScreenData.getTextField3Type();\n+\t\ttextField4Type = currentScreenData.getTextField4Type();\n+\t\tprimaryGraphic = currentScreenData.getPrimaryGraphic();\n+\t\tsecondaryGraphic = currentScreenData.getSecondaryGraphic();\n+\t\ttemplateConfiguration = currentScreenData.getTemplateConfiguration();\n+\t}\n+\n \t//Updates pending task with current screen data\n-\tvoid updatePendingOperationsWithNewScreenData(Show newScreenData) {\n+\tvoid updatePendingOperationsWithNewScreenData(TextsAndGraphicsState newScreenData) {\n \t\tfor (Task task : transactionQueue.getTasksAsList()) {\n \t\t\tif (!(task instanceof TextAndGraphicUpdateOperation)) {\n \t\t\t\tcontinue;\n \t\t\t}\n \t\t\t((TextAndGraphicUpdateOperation) task).setCurrentScreenData(newScreenData);\n \t\t}\n-\t\tif (this.softButtonManager.get() != null && newScreenData.getMainField1() != null) {\n-\t\t\tthis.softButtonManager.get().setCurrentMainField1(currentScreenData.getMainField1());\n+\t\tif (this.softButtonManager.get() != null && newScreenData.getTextField1() != null) {\n+\t\t\tthis.softButtonManager.get().setCurrentMainField1(currentScreenData.getTextField1());", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MzMwOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488853308", "bodyText": "Shouldn't templateConfiguration have @nonnull annotation?", "author": "bilal-alsharifi", "createdAt": "2020-09-15T17:45:58Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/BaseScreenManager.java", "diffHunk": "@@ -377,6 +378,21 @@ public String getTitle(){\n \t\treturn this.textAndGraphicManager.getTitle();\n \t}\n \n+\t/**\n+\t * Change the current layout to a new layout and optionally update the layout's night and day color schemes. The values set for the text, graphics,\n+\t * buttons and template title persist between layout changes. To update the text, graphics, buttons and template title at the same time as the template,\n+\t * batch all the updates between `beginUpdates` and `endUpdates`. If the layout update fails while batching, then the updated text, graphics, buttons or template title will also not be updated.\n+\t *\n+\t * If you are connected on a < v6.0 connection and batching the update, the layout will be updated, then the text and graphics will be updated.\n+\t * If you are connected on a >= v6.0 connection, the layout will be updated at the same time that the text and graphics are updated.\n+\t *\n+\t * @param templateConfiguration The new configuration of the template, including the layout and color scheme.\n+\t * @param listener A listener that will be called when the layout change finished.\n+\t */\n+\tpublic void changeLayout(TemplateConfiguration templateConfiguration, CompletionListener listener) {", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4Nzc1Nw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488887757", "bodyText": "internalInterface.get() could be null. This applies to all usages of internalInterface in this class", "author": "bilal-alsharifi", "createdAt": "2020-09-15T18:48:13Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java", "diffHunk": "@@ -60,16 +64,40 @@ private void start() {\n             return;\n         }\n \n-        // Build a show with everything from `self.newState`, we'll pull things out later if we can.\n-        Show fullShow = new Show();\n+        fullShow = new Show();\n         fullShow.setAlignment(updatedState.getTextAlignment());\n         fullShow = assembleShowText(fullShow);\n         fullShow = assembleShowImages(fullShow);\n+        fullShow = assembleLayout(fullShow);\n+\n+\n+        if (internalInterface.get().getSdlMsgVersion().getMajorVersion() >= 6) {", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5NDYxNw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488894617", "bodyText": "Can we use < instead of using >= then !?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!(internalInterface.get().getSdlMsgVersion().getMajorVersion() >= 6) || !shouldUpdateTemplateConfig()) {\n          \n          \n            \n                    if (internalInterface.get().getSdlMsgVersion().getMajorVersion() < 6 || !shouldUpdateTemplateConfig()) {", "author": "bilal-alsharifi", "createdAt": "2020-09-15T18:55:38Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java", "diffHunk": "@@ -452,42 +501,59 @@ private Show setBlankTextFields(Show newShow) {\n         return newShow;\n     }\n \n+    Show assembleLayout(Show show) {\n+        if (!(internalInterface.get().getSdlMsgVersion().getMajorVersion() >= 6) || !shouldUpdateTemplateConfig()) {", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwOTQ0NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488909445", "bodyText": "I see that we keep doing that same check in mutiple places. I suggested adding a new private method and reuse it instead of compareing the version every time to make the code easier to read:\nprivate boolean showRPCSupportsTemplateConfiguration() {\n    if (internalInterface.get() == null || internalInterface.get().getSdlMsgVersion() == null) {\n        return false;\n    }\n    return internalInterface.get().getSdlMsgVersion().getMajorVersion() >= 6;\n}", "author": "bilal-alsharifi", "createdAt": "2020-09-15T19:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5NDYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwNTg2NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488905864", "bodyText": "Do we need to set TemplateConfiguration if the head unit doesn't support it? the head unit will ignore it but why send it if is not going to be used? I suggest adding a condition to only do newShow.setTemplateConfiguration it when the head unit supports it.", "author": "bilal-alsharifi", "createdAt": "2020-09-15T19:13:21Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java", "diffHunk": "@@ -437,7 +486,7 @@ Show extractTextFromShow(Show show) {\n         newShow.setTemplateTitle(show.getTemplateTitle());\n         newShow.setMetadataTags(show.getMetadataTags());\n         newShow.setAlignment(show.getAlignment());\n-\n+        newShow.setTemplateConfiguration(show.getTemplateConfiguration());", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkxNTM0Nw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488915347", "bodyText": "I think the listner should be called whether there is a sucess or not. Also a message should be printed on failure :\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(response.getSuccess()){\n          \n          \n            \n                                updateCurrentScreenDataFromSetDisplayLayout(setLayout);\n          \n          \n            \n                                listener.onComplete(true);\n          \n          \n            \n                            }\n          \n          \n            \n                            else {\n          \n          \n            \n                                currentScreenDataUpdateListener.onError();\n          \n          \n            \n                            }\n          \n          \n            \n                            if(response.getSuccess()){\n          \n          \n            \n                                updateCurrentScreenDataFromSetDisplayLayout(setLayout);\n          \n          \n            \n                            }\n          \n          \n            \n                            else {\n          \n          \n            \n                                DebugTool.logInfo(TAG, \"Text and Graphic SetDisplayLayout failed\");\n          \n          \n            \n                                currentScreenDataUpdateListener.onError();\n          \n          \n            \n                            }\n          \n          \n            \n                            listener.onComplete(response.getSuccess());", "author": "bilal-alsharifi", "createdAt": "2020-09-15T19:27:08Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java", "diffHunk": "@@ -122,6 +154,23 @@ public void onResponse(int correlationId, RPCResponse response) {\n         internalInterface.get().sendRPC(show);\n     }\n \n+    private void sendSetDisplayLayoutWithTemplateConfiguration(TemplateConfiguration configuration, final CompletionListener listener){\n+        setLayout = new SetDisplayLayout().setDisplayLayout(configuration.getTemplate()).setDayColorScheme(configuration.getDayColorScheme()).setNightColorScheme(configuration.getNightColorScheme());\n+        setLayout.setOnRPCResponseListener(new OnRPCResponseListener() {\n+            @Override\n+            public void onResponse(int correlationId, RPCResponse response) {\n+                if(response.getSuccess()){\n+                    updateCurrentScreenDataFromSetDisplayLayout(setLayout);\n+                    listener.onComplete(true);\n+                }\n+                else {\n+                    currentScreenDataUpdateListener.onError();\n+                }", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4MTUwMQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488981501", "bodyText": "Your right that was an error.", "author": "JulianKast", "createdAt": "2020-09-15T21:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkxNTM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkxODE1Ng==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488918156", "bodyText": "Can this var be local instead of global?", "author": "bilal-alsharifi", "createdAt": "2020-09-15T19:30:19Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java", "diffHunk": "@@ -32,13 +34,15 @@\n     private final WeakReference<ISdl> internalInterface;\n     private final WeakReference<FileManager> fileManager;\n     WindowCapability defaultMainWindowCapability;\n-    private Show currentScreenData;\n+    private TextsAndGraphicsState currentScreenData;\n     private final TextsAndGraphicsState updatedState;\n-    private final CompletionListener listener;\n     private final TextAndGraphicManager.CurrentScreenDataUpdatedListener currentScreenDataUpdateListener;\n+    private final CompletionListener listener;\n+    private Show fullShow;\n+    private SetDisplayLayout setLayout;", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyNTE1NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488925154", "bodyText": "I am not sure why numberOfLines should be 4 if shouldUpdateTemplateConfig() is true?", "author": "bilal-alsharifi", "createdAt": "2020-09-15T19:38:12Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java", "diffHunk": "@@ -221,7 +270,7 @@ Show assembleShowText(Show show) {\n             return show;\n         }\n \n-        int numberOfLines = defaultMainWindowCapability != null ? ManagerUtility.WindowCapabilityUtility.getMaxNumberOfMainFieldLines(defaultMainWindowCapability) : 4;\n+        int numberOfLines = defaultMainWindowCapability == null || shouldUpdateTemplateConfig() ? 4 : ManagerUtility.WindowCapabilityUtility.getMaxNumberOfMainFieldLines(defaultMainWindowCapability);", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4Mjk2NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488982964", "bodyText": "We are just sending everything if shouldUpdateTemplateConfig is true because we don't know the capabilities of the new template at this time, when the capabilities change in the TextAndGraphicsManager it will send another update and correct anything that could be wrong", "author": "JulianKast", "createdAt": "2020-09-15T21:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyNTE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyODY5NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488928694", "bodyText": "Why we are getting the values from updatedState instead of Show? as the method name is updateCurrentScreenDataFromShow", "author": "bilal-alsharifi", "createdAt": "2020-09-15T19:42:21Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java", "diffHunk": "@@ -452,42 +501,59 @@ private Show setBlankTextFields(Show newShow) {\n         return newShow;\n     }\n \n+    Show assembleLayout(Show show) {\n+        if (!(internalInterface.get().getSdlMsgVersion().getMajorVersion() >= 6) || !shouldUpdateTemplateConfig()) {\n+            return show;\n+        }\n+        show.setTemplateConfiguration(updatedState.getTemplateConfiguration());\n+        return show;\n+    }\n+\n+    private void updateCurrentScreenDataFromSetDisplayLayout(SetDisplayLayout setDisplayLayout) {\n+        currentScreenData.setTemplateConfiguration(new TemplateConfiguration().setTemplate(setDisplayLayout.getDisplayLayout()).setDayColorScheme(setDisplayLayout.getDayColorScheme()).setNightColorScheme(setDisplayLayout.getNightColorScheme()));\n+        if(currentScreenDataUpdateListener != null){\n+            currentScreenDataUpdateListener.onUpdate(currentScreenData);\n+        }\n+    }\n+\n     private void updateCurrentScreenDataFromShow(Show show) {\n         if (show == null) {\n             DebugTool.logError(TAG, \"can not updateCurrentScreenDataFromShow from null show\");\n             return;\n         }\n-\n-        // If the items are null, they were not updated, so we can't just set it directly\n         if (show.getMainField1() != null) {\n-            currentScreenData.setMainField1(show.getMainField1());\n+            currentScreenData.setTextField1(updatedState.getTextField1());", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAxMDkwOQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r489010909", "bodyText": "we can not set an sdlArtWork object from a show, so if at this point the show has a value, it was updated on the screen, so we check the show, then transfer the value form the updateState to currentScreenData. We did this because in TextAndGraphicsManager if an update fails we want to reset the values to what is displaying on screen, so when a user does sdlManager.getTextField1, it's getting the value that's on screen.", "author": "JulianKast", "createdAt": "2020-09-15T22:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyODY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzMDcyMw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488930723", "bodyText": "I am not sure why we added shouldUpdateTemplateConfig() to shouldUpdatePrimaryImage() & shouldUpdateSecondaryImage() & shouldUpdateMediaTrackField() & shouldUpdateTitleField()", "author": "bilal-alsharifi", "createdAt": "2020-09-15T19:45:39Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/TextAndGraphicUpdateOperation.java", "diffHunk": "@@ -555,8 +621,8 @@ private boolean sdlArtworkNeedsUpload(SdlArtwork artwork) {\n      * @return true if primaryGraphic should be updated, false if not\n      */\n     private boolean shouldUpdatePrimaryImage() {\n-        boolean templateSupportsPrimaryArtwork = templateSupportsImageField(ImageFieldName.graphic);\n-        String currentScreenDataPrimaryGraphicName = (currentScreenData != null && currentScreenData.getGraphic() != null) ? currentScreenData.getGraphic().getValue() : null;\n+        boolean templateSupportsPrimaryArtwork = templateSupportsImageField(ImageFieldName.graphic) || shouldUpdateTemplateConfig();", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAxMTg1Ng==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r489011856", "bodyText": "We are just sending everything if shouldUpdateTemplateConfig is true because we don't know the capabilities of the new template at this time, when the capabilities change in the TextAndGraphicsManager it will send another update and correct anything that could be wrong", "author": "JulianKast", "createdAt": "2020-09-15T22:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzMDcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzODg5Mg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488938892", "bodyText": "While testing, I noticed that the listener doesn't get called if the developer is using the batching mode", "author": "bilal-alsharifi", "createdAt": "2020-09-15T20:00:18Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/BaseScreenManager.java", "diffHunk": "@@ -377,6 +378,21 @@ public String getTitle(){\n \t\treturn this.textAndGraphicManager.getTitle();\n \t}\n \n+\t/**\n+\t * Change the current layout to a new layout and optionally update the layout's night and day color schemes. The values set for the text, graphics,\n+\t * buttons and template title persist between layout changes. To update the text, graphics, buttons and template title at the same time as the template,\n+\t * batch all the updates between `beginUpdates` and `endUpdates`. If the layout update fails while batching, then the updated text, graphics, buttons or template title will also not be updated.\n+\t *\n+\t * If you are connected on a < v6.0 connection and batching the update, the layout will be updated, then the text and graphics will be updated.\n+\t * If you are connected on a >= v6.0 connection, the layout will be updated at the same time that the text and graphics are updated.\n+\t *\n+\t * @param templateConfiguration The new configuration of the template, including the layout and color scheme.\n+\t * @param listener A listener that will be called when the layout change finished.\n+\t */\n+\tpublic void changeLayout(TemplateConfiguration templateConfiguration, CompletionListener listener) {\n+\t\ttextAndGraphicManager.changeLayout(templateConfiguration, listener);", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAxNjUyOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r489016528", "bodyText": "we did this because if it's batched and that batched update gets overridden, it will return false for the changeLayout. This is keeping in line with how the TextAndGraphicsManager works with overriding updates.", "author": "JulianKast", "createdAt": "2020-09-15T22:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzODg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk0MjQzNg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1492#discussion_r488942436", "bodyText": "In my testing on Core 6+, I noticed that, if I change only colors and keep the template the same, the update fails with success = false.", "author": "bilal-alsharifi", "createdAt": "2020-09-15T20:07:17Z", "path": "base/src/main/java/com/smartdevicelink/managers/screen/BaseTextAndGraphicManager.java", "diffHunk": "@@ -444,12 +472,30 @@ SdlArtwork getPrimaryGraphic() {\n \tvoid setSecondaryGraphic(SdlArtwork secondaryGraphic) {\n \t\tthis.secondaryGraphic = secondaryGraphic;\n \t\tif (!batchingUpdates) {\n-\t\t\tsdlUpdate(null);\n+\t\t\tsdlUpdate(true, null);\n \t\t} else {\n \t\t\tisDirty = true;\n \t\t}\n \t}\n \n+\tvoid changeLayout(TemplateConfiguration templateConfiguration, CompletionListener listener) {", "originalCommit": "9037faac9656f0b21685de1c1b4329b0d3b898e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da67f59377fa7dede3420342ae90d565b493089a", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/da67f59377fa7dede3420342ae90d565b493089a", "message": "Add @nonNull to templateConfiguration", "committedDate": "2020-09-15T20:58:49Z", "type": "commit"}, {"oid": "b48f2de52bfa262f786e36304fac84aad5f224f7", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/b48f2de52bfa262f786e36304fac84aad5f224f7", "message": "Removing sending newScreenData to updatePendingOperationsWithNewScreenData as it is equal to currentScreenData at this point", "committedDate": "2020-09-15T21:09:13Z", "type": "commit"}, {"oid": "55738108450addbe634ec47acefec8b41e49283c", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/55738108450addbe634ec47acefec8b41e49283c", "message": "Make setLayout var local", "committedDate": "2020-09-15T21:17:32Z", "type": "commit"}, {"oid": "82db987825e48bc80e23c29f5ae7af81655a4401", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/82db987825e48bc80e23c29f5ae7af81655a4401", "message": "Fixing error where setDisplayLayout dosn't call listener if it fails", "committedDate": "2020-09-15T21:24:59Z", "type": "commit"}, {"oid": "f60cd9ce428dd575572e9420ef134bb5bfd7565d", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f60cd9ce428dd575572e9420ef134bb5bfd7565d", "message": "Added showRPCSupportsTemplateConfiguration() Method to T&G update operation", "committedDate": "2020-09-15T21:53:54Z", "type": "commit"}, {"oid": "c06a817aec65d6bf93562c6077d8b642a8d07e81", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/c06a817aec65d6bf93562c6077d8b642a8d07e81", "message": "Added check to make sure we don't get an npe if internalInterface is null", "committedDate": "2020-09-15T21:54:44Z", "type": "commit"}, {"oid": "7c67d0b21c52768cfea2b3ad4dc6eb431654db48", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/7c67d0b21c52768cfea2b3ad4dc6eb431654db48", "message": "added check to make sure we don't send an unnecessary templateConfig with show", "committedDate": "2020-09-15T21:56:31Z", "type": "commit"}, {"oid": "4c6e96d6599008b91b2d7f0dbdc33ff71691dcff", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/4c6e96d6599008b91b2d7f0dbdc33ff71691dcff", "message": "Merge branch 'develop' into feature/issue-1327-screen-manager-template-management", "committedDate": "2020-09-15T22:12:50Z", "type": "commit"}, {"oid": "e1e036a568e8ccec4e5c8d0c06b6127abdbbf7e1", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/e1e036a568e8ccec4e5c8d0c06b6127abdbbf7e1", "message": "Fixed issue with setDisplayLayout request updating capabilities  when request fails", "committedDate": "2020-09-16T16:19:46Z", "type": "commit"}, {"oid": "4d147a5c7f7ee4bb3f7589fad5f68fca0a0215a6", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/4d147a5c7f7ee4bb3f7589fad5f68fca0a0215a6", "message": "Documentation updates to screenManager", "committedDate": "2020-09-16T16:38:11Z", "type": "commit"}, {"oid": "89e9963a6c4407b73de3ee77e1ac9e83d1ffc383", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/89e9963a6c4407b73de3ee77e1ac9e83d1ffc383", "message": "Formatting fix", "committedDate": "2020-09-16T16:38:54Z", "type": "commit"}, {"oid": "0f62af9e31319b526834e787feef6af7d02cd28c", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/0f62af9e31319b526834e787feef6af7d02cd28c", "message": "Fix javaDocs and comments", "committedDate": "2020-09-16T17:06:15Z", "type": "commit"}, {"oid": "176b686095206f50a5d8afd7802bb27f92e55852", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/176b686095206f50a5d8afd7802bb27f92e55852", "message": "Fixed issue with updateCurrentScreenDataFromShow", "committedDate": "2020-09-16T17:33:41Z", "type": "commit"}, {"oid": "76be9d244c22d32458ea474d2c7b9396713e31c5", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/76be9d244c22d32458ea474d2c7b9396713e31c5", "message": "Change TextsAndGraphicsState to TextAndGraphicState to align with IOS", "committedDate": "2020-09-17T14:35:12Z", "type": "commit"}]}