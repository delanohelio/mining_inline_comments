{"pr_number": 1576, "pr_title": "Implement SDL 0323: Align video streaming parameters with VideoStreamingCapability", "pr_createdAt": "2020-12-07T09:18:33Z", "pr_url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576", "timeline": [{"oid": "7fb3515c82237d093f7779b67d01a08ffd2d7f72", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/7fb3515c82237d093f7779b67d01a08ffd2d7f72", "message": "Add missing stableFrameRate for default ctor.\nAlso removed some debug noise.", "committedDate": "2021-01-07T09:55:19Z", "type": "commit"}, {"oid": "1e2b92302aaeca638c61ed66ce1b6c36639086d5", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/1e2b92302aaeca638c61ed66ce1b6c36639086d5", "message": "Fix a potential case where VideoFormat is unexpectedly overridden by VideoStreamingParameter#update.", "committedDate": "2021-01-07T13:19:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU0NTc5NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576#discussion_r553545795", "bodyText": "Hello @shiniwat, This would be a breaking change, please deprecate the old constructor and assign this.stableFrameRate = true and then create the new constructor with stableFrameRate as a parameter", "author": "RHenigan", "createdAt": "2021-01-07T19:41:42Z", "path": "base/src/main/java/com/smartdevicelink/streaming/video/VideoStreamingParameters.java", "diffHunk": "@@ -78,16 +79,28 @@ public VideoStreamingParameters() {\n         format = new VideoStreamingFormat();\n         format.setProtocol(DEFAULT_PROTOCOL);\n         format.setCodec(DEFAULT_CODEC);\n+        stableFrameRate = true;\n     }\n \n+    /**\n+     * new constructor of VideoStreamingParameters, which now has stableFrameRate param.\n+     * @param displayDensity\n+     * @param frameRate\n+     * @param bitrate\n+     * @param interval\n+     * @param resolution\n+     * @param format\n+     * @param stableFrameRate\n+     */\n     public VideoStreamingParameters(int displayDensity, int frameRate, int bitrate, int interval,\n-                                    ImageResolution resolution, VideoStreamingFormat format) {\n-        this.displayDensity = displayDensity;\n-        this.frameRate = frameRate;\n-        this.bitrate = bitrate;\n-        this.interval = interval;\n-        this.resolution = resolution;\n-        this.format = format;\n+                                    ImageResolution resolution, VideoStreamingFormat format, boolean stableFrameRate){\n+\t    this.displayDensity = displayDensity;\n+\t    this.frameRate = frameRate;\n+\t    this.bitrate = bitrate;\n+\t    this.interval = interval;\n+\t    this.resolution = resolution;\n+\t    this.format = format;\n+\t    this.stableFrameRate = stableFrameRate;", "originalCommit": "1e2b92302aaeca638c61ed66ce1b6c36639086d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzcwMzA1OA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576#discussion_r553703058", "bodyText": "Thanks for the review. The ctor has been updated as you suggested.", "author": "shiniwat", "createdAt": "2021-01-08T02:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU0NTc5NQ=="}], "type": "inlineReview"}, {"oid": "4b1ff6d4776534b470612ed7a69960e25afec838", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/4b1ff6d4776534b470612ed7a69960e25afec838", "message": "Remove unused VideoStreamingParameter ctor, and mark existing one deprecated as per code review at https://github.com/smartdevicelink/sdl_java_suite/pull/1576.", "committedDate": "2021-01-08T02:15:42Z", "type": "commit"}, {"oid": "19e10a2e4d06710670bc2590f3b8874656a4dce8", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/19e10a2e4d06710670bc2590f3b8874656a4dce8", "message": "Update rpc_spec submodule for SDL 0274 reviewed at https://github.com/smartdevicelink/rpc_spec/pull/229.", "committedDate": "2021-01-15T08:49:58Z", "type": "commit"}, {"oid": "d37b8e546d50f9a07248b7f041f9bc8d9411a8c0", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/d37b8e546d50f9a07248b7f041f9bc8d9411a8c0", "message": "Merge remote-tracking branch 'upstream/integration/stable_frame_rate' into feature/issue-1569", "committedDate": "2021-01-22T09:58:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc4NDQyNQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576#discussion_r562784425", "bodyText": "Hello @shiniwat, even though this method is currently unused I believe it should be kept because it will replace the deprecated method above it when that method is eventually removed.", "author": "RHenigan", "createdAt": "2021-01-22T17:21:55Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/encoder/VirtualDisplayEncoder.java", "diffHunk": "@@ -130,11 +130,6 @@ public void setStreamingParams(int displayDensity, ImageResolution resolution, i\n         this.streamingParams = new VideoStreamingParameters(displayDensity, frameRate, bitrate, interval, resolution, format);\n     }\n \n-    @SuppressWarnings(\"unused\")\n-    public void setStreamingParams(int displayDensity, ImageResolution resolution, int frameRate, int bitrate, int interval, VideoStreamingFormat format, boolean stableFrameRate) {\n-        this.streamingParams = new VideoStreamingParameters(displayDensity, frameRate, bitrate, interval, resolution, format, stableFrameRate);\n-    }\n-", "originalCommit": "d37b8e546d50f9a07248b7f041f9bc8d9411a8c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQwNzI5NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576#discussion_r563407295", "bodyText": "Understood. I have restored setStreamingPrams back accordingly.", "author": "shiniwat", "createdAt": "2021-01-25T00:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc4NDQyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc4NzI2Ng==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576#discussion_r562787266", "bodyText": "Hello @shiniwat, I thank you for deprecating the old constructor but I eblieve we still need to include the new constructor so we should have both of the constructors listed here (The deprecated constructor will assign true for stableFrameRate)\n@Deprecated\npublic VideoStreamingParameters(int displayDensity, int frameRate, int bitrate, int interval,\n                                    ImageResolution resolution, VideoStreamingFormat format) {}\n\npublic VideoStreamingParameters(int displayDensity, int frameRate, int bitrate, int interval,\n                                    ImageResolution resolution, VideoStreamingFormat format, boolean stableFrameRate) {}", "author": "RHenigan", "createdAt": "2021-01-22T17:26:28Z", "path": "base/src/main/java/com/smartdevicelink/streaming/video/VideoStreamingParameters.java", "diffHunk": "@@ -103,15 +92,16 @@ public VideoStreamingParameters(int displayDensity, int frameRate, int bitrate,\n      * @param format\n      * @param stableFrameRate\n      */\n+    @Deprecated\n     public VideoStreamingParameters(int displayDensity, int frameRate, int bitrate, int interval,\n-                                    ImageResolution resolution, VideoStreamingFormat format, boolean stableFrameRate){\n+                                    ImageResolution resolution, VideoStreamingFormat format){\n \t    this.displayDensity = displayDensity;\n \t    this.frameRate = frameRate;\n \t    this.bitrate = bitrate;\n \t    this.interval = interval;\n \t    this.resolution = resolution;\n \t    this.format = format;\n-\t    this.stableFrameRate = stableFrameRate;\n+\t    this.stableFrameRate = true;", "originalCommit": "d37b8e546d50f9a07248b7f041f9bc8d9411a8c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQwNzQ4Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576#discussion_r563407483", "bodyText": "Understood. I have restored the constructor, and updated the method comments accordingly.", "author": "shiniwat", "createdAt": "2021-01-25T00:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc4NzI2Ng=="}], "type": "inlineReview"}, {"oid": "c82f344526bfb12ed74741516be972cf8fcd7173", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/c82f344526bfb12ed74741516be972cf8fcd7173", "message": "Update PR as per review comment at https://github.com/smartdevicelink/sdl_java_suite/pull/1576#pullrequestreview-574462581.", "committedDate": "2021-01-25T00:08:28Z", "type": "commit"}, {"oid": "65b3011735c1d78bb4af355ec06fc0afb61bc41f", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/65b3011735c1d78bb4af355ec06fc0afb61bc41f", "message": "Revert \"Update rpc_spec submodule for SDL 0274 reviewed at https://github.com/smartdevicelink/rpc_spec/pull/229.\"\n\nThis reverts commit 19e10a2e4d06710670bc2590f3b8874656a4dce8.", "committedDate": "2021-01-25T22:45:20Z", "type": "commit"}, {"oid": "1d1eb83ff3bbeb6bc30c5277c4859edd31b08656", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/1d1eb83ff3bbeb6bc30c5277c4859edd31b08656", "message": "Update VideoStreamingParameters#update, as per review at https://github.com/smartdevicelink/sdl_java_suite/pull/1576.", "committedDate": "2021-01-27T01:45:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTU0NzIwOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576#discussion_r565547208", "bodyText": "Hello @shiniwat, while testing I noticed an issue with taking the min bitrate. The sdl_hmi systemCapabilities that I was using had the max int value (2147483647), once we multiple by 1000 the int overflows and turns negative resulting in -1000 being the min value.\nSince the max value for the bitRate per the rpc_spec is 2147483647 I think we should cap the maxBitRate we receive from capabilities to ensure it does not overflow and then we can still use the min value between the parameters and the capabilities\nint maxBitrate = Math.min(Integer.MAX_VALUE/1000, capability.getMaxBitrate());\nthis.bitrate = Math.min(this.bitrate, maxBitrate * 1000);", "author": "RHenigan", "createdAt": "2021-01-27T18:42:51Z", "path": "base/src/main/java/com/smartdevicelink/streaming/video/VideoStreamingParameters.java", "diffHunk": "@@ -168,9 +178,12 @@ public void update(VideoStreamingParameters params) {\n      */\n     public void update(VideoStreamingCapability capability, String vehicleMake) {\n         if (capability.getMaxBitrate() != null) {\n-            this.bitrate = capability.getMaxBitrate() * 1000;\n+            // Taking lower value as per SDL 0323 :\n+            // https://github.com/smartdevicelink/sdl_evolution/blob/master/proposals/0323-align-VideoStreamingParameter-with-capability.md\n+            this.bitrate = Math.min(this.bitrate, capability.getMaxBitrate() * 1000);", "originalCommit": "1d1eb83ff3bbeb6bc30c5277c4859edd31b08656", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjA2Njc2MA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1576#discussion_r566066760", "bodyText": "@RHenigan, this is good catch! I have updated as you suggested. Thanks.", "author": "shiniwat", "createdAt": "2021-01-28T12:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTU0NzIwOA=="}], "type": "inlineReview"}, {"oid": "9c6136a7c52ab66a5dfde0e536a4a292fa8312da", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/9c6136a7c52ab66a5dfde0e536a4a292fa8312da", "message": "Fix the potential integer overflow case when taking lower value of bitrate.", "committedDate": "2021-01-28T12:26:14Z", "type": "commit"}, {"oid": "4fa997a00c141dad4d1975910f8d7f93cac9dfc7", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/4fa997a00c141dad4d1975910f8d7f93cac9dfc7", "message": "Refix the possible overflow case in capability's max bitrate.", "committedDate": "2021-01-28T12:36:53Z", "type": "commit"}]}