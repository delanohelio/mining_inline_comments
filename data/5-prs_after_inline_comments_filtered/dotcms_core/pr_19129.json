{"pr_number": 19129, "pr_title": "#18968 test wasn't registered also fix use setProp instead of addProp\u2026", "pr_createdAt": "2020-08-19T17:25:05Z", "pr_url": "https://github.com/dotCMS/core/pull/19129", "timeline": [{"oid": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007", "url": "https://github.com/dotCMS/core/commit/1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007", "message": "#18968 test wasn't registered also fix use setProp instead of addPropto avoid env props stored as arrays", "committedDate": "2020-08-19T17:22:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNjA4NA==", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r473216084", "bodyText": "why the synchronized ?", "author": "nollymar", "createdAt": "2020-08-19T17:50:02Z", "path": "dotCMS/src/main/java/com/dotmarketing/util/Config.java", "diffHunk": "@@ -300,17 +300,13 @@ private static void _refreshProperties () {\n \n \n \tprivate final static String ENV_PREFIX=\"DOT_\";\n-\t\n-    private static void readEnvironmentVariables() {\n-        \n-        \n-        System.getenv().entrySet().stream().filter(e->e.getKey().startsWith(ENV_PREFIX)).forEach(e->\n-            props.addProperty(e.getKey(), e.getValue())\n-        );\n-        \n \n-\n-    }\n+\tprivate static void readEnvironmentVariables() {\n+\t\tsynchronized (Config.class) {", "originalCommit": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MDc0NQ==", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r473240745", "bodyText": "The other read methods above this one are synchronized (The ones that read from the properties files). I was able to corroborate that the properties are loaded repeated times during the start-up.  from static context and from the MainServlet initialize. I think there's no harm in making that piece synchronized especially when this can be called from different contexts.", "author": "fabrizzio-dotCMS", "createdAt": "2020-08-19T18:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNjA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0MzIwMg==", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r474743202", "bodyText": "Doc Test. E.g:\n    /**\n     * Method to rest: {@link GraphqlAPI#getSchema()}\n     * Given scenario: A bad relationship field which returns null when trying to get the\n     * {@link com.dotmarketing.portlets.structure.model.Relationship} out of it.\n     * Expected result: The schema should be able to generate but without that field present\n     */", "author": "erickgonzalez", "createdAt": "2020-08-21T14:43:31Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/util/ConfigTest.java", "diffHunk": "@@ -48,54 +54,92 @@ private static void setTestEnvVariables() {\n         System.getenv().put(DOT_TESTING_STRING_WITH_SPACES, \"VALUE1 VALUE2\");\n         System.getenv().put(DOT_TESTING_STRING, \"VALUE_ABC\");\n         System.getenv().put(UNABLE_TO_READ_VAR, \"NOPE\");\n+        //This forces a re-load.\n+        Config.props = null;\n+        Config.initializeConfig();\n     }\n-    \n-    \n-    \n+\n+\n+\n     @Test\n     public void testing_string_with_comma() {\n \n         String value = Config.getStringProperty(\"TESTING_STRING_WITH_COMMA\");\n         assert(value.equals(Config.getStringProperty(\"testing.String.with_comma\")));\n \n-        \n+\n     }\n-    \n-    \n-    \n+\n+    /**\n+     * Small test to demo that the internal method addProperty generates an array list\n+     * There's a huge difference between addProperty and setProperty\n+     */\n+    @Test\n+    public void Test_Multiple_Calls_To_AddProperty_On_The_Same_Key() {\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        assertEquals (\"anyValue\",Config.props.getProperty(\"anyKey\"));\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        final List<String> values1 = Arrays.asList(\"anyValue\", \"anyValue\");\n+\n+        final Object property1 = Config.props.getProperty(\"anyKey\");\n+        final boolean equals1 = values1.equals(property1);\n+        assertTrue(equals1);\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        final List<String> values2 = Arrays.asList(\"anyValue\", \"anyValue\", \"anyValue\");\n+        final Object property2 = Config.props.getProperty(\"anyKey\");\n+        final boolean equals2 = values2.equals(property2);\n+        assertTrue(equals2);\n+    }\n+\n+    @Test", "originalCommit": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2NDcyNw==", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r475864727", "bodyText": "done", "author": "fabrizzio-dotCMS", "createdAt": "2020-08-24T20:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0MzIwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0MzI2MA==", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r474743260", "bodyText": "Doc Test. E.g:\n    /**\n     * Method to rest: {@link GraphqlAPI#getSchema()}\n     * Given scenario: A bad relationship field which returns null when trying to get the\n     * {@link com.dotmarketing.portlets.structure.model.Relationship} out of it.\n     * Expected result: The schema should be able to generate but without that field present\n     */", "author": "erickgonzalez", "createdAt": "2020-08-21T14:43:38Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/util/ConfigTest.java", "diffHunk": "@@ -48,54 +54,92 @@ private static void setTestEnvVariables() {\n         System.getenv().put(DOT_TESTING_STRING_WITH_SPACES, \"VALUE1 VALUE2\");\n         System.getenv().put(DOT_TESTING_STRING, \"VALUE_ABC\");\n         System.getenv().put(UNABLE_TO_READ_VAR, \"NOPE\");\n+        //This forces a re-load.\n+        Config.props = null;\n+        Config.initializeConfig();\n     }\n-    \n-    \n-    \n+\n+\n+\n     @Test\n     public void testing_string_with_comma() {\n \n         String value = Config.getStringProperty(\"TESTING_STRING_WITH_COMMA\");\n         assert(value.equals(Config.getStringProperty(\"testing.String.with_comma\")));\n \n-        \n+\n     }\n-    \n-    \n-    \n+\n+    /**\n+     * Small test to demo that the internal method addProperty generates an array list\n+     * There's a huge difference between addProperty and setProperty\n+     */\n+    @Test", "originalCommit": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2NDY3MA==", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r475864670", "bodyText": "done", "author": "fabrizzio-dotCMS", "createdAt": "2020-08-24T20:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0MzI2MA=="}], "type": "inlineReview"}, {"oid": "42ee3a867182671e62437de05b95cc26972d9276", "url": "https://github.com/dotCMS/core/commit/42ee3a867182671e62437de05b95cc26972d9276", "message": "#18968 docing up tests", "committedDate": "2020-08-24T20:07:11Z", "type": "commit"}]}