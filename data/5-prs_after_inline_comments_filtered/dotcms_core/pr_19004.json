{"pr_number": 19004, "pr_title": "Issue 18236 secret export", "pr_createdAt": "2020-07-29T22:18:30Z", "pr_url": "https://github.com/dotCMS/core/pull/19004", "timeline": [{"oid": "608d1196164a27f631d3711b9d6a826cd44d79f0", "url": "https://github.com/dotCMS/core/commit/608d1196164a27f631d3711b9d6a826cd44d79f0", "message": "#18236 save point", "committedDate": "2020-07-29T21:38:46Z", "type": "commit"}, {"oid": "742fc97aeff49cd4c8a3a7d0da5ed928cb35effb", "url": "https://github.com/dotCMS/core/commit/742fc97aeff49cd4c8a3a7d0da5ed928cb35effb", "message": "Merge branch 'master' into issue-18236-secret-export", "committedDate": "2020-07-29T22:01:12Z", "type": "commit"}, {"oid": "a55086a313641d2a8091dd3fc6c80b73a18161b3", "url": "https://github.com/dotCMS/core/commit/a55086a313641d2a8091dd3fc6c80b73a18161b3", "message": "#18236  export test cases", "committedDate": "2020-07-31T19:02:00Z", "type": "commit"}, {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1", "url": "https://github.com/dotCMS/core/commit/cacef0f9a52bc860b17027634f09580dfa8531f1", "message": "#18236  feedback", "committedDate": "2020-07-31T20:23:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwMzA4NQ==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466603085", "bodyText": "Add some log here", "author": "jdotcms", "createdAt": "2020-08-06T18:23:14Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsHelper.java", "diffHunk": "@@ -700,4 +707,72 @@ private boolean isAllFilledWithAsters(final char [] chars){\n          return true;\n     }\n \n+    /**\n+     * Secrets export\n+     * @param form\n+     * @param user\n+     * @return\n+     * @throws DotSecurityException\n+     * @throws IOException\n+     * @throws DotDataException\n+     */\n+    InputStream exportSecrets(final ExportSecretForm form, final User user)\n+            throws DotSecurityException, IOException, DotDataException {\n+\n+        if(isNotSet(form.getPassword())){", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwMzcxNw==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466603717", "bodyText": "I am wondering if it is save to delete a file that is gonna be read", "author": "jdotcms", "createdAt": "2020-08-06T18:24:22Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsHelper.java", "diffHunk": "@@ -700,4 +707,72 @@ private boolean isAllFilledWithAsters(final char [] chars){\n          return true;\n     }\n \n+    /**\n+     * Secrets export\n+     * @param form\n+     * @param user\n+     * @return\n+     * @throws DotSecurityException\n+     * @throws IOException\n+     * @throws DotDataException\n+     */\n+    InputStream exportSecrets(final ExportSecretForm form, final User user)\n+            throws DotSecurityException, IOException, DotDataException {\n+\n+        if(isNotSet(form.getPassword())){\n+           throw new DotDataException(\"Unable to locate password param.\");\n+        }\n+        final String password = form.getPassword();\n+        final Key key = AppsUtil.generateKey(password);\n+        final File file = appsAPI\n+                .exportSecrets(key, form.isExportAll(), form.getAppKeysBySite(), user);\n+        try {\n+            return  Files.newInputStream(file.toPath());\n+        } finally {\n+            file.delete();", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDY3MDI5OA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r480670298", "bodyText": "I'm changing it to a more reliable and safe approach.", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T03:06:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwMzcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNDA3Mw==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466604073", "bodyText": "set to final", "author": "jdotcms", "createdAt": "2020-08-06T18:24:59Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsHelper.java", "diffHunk": "@@ -700,4 +707,72 @@ private boolean isAllFilledWithAsters(final char [] chars){\n          return true;\n     }\n \n+    /**\n+     * Secrets export\n+     * @param form\n+     * @param user\n+     * @return\n+     * @throws DotSecurityException\n+     * @throws IOException\n+     * @throws DotDataException\n+     */\n+    InputStream exportSecrets(final ExportSecretForm form, final User user)\n+            throws DotSecurityException, IOException, DotDataException {\n+\n+        if(isNotSet(form.getPassword())){\n+           throw new DotDataException(\"Unable to locate password param.\");\n+        }\n+        final String password = form.getPassword();\n+        final Key key = AppsUtil.generateKey(password);\n+        final File file = appsAPI\n+                .exportSecrets(key, form.isExportAll(), form.getAppKeysBySite(), user);\n+        try {\n+            return  Files.newInputStream(file.toPath());\n+        } finally {\n+            file.delete();\n+        }\n+    }\n+\n+    /**\n+     * Secrets import\n+     * @param multipart\n+     * @param user\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws JSONException\n+     * @throws DotSecurityException\n+     * @throws EncryptorException\n+     * @throws ClassNotFoundException\n+     */\n+    void importSecrets(final FormDataMultiPart multipart, final User user)\n+            throws IOException, DotDataException, JSONException, DotSecurityException, EncryptorException, ClassNotFoundException {\n+        final MultiPartUtils multiPartUtils = new MultiPartUtils();\n+        final List<File> files = multiPartUtils.getBinariesFromMultipart(multipart);\n+        if(!UtilMethods.isSet(files)){\n+            throw new DotDataException(\"Unable to extract any files from multi-part request.\");\n+        }\n+\n+        final Map<String, Object> bodyMapFromMultipart = multiPartUtils\n+                .getBodyMapFromMultipart(multipart);\n+        final Object object = bodyMapFromMultipart.get(\"password\");\n+\n+        if(null == object){\n+            throw new DotDataException(\"Unable to locate password param.\");\n+        }\n+        final String password = object.toString();\n+        final Key key = AppsUtil.generateKey(password);\n+        final Map<String, List<AppSecrets>> importedSecretsBySiteId = appsAPI\n+                .importSecrets(files.get(0).toPath(), key, user);\n+        for (Entry<String, List<AppSecrets>> entry : importedSecretsBySiteId.entrySet()) {", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDY3MDY3Mg==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r480670672", "bodyText": "done", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T03:06:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNDA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTQ3MA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466605470", "bodyText": "I think you do not need to handle the exception, Jersey will do for you", "author": "jdotcms", "createdAt": "2020-08-06T18:27:34Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsResource.java", "diffHunk": "@@ -433,4 +434,79 @@ public final Response deleteApp(\n         }\n     }\n \n+    /**\n+     * Secrets export\n+     * @param request\n+     * @param response\n+     * @param exportSecretForm\n+     * @return\n+     */\n+    @POST\n+    @Path(\"/export\")\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response exportSecrets(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            final ExportSecretForm exportSecretForm\n+    ) {\n+        exportSecretForm.checkValid();\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();\n+            //no need to close i'll get closed upon writing the response\n+            final InputStream stream = helper.exportSecrets(exportSecretForm, user);\n+            return Response.ok(stream, MediaType.APPLICATION_OCTET_STREAM)\n+                    .header(\"content-disposition\", \"attachment; filename=appSecrets.export\")\n+                    .build(); // 200\n+        } catch (Exception e) {", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDgxODAzNA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r480818034", "bodyText": "I handle exceptions my self for the sake of writing test friendly classes.", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T05:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTU0Mw==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466605543", "bodyText": "Add some log here", "author": "jdotcms", "createdAt": "2020-08-06T18:27:42Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsResource.java", "diffHunk": "@@ -433,4 +434,79 @@ public final Response deleteApp(\n         }\n     }\n \n+    /**\n+     * Secrets export\n+     * @param request\n+     * @param response\n+     * @param exportSecretForm\n+     * @return\n+     */\n+    @POST\n+    @Path(\"/export\")\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response exportSecrets(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            final ExportSecretForm exportSecretForm\n+    ) {\n+        exportSecretForm.checkValid();\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTg0MQ==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466605841", "bodyText": "Do we have to do some permission check?", "author": "jdotcms", "createdAt": "2020-08-06T18:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDY4NTE4Nw==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r480685187", "bodyText": "permissions are checked internally. At helper's lever", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T03:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjIyMQ==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466606221", "bodyText": "Add some log\nCheck if permission are needed\nException block is not needed", "author": "jdotcms", "createdAt": "2020-08-06T18:29:00Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsResource.java", "diffHunk": "@@ -433,4 +434,79 @@ public final Response deleteApp(\n         }\n     }\n \n+    /**\n+     * Secrets export\n+     * @param request\n+     * @param response\n+     * @param exportSecretForm\n+     * @return\n+     */\n+    @POST\n+    @Path(\"/export\")\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response exportSecrets(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            final ExportSecretForm exportSecretForm\n+    ) {\n+        exportSecretForm.checkValid();\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();\n+            //no need to close i'll get closed upon writing the response\n+            final InputStream stream = helper.exportSecrets(exportSecretForm, user);\n+            return Response.ok(stream, MediaType.APPLICATION_OCTET_STREAM)\n+                    .header(\"content-disposition\", \"attachment; filename=appSecrets.export\")\n+                    .build(); // 200\n+        } catch (Exception e) {\n+            //By doing this mapping here. The resource becomes integration test friendly.\n+            Logger.error(this.getClass(),\"Exception exporting secrets.\", e);\n+            return ResponseUtil.mapExceptionResponse(e);\n+        }\n+    }\n+\n+    /**\n+     * Secrets import\n+     * @param request\n+     * @param response\n+     * @param form\n+     * @return\n+     */\n+    @POST\n+    @Path(\"/import\")\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @Consumes(MediaType.MULTIPART_FORM_DATA)\n+    public final Response importSecrets(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            final FormDataMultiPart form\n+    ) {\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDgxNTk1OA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r480815958", "bodyText": "I handle exceptions my self for the sake of writing test friendly classes.", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T05:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjc0NQ==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466606745", "bodyText": "Doc", "author": "jdotcms", "createdAt": "2020-08-06T18:29:52Z", "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPI.java", "diffHunk": "@@ -198,6 +201,35 @@ void removeSecretsForSite(Host host, User user)\n     void resetSecrets(User user)\n                     throws DotDataException, IOException;\n \n+    /**\n+     *", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjc5NA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466606794", "bodyText": "Doc", "author": "jdotcms", "createdAt": "2020-08-06T18:30:00Z", "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPI.java", "diffHunk": "@@ -198,6 +201,35 @@ void removeSecretsForSite(Host host, User user)\n     void resetSecrets(User user)\n                     throws DotDataException, IOException;\n \n+    /**\n+     *\n+     * @param key\n+     * @param exportAll\n+     * @param appKeysBySite\n+     * @param user\n+     * @return\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     * @throws IOException\n+     */\n+    File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> appKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException;\n+\n+    /**\n+     *", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNzM3NQ==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466607375", "bodyText": "I think you can use user.isAdmin, it is pretty much the same", "author": "jdotcms", "createdAt": "2020-08-06T18:31:04Z", "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MzIyNA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r481153224", "bodyText": "yeah.", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T13:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNzM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4MTU3Mg==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r481481572", "bodyText": "done", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T23:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNzM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNzc5Mg==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466607792", "bodyText": "final AppsSecretsImportExport exportedSecrets =\nexportAll?collectSecretsForExport(appKeysByHost(), user): collectSecretsForExport(paramAppKeysBySite, user);", "author": "jdotcms", "createdAt": "2020-08-06T18:31:52Z", "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){\n+            throw new DotSecurityException(\"Only Admins are allowed to perform an export operation.\");\n+        }\n+\n+        final AppsSecretsImportExport exportedSecrets;", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4MTQzNA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r481481434", "bodyText": "in my opinion, not everything needs to be converted to ternary operations only because we can. its a matter of style and preference", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T23:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNzc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwODc5Mg==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466608792", "bodyText": "just in case check NPE", "author": "jdotcms", "createdAt": "2020-08-06T18:33:53Z", "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){\n+            throw new DotSecurityException(\"Only Admins are allowed to perform an export operation.\");\n+        }\n+\n+        final AppsSecretsImportExport exportedSecrets;\n+        if (exportAll) {\n+            exportedSecrets = collectSecretsForExport(appKeysByHost(), user);\n+        } else {\n+            exportedSecrets = collectSecretsForExport(paramAppKeysBySite, user);\n+        }\n+\n+        final File tempFile = File.createTempFile(\"secretsExport\", \".tmp\");\n+        try {\n+            writeObject(exportedSecrets, tempFile.toPath());\n+            final byte[] bytes = Files.readAllBytes(tempFile.toPath());\n+            try {\n+                final File file = File.createTempFile(\"secrets\", \".export\");\n+                final byte[] encrypted = AppsUtil.encrypt(key, bytes);\n+                try (OutputStream outputStream = Files.newOutputStream(file.toPath())) {\n+                    outputStream.write(encrypted);\n+                    return file;\n+                }\n+            } catch (EncryptorException e) {\n+                throw new DotDataException(e);\n+            }\n+        } finally {\n+            tempFile.delete();", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4MDk1Nw==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r481480957", "bodyText": "when I did so.. It says the condition is always different from null", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T23:09:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwODc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwOTAwMA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466609000", "bodyText": "Doc", "author": "jdotcms", "createdAt": "2020-08-06T18:34:15Z", "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){\n+            throw new DotSecurityException(\"Only Admins are allowed to perform an export operation.\");\n+        }\n+\n+        final AppsSecretsImportExport exportedSecrets;\n+        if (exportAll) {\n+            exportedSecrets = collectSecretsForExport(appKeysByHost(), user);\n+        } else {\n+            exportedSecrets = collectSecretsForExport(paramAppKeysBySite, user);\n+        }\n+\n+        final File tempFile = File.createTempFile(\"secretsExport\", \".tmp\");\n+        try {\n+            writeObject(exportedSecrets, tempFile.toPath());\n+            final byte[] bytes = Files.readAllBytes(tempFile.toPath());\n+            try {\n+                final File file = File.createTempFile(\"secrets\", \".export\");\n+                final byte[] encrypted = AppsUtil.encrypt(key, bytes);\n+                try (OutputStream outputStream = Files.newOutputStream(file.toPath())) {\n+                    outputStream.write(encrypted);\n+                    return file;\n+                }\n+            } catch (EncryptorException e) {\n+                throw new DotDataException(e);\n+            }\n+        } finally {\n+            tempFile.delete();\n+        }\n+    }\n+\n+    /**\n+     *", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwOTc1Mg==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466609752", "bodyText": "Add doc", "author": "jdotcms", "createdAt": "2020-08-06T18:35:37Z", "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){\n+            throw new DotSecurityException(\"Only Admins are allowed to perform an export operation.\");\n+        }\n+\n+        final AppsSecretsImportExport exportedSecrets;\n+        if (exportAll) {\n+            exportedSecrets = collectSecretsForExport(appKeysByHost(), user);\n+        } else {\n+            exportedSecrets = collectSecretsForExport(paramAppKeysBySite, user);\n+        }\n+\n+        final File tempFile = File.createTempFile(\"secretsExport\", \".tmp\");\n+        try {\n+            writeObject(exportedSecrets, tempFile.toPath());\n+            final byte[] bytes = Files.readAllBytes(tempFile.toPath());\n+            try {\n+                final File file = File.createTempFile(\"secrets\", \".export\");\n+                final byte[] encrypted = AppsUtil.encrypt(key, bytes);\n+                try (OutputStream outputStream = Files.newOutputStream(file.toPath())) {\n+                    outputStream.write(encrypted);\n+                    return file;\n+                }\n+            } catch (EncryptorException e) {\n+                throw new DotDataException(e);\n+            }\n+        } finally {\n+            tempFile.delete();\n+        }\n+    }\n+\n+    /**\n+     *\n+     * @param paramAppKeysBySite\n+     * @param user\n+     * @return\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    private AppsSecretsImportExport collectSecretsForExport(final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException {\n+        final Map<String, List<AppSecrets>> exportedSecrets = new HashMap<>();\n+        final Map<String, Set<String>> keysByHost = appKeysByHost();\n+        keysByHost.forEach((siteId, appKeys) -> {\n+            try {\n+                final Host site = hostAPI.find(siteId, user, false);\n+                if (null != site) {\n+\n+                    final Set<String> appKeysBySiteId = paramAppKeysBySite.get(siteId);\n+                    if (isSet(appKeysBySiteId)) {\n+                        for (final String appKey : appKeysBySiteId) {\n+                            final Optional<AppSecrets> optional = getSecrets(appKey, site, user);\n+                            if (optional.isPresent()) {\n+                                final AppSecrets appSecrets = optional.get();\n+                                exportedSecrets\n+                                        .computeIfAbsent(siteId, list -> new LinkedList<>())\n+                                        .add(appSecrets);\n+                            }\n+                        }\n+                    }\n+                } else {\n+                    Logger.warn(AppsAPIImpl.class,\n+                            String.format(\"Unable to find site `%s` \", siteId));\n+                }\n+            } catch (DotDataException | DotSecurityException e) {\n+                Logger.warn(AppsAPIImpl.class, \"An exception occurred collecting the secrets for export\", e);\n+            }\n+        });\n+        return new AppsSecretsImportExport(\n+                exportedSecrets);\n+    }\n+\n+    /**\n+     *\n+     * @param bean\n+     * @param file\n+     * @throws IOException\n+     */\n+    private void writeObject(final AppsSecretsImportExport bean, final Path file)\n+            throws IOException {\n+        try (OutputStream outputStream = Files.newOutputStream(file)) {\n+            try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream)) {\n+                objectOutputStream.writeObject(bean);\n+            }\n+        }\n+    }\n+\n+    /**\n+     *", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwOTk1MQ==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466609951", "bodyText": "Doc", "author": "jdotcms", "createdAt": "2020-08-06T18:36:01Z", "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsSecretsImportExport.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.dotcms.security.apps;\n+\n+import java.io.Serializable;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AppsSecretsImportExport implements Serializable {", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyNTg4NQ==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r481225885", "bodyText": "done", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T15:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwOTk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU5ODc5Ng==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r476598796", "bodyText": "what is this test for?", "author": "nollymar", "createdAt": "2020-08-25T16:59:13Z", "path": "dotCMS/src/integration-test/java/com/dotcms/security/apps/AppsUtilTest.java", "diffHunk": "@@ -162,4 +162,13 @@ public void Test_Encrypt_Decrypt_Text_No_Middle_String() throws EncryptorExcepti\n         Assert.assertEquals(input, new String(decrypted));\n     }\n \n+     @Test\n+     public void Test_Key_Padding(){", "originalCommit": "cacef0f9a52bc860b17027634f09580dfa8531f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI4NTAwOQ==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r480285009", "bodyText": "We need to generate an encryption Key out of a given password. Keys have fixed values. (12, 24, 32 are valid lengths) A key can't have a random length. Here we simply transform any password adding or removing fill-chars to fit 32 length", "author": "fabrizzio-dotCMS", "createdAt": "2020-08-31T17:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU5ODc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyNzI2Nw==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r481227267", "bodyText": "I also doced the test", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-01T15:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU5ODc5Ng=="}], "type": "inlineReview"}, {"oid": "b5c2e80931c437e858b1eea8f2dd2db9a8700872", "url": "https://github.com/dotCMS/core/commit/b5c2e80931c437e858b1eea8f2dd2db9a8700872", "message": "Merge branch 'master' into issue-18236-secret-export", "committedDate": "2020-08-31T17:32:41Z", "type": "commit"}, {"oid": "30fd3c57ce88d8943629256516174a141b837c27", "url": "https://github.com/dotCMS/core/commit/30fd3c57ce88d8943629256516174a141b837c27", "message": "#18236  feedback", "committedDate": "2020-09-01T23:02:42Z", "type": "commit"}, {"oid": "33d53faecf8c76f2db52b2511a987a9d4074ea93", "url": "https://github.com/dotCMS/core/commit/33d53faecf8c76f2db52b2511a987a9d4074ea93", "message": "#18236  feedback", "committedDate": "2020-09-02T01:54:21Z", "type": "commit"}, {"oid": "45e8194cda1c1f270183678bff40baad3cb16488", "url": "https://github.com/dotCMS/core/commit/45e8194cda1c1f270183678bff40baad3cb16488", "message": "#18236  feedback", "committedDate": "2020-09-02T02:03:42Z", "type": "commit"}, {"oid": "761fef99daa11c9d988ad437c6a8def585179a84", "url": "https://github.com/dotCMS/core/commit/761fef99daa11c9d988ad437c6a8def585179a84", "message": "#18236  feedback", "committedDate": "2020-09-02T03:48:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTYzMDYzMA==", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r481630630", "bodyText": "Codacy found an issue: Ensure that resources like this InputStream object are closed after use", "author": "dev-dotcms", "createdAt": "2020-09-02T03:54:03Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/apps/AppsResourceTest.java", "diffHunk": "@@ -1245,6 +1274,69 @@ public void Test_Pagination_And_Sort_Then_Request_Filter_Expect_Empty_Results()\n \n     }\n \n+    /**\n+     * Given Scenario: We create secrets then export that particular one then the generated file is used as the input for the import method.\n+     * Expected Results: The secrets are imported correctly and replace the same old exiting secrets. No additional secrets are created.\n+     * @throws IOException\n+     */\n+     @Test\n+     public void Test_Export_Import() throws IOException {\n+         final AppDescriptorDataGen dataGen = new AppDescriptorDataGen()\n+                 .stringParam(\"param1\", false,  true)\n+                 .stringParam(\"param2\", false,  true)\n+                 .withName(\"import-export-test\")\n+                 .withDescription(\"import-export-test\")\n+                 //We're indicating that extra params are allowed to test required params are still required.\n+                 .withExtraParameters(true);\n+         final String key = dataGen.getKey();\n+         final HttpServletRequest request = mock(HttpServletRequest.class);\n+         final HttpServletResponse response = mock(HttpServletResponse.class);\n+\n+         when(request.getRequestURI()).thenReturn(\"/baseURL\");\n+         final String fileName = dataGen.getFileName();\n+         final File file = dataGen.nextPersistedDescriptor();\n+         try(InputStream inputStream = Files.newInputStream(file.toPath())){\n+             final FormDataMultiPart formDataMultiPart = createFormDataMultiPart(fileName, inputStream);\n+             final Response appResponseOk = appsResource.createApp(request, response,formDataMultiPart);\n+             Assert.assertNotNull(appResponseOk);\n+             Assert.assertEquals(HttpStatus.SC_OK, appResponseOk.getStatus());\n+\n+             final Response availableAppsResponse = appsResource\n+                     .listAvailableApps(request, response, null);\n+             Assert.assertEquals(HttpStatus.SC_OK, availableAppsResponse.getStatus());\n+             final ResponseEntityView responseEntityView1 = (ResponseEntityView) availableAppsResponse\n+                     .getEntity();\n+             final List<AppView> integrationViewList = (List<AppView>) responseEntityView1\n+                     .getEntity();\n+             assertFalse(integrationViewList.isEmpty());\n+\n+             final Host site = new SiteDataGen().nextPersisted();\n+\n+             final String siteId = site.getIdentifier();\n+             final Map<String, Input> inputParamMap = ImmutableMap.of(\n+              \"param1\", newInputParam(\"value\".toCharArray()),\n+              \"param2\", newInputParam(\"value\".toCharArray())\n+             );\n+             final SecretForm secretForm1 = new SecretForm(inputParamMap);\n+             final Response createSecretResponse1 = appsResource.createAppSecrets(request, response, key, siteId, secretForm1);\n+             Assert.assertEquals(HttpStatus.SC_OK, createSecretResponse1.getStatus());\n+\n+             final String password = \"123456789\";\n+             ExportSecretForm form = new ExportSecretForm(password,false, ImmutableMap.of(siteId, ImmutableSet.of(key)));\n+             final OutboundJaxrsResponse exportResponse = (OutboundJaxrsResponse)appsResource.exportSecrets(request, response, form);\n+             final String json = String.format(\"{ password: \\\"%s\\\" }\",password);\n+             final InputStream entity = (InputStream) exportResponse.getEntity();", "originalCommit": "761fef99daa11c9d988ad437c6a8def585179a84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}