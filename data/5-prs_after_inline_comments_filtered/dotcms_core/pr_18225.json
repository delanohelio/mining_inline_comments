{"pr_number": 18225, "pr_title": "Issue 18153 when elasticsearch is not available page in cache not work", "pr_createdAt": "2020-03-31T17:41:01Z", "pr_url": "https://github.com/dotCMS/core/pull/18225", "timeline": [{"oid": "78d405f4b45ebea3a0b95d230fd7ac04dafa1a90", "url": "https://github.com/dotCMS/core/commit/78d405f4b45ebea3a0b95d230fd7ac04dafa1a90", "message": "#18153 creating new method to find Files byparent folder from data base", "committedDate": "2020-03-24T16:05:32Z", "type": "commit"}, {"oid": "edb0d25075e022d233ec445dfa0035348812a861", "url": "https://github.com/dotCMS/core/commit/edb0d25075e022d233ec445dfa0035348812a861", "message": "#18153 testing", "committedDate": "2020-03-25T17:40:08Z", "type": "commit"}, {"oid": "8a05b786dfda26fb445daed5b29f4a3dda75b6d2", "url": "https://github.com/dotCMS/core/commit/8a05b786dfda26fb445daed5b29f4a3dda75b6d2", "message": "#18153", "committedDate": "2020-03-26T16:55:46Z", "type": "commit"}, {"oid": "22407568f127aed11d02bb67c03db42d839d45e6", "url": "https://github.com/dotCMS/core/commit/22407568f127aed11d02bb67c03db42d839d45e6", "message": "#18153 testing", "committedDate": "2020-03-30T15:19:44Z", "type": "commit"}, {"oid": "b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "url": "https://github.com/dotCMS/core/commit/b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "message": "#18153 Testing and fixing", "committedDate": "2020-03-31T17:33:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwMTE3Mg==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401101172", "bodyText": "I think you should implement a new method signature for this constructor and keep the old one. Internally the old constructor could call this new implementation", "author": "nollymar", "createdAt": "2020-03-31T17:49:08Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImpl.java", "diffHunk": "@@ -69,17 +73,35 @@\n \tfinal ContentletAPI contAPI;\n \tfinal PermissionAPI perAPI;\n \tprivate final IdentifierAPI identifierAPI;\n+\tprivate final FileAssetFactory fileAssetFactory;\n+\tprivate final ContentletCache contentletCache;\n \n \tpublic FileAssetAPIImpl() {\n-\t    this(APILocator.getContentletAPI(),APILocator.getPermissionAPI(),APILocator.getSystemEventsAPI(),APILocator.getIdentifierAPI());\n+\t    this(\n+\t    \t\tAPILocator.getContentletAPI(),\n+\t\t\t\tAPILocator.getPermissionAPI(),\n+\t\t\t\tAPILocator.getSystemEventsAPI(),\n+\t\t\t\tAPILocator.getIdentifierAPI(),\n+\t\t\t\tnew FileAssetFactoryImpl(),\n+\t\t\t\tCacheLocator.getContentletCache()\n+\t\t);\n \t}\n \n-   public FileAssetAPIImpl(ContentletAPI contAPI,PermissionAPI perAPI, SystemEventsAPI systemEventsAPI, IdentifierAPI identifierAPI ) {\n+\t@VisibleForTesting\n+    public FileAssetAPIImpl(", "originalCommit": "b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwMzQxNQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401103415", "bodyText": "I usually agree with backward compatibility, but I think people do not call the constructors, people use APILocator to delegate the construction, so I would say it is ok", "author": "jdotcms", "createdAt": "2020-03-31T17:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwMTE3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwMjEwOA==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401102108", "bodyText": "Cool, I would put this in another more reusable place", "author": "jdotcms", "createdAt": "2020-03-31T17:50:43Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImplIntegrationTest.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.FileUtil;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class FileAssetAPIImplIntegrationTest  extends IntegrationTestBase {\n+\n+    private static FileAssetAPIImpl fileAssetAPIImpl;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment o\n+        IntegrationTestInitService.getInstance().init();\n+\n+        fileAssetAPIImpl = new FileAssetAPIImpl();\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetAPIImpl#findFileAssetsByFolder(Folder, User, boolean)}\n+     * When: Create two Folder with two files each one, grant permission over folders and files\n+     * and try to get the files from the first folder\n+     * Should: return only the two files into the first folder\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void shouldReturnTwoFiles() throws IOException, DotDataException, DotSecurityException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Folder folder1 = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset1 = createFileAsset(folder1, \"text1\", \".txt\");\n+        final Contentlet fileAsset2 = createFileAsset(folder1, \"text2\", \".txt\");\n+\n+        final Folder folder2 = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset3 = createFileAsset(folder2, \"text1\", \".txt\");\n+        final Contentlet fileAsset4 = createFileAsset(folder2, \"text2\", \".txt\");\n+\n+        this.addPermission(role, folder1, folder2, fileAsset1, fileAsset2, fileAsset3, fileAsset4);\n+        final List<FileAsset> files = fileAssetAPIImpl.findFileAssetsByFolder(folder1, user, false);\n+\n+        assertEquals(2, files.size());\n+\n+        final List<String> filesInodes = files.stream().map((file) -> file.getInode()).collect(Collectors.toList());\n+\n+        assertTrue(filesInodes.contains(fileAsset1.getInode()));\n+        assertTrue(filesInodes.contains(fileAsset2.getInode()));\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetAPIImpl#findFileAssetsByFolder(Folder, User, boolean)}\n+     * When: Create one Folder with one files, and try to get the files from the first folder with a user without permission\n+     * Should: return a empty List\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void userWithoutPermission() throws IOException, DotDataException, DotSecurityException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Folder folder1 = new FolderDataGen().site(host).nextPersisted();\n+        createFileAsset(folder1, \"text1\", \".txt\");\n+\n+        final List<FileAsset> fileAssetsByFolder = fileAssetAPIImpl.findFileAssetsByFolder(folder1, user, false);\n+\n+        assertTrue(fileAssetsByFolder.isEmpty());\n+    }\n+\n+    private Contentlet createFileAsset(", "originalCommit": "b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MDcyMQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401240721", "bodyText": "done b3221ca#diff-a44b1746f41918b71f5f2d06d7cbc482R39", "author": "freddyucv", "createdAt": "2020-03-31T21:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwMjEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwNTc3NA==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401105774", "bodyText": "doc", "author": "jdotcms", "createdAt": "2020-03-31T17:56:32Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactory.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.liferay.portal.model.User;\n+\n+import java.util.List;\n+\n+public interface FileAssetFactory {", "originalCommit": "b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MDg3OA==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401240878", "bodyText": "done b3221ca#diff-00aa81b1e15540631fbfdcad81a97fe8R11", "author": "freddyucv", "createdAt": "2020-03-31T21:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwNTc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNDYxNw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401114617", "bodyText": "this should be the first line, well before the dotConnect", "author": "jdotcms", "createdAt": "2020-03-31T18:11:15Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryImpl.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.util.ContentletUtil;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.util.Logger;\n+import com.liferay.portal.model.User;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class FileAssetFactoryImpl implements FileAssetFactory {\n+    private final PermissionAPI permissionAPI;\n+\n+    private final String FIND_FILE_ASSETS_BY_FOLDER_QUERY =\n+            \"SELECT contentlet.inode \" +\n+            \"FROM identifier, contentlet_version_info, contentlet, structure \" +\n+            \"WHERE identifier.parent_path = ? and \" +\n+                \"identifier.host_inode = ? and \" +\n+                \"contentlet_version_info.identifier = identifier.id and \" +\n+                \"contentlet_version_info.%s_inode = contentlet.inode and \" +\n+                \"contentlet.structure_inode = structure.inode and \" +\n+                \"structure.structuretype =4;\";\n+\n+    public FileAssetFactoryImpl() {\n+        permissionAPI = APILocator.getPermissionAPI();\n+    }\n+\n+    @Override\n+    public List<Contentlet> findFileAssetsByFolderInDB(\n+            final Folder parentFolder,\n+            final  User user,\n+            final boolean live) throws DotDataException, DotSecurityException {\n+\n+        final boolean respectFrontendRoles = live;\n+        final DotConnect dotConnect = new DotConnect();\n+        dotConnect.setSQL(String.format(FIND_FILE_ASSETS_BY_FOLDER_QUERY, live ? \"live\" : \"working\"));\n+        dotConnect.addParam(parentFolder.getPath());\n+        dotConnect.addParam(parentFolder.getHostId());\n+\n+        if(!permissionAPI.doesUserHavePermission(parentFolder, PermissionAPI.PERMISSION_READ, user, respectFrontendRoles)){", "originalCommit": "b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MDk4Nw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401240987", "bodyText": "done b3221ca#diff-159930580f03a629fdc4eb9506576d39R50", "author": "freddyucv", "createdAt": "2020-03-31T22:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNDYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNDkwOQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401114909", "bodyText": "Immutable?", "author": "jdotcms", "createdAt": "2020-03-31T18:11:44Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryImpl.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.util.ContentletUtil;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.util.Logger;\n+import com.liferay.portal.model.User;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class FileAssetFactoryImpl implements FileAssetFactory {\n+    private final PermissionAPI permissionAPI;\n+\n+    private final String FIND_FILE_ASSETS_BY_FOLDER_QUERY =\n+            \"SELECT contentlet.inode \" +\n+            \"FROM identifier, contentlet_version_info, contentlet, structure \" +\n+            \"WHERE identifier.parent_path = ? and \" +\n+                \"identifier.host_inode = ? and \" +\n+                \"contentlet_version_info.identifier = identifier.id and \" +\n+                \"contentlet_version_info.%s_inode = contentlet.inode and \" +\n+                \"contentlet.structure_inode = structure.inode and \" +\n+                \"structure.structuretype =4;\";\n+\n+    public FileAssetFactoryImpl() {\n+        permissionAPI = APILocator.getPermissionAPI();\n+    }\n+\n+    @Override\n+    public List<Contentlet> findFileAssetsByFolderInDB(\n+            final Folder parentFolder,\n+            final  User user,\n+            final boolean live) throws DotDataException, DotSecurityException {\n+\n+        final boolean respectFrontendRoles = live;\n+        final DotConnect dotConnect = new DotConnect();\n+        dotConnect.setSQL(String.format(FIND_FILE_ASSETS_BY_FOLDER_QUERY, live ? \"live\" : \"working\"));\n+        dotConnect.addParam(parentFolder.getPath());\n+        dotConnect.addParam(parentFolder.getHostId());\n+\n+        if(!permissionAPI.doesUserHavePermission(parentFolder, PermissionAPI.PERMISSION_READ, user, respectFrontendRoles)){\n+            throw new DotSecurityException(\"User:\" + user.getUserId() + \" does not have permissions on Folder \" + parentFolder);\n+        }\n+\n+        final List<Map<String, Object>> queryResults = dotConnect.loadObjectResults();\n+        return convertToFileAssets(user, respectFrontendRoles, queryResults);\n+    }\n+\n+    @NotNull\n+    private List<Contentlet> convertToFileAssets(\n+            final User user,\n+            final boolean respectFrontendRoles,\n+            final List<Map<String, Object>> queryResults) throws DotDataException {\n+\n+        final List<Contentlet> files = new ArrayList<>();", "originalCommit": "b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MTExMw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401241113", "bodyText": "done b3221ca#diff-159930580f03a629fdc4eb9506576d39R69", "author": "freddyucv", "createdAt": "2020-03-31T22:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNDkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNjM5NQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401116395", "bodyText": "this could be better to handle by ExceptionUtil.causedBy\nThe immediate cause could be a wrapper of the real one, should go in deep", "author": "jdotcms", "createdAt": "2020-03-31T18:14:16Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImpl.java", "diffHunk": "@@ -104,17 +126,30 @@ public FileAsset checkinFile(Contentlet fileCon, User user,boolean respectFronte\n \t}\n \t */\n \t@CloseDBIfOpened\n-\tpublic List<FileAsset> findFileAssetsByFolder(Folder parentFolder, User user, boolean respectFrontendRoles) throws DotDataException,\n-\t\t\tDotSecurityException {\n-\t\tList<FileAsset> assets = null;\n+\tpublic List<FileAsset> findFileAssetsByFolder(\n+\t\t\tfinal Folder parentFolder,\n+\t\t\tfinal User user,\n+\t\t\tfinal boolean respectFrontendRoles) throws DotDataException, DotSecurityException {\n+\t\tList<Contentlet> contentlets = null;\n+\n \t\ttry{\n-\t\t\tassets = fromContentlets(perAPI.filterCollection(contAPI.search(\"+structureType:\" + Structure.STRUCTURE_TYPE_FILEASSET+\" +conFolder:\" + parentFolder.getInode(), -1, 0, null , user, respectFrontendRoles),\n-\t\t\t\t\tPermissionAPI.PERMISSION_READ, respectFrontendRoles, user));\n+\t\t\tcontentlets = contAPI.search(\n+\t\t\t\t\t\"+structureType:\" + Structure.STRUCTURE_TYPE_FILEASSET + \" +conFolder:\" + parentFolder.getInode(),\n+\t\t\t\t\t-1, 0, null, user, respectFrontendRoles);\n+\t\t} catch (DotRuntimeException e) {\n+\t\t\tif (e.getCause() instanceof ConnectException) {", "originalCommit": "b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNjkzMQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401116931", "bodyText": "Should log too", "author": "jdotcms", "createdAt": "2020-03-31T18:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNjM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIwODgwMQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401208801", "bodyText": "If you log, then we should use the Logger.warnEveryAndDebug(final Class cl, final String message, final Throwable ex, final int warnEveryMillis) \nand write every 5000ms", "author": "wezell", "createdAt": "2020-03-31T20:54:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNjM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MTIzMw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401241233", "bodyText": "done b3221ca#diff-3e213b868e011e1477445a17721c1926R141", "author": "freddyucv", "createdAt": "2020-03-31T22:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExNjM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxMTc2OA==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401211768", "bodyText": "add a sync block here", "author": "wezell", "createdAt": "2020-03-31T20:59:25Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImpl.java", "diffHunk": "@@ -104,17 +126,30 @@ public FileAsset checkinFile(Contentlet fileCon, User user,boolean respectFronte\n \t}\n \t */\n \t@CloseDBIfOpened\n-\tpublic List<FileAsset> findFileAssetsByFolder(Folder parentFolder, User user, boolean respectFrontendRoles) throws DotDataException,\n-\t\t\tDotSecurityException {\n-\t\tList<FileAsset> assets = null;\n+\tpublic List<FileAsset> findFileAssetsByFolder(\n+\t\t\tfinal Folder parentFolder,\n+\t\t\tfinal User user,\n+\t\t\tfinal boolean respectFrontendRoles) throws DotDataException, DotSecurityException {\n+\t\tList<Contentlet> contentlets = null;\n+\n \t\ttry{\n-\t\t\tassets = fromContentlets(perAPI.filterCollection(contAPI.search(\"+structureType:\" + Structure.STRUCTURE_TYPE_FILEASSET+\" +conFolder:\" + parentFolder.getInode(), -1, 0, null , user, respectFrontendRoles),\n-\t\t\t\t\tPermissionAPI.PERMISSION_READ, respectFrontendRoles, user));\n+\t\t\tcontentlets = contAPI.search(\n+\t\t\t\t\t\"+structureType:\" + Structure.STRUCTURE_TYPE_FILEASSET + \" +conFolder:\" + parentFolder.getInode(),\n+\t\t\t\t\t-1, 0, null, user, respectFrontendRoles);\n+\t\t} catch (DotRuntimeException e) {\n+\t\t\tif (e.getCause() instanceof ConnectException) {\n+\t\t\t\tcontentlets = this.fileAssetFactory.findFileAssetsByFolderInDB(parentFolder, user, respectFrontendRoles);", "originalCommit": "b10075ddfb89bba51fc2b9fe6838654ad7d8bc24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM5NDc2MQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r402394761", "bodyText": "done https://github.com/dotCMS/core/pull/18225/files#diff-3e213b868e011e1477445a17721c1926R154", "author": "freddyucv", "createdAt": "2020-04-02T15:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxMTc2OA=="}], "type": "inlineReview"}, {"oid": "b3221ca6fdad2fc09e713c11a6b62f4339571aac", "url": "https://github.com/dotCMS/core/commit/b3221ca6fdad2fc09e713c11a6b62f4339571aac", "message": "refactoring", "committedDate": "2020-03-31T21:52:37Z", "type": "commit"}, {"oid": "413e249baefd331dc28d2465b3ae33bae183a34d", "url": "https://github.com/dotCMS/core/commit/413e249baefd331dc28d2465b3ae33bae183a34d", "message": "#18225 refactoring", "committedDate": "2020-03-31T21:54:50Z", "type": "commit"}, {"oid": "ff3b99b6cec1dcf6e3a740cf78bbddff135a2c69", "url": "https://github.com/dotCMS/core/commit/ff3b99b6cec1dcf6e3a740cf78bbddff135a2c69", "message": "#18225 refactoring", "committedDate": "2020-03-31T22:00:16Z", "type": "commit"}, {"oid": "9dca2099299d3a09ffb92a97a18daf825a1859cc", "url": "https://github.com/dotCMS/core/commit/9dca2099299d3a09ffb92a97a18daf825a1859cc", "message": "Merge remote-tracking branch 'origin/master' into issue-18153-When-elasticsearch-is-not-available-page-in-cache-not-work", "committedDate": "2020-04-01T15:43:52Z", "type": "commit"}, {"oid": "8e87391b67b2dc8f0be55175350841ee83a7ab0d", "url": "https://github.com/dotCMS/core/commit/8e87391b67b2dc8f0be55175350841ee83a7ab0d", "message": "#18153 merge", "committedDate": "2020-04-01T15:51:44Z", "type": "commit"}, {"oid": "d948be47b518adc87e74e09f496300e8e48a7418", "url": "https://github.com/dotCMS/core/commit/d948be47b518adc87e74e09f496300e8e48a7418", "message": "#18153 testing", "committedDate": "2020-04-01T16:39:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc2NjI3Ng==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r401766276", "bodyText": "I would rename this method. Even when there are comments that explain the test, the name itself doesn't say something really helpful as the annotation @Test(expected = DotSecurityException.class)  says exactly that", "author": "nollymar", "createdAt": "2020-04-01T16:56:42Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryIntegrationTest.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.FileUtil;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class FileAssetFactoryIntegrationTest extends IntegrationTestBase {\n+\n+    private static FileAssetFactoryImpl fileAssetFactory;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment o\n+        IntegrationTestInitService.getInstance().init();\n+\n+        fileAssetFactory = new FileAssetFactoryImpl();\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetFactory#findFileAssetsByFolderInDB(Folder, User, boolean)}\n+     * When: Create two Folder with two files each one, and try to get the files from the first folder\n+     *       and the user jave permission over all the files\n+     * Should: return only the two files into the first folder\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void shouldReturnTwoFiles() throws IOException, DotDataException, DotSecurityException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Folder folder1 = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset1 = createFileAsset(folder1, \"text1\", \".txt\");\n+        final Contentlet fileAsset2 = createFileAsset(folder1, \"text2\", \".txt\");\n+\n+        final Folder folder2 = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset3 = createFileAsset(folder2, \"text1\", \".txt\");\n+        final Contentlet fileAsset4 = createFileAsset(folder2, \"text2\", \".txt\");\n+\n+        this.addPermission(role, folder1, folder2, fileAsset1, fileAsset2, fileAsset3, fileAsset4);\n+        final List<Contentlet> files = fileAssetFactory.findFileAssetsByFolderInDB(folder1, user, false);\n+\n+        assertEquals(2, files.size());\n+\n+        final List<String> filesInodes = files.stream().map((file) -> file.getInode()).collect(Collectors.toList());\n+\n+        assertTrue(filesInodes.contains(fileAsset1.getInode()));\n+        assertTrue(filesInodes.contains(fileAsset2.getInode()));\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetFactory#findFileAssetsByFolderInDB(Folder, User, boolean)}\n+     * When: Create one Folder with two files each one, grant permission iver one file and  try to get the files from the\n+     *       folder\n+     * Should: return only one file\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void shouldReturnOneFile() throws IOException, DotDataException, DotSecurityException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Folder folder = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset1 = createFileAsset(folder, \"text1\", \".txt\");\n+        createFileAsset(folder, \"text2\", \".txt\");\n+\n+        this.addPermission(role, folder, fileAsset1);\n+        final List<Contentlet> files = fileAssetFactory.findFileAssetsByFolderInDB(folder, user, false);\n+\n+        assertEquals(1, files.size());\n+\n+        final List<String> filesInodes = files.stream().map((file) -> file.getInode()).collect(Collectors.toList());\n+        assertTrue(filesInodes.contains(fileAsset1.getInode()));\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetFactory#findFileAssetsByFolderInDB(Folder, User, boolean)}\n+     * When: Create one Folder with two files each one, grant permission to anonymous role\n+     * Should: return two files\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void shouldWorkWithAnonymous() throws IOException, DotDataException, DotSecurityException {\n+        final Role anonymousRole = APILocator.getRoleAPI().loadCMSAnonymousRole();\n+        final User user = new UserDataGen().nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Folder folder = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset1 = createFileAsset(folder, \"text1\", \".txt\");\n+        final Contentlet fileAsset2 = createFileAsset(folder, \"text2\", \".txt\");\n+\n+        ContentletDataGen.publish(fileAsset1);\n+        ContentletDataGen.publish(fileAsset2);\n+\n+        this.addPermission(anonymousRole, folder, fileAsset1, fileAsset2);\n+        final List<Contentlet> files = fileAssetFactory.findFileAssetsByFolderInDB(folder, user, true);\n+\n+        assertEquals(2, files.size());\n+\n+        final List<String> filesInodes = files.stream().map((file) -> file.getInode()).collect(Collectors.toList());\n+        assertTrue(filesInodes.contains(fileAsset1.getInode()));\n+        assertTrue(filesInodes.contains(fileAsset2.getInode()));\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetFactory#findFileAssetsByFolderInDB(Folder, User, boolean)}\n+     * When: Create one Folder without files\n+     * Should: return a empty list\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void shouldReturnEmptyList() throws DotDataException, DotSecurityException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Folder folder = new FolderDataGen().site(host).nextPersisted();\n+\n+        this.addPermission(role, folder);\n+        final List<Contentlet> files = fileAssetFactory.findFileAssetsByFolderInDB(folder, user, false);\n+\n+        assertTrue(files.isEmpty());\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetFactory#findFileAssetsByFolderInDB(Folder, User, boolean)}\n+     * When: Create a Folder and not add permission\n+     * Should: throw a {@link DotSecurityException}\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void shouldThorDotSecurityException() throws DotDataException, DotSecurityException {", "originalCommit": "d948be47b518adc87e74e09f496300e8e48a7418", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM4MzIwMA==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r402383200", "bodyText": "done a14571c#diff-b1dc6015d0a0a590385cffd31ab8418eR175", "author": "freddyucv", "createdAt": "2020-04-02T15:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc2NjI3Ng=="}], "type": "inlineReview"}, {"oid": "5e17056db69831c301606b698fa7318b594ec0c6", "url": "https://github.com/dotCMS/core/commit/5e17056db69831c301606b698fa7318b594ec0c6", "message": "#18153 testing", "committedDate": "2020-04-01T20:00:39Z", "type": "commit"}, {"oid": "a14571cd0fa1e43bd5e21bfd4b25d77057a712f1", "url": "https://github.com/dotCMS/core/commit/a14571cd0fa1e43bd5e21bfd4b25d77057a712f1", "message": "refactoring", "committedDate": "2020-04-02T14:56:27Z", "type": "commit"}, {"oid": "9ef68cccc089edc9c5da23ab3d404b4c2ccc81a2", "url": "https://github.com/dotCMS/core/commit/9ef68cccc089edc9c5da23ab3d404b4c2ccc81a2", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18153-When-elasticsearch-is-not-available-page-in-cache-not-work", "committedDate": "2020-04-02T19:07:51Z", "type": "commit"}, {"oid": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "url": "https://github.com/dotCMS/core/commit/058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "message": "#18153 fix conflicts after merging master", "committedDate": "2020-04-08T19:12:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzAzMw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757033", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.business'", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:12Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImpl.java", "diffHunk": "@@ -5,13 +5,18 @@\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.net.ConnectException;\n import java.nio.file.Files;\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n import java.util.zip.GZIPInputStream;\n \n+import com.dotcms.exception.ExceptionUtil;\n+import com.dotcms.repackage.com.google.common.annotations.VisibleForTesting;\n import com.dotcms.util.MimeTypeUtils;\n+import com.dotmarketing.business.*;", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzA0MA==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757040", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:13Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImplIntegrationTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.liferay.portal.model.User;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class FileAssetAPIImplIntegrationTest  extends IntegrationTestBase {\n+\n+    private static FileAssetAPIImpl fileAssetAPIImpl;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzA1MQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757051", "bodyText": "Issue found: Avoid unused imports such as 'org.junit.Assert.assertTrue'", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:14Z", "path": "dotCMS/src/test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImplTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.api.system.event.SystemEventsAPI;\n+import com.dotmarketing.business.IdentifierAPI;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.business.ContentletCache;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.structure.model.Structure;\n+import com.liferay.portal.model.User;\n+import org.apache.velocity.exception.ResourceNotFoundException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.net.ConnectException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzA2Mg==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757062", "bodyText": "Issue found: Avoid unused imports such as 'org.apache.velocity.exception.ResourceNotFoundException'", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:15Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImpl.java", "diffHunk": "@@ -53,6 +53,7 @@\n import com.liferay.util.FileUtil;\n import com.liferay.util.StringPool;\n import io.vavr.control.Try;\n+import org.apache.velocity.exception.ResourceNotFoundException;", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzA3MQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757071", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.datagen'", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:16Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImplIntegrationTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzA4Mg==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757082", "bodyText": "Issue found: The String literal \"text2\" appears 4 times in this file; the first occurrence is on line 60", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:17Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryIntegrationTest.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.FileUtil;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class FileAssetFactoryIntegrationTest extends IntegrationTestBase {\n+\n+    private static FileAssetFactoryImpl fileAssetFactory;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment o\n+        IntegrationTestInitService.getInstance().init();\n+\n+        fileAssetFactory = new FileAssetFactoryImpl();\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetFactory#findFileAssetsByFolderInDB(Folder, User, boolean)}\n+     * When: Create two Folder with two files each one, and try to get the files from the first folder\n+     *       and the user jave permission over all the files\n+     * Should: return only the two files into the first folder\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void shouldReturnTwoFiles() throws IOException, DotDataException, DotSecurityException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Folder folder1 = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset1 = createFileAsset(folder1, \"text1\", \".txt\");\n+        final Contentlet fileAsset2 = createFileAsset(folder1, \"text2\", \".txt\");", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzA4Nw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757087", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:18Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryIntegrationTest.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.FileUtil;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class FileAssetFactoryIntegrationTest extends IntegrationTestBase {\n+\n+    private static FileAssetFactoryImpl fileAssetFactory;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzEwMw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757103", "bodyText": "Issue found: Avoid unused imports such as 'org.mockito.Mockito'", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:19Z", "path": "dotCMS/src/test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImplTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.api.system.event.SystemEventsAPI;\n+import com.dotmarketing.business.IdentifierAPI;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.business.ContentletCache;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.structure.model.Structure;\n+import com.liferay.portal.model.User;\n+import org.apache.velocity.exception.ResourceNotFoundException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.net.ConnectException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.*;", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzExMA==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757110", "bodyText": "Issue found: Unnecessary use of fully qualified name 'java.io.File.createTempFile' due to existing import 'java.io.File'", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:20Z", "path": "dotCMS/src/integration-test/java/com/dotcms/datagen/FileAssetDataGen.java", "diffHunk": "@@ -32,4 +36,24 @@ private FileAssetDataGen(final File file) throws DotDataException, DotSecurityEx\n         setProperty(FileAssetAPI.BINARY_FIELD, file);\n     }\n \n+    public static Contentlet createFileAsset(\n+            final Folder folder,\n+            final String fileName,\n+            final String suffix)\n+            throws IOException, DotSecurityException, DotDataException {\n+\n+        return  createFileAsset(folder, fileName, suffix, \"helloworld\");\n+    }\n+\n+    private static Contentlet createFileAsset(\n+            final Folder folder,\n+            final String fileName,\n+            final String suffix,\n+            final String content)\n+            throws IOException, DotSecurityException, DotDataException {\n+        final java.io.File file = java.io.File.createTempFile(fileName, suffix);", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzExNw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757117", "bodyText": "Issue found: Avoid unused imports such as 'org.apache.velocity.exception.ResourceNotFoundException'", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:21Z", "path": "dotCMS/src/test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImplTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.api.system.event.SystemEventsAPI;\n+import com.dotmarketing.business.IdentifierAPI;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.business.ContentletCache;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.structure.model.Structure;\n+import com.liferay.portal.model.User;\n+import org.apache.velocity.exception.ResourceNotFoundException;", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzEyNw==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757127", "bodyText": "Issue found: The String literal \"text1\" appears 4 times in this file; the first occurrence is on line 59", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:22Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryIntegrationTest.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.FileUtil;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class FileAssetFactoryIntegrationTest extends IntegrationTestBase {\n+\n+    private static FileAssetFactoryImpl fileAssetFactory;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment o\n+        IntegrationTestInitService.getInstance().init();\n+\n+        fileAssetFactory = new FileAssetFactoryImpl();\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetFactory#findFileAssetsByFolderInDB(Folder, User, boolean)}\n+     * When: Create two Folder with two files each one, and try to get the files from the first folder\n+     *       and the user jave permission over all the files\n+     * Should: return only the two files into the first folder\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void shouldReturnTwoFiles() throws IOException, DotDataException, DotSecurityException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Folder folder1 = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset1 = createFileAsset(folder1, \"text1\", \".txt\");", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzEzNA==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757134", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.datagen'", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:23Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryIntegrationTest.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzE0NQ==", "url": "https://github.com/dotCMS/core/pull/18225#discussion_r405757145", "bodyText": "Issue found: The String literal \".txt\" appears 5 times in this file; the first occurrence is on line 58", "author": "dev-dotcms", "createdAt": "2020-04-08T19:19:24Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPIImplIntegrationTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.liferay.portal.model.User;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class FileAssetAPIImplIntegrationTest  extends IntegrationTestBase {\n+\n+    private static FileAssetAPIImpl fileAssetAPIImpl;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment o\n+        IntegrationTestInitService.getInstance().init();\n+\n+        fileAssetAPIImpl = new FileAssetAPIImpl();\n+    }\n+\n+    /**\n+     * Method to test: {@link FileAssetAPIImpl#findFileAssetsByFolder(Folder, User, boolean)}\n+     * When: Create two Folder with two files each one, grant permission over folders and files\n+     * and try to get the files from the first folder\n+     * Should: return only the two files into the first folder\n+     *\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void shouldReturnTwoFiles() throws IOException, DotDataException, DotSecurityException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final Folder folder1 = new FolderDataGen().site(host).nextPersisted();\n+        final Contentlet fileAsset1 = FileAssetDataGen.createFileAsset(folder1, \"text1\", \".txt\");", "originalCommit": "058bf63a98483d2f4a805a74d63c5e5f6a7cf6d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}