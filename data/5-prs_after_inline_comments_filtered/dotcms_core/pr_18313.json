{"pr_number": 18313, "pr_title": "#18309 Owner user should have permission to edit contentlet", "pr_createdAt": "2020-04-15T22:41:29Z", "pr_url": "https://github.com/dotCMS/core/pull/18313", "timeline": [{"oid": "042a12ae0d104be8cd8d07a91960e2d5174922be", "url": "https://github.com/dotCMS/core/commit/042a12ae0d104be8cd8d07a91960e2d5174922be", "message": "#18309 Owner user should have permission to edit contentlet", "committedDate": "2020-04-15T22:34:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE3NzQ3MQ==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r409177471", "bodyText": "We can add an assert checking that the content is actually locked", "author": "dsilvam", "createdAt": "2020-04-15T22:45:05Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImplTest.java", "diffHunk": "@@ -330,6 +333,94 @@ public void testIsCheckInSafeWithoutRelationshipsShouldReturnTrue() {\n     }\n \n \n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: A user without permission try to lock a contentlet\n+     * ExpectedResult: Should throw a DotSecurityException\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void whenTryToLockShouldThrowDotSecurityException() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        final ESContentletAPIImpl esContentletAPI = new ESContentletAPIImpl();\n+        final Contentlet contentletSaved = esContentletAPI.checkin(contentlet, APILocator.systemUser(), false);\n+        esContentletAPI.lock(contentletSaved, user, false);\n+    }\n+\n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: A user with {@link PermissionLevel#EDIT} permission try to lock a contentlet\n+     * ExpectedResult: Should work\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void whenTryToLockShouldWork() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        final ESContentletAPIImpl esContentletAPI = new ESContentletAPIImpl();\n+        final Contentlet contentletSaved = esContentletAPI.checkin(contentlet, APILocator.systemUser(), false);\n+\n+        addPermission(role, contentType, PermissionLevel.WRITE);\n+        addPermission(role, contentletSaved, PermissionLevel.WRITE);\n+\n+        esContentletAPI.lock(contentletSaved, user, false);", "originalCommit": "042a12ae0d104be8cd8d07a91960e2d5174922be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE3NzY4Mg==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r409177682", "bodyText": "same as previous comment", "author": "dsilvam", "createdAt": "2020-04-15T22:45:41Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImplTest.java", "diffHunk": "@@ -330,6 +333,94 @@ public void testIsCheckInSafeWithoutRelationshipsShouldReturnTrue() {\n     }\n \n \n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: A user without permission try to lock a contentlet\n+     * ExpectedResult: Should throw a DotSecurityException\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void whenTryToLockShouldThrowDotSecurityException() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        final ESContentletAPIImpl esContentletAPI = new ESContentletAPIImpl();\n+        final Contentlet contentletSaved = esContentletAPI.checkin(contentlet, APILocator.systemUser(), false);\n+        esContentletAPI.lock(contentletSaved, user, false);\n+    }\n+\n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: A user with {@link PermissionLevel#EDIT} permission try to lock a contentlet\n+     * ExpectedResult: Should work\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void whenTryToLockShouldWork() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        final ESContentletAPIImpl esContentletAPI = new ESContentletAPIImpl();\n+        final Contentlet contentletSaved = esContentletAPI.checkin(contentlet, APILocator.systemUser(), false);\n+\n+        addPermission(role, contentType, PermissionLevel.WRITE);\n+        addPermission(role, contentletSaved, PermissionLevel.WRITE);\n+\n+        esContentletAPI.lock(contentletSaved, user, false);\n+    }\n+\n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: The contentlet's owner without permission to EDIT try to lock the contebtlet\n+     * ExpectedResult: Should work\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test()\n+    public void whenOwnerTryToLockShouldWork() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id())\n+                 .next();\n+\n+        addPermission(role, contentType, PermissionLevel.WRITE);\n+\n+        final ESContentletAPIImpl esContentletAPI = new ESContentletAPIImpl();\n+        final Contentlet contentletSaved = esContentletAPI.checkin(contentlet, user, false);\n+        esContentletAPI.lock(contentletSaved, user, false);", "originalCommit": "042a12ae0d104be8cd8d07a91960e2d5174922be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE3OTY5OQ==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r409179699", "bodyText": "does this apply only for WRITE level or any other also?", "author": "dsilvam", "createdAt": "2020-04-15T22:50:56Z", "path": "dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPIImpl.java", "diffHunk": "@@ -310,6 +310,13 @@ public boolean doesUserHavePermission(final Permissionable permissionable, int p\n \r\n \t\tfinal List<Permission> perms =  getPermissions(permissionable, true);\r\n \t\tfinal boolean isContentlet = permissionable instanceof Contentlet;\r\n+\r\n+\t\tif (isContentlet &&\r\n+\t\t\t\tPermissionLevel.WRITE.getType() == permissionType &&\r", "originalCommit": "042a12ae0d104be8cd8d07a91960e2d5174922be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "846bdbd729fc161f4f46565d471414001147af5c", "url": "https://github.com/dotCMS/core/commit/846bdbd729fc161f4f46565d471414001147af5c", "message": "#18309 When a contentlet is not lock you not have to lock it", "committedDate": "2020-04-17T17:28:55Z", "type": "commit"}, {"oid": "49e4b158627f2948a5066bc098364caef683b4f1", "url": "https://github.com/dotCMS/core/commit/49e4b158627f2948a5066bc098364caef683b4f1", "message": "refactoring", "committedDate": "2020-04-17T17:36:36Z", "type": "commit"}, {"oid": "ee15ab19ea817f1c3340baa65936fbab209c6b31", "url": "https://github.com/dotCMS/core/commit/ee15ab19ea817f1c3340baa65936fbab209c6b31", "message": "#18309 refactoring", "committedDate": "2020-04-17T18:11:45Z", "type": "commit"}, {"oid": "3a508f2ac034622f37c4a3c3cd240e1ce873e4e7", "url": "https://github.com/dotCMS/core/commit/3a508f2ac034622f37c4a3c3cd240e1ce873e4e7", "message": "#18292 Javadoc", "committedDate": "2020-04-17T22:38:41Z", "type": "commit"}, {"oid": "5ed23a58657539e3215bc832cba13b9c0901ac96", "url": "https://github.com/dotCMS/core/commit/5ed23a58657539e3215bc832cba13b9c0901ac96", "message": "#18292 Javadoc", "committedDate": "2020-04-17T22:39:32Z", "type": "commit"}, {"oid": "1303b1626f23b53765f0fdba71e841c426de4885", "url": "https://github.com/dotCMS/core/commit/1303b1626f23b53765f0fdba71e841c426de4885", "message": "merge", "committedDate": "2020-04-20T22:24:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM1MA==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739350", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.datagen'", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:14Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImplTest.java", "diffHunk": "@@ -20,19 +20,18 @@\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.model.type.SimpleContentType;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n-import com.dotcms.datagen.ContentletDataGen;\n-import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.*;", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM1Ng==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739356", "bodyText": "Issue found: Avoid throwing raw exception types.", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:15Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/CheckinContentActionletTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.model.field.*;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;\n+import com.dotcms.exception.ExceptionUtil;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionLevel;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.DotLockException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n+import com.dotmarketing.portlets.contentlet.model.ContentletVersionInfo;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionFailureException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.google.common.collect.ImmutableList;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.Map;\n+\n+import static com.dotcms.util.CollectionsUtils.map;\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(DataProviderRunner.class)\n+public class CheckinContentActionletTest {\n+\n+    private static class TestCase {\n+        Contentlet contentlet;\n+        User user;\n+\n+        boolean hasWritePermission;\n+\n+        public TestCase(Contentlet contentlet, User user, boolean hasWritePermission) {\n+            this.contentlet = contentlet;\n+            this.user = user;\n+            this.hasWritePermission = hasWritePermission;\n+        }\n+    }\n+\n+    @DataProvider\n+    public static Object[] dataProviderSaveLanguage() throws DotSecurityException, DotDataException {\n+        final ContentType contentType = new ContentTypeDataGen()\n+                .fields(ImmutableList.of(ImmutableTextField.builder().name(\"Name\").variable(\"name\").build()))\n+                .nextPersisted();\n+\n+        final Contentlet notLockContentlet = new ContentletDataGen(contentType.id())\n+                .setProperty(\"name\", \"testName\")\n+                .nextPersisted();\n+        final User limitedUser = new UserDataGen().next();\n+\n+        final Contentlet lockContentlet = new ContentletDataGen(contentType.id())\n+                .setProperty(\"name\", \"testName\")\n+                .nextPersisted();\n+\n+        final User userWithPermission = createUserWithPermission(lockContentlet);\n+        APILocator.getContentletAPI().lock(lockContentlet, userWithPermission, false);\n+\n+        return new TestCase[]{\n+                new TestCase(notLockContentlet, limitedUser, false),\n+                new TestCase(lockContentlet, limitedUser, false),\n+                new TestCase(notLockContentlet, userWithPermission, true)\n+        };\n+    }\n+\n+    private static User createUserWithPermission(final Contentlet lockContentlet) throws DotDataException {\n+        final Role backEndUserRole = APILocator.getRoleAPI().loadBackEndUserRole();\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User userWithPermission = new UserDataGen().roles(role, backEndUserRole).nextPersisted();\n+        addWritePermissionToContentlet(role, lockContentlet);\n+        return userWithPermission;\n+    }\n+\n+    private static void addWritePermissionToContentlet(final Role role, final Contentlet contentlet) throws DotDataException {\n+        final Permission permission = getPermission(role, contentlet, PermissionLevel.EDIT.getType());\n+\n+        try {\n+            APILocator.getPermissionAPI().save(permission, contentlet, APILocator.systemUser(), false);\n+\n+        } catch (DotDataException | DotSecurityException e){\n+            throw new RuntimeException(e);", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM2MA==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739360", "bodyText": "Issue found: Parameter 'user' is not assigned and could be declared final", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:16Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/CheckinContentActionletTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.model.field.*;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;\n+import com.dotcms.exception.ExceptionUtil;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionLevel;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.DotLockException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n+import com.dotmarketing.portlets.contentlet.model.ContentletVersionInfo;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionFailureException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.google.common.collect.ImmutableList;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.Map;\n+\n+import static com.dotcms.util.CollectionsUtils.map;\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(DataProviderRunner.class)\n+public class CheckinContentActionletTest {\n+\n+    private static class TestCase {\n+        Contentlet contentlet;\n+        User user;\n+\n+        boolean hasWritePermission;\n+\n+        public TestCase(Contentlet contentlet, User user, boolean hasWritePermission) {", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM2NA==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739364", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:17Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImplTest.java", "diffHunk": "@@ -330,6 +332,115 @@ public void testIsCheckInSafeWithoutRelationshipsShouldReturnTrue() {\n     }\n \n \n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: A user without permission try to lock a contentlet\n+     * ExpectedResult: Should throw a DotSecurityException\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void whenTryToLockShouldThrowDotSecurityException() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        final ESContentletAPIImpl esContentletAPI = new ESContentletAPIImpl();\n+        final Contentlet contentletSaved = esContentletAPI.checkin(contentlet, APILocator.systemUser(), false);\n+        esContentletAPI.lock(contentletSaved, user, false);\n+    }\n+\n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: A user with {@link PermissionLevel#EDIT} permission try to lock a contentlet\n+     * ExpectedResult: Should work\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void whenTryToLockShouldWork() throws DotSecurityException, DotDataException {", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM3MA==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739370", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.business'", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:18Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImplTest.java", "diffHunk": "@@ -20,19 +20,18 @@\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.model.type.SimpleContentType;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n-import com.dotcms.datagen.ContentletDataGen;\n-import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.*;\n import com.dotcms.util.CollectionsUtils;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n-import com.dotmarketing.business.CacheLocator;\n-import com.dotmarketing.business.RelationshipAPI;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM4MQ==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739381", "bodyText": "Issue found: Avoid unused imports such as 'org.junit.Assert'", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:19Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/CheckinContentActionletTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.model.field.*;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;\n+import com.dotcms.exception.ExceptionUtil;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionLevel;\n+import com.dotmarketing.business.Permissionable;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.business.DotLockException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n+import com.dotmarketing.portlets.contentlet.model.ContentletVersionInfo;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionFailureException;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.google.common.collect.ImmutableList;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.Map;\n+\n+import static com.dotcms.util.CollectionsUtils.map;\n+import static org.junit.Assert.*;", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM4Nw==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739387", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:20Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImplTest.java", "diffHunk": "@@ -330,6 +332,115 @@ public void testIsCheckInSafeWithoutRelationshipsShouldReturnTrue() {\n     }\n \n \n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: A user without permission try to lock a contentlet\n+     * ExpectedResult: Should throw a DotSecurityException\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotSecurityException.class)\n+    public void whenTryToLockShouldThrowDotSecurityException() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        final ESContentletAPIImpl esContentletAPI = new ESContentletAPIImpl();\n+        final Contentlet contentletSaved = esContentletAPI.checkin(contentlet, APILocator.systemUser(), false);\n+        esContentletAPI.lock(contentletSaved, user, false);\n+    }\n+\n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: A user with {@link PermissionLevel#EDIT} permission try to lock a contentlet\n+     * ExpectedResult: Should work\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void whenTryToLockShouldWork() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        final ESContentletAPIImpl esContentletAPI = new ESContentletAPIImpl();\n+        final Contentlet contentletSaved = esContentletAPI.checkin(contentlet, APILocator.systemUser(), false);\n+\n+        addPermission(role, contentType, PermissionLevel.WRITE);\n+        addPermission(role, contentletSaved, PermissionLevel.WRITE);\n+\n+        esContentletAPI.lock(contentletSaved, user, false);\n+\n+        checkLock(user, contentletSaved);\n+    }\n+\n+    private void checkLock(final User user, final Contentlet contentletSaved) throws DotDataException {\n+        final ContentletVersionInfo info = APILocator.getVersionableAPI().\n+                getContentletVersionInfo(contentletSaved.getIdentifier(), contentletSaved.getLanguageId());\n+\n+        assertNotNull(info.getLockedBy());\n+        assertNotNull(info.getLockedOn());\n+        assertEquals(user.getUserId(), info.getLockedBy());\n+    }\n+\n+    /**\n+     * Method to test: {@link ESContentletAPIImpl#lock(Contentlet, User, boolean)}\n+     * Given Scenario: The contentlet's owner without permission to EDIT try to lock the contebtlet\n+     * ExpectedResult: Should work\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test()\n+    public void whenOwnerTryToLockShouldWork() throws DotSecurityException, DotDataException {", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM5MA==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739390", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.contenttype.model.field'", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:21Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/CheckinContentActionletTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.model.field.*;", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczOTM5Nw==", "url": "https://github.com/dotCMS/core/pull/18313#discussion_r411739397", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.datagen'", "author": "dev-dotcms", "createdAt": "2020-04-20T22:40:22Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/CheckinContentActionletTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotcms.contenttype.model.field.*;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;", "originalCommit": "1303b1626f23b53765f0fdba71e841c426de4885", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}