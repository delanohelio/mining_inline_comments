{"pr_number": 18150, "pr_title": "Issue 18068 remove references to load records to index", "pr_createdAt": "2020-03-18T00:15:54Z", "pr_url": "https://github.com/dotCMS/core/pull/18150", "timeline": [{"oid": "ad81ff7181e36a98020b6402bbd94fd345c8831b", "url": "https://github.com/dotCMS/core/commit/ad81ff7181e36a98020b6402bbd94fd345c8831b", "message": "#18068 Removing references to load_records_to_index from all databases", "committedDate": "2020-03-18T00:13:39Z", "type": "commit"}, {"oid": "5a29187f690e1913cc16432bfe0e0ec94ef97846", "url": "https://github.com/dotCMS/core/commit/5a29187f690e1913cc16432bfe0e0ec94ef97846", "message": "Merge branch 'master' of https://github.com/dotCMS/core into issue-18068-remove-references-to-load_records_to_index", "committedDate": "2020-03-18T00:14:15Z", "type": "commit"}, {"oid": "612414de271a7710cb1df3f71d583b8f80d2d99e", "url": "https://github.com/dotCMS/core/commit/612414de271a7710cb1df3f71d583b8f80d2d99e", "message": "#18068 Removing missing lines from mysql.sql", "committedDate": "2020-03-18T00:35:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUyNjIxMg==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r394526212", "bodyText": "I think we should add here detail about what this task do\nfor example\n\nremove the load_records_to_index function if it exists", "author": "freddyucv", "createdAt": "2020-03-18T17:38:31Z", "path": "dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndex.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotmarketing.startup.AbstractJDBCStartupTask;\n+import java.util.List;\n+\n+/**\n+ * Remove {@code load_records_to_index} stored procedure", "originalCommit": "612414de271a7710cb1df3f71d583b8f80d2d99e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUyNjczMQ==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r394526731", "bodyText": "is it possible do a test?, maybe we can run the Task manually and check that the data base have the change that we expect", "author": "freddyucv", "createdAt": "2020-03-18T17:39:23Z", "path": "dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndex.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.dotmarketing.startup.runonce;", "originalCommit": "612414de271a7710cb1df3f71d583b8f80d2d99e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a4323b684162390ac9e5c2d39e0cb63cbca1576d", "url": "https://github.com/dotCMS/core/commit/a4323b684162390ac9e5c2d39e0cb63cbca1576d", "message": "#18068 Fixing issues with upgrade tasks. A couple of ITs were created", "committedDate": "2020-03-19T22:53:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5NTQzMQ==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396595431", "bodyText": "Looks like this run on an already altered db. We could put it in the previous state and run the upgrade task to actually test it did the modification.", "author": "dsilvam", "createdAt": "2020-03-23T16:43:41Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05205UpdateIndexNameLengthTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import java.util.Map;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05205UpdateIndexNameLengthTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    private Map<String, String> getColumnPropertiesAfterUpgrade() throws DotDataException {\n+        String query;\n+\n+        if (!DbConnectionFactory.getDBType().equals(\"Oracle\")){\n+            query = \"select character_maximum_length as field_length, is_nullable as nullable_value from \"\n+                    + \"information_schema.columns where table_name = 'indicies' \"\n+                    + \"and column_name='index_name'\";\n+        } else {\n+            query = \"SELECT DATA_LENGTH as field_length, NULLABLE as nullable_value \"\n+                    + \"FROM user_tab_columns WHERE table_name = 'INDICIES' \"\n+                    + \"AND column_name = 'INDEX_NAME'\";\n+        }\n+        final DotConnect dotConnect = new DotConnect();\n+        dotConnect.setSQL(query);\n+        return (Map<String, String>)dotConnect.loadResults().get(0);\n+\n+    }\n+\n+    @Test\n+    public void testUpgradeTaskShouldPass() throws DotDataException {\n+        final Task05205UpdateIndexNameLength task = new Task05205UpdateIndexNameLength();\n+\n+        task.executeUpgrade();", "originalCommit": "a4323b684162390ac9e5c2d39e0cb63cbca1576d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMzg4Mg==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396713882", "bodyText": "Done", "author": "nollymar", "createdAt": "2020-03-23T19:45:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5NTQzMQ=="}], "type": "inlineReview"}, {"oid": "7c40e02b5d169422fdcd42c60de094005cc457e3", "url": "https://github.com/dotCMS/core/commit/7c40e02b5d169422fdcd42c60de094005cc457e3", "message": "#18068 Applying code review suggestions", "committedDate": "2020-03-23T19:45:09Z", "type": "commit"}, {"oid": "96f70ae56ffab3da211149032b54193c5dee635d", "url": "https://github.com/dotCMS/core/commit/96f70ae56ffab3da211149032b54193c5dee635d", "message": "Merge branch 'master' of https://github.com/dotCMS/core into issue-18068-remove-references-to-load_records_to_index", "committedDate": "2020-03-23T22:19:48Z", "type": "commit"}, {"oid": "1f3246a81be88d8914b4a4bd0f998946484405d1", "url": "https://github.com/dotCMS/core/commit/1f3246a81be88d8914b4a4bd0f998946484405d1", "message": "Merge branch 'master' of https://github.com/dotCMS/core into issue-18068-remove-references-to-load_records_to_index", "committedDate": "2020-03-24T01:09:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDc5OA==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850798", "bodyText": "Issue found: Avoid variables with short names like dc", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:04Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndexTest.java", "diffHunk": "@@ -0,0 +1,182 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05225RemoveLoadRecordsToIndexTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void testUpgradeTaskShouldPass() throws DotDataException, SQLException {\n+\n+        createLoadRecordsToIndexProcedure();\n+        final Task05225RemoveLoadRecordsToIndex task = new Task05225RemoveLoadRecordsToIndex();\n+        task.executeUpgrade();\n+        assertFalse(procedureExists());\n+\n+    }\n+\n+    private void createLoadRecordsToIndexProcedure() throws SQLException {\n+        String script = null;\n+\n+        switch (DbConnectionFactory.getDBType()){\n+            case \"MySQL\":\n+                script = getMySQLScript();\n+                break;\n+\n+            case \"PostgreSQL\":\n+                script = getPostgreSQLScript();\n+                break;\n+\n+            case \"Oracle\":\n+                script = getOracleScript();\n+                break;\n+\n+            case \"Microsoft SQL Server\":\n+                script = getSQLServerScript();\n+                break;\n+        }\n+\n+        final DotConnect dotConnect = new DotConnect();\n+        dotConnect.executeStatement(script);\n+\n+    }\n+\n+    private String getOracleScript() {\n+        return \"CREATE OR REPLACE FUNCTION load_records_to_index(server_id VARCHAR2, records_to_fetch NUMBER, priority_level NUMBER)\\n\"\n+                + \"   RETURN types.ref_cursor IS\\n\"\n+                + \" cursor_ret types.ref_cursor;\\n\"\n+                + \" data_ret reindex_record_list;\\n\"\n+                + \"BEGIN\\n\"\n+                + \"  data_ret := reindex_record_list();\\n\"\n+                + \"  FOR dj in (SELECT * FROM dist_reindex_journal\\n\"\n+                + \"         WHERE serverid IS NULL AND priority <= priority_level AND rownum<=records_to_fetch\\n\"\n+                + \"         ORDER BY priority ASC\\n\"\n+                + \"         FOR UPDATE)\\n\"\n+                + \"  LOOP\\n\"\n+                + \"    UPDATE dist_reindex_journal SET serverid=server_id WHERE id=dj.id;\\n\"\n+                + \"    data_ret.extend;\\n\"\n+                + \"    data_ret(data_ret.Last) := reindex_record(dj.id,dj.inode_to_index,dj.ident_to_index,dj.priority,dj.dist_action);\\n\"\n+                + \"  END LOOP;\\n\"\n+                + \"  OPEN cursor_ret FOR\\n\"\n+                + \"    SELECT * FROM TABLE(CAST(data_ret AS reindex_record_list));\\n\"\n+                + \"  RETURN cursor_ret;\\n\"\n+                + \"END;\";\n+    }\n+\n+    private String getPostgreSQLScript() {\n+        return \"CREATE OR REPLACE FUNCTION load_records_to_index(server_id character varying, records_to_fetch int, priority_level int)\\n\"\n+                + \"  RETURNS SETOF dist_reindex_journal AS'\\n\"\n+                + \"DECLARE\\n\"\n+                + \"   dj dist_reindex_journal;\\n\"\n+                + \"BEGIN\\n\"\n+                + \"\\n\"\n+                + \"    FOR dj IN SELECT * FROM dist_reindex_journal\\n\"\n+                + \"       WHERE serverid IS NULL\\n\"\n+                + \"       AND priority <= priority_level\\n\"\n+                + \"       ORDER BY priority ASC\\n\"\n+                + \"       LIMIT records_to_fetch\\n\"\n+                + \"       FOR UPDATE\\n\"\n+                + \"    LOOP\\n\"\n+                + \"        UPDATE dist_reindex_journal SET serverid=server_id WHERE id=dj.id;\\n\"\n+                + \"        RETURN NEXT dj;\\n\"\n+                + \"    END LOOP;\\n\"\n+                + \"\\n\"\n+                + \"END'\"\n+                + \"LANGUAGE plpgsql;\";\n+    }\n+\n+    private String getSQLServerScript() {\n+        return \"CREATE PROCEDURE load_records_to_index(@server_id NVARCHAR(100), @records_to_fetch INT, @priority_level INT)\\n\"\n+                + \"AS\\n\"\n+                + \"BEGIN\\n\"\n+                + \"WITH cte AS (\\n\"\n+                + \"  SELECT TOP(@records_to_fetch) *\\n\"\n+                + \"  FROM dist_reindex_journal WITH (ROWLOCK, READPAST, UPDLOCK)\\n\"\n+                + \"  WHERE serverid IS NULL\\n\"\n+                + \"  AND priority <= @priority_level\\n\"\n+                + \"  ORDER BY priority ASC)\\n\"\n+                + \"UPDATE cte\\n\"\n+                + \"  SET serverid=@server_id\\n\"\n+                + \"OUTPUT\\n\"\n+                + \"  INSERTED.*\\n\"\n+                + \"END;\";\n+    }\n+\n+    private String getMySQLScript() {\n+        return \"CREATE PROCEDURE load_records_to_index(IN server_id VARCHAR(100), IN records_to_fetch INT, IN priority_level INT)\\n\"\n+                + \"BEGIN\\n\"\n+                + \"DECLARE v_id BIGINT;\\n\"\n+                + \"DECLARE v_inode_to_index VARCHAR(100);\\n\"\n+                + \"DECLARE v_ident_to_index VARCHAR(100);\\n\"\n+                + \"DECLARE v_serverid VARCHAR(64);\\n\"\n+                + \"DECLARE v_priority INT;\\n\"\n+                + \"DECLARE v_time_entered TIMESTAMP;\\n\"\n+                + \"DECLARE v_index_val VARCHAR(325);\\n\"\n+                + \"DECLARE v_dist_action INT;\\n\"\n+                + \"DECLARE cursor_end BOOL DEFAULT FALSE;\\n\"\n+                + \"DECLARE cur1 CURSOR FOR SELECT * FROM dist_reindex_journal WHERE serverid IS NULL or serverid='' AND priority <= priority_level ORDER BY priority ASC LIMIT records_to_fetch;\\n\"\n+                + \"DECLARE CONTINUE HANDLER FOR NOT FOUND SET cursor_end:=TRUE;\\n\"\n+                + \"\\n\"\n+                + \"DROP TEMPORARY TABLE IF EXISTS tmp_records_reindex;\\n\"\n+                + \"CREATE TEMPORARY TABLE tmp_records_reindex (\\n\"\n+                + \"  id BIGINT PRIMARY KEY,\\n\"\n+                + \"  inode_to_index varchar(36),\\n\"\n+                + \"  ident_to_index varchar(36),\\n\"\n+                + \"  dist_action INT,\\n\"\n+                + \"  priority INT\\n\"\n+                + \") ENGINE=MEMORY;\\n\"\n+                + \"\\n\"\n+                + \"OPEN cur1;\\n\"\n+                + \"WHILE (NOT cursor_end) DO\\n\"\n+                + \"  FETCH cur1 INTO v_id,v_inode_to_index,v_ident_to_index,v_serverid,v_priority,v_time_entered,v_index_val,v_dist_action;\\n\"\n+                + \"  IF (NOT cursor_end) THEN\\n\"\n+                + \"    UPDATE dist_reindex_journal SET serverid=server_id WHERE id=v_id;\\n\"\n+                + \"    INSERT INTO tmp_records_reindex VALUES (v_id, v_inode_to_index, v_ident_to_index, v_dist_action, v_priority);\\n\"\n+                + \"  END IF;\\n\"\n+                + \"END WHILE;\\n\"\n+                + \"CLOSE cur1;\\n\"\n+                + \"\\n\"\n+                + \"SELECT * FROM tmp_records_reindex;\\n\"\n+                + \"END;\";\n+    }\n+\n+    private boolean procedureExists() throws DotDataException {\n+        String query = null;\n+\n+        switch (DbConnectionFactory.getDBType()){\n+            case \"MySQL\":\n+                query = \"SHOW PROCEDURE STATUS WHERE name = 'load_records_to_index';\";\n+                break;\n+\n+            case \"PostgreSQL\":\n+                query = \"SELECT * FROM information_schema.routines where routine_name='load_records_to_index'\";\n+                break;\n+\n+            case \"Oracle\":\n+                query = \"select * from dba_objects where object_type = 'FUNCTION' and  object_name='LOAD_RECORDS_TO_INDEX'\";\n+                break;\n+\n+            case \"Microsoft SQL Server\":\n+                query = \"select * from sys.objects obj where obj.type in ('P', 'X') and obj.name = 'load_records_to_index'\";\n+                break;\n+        }\n+\n+        final DotConnect dc = new DotConnect();", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDgwMA==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850800", "bodyText": "Issue found: The String literal \"BEGIN\\n\" appears 4 times in this file; the first occurrence is on line 62", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:05Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndexTest.java", "diffHunk": "@@ -0,0 +1,182 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05225RemoveLoadRecordsToIndexTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void testUpgradeTaskShouldPass() throws DotDataException, SQLException {\n+\n+        createLoadRecordsToIndexProcedure();\n+        final Task05225RemoveLoadRecordsToIndex task = new Task05225RemoveLoadRecordsToIndex();\n+        task.executeUpgrade();\n+        assertFalse(procedureExists());\n+\n+    }\n+\n+    private void createLoadRecordsToIndexProcedure() throws SQLException {\n+        String script = null;\n+\n+        switch (DbConnectionFactory.getDBType()){\n+            case \"MySQL\":\n+                script = getMySQLScript();\n+                break;\n+\n+            case \"PostgreSQL\":\n+                script = getPostgreSQLScript();\n+                break;\n+\n+            case \"Oracle\":\n+                script = getOracleScript();\n+                break;\n+\n+            case \"Microsoft SQL Server\":\n+                script = getSQLServerScript();\n+                break;\n+        }\n+\n+        final DotConnect dotConnect = new DotConnect();\n+        dotConnect.executeStatement(script);\n+\n+    }\n+\n+    private String getOracleScript() {\n+        return \"CREATE OR REPLACE FUNCTION load_records_to_index(server_id VARCHAR2, records_to_fetch NUMBER, priority_level NUMBER)\\n\"\n+                + \"   RETURN types.ref_cursor IS\\n\"\n+                + \" cursor_ret types.ref_cursor;\\n\"\n+                + \" data_ret reindex_record_list;\\n\"\n+                + \"BEGIN\\n\"", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDgwMg==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850802", "bodyText": "Issue found: This final field could be made static", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:06Z", "path": "dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndex.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotmarketing.startup.AbstractJDBCStartupTask;\n+import java.util.List;\n+\n+/**\n+ * Remove {@code load_records_to_index} stored procedure\n+ *\n+ * @author nollymar\n+ */\n+public class Task05225RemoveLoadRecordsToIndex extends AbstractJDBCStartupTask {\n+\n+    private final String POSTGRES_SCRIPT = \"DROP FUNCTION IF EXISTS load_records_to_index;\";", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDgxMg==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850812", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:07Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05205UpdateIndexNameLengthTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import java.util.Map;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05205UpdateIndexNameLengthTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDgxOA==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850818", "bodyText": "Issue found: The String literal \"Oracle\" appears 4 times in this file; the first occurrence is on line 25", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:08Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05205UpdateIndexNameLengthTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import java.util.Map;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05205UpdateIndexNameLengthTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    private Map<String, String> getColumnProperties() throws DotDataException {\n+        String query;\n+\n+        if (!DbConnectionFactory.getDBType().equals(\"Oracle\")){", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDgyMw==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850823", "bodyText": "Issue found: This final field could be made static", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:09Z", "path": "dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndex.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotmarketing.startup.AbstractJDBCStartupTask;\n+import java.util.List;\n+\n+/**\n+ * Remove {@code load_records_to_index} stored procedure\n+ *\n+ * @author nollymar\n+ */\n+public class Task05225RemoveLoadRecordsToIndex extends AbstractJDBCStartupTask {\n+\n+    private final String POSTGRES_SCRIPT = \"DROP FUNCTION IF EXISTS load_records_to_index;\";\n+\n+    private final String MYSQL_SCRIPT = \"DROP PROCEDURE IF EXISTS load_records_to_index;\";\n+\n+    private final String MSSQL_SCRIPT =\n+            \"IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'load_records_to_index')\\n\"\n+                    + \"DROP PROCEDURE load_records_to_index;\";\n+\n+\n+    private final String ORACLE_SCRIPT = \"DROP FUNCTION load_records_to_index\";", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDgyNw==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850827", "bodyText": "Issue found: Switch statements should have a default label", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:10Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndexTest.java", "diffHunk": "@@ -0,0 +1,182 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05225RemoveLoadRecordsToIndexTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void testUpgradeTaskShouldPass() throws DotDataException, SQLException {\n+\n+        createLoadRecordsToIndexProcedure();\n+        final Task05225RemoveLoadRecordsToIndex task = new Task05225RemoveLoadRecordsToIndex();\n+        task.executeUpgrade();\n+        assertFalse(procedureExists());\n+\n+    }\n+\n+    private void createLoadRecordsToIndexProcedure() throws SQLException {\n+        String script = null;\n+\n+        switch (DbConnectionFactory.getDBType()){\n+            case \"MySQL\":\n+                script = getMySQLScript();\n+                break;\n+\n+            case \"PostgreSQL\":\n+                script = getPostgreSQLScript();\n+                break;\n+\n+            case \"Oracle\":\n+                script = getOracleScript();\n+                break;\n+\n+            case \"Microsoft SQL Server\":\n+                script = getSQLServerScript();\n+                break;\n+        }\n+\n+        final DotConnect dotConnect = new DotConnect();\n+        dotConnect.executeStatement(script);\n+\n+    }\n+\n+    private String getOracleScript() {\n+        return \"CREATE OR REPLACE FUNCTION load_records_to_index(server_id VARCHAR2, records_to_fetch NUMBER, priority_level NUMBER)\\n\"\n+                + \"   RETURN types.ref_cursor IS\\n\"\n+                + \" cursor_ret types.ref_cursor;\\n\"\n+                + \" data_ret reindex_record_list;\\n\"\n+                + \"BEGIN\\n\"\n+                + \"  data_ret := reindex_record_list();\\n\"\n+                + \"  FOR dj in (SELECT * FROM dist_reindex_journal\\n\"\n+                + \"         WHERE serverid IS NULL AND priority <= priority_level AND rownum<=records_to_fetch\\n\"\n+                + \"         ORDER BY priority ASC\\n\"\n+                + \"         FOR UPDATE)\\n\"\n+                + \"  LOOP\\n\"\n+                + \"    UPDATE dist_reindex_journal SET serverid=server_id WHERE id=dj.id;\\n\"\n+                + \"    data_ret.extend;\\n\"\n+                + \"    data_ret(data_ret.Last) := reindex_record(dj.id,dj.inode_to_index,dj.ident_to_index,dj.priority,dj.dist_action);\\n\"\n+                + \"  END LOOP;\\n\"\n+                + \"  OPEN cursor_ret FOR\\n\"\n+                + \"    SELECT * FROM TABLE(CAST(data_ret AS reindex_record_list));\\n\"\n+                + \"  RETURN cursor_ret;\\n\"\n+                + \"END;\";\n+    }\n+\n+    private String getPostgreSQLScript() {\n+        return \"CREATE OR REPLACE FUNCTION load_records_to_index(server_id character varying, records_to_fetch int, priority_level int)\\n\"\n+                + \"  RETURNS SETOF dist_reindex_journal AS'\\n\"\n+                + \"DECLARE\\n\"\n+                + \"   dj dist_reindex_journal;\\n\"\n+                + \"BEGIN\\n\"\n+                + \"\\n\"\n+                + \"    FOR dj IN SELECT * FROM dist_reindex_journal\\n\"\n+                + \"       WHERE serverid IS NULL\\n\"\n+                + \"       AND priority <= priority_level\\n\"\n+                + \"       ORDER BY priority ASC\\n\"\n+                + \"       LIMIT records_to_fetch\\n\"\n+                + \"       FOR UPDATE\\n\"\n+                + \"    LOOP\\n\"\n+                + \"        UPDATE dist_reindex_journal SET serverid=server_id WHERE id=dj.id;\\n\"\n+                + \"        RETURN NEXT dj;\\n\"\n+                + \"    END LOOP;\\n\"\n+                + \"\\n\"\n+                + \"END'\"\n+                + \"LANGUAGE plpgsql;\";\n+    }\n+\n+    private String getSQLServerScript() {\n+        return \"CREATE PROCEDURE load_records_to_index(@server_id NVARCHAR(100), @records_to_fetch INT, @priority_level INT)\\n\"\n+                + \"AS\\n\"\n+                + \"BEGIN\\n\"\n+                + \"WITH cte AS (\\n\"\n+                + \"  SELECT TOP(@records_to_fetch) *\\n\"\n+                + \"  FROM dist_reindex_journal WITH (ROWLOCK, READPAST, UPDLOCK)\\n\"\n+                + \"  WHERE serverid IS NULL\\n\"\n+                + \"  AND priority <= @priority_level\\n\"\n+                + \"  ORDER BY priority ASC)\\n\"\n+                + \"UPDATE cte\\n\"\n+                + \"  SET serverid=@server_id\\n\"\n+                + \"OUTPUT\\n\"\n+                + \"  INSERTED.*\\n\"\n+                + \"END;\";\n+    }\n+\n+    private String getMySQLScript() {\n+        return \"CREATE PROCEDURE load_records_to_index(IN server_id VARCHAR(100), IN records_to_fetch INT, IN priority_level INT)\\n\"\n+                + \"BEGIN\\n\"\n+                + \"DECLARE v_id BIGINT;\\n\"\n+                + \"DECLARE v_inode_to_index VARCHAR(100);\\n\"\n+                + \"DECLARE v_ident_to_index VARCHAR(100);\\n\"\n+                + \"DECLARE v_serverid VARCHAR(64);\\n\"\n+                + \"DECLARE v_priority INT;\\n\"\n+                + \"DECLARE v_time_entered TIMESTAMP;\\n\"\n+                + \"DECLARE v_index_val VARCHAR(325);\\n\"\n+                + \"DECLARE v_dist_action INT;\\n\"\n+                + \"DECLARE cursor_end BOOL DEFAULT FALSE;\\n\"\n+                + \"DECLARE cur1 CURSOR FOR SELECT * FROM dist_reindex_journal WHERE serverid IS NULL or serverid='' AND priority <= priority_level ORDER BY priority ASC LIMIT records_to_fetch;\\n\"\n+                + \"DECLARE CONTINUE HANDLER FOR NOT FOUND SET cursor_end:=TRUE;\\n\"\n+                + \"\\n\"\n+                + \"DROP TEMPORARY TABLE IF EXISTS tmp_records_reindex;\\n\"\n+                + \"CREATE TEMPORARY TABLE tmp_records_reindex (\\n\"\n+                + \"  id BIGINT PRIMARY KEY,\\n\"\n+                + \"  inode_to_index varchar(36),\\n\"\n+                + \"  ident_to_index varchar(36),\\n\"\n+                + \"  dist_action INT,\\n\"\n+                + \"  priority INT\\n\"\n+                + \") ENGINE=MEMORY;\\n\"\n+                + \"\\n\"\n+                + \"OPEN cur1;\\n\"\n+                + \"WHILE (NOT cursor_end) DO\\n\"\n+                + \"  FETCH cur1 INTO v_id,v_inode_to_index,v_ident_to_index,v_serverid,v_priority,v_time_entered,v_index_val,v_dist_action;\\n\"\n+                + \"  IF (NOT cursor_end) THEN\\n\"\n+                + \"    UPDATE dist_reindex_journal SET serverid=server_id WHERE id=v_id;\\n\"\n+                + \"    INSERT INTO tmp_records_reindex VALUES (v_id, v_inode_to_index, v_ident_to_index, v_dist_action, v_priority);\\n\"\n+                + \"  END IF;\\n\"\n+                + \"END WHILE;\\n\"\n+                + \"CLOSE cur1;\\n\"\n+                + \"\\n\"\n+                + \"SELECT * FROM tmp_records_reindex;\\n\"\n+                + \"END;\";\n+    }\n+\n+    private boolean procedureExists() throws DotDataException {\n+        String query = null;\n+\n+        switch (DbConnectionFactory.getDBType()){", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDgzMw==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850833", "bodyText": "Issue found: This final field could be made static", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:12Z", "path": "dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndex.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotmarketing.startup.AbstractJDBCStartupTask;\n+import java.util.List;\n+\n+/**\n+ * Remove {@code load_records_to_index} stored procedure\n+ *\n+ * @author nollymar\n+ */\n+public class Task05225RemoveLoadRecordsToIndex extends AbstractJDBCStartupTask {\n+\n+    private final String POSTGRES_SCRIPT = \"DROP FUNCTION IF EXISTS load_records_to_index;\";\n+\n+    private final String MYSQL_SCRIPT = \"DROP PROCEDURE IF EXISTS load_records_to_index;\";", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDgzOA==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850838", "bodyText": "Issue found: Switch statements should have a default label", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:13Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05205UpdateIndexNameLengthTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import java.util.Map;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05205UpdateIndexNameLengthTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    private Map<String, String> getColumnProperties() throws DotDataException {\n+        String query;\n+\n+        if (!DbConnectionFactory.getDBType().equals(\"Oracle\")){\n+            query = \"select character_maximum_length as field_length, is_nullable as nullable_value from \"\n+                    + \"information_schema.columns where table_name = 'indicies' \"\n+                    + \"and column_name='index_name'\";\n+        } else {\n+            query = \"SELECT DATA_LENGTH as field_length, NULLABLE as nullable_value \"\n+                    + \"FROM user_tab_columns WHERE table_name = 'INDICIES' \"\n+                    + \"AND column_name = 'INDEX_NAME'\";\n+        }\n+        final DotConnect dotConnect = new DotConnect();\n+        dotConnect.setSQL(query);\n+        return (Map<String, String>)dotConnect.loadResults().get(0);\n+\n+    }\n+\n+    private void setStateBeforeUpgrade() throws SQLException {\n+        String query = null;\n+\n+        switch(DbConnectionFactory.getDBType()){", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDg0MQ==", "url": "https://github.com/dotCMS/core/pull/18150#discussion_r396850841", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-03-24T01:17:14Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05225RemoveLoadRecordsToIndexTest.java", "diffHunk": "@@ -0,0 +1,182 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import java.sql.SQLException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05225RemoveLoadRecordsToIndexTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "originalCommit": "1f3246a81be88d8914b4a4bd0f998946484405d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}