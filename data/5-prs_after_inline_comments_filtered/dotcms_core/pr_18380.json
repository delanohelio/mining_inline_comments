{"pr_number": 18380, "pr_title": "Issue 18354 more normal", "pr_createdAt": "2020-04-28T17:48:10Z", "pr_url": "https://github.com/dotCMS/core/pull/18380", "timeline": [{"oid": "b77a9fa4413f80e6d7070474ff48b69af34336eb", "url": "https://github.com/dotCMS/core/commit/b77a9fa4413f80e6d7070474ff48b69af34336eb", "message": "#18354 changes // for /", "committedDate": "2020-04-24T15:57:50Z", "type": "commit"}, {"oid": "7234d6110ff44eb9676103a8b8aa1cd7afbf7157", "url": "https://github.com/dotCMS/core/commit/7234d6110ff44eb9676103a8b8aa1cd7afbf7157", "message": "#18354 fixes ////", "committedDate": "2020-04-24T16:47:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0NjI5MQ==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r416946291", "bodyText": "I think you could use something like\nreturn newNormal.replaceAll(Pattern.quote(\"//\"), StringPool.SLASH);", "author": "jdotcms", "createdAt": "2020-04-28T21:52:22Z", "path": "dotCMS/src/main/java/com/dotcms/filters/NormalizationFilter.java", "diffHunk": "@@ -36,7 +36,12 @@ public String getRequestURI() {\n                  2. A \"..\" segment is removed only if it is preceded by a non-\"..\" segment.\n                  3. Normalization has no effect upon opaque URIs. (mailto:a@b.com)\n                  */\n-                return URI.create(super.getRequestURI()).normalize().toString();\n+                String newNormal = URI.create(super.getRequestURI()).normalize().toString();", "originalCommit": "7234d6110ff44eb9676103a8b8aa1cd7afbf7157", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyMDQ3MA==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417420470", "bodyText": "While the code looks \"cleaner\", my thinking was that a replaceAll with a RegEx was actually going to be slower than just doing a string replace in a loop.", "author": "wezell", "createdAt": "2020-04-29T15:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0NjI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2MzU2Mg==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417363562", "bodyText": "miss test here", "author": "freddyucv", "createdAt": "2020-04-29T14:33:41Z", "path": "dotCMS/src/main/java/com/dotcms/filters/NormalizationFilter.java", "diffHunk": "@@ -36,7 +36,12 @@ public String getRequestURI() {\n                  2. A \"..\" segment is removed only if it is preceded by a non-\"..\" segment.\n                  3. Normalization has no effect upon opaque URIs. (mailto:a@b.com)\n                  */\n-                return URI.create(super.getRequestURI()).normalize().toString();\n+                String newNormal = URI.create(super.getRequestURI()).normalize().toString();\n+                \n+                while(newNormal.indexOf(\"//\")>-1) {\n+                    newNormal = newNormal.replace(\"//\", \"/\");\n+                }\n+                return newNormal;", "originalCommit": "7234d6110ff44eb9676103a8b8aa1cd7afbf7157", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b7c5c4079cf3dee767923d2147ea51692b76f10", "url": "https://github.com/dotCMS/core/commit/4b7c5c4079cf3dee767923d2147ea51692b76f10", "message": "#18354 more testing and better cleanup", "committedDate": "2020-04-29T16:56:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTAyOQ==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417471029", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-04-29T17:02:19Z", "path": "dotCMS/src/test/java/com/dotcms/filters/NormalizationFilterTest.java", "diffHunk": "@@ -111,5 +135,73 @@ private void compare(final String originalURI, final String expectedNormalizedUR\n         assertNotNull(normalizedValueByFilter);\n         assertEquals(expectedNormalizedURI, normalizedValueByFilter);\n     }\n+    \n+    /**\n+     * Test to verify the {@link NormalizationFilter} is applying properly the normalization on\n+     * invalids URIs\n+     */\n+    @Test\n+    public void test_uri_normalizer_fixes_double_slashes() throws IOException, ServletException {", "originalCommit": "4b7c5c4079cf3dee767923d2147ea51692b76f10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTAzNg==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417471036", "bodyText": "Issue found: String.indexOf(char) is faster than String.indexOf(String).", "author": "dev-dotcms", "createdAt": "2020-04-29T17:02:20Z", "path": "dotCMS/src/test/java/com/dotcms/filters/NormalizationFilterTest.java", "diffHunk": "@@ -86,15 +109,16 @@ public void test_uri_normalization_valid_URI() throws IOException, ServletExcept\n         String originalURI = \"/folder/important/secret_file.dat\";\n         compare(originalURI, originalURI);\n \n+        // (query strings are not part of URI)\n         originalURI = \"/folder/folder1/forward_jsp.jsp?FORWARD_URL=http://google.com\";\n-        compare(originalURI, originalURI);\n+        compare(originalURI, originalURI.substring(0,originalURI.indexOf(\"?\")));", "originalCommit": "4b7c5c4079cf3dee767923d2147ea51692b76f10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTA1Mw==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417471053", "bodyText": "Issue found: The String literal \"/folder/folder1/file.dat\" appears 4 times in this file; the first occurrence is on line 66", "author": "dev-dotcms", "createdAt": "2020-04-29T17:02:21Z", "path": "dotCMS/src/test/java/com/dotcms/filters/NormalizationFilterTest.java", "diffHunk": "@@ -62,18 +63,40 @@ public void test_uri_normalization_invalid_URI() throws IOException, ServletExce\n \n         // Each \".\" segment is simply removed\n         originalURI = \"./folder/folder1/file.dat\";\n-        expectedNormalizedURI = \"folder/folder1/file.dat\";\n+        expectedNormalizedURI = \"/folder/folder1/file.dat\";", "originalCommit": "4b7c5c4079cf3dee767923d2147ea51692b76f10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTA2MA==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417471060", "bodyText": "Issue found: Avoid empty catch blocks", "author": "dev-dotcms", "createdAt": "2020-04-29T17:02:22Z", "path": "dotCMS/src/main/java/com/dotcms/filters/NormalizationFilter.java", "diffHunk": "@@ -30,13 +37,35 @@ public void doFilter(ServletRequest servletRequest, ServletResponse servletRespo\n \n             @Override\n             public String getRequestURI() {\n+                try {\n+                    /* Normalization is the process of removing unnecessary \".\" and \"..\" segments from the path component of a hierarchical URI.\n+                     1. Each \".\" segment is simply removed.\n+                     2. A \"..\" segment is removed only if it is preceded by a non-\"..\" segment.\n+                     3. Normalization has no effect upon opaque URIs. (mailto:a@b.com)\n+                     */\n \n-                /* Normalization is the process of removing unnecessary \".\" and \"..\" segments from the path component of a hierarchical URI.\n-                 1. Each \".\" segment is simply removed.\n-                 2. A \"..\" segment is removed only if it is preceded by a non-\"..\" segment.\n-                 3. Normalization has no effect upon opaque URIs. (mailto:a@b.com)\n-                 */\n-                return URI.create(super.getRequestURI()).normalize().toString();\n+                    String newNormal = URI.create(super.getRequestURI()).normalize().toString();\n+                    newNormal = newNormal.startsWith(DOUBLEPEROIDS) ? newNormal.replace(DOUBLEPEROIDS, \"\") : newNormal;\n+                    newNormal = newNormal.startsWith(SLASH) ? newNormal : SLASH + newNormal;\n+\n+                    // this should not happen \n+                    newNormal = newNormal.indexOf(QUESTION )>-1 ? newNormal.substring(0,newNormal.indexOf(StringPool.QUESTION)) : newNormal;\n+                    while(newNormal.indexOf(DOUBLESLASH)>-1) {\n+                        newNormal = newNormal.replace(DOUBLESLASH, SLASH);\n+                    }\n+                    return newNormal;\n+                }\n+                catch(IllegalArgumentException ill) {\n+                    Logger.warnAndDebug(this.getClass(),ill);\n+                    HttpServletResponse response= (HttpServletResponse) servletResponse;\n+                    try {\n+                        response.sendError(HttpServletResponse.SC_FORBIDDEN);\n+                        response.flushBuffer();\n+                    }\n+                    catch(Exception e) {}", "originalCommit": "4b7c5c4079cf3dee767923d2147ea51692b76f10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTA3Mw==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417471073", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-04-29T17:02:23Z", "path": "dotCMS/src/test/java/com/dotcms/filters/NormalizationFilterTest.java", "diffHunk": "@@ -111,5 +135,73 @@ private void compare(final String originalURI, final String expectedNormalizedUR\n         assertNotNull(normalizedValueByFilter);\n         assertEquals(expectedNormalizedURI, normalizedValueByFilter);\n     }\n+    \n+    /**\n+     * Test to verify the {@link NormalizationFilter} is applying properly the normalization on\n+     * invalids URIs\n+     */\n+    @Test\n+    public void test_uri_normalizer_fixes_double_slashes() throws IOException, ServletException {\n+\n+        \n+        // remove all //, replace with /\n+        String originalURI = \"//folder/important/secret_file.dat\";\n+        String expectedNormalizedURI = \"/folder/important/secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // testing ///\n+        originalURI = \"///folder/important/secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // testing ////\n+        originalURI = \"////folder/important/secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+        \n+\n+        \n+        // testing multiple ////\n+        originalURI = \"////folder/important///secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+        \n+        // testing // not at the root (query strings are not part of URI)\n+        originalURI = \"/test//folder/folder1//forward_jsp.jsp?FORWARD_URL=http://google.com\";\n+        expectedNormalizedURI = \"/test/folder/folder1/forward_jsp.jsp\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // A \"..\" segment is removed only if it is preceded by a non-\"..\" segment\n+        originalURI = \"///test/../folder/important//../secret_file.dat\";\n+        expectedNormalizedURI = \"/folder/secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // Each \".\" segment is simply removed\n+        originalURI = \"./f/older//folder1//file.dat\";\n+        expectedNormalizedURI = \"/f/older/folder1/file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // Each \".\" segment is simply removed\n+        originalURI = \"./folder/./folder1/file.dat//..//\";\n+        expectedNormalizedURI = \"/folder/folder1/\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // starts with ..//\n+        originalURI = \"..//folder/./folder1//file.dat\";\n+        expectedNormalizedURI = \"/folder/folder1/file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+    }\n+    \n+    \n+    /**\n+     * Test to verify the {@link NormalizationFilter} is applying properly the normalization on\n+     * invalids URIs\n+     */\n+    @Test\n+    public void test_uri_normalizer_invalid_uris() throws IOException, ServletException {", "originalCommit": "4b7c5c4079cf3dee767923d2147ea51692b76f10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTA4NQ==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417471085", "bodyText": "Issue found: Local variable 'originalURI' could be declared final", "author": "dev-dotcms", "createdAt": "2020-04-29T17:02:24Z", "path": "dotCMS/src/test/java/com/dotcms/filters/NormalizationFilterTest.java", "diffHunk": "@@ -111,5 +135,73 @@ private void compare(final String originalURI, final String expectedNormalizedUR\n         assertNotNull(normalizedValueByFilter);\n         assertEquals(expectedNormalizedURI, normalizedValueByFilter);\n     }\n+    \n+    /**\n+     * Test to verify the {@link NormalizationFilter} is applying properly the normalization on\n+     * invalids URIs\n+     */\n+    @Test\n+    public void test_uri_normalizer_fixes_double_slashes() throws IOException, ServletException {\n+\n+        \n+        // remove all //, replace with /\n+        String originalURI = \"//folder/important/secret_file.dat\";\n+        String expectedNormalizedURI = \"/folder/important/secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // testing ///\n+        originalURI = \"///folder/important/secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // testing ////\n+        originalURI = \"////folder/important/secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+        \n+\n+        \n+        // testing multiple ////\n+        originalURI = \"////folder/important///secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+        \n+        // testing // not at the root (query strings are not part of URI)\n+        originalURI = \"/test//folder/folder1//forward_jsp.jsp?FORWARD_URL=http://google.com\";\n+        expectedNormalizedURI = \"/test/folder/folder1/forward_jsp.jsp\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // A \"..\" segment is removed only if it is preceded by a non-\"..\" segment\n+        originalURI = \"///test/../folder/important//../secret_file.dat\";\n+        expectedNormalizedURI = \"/folder/secret_file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // Each \".\" segment is simply removed\n+        originalURI = \"./f/older//folder1//file.dat\";\n+        expectedNormalizedURI = \"/f/older/folder1/file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // Each \".\" segment is simply removed\n+        originalURI = \"./folder/./folder1/file.dat//..//\";\n+        expectedNormalizedURI = \"/folder/folder1/\";\n+        compare(originalURI, expectedNormalizedURI);\n+\n+        // starts with ..//\n+        originalURI = \"..//folder/./folder1//file.dat\";\n+        expectedNormalizedURI = \"/folder/folder1/file.dat\";\n+        compare(originalURI, expectedNormalizedURI);\n+    }\n+    \n+    \n+    /**\n+     * Test to verify the {@link NormalizationFilter} is applying properly the normalization on\n+     * invalids URIs\n+     */\n+    @Test\n+    public void test_uri_normalizer_invalid_uris() throws IOException, ServletException {\n+        // testing escaped slashes - Filter barfs and returns /\n+        String originalURI = \"/\\\\///folder//important////secret_file.dat\";", "originalCommit": "4b7c5c4079cf3dee767923d2147ea51692b76f10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTA5OA==", "url": "https://github.com/dotCMS/core/pull/18380#discussion_r417471098", "bodyText": "Issue found: Avoid catching generic exceptions such as NullPointerException, RuntimeException, Exception in try-catch block", "author": "dev-dotcms", "createdAt": "2020-04-29T17:02:25Z", "path": "dotCMS/src/main/java/com/dotcms/filters/NormalizationFilter.java", "diffHunk": "@@ -30,13 +37,35 @@ public void doFilter(ServletRequest servletRequest, ServletResponse servletRespo\n \n             @Override\n             public String getRequestURI() {\n+                try {\n+                    /* Normalization is the process of removing unnecessary \".\" and \"..\" segments from the path component of a hierarchical URI.\n+                     1. Each \".\" segment is simply removed.\n+                     2. A \"..\" segment is removed only if it is preceded by a non-\"..\" segment.\n+                     3. Normalization has no effect upon opaque URIs. (mailto:a@b.com)\n+                     */\n \n-                /* Normalization is the process of removing unnecessary \".\" and \"..\" segments from the path component of a hierarchical URI.\n-                 1. Each \".\" segment is simply removed.\n-                 2. A \"..\" segment is removed only if it is preceded by a non-\"..\" segment.\n-                 3. Normalization has no effect upon opaque URIs. (mailto:a@b.com)\n-                 */\n-                return URI.create(super.getRequestURI()).normalize().toString();\n+                    String newNormal = URI.create(super.getRequestURI()).normalize().toString();\n+                    newNormal = newNormal.startsWith(DOUBLEPEROIDS) ? newNormal.replace(DOUBLEPEROIDS, \"\") : newNormal;\n+                    newNormal = newNormal.startsWith(SLASH) ? newNormal : SLASH + newNormal;\n+\n+                    // this should not happen \n+                    newNormal = newNormal.indexOf(QUESTION )>-1 ? newNormal.substring(0,newNormal.indexOf(StringPool.QUESTION)) : newNormal;\n+                    while(newNormal.indexOf(DOUBLESLASH)>-1) {\n+                        newNormal = newNormal.replace(DOUBLESLASH, SLASH);\n+                    }\n+                    return newNormal;\n+                }\n+                catch(IllegalArgumentException ill) {\n+                    Logger.warnAndDebug(this.getClass(),ill);\n+                    HttpServletResponse response= (HttpServletResponse) servletResponse;\n+                    try {\n+                        response.sendError(HttpServletResponse.SC_FORBIDDEN);\n+                        response.flushBuffer();\n+                    }\n+                    catch(Exception e) {}", "originalCommit": "4b7c5c4079cf3dee767923d2147ea51692b76f10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}