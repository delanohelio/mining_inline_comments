{"pr_number": 18131, "pr_title": "#18101 adding the skinid as mark check for the jwt user validation", "pr_createdAt": "2020-03-11T22:16:28Z", "pr_url": "https://github.com/dotCMS/core/pull/18131", "timeline": [{"oid": "7042c52cd73a377a9339bf38474eaee73d658b23", "url": "https://github.com/dotCMS/core/commit/7042c52cd73a377a9339bf38474eaee73d658b23", "message": "#18101 adding the skinid as mark check for the jwt user validation", "committedDate": "2020-03-11T22:07:16Z", "type": "commit"}, {"oid": "249067355be600554cfe773f7351e8d09f8843db", "url": "https://github.com/dotCMS/core/commit/249067355be600554cfe773f7351e8d09f8843db", "message": "#18101 adding a web service to revoke user api token and fixes", "committedDate": "2020-03-12T05:11:50Z", "type": "commit"}, {"oid": "138f04ef261d71f30c79648fcd09c99792393640", "url": "https://github.com/dotCMS/core/commit/138f04ef261d71f30c79648fcd09c99792393640", "message": "#18101 adding web services for api token and role/layout", "committedDate": "2020-03-12T06:58:17Z", "type": "commit"}, {"oid": "20ca93ad21eec1ecae232bbcb56c432e759429cd", "url": "https://github.com/dotCMS/core/commit/20ca93ad21eec1ecae232bbcb56c432e759429cd", "message": "#18101 Adding resources to handle CRUD over the role layouts", "committedDate": "2020-03-12T17:41:53Z", "type": "commit"}, {"oid": "798764ebcb3ad912171c59323d701cb9ecca38f5", "url": "https://github.com/dotCMS/core/commit/798764ebcb3ad912171c59323d701cb9ecca38f5", "message": "#18101 added unit test to test diff scenarios on UserPersistance", "committedDate": "2020-03-12T18:19:41Z", "type": "commit"}, {"oid": "908f74186c6fb067b82927de3a06b67ae04e7e45", "url": "https://github.com/dotCMS/core/commit/908f74186c6fb067b82927de3a06b67ae04e7e45", "message": "#18101 Adding fixes and unit test", "committedDate": "2020-03-12T23:09:12Z", "type": "commit"}, {"oid": "6999f66134752e458a5250b7040b1c420db74680", "url": "https://github.com/dotCMS/core/commit/6999f66134752e458a5250b7040b1c420db74680", "message": "#18101 adding an unit test", "committedDate": "2020-03-13T19:20:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzNTEzNg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392435136", "bodyText": "rename this method to roleHasLayout", "author": "wezell", "createdAt": "2020-03-13T19:46:48Z", "path": "dotCMS/src/main/java/com/dotmarketing/business/RoleAPIImpl.java", "diffHunk": "@@ -365,6 +366,16 @@ public void addLayoutToRole(final Layout layout, final Role role) throws DotData\n \t\troleFactory.addLayoutToRole(layout, role);\n \t}\n \n+\t@CloseDBIfOpened\n+\t@Override\n+\tpublic boolean hasLayoutToRole(final Layout layout, final Role role) {", "originalCommit": "6999f66134752e458a5250b7040b1c420db74680", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzNTc0Ng==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392435746", "bodyText": "as discussed, we need to add property and methods for rememberMeToken e.g. user.getRememberMeToken()\nWe should only save the value of this field to \"skinUI\" when saving to the db", "author": "wezell", "createdAt": "2020-03-13T19:48:28Z", "path": "dotCMS/src/integration-test/java/com/dotcms/auth/providers/jwt/JsonWebTokenUtilsIntegrationTest.java", "diffHunk": "@@ -67,7 +71,7 @@ public void get_user_in_token()\n \n         //Generate a new token\n         String jsonWebToken = jsonWebTokenService.generateUserToken(new UserToken(jwtId,\n-                userId, date, DateUtil.daysToMillis(2)\n+                userId, date, DateUtil.daysToMillis(2), user.getSkinId()", "originalCommit": "6999f66134752e458a5250b7040b1c420db74680", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzODA0Ng==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392438046", "bodyText": "Question - should we just use the value of user.skinId as the token id instead of adding another claim on the token?  I think that might be best - less moving parts.  When a user logs in, they get a user token with the id out of their user.skinId.  If that gets invalidated/updated, then all tokens using that would be invalidated, right?", "author": "wezell", "createdAt": "2020-03-13T19:54:07Z", "path": "dotCMS/src/integration-test/java/com/dotcms/filters/interceptor/jwt/JsonWebTokenInterceptorIntegrationTest.java", "diffHunk": "@@ -189,8 +190,8 @@ public void interceptWithAccessTokenTest() throws IOException, DotSecurityExcept\n \n         when(loginService.isLoggedIn(request)).thenReturn(false);\n \n-\n-        final UserToken userToken = new UserToken(jwtId, userId, date, date.getTime());\n+        final User user = APILocator.getUserAPI().loadUserById(userId);\n+        final UserToken userToken = new UserToken(jwtId, userId, date, date.getTime(), user.getSkinId());", "originalCommit": "6999f66134752e458a5250b7040b1c420db74680", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzODg2MQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392438861", "bodyText": "We need to mark User.skinId as @JsonIgnore", "author": "wezell", "createdAt": "2020-03-13T19:55:52Z", "path": "dotCMS/src/main/java/com/liferay/portal/model/User.java", "diffHunk": "@@ -22,15 +22,6 @@\n \r", "originalCommit": "6999f66134752e458a5250b7040b1c420db74680", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzOTE4Nw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392439187", "bodyText": "This should be moved to our LayoutAPI and called findLayoutByRole(final Layout layout, final Role role)", "author": "wezell", "createdAt": "2020-03-13T19:56:47Z", "path": "dotCMS/src/main/java/com/dotmarketing/business/RoleFactoryImpl.java", "diffHunk": "@@ -615,6 +617,22 @@ protected void addLayoutToRole(Layout layout, Role role) throws DotDataException\n \t\trc.removeLayoutsOnRole(role.getId());\n \t}\n \n+\t@Override\n+\tprotected Optional<LayoutsRoles> findLayoutsRoles(final Layout layout, final Role role) {", "originalCommit": "6999f66134752e458a5250b7040b1c420db74680", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "url": "https://github.com/dotCMS/core/commit/154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "message": "#18101 adding a new remember me token method to the user", "committedDate": "2020-03-13T22:17:16Z", "type": "commit"}, {"oid": "51c1d3f0dffd92cfb24ab42ce9d912f6c09b5b5a", "url": "https://github.com/dotCMS/core/commit/51c1d3f0dffd92cfb24ab42ce9d912f6c09b5b5a", "message": "#18101 renaming a method", "committedDate": "2020-03-13T22:24:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQyNg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512426", "bodyText": "Issue found: Avoid unused imports such as 'com.liferay.portal.ejb.CompanyPool'", "author": "dev-dotcms", "createdAt": "2020-03-13T22:24:54Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ApiTokenResourceTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.dotcms.rest.api.v1.authentication;\n+\n+import com.dotcms.datagen.CompanyDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.rest.InitDataObject;\n+import com.dotcms.rest.RestUtilTest;\n+import com.dotcms.rest.WebResource;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.liferay.portal.NoSuchCompanyException;\n+import com.liferay.portal.SystemException;\n+import com.liferay.portal.ejb.CompanyPool;", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQzNA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512434", "bodyText": "Issue found: Field roleId has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-13T22:24:55Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleLayoutForm.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.dotcms.rest.api.v1.system.role;\n+\n+import com.dotcms.rest.api.Validated;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+import java.util.Set;\n+\n+@JsonDeserialize(builder = RoleLayoutForm.Builder.class)\n+public class RoleLayoutForm extends Validated {\n+\n+    private final String roleId;\n+    private final Set<String> layoutIds;\n+\n+    private RoleLayoutForm(final RoleLayoutForm.Builder builder) {\n+        roleId    = builder.roleId;\n+        layoutIds = builder.layoutIds;\n+        checkValid();\n+    }\n+\n+    public String getRoleId() {\n+        return this.roleId;\n+    }\n+\n+    public Set<String> getLayoutIds() {\n+        return this.layoutIds;\n+    }\n+\n+    public static final class Builder {\n+\n+        @JsonProperty(required = true)\n+        private String roleId;", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQzOQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512439", "bodyText": "Issue found: These nested if statements could be combined", "author": "dev-dotcms", "createdAt": "2020-03-13T22:24:56Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleHelper.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.dotcms.rest.api.v1.system.role;\n+\n+import com.dotcms.api.system.event.Payload;\n+import com.dotcms.api.system.event.SystemEventType;\n+import com.dotcms.api.system.event.SystemEventsAPI;\n+import com.dotcms.business.WrapInTransaction;\n+import com.dotmarketing.business.Layout;\n+import com.dotmarketing.business.LayoutAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.business.RoleAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Helper to encapsulate Roles logic\n+ * @author jsanca\n+ */\n+public class RoleHelper {\n+\n+    /**\n+     * Saves only the existing layouts on layoutIds, any issue previous added not in the list will be removed\n+     * @param role\n+     * @param layoutIds\n+     * @param layoutAPI\n+     * @param roleAPI\n+     * @param systemEventsAPI\n+     * @throws DotDataException\n+     */\n+    @WrapInTransaction\n+    public List<String> saveRoleLayouts(final Role role, final Set<String> layoutIds,\n+                                final LayoutAPI layoutAPI, final RoleAPI roleAPI,\n+                                final SystemEventsAPI systemEventsAPI) throws DotDataException {\n+\n+        final List<Layout> layouts      = layoutAPI.loadLayoutsForRole(role);\n+        final List<String> layoutsAdded = new ArrayList<>();\n+        final Map<String, Layout> currentLayoutMaps = layouts.stream().collect(\n+                Collectors.toMap(layout -> layout.getId(), layout -> layout));\n+\n+        //Remove all layouts not included in the layoutIds list\n+        layoutIds.forEach(layoutId -> currentLayoutMaps.remove(layoutId));\n+        for(final Map.Entry<String, Layout> layoutToRemoveEntry : currentLayoutMaps.entrySet()) {\n+            roleAPI.removeLayoutFromRole(layoutToRemoveEntry.getValue(), role);\n+        }\n+\n+        // Add new layouts\n+        for(final String changedLayout : layoutIds) {\n+\n+            final Layout layout = layoutAPI.findLayout(changedLayout);\n+            if (null != layout && UtilMethods.isSet(layout.getId())) {\n+                if (!roleAPI.hasLayoutToRole(layout, role)) {", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQ0NA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512444", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-03-13T22:24:57Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ResetPasswordResourceIntegrationTest.java", "diffHunk": "@@ -55,12 +59,13 @@ public void initTest(){\n     }\n \n     @Test\n-    public void testNoSuchUserException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException, SystemException, PortalException {\n+    public void testNoSuchUserException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException, SystemException, PortalException, DotDataException {", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQ1Mw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512453", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-03-13T22:24:59Z", "path": "dotCMS/src/integration-test/java/com/liferay/portal/ejb/UserPersistenceTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.liferay.portal.ejb;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.liferay.portal.model.User;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * Unit test for the {@link UserPersistence}\n+ */\n+public class UserPersistenceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQ1NQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512455", "bodyText": "Issue found: The String literal \"eee\" appears 15 times in this file; the first occurrence is on line 33", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:00Z", "path": "dotCMS/src/integration-test/java/com/liferay/portal/ejb/UserPersistenceTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.liferay.portal.ejb;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.liferay.portal.model.User;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * Unit test for the {@link UserPersistence}\n+ */\n+public class UserPersistenceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void test_diff_same_user_nodiff()  {\n+\n+        final UserPersistence userPersistence = new UserPersistence();\n+        final UserHBM userHBM = new UserHBM();\n+        final User    user    = new User();\n+\n+        userHBM.setPassword(\"xxx\");\n+        user.setPassword(\"xxx\");\n+\n+        userHBM.setCompanyId(\"yyy\");\n+        user.setCompanyId(\"yyy\");\n+\n+        userHBM.setEmailAddress(\"eee\");", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQ2MA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512460", "bodyText": "Issue found: Avoid variables with short names like id", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:01Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -76,8 +77,8 @@ public UserToken(String id, String subject, Date modificationDate, long ttlMilli\n      * @param subject - The subject of the token\n      * @param ttlMillis - The expiration date of the token.\n      */\n-    public UserToken(String id, String subject, String issuer, Date modificationDate, long ttlMillis) {\n-        this(id, subject, issuer, modificationDate,ttlMillis, ImmutableMap.of());\n+    public UserToken(final String id, final String subject, final String issuer, final Date modificationDate, final long ttlMillis, final String skinId) {", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQ2Ng==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512466", "bodyText": "Issue found: Field skinId has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:02Z", "path": "dotCMS/src/integration-test/java/com/dotcms/datagen/UserDataGen.java", "diffHunk": "@@ -22,6 +23,8 @@\n     private String lastName = \"testLastName\" + currentTime;\n     private String emailAddress = \"testEmailAddress@\" + currentTime + \".com\";\n     private String password = String.valueOf(currentTime);\n+    private String skinId   = UUIDGenerator.generateUuid();", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQ3MA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512470", "bodyText": "Issue found: The String literal \"111\" appears 13 times in this file; the first occurrence is on line 39", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:03Z", "path": "dotCMS/src/integration-test/java/com/liferay/portal/ejb/UserPersistenceTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.liferay.portal.ejb;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.liferay.portal.model.User;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * Unit test for the {@link UserPersistence}\n+ */\n+public class UserPersistenceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void test_diff_same_user_nodiff()  {\n+\n+        final UserPersistence userPersistence = new UserPersistence();\n+        final UserHBM userHBM = new UserHBM();\n+        final User    user    = new User();\n+\n+        userHBM.setPassword(\"xxx\");\n+        user.setPassword(\"xxx\");\n+\n+        userHBM.setCompanyId(\"yyy\");\n+        user.setCompanyId(\"yyy\");\n+\n+        userHBM.setEmailAddress(\"eee\");\n+        user.setEmailAddress(\"eee\");\n+\n+        userHBM.setLayoutIds(\"iii\");\n+        user.setLayoutIds(\"iii\");\n+\n+        userHBM.setUserId(\"111\");", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQ3Nw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512477", "bodyText": "Issue found: Avoid unused imports such as 'org.mockito.Matchers.anyObject'", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:04Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ApiTokenResourceTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.dotcms.rest.api.v1.authentication;\n+\n+import com.dotcms.datagen.CompanyDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.rest.InitDataObject;\n+import com.dotcms.rest.RestUtilTest;\n+import com.dotcms.rest.WebResource;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.liferay.portal.NoSuchCompanyException;\n+import com.liferay.portal.SystemException;\n+import com.liferay.portal.ejb.CompanyPool;\n+import com.liferay.portal.ejb.CompanyUtil;\n+import com.liferay.portal.model.Company;\n+import com.liferay.portal.model.User;\n+import com.liferay.portal.util.WebKeys;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.anyObject;", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjQ4Ng==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512486", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:06Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ApiTokenResourceTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.dotcms.rest.api.v1.authentication;\n+\n+import com.dotcms.datagen.CompanyDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.rest.InitDataObject;\n+import com.dotcms.rest.RestUtilTest;\n+import com.dotcms.rest.WebResource;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.liferay.portal.NoSuchCompanyException;\n+import com.liferay.portal.SystemException;\n+import com.liferay.portal.ejb.CompanyPool;\n+import com.liferay.portal.ejb.CompanyUtil;\n+import com.liferay.portal.model.Company;\n+import com.liferay.portal.model.User;\n+import com.liferay.portal.util.WebKeys;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.anyObject;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class ApiTokenResourceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjUwMg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512502", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:07Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ResetPasswordResourceIntegrationTest.java", "diffHunk": "@@ -70,12 +75,13 @@ public void testNoSuchUserException() throws DotSecurityException, NoSuchUserExc\n     }\n \n     @Test\n-    public void testTokenInvalidException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException {\n+    public void testTokenInvalidException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException, DotDataException {", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjUwOQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512509", "bodyText": "Issue found: The String literal \"xxx\" appears 15 times in this file; the first occurrence is on line 27", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:07Z", "path": "dotCMS/src/integration-test/java/com/liferay/portal/ejb/UserPersistenceTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.liferay.portal.ejb;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.liferay.portal.model.User;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * Unit test for the {@link UserPersistence}\n+ */\n+public class UserPersistenceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void test_diff_same_user_nodiff()  {\n+\n+        final UserPersistence userPersistence = new UserPersistence();\n+        final UserHBM userHBM = new UserHBM();\n+        final User    user    = new User();\n+\n+        userHBM.setPassword(\"xxx\");", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjUxNQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512515", "bodyText": "Issue found: Field companyId has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:09Z", "path": "dotCMS/src/integration-test/java/com/dotcms/datagen/UserDataGen.java", "diffHunk": "@@ -22,6 +23,8 @@\n     private String lastName = \"testLastName\" + currentTime;\n     private String emailAddress = \"testEmailAddress@\" + currentTime + \".com\";\n     private String password = String.valueOf(currentTime);\n+    private String skinId   = UUIDGenerator.generateUuid();\n+    private String companyId = UUIDGenerator.generateUuid();", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjUyMQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512521", "bodyText": "Issue found: Parameter 'ttlMillis' is not assigned and could be declared final", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:10Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -65,8 +66,8 @@ public UserToken(final String id, final String subject, final String issuer, fin\n      * @param subject - The subject of the token\n      * @param ttlMillis - The expiration date of the token.\n      */\n-    public UserToken(String id, String subject, Date modificationDate, long ttlMillis) {\n-        this(id, subject, ClusterFactory.getClusterId(), modificationDate,ttlMillis, ImmutableMap.of());\n+    public UserToken(String id, String subject, Date modificationDate, long ttlMillis, final String skinId) {", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjUyNQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512525", "bodyText": "Issue found: These nested if statements could be combined", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:11Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleHelper.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.dotcms.rest.api.v1.system.role;\n+\n+import com.dotcms.api.system.event.Payload;\n+import com.dotcms.api.system.event.SystemEventType;\n+import com.dotcms.api.system.event.SystemEventsAPI;\n+import com.dotcms.business.WrapInTransaction;\n+import com.dotmarketing.business.Layout;\n+import com.dotmarketing.business.LayoutAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.business.RoleAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Helper to encapsulate Roles logic\n+ * @author jsanca\n+ */\n+public class RoleHelper {\n+\n+    /**\n+     * Saves only the existing layouts on layoutIds, any issue previous added not in the list will be removed\n+     * @param role\n+     * @param layoutIds\n+     * @param layoutAPI\n+     * @param roleAPI\n+     * @param systemEventsAPI\n+     * @throws DotDataException\n+     */\n+    @WrapInTransaction\n+    public List<String> saveRoleLayouts(final Role role, final Set<String> layoutIds,\n+                                final LayoutAPI layoutAPI, final RoleAPI roleAPI,\n+                                final SystemEventsAPI systemEventsAPI) throws DotDataException {\n+\n+        final List<Layout> layouts      = layoutAPI.loadLayoutsForRole(role);\n+        final List<String> layoutsAdded = new ArrayList<>();\n+        final Map<String, Layout> currentLayoutMaps = layouts.stream().collect(\n+                Collectors.toMap(layout -> layout.getId(), layout -> layout));\n+\n+        //Remove all layouts not included in the layoutIds list\n+        layoutIds.forEach(layoutId -> currentLayoutMaps.remove(layoutId));\n+        for(final Map.Entry<String, Layout> layoutToRemoveEntry : currentLayoutMaps.entrySet()) {\n+            roleAPI.removeLayoutFromRole(layoutToRemoveEntry.getValue(), role);\n+        }\n+\n+        // Add new layouts\n+        for(final String changedLayout : layoutIds) {\n+\n+            final Layout layout = layoutAPI.findLayout(changedLayout);\n+            if (null != layout && UtilMethods.isSet(layout.getId())) {\n+                if (!roleAPI.hasLayoutToRole(layout, role)) {\n+\n+                    roleAPI.addLayoutToRole(layout, role);\n+                    layoutsAdded.add(layout.getId());\n+                }\n+            }\n+        }\n+\n+        //Send a websocket event to notificate a layout change\n+        systemEventsAPI.pushAsync(SystemEventType.UPDATE_PORTLET_LAYOUTS, new Payload(layoutsAdded));\n+\n+        return layoutsAdded;\n+    }\n+\n+    /**\n+     * Saves only the existing layouts on layoutIds, any issue previous added not in the list will be removed\n+     * @param role\n+     * @param layoutIds\n+     * @param layoutAPI\n+     * @param roleAPI\n+     * @param systemEventsAPI\n+     * @throws DotDataException\n+     */\n+    @WrapInTransaction\n+    public List<String> deleteRoleLayouts(final Role role, final Set<String> layoutIds,\n+                                        final LayoutAPI layoutAPI, final RoleAPI roleAPI,\n+                                        final SystemEventsAPI systemEventsAPI) throws DotDataException {\n+\n+        final List<String> layoutsDeleted = new ArrayList<>();\n+        // Delete layout new layouts\n+        for(final String toDeleteLayout : layoutIds) {\n+\n+            final Layout layout = layoutAPI.findLayout(toDeleteLayout);\n+            if (null != layout && UtilMethods.isSet(layout.getId())) {\n+                if (roleAPI.hasLayoutToRole(layout, role)) {", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjUzMQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512531", "bodyText": "Issue found: Field layoutIds has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:12Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleLayoutForm.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.dotcms.rest.api.v1.system.role;\n+\n+import com.dotcms.rest.api.Validated;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+import java.util.Set;\n+\n+@JsonDeserialize(builder = RoleLayoutForm.Builder.class)\n+public class RoleLayoutForm extends Validated {\n+\n+    private final String roleId;\n+    private final Set<String> layoutIds;\n+\n+    private RoleLayoutForm(final RoleLayoutForm.Builder builder) {\n+        roleId    = builder.roleId;\n+        layoutIds = builder.layoutIds;\n+        checkValid();\n+    }\n+\n+    public String getRoleId() {\n+        return this.roleId;\n+    }\n+\n+    public Set<String> getLayoutIds() {\n+        return this.layoutIds;\n+    }\n+\n+    public static final class Builder {\n+\n+        @JsonProperty(required = true)\n+        private String roleId;\n+        @JsonProperty(required = true)\n+        private Set<String> layoutIds;", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjUzNQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512535", "bodyText": "Issue found: The String literal \"yyy\" appears 15 times in this file; the first occurrence is on line 30", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:13Z", "path": "dotCMS/src/integration-test/java/com/liferay/portal/ejb/UserPersistenceTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.liferay.portal.ejb;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.liferay.portal.model.User;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * Unit test for the {@link UserPersistence}\n+ */\n+public class UserPersistenceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void test_diff_same_user_nodiff()  {\n+\n+        final UserPersistence userPersistence = new UserPersistence();\n+        final UserHBM userHBM = new UserHBM();\n+        final User    user    = new User();\n+\n+        userHBM.setPassword(\"xxx\");\n+        user.setPassword(\"xxx\");\n+\n+        userHBM.setCompanyId(\"yyy\");", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjU0Mg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512542", "bodyText": "Issue found: The String literal \"dotcms.org.1\" appears 7 times in this file; the first occurrence is on line 64", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:14Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ResetPasswordResourceIntegrationTest.java", "diffHunk": "@@ -55,12 +59,13 @@ public void initTest(){\n     }\n \n     @Test\n-    public void testNoSuchUserException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException, SystemException, PortalException {\n+    public void testNoSuchUserException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException, SystemException, PortalException, DotDataException {\n         UserManager userManager = getUserManagerThrowingException( new NoSuchUserException(\"\") );\n+        final User user = APILocator.getUserAPI().loadUserById(\"dotcms.org.1\");", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjU0NA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512544", "bodyText": "Issue found: Avoid variables with short names like id", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:15Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -65,8 +66,8 @@ public UserToken(final String id, final String subject, final String issuer, fin\n      * @param subject - The subject of the token\n      * @param ttlMillis - The expiration date of the token.\n      */\n-    public UserToken(String id, String subject, Date modificationDate, long ttlMillis) {\n-        this(id, subject, ClusterFactory.getClusterId(), modificationDate,ttlMillis, ImmutableMap.of());\n+    public UserToken(String id, String subject, Date modificationDate, long ttlMillis, final String skinId) {", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjU0OQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r392512549", "bodyText": "Issue found: The String literal \"iii\" appears 15 times in this file; the first occurrence is on line 36", "author": "dev-dotcms", "createdAt": "2020-03-13T22:25:16Z", "path": "dotCMS/src/integration-test/java/com/liferay/portal/ejb/UserPersistenceTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.liferay.portal.ejb;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.liferay.portal.model.User;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * Unit test for the {@link UserPersistence}\n+ */\n+public class UserPersistenceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test\n+    public void test_diff_same_user_nodiff()  {\n+\n+        final UserPersistence userPersistence = new UserPersistence();\n+        final UserHBM userHBM = new UserHBM();\n+        final User    user    = new User();\n+\n+        userHBM.setPassword(\"xxx\");\n+        user.setPassword(\"xxx\");\n+\n+        userHBM.setCompanyId(\"yyy\");\n+        user.setCompanyId(\"yyy\");\n+\n+        userHBM.setEmailAddress(\"eee\");\n+        user.setEmailAddress(\"eee\");\n+\n+        userHBM.setLayoutIds(\"iii\");", "originalCommit": "154ca366fca64ad6dcc0940d821fe622c5ea9f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b9de60c3b448d5b2cd4567bedbd82eeb21c63503", "url": "https://github.com/dotCMS/core/commit/b9de60c3b448d5b2cd4567bedbd82eeb21c63503", "message": "#18101 refactor, fixes and unit test", "committedDate": "2020-03-17T06:11:15Z", "type": "commit"}, {"oid": "00288f35d8562deb8536c368deb5b3d2668fd5cb", "url": "https://github.com/dotCMS/core/commit/00288f35d8562deb8536c368deb5b3d2668fd5cb", "message": "#18101 adding fixes for the codacy feedback and some unit test fixes", "committedDate": "2020-03-17T20:02:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NDcyNQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394494725", "bodyText": "Tests and Doc regarding this new Resource", "author": "erickgonzalez", "createdAt": "2020-03-18T16:50:28Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleResource.java", "diffHunk": "@@ -1,26 +1,36 @@\n package com.dotcms.rest.api.v1.system.role;\n \n-import static com.dotcms.util.CollectionsUtils.list;\n-import static com.dotcms.util.CollectionsUtils.map;\n-\n import com.dotcms.repackage.com.google.common.annotations.VisibleForTesting;\n import com.dotcms.rest.InitDataObject;\n import com.dotcms.rest.ResponseEntityView;\n import com.dotcms.rest.WebResource;\n import com.dotcms.rest.exception.mapper.ExceptionMapperUtil;\n import com.dotmarketing.business.APILocator;\n import com.dotmarketing.business.ApiProvider;\n+import com.dotmarketing.business.LayoutAPI;\n+import com.dotmarketing.business.Role;\n import com.dotmarketing.business.RoleAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.user.ajax.UserAjax;\n import com.dotmarketing.util.Logger;\n-import java.io.Serializable;\n+import com.dotmarketing.util.SecurityLogger;\n+\n import javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.DELETE;\n import javax.ws.rs.GET;\n+import javax.ws.rs.POST;\n import javax.ws.rs.Path;\n import javax.ws.rs.PathParam;\n import javax.ws.rs.Produces;\n import javax.ws.rs.core.Context;\n import javax.ws.rs.core.Response;\n+import java.io.Serializable;\n+import java.util.Set;\n+\n+import static com.dotcms.util.CollectionsUtils.list;\n+import static com.dotcms.util.CollectionsUtils.map;", "originalCommit": "b9de60c3b448d5b2cd4567bedbd82eeb21c63503", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxODA4MA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394518080", "bodyText": "Looks like wrong javadoc. Should be \"Deletes\" etc...", "author": "dsilvam", "createdAt": "2020-03-18T17:25:44Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleResource.java", "diffHunk": "@@ -98,7 +109,109 @@ public Response checkRoles(final @Context HttpServletRequest request,\n \t\t\tLogger.error(this, \"An error occurred when processing the request.\", e);\n \t\t\treturn ExceptionMapperUtil.createResponse(e, Response.Status.INTERNAL_SERVER_ERROR);\n \t\t}\n+\n \t\treturn Response.ok(new ResponseEntityView(map(\"checkRoles\", hasUserRole))).build();\n \t}\n \n+\t/**\n+\t * Saves set of layout into a role\n+\t * The user must have to be a BE and has to have access to roles portlet\n+\t */\n+\t@DELETE", "originalCommit": "b9de60c3b448d5b2cd4567bedbd82eeb21c63503", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxODczMQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394518731", "bodyText": "Also wrong javadoc here", "author": "dsilvam", "createdAt": "2020-03-18T17:26:45Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleResource.java", "diffHunk": "@@ -98,7 +109,109 @@ public Response checkRoles(final @Context HttpServletRequest request,\n \t\t\tLogger.error(this, \"An error occurred when processing the request.\", e);\n \t\t\treturn ExceptionMapperUtil.createResponse(e, Response.Status.INTERNAL_SERVER_ERROR);\n \t\t}\n+\n \t\treturn Response.ok(new ResponseEntityView(map(\"checkRoles\", hasUserRole))).build();\n \t}\n \n+\t/**\n+\t * Saves set of layout into a role\n+\t * The user must have to be a BE and has to have access to roles portlet\n+\t */\n+\t@DELETE\n+\t@Path(\"/layouts\")\n+\t@Produces(\"application/json\")\n+\tpublic Response deleteRoleLayouts(\n+\t\t\tfinal @Context HttpServletRequest request,\n+\t\t\tfinal @Context HttpServletResponse response,\n+\t\t\tfinal RoleLayoutForm roleLayoutForm) throws DotDataException, DotSecurityException {\n+\n+\t\tfinal InitDataObject initDataObject = new WebResource.InitBuilder()\n+\t\t\t\t.requiredFrontendUser(false).rejectWhenNoUser(true)\n+\t\t\t\t.requiredBackendUser(true).requiredPortlet(\"roles\")\n+\t\t\t\t.requestAndResponse(request, response).init();\n+\n+\t\tif (this.roleAPI.doesUserHaveRole(initDataObject.getUser(), this.roleAPI.loadCMSAdminRole())) {\n+\n+\t\t\tfinal String roleId         = roleLayoutForm.getRoleId();\n+\t\t\tfinal Set<String> layoutIds = roleLayoutForm.getLayoutIds();\n+\t\t\tfinal Role role \t\t\t= roleAPI.loadRoleById(roleId);\n+\t\t\tfinal LayoutAPI layoutAPI   = APILocator.getLayoutAPI();\n+\n+\t\t\tLogger.debug(this, ()-> \"Deleting the layouts : \" + layoutIds + \" to the role: \" + roleId);\n+\n+\t\t\treturn Response.ok(new ResponseEntityView(map(\"deletedLayouts\",\n+\t\t\t\t\tthis.roleHelper.deleteRoleLayouts(role, layoutIds, layoutAPI,\n+\t\t\t\t\t\t\tthis.roleAPI, APILocator.getSystemEventsAPI())))).build();\n+\t\t} else {\n+\n+\t\t\tfinal String remoteIp = request.getRemoteHost();\n+\t\t\tSecurityLogger.logInfo(UserAjax.class, \"unauthorized attempt to call delete role layouts by user \"+\n+\t\t\t\t\tinitDataObject.getUser().getUserId() + \" from \" + remoteIp);\n+\t\t\tthrow new DotSecurityException(\"User: '\" +  initDataObject.getUser().getUserId() + \"' not authorized\");\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Saves set of layout into a role\n+\t * The user must have to be a BE and has to have access to roles portlet\n+\t */\n+\t@POST\n+\t@Path(\"/layouts\")\n+\t@Produces(\"application/json\")\n+\tpublic Response saveRoleLayouts(\n+\t\t\tfinal @Context HttpServletRequest request,\n+\t\t\tfinal @Context HttpServletResponse response,\n+\t\t\tfinal RoleLayoutForm roleLayoutForm) throws DotDataException, DotSecurityException {\n+\n+\t\tfinal InitDataObject initDataObject = new WebResource.InitBuilder(this.webResource)\n+\t\t\t\t.requiredFrontendUser(false).rejectWhenNoUser(true)\n+\t\t\t\t.requiredBackendUser(true).requiredPortlet(\"roles\")\n+\t\t\t\t.requestAndResponse(request, response).init();\n+\n+\t\tif (this.roleAPI.doesUserHaveRole(initDataObject.getUser(), this.roleAPI.loadCMSAdminRole())) {\n+\n+\t\t\tfinal String roleId         = roleLayoutForm.getRoleId();\n+\t\t\tfinal Set<String> layoutIds = roleLayoutForm.getLayoutIds();\n+\t\t\tfinal Role role \t\t\t= roleAPI.loadRoleById(roleId);\n+\t\t\tfinal LayoutAPI layoutAPI   = APILocator.getLayoutAPI();\n+\n+\t\t\tLogger.debug(this, ()-> \"Saving the layouts : \" + layoutIds + \" to the role: \" + roleId);\n+\n+\t\t\treturn Response.ok(new ResponseEntityView(map(\"savedLayouts\",\n+\t\t\t\t\tthis.roleHelper.saveRoleLayouts(role, layoutIds, layoutAPI,\n+\t\t\t\t\t\t\tthis.roleAPI, APILocator.getSystemEventsAPI())))).build();\n+\t\t} else {\n+\n+\t\t\tfinal String remoteIp = request.getRemoteHost();\n+\t\t\tSecurityLogger.logInfo(UserAjax.class, \"unauthorized attempt to call save role layouts by user \"+\n+\t\t\t\t\tinitDataObject.getUser().getUserId() + \" from \" + remoteIp);\n+\t\t\tthrow new DotSecurityException(\"User: '\" +  initDataObject.getUser().getUserId() + \"' not authorized\");\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Saves set of layout into a role\n+\t * The user must have to be a BE and has to have access to roles portlet\n+\t */\n+\t@GET", "originalCommit": "b9de60c3b448d5b2cd4567bedbd82eeb21c63503", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f004e218c84269bfff4c49d70f46953ce9764b89", "url": "https://github.com/dotCMS/core/commit/f004e218c84269bfff4c49d70f46953ce9764b89", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18101-jwt-userinvalidation", "committedDate": "2020-03-18T17:51:29Z", "type": "commit"}, {"oid": "77d7159e564b36b33448b2164110f8b99efcdfb6", "url": "https://github.com/dotCMS/core/commit/77d7159e564b36b33448b2164110f8b99efcdfb6", "message": "#18101 fixing unit test", "committedDate": "2020-03-18T19:42:02Z", "type": "commit"}, {"oid": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "url": "https://github.com/dotCMS/core/commit/4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "message": "#18101 part of the review check", "committedDate": "2020-03-18T20:04:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTQxMw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611413", "bodyText": "Issue found: Field companyId has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:04Z", "path": "dotCMS/src/integration-test/java/com/dotcms/datagen/UserDataGen.java", "diffHunk": "@@ -22,6 +23,8 @@\n     private String lastName = \"testLastName\" + currentTime;\n     private String emailAddress = \"testEmailAddress@\" + currentTime + \".com\";\n     private String password = String.valueOf(currentTime);\n+    private String skinIdentifier = UUIDGenerator.generateUuid();\n+    private String companyId = UUIDGenerator.generateUuid();", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTQyMg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611422", "bodyText": "Issue found: These nested if statements could be combined", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:05Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleHelper.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.dotcms.rest.api.v1.system.role;\n+\n+import com.dotcms.api.system.event.Payload;\n+import com.dotcms.api.system.event.SystemEventType;\n+import com.dotcms.api.system.event.SystemEventsAPI;\n+import com.dotcms.business.WrapInTransaction;\n+import com.dotmarketing.business.Layout;\n+import com.dotmarketing.business.LayoutAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.business.RoleAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Helper to encapsulate Roles logic\n+ * @author jsanca\n+ */\n+public class RoleHelper {\n+\n+    /**\n+     * Saves only the existing layouts on layoutIds, any issue previous added not in the list will be removed\n+     * @param role\n+     * @param layoutIds\n+     * @param layoutAPI\n+     * @param roleAPI\n+     * @param systemEventsAPI\n+     * @throws DotDataException\n+     */\n+    @WrapInTransaction\n+    public List<String> saveRoleLayouts(final Role role, final Set<String> layoutIds,\n+                                final LayoutAPI layoutAPI, final RoleAPI roleAPI,\n+                                final SystemEventsAPI systemEventsAPI) throws DotDataException {\n+\n+        final List<Layout> layouts      = layoutAPI.loadLayoutsForRole(role);\n+        final List<String> layoutsAdded = new ArrayList<>();\n+        final Map<String, Layout> currentLayoutMaps = layouts.stream().collect(\n+                Collectors.toMap(layout -> layout.getId(), layout -> layout));\n+\n+        //Remove all layouts not included in the layoutIds list\n+        layoutIds.forEach(layoutId -> currentLayoutMaps.remove(layoutId));\n+        for(final Map.Entry<String, Layout> layoutToRemoveEntry : currentLayoutMaps.entrySet()) {\n+            roleAPI.removeLayoutFromRole(layoutToRemoveEntry.getValue(), role);\n+        }\n+\n+        // Add new layouts\n+        for(final String changedLayout : layoutIds) {\n+\n+            final Layout layout = layoutAPI.findLayout(changedLayout);\n+            if (null != layout && UtilMethods.isSet(layout.getId())) {\n+                if (!roleAPI.roleHasLayout(layout, role)) {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTQzMg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611432", "bodyText": "Issue found: Field layoutIds has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:06Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleLayoutForm.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.dotcms.rest.api.v1.system.role;\n+\n+import com.dotcms.rest.api.Validated;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+import java.util.Set;\n+\n+@JsonDeserialize(builder = RoleLayoutForm.Builder.class)\n+public class RoleLayoutForm extends Validated {\n+\n+    private final String roleId;\n+    private final Set<String> layoutIds;\n+\n+    private RoleLayoutForm(final RoleLayoutForm.Builder builder) {\n+        super();\n+        roleId    = builder.roleId;\n+        layoutIds = builder.layoutIds;\n+        checkValid();\n+    }\n+\n+    public String getRoleId() {\n+        return this.roleId;\n+    }\n+\n+    public Set<String> getLayoutIds() {\n+        return this.layoutIds;\n+    }\n+\n+    public static final class Builder {\n+\n+        @JsonProperty(required = true)\n+        private String roleId;\n+        @JsonProperty(required = true)\n+        private Set<String> layoutIds;", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTQzOQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611439", "bodyText": "Issue found: Avoid variables with short names like id", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:07Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTQ0Ng==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611446", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:08Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ResetPasswordResourceIntegrationTest.java", "diffHunk": "@@ -70,12 +72,14 @@ public void testNoSuchUserException() throws DotSecurityException, NoSuchUserExc\n     }\n \n     @Test\n-    public void testTokenInvalidException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException {\n+    public void testTokenInvalidException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException, DotDataException {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTQ1OQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611459", "bodyText": "Issue found: Field roleId has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:10Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleLayoutForm.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.dotcms.rest.api.v1.system.role;\n+\n+import com.dotcms.rest.api.Validated;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+import java.util.Set;\n+\n+@JsonDeserialize(builder = RoleLayoutForm.Builder.class)\n+public class RoleLayoutForm extends Validated {\n+\n+    private final String roleId;\n+    private final Set<String> layoutIds;\n+\n+    private RoleLayoutForm(final RoleLayoutForm.Builder builder) {\n+        super();\n+        roleId    = builder.roleId;\n+        layoutIds = builder.layoutIds;\n+        checkValid();\n+    }\n+\n+    public String getRoleId() {\n+        return this.roleId;\n+    }\n+\n+    public Set<String> getLayoutIds() {\n+        return this.layoutIds;\n+    }\n+\n+    public static final class Builder {\n+\n+        @JsonProperty(required = true)\n+        private String roleId;", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTQ3Ng==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611476", "bodyText": "Issue found: Avoid using short method names", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:11Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;\n+        @JsonProperty(required = true)  private String subject;\n+        @JsonProperty(required = true)  private String issuer = ClusterFactory.getClusterId();\n+        @JsonProperty(required = true)  private Date   modificationDate = new Date();\n+        @JsonProperty(required = true)  private Date   expiresDate;\n+        @JsonProperty(required = true)  private ImmutableMap<String,Object> claims = ImmutableMap.of();\n \n+        public UserToken.Builder id(final String id) {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTQ5Mg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611492", "bodyText": "Issue found: Local variable 'jsonWebToken' could be declared final", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:12Z", "path": "dotCMS/src/integration-test/java/com/dotcms/auth/providers/jwt/JsonWebTokenUtilsIntegrationTest.java", "diffHunk": "@@ -102,10 +110,13 @@ public void get_user_in_token_modified()\n                 JsonWebTokenFactory.getInstance().getJsonWebTokenService();\n         assertNotNull(jsonWebTokenService);\n \n+        final String jwtId = APILocator.getUserAPI().loadUserById(userId).getRememberMeToken();\n         //Generate a new token\n-        String jsonWebToken = jsonWebTokenService.generateUserToken(new UserToken(jwtId,\n-                userId, date, DateUtil.daysToMillis(2)\n-        ));\n+        final UserToken userToken = new UserToken.Builder().id(jwtId).subject(userId).modificationDate(date)\n+                .expiresDate(DateUtil.daysToMillis(2))\n+                .build();\n+        String jsonWebToken = jsonWebTokenService.generateUserToken(userToken);", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTUwNQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611505", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:13Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ApiTokenResourceTest.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.dotcms.rest.api.v1.authentication;\n+\n+import com.dotcms.datagen.CompanyDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.rest.InitDataObject;\n+import com.dotcms.rest.RestUtilTest;\n+import com.dotcms.rest.WebResource;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.liferay.portal.NoSuchCompanyException;\n+import com.liferay.portal.SystemException;\n+import com.liferay.portal.ejb.CompanyUtil;\n+import com.liferay.portal.model.Company;\n+import com.liferay.portal.model.User;\n+import com.liferay.portal.util.WebKeys;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class ApiTokenResourceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTUxNQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611515", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:14Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ResetPasswordResourceIntegrationTest.java", "diffHunk": "@@ -55,12 +58,11 @@ public void initTest(){\n     }\n \n     @Test\n-    public void testNoSuchUserException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException, SystemException, PortalException {\n+    public void testNoSuchUserException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException,  DotDataException {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTUyNQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611525", "bodyText": "Issue found: Field modificationDate has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:15Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;\n+        @JsonProperty(required = true)  private String subject;\n+        @JsonProperty(required = true)  private String issuer = ClusterFactory.getClusterId();\n+        @JsonProperty(required = true)  private Date   modificationDate = new Date();", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTUzNw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611537", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Assert.assertNotNull' due to existing static import 'org.junit.Assert.assertNotNull'", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:16Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ApiTokenResourceTest.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.dotcms.rest.api.v1.authentication;\n+\n+import com.dotcms.datagen.CompanyDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.rest.InitDataObject;\n+import com.dotcms.rest.RestUtilTest;\n+import com.dotcms.rest.WebResource;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.liferay.portal.NoSuchCompanyException;\n+import com.liferay.portal.SystemException;\n+import com.liferay.portal.ejb.CompanyUtil;\n+import com.liferay.portal.model.Company;\n+import com.liferay.portal.model.User;\n+import com.liferay.portal.util.WebKeys;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class ApiTokenResourceTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Test()\n+    public void test_revokeUserToken_non_admin_user() throws DotDataException, DotSecurityException {\n+\n+        final String skinId    = UUIDGenerator.generateUuid();\n+        final User limitedUser = new UserDataGen().active(true)\n+                .skinId(skinId).nextPersisted();\n+        final HttpServletRequest  request  = mock(HttpServletRequest.class);\n+        final HttpServletResponse response = mock(HttpServletResponse.class);\n+        final WebResource      webResource = mock(WebResource.class);\n+        final ApiTokenResource apiTokenResource = new ApiTokenResource(APILocator.getApiTokenAPI(), webResource);\n+\n+        when(request.getAttribute(WebKeys.USER)).thenReturn(limitedUser);\n+        final InitDataObject initDataObject = new InitDataObject();\n+        initDataObject.setUser(limitedUser);\n+        when(webResource.init(any(WebResource.InitBuilder.class))).thenReturn(initDataObject);\n+        final Response restResponse = apiTokenResource.revokeUserToken(request, response, limitedUser.getUserId());\n+        Assert.assertNotNull(restResponse);\n+        RestUtilTest.verifyErrorResponse(restResponse,  Response.Status.UNAUTHORIZED.getStatusCode(), \"unauthorized to remove the token\");\n+    }\n+\n+    @Test\n+    public void test_revokeUserToken() throws DotSecurityException, DotDataException, SystemException, NoSuchCompanyException {\n+\n+        // 1) create an user with skinid\n+        // 2) call the revoke to reset the user\n+        // 3) check the user has the skinid reset\n+\n+        final Company company = new CompanyDataGen()\n+                .name(\"TestCompany\")\n+                .shortName(\"TC\")\n+                .authType(\"email\")\n+                .autoLogin(true)\n+                .emailAddress(\"lol@dotCMS.com\")\n+                .homeURL(\"localhost\")\n+                .city(\"NYC\")\n+                .mx(\"MX\")\n+                .type(\"test\")\n+                .phone(\"5552368\")\n+                .portalURL(\"/portalURL\")\n+                .nextPersisted();\n+        assertNotNull(company.getCompanyId());\n+        final Company retrievedCompany =  CompanyUtil.findByPrimaryKey(company.getCompanyId());\n+        assertEquals(company.getCompanyId(), retrievedCompany.getCompanyId());\n+\n+        final String skinId    = UUIDGenerator.generateUuid();\n+        final User limitedUser = new UserDataGen().active(true)\n+                .skinId(skinId).companyId(retrievedCompany.getCompanyId()).nextPersisted();\n+\n+        final User adminUser = new UserDataGen().nextPersisted();\n+        APILocator.getRoleAPI().addRoleToUser(APILocator.getRoleAPI().loadCMSAdminRole(), adminUser);\n+        assertTrue(APILocator.getUserAPI().isCMSAdmin(adminUser));\n+\n+        final HttpServletRequest  request  = mock(HttpServletRequest.class);\n+        final HttpServletResponse response = mock(HttpServletResponse.class);\n+        final WebResource      webResource = mock(WebResource.class);\n+        final ApiTokenResource apiTokenResource = new ApiTokenResource(APILocator.getApiTokenAPI(), webResource);\n+\n+        when(request.getAttribute(WebKeys.USER)).thenReturn(adminUser);\n+        final InitDataObject initDataObject = new InitDataObject();\n+        initDataObject.setUser(adminUser);\n+        when(webResource.init(any(WebResource.InitBuilder.class))).thenReturn(initDataObject);\n+        final Response restResponse = apiTokenResource.revokeUserToken(request, response, limitedUser.getUserId());\n+        Assert.assertNotNull(restResponse);", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTU0NA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611544", "bodyText": "Issue found: These nested if statements could be combined", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:17Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/role/RoleHelper.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.dotcms.rest.api.v1.system.role;\n+\n+import com.dotcms.api.system.event.Payload;\n+import com.dotcms.api.system.event.SystemEventType;\n+import com.dotcms.api.system.event.SystemEventsAPI;\n+import com.dotcms.business.WrapInTransaction;\n+import com.dotmarketing.business.Layout;\n+import com.dotmarketing.business.LayoutAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.business.RoleAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.util.UtilMethods;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Helper to encapsulate Roles logic\n+ * @author jsanca\n+ */\n+public class RoleHelper {\n+\n+    /**\n+     * Saves only the existing layouts on layoutIds, any issue previous added not in the list will be removed\n+     * @param role\n+     * @param layoutIds\n+     * @param layoutAPI\n+     * @param roleAPI\n+     * @param systemEventsAPI\n+     * @throws DotDataException\n+     */\n+    @WrapInTransaction\n+    public List<String> saveRoleLayouts(final Role role, final Set<String> layoutIds,\n+                                final LayoutAPI layoutAPI, final RoleAPI roleAPI,\n+                                final SystemEventsAPI systemEventsAPI) throws DotDataException {\n+\n+        final List<Layout> layouts      = layoutAPI.loadLayoutsForRole(role);\n+        final List<String> layoutsAdded = new ArrayList<>();\n+        final Map<String, Layout> currentLayoutMaps = layouts.stream().collect(\n+                Collectors.toMap(layout -> layout.getId(), layout -> layout));\n+\n+        //Remove all layouts not included in the layoutIds list\n+        layoutIds.forEach(layoutId -> currentLayoutMaps.remove(layoutId));\n+        for(final Map.Entry<String, Layout> layoutToRemoveEntry : currentLayoutMaps.entrySet()) {\n+            roleAPI.removeLayoutFromRole(layoutToRemoveEntry.getValue(), role);\n+        }\n+\n+        // Add new layouts\n+        for(final String changedLayout : layoutIds) {\n+\n+            final Layout layout = layoutAPI.findLayout(changedLayout);\n+            if (null != layout && UtilMethods.isSet(layout.getId())) {\n+                if (!roleAPI.roleHasLayout(layout, role)) {\n+\n+                    roleAPI.addLayoutToRole(layout, role);\n+                    layoutsAdded.add(layout.getId());\n+                }\n+            }\n+        }\n+\n+        //Send a websocket event to notificate a layout change\n+        systemEventsAPI.pushAsync(SystemEventType.UPDATE_PORTLET_LAYOUTS, new Payload(layoutsAdded));\n+\n+        return layoutsAdded;\n+    }\n+\n+    /**\n+     * Saves only the existing layouts on layoutIds, any issue previous added not in the list will be removed\n+     * @param role\n+     * @param layoutIds\n+     * @param layoutAPI\n+     * @param roleAPI\n+     * @param systemEventsAPI\n+     * @throws DotDataException\n+     */\n+    @WrapInTransaction\n+    public List<String> deleteRoleLayouts(final Role role, final Set<String> layoutIds,\n+                                        final LayoutAPI layoutAPI, final RoleAPI roleAPI,\n+                                        final SystemEventsAPI systemEventsAPI) throws DotDataException {\n+\n+        final List<String> layoutsDeleted = new ArrayList<>();\n+        // Delete layout new layouts\n+        for(final String toDeleteLayout : layoutIds) {\n+\n+            final Layout layout = layoutAPI.findLayout(toDeleteLayout);\n+            if (null != layout && UtilMethods.isSet(layout.getId())) {\n+                if (roleAPI.roleHasLayout(layout, role)) {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTU1Nw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611557", "bodyText": "Issue found: Field claims has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:19Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;\n+        @JsonProperty(required = true)  private String subject;\n+        @JsonProperty(required = true)  private String issuer = ClusterFactory.getClusterId();\n+        @JsonProperty(required = true)  private Date   modificationDate = new Date();\n+        @JsonProperty(required = true)  private Date   expiresDate;\n+        @JsonProperty(required = true)  private ImmutableMap<String,Object> claims = ImmutableMap.of();", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTU3Mg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611572", "bodyText": "Issue found: Field subject has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:20Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;\n+        @JsonProperty(required = true)  private String subject;", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTU4Mw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611583", "bodyText": "Issue found: Avoid variables with short names like id", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:21Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;\n+        @JsonProperty(required = true)  private String subject;\n+        @JsonProperty(required = true)  private String issuer = ClusterFactory.getClusterId();\n+        @JsonProperty(required = true)  private Date   modificationDate = new Date();\n+        @JsonProperty(required = true)  private Date   expiresDate;\n+        @JsonProperty(required = true)  private ImmutableMap<String,Object> claims = ImmutableMap.of();\n \n+        public UserToken.Builder id(final String id) {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTU5MA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611590", "bodyText": "Issue found: Field expiresDate has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:22Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;\n+        @JsonProperty(required = true)  private String subject;\n+        @JsonProperty(required = true)  private String issuer = ClusterFactory.getClusterId();\n+        @JsonProperty(required = true)  private Date   modificationDate = new Date();\n+        @JsonProperty(required = true)  private Date   expiresDate;", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTYwMQ==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611601", "bodyText": "Issue found: Field id has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:23Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTYwNg==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611606", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:24Z", "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/authentication/ResetPasswordResourceIntegrationTest.java", "diffHunk": "@@ -84,12 +88,12 @@ public void testTokenInvalidException() throws DotSecurityException, NoSuchUserE\n     }\n \n     @Test\n-    public void testTokenExpiredException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException {\n+    public void testTokenExpiredException() throws DotSecurityException, NoSuchUserException, DotInvalidTokenException, DotDataException {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTYxNw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611617", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:25Z", "path": "dotCMS/src/integration-test/java/com/liferay/portal/ejb/UserPersistenceTest.java", "diffHunk": "@@ -0,0 +1,225 @@\n+package com.liferay.portal.ejb;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.liferay.portal.model.User;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * Unit test for the {@link UserPersistence}\n+ */\n+public class UserPersistenceTest {\n+\n+    private static final String TOKEN_XXX = \"xxx\";\n+    private static final String TOKEN_YYY = \"yyy\";\n+    private static final String TOKEN_EEE = \"eee\";\n+    private static final String TOKEN_III = \"iii\";\n+    private static final String TOKEN_USER_ID = \"111\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception{", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTYzMA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611630", "bodyText": "Issue found: Field issuer has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:26Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/beans/UserToken.java", "diffHunk": "@@ -186,5 +212,50 @@ public String getUserId() {\n         return this.subject;\n     }\n \n+    public static final class Builder {\n+        @JsonProperty(required = true)  private String id;\n+        @JsonProperty(required = true)  private String subject;\n+        @JsonProperty(required = true)  private String issuer = ClusterFactory.getClusterId();", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTYzOA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r394611638", "bodyText": "Issue found: Local variable 'jsonWebToken' could be declared final", "author": "dev-dotcms", "createdAt": "2020-03-18T20:12:27Z", "path": "dotCMS/src/integration-test/java/com/dotcms/auth/providers/jwt/services/JsonWebTokenServiceIntegrationTest.java", "diffHunk": "@@ -56,18 +56,26 @@ public static void prepare() throws Exception {\n      * Testing the generateToken JsonWebTokenServiceTest\n      */\n     @Test\n-    public void generateTokenTest() {\n+    public void generateTokenTest() throws DotSecurityException, DotDataException {\n \n+        final User user = APILocator.getUserAPI().loadUserById(userId);\n         //Generate a new token\n-        String jsonWebToken = jsonWebTokenService.generateUserToken(new UserToken(jwtId,\n-                userId, new Date(), DateUtil.daysToMillis(2)));\n+        final String jwtokenId    = user.getRememberMeToken();\n+        final UserToken userToken = new UserToken.Builder()\n+                .id(jwtokenId)\n+                .subject(userId)\n+                .issuer(clusterId)\n+                .expiresDate(DateUtil.daysToMillis(2))\n+                .claims(ImmutableMap.of())\n+                .build();\n+        String jsonWebToken = jsonWebTokenService.generateUserToken(userToken);", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEyMTkyNw==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r395121927", "bodyText": "uuid could be null - should we NPE check here?", "author": "wezell", "createdAt": "2020-03-19T15:39:19Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/factories/JsonWebTokenFactory.java", "diffHunk": "@@ -273,13 +268,17 @@ private JWToken validateToken(final Jws<Claims> jws, final JWToken jwtToken, fin\n             }\n             \n             if(jwtToken.getTokenType() == TokenType.USER_TOKEN) {\n-                if(jwtToken.getModificationDate().before(user.getModificationDate())) {\n-                    IncorrectClaimException claimException = new IncorrectClaimException( jws.getHeader(), body, \"JWT Token user: \" + jwtToken.getUserId() + \" has been modified, old tokens are invalid\");\n+\n+                final String uuid = jwtToken.getId();\n+\n+                if (!uuid.equals(user.getRememberMeToken())) {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1MDg4OA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r395150888", "bodyText": "Does this need a @closedb annotation?", "author": "wezell", "createdAt": "2020-03-19T16:19:10Z", "path": "dotCMS/src/main/java/com/dotmarketing/business/RoleFactoryImpl.java", "diffHunk": "@@ -615,6 +617,22 @@ protected void addLayoutToRole(Layout layout, Role role) throws DotDataException\n \t\trc.removeLayoutsOnRole(role.getId());\n \t}\n \n+\t@Override\n+\tprotected Optional<LayoutsRoles> findLayoutsRole(final Layout layout, final Role role) {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1MjM1MA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r395152350", "bodyText": "fwiw, we don't really support multiple companies.  Not sure what the ramifications of this are.", "author": "wezell", "createdAt": "2020-03-19T16:21:20Z", "path": "dotCMS/src/integration-test/java/com/dotcms/auth/providers/jwt/factories/ApiTokenAPITest.java", "diffHunk": "@@ -357,7 +361,26 @@ public void test_expired_ApiToken() throws Exception {\n     @Test\n     public void test_user_must_be_active_to_validate_ApiToken() throws Exception {\n \n-        User user = new UserDataGen().nextPersisted();\n+        final Company company = new CompanyDataGen()", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1MzI4OA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r395153288", "bodyText": "Why not use default company?  Will this break other tests using this?", "author": "wezell", "createdAt": "2020-03-19T16:22:36Z", "path": "dotCMS/src/integration-test/java/com/dotcms/datagen/UserDataGen.java", "diffHunk": "@@ -22,6 +23,8 @@\n     private String lastName = \"testLastName\" + currentTime;\n     private String emailAddress = \"testEmailAddress@\" + currentTime + \".com\";\n     private String password = String.valueOf(currentTime);\n+    private String skinIdentifier = UUIDGenerator.generateUuid();\n+    private String companyId = UUIDGenerator.generateUuid();", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1NDk5OA==", "url": "https://github.com/dotCMS/core/pull/18131#discussion_r395154998", "bodyText": "Can uuid =null?  I think we should null check here.", "author": "wezell", "createdAt": "2020-03-19T16:25:05Z", "path": "dotCMS/src/main/java/com/dotcms/auth/providers/jwt/factories/JsonWebTokenFactory.java", "diffHunk": "@@ -273,13 +268,17 @@ private JWToken validateToken(final Jws<Claims> jws, final JWToken jwtToken, fin\n             }\n             \n             if(jwtToken.getTokenType() == TokenType.USER_TOKEN) {\n-                if(jwtToken.getModificationDate().before(user.getModificationDate())) {\n-                    IncorrectClaimException claimException = new IncorrectClaimException( jws.getHeader(), body, \"JWT Token user: \" + jwtToken.getUserId() + \" has been modified, old tokens are invalid\");\n+\n+                final String uuid = jwtToken.getId();\n+\n+                if (!uuid.equals(user.getRememberMeToken())) {", "originalCommit": "4d85b789d7d8b3edd9be7f65709b9bc4326ee2a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}