{"pr_number": 18825, "pr_title": "Issue 18744 global urlmaps", "pr_createdAt": "2020-07-02T18:50:36Z", "pr_url": "https://github.com/dotCMS/core/pull/18825", "timeline": [{"oid": "eca540bb0cb9ab0e660f55ba9dfd517a3bd024ee", "url": "https://github.com/dotCMS/core/commit/eca540bb0cb9ab0e660f55ba9dfd517a3bd024ee", "message": "Update dotcmsReleaseVersion and coreWebReleasion version", "committedDate": "2020-06-18T21:44:14Z", "type": "commit"}, {"oid": "b6fd2dd2719a54fd3e87a1d024249f46348ab3f8", "url": "https://github.com/dotCMS/core/commit/b6fd2dd2719a54fd3e87a1d024249f46348ab3f8", "message": "update release version", "committedDate": "2020-06-18T21:46:13Z", "type": "commit"}, {"oid": "039c6f05ab759ca542743d77cb9cb9412263295a", "url": "https://github.com/dotCMS/core/commit/039c6f05ab759ca542743d77cb9cb9412263295a", "message": "Update dotcms-webcomponents version", "committedDate": "2020-06-19T14:54:04Z", "type": "commit"}, {"oid": "293b443dc467e8b9b2b2deb5dbde474ebb2024ab", "url": "https://github.com/dotCMS/core/commit/293b443dc467e8b9b2b2deb5dbde474ebb2024ab", "message": "Merge remote-tracking branch 'origin/release-5.3.3'", "committedDate": "2020-06-19T15:21:06Z", "type": "commit"}, {"oid": "90d2504509bfe608d5a1e152f069b4bdce5c135e", "url": "https://github.com/dotCMS/core/commit/90d2504509bfe608d5a1e152f069b4bdce5c135e", "message": "Merge branch 'master' of https://github.com/dotCMS/core", "committedDate": "2020-06-22T13:18:20Z", "type": "commit"}, {"oid": "2f5ce7a444491e0ecc07287db51f27e68ba9417f", "url": "https://github.com/dotCMS/core/commit/2f5ce7a444491e0ecc07287db51f27e68ba9417f", "message": "#18744 initial commit", "committedDate": "2020-06-22T15:42:31Z", "type": "commit"}, {"oid": "1f86218dd7e32df7214b0055e22a51c4daecf75c", "url": "https://github.com/dotCMS/core/commit/1f86218dd7e32df7214b0055e22a51c4daecf75c", "message": "#18744 global urlmaps", "committedDate": "2020-06-22T16:18:49Z", "type": "commit"}, {"oid": "0ec1138a766579bb78d4b4c39a65b914f8883d8c", "url": "https://github.com/dotCMS/core/commit/0ec1138a766579bb78d4b4c39a65b914f8883d8c", "message": "erge remote-tracking branch 'origin/master' into issue-18744-global-urlmaps", "committedDate": "2020-06-30T15:56:53Z", "type": "commit"}, {"oid": "b53d82930ba3ee645a8d605f81863c162328d1d6", "url": "https://github.com/dotCMS/core/commit/b53d82930ba3ee645a8d605f81863c162328d1d6", "message": "Merge remote-tracking branch 'origin/master' into issue-18744-global-urlmaps", "committedDate": "2020-06-30T22:12:38Z", "type": "commit"}, {"oid": "56181a8999a04c8424de2294940aedb49e294aa0", "url": "https://github.com/dotCMS/core/commit/56181a8999a04c8424de2294940aedb49e294aa0", "message": "#18744 updating to master", "committedDate": "2020-06-30T22:16:16Z", "type": "commit"}, {"oid": "bbdb412b0eb9fbdc1fa20eea55306a78f3826bd6", "url": "https://github.com/dotCMS/core/commit/bbdb412b0eb9fbdc1fa20eea55306a78f3826bd6", "message": "#18744 global urlmap", "committedDate": "2020-06-30T23:42:32Z", "type": "commit"}, {"oid": "9a6abb1efe6fe3711c6a771fc34a4507acdb24c4", "url": "https://github.com/dotCMS/core/commit/9a6abb1efe6fe3711c6a771fc34a4507acdb24c4", "message": "Merge remote-tracking branch 'origin/master' into issue-18744-global-urlmaps", "committedDate": "2020-07-01T17:36:12Z", "type": "commit"}, {"oid": "bdf09c871d72b785c326d3b5e372504c8f144c00", "url": "https://github.com/dotCMS/core/commit/bdf09c871d72b785c326d3b5e372504c8f144c00", "message": "Merge remote-tracking branch 'origin/master' into issue-18744-global-urlmaps", "committedDate": "2020-07-01T17:43:39Z", "type": "commit"}, {"oid": "e656f3ade3817fd66ba647f1ce48b76cf37a89de", "url": "https://github.com/dotCMS/core/commit/e656f3ade3817fd66ba647f1ce48b76cf37a89de", "message": "#18744 tests for global urlmaps", "committedDate": "2020-07-02T17:56:09Z", "type": "commit"}, {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "url": "https://github.com/dotCMS/core/commit/cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "message": "#18744 fixing broken tests", "committedDate": "2020-07-03T11:41:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg0OQ==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542849", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-07-03T11:50:53Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();\n+        final Folder folder2 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host2).nextPersisted();\n+\n+\n+\n+        final Template template1 = new TemplateDataGen().site(host1).nextPersisted();\n+        final Template template2 = new TemplateDataGen().site(host2).nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost1 = new HTMLPageDataGen(folder1, template1).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost2 = new HTMLPageDataGen(folder2, template2).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final String urlPattern = \"/\" + UUIDGenerator.shorty() + \"/{urlTitle}\";\n+        \n+        // set the detail page to page on host1\n+        final ContentType contentType1 = getNewsLikeContentType(\"News\" + System.currentTimeMillis(),\n+                        APILocator.systemHost(), pageOnHost1.getIdentifier(), urlPattern);\n+\n+\n+        final Contentlet newsOnSystemHost = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(),\n+                        APILocator.systemHost(), null, UUIDGenerator.generateUuid());\n+\n+\n+        final Contentlet newsOnHost1 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host1,\n+                        null, UUIDGenerator.generateUuid());\n+\n+        final Contentlet newsOnHost2 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host2,\n+                        null, UUIDGenerator.generateUuid());\n+\n+\n+        \n+        // WORKS : trying where contentlet on the system host and request is on host1 \n+        UrlMapContext context = getUrlMapContext(systemUser, host1,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));\n+\n+        Optional<URLMapInfo> urlMapInfoOptional = urlMapAPI.processURLMap(context);\n+        URLMapInfo urlMapInfo = urlMapInfoOptional.get();\n+\n+        assertEquals(newsOnSystemHost.getStringProperty(\"title\"), urlMapInfo.getContentlet().getName());\n+        assertEquals(pageOnHost1.getURI(), urlMapInfo.getIdentifier().getURI());\n+        \n+\n+        // WORKS :  trying where contentlet on the system host and request is on host2, which also has a detail page in the right place\n+        context = getUrlMapContext(systemUser, host2,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));\n+\n+        urlMapInfoOptional = urlMapAPI.processURLMap(context);\n+        urlMapInfo = urlMapInfoOptional.get();\n+\n+        assertEquals(newsOnSystemHost.getStringProperty(\"title\"), urlMapInfo.getContentlet().getName());\n+        assertEquals(pageOnHost2.getURI(), urlMapInfo.getIdentifier().getURI());\n+        \n+        \n+        \n+        // FAIL : trying where contentlet on the system host and request is on host3, which does not have a detail page\n+        context = getUrlMapContext(systemUser, host3,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));\n+\n+        urlMapInfoOptional = urlMapAPI.processURLMap(context);\n+        assert(!urlMapInfoOptional.isPresent());", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg2MQ==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542861", "bodyText": "Codacy found an issue: StringBuffer (or StringBuilder).append is called consecutively without reusing the target variable.", "author": "dev-dotcms", "createdAt": "2020-07-03T11:50:54Z", "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -268,34 +256,40 @@ private void checkContentPermission(final UrlMapContext context, final Contentle\n                 contentlet, PermissionLevel.READ.getType(), context.getUser(), context.getMode().respectAnonPerms);\n \n         if (!havePermission) {\n-            throw new DotSecurityException(String.format(\"User dont have permission in content: %s\", contentlet.getName()));\n+            throw new DotSecurityException(String.format(\"User does not have permission in content: %s\", contentlet.getName()));\n         }\n     }\n \n     private String buildContentQuery(\n             final Matches matches,\n-            final Structure structure,\n-            final Field hostField,\n+            final ContentType structure,\n             final UrlMapContext context) {\n \n         final StringBuilder query = new StringBuilder();\n \n-        query.append(\"+structureName:\").append(structure.getVelocityVarName())\n-             .append(\" +deleted:false \");\n-\n-        if (context.getMode() == PageMode.PREVIEW_MODE || context.getMode() == PageMode.EDIT_MODE) {\n-            query.append(\"+working:true \");\n+        query.append(\"+contentType:\")\n+            .append(structure.variable())\n+            .append(\" +deleted:false \")\n+            .append(\" +(conhost:\")\n+                .append(context.getHost().getIdentifier())\n+                .append(\" OR conhost:\")\n+                .append(Host.SYSTEM_HOST)\n+            .append(\")\");\n+        \n+\n+        if (context.getMode().showLive) {\n+            query.append(\" +live:true \");\n         } else {\n-            query.append(\"+live:true \");\n+            query.append(\" +working:true \");\n         }\n \n-        if (null != hostField && context.getHost() != null) {\n-            query.append(this.getHostFilter(context.getHost()));\n-        }\n+\n \n         query.append(\" \");\n-        query.append(this.buildFields(structure, matches))\n-             .append(\" +languageId:\").append(context.getLanguageId());\n+        query.append(this.buildFields(structure, matches));", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg2NQ==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542865", "bodyText": "Codacy found an issue: StringBuffer (or StringBuilder).append is called 2 consecutive times with literals. Use a single append with a single combined String.", "author": "dev-dotcms", "createdAt": "2020-07-03T11:50:55Z", "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -268,34 +256,40 @@ private void checkContentPermission(final UrlMapContext context, final Contentle\n                 contentlet, PermissionLevel.READ.getType(), context.getUser(), context.getMode().respectAnonPerms);\n \n         if (!havePermission) {\n-            throw new DotSecurityException(String.format(\"User dont have permission in content: %s\", contentlet.getName()));\n+            throw new DotSecurityException(String.format(\"User does not have permission in content: %s\", contentlet.getName()));\n         }\n     }\n \n     private String buildContentQuery(\n             final Matches matches,\n-            final Structure structure,\n-            final Field hostField,\n+            final ContentType structure,\n             final UrlMapContext context) {\n \n         final StringBuilder query = new StringBuilder();\n \n-        query.append(\"+structureName:\").append(structure.getVelocityVarName())\n-             .append(\" +deleted:false \");\n-\n-        if (context.getMode() == PageMode.PREVIEW_MODE || context.getMode() == PageMode.EDIT_MODE) {\n-            query.append(\"+working:true \");\n+        query.append(\"+contentType:\")\n+            .append(structure.variable())\n+            .append(\" +deleted:false \")", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg3NA==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542874", "bodyText": "Codacy found an issue: The String literal \"my-detail\" appears 4 times in this file; the first occurrence is on line 118", "author": "dev-dotcms", "createdAt": "2020-07-03T11:50:56Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();\n+        final Folder folder2 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host2).nextPersisted();\n+\n+\n+\n+        final Template template1 = new TemplateDataGen().site(host1).nextPersisted();\n+        final Template template2 = new TemplateDataGen().site(host2).nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost1 = new HTMLPageDataGen(folder1, template1).pageURL(\"my-detail\")", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg4Mg==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542882", "bodyText": "Codacy found an issue: The String literal \"folder\" appears 4 times in this file; the first occurrence is on line 110", "author": "dev-dotcms", "createdAt": "2020-07-03T11:50:57Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg4OA==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542888", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-07-03T11:50:58Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg5OQ==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542899", "bodyText": "Codacy found an issue: Avoid appending characters as strings in StringBuffer.append.", "author": "dev-dotcms", "createdAt": "2020-07-03T11:50:59Z", "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -268,34 +256,40 @@ private void checkContentPermission(final UrlMapContext context, final Contentle\n                 contentlet, PermissionLevel.READ.getType(), context.getUser(), context.getMode().respectAnonPerms);\n \n         if (!havePermission) {\n-            throw new DotSecurityException(String.format(\"User dont have permission in content: %s\", contentlet.getName()));\n+            throw new DotSecurityException(String.format(\"User does not have permission in content: %s\", contentlet.getName()));\n         }\n     }\n \n     private String buildContentQuery(\n             final Matches matches,\n-            final Structure structure,\n-            final Field hostField,\n+            final ContentType structure,\n             final UrlMapContext context) {\n \n         final StringBuilder query = new StringBuilder();\n \n-        query.append(\"+structureName:\").append(structure.getVelocityVarName())\n-             .append(\" +deleted:false \");\n-\n-        if (context.getMode() == PageMode.PREVIEW_MODE || context.getMode() == PageMode.EDIT_MODE) {\n-            query.append(\"+working:true \");\n+        query.append(\"+contentType:\")\n+            .append(structure.variable())\n+            .append(\" +deleted:false \")\n+            .append(\" +(conhost:\")\n+                .append(context.getHost().getIdentifier())\n+                .append(\" OR conhost:\")\n+                .append(Host.SYSTEM_HOST)\n+            .append(\")\");", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MjkwNQ==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542905", "bodyText": "Codacy found an issue: The String literal \"urlTitle\" appears 18 times in this file; the first occurrence is on line 148", "author": "dev-dotcms", "createdAt": "2020-07-03T11:50:59Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();\n+        final Folder folder2 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host2).nextPersisted();\n+\n+\n+\n+        final Template template1 = new TemplateDataGen().site(host1).nextPersisted();\n+        final Template template2 = new TemplateDataGen().site(host2).nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost1 = new HTMLPageDataGen(folder1, template1).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost2 = new HTMLPageDataGen(folder2, template2).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final String urlPattern = \"/\" + UUIDGenerator.shorty() + \"/{urlTitle}\";\n+        \n+        // set the detail page to page on host1\n+        final ContentType contentType1 = getNewsLikeContentType(\"News\" + System.currentTimeMillis(),\n+                        APILocator.systemHost(), pageOnHost1.getIdentifier(), urlPattern);\n+\n+\n+        final Contentlet newsOnSystemHost = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(),\n+                        APILocator.systemHost(), null, UUIDGenerator.generateUuid());\n+\n+\n+        final Contentlet newsOnHost1 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host1,\n+                        null, UUIDGenerator.generateUuid());\n+\n+        final Contentlet newsOnHost2 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host2,\n+                        null, UUIDGenerator.generateUuid());\n+\n+\n+        \n+        // WORKS : trying where contentlet on the system host and request is on host1 \n+        UrlMapContext context = getUrlMapContext(systemUser, host1,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MjkxNA==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542914", "bodyText": "Codacy found an issue: The String literal \"title\" appears 14 times in this file; the first occurrence is on line 153", "author": "dev-dotcms", "createdAt": "2020-07-03T11:51:00Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();\n+        final Folder folder2 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host2).nextPersisted();\n+\n+\n+\n+        final Template template1 = new TemplateDataGen().site(host1).nextPersisted();\n+        final Template template2 = new TemplateDataGen().site(host2).nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost1 = new HTMLPageDataGen(folder1, template1).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost2 = new HTMLPageDataGen(folder2, template2).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final String urlPattern = \"/\" + UUIDGenerator.shorty() + \"/{urlTitle}\";\n+        \n+        // set the detail page to page on host1\n+        final ContentType contentType1 = getNewsLikeContentType(\"News\" + System.currentTimeMillis(),\n+                        APILocator.systemHost(), pageOnHost1.getIdentifier(), urlPattern);\n+\n+\n+        final Contentlet newsOnSystemHost = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(),\n+                        APILocator.systemHost(), null, UUIDGenerator.generateUuid());\n+\n+\n+        final Contentlet newsOnHost1 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host1,\n+                        null, UUIDGenerator.generateUuid());\n+\n+        final Contentlet newsOnHost2 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host2,\n+                        null, UUIDGenerator.generateUuid());\n+\n+\n+        \n+        // WORKS : trying where contentlet on the system host and request is on host1 \n+        UrlMapContext context = getUrlMapContext(systemUser, host1,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));\n+\n+        Optional<URLMapInfo> urlMapInfoOptional = urlMapAPI.processURLMap(context);\n+        URLMapInfo urlMapInfo = urlMapInfoOptional.get();\n+\n+        assertEquals(newsOnSystemHost.getStringProperty(\"title\"), urlMapInfo.getContentlet().getName());", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjAzMw==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r450326033", "bodyText": "why do you remove the 'volatile'?", "author": "freddyucv", "createdAt": "2020-07-06T16:05:39Z", "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -44,12 +40,11 @@\n  */\n public class URLMapAPIImpl implements URLMapAPI {\n \n-    private volatile Collection<ContentTypeURLPattern> patternsCache;", "originalCommit": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzMDkyNQ==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r450330925", "bodyText": "because the only method that writes to the patterns cache is synchronized?  It is ok if some threads get a dirty read as long as once it has been written, all threads will ultimately see the right variable.  Am I missing something?", "author": "wezell", "createdAt": "2020-07-06T16:13:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MzM2OA==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r450343368", "bodyText": "I think there might be a List implementation on Concurrent", "author": "jdotcms", "createdAt": "2020-07-06T16:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0NzQzNw==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r450347437", "bodyText": "So the question is, do we need a concurrent implementation on an object when all writes happen in a synced block?  I don't think we do - though I am happy to be proven wrong.", "author": "wezell", "createdAt": "2020-07-06T16:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2MDg3MA==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r450360870", "bodyText": "CopyOnWriteArrayList, might be", "author": "jdotcms", "createdAt": "2020-07-06T17:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM3NDkzMg==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r450374932", "bodyText": "Guys, I understand the better ways to create / use a concurrent List.  I am just not seeing where that is a requirement here.  Here are what the impl above expects\n\nMultiple threads read the List\nAny clearing/writing/modification to the List happens in 1 thread.\nDirty reads are ok for a few (milli) seconds as the list rebuilds\n\nI have not read anything that says single threaded modification of an ArrayList is harmful.  All the examples show where there are multiple threads trying to write to a list or the ConcurrentMod exceptions use of looping over a list to modify.\nI can change to a more defensive pattern, but I am not convinced it is broken.", "author": "wezell", "createdAt": "2020-07-06T17:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNzU4MQ==", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r450517581", "bodyText": "I think is ok", "author": "freddyucv", "createdAt": "2020-07-06T22:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjAzMw=="}], "type": "inlineReview"}]}