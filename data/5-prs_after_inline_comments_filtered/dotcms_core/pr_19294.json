{"pr_number": 19294, "pr_title": "Issue 18550 migrate cvi away from hibernate", "pr_createdAt": "2020-09-21T21:53:38Z", "pr_url": "https://github.com/dotCMS/core/pull/19294", "timeline": [{"oid": "36912d8f388b7f19586ee4f7b01dcdd67d087739", "url": "https://github.com/dotCMS/core/commit/36912d8f388b7f19586ee4f7b01dcdd67d087739", "message": "#18550 first draft", "committedDate": "2020-09-17T23:52:34Z", "type": "commit"}, {"oid": "936a8f78bc53c593450acebce154e8b43ed1e12f", "url": "https://github.com/dotCMS/core/commit/936a8f78bc53c593450acebce154e8b43ed1e12f", "message": "#18550 cast to String to preserve null", "committedDate": "2020-09-18T19:55:09Z", "type": "commit"}, {"oid": "8cd2b23a93eb1e5b7656bd43f595c824d2f73be1", "url": "https://github.com/dotCMS/core/commit/8cd2b23a93eb1e5b7656bd43f595c824d2f73be1", "message": "#18550 try with new factory impl", "committedDate": "2020-09-18T21:29:27Z", "type": "commit"}, {"oid": "714a2df9dbdd902761b54233c2ab5aa455c57635", "url": "https://github.com/dotCMS/core/commit/714a2df9dbdd902761b54233c2ab5aa455c57635", "message": "#18550 create cvi migrated to dotconnect", "committedDate": "2020-09-21T21:51:51Z", "type": "commit"}, {"oid": "4db0bb7d3eff4a7fa7f922dfa267b47168038737", "url": "https://github.com/dotCMS/core/commit/4db0bb7d3eff4a7fa7f922dfa267b47168038737", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18550-migrate-cvi-away-from-hibernate", "committedDate": "2020-09-21T22:54:52Z", "type": "commit"}, {"oid": "c591c3f92641afbdbe70a101b26631910a121fab", "url": "https://github.com/dotCMS/core/commit/c591c3f92641afbdbe70a101b26631910a121fab", "message": "#18550 fix transformer", "committedDate": "2020-09-22T18:21:31Z", "type": "commit"}, {"oid": "abcf4378561372f74f236a033715aec5be7ab926", "url": "https://github.com/dotCMS/core/commit/abcf4378561372f74f236a033715aec5be7ab926", "message": "#18550 return empty object instead of null, like hibernate did", "committedDate": "2020-09-23T18:19:18Z", "type": "commit"}, {"oid": "bc0f3a6fdc8bf885afeddf274bd9715696aa3e54", "url": "https://github.com/dotCMS/core/commit/bc0f3a6fdc8bf885afeddf274bd9715696aa3e54", "message": "#18550 codacy feedback", "committedDate": "2020-09-23T18:20:58Z", "type": "commit"}, {"oid": "b479eede5513c69cf49022987ca547d0d9c94984", "url": "https://github.com/dotCMS/core/commit/b479eede5513c69cf49022987ca547d0d9c94984", "message": "#18550 proper doc", "committedDate": "2020-09-23T18:26:16Z", "type": "commit"}, {"oid": "7cfda6869de41769141922c8b30af3c80184ef2b", "url": "https://github.com/dotCMS/core/commit/7cfda6869de41769141922c8b30af3c80184ef2b", "message": "#18550 include deprecated annotation", "committedDate": "2020-09-23T18:28:11Z", "type": "commit"}, {"oid": "84e99da054e1f6f0ca096b63ca8c00abcf37ef77", "url": "https://github.com/dotCMS/core/commit/84e99da054e1f6f0ca096b63ca8c00abcf37ef77", "message": "#18550 change signature of getContentletVersion info part I", "committedDate": "2020-09-24T23:01:57Z", "type": "commit"}, {"oid": "bd5a404b04a9800d5f7d974333a217fe6bec6ce2", "url": "https://github.com/dotCMS/core/commit/bd5a404b04a9800d5f7d974333a217fe6bec6ce2", "message": "#18550 custom ee jar to run tests", "committedDate": "2020-09-25T21:48:39Z", "type": "commit"}, {"oid": "942c8b1eff343e3bfd06664156a2448fbaba0544", "url": "https://github.com/dotCMS/core/commit/942c8b1eff343e3bfd06664156a2448fbaba0544", "message": "#18550 fix wrong return", "committedDate": "2020-09-25T23:31:35Z", "type": "commit"}, {"oid": "6275687cc07ad20d5d8fec1603b36ff7092e46aa", "url": "https://github.com/dotCMS/core/commit/6275687cc07ad20d5d8fec1603b36ff7092e46aa", "message": "#18550 fixing beanutils call", "committedDate": "2020-09-28T19:10:12Z", "type": "commit"}, {"oid": "91394a786f18119f4385cea389ea55b3f3f382f2", "url": "https://github.com/dotCMS/core/commit/91394a786f18119f4385cea389ea55b3f3f382f2", "message": "#18550 fix red in jsps", "committedDate": "2020-09-28T19:48:47Z", "type": "commit"}, {"oid": "25153c9fa1f3a1eebc0059839da30c30280c253c", "url": "https://github.com/dotCMS/core/commit/25153c9fa1f3a1eebc0059839da30c30280c253c", "message": "#18550 fix usage of optional", "committedDate": "2020-09-28T21:39:10Z", "type": "commit"}, {"oid": "46f648d95b888bb97b27a15f3f4f9d8a919a4eab", "url": "https://github.com/dotCMS/core/commit/46f648d95b888bb97b27a15f3f4f9d8a919a4eab", "message": "#18550 fix behavior when CVI not present", "committedDate": "2020-09-28T22:57:41Z", "type": "commit"}, {"oid": "f63850e7e64a69e49cecb49902df68e7637e8c54", "url": "https://github.com/dotCMS/core/commit/f63850e7e64a69e49cecb49902df68e7637e8c54", "message": "#18550 remove throws from method signature", "committedDate": "2020-09-29T17:34:24Z", "type": "commit"}, {"oid": "29fd8c3a002dfb9be3ba3adaf76816eee61668f5", "url": "https://github.com/dotCMS/core/commit/29fd8c3a002dfb9be3ba3adaf76816eee61668f5", "message": "#18550 remove commeted out code", "committedDate": "2020-09-29T22:38:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMTUxNQ==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497621515", "bodyText": "Just curious, is it OK to throw an exception here? It's because I've seen some places the expression assertTrue(opt.isPresent()) is used in tests.", "author": "victoralfaro-dotcms", "createdAt": "2020-09-30T15:55:10Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ContentletIndexAPIImplTest.java", "diffHunk": "@@ -603,13 +604,19 @@ public void testSearch () throws Exception {\n \n         //*****************************************************************\n         //Build a site search result in order to add it to the index\n-        ContentletVersionInfo versionInfo = APILocator.getVersionableAPI().getContentletVersionInfo(testHtmlPage.getIdentifier(), testHtmlPage.getLanguageId());\n+        Optional<ContentletVersionInfo> versionInfo = APILocator.getVersionableAPI().getContentletVersionInfo(testHtmlPage.getIdentifier(), testHtmlPage.getLanguageId());\n+\n+        if(!versionInfo.isPresent()) {", "originalCommit": "29fd8c3a002dfb9be3ba3adaf76816eee61668f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4NDE2MA==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497684160", "bodyText": "I will do that instead. Good call", "author": "dsilvam", "createdAt": "2020-09-30T17:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMTUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYzNjA1OQ==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497636059", "bodyText": "Can we use Optional.empty() instead?", "author": "victoralfaro-dotcms", "createdAt": "2020-09-30T16:16:11Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "diffHunk": "@@ -8074,15 +8077,15 @@ public boolean canLock(final Contentlet contentlet, final User user, final boole\n                     +\" does not have Edit Permissions to lock content: \" + (contentlet != null ? contentlet.getIdentifier() : \"Unknown\"));\n         }\n \n-        String lockedBy = null;\n+        Optional<String> lockedBy = null;", "originalCommit": "29fd8c3a002dfb9be3ba3adaf76816eee61668f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1MTcxMg==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497651712", "bodyText": "Shouldn't we check also for info.getIdentifier()is set?", "author": "victoralfaro-dotcms", "createdAt": "2020-09-30T16:40:23Z", "path": "dotCMS/src/main/java/com/dotmarketing/business/VersionableAPIImpl.java", "diffHunk": "@@ -543,22 +541,23 @@ public void setWorking(final Versionable versionable) throws DotDataException, D\n         if(identifier.getAssetType().equals(\"contentlet\")) {\n \n             final Contentlet contentlet = (Contentlet)versionable;\n-            ContentletVersionInfo info = versionableFactory\n+            Optional<ContentletVersionInfo> info = versionableFactory\n                     .getContentletVersionInfo(contentlet.getIdentifier(), contentlet.getLanguageId());\n \n-            if(info ==null || !UtilMethods.isSet(info.getIdentifier())) {\n+            if(!info.isPresent()) {", "originalCommit": "29fd8c3a002dfb9be3ba3adaf76816eee61668f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4ODI3OQ==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497688279", "bodyText": "Good review here", "author": "dsilvam", "createdAt": "2020-09-30T17:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1MTcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1Njg0Ng==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497656846", "bodyText": "Shouldn't we check for contentletVersionInfo.get().getLiveInode() to be set?", "author": "victoralfaro-dotcms", "createdAt": "2020-09-30T16:48:34Z", "path": "dotCMS/src/main/java/com/dotmarketing/business/VersionableAPIImpl.java", "diffHunk": "@@ -690,10 +707,11 @@ public boolean hasLiveVersion(final Versionable versionable) throws DotDataExcep\n \n \t\tif(versionable instanceof Contentlet) {\n \n-\t\t\tfinal ContentletVersionInfo contentletVersionInfo = this.getContentletVersionInfo\n+\t\t\tfinal Optional<ContentletVersionInfo> contentletVersionInfo = this.getContentletVersionInfo\n                     (versionable.getVersionId(), ((Contentlet) versionable).getLanguageId());\n \n-\t\t\treturn (contentletVersionInfo != null && UtilMethods.isSet(contentletVersionInfo.getLiveInode()));\n+\t\t\treturn (contentletVersionInfo.isPresent()", "originalCommit": "29fd8c3a002dfb9be3ba3adaf76816eee61668f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4OTU0Mg==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497689542", "bodyText": "We are! but it is on the next line", "author": "dsilvam", "createdAt": "2020-09-30T17:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1Njg0Ng=="}], "type": "inlineReview"}, {"oid": "926fc58c8460252418bcb80ca49156f2729f63af", "url": "https://github.com/dotCMS/core/commit/926fc58c8460252418bcb80ca49156f2729f63af", "message": "#18550 code-review", "committedDate": "2020-09-30T17:44:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcyMTI5MA==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497721290", "bodyText": "if(verInfo.isPresent() ) should be enough", "author": "wezell", "createdAt": "2020-09-30T18:37:40Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentFactoryImpl.java", "diffHunk": "@@ -613,15 +613,16 @@ protected void delete(List<Contentlet> contentlets, boolean deleteIdentifier) th\n             if(InodeUtils.isSet(con.getInode())){\n                 APILocator.getPermissionAPI().removePermissions(con);\n \n-                ContentletVersionInfo verInfo=APILocator.getVersionableAPI().getContentletVersionInfo(con.getIdentifier(), con.getLanguageId());\n-                if(verInfo!=null && UtilMethods.isSet(verInfo.getIdentifier())) {\n-                    if(UtilMethods.isSet(verInfo.getLiveInode()) && verInfo.getLiveInode().equals(con.getInode()))\n+                Optional<ContentletVersionInfo> verInfo=APILocator.getVersionableAPI().getContentletVersionInfo(con.getIdentifier(), con.getLanguageId());\n+\n+                if(verInfo.isPresent() && UtilMethods.isSet(verInfo.get().getIdentifier())) {", "originalCommit": "926fc58c8460252418bcb80ca49156f2729f63af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcyMTQxNg==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497721416", "bodyText": "if(cvi.isPresent() ) should be enough", "author": "wezell", "createdAt": "2020-09-30T18:37:52Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentFactoryImpl.java", "diffHunk": "@@ -1033,12 +1034,13 @@ protected Contentlet find(final String inode) throws ElasticsearchException, Dot\n \n \t@Override\n \tprotected Contentlet findContentletByIdentifier(String identifier, Boolean live, Long languageId) throws DotDataException {\n-        final ContentletVersionInfo cvi = APILocator.getVersionableAPI().getContentletVersionInfo(identifier, languageId);\n-        if(cvi == null  || UtilMethods.isEmpty(cvi.getIdentifier()) || (live && UtilMethods.isEmpty(cvi.getLiveInode()))) {\n+        final Optional<ContentletVersionInfo> cvi = APILocator.getVersionableAPI().getContentletVersionInfo(identifier, languageId);\n+        if(!cvi.isPresent() || UtilMethods.isEmpty(cvi.get().getIdentifier())", "originalCommit": "926fc58c8460252418bcb80ca49156f2729f63af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcyMjMwOA==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r497722308", "bodyText": "if(info.isPresent()) should be enough", "author": "wezell", "createdAt": "2020-09-30T18:39:32Z", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencySet.java", "diffHunk": "@@ -188,9 +188,12 @@ private boolean addOrClean ( final String assetId, final Date assetModDate, fina\n \t\t\t\t\tif(!modifiedOnCurrentEnv && assetType.equals(\"content\")) {\n \t\t\t\t\t\t// check for versionInfo TS on content\n \t\t\t\t\t\tfor(Language lang : APILocator.getLanguageAPI().getLanguages()) {\n-\t\t\t\t\t\t\tContentletVersionInfo info=APILocator.getVersionableAPI().getContentletVersionInfo(assetId, lang.getId());\n-\t\t\t\t\t\t\tif(info!=null && InodeUtils.isSet(info.getIdentifier())) {\n-\t\t\t\t\t\t\t\tmodifiedOnCurrentEnv = modifiedOnCurrentEnv || (null == info.getVersionTs()) || asset.getPushDate().before(info.getVersionTs());\n+\t\t\t\t\t\t\tOptional<ContentletVersionInfo> info=APILocator.getVersionableAPI().getContentletVersionInfo(assetId, lang.getId());\n+\n+\t\t\t\t\t\t\tif(info.isPresent() && InodeUtils.isSet(info.get().getIdentifier())) {", "originalCommit": "926fc58c8460252418bcb80ca49156f2729f63af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ee96ba2802078e1ede43bec4e7bc252c07beed5e", "url": "https://github.com/dotCMS/core/commit/ee96ba2802078e1ede43bec4e7bc252c07beed5e", "message": "Update gradle.properties", "committedDate": "2020-09-30T22:40:27Z", "type": "commit"}, {"oid": "f4b90a8830cc6f976d6d51fceeb08341f934edfc", "url": "https://github.com/dotCMS/core/commit/f4b90a8830cc6f976d6d51fceeb08341f934edfc", "message": "Update it-dotcms-config-cluster.properties", "committedDate": "2020-09-30T22:44:20Z", "type": "commit"}, {"oid": "aca420390ecb3431add888fbc51b2ae29bed7e68", "url": "https://github.com/dotCMS/core/commit/aca420390ecb3431add888fbc51b2ae29bed7e68", "message": "Update it-dotmarketing-config.properties", "committedDate": "2020-09-30T22:47:09Z", "type": "commit"}, {"oid": "84b4e04796a2c8011707ecaabb49fd5bf855b528", "url": "https://github.com/dotCMS/core/commit/84b4e04796a2c8011707ecaabb49fd5bf855b528", "message": "Update it-dotmarketing-config.properties", "committedDate": "2020-09-30T22:47:38Z", "type": "commit"}, {"oid": "c082973d88f62a27c33b760fd76fa0480648d59f", "url": "https://github.com/dotCMS/core/commit/c082973d88f62a27c33b760fd76fa0480648d59f", "message": "Update it-dotmarketing-config.properties", "committedDate": "2020-09-30T22:48:28Z", "type": "commit"}, {"oid": "ec12c93d4d62a04416012892a921a19882d6f704", "url": "https://github.com/dotCMS/core/commit/ec12c93d4d62a04416012892a921a19882d6f704", "message": "Update oracle-db-config.properties", "committedDate": "2020-09-30T22:49:00Z", "type": "commit"}, {"oid": "beb2f0f4fe0e9f0ff982e4d90a36ff37b7ce8db0", "url": "https://github.com/dotCMS/core/commit/beb2f0f4fe0e9f0ff982e4d90a36ff37b7ce8db0", "message": "Update postgres-db-config.properties", "committedDate": "2020-09-30T22:57:48Z", "type": "commit"}, {"oid": "d38e5aa02c207b3e8400d1224a4d16647a013557", "url": "https://github.com/dotCMS/core/commit/d38e5aa02c207b3e8400d1224a4d16647a013557", "message": "Update ESContentFactoryImpl.java", "committedDate": "2020-09-30T22:58:47Z", "type": "commit"}, {"oid": "11788ae5c0757c9c8c63c29411833928b8ce88a2", "url": "https://github.com/dotCMS/core/commit/11788ae5c0757c9c8c63c29411833928b8ce88a2", "message": "Update DependencySet.java", "committedDate": "2020-09-30T22:59:29Z", "type": "commit"}, {"oid": "f04092f9eacaba790294c7a9f81da6a42b275dee", "url": "https://github.com/dotCMS/core/commit/f04092f9eacaba790294c7a9f81da6a42b275dee", "message": "Update it-dotcms-config-cluster.properties", "committedDate": "2020-09-30T23:02:14Z", "type": "commit"}, {"oid": "fa72fa10dd1f98d383a8f7838dc948f2874520c7", "url": "https://github.com/dotCMS/core/commit/fa72fa10dd1f98d383a8f7838dc948f2874520c7", "message": "Update oracle-db-config.properties", "committedDate": "2020-09-30T23:02:42Z", "type": "commit"}, {"oid": "e454cf5e924c8b389fcd16f2412a95b924a3b168", "url": "https://github.com/dotCMS/core/commit/e454cf5e924c8b389fcd16f2412a95b924a3b168", "message": "#18550 remove new linews", "committedDate": "2020-09-30T23:04:16Z", "type": "commit"}, {"oid": "7b1ec15358ab54a3d463c1a74035d39044273cb6", "url": "https://github.com/dotCMS/core/commit/7b1ec15358ab54a3d463c1a74035d39044273cb6", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18550-migrate-cvi-away-from-hibernate", "committedDate": "2020-10-01T16:29:22Z", "type": "commit"}, {"oid": "bde7ec2537c2ff1f60e9797d29c840618ba204a4", "url": "https://github.com/dotCMS/core/commit/bde7ec2537c2ff1f60e9797d29c840618ba204a4", "message": "#18550 git rid of CVI definition in hbm files", "committedDate": "2020-10-01T17:48:17Z", "type": "commit"}, {"oid": "30027d11b303d769f277f39b9568721a4a9d4d82", "url": "https://github.com/dotCMS/core/commit/30027d11b303d769f277f39b9568721a4a9d4d82", "message": "#18550 changes after removing CVI from hbm files", "committedDate": "2020-10-01T22:20:18Z", "type": "commit"}, {"oid": "a246caaee5276db5e9d9de6f78c1593d28ca2837", "url": "https://github.com/dotCMS/core/commit/a246caaee5276db5e9d9de6f78c1593d28ca2837", "message": "#18550 migrate deleteContentByStructure to dotConnect", "committedDate": "2020-10-02T16:49:25Z", "type": "commit"}, {"oid": "329efa2ec3bd5e10d08301d1252684526d7bf10a", "url": "https://github.com/dotCMS/core/commit/329efa2ec3bd5e10d08301d1252684526d7bf10a", "message": "#18550 fat-contentlet db transformer", "committedDate": "2020-10-02T17:43:19Z", "type": "commit"}, {"oid": "3c40d0a5927a21371100f21adb69d1aaa642e638", "url": "https://github.com/dotCMS/core/commit/3c40d0a5927a21371100f21adb69d1aaa642e638", "message": "#18550 fix failing tests", "committedDate": "2020-10-06T23:23:21Z", "type": "commit"}, {"oid": "3fcd04d7ce4f1a5c946e7696d1b7fcd320555adc", "url": "https://github.com/dotCMS/core/commit/3fcd04d7ce4f1a5c946e7696d1b7fcd320555adc", "message": "#18550 fix more failing tests", "committedDate": "2020-10-07T17:12:59Z", "type": "commit"}, {"oid": "f77653a721d1c3bad529648820bf271a2770231e", "url": "https://github.com/dotCMS/core/commit/f77653a721d1c3bad529648820bf271a2770231e", "message": "#18550 create pp-filter fot test", "committedDate": "2020-10-08T16:27:22Z", "type": "commit"}, {"oid": "3093bc549a9a30d8874ac979f7f22db10d9e0ad9", "url": "https://github.com/dotCMS/core/commit/3093bc549a9a30d8874ac979f7f22db10d9e0ad9", "message": "#18550 replace hibernate call with new one", "committedDate": "2020-10-08T20:18:19Z", "type": "commit"}, {"oid": "420525ede2b56c809481674d25c3a56d6625d558", "url": "https://github.com/dotCMS/core/commit/420525ede2b56c809481674d25c3a56d6625d558", "message": "#18550 missing the owner of the contentlet", "committedDate": "2020-10-12T22:15:54Z", "type": "commit"}, {"oid": "5dcc89a585063c862c8c2093a6375d6dabddcbab", "url": "https://github.com/dotCMS/core/commit/5dcc89a585063c862c8c2093a6375d6dabddcbab", "message": "#18550 remove unneeded validation", "committedDate": "2020-10-14T19:01:41Z", "type": "commit"}, {"oid": "d2980c0b63a2061c3d009865424c447d8d38fcf0", "url": "https://github.com/dotCMS/core/commit/d2980c0b63a2061c3d009865424c447d8d38fcf0", "message": "Update gradle.properties", "committedDate": "2020-10-14T22:33:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAzMzU2MQ==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r505033561", "bodyText": "Codacy found an issue: Avoid declaring a variable if it is unreferenced before a possible exit point.", "author": "dev-dotcms", "createdAt": "2020-10-14T22:41:53Z", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/directive/ContentletDetail.java", "diffHunk": "@@ -32,20 +33,25 @@ public String getName() {\n \n \n     private long resolveLang(final String identifier, final RenderParams params) {\n-        ContentletVersionInfo cv;\n+        Optional<ContentletVersionInfo> versionInfo;", "originalCommit": "d2980c0b63a2061c3d009865424c447d8d38fcf0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAzMzU4Nw==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r505033587", "bodyText": "Codacy found an issue: Avoid unused imports such as 'java.util.Map.Entry'", "author": "dev-dotcms", "createdAt": "2020-10-14T22:41:54Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/transform/FatContentletTransformer.java", "diffHunk": "@@ -0,0 +1,221 @@\n+package com.dotmarketing.portlets.contentlet.transform;\n+\n+import com.dotcms.util.ConversionUtils;\n+import com.dotcms.util.transform.DBTransformer;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;", "originalCommit": "d2980c0b63a2061c3d009865424c447d8d38fcf0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAzMzU5OA==", "url": "https://github.com/dotCMS/core/pull/19294#discussion_r505033598", "bodyText": "Codacy found an issue: Avoid catching generic exceptions such as NullPointerException, RuntimeException, Exception in try-catch block", "author": "dev-dotcms", "createdAt": "2020-10-14T22:41:55Z", "path": "dotCMS/src/main/java/com/dotmarketing/business/VersionableFactoryImpl.java", "diffHunk": "@@ -278,92 +304,121 @@ protected void saveVersionInfo(VersionInfo info, boolean updateVersionTS) throws\n     }\n \n     @Override\n-    protected ContentletVersionInfo getContentletVersionInfo(String identifier, long lang) throws DotDataException, DotStateException {\n+    protected Optional<ContentletVersionInfo> getContentletVersionInfo(String identifier, long lang) throws DotDataException, DotStateException {\n         if (DbConnectionFactory.inTransaction()) {\n             return findContentletVersionInfoInDB(identifier, lang);\n         }\n-        ContentletVersionInfo contv = this.icache.getContentVersionInfo(identifier, lang);\n-        if(contv!=null && fourOhFour.equals(contv.getWorkingInode())) {\n-        \treturn null;\n-        }else if(contv!=null ){\n-        \treturn contv;\n+        ContentletVersionInfo contentVersionInfo = this.icache.getContentVersionInfo(identifier, lang);\n+        if(contentVersionInfo!=null && fourOhFour.equals(contentVersionInfo.getWorkingInode())) {\n+        \treturn Optional.empty();\n+        }else if(contentVersionInfo!=null ){\n+        \treturn Optional.of(contentVersionInfo);\n         }\n \n-    \tcontv = findContentletVersionInfoInDB(identifier, lang);\n-        if(contv!=null && UtilMethods.isSet(contv.getIdentifier())){\n-        \tthis.icache.addContentletVersionInfoToCache(contv);\n+    \tfinal Optional<ContentletVersionInfo> optionalInfo = findContentletVersionInfoInDB(identifier, lang);\n+        if(optionalInfo.isPresent()){\n+        \tthis.icache.addContentletVersionInfoToCache(optionalInfo.get());\n         }else{\n-        \tcontv = new ContentletVersionInfo();\n-        \tcontv.setIdentifier(identifier);\n-        \tcontv.setLang(lang);\n-        \tcontv.setWorkingInode(fourOhFour);\n-        \tthis.icache.addContentletVersionInfoToCache(contv);\n-\t\t\treturn null;\n+        \tcontentVersionInfo = new ContentletVersionInfo();\n+        \tcontentVersionInfo.setIdentifier(identifier);\n+        \tcontentVersionInfo.setLang(lang);\n+        \tcontentVersionInfo.setWorkingInode(fourOhFour);\n+        \tthis.icache.addContentletVersionInfoToCache(contentVersionInfo);\n+\t\t\treturn Optional.empty();\n         }\n \n-        return contv;\n+        return optionalInfo;\n     }\n \n     @Override\n-    protected ContentletVersionInfo findContentletVersionInfoInDB(String identifier, long lang)throws DotDataException, DotStateException {\n-    \tContentletVersionInfo contv = null;\n-    \t HibernateUtil dh = new HibernateUtil(ContentletVersionInfo.class);\n-         dh.setQuery(\"from \"+ContentletVersionInfo.class.getName()+\" where identifier=? and lang=?\");\n-         dh.setParam(identifier);\n-         dh.setParam(lang);\n-         Logger.debug(this.getClass(), \"getContentletVersionInfo query: \"+dh.getQuery());\n-         contv = (ContentletVersionInfo)dh.load();\n-         return contv;\n+    protected Optional<ContentletVersionInfo> findContentletVersionInfoInDB(String identifier, long lang)throws DotDataException, DotStateException {\n+\t\tfinal DotConnect dotConnect = new DotConnect()\n+\t\t\t\t.setSQL(\"SELECT * FROM contentlet_version_info WHERE identifier=? AND lang=?\")\n+\t\t\t\t.addParam(identifier)\n+\t\t\t\t.addParam(lang);\n+\n+\t\tList<ContentletVersionInfo> versionInfos = TransformerLocator\n+\t\t\t\t.createContentletVersionInfoTransformer(dotConnect.loadObjectResults()).asList();\n+\n+\t\treturn !versionInfos.isEmpty() ? Optional.of(versionInfos.get(0)) : Optional.empty();\n     }\n     @Override\n     protected List<ContentletVersionInfo> findAllContentletVersionInfos(final String identifier)throws DotDataException, DotStateException {\n+        final DotConnect dotConnect = new DotConnect()\n+                .setSQL(\"SELECT * FROM contentlet_version_info WHERE identifier=?\")\n+                .addParam(identifier);\n \n-         HibernateUtil dh = new HibernateUtil(ContentletVersionInfo.class);\n-         dh.setQuery(\"from \"+ContentletVersionInfo.class.getName()+\" where identifier=? \");\n-         dh.setParam(identifier);\n+        List<ContentletVersionInfo> versionInfos = TransformerLocator\n+                .createContentletVersionInfoTransformer(dotConnect.loadObjectResults()).asList();\n \n-         Logger.debug(this.getClass(), \"getContentletVersionInfo query: \"+dh.getQuery());\n-         return (List<ContentletVersionInfo>)dh.list();\n+\t\treturn versionInfos==null || versionInfos.isEmpty()\n+\t\t\t\t? Collections.emptyList()\n+\t\t\t\t: versionInfos;\n \n     }\n     @Override\n     protected void saveContentletVersionInfo(ContentletVersionInfo cvInfo, boolean updateVersionTS) throws DotDataException, DotStateException {\n-    \tIdentifier ident = this.iapi.find(cvInfo.getIdentifier());\n-    \tContentletVersionInfo vi= null;\n-    \tif(ident!=null && InodeUtils.isSet(ident.getId())){\n-    \t\tvi= findContentletVersionInfoInDB(ident.getId(), cvInfo.getLang());\n-    \t}\n-    \tboolean isNew = vi==null || !InodeUtils.isSet(vi.getIdentifier());\n-        try {\n-\t\t\tBeanUtils.copyProperties(vi, cvInfo);\n-\t\t} catch (Exception e) {\n-\t\t\tthrow new DotDataException(e.getMessage(),e);\n+\t\tboolean isNew = true;\n+\t\tif (UtilMethods.isSet(cvInfo.getIdentifier())) {\n+\t\t\ttry {\n+\t\t\t\tfinal Optional<ContentletVersionInfo> fromDB =\n+\t\t\t\t\t\tfindContentletVersionInfoInDB(cvInfo.getIdentifier(), cvInfo.getLang());\n+\t\t\t\tif (fromDB.isPresent()) {\n+\t\t\t\t\tisNew = false;\n+\t\t\t\t}\n+\t\t\t} catch (final Exception e) {", "originalCommit": "d2980c0b63a2061c3d009865424c447d8d38fcf0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}