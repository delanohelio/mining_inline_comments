{"pr_number": 19278, "pr_title": "#18990 now the key value on the url map as a map instead of single st\u2026", "pr_createdAt": "2020-09-17T17:48:18Z", "pr_url": "https://github.com/dotCMS/core/pull/19278", "timeline": [{"oid": "71afdfe42f323f3b2009e859088d9b9a72a70f0a", "url": "https://github.com/dotCMS/core/commit/71afdfe42f323f3b2009e859088d9b9a72a70f0a", "message": "#18990 now the key value on the url map as a map instead of single string", "committedDate": "2020-09-17T17:43:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ2NDU5Mg==", "url": "https://github.com/dotCMS/core/pull/19278#discussion_r490464592", "bodyText": "I think this code should be part of a more generic Serializer - DotContentletTransformer- any content can have a key/value field, not just Pages", "author": "wezell", "createdAt": "2020-09-17T18:19:51Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/page/PageViewSerializer.java", "diffHunk": "@@ -54,14 +60,42 @@ public void serialize(final PageView pageView, final JsonGenerator jsonGenerator\n \n         if (null != pageView.getUrlContent()) {\n \n-            final DotContentletTransformer transformer = new DotTransformerBuilder().defaultOptions().content(pageView.getUrlContent()).build();\n-            final Map<String, Object>   urlContentletMap = transformer.toMaps().stream().findFirst().orElse(Collections.EMPTY_MAP);\n-            pageViewMap.put(\"urlContentMap\", urlContentletMap);\n+            this.createObjectMapUrlContent(pageView.getUrlContent(), pageViewMap);\n         }\n \n         return pageViewMap;\n     }\n \n+    protected void createObjectMapUrlContent(final Contentlet urlContent, final Map<String, Object> pageViewMap) {\n+\n+        final DotContentletTransformer transformer   = new DotTransformerBuilder().defaultOptions().content(urlContent).build();\n+        final Map<String, Object>   urlContentletMap = transformer.toMaps().stream().findFirst().orElse(Collections.EMPTY_MAP);\n+        this.createObjectMapKeyValue(urlContent, urlContent.getContentType(), urlContentletMap);\n+\n+        pageViewMap.put(\"urlContentMap\", urlContentletMap);\n+    }\n+\n+    /**\n+     * Get all key value fields into the contentlet (if any) and put as an object into the contentMap (returns it)\n+     * @param contentlet    {@link Contentlet}\n+     * @param contentType   {@link ContentType}\n+     * @param contentletMap {@link Map}\n+     * @return Map\n+     */\n+    protected Map<String, Object> createObjectMapKeyValue(final Contentlet contentlet, final ContentType contentType, final Map<String, Object> contentletMap) {", "originalCommit": "71afdfe42f323f3b2009e859088d9b9a72a70f0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "25c36ccdc7f59a6d01f9c82a9030ba77cb362233", "url": "https://github.com/dotCMS/core/commit/25c36ccdc7f59a6d01f9c82a9030ba77cb362233", "message": "#18990 refactoring to add the key value map to the DotTransformer", "committedDate": "2020-09-22T06:22:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwMjE3Ng==", "url": "https://github.com/dotCMS/core/pull/19278#discussion_r492902176", "bodyText": "I don't think the strategy should be applied directly it must be applied from within the transformer.\nLet's say you do\nnew DotTransformerBuilder().defaultOptions() \nthe code that instructs the transformer to apply this strategy must be part of the options provided to the transformer. You should never apply a strategy outside of the transformer", "author": "fabrizzio-dotCMS", "createdAt": "2020-09-22T17:13:32Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/page/PageViewSerializer.java", "diffHunk": "@@ -54,14 +63,36 @@ public void serialize(final PageView pageView, final JsonGenerator jsonGenerator\n \n         if (null != pageView.getUrlContent()) {\n \n-            final DotContentletTransformer transformer = new DotTransformerBuilder().defaultOptions().content(pageView.getUrlContent()).build();\n-            final Map<String, Object>   urlContentletMap = transformer.toMaps().stream().findFirst().orElse(Collections.EMPTY_MAP);\n-            pageViewMap.put(\"urlContentMap\", urlContentletMap);\n+            this.createObjectMapUrlContent(pageView.getUrlContent(), pageViewMap);\n         }\n \n         return pageViewMap;\n     }\n \n+    protected void createObjectMapUrlContent(final Contentlet urlContent, final Map<String, Object> pageViewMap) {\n+\n+        final DotContentletTransformer transformer   = new DotTransformerBuilder().defaultOptions().content(urlContent).build();\n+        final Map<String, Object>   urlContentletMap = transformer.toMaps().stream().findFirst().orElse(Collections.EMPTY_MAP);\n+        this.createObjectMapKeyValue(urlContent, urlContentletMap);\n+\n+        pageViewMap.put(\"urlContentMap\", urlContentletMap);\n+    }\n+\n+    /**\n+     * Get all key value fields into the contentlet (if any) and put as an object into the contentMap (returns it)\n+     * @param contentlet    {@link Contentlet}\n+     * @param contentType   {@link ContentType}\n+     * @param contentletMap {@link Map}\n+     * @return Map\n+     */\n+    protected Map<String, Object> createObjectMapKeyValue(final Contentlet contentlet,\n+                                                          final Map<String, Object> contentletMap) {\n+\n+        new KeyValueViewStrategy(null).apply(contentlet, contentletMap, null, null);\n+        return contentletMap;\n+    }", "originalCommit": "25c36ccdc7f59a6d01f9c82a9030ba77cb362233", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5cce42cfa5dfd1316b2611272fb78aee5cac6e3c", "url": "https://github.com/dotCMS/core/commit/5cce42cfa5dfd1316b2611272fb78aee5cac6e3c", "message": "#18990 adding refactor to be align with the DotTransformer approach", "committedDate": "2020-09-22T20:36:50Z", "type": "commit"}, {"oid": "07979aa5ea23a989fb6af9390edcec0d2ad4c5e4", "url": "https://github.com/dotCMS/core/commit/07979aa5ea23a989fb6af9390edcec0d2ad4c5e4", "message": "Merge branch 'release-5.3.9' into issue-18990-keyvalue-urlmap-asmap", "committedDate": "2020-09-22T22:50:47Z", "type": "commit"}]}