{"pr_number": 528, "pr_title": "Named shadows for device deployment", "pr_createdAt": "2020-10-14T19:16:00Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528", "timeline": [{"oid": "3fd70fb9519d93de2df9c745b1a2b881563a8afc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3fd70fb9519d93de2df9c745b1a2b881563a8afc", "message": "move to named shadows for device deployment", "committedDate": "2020-10-14T19:14:53Z", "type": "commit"}, {"oid": "e783ba4ca143e84834f7690daa8e6c7d743afe46", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e783ba4ca143e84834f7690daa8e6c7d743afe46", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-14T19:17:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxNDg5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#discussion_r504914892", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nProblem\nYou are using a ConcurrentLinkedQueue, but your usage of peek(), null check, and remove() may not be thread-safe at lines: 187, 190, 195, and 210. If the ConcurrentLinkedQueue contains only one element and two threads perform this same check at the same time , the second thread's call to remove() will throw NoSuchElementException.\nFix\nConsider using poll() (does not throw an exception, but it may return null, which you can check for) or handling the exception.", "author": "MikeDombo", "createdAt": "2020-10-14T19:19:04Z", "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -193,10 +201,11 @@ private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n             try {\n                 ShadowState shadowState = new ShadowState();\n                 shadowState.reported = new HashMap<>(desired.getRight());\n-                UpdateShadowRequest updateShadowRequest = new UpdateShadowRequest();\n-                updateShadowRequest.thingName = thingName;\n-                updateShadowRequest.state = shadowState;\n-                iotShadowClient.PublishUpdateShadow(updateShadowRequest, QualityOfService.AT_LEAST_ONCE)\n+                UpdateNamedShadowRequest updateNamedShadowRequest = new UpdateNamedShadowRequest();\n+                updateNamedShadowRequest.shadowName = DEPLOYMENT_SHADOW_NAME;\n+                updateNamedShadowRequest.thingName = thingName;\n+                updateNamedShadowRequest.state = shadowState;\n+                iotShadowClient.PublishUpdateNamedShadow(updateNamedShadowRequest, QualityOfService.AT_LEAST_ONCE)\n                         .get(TIMEOUT_FOR_PUBLISHING_TO_TOPICS_SECONDS, TimeUnit.SECONDS);\n                 desiredStateQueue.remove();", "originalCommit": "3fd70fb9519d93de2df9c745b1a2b881563a8afc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxNDg5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#discussion_r504914895", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nProblem\nYou are using a ConcurrentLinkedQueue, but your usage of peek(), null check, and remove() may not be thread-safe at lines: 192, 195, 210, and 190. If the ConcurrentLinkedQueue contains only one element and two threads perform this same check at the same time , the second thread's call to remove() will throw NoSuchElementException.\nFix\nConsider using poll() (does not throw an exception, but it may return null, which you can check for) or handling the exception.", "author": "MikeDombo", "createdAt": "2020-10-14T19:19:04Z", "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -193,10 +201,11 @@ private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n             try {\n                 ShadowState shadowState = new ShadowState();\n                 shadowState.reported = new HashMap<>(desired.getRight());\n-                UpdateShadowRequest updateShadowRequest = new UpdateShadowRequest();\n-                updateShadowRequest.thingName = thingName;\n-                updateShadowRequest.state = shadowState;\n-                iotShadowClient.PublishUpdateShadow(updateShadowRequest, QualityOfService.AT_LEAST_ONCE)\n+                UpdateNamedShadowRequest updateNamedShadowRequest = new UpdateNamedShadowRequest();\n+                updateNamedShadowRequest.shadowName = DEPLOYMENT_SHADOW_NAME;\n+                updateNamedShadowRequest.thingName = thingName;\n+                updateNamedShadowRequest.state = shadowState;\n+                iotShadowClient.PublishUpdateNamedShadow(updateNamedShadowRequest, QualityOfService.AT_LEAST_ONCE)\n                         .get(TIMEOUT_FOR_PUBLISHING_TO_TOPICS_SECONDS, TimeUnit.SECONDS);\n                 desiredStateQueue.remove();", "originalCommit": "3fd70fb9519d93de2df9c745b1a2b881563a8afc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ed63a058bc7cb59927ee40bd8a00d8609bb388d3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed63a058bc7cb59927ee40bd8a00d8609bb388d3", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-14T20:30:53Z", "type": "commit"}, {"oid": "ab50c67eae369c609fe91250a2e84033c878c11d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ab50c67eae369c609fe91250a2e84033c878c11d", "message": "disable flaky test", "committedDate": "2020-10-14T20:47:52Z", "type": "commit"}, {"oid": "640dfc1af03435a0807ac3e5402106f113151a87", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/640dfc1af03435a0807ac3e5402106f113151a87", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-14T21:53:50Z", "type": "commit"}, {"oid": "ce02907561b608e466db562695786d574109c7b2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce02907561b608e466db562695786d574109c7b2", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-14T22:33:36Z", "type": "commit"}, {"oid": "fb8425f163c2839e18d98ada27ac363b0a6b76b2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb8425f163c2839e18d98ada27ac363b0a6b76b2", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-14T22:58:55Z", "type": "commit"}, {"oid": "57f25557945e36842b135b28a45d080c457d24a1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/57f25557945e36842b135b28a45d080c457d24a1", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-15T00:07:19Z", "type": "commit"}, {"oid": "f4a193e2200d68953e13bf1f4c9b661d496d6ac2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f4a193e2200d68953e13bf1f4c9b661d496d6ac2", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-15T16:14:21Z", "type": "commit"}, {"oid": "fd895915c23530701fba8f91a82f77169a7b60b5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd895915c23530701fba8f91a82f77169a7b60b5", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-15T18:20:25Z", "type": "commit"}, {"oid": "949591e5e64a68d5e189536d72e2310cf2745bc8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/949591e5e64a68d5e189536d72e2310cf2745bc8", "message": "Merge branch 'master' into use-named-shadows", "committedDate": "2020-10-15T18:50:32Z", "type": "commit"}]}