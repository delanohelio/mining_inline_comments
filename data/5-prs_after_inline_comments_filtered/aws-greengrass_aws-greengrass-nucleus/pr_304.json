{"pr_number": 304, "pr_title": "PubSub IPC Broker Implementation", "pr_createdAt": "2020-07-13T22:31:51Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/304", "timeline": [{"oid": "572c0f9f6cab065ad6a30d9519fbe16b71921c19", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/572c0f9f6cab065ad6a30d9519fbe16b71921c19", "message": "Add PubSub IPC broker implementation", "committedDate": "2020-07-13T22:37:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5MTQ3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/304#discussion_r454091475", "bodyText": "Is this intended to be used by other internal services in the same JVM through method invocation?", "author": "fengwang666", "createdAt": "2020-07-14T04:24:55Z", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/pubsub/PubSubIPCAgent.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.builtin.services.pubsub;\n+\n+import com.aws.iot.evergreen.ipc.ConnectionContext;\n+import com.aws.iot.evergreen.ipc.common.BuiltInServiceDestinationCode;\n+import com.aws.iot.evergreen.ipc.common.FrameReader;\n+import com.aws.iot.evergreen.ipc.services.common.ApplicationMessage;\n+import com.aws.iot.evergreen.ipc.services.common.IPCUtil;\n+import com.aws.iot.evergreen.ipc.services.pubsub.MessagePublishedEvent;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubGenericResponse;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubImpl;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubPublishRequest;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubResponseStatus;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubServiceOpCodes;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubSubscribeRequest;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubUnsubscribeRequest;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.DefaultConcurrentHashMap;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.function.Consumer;\n+import javax.inject.Inject;\n+\n+/**\n+ * Class to handle business logic for all PubSub requests over IPC.\n+ */\n+public class PubSubIPCAgent {\n+    // Map from connection --> Function to call for each published message\n+    private static final Map<String, Set<Object>> listeners = new DefaultConcurrentHashMap<>(CopyOnWriteArraySet::new);\n+    private static final int TIMEOUT_SECONDS = 30;\n+\n+    @Inject\n+    private ExecutorService executor;\n+\n+    private static final Logger log = LogManager.getLogger(PubSubIPCAgent.class);\n+\n+    /**\n+     * Publish a message to all subscribers.\n+     *\n+     * @param publishRequest publish request\n+     * @return response\n+     */\n+    public PubSubGenericResponse publish(PubSubPublishRequest publishRequest) {\n+        if (!listeners.containsKey(publishRequest.getTopic())) {\n+            // Still technically successful, just no one was subscribed\n+            return new PubSubGenericResponse(PubSubResponseStatus.Success, null);\n+        }\n+        Set<Object> contexts = listeners.get(publishRequest.getTopic());\n+\n+        executor.execute(() -> {\n+            contexts.forEach(c -> {\n+                publishToTopic(new MessagePublishedEvent(publishRequest.getTopic(), publishRequest.getPayload()), c);\n+            });\n+        });\n+        return new PubSubGenericResponse(PubSubResponseStatus.Success, null);\n+    }\n+\n+    /**\n+     * Handle the subscription request from the user.\n+     *\n+     * @param subscribeRequest subscribe request\n+     * @param context          connection context\n+     * @return response code Success if all went well\n+     */\n+    public PubSubGenericResponse subscribe(PubSubSubscribeRequest subscribeRequest, ConnectionContext context) {\n+        // TODO: Input validation. https://sim.amazon.com/issues/P32540011\n+        log.debug(\"Subscribing to topic {}, {}\", subscribeRequest.getTopic(), context);\n+        listeners.get(subscribeRequest.getTopic()).add(context);\n+        context.onDisconnect(() -> {\n+            if (listeners.containsKey(subscribeRequest.getTopic())) {\n+                if (listeners.get(subscribeRequest.getTopic()).remove(context)) {\n+                    log.debug(\"Client {} disconnected, removing subscription {}\", context, subscribeRequest.getTopic());\n+                }\n+            }\n+        });\n+\n+        return new PubSubGenericResponse(PubSubResponseStatus.Success, null);\n+    }\n+\n+    /**\n+     * Handle the subscription request from the user.\n+     *\n+     * @param subscribeRequest subscribe request\n+     * @param cb               callback to be called for each published message\n+     */\n+    public void subscribe(PubSubSubscribeRequest subscribeRequest, Consumer<MessagePublishedEvent> cb) {", "originalCommit": "572c0f9f6cab065ad6a30d9519fbe16b71921c19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5NjA4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/304#discussion_r454096081", "bodyText": "Yes, that's the idea with exposing this method. That way we can use it for the lambda stuff.", "author": "MikeDombo", "createdAt": "2020-07-14T04:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5MTQ3NQ=="}], "type": "inlineReview"}, {"oid": "c7321850377540ede4b391cace416d3c81efeba9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c7321850377540ede4b391cace416d3c81efeba9", "message": "Add PubSub IPC broker implementation", "committedDate": "2020-07-14T16:24:55Z", "type": "forcePushed"}, {"oid": "07eb27f62d47afe5d67ba9c341a69c46171fecf2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/07eb27f62d47afe5d67ba9c341a69c46171fecf2", "message": "Add PubSub IPC/broker implementation", "committedDate": "2020-07-14T16:25:37Z", "type": "commit"}, {"oid": "e8800009d0c20186dd5bec0215d7e167d3b56cec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e8800009d0c20186dd5bec0215d7e167d3b56cec", "message": "Add PubSub IPC broker implementation", "committedDate": "2020-07-14T16:25:37Z", "type": "forcePushed"}, {"oid": "71b020f9c6d5b4caaa05cfc8557e720083679da4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/71b020f9c6d5b4caaa05cfc8557e720083679da4", "message": "Add PubSub IPC broker implementation", "committedDate": "2020-07-14T16:55:46Z", "type": "commit"}, {"oid": "71b020f9c6d5b4caaa05cfc8557e720083679da4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/71b020f9c6d5b4caaa05cfc8557e720083679da4", "message": "Add PubSub IPC broker implementation", "committedDate": "2020-07-14T16:55:46Z", "type": "forcePushed"}, {"oid": "34f8ca148265a221a262b9c18a4da3cfff68bf8c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/34f8ca148265a221a262b9c18a4da3cfff68bf8c", "message": "Update cloud endpoints", "committedDate": "2020-07-14T20:08:48Z", "type": "commit"}, {"oid": "34f8ca148265a221a262b9c18a4da3cfff68bf8c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/34f8ca148265a221a262b9c18a4da3cfff68bf8c", "message": "Update cloud endpoints", "committedDate": "2020-07-14T20:08:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1ODIxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/304#discussion_r454658213", "bodyText": "what kind of guarantee does this publish operation need to support?", "author": "fahadmohammed01", "createdAt": "2020-07-14T21:32:36Z", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/pubsub/PubSubIPCAgent.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.builtin.services.pubsub;\n+\n+import com.aws.iot.evergreen.ipc.ConnectionContext;\n+import com.aws.iot.evergreen.ipc.common.BuiltInServiceDestinationCode;\n+import com.aws.iot.evergreen.ipc.common.FrameReader;\n+import com.aws.iot.evergreen.ipc.services.common.ApplicationMessage;\n+import com.aws.iot.evergreen.ipc.services.common.IPCUtil;\n+import com.aws.iot.evergreen.ipc.services.pubsub.MessagePublishedEvent;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubGenericResponse;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubImpl;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubPublishRequest;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubResponseStatus;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubServiceOpCodes;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubSubscribeRequest;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubUnsubscribeRequest;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.DefaultConcurrentHashMap;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.function.Consumer;\n+import javax.inject.Inject;\n+\n+/**\n+ * Class to handle business logic for all PubSub requests over IPC.\n+ */\n+public class PubSubIPCAgent {\n+    // Map from connection --> Function to call for each published message\n+    private static final Map<String, Set<Object>> listeners = new DefaultConcurrentHashMap<>(CopyOnWriteArraySet::new);\n+    private static final int TIMEOUT_SECONDS = 30;\n+\n+    @Inject\n+    private ExecutorService executor;\n+\n+    private static final Logger log = LogManager.getLogger(PubSubIPCAgent.class);\n+\n+    /**\n+     * Publish a message to all subscribers.\n+     *\n+     * @param publishRequest publish request\n+     * @return response\n+     */\n+    public PubSubGenericResponse publish(PubSubPublishRequest publishRequest) {", "originalCommit": "34f8ca148265a221a262b9c18a4da3cfff68bf8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2NzI3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/304#discussion_r454667275", "bodyText": "Right now, as you can see, the only guarantee is that we add it into the executor to be run at some point. I don't really think we need a stronger guarantee like qos 1, especially I don't really want to block the thread waiting for all consumers to finish. I'll sync with Feng on the guarantee.", "author": "MikeDombo", "createdAt": "2020-07-14T21:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1ODIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2MjYwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/304#discussion_r454662601", "bodyText": "why a CopyOnWriteArraySet? is order important? Would a set backed by concurrentHaspMap be more efficient?\nex Set myConcurrentSet = ConcurrentHashMap.newKeySet();", "author": "fahadmohammed01", "createdAt": "2020-07-14T21:41:52Z", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/pubsub/PubSubIPCAgent.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.builtin.services.pubsub;\n+\n+import com.aws.iot.evergreen.ipc.ConnectionContext;\n+import com.aws.iot.evergreen.ipc.common.BuiltInServiceDestinationCode;\n+import com.aws.iot.evergreen.ipc.common.FrameReader;\n+import com.aws.iot.evergreen.ipc.services.common.ApplicationMessage;\n+import com.aws.iot.evergreen.ipc.services.common.IPCUtil;\n+import com.aws.iot.evergreen.ipc.services.pubsub.MessagePublishedEvent;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubGenericResponse;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubImpl;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubPublishRequest;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubResponseStatus;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubServiceOpCodes;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubSubscribeRequest;\n+import com.aws.iot.evergreen.ipc.services.pubsub.PubSubUnsubscribeRequest;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.DefaultConcurrentHashMap;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.function.Consumer;\n+import javax.inject.Inject;\n+\n+/**\n+ * Class to handle business logic for all PubSub requests over IPC.\n+ */\n+public class PubSubIPCAgent {\n+    // Map from connection --> Function to call for each published message\n+    private static final Map<String, Set<Object>> listeners = new DefaultConcurrentHashMap<>(CopyOnWriteArraySet::new);", "originalCommit": "34f8ca148265a221a262b9c18a4da3cfff68bf8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2NjIxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/304#discussion_r454666219", "bodyText": "I'm using a set because the order isn't important (not an array). I don't see how using the keyset would be better, a cow set is threadsafe for all operations (especially iteration which we need).", "author": "MikeDombo", "createdAt": "2020-07-14T21:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2MjYwMQ=="}], "type": "inlineReview"}]}