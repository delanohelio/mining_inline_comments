{"pr_number": 434, "pr_title": "Generating authentication token for CLI and storing in a file", "pr_createdAt": "2020-09-14T16:10:27Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA5NTczNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488095737", "bodyText": "nit\nremove the listener in a finally", "author": "MikeDombo", "createdAt": "2020-09-14T17:15:33Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/fss/FleetStatusServiceTest.java", "diffHunk": "@@ -97,6 +98,13 @@ void GIVEN_kernel_running_with_deployed_services_WHEN_deployment_finishes_THEN_f\n                     mqttMessagesList.get().add(m);\n                 }).build());\n \n+        CountDownLatch fssPublishLatch = new CountDownLatch(2);\n+        Slf4jLogAdapter.addGlobalListener(eslm->{", "originalCommit": "c898dba0b608ab25a888bd58b53a517ae17f144f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA5Njk2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488096967", "bodyText": "Why not set the cause? Just ignore it in tests if you must", "author": "MikeDombo", "createdAt": "2020-09-14T17:17:31Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/modules/CLIService.java", "diffHunk": "@@ -60,42 +78,102 @@\n     @Inject\n     private DeploymentStatusKeeper deploymentStatusKeeper;\n \n+    @Inject\n+    private AuthenticationHandler authenticationHandler;\n+\n+    @Inject\n+    private Kernel kernel;\n+\n     public CLIService(Topics topics) {\n         super(topics);\n     }\n \n     /**\n      * Constructor for unit testing.\n      * @param topics Service config\n+     * @param privateConfig Private config for the service\n      * @param router {@link IPCRouter}\n      * @param agent {@link CLIServiceAgent}\n      * @param deploymentStatusKeeper {@link DeploymentStatusKeeper}\n+     * @param authenticationHandler {@link AuthenticationHandler}\n+     * @param kernel {@link Kernel}\n      */\n-    public CLIService(Topics topics, IPCRouter router, CLIServiceAgent agent,\n-                      DeploymentStatusKeeper deploymentStatusKeeper) {\n-        super(topics);\n+    public CLIService(Topics topics, Topics privateConfig, IPCRouter router, CLIServiceAgent agent,\n+                      DeploymentStatusKeeper deploymentStatusKeeper, AuthenticationHandler authenticationHandler,\n+                      Kernel kernel) {\n+        super(topics, privateConfig);\n         this.router = router;\n         this.agent = agent;\n         this.deploymentStatusKeeper = deploymentStatusKeeper;\n+        this.authenticationHandler = authenticationHandler;\n+        this.kernel = kernel;\n     }\n \n     @Override\n     public void postInject() {\n         BuiltInServiceDestinationCode destination = BuiltInServiceDestinationCode.CLI;\n         super.postInject();\n+        // Does not happen for built-in/plugin services so doing explicitly\n+        AuthenticationHandler.registerAuthenticationToken(this);\n         try {\n             router.registerServiceCallback(destination.getValue(), this::handleMessage);\n             logger.atInfo().setEventType(\"ipc-register-request-handler\").addKeyValue(\"destination\", destination.name())\n                     .log();\n             deploymentStatusKeeper.registerDeploymentStatusConsumer(Deployment.DeploymentType.LOCAL,\n                     this::deploymentStatusChanged, CLIService.class.getName());\n+\n         } catch (IPCException e) {\n             logger.atError().setEventType(\"ipc-register-request-handler-error\").setCause(e)\n                     .addKeyValue(\"destination\", destination.name())\n                     .log(\"Failed to register service callback to destination\");\n         }\n     }\n \n+    @Override\n+    protected void startup() {\n+        try {\n+            generateCliIpcInfo();\n+            reportState(State.RUNNING);\n+        } catch (IOException | UnauthenticatedException e) {\n+            logger.atError().setEventType(\"cli-ipc-info-generation-error\")\n+                    // CloseByInterrupt exception occurs in tests if the threads finish earlier than this method", "originalCommit": "c898dba0b608ab25a888bd58b53a517ae17f144f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI5MDEyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488290127", "bodyText": "Will have to ignore in a lot of tests, since this will happen as part of kernel launch. I tried that approach initially but don;t think I want to add that ignore in all the tests.", "author": "abanthiy", "createdAt": "2020-09-14T23:18:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA5Njk2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI5MzA5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488293090", "bodyText": "We have some global ignores in the ExceptionLogProtector class, you can put it there. But, why is it happening everytime? Anything we can do so that it doesn't?", "author": "MikeDombo", "createdAt": "2020-09-14T23:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA5Njk2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NTk5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489175996", "bodyText": "I am removing it and will observe if we still get it after the fixes we have added. I identified the cause and fixed that so it should not happen.", "author": "abanthiy", "createdAt": "2020-09-16T05:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA5Njk2Nw=="}], "type": "inlineReview"}, {"oid": "f88d6773f39f29b778635a916ea750c9fd8a7490", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f88d6773f39f29b778635a916ea750c9fd8a7490", "message": "Using modified IPC Client with new thread pool and closing connection in IotConnectionManager. Updating test to avoid IPC Server exception.", "committedDate": "2020-09-14T19:41:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NzU4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488287584", "bodyText": "why are these needed, I don't think I see it used?", "author": "MikeDombo", "createdAt": "2020-09-14T23:10:18Z", "path": "src/main/java/com/aws/iot/evergreen/fss/FleetStatusService.java", "diffHunk": "@@ -66,7 +67,8 @@\n     private final Kernel kernel;\n     private final String architecture;\n     private final String platform;\n-    private final MqttChunkedPayloadPublisher<ComponentStatusDetails> publisher;\n+    @Getter @Setter", "originalCommit": "434183cc3a995cbb31e48ad5040c0c8b4c89ee66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4Nzg4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488287886", "bodyText": "with coerce you don't need to call getOnce", "author": "MikeDombo", "createdAt": "2020-09-14T23:11:10Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/modules/CLIService.java", "diffHunk": "@@ -60,42 +78,102 @@\n     @Inject\n     private DeploymentStatusKeeper deploymentStatusKeeper;\n \n+    @Inject\n+    private AuthenticationHandler authenticationHandler;\n+\n+    @Inject\n+    private Kernel kernel;\n+\n     public CLIService(Topics topics) {\n         super(topics);\n     }\n \n     /**\n      * Constructor for unit testing.\n      * @param topics Service config\n+     * @param privateConfig Private config for the service\n      * @param router {@link IPCRouter}\n      * @param agent {@link CLIServiceAgent}\n      * @param deploymentStatusKeeper {@link DeploymentStatusKeeper}\n+     * @param authenticationHandler {@link AuthenticationHandler}\n+     * @param kernel {@link Kernel}\n      */\n-    public CLIService(Topics topics, IPCRouter router, CLIServiceAgent agent,\n-                      DeploymentStatusKeeper deploymentStatusKeeper) {\n-        super(topics);\n+    public CLIService(Topics topics, Topics privateConfig, IPCRouter router, CLIServiceAgent agent,\n+                      DeploymentStatusKeeper deploymentStatusKeeper, AuthenticationHandler authenticationHandler,\n+                      Kernel kernel) {\n+        super(topics, privateConfig);\n         this.router = router;\n         this.agent = agent;\n         this.deploymentStatusKeeper = deploymentStatusKeeper;\n+        this.authenticationHandler = authenticationHandler;\n+        this.kernel = kernel;\n     }\n \n     @Override\n     public void postInject() {\n         BuiltInServiceDestinationCode destination = BuiltInServiceDestinationCode.CLI;\n         super.postInject();\n+        // Does not happen for built-in/plugin services so doing explicitly\n+        AuthenticationHandler.registerAuthenticationToken(this);\n         try {\n             router.registerServiceCallback(destination.getValue(), this::handleMessage);\n             logger.atInfo().setEventType(\"ipc-register-request-handler\").addKeyValue(\"destination\", destination.name())\n                     .log();\n             deploymentStatusKeeper.registerDeploymentStatusConsumer(Deployment.DeploymentType.LOCAL,\n                     this::deploymentStatusChanged, CLIService.class.getName());\n+\n         } catch (IPCException e) {\n             logger.atError().setEventType(\"ipc-register-request-handler-error\").setCause(e)\n                     .addKeyValue(\"destination\", destination.name())\n                     .log(\"Failed to register service callback to destination\");\n         }\n     }\n \n+    @Override\n+    protected void startup() {\n+        try {\n+            generateCliIpcInfo();\n+            reportState(State.RUNNING);\n+        } catch (IOException | UnauthenticatedException e) {\n+            logger.atError().setEventType(\"cli-ipc-info-generation-error\")\n+                    // CloseByInterrupt exception occurs in tests if the threads finish earlier than this method\n+                    // fnishes generating the cli ipc info file. This not setting the cause here.\n+                    .kv(\"errorMessage\", e.getMessage())\n+                    .log(\"Failed to create cli_ipc_info file\");\n+        }\n+    }\n+\n+    @SuppressFBWarnings(value = {\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\", \"RV_RETURN_VALUE_IGNORED\"},\n+            justification = \"File is created in the same method\")\n+    @SuppressWarnings(\"PMD.PrematureDeclaration\")\n+    private void generateCliIpcInfo() throws UnauthenticatedException, IOException {\n+        String cliAuthToken = authenticationHandler.registerAuthenticationTokenForExternalClient(\n+                Coerce.toString(getPrivateConfig().find(SERVICE_UNIQUE_ID_KEY).getOnce()),\n+                GREENGRASS_CLI);\n+        Map<String, String> ipcInfo = new HashMap<>();\n+        ipcInfo.put(CLI_AUTH_TOKEN, cliAuthToken);\n+\n+        if (config.getRoot().find(SETENV_CONFIG_NAMESPACE, KERNEL_URI_ENV_VARIABLE_NAME) == null) {\n+            logger.atWarn().log(\"Did not find IPC socket URL in the config. Not creating the cli ipc info file\");\n+            return;\n+        } else {\n+            //TODO: Change the URL as per the new IPC\n+            ipcInfo.put(SOCKET_URL, Coerce.toString(", "originalCommit": "434183cc3a995cbb31e48ad5040c0c8b4c89ee66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NTczMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489175731", "bodyText": "Updated", "author": "abanthiy", "createdAt": "2020-09-16T05:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4Nzg4Ng=="}], "type": "inlineReview"}, {"oid": "688c20186b2d5987c190a22237ac5781d9e75abc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/688c20186b2d5987c190a22237ac5781d9e75abc", "message": "Addressing PR comments", "committedDate": "2020-09-14T23:47:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMTUzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488301539", "bodyText": "why add lenient()", "author": "fahadmohammed01", "createdAt": "2020-09-14T23:56:33Z", "path": "src/test/java/com/aws/iot/evergreen/testcommons/testutilities/EGServiceTestUtil.java", "diffHunk": "@@ -57,15 +56,14 @@ public Topics initializeMockedConfig() {\n         lenient().when(config.lookupTopics(eq(RUNTIME_STORE_NAMESPACE_TOPIC))).thenReturn(runtimeStoreTopic);\n         lenient().when(config.lookupTopics(eq(PRIVATE_STORE_NAMESPACE_TOPIC))).thenReturn(privateStoreTopic);\n         lenient().when(privateStoreTopic.createLeafChild(eq(STATE_TOPIC_NAME))).thenReturn(stateTopic);\n-        when(config.createLeafChild(eq(SERVICE_DEPENDENCIES_NAMESPACE_TOPIC))).thenReturn(dependenciesTopic);\n-        when(config.getName()).thenReturn(serviceFullName);\n-        when(dependenciesTopic.dflt(Mockito.any())).thenReturn(dependenciesTopic);\n-        when(dependenciesTopic.getOnce()).thenReturn(new ArrayList<>());\n-        when(config.getContext()).thenReturn(context);\n+        lenient().when(config.createLeafChild(eq(SERVICE_DEPENDENCIES_NAMESPACE_TOPIC))).thenReturn(dependenciesTopic);", "originalCommit": "688c20186b2d5987c190a22237ac5781d9e75abc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwODMyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488308327", "bodyText": "Some out of all tests in cli tests do not need these mocking, resulting in unnecessary mocks exception. Changed this to lenient to fix that.", "author": "abanthiy", "createdAt": "2020-09-15T00:19:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMTUzOQ=="}], "type": "inlineReview"}, {"oid": "0491d27ab1331b63cc0830cecca2b0adea2fd418", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0491d27ab1331b63cc0830cecca2b0adea2fd418", "message": "Addressing PR comments", "committedDate": "2020-09-15T00:16:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNDMyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488314321", "bodyText": "nit: authenticated", "author": "hui-yang", "createdAt": "2020-09-15T00:40:52Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/AuthenticationHandler.java", "diffHunk": "@@ -62,6 +63,43 @@ public static void registerAuthenticationToken(EvergreenService s) {\n         }\n     }\n \n+    /**\n+     * Register an auth token for an external client which is not part of Evergreen. Only authenticate EG service can", "originalCommit": "0491d27ab1331b63cc0830cecca2b0adea2fd418", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNTkzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488315932", "bodyText": "Seems unnecessary to call registerAuthenticationTokenForExternalClient. Maybe extract ln 86,91-96 and retry that only?", "author": "hui-yang", "createdAt": "2020-09-15T00:46:15Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/AuthenticationHandler.java", "diffHunk": "@@ -62,6 +63,43 @@ public static void registerAuthenticationToken(EvergreenService s) {\n         }\n     }\n \n+    /**\n+     * Register an auth token for an external client which is not part of Evergreen. Only authenticate EG service can\n+     * register such a token.\n+     * @param requestingAuthToken Auth token of the requesting service\n+     * @param clientIdentifier The identifier to identify the client for which the token is being requested\n+     * @return Auth token.\n+     * @throws UnauthenticatedException thrown when the requestAuthToken is invalid\n+     */\n+    public String registerAuthenticationTokenForExternalClient(String requestingAuthToken,\n+                                                               String clientIdentifier)\n+            throws UnauthenticatedException {\n+        String authenticatedService = doAuthentication(requestingAuthToken);\n+        // Making it available only for CLIService right now. If it needs to be extended, requesting service can be\n+        // taken as a parameter\n+        if (!authenticatedService.equals(CLIService.CLI_SERVICE)) {\n+            logger.atError().kv(\"Requesting service name\", CLIService.CLI_SERVICE)\n+                    .log(\"Invalid requesting auth token for service\");\n+            throw new UnauthenticatedException(\"Invalid requesting auth token for service\");\n+        }\n+\n+        String authenticationToken = Utils.generateRandomString(16).toUpperCase();\n+        Topics tokenTopics = config.lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC,\n+                AUTHENTICATION_TOKEN_LOOKUP_KEY);\n+        tokenTopics.withParentNeedsToKnow(false);\n+\n+        Topic tokenTopic = tokenTopics.createLeafChild(authenticationToken);\n+\n+        // If the authentication token was already registered, that's an issue, so we will retry\n+        // generating a new token in that case\n+        if (tokenTopic.getOnce() == null) {\n+            tokenTopic.withValue(clientIdentifier);\n+            return authenticationToken;\n+        } else {\n+            return registerAuthenticationTokenForExternalClient(requestingAuthToken, clientIdentifier);", "originalCommit": "0491d27ab1331b63cc0830cecca2b0adea2fd418", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3OTk2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489179962", "bodyText": "Updated", "author": "abanthiy", "createdAt": "2020-09-16T05:54:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNTkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNjg2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488316863", "bodyText": "Is this message correct? Why not moving this check to the beginning before ipcInfo is created?", "author": "hui-yang", "createdAt": "2020-09-15T00:49:38Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/modules/CLIService.java", "diffHunk": "@@ -60,42 +78,101 @@\n     @Inject\n     private DeploymentStatusKeeper deploymentStatusKeeper;\n \n+    @Inject\n+    private AuthenticationHandler authenticationHandler;\n+\n+    @Inject\n+    private Kernel kernel;\n+\n     public CLIService(Topics topics) {\n         super(topics);\n     }\n \n     /**\n      * Constructor for unit testing.\n      * @param topics Service config\n+     * @param privateConfig Private config for the service\n      * @param router {@link IPCRouter}\n      * @param agent {@link CLIServiceAgent}\n      * @param deploymentStatusKeeper {@link DeploymentStatusKeeper}\n+     * @param authenticationHandler {@link AuthenticationHandler}\n+     * @param kernel {@link Kernel}\n      */\n-    public CLIService(Topics topics, IPCRouter router, CLIServiceAgent agent,\n-                      DeploymentStatusKeeper deploymentStatusKeeper) {\n-        super(topics);\n+    public CLIService(Topics topics, Topics privateConfig, IPCRouter router, CLIServiceAgent agent,\n+                      DeploymentStatusKeeper deploymentStatusKeeper, AuthenticationHandler authenticationHandler,\n+                      Kernel kernel) {\n+        super(topics, privateConfig);\n         this.router = router;\n         this.agent = agent;\n         this.deploymentStatusKeeper = deploymentStatusKeeper;\n+        this.authenticationHandler = authenticationHandler;\n+        this.kernel = kernel;\n     }\n \n     @Override\n     public void postInject() {\n         BuiltInServiceDestinationCode destination = BuiltInServiceDestinationCode.CLI;\n         super.postInject();\n+        // Does not happen for built-in/plugin services so doing explicitly\n+        AuthenticationHandler.registerAuthenticationToken(this);\n         try {\n             router.registerServiceCallback(destination.getValue(), this::handleMessage);\n             logger.atInfo().setEventType(\"ipc-register-request-handler\").addKeyValue(\"destination\", destination.name())\n                     .log();\n             deploymentStatusKeeper.registerDeploymentStatusConsumer(Deployment.DeploymentType.LOCAL,\n                     this::deploymentStatusChanged, CLIService.class.getName());\n+\n         } catch (IPCException e) {\n             logger.atError().setEventType(\"ipc-register-request-handler-error\").setCause(e)\n                     .addKeyValue(\"destination\", destination.name())\n                     .log(\"Failed to register service callback to destination\");\n         }\n     }\n \n+    @Override\n+    protected void startup() {\n+        try {\n+            generateCliIpcInfo();\n+            reportState(State.RUNNING);\n+        } catch (IOException | UnauthenticatedException e) {\n+            logger.atError().setEventType(\"cli-ipc-info-generation-error\")\n+                    // CloseByInterrupt exception occurs in tests if the threads finish earlier than this method\n+                    // fnishes generating the cli ipc info file. This not setting the cause here.\n+                    .kv(\"errorMessage\", e.getMessage())\n+                    .log(\"Failed to create cli_ipc_info file\");\n+        }\n+    }\n+\n+    @SuppressFBWarnings(value = {\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\", \"RV_RETURN_VALUE_IGNORED\"},\n+            justification = \"File is created in the same method\")\n+    @SuppressWarnings(\"PMD.PrematureDeclaration\")\n+    private void generateCliIpcInfo() throws UnauthenticatedException, IOException {\n+        String cliAuthToken = authenticationHandler.registerAuthenticationTokenForExternalClient(\n+                Coerce.toString(getPrivateConfig().find(SERVICE_UNIQUE_ID_KEY)),\n+                GREENGRASS_CLI);\n+        Map<String, String> ipcInfo = new HashMap<>();\n+        ipcInfo.put(CLI_AUTH_TOKEN, cliAuthToken);\n+\n+        if (config.getRoot().find(SETENV_CONFIG_NAMESPACE, KERNEL_URI_ENV_VARIABLE_NAME) == null) {\n+            logger.atWarn().log(\"Did not find IPC socket URL in the config. Not creating the cli ipc info file\");", "originalCommit": "0491d27ab1331b63cc0830cecca2b0adea2fd418", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNzA3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r488317071", "bodyText": "Is this file for CLI to read? Why does CLIService needs to be a service?", "author": "hui-yang", "createdAt": "2020-09-15T00:50:25Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/modules/CLIService.java", "diffHunk": "@@ -60,42 +78,101 @@\n     @Inject\n     private DeploymentStatusKeeper deploymentStatusKeeper;\n \n+    @Inject\n+    private AuthenticationHandler authenticationHandler;\n+\n+    @Inject\n+    private Kernel kernel;\n+\n     public CLIService(Topics topics) {\n         super(topics);\n     }\n \n     /**\n      * Constructor for unit testing.\n      * @param topics Service config\n+     * @param privateConfig Private config for the service\n      * @param router {@link IPCRouter}\n      * @param agent {@link CLIServiceAgent}\n      * @param deploymentStatusKeeper {@link DeploymentStatusKeeper}\n+     * @param authenticationHandler {@link AuthenticationHandler}\n+     * @param kernel {@link Kernel}\n      */\n-    public CLIService(Topics topics, IPCRouter router, CLIServiceAgent agent,\n-                      DeploymentStatusKeeper deploymentStatusKeeper) {\n-        super(topics);\n+    public CLIService(Topics topics, Topics privateConfig, IPCRouter router, CLIServiceAgent agent,\n+                      DeploymentStatusKeeper deploymentStatusKeeper, AuthenticationHandler authenticationHandler,\n+                      Kernel kernel) {\n+        super(topics, privateConfig);\n         this.router = router;\n         this.agent = agent;\n         this.deploymentStatusKeeper = deploymentStatusKeeper;\n+        this.authenticationHandler = authenticationHandler;\n+        this.kernel = kernel;\n     }\n \n     @Override\n     public void postInject() {\n         BuiltInServiceDestinationCode destination = BuiltInServiceDestinationCode.CLI;\n         super.postInject();\n+        // Does not happen for built-in/plugin services so doing explicitly\n+        AuthenticationHandler.registerAuthenticationToken(this);\n         try {\n             router.registerServiceCallback(destination.getValue(), this::handleMessage);\n             logger.atInfo().setEventType(\"ipc-register-request-handler\").addKeyValue(\"destination\", destination.name())\n                     .log();\n             deploymentStatusKeeper.registerDeploymentStatusConsumer(Deployment.DeploymentType.LOCAL,\n                     this::deploymentStatusChanged, CLIService.class.getName());\n+\n         } catch (IPCException e) {\n             logger.atError().setEventType(\"ipc-register-request-handler-error\").setCause(e)\n                     .addKeyValue(\"destination\", destination.name())\n                     .log(\"Failed to register service callback to destination\");\n         }\n     }\n \n+    @Override\n+    protected void startup() {\n+        try {\n+            generateCliIpcInfo();\n+            reportState(State.RUNNING);\n+        } catch (IOException | UnauthenticatedException e) {\n+            logger.atError().setEventType(\"cli-ipc-info-generation-error\")\n+                    // CloseByInterrupt exception occurs in tests if the threads finish earlier than this method\n+                    // fnishes generating the cli ipc info file. This not setting the cause here.\n+                    .kv(\"errorMessage\", e.getMessage())\n+                    .log(\"Failed to create cli_ipc_info file\");\n+        }\n+    }\n+\n+    @SuppressFBWarnings(value = {\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\", \"RV_RETURN_VALUE_IGNORED\"},\n+            justification = \"File is created in the same method\")\n+    @SuppressWarnings(\"PMD.PrematureDeclaration\")\n+    private void generateCliIpcInfo() throws UnauthenticatedException, IOException {\n+        String cliAuthToken = authenticationHandler.registerAuthenticationTokenForExternalClient(\n+                Coerce.toString(getPrivateConfig().find(SERVICE_UNIQUE_ID_KEY)),\n+                GREENGRASS_CLI);\n+        Map<String, String> ipcInfo = new HashMap<>();\n+        ipcInfo.put(CLI_AUTH_TOKEN, cliAuthToken);\n+\n+        if (config.getRoot().find(SETENV_CONFIG_NAMESPACE, KERNEL_URI_ENV_VARIABLE_NAME) == null) {\n+            logger.atWarn().log(\"Did not find IPC socket URL in the config. Not creating the cli ipc info file\");\n+            return;\n+        } else {\n+            //TODO: Change the URL as per the new IPC\n+            ipcInfo.put(SOCKET_URL, Coerce.toString(\n+                    config.getRoot().find(SETENV_CONFIG_NAMESPACE, KERNEL_URI_ENV_VARIABLE_NAME)));\n+        }\n+\n+        Path filePath = kernel.getRootPath().resolve(CLI_IPC_INFO_FILENAME);", "originalCommit": "0491d27ab1331b63cc0830cecca2b0adea2fd418", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NTY3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489175679", "bodyText": "Yes this file is for CLI to read. CLIService needs to be a service as it needs to setup the handlers for CLI APIs and will also install greengrass-cli on the device.", "author": "abanthiy", "createdAt": "2020-09-16T05:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNzA3MQ=="}], "type": "inlineReview"}, {"oid": "858451ea0277b4660b18d00e46e0f3b4f97c6f19", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/858451ea0277b4660b18d00e46e0f3b4f97c6f19", "message": "Addressing PR comments", "committedDate": "2020-09-15T02:08:38Z", "type": "forcePushed"}, {"oid": "da1d51ebae3efe274d3d2eb6c92ec05e518d8b53", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da1d51ebae3efe274d3d2eb6c92ec05e518d8b53", "message": "Using ipc connect retry and ignoring ConnectException in CLI tests", "committedDate": "2020-09-15T22:00:16Z", "type": "forcePushed"}, {"oid": "71b414fc34217867254c0a44c95b893208e25c1a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/71b414fc34217867254c0a44c95b893208e25c1a", "message": "Adding debug logs for socket connect exception", "committedDate": "2020-09-15T22:53:54Z", "type": "forcePushed"}, {"oid": "80c183092836d3cd75d546891ab59fc74b357fa8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/80c183092836d3cd75d546891ab59fc74b357fa8", "message": "Adding debug logs for socket connect exception", "committedDate": "2020-09-15T22:56:40Z", "type": "forcePushed"}, {"oid": "d06772366c4d0aa8a4a77b4d985b1bd442cb7d4e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d06772366c4d0aa8a4a77b4d985b1bd442cb7d4e", "message": "Adding debug logs for socket connect exception", "committedDate": "2020-09-15T23:42:49Z", "type": "forcePushed"}, {"oid": "40c6595353e4dc0eb420c5d3e1d0ec5730457b41", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/40c6595353e4dc0eb420c5d3e1d0ec5730457b41", "message": "Adding debug logs for socket connect exception", "committedDate": "2020-09-15T23:48:34Z", "type": "forcePushed"}, {"oid": "832d4ab4667bbd3c802cf9f15c0601a52cf212a5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/832d4ab4667bbd3c802cf9f15c0601a52cf212a5", "message": "Adding debug logs for socket connect exception", "committedDate": "2020-09-16T02:39:16Z", "type": "forcePushed"}, {"oid": "2b7a4c26f5676bbda73274cf672c819d069e5927", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2b7a4c26f5676bbda73274cf672c819d069e5927", "message": "Adding debug logs for socket connect exception", "committedDate": "2020-09-16T02:48:47Z", "type": "forcePushed"}, {"oid": "29135b5d1ce97c4300f5e17e1996dca72f3df3ef", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/29135b5d1ce97c4300f5e17e1996dca72f3df3ef", "message": "Adding debug logs for socket connect exception", "committedDate": "2020-09-16T02:52:04Z", "type": "forcePushed"}, {"oid": "6965f5aa770a99f51e5956e5e2fe9160b6b841bf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6965f5aa770a99f51e5956e5e2fe9160b6b841bf", "message": "Generating authentication token for CLI and storing in a file", "committedDate": "2020-09-16T03:09:31Z", "type": "commit"}, {"oid": "f41eae11ebd5e3f6ee649549841d1c9fd77f96ab", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f41eae11ebd5e3f6ee649549841d1c9fd77f96ab", "message": "Changing logs in pubsub agent to info from debug", "committedDate": "2020-09-16T03:09:31Z", "type": "commit"}, {"oid": "9150c2e3028e90e6f8c16c11fd1638fc95cb34a4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9150c2e3028e90e6f8c16c11fd1638fc95cb34a4", "message": "Using modified IPC Client with new thread pool and closing connection in IotConnectionManager. Updating test to avoid IPC Server exception.", "committedDate": "2020-09-16T03:09:31Z", "type": "commit"}, {"oid": "8816be42d64513d3eb6e6439cf5ab1f0bb361793", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8816be42d64513d3eb6e6439cf5ab1f0bb361793", "message": "Reverting the timeout values to 2 seconds and reverting the info logs to debug in PubSubAgent", "committedDate": "2020-09-16T03:09:31Z", "type": "commit"}, {"oid": "b4462a82887feca5de06b7cc5c4c891c7d39a771", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b4462a82887feca5de06b7cc5c4c891c7d39a771", "message": "Changing evergreen sdk version to snapshot", "committedDate": "2020-09-16T03:09:31Z", "type": "commit"}, {"oid": "3c60708d7ebab2383ba2f5ecfcfcabddf59b3af4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3c60708d7ebab2383ba2f5ecfcfcabddf59b3af4", "message": "Addressing PR comments", "committedDate": "2020-09-16T03:09:31Z", "type": "commit"}, {"oid": "245bfb63ed3a60835bebffa460e19f1535e51ac0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/245bfb63ed3a60835bebffa460e19f1535e51ac0", "message": "Using ipc connect retry and ignoring ConnectException in CLI tests", "committedDate": "2020-09-16T03:09:31Z", "type": "commit"}, {"oid": "6956c3bf64ff38fd3b3a44ccf117381ab368c114", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6956c3bf64ff38fd3b3a44ccf117381ab368c114", "message": "Adding debug logs for socket connect exception", "committedDate": "2020-09-16T03:09:31Z", "type": "forcePushed"}, {"oid": "bb33ab2f56d1ebf8e9376efe6560fdb5dc07c03e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bb33ab2f56d1ebf8e9376efe6560fdb5dc07c03e", "message": "Setting temp directory as root in IPCUtils", "committedDate": "2020-09-16T05:12:47Z", "type": "commit"}, {"oid": "bb33ab2f56d1ebf8e9376efe6560fdb5dc07c03e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bb33ab2f56d1ebf8e9376efe6560fdb5dc07c03e", "message": "Setting temp directory as root in IPCUtils", "committedDate": "2020-09-16T05:12:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NzA2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489177060", "bodyText": "any reason why we are only getting this for CLI and none of the other IPC tests?", "author": "MikeDombo", "createdAt": "2020-09-16T05:46:08Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java", "diffHunk": "@@ -75,25 +83,41 @@\n class IPCCliTest {\n \n     private static Kernel kernel;\n+    private static int LOCAL_DEPLOYMENT_TIMEOUT_MINUTES = 5;\n+    private static int SERVICE_STATE_CHECK_TIMEOUT_MINUTES = 5;\n     private IPCClient client;\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n+                    .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n \n     @BeforeEach\n-    void beforeEach(ExtensionContext context) throws InterruptedException {\n+    void beforeEach(ExtensionContext context) throws InterruptedException, IOException {\n+        ignoreExceptionOfType(context, ConnectException.class);", "originalCommit": "bb33ab2f56d1ebf8e9376efe6560fdb5dc07c03e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE4Mzk5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489183990", "bodyText": "Its because of reading from the file. File gets overwritten in every test but test does not read the updated file somehow. Added new kernel root for each test now.", "author": "abanthiy", "createdAt": "2020-09-16T06:05:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NzA2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NzEyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489177126", "bodyText": "await", "author": "MikeDombo", "createdAt": "2020-09-16T05:46:22Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCCliTest.java", "diffHunk": "@@ -75,25 +83,41 @@\n class IPCCliTest {\n \n     private static Kernel kernel;\n+    private static int LOCAL_DEPLOYMENT_TIMEOUT_MINUTES = 5;\n+    private static int SERVICE_STATE_CHECK_TIMEOUT_MINUTES = 5;\n     private IPCClient client;\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n+                    .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n \n     @BeforeEach\n-    void beforeEach(ExtensionContext context) throws InterruptedException {\n+    void beforeEach(ExtensionContext context) throws InterruptedException, IOException {\n+        ignoreExceptionOfType(context, ConnectException.class);\n         ignoreExceptionWithMessage(context, \"Connection reset by peer\");\n         // Ignore if IPC can't send us more lifecycle updates because the test is already done.\n         ignoreExceptionUltimateCauseWithMessage(context, \"Channel not found for given connection context\");\n         kernel = prepareKernelFromConfigFile(\"ipc.yaml\", TEST_SERVICE_NAME, this.getClass());\n+        //wait for CLI Service to be up and running\n+        CountDownLatch cliServiceLatch = new CountDownLatch(1);\n+        kernel.getContext().addGlobalStateChangeListener((s, o, n)->{\n+            if (s.getName().equals(CLI_SERVICE) && n == State.RUNNING) {\n+                cliServiceLatch.countDown();\n+            }\n+        });\n+        cliServiceLatch.countDown();", "originalCommit": "bb33ab2f56d1ebf8e9376efe6560fdb5dc07c03e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NzY2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489177667", "bodyText": "Please use @TempDir which will cleanup after the test.", "author": "MikeDombo", "createdAt": "2020-09-16T05:47:56Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCTestUtils.java", "diffHunk": "@@ -38,9 +40,10 @@ public static KernelIPCClientConfig getIPCConfigForService(String serviceName, K\n                         .getOnce())).build();\n     }\n \n-    public static Kernel prepareKernelFromConfigFile(String configFile, String serviceName, Class testClass) throws InterruptedException {\n+    public static Kernel prepareKernelFromConfigFile(String configFile, String serviceName, Class testClass) throws InterruptedException, IOException {\n         Kernel kernel = new Kernel();\n-        kernel.parseArgs(\"-i\", testClass.getResource(configFile).toString());\n+        String rootDirectoryPath = Files.createTempDirectory(\"ipcCliTest\").toString();", "originalCommit": "bb33ab2f56d1ebf8e9376efe6560fdb5dc07c03e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE5NTQ5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489195491", "bodyText": "I want to generate new directory for every test.", "author": "abanthiy", "createdAt": "2020-09-16T06:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NzY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU0MDQ2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489540461", "bodyText": "TempDir on a non-static field will make a new one for each test", "author": "MikeDombo", "createdAt": "2020-09-16T15:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NzY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1OTk3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/434#discussion_r489559974", "bodyText": "Not needed anymore", "author": "abanthiy", "createdAt": "2020-09-16T16:14:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NzY2Nw=="}], "type": "inlineReview"}, {"oid": "357063cdae2f9b29fa94c87a23cf55c8b4012fb0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/357063cdae2f9b29fa94c87a23cf55c8b4012fb0", "message": "Addressing PR comments", "committedDate": "2020-09-16T06:37:01Z", "type": "forcePushed"}, {"oid": "d73879b90032ec88fbe90de192fd85b99b62f47f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d73879b90032ec88fbe90de192fd85b99b62f47f", "message": "Addressing PR comments", "committedDate": "2020-09-16T06:51:07Z", "type": "forcePushed"}, {"oid": "82dc23b265245f980c5fb84757b8843a00d43527", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/82dc23b265245f980c5fb84757b8843a00d43527", "message": "Addressing PR comments", "committedDate": "2020-09-16T07:39:43Z", "type": "forcePushed"}, {"oid": "ef5baa85e1c67d4d83a46606273c979b0ab13674", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ef5baa85e1c67d4d83a46606273c979b0ab13674", "message": "Addressing PR comments", "committedDate": "2020-09-16T07:55:11Z", "type": "forcePushed"}, {"oid": "ab742cea367b262daf2ed933dbf7d5a3c7f2ee4f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ab742cea367b262daf2ed933dbf7d5a3c7f2ee4f", "message": "Addressing PR comments", "committedDate": "2020-09-16T08:01:01Z", "type": "commit"}, {"oid": "ab742cea367b262daf2ed933dbf7d5a3c7f2ee4f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ab742cea367b262daf2ed933dbf7d5a3c7f2ee4f", "message": "Addressing PR comments", "committedDate": "2020-09-16T08:01:01Z", "type": "forcePushed"}]}