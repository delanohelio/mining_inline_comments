{"pr_number": 693, "pr_title": "TES clear cache", "pr_createdAt": "2020-11-17T17:59:15Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693", "timeline": [{"oid": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "message": "TES clear cache", "committedDate": "2020-11-17T18:11:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMDA5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525400094", "bodyText": "Nit: remove whitespace", "author": "rbattle", "createdAt": "2020-11-17T18:43:01Z", "path": "src/main/java/com/aws/greengrass/tes/CredentialRequestHandler.java", "diffHunk": "@@ -340,7 +340,22 @@ private Instant getExpiryPolicyForErr(int statusCode) {\n      */\n     private boolean areCredentialsValid(TESCache cacheEntry) {\n         Instant now = Instant.now(clock);\n-        return now.isBefore(cacheEntry.expiry);\n+        return cacheEntry.credentials != null && now.isBefore(cacheEntry.expiry);\n+    }\n+\n+    /**\n+     * Clear cached credentials.\n+     *\n+     */", "originalCommit": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzOTg0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525439845", "bodyText": "thanks. removed", "author": "youtuyy", "createdAt": "2020-11-17T19:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMDA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDQ0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525404446", "bodyText": "can tesCache.get(iotCredentialsPath) ever be null? it doesn't appear to be checked elsewhere", "author": "rbattle", "createdAt": "2020-11-17T18:49:55Z", "path": "src/main/java/com/aws/greengrass/tes/CredentialRequestHandler.java", "diffHunk": "@@ -340,7 +340,22 @@ private Instant getExpiryPolicyForErr(int statusCode) {\n      */\n     private boolean areCredentialsValid(TESCache cacheEntry) {\n         Instant now = Instant.now(clock);\n-        return now.isBefore(cacheEntry.expiry);\n+        return cacheEntry.credentials != null && now.isBefore(cacheEntry.expiry);\n+    }\n+\n+    /**\n+     * Clear cached credentials.\n+     *\n+     */\n+    @SuppressWarnings(\"PMD.NullAssignment\")\n+    public void clearCache() {\n+        if (iotCredentialsPath != null && tesCache.get(iotCredentialsPath) != null) {", "originalCommit": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzOTk3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525439975", "bodyText": "yeah you're right. it will not be null. checking if key exists instead", "author": "youtuyy", "createdAt": "2020-11-17T19:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDkyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525404926", "bodyText": "does the credential path ever change? does the map ever get cleared of entries?", "author": "rbattle", "createdAt": "2020-11-17T18:50:38Z", "path": "src/main/java/com/aws/greengrass/tes/CredentialRequestHandler.java", "diffHunk": "@@ -340,7 +340,22 @@ private Instant getExpiryPolicyForErr(int statusCode) {\n      */\n     private boolean areCredentialsValid(TESCache cacheEntry) {\n         Instant now = Instant.now(clock);\n-        return now.isBefore(cacheEntry.expiry);\n+        return cacheEntry.credentials != null && now.isBefore(cacheEntry.expiry);\n+    }\n+\n+    /**\n+     * Clear cached credentials.\n+     *\n+     */\n+    @SuppressWarnings(\"PMD.NullAssignment\")\n+    public void clearCache() {\n+        if (iotCredentialsPath != null && tesCache.get(iotCredentialsPath) != null) {\n+            LOGGER.atDebug().kv(IOT_CRED_PATH_KEY, iotCredentialsPath).log(\"Clearing TES cache\");\n+            TESCache cacheEntry = tesCache.get(iotCredentialsPath);\n+            cacheEntry.credentials = null;\n+            cacheEntry.responseCode = 0;\n+            cacheEntry.expiry = Instant.EPOCH;", "originalCommit": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0MDA3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525440079", "bodyText": "iotCredentialsPath will be changed when new iotRoleAlias is set. here it will only reset the values of entries to its default, but the map will not be cleared", "author": "youtuyy", "createdAt": "2020-11-17T19:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYxMDU0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525610549", "bodyText": "isn't this a tiny memory leak then if it never gets removed? Is there any harm in removing it?", "author": "rbattle", "createdAt": "2020-11-18T00:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYxNDUxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525614511", "bodyText": "Talked with @youtuyy - if the role alias is changed, the kernel restarts so this cache will be discarded", "author": "rbattle", "createdAt": "2020-11-18T00:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDkyNg=="}], "type": "inlineReview"}, {"oid": "df807723b3f18531fadd393e69fdf4ee15e010d7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/df807723b3f18531fadd393e69fdf4ee15e010d7", "message": "TES clear cache", "committedDate": "2020-11-17T19:38:32Z", "type": "commit"}, {"oid": "df807723b3f18531fadd393e69fdf4ee15e010d7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/df807723b3f18531fadd393e69fdf4ee15e010d7", "message": "TES clear cache", "committedDate": "2020-11-17T19:38:32Z", "type": "forcePushed"}, {"oid": "a230ec4f942d033fa0be6f0a6bbdde578ff0a07e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a230ec4f942d033fa0be6f0a6bbdde578ff0a07e", "message": "Merge branch 'master' into tes-cache", "committedDate": "2020-11-17T20:45:33Z", "type": "commit"}, {"oid": "0ed309a31fa575d7fc4b732fbf1e5fc1c3050d33", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0ed309a31fa575d7fc4b732fbf1e5fc1c3050d33", "message": "Merge branch 'master' into tes-cache", "committedDate": "2020-11-17T23:27:54Z", "type": "commit"}]}