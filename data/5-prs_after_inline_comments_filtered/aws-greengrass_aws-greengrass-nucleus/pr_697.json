{"pr_number": 697, "pr_title": "Recipe storage upgrade so that it is cross platform safe.", "pr_createdAt": "2020-11-18T00:32:20Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/697", "timeline": [{"oid": "0845638e041b86718952e8e49be3eb95fc461b90", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0845638e041b86718952e8e49be3eb95fc461b90", "message": "save", "committedDate": "2020-11-12T22:30:27Z", "type": "commit"}, {"oid": "cfc94570b0f3dc23b6a3f6aa5a0304ffd09e92dc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cfc94570b0f3dc23b6a3f6aa5a0304ffd09e92dc", "message": "merged; src code; ready for some test", "committedDate": "2020-11-13T02:09:40Z", "type": "commit"}, {"oid": "57de9341227ee045b1c51f1c738c8a591893b322", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/57de9341227ee045b1c51f1c738c8a591893b322", "message": "No unit test yet. But one E2E passed. Open for early review", "committedDate": "2020-11-13T03:17:15Z", "type": "commit"}, {"oid": "c93a4e8409cc042ca13312a8831407bc356959ad", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c93a4e8409cc042ca13312a8831407bc356959ad", "message": "Merge remote-tracking branch 'origin/master' into use_component_arn", "committedDate": "2020-11-13T07:16:43Z", "type": "commit"}, {"oid": "b02ccc5b50a39fa8d186ae397de9e00c12e59379", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b02ccc5b50a39fa8d186ae397de9e00c12e59379", "message": "try CI", "committedDate": "2020-11-13T08:44:08Z", "type": "commit"}, {"oid": "71ea2454f0a8304dea0d0a5c6593fe357ad50580", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/71ea2454f0a8304dea0d0a5c6593fe357ad50580", "message": "sage", "committedDate": "2020-11-14T00:31:02Z", "type": "commit"}, {"oid": "d75401466cd67b1daef1e6da8c4f6ed9a101c81b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d75401466cd67b1daef1e6da8c4f6ed9a101c81b", "message": "partial unit tests", "committedDate": "2020-11-14T06:22:57Z", "type": "commit"}, {"oid": "f551cdb1b026f51b07caf156ff78059b9cce244c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f551cdb1b026f51b07caf156ff78059b9cce244c", "message": "full unit test. Added cleanup", "committedDate": "2020-11-14T06:49:27Z", "type": "commit"}, {"oid": "eface81b58fec22735cd1cda16a7a0fb27647595", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eface81b58fec22735cd1cda16a7a0fb27647595", "message": "rename", "committedDate": "2020-11-14T07:11:01Z", "type": "commit"}, {"oid": "e6785c5719e7d7e89c7e5e4091321d1fab454ab0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e6785c5719e7d7e89c7e5e4091321d1fab454ab0", "message": "UAT passes", "committedDate": "2020-11-16T20:02:59Z", "type": "commit"}, {"oid": "8024fadfd0c872a4532a34b3b793f2028f78e2c9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8024fadfd0c872a4532a34b3b793f2028f78e2c9", "message": "merged", "committedDate": "2020-11-16T20:18:01Z", "type": "commit"}, {"oid": "7276ecf23afc1e83077baf978e8949b73e0ae231", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7276ecf23afc1e83077baf978e8949b73e0ae231", "message": "update test", "committedDate": "2020-11-16T20:20:10Z", "type": "commit"}, {"oid": "1bfccabb53659006b592ff494f7c5c98a319cc51", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1bfccabb53659006b592ff494f7c5c98a319cc51", "message": "update", "committedDate": "2020-11-16T20:42:10Z", "type": "commit"}, {"oid": "4ca4ff39f48d6f5eedd4e2fdc16460688d6bb4cd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ca4ff39f48d6f5eedd4e2fdc16460688d6bb4cd", "message": "manually rebase shirley's change", "committedDate": "2020-11-16T22:31:15Z", "type": "commit"}, {"oid": "255ac56ffc875a09b3cb590a6b018dd5a8948887", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/255ac56ffc875a09b3cb590a6b018dd5a8948887", "message": "Merge branch 'master' into use_component_arn", "committedDate": "2020-11-16T22:42:45Z", "type": "commit"}, {"oid": "3596c51989f4240457ed50223a1778f48e53db28", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3596c51989f4240457ed50223a1778f48e53db28", "message": "ready to run CI after painful rebases", "committedDate": "2020-11-16T23:02:54Z", "type": "commit"}, {"oid": "2fb131852ecb39b043befb8146083ed1d8746cce", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2fb131852ecb39b043befb8146083ed1d8746cce", "message": "save", "committedDate": "2020-11-16T23:45:09Z", "type": "commit"}, {"oid": "b6faedd4208ccc6c46248ce0d06777a894ec2cf3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b6faedd4208ccc6c46248ce0d06777a894ec2cf3", "message": "unit test", "committedDate": "2020-11-17T00:04:39Z", "type": "commit"}, {"oid": "5e1f0f04d12b6d0d1b401830a6cfc55c67fa35fc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5e1f0f04d12b6d0d1b401830a6cfc55c67fa35fc", "message": "hash TODO", "committedDate": "2020-11-17T00:06:46Z", "type": "commit"}, {"oid": "bd16aa04a97a6c6ab26037552b7dc5935ef2e131", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd16aa04a97a6c6ab26037552b7dc5935ef2e131", "message": "done. next step is to change unit test", "committedDate": "2020-11-17T00:44:57Z", "type": "commit"}, {"oid": "e092a69c1cdbd3654966ee71d5d4f5e4e198d35e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e092a69c1cdbd3654966ee71d5d4f5e4e198d35e", "message": "component unit test pending test", "committedDate": "2020-11-17T17:07:16Z", "type": "commit"}, {"oid": "a6a00323427cd2e6fb3e8c77c09e1406a0652d29", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a6a00323427cd2e6fb3e8c77c09e1406a0652d29", "message": "unit test done. next is local cli", "committedDate": "2020-11-17T17:34:40Z", "type": "commit"}, {"oid": "9ca8b5314933d2f47fc3efc1d67e963928171fa2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9ca8b5314933d2f47fc3efc1d67e963928171fa2", "message": "merge temp fix", "committedDate": "2020-11-17T17:39:03Z", "type": "commit"}, {"oid": "b5f11c3238774608f8ae85f6b8ca997df94b0042", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5f11c3238774608f8ae85f6b8ca997df94b0042", "message": "fix exception", "committedDate": "2020-11-17T17:43:43Z", "type": "commit"}, {"oid": "dac6762d0c66f78c9bb501a0682f868d15eb8506", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dac6762d0c66f78c9bb501a0682f868d15eb8506", "message": "need to deal with the local store content", "committedDate": "2020-11-17T21:25:20Z", "type": "commit"}, {"oid": "23aa271d63c3212fe0e12a43f83de211c14dee11", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/23aa271d63c3212fe0e12a43f83de211c14dee11", "message": "done", "committedDate": "2020-11-18T00:26:40Z", "type": "commit"}, {"oid": "84f058d00b028d5cf0ffe25b2c1811dfd134c7b6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/84f058d00b028d5cf0ffe25b2c1811dfd134c7b6", "message": "ready for a CI", "committedDate": "2020-11-18T00:29:45Z", "type": "commit"}, {"oid": "6a7bba8afa09d1f4e6a3b7ab2846d63a17963d24", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6a7bba8afa09d1f4e6a3b7ab2846d63a17963d24", "message": "fix code style", "committedDate": "2020-11-18T00:38:11Z", "type": "commit"}, {"oid": "992f11af10b50a79eca49cb56bb99a2613c77cd8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/992f11af10b50a79eca49cb56bb99a2613c77cd8", "message": "need by cli", "committedDate": "2020-11-18T01:00:42Z", "type": "commit"}, {"oid": "949dc6b98d8a55763133b1290a0cdbd5d5fafff2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/949dc6b98d8a55763133b1290a0cdbd5d5fafff2", "message": "rename back to avoid merge conflict", "committedDate": "2020-11-18T01:06:53Z", "type": "commit"}, {"oid": "d01747dfecdb850ac63f7eae0129071d1509d5e2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d01747dfecdb850ac63f7eae0129071d1509d5e2", "message": "merge from master", "committedDate": "2020-11-18T01:07:39Z", "type": "commit"}, {"oid": "b8eebaae5c7f41d8b6de589b9d3507ede86edec8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b8eebaae5c7f41d8b6de589b9d3507ede86edec8", "message": "Merge branch 'use_component_arn' into recipe_storage_upgrade", "committedDate": "2020-11-18T01:08:01Z", "type": "commit"}, {"oid": "0593ad906e18614b3b23e7bd7fcd8e74001ff1f5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0593ad906e18614b3b23e7bd7fcd8e74001ff1f5", "message": "save", "committedDate": "2020-11-18T02:07:48Z", "type": "commit"}, {"oid": "58f823378fa77a3bf7ba9c03202dcf57d5fadc40", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/58f823378fa77a3bf7ba9c03202dcf57d5fadc40", "message": "Fix E2E store path. Use pure temp staging folder, instead of preloading to the real component store", "committedDate": "2020-11-18T02:19:13Z", "type": "commit"}, {"oid": "b7c98b6f9c05a01cf3bb1b116ec064540c7ebb00", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b7c98b6f9c05a01cf3bb1b116ec064540c7ebb00", "message": "fix import", "committedDate": "2020-11-18T16:13:17Z", "type": "commit"}, {"oid": "9a16ca1d36bad87b80c8af87bbedf9eeb20c0da2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9a16ca1d36bad87b80c8af87bbedf9eeb20c0da2", "message": "fix the last E2E", "committedDate": "2020-11-18T16:18:27Z", "type": "commit"}, {"oid": "2075a1fa3727cf2d5d10f8f771289692e17bc9de", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2075a1fa3727cf2d5d10f8f771289692e17bc9de", "message": "mvn check pass", "committedDate": "2020-11-18T16:25:41Z", "type": "commit"}, {"oid": "7b2b4d128b091e4f9ef02bc10cde1b3e73885a1b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7b2b4d128b091e4f9ef02bc10cde1b3e73885a1b", "message": "merged. need to fix compile", "committedDate": "2020-11-23T22:08:46Z", "type": "commit"}, {"oid": "5f52e39a0036cb1a0cea3152b9b74304f5f9da71", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5f52e39a0036cb1a0cea3152b9b74304f5f9da71", "message": "unit and integ works; working on e2e", "committedDate": "2020-11-23T22:24:49Z", "type": "commit"}, {"oid": "68beb21102d99d48a9011ad9465b710391925929", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/68beb21102d99d48a9011ad9465b710391925929", "message": "e2e", "committedDate": "2020-11-23T22:30:08Z", "type": "commit"}, {"oid": "892fb63719a9f3732f1c646fcbe4d3afbc5c57bf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/892fb63719a9f3732f1c646fcbe4d3afbc5c57bf", "message": "fix pmd", "committedDate": "2020-11-23T22:55:51Z", "type": "commit"}, {"oid": "6ec21e8c7d0eaa40a44264eb562987f88dcc49c1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6ec21e8c7d0eaa40a44264eb562987f88dcc49c1", "message": "fix e2e", "committedDate": "2020-11-23T23:20:28Z", "type": "commit"}, {"oid": "93c3b63672754aeb3b6bdf6a1abc2fd3bf14138f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/93c3b63672754aeb3b6bdf6a1abc2fd3bf14138f", "message": "fix some more preload", "committedDate": "2020-11-24T00:36:06Z", "type": "commit"}, {"oid": "90c6c4cfa04c631f3855bd91817188f149fb1ff7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/90c6c4cfa04c631f3855bd91817188f149fb1ff7", "message": "use CI to publish nucleus-1.0-recipe_storage_upgrade-SNAPSHOT to maven so that CLI CI can consume", "committedDate": "2020-11-24T00:46:43Z", "type": "commit"}, {"oid": "c479424425ccb96ca6f52168c72a26bffbd27f58", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c479424425ccb96ca6f52168c72a26bffbd27f58", "message": "Merge branch 'master' into recipe_storage_upgrade", "committedDate": "2020-11-24T00:46:57Z", "type": "commit"}, {"oid": "509efd329fae2dc3da5f675a8042d5295e7401b6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/509efd329fae2dc3da5f675a8042d5295e7401b6", "message": "use CI to publish nucleus-1.0-recipe_storage_upgrade-SNAPSHOT to maven so that CLI CI can consume", "committedDate": "2020-11-24T00:48:18Z", "type": "commit"}, {"oid": "61861dcd661bcadcf637ad9a02321adffaed4d32", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/61861dcd661bcadcf637ad9a02321adffaed4d32", "message": "done", "committedDate": "2020-11-24T01:01:10Z", "type": "commit"}, {"oid": "ba01ab80118a6a1ffb25d67da868284bb14c61bc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba01ab80118a6a1ffb25d67da868284bb14c61bc", "message": "get CI back", "committedDate": "2020-11-24T01:01:42Z", "type": "commit"}, {"oid": "e784604bdcb6071bf83231ab5221df5507eee85c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e784604bdcb6071bf83231ab5221df5507eee85c", "message": "get CI back", "committedDate": "2020-11-24T01:02:30Z", "type": "commit"}, {"oid": "7f40ea217304d3c14fe079a24af5b769a486b657", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7f40ea217304d3c14fe079a24af5b769a486b657", "message": "more refactoring", "committedDate": "2020-11-24T01:20:20Z", "type": "commit"}, {"oid": "217037738af17df8c993e10ab45bf39f7f1250b5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/217037738af17df8c993e10ab45bf39f7f1250b5", "message": "more refactoring", "committedDate": "2020-11-24T01:29:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTExMjI0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/697#discussion_r529112246", "bodyText": "Doesn't this break local deployments?", "author": "MikeDombo", "createdAt": "2020-11-24T01:38:37Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -239,41 +244,56 @@ ComponentMetadata getPackageMetadata(@NonNull ComponentIdentifier pkgId) throws\n         return new ComponentMetadata(pkgId, dependencyMetadata);\n     }\n \n+    Optional<ComponentIdentifier> findBestMatchAvailableComponent(@NonNull String componentName,\n+                                                                  @NonNull Requirement requirement)\n+            throws PackageLoadingException {\n+        List<ComponentIdentifier> componentIdentifierList = listAvailableComponent(componentName, requirement);\n+\n+        if (componentIdentifierList.isEmpty()) {\n+            return Optional.empty();\n+        } else {\n+            return Optional.of(componentIdentifierList.get(0));\n+        }\n+    }\n+\n     /**\n-     * list PackageMetadata for available packages that satisfies the requirement.\n-     *\n-     * @param packageName the target package\n-     * @param requirement version requirement\n-     * @return a list of PackageMetadata that satisfies the requirement.\n-     * @throws UnexpectedPackagingException if fails to parse version directory to Semver\n+     * List available component (versions) that satisfies the requirement in descending order.\n+     * @param componentName target component's name\n+     * @param requirement   semver requirement\n+     * @return component id list contains all satisfied version, in descending order\n+     * @throws PackageLoadingException  when fails to read recipe directory or parse recipe file name\n      */\n-    List<ComponentMetadata> listAvailablePackageMetadata(@NonNull String packageName, @NonNull Requirement requirement)\n-            throws PackagingException {\n-        File[] recipeFiles = getAllRecipeFiles();\n+    List<ComponentIdentifier> listAvailableComponent(@NonNull String componentName, @NonNull Requirement requirement)", "originalCommit": "217037738af17df8c993e10ab45bf39f7f1250b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyNDUwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/697#discussion_r529124506", "bodyText": "Nah. The old one isn't used any more except in the unit test. It can be safely removed.\nNew logic all changed to use the listAvailableComponent which returns the list of id.", "author": "leaf94", "createdAt": "2020-11-24T01:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTExMjI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyNjQ1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/697#discussion_r529126454", "bodyText": "But if you're now looking for very specifically named recipe files, that will break the local deployment", "author": "MikeDombo", "createdAt": "2020-11-24T01:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTExMjI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc1OTA5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/697#discussion_r529759097", "bodyText": "Synced offline and we are good. I also got a corresponding cli change: aws-greengrass/aws-greengrass-cli#80. Added to the PR description so that others can also be aware.", "author": "leaf94", "createdAt": "2020-11-24T17:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTExMjI0Ng=="}], "type": "inlineReview"}, {"oid": "134e10015f11e12b4a4a4f608395f2c1543d110b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/134e10015f11e12b4a4a4f608395f2c1543d110b", "message": "Add README", "committedDate": "2020-11-24T01:54:07Z", "type": "commit"}, {"oid": "f68cafc3b576abb52c36d2bd652be9a68363bef3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f68cafc3b576abb52c36d2bd652be9a68363bef3", "message": "Publish 1.0-recipe_storage_upgrade_1 for cli to consume", "committedDate": "2020-11-24T17:02:38Z", "type": "commit"}, {"oid": "c646205f3c2b68bbcbe0e7cc3400cb6970cb0214", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c646205f3c2b68bbcbe0e7cc3400cb6970cb0214", "message": "publish with SNAPSHOT", "committedDate": "2020-11-24T17:11:05Z", "type": "commit"}, {"oid": "e41d25c7af4cd94f919879bf8e214674eeaed96d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e41d25c7af4cd94f919879bf8e214674eeaed96d", "message": "back", "committedDate": "2020-11-24T17:29:48Z", "type": "commit"}]}