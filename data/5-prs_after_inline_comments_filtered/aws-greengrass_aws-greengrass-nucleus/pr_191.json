{"pr_number": 191, "pr_title": "Add integration with Package Management Service", "pr_createdAt": "2020-04-17T17:48:20Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191", "timeline": [{"oid": "c5d9155d7ae8fdb5d621570aa515523483674c7c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c5d9155d7ae8fdb5d621570aa515523483674c7c", "message": "Add integration with Package Management Service", "committedDate": "2020-04-23T15:56:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0MzQ3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414043475", "bodyText": "Why set this here? Why not just set it in the field?", "author": "MikeDombo", "createdAt": "2020-04-23T18:53:39Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,76 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_TYPE_YAML = \"YAML\";\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger;\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);", "originalCommit": "5c9486b3825354fb8afea977e6b85d7a9e91823b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzAzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414057033", "bodyText": "Fixing in update", "author": "chaurah", "createdAt": "2020-04-23T19:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0MzQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0NDI5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414044295", "bodyText": "I could be wrong, but I thought that the object mapper had a bytebuffer overload so you don't need to copy it into a byte[].", "author": "MikeDombo", "createdAt": "2020-04-23T18:54:53Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,76 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_TYPE_YAML = \"YAML\";\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger;\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n+    }\n+\n     @SuppressWarnings({\"PMD.UnusedLocalVariable\"})\n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier) throws PackageDownloadException {\n-        // TODO: to be implemented.\n-        return null;\n+        GetPackageRequest getPackageRequest =\n+                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n+                                       .withType(PACKAGE_RECIPE_TYPE_YAML);\n+        GetPackageResult getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+\n+        // TODO: Currently getPackageResult doesn't have http status code in the object.\n+        // Uncomment below code once the model is updated\n+\n+        /*\n+            Potential responses:\n+            - 302: See Other (Redirects to pre-signed S3 URL)\n+            - 400: Invalid Input\n+            - 403: Forbidden\n+            - 404: Resource Not Found\n+         */\n+        /*int responseStatus = getPackageResult.getStatusCode();\n+        if (responseStatus != HttpURLConnection.HTTP_SEE_OTHER) {\n+            logger.atError(\"download-recipe-from-greengrass-repo\")\n+                  .addKeyValue(\"packageIdentifier\", packageIdentifier)\n+                  .addKeyValue(\"failureCode\", responseStatus)\n+                  .log();\n+            throw new PackageDownloadException(String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT,\n+                                                             packageIdentifier.getArn());\n+        }*/\n+\n+        try {\n+            ByteBuffer recipeBuf = getPackageResult.getRecipe();\n+            byte [] recipe = new byte[recipeBuf.remaining()];\n+            recipeBuf.get(recipe);\n+            return OBJECT_MAPPER.readValue(recipe, PackageRecipe.class);", "originalCommit": "5c9486b3825354fb8afea977e6b85d7a9e91823b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0OTA5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414049094", "bodyText": "No I checked for that, not an option unfortunately.", "author": "chaurah", "createdAt": "2020-04-23T19:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0NDI5NQ=="}], "type": "inlineReview"}, {"oid": "60c2bf328fa6fa7ebfd7b823c42dae5314882fc5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/60c2bf328fa6fa7ebfd7b823c42dae5314882fc5", "message": "Add integration with Package Management Service", "committedDate": "2020-04-23T21:20:29Z", "type": "forcePushed"}, {"oid": "53934839fa7b27b39284705dd288f011ab984eef", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/53934839fa7b27b39284705dd288f011ab984eef", "message": "Add integration with Package Management Service", "committedDate": "2020-04-23T23:05:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5Mzc4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414193782", "bodyText": ".log()?", "author": "hui-yang", "createdAt": "2020-04-23T23:37:50Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.amazonaws.client.builder.AwsClientBuilder;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagementClientBuilder;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Utils;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+@Getter\n+@Setter\n+public class GreengrassPackageServiceClientFactory {\n+\n+    private static final Logger logger = LogManager.getLogger(GreengrassPackageServiceClientFactory.class);\n+\n+    private final AWSGreengrassPackageManagement pmsClient;\n+\n+    /**\n+     * Constructor with custom endpoint/region configuration.\n+     *\n+     * @param greengrassServiceEndpoint String containing service endpoint\n+     * @param greengrassServiceRegion String containing service region\n+     */\n+    @Inject\n+    public GreengrassPackageServiceClientFactory(\n+            @Named(\"greengrassServiceEndpoint\") String greengrassServiceEndpoint,\n+            @Named(\"greengrassServiceRegion\") String greengrassServiceRegion) {\n+\n+        if (Utils.isEmpty(greengrassServiceEndpoint) || Utils.isEmpty(greengrassServiceRegion)) {\n+            // Initialize default client, client builder determines endpoint configuration\n+            // Will try to use default credential provider and environment region configuration\n+            logger.atInfo(\"initialize-pms-client\")\n+                  .addKeyValue(\"service-endpoint\", \"default\")\n+                  .addKeyValue(\"service-region\", \"default\");", "originalCommit": "53934839fa7b27b39284705dd288f011ab984eef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMTg3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414211878", "bodyText": "Fixing.", "author": "chaurah", "createdAt": "2020-04-24T00:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5Mzc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5MzkxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414193919", "bodyText": "same", "author": "hui-yang", "createdAt": "2020-04-23T23:38:10Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.amazonaws.client.builder.AwsClientBuilder;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagementClientBuilder;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Utils;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+@Getter\n+@Setter\n+public class GreengrassPackageServiceClientFactory {\n+\n+    private static final Logger logger = LogManager.getLogger(GreengrassPackageServiceClientFactory.class);\n+\n+    private final AWSGreengrassPackageManagement pmsClient;\n+\n+    /**\n+     * Constructor with custom endpoint/region configuration.\n+     *\n+     * @param greengrassServiceEndpoint String containing service endpoint\n+     * @param greengrassServiceRegion String containing service region\n+     */\n+    @Inject\n+    public GreengrassPackageServiceClientFactory(\n+            @Named(\"greengrassServiceEndpoint\") String greengrassServiceEndpoint,\n+            @Named(\"greengrassServiceRegion\") String greengrassServiceRegion) {\n+\n+        if (Utils.isEmpty(greengrassServiceEndpoint) || Utils.isEmpty(greengrassServiceRegion)) {\n+            // Initialize default client, client builder determines endpoint configuration\n+            // Will try to use default credential provider and environment region configuration\n+            logger.atInfo(\"initialize-pms-client\")\n+                  .addKeyValue(\"service-endpoint\", \"default\")\n+                  .addKeyValue(\"service-region\", \"default\");\n+            this.pmsClient = AWSGreengrassPackageManagementClientBuilder.defaultClient();\n+        } else {\n+            AWSGreengrassPackageManagementClientBuilder clientBuilder\n+                    = AWSGreengrassPackageManagementClientBuilder.standard();\n+            logger.atInfo(\"initialize-pms-client\")\n+                  .addKeyValue(\"service-endpoint\", greengrassServiceEndpoint)\n+                  .addKeyValue(\"service-region\", greengrassServiceRegion);", "originalCommit": "53934839fa7b27b39284705dd288f011ab984eef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMTg2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414211867", "bodyText": "Fixing.", "author": "chaurah", "createdAt": "2020-04-24T00:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5MzkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NTMwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414195308", "bodyText": "Do we need setter?", "author": "hui-yang", "createdAt": "2020-04-23T23:41:22Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.amazonaws.client.builder.AwsClientBuilder;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagementClientBuilder;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Utils;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+@Getter\n+@Setter", "originalCommit": "53934839fa7b27b39284705dd288f011ab984eef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMTg1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414211859", "bodyText": "Removing", "author": "chaurah", "createdAt": "2020-04-24T00:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NTMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NTk2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414195962", "bodyText": "same", "author": "hui-yang", "createdAt": "2020-04-23T23:43:11Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,75 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+    }\n+\n     @SuppressWarnings({\"PMD.UnusedLocalVariable\"})\n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier) throws PackageDownloadException {\n-        // TODO: to be implemented.\n-        return null;\n+        GetPackageRequest getPackageRequest =\n+                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n+                                       .withType(RecipeFormatType.YAML);\n+        GetPackageResult getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+\n+        // TODO: Currently getPackageResult doesn't have http status code in the object.\n+        // Uncomment below code once the model is updated\n+\n+        /*\n+            Potential responses:\n+            - 302: See Other (Redirects to pre-signed S3 URL)\n+            - 400: Invalid Input\n+            - 403: Forbidden\n+            - 404: Resource Not Found\n+         */\n+        /*int responseStatus = getPackageResult.getStatusCode();\n+        if (responseStatus != HttpURLConnection.HTTP_SEE_OTHER) {\n+            logger.atError(\"download-recipe-from-greengrass-repo\")\n+                  .addKeyValue(\"packageIdentifier\", packageIdentifier)\n+                  .addKeyValue(\"failureCode\", responseStatus)\n+                  .log();\n+            throw new PackageDownloadException(String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT,\n+                                                             packageIdentifier.getArn());\n+        }*/\n+\n+        try {\n+            ByteBuffer recipeBuf = getPackageResult.getRecipe();\n+            return OBJECT_MAPPER.readValue(new ByteBufferBackedInputStream(recipeBuf),\n+                                           PackageRecipe.class);\n+        } catch (IOException e) {\n+            String errorMsg = String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT,\n+                                            packageIdentifier.getArn());\n+            logger.atError(\"download-artifact-from-greengrass-repo\", e)\n+                  .addKeyValue(\"packageIdentifier\", packageIdentifier);", "originalCommit": "53934839fa7b27b39284705dd288f011ab984eef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMTgzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414211838", "bodyText": "Fixing.", "author": "chaurah", "createdAt": "2020-04-24T00:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NTk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODAyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414198022", "bodyText": "This is not an exception in downloading the recipe. The received recipe is of invalid format right? So I think the message should be changed indicate that.", "author": "abanthiy", "createdAt": "2020-04-23T23:48:34Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,75 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+    }\n+\n     @SuppressWarnings({\"PMD.UnusedLocalVariable\"})\n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier) throws PackageDownloadException {\n-        // TODO: to be implemented.\n-        return null;\n+        GetPackageRequest getPackageRequest =\n+                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n+                                       .withType(RecipeFormatType.YAML);\n+        GetPackageResult getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+\n+        // TODO: Currently getPackageResult doesn't have http status code in the object.\n+        // Uncomment below code once the model is updated\n+\n+        /*\n+            Potential responses:\n+            - 302: See Other (Redirects to pre-signed S3 URL)\n+            - 400: Invalid Input\n+            - 403: Forbidden\n+            - 404: Resource Not Found\n+         */\n+        /*int responseStatus = getPackageResult.getStatusCode();\n+        if (responseStatus != HttpURLConnection.HTTP_SEE_OTHER) {\n+            logger.atError(\"download-recipe-from-greengrass-repo\")\n+                  .addKeyValue(\"packageIdentifier\", packageIdentifier)\n+                  .addKeyValue(\"failureCode\", responseStatus)\n+                  .log();\n+            throw new PackageDownloadException(String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT,\n+                                                             packageIdentifier.getArn());\n+        }*/\n+\n+        try {\n+            ByteBuffer recipeBuf = getPackageResult.getRecipe();\n+            return OBJECT_MAPPER.readValue(new ByteBufferBackedInputStream(recipeBuf),\n+                                           PackageRecipe.class);\n+        } catch (IOException e) {\n+            String errorMsg = String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT,", "originalCommit": "53934839fa7b27b39284705dd288f011ab984eef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMTc2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414211766", "bodyText": "Good catch, fixing.", "author": "chaurah", "createdAt": "2020-04-24T00:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODQ5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414198496", "bodyText": "How does client handle timeout?", "author": "abanthiy", "createdAt": "2020-04-23T23:49:56Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,75 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+    }\n+\n     @SuppressWarnings({\"PMD.UnusedLocalVariable\"})\n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier) throws PackageDownloadException {\n-        // TODO: to be implemented.\n-        return null;\n+        GetPackageRequest getPackageRequest =\n+                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n+                                       .withType(RecipeFormatType.YAML);\n+        GetPackageResult getPackageResult = evgPmsClient.getPackage(getPackageRequest);", "originalCommit": "53934839fa7b27b39284705dd288f011ab984eef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMTQwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414211402", "bodyText": "Default AWS SDK behavior for retries and timeouts (I believe it's 30 seconds and 3 retries)", "author": "chaurah", "createdAt": "2020-04-24T00:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIzMjYxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414232613", "bodyText": "So we expect to get a 408 response code in response here?", "author": "abanthiy", "createdAt": "2020-04-24T01:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI0MjE4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414242181", "bodyText": "Handled by AmazonClientException catch block. The SDK tries to throw exceptions for almost all cases. It's only when the service returns a 2xx with some separate response code in status body that you will need explicit status code parsing. In theory. Heavily depends on modelling.\nThink LambdaInvokeResponse and LambdaProxyResponse from v1.", "author": "chaurah", "createdAt": "2020-04-24T02:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODU5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414198597", "bodyText": "5XX?", "author": "abanthiy", "createdAt": "2020-04-23T23:50:12Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,75 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+    }\n+\n     @SuppressWarnings({\"PMD.UnusedLocalVariable\"})\n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier) throws PackageDownloadException {\n-        // TODO: to be implemented.\n-        return null;\n+        GetPackageRequest getPackageRequest =\n+                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n+                                       .withType(RecipeFormatType.YAML);\n+        GetPackageResult getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+\n+        // TODO: Currently getPackageResult doesn't have http status code in the object.\n+        // Uncomment below code once the model is updated\n+\n+        /*\n+            Potential responses:\n+            - 302: See Other (Redirects to pre-signed S3 URL)\n+            - 400: Invalid Input\n+            - 403: Forbidden\n+            - 404: Resource Not Found", "originalCommit": "53934839fa7b27b39284705dd288f011ab984eef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMTAxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414211012", "bodyText": "None yet, service only returns the above. Still WIP from their side.", "author": "chaurah", "createdAt": "2020-04-24T00:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5OTIyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414199225", "bodyText": "Why is there no client in the name of this type? Is this standard?\nThis is a REST client I believe?", "author": "abanthiy", "createdAt": "2020-04-23T23:51:57Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.amazonaws.client.builder.AwsClientBuilder;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagementClientBuilder;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Utils;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+@Getter\n+@Setter\n+public class GreengrassPackageServiceClientFactory {\n+\n+    private static final Logger logger = LogManager.getLogger(GreengrassPackageServiceClientFactory.class);\n+\n+    private final AWSGreengrassPackageManagement pmsClient;", "originalCommit": "53934839fa7b27b39284705dd288f011ab984eef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMTE2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414211167", "bodyText": "WIP client, subject to change if the service client changes. I would except the final client is just called AWSGreengrassClient", "author": "chaurah", "createdAt": "2020-04-24T00:25:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5OTIyNQ=="}], "type": "inlineReview"}, {"oid": "994455d048ea263e9b4b3ab87f4a4109f99cf6a9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/994455d048ea263e9b4b3ab87f4a4109f99cf6a9", "message": "Add integration with Package Management Service", "committedDate": "2020-04-24T02:02:04Z", "type": "forcePushed"}, {"oid": "a298d4d7ab36f552996997fdbddea2f5c997a310", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a298d4d7ab36f552996997fdbddea2f5c997a310", "message": "Add integration with Package Management Service", "committedDate": "2020-04-24T02:43:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1OTY4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414259688", "bodyText": "For unit testing keep this package private if possible.", "author": "MikeDombo", "createdAt": "2020-04-24T03:10:46Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.amazonaws.client.builder.AwsClientBuilder;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagementClientBuilder;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Utils;\n+import lombok.Getter;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+@Getter\n+public class GreengrassPackageServiceClientFactory {\n+\n+    private static final Logger logger = LogManager.getLogger(GreengrassPackageServiceClientFactory.class);\n+\n+    private final AWSGreengrassPackageManagement pmsClient;\n+\n+    /**\n+     * Constructor with custom endpoint/region configuration.\n+     *\n+     * @param greengrassServiceEndpoint String containing service endpoint\n+     * @param greengrassServiceRegion String containing service region\n+     */\n+    @Inject\n+    public GreengrassPackageServiceClientFactory(\n+            @Named(\"greengrassServiceEndpoint\") String greengrassServiceEndpoint,\n+            @Named(\"greengrassServiceRegion\") String greengrassServiceRegion) {\n+\n+        if (Utils.isEmpty(greengrassServiceEndpoint) || Utils.isEmpty(greengrassServiceRegion)) {\n+            // Initialize default client, client builder determines endpoint configuration\n+            // Will try to use default credential provider and environment region configuration\n+            logger.atInfo(\"initialize-pms-client\")\n+                  .addKeyValue(\"service-endpoint\", \"default\")\n+                  .addKeyValue(\"service-region\", \"default\")\n+                  .log();\n+            this.pmsClient = AWSGreengrassPackageManagementClientBuilder.defaultClient();\n+        } else {\n+            AWSGreengrassPackageManagementClientBuilder clientBuilder\n+                    = AWSGreengrassPackageManagementClientBuilder.standard();\n+            logger.atInfo(\"initialize-pms-client\")\n+                  .addKeyValue(\"service-endpoint\", greengrassServiceEndpoint)\n+                  .addKeyValue(\"service-region\", greengrassServiceRegion)\n+                  .log();\n+            clientBuilder.withEndpointConfiguration(\n+                    new AwsClientBuilder.EndpointConfiguration(greengrassServiceEndpoint, greengrassServiceRegion));\n+            this.pmsClient = clientBuilder.build();\n+        }\n+        // TODO: Might need to retrieve AWS credentials from custom credential provider\n+    }\n+\n+    /**\n+     * Constructor for unit testing.\n+     * @param client AWSGreengrassPackageManagement object\n+     */\n+    public GreengrassPackageServiceClientFactory(AWSGreengrassPackageManagement client) {", "originalCommit": "a298d4d7ab36f552996997fdbddea2f5c997a310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MjM5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414262395", "bodyText": "Makes sense, going to check if doable.", "author": "chaurah", "createdAt": "2020-04-24T03:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1OTY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MDIyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414260222", "bodyText": "Never seen this before, is this from the new client or is this in our code?", "author": "MikeDombo", "createdAt": "2020-04-24T03:12:18Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,70 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.AmazonClientException;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();", "originalCommit": "a298d4d7ab36f552996997fdbddea2f5c997a310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MjY3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414262675", "bodyText": "New for us, discovered it myself while working on this PR. Located here : https://github.com/aws/aws-greengrass-kernel/blob/1f1808f9175d3b22169286e4c309d6a628d7490f/src/main/java/com/aws/iot/evergreen/util/SerializerFactory.java", "author": "chaurah", "createdAt": "2020-04-24T03:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MDIyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0NDM0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414744346", "bodyText": "Better if renaming it to RECIPE_SERIALIZER because it is configured as an recipe serializer.", "author": "leaf94", "createdAt": "2020-04-24T17:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MDIyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2NzQ5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414767496", "bodyText": "Makes sense, updating", "author": "chaurah", "createdAt": "2020-04-24T18:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2MDIyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0NTU5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414745598", "bodyText": "We should be able to avoid creating this. Let's sync up offline.", "author": "leaf94", "createdAt": "2020-04-24T17:33:17Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.amazonaws.client.builder.AwsClientBuilder;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagementClientBuilder;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Utils;\n+import lombok.Getter;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+@Getter\n+public class GreengrassPackageServiceClientFactory {\n+\n+    private static final Logger logger = LogManager.getLogger(GreengrassPackageServiceClientFactory.class);\n+\n+    private final AWSGreengrassPackageManagement pmsClient;\n+\n+    /**\n+     * Constructor with custom endpoint/region configuration.\n+     *\n+     * @param greengrassServiceEndpoint String containing service endpoint\n+     * @param greengrassServiceRegion String containing service region\n+     */\n+    @Inject\n+    public GreengrassPackageServiceClientFactory(\n+            @Named(\"greengrassServiceEndpoint\") String greengrassServiceEndpoint,\n+            @Named(\"greengrassServiceRegion\") String greengrassServiceRegion) {\n+\n+        if (Utils.isEmpty(greengrassServiceEndpoint) || Utils.isEmpty(greengrassServiceRegion)) {\n+            // Initialize default client, client builder determines endpoint configuration\n+            // Will try to use default credential provider and environment region configuration\n+            logger.atInfo(\"initialize-pms-client\")\n+                  .addKeyValue(\"service-endpoint\", \"default\")\n+                  .addKeyValue(\"service-region\", \"default\")\n+                  .log();\n+            this.pmsClient = AWSGreengrassPackageManagementClientBuilder.defaultClient();\n+        } else {\n+            AWSGreengrassPackageManagementClientBuilder clientBuilder\n+                    = AWSGreengrassPackageManagementClientBuilder.standard();\n+            logger.atInfo(\"initialize-pms-client\")\n+                  .addKeyValue(\"service-endpoint\", greengrassServiceEndpoint)\n+                  .addKeyValue(\"service-region\", greengrassServiceRegion)\n+                  .log();\n+            clientBuilder.withEndpointConfiguration(\n+                    new AwsClientBuilder.EndpointConfiguration(greengrassServiceEndpoint, greengrassServiceRegion));\n+            this.pmsClient = clientBuilder.build();\n+        }\n+        // TODO: Might need to retrieve AWS credentials from custom credential provider\n+    }\n+\n+    /**\n+     * Constructor for unit testing.\n+     * @param client AWSGreengrassPackageManagement object\n+     */\n+    public GreengrassPackageServiceClientFactory(AWSGreengrassPackageManagement client) {", "originalCommit": "a298d4d7ab36f552996997fdbddea2f5c997a310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk3OTk2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r415979964", "bodyText": "Removed", "author": "chaurah", "createdAt": "2020-04-27T16:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0NTU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODQ4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414748489", "bodyText": "Try only the line\nGetPackageResult getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n\nfor catching exceptions for calling PMS.\nThen try parsing logic for handling parsing/loading exception.", "author": "leaf94", "createdAt": "2020-04-24T17:38:12Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,70 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.AmazonClientException;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+    }\n+\n     @SuppressWarnings({\"PMD.UnusedLocalVariable\"})\n-    PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier) throws PackageDownloadException {\n-        // TODO: to be implemented.\n-        return null;\n+    PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier)\n+            throws PackageDownloadException, PackageLoadingException {\n+        GetPackageRequest getPackageRequest =\n+                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n+                                       .withType(RecipeFormatType.YAML);\n+\n+        try {\n+            GetPackageResult getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+            ByteBuffer recipeBuf = getPackageResult.getRecipe();\n+            return OBJECT_MAPPER.readValue(new ByteBufferBackedInputStream(recipeBuf),\n+                                           PackageRecipe.class);\n+        } catch (IOException e) {\n+            String errorMsg = String.format(PACKAGE_RECIPE_PARSING_EXCEPTION_FMT,\n+                                            packageIdentifier.getArn());\n+            logger.atError(\"download-package-from-greengrass-repo\", e)\n+                  .addKeyValue(\"packageIdentifier\", packageIdentifier)\n+                  .addKeyValue(\"errorMessage\", errorMsg)\n+                  .log();\n+            throw new PackageLoadingException(errorMsg, e);\n+        } catch (AmazonClientException e) {", "originalCommit": "a298d4d7ab36f552996997fdbddea2f5c997a310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2ODE4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414768184", "bodyText": "Split the two basically? Sounds good", "author": "chaurah", "createdAt": "2020-04-24T18:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODY3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414748673", "bodyText": "No need to implement fully but what about Service Exception?", "author": "leaf94", "createdAt": "2020-04-24T17:38:31Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,70 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.AmazonClientException;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper OBJECT_MAPPER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+    }\n+\n     @SuppressWarnings({\"PMD.UnusedLocalVariable\"})\n-    PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier) throws PackageDownloadException {\n-        // TODO: to be implemented.\n-        return null;\n+    PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier)\n+            throws PackageDownloadException, PackageLoadingException {\n+        GetPackageRequest getPackageRequest =\n+                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n+                                       .withType(RecipeFormatType.YAML);\n+\n+        try {\n+            GetPackageResult getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+            ByteBuffer recipeBuf = getPackageResult.getRecipe();\n+            return OBJECT_MAPPER.readValue(new ByteBufferBackedInputStream(recipeBuf),\n+                                           PackageRecipe.class);\n+        } catch (IOException e) {\n+            String errorMsg = String.format(PACKAGE_RECIPE_PARSING_EXCEPTION_FMT,\n+                                            packageIdentifier.getArn());\n+            logger.atError(\"download-package-from-greengrass-repo\", e)\n+                  .addKeyValue(\"packageIdentifier\", packageIdentifier)\n+                  .addKeyValue(\"errorMessage\", errorMsg)\n+                  .log();\n+            throw new PackageLoadingException(errorMsg, e);\n+        } catch (AmazonClientException e) {", "originalCommit": "a298d4d7ab36f552996997fdbddea2f5c997a310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2ODAyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414768029", "bodyText": "Service Exception is child of client exception. When we have a stable sdk, we can expand into various handlers, didn't seem warranted at the moment.", "author": "chaurah", "createdAt": "2020-04-24T18:10:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwMzI0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414803247", "bodyText": "I'm referring to AmazonServiceException. Other than catching client exception, which indicates error in java client, we should probably also catch AmazonServiceException to handle error from service side.", "author": "leaf94", "createdAt": "2020-04-24T19:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxNjc1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414816751", "bodyText": "yes, that's a child of the client exception. Ideally the SDK should specify exceptions to be caught in the service model. There are some but the model is not complete yet. The hierarchy is\nAmazonClientException <- AmazonServiceException <- Service model defined exceptions.\nAs mentioned, I can break down into catching specific exceptions, I just don't see the point at the moment with the service and service models not fully implemented yet.", "author": "chaurah", "createdAt": "2020-04-24T19:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0OTY1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414749655", "bodyText": "Let's not check this in, shall we? Cloud team should be able to return a 200 instead of 302 easily...", "author": "leaf94", "createdAt": "2020-04-24T17:40:11Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -50,9 +71,45 @@ HttpURLConnection connect(URL url) throws IOException {\n         return (HttpURLConnection) url.openConnection();\n     }\n \n-    String getArtifactDownloadURL(String packageArn, String artifactName) {\n-        //TODO retrieve artifact presigned download URL from cloud as redirection\n-        return \"placeholder\";\n+    String getArtifactDownloadURL(String packageArn, String artifactName) throws PackageDownloadException {\n+        GetArtifactRequest getArtifactRequest = new GetArtifactRequest().withArtifactName(artifactName)\n+                                                                        .withPackageARN(packageArn);\n+\n+        GetArtifactResult getArtifactResult = null;\n+        // TODO: This is horribly bad code, but unfortunately, the service is configured to return 302 redirect and\n+        // the auto-generated SDK does NOT like that. The only way to handle this at the moment is to catch the\n+        // exception for the redirect. This response code needs a revisit from the service side either to change the", "originalCommit": "a298d4d7ab36f552996997fdbddea2f5c997a310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2ODk4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414768982", "bodyText": "There's going to be an api discussion, will take time. I think the preferred approach will be to see if we can improve the default auto-generated behavior and not throw an exception. Either way will take 2-3 weeks while they're working on the service code, no point holding off on this.", "author": "chaurah", "createdAt": "2020-04-24T18:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0OTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwMzc5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414803790", "bodyText": "If it is 2-3 weeks, then let's merge this in. Maybe I'm missing some context, but getArtifact should just return 200. Even if is returning a \"redirectUrl\", but has nothing to do with returning a 302 for this API... I think it could be easily communicated with them.", "author": "leaf94", "createdAt": "2020-04-24T19:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0OTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxNzQ5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414817491", "bodyText": "They had a design reviewed for the API already. I obviously already communicated the issue to them, but in the end they have to reach the stage where they will be implementing the API in the first place. Sending you the API design doc for reference :)", "author": "chaurah", "createdAt": "2020-04-24T19:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0OTY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1MTQ2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414751465", "bodyText": "One of the point of having clientFactory is that you could mock it.\nIf you do:\nclientFactory = mock(ClientFactory);\nwhen(clientFactory.getClient()).thenReturn(mockClient);\n\nthis.helper = new Helper(clientFactory);\n\nThen you could remove both spy and constructor for unit test", "author": "leaf94", "createdAt": "2020-04-24T17:43:02Z", "path": "src/test/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelperTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+\n+import com.vdurmont.semver4j.Semver;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.spy;\n+\n+import java.nio.ByteBuffer;\n+\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+\n+@ExtendWith({MockitoExtension.class, EGExtension.class})\n+class GreengrassPackageServiceHelperTest {\n+\n+    @Mock\n+    private AWSGreengrassPackageManagement client;\n+\n+    private GreengrassPackageServiceClientFactory clientFactory;\n+    private GreengrassPackageServiceHelper helper;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        this.clientFactory = new GreengrassPackageServiceClientFactory(client);\n+        this.helper = spy(new GreengrassPackageServiceHelper(clientFactory));", "originalCommit": "a298d4d7ab36f552996997fdbddea2f5c997a310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2OTgxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414769812", "bodyText": "Tried that, need spy because of the connection object responses. I can do the other one though probably, but felt kinda redundant to mock.", "author": "chaurah", "createdAt": "2020-04-24T18:13:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1MTQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1MjAzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414752039", "bodyText": "If we do getPackage(any()) here, we need to verify the argument to ensure client is called with the argument we expect.", "author": "leaf94", "createdAt": "2020-04-24T17:43:59Z", "path": "src/test/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelperTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+\n+import com.vdurmont.semver4j.Semver;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.spy;\n+\n+import java.nio.ByteBuffer;\n+\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+\n+@ExtendWith({MockitoExtension.class, EGExtension.class})\n+class GreengrassPackageServiceHelperTest {\n+\n+    @Mock\n+    private AWSGreengrassPackageManagement client;\n+\n+    private GreengrassPackageServiceClientFactory clientFactory;\n+    private GreengrassPackageServiceHelper helper;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        this.clientFactory = new GreengrassPackageServiceClientFactory(client);\n+        this.helper = spy(new GreengrassPackageServiceHelper(clientFactory));\n+    }\n+\n+    @Test\n+    void GIVEN_artifact_url_WHEN_attempt_download_THEN_task_succeed() throws Exception {\n+        String recipeContents =\n+                TestHelper.getPackageRecipeForTestPackage(TestHelper.MONITORING_SERVICE_PACKAGE_NAME, \"1.0.0\");\n+        ByteBuffer testRecipeBytes = ByteBuffer.wrap(recipeContents.getBytes());\n+        GetPackageResult testResult = new GetPackageResult().withRecipe(testRecipeBytes);\n+        doReturn(testResult).when(client).getPackage(any());", "originalCommit": "a298d4d7ab36f552996997fdbddea2f5c997a310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc3MDIyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r414770224", "bodyText": "Can improve that, need a captor. Sounds good.", "author": "chaurah", "createdAt": "2020-04-24T18:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1MjAzOQ=="}], "type": "inlineReview"}, {"oid": "64279c0608b329430f4769076456f9d26ad81775", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/64279c0608b329430f4769076456f9d26ad81775", "message": "Add integration with Package Management Service", "committedDate": "2020-04-27T16:53:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwMDgzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r416000836", "bodyText": "remove this?", "author": "hui-yang", "createdAt": "2020-04-27T17:19:56Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,15 +1,74 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.amazonaws.AmazonClientException;\n+import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n+import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n+import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    //TODO connect to cloud service\n+    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n+    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n+\n+    private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n+\n+    // Service logger instance\n+    protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+    }\n+\n     @SuppressWarnings({\"PMD.UnusedLocalVariable\"})", "originalCommit": "64279c0608b329430f4769076456f9d26ad81775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAxNjM2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r416016363", "bodyText": "Not storing the client factory in a variable, need a constructor to get the PMS client from the factory. Otherwise could directly Inject in the variable itself. It's also needed for unit testing.", "author": "chaurah", "createdAt": "2020-04-27T17:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwMDgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwNTYyMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r416005620", "bodyText": "remove the first one?", "author": "hui-yang", "createdAt": "2020-04-27T17:26:37Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -12,22 +19,36 @@\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.nio.file.StandardCopyOption;\n+import java.util.Map;\n+import javax.inject.Inject;\n \n public class GreengrassRepositoryDownloader implements ArtifactDownloader {\n     private static final Logger logger = LogManager.getLogger(GreengrassRepositoryDownloader.class);\n     private static final String CONTENT_DISPOSITION = \"Content-Disposition\";\n+    private static final String HTTP_HEADER_LOCATION = \"Location\";\n+    private static final String ARTIFACT_DOWNLOAD_EXCEPTION_PMS_FMT\n+            = \"Failed to download artifact %s for package %s, http response from server was %d\";\n+\n+    private final AWSGreengrassPackageManagement evgPmsClient;\n+\n+    @Inject\n+    public GreengrassRepositoryDownloader(GreengrassPackageServiceClientFactory clientFactory) {\n+        this.evgPmsClient = clientFactory.getPmsClient();\n+    }\n \n     @SuppressWarnings({\"PMD.AssignmentInOperand\", \"AvoidFileStream\"})", "originalCommit": "64279c0608b329430f4769076456f9d26ad81775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAxNjQ2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/191#discussion_r416016465", "bodyText": "Same as above", "author": "chaurah", "createdAt": "2020-04-27T17:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwNTYyMA=="}], "type": "inlineReview"}, {"oid": "4bfe437997054a89a26a86b7c650c7795418544b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4bfe437997054a89a26a86b7c650c7795418544b", "message": "Add integration with Package Management Service", "committedDate": "2020-04-27T17:47:33Z", "type": "forcePushed"}, {"oid": "8209fc286f2a452a1db885f7407cbe3d3b9d0d97", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8209fc286f2a452a1db885f7407cbe3d3b9d0d97", "message": "Add integration with Package Management Service", "committedDate": "2020-04-27T21:23:57Z", "type": "commit"}, {"oid": "8209fc286f2a452a1db885f7407cbe3d3b9d0d97", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8209fc286f2a452a1db885f7407cbe3d3b9d0d97", "message": "Add integration with Package Management Service", "committedDate": "2020-04-27T21:23:57Z", "type": "forcePushed"}]}