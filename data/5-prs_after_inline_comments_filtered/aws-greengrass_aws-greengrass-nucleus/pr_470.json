{"pr_number": 470, "pr_title": "getIotClient(awsRegion, stage, credentialsProvider) API", "pr_createdAt": "2020-09-24T01:54:41Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470", "timeline": [{"oid": "f05f519ad65d31544d02be28d57c2f387e6f0a10", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f05f519ad65d31544d02be28d57c2f387e6f0a10", "message": "getIotClient(awsRegion, stage, credentialsProvider) API", "committedDate": "2020-09-24T01:52:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5OTYwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r493999607", "bodyText": "Nit: make awsRegion of type Region and have getIotClient(Region, AwsCredentialsProvider) call this", "author": "jbutler", "createdAt": "2020-09-24T02:18:07Z", "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -73,6 +73,26 @@ public static IotClient getIotClient(Region awsRegion, AwsCredentialsProvider cr\n                 .overrideConfiguration(ClientOverrideConfiguration.builder().retryPolicy(retryPolicy).build()).build();\n     }\n \n+    /**\n+     * Build IotClient for desired region, stage and credentials.\n+     *\n+     * @param awsRegion           aws region\n+     * @param stage               {@link EnvironmentStage}\n+     * @param credentialsProvider credentials provider\n+     * @return\n+     */\n+    public static IotClient getIotClient(String awsRegion, EnvironmentStage stage,", "originalCommit": "f05f519ad65d31544d02be28d57c2f387e6f0a10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMzgwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494003803", "bodyText": "If I make getIotClient(Region, AwsCredentialsProvider) call the above method, I'll have to add \"throws URISyntaxException\" to it, when actually it's not required because the if block of above method will never be executed when called from getIotClient(Region, AwsCredentialsProvider). And its callers will have to unnecessarily handle the exception.", "author": "popanmol", "createdAt": "2020-09-24T02:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5OTYwNw=="}], "type": "inlineReview"}, {"oid": "0791551f5fd217956efd00cda30f84c896100302", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0791551f5fd217956efd00cda30f84c896100302", "message": "region and docstring", "committedDate": "2020-09-24T02:39:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxNzIwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494017207", "bodyText": "the other implementations should call this one so we don't need to duplicate logic.", "author": "MikeDombo", "createdAt": "2020-09-24T03:31:07Z", "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -73,6 +73,27 @@ public static IotClient getIotClient(Region awsRegion, AwsCredentialsProvider cr\n                 .overrideConfiguration(ClientOverrideConfiguration.builder().retryPolicy(retryPolicy).build()).build();\n     }\n \n+    /**\n+     * Build IotClient for desired region, stage and credentials.\n+     *\n+     * @param awsRegion           aws region\n+     * @param stage               {@link EnvironmentStage}\n+     * @param credentialsProvider credentials provider\n+     * @return IotClient instance\n+     * @throws URISyntaxException when Iot endpoint is malformed\n+     */\n+    public static IotClient getIotClient(Region awsRegion, EnvironmentStage stage,", "originalCommit": "0791551f5fd217956efd00cda30f84c896100302", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d336ed1cde35258f64d6afaefbb2f2801d749e7c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d336ed1cde35258f64d6afaefbb2f2801d749e7c", "message": "common implementation for all getIotClient APIs", "committedDate": "2020-09-24T05:06:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1MDIwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494450202", "bodyText": "Returning a default IotClient is probably not the correct thing to do in this case. This SHOULD never happen, but if something changed and it did, and the client still functioned (e.g. using credentials from a customer profile), then that could be very bad.\nWe definitely need explicit failure here. Either revert and duplicate code or bubble up the exception.", "author": "jbutler", "createdAt": "2020-09-24T16:24:06Z", "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -69,8 +57,26 @@ public static IotClient getIotClient(String awsRegion, EnvironmentStage stage) t\n      * @return IotClient instance\n      */\n     public static IotClient getIotClient(Region awsRegion, AwsCredentialsProvider credentialsProvider) {\n-        return IotClient.builder().region(awsRegion).credentialsProvider(credentialsProvider)\n-                .overrideConfiguration(ClientOverrideConfiguration.builder().retryPolicy(retryPolicy).build()).build();\n+        try {\n+            return getIotClient(awsRegion, EnvironmentStage.PROD, credentialsProvider, Collections.emptySet());\n+        } catch (URISyntaxException e) {\n+            //this will never execute\n+            return IotClient.builder().build();\n+        }", "originalCommit": "d336ed1cde35258f64d6afaefbb2f2801d749e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1MTAxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494451012", "bodyText": "Nit: I realize this is only used in one place, but it's probably useful here still with a comment indicating this is the default retry policy used by all methods", "author": "jbutler", "createdAt": "2020-09-24T16:25:21Z", "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -31,13 +32,6 @@\n             Arrays.asList(ThrottlingException.class, InternalException.class, InternalFailureException.class,\n                     LimitExceededException.class));\n \n-    private static final RetryCondition retryCondition = OrRetryCondition", "originalCommit": "d336ed1cde35258f64d6afaefbb2f2801d749e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1MTc0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494451746", "bodyText": "Interestingly enough, this didn't previously use the default policy :) 5 retries instead of 10.", "author": "jbutler", "createdAt": "2020-09-24T16:26:28Z", "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -85,19 +91,42 @@ public static IotClient getIotClient(Region awsRegion, AwsCredentialsProvider cr\n     public static IotClient getIotClient(String awsRegion, EnvironmentStage stage,\n                                          Set<Class<? extends Exception>> additionalRetryableExceptions)\n             throws URISyntaxException {\n+        return getIotClient(Region.of(awsRegion), stage, null, additionalRetryableExceptions);\n+    }\n+\n+    /**\n+     * Build IotClient for desired region, stage and credentials with custom retry logic.\n+     * @param awsRegion                     aws region\n+     * @param stage                         {@link EnvironmentStage}\n+     * @param credentialsProvider           credentials provider\n+     * @param additionalRetryableExceptions additional exceptions to retry on\n+     * @return IotClient instance\n+     * @throws URISyntaxException when Iot endpoint is malformed\n+     */\n+    public static IotClient getIotClient(Region awsRegion, EnvironmentStage stage,\n+                                         AwsCredentialsProvider credentialsProvider,\n+                                         Set<Class<? extends Exception>> additionalRetryableExceptions)\n+            throws URISyntaxException {\n         Set<Class<? extends Exception>> allExceptionsToRetryOn = new HashSet<>();\n         allExceptionsToRetryOn.addAll(retryableIoTExceptions);\n         allExceptionsToRetryOn.addAll(additionalRetryableExceptions);\n-        IotClientBuilder iotClientBuilder = IotClient.builder().region(Region.of(awsRegion)).overrideConfiguration(\n-                ClientOverrideConfiguration.builder().retryPolicy(\n-                        RetryPolicy.builder().numRetries(5).backoffStrategy(BackoffStrategy.defaultThrottlingStrategy())", "originalCommit": "d336ed1cde35258f64d6afaefbb2f2801d749e7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5MTkzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494491933", "bodyText": "changed the number of retries from 5 to 10 because if we wanna have all methods call one implementation, then we would need to have one common value of retries", "author": "popanmol", "createdAt": "2020-09-24T17:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1MTc0Ng=="}], "type": "inlineReview"}, {"oid": "574cb926e5846db49af9f9cfc1dc96b603e4d45a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/574cb926e5846db49af9f9cfc1dc96b603e4d45a", "message": "throw URISyntaxException", "committedDate": "2020-09-24T18:00:29Z", "type": "commit"}, {"oid": "b02568f27bef30d1b7c80ed7127aa353afd8ff1f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b02568f27bef30d1b7c80ed7127aa353afd8ff1f", "message": "Merge branch 'master' into iotclient-factory", "committedDate": "2020-09-25T07:07:56Z", "type": "commit"}, {"oid": "5e536a613a32a2d04a470a6a148993f61f7aad97", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5e536a613a32a2d04a470a6a148993f61f7aad97", "message": "Merge branch 'master' into iotclient-factory", "committedDate": "2020-09-25T18:02:54Z", "type": "commit"}, {"oid": "6ee4abb55adcf2629118e470b8140ab508a647e1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6ee4abb55adcf2629118e470b8140ab508a647e1", "message": "Merge branch 'master' into iotclient-factory", "committedDate": "2020-09-25T18:41:43Z", "type": "commit"}, {"oid": "127a2964d2628cd04919ca05adc886f6e122864a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/127a2964d2628cd04919ca05adc886f6e122864a", "message": "number of retries", "committedDate": "2020-09-25T18:42:39Z", "type": "commit"}, {"oid": "1fb433c09fbb90c7321e41f820e6d880c3f685de", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1fb433c09fbb90c7321e41f820e6d880c3f685de", "message": "Merge branch 'master' into iotclient-factory", "committedDate": "2020-09-25T18:56:18Z", "type": "commit"}]}