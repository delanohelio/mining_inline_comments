{"pr_number": 151, "pr_title": "Kernel throws exception when a service moved to Broken state after deployment. ", "pr_createdAt": "2020-04-02T05:52:41Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151", "timeline": [{"oid": "63335fed491c227a6413e30e8c887a30e2abbdab", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/63335fed491c227a6413e30e8c887a30e2abbdab", "message": "added timeout for service startup, throw exception to DA when serive broken", "committedDate": "2020-04-02T05:43:22Z", "type": "commit"}, {"oid": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "message": "added timeout for service startup, throw exception to DA when serive broken", "committedDate": "2020-04-02T05:43:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MzI0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402073248", "bodyText": "typo: when_does_not_startup", "author": "MikeDombo", "createdAt": "2020-04-02T06:13:35Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -36,4 +36,22 @@ void GIVEN_service_config_with_broken_skipif_config_WHEN_launch_service_THEN_ser\n         // THEN\n         assertTrue(testErrored.await(60, TimeUnit.SECONDS));\n     }\n+\n+    @Test\n+    void GIVEN_service_with_startup_timeout_WHEN_do_not_startup_within_timeout_THEN_move_service_to_errored()", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5MjUwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402492503", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-04-02T17:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MzI0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MzgwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402073807", "bodyText": "If it doesn't need to be serializable then you can remove the serialization uid.", "author": "MikeDombo", "createdAt": "2020-04-02T06:15:12Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/exceptions/ServiceInBrokenStateAfterDeploymentException.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package com.aws.iot.evergreen.deployment.exceptions;\n+\n+import com.aws.iot.evergreen.kernel.EvergreenService;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import lombok.Getter;\n+\n+@SuppressFBWarnings(justification = \"This does not need to be serializable\", value = \"SE_BAD_FIELD\")", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5MjQ3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402492479", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-04-02T17:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MzgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3Mzk3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402073979", "bodyText": "Do we have a \"DeploymentException\" class? If not, let's make that and then have this extend that.", "author": "MikeDombo", "createdAt": "2020-04-02T06:15:44Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/exceptions/ServiceInBrokenStateAfterDeploymentException.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package com.aws.iot.evergreen.deployment.exceptions;\n+\n+import com.aws.iot.evergreen.kernel.EvergreenService;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import lombok.Getter;\n+\n+@SuppressFBWarnings(justification = \"This does not need to be serializable\", value = \"SE_BAD_FIELD\")\n+public class ServiceInBrokenStateAfterDeploymentException extends Exception {", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5NjgwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402596807", "bodyText": "Added", "author": "fahadmohammed01", "createdAt": "2020-04-02T21:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3Mzk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5OTQ0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402599442", "bodyText": "Agree. Also I don't think service in Broken state needs a separate Exception. We can have a ServiceUpdateException , and have \"Service in Broken state\" in the message.", "author": "ShirleyZheng92", "createdAt": "2020-04-02T21:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3Mzk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYzNjQ1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402636452", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-04-02T22:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3Mzk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDgyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402074822", "bodyText": "I don't think this should be in the backing task. I believe we'd want this to be in the lifecycle thread.", "author": "MikeDombo", "createdAt": "2020-04-02T06:18:22Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -477,8 +483,26 @@ private void startStateTransition() throws InterruptedException {\n                                             .log(\"Got interrupted while waiting for dependency ready\");\n                                     return;\n                                 }\n-\n                                 try {\n+                                    Topics startUpTopic = lifecycle != null", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5MjQyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402492427", "bodyText": "This is in the backing task because, the timeout should start after the waitForDependencyReady() returns.", "author": "fahadmohammed01", "createdAt": "2020-04-02T17:36:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMDAwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402600000", "bodyText": "This topic can be initialized at the beginning of initializing this class", "author": "ShirleyZheng92", "createdAt": "2020-04-02T21:14:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MDQ4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402680488", "bodyText": "I dont think we should initialize it in the constructor, this would prevent it from getting updated via deployment. Refactored and added support for timeout for run as well.", "author": "fahadmohammed01", "createdAt": "2020-04-03T01:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MTA3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402681074", "bodyText": "Why would that prevent anything? The topic can still be updated during deployment.", "author": "MikeDombo", "createdAt": "2020-04-03T01:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxNDIwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403814206", "bodyText": "Updated to use findTopics() in Topics class", "author": "fahadmohammed01", "createdAt": "2020-04-06T03:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDk2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402074964", "bodyText": "Pull out the default to a const which we can change more easily.", "author": "MikeDombo", "createdAt": "2020-04-02T06:18:43Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -477,8 +483,26 @@ private void startStateTransition() throws InterruptedException {\n                                             .log(\"Got interrupted while waiting for dependency ready\");\n                                     return;\n                                 }\n-\n                                 try {\n+                                    Topics startUpTopic = lifecycle != null\n+                                            ? lifecycle.findInteriorChild(LIFECYCLE_STARTUP_NAMESPACE_TOPIC)\n+                                            : null;\n+                                    // only schedule task to report error for services which use startup\n+                                    // Default startup time is 120 seconds\n+                                    if (startUpTopic != null) {\n+                                        Integer timeout = (Integer) startUpTopic.findLeafChild(TIMEOUT_NAMESPACE_TOPIC)\n+                                                .dflt(120).getOnce();", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5MjM5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402492391", "bodyText": "Changed", "author": "fahadmohammed01", "createdAt": "2020-04-02T17:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NTU0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402075542", "bodyText": "This requires another thread which seems wasteful. I believe if you moved this logic into the main lifecycle thread then you can wait on some future with the provided timeout. Remember back when we discussed the 3-way wait when we were discussing the state machine refactor. We want to unblock the lifecycle thread if startup completes, timesout, or errors.", "author": "MikeDombo", "createdAt": "2020-04-02T06:20:21Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -477,8 +483,26 @@ private void startStateTransition() throws InterruptedException {\n                                             .log(\"Got interrupted while waiting for dependency ready\");\n                                     return;\n                                 }\n-\n                                 try {\n+                                    Topics startUpTopic = lifecycle != null\n+                                            ? lifecycle.findInteriorChild(LIFECYCLE_STARTUP_NAMESPACE_TOPIC)\n+                                            : null;\n+                                    // only schedule task to report error for services which use startup\n+                                    // Default startup time is 120 seconds\n+                                    if (startUpTopic != null) {\n+                                        Integer timeout = (Integer) startUpTopic.findLeafChild(TIMEOUT_NAMESPACE_TOPIC)\n+                                                .dflt(120).getOnce();\n+                                        Future<?> schedule =\n+                                                context.get(ScheduledExecutorService.class).schedule(() -> {", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0OTYzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402649637", "bodyText": "If we wait for the future to complete (like in install and shutdown), lifecycle thread would be able to make any state transition until startup timeout is completed.", "author": "fahadmohammed01", "createdAt": "2020-04-02T23:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NTU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NjgwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402076802", "bodyText": "typo: completes_without_exception.", "author": "MikeDombo", "createdAt": "2020-04-02T06:23:47Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/mergeTest.java", "diffHunk": "@@ -21,5 +42,46 @@ public void testSomeMethod() throws Exception {\n         assertEquals(c.getRoot(), b.getRoot());\n     }\n \n+    @Test\n+    public void GIVEN_deployment_WHEN_all_service_are_running_THEN_waitForServicesToStart_complete_without_exception()", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5MjA2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402492060", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-04-02T17:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NjgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NzI1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402077251", "bodyText": "This won't actually do anything to block the test.", "author": "MikeDombo", "createdAt": "2020-04-02T06:24:45Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/mergeTest.java", "diffHunk": "@@ -21,5 +42,46 @@ public void testSomeMethod() throws Exception {\n         assertEquals(c.getRoot(), b.getRoot());\n     }\n \n+    @Test\n+    public void GIVEN_deployment_WHEN_all_service_are_running_THEN_waitForServicesToStart_complete_without_exception()\n+            throws InterruptedException {\n+        Kernel kernel = new Kernel();\n+        when(mockMainService.getState()).thenReturn(State.RUNNING);\n+        when(mockServiceA.getState()).thenReturn(State.RUNNING);\n+        when(mockServiceB.getState()).thenReturn(State.RUNNING);\n+\n+        when(mockMainService.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceA.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceB.reachedDesiredState()).thenReturn(true);\n+        CompletableFuture future = new CompletableFuture();\n+        Set<EvergreenService> evergreenServices =\n+                new HashSet(Arrays.asList(mockMainService, mockServiceA, mockServiceB));\n+        kernel.waitForServicesToStart(evergreenServices, future);\n+\n+        assertFalse(future.isCompletedExceptionally());\n+    }\n+\n+    @Test\n+    public void GIVEN_deployment_WHEN_one_service_is_broken_THEN_waitForServicesToStart_completes_Exceptionally()\n+            throws InterruptedException {\n+        Kernel kernel = new Kernel();\n+        when(mockMainService.getState()).thenReturn(State.BROKEN);\n+        when(mockServiceA.getState()).thenReturn(State.RUNNING);\n+        when(mockServiceB.getState()).thenReturn(State.RUNNING);\n+\n+        when(mockMainService.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceA.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceB.reachedDesiredState()).thenReturn(true);\n+        CompletableFuture future = new CompletableFuture();\n+        Set<EvergreenService> evergreenServices =\n+                new HashSet(Arrays.asList(mockMainService, mockServiceA, mockServiceB));\n+        kernel.waitForServicesToStart(evergreenServices, future);\n+\n+        future.whenComplete((v, t) -> {", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5MjI4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402492288", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-04-02T17:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NzI1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NzU3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402077570", "bodyText": "You'll need to use ServiceInborkenStateAfterDeploymentException ex = assertThrows(ServiceInborkenStateAfterDeploymentException.class, () -> future.get(1, TimeUnit.Seconds)", "author": "MikeDombo", "createdAt": "2020-04-02T06:25:39Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/mergeTest.java", "diffHunk": "@@ -21,5 +42,46 @@ public void testSomeMethod() throws Exception {\n         assertEquals(c.getRoot(), b.getRoot());\n     }\n \n+    @Test\n+    public void GIVEN_deployment_WHEN_all_service_are_running_THEN_waitForServicesToStart_complete_without_exception()\n+            throws InterruptedException {\n+        Kernel kernel = new Kernel();\n+        when(mockMainService.getState()).thenReturn(State.RUNNING);\n+        when(mockServiceA.getState()).thenReturn(State.RUNNING);\n+        when(mockServiceB.getState()).thenReturn(State.RUNNING);\n+\n+        when(mockMainService.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceA.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceB.reachedDesiredState()).thenReturn(true);\n+        CompletableFuture future = new CompletableFuture();\n+        Set<EvergreenService> evergreenServices =\n+                new HashSet(Arrays.asList(mockMainService, mockServiceA, mockServiceB));\n+        kernel.waitForServicesToStart(evergreenServices, future);\n+\n+        assertFalse(future.isCompletedExceptionally());\n+    }\n+\n+    @Test\n+    public void GIVEN_deployment_WHEN_one_service_is_broken_THEN_waitForServicesToStart_completes_Exceptionally()\n+            throws InterruptedException {\n+        Kernel kernel = new Kernel();\n+        when(mockMainService.getState()).thenReturn(State.BROKEN);\n+        when(mockServiceA.getState()).thenReturn(State.RUNNING);\n+        when(mockServiceB.getState()).thenReturn(State.RUNNING);\n+\n+        when(mockMainService.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceA.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceB.reachedDesiredState()).thenReturn(true);\n+        CompletableFuture future = new CompletableFuture();\n+        Set<EvergreenService> evergreenServices =\n+                new HashSet(Arrays.asList(mockMainService, mockServiceA, mockServiceB));\n+        kernel.waitForServicesToStart(evergreenServices, future);\n+\n+        future.whenComplete((v, t) -> {\n+            assertTrue(t instanceof ServiceInBrokenStateAfterDeploymentException);\n+            EvergreenService brokenService = ((ServiceInBrokenStateAfterDeploymentException) t).getBrokenService();\n+            assertEquals(mockMainService, brokenService);\n+        });", "originalCommit": "dcbe3e44bbe72b9d02faabc39a728deb283b21d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5MjMzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402492331", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-04-02T17:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NzU3MA=="}], "type": "inlineReview"}, {"oid": "0b1571f723b0bff5ee3606105b2937c7c2d78439", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0b1571f723b0bff5ee3606105b2937c7c2d78439", "message": "addressed minor pr comments", "committedDate": "2020-04-02T17:35:44Z", "type": "commit"}, {"oid": "91fbbdfa2e09fb9efd9878e95abac3329028de98", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/91fbbdfa2e09fb9efd9878e95abac3329028de98", "message": "fixed pmd failures and addressed minor pr comments", "committedDate": "2020-04-02T20:57:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5ODE2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402598169", "bodyText": "An updated DesiredState will also cancel this", "author": "ShirleyZheng92", "createdAt": "2020-04-02T21:10:24Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -608,6 +633,11 @@ private void startStateTransition() throws InterruptedException {\n                 logger.atInfo().setEventType(\"service-report-state\").kv(\"state\", toState).log();\n                 updateStateAndBroadcast(toState);\n             }\n+            // service transitioning to another state, cancelling task monitoring the timeout for startup\n+            Future triggerTimeOutFuture = triggerTimeOutFutureReference.get();\n+            if (triggerTimeOutFuture != null) {\n+                triggerTimeOutFuture.cancel(true);\n+            }", "originalCommit": "0b1571f723b0bff5ee3606105b2937c7c2d78439", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0NzkwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402647908", "bodyText": "Synced offline.", "author": "fahadmohammed01", "createdAt": "2020-04-02T23:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5ODE2OQ=="}], "type": "inlineReview"}, {"oid": "62149c8e001ca92100d358f53d6db77013dd1ff3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/62149c8e001ca92100d358f53d6db77013dd1ff3", "message": "renamed exception name", "committedDate": "2020-04-02T22:37:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NjIwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402656203", "bodyText": "Let's make sure to use these topic names elsewhere, ie. in GenericExternalService.", "author": "MikeDombo", "createdAt": "2020-04-02T23:36:59Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -53,6 +55,10 @@\n     public static final String SERVICES_NAMESPACE_TOPIC = \"services\";\n     public static final String SERVICE_LIFECYCLE_NAMESPACE_TOPIC = \"lifecycle\";\n     public static final String SERVICE_NAME_KEY = \"serviceName\";\n+    public static final String LIFECYCLE_STARTUP_NAMESPACE_TOPIC = \"startup\";\n+    public static final String TIMEOUT_NAMESPACE_TOPIC = \"timeout\";", "originalCommit": "62149c8e001ca92100d358f53d6db77013dd1ff3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MTM1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402681356", "bodyText": "Found one in generic external service, updated", "author": "fahadmohammed01", "createdAt": "2020-04-03T01:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NjIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NjcyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402656723", "bodyText": "Looks like this change will fix a PMD issue, please make sure to decrease the max allowed PMD violations if it got decreased.", "author": "MikeDombo", "createdAt": "2020-04-02T23:38:45Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -127,8 +133,8 @@ private void updateStateAndBroadcast(State newState) {\n         }\n \n         // TODO: Add validation\n-        logger.atInfo().setEventType(\"service-set-state\").kv(\"currentState\", currentState).kv(\"newState\", newState)\n-                .log();\n+        logger.atInfo().setEventType(\"service-set-state\")\n+                .kv(CURRENT_STATE_METRIC_NAME, currentState).kv(\"newState\", newState).log();", "originalCommit": "62149c8e001ca92100d358f53d6db77013dd1ff3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MDcwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402680701", "bodyText": "moved it down to 80", "author": "fahadmohammed01", "createdAt": "2020-04-03T01:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NjcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1Njk0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402656941", "bodyText": "Keep the description for the backing task. This will make logging much much better, because we have no other way to tell what is running in the backing task.", "author": "MikeDombo", "createdAt": "2020-04-02T23:39:24Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -444,7 +450,7 @@ private void startStateTransition() throws InterruptedException {\n                         } finally {\n                             installLatch.countDown();\n                         }\n-                    }, \"install\");\n+                    });", "originalCommit": "62149c8e001ca92100d358f53d6db77013dd1ff3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MTIxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402681213", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-04-03T01:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1Njk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NzEwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402657104", "bodyText": "Again, keep the description here.", "author": "MikeDombo", "createdAt": "2020-04-02T23:40:03Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -488,7 +512,7 @@ private void startStateTransition() throws InterruptedException {\n                                     reportState(State.ERRORED);\n                                     logger.atError().setEventType(\"service-runtime-error\").setCause(t).log();\n                                 }\n-                            }, \"start\");\n+                            });", "originalCommit": "62149c8e001ca92100d358f53d6db77013dd1ff3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MTI0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402681241", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-04-03T01:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NzEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NzQ0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402657449", "bodyText": "Instead of removing the description since it is unused, change the log on L627 to use the description, since the bt is a future which won't print anything helpful.", "author": "MikeDombo", "createdAt": "2020-04-02T23:41:18Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -619,7 +648,7 @@ private void startStateTransition() throws InterruptedException {\n     public void handleError() throws InterruptedException {\n     }\n \n-    private synchronized void setBackingTask(Runnable r, String db) {", "originalCommit": "62149c8e001ca92100d358f53d6db77013dd1ff3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MTI3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402681271", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-04-03T01:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NzQ0OQ=="}], "type": "inlineReview"}, {"oid": "e277e3d000ec24a6200d0b8ff36bbf9aa235b90f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e277e3d000ec24a6200d0b8ff36bbf9aa235b90f", "message": "addressed pr comments + fixed few  PMD violations", "committedDate": "2020-04-03T01:05:44Z", "type": "commit"}, {"oid": "53f1974927f39c36a198527ac01856026e2b4470", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/53f1974927f39c36a198527ac01856026e2b4470", "message": "updated pmd violations number", "committedDate": "2020-04-03T01:13:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDEwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402684103", "bodyText": "Do we want to get rid of assert? Maybe use Object.notNull instead?", "author": "MikeDombo", "createdAt": "2020-04-03T01:16:59Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -56,10 +56,10 @@ public int size() {\n \n     @Override\n     public void copyFrom(Node from) {\n-        assert (from != null);\n+        assert from != null;", "originalCommit": "53f1974927f39c36a198527ac01856026e2b4470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3MzUyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403373529", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-04-03T22:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDI3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402684276", "bodyText": "I think this might be wrong since this is inside of a lambda, the this is not the same this as outside of the lambda.", "author": "MikeDombo", "createdAt": "2020-04-03T01:17:35Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -84,7 +84,7 @@ public Node getChild(String name) {\n      * @return the node\n      */\n     public Topic createLeafChild(String name) {\n-        Node n = children.computeIfAbsent(name, (nm) -> new Topic(context, nm, Topics.this));\n+        Node n = children.computeIfAbsent(name, (nm) -> new Topic(context, nm, this));", "originalCommit": "53f1974927f39c36a198527ac01856026e2b4470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI0OTE2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403249166", "bodyText": "Since createLeafChild is within the Topics class and there is no inner classes at play,  replacing Topics.this with this should not cause any problem.", "author": "fahadmohammed01", "createdAt": "2020-04-03T19:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI1MjU1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403252552", "bodyText": "A lambda is an anonymous inner class. The this inside the lambda is not the same as outside, AFAIK.", "author": "MikeDombo", "createdAt": "2020-04-03T19:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxMjUxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403312510", "bodyText": "https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.27.2\nUnlike code appearing in anonymous class declarations, the meaning of names and the this and super keywords appearing in a lambda body, along with the accessibility of referenced declarations, are the same as in the surrounding context (except that lambda parameters introduce new names).", "author": "fahadmohammed01", "createdAt": "2020-04-03T20:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDUwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402684506", "bodyText": "Why are you removing this from the constructor?", "author": "MikeDombo", "createdAt": "2020-04-03T01:18:27Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -102,7 +108,6 @@\n     public EvergreenService(Topics topics) {\n         this.config = topics;\n         this.context = topics.getContext();\n-        this.lifecycle = topics.findInteriorChild(SERVICE_LIFECYCLE_NAMESPACE_TOPIC);", "originalCommit": "53f1974927f39c36a198527ac01856026e2b4470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2NzkwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402767908", "bodyText": "same reason as below", "author": "fahadmohammed01", "createdAt": "2020-04-03T06:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDczMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402684730", "bodyText": "All this should be in the constructor, and then subscribed to in order to get updates if the timeout changes.", "author": "MikeDombo", "createdAt": "2020-04-03T01:19:16Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -477,8 +482,33 @@ private void startStateTransition() throws InterruptedException {\n                                             .log(\"Got interrupted while waiting for dependency ready\");\n                                     return;\n                                 }\n-\n                                 try {\n+                                    Topics startUpTopic = getStartUpTopic();\n+                                    Integer timeout = null;\n+                                    if (startUpTopic != null) {\n+                                        timeout = (Integer) startUpTopic.findLeafChild(TIMEOUT_NAMESPACE_TOPIC)\n+                                                .dflt(DEFAULT_STARTUP_STAGE_TIMEOUT_IN_SEC).getOnce();\n+                                        Topics runTopic = getRunTopic();\n+                                        if (runTopic != null) {\n+                                            timeout = (Integer) startUpTopic.findLeafChild(TIMEOUT_NAMESPACE_TOPIC)\n+                                                    .dflt(null).getOnce();\n+                                        }\n+                                    }", "originalCommit": "53f1974927f39c36a198527ac01856026e2b4470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2Nzg3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402767879", "bodyText": "I didn't add this to the constructor because if a startup or run got added via mergeinConfig then the variable initialized in constructor will not get updated. We can subscribe to changes and update the values but say if the field is missing we will have to subscribe to its parent.", "author": "fahadmohammed01", "createdAt": "2020-04-03T06:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3MzA2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403373067", "bodyText": "Refactored to use find in topics", "author": "fahadmohammed01", "createdAt": "2020-04-03T22:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDc2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402684768", "bodyText": "is this an extra space?", "author": "MikeDombo", "createdAt": "2020-04-03T01:19:29Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -488,7 +518,7 @@ private void startStateTransition() throws InterruptedException {\n                                     reportState(State.ERRORED);\n                                     logger.atError().setEventType(\"service-runtime-error\").setCause(t).log();\n                                 }\n-                            }, \"start\");\n+                            },  \"start\");", "originalCommit": "53f1974927f39c36a198527ac01856026e2b4470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3MzA5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403373098", "bodyText": "removed", "author": "fahadmohammed01", "createdAt": "2020-04-03T22:51:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MzEwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404283105", "bodyText": "Still present it would seem.", "author": "MikeDombo", "createdAt": "2020-04-06T17:58:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxNzE0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404317145", "bodyText": "removed", "author": "fahadmohammed01", "createdAt": "2020-04-06T18:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NTIzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402685237", "bodyText": "use != null? I think PMD will be ok with it, and if not, let's ignore that because this is more complicated with the ternary.", "author": "MikeDombo", "createdAt": "2020-04-03T01:21:21Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -653,7 +691,7 @@ public void serviceErrored() {\n     }\n \n     public boolean isErrored() {\n-        return !getState().isHappy() || error != null;\n+        return getState().isHappy() && error == null ? false : true;", "originalCommit": "53f1974927f39c36a198527ac01856026e2b4470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2NTAxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402765017", "bodyText": "PMD was complaining complicated ternary operation  because of the ! and !=.", "author": "fahadmohammed01", "createdAt": "2020-04-03T06:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NTIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NTkyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r402685922", "bodyText": "Run should be handled by GenericExternalService. Since EvergreenService has no run() API it should not be doing anything with it. IMO run() is a detail of GenericExternalService which should be encapsulated within it.", "author": "MikeDombo", "createdAt": "2020-04-03T01:23:48Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -477,8 +482,33 @@ private void startStateTransition() throws InterruptedException {\n                                             .log(\"Got interrupted while waiting for dependency ready\");\n                                     return;\n                                 }\n-\n                                 try {\n+                                    Topics startUpTopic = getStartUpTopic();\n+                                    Integer timeout = null;\n+                                    if (startUpTopic != null) {\n+                                        timeout = (Integer) startUpTopic.findLeafChild(TIMEOUT_NAMESPACE_TOPIC)\n+                                                .dflt(DEFAULT_STARTUP_STAGE_TIMEOUT_IN_SEC).getOnce();\n+                                        Topics runTopic = getRunTopic();\n+                                        if (runTopic != null) {\n+                                            timeout = (Integer) startUpTopic.findLeafChild(TIMEOUT_NAMESPACE_TOPIC)\n+                                                    .dflt(null).getOnce();\n+                                        }", "originalCommit": "53f1974927f39c36a198527ac01856026e2b4470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MzIxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403143211", "bodyText": "Agree. Can we move this timeout logic to GenericExternalService?", "author": "fengwang666", "createdAt": "2020-04-03T16:54:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NTkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE2NDIyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403164222", "bodyText": "startup and run are two ways you can move the service to running. There is not much difference between them other than how they transition the service to finished state once the script execution finishes. GenericExternalService also do not have run() method, both run and startup configuration is handled in the startup().\nIts not a big change to move this to GenericExternalService, but since both the timeouts stand has the same behaviour I though it would be better to have it in one place.", "author": "fahadmohammed01", "createdAt": "2020-04-03T17:18:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NTkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3MzIxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403373211", "bodyText": "Moved run timeout to GenericExternalService", "author": "fahadmohammed01", "createdAt": "2020-04-03T22:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NTkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0NTgxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403145812", "bodyText": "Why do you put a reference of the service in the exception? Isn't the name of the service sufficient?", "author": "fengwang666", "createdAt": "2020-04-03T16:57:35Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/exceptions/ServiceUpdateException.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package com.aws.iot.evergreen.deployment.exceptions;\n+\n+import com.aws.iot.evergreen.kernel.EvergreenService;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import lombok.Getter;\n+\n+@SuppressFBWarnings(justification = \"This does not need to be serializable\", value = \"SE_BAD_FIELD\")\n+public class ServiceUpdateException extends DeploymentException {\n+\n+    @Getter\n+    private EvergreenService brokenService;", "originalCommit": "53f1974927f39c36a198527ac01856026e2b4470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE2NDI4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403164287", "bodyText": "I added it in case, a more richer message needed to be constructed by DA.", "author": "fahadmohammed01", "createdAt": "2020-04-03T17:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0NTgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNjU5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403336590", "bodyText": "This doesn't feel right. The handler of the exception shouldn't need to inspect EvergreenService.", "author": "fengwang666", "createdAt": "2020-04-03T21:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0NTgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxMzk0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403813940", "bodyText": "removed EvergreenService reference from exception and updated the error message", "author": "fahadmohammed01", "createdAt": "2020-04-06T03:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0NTgxMg=="}], "type": "inlineReview"}, {"oid": "47f5547aa1a44590f0a0c32dccb12319cd40e730", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/47f5547aa1a44590f0a0c32dccb12319cd40e730", "message": "moved run timeout to generic external service", "committedDate": "2020-04-03T22:50:05Z", "type": "commit"}, {"oid": "37f9d91ed014f232a16f9ae7078bea466e83bfd6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/37f9d91ed014f232a16f9ae7078bea466e83bfd6", "message": "Merge branch 'master' into throw-deployment-failure", "committedDate": "2020-04-04T03:51:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQyMDM0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403420349", "bodyText": "Thanks for adding these. Can you copy lookup also from Configuration and then have the lookup and find methods in Config delegate to these methods on the root topics?", "author": "MikeDombo", "createdAt": "2020-04-04T03:54:17Z", "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -133,6 +133,41 @@ public Topic lookup(String... path) {\n         return n.createLeafChild(path[limit]);\n     }\n \n+    /**\n+     * Find, but do not create if missing, a topic (a name/value pair) in the\n+     * config file. Returns null if missing.\n+     *\n+     * @param path String[] of node names to traverse to find or create the Topic\n+     */\n+    public Topic find(String... path) {", "originalCommit": "37f9d91ed014f232a16f9ae7078bea466e83bfd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxMzg0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403813842", "bodyText": "Done.", "author": "fahadmohammed01", "createdAt": "2020-04-06T03:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQyMDM0OQ=="}], "type": "inlineReview"}, {"oid": "b36fb2fd719f3f0aaa879e1f39d722d009679d62", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b36fb2fd719f3f0aaa879e1f39d722d009679d62", "message": "addressed pr comments", "committedDate": "2020-04-06T03:38:43Z", "type": "commit"}, {"oid": "b04145b56ac40794602b86ad3a1763b1902f2fdf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b04145b56ac40794602b86ad3a1763b1902f2fdf", "message": "fixed pmd violations", "committedDate": "2020-04-06T03:48:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxNjIxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403816211", "bodyText": "Looks like you can get rid of this now.", "author": "MikeDombo", "createdAt": "2020-04-06T03:50:45Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/exceptions/ServiceUpdateException.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package com.aws.iot.evergreen.deployment.exceptions;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+@SuppressFBWarnings(justification = \"This does not need to be serializable\", value = \"SE_BAD_FIELD\")", "originalCommit": "b04145b56ac40794602b86ad3a1763b1902f2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgyMDMzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403820330", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-04-06T04:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxNjIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxNjQ4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403816487", "bodyText": "This happens a lot. I think this should drop to debug.", "author": "MikeDombo", "createdAt": "2020-04-06T03:52:12Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -635,16 +662,19 @@ private void serviceTerminatedMoveToDesiredState(@Nonnull State desiredState) {\n     public void handleError() throws InterruptedException {\n     }\n \n-    private synchronized void setBackingTask(Runnable r, String db) {\n+    private synchronized void setBackingTask(Runnable r, String action) {\n         Future bt = backingTask;\n-        if (bt != null) {\n-            backingTask = null;\n-            if (!bt.isDone()) {\n-                logger.info(\"Stopping backingTask {}\", bt);\n-                bt.cancel(true);\n-            }\n+        String btName = backingTaskName;\n+\n+        if (!bt.isDone()) {\n+            backingTask = CompletableFuture.completedFuture(null);\n+            logger.info(\"Stopping backingTask {}\", btName);\n+            bt.cancel(true);\n         }\n+\n         if (r != null) {\n+            backingTaskName = action;\n+            logger.info(\"Scheduling backingTask {}\", backingTaskName);", "originalCommit": "b04145b56ac40794602b86ad3a1763b1902f2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgyMDMzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403820335", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-04-06T04:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxNjQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxNjk2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403816960", "bodyText": "This is overcomplicated. Exec has a timeout field which you can set instead. Try modifying the run function to lookup both the script and the timeout.", "author": "MikeDombo", "createdAt": "2020-04-06T03:54:23Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -106,12 +108,29 @@ public void startup() throws InterruptedException {\n                     }\n                 }\n             });\n+            Topic timeoutTopic = config.find(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                    LIFECYCLE_RUN_NAMESPACE_TOPIC, TIMEOUT_NAMESPACE_TOPIC);\n+            Integer timeout = timeoutTopic == null ? null : (Integer) timeoutTopic.getOnce();\n+            if (timeout != null) {", "originalCommit": "b04145b56ac40794602b86ad3a1763b1902f2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgyNTMzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403825333", "bodyText": "Synced offline, The timeout in exec doesn't do what we want, its causes the run() to block till the timeout is breached. Having a job scheduled into the future is better than having a thread wait the whole time.", "author": "fahadmohammed01", "createdAt": "2020-04-06T04:36:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxNjk2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgyNTQ5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r403825499", "bodyText": "Thanks for pointing it out, i didn't know there was a timeout in exec :)", "author": "fahadmohammed01", "createdAt": "2020-04-06T04:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxNjk2MA=="}], "type": "inlineReview"}, {"oid": "9cfaa0ec0b3ec1daf214defec8abbed669027801", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9cfaa0ec0b3ec1daf214defec8abbed669027801", "message": "addressed minor pr comments", "committedDate": "2020-04-06T03:58:43Z", "type": "commit"}, {"oid": "d283fce79b3ffd0ea7e2e68e54699e6ee3b66fcb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d283fce79b3ffd0ea7e2e68e54699e6ee3b66fcb", "message": "increased timeout for newly added test", "committedDate": "2020-04-06T16:02:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2OTIwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404269202", "bodyText": "Why not use find here with the whole path to TIMEOUT_NAMESPACE_TOPIC?", "author": "MikeDombo", "createdAt": "2020-04-06T17:35:47Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -478,8 +479,29 @@ private void startStateTransition() throws InterruptedException {\n                                             .log(\"Got interrupted while waiting for dependency ready\");\n                                     return;\n                                 }\n-\n                                 try {\n+                                    Topics startupTopics = config.findTopics(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,", "originalCommit": "d283fce79b3ffd0ea7e2e68e54699e6ee3b66fcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI3NTAyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404275023", "bodyText": "I want to differentiate between timeout not specified for startup life-cycle stage vs timeout not present because startup life-cycle stage itself is missing. find will return null in both the cases and we only need to start a timer if startup life-cycle stage is present", "author": "fahadmohammed01", "createdAt": "2020-04-06T17:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2OTIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0OTIwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404349207", "bodyText": "I feel the case of \"startup life-cycle stage itself is missing\" doesn't make a difference here", "author": "ShirleyZheng92", "createdAt": "2020-04-06T19:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2OTIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkyMTUwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404921501", "bodyText": "We don't enforce a timeout if startup life-cycle stage is missing as its handled in generic external service. Hence the explicit check startupTopics != null before enforcing timeout", "author": "fahadmohammed01", "createdAt": "2020-04-07T15:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2OTIwMg=="}], "type": "inlineReview"}, {"oid": "754d69f41939c40b930f0cd60d9ad39c8135aaa7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/754d69f41939c40b930f0cd60d9ad39c8135aaa7", "message": "explicitly added report state when run() time out triggers", "committedDate": "2020-04-06T17:44:47Z", "type": "commit"}, {"oid": "7a6eb3135bf0dcfeb6265fe9e1c9f5d38f1169b1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7a6eb3135bf0dcfeb6265fe9e1c9f5d38f1169b1", "message": "Merge branch 'master' into throw-deployment-failure", "committedDate": "2020-04-06T17:52:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MTkwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404281903", "bodyText": "Can we make this timeout any faster?", "author": "MikeDombo", "createdAt": "2020-04-06T17:56:35Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -36,4 +36,27 @@ void GIVEN_service_config_with_broken_skipif_config_WHEN_launch_service_THEN_ser\n         // THEN\n         assertTrue(testErrored.await(60, TimeUnit.SECONDS));\n     }\n+\n+    @Test\n+    void GIVEN_service_with_timeout_WHEN_timeout_expires_THEN_move_service_to_errored()\n+            throws InterruptedException {\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"service_timesout.yaml\").toString());\n+        kernel.launch();\n+        CountDownLatch ServicesAErroredLatch = new CountDownLatch(1);\n+        CountDownLatch ServicesBErroredLatch = new CountDownLatch(1);\n+        // service sleeps for 120 seconds during startup and timeout is 5 seconds, service should transition to errored\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if(\"ServiceA\".equals(service.getName()) && State.ERRORED.equals(newState)){\n+                ServicesAErroredLatch.countDown();\n+            }\n+            if(\"ServiceB\".equals(service.getName()) && State.ERRORED.equals(newState)){\n+                ServicesBErroredLatch.countDown();\n+            }\n+        });\n+\n+        assertTrue(ServicesAErroredLatch.await(60, TimeUnit.SECONDS));", "originalCommit": "7a6eb3135bf0dcfeb6265fe9e1c9f5d38f1169b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxNjk2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404316963", "bodyText": "made it 30 seconds. lets see if that works", "author": "fahadmohammed01", "createdAt": "2020-04-06T18:56:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MTkwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4NDg3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404284878", "bodyText": "Won't this be wrong if it did not timeout? If it ran to completion, then we should not be reporting error or calling close here.", "author": "MikeDombo", "createdAt": "2020-04-06T18:01:18Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -106,12 +108,28 @@ public void startup() throws InterruptedException {\n                     }\n                 }\n             });\n+            Topic timeoutTopic = config.find(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                    LIFECYCLE_RUN_NAMESPACE_TOPIC, TIMEOUT_NAMESPACE_TOPIC);\n+            Integer timeout = timeoutTopic == null ? null : (Integer) timeoutTopic.getOnce();\n+            if (timeout != null) {\n+                Exec processToClose = currentScript;\n+                context.get(ScheduledExecutorService.class).schedule(() -> {\n+                        try {\n+                            logger.atWarn(\"service-run-timed-out\")\n+                                    .log(\"Service failed to run within timeout, calling close in process\");\n+                            processToClose.close();", "originalCommit": "7a6eb3135bf0dcfeb6265fe9e1c9f5d38f1169b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxNjA4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404316080", "bodyText": "nice catch, fixed.", "author": "fahadmohammed01", "createdAt": "2020-04-06T18:54:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4NDg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4NTMwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404285309", "bodyText": "should we check if the future is done?", "author": "MikeDombo", "createdAt": "2020-04-06T18:02:06Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/mergeTest.java", "diffHunk": "@@ -21,5 +44,47 @@ public void testSomeMethod() throws Exception {\n         assertEquals(c.getRoot(), b.getRoot());\n     }\n \n+    @Test\n+    public void GIVEN_deployment_WHEN_all_service_are_running_THEN_waitForServicesToStart_completes_without_exception()\n+            throws InterruptedException {\n+        Kernel kernel = new Kernel();\n+        when(mockMainService.getState()).thenReturn(State.RUNNING);\n+        when(mockServiceA.getState()).thenReturn(State.RUNNING);\n+        when(mockServiceB.getState()).thenReturn(State.RUNNING);\n+\n+        when(mockMainService.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceA.reachedDesiredState()).thenReturn(true);\n+        when(mockServiceB.reachedDesiredState()).thenReturn(true);\n+        CompletableFuture future = new CompletableFuture();\n+        Set<EvergreenService> evergreenServices =\n+                new HashSet(Arrays.asList(mockMainService, mockServiceA, mockServiceB));\n+        kernel.waitForServicesToStart(evergreenServices, future);\n+\n+        assertFalse(future.isCompletedExceptionally());", "originalCommit": "7a6eb3135bf0dcfeb6265fe9e1c9f5d38f1169b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxNjA1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404316056", "bodyText": "The function being tested does not complete the future unless there is an exception.", "author": "fahadmohammed01", "createdAt": "2020-04-06T18:54:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4NTMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5NTUxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404295513", "bodyText": "Proper handling?", "author": "MikeDombo", "createdAt": "2020-04-06T18:19:48Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -106,12 +108,28 @@ public void startup() throws InterruptedException {\n                     }\n                 }\n             });\n+            Topic timeoutTopic = config.find(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                    LIFECYCLE_RUN_NAMESPACE_TOPIC, TIMEOUT_NAMESPACE_TOPIC);\n+            Integer timeout = timeoutTopic == null ? null : (Integer) timeoutTopic.getOnce();\n+            if (timeout != null) {\n+                Exec processToClose = currentScript;\n+                context.get(ScheduledExecutorService.class).schedule(() -> {\n+                        try {\n+                            logger.atWarn(\"service-run-timed-out\")\n+                                    .log(\"Service failed to run within timeout, calling close in process\");\n+                            processToClose.close();\n+                            reportState(State.ERRORED);\n+                        } catch (IOException e) {\n+                            logger.atError(\"\").log(\"\");", "originalCommit": "7a6eb3135bf0dcfeb6265fe9e1c9f5d38f1169b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxNjE1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404316156", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-04-06T18:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5NTUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5NzE5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404297199", "bodyText": "Does this need to be a field of the class since the lifecycle thread may break/continue which would cause this future to be lost?", "author": "MikeDombo", "createdAt": "2020-04-06T18:22:34Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -416,14 +417,14 @@ private void startStateTransition() throws InterruptedException {\n         while (!(isClosed.get() && getState().isClosable())) {\n             Optional<State> desiredState;\n             State current = getState();\n-            logger.atInfo().setEventType(\"service-state-transition-start\").kv(\"currentState\", current).log();\n+            logger.atInfo().setEventType(\"service-state-transition-start\").kv(CURRENT_STATE_METRIC_NAME, current).log();\n \n             // if already in desired state, remove the head of desired state list.\n             desiredState = peekOrRemoveFirstDesiredState(current);\n             while (desiredState.isPresent() && desiredState.get().equals(current)) {\n                 desiredState = peekOrRemoveFirstDesiredState(current);\n             }\n-\n+            AtomicReference<Future> triggerTimeOutReference = new AtomicReference<>();", "originalCommit": "7a6eb3135bf0dcfeb6265fe9e1c9f5d38f1169b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxNjM0NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404316344", "bodyText": "No, triggerTimeOutReference is only valid within startStateTransition", "author": "fahadmohammed01", "createdAt": "2020-04-06T18:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5NzE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2NzkwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404367900", "bodyText": "Add timeout to install as well? L452 has it hardcoded.", "author": "MikeDombo", "createdAt": "2020-04-06T20:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5NzE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkzMjY4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404932683", "bodyText": "why not, added support for configurable timeout for install. There is still hard coded timeout for shutdown, that can be fixed while tuning all the shutdown timeouts", "author": "fahadmohammed01", "createdAt": "2020-04-07T16:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5NzE5OQ=="}], "type": "inlineReview"}, {"oid": "61c899091cfdc4cc11ca7dfe71f374b8a61e626e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/61c899091cfdc4cc11ca7dfe71f374b8a61e626e", "message": "addressed minor comments", "committedDate": "2020-04-06T18:55:08Z", "type": "commit"}, {"oid": "e3471c05965ddcda0c25e25d61f376fff6c3f953", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e3471c05965ddcda0c25e25d61f376fff6c3f953", "message": "minor refactoring", "committedDate": "2020-04-06T19:32:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0MTU0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404241548", "bodyText": "Can this be in GenericExternalService.java", "author": "ShirleyZheng92", "createdAt": "2020-04-06T16:52:07Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -54,6 +56,11 @@\n     public static final String SERVICES_NAMESPACE_TOPIC = \"services\";\n     public static final String SERVICE_LIFECYCLE_NAMESPACE_TOPIC = \"lifecycle\";\n     public static final String SERVICE_NAME_KEY = \"serviceName\";\n+    public static final String LIFECYCLE_STARTUP_NAMESPACE_TOPIC = \"startup\";\n+    public static final String LIFECYCLE_RUN_NAMESPACE_TOPIC = \"run\";", "originalCommit": "d283fce79b3ffd0ea7e2e68e54699e6ee3b66fcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2Njk5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404366991", "bodyText": "+1, run is specific to external", "author": "MikeDombo", "createdAt": "2020-04-06T20:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0MTU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MTU2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404881561", "bodyText": "Moved run to external", "author": "fahadmohammed01", "createdAt": "2020-04-07T15:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0MTU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0MzExOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404243119", "bodyText": "Hmm can you add more message?", "author": "ShirleyZheng92", "createdAt": "2020-04-06T16:54:33Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -106,12 +108,29 @@ public void startup() throws InterruptedException {\n                     }\n                 }\n             });\n+            Topic timeoutTopic = config.find(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                    LIFECYCLE_RUN_NAMESPACE_TOPIC, TIMEOUT_NAMESPACE_TOPIC);\n+            Integer timeout = timeoutTopic == null ? null : (Integer) timeoutTopic.getOnce();\n+            if (timeout != null) {\n+                Exec processToClose = currentScript;\n+                context.get(ScheduledExecutorService.class).schedule(() -> {\n+                        try {\n+                            logger.atWarn(\"service-run-timed-out\")\n+                                    .log(\"Service failed to run within timeout, calling close in process\");\n+                            // sigint, sigterm will cause the process to exit with a non-zero exit code\n+                            // which would move the service into errored state\n+                            processToClose.close();\n+                        } catch (IOException e) {\n+                            logger.atError(\"\").log(\"\");", "originalCommit": "d283fce79b3ffd0ea7e2e68e54699e6ee3b66fcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MTQwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404881400", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-04-07T15:03:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI0MzExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2ODIwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404368208", "bodyText": "There should be a space here. But only 1.", "author": "MikeDombo", "createdAt": "2020-04-06T20:29:19Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -489,7 +511,7 @@ private void startStateTransition() throws InterruptedException {\n                                     reportState(State.ERRORED);\n                                     logger.atError().setEventType(\"service-runtime-error\").setCause(t).log();\n                                 }\n-                            }, \"start\");\n+                            },\"start\");", "originalCommit": "e3471c05965ddcda0c25e25d61f376fff6c3f953", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MTMwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404881303", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-04-07T15:03:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2ODIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2OTI5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404369293", "bodyText": "Whether it errors here or not, you still need to do the reportState, right? Should you maybe just put the report into finally?", "author": "MikeDombo", "createdAt": "2020-04-06T20:31:18Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -106,12 +108,32 @@ public void startup() throws InterruptedException {\n                     }\n                 }\n             });\n+            Topic timeoutTopic = config.find(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                    LIFECYCLE_RUN_NAMESPACE_TOPIC, TIMEOUT_NAMESPACE_TOPIC);\n+            Integer timeout = timeoutTopic == null ? null : (Integer) timeoutTopic.getOnce();\n+            if (timeout != null) {\n+                Exec processToClose = currentScript;\n+                context.get(ScheduledExecutorService.class).schedule(() -> {\n+                    if (processToClose.isRunning()) {\n+                        try {\n+                            logger.atWarn(\"service-run-timed-out\")\n+                                    .log(\"Service failed to run within timeout, calling close in process\");\n+                            processToClose.close();\n+                            reportState(State.ERRORED);\n+\n+                        } catch (IOException e) {", "originalCommit": "e3471c05965ddcda0c25e25d61f376fff6c3f953", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MTIzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/151#discussion_r404881239", "bodyText": "Moved reportState above processToClose.", "author": "fahadmohammed01", "createdAt": "2020-04-07T15:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2OTI5Mw=="}], "type": "inlineReview"}, {"oid": "17d0edd34306670d02f54343e4792e274efdc371", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/17d0edd34306670d02f54343e4792e274efdc371", "message": "addressed minor comments", "committedDate": "2020-04-07T14:37:31Z", "type": "commit"}, {"oid": "a4d7503acaf8c52ca38120435e58a7f17481570f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a4d7503acaf8c52ca38120435e58a7f17481570f", "message": "Merge branch 'master' into throw-deployment-failure", "committedDate": "2020-04-07T14:41:59Z", "type": "commit"}, {"oid": "f57f7fb4b10c5384edd4ef45fa6f67e27ef9c56f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f57f7fb4b10c5384edd4ef45fa6f67e27ef9c56f", "message": "added support for configurable install timeout", "committedDate": "2020-04-07T16:17:51Z", "type": "commit"}, {"oid": "db8fe02b5b8a51b09e609eadf6bc7d5a487a2d29", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/db8fe02b5b8a51b09e609eadf6bc7d5a487a2d29", "message": "use lookup to find timeout to avoid  pollute the config", "committedDate": "2020-04-07T17:17:55Z", "type": "commit"}, {"oid": "ef0812e55c40c05c6696a62043e4612504a73ebf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ef0812e55c40c05c6696a62043e4612504a73ebf", "message": "Merge branch 'master' into throw-deployment-failure", "committedDate": "2020-04-07T18:12:35Z", "type": "commit"}, {"oid": "b35af9fde7f33bd6a8067a1b7efcbfbe09319b96", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b35af9fde7f33bd6a8067a1b7efcbfbe09319b96", "message": "updating the time out for e2e as tests are timing out", "committedDate": "2020-04-07T19:23:34Z", "type": "commit"}, {"oid": "7a3bfd59473bf0d2a3c7e4f87e4db96fc646670b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7a3bfd59473bf0d2a3c7e4f87e4db96fc646670b", "message": "added timeout field to unit test", "committedDate": "2020-04-07T22:21:50Z", "type": "commit"}, {"oid": "de5ec757ed993e1eb38efb5cc5439ecc6a64af92", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/de5ec757ed993e1eb38efb5cc5439ecc6a64af92", "message": "Merge branch 'master' into throw-deployment-failure", "committedDate": "2020-04-07T22:24:04Z", "type": "commit"}]}