{"pr_number": 220, "pr_title": "Run E2E tests in parallel", "pr_createdAt": "2020-04-29T19:56:45Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/220", "timeline": [{"oid": "047bbc4619681b88ef327523c31ed6b57dc70d29", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/047bbc4619681b88ef327523c31ed6b57dc70d29", "message": "Run E2E tests in parallel", "committedDate": "2020-04-29T21:42:00Z", "type": "forcePushed"}, {"oid": "fe9a27a52ed552d896b340478aa5a1bd60f6b289", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fe9a27a52ed552d896b340478aa5a1bd60f6b289", "message": "Run E2E tests in parallel", "committedDate": "2020-04-29T22:52:49Z", "type": "forcePushed"}, {"oid": "f16ca7528df038152c948cfe4b292ba50d7e0fde", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f16ca7528df038152c948cfe4b292ba50d7e0fde", "message": "Run E2E tests in parallel", "committedDate": "2020-04-30T00:20:36Z", "type": "forcePushed"}, {"oid": "407c51d23025cfdb9510ad0cc93db42392a62998", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/407c51d23025cfdb9510ad0cc93db42392a62998", "message": "Run E2E tests in parallel", "committedDate": "2020-04-30T20:52:35Z", "type": "forcePushed"}, {"oid": "420087a209caf22a98d41fee956c33a487732ec3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/420087a209caf22a98d41fee956c33a487732ec3", "message": "Run E2E tests in parallel", "committedDate": "2020-04-30T21:07:14Z", "type": "forcePushed"}, {"oid": "d197ef38a344aa23675af89d500e4e3dbb64ea30", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d197ef38a344aa23675af89d500e4e3dbb64ea30", "message": "Run E2E tests in parallel", "committedDate": "2020-04-30T21:19:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0ODkzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/220#discussion_r418748935", "bodyText": "How about: https://github.com/grantwest/eventually-matchers", "author": "MikeDombo", "createdAt": "2020-05-01T21:38:02Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentCloudServiceIntegTest.java", "diffHunk": "@@ -98,53 +103,55 @@ void cleanUp() {\n         if (kernel != null) {\n             kernel.shutdown();\n         }\n-        Utils.cleanAllCreatedThings(iotClient);\n-        Utils.cleanAllCreatedThingGroups(iotClient);\n+        Utils.cleanThing(iotClient, thingInfo);\n+        Utils.cleanThingGroup(iotClient, thingGroupResp.thingGroupName());\n         createdIotJobIdList.forEach(jobId -> Utils.cleanJob(iotClient, jobId));\n+        createdIotJobIdList.clear();\n     }\n \n     @Test\n-    void GIVEN_blank_kernel_WHEN_create_deployment_on_thing_group_THEN_new_services_deployed_and_job_is_successful()\n-            throws Exception {\n-        System.setProperty(\"root\", tempRootDir.toString());\n-        kernel = new Kernel().parseArgs(\"-i\", getClass().getResource(\"blank_config.yaml\").toString());\n+    void GIVEN_blank_kernel_WHEN_create_deployment_on_thing_group_THEN_new_services_deployed_and_job_is_successful() throws Exception {\n+        kernel = new Kernel()\n+                .parseArgs(\"-i\", getClass().getResource(\"blank_config.yaml\").toString(), \"-r\", tempRootDir.toString());\n \n         Path localStoreContentPath = Paths.get(getClass().getResource(\"local_store_content\").getPath());\n         // pre-load contents to package store\n         FileUtils.copyFolderRecursively(localStoreContentPath, kernel.getPackageStorePath());\n \n-        Utils.ThingInfo thingInfo = Utils.createThing(iotClient);\n+        thingInfo = Utils.createThing(iotClient);\n         Utils.updateKernelConfigWithIotConfiguration(kernel, thingInfo);\n \n         kernel.launch();\n \n         // Create thing group and deployment\n-        String thingGroupArn = Utils.createThingGroupAndAddThing(iotClient, thingInfo);\n+        thingGroupResp = Utils.createThingGroupAndAddThing(iotClient, thingInfo);\n         DeploymentDocument document = DeploymentDocument.builder().timestamp(System.currentTimeMillis())\n                 .deploymentId(UUID.randomUUID().toString()).rootPackages(Arrays.asList(\"CustomerApp\", \"SomeService\"))\n-                .deploymentPackageConfigurationList(\n-                        Arrays.asList(new DeploymentPackageConfiguration(\"CustomerApp\", \"1.0.0\", null, null, null),\n-                                new DeploymentPackageConfiguration(\"SomeService\", \"1.0.0\", null, null, null))).build();\n+                .deploymentPackageConfigurationList(Arrays\n+                        .asList(new DeploymentPackageConfiguration(\"CustomerApp\", \"1.0.0\", null, null, null), new DeploymentPackageConfiguration(\"SomeService\", \"1.0.0\", null, null, null)))\n+                .build();\n \n-        String jobId1 = sendCreateDeploymentRequest(thingGroupArn, document);\n+        String jobId1 = sendCreateDeploymentRequest(thingGroupResp.thingGroupArn(), document);\n \n         // wait until deployment complete\n-        Utils.waitForJobExecutionStatusToSatisfy(iotClient, jobId1, thingInfo.thingName, Duration.ofMinutes(3),\n-                s -> s.equals(JobExecutionStatus.SUCCEEDED));\n-\n-        assertEquals(State.FINISHED, kernel.getMain().getState());\n-        assertEquals(State.FINISHED, kernel.locate(\"CustomerApp\").getState());\n-        assertEquals(State.FINISHED, kernel.locate(\"SomeService\").getState());\n+        Utils.waitForJobExecutionStatusToSatisfy(iotClient, jobId1, thingInfo.thingName, Duration.ofMinutes(3), s -> s\n+                .equals(JobExecutionStatus.SUCCEEDED));\n+\n+        CustomAssertionUtil.assertEventuallyTrue(3, Duration.ofMillis(500),\n+                () -> State.FINISHED.equals(kernel.getMain().getState()));\n+        CustomAssertionUtil.assertEventuallyTrue(3, Duration.ofMillis(500),\n+                () -> State.FINISHED.equals(kernel.locate(\"CustomerApp\").getState()));\n+        CustomAssertionUtil.assertEventuallyTrue(3, Duration.ofMillis(500),", "originalCommit": "d197ef38a344aa23675af89d500e4e3dbb64ea30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMjQwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/220#discussion_r419612400", "bodyText": "I'll try it out", "author": "hui-yang", "createdAt": "2020-05-04T17:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0ODkzNQ=="}], "type": "inlineReview"}, {"oid": "2d522dc937ead64f05576589173b77edae4afa45", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2d522dc937ead64f05576589173b77edae4afa45", "message": "Run E2E tests in parallel", "committedDate": "2020-05-04T18:31:57Z", "type": "forcePushed"}, {"oid": "9692d4651d6fb1023d96f1d5e20df87de73dce34", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9692d4651d6fb1023d96f1d5e20df87de73dce34", "message": "Run E2E tests in parallel", "committedDate": "2020-05-04T22:04:32Z", "type": "commit"}, {"oid": "9692d4651d6fb1023d96f1d5e20df87de73dce34", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9692d4651d6fb1023d96f1d5e20df87de73dce34", "message": "Run E2E tests in parallel", "committedDate": "2020-05-04T22:04:32Z", "type": "forcePushed"}, {"oid": "4776a8a34beb74e035d8fc119524eb556d9379ee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4776a8a34beb74e035d8fc119524eb556d9379ee", "message": "Merge branch 'master' into parallel", "committedDate": "2020-05-04T22:57:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3OTU1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/220#discussion_r419779553", "bodyText": "how long will this go for? We need reasonable timeouts.", "author": "MikeDombo", "createdAt": "2020-05-04T23:05:28Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentCloudServiceIntegTest.java", "diffHunk": "@@ -100,53 +106,52 @@ void cleanUp() {\n         if (kernel != null) {\n             kernel.shutdown();\n         }\n-        Utils.cleanAllCreatedThings(iotClient);\n-        Utils.cleanAllCreatedThingGroups(iotClient);\n+        Utils.cleanThing(iotClient, thingInfo);\n+        Utils.cleanThingGroup(iotClient, thingGroupResp.thingGroupName());\n         createdIotJobIdList.forEach(jobId -> Utils.cleanJob(iotClient, jobId));\n+        createdIotJobIdList.clear();\n     }\n \n     @Test\n-    void GIVEN_blank_kernel_WHEN_create_deployment_on_thing_group_THEN_new_services_deployed_and_job_is_successful()\n-            throws Exception {\n-        System.setProperty(\"root\", tempRootDir.toString());\n-        kernel = new Kernel().parseArgs(\"-i\", getClass().getResource(\"blank_config.yaml\").toString());\n+    void GIVEN_blank_kernel_WHEN_create_deployment_on_thing_group_THEN_new_services_deployed_and_job_is_successful() throws Exception {\n+        kernel = new Kernel()\n+                .parseArgs(\"-i\", getClass().getResource(\"blank_config.yaml\").toString(), \"-r\", tempRootDir.toString());\n \n         Path localStoreContentPath = Paths.get(getClass().getResource(\"local_store_content\").getPath());\n         // pre-load contents to package store\n         FileUtils.copyFolderRecursively(localStoreContentPath, kernel.getPackageStorePath());\n \n-        Utils.ThingInfo thingInfo = Utils.createThing(iotClient);\n+        thingInfo = Utils.createThing(iotClient);\n         Utils.updateKernelConfigWithIotConfiguration(kernel, thingInfo);\n \n         kernel.launch();\n \n         // Create thing group and deployment\n-        String thingGroupArn = Utils.createThingGroupAndAddThing(iotClient, thingInfo);\n+        thingGroupResp = Utils.createThingGroupAndAddThing(iotClient, thingInfo);\n         DeploymentDocument document = DeploymentDocument.builder().timestamp(System.currentTimeMillis())\n                 .deploymentId(UUID.randomUUID().toString()).rootPackages(Arrays.asList(\"CustomerApp\", \"SomeService\"))\n-                .deploymentPackageConfigurationList(\n-                        Arrays.asList(new DeploymentPackageConfiguration(\"CustomerApp\", \"1.0.0\", null, null, null),\n-                                new DeploymentPackageConfiguration(\"SomeService\", \"1.0.0\", null, null, null))).build();\n+                .deploymentPackageConfigurationList(Arrays\n+                        .asList(new DeploymentPackageConfiguration(\"CustomerApp\", \"1.0.0\", null, null, null), new DeploymentPackageConfiguration(\"SomeService\", \"1.0.0\", null, null, null)))\n+                .build();\n \n-        String jobId1 = sendCreateDeploymentRequest(thingGroupArn, document);\n+        String jobId1 = sendCreateDeploymentRequest(thingGroupResp.thingGroupArn(), document);\n \n         // wait until deployment complete\n-        Utils.waitForJobExecutionStatusToSatisfy(iotClient, jobId1, thingInfo.thingName, Duration.ofMinutes(3),\n-                s -> s.equals(JobExecutionStatus.SUCCEEDED));\n+        Utils.waitForJobExecutionStatusToSatisfy(iotClient, jobId1, thingInfo.thingName, Duration.ofMinutes(3), s -> s\n+                .equals(JobExecutionStatus.SUCCEEDED));\n \n-        assertThat(kernel.getMain().getState(), anyOf(is(State.RUNNING), is(State.FINISHED)));\n-        assertThat(kernel.locate(\"CustomerApp\").getState(), anyOf(is(State.RUNNING), is(State.FINISHED)));\n-        assertThat(kernel.locate(\"SomeService\").getState(), anyOf(is(State.RUNNING), is(State.FINISHED)));\n+        assertThat(kernel.getMain()::getState, eventuallyEval(is(State.FINISHED)));", "originalCommit": "4776a8a34beb74e035d8fc119524eb556d9379ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc4MDIyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/220#discussion_r419780223", "bodyText": "5 seconds by default. It's sufficient in most cases.", "author": "hui-yang", "createdAt": "2020-05-04T23:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3OTU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5MzEyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/220#discussion_r419793129", "bodyText": "nit - Let's make is consistent. E2E-INTRUSIVE and will be executed at Run intrusive e2e test sequentially stage.", "author": "leaf94", "createdAt": "2020-05-04T23:49:11Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -54,18 +57,19 @@\n import static org.junit.jupiter.api.Assertions.assertTrue;\n \n @ExtendWith(EGExtension.class)\n-@Tag(\"E2E\")\n+@Tag(\"E2E-EXCLUSIVE\")", "originalCommit": "4776a8a34beb74e035d8fc119524eb556d9379ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e850da35b89118fdc10c9cc3cfc68d1c0edfa35b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e850da35b89118fdc10c9cc3cfc68d1c0edfa35b", "message": "Add more logs in deployment notification handling", "committedDate": "2020-05-05T00:00:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgwMDYxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/220#discussion_r419800613", "bodyText": "Nice!\nSince you are adding this... As a good practice for external calls, I'd suggest log before and after making any external call, with the enough identifier for debugging purpose(if not logged by SDK). Sometimes even entire request should be logged if necessary.\nFor example,\nlogger.atInfo().kv(\"Thing Name\", thingName).log(\"Subscribing to job execution change events.\"); and logger.atInfo().kv(\"Thing Name\", thingName).log(\"Subscribed to job execution change events.\");\nLet's add the identifier for now and we could re-visit logging later.", "author": "leaf94", "createdAt": "2020-05-05T00:14:26Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -395,5 +401,6 @@ protected void subscribeToEventNotifications(Consumer<JobExecutionsChangedEvent>\n         CompletableFuture<Integer> subscribed = iotJobsClient\n                 .SubscribeToJobExecutionsChangedEvents(request, QualityOfService.AT_LEAST_ONCE, eventHandler);\n         subscribed.get(TIMEOUT_FOR_IOT_JOBS_OPERATIONS_SECONDS, TimeUnit.SECONDS);\n+        logger.atInfo().log(\"Subscribed to deployment notifications.\");", "originalCommit": "e850da35b89118fdc10c9cc3cfc68d1c0edfa35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgwNDQyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/220#discussion_r419804425", "bodyText": "Yes. I can add that. I didn't add both before and after because we're not waiting for this async call. One log line seems enough here and we do log when the response comes in.\nUPDATE: logging both before and after this call makes sense. I'll update.", "author": "hui-yang", "createdAt": "2020-05-05T00:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgwMDYxMw=="}], "type": "inlineReview"}, {"oid": "ed1544fcfd1de28c607aff86c3f55103b622f2ae", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed1544fcfd1de28c607aff86c3f55103b622f2ae", "message": "Add more logs in deployment notification handling", "committedDate": "2020-05-05T01:07:22Z", "type": "forcePushed"}, {"oid": "761d2d2374b0f9f38a67b224bbd53fad10a9bd8f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/761d2d2374b0f9f38a67b224bbd53fad10a9bd8f", "message": "Add more logs in deployment notification handling", "committedDate": "2020-05-05T01:23:40Z", "type": "forcePushed"}, {"oid": "d7c808d4e1d5aa04e0ebeb609061fb52d33fc618", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d7c808d4e1d5aa04e0ebeb609061fb52d33fc618", "message": "Add more logs in deployment notification handling", "committedDate": "2020-05-05T16:30:16Z", "type": "commit"}, {"oid": "d7c808d4e1d5aa04e0ebeb609061fb52d33fc618", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d7c808d4e1d5aa04e0ebeb609061fb52d33fc618", "message": "Add more logs in deployment notification handling", "committedDate": "2020-05-05T16:30:16Z", "type": "forcePushed"}, {"oid": "c446e41853776820d1f1e89a11a7f27b1d596778", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c446e41853776820d1f1e89a11a7f27b1d596778", "message": "Attempt to fix the issue where DS times out picking up the deployment", "committedDate": "2020-05-05T17:34:42Z", "type": "commit"}, {"oid": "1580ab7e76a4b3f75fee616c14b963761e71fe28", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1580ab7e76a4b3f75fee616c14b963761e71fe28", "message": "Merge branch 'master' into parallel", "committedDate": "2020-05-05T17:38:09Z", "type": "commit"}, {"oid": "d3a5420db7e4e5215b5881542b01ec2a329820aa", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d3a5420db7e4e5215b5881542b01ec2a329820aa", "message": "revert some changes", "committedDate": "2020-05-05T18:27:22Z", "type": "commit"}]}