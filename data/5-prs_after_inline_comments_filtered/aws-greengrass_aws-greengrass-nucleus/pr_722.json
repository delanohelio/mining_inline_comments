{"pr_number": 722, "pr_title": "Recipe in json format", "pr_createdAt": "2020-11-24T04:28:50Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722", "timeline": [{"oid": "bd70c13c2cb80a37a3e48b41439d8ce47ce1acfe", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd70c13c2cb80a37a3e48b41439d8ce47ce1acfe", "message": "parse recipe in JSON format sent from cloud", "committedDate": "2020-11-24T02:39:37Z", "type": "commit"}, {"oid": "3e4e7625cf34ba92648b98734775c33c6f2382bb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3e4e7625cf34ba92648b98734775c33c6f2382bb", "message": "specify format when parsing recipe string", "committedDate": "2020-11-24T04:26:51Z", "type": "commit"}, {"oid": "700ca2eca339f11faef02c8239655ba93c934f91", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/700ca2eca339f11faef02c8239655ba93c934f91", "message": "correct typing", "committedDate": "2020-11-24T04:31:05Z", "type": "commit"}, {"oid": "51f58f3e0f3a6b746555fbcc3ffe14051a93a097", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/51f58f3e0f3a6b746555fbcc3ffe14051a93a097", "message": "remove unused file", "committedDate": "2020-11-24T04:32:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyMDk0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r529720945", "bodyText": "why change this? the id looks more correct from signature perspective.", "author": "leaf94", "createdAt": "2020-11-24T16:42:38Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -204,24 +204,39 @@ private ComponentIdentifier negotiateVersionWithCloud(String componentName,\n                             + \"satisfying requirement '%s'.\", componentName, versionRequirements), e);\n         }\n \n-        ComponentIdentifier resolvedComponentId =\n-                new ComponentIdentifier(resolvedComponentVersion.getComponentName(),\n-                        new Semver(resolvedComponentVersion.getComponentVersion()));\n+        ComponentIdentifier resolvedComponentId = new ComponentIdentifier(resolvedComponentVersion.getComponentName(),\n+                new Semver(resolvedComponentVersion.getComponentVersion()));\n         String downloadedRecipeContent = StandardCharsets.UTF_8.decode(resolvedComponentVersion.getRecipe()).toString();\n+        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe downloadedRecipe;\n+        try {\n+            downloadedRecipe = RecipeLoader.parseRecipe(downloadedRecipeContent, RecipeLoader.RecipeFormat.JSON);\n+        } catch (PackageLoadingException e) {\n+            // TODO remove this backoff operation once cloud switch to send JSON recipe\n+            downloadedRecipe = RecipeLoader.parseRecipe(downloadedRecipeContent, RecipeLoader.RecipeFormat.YAML);\n+        }\n \n         // Save the recipe digest for plugin in a secure place, before persisting recipe\n-        storeRecipeDigestSecurelyForPlugin(resolvedComponentId, downloadedRecipeContent);\n+        storeRecipeDigestSecurelyForPlugin(downloadedRecipe, downloadedRecipeContent);", "originalCommit": "51f58f3e0f3a6b746555fbcc3ffe14051a93a097", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2MTUxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r529761514", "bodyText": "It parses the recipe inside the function previously. Now the parsing is moved outside the function,  model is passed to the function. With component recipe, it doesn't need id I think.", "author": "wikimonkey", "createdAt": "2020-11-24T17:42:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyMDk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyMjY3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r529722679", "bodyText": "Ah! Could you do me favor and not change the signature now? Otherwise rebasing #697 is going to be very painful!!!", "author": "leaf94", "createdAt": "2020-11-24T16:45:05Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -76,13 +76,17 @@ public ComponentStore(NucleusPaths nucleusPaths, PlatformResolver platformResolv\n     /**\n      * Creates or updates a package recipe in the package store on the disk.\n      *\n-     * @param pkgId         the id for the component\n-     * @param recipeContent recipe content to save\n+     * @param componentRecipe raw component recipe\n      * @throws PackageLoadingException if fails to write the package recipe to disk.\n      */\n-    void savePackageRecipe(@NonNull ComponentIdentifier pkgId, String recipeContent) throws PackageLoadingException {\n+    void saveComponentRecipe(@NonNull com.amazon.aws.iot.greengrass.component.common.ComponentRecipe componentRecipe)\n+            throws PackageLoadingException {", "originalCommit": "51f58f3e0f3a6b746555fbcc3ffe14051a93a097", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2MDY5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r529760698", "bodyText": "got it back.", "author": "wikimonkey", "createdAt": "2020-11-24T17:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyMjY3OQ=="}], "type": "inlineReview"}, {"oid": "85e3459812b1f47f03840cb1b6ca58ce112cf054", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/85e3459812b1f47f03840cb1b6ca58ce112cf054", "message": "add back savePackageRecipe method of component store, used by the other components", "committedDate": "2020-11-24T17:37:32Z", "type": "commit"}, {"oid": "c46cf6c9d0b2a1924ae1484463b92a281d0f0edb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c46cf6c9d0b2a1924ae1484463b92a281d0f0edb", "message": "Merge remote-tracking branch 'origin/master' into recipe-in-json-format", "committedDate": "2020-11-24T19:50:28Z", "type": "commit"}, {"oid": "b6238bea352b821ab338b3088b831d372d59acc5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b6238bea352b821ab338b3088b831d372d59acc5", "message": "fix broken unit tests from merging", "committedDate": "2020-11-24T19:54:11Z", "type": "commit"}, {"oid": "93d8eebc4c5a334fffaa4190f66e8b0d8db8a98d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/93d8eebc4c5a334fffaa4190f66e8b0d8db8a98d", "message": "Merge branch 'master' into recipe-in-json-format", "committedDate": "2020-11-24T20:08:34Z", "type": "commit"}, {"oid": "9c68c5e249b513f825d3d924ebcef26b670ab984", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9c68c5e249b513f825d3d924ebcef26b670ab984", "message": "Merge branch 'master' into recipe-in-json-format", "committedDate": "2020-11-25T00:05:00Z", "type": "commit"}, {"oid": "6244521f0cb44ff5d7c2d50d27dd7ebd8d43ac7c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6244521f0cb44ff5d7c2d50d27dd7ebd8d43ac7c", "message": "Merge branch 'master' into recipe-in-json-format", "committedDate": "2020-11-25T07:19:12Z", "type": "commit"}, {"oid": "37159fc25ba5060e79606fcd7c3196d1dcc4145c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/37159fc25ba5060e79606fcd7c3196d1dcc4145c", "message": "Merge branch 'master' into recipe-in-json-format", "committedDate": "2020-11-25T18:12:26Z", "type": "commit"}, {"oid": "7d7e47c3f2a84fa6becdcdb56bfd3ec6ec31624f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7d7e47c3f2a84fa6becdcdb56bfd3ec6ec31624f", "message": "Merge branch 'master' into recipe-in-json-format", "committedDate": "2020-11-25T21:41:20Z", "type": "commit"}, {"oid": "5647a214943746105d93a35ea3a46fc40ba70430", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5647a214943746105d93a35ea3a46fc40ba70430", "message": "Merge branch 'master' into recipe-in-json-format", "committedDate": "2020-11-25T22:29:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4NjIxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r530686213", "bodyText": "Maybe check file suffix is better :)", "author": "ShirleyZheng92", "createdAt": "2020-11-25T23:06:18Z", "path": "src/main/java/com/aws/greengrass/componentmanager/converter/RecipeLoader.java", "diffHunk": "@@ -76,7 +94,8 @@ public RecipeLoader(PlatformResolver platformResolver) {\n      */\n     public Optional<ComponentRecipe> loadFromFile(String recipeFileContent) throws PackageLoadingException {\n \n-        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe componentRecipe = parseRecipe(recipeFileContent);\n+        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe componentRecipe =\n+                parseRecipe(recipeFileContent, RecipeFormat.YAML);", "originalCommit": "5647a214943746105d93a35ea3a46fc40ba70430", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4Nzg1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r530687856", "bodyText": "Maybe, but JSON is valid YAML.", "author": "wikimonkey", "createdAt": "2020-11-25T23:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4NjIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4NzM2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r530687365", "bodyText": "Can we remove this method?", "author": "ShirleyZheng92", "createdAt": "2020-11-25T23:10:33Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -204,24 +204,39 @@ private ComponentIdentifier negotiateVersionWithCloud(String componentName,\n                             + \"satisfying requirement '%s'.\", componentName, versionRequirements), e);\n         }\n \n-        ComponentIdentifier resolvedComponentId =\n-                new ComponentIdentifier(resolvedComponentVersion.getComponentName(),\n-                        new Semver(resolvedComponentVersion.getComponentVersion()));\n+        ComponentIdentifier resolvedComponentId = new ComponentIdentifier(resolvedComponentVersion.getComponentName(),\n+                new Semver(resolvedComponentVersion.getComponentVersion()));\n         String downloadedRecipeContent = StandardCharsets.UTF_8.decode(resolvedComponentVersion.getRecipe()).toString();\n+        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe downloadedRecipe;\n+        try {\n+            downloadedRecipe = RecipeLoader.parseRecipe(downloadedRecipeContent, RecipeLoader.RecipeFormat.JSON);\n+        } catch (PackageLoadingException e) {\n+            // TODO remove this backoff operation once cloud switch to send JSON recipe\n+            downloadedRecipe = RecipeLoader.parseRecipe(downloadedRecipeContent, RecipeLoader.RecipeFormat.YAML);\n+        }\n \n         // Save the recipe digest for plugin in a secure place, before persisting recipe\n-        storeRecipeDigestSecurelyForPlugin(resolvedComponentId, downloadedRecipeContent);\n+        storeRecipeDigestSecurelyForPlugin(downloadedRecipe, downloadedRecipeContent);\n \n         // Save the recipe\n         boolean saveContent = true;\n         Optional<String> recipeContentOnDevice = componentStore.findComponentRecipeContent(resolvedComponentId);\n \n-        if (recipeContentOnDevice.filter(recipe -> recipe.equals(downloadedRecipeContent)).isPresent()) {\n+        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe finalDownloadedRecipe = downloadedRecipe;\n+        if (recipeContentOnDevice.map(recipeContent -> {\n+            try {\n+                return RecipeLoader.parseRecipe(recipeContent, RecipeLoader.RecipeFormat.YAML);\n+            } catch (PackageLoadingException e) {\n+                // if fail to parse local recipe, treat it as not presented\n+                logger.atDebug().setCause(e).kv(\"componentId\", resolvedComponentId).log(\"Failed to parse local recipe\");\n+                return null;\n+            }\n+        }).filter(recipe -> recipe.equals(finalDownloadedRecipe)).isPresent()) {\n             saveContent = false;\n         }\n \n         if (saveContent) {\n-            componentStore.savePackageRecipe(resolvedComponentId, downloadedRecipeContent);", "originalCommit": "5647a214943746105d93a35ea3a46fc40ba70430", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4Nzc5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r530687798", "bodyText": "Heard from Ethan, CLI is calling the method. Will remove it once CLI uses new method.", "author": "wikimonkey", "createdAt": "2020-11-25T23:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4NzM2NQ=="}], "type": "inlineReview"}, {"oid": "c9f12c5ef61dd28143c482ca8d6627345621abcf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c9f12c5ef61dd28143c482ca8d6627345621abcf", "message": "Merge branch 'master' into recipe-in-json-format", "committedDate": "2020-11-25T23:21:46Z", "type": "commit"}]}