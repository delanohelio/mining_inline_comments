{"pr_number": 67, "pr_title": "Changes to update application layer protocol", "pr_createdAt": "2020-02-21T01:24:30Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67", "timeline": [{"oid": "2c10f92d19fd539f02bbb0c4b76493fc7f52cc1b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2c10f92d19fd539f02bbb0c4b76493fc7f52cc1b", "message": "Changes to update application layer protocol", "committedDate": "2020-02-21T01:22:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MTk0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382351946", "bodyText": "Like the other apps, this should be read from the sdk as a public static", "author": "MikeDombo", "createdAt": "2020-02-21T01:28:23Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/AuthHandler.java", "diffHunk": "@@ -30,6 +28,7 @@\n public class AuthHandler implements InjectionActions {\n     public static final String AUTH_TOKEN_LOOKUP_KEY = \"_AUTH_TOKENS\";\n     public static final String SERVICE_UNIQUE_ID_KEY = \"_UID\";\n+    public static final int AUTH_API_VERSION = 1;", "originalCommit": "2c10f92d19fd539f02bbb0c4b76493fc7f52cc1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgxOTU5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382819598", "bodyText": "Will kernel depend on client SDK as well?", "author": "ShirleyZheng92", "createdAt": "2020-02-21T21:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MTk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMDA3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382820079", "bodyText": "Yes, it already does depend on it.", "author": "MikeDombo", "createdAt": "2020-02-21T21:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MTk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MjQyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382352427", "bodyText": "Read this from the sdk.", "author": "MikeDombo", "createdAt": "2020-02-21T01:30:15Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/modules/LifecycleIPCService.java", "diffHunk": "@@ -33,6 +31,7 @@\n //TODO: see if this needs to be a GGService\n @ImplementsService(name = \"lifecycleipc\", autostart = true)\n public class LifecycleIPCService extends EvergreenService {\n+    public static final int LIFECYCLE_SERVICE_API_VERSION = 1;", "originalCommit": "2c10f92d19fd539f02bbb0c4b76493fc7f52cc1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NDE3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382354178", "bodyText": "Shouldn't this be decoupled from the SDK version?", "author": "fahadmohammed01", "createdAt": "2020-02-21T01:37:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NTU4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382355580", "bodyText": "Not necessarily since the server is compiled with a certain version of the SDK (so it is coupled anyway).", "author": "MikeDombo", "createdAt": "2020-02-21T01:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3NzMwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382777309", "bodyText": "Removed api version, added todo to implement a version compatibility check. Service might support multiple version of the sdk to be backward compatible.", "author": "fahadmohammed01", "createdAt": "2020-02-21T19:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MjQyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MjY2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382352662", "bodyText": "No * imports.", "author": "MikeDombo", "createdAt": "2020-02-21T01:31:03Z", "path": "src/test/java/com/aws/iot/evergreen/ipc/AuthHandlerTest.java", "diffHunk": "@@ -27,13 +28,10 @@\n import java.net.SocketAddress;\n import java.nio.charset.StandardCharsets;\n \n-import static com.aws.iot.evergreen.ipc.AuthHandler.AUTH_TOKEN_LOOKUP_KEY;\n-import static com.aws.iot.evergreen.ipc.AuthHandler.SERVICE_UNIQUE_ID_KEY;\n+import static com.aws.iot.evergreen.ipc.AuthHandler.*;\n import static org.hamcrest.CoreMatchers.containsString;\n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.junit.jupiter.api.Assertions.assertNotNull;\n-import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.*;", "originalCommit": "2c10f92d19fd539f02bbb0c4b76493fc7f52cc1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NTE2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382355161", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-02-21T01:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MjY2Mg=="}], "type": "inlineReview"}, {"oid": "4ea935a2640992466f47776e08ef5506612026f3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ea935a2640992466f47776e08ef5506612026f3", "message": "removed * imports", "committedDate": "2020-02-21T01:38:14Z", "type": "commit"}, {"oid": "743db013d0e187deecc581744327c53090b91f7e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/743db013d0e187deecc581744327c53090b91f7e", "message": "addressed PR  comments", "committedDate": "2020-02-21T19:35:01Z", "type": "commit"}, {"oid": "4299437600afc92ce6a3258e9fa8717c12e8f088", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4299437600afc92ce6a3258e9fa8717c12e8f088", "message": "fixed check style issues", "committedDate": "2020-02-21T19:45:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3Njc4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382776785", "bodyText": "Why is this todo? It should be done in this pull.", "author": "MikeDombo", "createdAt": "2020-02-21T19:55:15Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/modules/LifecycleIPCService.java", "diffHunk": "@@ -68,12 +68,9 @@ public void postInject() {\n     public Future<Message> handleMessage(Message message, ConnectionContext context) {\n         CompletableFuture<Message> fut = new CompletableFuture<>();\n \n+        ApplicationMessage applicationMessage = new ApplicationMessage(message.getPayload());\n         try {\n-            ApplicationMessage applicationMessage = new ApplicationMessage(message.getPayload());\n-            if (applicationMessage.getVersion() != LIFECYCLE_SERVICE_API_VERSION) {\n-                throw new IllegalArgumentException(\"Unknown API Version\");\n-            }\n-\n+            //TODO: add version compatibility check", "originalCommit": "4299437600afc92ce6a3258e9fa8717c12e8f088", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3OTA0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382779045", "bodyText": "updated comments above", "author": "fahadmohammed01", "createdAt": "2020-02-21T20:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3Njc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMDQ3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382820478", "bodyText": "I'm wondering that if we are completing the future here, why return a Future of this method instead of Message directly?", "author": "ShirleyZheng92", "createdAt": "2020-02-21T21:45:39Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/modules/LifecycleIPCService.java", "diffHunk": "@@ -62,55 +61,56 @@ public void postInject() {\n     /**\n      * Handle all requests from the client.\n      *\n-     * @param request the incoming request\n+     * @param message the incoming request\n      * @param context caller request context\n      * @return future containing our response\n      */\n-    public Future<Message> handleMessage(Message request, ConnectionContext context) {\n+    public Future<Message> handleMessage(Message message, ConnectionContext context) {\n         CompletableFuture<Message> fut = new CompletableFuture<>();\n \n+        ApplicationMessage applicationMessage = new ApplicationMessage(message.getPayload());\n         try {\n-            GeneralRequest<Object, LifecycleRequestTypes> obj =\n-                    IPCUtil.decode(request, new TypeReference<GeneralRequest<Object, LifecycleRequestTypes>>() {\n-                    });\n-\n-            GeneralResponse<?, LifecycleResponseStatus> genResp = new GeneralResponse<>();\n-            switch (obj.getType()) {\n-                case listen:\n+            //TODO: add version compatibility check\n+            LifecycleServiceOpCodes lifecycleServiceOpCodes =\n+                    LifecycleServiceOpCodes.values()[applicationMessage.getOpCode()];\n+            LifecycleGenericResponse lifecycleGenericResponse = new LifecycleGenericResponse();\n+            switch (lifecycleServiceOpCodes) {\n+                case REGISTER_LISTENER:\n                     LifecycleListenRequest listenRequest =\n-                            mapper.convertValue(obj.getRequest(), LifecycleListenRequest.class);\n-                    genResp = agent.listenToStateChanges(listenRequest, context);\n+                            mapper.readValue(applicationMessage.getPayload(), LifecycleListenRequest.class);\n+                    lifecycleGenericResponse = agent.listenToStateChanges(listenRequest, context);\n                     break;\n-                case setState:\n+                case REPORT_STATE:\n                     StateChangeRequest stateChangeRequest =\n-                            mapper.convertValue(obj.getRequest(), StateChangeRequest.class);\n-                    genResp = agent.reportState(stateChangeRequest, context);\n+                            mapper.readValue(applicationMessage.getPayload(), StateChangeRequest.class);\n+                    lifecycleGenericResponse = agent.reportState(stateChangeRequest, context);\n                     break;\n                 default:\n-                    genResp.setError(LifecycleResponseStatus.InvalidRequest);\n-                    genResp.setErrorMessage(\"Unknown request type \" + obj.getType());\n+                    lifecycleGenericResponse.setStatus(LifecycleResponseStatus.InvalidRequest);\n+                    lifecycleGenericResponse.setErrorMessage(\"Unknown request type \"\n+                            + lifecycleServiceOpCodes.toString());\n                     break;\n             }\n-            fut.complete(new Message(IPCUtil.encode(genResp)));\n \n+            ApplicationMessage responseMessage = ApplicationMessage.builder().version(applicationMessage.getVersion())\n+                    .payload(mapper.writeValueAsBytes(lifecycleGenericResponse)).build();\n+            fut.complete(new Message(responseMessage.toByteArray()));\n         } catch (Throwable e) {\n             log.log(Level.Error, \"Failed to respond to handleMessage\", e);\n-\n-            GeneralResponse<Void, LifecycleResponseStatus> errorResponse =\n-                    GeneralResponse.<Void, LifecycleResponseStatus>builder()\n-                            .error(LifecycleResponseStatus.InternalError).errorMessage(e.getMessage()).build();\n-\n             try {\n-                fut.complete(new Message(IPCUtil.encode(errorResponse)));\n+                LifecycleGenericResponse response = LifecycleGenericResponse.builder()\n+                        .status(LifecycleResponseStatus.InternalError).errorMessage(e.getMessage()).build();\n+                ApplicationMessage responseMessage = ApplicationMessage.builder()\n+                        .version(applicationMessage.getVersion())\n+                        .payload(mapper.writeValueAsBytes(response)).build();\n+                fut.complete(new Message(responseMessage.toByteArray()));", "originalCommit": "4299437600afc92ce6a3258e9fa8717c12e8f088", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNDI3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382824273", "bodyText": "I feel IPCService should handle the Future<> part and the handler function of IPC module should just do blocking calls.", "author": "ShirleyZheng92", "createdAt": "2020-02-21T21:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNTk0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382825947", "bodyText": "We want to be able to add timeouts in the future, which Futures will let us do easily.", "author": "MikeDombo", "createdAt": "2020-02-21T22:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNjAxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382826017", "bodyText": "But that can be in a separate PR", "author": "ShirleyZheng92", "createdAt": "2020-02-21T22:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNjY4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382826687", "bodyText": "Timeouts aren't implemented, but the Future handling already exists; there's no reason to remove it now.", "author": "MikeDombo", "createdAt": "2020-02-21T22:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyOTQ3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382829479", "bodyText": "However this function is completing a Future before returning it.\nSupporting timeout needs to be be something like below:\n// In IPC Service:\nFuture<Message> fut = new Future<>\n// put fut in response map\nhandler = router.getHandler(dest);\nthreadPool.submit(() -> {\n  fut.complete(handler(clientContext, message));\n);\n\nif (fut.get(timeout)) {\n  thread.cancel();\n}", "author": "ShirleyZheng92", "createdAt": "2020-02-21T22:09:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQyOTY4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r383429688", "bodyText": "The current implementation is synchronous and always returns a completed future. Having futures now allows us to make this async going forward. This was the intent in making IPCCallback interface return a Future", "author": "fahadmohammed01", "createdAt": "2020-02-24T18:14:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMDQ3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMTI3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382821273", "bodyText": "Missing version?\nShould add @Notnull to the fields in ApplicationMessage so that the builder will fail for missing fields.", "author": "MikeDombo", "createdAt": "2020-02-21T21:47:51Z", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/lifecycle/LifecycleIPCAgent.java", "diffHunk": "@@ -108,18 +108,17 @@ public void postInject() {\n             executor.submit(() -> {\n                 // Synchronize on context so that we only try to send 1 update at a time to a given client\n                 synchronized (context) {\n-                    StateTransitionEvent trans =\n-                            StateTransitionEvent.builder().newState(newState.toString()).oldState(oldState.toString())\n-                                    .service(listenRequest.getServiceName()).build();\n-\n-                    GeneralRequest<StateTransitionEvent, LifecycleRequestTypes> req =\n-                            GeneralRequest.<StateTransitionEvent, LifecycleRequestTypes>builder()\n-                                    .type(LifecycleRequestTypes.transition).request(trans).build();\n+                    StateTransitionEvent stateTransitionEvent =\n+                            StateTransitionEvent.builder().newState(newState.toString())\n+                                    .oldState(oldState.toString()).service(listenRequest.getServiceName()).build();\n \n                     try {\n+                        ApplicationMessage applicationMessage = ApplicationMessage.builder()", "originalCommit": "4299437600afc92ce6a3258e9fa8717c12e8f088", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNzUxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r382827515", "bodyText": "+1. Also lifecycle (and probably any IPC module that does a server push) need to keep a map of clientContext -> AppVersion if we are making server response version equals to client version", "author": "ShirleyZheng92", "createdAt": "2020-02-21T22:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMTI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ3MTI2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r383471260", "bodyText": "Added @nonnull to version and payload in ApplicationMessage (in the SDK PR). We do not have validation for a lot of API inputs, there should be PR addressing that as the API are getting mature now", "author": "fahadmohammed01", "createdAt": "2020-02-24T19:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMTI3Mw=="}], "type": "inlineReview"}, {"oid": "9f7e4d490071f95e194055cacab72592033a416a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9f7e4d490071f95e194055cacab72592033a416a", "message": "minor refactoring based on PR", "committedDate": "2020-02-24T21:32:19Z", "type": "commit"}, {"oid": "94fbe400e8d733985bfd548aff22f1ea28597723", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/94fbe400e8d733985bfd548aff22f1ea28597723", "message": "Merge branch 'master' into updated-application-protocol", "committedDate": "2020-02-25T17:21:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NjMyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/67#discussion_r384076321", "bodyText": "[Minor] I would put the static import here directly for easy reading...", "author": "leaf94", "createdAt": "2020-02-25T19:26:58Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/modules/ServiceDiscoveryService.java", "diffHunk": "@@ -68,49 +67,50 @@ public void postInject() {\n      */\n     public Future<Message> handleMessage(Message request, ConnectionContext context) {\n         CompletableFuture<Message> fut = new CompletableFuture<>();\n+        ApplicationMessage message = ApplicationMessage.fromBytes(request.getPayload());\n         try {\n-            GeneralRequest<Object, ServiceDiscoveryRequestTypes> obj =\n-                    IPCUtil.decode(request, new TypeReference<GeneralRequest<Object, ServiceDiscoveryRequestTypes>>() {\n-                    });\n+            //TODO: add version compatibility check\n \n-            GeneralResponse<?, ServiceDiscoveryResponseStatus> genResp = new GeneralResponse<>();\n-            switch (obj.getType()) {\n-                case lookup:\n-                    LookupResourceRequest lookup = mapper.convertValue(obj.getRequest(), LookupResourceRequest.class);\n+            ServiceDiscoveryOpCodes opCode = values()[message.getOpCode()];", "originalCommit": "94fbe400e8d733985bfd548aff22f1ea28597723", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d073232373dd82381f005bc2cecced54051f8e77", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d073232373dd82381f005bc2cecced54051f8e77", "message": "Merge branch 'master' into updated-application-protocol", "committedDate": "2020-02-25T19:49:06Z", "type": "commit"}, {"oid": "36af360faf009a28fb0cb7855c014d88ef0a9dd8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/36af360faf009a28fb0cb7855c014d88ef0a9dd8", "message": "Update pom.xml", "committedDate": "2020-02-25T19:59:45Z", "type": "commit"}]}