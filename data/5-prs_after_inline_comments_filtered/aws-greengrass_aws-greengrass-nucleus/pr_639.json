{"pr_number": 639, "pr_title": "V234938383: Investigate how to allow the AuthorizationHandler to initalize after services are registered", "pr_createdAt": "2020-11-07T01:49:23Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639", "timeline": [{"oid": "596a77a53908809795d9ebef29e5467b6c4dcc8b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/596a77a53908809795d9ebef29e5467b6c4dcc8b", "message": "V234938383: Investigate how to allow the AuthorizationHandler to initialize after services are registered\n\nDetails:\nThis ensures that TES handler is registered as component before the default policies are loaded. Also as per the discussion there is no need to register other component operations, since the policies would be merged as a part of recipe after the start up.", "committedDate": "2020-11-07T01:41:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r519084107", "bodyText": "So I'm guessing we're not able to force TokenExchangeService to start up before the AuthorizationHandler, then?", "author": "avipinku", "createdAt": "2020-11-07T02:31:08Z", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -73,6 +74,8 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n         Map<String, List<AuthorizationPolicy>> componentNameToPolicies = policyParser.parseAllAuthorizationPolicies(\n                 kernel);\n \n+        // Adding TES component and operation before it's default policies are fetched\n+        componentToOperationsMap.put(TOKEN_EXCHANGE_SERVICE_TOPICS, new HashSet<>(Arrays.asList(AUTHZ_TES_OPERATION)));", "originalCommit": "596a77a53908809795d9ebef29e5467b6c4dcc8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk4NzUyMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r519987520", "bodyText": "There is no fixed order in which these classes would be loaded so there is not guarantee that TokenExchangeService will start after AuthorizationHandler", "author": "k-khatri", "createdAt": "2020-11-09T17:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjQwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r520016408", "bodyText": "Ok. Do we want to remove the registration logic in the TokenExchangeService.java PostInject, if we're registering it here?", "author": "avipinku", "createdAt": "2020-11-09T18:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDExNjQ1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r520116452", "bodyText": "These 2 names look different aws.greengrass.TokenExchangeService and com.aws.greengrass.tes.TokenExchangeService so I guess we need to keep them", "author": "k-khatri", "createdAt": "2020-11-09T20:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MjA1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r520152054", "bodyText": "Also add \"aws.greengrass#PublishToTopic\",  \"aws.greengrass#SubscribeToTopic\" for aws.greengrass.ipc.pubsub service. Add \"aws.greengrass#PublishToIoTCore\", \"aws.greengrass#SubscribeToIoTCore\" for \"aws.greengrass.ipc.mqttproxy\" service.\nI think we dont need to add TES and secrets here, as they will always start after Auth Handler as those are services and not native classes. Let them do registration on their own, like they do it today.\n\nMake sure these constants are properly defined at a single place.\nAdd UT with bad operation fields in the config and make sure they fail", "author": "prateek-y", "createdAt": "2020-11-09T22:08:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMzQ5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r520203497", "bodyText": "@prateek-y We are already doing the registration in the postInject of these classes MqttProxyIPCService and PubSubIPCService. So in that case after removing TES we don't even need this change?", "author": "k-khatri", "createdAt": "2020-11-10T00:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNDAwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r520204008", "bodyText": "Only thing remains is uncommenting the exception", "author": "k-khatri", "createdAt": "2020-11-10T00:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNTExNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r520205115", "bodyText": "actually lets keep tes as well, and just initialize the map with the same operations. If register is called later, it can just override the map. We just want to make sure that when AuthHandler comes up it knows all operations.", "author": "prateek-y", "createdAt": "2020-11-10T00:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MDcyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r520880727", "bodyText": "Added the them to the map also added a UT check for bad operations", "author": "k-khatri", "createdAt": "2020-11-10T21:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDE0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r519084141", "bodyText": "You can remove this comment now", "author": "avipinku", "createdAt": "2020-11-07T02:31:27Z", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -313,9 +316,9 @@ private void isComponentRegistered(String componentName) throws AuthorizationExc\n         }\n         // TODO: [V234938383] solve the issue where the authhandler starts up and loads policies before services", "originalCommit": "596a77a53908809795d9ebef29e5467b6c4dcc8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDExNjkzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r520116933", "bodyText": "Done", "author": "k-khatri", "createdAt": "2020-11-09T21:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDE0MQ=="}], "type": "inlineReview"}, {"oid": "21e5036c5d41d54846a9403324ab06e2ceb38ae1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/21e5036c5d41d54846a9403324ab06e2ceb38ae1", "message": "Removing the comments for V234938383", "committedDate": "2020-11-09T20:06:14Z", "type": "commit"}, {"oid": "f016a64a4f8af1aca3b9d6dba595f6d38ac0df32", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f016a64a4f8af1aca3b9d6dba595f6d38ac0df32", "message": "Merge branch 'master' into AuthHandlerFix", "committedDate": "2020-11-09T21:45:20Z", "type": "commit"}, {"oid": "ea98ea7aca6163b6b2bc4c508c017569381ff178", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ea98ea7aca6163b6b2bc4c508c017569381ff178", "message": "Adding MQTT and PubSub components with their respective operations in the AuthorizationHandler", "committedDate": "2020-11-10T07:16:19Z", "type": "commit"}, {"oid": "5b1d53a5b6c707fbfc64cf55fb6a9523388c54e0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b1d53a5b6c707fbfc64cf55fb6a9523388c54e0", "message": "Fixing the build and adding Unit Test for ad operations", "committedDate": "2020-11-10T21:19:19Z", "type": "commit"}, {"oid": "fc8f6e60929857b7d1bfbc83fa8ccbcc856cbab6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fc8f6e60929857b7d1bfbc83fa8ccbcc856cbab6", "message": "Merge branch 'master' into AuthHandlerFix", "committedDate": "2020-11-11T00:43:01Z", "type": "commit"}, {"oid": "2f8f0505cb283f837fe24e27522267c6bbf78296", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2f8f0505cb283f837fe24e27522267c6bbf78296", "message": "Merge remote-tracking branch 'origin/master' into AuthHandlerFix", "committedDate": "2020-11-11T01:24:27Z", "type": "commit"}, {"oid": "13ba1d0bfa16ea22e9a02d11dfd1dc6ff256f677", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13ba1d0bfa16ea22e9a02d11dfd1dc6ff256f677", "message": "Adding the * as operation and fixing the Unit Test", "committedDate": "2020-11-11T17:53:56Z", "type": "commit"}, {"oid": "bb03f6dcec2923c2b66ff170e3b34a1871632f9b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bb03f6dcec2923c2b66ff170e3b34a1871632f9b", "message": "Fixing the build", "committedDate": "2020-11-11T19:06:32Z", "type": "commit"}, {"oid": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/43dde1143dcd0a81fe8d7a55a13aa21fdf725079", "message": "Merge remote-tracking branch 'origin/master' into AuthHandlerFix", "committedDate": "2020-11-11T19:23:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5ODcwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r521598705", "bodyText": "why was this section removed?", "author": "avipinku", "createdAt": "2020-11-11T19:48:02Z", "path": "src/test/java/com/aws/greengrass/authorization/AuthorizationHandlerTest.java", "diffHunk": "@@ -456,15 +464,6 @@ void GIVEN_authZ_handler_WHEN_loaded_incorrect_config_THEN_load_fails(ExtensionC\n                 Collections.singletonList(getAuthZPolicy()), false);\n         assertTrue(logReceived.await(5, TimeUnit.SECONDS));\n \n-        // Now let the mock return mock topics", "originalCommit": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYyMTM1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r521621357", "bodyText": "Seems like this section was outdated with respect to the current code loadAuthorizationPolicies no longer returns an exception", "author": "k-khatri", "createdAt": "2020-11-11T20:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5ODcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5ODc1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r521598756", "bodyText": "nit: we should move these into another method in the same way that we have componentNameToPolicies.putAll(getDefaultPolicies());", "author": "avipinku", "createdAt": "2020-11-11T19:48:08Z", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -69,10 +76,15 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n                                 AuthorizationPolicyParser policyParser) {\n         this.kernel = kernel;\n         this.authModule = authModule;\n+        // Adding TES component and operation before it's default policies are fetched\n+        componentToOperationsMap.put(TOKEN_EXCHANGE_SERVICE_TOPICS, new HashSet<>(Arrays.asList(AUTHZ_TES_OPERATION)));", "originalCommit": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYyMTY1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r521621658", "bodyText": "May be will add this in next PR, will skip for this one", "author": "k-khatri", "createdAt": "2020-11-11T20:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5ODc1Ng=="}], "type": "inlineReview"}, {"oid": "9eac287460c85c0d5624473f59946633fb5748ef", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9eac287460c85c0d5624473f59946633fb5748ef", "message": "Merge remote-tracking branch 'origin/master' into AuthHandlerFix", "committedDate": "2020-11-11T22:34:37Z", "type": "commit"}, {"oid": "373c36b4b8edc69758b7d48bffdec14195d55432", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/373c36b4b8edc69758b7d48bffdec14195d55432", "message": "Merge branch 'master' into AuthHandlerFix", "committedDate": "2020-11-11T23:04:10Z", "type": "commit"}]}