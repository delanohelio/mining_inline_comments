{"pr_number": 132, "pr_title": "Updated dependency resolver to handle pakage removes scenario.", "pr_createdAt": "2020-03-24T20:49:09Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132", "timeline": [{"oid": "0095f197dfdbcf41c41fc96b1ba6596d8565eb89", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0095f197dfdbcf41c41fc96b1ba6596d8565eb89", "message": "changes to resolve dependecy when when packages are removed", "committedDate": "2020-03-24T19:44:24Z", "type": "commit"}, {"oid": "15416cae7e0fc63883b2b2785a14c8454d07d6aa", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/15416cae7e0fc63883b2b2785a14c8454d07d6aa", "message": "removed commented code", "committedDate": "2020-03-24T20:40:24Z", "type": "commit"}, {"oid": "aa495ad20b03f228b7b65dda95c68cb8fdd3876d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aa495ad20b03f228b7b65dda95c68cb8fdd3876d", "message": "updated comments for the test", "committedDate": "2020-03-24T20:48:17Z", "type": "commit"}, {"oid": "a1b1c822bdf792d18ffb8da04bb1bab9dc8b6259", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a1b1c822bdf792d18ffb8da04bb1bab9dc8b6259", "message": "added back the InterruptedException", "committedDate": "2020-03-24T21:12:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3Nzg1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397477852", "bodyText": "Why don't you just compile newRootPackages once and pass to both dependency resolver and config resolver? Or use rootPackagesToRemove consistently?", "author": "hui-yang", "createdAt": "2020-03-24T21:39:46Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -40,13 +44,28 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n         try {\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", document.getDeploymentId()).log(\"Start deployment task\");\n-            List<PackageIdentifier> desiredPackages = dependencyResolver.resolveDependencies(document);\n+\n+            // TODO: DA compute the root level packages to remove by looking across root level packages\n+            //  of all groups, when multi group support is added.\n+            Set<String> currentRootPackages = kernel.getMain().getDependencies().keySet().stream()\n+                    .filter((evergreenService) -> evergreenService instanceof GenericExternalService)\n+                    .map(EvergreenService::getName).collect(Collectors.toSet());\n+\n+            Set<String> rootPackagesToRemove = currentRootPackages.stream()\n+                    .filter(packageName -> !document.getRootPackages().contains(packageName))\n+                    .collect(Collectors.toSet());\n+\n+            List<PackageIdentifier> desiredPackages = dependencyResolver\n+                    .resolveDependencies(document, rootPackagesToRemove);", "originalCommit": "a1b1c822bdf792d18ffb8da04bb1bab9dc8b6259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxNjAzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397516032", "bodyText": "It's also not clear to me how default services will be handled. IMO it's noop in dependency resolution and parameter resolution, but they need to be included in the final dependency map.", "author": "hui-yang", "createdAt": "2020-03-24T23:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3Nzg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxNjk1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397516953", "bodyText": "Could you also update the benchmark test here? https://github.com/aws/aws-greengrass-kernel/blob/master/src/test/evergreen-kernel-benchmark/src/main/java/com/aws/iot/evergreen/jmh/packagemanager/DependencyResolverBenchmark.java#L72 The benchmark does not need to test the removal case, so it should be straightforward to just update the existing function call.", "author": "hui-yang", "createdAt": "2020-03-24T23:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3Nzg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyMDI2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397520267", "bodyText": "default dependencies are added as mains dependencies in kernel config resolver.", "author": "fahadmohammed01", "createdAt": "2020-03-24T23:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3Nzg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NzI1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397567259", "bodyText": "update: newRootPackages is used for both dependency resolver and config resolver", "author": "fahadmohammed01", "createdAt": "2020-03-25T02:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3Nzg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA2NjUzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398066530", "bodyText": "Updated benchmark tests.", "author": "fahadmohammed01", "createdAt": "2020-03-25T18:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3Nzg1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3OTc1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397479757", "bodyText": "Doesn't this drop the original Service state value in the map?", "author": "hui-yang", "createdAt": "2020-03-24T21:43:20Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -135,19 +135,19 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n \n \n     /*\n-     * Recompute main service dependencies for deployment.\n+     * Compute the config for main service\n      */\n-    private Map<Object, Object> getUpdatedMainConfig(Set<PackageIdentifier> rootPackagesToRemove,\n-                                                     DeploymentDocument document) {\n-        Set<String> kernelDependencies =\n-                kernel.getMain().getDependencies().keySet().stream().map(EvergreenService::getName)\n-                        .collect(Collectors.toSet());\n-        kernelDependencies\n-                .removeAll(rootPackagesToRemove.stream().map(PackageIdentifier::getName).collect(Collectors.toSet()));\n-        kernelDependencies.addAll(document.getRootPackages());\n-        Map<Object, Object> mainLifecycleMap = new HashMap<>();\n-        mainLifecycleMap.put(SERVICE_DEPENDENCIES_CONFIG_KEY, new ArrayList<>(kernelDependencies));\n-        return mainLifecycleMap;\n+    private Map<Object, Object> getMainConfig(Set<String> rootPackages) {\n+\n+        Map<Object, Object> mainServiceConfig = new HashMap<>();\n+        ArrayList<String> mainDependencies = new ArrayList<>(rootPackages);\n+        kernel.getMain().getDependencies().keySet().forEach(evergreenService -> {\n+            if (!(evergreenService instanceof GenericExternalService)) {\n+                mainDependencies.add(evergreenService.getName());", "originalCommit": "a1b1c822bdf792d18ffb8da04bb1bab9dc8b6259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NzU4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397567583", "bodyText": "No, there is no remove here", "author": "fahadmohammed01", "createdAt": "2020-03-25T02:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3OTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3MzE1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397573159", "bodyText": "I think what Hui is trying to point out is that since service dependencies actually are maintained in as a list of DependencyServiceName::RequiredDependencyState, you end up losing information about the required state for main service dependencies. That would apply to the earlier implementation as well but earlier it was easy to retain that information than it would be now if we were to make an incremental change to pass state information for dependencies", "author": "shaguptashaikh", "createdAt": "2020-03-25T02:23:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3OTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NjQzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398076433", "bodyText": "If you wait for Shirley's change then you can have access to richer information about the dependency (like if it is a default dependency) which is what you really need in this case.", "author": "MikeDombo", "createdAt": "2020-03-25T18:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3OTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA5NDczOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398094739", "bodyText": "Yes, we need to make another pass in dependency resolution to handle default services. I will add a sim task for this", "author": "fahadmohammed01", "createdAt": "2020-03-25T18:54:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3OTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEwMjQxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398102418", "bodyText": "Could you clarify where you mean to have the state handled? in dependency resolver or config resolver, as part of that next pass?", "author": "shaguptashaikh", "createdAt": "2020-03-25T19:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3OTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MTE0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397481149", "bodyText": "Why is this test case removed? Is the scenario tested elsewhere?", "author": "hui-yang", "createdAt": "2020-03-24T21:46:23Z", "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -155,50 +152,6 @@ public void GIVEN_deployment_for_existing_package_WHEN_config_resolution_request\n                    dependencyListContains(\"main\", TEST_INPUT_PACKAGE_A, servicesConfig));\n     }\n \n-    @Test\n-    public void GIVEN_deployment_removes_root_package_WHEN_config_resolution_requested_THEN_remove_service()", "originalCommit": "a1b1c822bdf792d18ffb8da04bb1bab9dc8b6259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyMTI5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397521293", "bodyText": "Yes, removed to GIVEN_active_packages_WHEN_merge_in_packages_THEN_add_or_update_or_keep_or_delete_accordingly test in dependency resolver.", "author": "fahadmohammed01", "createdAt": "2020-03-24T23:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MTE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTc0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397541748", "bodyText": "They one you mentioned is a unit test for a different component. I would rather be verbose here and have one test case for ConfigResolver as well.", "author": "hui-yang", "createdAt": "2020-03-25T00:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MTE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NzkxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397567918", "bodyText": "The remove functionality  was moved from ConfigResolver to dependency resolver. Hence the test case got moved to dependency resolver.", "author": "fahadmohammed01", "createdAt": "2020-03-25T02:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MTE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MzgyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397493829", "bodyText": "These assertions won't work well when they fail. Use the hamcrest matchers, like equals or contains to make these work better.", "author": "MikeDombo", "createdAt": "2020-03-24T22:13:48Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -160,6 +165,49 @@ void GIVEN_services_running_WHEN_updated_params_THEN_services_start_with_updated\n         Log4jLogEventBuilder.removeGlobalListener(listener);\n     }\n \n+    /**\n+     * First deployment contains packages yellow and customerApp\n+     * Second deployment updates the root packages to yellow and red. Red is added, customerApp is removed\n+     * and no update for yellow\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    @Order(3)\n+    void GIVEN_services_running_WHEN_service_added_and_deleted_THEN_add_remove_service_accordingly()\n+            throws Exception {\n+\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"CustomerAppAndYellowSignal.json\").toURI(), System.currentTimeMillis());\n+        result.get();\n+        List<String> services = kernel.orderedDependencies().stream()\n+                .filter(evergreenService -> evergreenService instanceof GenericExternalService)\n+                .map(evergreenService -> evergreenService.getName()).collect(Collectors.toList());\n+\n+        assertThat(\"Only contain main, YellowSignal, CustomerApp, Mosquitto and GreenSignal\", services.size() == 5);", "originalCommit": "a1b1c822bdf792d18ffb8da04bb1bab9dc8b6259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3MzYyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397573624", "bodyText": "Updated", "author": "fahadmohammed01", "createdAt": "2020-03-25T02:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MzgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3MDA1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397470055", "bodyText": "Nit you could combine these two, if not then move the TODO from line 48 to line 53", "author": "shaguptashaikh", "createdAt": "2020-03-24T21:24:09Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -40,13 +44,28 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n         try {\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", document.getDeploymentId()).log(\"Start deployment task\");\n-            List<PackageIdentifier> desiredPackages = dependencyResolver.resolveDependencies(document);\n+\n+            // TODO: DA compute the root level packages to remove by looking across root level packages\n+            //  of all groups, when multi group support is added.\n+            Set<String> currentRootPackages = kernel.getMain().getDependencies().keySet().stream()\n+                    .filter((evergreenService) -> evergreenService instanceof GenericExternalService)\n+                    .map(EvergreenService::getName).collect(Collectors.toSet());\n+\n+            Set<String> rootPackagesToRemove = currentRootPackages.stream()\n+                    .filter(packageName -> !document.getRootPackages().contains(packageName))\n+                    .collect(Collectors.toSet());", "originalCommit": "a1b1c822bdf792d18ffb8da04bb1bab9dc8b6259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2ODE5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397568190", "bodyText": "This section got refactored for the change \"newRootPackages is used for both dependency resolver and config resolver\".", "author": "fahadmohammed01", "createdAt": "2020-03-25T02:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3MDA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3MTk4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397471980", "bodyText": "You've moved the business logic that this test tests to DependencyResolver class, shouldn't there be a corresponding test added to DependencyResolverTest as well?", "author": "shaguptashaikh", "createdAt": "2020-03-24T21:27:57Z", "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -155,50 +152,6 @@ public void GIVEN_deployment_for_existing_package_WHEN_config_resolution_request\n                    dependencyListContains(\"main\", TEST_INPUT_PACKAGE_A, servicesConfig));\n     }\n \n-    @Test\n-    public void GIVEN_deployment_removes_root_package_WHEN_config_resolution_requested_THEN_remove_service()\n-            throws Exception {", "originalCommit": "a1b1c822bdf792d18ffb8da04bb1bab9dc8b6259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyMTM5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397521396", "bodyText": "Yes, removed to GIVEN_active_packages_WHEN_merge_in_packages_THEN_add_or_update_or_keep_or_delete_accordingly test in dependency resolver.", "author": "fahadmohammed01", "createdAt": "2020-03-24T23:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3MTk4MA=="}], "type": "inlineReview"}, {"oid": "b17333ca2d3328157b5378f97be9f77641efc1c9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b17333ca2d3328157b5378f97be9f77641efc1c9", "message": "addressed minor comments in PR", "committedDate": "2020-03-25T01:59:51Z", "type": "commit"}, {"oid": "d6c7d36471a3a7247b491e72ebba96e161443fc7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d6c7d36471a3a7247b491e72ebba96e161443fc7", "message": "addressed pr comment", "committedDate": "2020-03-25T02:08:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2OTg2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397569861", "bodyText": "Is there a better name for this than newRootPackages? with you latest change, newRootPackages sounds a little ambiguous, for instance the first thing that comes to my mind is 'this must be any new top level packages the deployment is trying to add'", "author": "shaguptashaikh", "createdAt": "2020-03-25T02:11:02Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -40,13 +45,18 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n         try {\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", document.getDeploymentId()).log(\"Start deployment task\");\n-            List<PackageIdentifier> desiredPackages = dependencyResolver.resolveDependencies(document);\n+\n+            // TODO: DA compute the root level packages by looking across root level packages\n+            //  of all groups, when multi group support is added.\n+            List<String> newRootPackages = new ArrayList<>(document.getRootPackages());", "originalCommit": "b17333ca2d3328157b5378f97be9f77641efc1c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3OTIyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397579222", "bodyText": "Agree, any suggestions?", "author": "fahadmohammed01", "createdAt": "2020-03-25T02:47:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2OTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwNDIzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397604231", "bodyText": "renamed to rootPackages and updated the comment.", "author": "fahadmohammed01", "createdAt": "2020-03-25T04:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2OTg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3MTY3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397571671", "bodyText": "Nit- With your latest change, maybe getServiceVersion method doesn't need to return optional anymore", "author": "shaguptashaikh", "createdAt": "2020-03-25T02:17:38Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/DependencyResolver.java", "diffHunk": "@@ -301,28 +303,24 @@ protected String mergeSemverRequirements(final Collection<String> packageVersion\n         return getServiceVersion(service);\n     }\n \n-    private void mergeActiveRootPackages(Set<String> rootPackages,\n-                                    Map<String, Map<String, String>> packageNameToVersionConstraints) {\n-        Set<EvergreenService> activeServices = kernel.getMain().getDependencies().keySet();\n-        for (EvergreenService s: activeServices) {\n-            Optional<String> version = getServiceVersion(s);\n-            if (!version.isPresent()) {\n-                // Assume 1P services if version is not present. 1P services don't need resolution\n-                continue;\n-            }\n+    private void mergeActiveRootPackages(Set<String> rootPackagesToResolve, DeploymentDocument document,\n+                                         Map<String, Map<String, String>> packageNameToVersionConstraints) {\n \n-            String serviceName = s.getName();\n-            if (!rootPackages.contains(serviceName)) {\n-                // If the service package does not exist in root packages, still use the current version on the device\n-                rootPackages.add(serviceName);\n+        Set<EvergreenService> activeServices = kernel.getMain().getDependencies().keySet();\n+        for (EvergreenService evergreenService : activeServices) {\n+            String serviceName = evergreenService.getName();\n+            // add version constraints for package not in deployment document but is active in device\n+            if (rootPackagesToResolve.contains(serviceName) && !document.getRootPackages().contains(serviceName)) {\n+                String version = getServiceVersion(evergreenService).get();", "originalCommit": "b17333ca2d3328157b5378f97be9f77641efc1c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwMDM0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r397600348", "bodyText": "getPackageVersionIfActive also depends on getServiceVersion. Keeping the contract same for now.", "author": "fahadmohammed01", "createdAt": "2020-03-25T04:14:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3MTY3MQ=="}], "type": "inlineReview"}, {"oid": "535de3660d216dab8a83ac15688c8cf91ec6242e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/535de3660d216dab8a83ac15688c8cf91ec6242e", "message": "updated variable names", "committedDate": "2020-03-25T04:31:28Z", "type": "commit"}, {"oid": "1679cb823d36807356e55d9b81b6c5580fd45b76", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1679cb823d36807356e55d9b81b6c5580fd45b76", "message": "changes to resolve dependecy when when packages are removed", "committedDate": "2020-03-25T05:37:12Z", "type": "commit"}, {"oid": "9fd79cab2c2d061f4e61dce4f44ab005b5a0abe1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9fd79cab2c2d061f4e61dce4f44ab005b5a0abe1", "message": "removed commented code", "committedDate": "2020-03-25T05:37:12Z", "type": "commit"}, {"oid": "37e6b50fb57714c82557e5110246f7adb5822a0a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/37e6b50fb57714c82557e5110246f7adb5822a0a", "message": "updated comments for the test", "committedDate": "2020-03-25T05:37:12Z", "type": "commit"}, {"oid": "cba1076e155ed7b4ae94a34756eca582fb713715", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cba1076e155ed7b4ae94a34756eca582fb713715", "message": "added back the InterruptedException", "committedDate": "2020-03-25T05:37:12Z", "type": "commit"}, {"oid": "f44a78327fdea96f42beda1c2d0b910f7673fd95", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f44a78327fdea96f42beda1c2d0b910f7673fd95", "message": "addressed minor comments in PR", "committedDate": "2020-03-25T05:37:12Z", "type": "commit"}, {"oid": "415f955e21757b60d845505642f9965fd79eead8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/415f955e21757b60d845505642f9965fd79eead8", "message": "addressed pr comment", "committedDate": "2020-03-25T05:37:12Z", "type": "commit"}, {"oid": "4fe2536bbb01af20d1dbbddf5cf31732fe05971e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4fe2536bbb01af20d1dbbddf5cf31732fe05971e", "message": "updated variable names", "committedDate": "2020-03-25T05:37:12Z", "type": "commit"}, {"oid": "79d079da8fa10a6a622a7cfb7ae415886cb568b9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/79d079da8fa10a6a622a7cfb7ae415886cb568b9", "message": "updated  benchmark tests", "committedDate": "2020-03-25T17:02:01Z", "type": "commit"}, {"oid": "5a05d8eb20b8c47eb5de6f538c69cc63ee084bf0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5a05d8eb20b8c47eb5de6f538c69cc63ee084bf0", "message": "Merge branch 'remove-services-in-da' of github.com:aws/aws-greengrass-kernel into remove-services-in-da", "committedDate": "2020-03-25T17:02:19Z", "type": "commit"}, {"oid": "02925cd591c60588908e4ba64f5c829d6e6fb439", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02925cd591c60588908e4ba64f5c829d6e6fb439", "message": "Merge branch 'master' into remove-services-in-da", "committedDate": "2020-03-25T17:36:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NDA2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398074066", "bodyText": "Is this a future that you are geting? If so, we need to be careful about blocking calls like this with no timeout.", "author": "MikeDombo", "createdAt": "2020-03-25T18:21:31Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/DependencyResolver.java", "diffHunk": "@@ -302,28 +304,24 @@ protected String mergeSemverRequirements(final Collection<String> packageVersion\n         return getServiceVersion(service);\n     }\n \n-    private void mergeActiveRootPackages(Set<String> rootPackages,\n-                                    Map<String, Map<String, String>> packageNameToVersionConstraints) {\n-        Set<EvergreenService> activeServices = kernel.getMain().getDependencies().keySet();\n-        for (EvergreenService s: activeServices) {\n-            Optional<String> version = getServiceVersion(s);\n-            if (!version.isPresent()) {\n-                // Assume 1P services if version is not present. 1P services don't need resolution\n-                continue;\n-            }\n+    private void mergeActiveRootPackages(Set<String> rootPackagesToResolve, DeploymentDocument document,\n+                                         Map<String, Map<String, String>> packageNameToVersionConstraints) {\n \n-            String serviceName = s.getName();\n-            if (!rootPackages.contains(serviceName)) {\n-                // If the service package does not exist in root packages, still use the current version on the device\n-                rootPackages.add(serviceName);\n+        Set<EvergreenService> activeServices = kernel.getMain().getDependencies().keySet();\n+        for (EvergreenService evergreenService : activeServices) {\n+            String serviceName = evergreenService.getName();\n+            // add version constraints for package not in deployment document but is active in device\n+            if (rootPackagesToResolve.contains(serviceName) && !document.getRootPackages().contains(serviceName)) {\n+                String version = getServiceVersion(evergreenService).get();", "originalCommit": "02925cd591c60588908e4ba64f5c829d6e6fb439", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA4MDg3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398080872", "bodyText": "We are getting an optional, but under the circumstances that we are calling it, the optional will not be empty.", "author": "fahadmohammed01", "createdAt": "2020-03-25T18:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NDA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NTE0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398075146", "bodyText": "Why list vs set? If we don't need anything specific, how about just a Collection or even Iterable?", "author": "MikeDombo", "createdAt": "2020-03-25T18:23:13Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -44,20 +45,19 @@\n      * transform it to a kernel config key-value pair.\n      *\n      * @param packagesToDeploy     package identifiers for resolved packages that are to be deployed\n-     * @param document             deployment document\n-     * @param rootPackagesToRemove top level packages that need to be removed as part of current deployment\n+     * @param document      deployment document\n+     * @param rootPackages  root level packages\n      * @return a kernel config map\n      * @throws InterruptedException when the running thread is interrupted\n      */\n     public Map<Object, Object> resolve(List<PackageIdentifier> packagesToDeploy, DeploymentDocument document,\n-                                       Set<PackageIdentifier> rootPackagesToRemove) throws InterruptedException {\n+                                       List<String> rootPackages) throws InterruptedException {", "originalCommit": "02925cd591c60588908e4ba64f5c829d6e6fb439", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA4NDEwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398084108", "bodyText": "There is no difference between using set or list for rootPackages. We already compute the rootPackages as a list, so I changes the signature from set to list.", "author": "fahadmohammed01", "createdAt": "2020-03-25T18:37:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NTE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NzI3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398077279", "bodyText": "For all these, if there are no root packages, why is it resolving anything? That seems incorrect.", "author": "MikeDombo", "createdAt": "2020-03-25T18:26:39Z", "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentTaskTest.java", "diffHunk": "@@ -107,24 +113,24 @@ public void GIVEN_deploymentDocument_WHEN_preparePackages_interrupted_THEN_deplo\n         t.interrupt();\n         Exception thrown = assertThrows(ExecutionException.class, () -> futureTask.get());\n         assertThat(thrown.getCause(), isA(RetryableDeploymentTaskFailureException.class));\n-        verify(mockDependencyResolver).resolveDependencies(deploymentDocument);\n+        verify(mockDependencyResolver).resolveDependencies(deploymentDocument, Collections.EMPTY_LIST);\n         verify(mockPackageCache).preparePackages(anyList());\n-        verify(mockKernelConfigResolver, times(0)).resolve(anyList(), eq(deploymentDocument), anySet());\n+        verify(mockKernelConfigResolver, times(0)).resolve(anyList(), eq(deploymentDocument), anyList());\n         verify(mockKernel, times(0)).mergeInNewConfig(eq(\"TestDeployment\"), anyLong(), anyMap());\n     }\n \n     @Test\n     public void GIVEN_deploymentDocument_WHEN_resolve_kernel_config_interrupted_THEN_deploymentTask_aborted()\n             throws Exception {\n         when(mockPackageCache.preparePackages(anyList())).thenReturn(CompletableFuture.completedFuture(null));\n-        when(mockKernelConfigResolver.resolve(anyList(), eq(deploymentDocument), anySet()))\n+        when(mockKernelConfigResolver.resolve(anyList(), eq(deploymentDocument), anyList()))\n                 .thenThrow(new InterruptedException());\n \n         Exception thrown = assertThrows(RetryableDeploymentTaskFailureException.class, () -> deploymentTask.call());\n         assertThat(thrown.getCause(), isA(InterruptedException.class));\n-        verify(mockDependencyResolver).resolveDependencies(deploymentDocument);\n+        verify(mockDependencyResolver).resolveDependencies(deploymentDocument, Collections.EMPTY_LIST);", "originalCommit": "02925cd591c60588908e4ba64f5c829d6e6fb439", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA4NjQxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398086411", "bodyText": "DeploymentTaskTest do not verify how the resolution works, that is done in DependecyResolverTests. DeploymentTaskTest verifies if deployment task is aborted under various scenarios like:\nGIVEN_deploymentDocument_WHEN_resolveDependencies_with_conflicted_dependency_THEN_deploymentTask_aborted()\nGIVEN_deploymentDocument_WHEN_resolveDependencies_errored_THEN_deploymentTask_aborted()", "author": "fahadmohammed01", "createdAt": "2020-03-25T18:41:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NzI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA5MDQ0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398090448", "bodyText": "+1. A real situation should be that rootPackages is a superset of those in deploymentDocument", "author": "hui-yang", "createdAt": "2020-03-25T18:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NzI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODExMDk0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398110947", "bodyText": "The super set scenerio is tested in dependecyresolvertest GIVEN_active_packages_WHEN_merge_in_packages_THEN_add_or_update_or_keep_or_delete_accordingly", "author": "fahadmohammed01", "createdAt": "2020-03-25T19:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NzI3OQ=="}], "type": "inlineReview"}, {"oid": "a91e1f69730e429f9378592271efd16170e90342", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a91e1f69730e429f9378592271efd16170e90342", "message": "addressing minor PR comments", "committedDate": "2020-03-25T19:31:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODExODEzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398118133", "bodyText": "Instead of scanning all the active services in kernel, why don't we just check what package in rootPackagesToResolve doesn't have a pinned version in packageNameToVersionConstraints, and directly find out the package version?\nWe don't need document here at all.", "author": "hui-yang", "createdAt": "2020-03-25T19:34:51Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/DependencyResolver.java", "diffHunk": "@@ -302,28 +304,24 @@ protected String mergeSemverRequirements(final Collection<String> packageVersion\n         return getServiceVersion(service);\n     }\n \n-    private void mergeActiveRootPackages(Set<String> rootPackages,\n-                                    Map<String, Map<String, String>> packageNameToVersionConstraints) {\n-        Set<EvergreenService> activeServices = kernel.getMain().getDependencies().keySet();\n-        for (EvergreenService s: activeServices) {\n-            Optional<String> version = getServiceVersion(s);\n-            if (!version.isPresent()) {\n-                // Assume 1P services if version is not present. 1P services don't need resolution\n-                continue;\n-            }\n+    private void mergeActiveRootPackages(Set<String> rootPackagesToResolve, DeploymentDocument document,\n+                                         Map<String, Map<String, String>> packageNameToVersionConstraints) {\n \n-            String serviceName = s.getName();\n-            if (!rootPackages.contains(serviceName)) {\n-                // If the service package does not exist in root packages, still use the current version on the device\n-                rootPackages.add(serviceName);\n+        Set<EvergreenService> activeServices = kernel.getMain().getDependencies().keySet();", "originalCommit": "a91e1f69730e429f9378592271efd16170e90342", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE1Mjk4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398152981", "bodyText": "Synced offline, removed document.", "author": "fahadmohammed01", "createdAt": "2020-03-25T20:37:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODExODEzMw=="}], "type": "inlineReview"}, {"oid": "d9d0d2a87333627a292e755d63fa13f34778f622", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d9d0d2a87333627a292e755d63fa13f34778f622", "message": "minor comments from PR", "committedDate": "2020-03-25T20:36:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE1NTk2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/132#discussion_r398155961", "bodyText": "nit: .containsKey()", "author": "hui-yang", "createdAt": "2020-03-25T20:42:40Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/DependencyResolver.java", "diffHunk": "@@ -304,14 +304,15 @@ protected String mergeSemverRequirements(final Collection<String> packageVersion\n         return getServiceVersion(service);\n     }\n \n-    private void mergeActiveRootPackages(Set<String> rootPackagesToResolve, DeploymentDocument document,\n+    private void mergeActiveRootPackages(Set<String> rootPackagesToResolve,\n                                          Map<String, Map<String, String>> packageNameToVersionConstraints) {\n \n         Set<EvergreenService> activeServices = kernel.getMain().getDependencies().keySet();\n         for (EvergreenService evergreenService : activeServices) {\n             String serviceName = evergreenService.getName();\n             // add version constraints for package not in deployment document but is active in device\n-            if (rootPackagesToResolve.contains(serviceName) && !document.getRootPackages().contains(serviceName)) {\n+            if (rootPackagesToResolve.contains(serviceName)\n+                    && !packageNameToVersionConstraints.keySet().contains(serviceName)) {", "originalCommit": "d9d0d2a87333627a292e755d63fa13f34778f622", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}