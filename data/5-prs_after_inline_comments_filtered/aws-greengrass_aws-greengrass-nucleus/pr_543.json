{"pr_number": 543, "pr_title": "Moonraker integration", "pr_createdAt": "2020-10-19T16:28:46Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NDM1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507894351", "bodyText": "needs proxy support too", "author": "MikeDombo", "createdAt": "2020-10-19T16:36:08Z", "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -34,36 +51,104 @@\n      *\n      * @param greengrassServiceEndpoint String containing service endpoint\n      * @param deviceConfiguration       Device configuration\n-     * @param credentialsProvider       AWS Credentials provider for device credentials\n      */\n     @Inject\n     public GreengrassComponentServiceClientFactory(\n             @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration,\n-            LazyCredentialProvider credentialsProvider) {\n+            DeviceConfiguration deviceConfiguration) {\n+\n+        ClientConfiguration clientConfiguration = ProxyUtils.getClientConfiguration();\n+        try {\n+            configureClientMutualTLS(clientConfiguration, deviceConfiguration);\n+        } catch (TLSAuthException e) {\n+            logger.atWarn(\"configure-greengrass-mutual-auth\")\n+                    .log(\"Error during configure greengrass client mutual auth\", e);\n+        }\n         AWSEvergreenClientBuilder clientBuilder =\n-                AWSEvergreenClientBuilder.standard().withClientConfiguration(ProxyUtils.getClientConfiguration());\n+                AWSEvergreenClientBuilder.standard().withClientConfiguration(clientConfiguration);", "originalCommit": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNTU1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507905551", "bodyText": "I keep ProxyUtils.getClientConfiguration() above. What else do I need to do here to support proxy?", "author": "wikimonkey", "createdAt": "2020-10-19T16:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NDM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwODMxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507908317", "bodyText": "OK, I see now", "author": "MikeDombo", "createdAt": "2020-10-19T16:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NDM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTEwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507895104", "bodyText": "can we just have a null password? or empty array", "author": "MikeDombo", "createdAt": "2020-10-19T16:37:24Z", "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -34,36 +51,104 @@\n      *\n      * @param greengrassServiceEndpoint String containing service endpoint\n      * @param deviceConfiguration       Device configuration\n-     * @param credentialsProvider       AWS Credentials provider for device credentials\n      */\n     @Inject\n     public GreengrassComponentServiceClientFactory(\n             @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration,\n-            LazyCredentialProvider credentialsProvider) {\n+            DeviceConfiguration deviceConfiguration) {\n+\n+        ClientConfiguration clientConfiguration = ProxyUtils.getClientConfiguration();\n+        try {\n+            configureClientMutualTLS(clientConfiguration, deviceConfiguration);\n+        } catch (TLSAuthException e) {\n+            logger.atWarn(\"configure-greengrass-mutual-auth\")\n+                    .log(\"Error during configure greengrass client mutual auth\", e);\n+        }\n         AWSEvergreenClientBuilder clientBuilder =\n-                AWSEvergreenClientBuilder.standard().withClientConfiguration(ProxyUtils.getClientConfiguration());\n+                AWSEvergreenClientBuilder.standard().withClientConfiguration(clientConfiguration);\n         String region = Coerce.toString(deviceConfiguration.getAWSRegion());\n \n         if (!Utils.isEmpty(region)) {\n             if (!Utils.isEmpty(greengrassServiceEndpoint)) {\n                 // Region and endpoint are both required when updating endpoint config\n-                logger.atInfo(\"initialize-cms-client\").addKeyValue(\"service-endpoint\", greengrassServiceEndpoint)\n+                logger.atInfo(\"initialize-greengrass-client\").addKeyValue(\"service-endpoint\", greengrassServiceEndpoint)\n                         .addKeyValue(\"service-region\", region).log();\n                 EndpointConfiguration endpointConfiguration =\n                         new EndpointConfiguration(greengrassServiceEndpoint, region);\n                 clientBuilder.withEndpointConfiguration(endpointConfiguration);\n             } else {\n                 // This section is to override default region if needed\n-                logger.atInfo(\"initialize-cms-client\").addKeyValue(\"service-region\", region).log();\n+                logger.atInfo(\"initialize-greengrass-client\").addKeyValue(\"service-region\", region).log();\n                 clientBuilder.withRegion(region);\n             }\n         }\n \n-        if (credentialsProvider != null) {\n-            clientBuilder.withCredentials(credentialsProvider);\n+        this.cmsClient = clientBuilder.build();\n+    }\n+\n+    private void configureClientMutualTLS(ClientConfiguration clientConfiguration,\n+                                          DeviceConfiguration deviceConfiguration) throws TLSAuthException {\n+        if (clientConfiguration == null) {\n+            return;\n+        }\n+        String certificatePath = Coerce.toString(deviceConfiguration.getCertificateFilePath());\n+        String privateKeyPath = Coerce.toString(deviceConfiguration.getPrivateKeyFilePath());\n+        String rootCAPath = Coerce.toString(deviceConfiguration.getRootCAFilePath());\n+        if (Utils.isEmpty(certificatePath) || Utils.isEmpty(privateKeyPath) || Utils.isEmpty(rootCAPath)) {\n+            return;\n+        }\n+\n+        TrustManager[] trustManagers = createTrustManagers(rootCAPath);\n+        KeyManager[] keyManagers = createKeyManagers(privateKeyPath, certificatePath);\n+        SSLContext sslContext = null;\n+        try {\n+            sslContext = SSLContext.getInstance(\"TLSv1.2\");\n+            sslContext.init(keyManagers, trustManagers, null);\n+        } catch (GeneralSecurityException e) {\n+            throw new TLSAuthException(\"Failed to initialize TLS context\", e);\n         }\n \n-        this.cmsClient = clientBuilder.build();\n+        SSLConnectionSocketFactory sslConnectionSocketFactory =\n+                new SSLConnectionSocketFactory(sslContext, NoopHostnameVerifier.INSTANCE);\n+        clientConfiguration.getApacheHttpClientConfig().setSslSocketFactory(sslConnectionSocketFactory);\n+    }\n+\n+    private TrustManager[] createTrustManagers(String rootCAPath) throws TLSAuthException {\n+        try {\n+            List<X509Certificate> trustCertificates = EncryptionUtils.loadX509Certificates(rootCAPath);\n+\n+            KeyStore tmKeyStore = KeyStore.getInstance(\"JKS\");\n+            tmKeyStore.load(null, null);\n+            for (X509Certificate certificate : trustCertificates) {\n+                X500Principal principal = certificate.getSubjectX500Principal();\n+                String name = principal.getName(\"RFC2253\");\n+                tmKeyStore.setCertificateEntry(name, certificate);\n+            }\n+            TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(\"X509\");\n+            trustManagerFactory.init(tmKeyStore);\n+            return trustManagerFactory.getTrustManagers();\n+        } catch (GeneralSecurityException | IOException e) {\n+            throw new TLSAuthException(\"Failed to get trust manager\", e);\n+        }\n+    }\n+\n+    private KeyManager[] createKeyManagers(String privateKeyPath, String certificatePath) throws TLSAuthException {\n+        try {\n+            List<X509Certificate> certificateChain = EncryptionUtils.loadX509Certificates(certificatePath);\n+\n+            PrivateKey privateKey = EncryptionUtils.loadPrivateKey(privateKeyPath);\n+\n+            KeyStore keyStore = KeyStore.getInstance(\"PKCS12\");\n+            keyStore.load(null);\n+            keyStore.setKeyEntry(\"private-key\", privateKey, \"password\".toCharArray(),", "originalCommit": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwOTU5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507909594", "bodyText": "If it's supposed to have private key, why do we need to support null password? Please clarify what you mean, thanks.", "author": "wikimonkey", "createdAt": "2020-10-19T16:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxMDk2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507910968", "bodyText": "you are setting a password called \"password\". Can we not do that?", "author": "MikeDombo", "createdAt": "2020-10-19T17:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyMTg2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507921866", "bodyText": "Got you. Sure, it can be changed.", "author": "wikimonkey", "createdAt": "2020-10-19T17:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTczMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507895732", "bodyText": "since we have this now, you should be able to remove greengrass permissions from the TES role that we create for customers (not the one we use in testing though)", "author": "MikeDombo", "createdAt": "2020-10-19T16:38:23Z", "path": "src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -154,7 +154,8 @@ public ThingInfo createThing(IotClient client, String policyName, String thingNa\n                     \"{\\n  \\\"Version\\\": \\\"2012-10-17\\\",\\n  \\\"Statement\\\": [\\n    {\\n\"\n                             + \"      \\\"Effect\\\": \\\"Allow\\\",\\n      \\\"Action\\\": [\\n\"\n                             + \"                \\\"iot:Connect\\\",\\n                \\\"iot:Publish\\\",\\n\"\n-                            + \"                \\\"iot:Subscribe\\\",\\n                \\\"iot:Receive\\\"\\n],\\n\"\n+                            + \"                \\\"iot:Subscribe\\\",\\n                \\\"iot:Receive\\\",\\n\"\n+                            + \"                \\\"greengrass:*\\\"\\n],\\n\"", "originalCommit": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNDY2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507904665", "bodyText": "Can you point me the location of TES permission? Thanks!", "author": "wikimonkey", "createdAt": "2020-10-19T16:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjQ1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507896450", "bodyText": "yikes. Link to where you got this from.", "author": "MikeDombo", "createdAt": "2020-10-19T16:39:28Z", "path": "src/main/java/com/aws/greengrass/util/EncryptionUtils.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.aws.greengrass.util;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyFactory;\n+import java.security.PrivateKey;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.security.spec.PKCS8EncodedKeySpec;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+public final class EncryptionUtils {\n+\n+    private static final String PKCS_1_PEM_HEADER = \"-----BEGIN RSA PRIVATE KEY-----\";\n+    private static final String PKCS_1_PEM_FOOTER = \"-----END RSA PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_HEADER = \"-----BEGIN PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_FOOTER = \"-----END PRIVATE KEY-----\";\n+\n+    private EncryptionUtils() {\n+    }\n+\n+    /**\n+     * Populate a list of X509 encryption certificate objects from the given file path.\n+     *\n+     * @param certificatePath certificate file path\n+     * @return a list of X590 certificate objects\n+     * @throws IOException          file IO error\n+     * @throws CertificateException can't populate certificates\n+     */\n+    public static List<X509Certificate> loadX509Certificates(String certificatePath)\n+            throws IOException, CertificateException {\n+        try (InputStream certificateInputStream = Files.newInputStream(Paths.get(certificatePath))) {\n+            CertificateFactory factory = CertificateFactory.getInstance(\"X.509\");\n+            return new ArrayList<>(\n+                    (Collection<? extends X509Certificate>) factory.generateCertificates(certificateInputStream));\n+        }\n+    }\n+\n+    /**\n+     * Load a RSA private key from the given file path.\n+     *\n+     * @param keyPath key file path\n+     * @return a RSA private key\n+     * @throws IOException              file IO error\n+     * @throws GeneralSecurityException can't load private key\n+     */\n+    public static PrivateKey loadPrivateKey(String keyPath) throws IOException, GeneralSecurityException {\n+        byte[] keyBytes = Files.readAllBytes(Paths.get(keyPath));\n+        String keyString = new String(keyBytes, StandardCharsets.UTF_8);\n+\n+        if (keyString.contains(PKCS_1_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_1_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_1_PEM_FOOTER, \"\");\n+            return readPkcs1PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        if (keyString.contains(PKCS_8_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_8_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_8_PEM_FOOTER, \"\");\n+            return readPkcs8PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        return readPkcs8PrivateKey(keyBytes);\n+    }\n+\n+    private static PrivateKey readPkcs8PrivateKey(byte[] pkcs8Bytes) throws GeneralSecurityException {\n+        KeyFactory keyFactory = KeyFactory.getInstance(\"RSA\");\n+        PKCS8EncodedKeySpec keySpec = new PKCS8EncodedKeySpec(pkcs8Bytes);\n+        return keyFactory.generatePrivate(keySpec);\n+    }\n+\n+    private static PrivateKey readPkcs1PrivateKey(byte[] pkcs1Bytes) throws GeneralSecurityException {\n+        // We can't use Java internal APIs to parse ASN.1 structures, so we build a PKCS#8 key Java can understand\n+        int pkcs1Length = pkcs1Bytes.length;\n+        int totalLength = pkcs1Length + 22;\n+        byte[] pkcs8Header = {0x30, (byte) 0x82, (byte) ((totalLength >> 8) & 0xff), (byte) (totalLength & 0xff),", "originalCommit": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwMzk0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507903943", "bodyText": "Here is the reference:\nhttps://github.com/Mastercard/client-encryption-java/blob/master/src/main/java/com/mastercard/developer/utils/EncryptionUtils.java#L95-L100\nIt basically changes pkcs1 to pkcs8. The other option is BouncyCastle PEM parser so we can avoid this hack. But it's ~800KB overhead.", "author": "wikimonkey", "createdAt": "2020-10-19T16:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNDY2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507904660", "bodyText": "Link it in the code so we have traceability.", "author": "MikeDombo", "createdAt": "2020-10-19T16:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxMDY1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507910652", "bodyText": "sure", "author": "wikimonkey", "createdAt": "2020-10-19T17:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjYwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507896600", "bodyText": "use bouncycastle instead?", "author": "MikeDombo", "createdAt": "2020-10-19T16:39:42Z", "path": "src/main/java/com/aws/greengrass/util/EncryptionUtils.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.aws.greengrass.util;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyFactory;\n+import java.security.PrivateKey;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.security.spec.PKCS8EncodedKeySpec;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+public final class EncryptionUtils {\n+\n+    private static final String PKCS_1_PEM_HEADER = \"-----BEGIN RSA PRIVATE KEY-----\";\n+    private static final String PKCS_1_PEM_FOOTER = \"-----END RSA PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_HEADER = \"-----BEGIN PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_FOOTER = \"-----END PRIVATE KEY-----\";\n+\n+    private EncryptionUtils() {\n+    }\n+\n+    /**\n+     * Populate a list of X509 encryption certificate objects from the given file path.\n+     *\n+     * @param certificatePath certificate file path\n+     * @return a list of X590 certificate objects\n+     * @throws IOException          file IO error\n+     * @throws CertificateException can't populate certificates\n+     */\n+    public static List<X509Certificate> loadX509Certificates(String certificatePath)\n+            throws IOException, CertificateException {\n+        try (InputStream certificateInputStream = Files.newInputStream(Paths.get(certificatePath))) {\n+            CertificateFactory factory = CertificateFactory.getInstance(\"X.509\");\n+            return new ArrayList<>(\n+                    (Collection<? extends X509Certificate>) factory.generateCertificates(certificateInputStream));\n+        }\n+    }\n+\n+    /**\n+     * Load a RSA private key from the given file path.\n+     *\n+     * @param keyPath key file path\n+     * @return a RSA private key\n+     * @throws IOException              file IO error\n+     * @throws GeneralSecurityException can't load private key\n+     */\n+    public static PrivateKey loadPrivateKey(String keyPath) throws IOException, GeneralSecurityException {\n+        byte[] keyBytes = Files.readAllBytes(Paths.get(keyPath));\n+        String keyString = new String(keyBytes, StandardCharsets.UTF_8);\n+\n+        if (keyString.contains(PKCS_1_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_1_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_1_PEM_FOOTER, \"\");\n+            return readPkcs1PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        if (keyString.contains(PKCS_8_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_8_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_8_PEM_FOOTER, \"\");\n+            return readPkcs8PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        return readPkcs8PrivateKey(keyBytes);\n+    }\n+\n+    private static PrivateKey readPkcs8PrivateKey(byte[] pkcs8Bytes) throws GeneralSecurityException {\n+        KeyFactory keyFactory = KeyFactory.getInstance(\"RSA\");\n+        PKCS8EncodedKeySpec keySpec = new PKCS8EncodedKeySpec(pkcs8Bytes);\n+        return keyFactory.generatePrivate(keySpec);\n+    }\n+\n+    private static PrivateKey readPkcs1PrivateKey(byte[] pkcs1Bytes) throws GeneralSecurityException {\n+        // We can't use Java internal APIs to parse ASN.1 structures, so we build a PKCS#8 key Java can understand", "originalCommit": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwMjcwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507902705", "bodyText": "bouncycastle is ~800KB\nhttps://mvnrepository.com/artifact/org.bouncycastle/bcpkix-jdk15on/1.66\nDo we want to have it?", "author": "wikimonkey", "createdAt": "2020-10-19T16:49:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNDI5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507904291", "bodyText": "Not for just these methods. Though DCM was going to use bouncycastle...", "author": "MikeDombo", "createdAt": "2020-10-19T16:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjYwMA=="}], "type": "inlineReview"}, {"oid": "988229682398e57107778b310c95fe552ab46d2f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/988229682398e57107778b310c95fe552ab46d2f", "message": "switch to use moonraker endpoint with mTLS", "committedDate": "2020-10-22T18:31:38Z", "type": "commit"}, {"oid": "b56f6d65cc9cef0ae456705530f56ecfbd05713e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b56f6d65cc9cef0ae456705530f56ecfbd05713e", "message": "fix integ tests", "committedDate": "2020-10-22T18:31:42Z", "type": "commit"}, {"oid": "22f7c35d4753196f8d7e45cbd77c596de0718fe2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/22f7c35d4753196f8d7e45cbd77c596de0718fe2", "message": "remove unused import", "committedDate": "2020-10-22T18:31:42Z", "type": "commit"}, {"oid": "929ea35959a6da1833c30e0304c7b487583fbd65", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/929ea35959a6da1833c30e0304c7b487583fbd65", "message": "clean unused stuff", "committedDate": "2020-10-22T18:32:35Z", "type": "commit"}, {"oid": "cf65ad1a714fb92d9c1a2c3637c101a5340c967a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cf65ad1a714fb92d9c1a2c3637c101a5340c967a", "message": "remove unused import", "committedDate": "2020-10-22T18:32:38Z", "type": "commit"}, {"oid": "4fe2c64841fc09c57bf0d234bd03e72130e9f99f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4fe2c64841fc09c57bf0d234bd03e72130e9f99f", "message": "add reference to pkcs1 pkcs8 conversion", "committedDate": "2020-10-22T18:32:38Z", "type": "commit"}, {"oid": "3541001eb9cef044b9139edaac2bdcf69a9f001c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3541001eb9cef044b9139edaac2bdcf69a9f001c", "message": "change to generate key and certificate in unit tests", "committedDate": "2020-10-22T18:33:08Z", "type": "commit"}, {"oid": "3541001eb9cef044b9139edaac2bdcf69a9f001c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3541001eb9cef044b9139edaac2bdcf69a9f001c", "message": "change to generate key and certificate in unit tests", "committedDate": "2020-10-22T18:33:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5MTU2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r510391564", "bodyText": "... I'd say if you didn't find this from Master Card, this is going to take days or weeks to implement. Great job...\nI assume this would be reliable as long as it works... But better to recheck with Device SDK's implementation - if we can find it.", "author": "leaf94", "createdAt": "2020-10-22T19:04:09Z", "path": "src/main/java/com/aws/greengrass/util/EncryptionUtils.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.aws.greengrass.util;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyFactory;\n+import java.security.PrivateKey;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.security.spec.PKCS8EncodedKeySpec;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+public final class EncryptionUtils {\n+\n+    private static final String PKCS_1_PEM_HEADER = \"-----BEGIN RSA PRIVATE KEY-----\";\n+    private static final String PKCS_1_PEM_FOOTER = \"-----END RSA PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_HEADER = \"-----BEGIN PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_FOOTER = \"-----END PRIVATE KEY-----\";\n+\n+    private EncryptionUtils() {\n+    }\n+\n+    /**\n+     * Populate a list of X509 encryption certificate objects from the given file path.\n+     *\n+     * @param certificatePath certificate file path\n+     * @return a list of X590 certificate objects\n+     * @throws IOException          file IO error\n+     * @throws CertificateException can't populate certificates\n+     */\n+    public static List<X509Certificate> loadX509Certificates(String certificatePath)\n+            throws IOException, CertificateException {\n+        try (InputStream certificateInputStream = Files.newInputStream(Paths.get(certificatePath))) {\n+            CertificateFactory factory = CertificateFactory.getInstance(\"X.509\");\n+            return new ArrayList<>(\n+                    (Collection<? extends X509Certificate>) factory.generateCertificates(certificateInputStream));\n+        }\n+    }\n+\n+    /**\n+     * Load a RSA private key from the given file path.\n+     *\n+     * @param keyPath key file path\n+     * @return a RSA private key\n+     * @throws IOException              file IO error\n+     * @throws GeneralSecurityException can't load private key\n+     */\n+    public static PrivateKey loadPrivateKey(String keyPath) throws IOException, GeneralSecurityException {\n+        byte[] keyBytes = Files.readAllBytes(Paths.get(keyPath));\n+        String keyString = new String(keyBytes, StandardCharsets.UTF_8);\n+\n+        if (keyString.contains(PKCS_1_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_1_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_1_PEM_FOOTER, \"\");\n+            return readPkcs1PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        if (keyString.contains(PKCS_8_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_8_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_8_PEM_FOOTER, \"\");\n+            return readPkcs8PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        return readPkcs8PrivateKey(keyBytes);\n+    }\n+\n+    private static PrivateKey readPkcs8PrivateKey(byte[] pkcs8Bytes) throws GeneralSecurityException {\n+        KeyFactory keyFactory = KeyFactory.getInstance(\"RSA\");\n+        PKCS8EncodedKeySpec keySpec = new PKCS8EncodedKeySpec(pkcs8Bytes);\n+        return keyFactory.generatePrivate(keySpec);\n+    }\n+\n+    private static PrivateKey readPkcs1PrivateKey(byte[] pkcs1Bytes) throws GeneralSecurityException {\n+        // We can't use Java internal APIs to parse ASN.1 structures, so we build a PKCS#8 key Java can understand\n+        int pkcs1Length = pkcs1Bytes.length;\n+        int totalLength = pkcs1Length + 22;\n+        // reference to https://github.com/Mastercard/client-encryption-java/blob/master/src/main/java/com/mastercard/developer/utils/EncryptionUtils.java#L95-L100\n+        // this method can save us from importing BouncyCastle as dependency\n+        byte[] pkcs8Header = {0x30, (byte) 0x82, (byte) ((totalLength >> 8) & 0xff), (byte) (totalLength & 0xff),\n+                // Sequence + total length\n+                0x2, 0x1, 0x0, // Integer (0)\n+                0x30, 0xD, 0x6, 0x9, 0x2A, (byte) 0x86, 0x48, (byte) 0x86, (byte) 0xF7, 0xD, 0x1, 0x1, 0x1, 0x5, 0x0,\n+                // Sequence: 1.2.840.113549.1.1.1, NULL\n+                0x4, (byte) 0x82, (byte) ((pkcs1Length >> 8) & 0xff), (byte) (pkcs1Length & 0xff)\n+                // Octet string + length\n+        };", "originalCommit": "3541001eb9cef044b9139edaac2bdcf69a9f001c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f1bcf2f44d4495a54688691bf63c707ee02b3222", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f1bcf2f44d4495a54688691bf63c707ee02b3222", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-22T20:11:20Z", "type": "commit"}, {"oid": "69f5a6582f4ad917767d87a925735a9e4554fa2d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/69f5a6582f4ad917767d87a925735a9e4554fa2d", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-22T21:28:49Z", "type": "commit"}, {"oid": "fa4a5f460d87a7cfc13e3ae019086dc4b6b5f4c6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fa4a5f460d87a7cfc13e3ae019086dc4b6b5f4c6", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-23T06:36:47Z", "type": "commit"}, {"oid": "322746718cfdc67d3e8c6d49d767bfe3cd6b93be", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/322746718cfdc67d3e8c6d49d767bfe3cd6b93be", "message": "switch to take http body of getComponentArtifact API since MR doesn't support http header forward", "committedDate": "2020-10-23T17:45:00Z", "type": "commit"}, {"oid": "97e099f63aa167e6b6ffc49e1994c9381aac712d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/97e099f63aa167e6b6ffc49e1994c9381aac712d", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-23T18:33:44Z", "type": "commit"}, {"oid": "c42e4faf730aad77d2836f4156be12e3aa3411ef", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c42e4faf730aad77d2836f4156be12e3aa3411ef", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-26T16:23:41Z", "type": "commit"}, {"oid": "18af24d734fe708cb0d2104f85469ea34b0b0a6b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/18af24d734fe708cb0d2104f85469ea34b0b0a6b", "message": "remove dead import", "committedDate": "2020-10-26T16:45:45Z", "type": "commit"}, {"oid": "3b1f4ba5d1cafba4b035add040502a9a7548df45", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3b1f4ba5d1cafba4b035add040502a9a7548df45", "message": "Merge remote-tracking branch 'origin/master' into moonraker_integration", "committedDate": "2020-10-26T19:50:52Z", "type": "commit"}, {"oid": "191f983496a49567ce2a9ba59420b5e8760005f9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/191f983496a49567ce2a9ba59420b5e8760005f9", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-27T00:51:59Z", "type": "commit"}, {"oid": "04646a47d472b0e4a7b8ca9dbc48a6942f8fa35b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/04646a47d472b0e4a7b8ca9dbc48a6942f8fa35b", "message": "switch to beta endpoint temporarily", "committedDate": "2020-10-27T01:19:51Z", "type": "commit"}, {"oid": "284e6eea5416b548bfe66fe0e5d21d961b594dc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/284e6eea5416b548bfe66fe0e5d21d961b594dc0", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-27T02:16:42Z", "type": "commit"}, {"oid": "d94b634b6f5802dcea8c37dcb9af9c2c5eabc4b0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d94b634b6f5802dcea8c37dcb9af9c2c5eabc4b0", "message": "add copyright headers", "committedDate": "2020-10-27T02:21:41Z", "type": "commit"}, {"oid": "f8545a209407aef29c6bcfdf325be6ca096ead3e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f8545a209407aef29c6bcfdf325be6ca096ead3e", "message": "delete e2e test case not applicable any more", "committedDate": "2020-10-27T03:16:24Z", "type": "commit"}, {"oid": "38f4a1dbbf7020a842dd651df01ead065e518c32", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/38f4a1dbbf7020a842dd651df01ead065e518c32", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-27T17:58:17Z", "type": "commit"}, {"oid": "5e18069cb461df4acfbc0660b34d1d1f059546e5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5e18069cb461df4acfbc0660b34d1d1f059546e5", "message": "switch back to gamma", "committedDate": "2020-10-27T17:58:28Z", "type": "commit"}, {"oid": "0fae8ea8b438f1dcd9fa68ed19d7a0d07817b8ee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0fae8ea8b438f1dcd9fa68ed19d7a0d07817b8ee", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-27T18:36:15Z", "type": "commit"}, {"oid": "e8919f4da5873779f41e7b680ed0a02b24ecff9d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e8919f4da5873779f41e7b680ed0a02b24ecff9d", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-27T21:01:50Z", "type": "commit"}, {"oid": "2ff1f1536ecbba90923eaa33f0bbec12652cadee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ff1f1536ecbba90923eaa33f0bbec12652cadee", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-29T17:02:58Z", "type": "commit"}, {"oid": "3a0a5008c9cfb080431733a1067f2bde7d221196", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3a0a5008c9cfb080431733a1067f2bde7d221196", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-29T19:20:38Z", "type": "commit"}, {"oid": "0fde5a3a7f085ab34f55b6dc3ef1602aa0a925ab", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0fde5a3a7f085ab34f55b6dc3ef1602aa0a925ab", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-30T00:02:34Z", "type": "commit"}, {"oid": "899272aeeec881aeafeb2764a2b3b6683feac553", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/899272aeeec881aeafeb2764a2b3b6683feac553", "message": "remove unused imports", "committedDate": "2020-10-30T00:27:37Z", "type": "commit"}, {"oid": "5aed5b6687ec9b81ab051a365d40472bf6ceaf0f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5aed5b6687ec9b81ab051a365d40472bf6ceaf0f", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-30T02:12:26Z", "type": "commit"}, {"oid": "667aea0372d5eb40b89a7d4a76a4aecd1b6126ed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/667aea0372d5eb40b89a7d4a76a4aecd1b6126ed", "message": "Merge branch 'master' into moonraker_integration", "committedDate": "2020-10-30T17:48:13Z", "type": "commit"}, {"oid": "49410e58969340e7f45a9f44a1e607a0ce78c874", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/49410e58969340e7f45a9f44a1e607a0ce78c874", "message": "ignore unrelated exception in fleet status service test", "committedDate": "2020-10-30T19:04:48Z", "type": "commit"}]}