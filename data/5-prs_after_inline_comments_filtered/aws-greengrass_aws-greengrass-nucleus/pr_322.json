{"pr_number": 322, "pr_title": "Cache credentials in TES", "pr_createdAt": "2020-07-18T01:44:08Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322", "timeline": [{"oid": "4c5e0df7fcaabb9ee7434943d05d38cdb8eb38fd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4c5e0df7fcaabb9ee7434943d05d38cdb8eb38fd", "message": "Cache credentials in TES", "committedDate": "2020-07-18T01:32:48Z", "type": "commit"}, {"oid": "66ba55f6eb430360ff7ebfeedbce82f908975a03", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/66ba55f6eb430360ff7ebfeedbce82f908975a03", "message": "Merge branch 'master' into tes-cache", "committedDate": "2020-07-18T02:02:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0OTM5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457549393", "bodyText": "Lets key the credentials by role name or url. This prevents accidental overrides of credentials, lets say when we update the role in the config.", "author": "prateek-y", "createdAt": "2020-07-20T16:44:21Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "diffHunk": "@@ -34,12 +39,22 @@\n     private static final String EXPIRATION_DOWNSTREAM_STR = \"Expiration\";\n     private static final ObjectMapper OBJECT_MAPPER =\n             new ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, true);\n+    public static final int TIME_BEFORE_CACHE_EXPIRE_IN_MIN = 5;\n+\n     private final String iotCredentialsPath;\n \n     private final IotCloudHelper iotCloudHelper;\n \n     private final IotConnectionManager iotConnectionManager;\n \n+    private Clock clock = Clock.systemUTC();\n+\n+    private Instant cacheExpiry = Instant.now(clock);\n+\n+    private byte[] cachedCredentials;", "originalCommit": "66ba55f6eb430360ff7ebfeedbce82f908975a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4MTI1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457781259", "bodyText": "Created a cache map with iotCredentialsPath as the key", "author": "popanmol", "createdAt": "2020-07-21T01:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0OTM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0OTY0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457549645", "bodyText": "Do you want to create a cached POJO  instead of different fields here?", "author": "prateek-y", "createdAt": "2020-07-20T16:44:48Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "diffHunk": "@@ -34,12 +39,22 @@\n     private static final String EXPIRATION_DOWNSTREAM_STR = \"Expiration\";\n     private static final ObjectMapper OBJECT_MAPPER =\n             new ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, true);\n+    public static final int TIME_BEFORE_CACHE_EXPIRE_IN_MIN = 5;\n+\n     private final String iotCredentialsPath;\n \n     private final IotCloudHelper iotCloudHelper;\n \n     private final IotConnectionManager iotConnectionManager;\n \n+    private Clock clock = Clock.systemUTC();\n+\n+    private Instant cacheExpiry = Instant.now(clock);\n+\n+    private byte[] cachedCredentials;\n+\n+    private int cachedResponseCode;", "originalCommit": "66ba55f6eb430360ff7ebfeedbce82f908975a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4MTQ3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457781479", "bodyText": "Created an object with fields credentials, responseCode and expiry", "author": "popanmol", "createdAt": "2020-07-21T01:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0OTY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1MTAxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457551012", "bodyText": "Lets always log the real expiry time, easier to read logs, then i dont have to do the math of +5 to debug what happened.", "author": "prateek-y", "createdAt": "2020-07-20T16:47:08Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "diffHunk": "@@ -67,18 +82,49 @@ public void handle(final HttpExchange exchange) throws IOException {\n      * @return AWS credentials from cloud.\n      */\n     public byte[] getCredentials() {\n-        byte[] response = {};\n         LOGGER.debug(\"Got request for credentials\");\n-        // TODO: Add cache\n+\n+        if (areCredentialsValid()) {\n+            return Arrays.copyOf(cachedCredentials, cachedCredentials.length);\n+        }\n+        \n+        byte[] response = {};\n+        Instant newExpiry = cacheExpiry;\n+\n         try {\n             final String credentials = iotCloudHelper.sendHttpRequest(iotConnectionManager,\n                     iotCredentialsPath,\n                     IOT_CREDENTIALS_HTTP_VERB, null);\n             response = translateToAwsSdkFormat(credentials);\n+\n+            String expiryString = parseExpiryFromResponse(credentials);\n+            Instant expiry = Instant.parse(expiryString);\n+\n+            if (expiry.isBefore(Instant.now(clock))) {\n+                String responseString = \"TES responded with expired credentials: \" + credentials;\n+                response = responseString.getBytes(StandardCharsets.UTF_8);\n+                cachedResponseCode = HttpURLConnection.HTTP_INTERNAL_ERROR;\n+                LOGGER.error(\"Unable to cache expired credentials which expired at {}\", expiry.toString());\n+            } else {\n+                newExpiry = expiry.minus(Duration.ofMinutes(TIME_BEFORE_CACHE_EXPIRE_IN_MIN));\n+                cachedResponseCode = HttpURLConnection.HTTP_OK;\n+\n+                if (newExpiry.isBefore(Instant.now(clock))) {\n+                    LOGGER.warn(\"Can't cache credentials as new credentials {} will expire in less than {} minutes\",\n+                            newExpiry.toString(),", "originalCommit": "66ba55f6eb430360ff7ebfeedbce82f908975a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4MTU3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457781575", "bodyText": "Changed newExpiry to expiry in log", "author": "popanmol", "createdAt": "2020-07-21T01:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1MTAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1MjUzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457552539", "bodyText": "If parseExpiry or translate throws, you will set credentials to empty. Do you want that?", "author": "prateek-y", "createdAt": "2020-07-20T16:49:32Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "diffHunk": "@@ -67,18 +82,49 @@ public void handle(final HttpExchange exchange) throws IOException {\n      * @return AWS credentials from cloud.\n      */\n     public byte[] getCredentials() {\n-        byte[] response = {};\n         LOGGER.debug(\"Got request for credentials\");\n-        // TODO: Add cache\n+\n+        if (areCredentialsValid()) {\n+            return Arrays.copyOf(cachedCredentials, cachedCredentials.length);\n+        }\n+        \n+        byte[] response = {};\n+        Instant newExpiry = cacheExpiry;\n+\n         try {\n             final String credentials = iotCloudHelper.sendHttpRequest(iotConnectionManager,\n                     iotCredentialsPath,\n                     IOT_CREDENTIALS_HTTP_VERB, null);\n             response = translateToAwsSdkFormat(credentials);\n+\n+            String expiryString = parseExpiryFromResponse(credentials);\n+            Instant expiry = Instant.parse(expiryString);\n+\n+            if (expiry.isBefore(Instant.now(clock))) {\n+                String responseString = \"TES responded with expired credentials: \" + credentials;\n+                response = responseString.getBytes(StandardCharsets.UTF_8);\n+                cachedResponseCode = HttpURLConnection.HTTP_INTERNAL_ERROR;\n+                LOGGER.error(\"Unable to cache expired credentials which expired at {}\", expiry.toString());\n+            } else {\n+                newExpiry = expiry.minus(Duration.ofMinutes(TIME_BEFORE_CACHE_EXPIRE_IN_MIN));\n+                cachedResponseCode = HttpURLConnection.HTTP_OK;\n+\n+                if (newExpiry.isBefore(Instant.now(clock))) {\n+                    LOGGER.warn(\"Can't cache credentials as new credentials {} will expire in less than {} minutes\",\n+                            newExpiry.toString(),\n+                            TIME_BEFORE_CACHE_EXPIRE_IN_MIN);\n+                } else {\n+                    LOGGER.info(\"Received IAM credentials that will be cached until {}\", newExpiry.toString());\n+                }\n+            }\n         } catch (AWSIotException e) {\n             // TODO: Generate 4xx, 5xx responses for all error scenarios\n             LOGGER.error(\"Encountered error while fetching credentials\", e);\n         }\n+\n+        cacheExpiry = newExpiry;\n+        cachedCredentials = response;", "originalCommit": "66ba55f6eb430360ff7ebfeedbce82f908975a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1Mjk0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457552942", "bodyText": "Lets add test case for those cases.", "author": "prateek-y", "createdAt": "2020-07-20T16:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1MjUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4MzY5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/322#discussion_r457783690", "bodyText": "If parseExpiry or translate throws, set response to \"Bad TES response: \" + credentials\nAlso added unit test for this.\nHad to create another try-catch for this because iotCloudHelper could also throw AWSIotException and that needs to be distinguished from these two to create appropriate error responses.", "author": "popanmol", "createdAt": "2020-07-21T01:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1MjUzOQ=="}], "type": "inlineReview"}, {"oid": "fc75eb938932fb684edce1f6806ae5afd17d1d2e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fc75eb938932fb684edce1f6806ae5afd17d1d2e", "message": "cache map and unparsable response body", "committedDate": "2020-07-21T00:44:40Z", "type": "commit"}, {"oid": "dd0c4be22bba7c4668de94b80b25a0360983c58a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dd0c4be22bba7c4668de94b80b25a0360983c58a", "message": "add expiry to cache object", "committedDate": "2020-07-21T01:09:20Z", "type": "commit"}, {"oid": "d96453a7c918dafb9a1999d8af368850df8f0306", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d96453a7c918dafb9a1999d8af368850df8f0306", "message": "Merge branch 'master' into tes-cache", "committedDate": "2020-07-21T02:47:21Z", "type": "commit"}, {"oid": "173a75dac4c8be70c0ff215191ca5bb2c80a8edc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/173a75dac4c8be70c0ff215191ca5bb2c80a8edc", "message": "Merge branch 'master' into tes-cache", "committedDate": "2020-07-21T03:16:59Z", "type": "commit"}, {"oid": "769fbe73a98a1b143e88f73df576cc98416bc02c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/769fbe73a98a1b143e88f73df576cc98416bc02c", "message": "Merge branch 'master' into tes-cache", "committedDate": "2020-07-21T22:16:32Z", "type": "commit"}]}