{"pr_number": 665, "pr_title": "Improve error recovery of kernel update", "pr_createdAt": "2020-11-12T01:47:26Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MjUxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521772516", "bodyText": "use Files.exists instead", "author": "MikeDombo", "createdAt": "2020-11-12T02:09:47Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -106,8 +115,11 @@ public Path getServiceConfigPath() {\n     }\n \n     public boolean isLaunchDirSetup() {\n-        // GG_NEEDS_REVIEW: TODO: check for file and directory corruptions\n-        return currentDir.toFile().exists();\n+        return validateLaunchDirSetup(currentDir);\n+    }\n+\n+    private boolean validateLaunchDirSetup(Path path) {\n+        return path.toFile().exists() && getLoaderPathFromLaunchDir(path).toFile().exists();", "originalCommit": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MjY3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521772676", "bodyText": "use deleteIfExists that way it won't complain if it doesn't exist.", "author": "MikeDombo", "createdAt": "2020-11-12T02:10:16Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -237,8 +255,12 @@ public void prepareBootstrap(String deploymentId) throws IOException {\n         Path existingLaunchDir = Files.readSymbolicLink(currentDir).toAbsolutePath();\n         copyFolderRecursively(existingLaunchDir, newLaunchDir, REPLACE_EXISTING, NOFOLLOW_LINKS, COPY_ATTRIBUTES);\n \n+        cleanup();\n+        setupLinkToDirectory(newDir, newLaunchDir);\n         setupLinkToDirectory(oldDir, existingLaunchDir);\n+        Files.delete(currentDir);\n         setupLinkToDirectory(currentDir, newLaunchDir);\n+        Files.delete(newDir);", "originalCommit": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMTM4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r522301380", "bodyText": "Both should exist otherwise won't reach here.", "author": "hui-yang", "createdAt": "2020-11-12T17:52:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MjY3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQxMDA4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r522410089", "bodyText": "Even though you say that, I'd feel better if you just add the ifExists. Less room for throwing exceptions.", "author": "MikeDombo", "createdAt": "2020-11-12T20:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MjY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3Mjc0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521772742", "bodyText": "at least log?", "author": "MikeDombo", "createdAt": "2020-11-12T02:10:26Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -251,7 +273,21 @@ public void prepareBootstrap(String deploymentId) throws IOException {\n      */\n     public void setupLinkToDirectory(Path link, Path directory) throws IOException {\n         logger.atDebug().kv(\"link\", link).kv(\"directory\", directory).log(\"Set up link to directory\");\n-        Files.deleteIfExists(link);\n         Files.createSymbolicLink(link, directory);\n     }\n+\n+    private void cleanup() {\n+        try {\n+            Files.deleteIfExists(brokenDir);\n+        } catch (IOException ignore) {", "originalCommit": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MzAwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521773008", "bodyText": "definitely needs a unit test", "author": "MikeDombo", "createdAt": "2020-11-12T02:11:17Z", "path": "src/main/java/com/aws/greengrass/util/CommitableReader.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util;\n+\n+import com.aws.greengrass.logging.api.Logger;\n+import com.aws.greengrass.logging.impl.LogManager;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+public final class CommitableReader {\n+    private static final Logger logger = LogManager.getLogger(CommitableReader.class);\n+\n+    private final Path target;\n+    private final Path backup;\n+\n+    private CommitableReader(Path target, Path backup) {\n+        this.target = target;\n+        this.backup = backup;\n+    }\n+\n+    public static CommitableReader of(Path path) {\n+        return new CommitableReader(path, CommitableFile.getBackupFile(path));\n+    }\n+\n+    /**\n+     * Read and validate the content of the given CommitableFile.\n+     *\n+     * @param validator CrashableFunction to read and validate file content\n+     * @throws IOException on I/O error\n+     */\n+    public void read(CrashableFunction<InputStream, Void, IOException> validator) throws IOException {", "originalCommit": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMjIwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r522302200", "bodyText": "Currently covered in classes where it's used. But I can also add some explicitly", "author": "hui-yang", "createdAt": "2020-11-12T17:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MzAwOA=="}], "type": "inlineReview"}, {"oid": "34ec91e864b3da9c34757bb15a07bb1ed027a330", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/34ec91e864b3da9c34757bb15a07bb1ed027a330", "message": "Address comments; add unit tests", "committedDate": "2020-11-12T20:06:36Z", "type": "forcePushed"}, {"oid": "789dc09db7a920692478bc4de94961b738d04761", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/789dc09db7a920692478bc4de94961b738d04761", "message": "Address comments; add unit tests", "committedDate": "2020-11-12T20:31:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwOTk0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r522409941", "bodyText": "deleteIfExists", "author": "MikeDombo", "createdAt": "2020-11-12T20:35:10Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -208,6 +225,7 @@ public void prepareRollback() throws IOException {\n             return;\n         }\n         setupLinkToDirectory(brokenDir, Files.readSymbolicLink(currentDir).toAbsolutePath());\n+        Files.delete(currentDir);", "originalCommit": "789dc09db7a920692478bc4de94961b738d04761", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "50436eff9e1e388999bda40704d1fba3603cae28", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/50436eff9e1e388999bda40704d1fba3603cae28", "message": "Improve error recovery of kernel update", "committedDate": "2020-11-12T21:59:30Z", "type": "commit"}, {"oid": "7dbb23b3c1cc2d3260512f05615ddedaa2d90e1a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7dbb23b3c1cc2d3260512f05615ddedaa2d90e1a", "message": "Address comments; add unit tests", "committedDate": "2020-11-12T21:59:30Z", "type": "commit"}, {"oid": "030364636c01aafb2ea43aa366ab0ef15f76c886", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/030364636c01aafb2ea43aa366ab0ef15f76c886", "message": "More fixes; add inline comments for review", "committedDate": "2020-11-12T21:59:30Z", "type": "forcePushed"}, {"oid": "9fe3a3f24db5eb97176dc27f7a4183da06334a00", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9fe3a3f24db5eb97176dc27f7a4183da06334a00", "message": "More fixes; add inline comments for review", "committedDate": "2020-11-12T22:27:39Z", "type": "commit"}, {"oid": "9fe3a3f24db5eb97176dc27f7a4183da06334a00", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9fe3a3f24db5eb97176dc27f7a4183da06334a00", "message": "More fixes; add inline comments for review", "committedDate": "2020-11-12T22:27:39Z", "type": "forcePushed"}, {"oid": "3a49bdefc23d65700aa6f5146fc3e28b5b59db65", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3a49bdefc23d65700aa6f5146fc3e28b5b59db65", "message": "Merge branch 'master' into ku-error-recovery", "committedDate": "2020-11-13T03:37:46Z", "type": "commit"}, {"oid": "825828f3056b9415d920149ca9c16a85c5fa699c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/825828f3056b9415d920149ca9c16a85c5fa699c", "message": "Merge branch 'master' into ku-error-recovery", "committedDate": "2020-11-13T22:15:57Z", "type": "commit"}, {"oid": "cba1a1ed3912f766e151eb5b7b413598ac0af650", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cba1a1ed3912f766e151eb5b7b413598ac0af650", "message": "Remove comments for review", "committedDate": "2020-11-13T22:26:44Z", "type": "commit"}]}