{"pr_number": 305, "pr_title": "Support kernel update deployments with restart/reboot", "pr_createdAt": "2020-07-14T02:26:45Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMDEwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457710100", "bodyText": "why subtype for type DeploymentStage?", "author": "leaf94", "createdAt": "2020-07-20T21:46:42Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/KernelUpdateDeploymentTask.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment;\n+\n+import com.aws.iot.evergreen.deployment.exceptions.ServiceUpdateException;\n+import com.aws.iot.evergreen.deployment.model.BaseDeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.Deployment;\n+import com.aws.iot.evergreen.deployment.model.DeploymentResult;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import lombok.AllArgsConstructor;\n+\n+import static com.aws.iot.evergreen.deployment.model.Deployment.DeploymentStage.KERNEL_ACTIVATION;\n+import static com.aws.iot.evergreen.deployment.model.Deployment.DeploymentStage.KERNEL_ROLLBACK;\n+\n+@AllArgsConstructor\n+public class KernelUpdateDeploymentTask implements BaseDeploymentTask {\n+    private Kernel kernel;\n+    private final Logger logger;\n+    private Deployment deployment;\n+\n+    @Override\n+    public DeploymentResult call() {\n+        Deployment.DeploymentStage subtype = deployment.getDeploymentStage();", "originalCommit": "f20c237cd26eeaa3544dccb238570de10ff194cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMjI4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457712287", "bodyText": "naming - BaseXXX implies inheritance. For polymorphism, I'd name the interface as \"DeploymentTask\" directly and have different \"DeploymentTask\" such as \"UpdateKernelDeploymentTask\" vs \"ComponentDeploymentTask\".", "author": "leaf94", "createdAt": "2020-07-20T21:51:37Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/BaseDeploymentTask.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment.model;\n+\n+import com.aws.iot.evergreen.deployment.exceptions.NonRetryableDeploymentTaskFailureException;\n+import com.aws.iot.evergreen.deployment.exceptions.RetryableDeploymentTaskFailureException;\n+\n+import java.util.concurrent.Callable;\n+\n+public interface BaseDeploymentTask extends Callable<DeploymentResult> {", "originalCommit": "f20c237cd26eeaa3544dccb238570de10ff194cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTk1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r458459952", "bodyText": "What about DeploymentTaskI? I tried to avoid unnecessary renaming of DeploymentTask in use", "author": "hui-yang", "createdAt": "2020-07-22T00:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMjI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMzMxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457713319", "bodyText": "Some comments to indicate the reason for each stage?", "author": "leaf94", "createdAt": "2020-07-20T21:54:10Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -45,9 +50,31 @@ public Deployment(DeploymentType deploymentType, String id, boolean isCancelled)\n         this.deploymentType = deploymentType;\n         this.id = id;\n         this.isCancelled = isCancelled;\n+        this.deploymentStage = DeploymentStage.DEFAULT;\n+    }\n+\n+    /**\n+     * Constructor for resuming deployments after Kernel restarts.\n+     *\n+     * @param deploymentDetails deployment document object\n+     * @param deploymentType deployment type\n+     * @param id deployment id\n+     * @param deploymentStage deployment stage, only applicable to deployments which require Kernel restart\n+     */\n+    public Deployment(DeploymentDocument deploymentDetails, DeploymentType deploymentType, String id,\n+                      DeploymentStage deploymentStage) {\n+        this.deploymentDocumentObj = deploymentDetails;\n+        this.deploymentType = deploymentType;\n+        this.id = id;\n+        this.deploymentStage = deploymentStage;\n     }\n \n     public enum DeploymentType {\n         IOT_JOBS, LOCAL\n     }\n+\n+    public enum DeploymentStage {\n+        DEFAULT, BOOTSTRAP, KERNEL_ACTIVATION, KERNEL_ROLLBACK", "originalCommit": "f20c237cd26eeaa3544dccb238570de10ff194cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e43798b2d18621f86d245794bf53b890332f862", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2e43798b2d18621f86d245794bf53b890332f862", "message": "Support kernel update deployments with restart/reboot", "committedDate": "2020-07-22T20:08:54Z", "type": "commit"}, {"oid": "c0ca24027d57145a2c8afa6dc707976a5eee550e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c0ca24027d57145a2c8afa6dc707976a5eee550e", "message": "Add readme and address comments", "committedDate": "2020-07-22T20:53:19Z", "type": "forcePushed"}, {"oid": "a57973c7728e9560b6592c3abf8342aa0132ac39", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a57973c7728e9560b6592c3abf8342aa0132ac39", "message": "Add readme and address comments", "committedDate": "2020-07-22T21:04:56Z", "type": "forcePushed"}, {"oid": "809f071783929a50dec9a3f1163611229a312443", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/809f071783929a50dec9a3f1163611229a312443", "message": "Add readme and address comments", "committedDate": "2020-07-22T21:24:04Z", "type": "forcePushed"}, {"oid": "03d5eb663971d7fa44617bda8e357eae2bf96b0a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03d5eb663971d7fa44617bda8e357eae2bf96b0a", "message": "Add readme and address comments", "committedDate": "2020-07-22T21:26:31Z", "type": "commit"}, {"oid": "03d5eb663971d7fa44617bda8e357eae2bf96b0a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03d5eb663971d7fa44617bda8e357eae2bf96b0a", "message": "Add readme and address comments", "committedDate": "2020-07-22T21:26:31Z", "type": "forcePushed"}, {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7c784db32487cf45eaa1ebc5ba635328be45ad40", "message": "Merge branch 'master' into kernel-update-deployment", "committedDate": "2020-07-23T22:23:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwOTkxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r459809917", "bodyText": "If the task isn't performed yet (eg in the wait for safe to update stage), will this disallow cancelling such tasks?", "author": "ShirleyZheng92", "createdAt": "2020-07-24T01:16:30Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -281,11 +283,13 @@ private void finishCurrentDeployment() throws InterruptedException {\n     @SuppressWarnings(\"PMD.NullAssignment\")\n     private void cancelCurrentDeployment() {\n         if (currentDeploymentTaskMetadata.getDeploymentResultFuture() != null) {\n-            if (currentDeploymentTaskMetadata.getDeploymentResultFuture().isDone()) {\n-                logger.atInfo().log(\"Deployment already finished processing, cannot cancel now\");\n+            if (currentDeploymentTaskMetadata.getDeploymentResultFuture().isDone()\n+                    || !currentDeploymentTaskMetadata.isCancellable()) {", "originalCommit": "7c784db32487cf45eaa1ebc5ba635328be45ad40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0MjA5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r460242095", "bodyText": "It is not allowed to cancel this task, because at this stage, bootstrap has finished and configuration has been merged, meaning it passed safe-update checked. Similar to default deployment, we also don't allow cancellation after config merge.", "author": "hui-yang", "createdAt": "2020-07-24T19:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwOTkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1Mjg2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r459852863", "bodyText": "Having both Obj and string looks confusing to me", "author": "ShirleyZheng92", "createdAt": "2020-07-24T05:02:02Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -7,18 +7,22 @@\n \n import lombok.EqualsAndHashCode;\n import lombok.Getter;\n+import lombok.Setter;\n import lombok.ToString;\n \n @Getter\n @EqualsAndHashCode(onlyExplicitlyIncluded = true)\n @ToString\n public class Deployment {\n+    @Setter\n+    private DeploymentDocument deploymentDocumentObj;\n     private String deploymentDocument;", "originalCommit": "7c784db32487cf45eaa1ebc5ba635328be45ad40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0MjU0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r460242542", "bodyText": "Agree. One option may be extending Deployment class. I can try to refactor in the next iteration.", "author": "hui-yang", "createdAt": "2020-07-24T19:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1Mjg2Mw=="}], "type": "inlineReview"}]}