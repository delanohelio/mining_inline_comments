{"pr_number": 581, "pr_title": "Integrate create deployment", "pr_createdAt": "2020-10-29T07:48:49Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581", "timeline": [{"oid": "1ee7496884eb9d64932e8fced83e29ff23fef41a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1ee7496884eb9d64932e8fced83e29ff23fef41a", "message": "initial commit", "committedDate": "2020-10-28T17:23:33Z", "type": "commit"}, {"oid": "800b2e36cd2d27bc29f125cbe61c3b92abc5d2ed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/800b2e36cd2d27bc29f125cbe61c3b92abc5d2ed", "message": "yes. it works.", "committedDate": "2020-10-29T07:48:11Z", "type": "commit"}, {"oid": "6586cdb2682300b836b83fbff3924d9e38da9b85", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6586cdb2682300b836b83fbff3924d9e38da9b85", "message": "pmd", "committedDate": "2020-10-29T08:02:42Z", "type": "commit"}, {"oid": "dc9a6b12ea5f4df8b7d03e77bb95eeb570d08526", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dc9a6b12ea5f4df8b7d03e77bb95eeb570d08526", "message": "Updated e2e tests", "committedDate": "2020-10-30T05:35:21Z", "type": "commit"}, {"oid": "f2c547be04a8ae278187a9a203ef1ed5be58dd17", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f2c547be04a8ae278187a9a203ef1ed5be58dd17", "message": "Update integ&e2e test recipe", "committedDate": "2020-10-30T18:28:45Z", "type": "commit"}, {"oid": "f2c547be04a8ae278187a9a203ef1ed5be58dd17", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f2c547be04a8ae278187a9a203ef1ed5be58dd17", "message": "Update integ&e2e test recipe", "committedDate": "2020-10-30T18:28:45Z", "type": "forcePushed"}, {"oid": "d5205b7fc96386ff32657e9fe4f3f41867e59ee9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5205b7fc96386ff32657e9fe4f3f41867e59ee9", "message": "finish unit tests", "committedDate": "2020-10-30T22:17:21Z", "type": "commit"}, {"oid": "b3df199f283df2d62b0b5a55fb5c92940a53f067", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3df199f283df2d62b0b5a55fb5c92940a53f067", "message": "Merge branch 'integrate_create_deployment' of github.com:aws/aws-greengrass-kernel into integrate_create_deployment", "committedDate": "2020-10-30T22:17:33Z", "type": "commit"}, {"oid": "166d534baecbe117001e0b12e169e0ef1f45167e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/166d534baecbe117001e0b12e169e0ef1f45167e", "message": "more tests migration", "committedDate": "2020-10-30T23:04:27Z", "type": "commit"}, {"oid": "f60e7972f31cee301029f0c83e7c85130ab494e3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f60e7972f31cee301029f0c83e7c85130ab494e3", "message": "update to use latest AWS SDK with brazil artifact version 1.0.354", "committedDate": "2020-11-02T20:18:50Z", "type": "commit"}, {"oid": "c6db62a38035ae67a9ab04637f03f3f97454a1a5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6db62a38035ae67a9ab04637f03f3f97454a1a5", "message": "Merge remote-tracking branch 'origin/master' into integrate_create_deployment", "committedDate": "2020-11-02T20:29:14Z", "type": "commit"}, {"oid": "33ec0923719130df995722b7e77d1d61ed2eee92", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/33ec0923719130df995722b7e77d1d61ed2eee92", "message": "merge", "committedDate": "2020-11-02T20:29:31Z", "type": "commit"}, {"oid": "622338f8f20f6faed7ee371b00a6ec40432ed572", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/622338f8f20f6faed7ee371b00a6ec40432ed572", "message": "merge fix", "committedDate": "2020-11-02T20:34:50Z", "type": "commit"}, {"oid": "dd8849ab08252bfe6c87f6dee6bc69026d0017e8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dd8849ab08252bfe6c87f6dee6bc69026d0017e8", "message": "Merge branch 'master' into integrate_create_deployment", "committedDate": "2020-11-02T21:40:23Z", "type": "commit"}, {"oid": "4a167e0d9c24e52026044c77b3d6ca39ed5be1d6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4a167e0d9c24e52026044c77b3d6ca39ed5be1d6", "message": "Merge branch 'master' into integrate_create_deployment", "committedDate": "2020-11-03T06:23:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1OTkyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516459927", "bodyText": "Too many auto formatting :) Here is the real change.", "author": "ShirleyZheng92", "createdAt": "2020-11-03T07:09:58Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -465,9 +467,24 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n                     break;\n                 case IOT_JOBS:\n                 case SHADOW:\n-                    FleetConfiguration config = SerializerFactory.getJsonObjectMapper()\n-                            .readValue(jobDocumentString, FleetConfiguration.class);\n-                    document = DeploymentDocumentConverter.convertFromFleetConfiguration(config);\n+                    JsonNode jsonNode =", "originalCommit": "4a167e0d9c24e52026044c77b3d6ca39ed5be1d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3MjgwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516972806", "bodyText": "hah thanks", "author": "leaf94", "createdAt": "2020-11-03T21:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1OTkyNw=="}], "type": "inlineReview"}, {"oid": "36a71253de3cb6d29647cc90135ebf3b5a0a75e3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/36a71253de3cb6d29647cc90135ebf3b5a0a75e3", "message": "Small fix on DeploymentE2ETest", "committedDate": "2020-11-03T07:50:32Z", "type": "commit"}, {"oid": "0e3410acdc946e96770ffdfa6158f11492f16ea3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0e3410acdc946e96770ffdfa6158f11492f16ea3", "message": "Merge remote-tracking branch 'origin/master' into integrate_create_deployment", "committedDate": "2020-11-03T18:21:12Z", "type": "commit"}, {"oid": "047f5f242fe57e894ed35b1a5772cc08db2fef34", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/047f5f242fe57e894ed35b1a5772cc08db2fef34", "message": "Small fix on DeploymentE2ETest", "committedDate": "2020-11-03T18:28:16Z", "type": "forcePushed"}, {"oid": "c71c112f5c1724ed2258ecf9683d9f2621074ba9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c71c112f5c1724ed2258ecf9683d9f2621074ba9", "message": "works now", "committedDate": "2020-11-03T19:14:01Z", "type": "commit"}, {"oid": "c71c112f5c1724ed2258ecf9683d9f2621074ba9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c71c112f5c1724ed2258ecf9683d9f2621074ba9", "message": "works now", "committedDate": "2020-11-03T19:14:01Z", "type": "forcePushed"}, {"oid": "6bb0415d3e46175d4d144f1bebeb778e7d3ed770", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6bb0415d3e46175d4d144f1bebeb778e7d3ed770", "message": "minor fix for pending actin", "committedDate": "2020-11-03T20:08:44Z", "type": "commit"}, {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d1335d897d18367668cc3895bc6a2b26e5358067", "message": "minor fix for pending actin", "committedDate": "2020-11-03T20:09:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0MzAzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516943032", "bodyText": "Do we have an enum yet for these target types?", "author": "MikeDombo", "createdAt": "2020-11-03T20:41:12Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -372,38 +370,34 @@ private static void cleanUpTestComponentArtifactsFromS3() {\n     }\n \n     @SuppressWarnings(\"PMD.LinguisticNaming\")\n-    protected PublishConfigurationResult setAndPublishFleetConfiguration(SetConfigurationRequest setRequest) {\n+    protected CreateDeploymentResult draftAndCreateDeployment(CreateDeploymentRequest createDeploymentRequest) {\n \n         // update package name with random suffix to avoid conflict in cloud\n-        Map<String, PackageMetaData> updatedPkgMetadata = new HashMap<>();\n-        setRequest.getPackages().forEach((key, val) -> updatedPkgMetadata.put(getTestComponentNameInCloud(key), val));\n-        setRequest.setPackages(updatedPkgMetadata);\n+        Map<String, ComponentInfo> updatedPkgMetadata = new HashMap<>();\n+        createDeploymentRequest.getComponents().forEach((key, val) -> updatedPkgMetadata.put(getTestComponentNameInCloud(key), val));\n+        createDeploymentRequest.setComponents(updatedPkgMetadata);\n \n         // set default value\n-        if (setRequest.getDeploymentPolicies() == null) {\n-            setRequest.withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n-                    .withComponentUpdatePolicy(\n-                            new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n-                                    .withTimeout(120))\n-                    .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING));\n+        if (createDeploymentRequest.getTargetName() == null) {\n+            createDeploymentRequest.withTargetName(thingGroupName);\n         }\n-\n-        logger.atInfo().kv(\"setRequest\", setRequest).log();\n-        SetConfigurationResult setResult = greengrassClient.setConfiguration(setRequest);\n-        logger.atInfo().kv(\"setResult\", setResult).log();\n-\n-        PublishConfigurationRequest publishRequest = new PublishConfigurationRequest()\n-                .withTargetName(setRequest.getTargetName())\n-                .withTargetType(setRequest.getTargetType())\n-                .withRevisionId(setResult.getRevisionId());\n-        logger.atInfo().kv(\"publishRequest\", publishRequest).log();\n-        PublishConfigurationResult publishResult = greengrassClient.publishConfiguration(publishRequest);\n-        logger.atInfo().kv(\"publishResult\", publishResult).log();\n-        if (setRequest.getTargetType().equals(THING_GROUP_TARGET_TYPE)) {\n-            createdIotJobIds.add(publishResult.getJobId());\n+        if (createDeploymentRequest.getTargetType() == null) {\n+            createDeploymentRequest.withTargetType(THING_GROUP_TARGET_TYPE);", "originalCommit": "d1335d897d18367668cc3895bc6a2b26e5358067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NzMzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516967331", "bodyText": "Nah. Will open a thread to ask when we will have it. https://code.amazon.com/packages/EvergreenFleetConfigurationServiceModel/blobs/7f3d14a8495f9706bbc17c9bbfdbebd6a0b5aa44/--/model/CreateDeployment.xml#L24", "author": "leaf94", "createdAt": "2020-11-03T21:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0MzAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTMxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516945311", "bodyText": "why is this the default? Should the default be to wait forever?", "author": "MikeDombo", "createdAt": "2020-11-03T20:46:00Z", "path": "src/main/java/com/aws/greengrass/deployment/model/ComponentUpdatePolicy.java", "diffHunk": "@@ -23,8 +23,9 @@\n @EqualsAndHashCode\n @ToString\n public class ComponentUpdatePolicy {\n+\n     @JsonProperty(\"Timeout\")\n-    private Integer timeout;\n+    private Integer timeout = 60;", "originalCommit": "d1335d897d18367668cc3895bc6a2b26e5358067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2Mzc2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516963767", "bodyText": "Good catch. Got these from @shaguptashaikh . Could you help?", "author": "leaf94", "createdAt": "2020-11-03T21:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwOTgyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517009827", "bodyText": "The default is 60s based on an old conversation between me, Fahad and Finn, Fahad knows more. We can't wait forever because components can only report if they want to DEFER the update and for how long, they don't have a way of saying they are okay with the deployment, them not responding within the timeout is taken as a go ahead from them, so can't wait forever", "author": "shaguptashaikh", "createdAt": "2020-11-03T23:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTUwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516945503", "bodyText": "not sure this is the correct default.", "author": "MikeDombo", "createdAt": "2020-11-03T20:46:25Z", "path": "src/main/java/com/aws/greengrass/deployment/model/DeploymentDocument.java", "diffHunk": "@@ -51,10 +51,12 @@\n     private Long timestamp;\n \n     @JsonProperty(\"FailureHandlingPolicy\")\n-    private FailureHandlingPolicy failureHandlingPolicy;\n+    @Builder.Default\n+    private FailureHandlingPolicy failureHandlingPolicy = FailureHandlingPolicy.ROLLBACK;", "originalCommit": "d1335d897d18367668cc3895bc6a2b26e5358067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2MzgzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516963838", "bodyText": "same as above", "author": "leaf94", "createdAt": "2020-11-03T21:24:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMDA2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517010065", "bodyText": "This default should be ROLLBACK, and customers can change it to DO_NOTHING if they want to", "author": "shaguptashaikh", "createdAt": "2020-11-03T23:13:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NzY2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516947667", "bodyText": "flip this .equals so that a NPE isn't possible", "author": "MikeDombo", "createdAt": "2020-11-03T20:50:49Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -197,17 +200,17 @@ protected void startup() throws InterruptedException {\n                 if (deployment.getDeploymentType().equals(DeploymentType.SHADOW)) {\n                     // A new device deployment invalidates the previous deployment, cancel the ongoing device deployment\n                     // and wait till the new device deployment can be picked up.\n-                    if (currentDeploymentTaskMetadata != null\n-                            && currentDeploymentTaskMetadata.getDeploymentType().equals(DeploymentType.SHADOW)) {\n+                    if (currentDeploymentTaskMetadata != null && currentDeploymentTaskMetadata.getDeploymentType()", "originalCommit": "d1335d897d18367668cc3895bc6a2b26e5358067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NTc2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516965768", "bodyText": "done", "author": "leaf94", "createdAt": "2020-11-03T21:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NzY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0Nzk5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516947993", "bodyText": "needs a space before the need", "author": "MikeDombo", "createdAt": "2020-11-03T20:51:25Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -356,13 +358,13 @@ private void cancelCurrentDeployment() {\n                 } else {\n                     logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n                             .log(\"Deployment is in a stage where it cannot be cancelled,\"\n-                                    + \"need to wait for it to finish\");\n+                                         + \"need to wait for it to finish\");", "originalCommit": "d1335d897d18367668cc3895bc6a2b26e5358067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NTU2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516965568", "bodyText": "done.", "author": "leaf94", "createdAt": "2020-11-03T21:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0Nzk5Mw=="}], "type": "inlineReview"}, {"oid": "6717c926fa87bc03416625e51e263840ecf85cd9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6717c926fa87bc03416625e51e263840ecf85cd9", "message": "fix on DeploymentE2ETest", "committedDate": "2020-11-03T20:53:56Z", "type": "commit"}, {"oid": "0b69e1ba2035ba0c7878db775bcafe92f1cf4cbd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0b69e1ba2035ba0c7878db775bcafe92f1cf4cbd", "message": "Merge remote-tracking branch 'origin/master' into integrate_create_deployment", "committedDate": "2020-11-03T21:08:12Z", "type": "commit"}, {"oid": "dcc22e971f3ea63a27e05fd9c8bdb2a2c98d27fa", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dcc22e971f3ea63a27e05fd9c8bdb2a2c98d27fa", "message": "Merge branch 'master' into integrate_create_deployment", "committedDate": "2020-11-03T21:25:16Z", "type": "commit"}, {"oid": "341e49c76fa7e3b4d56f13c8f21b9c862589df4a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/341e49c76fa7e3b4d56f13c8f21b9c862589df4a", "message": "pr comments", "committedDate": "2020-11-03T21:32:55Z", "type": "commit"}, {"oid": "0b3f69574af3b5eb1fe824c9a7b2d31ab5d67cda", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0b3f69574af3b5eb1fe824c9a7b2d31ab5d67cda", "message": "minor fix with Ashay's help", "committedDate": "2020-11-04T00:21:29Z", "type": "commit"}, {"oid": "81ca90fa8f98e3b0ad9341a899e6894f2eba0697", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/81ca90fa8f98e3b0ad9341a899e6894f2eba0697", "message": "Merge branch 'master' into integrate_create_deployment", "committedDate": "2020-11-04T00:27:55Z", "type": "commit"}, {"oid": "5aa4bd11a94d818d44ea2f49d6e76d44eac8ede2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5aa4bd11a94d818d44ea2f49d6e76d44eac8ede2", "message": "my bad. committed wrong code. It will pass this time.", "committedDate": "2020-11-04T00:58:40Z", "type": "commit"}, {"oid": "358a102b80099fed7e22034de61785cf38f56172", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/358a102b80099fed7e22034de61785cf38f56172", "message": "Merge branch 'master' into integrate_create_deployment", "committedDate": "2020-11-04T01:00:04Z", "type": "commit"}, {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ebdbca049716460c9d8c344232001eb4e9d4b410", "message": "merge", "committedDate": "2020-11-04T01:02:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA0NjYzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517046630", "bodyText": "DeploymentConfiguration -> camel case", "author": "shaguptashaikh", "createdAt": "2020-11-04T01:22:23Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -177,10 +177,10 @@ public void onStreamClosed() {\n     }\n \n     private void submitSampleJobDocument(URI uri, String arn, DeploymentType type) throws Exception {\n-        FleetConfiguration fleetConfiguration = OBJECT_MAPPER.readValue(new File(uri), FleetConfiguration.class);\n-        fleetConfiguration.setCreationTimestamp(System.currentTimeMillis());\n-        fleetConfiguration.setConfigurationArn(arn);\n-        Deployment deployment = new Deployment(OBJECT_MAPPER.writeValueAsString(fleetConfiguration), type, fleetConfiguration.getConfigurationArn());\n+        Configuration DeploymentConfiguration = OBJECT_MAPPER.readValue(new File(uri), Configuration.class);", "originalCommit": "ebdbca049716460c9d8c344232001eb4e9d4b410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA0NzY0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517047643", "bodyText": "oh god. Thanks. Let me know if anything else. Build passes and hopefully we can merge it in after one more build and only 20 min.", "author": "leaf94", "createdAt": "2020-11-04T01:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA0NjYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1MTczNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517051734", "bodyText": "why is this needed? and the string is an identifier / tag for the update action so it's just the deployment id", "author": "shaguptashaikh", "createdAt": "2020-11-04T01:40:58Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -674,44 +657,62 @@ public void onStreamClosed() {\n \n             // Second deployment to update the service which is currently running an important task so deployment should\n             // keep waiting for a safe time to update\n-            SetConfigurationRequest setRequest2 = new SetConfigurationRequest().withTargetName(thingGroupName).withTargetType(THING_GROUP_TARGET_TYPE).withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120)).withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING)\n-                    .withComponentUpdatePolicy(new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS).withTimeout(120)))\n-                    .addPackagesEntry(\"NonDisruptableService\", new PackageMetaData().withRootComponent(true).withVersion(\"1.0.1\"));\n-            PublishConfigurationResult publishResult2 = setAndPublishFleetConfiguration(setRequest2);\n-            IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, publishResult2.getJobId(), thingInfo\n-                    .getThingName(), Duration.ofMinutes(3), s -> s.equals(JobExecutionStatus.IN_PROGRESS));\n+            CreateDeploymentRequest createDeploymentRequest2 = new CreateDeploymentRequest()\n+                    .withDeploymentPolicies(new DeploymentPolicies()\n+                            .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n+                            .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING).withComponentUpdatePolicy(\n+                                    new ComponentUpdatePolicy()\n+                                            .withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n+                                            .withTimeout(120)))\n+                    .addComponentsEntry(\"NonDisruptableService\", new ComponentInfo().withVersion(\"1.0.1\"));\n+            CreateDeploymentResult result2 = draftAndCreateDeployment(createDeploymentRequest2);\n+            IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, result2.getJobId(), thingInfo.getThingName(),\n+                    Duration.ofMinutes(3), s -> s.equals(JobExecutionStatus.IN_PROGRESS));\n \n             // Create one more deployment so that it's queued in cloud\n-            SetConfigurationRequest setRequest3 = new SetConfigurationRequest().withTargetName(thingGroupName).withTargetType(THING_GROUP_TARGET_TYPE).withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120)).withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING)\n-                    .withComponentUpdatePolicy(new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS).withTimeout(120)))\n-                    .addPackagesEntry(\"NonDisruptableService\", new PackageMetaData().withRootComponent(true).withVersion(\"1.0.1\"));\n-            PublishConfigurationResult publishResult3 = setAndPublishFleetConfiguration(setRequest3);\n+            CreateDeploymentRequest createDeploymentRequest3 = new CreateDeploymentRequest()\n+                    .withDeploymentPolicies(new DeploymentPolicies()\n+                            .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n+                            .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING).withComponentUpdatePolicy(\n+                                    new ComponentUpdatePolicy()\n+                                            .withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n+                                            .withTimeout(120)))\n+                    .addComponentsEntry(\"NonDisruptableService\", new ComponentInfo().withVersion(\"1.0.1\"));\n+            CreateDeploymentResult result3 = draftAndCreateDeployment(createDeploymentRequest3);\n \n             // Wait for the second deployment to start waiting for safe time to update and\n             // then cancel it's corresponding job from cloud\n             assertTrue(updateRegistered.await(60, TimeUnit.SECONDS));\n-            assertTrue(kernel.getContext().get(UpdateSystemSafelyService.class).hasPendingUpdateAction(publishResult2.getConfigurationArn()));\n+            UpdateSystemSafelyService updateSystemSafelyService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            assertThat(\"The UpdateSystemService should have one pending action.\",\n+                    updateSystemSafelyService.getPendingActions(),\n+                    IsCollectionWithSize.hasSize(1));\n+            // Get the value of the pending Action\n+            String pendingAction = updateSystemSafelyService.getPendingActions().iterator().next();", "originalCommit": "ebdbca049716460c9d8c344232001eb4e9d4b410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NTU3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517055572", "bodyText": "Not sure as we just migrated it. My guess is that it wants to verify as a double check so that it doesn't only rely on the log text matching.\nAnd the deployment id is a different story.  In short, cloud now returns an obfuscated UUID from control plane, but passes the original fleetConfigArn via data plane, which will be the tag. So we can't verify here.", "author": "leaf94", "createdAt": "2020-11-04T01:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1MTczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1MTg2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517051868", "bodyText": "Same here, why do we need it?", "author": "shaguptashaikh", "createdAt": "2020-11-04T01:41:31Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -674,44 +657,62 @@ public void onStreamClosed() {\n \n             // Second deployment to update the service which is currently running an important task so deployment should\n             // keep waiting for a safe time to update\n-            SetConfigurationRequest setRequest2 = new SetConfigurationRequest().withTargetName(thingGroupName).withTargetType(THING_GROUP_TARGET_TYPE).withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120)).withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING)\n-                    .withComponentUpdatePolicy(new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS).withTimeout(120)))\n-                    .addPackagesEntry(\"NonDisruptableService\", new PackageMetaData().withRootComponent(true).withVersion(\"1.0.1\"));\n-            PublishConfigurationResult publishResult2 = setAndPublishFleetConfiguration(setRequest2);\n-            IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, publishResult2.getJobId(), thingInfo\n-                    .getThingName(), Duration.ofMinutes(3), s -> s.equals(JobExecutionStatus.IN_PROGRESS));\n+            CreateDeploymentRequest createDeploymentRequest2 = new CreateDeploymentRequest()\n+                    .withDeploymentPolicies(new DeploymentPolicies()\n+                            .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n+                            .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING).withComponentUpdatePolicy(\n+                                    new ComponentUpdatePolicy()\n+                                            .withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n+                                            .withTimeout(120)))\n+                    .addComponentsEntry(\"NonDisruptableService\", new ComponentInfo().withVersion(\"1.0.1\"));\n+            CreateDeploymentResult result2 = draftAndCreateDeployment(createDeploymentRequest2);\n+            IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, result2.getJobId(), thingInfo.getThingName(),\n+                    Duration.ofMinutes(3), s -> s.equals(JobExecutionStatus.IN_PROGRESS));\n \n             // Create one more deployment so that it's queued in cloud\n-            SetConfigurationRequest setRequest3 = new SetConfigurationRequest().withTargetName(thingGroupName).withTargetType(THING_GROUP_TARGET_TYPE).withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120)).withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING)\n-                    .withComponentUpdatePolicy(new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS).withTimeout(120)))\n-                    .addPackagesEntry(\"NonDisruptableService\", new PackageMetaData().withRootComponent(true).withVersion(\"1.0.1\"));\n-            PublishConfigurationResult publishResult3 = setAndPublishFleetConfiguration(setRequest3);\n+            CreateDeploymentRequest createDeploymentRequest3 = new CreateDeploymentRequest()\n+                    .withDeploymentPolicies(new DeploymentPolicies()\n+                            .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n+                            .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING).withComponentUpdatePolicy(\n+                                    new ComponentUpdatePolicy()\n+                                            .withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n+                                            .withTimeout(120)))\n+                    .addComponentsEntry(\"NonDisruptableService\", new ComponentInfo().withVersion(\"1.0.1\"));\n+            CreateDeploymentResult result3 = draftAndCreateDeployment(createDeploymentRequest3);\n \n             // Wait for the second deployment to start waiting for safe time to update and\n             // then cancel it's corresponding job from cloud\n             assertTrue(updateRegistered.await(60, TimeUnit.SECONDS));\n-            assertTrue(kernel.getContext().get(UpdateSystemSafelyService.class).hasPendingUpdateAction(publishResult2.getConfigurationArn()));\n+            UpdateSystemSafelyService updateSystemSafelyService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            assertThat(\"The UpdateSystemService should have one pending action.\",\n+                    updateSystemSafelyService.getPendingActions(),\n+                    IsCollectionWithSize.hasSize(1));\n+            // Get the value of the pending Action\n+            String pendingAction = updateSystemSafelyService.getPendingActions().iterator().next();\n \n             // GG_NEEDS_REVIEW: TODO : Call Fleet configuration service's cancel API when ready instead of calling IoT Jobs API\n-            IotJobsUtils.cancelJob(iotClient, publishResult2.getJobId());\n+            IotJobsUtils.cancelJob(iotClient, result2.getJobId());\n \n             // Wait for indication that cancellation has gone through\n             assertTrue(deploymentCancelled.await(240, TimeUnit.SECONDS));\n-            assertFalse(kernel.getContext().get(UpdateSystemSafelyService.class).hasPendingUpdateAction(publishResult2.getConfigurationArn()));\n+            // the third deployment may have reached device.\n+            Set<String> pendingActions = updateSystemSafelyService.getPendingActions();\n+            if (pendingActions.size() == 1) {\n+                String newPendingAction = pendingActions.iterator().next();\n+                assertNotEquals(pendingAction, newPendingAction, \"The UpdateSystemService's one pending action should be be replaced.\");", "originalCommit": "ebdbca049716460c9d8c344232001eb4e9d4b410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NTYwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517055602", "bodyText": "same as above.", "author": "leaf94", "createdAt": "2020-11-04T01:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1MTg2OA=="}], "type": "inlineReview"}, {"oid": "4756f8fdabc2c561d7828b02c199516f3589190e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4756f8fdabc2c561d7828b02c199516f3589190e", "message": "pr comment", "committedDate": "2020-11-04T01:41:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1Mzk2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517053969", "bodyText": "For TODOs we need to create SIMs in this folder for tracking them appropriately if they are release blockers, and this does sound like something we should clean up before release? https://issues.amazon.com/issues/search?q=status%3A(Open)+in%3A(09c8bedb-c771-4a5b-a8a8-409bc1758e3d)&sort=lastUpdatedDate+desc&selectedDocument=54e3fb2d-e2d0-48db-a2db-067d4121c09d Not blocking the CR but a SIM needs to be created for it", "author": "shaguptashaikh", "createdAt": "2020-11-04T01:49:50Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -472,9 +475,24 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n                     break;\n                 case IOT_JOBS:\n                 case SHADOW:\n-                    FleetConfiguration config = SerializerFactory.getJsonObjectMapper()\n-                            .readValue(jobDocumentString, FleetConfiguration.class);\n-                    document = DeploymentDocumentConverter.convertFromFleetConfiguration(config);\n+                    JsonNode jsonNode =\n+                            SerializerFactory.getJsonObjectMapper().readValue(jobDocumentString, JsonNode.class);\n+\n+                    if (jsonNode.has(\"packages\")) {\n+                        // If \"packages\" exists, the document is in the old format, which is\n+                        // the result of Set/PublishConfiguration\n+                        // TODO remove after migrating off Set/PublishConfiguration", "originalCommit": "ebdbca049716460c9d8c344232001eb4e9d4b410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1Nzk5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517057997", "bodyText": "done: https://issues.amazon.com/issues/P41383716", "author": "leaf94", "createdAt": "2020-11-04T02:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1Mzk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NDc5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517054799", "bodyText": "I don't think this warning log should be added, it's should be at debug level at best, it's not going to be uncommon for customers to rely on defaults unless they have to change to some other value", "author": "shaguptashaikh", "createdAt": "2020-11-04T01:53:13Z", "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -185,4 +197,116 @@ public static DeploymentDocument convertFromFleetConfiguration(FleetConfiguratio\n         });\n         return new ArrayList<>(packageConfigurations.values());\n     }\n+\n+    /**\n+     * Converts deployment configuration {@link Configuration} that is generated by CreateDeployment and gets sent down\n+     * via IoT Job and shadow to the Nucleus's core {@link DeploymentDocument}.\n+     *\n+     * @param config Fleet configuration that is generated by CreateDeployment and gets sent down via IoT Job and\n+     *               shadow\n+     * @return Nucleus's core {@link DeploymentDocument}\n+     * @throws InvalidRequestException if the deployment configuration is invalid\n+     */\n+    public static DeploymentDocument convertFromDeploymentConfiguration(Configuration config)\n+            throws InvalidRequestException {\n+\n+        Map<String, ComponentUpdate> components = config.getComponents();\n+        if (components == null || components.isEmpty()) {\n+            throw new InvalidRequestException(\"The deployment configuration doesn't specified components to deploy.\");\n+        }\n+\n+        DeploymentDocument.DeploymentDocumentBuilder builder =\n+                DeploymentDocument.builder().deploymentId(config.getConfigurationArn())\n+                        .deploymentPackageConfigurationList(convertComponents(config.getComponents()))\n+                        .groupName(parseGroupNameFromConfigurationArn(config)).timestamp(config.getCreationTimestamp());\n+\n+\n+        if (config.getFailureHandlingPolicy() == null) {\n+            // FailureHandlingPolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"FailureHandlingPolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");", "originalCommit": "ebdbca049716460c9d8c344232001eb4e9d4b410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjEwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517056100", "bodyText": "No. The cloud would give the default. This would only log when cloud is not providing, which is a warning.", "author": "leaf94", "createdAt": "2020-11-04T01:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NDc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NDgyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517054828", "bodyText": "Same as above", "author": "shaguptashaikh", "createdAt": "2020-11-04T01:53:21Z", "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -185,4 +197,116 @@ public static DeploymentDocument convertFromFleetConfiguration(FleetConfiguratio\n         });\n         return new ArrayList<>(packageConfigurations.values());\n     }\n+\n+    /**\n+     * Converts deployment configuration {@link Configuration} that is generated by CreateDeployment and gets sent down\n+     * via IoT Job and shadow to the Nucleus's core {@link DeploymentDocument}.\n+     *\n+     * @param config Fleet configuration that is generated by CreateDeployment and gets sent down via IoT Job and\n+     *               shadow\n+     * @return Nucleus's core {@link DeploymentDocument}\n+     * @throws InvalidRequestException if the deployment configuration is invalid\n+     */\n+    public static DeploymentDocument convertFromDeploymentConfiguration(Configuration config)\n+            throws InvalidRequestException {\n+\n+        Map<String, ComponentUpdate> components = config.getComponents();\n+        if (components == null || components.isEmpty()) {\n+            throw new InvalidRequestException(\"The deployment configuration doesn't specified components to deploy.\");\n+        }\n+\n+        DeploymentDocument.DeploymentDocumentBuilder builder =\n+                DeploymentDocument.builder().deploymentId(config.getConfigurationArn())\n+                        .deploymentPackageConfigurationList(convertComponents(config.getComponents()))\n+                        .groupName(parseGroupNameFromConfigurationArn(config)).timestamp(config.getCreationTimestamp());\n+\n+\n+        if (config.getFailureHandlingPolicy() == null) {\n+            // FailureHandlingPolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"FailureHandlingPolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.failureHandlingPolicy(convertFailureHandlingPolicy(config.getFailureHandlingPolicy()));\n+        }\n+\n+        if (config.getComponentUpdatePolicy() == null) {\n+            // ComponentUpdatePolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"ComponentUpdatePolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");", "originalCommit": "ebdbca049716460c9d8c344232001eb4e9d4b410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1ODA3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517058072", "bodyText": "same", "author": "leaf94", "createdAt": "2020-11-04T02:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NDgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjExMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517056112", "bodyText": "Not sure if this is okay to do, thing group name and configuration arn are different strings, more importantly, this has to be some problem with our code on the cloud side if this arn is not present in the document, it's not a user error, so swallowing it is bad because it will not reveal service side issues but might mess up FSS metrics for customers. Also about using the thing name as group name, is that how we treat single device deployments? I thought we were using the default group for shadow deployments right?", "author": "shaguptashaikh", "createdAt": "2020-11-04T01:58:19Z", "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -185,4 +197,116 @@ public static DeploymentDocument convertFromFleetConfiguration(FleetConfiguratio\n         });\n         return new ArrayList<>(packageConfigurations.values());\n     }\n+\n+    /**\n+     * Converts deployment configuration {@link Configuration} that is generated by CreateDeployment and gets sent down\n+     * via IoT Job and shadow to the Nucleus's core {@link DeploymentDocument}.\n+     *\n+     * @param config Fleet configuration that is generated by CreateDeployment and gets sent down via IoT Job and\n+     *               shadow\n+     * @return Nucleus's core {@link DeploymentDocument}\n+     * @throws InvalidRequestException if the deployment configuration is invalid\n+     */\n+    public static DeploymentDocument convertFromDeploymentConfiguration(Configuration config)\n+            throws InvalidRequestException {\n+\n+        Map<String, ComponentUpdate> components = config.getComponents();\n+        if (components == null || components.isEmpty()) {\n+            throw new InvalidRequestException(\"The deployment configuration doesn't specified components to deploy.\");\n+        }\n+\n+        DeploymentDocument.DeploymentDocumentBuilder builder =\n+                DeploymentDocument.builder().deploymentId(config.getConfigurationArn())\n+                        .deploymentPackageConfigurationList(convertComponents(config.getComponents()))\n+                        .groupName(parseGroupNameFromConfigurationArn(config)).timestamp(config.getCreationTimestamp());\n+\n+\n+        if (config.getFailureHandlingPolicy() == null) {\n+            // FailureHandlingPolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"FailureHandlingPolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.failureHandlingPolicy(convertFailureHandlingPolicy(config.getFailureHandlingPolicy()));\n+        }\n+\n+        if (config.getComponentUpdatePolicy() == null) {\n+            // ComponentUpdatePolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"ComponentUpdatePolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.componentUpdatePolicy(convertComponentUpdatePolicy(config.getComponentUpdatePolicy()));\n+        }\n+\n+        return builder.build();\n+    }\n+\n+    private static String parseGroupNameFromConfigurationArn(Configuration config) {\n+        String groupName;\n+        try {\n+            // ConfigurationArn formats:\n+            // configuration:thing/<thing-name>\n+            // configuration:thinggroup/<thing-group-name>\n+            groupName = Arn.fromString(config.getConfigurationArn()).getResource().getResource();\n+        } catch (IllegalArgumentException e) {\n+            // so that it can proceed, rather than fail, when the format of configurationArn is wrong.\n+            groupName = config.getConfigurationArn();", "originalCommit": "ebdbca049716460c9d8c344232001eb4e9d4b410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjM0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517056347", "bodyText": "This is migrated from previous logic which passes all UATs. Checked with @abanthiy", "author": "leaf94", "createdAt": "2020-11-04T01:59:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjU0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517056546", "bodyText": "So no non root components even if they have just configuration changes ?", "author": "shaguptashaikh", "createdAt": "2020-11-04T01:59:55Z", "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -185,4 +197,116 @@ public static DeploymentDocument convertFromFleetConfiguration(FleetConfiguratio\n         });\n         return new ArrayList<>(packageConfigurations.values());\n     }\n+\n+    /**\n+     * Converts deployment configuration {@link Configuration} that is generated by CreateDeployment and gets sent down\n+     * via IoT Job and shadow to the Nucleus's core {@link DeploymentDocument}.\n+     *\n+     * @param config Fleet configuration that is generated by CreateDeployment and gets sent down via IoT Job and\n+     *               shadow\n+     * @return Nucleus's core {@link DeploymentDocument}\n+     * @throws InvalidRequestException if the deployment configuration is invalid\n+     */\n+    public static DeploymentDocument convertFromDeploymentConfiguration(Configuration config)\n+            throws InvalidRequestException {\n+\n+        Map<String, ComponentUpdate> components = config.getComponents();\n+        if (components == null || components.isEmpty()) {\n+            throw new InvalidRequestException(\"The deployment configuration doesn't specified components to deploy.\");\n+        }\n+\n+        DeploymentDocument.DeploymentDocumentBuilder builder =\n+                DeploymentDocument.builder().deploymentId(config.getConfigurationArn())\n+                        .deploymentPackageConfigurationList(convertComponents(config.getComponents()))\n+                        .groupName(parseGroupNameFromConfigurationArn(config)).timestamp(config.getCreationTimestamp());\n+\n+\n+        if (config.getFailureHandlingPolicy() == null) {\n+            // FailureHandlingPolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"FailureHandlingPolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.failureHandlingPolicy(convertFailureHandlingPolicy(config.getFailureHandlingPolicy()));\n+        }\n+\n+        if (config.getComponentUpdatePolicy() == null) {\n+            // ComponentUpdatePolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"ComponentUpdatePolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.componentUpdatePolicy(convertComponentUpdatePolicy(config.getComponentUpdatePolicy()));\n+        }\n+\n+        return builder.build();\n+    }\n+\n+    private static String parseGroupNameFromConfigurationArn(Configuration config) {\n+        String groupName;\n+        try {\n+            // ConfigurationArn formats:\n+            // configuration:thing/<thing-name>\n+            // configuration:thinggroup/<thing-group-name>\n+            groupName = Arn.fromString(config.getConfigurationArn()).getResource().getResource();\n+        } catch (IllegalArgumentException e) {\n+            // so that it can proceed, rather than fail, when the format of configurationArn is wrong.\n+            groupName = config.getConfigurationArn();\n+        }\n+        return groupName;\n+    }\n+\n+    private static List<DeploymentPackageConfiguration> convertComponents(\n+            @Nonnull Map<String, ComponentUpdate> components) {\n+        return components.entrySet().stream().map(e -> convertComponent(e.getKey(), e.getValue()))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private static DeploymentPackageConfiguration convertComponent(String componentName,\n+            ComponentUpdate componentUpdate) {\n+\n+        return DeploymentPackageConfiguration.builder().packageName(componentName)\n+                .resolvedVersion(componentUpdate.getVersion().getValue())\n+                .rootComponent(true) // As of now, CreateDeployment API only gives root component", "originalCommit": "ebdbca049716460c9d8c344232001eb4e9d4b410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1Njg0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517056842", "bodyText": "Correct.", "author": "leaf94", "createdAt": "2020-11-04T02:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjU0Ng=="}], "type": "inlineReview"}, {"oid": "498674b3912c550217d273a2f7f0c2574873e4ad", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/498674b3912c550217d273a2f7f0c2574873e4ad", "message": "pr comments", "committedDate": "2020-11-04T02:15:00Z", "type": "commit"}]}