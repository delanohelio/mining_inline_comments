{"pr_number": 244, "pr_title": "Fix TES Dependency Injection", "pr_createdAt": "2020-05-15T20:07:57Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244", "timeline": [{"oid": "4fae6156de83b5c40371b33a6a5b97dff588f966", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4fae6156de83b5c40371b33a6a5b97dff588f966", "message": "Fix TES injection", "committedDate": "2020-05-15T21:07:06Z", "type": "forcePushed"}, {"oid": "5b6a502fa848cbba121ad2a30438d5a2464c1b8d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b6a502fa848cbba121ad2a30438d5a2464c1b8d", "message": "Add update policy to pom", "committedDate": "2020-05-15T21:21:19Z", "type": "forcePushed"}, {"oid": "8d91f089369b1b196d0ae236ec4ea66f9cc4a1b3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8d91f089369b1b196d0ae236ec4ea66f9cc4a1b3", "message": "Add update policy to pom", "committedDate": "2020-05-15T21:22:11Z", "type": "forcePushed"}, {"oid": "023b7ae5dcd2991ce30e9ea550750cb4729722c5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/023b7ae5dcd2991ce30e9ea550750cb4729722c5", "message": "Add update policy to pom", "committedDate": "2020-05-15T21:24:21Z", "type": "forcePushed"}, {"oid": "f20981a78b64a33a27308b47f6877818bf58f018", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f20981a78b64a33a27308b47f6877818bf58f018", "message": "Add update policy to pom", "committedDate": "2020-05-15T21:26:54Z", "type": "forcePushed"}, {"oid": "465c1578b5804b25fdd00e2c54fa2d4ad6280ebc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/465c1578b5804b25fdd00e2c54fa2d4ad6280ebc", "message": "Add update policy to pom", "committedDate": "2020-05-15T21:45:31Z", "type": "forcePushed"}, {"oid": "8e69c763e259d47acb3344ab563c263c48e44967", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e69c763e259d47acb3344ab563c263c48e44967", "message": "Fix TES injection", "committedDate": "2020-05-16T00:01:26Z", "type": "commit"}, {"oid": "560fa96ec6c4fb9882ea531e5461542ffbb19de3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/560fa96ec6c4fb9882ea531e5461542ffbb19de3", "message": "Update shading to remove extra StaticLoggerBinding", "committedDate": "2020-05-16T00:01:37Z", "type": "commit"}, {"oid": "041f77bf31686187958fa83326e43fce059e4612", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/041f77bf31686187958fa83326e43fce059e4612", "message": "Update E2E tests to have cred endpoint", "committedDate": "2020-05-18T03:22:11Z", "type": "commit"}, {"oid": "041f77bf31686187958fa83326e43fce059e4612", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/041f77bf31686187958fa83326e43fce059e4612", "message": "Update E2E tests to have cred endpoint", "committedDate": "2020-05-18T03:22:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzMzA0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426833046", "bodyText": "change name of @param", "author": "abanthiy", "createdAt": "2020-05-18T19:00:14Z", "path": "src/main/java/com/aws/iot/evergreen/tes/IotConnectionManager.java", "diffHunk": "@@ -24,31 +25,31 @@\n import java.util.concurrent.ExecutionException;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.TimeoutException;\n+import javax.inject.Inject;\n \n public class IotConnectionManager implements Closeable {\n     // TODO: Move Iot related classes to a central location\n     private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n     // TODO: ALPN support\n     private static final int IOT_PORT = 8443;\n     // Max wait time for device to establish mTLS connection with IOT core\n-    private static final long TIMEOUT_FOR_CONNECTION_SETUP_SECONDS = (long) Duration.ofMinutes(1).getSeconds();\n-    private final String iotEndpoint;\n+    private static final long TIMEOUT_FOR_CONNECTION_SETUP_SECONDS = Duration.ofMinutes(1).getSeconds();\n     private final HttpClientConnectionManager connManager;\n \n     /**\n      * Constructor.\n-     * @param iotEndpoint Iot cloud credentials endpoint for managing connections to.\n+     *\n      * @param deviceConfiguration Device configuration for getting cert and keys for mTLS", "originalCommit": "041f77bf31686187958fa83326e43fce059e4612", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTA0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839048", "bodyText": "Wondering if we should just rename this to dataEndpoint, to match with the terminology used in AWS docs. Similar change in DeviceConfiguration as well.", "author": "abanthiy", "createdAt": "2020-05-18T19:12:01Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -330,5 +321,18 @@ public static void updateKernelConfigWithIotConfiguration(Kernel kernel, Utils.T\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_PRIVATE_KEY_PATH).withValue(privKeyFilePath);\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_CERTIFICATE_FILE_PATH).withValue(certFilePath);\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_ROOT_CA_PATH).withValue(caFilePath);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_IOT_CRED_ENDPOINT).withValue(thing.credEndpoint);\n+    }\n+\n+    @AllArgsConstructor\n+    public static class ThingInfo {\n+        public String thingArn;\n+        public String thingName;\n+        public String certificateArn;\n+        public String certificateId;\n+        public String certificatePem;\n+        public KeyPair keyPair;\n+        public String endpoint;", "originalCommit": "041f77bf31686187958fa83326e43fce059e4612", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTM3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839372", "bodyText": "clientEndpoint -> dataEndpoint", "author": "abanthiy", "createdAt": "2020-05-18T19:12:38Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfigurationHelper.java", "diffHunk": "@@ -36,33 +37,38 @@\n \n     /**\n      * Retrieves the device configuration information from kernel config to communicate with Iot Cloud.\n+     *\n      * @return {@link DeviceConfiguration}\n      * @throws DeviceConfigurationException when configuration is not available for the device.\n      */\n     public DeviceConfiguration getDeviceConfiguration() throws DeviceConfigurationException {\n         String thingName = getStringParameterFromConfig(DEVICE_PARAM_THING_NAME);\n-        String certificateFilePath = kernelCommandLine.deTilde(\n-                getStringParameterFromConfig(DEVICE_PARAM_CERTIFICATE_FILE_PATH));\n+        String certificateFilePath =\n+                kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_CERTIFICATE_FILE_PATH));\n         String privateKeyPath = kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_PRIVATE_KEY_PATH));\n         String rootCAPath = kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_ROOT_CA_PATH));\n         String mqttClientEndpoint = getStringParameterFromConfig(DEVICE_PARAM_MQTT_CLIENT_ENDPOINT);\n-        validateDeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint);\n-        return new DeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint);\n+        String iotCredEndpoint = getStringParameterFromConfig(DEVICE_PARAM_IOT_CRED_ENDPOINT);\n+        validateDeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint,\n+                iotCredEndpoint);\n+        return new DeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint,\n+                iotCredEndpoint);\n     }\n \n     private String getStringParameterFromConfig(String parameterName) {\n         String paramValue = \"\";\n         //TODO: Update when device provisioning is implemented\n-        Topic childTopic = kernel.getConfig().lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC,\n-                DeploymentService.DEPLOYMENT_SERVICE_TOPICS).findLeafChild(parameterName);\n+        Topic childTopic = kernel.getConfig()\n+                .lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, DeploymentService.DEPLOYMENT_SERVICE_TOPICS)\n+                .findLeafChild(parameterName);\n         if (childTopic != null && childTopic.getOnce() != null) {\n             paramValue = childTopic.getOnce().toString();\n         }\n         return paramValue;\n     }\n \n     private void validateDeviceConfiguration(String thingName, String certificateFilePath, String privateKeyPath,\n-                                             String rootCAPath, String clientEndpoint)\n+                                             String rootCAPath, String clientEndpoint, String iotCredEndpoint)", "originalCommit": "041f77bf31686187958fa83326e43fce059e4612", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTU1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839556", "bodyText": "Renaming here to iotDataEndpoint", "author": "abanthiy", "createdAt": "2020-05-18T19:12:59Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeviceConfiguration.java", "diffHunk": "@@ -18,4 +18,5 @@\n     private String privateKeyFilePath;\n     private String rootCAFilePath;\n     private String mqttClientEndpoint;", "originalCommit": "041f77bf31686187958fa83326e43fce059e4612", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "488a3a302d296d17e46664d119df557a34c17578", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/488a3a302d296d17e46664d119df557a34c17578", "message": "Address PR comments", "committedDate": "2020-05-18T19:33:39Z", "type": "forcePushed"}, {"oid": "27f8158bf1c36d6f75c671cf99d6a03f25fa79ab", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/27f8158bf1c36d6f75c671cf99d6a03f25fa79ab", "message": "Address PR comments", "committedDate": "2020-05-18T19:37:49Z", "type": "forcePushed"}, {"oid": "a42d29fb5886267881ba33860f7fd712574c9166", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a42d29fb5886267881ba33860f7fd712574c9166", "message": "Address PR comments", "committedDate": "2020-05-18T20:00:01Z", "type": "commit"}, {"oid": "a42d29fb5886267881ba33860f7fd712574c9166", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a42d29fb5886267881ba33860f7fd712574c9166", "message": "Address PR comments", "committedDate": "2020-05-18T20:00:01Z", "type": "forcePushed"}]}