{"pr_number": 126, "pr_title": "E2E Deployment test with IoT Jobs", "pr_createdAt": "2020-03-19T23:03:13Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126", "timeline": [{"oid": "0c84b36f7908ed655f94265c36d01d37a0c98ec9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0c84b36f7908ed655f94265c36d01d37a0c98ec9", "message": "E2E Deployment test with IoT Jobs", "committedDate": "2020-03-19T23:18:59Z", "type": "forcePushed"}, {"oid": "9cbb3eb2c277f2c83aaee348894ae94433a03a07", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9cbb3eb2c277f2c83aaee348894ae94433a03a07", "message": "E2E Deployment test with IoT Jobs", "committedDate": "2020-03-19T23:20:54Z", "type": "forcePushed"}, {"oid": "a92e0f72222d8bc7755d94d0c6b4bbcc4fcc969f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a92e0f72222d8bc7755d94d0c6b4bbcc4fcc969f", "message": "E2E Deployment test with IoT Jobs", "committedDate": "2020-03-19T23:26:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2OTEzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395369130", "bodyText": "Packages need to be created in the store as well as part of this test?", "author": "abanthiy", "createdAt": "2020-03-19T23:10:08Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.integrationtests.AbstractBaseITCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.util.CommitableFile;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Test;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.LinkedList;\n+import java.util.UUID;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_MQTT_CLIENT_ENDPOINT;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_ROOT_CA_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_THING_NAME;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class DeploymentE2ETest extends AbstractBaseITCase {\n+\n+    private static final String ROOT_CA_FILENAME = tempRootDir.resolve(\"rootCA.pem\").toString();\n+    private static final String PRIVATE_KEY_FILENAME = tempRootDir.resolve(\"privKey.key\").toString();\n+    private static final String CERTIFICATE_FILENAME = tempRootDir.resolve(\"thingCert.crt\").toString();\n+\n+    @AfterAll\n+    static void afterAll() {\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Test\n+    void GIVEN_blank_kernel_WHEN_deploy_new_services_e2e_THEN_new_services_deployed_and_job_is_successful()\n+            throws Exception {\n+        // Setup IoT resources\n+        Utils.downloadRootCAToFile(new File(ROOT_CA_FILENAME));\n+        Utils.ThingInfo thing = Utils.createThing();\n+        try (CommitableFile cf = CommitableFile.of(new File(PRIVATE_KEY_FILENAME).toPath(), true)) {\n+            cf.write(thing.keyPair.privateKey().getBytes(StandardCharsets.UTF_8));\n+        }\n+        try (CommitableFile cf = CommitableFile.of(new File(CERTIFICATE_FILENAME).toPath(), true)) {\n+            cf.write(thing.certificatePem.getBytes(StandardCharsets.UTF_8));\n+        }\n+\n+        // Inject IoT resources into kernel\n+        Kernel kernel = new Kernel().parseArgs(\"-i\", getClass().getResource(\"blank_config.yaml\").toString());\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, \"DeploymentService\");\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_THING_NAME).setValue(thing.thingName);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_MQTT_CLIENT_ENDPOINT).setValue(thing.endpoint);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_PRIVATE_KEY_PATH).setValue(PRIVATE_KEY_FILENAME);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_CERTIFICATE_FILE_PATH).setValue(CERTIFICATE_FILENAME);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_ROOT_CA_PATH).setValue(ROOT_CA_FILENAME);\n+        kernel.launch();\n+\n+        // Create Job Doc\n+        String document = new ObjectMapper().writeValueAsString(\n+                DeploymentDocument.builder().timestamp(System.currentTimeMillis())\n+                        .deploymentId(UUID.randomUUID().toString())\n+                        // TODO: Add packages once we have a mock/real package store", "originalCommit": "f9dc44da3807bbafce064f5b6b4ed62d1cddf5e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NDY3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395374677", "bodyText": "Well I can have package names here, but they won't be deployable unless we have a package manager/store that can find them.", "author": "MikeDombo", "createdAt": "2020-03-19T23:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2OTEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NjEyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395376128", "bodyText": "You can use the local store for now, which is being used by the IntegrationTest. When the design of store gets defined then we can change this.", "author": "abanthiy", "createdAt": "2020-03-19T23:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2OTEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2OTY5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395369697", "bodyText": "Change this to be more restrictive. Certs with these policies are going to live (even though short lived) on different hosts and thats a risk. I would changes the Resource to be the Iot Thing ARN", "author": "abanthiy", "createdAt": "2020-03-19T23:11:54Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import lombok.AllArgsConstructor;\n+import software.amazon.awssdk.services.iot.IotClient;\n+import software.amazon.awssdk.services.iot.model.AttachPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.AttachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.CancelJobRequest;\n+import software.amazon.awssdk.services.iot.model.CertificateStatus;\n+import software.amazon.awssdk.services.iot.model.CreateJobRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateResponse;\n+import software.amazon.awssdk.services.iot.model.CreatePolicyRequest;\n+import software.amazon.awssdk.services.iot.model.CreateThingRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteJobRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteThingRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeEndpointRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.DetachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.GetPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.InvalidRequestException;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+import software.amazon.awssdk.services.iot.model.KeyPair;\n+import software.amazon.awssdk.services.iot.model.ResourceNotFoundException;\n+import software.amazon.awssdk.services.iot.model.TargetSelection;\n+import software.amazon.awssdk.services.iot.model.TimeoutConfig;\n+import software.amazon.awssdk.services.iot.model.UpdateCertificateRequest;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.TimeoutException;\n+\n+public class Utils {\n+    public static final IotClient iotClient = IotClient.builder().build();\n+    private static final String FULL_ACCESS_POLICY_NAME = \"E2ETestFullAccess\";\n+    private static final Set<ThingInfo> createdThings = new CopyOnWriteArraySet<>();\n+    private static final Set<String> createdJobs = new CopyOnWriteArraySet<>();\n+    private static final String ROOT_CA_URL = \"https://www.amazontrust.com/repository/AmazonRootCA1.pem\";\n+\n+    public static String createJob(String document, String[] targets) {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        iotClient.createJob(\n+                CreateJobRequest.builder().jobId(jobId).targets(targets).targetSelection(TargetSelection.SNAPSHOT)\n+                        .document(document).description(\"E2E Test: \" + new Date())\n+                        .timeoutConfig(TimeoutConfig.builder().inProgressTimeoutInMinutes(10L).build()).build());\n+        createdJobs.add(jobId);\n+        return jobId;\n+    }\n+\n+    public static void waitForJobToComplete(String jobId, Duration timeout) throws TimeoutException {\n+        Instant start = Instant.now();\n+\n+        while (start.plusMillis(timeout.toMillis()).isAfter(Instant.now())) {\n+            JobStatus status = iotClient.describeJob(DescribeJobRequest.builder().jobId(jobId).build()).job().status();\n+            if (status.ordinal() > JobStatus.IN_PROGRESS.ordinal()) {\n+                return;\n+            }\n+        }\n+        throw new TimeoutException();\n+    }\n+\n+    public static ThingInfo createThing() {\n+        // Find or create IoT policy\n+        try {\n+            iotClient.getPolicy(GetPolicyRequest.builder().policyName(FULL_ACCESS_POLICY_NAME).build());\n+        } catch (ResourceNotFoundException e) {\n+            iotClient.createPolicy(CreatePolicyRequest.builder().policyName(FULL_ACCESS_POLICY_NAME).policyDocument(\n+                    \"{\\n  \\\"Version\\\": \\\"2012-10-17\\\",\\n  \\\"Statement\\\": [\\n    {\\n\"\n+                            + \"      \\\"Effect\\\": \\\"Allow\\\",\\n      \\\"Action\\\": \\\"iot:*\\\",\\n\"\n+                            + \"      \\\"Resource\\\": \\\"*\\\"\\n    }\\n  ]\\n}\").build());", "originalCommit": "f9dc44da3807bbafce064f5b6b4ed62d1cddf5e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MTIyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395371229", "bodyText": "May not be applicable for starters but, timeout should be taken as parameter and we should be able to create job without timeout. In my understanding when cloud service creates a job it is not going to put timeout. At some point we are also going to deployment when device gets offline after it receives the job.", "author": "abanthiy", "createdAt": "2020-03-19T23:16:40Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import lombok.AllArgsConstructor;\n+import software.amazon.awssdk.services.iot.IotClient;\n+import software.amazon.awssdk.services.iot.model.AttachPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.AttachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.CancelJobRequest;\n+import software.amazon.awssdk.services.iot.model.CertificateStatus;\n+import software.amazon.awssdk.services.iot.model.CreateJobRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateResponse;\n+import software.amazon.awssdk.services.iot.model.CreatePolicyRequest;\n+import software.amazon.awssdk.services.iot.model.CreateThingRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteJobRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteThingRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeEndpointRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.DetachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.GetPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.InvalidRequestException;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+import software.amazon.awssdk.services.iot.model.KeyPair;\n+import software.amazon.awssdk.services.iot.model.ResourceNotFoundException;\n+import software.amazon.awssdk.services.iot.model.TargetSelection;\n+import software.amazon.awssdk.services.iot.model.TimeoutConfig;\n+import software.amazon.awssdk.services.iot.model.UpdateCertificateRequest;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.TimeoutException;\n+\n+public class Utils {\n+    public static final IotClient iotClient = IotClient.builder().build();\n+    private static final String FULL_ACCESS_POLICY_NAME = \"E2ETestFullAccess\";\n+    private static final Set<ThingInfo> createdThings = new CopyOnWriteArraySet<>();\n+    private static final Set<String> createdJobs = new CopyOnWriteArraySet<>();\n+    private static final String ROOT_CA_URL = \"https://www.amazontrust.com/repository/AmazonRootCA1.pem\";\n+\n+    public static String createJob(String document, String[] targets) {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        iotClient.createJob(\n+                CreateJobRequest.builder().jobId(jobId).targets(targets).targetSelection(TargetSelection.SNAPSHOT)\n+                        .document(document).description(\"E2E Test: \" + new Date())\n+                        .timeoutConfig(TimeoutConfig.builder().inProgressTimeoutInMinutes(10L).build()).build());", "originalCommit": "f9dc44da3807bbafce064f5b6b4ed62d1cddf5e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NTIzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395375230", "bodyText": "Yeah, it should be configurable but I do want a timeout on our test resources so that they eventually are marked as failed/go away even if in production they won't have timeouts. I don't think that affects anything about how the job works, but let me know if I'm wrong.", "author": "MikeDombo", "createdAt": "2020-03-19T23:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3OTU5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395379594", "bodyText": "Yes it does not affect how the jobs work.", "author": "abanthiy", "createdAt": "2020-03-19T23:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MTIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MDM2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395380363", "bodyText": "Handle ThrottlingException for this and other resource CRUD operations in Iot? Add retries with backoff?", "author": "abanthiy", "createdAt": "2020-03-19T23:48:24Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import lombok.AllArgsConstructor;\n+import software.amazon.awssdk.services.iot.IotClient;\n+import software.amazon.awssdk.services.iot.model.AttachPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.AttachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.CancelJobRequest;\n+import software.amazon.awssdk.services.iot.model.CertificateStatus;\n+import software.amazon.awssdk.services.iot.model.CreateJobRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateResponse;\n+import software.amazon.awssdk.services.iot.model.CreatePolicyRequest;\n+import software.amazon.awssdk.services.iot.model.CreateThingRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteJobRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteThingRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeEndpointRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.DetachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.GetPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.InvalidRequestException;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+import software.amazon.awssdk.services.iot.model.KeyPair;\n+import software.amazon.awssdk.services.iot.model.ResourceNotFoundException;\n+import software.amazon.awssdk.services.iot.model.TargetSelection;\n+import software.amazon.awssdk.services.iot.model.TimeoutConfig;\n+import software.amazon.awssdk.services.iot.model.UpdateCertificateRequest;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.TimeoutException;\n+\n+public class Utils {\n+    public static final IotClient iotClient = IotClient.builder().build();\n+    private static final String FULL_ACCESS_POLICY_NAME = \"E2ETestFullAccess\";\n+    private static final Set<ThingInfo> createdThings = new CopyOnWriteArraySet<>();\n+    private static final Set<String> createdJobs = new CopyOnWriteArraySet<>();\n+    private static final String ROOT_CA_URL = \"https://www.amazontrust.com/repository/AmazonRootCA1.pem\";\n+\n+    public static String createJob(String document, String[] targets) {", "originalCommit": "a92e0f72222d8bc7755d94d0c6b4bbcc4fcc969f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "656749d351d506c73e8b779e6c749609101f0724", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/656749d351d506c73e8b779e6c749609101f0724", "message": "Add retries for IoT Core operations. Scoped down IoT Core Policy", "committedDate": "2020-03-20T00:32:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MzI1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395393259", "bodyText": "Dependencies are not needed in job document. This is a deprecated field. We get the dependencies from recipe.", "author": "abanthiy", "createdAt": "2020-03-20T00:40:39Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.AbstractBaseITCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.EvergreenService;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.util.CommitableFile;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Test;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.UUID;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_MQTT_CLIENT_ENDPOINT;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_ROOT_CA_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_THING_NAME;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class DeploymentE2ETest extends AbstractBaseITCase {\n+\n+    private static final String ROOT_CA_FILENAME = tempRootDir.resolve(\"rootCA.pem\").toString();\n+    private static final String PRIVATE_KEY_FILENAME = tempRootDir.resolve(\"privKey.key\").toString();\n+    private static final String CERTIFICATE_FILENAME = tempRootDir.resolve(\"thingCert.crt\").toString();\n+    private static final Path LOCAL_CACHE_PATH =\n+            Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    @AfterAll\n+    static void afterAll() {\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Test\n+    void GIVEN_blank_kernel_WHEN_deploy_new_services_e2e_THEN_new_services_deployed_and_job_is_successful()\n+            throws Exception {\n+        // Setup IoT resources\n+        Utils.downloadRootCAToFile(new File(ROOT_CA_FILENAME));\n+        Utils.ThingInfo thing = Utils.createThing();\n+        try (CommitableFile cf = CommitableFile.of(new File(PRIVATE_KEY_FILENAME).toPath(), true)) {\n+            cf.write(thing.keyPair.privateKey().getBytes(StandardCharsets.UTF_8));\n+        }\n+        try (CommitableFile cf = CommitableFile.of(new File(CERTIFICATE_FILENAME).toPath(), true)) {\n+            cf.write(thing.certificatePem.getBytes(StandardCharsets.UTF_8));\n+        }\n+\n+        // Inject IoT resources into kernel\n+        Kernel kernel = new Kernel().parseArgs(\"-i\", getClass().getResource(\"blank_config.yaml\").toString());\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, \"DeploymentService\");\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_THING_NAME).setValue(thing.thingName);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_MQTT_CLIENT_ENDPOINT).setValue(thing.endpoint);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_PRIVATE_KEY_PATH).setValue(PRIVATE_KEY_FILENAME);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_CERTIFICATE_FILE_PATH).setValue(CERTIFICATE_FILENAME);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_ROOT_CA_PATH).setValue(ROOT_CA_FILENAME);\n+\n+        // Inject our mocked local package store\n+        kernel.context.getv(DependencyResolver.class)\n+                .put(new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel));\n+        kernel.launch();\n+\n+        // Create Job Doc\n+        String document = new ObjectMapper().writeValueAsString(\n+                DeploymentDocument.builder().timestamp(System.currentTimeMillis())\n+                        .deploymentId(UUID.randomUUID().toString()).rootPackages(Arrays.asList(\"CustomerApp\"))\n+                        .deploymentPackageConfigurationList(Arrays.asList(\n+                                new DeploymentPackageConfiguration(\"CustomerApp\", \"1.0.0\", null, null,\n+                                        Arrays.asList(new PackageIdentifier(\"Mosquitto\", null))))).build());", "originalCommit": "656749d351d506c73e8b779e6c749609101f0724", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5Njk4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395396988", "bodyText": "Like how you do this. Would it better to take retryable exceptions as input? We want to retry in specific cases, not in all.", "author": "abanthiy", "createdAt": "2020-03-20T00:57:59Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.util.CrashableSupplier;\n+import lombok.AllArgsConstructor;\n+import software.amazon.awssdk.services.iot.IotClient;\n+import software.amazon.awssdk.services.iot.model.AttachPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.AttachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.CancelJobRequest;\n+import software.amazon.awssdk.services.iot.model.CertificateStatus;\n+import software.amazon.awssdk.services.iot.model.CreateJobRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateResponse;\n+import software.amazon.awssdk.services.iot.model.CreatePolicyRequest;\n+import software.amazon.awssdk.services.iot.model.CreateThingRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteJobRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteThingRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeEndpointRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.DetachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.GetPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.InvalidRequestException;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+import software.amazon.awssdk.services.iot.model.KeyPair;\n+import software.amazon.awssdk.services.iot.model.ResourceNotFoundException;\n+import software.amazon.awssdk.services.iot.model.TargetSelection;\n+import software.amazon.awssdk.services.iot.model.TimeoutConfig;\n+import software.amazon.awssdk.services.iot.model.UpdateCertificateRequest;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.TimeoutException;\n+\n+public class Utils {\n+    public static final IotClient iotClient = IotClient.builder().build();\n+    private static final String FULL_ACCESS_POLICY_NAME = \"E2ETestFullAccess\";\n+    private static final Set<ThingInfo> createdThings = new CopyOnWriteArraySet<>();\n+    private static final Set<String> createdJobs = new CopyOnWriteArraySet<>();\n+    private static final String ROOT_CA_URL = \"https://www.amazontrust.com/repository/AmazonRootCA1.pem\";\n+    private static final int DEFAULT_RETRIES = 5;\n+    private static final int DEFAULT_INITIAL_BACKOFF_MS = 100;\n+\n+    public static String createJob(String document, String[] targets) {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        retry(() -> iotClient.createJob(\n+                CreateJobRequest.builder().jobId(jobId).targets(targets).targetSelection(TargetSelection.SNAPSHOT)\n+                        .document(document).description(\"E2E Test: \" + new Date())\n+                        .timeoutConfig(TimeoutConfig.builder().inProgressTimeoutInMinutes(10L).build()).build()));\n+        createdJobs.add(jobId);\n+        return jobId;\n+    }\n+\n+    public static void waitForJobToComplete(String jobId, Duration timeout) throws TimeoutException {\n+        Instant start = Instant.now();\n+\n+        while (start.plusMillis(timeout.toMillis()).isAfter(Instant.now())) {\n+            JobStatus status =\n+                    retry(() -> iotClient.describeJob(DescribeJobRequest.builder().jobId(jobId).build())).job()\n+                            .status();\n+            if (status.ordinal() > JobStatus.IN_PROGRESS.ordinal()) {\n+                return;\n+            }\n+        }\n+        throw new TimeoutException();\n+    }\n+\n+    public static ThingInfo createThing() {\n+        // Find or create IoT policy\n+        try {\n+            retry(() -> iotClient.getPolicy(GetPolicyRequest.builder().policyName(FULL_ACCESS_POLICY_NAME).build()),\n+                    ResourceNotFoundException.class);\n+        } catch (ResourceNotFoundException e) {\n+            retry(() -> iotClient.createPolicy(CreatePolicyRequest.builder().policyName(FULL_ACCESS_POLICY_NAME)\n+                    .policyDocument(\"{\\n  \\\"Version\\\": \\\"2012-10-17\\\",\\n  \\\"Statement\\\": [\\n    {\\n\"\n+                            + \"      \\\"Effect\\\": \\\"Allow\\\",\\n      \\\"Action\\\": [\\n\"\n+                            + \"                \\\"iot:Connect\\\",\\n                \\\"iot:Publish\\\",\\n\"\n+                            + \"                \\\"iot:Subscribe\\\",\\n                \\\"iot:Receive\\\"\\n],\\n\"\n+                            + \"      \\\"Resource\\\": \\\"*\\\"\\n    }\\n  ]\\n}\").build()));\n+        }\n+\n+        // Create cert\n+        CreateKeysAndCertificateResponse keyResponse = retry(() -> iotClient\n+                .createKeysAndCertificate(CreateKeysAndCertificateRequest.builder().setAsActive(true).build()));\n+\n+        // Attach policy to cert\n+        retry(() -> iotClient.attachPolicy(\n+                AttachPolicyRequest.builder().policyName(FULL_ACCESS_POLICY_NAME).target(keyResponse.certificateArn())\n+                        .build()));\n+\n+        // Create the thing and attach the cert to it\n+        String thingName = \"e2etest-\" + UUID.randomUUID().toString();\n+        String thingArn = retry(() -> iotClient.createThing(CreateThingRequest.builder().thingName(thingName).build()))\n+                .thingArn();\n+        retry(() -> iotClient.attachThingPrincipal(\n+                AttachThingPrincipalRequest.builder().thingName(thingName).principal(keyResponse.certificateArn())\n+                        .build()));\n+\n+        ThingInfo info = new ThingInfo(thingArn, thingName, keyResponse.certificateArn(), keyResponse.certificateId(),\n+                keyResponse.certificatePem(), keyResponse.keyPair(), retry(() -> iotClient\n+                .describeEndpoint(DescribeEndpointRequest.builder().endpointType(\"iot:Data-ATS\").build()))\n+                .endpointAddress());\n+        createdThings.add(info);\n+        return info;\n+    }\n+\n+    public static void cleanAllCreatedThings() {\n+        createdThings.forEach(Utils::cleanThing);\n+    }\n+\n+    public static void cleanAllCreatedJobs() {\n+        createdJobs.forEach(Utils::cleanJob);\n+    }\n+\n+    public static void cleanThing(ThingInfo thing) {\n+        retry(() -> iotClient.detachThingPrincipal(\n+                DetachThingPrincipalRequest.builder().thingName(thing.thingName).principal(thing.certificateArn)\n+                        .build()));\n+        retry(() -> iotClient.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build()));\n+        retry(() -> iotClient.updateCertificate(UpdateCertificateRequest.builder().certificateId(thing.certificateId)\n+                .newStatus(CertificateStatus.INACTIVE).build()));\n+        retry(() -> iotClient.deleteCertificate(\n+                DeleteCertificateRequest.builder().certificateId(thing.certificateId).forceDelete(true).build()));\n+        createdThings.remove(thing);\n+    }\n+\n+    public static void cleanJob(String jobId) {\n+        try {\n+            retry(() -> iotClient.cancelJob(CancelJobRequest.builder().jobId(jobId).force(true).build()),\n+                    InvalidRequestException.class);\n+        } catch (InvalidRequestException e) {\n+            // Ignore can't cancel due to job already completed\n+            if (!e.getMessage().contains(\"in status COMPLETED cannot\")) {\n+                throw e;\n+            }\n+        }\n+        retry(() -> iotClient.deleteJob(DeleteJobRequest.builder().jobId(jobId).force(true).build()));\n+        createdJobs.remove(jobId);\n+    }\n+\n+    public static void downloadRootCAToFile(File f) throws IOException {\n+        downloadFileFromURL(ROOT_CA_URL, f);\n+    }\n+\n+    public static void downloadFileFromURL(String url, File f) throws IOException {\n+        try (ReadableByteChannel readableByteChannel = Channels.newChannel(new URL(url).openStream());\n+             FileOutputStream fileOutputStream = new FileOutputStream(f)) {\n+            fileOutputStream.getChannel().transferFrom(readableByteChannel, 0, Long.MAX_VALUE);\n+        }\n+    }\n+\n+    @AllArgsConstructor\n+    public static class ThingInfo {\n+        public String thingArn;\n+        public String thingName;\n+        public String certificateArn;\n+        public String certificateId;\n+        public String certificatePem;\n+        public KeyPair keyPair;\n+        public String endpoint;\n+    }\n+\n+    @SafeVarargs\n+    public static <T, E extends Throwable> T retry(CrashableSupplier<T, E> func, Class<E>... nonRetryable) throws E {", "originalCommit": "656749d351d506c73e8b779e6c749609101f0724", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4NDI0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r395784246", "bodyText": "Flipped it to be retryable list instead of non-retryable list.", "author": "MikeDombo", "createdAt": "2020-03-20T17:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5Njk4OA=="}], "type": "inlineReview"}, {"oid": "ee67a53a3b7b194a3186b70b63d86ca0c7a696b8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ee67a53a3b7b194a3186b70b63d86ca0c7a696b8", "message": "Add retries for IoT Core operations. Scoped down IoT Core Policy", "committedDate": "2020-03-20T01:08:59Z", "type": "forcePushed"}, {"oid": "5dd7a15ef0a4bf25ec5ca68be8372bd8e7a02a82", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5dd7a15ef0a4bf25ec5ca68be8372bd8e7a02a82", "message": "Add retries for IoT Core operations. Scoped down IoT Core Policy", "committedDate": "2020-03-20T17:22:27Z", "type": "forcePushed"}, {"oid": "e43625494fcb1704a0f08638e558aa5d6bbb57b2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e43625494fcb1704a0f08638e558aa5d6bbb57b2", "message": "Breakout E2E test", "committedDate": "2020-03-20T18:02:43Z", "type": "forcePushed"}, {"oid": "ddaa690bcac2eab09eed33c3cfcfc418724b8928", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ddaa690bcac2eab09eed33c3cfcfc418724b8928", "message": "Breakout E2E test", "committedDate": "2020-03-20T18:17:36Z", "type": "forcePushed"}, {"oid": "019ec3ae0476de5322108b553c0bd9e36f1252cf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/019ec3ae0476de5322108b553c0bd9e36f1252cf", "message": "Breakout E2E test", "committedDate": "2020-03-20T19:07:36Z", "type": "forcePushed"}, {"oid": "9a1c8ea527db198fcaf64f09a9074c1c00a34625", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9a1c8ea527db198fcaf64f09a9074c1c00a34625", "message": "E2E Deployment test with IoT Jobs", "committedDate": "2020-03-22T01:40:21Z", "type": "commit"}, {"oid": "714f5928ce0a813a4eccf89b5b56b22f6b014889", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/714f5928ce0a813a4eccf89b5b56b22f6b014889", "message": "Add retries for IoT Core operations. Scoped down IoT Core Policy", "committedDate": "2020-03-22T01:40:21Z", "type": "commit"}, {"oid": "07f6a0cbd6d23780c352a88b0a6c87e564c2158e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/07f6a0cbd6d23780c352a88b0a6c87e564c2158e", "message": "Breakout E2E test", "committedDate": "2020-03-22T01:41:13Z", "type": "forcePushed"}, {"oid": "7a2850a1332076e769e8aaa3f79312882de83013", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7a2850a1332076e769e8aaa3f79312882de83013", "message": "Breakout E2E test", "committedDate": "2020-03-22T02:02:47Z", "type": "forcePushed"}, {"oid": "c87dbd45d6719bdedaf857bbaf63400fd78d92e7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c87dbd45d6719bdedaf857bbaf63400fd78d92e7", "message": "Breakout E2E test", "committedDate": "2020-03-22T02:35:12Z", "type": "forcePushed"}, {"oid": "fda112ff2eb27d08f24146a2f7b8f81cd50d7362", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fda112ff2eb27d08f24146a2f7b8f81cd50d7362", "message": "Breakout E2E test", "committedDate": "2020-03-22T03:31:27Z", "type": "forcePushed"}, {"oid": "3bb27a6ba0b7a2d211747251f5456d2d72a0eae1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3bb27a6ba0b7a2d211747251f5456d2d72a0eae1", "message": "Breakout E2E test", "committedDate": "2020-03-22T03:53:45Z", "type": "forcePushed"}, {"oid": "d2c3578c87ae3b9c652e185d4f0f02bfac39c89f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d2c3578c87ae3b9c652e185d4f0f02bfac39c89f", "message": "Breakout E2E test", "committedDate": "2020-03-22T04:10:42Z", "type": "forcePushed"}, {"oid": "75ffce92082d2008f46114d4a20ac2b36013df9c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/75ffce92082d2008f46114d4a20ac2b36013df9c", "message": "Breakout E2E test", "committedDate": "2020-03-22T04:23:27Z", "type": "commit"}, {"oid": "75ffce92082d2008f46114d4a20ac2b36013df9c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/75ffce92082d2008f46114d4a20ac2b36013df9c", "message": "Breakout E2E test", "committedDate": "2020-03-22T04:23:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4Nzg0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r396587842", "bodyText": "Are there existing libraries supporting the retry behavior?", "author": "ShirleyZheng92", "createdAt": "2020-03-23T16:33:13Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -0,0 +1,221 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.util.CrashableSupplier;\n+import lombok.AllArgsConstructor;\n+import software.amazon.awssdk.services.iot.IotClient;\n+import software.amazon.awssdk.services.iot.model.AttachPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.AttachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.CancelJobRequest;\n+import software.amazon.awssdk.services.iot.model.CertificateStatus;\n+import software.amazon.awssdk.services.iot.model.CreateJobRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateResponse;\n+import software.amazon.awssdk.services.iot.model.CreatePolicyRequest;\n+import software.amazon.awssdk.services.iot.model.CreateThingRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteJobRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteThingRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeEndpointRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.DetachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.GetPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.InternalException;\n+import software.amazon.awssdk.services.iot.model.InternalFailureException;\n+import software.amazon.awssdk.services.iot.model.InvalidRequestException;\n+import software.amazon.awssdk.services.iot.model.IotException;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+import software.amazon.awssdk.services.iot.model.KeyPair;\n+import software.amazon.awssdk.services.iot.model.LimitExceededException;\n+import software.amazon.awssdk.services.iot.model.ResourceNotFoundException;\n+import software.amazon.awssdk.services.iot.model.TargetSelection;\n+import software.amazon.awssdk.services.iot.model.ThrottlingException;\n+import software.amazon.awssdk.services.iot.model.TimeoutConfig;\n+import software.amazon.awssdk.services.iot.model.UpdateCertificateRequest;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.TimeoutException;\n+\n+public class Utils {\n+    public static final IotClient iotClient = IotClient.builder().build();\n+    private static final String FULL_ACCESS_POLICY_NAME = \"E2ETestFullAccess\";\n+    private static final Set<ThingInfo> createdThings = new CopyOnWriteArraySet<>();\n+    private static final Set<String> createdJobs = new CopyOnWriteArraySet<>();\n+    private static final String ROOT_CA_URL = \"https://www.amazontrust.com/repository/AmazonRootCA1.pem\";\n+    private static final int DEFAULT_RETRIES = 5;\n+    private static final int DEFAULT_INITIAL_BACKOFF_MS = 100;\n+\n+    public static String createJob(String document, String[] targets) {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        retryIot(() -> iotClient.createJob(\n+                CreateJobRequest.builder().jobId(jobId).targets(targets).targetSelection(TargetSelection.SNAPSHOT)\n+                        .document(document).description(\"E2E Test: \" + new Date())\n+                        .timeoutConfig(TimeoutConfig.builder().inProgressTimeoutInMinutes(10L).build()).build()));\n+        createdJobs.add(jobId);\n+        return jobId;\n+    }\n+\n+    public static void waitForJobToComplete(String jobId, Duration timeout) throws TimeoutException {\n+        Instant start = Instant.now();\n+\n+        while (start.plusMillis(timeout.toMillis()).isAfter(Instant.now())) {\n+            JobStatus status =\n+                    retryIot(() -> iotClient.describeJob(DescribeJobRequest.builder().jobId(jobId).build())).job()\n+                            .status();\n+            if (status.ordinal() > JobStatus.IN_PROGRESS.ordinal()) {\n+                return;\n+            }\n+        }\n+        throw new TimeoutException();\n+    }\n+\n+    public static ThingInfo createThing() {\n+        // Find or create IoT policy\n+        try {\n+            retryIot(() -> iotClient.getPolicy(GetPolicyRequest.builder().policyName(FULL_ACCESS_POLICY_NAME).build()));\n+        } catch (ResourceNotFoundException e) {\n+            retryIot(() -> iotClient.createPolicy(CreatePolicyRequest.builder().policyName(FULL_ACCESS_POLICY_NAME)\n+                    .policyDocument(\"{\\n  \\\"Version\\\": \\\"2012-10-17\\\",\\n  \\\"Statement\\\": [\\n    {\\n\"\n+                            + \"      \\\"Effect\\\": \\\"Allow\\\",\\n      \\\"Action\\\": [\\n\"\n+                            + \"                \\\"iot:Connect\\\",\\n                \\\"iot:Publish\\\",\\n\"\n+                            + \"                \\\"iot:Subscribe\\\",\\n                \\\"iot:Receive\\\"\\n],\\n\"\n+                            + \"      \\\"Resource\\\": \\\"*\\\"\\n    }\\n  ]\\n}\").build()));\n+        }\n+\n+        // Create cert\n+        CreateKeysAndCertificateResponse keyResponse = retryIot(() -> iotClient\n+                .createKeysAndCertificate(CreateKeysAndCertificateRequest.builder().setAsActive(true).build()));\n+\n+        // Attach policy to cert\n+        retryIot(() -> iotClient.attachPolicy(\n+                AttachPolicyRequest.builder().policyName(FULL_ACCESS_POLICY_NAME).target(keyResponse.certificateArn())\n+                        .build()));\n+\n+        // Create the thing and attach the cert to it\n+        String thingName = \"e2etest-\" + UUID.randomUUID().toString();\n+        String thingArn =\n+                retryIot(() -> iotClient.createThing(CreateThingRequest.builder().thingName(thingName).build()))\n+                        .thingArn();\n+        retryIot(() -> iotClient.attachThingPrincipal(\n+                AttachThingPrincipalRequest.builder().thingName(thingName).principal(keyResponse.certificateArn())\n+                        .build()));\n+\n+        ThingInfo info = new ThingInfo(thingArn, thingName, keyResponse.certificateArn(), keyResponse.certificateId(),\n+                keyResponse.certificatePem(), keyResponse.keyPair(), retryIot(() -> iotClient\n+                .describeEndpoint(DescribeEndpointRequest.builder().endpointType(\"iot:Data-ATS\").build()))\n+                .endpointAddress());\n+        createdThings.add(info);\n+        return info;\n+    }\n+\n+    public static void cleanAllCreatedThings() {\n+        createdThings.forEach(Utils::cleanThing);\n+    }\n+\n+    public static void cleanAllCreatedJobs() {\n+        createdJobs.forEach(Utils::cleanJob);\n+    }\n+\n+    public static void cleanThing(ThingInfo thing) {\n+        retryIot(() -> iotClient.detachThingPrincipal(\n+                DetachThingPrincipalRequest.builder().thingName(thing.thingName).principal(thing.certificateArn)\n+                        .build()));\n+        retryIot(() -> iotClient.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build()));\n+        retryIot(() -> iotClient.updateCertificate(UpdateCertificateRequest.builder().certificateId(thing.certificateId)\n+                .newStatus(CertificateStatus.INACTIVE).build()));\n+        retryIot(() -> iotClient.deleteCertificate(\n+                DeleteCertificateRequest.builder().certificateId(thing.certificateId).forceDelete(true).build()));\n+        createdThings.remove(thing);\n+    }\n+\n+    public static void cleanJob(String jobId) {\n+        try {\n+            retryIot(() -> iotClient.cancelJob(CancelJobRequest.builder().jobId(jobId).force(true).build()));\n+        } catch (InvalidRequestException e) {\n+            // Ignore can't cancel due to job already completed\n+            if (!e.getMessage().contains(\"in status COMPLETED cannot\")) {\n+                throw e;\n+            }\n+        }\n+        retryIot(() -> iotClient.deleteJob(DeleteJobRequest.builder().jobId(jobId).force(true).build()));\n+        createdJobs.remove(jobId);\n+    }\n+\n+    public static void downloadRootCAToFile(File f) throws IOException {\n+        downloadFileFromURL(ROOT_CA_URL, f);\n+    }\n+\n+    public static void downloadFileFromURL(String url, File f) throws IOException {\n+        try (ReadableByteChannel readableByteChannel = Channels.newChannel(new URL(url).openStream());\n+             FileOutputStream fileOutputStream = new FileOutputStream(f)) {\n+            fileOutputStream.getChannel().transferFrom(readableByteChannel, 0, Long.MAX_VALUE);\n+        }\n+    }\n+\n+    @AllArgsConstructor\n+    public static class ThingInfo {\n+        public String thingArn;\n+        public String thingName;\n+        public String certificateArn;\n+        public String certificateId;\n+        public String certificatePem;\n+        public KeyPair keyPair;\n+        public String endpoint;\n+    }\n+\n+    public static <T, E extends IotException> T retryIot(CrashableSupplier<T, E> func) throws E {\n+        return retry(DEFAULT_RETRIES, DEFAULT_INITIAL_BACKOFF_MS, func, ThrottlingException.class,\n+                InternalException.class, InternalFailureException.class, LimitExceededException.class);\n+    }\n+\n+    @SafeVarargs\n+    public static <T, E extends Throwable> T retry(int tries, int initialBackoffMillis, CrashableSupplier<T, E> func,", "originalCommit": "75ffce92082d2008f46114d4a20ac2b36013df9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxODgwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r396618804", "bodyText": "Yes, but why bring in a library for 15 lines of code? We want to minimize our footprint.", "author": "MikeDombo", "createdAt": "2020-03-23T17:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4Nzg0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxNTQ5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r396615492", "bodyText": "nit: change it to FILEPATH", "author": "abanthiy", "createdAt": "2020-03-23T17:11:52Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.EvergreenService;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.util.CommitableFile;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.UUID;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_MQTT_CLIENT_ENDPOINT;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_ROOT_CA_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_THING_NAME;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@Tag(\"E2E\")\n+public class DeploymentE2ETest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static String ROOT_CA_FILENAME;\n+    private static String PRIVATE_KEY_FILENAME;\n+    private static String CERTIFICATE_FILENAME;\n+    private static final Path LOCAL_CACHE_PATH =\n+            Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+        ROOT_CA_FILENAME = tempRootDir.resolve(\"rootCA.pem\").toString();\n+        PRIVATE_KEY_FILENAME = tempRootDir.resolve(\"privKey.key\").toString();\n+        CERTIFICATE_FILENAME = tempRootDir.resolve(\"thingCert.crt\").toString();", "originalCommit": "75ffce92082d2008f46114d4a20ac2b36013df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxODY5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r396618691", "bodyText": "We are going to use thing groups as targets when creating jobs using Iot Jobs. For individual devices we will use shadows (which is not implemented yet). So this will need to evolve to use Iot Thing groups. Don't want to block this PR because of this but add a TODO to make that change.", "author": "abanthiy", "createdAt": "2020-03-23T17:16:21Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.EvergreenService;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.util.CommitableFile;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.UUID;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_MQTT_CLIENT_ENDPOINT;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_ROOT_CA_PATH;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEVICE_PARAM_THING_NAME;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@Tag(\"E2E\")\n+public class DeploymentE2ETest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static String ROOT_CA_FILENAME;\n+    private static String PRIVATE_KEY_FILENAME;\n+    private static String CERTIFICATE_FILENAME;\n+    private static final Path LOCAL_CACHE_PATH =\n+            Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+        ROOT_CA_FILENAME = tempRootDir.resolve(\"rootCA.pem\").toString();\n+        PRIVATE_KEY_FILENAME = tempRootDir.resolve(\"privKey.key\").toString();\n+        CERTIFICATE_FILENAME = tempRootDir.resolve(\"thingCert.crt\").toString();\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Test\n+    void GIVEN_blank_kernel_WHEN_deploy_new_services_e2e_THEN_new_services_deployed_and_job_is_successful()\n+            throws Exception {\n+        // Setup IoT resources\n+        Utils.downloadRootCAToFile(new File(ROOT_CA_FILENAME));\n+        Utils.ThingInfo thing = Utils.createThing();\n+        try (CommitableFile cf = CommitableFile.of(new File(PRIVATE_KEY_FILENAME).toPath(), true)) {\n+            cf.write(thing.keyPair.privateKey().getBytes(StandardCharsets.UTF_8));\n+        }\n+        try (CommitableFile cf = CommitableFile.of(new File(CERTIFICATE_FILENAME).toPath(), true)) {\n+            cf.write(thing.certificatePem.getBytes(StandardCharsets.UTF_8));\n+        }\n+\n+        // Inject IoT resources into kernel\n+        Kernel kernel = new Kernel().parseArgs(\"-i\", getClass().getResource(\"blank_config.yaml\").toString());\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, \"DeploymentService\");\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_THING_NAME).setValue(thing.thingName);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_MQTT_CLIENT_ENDPOINT).setValue(thing.endpoint);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_PRIVATE_KEY_PATH).setValue(PRIVATE_KEY_FILENAME);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_CERTIFICATE_FILE_PATH).setValue(CERTIFICATE_FILENAME);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_ROOT_CA_PATH).setValue(ROOT_CA_FILENAME);\n+\n+        // Inject our mocked local package store\n+        kernel.context.getv(DependencyResolver.class)\n+                .put(new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel));\n+        kernel.launch();\n+\n+        // Create Job Doc\n+        String document = new ObjectMapper().writeValueAsString(\n+                DeploymentDocument.builder().timestamp(System.currentTimeMillis())\n+                        .deploymentId(UUID.randomUUID().toString()).rootPackages(Arrays.asList(\"CustomerApp\"))\n+                        .deploymentPackageConfigurationList(Arrays.asList(\n+                                new DeploymentPackageConfiguration(\"CustomerApp\", \"1.0.0\", null, null, null))).build());\n+\n+        // Create job targeting our DUT\n+        String[] targets = new String[]{thing.thingArn};", "originalCommit": "75ffce92082d2008f46114d4a20ac2b36013df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyNTY4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r396625681", "bodyText": "Sleep in else part and wait a bit before next query?", "author": "abanthiy", "createdAt": "2020-03-23T17:26:21Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -0,0 +1,221 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.util.CrashableSupplier;\n+import lombok.AllArgsConstructor;\n+import software.amazon.awssdk.services.iot.IotClient;\n+import software.amazon.awssdk.services.iot.model.AttachPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.AttachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.CancelJobRequest;\n+import software.amazon.awssdk.services.iot.model.CertificateStatus;\n+import software.amazon.awssdk.services.iot.model.CreateJobRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateResponse;\n+import software.amazon.awssdk.services.iot.model.CreatePolicyRequest;\n+import software.amazon.awssdk.services.iot.model.CreateThingRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteJobRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteThingRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeEndpointRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.DetachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.GetPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.InternalException;\n+import software.amazon.awssdk.services.iot.model.InternalFailureException;\n+import software.amazon.awssdk.services.iot.model.InvalidRequestException;\n+import software.amazon.awssdk.services.iot.model.IotException;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+import software.amazon.awssdk.services.iot.model.KeyPair;\n+import software.amazon.awssdk.services.iot.model.LimitExceededException;\n+import software.amazon.awssdk.services.iot.model.ResourceNotFoundException;\n+import software.amazon.awssdk.services.iot.model.TargetSelection;\n+import software.amazon.awssdk.services.iot.model.ThrottlingException;\n+import software.amazon.awssdk.services.iot.model.TimeoutConfig;\n+import software.amazon.awssdk.services.iot.model.UpdateCertificateRequest;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.TimeoutException;\n+\n+public class Utils {\n+    public static final IotClient iotClient = IotClient.builder().build();\n+    private static final String FULL_ACCESS_POLICY_NAME = \"E2ETestFullAccess\";\n+    private static final Set<ThingInfo> createdThings = new CopyOnWriteArraySet<>();\n+    private static final Set<String> createdJobs = new CopyOnWriteArraySet<>();\n+    private static final String ROOT_CA_URL = \"https://www.amazontrust.com/repository/AmazonRootCA1.pem\";\n+    private static final int DEFAULT_RETRIES = 5;\n+    private static final int DEFAULT_INITIAL_BACKOFF_MS = 100;\n+\n+    public static String createJob(String document, String[] targets) {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        retryIot(() -> iotClient.createJob(\n+                CreateJobRequest.builder().jobId(jobId).targets(targets).targetSelection(TargetSelection.SNAPSHOT)\n+                        .document(document).description(\"E2E Test: \" + new Date())\n+                        .timeoutConfig(TimeoutConfig.builder().inProgressTimeoutInMinutes(10L).build()).build()));\n+        createdJobs.add(jobId);\n+        return jobId;\n+    }\n+\n+    public static void waitForJobToComplete(String jobId, Duration timeout) throws TimeoutException {\n+        Instant start = Instant.now();\n+\n+        while (start.plusMillis(timeout.toMillis()).isAfter(Instant.now())) {\n+            JobStatus status =\n+                    retryIot(() -> iotClient.describeJob(DescribeJobRequest.builder().jobId(jobId).build())).job()\n+                            .status();\n+            if (status.ordinal() > JobStatus.IN_PROGRESS.ordinal()) {\n+                return;\n+            }", "originalCommit": "75ffce92082d2008f46114d4a20ac2b36013df9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77d5370144d216c313cf3a5dcda01426cb1c4f06", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77d5370144d216c313cf3a5dcda01426cb1c4f06", "message": "Address PR comments", "committedDate": "2020-03-23T17:49:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY2NTcxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r396665718", "bodyText": "Thanks for cleaning this!", "author": "fengwang666", "createdAt": "2020-03-23T18:25:13Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -197,9 +195,6 @@ public static EvergreenService locate(Context context, String name) throws Servi\n                 try {\n                     clazz = Class.forName(cn);\n                 } catch (Throwable ex) {\n-                    staticLogger.atError().setEventType(\"service-load-error\")\n-                            .addKeyValue(\"serviceName\", name)\n-                            .addKeyValue(\"className\", cn).log(\"Can't load service class\");", "originalCommit": "77d5370144d216c313cf3a5dcda01426cb1c4f06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY2NzEzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/126#discussion_r396667139", "bodyText": "Nit: rename it to AwsIoTUtils to be more specific?", "author": "fengwang666", "createdAt": "2020-03-23T18:26:58Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.util.CrashableSupplier;\n+import lombok.AllArgsConstructor;\n+import software.amazon.awssdk.services.iot.IotClient;\n+import software.amazon.awssdk.services.iot.model.AttachPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.AttachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.CancelJobRequest;\n+import software.amazon.awssdk.services.iot.model.CertificateStatus;\n+import software.amazon.awssdk.services.iot.model.CreateJobRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.CreateKeysAndCertificateResponse;\n+import software.amazon.awssdk.services.iot.model.CreatePolicyRequest;\n+import software.amazon.awssdk.services.iot.model.CreateThingRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteCertificateRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteJobRequest;\n+import software.amazon.awssdk.services.iot.model.DeleteThingRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeEndpointRequest;\n+import software.amazon.awssdk.services.iot.model.DescribeJobRequest;\n+import software.amazon.awssdk.services.iot.model.DetachThingPrincipalRequest;\n+import software.amazon.awssdk.services.iot.model.GetPolicyRequest;\n+import software.amazon.awssdk.services.iot.model.InternalException;\n+import software.amazon.awssdk.services.iot.model.InternalFailureException;\n+import software.amazon.awssdk.services.iot.model.InvalidRequestException;\n+import software.amazon.awssdk.services.iot.model.IotException;\n+import software.amazon.awssdk.services.iot.model.JobStatus;\n+import software.amazon.awssdk.services.iot.model.KeyPair;\n+import software.amazon.awssdk.services.iot.model.LimitExceededException;\n+import software.amazon.awssdk.services.iot.model.ResourceNotFoundException;\n+import software.amazon.awssdk.services.iot.model.TargetSelection;\n+import software.amazon.awssdk.services.iot.model.ThrottlingException;\n+import software.amazon.awssdk.services.iot.model.TimeoutConfig;\n+import software.amazon.awssdk.services.iot.model.UpdateCertificateRequest;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.TimeoutException;\n+\n+public class Utils {", "originalCommit": "77d5370144d216c313cf3a5dcda01426cb1c4f06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}