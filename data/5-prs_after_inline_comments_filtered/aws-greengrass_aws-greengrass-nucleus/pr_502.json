{"pr_number": 502, "pr_title": "Fix deployment sync issue causing cancellation to break and post comp\u2026", "pr_createdAt": "2020-10-06T16:41:42Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502", "timeline": [{"oid": "0316163a2bcd2e369fb1c87907c6b038dff16227", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0316163a2bcd2e369fb1c87907c6b038dff16227", "message": "Fix deployment sync issue causing cancellation to break and post component updates to be sent prematurely", "committedDate": "2020-10-06T16:46:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500476894", "bodyText": "this blocks the publish queue, doesn't it need to be unblocked to actually process the deployment?", "author": "MikeDombo", "createdAt": "2020-10-06T17:34:44Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -79,41 +79,50 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n         // wait until topic listeners finished processing mergeMap changes.\n         kernel.getContext().runOnPublishQueue(() -> {\n             // polling to wait for all services to be started.\n-            kernel.getContext().get(ExecutorService.class).execute(() -> {\n-                //TODO: Add timeout\n-                try {\n-                    servicesChangeManager.startNewServices();\n-\n-                    // Restart any services that may have been broken before this deployment\n-                    // This is added to allow deployments to fix broken services\n-                    servicesChangeManager.reinstallBrokenServices();\n-\n-                    Set<GreengrassService> servicesToTrack = servicesChangeManager.servicesToTrack();\n-                    logger.atDebug(MERGE_CONFIG_EVENT_KEY).kv(\"serviceToTrack\", servicesToTrack)\n-                            .log(\"Applied new service config. Waiting for services to complete update\");\n-\n-                    waitForServicesToStart(servicesToTrack, mergeTime);\n-                    logger.atDebug(MERGE_CONFIG_EVENT_KEY).log(\"new/updated services are running, will now remove\"\n-                            + \" old services\");\n-                    servicesChangeManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n-                            .log(\"All services updated\");\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.SUCCESSFUL, null));\n-                } catch (ServiceLoadException | InterruptedException | ServiceUpdateException\n-                        | ExecutionException e) {\n-                    logger.atError(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId).setCause(e)\n-                            .log(\"Deployment failed\");\n-                    if (isAutoRollbackRequested(deploymentDocument)) {\n-                        rollback(deploymentDocument, totallyCompleteFuture, e,\n-                                servicesChangeManager.createRollbackManager());\n-                    } else {\n-                        totallyCompleteFuture.complete(new DeploymentResult(\n-                                DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_NOT_REQUESTED, e));\n+            try {\n+                kernel.getContext().get(ExecutorService.class).submit(() -> {\n+                    try {\n+                        servicesChangeManager.startNewServices();\n+                        // Restart any services that may have been broken before this deployment\n+                        // This is added to allow deployments to fix broken services\n+                        servicesChangeManager.reinstallBrokenServices();\n+                    } catch (ServiceLoadException e) {\n+                        handleFailure(servicesChangeManager, deploymentDocument, totallyCompleteFuture, e);\n                     }\n-                }\n-            });\n+                }).get();", "originalCommit": "0316163a2bcd2e369fb1c87907c6b038dff16227", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NzgyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500477827", "bodyText": "Also, it blocks and can't be unblocked by cancellation which doesn't seem right", "author": "MikeDombo", "createdAt": "2020-10-06T17:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NDM4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500484387", "bodyText": "This is only requesting starts/reinstalls for services which should be quick and the individual lifecycle threads can run their state changes on the publish queue right after. And that will be monitored by the wait logic below. I don't see why it would block in a way that deployment cannot be processed?", "author": "shaguptashaikh", "createdAt": "2020-10-06T17:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NTA0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500485042", "bodyText": "Or you mean for failure cases it will stop services from making any changes before trying to handle the failure first ?", "author": "shaguptashaikh", "createdAt": "2020-10-06T17:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NjUzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500486538", "bodyText": "If you're only starting and reinstalling, does it need to be in a separate thread at all? Those aren't blocking methods AFAIK.", "author": "MikeDombo", "createdAt": "2020-10-06T17:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4OTk4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500489981", "bodyText": "Maybe not, it was just there since everything including waiting was combined and waiting had to happen without blocking the queue. let me see if it can be changed", "author": "shaguptashaikh", "createdAt": "2020-10-06T17:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5MTUxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500491515", "bodyText": "If you don't want to block the queue, then you shouldn't be calling .get(), since that's blocking it anyway", "author": "MikeDombo", "createdAt": "2020-10-06T17:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyMzE1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500523155", "bodyText": "I'm blocking until service starts/reinstalls have been requested so that the desired state is set for all services before the waiting logic starts monitoring if services reached those desired states or not", "author": "shaguptashaikh", "createdAt": "2020-10-06T18:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyNTU1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500525554", "bodyText": "So, since the queue is blocked anyway, you may as well just run those requests in the queue thread", "author": "MikeDombo", "createdAt": "2020-10-06T18:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Njg5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4ODAzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r500488035", "bodyText": "why change this? How is it any different from before?", "author": "MikeDombo", "createdAt": "2020-10-06T17:53:36Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateSystemSafelyService.java", "diffHunk": "@@ -159,12 +155,17 @@ protected void startup() throws InterruptedException {\n                 try {\n                     context.get(ExecutorService.class).submit(() -> {\n                         logger.atInfo().setEventType(\"service-update-start\").log();\n+                        runningUpdateActions.set(true);\n+\n                         runUpdateActions();\n+                        pendingActions.clear();", "originalCommit": "0316163a2bcd2e369fb1c87907c6b038dff16227", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e80d1afe49a03c392a973a5c573c3e853101e3e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2e80d1afe49a03c392a973a5c573c3e853101e3e", "message": "Fix deployment sync issue causing cancellation to break and post component updates to be sent prematurely", "committedDate": "2020-10-07T16:02:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM2MzI0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r501363247", "bodyText": "Nice! this simplifies the threading model a lot", "author": "fahadmohammed01", "createdAt": "2020-10-07T23:18:15Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -128,35 +140,47 @@ void rollback(DeploymentDocument deploymentDocument, CompletableFuture<Deploymen\n             return;\n         }\n         // wait until topic listeners finished processing read changes.\n+        AtomicBoolean setDesiredStatesFailed = new AtomicBoolean();\n+        AtomicReference<Throwable> setDesiredStateFailureCause = new AtomicReference<>();\n         kernel.getContext().runOnPublishQueue(() -> {\n             // polling to wait for all services to be started.\n-            kernel.getContext().get(ExecutorService.class).execute(() -> {\n-                // TODO: Add timeout\n-                try {\n-                    rollbackManager.startNewServices();\n-                    rollbackManager.reinstallBrokenServices();\n-\n-                    Set<GreengrassService> servicesToTrackForRollback = rollbackManager.servicesToTrack();\n-\n-                    waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n-\n-                    rollbackManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n-                            .log(\"All services rolled back\");\n-\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, failureCause));\n-                } catch (InterruptedException | ServiceUpdateException | ExecutionException\n-                        | ServiceLoadException e) {\n-                    // Rollback execution failed\n-                    logger.atError().setEventType(MERGE_ERROR_LOG_EVENT_KEY).setCause(e)\n-                            .log(\"Failed to rollback deployment\");\n-                    // TODO : Run user provided script to reach user defined safe state and\n-                    //  set deployment status based on the success of the script run\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.FAILED_UNABLE_TO_ROLLBACK, failureCause));\n-                }\n-            });\n+            try {", "originalCommit": "2e80d1afe49a03c392a973a5c573c3e853101e3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb08726b915f9091d49ad939de37b6c9643ce314", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb08726b915f9091d49ad939de37b6c9643ce314", "message": "Higher timeout for hard dependency remove integ test", "committedDate": "2020-10-08T00:59:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0MTYxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504341610", "bodyText": "Are services stopped before the updated config is applied?", "author": "philcali", "createdAt": "2020-10-14T01:04:05Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -77,43 +78,56 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n                 kernel.getConfig().updateMap(deploymentDocument.getTimestamp(), newConfig, DEPLOYMENT_MERGE_BEHAVIOR));", "originalCommit": "d81768f0e46854468f0a36105120ee1131a2998a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NDMzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504794331", "bodyText": "No, the listeners triggered by updateMap handle the stop and restart as part of the service lifecycle threads. For any services that become obsolete after the update, there's a remove step at the end of the workflow", "author": "shaguptashaikh", "createdAt": "2020-10-14T15:59:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0MTYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0MjQwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504342402", "bodyText": "Isn't the presence of a Throwable evidence that setDesiredStatesFailed? Why have both?", "author": "philcali", "createdAt": "2020-10-14T01:06:57Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -77,43 +78,56 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n                 kernel.getConfig().updateMap(deploymentDocument.getTimestamp(), newConfig, DEPLOYMENT_MERGE_BEHAVIOR));\n \n         // wait until topic listeners finished processing mergeMap changes.\n+        kernel.getContext().runOnPublishQueueAndWait(() -> {});\n+\n+        AtomicBoolean setDesiredStatesFailed = new AtomicBoolean();\n+        AtomicReference<Throwable> setDesiredStateFailureCause = new AtomicReference<>();", "originalCommit": "d81768f0e46854468f0a36105120ee1131a2998a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NDU1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504794555", "bodyText": "Right, removed it", "author": "shaguptashaikh", "createdAt": "2020-10-14T15:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0MjQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0MzIxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504343212", "bodyText": "There was a add timeout comment above... is that still relevant?", "author": "philcali", "createdAt": "2020-10-14T01:10:11Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -77,43 +78,56 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n                 kernel.getConfig().updateMap(deploymentDocument.getTimestamp(), newConfig, DEPLOYMENT_MERGE_BEHAVIOR));\n \n         // wait until topic listeners finished processing mergeMap changes.\n+        kernel.getContext().runOnPublishQueueAndWait(() -> {});\n+\n+        AtomicBoolean setDesiredStatesFailed = new AtomicBoolean();\n+        AtomicReference<Throwable> setDesiredStateFailureCause = new AtomicReference<>();\n         kernel.getContext().runOnPublishQueue(() -> {\n             // polling to wait for all services to be started.\n-            kernel.getContext().get(ExecutorService.class).execute(() -> {\n-                //TODO: Add timeout\n-                try {\n-                    servicesChangeManager.startNewServices();\n-\n-                    // Restart any services that may have been broken before this deployment\n-                    // This is added to allow deployments to fix broken services\n-                    servicesChangeManager.reinstallBrokenServices();\n-\n-                    Set<GreengrassService> servicesToTrack = servicesChangeManager.servicesToTrack();\n-                    logger.atDebug(MERGE_CONFIG_EVENT_KEY).kv(\"serviceToTrack\", servicesToTrack)\n-                            .log(\"Applied new service config. Waiting for services to complete update\");\n-\n-                    waitForServicesToStart(servicesToTrack, mergeTime);\n-                    logger.atDebug(MERGE_CONFIG_EVENT_KEY).log(\"new/updated services are running, will now remove\"\n-                            + \" old services\");\n-                    servicesChangeManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n-                            .log(\"All services updated\");\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.SUCCESSFUL, null));\n-                } catch (ServiceLoadException | InterruptedException | ServiceUpdateException\n-                        | ExecutionException e) {\n-                    logger.atError(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId).setCause(e)\n-                            .log(\"Deployment failed\");\n-                    if (isAutoRollbackRequested(deploymentDocument)) {\n-                        rollback(deploymentDocument, totallyCompleteFuture, e,\n-                                servicesChangeManager.createRollbackManager());\n-                    } else {\n-                        totallyCompleteFuture.complete(new DeploymentResult(\n-                                DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_NOT_REQUESTED, e));\n-                    }\n-                }\n-            });\n+            try {\n+                servicesChangeManager.startNewServices();\n+                // Restart any services that may have been broken before this deployment\n+                // This is added to allow deployments to fix broken services\n+                servicesChangeManager.reinstallBrokenServices();", "originalCommit": "d81768f0e46854468f0a36105120ee1131a2998a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5Njc1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504796753", "bodyText": "That was a really old comment that became irrelevant because deployment workflow really can't have a timeout since it can wait for an unknown time for a safe time to update, there are other guardrails like individual service lifecycle step timeouts and cancellation that ensure deployment doesn't turn the device into a brick", "author": "shaguptashaikh", "createdAt": "2020-10-14T16:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0MzIxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0MzQxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504343414", "bodyText": "Should these be logged?", "author": "philcali", "createdAt": "2020-10-14T01:10:49Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -128,35 +142,47 @@ void rollback(DeploymentDocument deploymentDocument, CompletableFuture<Deploymen\n             return;\n         }\n         // wait until topic listeners finished processing read changes.\n+        AtomicBoolean setDesiredStatesFailed = new AtomicBoolean();\n+        AtomicReference<Throwable> setDesiredStateFailureCause = new AtomicReference<>();\n         kernel.getContext().runOnPublishQueue(() -> {\n             // polling to wait for all services to be started.\n-            kernel.getContext().get(ExecutorService.class).execute(() -> {\n-                // TODO: Add timeout\n-                try {\n-                    rollbackManager.startNewServices();\n-                    rollbackManager.reinstallBrokenServices();\n-\n-                    Set<GreengrassService> servicesToTrackForRollback = rollbackManager.servicesToTrack();\n-\n-                    waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n-\n-                    rollbackManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n-                            .log(\"All services rolled back\");\n-\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, failureCause));\n-                } catch (InterruptedException | ServiceUpdateException | ExecutionException\n-                        | ServiceLoadException e) {\n-                    // Rollback execution failed\n-                    logger.atError().setEventType(MERGE_ERROR_LOG_EVENT_KEY).setCause(e)\n-                            .log(\"Failed to rollback deployment\");\n-                    // TODO : Run user provided script to reach user defined safe state and\n-                    //  set deployment status based on the success of the script run\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.FAILED_UNABLE_TO_ROLLBACK, failureCause));\n-                }\n-            });\n+            try {\n+                rollbackManager.startNewServices();\n+                rollbackManager.reinstallBrokenServices();\n+            } catch (ServiceLoadException e) {\n+                setDesiredStatesFailed.set(true);\n+                setDesiredStateFailureCause.set(e);\n+            }\n         });\n+        // Do not block the publish queue to handle failure in setting desired states for services\n+        if (setDesiredStatesFailed.get()) {\n+            handleFailureRollback(totallyCompleteFuture, failureCause, setDesiredStateFailureCause.get());\n+        }\n+\n+        try {\n+            Set<GreengrassService> servicesToTrackForRollback = rollbackManager.servicesToTrack();", "originalCommit": "d81768f0e46854468f0a36105120ee1131a2998a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NDc2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504794766", "bodyText": "Added a debug log similar to the rollforward action", "author": "shaguptashaikh", "createdAt": "2020-10-14T16:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0MzQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0NDAyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504344024", "bodyText": "This log does not seem relevant anymore.", "author": "philcali", "createdAt": "2020-10-14T01:13:20Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateSystemSafelyService.java", "diffHunk": "@@ -156,16 +155,10 @@ protected void startup() throws InterruptedException {\n             } else {\n                 lifecycleIPCAgent.discardDeferComponentUpdateFutures();\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();", "originalCommit": "d81768f0e46854468f0a36105120ee1131a2998a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5ODQwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r504798402", "bodyText": "I had to revet the changes to this class because it was failing in cases when deployment causes kernel restart and kernel shutdown has to stop this service, but since this startup thread would be running the deployment action it would fail to close gracefully", "author": "shaguptashaikh", "createdAt": "2020-10-14T16:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM0NDAyNA=="}], "type": "inlineReview"}, {"oid": "402491df0c25cc25bf3037812f9fa0932e3d2556", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/402491df0c25cc25bf3037812f9fa0932e3d2556", "message": "Revert reusing safe update service startup thread for executing deployment to enable graceful kernel shutdown when deployment triggers restart", "committedDate": "2020-10-14T15:42:19Z", "type": "forcePushed"}, {"oid": "654c199a76e04f349ffdfb6517d63e91f1f5e332", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/654c199a76e04f349ffdfb6517d63e91f1f5e332", "message": "Revert reusing safe update service startup thread for executing deployment to enable graceful kernel shutdown when deployment triggers restart", "committedDate": "2020-10-14T15:57:38Z", "type": "forcePushed"}, {"oid": "e0af70c837e79992edb9ff55ae5a281edb8566b5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e0af70c837e79992edb9ff55ae5a281edb8566b5", "message": "Revert reusing safe update service startup thread for executing deployment to enable graceful kernel shutdown when deployment triggers restart", "committedDate": "2020-10-14T19:26:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEyOTI3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r505129272", "bodyText": "don't you need to wait for the lambda to run? This will always be null because it hasn't executed yet, right?", "author": "MikeDombo", "createdAt": "2020-10-15T02:37:14Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -77,43 +77,54 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n                 kernel.getConfig().updateMap(deploymentDocument.getTimestamp(), newConfig, DEPLOYMENT_MERGE_BEHAVIOR));\n \n         // wait until topic listeners finished processing mergeMap changes.\n+        kernel.getContext().runOnPublishQueueAndWait(() -> {});\n+\n+        AtomicReference<Throwable> setDesiredStateFailureCause = new AtomicReference<>();\n         kernel.getContext().runOnPublishQueue(() -> {\n             // polling to wait for all services to be started.\n-            kernel.getContext().get(ExecutorService.class).execute(() -> {\n-                //TODO: Add timeout\n-                try {\n-                    servicesChangeManager.startNewServices();\n-\n-                    // Restart any services that may have been broken before this deployment\n-                    // This is added to allow deployments to fix broken services\n-                    servicesChangeManager.reinstallBrokenServices();\n-\n-                    Set<GreengrassService> servicesToTrack = servicesChangeManager.servicesToTrack();\n-                    logger.atDebug(MERGE_CONFIG_EVENT_KEY).kv(\"serviceToTrack\", servicesToTrack)\n-                            .log(\"Applied new service config. Waiting for services to complete update\");\n-\n-                    waitForServicesToStart(servicesToTrack, mergeTime);\n-                    logger.atDebug(MERGE_CONFIG_EVENT_KEY).log(\"new/updated services are running, will now remove\"\n-                            + \" old services\");\n-                    servicesChangeManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n-                            .log(\"All services updated\");\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.SUCCESSFUL, null));\n-                } catch (ServiceLoadException | InterruptedException | ServiceUpdateException\n-                        | ExecutionException e) {\n-                    logger.atError(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId).setCause(e)\n-                            .log(\"Deployment failed\");\n-                    if (isAutoRollbackRequested(deploymentDocument)) {\n-                        rollback(deploymentDocument, totallyCompleteFuture, e,\n-                                servicesChangeManager.createRollbackManager());\n-                    } else {\n-                        totallyCompleteFuture.complete(new DeploymentResult(\n-                                DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_NOT_REQUESTED, e));\n-                    }\n-                }\n-            });\n+            try {\n+                servicesChangeManager.startNewServices();\n+                // Restart any services that may have been broken before this deployment\n+                // This is added to allow deployments to fix broken services\n+                servicesChangeManager.reinstallBrokenServices();\n+            } catch (ServiceLoadException e) {\n+                setDesiredStateFailureCause.set(e);\n+            }\n         });\n+        // Do not block the publish queue to handle failure in setting desired states for services\n+        if (setDesiredStateFailureCause.get() != null) {", "originalCommit": "f10aa4872cfb3d1e37ba5128933e2b59421f3d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEyOTQ5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r505129499", "bodyText": "use run and wait which returns you the exception (if any)", "author": "MikeDombo", "createdAt": "2020-10-15T02:38:03Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -77,43 +77,54 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n                 kernel.getConfig().updateMap(deploymentDocument.getTimestamp(), newConfig, DEPLOYMENT_MERGE_BEHAVIOR));\n \n         // wait until topic listeners finished processing mergeMap changes.\n+        kernel.getContext().runOnPublishQueueAndWait(() -> {});\n+\n+        AtomicReference<Throwable> setDesiredStateFailureCause = new AtomicReference<>();\n         kernel.getContext().runOnPublishQueue(() -> {", "originalCommit": "f10aa4872cfb3d1e37ba5128933e2b59421f3d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEyOTg0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r505129840", "bodyText": "same here. This will always be null because you aren't waiting for the error to maybe happen.", "author": "MikeDombo", "createdAt": "2020-10-15T02:39:13Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -128,35 +139,49 @@ void rollback(DeploymentDocument deploymentDocument, CompletableFuture<Deploymen\n             return;\n         }\n         // wait until topic listeners finished processing read changes.\n+        kernel.getContext().runOnPublishQueueAndWait(() -> {});\n+\n+        AtomicReference<Throwable> setDesiredStateFailureCause = new AtomicReference<>();\n         kernel.getContext().runOnPublishQueue(() -> {\n             // polling to wait for all services to be started.\n-            kernel.getContext().get(ExecutorService.class).execute(() -> {\n-                // TODO: Add timeout\n-                try {\n-                    rollbackManager.startNewServices();\n-                    rollbackManager.reinstallBrokenServices();\n-\n-                    Set<GreengrassService> servicesToTrackForRollback = rollbackManager.servicesToTrack();\n-\n-                    waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n-\n-                    rollbackManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n-                            .log(\"All services rolled back\");\n-\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, failureCause));\n-                } catch (InterruptedException | ServiceUpdateException | ExecutionException\n-                        | ServiceLoadException e) {\n-                    // Rollback execution failed\n-                    logger.atError().setEventType(MERGE_ERROR_LOG_EVENT_KEY).setCause(e)\n-                            .log(\"Failed to rollback deployment\");\n-                    // TODO : Run user provided script to reach user defined safe state and\n-                    //  set deployment status based on the success of the script run\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.FAILED_UNABLE_TO_ROLLBACK, failureCause));\n-                }\n-            });\n+            try {\n+                rollbackManager.startNewServices();\n+                rollbackManager.reinstallBrokenServices();\n+            } catch (ServiceLoadException e) {\n+                setDesiredStateFailureCause.set(e);\n+            }\n         });\n+        // Do not block the publish queue to handle failure in setting desired states for services\n+        if (setDesiredStateFailureCause.get() != null) {", "originalCommit": "f10aa4872cfb3d1e37ba5128933e2b59421f3d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e487b660b2cb3b3d3c7ab5e90b795536bda0bdc7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e487b660b2cb3b3d3c7ab5e90b795536bda0bdc7", "message": "Fix deployment sync issue causing cancellation to break and post component updates to be sent prematurely", "committedDate": "2020-10-15T16:33:15Z", "type": "commit"}, {"oid": "fb7e7c4288dd6cfc4160ae70667262b3f28a4708", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb7e7c4288dd6cfc4160ae70667262b3f28a4708", "message": "Higher timeout for hard dependency remove integ test", "committedDate": "2020-10-15T16:33:15Z", "type": "commit"}, {"oid": "8088fa97d14742d5780e5e08d0a56f8a9ff69cdc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8088fa97d14742d5780e5e08d0a56f8a9ff69cdc", "message": "fix race condition", "committedDate": "2020-10-15T16:33:15Z", "type": "commit"}, {"oid": "38d5439e574302bb5a8145392508803dbdb681fa", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/38d5439e574302bb5a8145392508803dbdb681fa", "message": "Revert reusing safe update service startup thread for executing deployment to enable graceful kernel shutdown when deployment triggers restart", "committedDate": "2020-10-15T16:33:15Z", "type": "commit"}, {"oid": "920704f30aede09201ffa970b0d986e8c63870d3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/920704f30aede09201ffa970b0d986e8c63870d3", "message": "Address comment", "committedDate": "2020-10-15T16:39:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5MTU1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r505691551", "bodyText": "after handling failure, shouldn't we quit?", "author": "MikeDombo", "createdAt": "2020-10-15T16:48:03Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -77,43 +76,46 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n                 kernel.getConfig().updateMap(deploymentDocument.getTimestamp(), newConfig, DEPLOYMENT_MERGE_BEHAVIOR));\n \n         // wait until topic listeners finished processing mergeMap changes.\n-        kernel.getContext().runOnPublishQueue(() -> {\n+        Throwable setDesiredStateFailureCause = kernel.getContext().runOnPublishQueueAndWait(() -> {\n             // polling to wait for all services to be started.\n-            kernel.getContext().get(ExecutorService.class).execute(() -> {\n-                //TODO: Add timeout\n-                try {\n-                    servicesChangeManager.startNewServices();\n-\n-                    // Restart any services that may have been broken before this deployment\n-                    // This is added to allow deployments to fix broken services\n-                    servicesChangeManager.reinstallBrokenServices();\n-\n-                    Set<GreengrassService> servicesToTrack = servicesChangeManager.servicesToTrack();\n-                    logger.atDebug(MERGE_CONFIG_EVENT_KEY).kv(\"serviceToTrack\", servicesToTrack)\n-                            .log(\"Applied new service config. Waiting for services to complete update\");\n-\n-                    waitForServicesToStart(servicesToTrack, mergeTime);\n-                    logger.atDebug(MERGE_CONFIG_EVENT_KEY).log(\"new/updated services are running, will now remove\"\n-                            + \" old services\");\n-                    servicesChangeManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n-                            .log(\"All services updated\");\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.SUCCESSFUL, null));\n-                } catch (ServiceLoadException | InterruptedException | ServiceUpdateException\n-                        | ExecutionException e) {\n-                    logger.atError(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId).setCause(e)\n-                            .log(\"Deployment failed\");\n-                    if (isAutoRollbackRequested(deploymentDocument)) {\n-                        rollback(deploymentDocument, totallyCompleteFuture, e,\n-                                servicesChangeManager.createRollbackManager());\n-                    } else {\n-                        totallyCompleteFuture.complete(new DeploymentResult(\n-                                DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_NOT_REQUESTED, e));\n-                    }\n-                }\n-            });\n+            servicesChangeManager.startNewServices();\n+            // Restart any services that may have been broken before this deployment\n+            // This is added to allow deployments to fix broken services\n+            servicesChangeManager.reinstallBrokenServices();\n         });\n+        if (setDesiredStateFailureCause != null) {\n+            handleFailure(servicesChangeManager, deploymentDocument, totallyCompleteFuture,\n+                    setDesiredStateFailureCause);", "originalCommit": "920704f30aede09201ffa970b0d986e8c63870d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5MjA2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r505692067", "bodyText": "likewise", "author": "MikeDombo", "createdAt": "2020-10-15T16:48:54Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -128,35 +130,40 @@ void rollback(DeploymentDocument deploymentDocument, CompletableFuture<Deploymen\n             return;\n         }\n         // wait until topic listeners finished processing read changes.\n-        kernel.getContext().runOnPublishQueue(() -> {\n-            // polling to wait for all services to be started.\n-            kernel.getContext().get(ExecutorService.class).execute(() -> {\n-                // TODO: Add timeout\n-                try {\n-                    rollbackManager.startNewServices();\n-                    rollbackManager.reinstallBrokenServices();\n-\n-                    Set<GreengrassService> servicesToTrackForRollback = rollbackManager.servicesToTrack();\n-\n-                    waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n-\n-                    rollbackManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n-                            .log(\"All services rolled back\");\n-\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, failureCause));\n-                } catch (InterruptedException | ServiceUpdateException | ExecutionException\n-                        | ServiceLoadException e) {\n-                    // Rollback execution failed\n-                    logger.atError().setEventType(MERGE_ERROR_LOG_EVENT_KEY).setCause(e)\n-                            .log(\"Failed to rollback deployment\");\n-                    // TODO : Run user provided script to reach user defined safe state and\n-                    //  set deployment status based on the success of the script run\n-                    totallyCompleteFuture.complete(new DeploymentResult(\n-                            DeploymentResult.DeploymentStatus.FAILED_UNABLE_TO_ROLLBACK, failureCause));\n-                }\n-            });\n+        Throwable setDesiredStateFailureCause = kernel.getContext().runOnPublishQueueAndWait(() -> {\n+                rollbackManager.startNewServices();\n+                rollbackManager.reinstallBrokenServices();\n         });\n+        if (setDesiredStateFailureCause != null) {\n+            handleFailureRollback(totallyCompleteFuture, failureCause, setDesiredStateFailureCause);", "originalCommit": "920704f30aede09201ffa970b0d986e8c63870d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e38d6a405e083abcbb76b27aa0d7efead357a7fc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e38d6a405e083abcbb76b27aa0d7efead357a7fc", "message": "Address comment", "committedDate": "2020-10-15T16:56:14Z", "type": "forcePushed"}, {"oid": "272a5df8cf88b8b44bfa98d90e142c8b69c19f58", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/272a5df8cf88b8b44bfa98d90e142c8b69c19f58", "message": "Address comment", "committedDate": "2020-10-15T17:07:05Z", "type": "commit"}, {"oid": "272a5df8cf88b8b44bfa98d90e142c8b69c19f58", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/272a5df8cf88b8b44bfa98d90e142c8b69c19f58", "message": "Address comment", "committedDate": "2020-10-15T17:07:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwNTI2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r505705266", "bodyText": "instead of suppressing it would be better to fix it, or mark the variable as final which also resolves it", "author": "MikeDombo", "createdAt": "2020-10-15T17:09:35Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -43,6 +42,7 @@ public DefaultActivator(Kernel kernel, DynamicComponentConfigurationValidator va\n     }\n \n     @Override\n+    @SuppressWarnings(\"PMD.PrematureDeclaration\")", "originalCommit": "272a5df8cf88b8b44bfa98d90e142c8b69c19f58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxMzA2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/502#discussion_r505713061", "bodyText": "I fixed one for deploymentId, the other is for mergTime at line 69 which has to be initialized at the time it is because we need to record it before changing config but we reference it much later in the wait phase. Making it final isn't helping", "author": "shaguptashaikh", "createdAt": "2020-10-15T17:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwNTI2Ng=="}], "type": "inlineReview"}, {"oid": "ec8ee00517e432e9204cb65a762b858cb6b90649", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ec8ee00517e432e9204cb65a762b858cb6b90649", "message": "Merge branch 'master' into deployment-wait-sync", "committedDate": "2020-10-15T17:57:38Z", "type": "commit"}, {"oid": "ccc5281e239e1c550ed9ae61628711c896eb8953", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ccc5281e239e1c550ed9ae61628711c896eb8953", "message": "Merge branch 'master' into deployment-wait-sync", "committedDate": "2020-10-15T18:07:37Z", "type": "commit"}]}