{"pr_number": 254, "pr_title": "Implement taking LocalOverrideRequest and convert to DeploymentDocument", "pr_createdAt": "2020-05-22T16:15:32Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254", "timeline": [{"oid": "45e040de76427caddaf2b07bcbba9251394a3a5a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/45e040de76427caddaf2b07bcbba9251394a3a5a", "message": "Ready for Demo; Missing tests", "committedDate": "2020-05-22T16:13:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzOTgyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429339823", "bodyText": "This seems maybe too quick. Not positive what the original intention of setting it to 30s was though, but I'm guessing it is to keep the cpu idle for longer.", "author": "MikeDombo", "createdAt": "2020-05-22T16:23:56Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -44,12 +51,12 @@\n \n     public static final String DEPLOYMENT_SERVICE_TOPICS = \"DeploymentService\";\n \n-    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper()\n-            .configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n-            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+    private static final ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n+                    .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n \n     // TODO: These should probably become configurable parameters eventually\n-    private static final long DEPLOYMENT_POLLING_FREQUENCY = Duration.ofSeconds(30).toMillis();\n+    private static final long DEPLOYMENT_POLLING_FREQUENCY = Duration.ofSeconds(1).toMillis();", "originalCommit": "45e040de76427caddaf2b07bcbba9251394a3a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2ODczNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429368736", "bodyText": "Agree. 1s is too much.", "author": "fengwang666", "createdAt": "2020-05-22T17:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzOTgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NTEwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429375109", "bodyText": "Yeah this is mainly for the demo. But I also had the question for 30... Seems too long. And our E2E tests could be long just because of that. We can check with team.", "author": "leaf94", "createdAt": "2020-05-22T17:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzOTgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MDgwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429340807", "bodyText": "why skip, why not have a null version?", "author": "MikeDombo", "createdAt": "2020-05-22T16:26:01Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -311,20 +314,39 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n             // if not found, initialize GenericExternalService\n             try {\n                 ret = new GenericExternalService(serviceRootTopics);\n-                logger.atInfo(\"generic-service-loaded\")\n-                        .kv(EvergreenService.SERVICE_NAME_KEY, ret.getName()).log();\n+                logger.atInfo(\"generic-service-loaded\").kv(EvergreenService.SERVICE_NAME_KEY, ret.getName()).log();\n             } catch (Throwable ex) {\n                 throw new ServiceLoadException(\"Can't create generic service instance \" + name, ex);\n             }\n             return ret;\n         });\n     }\n \n+\n+    /**\n+     * Fetch root packages and thier version from the kernel.\n+     *\n+     * @return returns packageName, version as a map\n+     */\n+    public Map<String, String> getRootPackageNameAndVersion() {\n+\n+        Map<String, String> rootPackageNameAndVersionMap = new HashMap<>();\n+        for (EvergreenService service : getMain().getDependencies().keySet()) {\n+            Topic version = service.getConfig().find(VERSION_CONFIG_KEY);\n+            if (version == null) {\n+                // version is not currently available for services that ship with the kernel", "originalCommit": "45e040de76427caddaf2b07bcbba9251394a3a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NjQ5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429376497", "bodyText": "I see your question on Fahad's PR. Basically here the intention is not to return the built-in services... And I think the implementation achieved it this way. But it could be optimized instead of relying on null check on version", "author": "leaf94", "createdAt": "2020-05-22T17:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MDgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0NDI1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431344254", "bodyText": "Why not return them, won't this cause them to be removed or have their config values reset during the deployment?", "author": "MikeDombo", "createdAt": "2020-05-27T18:08:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MDgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTEyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429341128", "bodyText": "this can be a bit simpler if you just do if (configuration==null) return set;", "author": "MikeDombo", "createdAt": "2020-05-22T16:26:37Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageParameter.java", "diffHunk": "@@ -59,16 +59,16 @@ public PackageParameter(String name, String value, ParameterType type) {\n      */\n     public static Set<PackageParameter> fromMap(Map<String, Object> configuration) {\n         HashSet<PackageParameter> set = new HashSet<>();\n-        for (Map.Entry<String, Object> parameter : configuration.entrySet()) {\n-            Object value = parameter.getValue();\n-            if (value instanceof String) {\n-                set.add(new PackageParameter(parameter.getKey(), (String) value, ParameterType.STRING));\n-            } else if (value instanceof Boolean) {\n-                set.add(new PackageParameter(parameter.getKey(), ((Boolean) value).toString(),\n-                        ParameterType.BOOLEAN));\n-            } else if (value instanceof Number) {\n-                set.add(new PackageParameter(parameter.getKey(), String.valueOf(value),\n-                        ParameterType.NUMBER));\n+        if (configuration != null) {", "originalCommit": "45e040de76427caddaf2b07bcbba9251394a3a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NjU5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429376591", "bodyText": "Will do", "author": "leaf94", "createdAt": "2020-05-22T17:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTEyOA=="}], "type": "inlineReview"}, {"oid": "629392a55d643d2313169c45be62aa84b16d6f3f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/629392a55d643d2313169c45be62aa84b16d6f3f", "message": "Add request id and timestamp", "committedDate": "2020-05-22T17:22:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2Mjc2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429362767", "bodyText": "What is \"*\"?", "author": "fengwang666", "createdAt": "2020-05-22T17:12:15Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -301,6 +315,52 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n         return document;\n     }\n \n+    private DeploymentDocument convertLocalOverrideRequestToDeployDoc(LocalOverrideRequest localOverrideRequest) {\n+\n+        // TODO DeploymentId\n+        Map<String, String> rootComponents = kernel.getRootPackageNameAndVersion();\n+\n+        // remove\n+        List<String> componentsToRemove = localOverrideRequest.getComponentsToRemove();\n+        if (componentsToRemove != null && !componentsToRemove.isEmpty()) {\n+            componentsToRemove.forEach((rootComponents::remove));\n+        }\n+\n+        // add or update\n+        Map<String, String> componentsToMerge = localOverrideRequest.getComponentsToMerge();\n+\n+        if (componentsToMerge != null && !componentsToMerge.isEmpty()) {\n+            componentsToMerge.forEach((name, version) -> rootComponents.merge(name, version, (k, v) -> version));\n+        }\n+\n+        List<String> rootPackages = new ArrayList<>(rootComponents.keySet());\n+\n+\n+        List<DeploymentPackageConfiguration> packageConfigurations =\n+                localOverrideRequest.getComponentNameToConfig().entrySet().stream()\n+                        .map(entry -> new DeploymentPackageConfiguration(entry.getKey(), \"*\", entry.getValue()))", "originalCommit": "45e040de76427caddaf2b07bcbba9251394a3a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NjcyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429376724", "bodyText": "This needs an offline discussion...", "author": "leaf94", "createdAt": "2020-05-22T17:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2Mjc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2NDg5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429364892", "bodyText": "typo: thier -> their", "author": "fengwang666", "createdAt": "2020-05-22T17:17:14Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -311,20 +314,39 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n             // if not found, initialize GenericExternalService\n             try {\n                 ret = new GenericExternalService(serviceRootTopics);\n-                logger.atInfo(\"generic-service-loaded\")\n-                        .kv(EvergreenService.SERVICE_NAME_KEY, ret.getName()).log();\n+                logger.atInfo(\"generic-service-loaded\").kv(EvergreenService.SERVICE_NAME_KEY, ret.getName()).log();\n             } catch (Throwable ex) {\n                 throw new ServiceLoadException(\"Can't create generic service instance \" + name, ex);\n             }\n             return ret;\n         });\n     }\n \n+\n+    /**\n+     * Fetch root packages and thier version from the kernel.", "originalCommit": "45e040de76427caddaf2b07bcbba9251394a3a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3Njc3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429376772", "bodyText": "Thanks", "author": "leaf94", "createdAt": "2020-05-22T17:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2NDg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0Mzg2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431343864", "bodyText": "Still typo", "author": "MikeDombo", "createdAt": "2020-05-27T18:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2NDg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2NTg2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429365864", "bodyText": "I have no idea what this TODO means. The purpose of TODO is other people can understand what is missing.", "author": "fengwang666", "createdAt": "2020-05-22T17:19:39Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -301,6 +315,52 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n         return document;\n     }\n \n+    private DeploymentDocument convertLocalOverrideRequestToDeployDoc(LocalOverrideRequest localOverrideRequest) {\n+\n+        // TODO DeploymentId", "originalCommit": "45e040de76427caddaf2b07bcbba9251394a3a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzM4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429377380", "bodyText": "It was for myself not to forget deal with deployment id in the previous revision.. It's handled now and I forgot to remove it. Thanks for catching it.", "author": "leaf94", "createdAt": "2020-05-22T17:45:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2NTg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2Njg5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429366892", "bodyText": "why not just use put()?", "author": "fengwang666", "createdAt": "2020-05-22T17:21:42Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -301,6 +315,52 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n         return document;\n     }\n \n+    private DeploymentDocument convertLocalOverrideRequestToDeployDoc(LocalOverrideRequest localOverrideRequest) {\n+\n+        // TODO DeploymentId\n+        Map<String, String> rootComponents = kernel.getRootPackageNameAndVersion();\n+\n+        // remove\n+        List<String> componentsToRemove = localOverrideRequest.getComponentsToRemove();\n+        if (componentsToRemove != null && !componentsToRemove.isEmpty()) {\n+            componentsToRemove.forEach((rootComponents::remove));\n+        }\n+\n+        // add or update\n+        Map<String, String> componentsToMerge = localOverrideRequest.getComponentsToMerge();\n+\n+        if (componentsToMerge != null && !componentsToMerge.isEmpty()) {\n+            componentsToMerge.forEach((name, version) -> rootComponents.merge(name, version, (k, v) -> version));", "originalCommit": "45e040de76427caddaf2b07bcbba9251394a3a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMzMzA2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431333064", "bodyText": "Because I was stupid. :)", "author": "leaf94", "createdAt": "2020-05-27T17:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2Njg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2OTU0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429369547", "bodyText": "I don't quite understand this line. Isn't the root component already in the packageConfigurations?", "author": "fengwang666", "createdAt": "2020-05-22T17:27:44Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -301,6 +315,52 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n         return document;\n     }\n \n+    private DeploymentDocument convertLocalOverrideRequestToDeployDoc(LocalOverrideRequest localOverrideRequest) {\n+\n+        // TODO DeploymentId\n+        Map<String, String> rootComponents = kernel.getRootPackageNameAndVersion();\n+\n+        // remove\n+        List<String> componentsToRemove = localOverrideRequest.getComponentsToRemove();\n+        if (componentsToRemove != null && !componentsToRemove.isEmpty()) {\n+            componentsToRemove.forEach((rootComponents::remove));\n+        }\n+\n+        // add or update\n+        Map<String, String> componentsToMerge = localOverrideRequest.getComponentsToMerge();\n+\n+        if (componentsToMerge != null && !componentsToMerge.isEmpty()) {\n+            componentsToMerge.forEach((name, version) -> rootComponents.merge(name, version, (k, v) -> version));\n+        }\n+\n+        List<String> rootPackages = new ArrayList<>(rootComponents.keySet());\n+\n+\n+        List<DeploymentPackageConfiguration> packageConfigurations =\n+                localOverrideRequest.getComponentNameToConfig().entrySet().stream()\n+                        .map(entry -> new DeploymentPackageConfiguration(entry.getKey(), \"*\", entry.getValue()))\n+                        .collect(Collectors.toList());\n+\n+        // apply root\n+        rootComponents.forEach((rootComponentName, version) -> {\n+            Optional<DeploymentPackageConfiguration> optionalConfiguration = packageConfigurations.stream()\n+                    .filter(packageConfiguration -> packageConfiguration.getPackageName().equals(rootComponentName))\n+                    .findAny();\n+\n+            if (optionalConfiguration.isPresent()) {\n+                optionalConfiguration.get().setResolvedVersion(version);\n+            } else {\n+                packageConfigurations.add(new DeploymentPackageConfiguration(rootComponentName, version, null));", "originalCommit": "45e040de76427caddaf2b07bcbba9251394a3a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMzMjg3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431332877", "bodyText": "Nah... Unlike cloud deployment doc, the local request doesn't have that info. It may only have something like: {\"PackageToMerge\": \"HelloWorld-1.0.0\"}. So the packageConfigurations needs to be populated from it...", "author": "leaf94", "createdAt": "2020-05-27T17:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2OTU0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MjkyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429452926", "bodyText": "Can we have this logic some place else ? Deployment service need not know abt converting the override request to deployment document", "author": "fahadmohammed01", "createdAt": "2020-05-22T21:11:52Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -301,6 +315,50 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n         return document;\n     }\n \n+    private DeploymentDocument convertLocalOverrideRequestToDeployDoc(LocalOverrideRequest localOverrideRequest) {", "originalCommit": "629392a55d643d2313169c45be62aa84b16d6f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ2NDA2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r429464065", "bodyText": "hah great thought! This is exactly what I want to do. I want to create a converter and have a unit test for it.", "author": "leaf94", "createdAt": "2020-05-22T21:43:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MjkyNg=="}], "type": "inlineReview"}, {"oid": "8b9ee5d2f171839066c1e4176539ccff92e41f25", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b9ee5d2f171839066c1e4176539ccff92e41f25", "message": "added unit tests", "committedDate": "2020-05-22T23:32:14Z", "type": "commit"}, {"oid": "1578dfc4bcf445621ba958d0a69525b7056cf3cb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1578dfc4bcf445621ba958d0a69525b7056cf3cb", "message": "Merge branch 'master' into component_local_override", "committedDate": "2020-05-27T05:44:00Z", "type": "commit"}, {"oid": "c980a2341802795ecf5cde7c9f2f97e7b4a6218e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c980a2341802795ecf5cde7c9f2f97e7b4a6218e", "message": "Add Converter and test", "committedDate": "2020-05-27T05:44:10Z", "type": "commit"}, {"oid": "d84911fe44354e426809d2a05b039fb892733871", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d84911fe44354e426809d2a05b039fb892733871", "message": "Fix build", "committedDate": "2020-05-27T17:37:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0MjQ2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431342466", "bodyText": "object mappers are expensive, avoid creating them all the time. Save this as a static final.", "author": "MikeDombo", "createdAt": "2020-05-27T18:05:26Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/LocalDeploymentListener.java", "diffHunk": "@@ -23,20 +25,35 @@\n     private LinkedBlockingQueue<Deployment> deploymentsQueue;\n \n     //TODO: LocalDeploymentListener should register with IPC to expose submitLocalDeployment\n-    //TODO: the interface is not finalized yet, this is more an example.\n-    /** schedules a deployment with deployment service.\n-     * @param deploymentDocument document configuration\n+\n+    /**\n+     * schedules a deployment with deployment service.\n+     *\n+     * @param localOverrideRequestStr serialized localOverrideRequestStr\n      * @return true if deployment was scheduled\n      */\n-    public boolean submitLocalDeployment(String deploymentDocument) {\n-        String localDeploymentIdentifier = LOCAL_DEPLOYMENT_ID_PREFIX + System.currentTimeMillis();\n-        Deployment deployment = new Deployment(deploymentDocument, DeploymentType.LOCAL, localDeploymentIdentifier);\n+    public boolean submitLocalDeployment(String localOverrideRequestStr) {\n+\n+        LocalOverrideRequest request;\n+\n+        try {\n+            request = new ObjectMapper().readValue(localOverrideRequestStr, LocalOverrideRequest.class);", "originalCommit": "d84911fe44354e426809d2a05b039fb892733871", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0MzI0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431343240", "bodyText": "nit: no reason to check for empty.", "author": "MikeDombo", "createdAt": "2020-05-27T18:06:51Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+  * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment.converter;\n+\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.deployment.model.LocalOverrideRequest;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+public final class DeploymentDocumentConverter {\n+\n+    private static final String ANY_VERSION = \"*\";\n+\n+    private DeploymentDocumentConverter() {\n+        // So that this can't be initialized\n+    }\n+\n+    /**\n+     * Convert to a DeploymentDocument from a LocalOverrideRequest and the current running root Components.\n+     *\n+     * @param localOverrideRequest  local override request\n+     * @param runningRootComponents current running root component name to version\n+     * @return a converted DeploymentDocument\n+     */\n+    public static DeploymentDocument convertFromLocalOverrideRequestAndRoot(LocalOverrideRequest localOverrideRequest,\n+                                                                            Map<String, String> runningRootComponents) {\n+\n+        // copy over existing root components\n+        Map<String, String> newRootComponents = new HashMap<>(runningRootComponents);\n+\n+        // remove\n+        List<String> componentsToRemove = localOverrideRequest.getComponentsToRemove();\n+        if (componentsToRemove != null && !componentsToRemove.isEmpty()) {\n+            componentsToRemove.forEach(newRootComponents::remove);\n+        }\n+\n+        // add or update\n+        Map<String, String> componentsToMerge = localOverrideRequest.getComponentsToMerge();\n+        if (componentsToMerge != null && !componentsToMerge.isEmpty()) {", "originalCommit": "d84911fe44354e426809d2a05b039fb892733871", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU5NDY3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431594674", "bodyText": "Done", "author": "leaf94", "createdAt": "2020-05-28T05:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0MzI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0NDc4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431344782", "bodyText": "please undo the formatting.", "author": "MikeDombo", "createdAt": "2020-05-27T18:09:38Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/KernelTest.java", "diffHunk": "@@ -42,16 +46,9 @@\n @ExtendWith(EGExtension.class)\n class KernelTest {\n     private static final String EXPECTED_CONFIG_OUTPUT =\n-            \"---\\n\"\n-            + \"services:\\n\"\n-            + \"  service1:\\n\"\n-            + \"    dependencies: []\\n\"\n-            + \"    lifecycle:\\n\"\n-            + \"      run:\\n\"\n-            + \"        script: \\\"test script\\\"\\n\"\n-            + \"  main:\\n\"\n-            + \"    dependencies:\\n\"\n-            + \"    - \\\"service1\\\"\\n\";\n+            \"---\\n\" + \"services:\\n\" + \"  service1:\\n\" + \"    dependencies: []\\n\" + \"    lifecycle:\\n\" + \"      run:\\n\"", "originalCommit": "d84911fe44354e426809d2a05b039fb892733871", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU5MTM3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431591371", "bodyText": "Done", "author": "leaf94", "createdAt": "2020-05-28T05:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0NDc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0NTA4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431345087", "bodyText": "use findServiceTopics instead.", "author": "MikeDombo", "createdAt": "2020-05-27T18:10:07Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/KernelTest.java", "diffHunk": "@@ -74,19 +71,16 @@ void GIVEN_kernel_and_services_WHEN_orderedDependencies_THEN_dependencies_are_re\n         KernelLifecycle kernelLifecycle = spy(new KernelLifecycle(kernel, new KernelCommandLine(kernel)));\n         kernel.setKernelLifecycle(kernelLifecycle);\n \n-        EvergreenService mockMain =\n-                new EvergreenService(kernel.getConfig()\n-                        .lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, \"main\"));\n+        EvergreenService mockMain = new EvergreenService(\n+                kernel.getConfig().lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, \"main\"));\n         mockMain.postInject();\n         when(kernelLifecycle.getMain()).thenReturn(mockMain);\n \n-        EvergreenService service1 =\n-                new EvergreenService(kernel.getConfig()\n-                        .lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, \"service1\"));\n+        EvergreenService service1 = new EvergreenService(\n+                kernel.getConfig().lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, \"service1\"));\n         service1.postInject();\n-        EvergreenService service2 =\n-                new EvergreenService(kernel.getConfig()\n-                        .lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, \"service2\"));\n+        EvergreenService service2 = new EvergreenService(\n+                kernel.getConfig().lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, \"service2\"));", "originalCommit": "d84911fe44354e426809d2a05b039fb892733871", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU5MTM1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r431591357", "bodyText": "Tried it and failed because returning null. I think here we do need to create the topics coz the config at this point is basically empty, right?", "author": "leaf94", "createdAt": "2020-05-28T05:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0NTA4Nw=="}], "type": "inlineReview"}, {"oid": "c14b4568bb38b052289acb44e449c6ae75186ded", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c14b4568bb38b052289acb44e449c6ae75186ded", "message": "Merge branch 'master' into component_local_override", "committedDate": "2020-05-28T05:45:48Z", "type": "commit"}, {"oid": "427dfcde64ab6a76efd11ceeb87faf9a166a6f71", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/427dfcde64ab6a76efd11ceeb87faf9a166a6f71", "message": "PR", "committedDate": "2020-05-28T07:19:03Z", "type": "commit"}, {"oid": "2c2d09b975af4bb1c904c3d6702f88f42d3273c2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2c2d09b975af4bb1c904c3d6702f88f42d3273c2", "message": "Put back the polling wait time", "committedDate": "2020-05-28T17:43:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyODYzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432128632", "bodyText": "Why does this cause duplication? That sounds like a serious bug that should be fixed.", "author": "MikeDombo", "createdAt": "2020-05-28T21:16:54Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -44,11 +47,15 @@\n \n     public static final String DEPLOYMENT_SERVICE_TOPICS = \"DeploymentService\";\n \n-    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper()\n-            .configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n-            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+    private static final ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n+                    .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n \n     // TODO: These should probably become configurable parameters eventually\n+    // TODO: Deployment polling wait time can't be simply reduced now because it may result doing duplicate deployment.", "originalCommit": "2c2d09b975af4bb1c904c3d6702f88f42d3273c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEzNDI5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432134297", "bodyText": "My guess is because the QoS is at least 1 when we subscribe to IoT Job for notification. Not very sure though.", "author": "leaf94", "createdAt": "2020-05-28T21:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEzODEzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432138139", "bodyText": "This is being caused due to Mqtt QoS 1 which implies we can receive an Mqtt message twice. And if we pull the first message from the queue before the second one comes in, and the deployment finishes within the next poll cycle then this issue will come.\nThis is what I propose:\nJobs helper keeps record of last jobId and queuedAt timestamp for the last job. When a job message comes we see if the timestamp of the message is greater than the last processed one, if so the message should be put in queue. If timestamp is same then we compare the jobId and ignore if jobId is same (already processed). If timestamp is old then we ignore the message.", "author": "abanthiy", "createdAt": "2020-05-28T21:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1Mzg5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432553895", "bodyText": "Someone please create a sim and link it in the to do so we don't forget this.", "author": "MikeDombo", "createdAt": "2020-05-29T15:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU5NTU1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432595550", "bodyText": "I can do it and I also put the reference in the code.", "author": "leaf94", "createdAt": "2020-05-29T16:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyODYzMg=="}], "type": "inlineReview"}, {"oid": "97b1750af4a5f46159835800f3dd847f8c7cb4fe", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/97b1750af4a5f46159835800f3dd847f8c7cb4fe", "message": "Merge branch 'master' into component_local_override", "committedDate": "2020-05-28T21:27:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MDgxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432140813", "bodyText": "Refer to my suggested approach above and remove this comment", "author": "abanthiy", "createdAt": "2020-05-28T21:42:44Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -178,6 +178,10 @@\n         }\n         Deployment deployment =\n                 new Deployment(documentString, DeploymentType.IOT_JOBS, jobExecutionData.jobId);\n+\n+        // TODO The deduping here doesn't working when the deployment polling frequency increased", "originalCommit": "97b1750af4a5f46159835800f3dd847f8c7cb4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU5NTI4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432595284", "bodyText": "Discussed offline and aligned on the Amit's suggested approach. Updated the comment with the approach above.", "author": "leaf94", "createdAt": "2020-05-29T16:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MDgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MzMwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432143302", "bodyText": "I think this should happen respectively in IotJobsHelper and LocalDeploymentListener\nDeployment service understands the deployment document and any transformations should be handled before it. Otherwise deployment service will keep on adding transformation code for different deployment sources.", "author": "abanthiy", "createdAt": "2020-05-28T21:48:32Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -282,11 +293,17 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n         if (Utils.isEmpty(jobDocumentString)) {\n             throw new InvalidRequestException(\"Job document cannot be empty\");\n         }\n-        DeploymentDocument document = null;\n+        DeploymentDocument document;\n         try {\n             switch (deployment.getDeploymentType()) {\n                 case LOCAL:\n-                    document = OBJECT_MAPPER.readValue(jobDocumentString, DeploymentDocument.class);\n+                    LocalOverrideRequest localOverrideRequest =\n+                            OBJECT_MAPPER.readValue(jobDocumentString, LocalOverrideRequest.class);\n+\n+                    Map<String, String> rootComponents = kernel.getRunningCustomRootComponents();\n+\n+                    document = DeploymentDocumentConverter\n+                            .convertFromLocalOverrideRequestAndRoot(localOverrideRequest, rootComponents);\n                     break;\n                 case IOT_JOBS:\n                     FleetConfiguration config = OBJECT_MAPPER.readValue(jobDocumentString, FleetConfiguration.class);", "originalCommit": "97b1750af4a5f46159835800f3dd847f8c7cb4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1NDc0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432554747", "bodyText": "+1 this makes more sense to me. The deployment service should just use our internal models without anymore transforms.", "author": "MikeDombo", "createdAt": "2020-05-29T15:14:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MzMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4OTg4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432589885", "bodyText": "Discussed offline. Agreed that we should do the refactor when the shadow comes.", "author": "leaf94", "createdAt": "2020-05-29T16:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MzMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0Nzk5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432147997", "bodyText": "This initialization can move to top and this can be reduced to one if block", "author": "abanthiy", "createdAt": "2020-05-28T21:59:39Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+  * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment.converter;\n+\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.deployment.model.LocalOverrideRequest;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+public final class DeploymentDocumentConverter {\n+\n+    private static final String ANY_VERSION = \"*\";\n+\n+    private DeploymentDocumentConverter() {\n+        // So that this can't be initialized\n+    }\n+\n+    /**\n+     * Convert to a DeploymentDocument from a LocalOverrideRequest and the current running root Components.\n+     *\n+     * @param localOverrideRequest  local override request\n+     * @param runningRootComponents current running root component name to version\n+     * @return a converted DeploymentDocument\n+     */\n+    public static DeploymentDocument convertFromLocalOverrideRequestAndRoot(LocalOverrideRequest localOverrideRequest,\n+                                                                            Map<String, String> runningRootComponents) {\n+\n+        // copy over existing root components\n+        Map<String, String> newRootComponents = new HashMap<>(runningRootComponents);\n+\n+        // remove\n+        List<String> componentsToRemove = localOverrideRequest.getComponentsToRemove();\n+        if (componentsToRemove != null) {\n+            componentsToRemove.forEach(newRootComponents::remove);\n+        }\n+\n+        // add or update\n+        Map<String, String> componentsToMerge = localOverrideRequest.getComponentsToMerge();\n+        if (componentsToMerge != null) {\n+            componentsToMerge.forEach(newRootComponents::put);\n+        }\n+\n+        List<String> rootPackages = new ArrayList<>(newRootComponents.keySet());\n+\n+        // Build configs\n+        List<DeploymentPackageConfiguration> packageConfigurations =\n+                buildDeploymentPackageConfigurations(localOverrideRequest, newRootComponents);\n+\n+\n+        return DeploymentDocument.builder().timestamp(localOverrideRequest.getRequestTimestamp())\n+                .deploymentId(localOverrideRequest.getRequestId()).rootPackages(rootPackages)\n+                .deploymentPackageConfigurationList(packageConfigurations).build();\n+    }\n+\n+    private static List<DeploymentPackageConfiguration> buildDeploymentPackageConfigurations(\n+            LocalOverrideRequest localOverrideRequest, Map<String, String> newRootComponents) {\n+        List<DeploymentPackageConfiguration> packageConfigurations;\n+\n+        // convert Deployment Config from getComponentNameToConfig, which doesn't include root components necessarily\n+        if (localOverrideRequest.getComponentNameToConfig() == null || localOverrideRequest.getComponentNameToConfig()\n+                .isEmpty()) {\n+            packageConfigurations = new ArrayList<>();", "originalCommit": "97b1750af4a5f46159835800f3dd847f8c7cb4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4OTY4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432589687", "bodyText": "I used the var in the lambda expression and the compilation needs to be effective final... Moving to top essentially will change the assignment and not effective final...", "author": "leaf94", "createdAt": "2020-05-29T16:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0Nzk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MzU5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432153594", "bodyText": "Getting all root components and creating the complete config seems like work which dependency resolver/kernelConfigResolver needs to do. Why can't we just send the packages that need to be updated, added and removed. Right now we do no support removing, but with multi groups and shadow deployments we will need to add those.\nI am ok keeping this for M1 since these are bigger changes.", "author": "abanthiy", "createdAt": "2020-05-28T22:13:28Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+  * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment.converter;\n+\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.deployment.model.LocalOverrideRequest;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+public final class DeploymentDocumentConverter {\n+\n+    private static final String ANY_VERSION = \"*\";\n+\n+    private DeploymentDocumentConverter() {\n+        // So that this can't be initialized\n+    }\n+\n+    /**\n+     * Convert to a DeploymentDocument from a LocalOverrideRequest and the current running root Components.\n+     *\n+     * @param localOverrideRequest  local override request\n+     * @param runningRootComponents current running root component name to version\n+     * @return a converted DeploymentDocument\n+     */\n+    public static DeploymentDocument convertFromLocalOverrideRequestAndRoot(LocalOverrideRequest localOverrideRequest,", "originalCommit": "97b1750af4a5f46159835800f3dd847f8c7cb4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1NTY0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432555647", "bodyText": "That's the way the cloud deployment works; the config resolver merges the root components. So this should be the same for local too.", "author": "MikeDombo", "createdAt": "2020-05-29T15:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MzU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4ODY4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432588687", "bodyText": "Discussed offline and agreed.", "author": "leaf94", "createdAt": "2020-05-29T16:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MzU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1NjM4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432556388", "bodyText": "Not needed for this pr, but let's add a version to the implements service annotation so that all services will have versions.", "author": "MikeDombo", "createdAt": "2020-05-29T15:17:23Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -311,20 +314,42 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n             // if not found, initialize GenericExternalService\n             try {\n                 ret = new GenericExternalService(serviceRootTopics);\n-                logger.atInfo(\"generic-service-loaded\")\n-                        .kv(EvergreenService.SERVICE_NAME_KEY, ret.getName()).log();\n+                logger.atInfo(\"generic-service-loaded\").kv(EvergreenService.SERVICE_NAME_KEY, ret.getName()).log();\n             } catch (Throwable ex) {\n                 throw new ServiceLoadException(\"Can't create generic service instance \" + name, ex);\n             }\n             return ret;\n         });\n     }\n \n+\n+    /**\n+     * Get running custom root components, excluding the kernel's built-in services.\n+     *\n+     * @return returns name and version as a map\n+     */\n+    public Map<String, String> getRunningCustomRootComponents() {\n+\n+        Map<String, String> rootPackageNameAndVersionMap = new HashMap<>();\n+\n+        for (EvergreenService service : getMain().getDependencies().keySet()) {\n+            Topic version = service.getConfig().find(VERSION_CONFIG_KEY);\n+\n+            if (version == null) {", "originalCommit": "97b1750af4a5f46159835800f3dd847f8c7cb4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMjg5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/254#discussion_r432622898", "bodyText": "Make sense! So we shouldn't expect any null version. It has confused me a bit as well.", "author": "leaf94", "createdAt": "2020-05-29T17:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU1NjM4OA=="}], "type": "inlineReview"}, {"oid": "798ad7c8c731b9ce8e6e478dabdf0d8fdde668a9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/798ad7c8c731b9ce8e6e478dabdf0d8fdde668a9", "message": "address amit comments", "committedDate": "2020-05-29T16:14:40Z", "type": "commit"}, {"oid": "23ab6e8776c8ba00dad7c194e8f9b31edb0bf395", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/23ab6e8776c8ba00dad7c194e8f9b31edb0bf395", "message": "solve merge conflict", "committedDate": "2020-05-29T16:17:56Z", "type": "commit"}, {"oid": "fe45a8518a20f7353c71d490601abdd6e1c49238", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fe45a8518a20f7353c71d490601abdd6e1c49238", "message": "solve merge conflict", "committedDate": "2020-05-29T16:31:57Z", "type": "commit"}]}