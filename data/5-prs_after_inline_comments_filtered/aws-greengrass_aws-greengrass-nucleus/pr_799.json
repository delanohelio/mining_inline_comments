{"pr_number": 799, "pr_title": "fix(deployment): Handle deployment cancellation correctly when deployment is not yet registered with UpdateSystemPolicyService", "pr_createdAt": "2020-12-17T00:33:31Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799", "timeline": [{"oid": "eeccc874ab076c403ce16ccdad7b1dc7ec29faee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eeccc874ab076c403ce16ccdad7b1dc7ec29faee", "message": "fix(cancellation): Condition to check if deployment can be cancelled should evaluate to true if deployment has not started config merge yet\nfix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation", "committedDate": "2020-12-17T00:42:23Z", "type": "forcePushed"}, {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f793e6bdd1f5943b1684fba3c6ae55edd8230443", "message": "fix(cancellation): Condition to check if deployment can be cancelled should evaluate to true if deployment has not started config merge yet\nfix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation", "committedDate": "2020-12-17T00:52:12Z", "type": "commit"}, {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f793e6bdd1f5943b1684fba3c6ae55edd8230443", "message": "fix(cancellation): Condition to check if deployment can be cancelled should evaluate to true if deployment has not started config merge yet\nfix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation", "committedDate": "2020-12-17T00:52:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczMzI0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#discussion_r544733246", "bodyText": "What happens if the action is in progress, like mentioned in the javadoc?", "author": "hui-yang", "createdAt": "2020-12-17T01:01:06Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateSystemPolicyService.java", "diffHunk": "@@ -116,7 +117,8 @@ public boolean discardPendingUpdateAction(String tag) {\n         }\n         // Signal components that they can resume their work since the update is not going to happen\n         lifecycleIPCAgent.sendPostComponentUpdateEvent(new PostComponentUpdateEvent());\n-        return pendingActions.remove(tag) != null;\n+        pendingActions.remove(tag);\n+        return true;\n     }", "originalCommit": "f793e6bdd1f5943b1684fba3c6ae55edd8230443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczNDE0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#discussion_r544734147", "bodyText": "It will return false on line 116", "author": "shaguptashaikh", "createdAt": "2020-12-17T01:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczMzI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MTU3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#discussion_r544741571", "bodyText": "Why not just use ConcurrentHashMap?", "author": "fengwang666", "createdAt": "2020-12-17T01:23:46Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateSystemPolicyService.java", "diffHunk": "@@ -47,7 +48,7 @@\n     // String identifies the action, the pair consist of timeout and an action. The timeout\n     // represents the value in seconds the kernel will wait for components to respond to\n     // an precomponent update event\n-    private final Map<String, UpdateAction> pendingActions = new LinkedHashMap<>();\n+    private final Map<String, UpdateAction> pendingActions = Collections.synchronizedMap(new LinkedHashMap<>());", "originalCommit": "f793e6bdd1f5943b1684fba3c6ae55edd8230443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MjYwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#discussion_r544742609", "bodyText": "We need to keep ordering I believe", "author": "MikeDombo", "createdAt": "2020-12-17T01:26:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MTU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MzI3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#discussion_r544743275", "bodyText": "It needs to be a LinkedHashMap so all pending actions are executed in order, right now we only ever have 1 action because we use this only for deployments and we process 1 deployment at a time, but this service was written to accommodate more actions and execute them in order of registration, and we've always left it like that", "author": "shaguptashaikh", "createdAt": "2020-12-17T01:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MTU3MQ=="}], "type": "inlineReview"}, {"oid": "d69ddc2a41ad31553c1ae2862066f7082c0847f8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d69ddc2a41ad31553c1ae2862066f7082c0847f8", "message": "fix(benchmark):Remove benchmark workflow", "committedDate": "2020-12-17T01:34:19Z", "type": "commit"}]}