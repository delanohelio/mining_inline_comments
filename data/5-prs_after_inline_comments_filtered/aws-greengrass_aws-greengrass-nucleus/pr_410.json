{"pr_number": 410, "pr_title": "Support bootstrap step in all evergreen services", "pr_createdAt": "2020-09-02T21:45:24Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/410", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUwNjYzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/410#discussion_r482506639", "bodyText": "seems like this should be info", "author": "MikeDombo", "createdAt": "2020-09-02T21:47:55Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -169,27 +173,9 @@ boolean serviceBootstrapRequired(String componentName, Map<String, Object> newSe\n                     .log(\"Bootstrap is not required: service lifecycle bootstrap not found\");\n             return false;\n         }\n-        EvergreenService service;\n-        try {\n-            service = kernel.locate(componentName);\n-        } catch (ServiceLoadException e) {\n-            logger.atTrace().kv(COMPONENT_NAME_LOG_KEY_NAME, componentName).log(\"Bootstrap is required: new service\");\n-            return true;\n-        }\n-        if (!service.getConfig().find(VERSION_CONFIG_KEY).getOnce()\n-                .equals(newServiceConfig.get(VERSION_CONFIG_KEY))) {\n-            logger.atTrace().kv(COMPONENT_NAME_LOG_KEY_NAME, componentName)\n-                    .log(\"Bootstrap is required: service version changed\");\n-            return true;\n-        }\n-        Node serviceOldBootstrap = service.getConfig().findNode(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n-                LIFECYCLE_BOOTSTRAP_NAMESPACE_TOPIC);\n-        boolean bootstrapStepChanged =  serviceOldBootstrap == null\n-                || !serviceOldBootstrap.toPOJO().equals(newServiceLifecycle.get(LIFECYCLE_BOOTSTRAP_NAMESPACE_TOPIC));\n-        logger.atTrace().kv(COMPONENT_NAME_LOG_KEY_NAME, componentName).log(String.format(\n-                \"Bootstrap is %srequired: bootstrap step %schanged\", bootstrapStepChanged ? \"\" : \"not \",\n-                        bootstrapStepChanged ? \"\" : \"un\"));\n-        return bootstrapStepChanged;\n+        logger.atTrace().kv(COMPONENT_NAME_LOG_KEY_NAME, componentName)", "originalCommit": "7a203f760f3e62df0aceec3ed469ab77d9be7bd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUwNzE5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/410#discussion_r482507191", "bodyText": "debug?", "author": "MikeDombo", "createdAt": "2020-09-02T21:48:34Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -152,6 +153,42 @@ public synchronized int bootstrap() throws InterruptedException, TimeoutExceptio\n         return atomicExitCode.get();\n     }\n \n+    /**\n+     * Check if bootstrap step needs to run during service update. Called during deployments to determine deployment\n+     * workflow.\n+     *\n+     * @param newServiceConfig new service config for the update\n+     * @return true if the service\n+     *      1. has a bootstrap step defined, 2. component version changes, or bootstrap step changes.\n+     *      false otherwise\n+     */\n+    @Override\n+    public boolean isBootstrapRequired(Map<String, Object> newServiceConfig) {\n+        if (newServiceConfig == null || !newServiceConfig.containsKey(SERVICE_LIFECYCLE_NAMESPACE_TOPIC)) {\n+            logger.atTrace().log(\"Bootstrap is not required: service lifecycle config not found\");", "originalCommit": "7a203f760f3e62df0aceec3ed469ab77d9be7bd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUwNzY5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/410#discussion_r482507695", "bodyText": "Just combine this with the checks below?", "author": "MikeDombo", "createdAt": "2020-09-02T21:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUwNzE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUxMDE3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/410#discussion_r482510176", "bodyText": "Can you validate in the integ test, that upon initial install, the bootstrap required would be false?\nAnd on subsequent installs that it requests restart?", "author": "MikeDombo", "createdAt": "2020-09-02T21:52:14Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/PluginService.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+\n+import java.util.Map;\n+\n+import static com.aws.iot.evergreen.packagemanager.KernelConfigResolver.VERSION_CONFIG_KEY;\n+\n+public class PluginService extends EvergreenService {\n+    public PluginService(Topics topics) {\n+        super(topics);\n+    }\n+\n+    /**\n+     * Check if bootstrap step needs to run during service update. Called during deployments to determine deployment\n+     * workflow.\n+     *\n+     * @param newServiceConfig new service config for the update\n+     * @return\n+     */\n+    @Override\n+    public boolean isBootstrapRequired(Map<String, Object> newServiceConfig) {\n+        Topic versionTopic = getConfig().find(VERSION_CONFIG_KEY);\n+        if (versionTopic == null) {\n+            logger.atTrace().log(\"Bootstrap is required: current service version unknown\");", "originalCommit": "7a203f760f3e62df0aceec3ed469ab77d9be7bd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUxMDU3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/410#discussion_r482510579", "bodyText": "Add a bootstrap override too which returns REQUEST_RESTART", "author": "MikeDombo", "createdAt": "2020-09-02T21:52:45Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/PluginService.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+\n+import java.util.Map;\n+\n+import static com.aws.iot.evergreen.packagemanager.KernelConfigResolver.VERSION_CONFIG_KEY;\n+\n+public class PluginService extends EvergreenService {\n+    public PluginService(Topics topics) {\n+        super(topics);\n+    }\n+\n+    /**\n+     * Check if bootstrap step needs to run during service update. Called during deployments to determine deployment\n+     * workflow.\n+     *\n+     * @param newServiceConfig new service config for the update\n+     * @return\n+     */\n+    @Override\n+    public boolean isBootstrapRequired(Map<String, Object> newServiceConfig) {", "originalCommit": "7a203f760f3e62df0aceec3ed469ab77d9be7bd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUxMjY1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/410#discussion_r482512652", "bodyText": "oh right", "author": "hui-yang", "createdAt": "2020-09-02T21:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUxMDU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwNzMxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/410#discussion_r482707319", "bodyText": "can you also override isBuiltin to return false, since these are plugins, and therefore are not builtin.", "author": "MikeDombo", "createdAt": "2020-09-03T05:08:57Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/PluginService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+\n+import java.util.Map;\n+\n+import static com.aws.iot.evergreen.deployment.bootstrap.BootstrapSuccessCode.REQUEST_RESTART;\n+import static com.aws.iot.evergreen.packagemanager.KernelConfigResolver.VERSION_CONFIG_KEY;\n+\n+public class PluginService extends EvergreenService {\n+    public PluginService(Topics topics) {\n+        super(topics);\n+    }\n+\n+    /**\n+     * Check if bootstrap step needs to run during service update. Called during deployments to determine deployment\n+     * workflow.\n+     *\n+     * @param newServiceConfig new service config for the update\n+     * @return\n+     */\n+    @Override\n+    public boolean isBootstrapRequired(Map<String, Object> newServiceConfig) {\n+        Topic versionTopic = getConfig().find(VERSION_CONFIG_KEY);\n+        if (versionTopic == null) {\n+            logger.atTrace().log(\"Bootstrap is required: current service version unknown\");\n+            return true;\n+        }\n+        if (!versionTopic.getOnce().equals(newServiceConfig.get(VERSION_CONFIG_KEY))) {\n+            logger.atTrace().log(\"Bootstrap is required: service version changed\");\n+            return true;\n+        }\n+        logger.atTrace().log(\"Bootstrap is not required: service version unchanged\");\n+        return false;\n+    }\n+\n+    @Override\n+    public int bootstrap() {\n+        return REQUEST_RESTART;\n+    }\n+}", "originalCommit": "1087f6b3454fa47cda6267771392e21ca68f0abc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6fa78ce07d0a90df60347fa6ba7738128b619ad3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6fa78ce07d0a90df60347fa6ba7738128b619ad3", "message": "Support bootstrap step in all evergreen services", "committedDate": "2020-09-03T19:03:51Z", "type": "commit"}, {"oid": "5950302015796470ddb7eb28be8f6de6c2c1eac7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5950302015796470ddb7eb28be8f6de6c2c1eac7", "message": "Update integration tests", "committedDate": "2020-09-03T19:03:51Z", "type": "commit"}, {"oid": "7d211d82647a7903ec2838ac925878f0924e0bb9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7d211d82647a7903ec2838ac925878f0924e0bb9", "message": "fix tests; address comments", "committedDate": "2020-09-03T19:03:51Z", "type": "commit"}, {"oid": "7d211d82647a7903ec2838ac925878f0924e0bb9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7d211d82647a7903ec2838ac925878f0924e0bb9", "message": "fix tests; address comments", "committedDate": "2020-09-03T19:03:51Z", "type": "forcePushed"}, {"oid": "698b3d06f49ee1d6e4d419f8a947a4d72f81e253", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/698b3d06f49ee1d6e4d419f8a947a4d72f81e253", "message": "Merge branch 'master' into fix-bootstrap", "committedDate": "2020-09-03T20:27:19Z", "type": "commit"}, {"oid": "e562fe66385d2e0231452a6cbad78ecd5aa38964", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e562fe66385d2e0231452a6cbad78ecd5aa38964", "message": "Merge branch 'master' into fix-bootstrap", "committedDate": "2020-09-03T21:34:17Z", "type": "commit"}]}