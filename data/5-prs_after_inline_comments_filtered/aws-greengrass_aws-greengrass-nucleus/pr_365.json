{"pr_number": 365, "pr_title": "Add jitter and chunking of message for Fleet Status Service", "pr_createdAt": "2020-08-14T22:19:50Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365", "timeline": [{"oid": "abfb17da2711a2de74d5f5f6242b66ab3b2b89d0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/abfb17da2711a2de74d5f5f6242b66ab3b2b89d0", "message": "Add initial jitter delay for periodic updates. Add chunking of messages if the payload size exceeds 128 KB.", "committedDate": "2020-08-14T21:00:46Z", "type": "commit"}, {"oid": "725228d7ceb85b0c03233563ad1af4ea83e1fbb9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/725228d7ceb85b0c03233563ad1af4ea83e1fbb9", "message": "Refactor some code.", "committedDate": "2020-08-14T21:49:49Z", "type": "commit"}, {"oid": "faef4e3567100a9dd60442faea546487a66ca11d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/faef4e3567100a9dd60442faea546487a66ca11d", "message": "Update README.", "committedDate": "2020-08-14T22:17:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwNzc1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r471607757", "bodyText": "Also put the reason in the description here so that people can understand why we did it", "author": "leaf94", "createdAt": "2020-08-17T16:48:32Z", "path": "src/main/java/com/aws/iot/evergreen/fss/FleetStatusService.java", "diffHunk": "@@ -173,9 +174,11 @@ private void schedulePeriodicFleetStatusDataUpdate(boolean isDuringConnectionRes\n             updateEventTriggeredFleetStatusData();\n         }\n \n+        // Add some jitter as an initial delay.", "originalCommit": "faef4e3567100a9dd60442faea546487a66ca11d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMzQxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r471613415", "bodyText": "Took me some time to understand the logic. Good job. I think this worth at least a private method and maybe even a util method in separate class for better unit testing. You want to test out the result caused by combinations  payloadVariableInformationSize and payloadCommonInformationSize.", "author": "leaf94", "createdAt": "2020-08-17T16:58:17Z", "path": "src/main/java/com/aws/iot/evergreen/fss/FleetStatusService.java", "diffHunk": "@@ -337,18 +339,30 @@ private void uploadFleetStatusServiceData(Set<EvergreenService> evergreenService\n \n         FleetStatusDetails fleetStatusDetails = FleetStatusDetails.builder()\n                 .overallStatus(overAllStatus)\n-                .componentStatusDetails(components)\n                 .architecture(this.architecture)\n                 .platform(this.platform)\n                 .thing(thingName)\n                 .ggcVersion(KERNEL_VERSION)\n                 .sequenceNumber(sequenceNumber)\n                 .build();\n         try {\n-            this.mqttClient.publish(PublishRequest.builder()\n-                    .qos(QualityOfService.AT_LEAST_ONCE)\n-                    .topic(this.updateFssDataTopic)\n-                    .payload(SERIALIZER.writeValueAsBytes(fleetStatusDetails)).build());\n+            int payloadVariableInformationSize = SERIALIZER.writeValueAsBytes(components).length;\n+            int payloadCommonInformationSize = SERIALIZER.writeValueAsBytes(fleetStatusDetails).length;\n+\n+            // The number of chunks to send would be the component byte size divided by the available bytes in per\n+            // publish message after adding the fleet status information.\n+            int numberOfChunks = Math.floorDiv(payloadVariableInformationSize,\n+                    MAX_PAYLOAD_LENGTH_BYTES - payloadCommonInformationSize) + 1;\n+            int start = 0;\n+            int numberOfComponentsPerPublish = Math.floorDiv(components.size(), numberOfChunks);\n+            for (int chunkId = 0; chunkId < numberOfChunks; chunkId++, start += numberOfComponentsPerPublish) {\n+                fleetStatusDetails.setComponentStatusDetails(components.subList(start,\n+                        start + numberOfComponentsPerPublish));\n+                this.mqttClient.publish(PublishRequest.builder()\n+                        .qos(QualityOfService.AT_LEAST_ONCE)\n+                        .topic(this.updateFssDataTopic)\n+                        .payload(SERIALIZER.writeValueAsBytes(fleetStatusDetails)).build());\n+            }", "originalCommit": "faef4e3567100a9dd60442faea546487a66ca11d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyMjMzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r471622337", "bodyText": "I do have a unit test for this. But I can make make it into a private function.", "author": "nikkhilmuthye", "createdAt": "2020-08-17T17:08:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMzQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMzU3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r471613572", "bodyText": "Why? For happy path it should be exact once, no?", "author": "leaf94", "createdAt": "2020-08-17T16:58:33Z", "path": "src/test/java/com/aws/iot/evergreen/fss/FleetStatusServiceTest.java", "diffHunk": "@@ -379,7 +383,7 @@ public void GIVEN_component_status_change_WHEN_periodic_update_triggered_THEN_MQ\n         TimeUnit.SECONDS.sleep(5);\n \n         // Verify that an MQTT message with the components' status is uploaded.\n-        verify(mockMqttClient, times(1)).publish(publishRequestArgumentCaptor.capture());\n+        verify(mockMqttClient, atLeast(1)).publish(publishRequestArgumentCaptor.capture());", "originalCommit": "faef4e3567100a9dd60442faea546487a66ca11d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyMDE5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r471620195", "bodyText": "Right. But there are times that the initial delay is too small and then the periodic update triggers again before the test finishes.", "author": "nikkhilmuthye", "createdAt": "2020-08-17T17:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMzU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxNTI1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r471615259", "bodyText": "Related to https://github.com/aws/aws-greengrass-kernel/pull/365/files#r471613415. If you separate this out to another class, say FssMqttPublisher, then you don't have to repeat all this settings in this test. This test will just verify, say FssMqttPublisher::publishWithChunks, gets called. And you can have lightweight tests in FssMqttPublisherTest", "author": "leaf94", "createdAt": "2020-08-17T17:01:30Z", "path": "src/test/java/com/aws/iot/evergreen/fss/FleetStatusServiceTest.java", "diffHunk": "@@ -687,4 +692,85 @@ public void GIVEN_MQTT_connection_interrupted_WHEN_connection_resumes_THEN_MQTT_\n         assertEquals(State.RUNNING, fleetStatusDetails.getComponentStatusDetails().get(0).getState());\n         assertEquals(Collections.singletonList(\"arn:aws:greengrass:testRegion:12345:configuration:testGroup:12\"), fleetStatusDetails.getComponentStatusDetails().get(0).getFleetConfigArns());\n     }\n+\n+    @Test\n+    public void GIVEN_large_num_component_status_change_WHEN_deployment_finishes_THEN_MQTT_Sent_with_fss_data_with_overall_healthy_state()\n+            throws ServiceLoadException, IOException, InterruptedException {\n+        // Set up all the topics\n+        int numServices = 1500;\n+        Topic periodicUpdateIntervalMsTopic = Topic.of(context, FLEET_STATUS_PERIODIC_UPDATE_INTERVAL_SEC, \"10\");\n+        Topics allComponentToGroupsTopics = Topics.of(context, GROUP_TO_ROOT_COMPONENTS_TOPICS, null);\n+        Topic groupTopic1 = Topic.of(context, \"arn:aws:greengrass:testRegion:12345:configuration:testGroup:12\",\n+                true);\n+\n+        List<EvergreenService> evergreenServices = new ArrayList<>();\n+        Set<String> serviceNamesToCheck = new HashSet<>();\n+        for (int i = 0; i < numServices; i++) {\n+            String serviceName = String.format(\"MockService-%s\", i);\n+            Topics groupsTopics = Topics.of(context, serviceName, allComponentToGroupsTopics);\n+            groupsTopics.children.put(serviceName, groupTopic1);\n+            allComponentToGroupsTopics.children.put(serviceName, groupsTopics);\n+            EvergreenService evergreenService = mock(EvergreenService.class);\n+            when(evergreenService.getName()).thenReturn(serviceName);\n+            when(evergreenService.getState()).thenReturn(State.RUNNING);\n+            when(evergreenService.getServiceConfig()).thenReturn(config);\n+\n+            evergreenServices.add(evergreenService);\n+            serviceNamesToCheck.add(serviceName);\n+        }\n+        lenient().when(config.lookupTopics(COMPONENTS_TO_GROUPS_TOPICS)).thenReturn(allComponentToGroupsTopics);\n+\n+        // Set up all the mocks\n+        when(mockDeploymentStatusKeeper.registerDeploymentStatusConsumer(any(), consumerArgumentCaptor.capture(), anyString())).thenReturn(true);\n+        when(mockKernel.locate(DeploymentService.DEPLOYMENT_SERVICE_TOPICS)).thenReturn(mockDeploymentService);\n+        when(mockKernel.orderedDependencies()).thenReturn(evergreenServices);\n+        when(mockDeploymentService.getConfig()).thenReturn(config);\n+        doNothing().when(context).addGlobalStateChangeListener(addGlobalStateChangeListenerArgumentCaptor.capture());\n+        when(config.lookup(PARAMETERS_CONFIG_KEY, FLEET_STATUS_PERIODIC_UPDATE_INTERVAL_SEC))\n+                .thenReturn(periodicUpdateIntervalMsTopic);\n+        when(context.get(ScheduledExecutorService.class)).thenReturn(ses);\n+\n+        // Create the fleet status service instance\n+        fleetStatusService = new FleetStatusService(config, mockMqttClient,\n+                mockDeploymentStatusKeeper, mockKernel, mockDeviceConfiguration);\n+        fleetStatusService.startup();\n+\n+        // Update the job status for an ongoing deployment to SUCCEEDED.\n+        HashMap<String, Object> map = new HashMap<>();\n+        map.put(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS, JobStatus.IN_PROGRESS.toString());\n+        map.put(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID, \"testJob\");\n+        consumerArgumentCaptor.getValue().apply(map);\n+\n+        // Update the state of an EG service.", "originalCommit": "faef4e3567100a9dd60442faea546487a66ca11d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "506cdb12235ab1196655fe7e30711e9949421b3e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/506cdb12235ab1196655fe7e30711e9949421b3e", "message": "Address PR comments. Add ChunkedPublisher class to reuse MQTT chunking logic.", "committedDate": "2020-08-17T21:33:21Z", "type": "commit"}, {"oid": "16597f6a92431bc2b729cf65977c8ed509274a45", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/16597f6a92431bc2b729cf65977c8ed509274a45", "message": "Fix JSON name for overallStatus to overallDeviceStatus.", "committedDate": "2020-08-18T02:20:58Z", "type": "commit"}, {"oid": "19de4bfa2c76cf717c03994c35cbe823a6228168", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19de4bfa2c76cf717c03994c35cbe823a6228168", "message": "Merge branch 'master' into fssWithJitterAndChunking", "committedDate": "2020-08-18T03:34:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzNTY1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r472335659", "bodyText": "remove space before SPDX", "author": "MikeDombo", "createdAt": "2020-08-18T16:44:23Z", "path": "src/main/java/com/aws/iot/evergreen/util/MqttChunkedPayloadPublisher.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *   SPDX-License-Identifier: Apache-2.0", "originalCommit": "19de4bfa2c76cf717c03994c35cbe823a6228168", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2ODEwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r472368108", "bodyText": "Nit- Why is this in the utils package? this looks specific to fss since you have that topic hardcoded below, then can we move this to the fss package?", "author": "shaguptashaikh", "createdAt": "2020-08-18T17:36:05Z", "path": "src/main/java/com/aws/iot/evergreen/util/MqttChunkedPayloadPublisher.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *   SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util;\n+\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.mqtt.MqttClient;\n+import com.aws.iot.evergreen.mqtt.PublishRequest;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.Setter;\n+import software.amazon.awssdk.crt.mqtt.QualityOfService;\n+\n+import java.util.List;\n+\n+public class MqttChunkedPayloadPublisher<T> {", "originalCommit": "19de4bfa2c76cf717c03994c35cbe823a6228168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NTQ1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r472375459", "bodyText": "I put this in the utils folders since even telemetry metrics agent will use this. The topic is set from the component which uses this class.", "author": "nikkhilmuthye", "createdAt": "2020-08-18T17:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2ODEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUyODYxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r473528615", "bodyText": "Sweet...", "author": "leaf94", "createdAt": "2020-08-20T01:55:49Z", "path": "src/main/java/com/aws/iot/evergreen/fss/FleetStatusService.java", "diffHunk": "@@ -345,27 +347,7 @@ private void uploadFleetStatusServiceData(Set<EvergreenService> evergreenService\n                 .ggcVersion(KERNEL_VERSION)\n                 .sequenceNumber(sequenceNumber)\n                 .build();\n-        try {\n-            int payloadVariableInformationSize = SERIALIZER.writeValueAsBytes(components).length;\n-            int payloadCommonInformationSize = SERIALIZER.writeValueAsBytes(fleetStatusDetails).length;\n-\n-            // The number of chunks to send would be the component byte size divided by the available bytes in per\n-            // publish message after adding the fleet status information.\n-            int numberOfChunks = Math.floorDiv(payloadVariableInformationSize,\n-                    MAX_PAYLOAD_LENGTH_BYTES - payloadCommonInformationSize) + 1;\n-            int start = 0;\n-            int numberOfComponentsPerPublish = Math.floorDiv(components.size(), numberOfChunks);\n-            for (int chunkId = 0; chunkId < numberOfChunks; chunkId++, start += numberOfComponentsPerPublish) {\n-                fleetStatusDetails.setComponentStatusDetails(components.subList(start,\n-                        start + numberOfComponentsPerPublish));\n-                this.mqttClient.publish(PublishRequest.builder()\n-                        .qos(QualityOfService.AT_LEAST_ONCE)\n-                        .topic(this.updateFssDataTopic)\n-                        .payload(SERIALIZER.writeValueAsBytes(fleetStatusDetails)).build());\n-            }\n-        } catch (JsonProcessingException e) {\n-            logger.atError().cause(e).log(\"Unable to publish fleet status service.\");\n-        }\n+        publisher.publish(components, fleetStatusDetails);", "originalCommit": "19de4bfa2c76cf717c03994c35cbe823a6228168", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUyODgyMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r473528820", "bodyText": "nit - missing copyright", "author": "leaf94", "createdAt": "2020-08-20T01:56:10Z", "path": "src/main/java/com/aws/iot/evergreen/util/CommonPayload.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package com.aws.iot.evergreen.util;", "originalCommit": "19de4bfa2c76cf717c03994c35cbe823a6228168", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzMDE2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r473530163", "bodyText": "Can this two be with constructor?", "author": "leaf94", "createdAt": "2020-08-20T01:58:11Z", "path": "src/main/java/com/aws/iot/evergreen/util/MqttChunkedPayloadPublisher.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *   SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util;\n+\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.mqtt.MqttClient;\n+import com.aws.iot.evergreen.mqtt.PublishRequest;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.Setter;\n+import software.amazon.awssdk.crt.mqtt.QualityOfService;\n+\n+import java.util.List;\n+\n+public class MqttChunkedPayloadPublisher<T> {\n+    private static final Logger logger = LogManager.getLogger(MqttChunkedPayloadPublisher.class);\n+    private final MqttClient mqttClient;\n+    private static final ObjectMapper SERIALIZER = new ObjectMapper();\n+    @Setter\n+    private String updateFssDataTopic;\n+    @Setter\n+    private int maxPayloadLengthBytes;\n+\n+    public MqttChunkedPayloadPublisher(MqttClient mqttClient) {\n+        this.mqttClient = mqttClient;\n+    }", "originalCommit": "19de4bfa2c76cf717c03994c35cbe823a6228168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5ODgxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r474298815", "bodyText": "Synced offline. Kept the two setters separate since they can change based on config changes.", "author": "nikkhilmuthye", "createdAt": "2020-08-20T22:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzMDE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzNjA5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r473536090", "bodyText": "I guess I understand what you are trying to achieve. The signature is a little confusing though.\nWhy does a CommonPayload needs to set variable payload..?\nMaybe you can have a ChunkablePayload<T> (wrong grammar for sure but you get the meaning), which has a\ngetCommonPayload() and List<T> getVariablePayload().\nAnd then the publisher will just take the ChunkablePayload which could be implemented by FSS or Telemetry's DTO (data transfer object)", "author": "leaf94", "createdAt": "2020-08-20T02:07:43Z", "path": "src/main/java/com/aws/iot/evergreen/util/CommonPayload.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package com.aws.iot.evergreen.util;\n+\n+import java.util.List;\n+\n+public interface CommonPayload<T> {\n+    void setVariablePayload(List<T> variablePayload);\n+}", "originalCommit": "19de4bfa2c76cf717c03994c35cbe823a6228168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4ODEzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r474288137", "bodyText": "Synced up offline. We will rename CommonPayload to Chunkable. This is to keep the interface naming convention appropriately.\nIn Java, interfaces names, generally, should be adjectives. Interfaces should be in titlecase with the first letter of each separate word capitalized", "author": "nikkhilmuthye", "createdAt": "2020-08-20T21:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzNjA5MA=="}], "type": "inlineReview"}, {"oid": "e07dd3f6c8a91f3eff9754a3503196c509e679c0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e07dd3f6c8a91f3eff9754a3503196c509e679c0", "message": "Address PR comments.", "committedDate": "2020-08-20T14:57:54Z", "type": "commit"}, {"oid": "2a907f24435491f8c27812f1b964be80e02f62fe", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2a907f24435491f8c27812f1b964be80e02f62fe", "message": "Merge branch 'fssWithJitterAndChunking' of github.com:aws/aws-greengrass-kernel into fssWithJitterAndChunking", "committedDate": "2020-08-20T21:26:12Z", "type": "commit"}, {"oid": "f22e88b5bd153caf766ea3d89fa42ec2dbe284c4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f22e88b5bd153caf766ea3d89fa42ec2dbe284c4", "message": "Address PR comments.", "committedDate": "2020-08-20T21:26:53Z", "type": "commit"}, {"oid": "0a14d362535b0fef9f52d876174adbac9cacc79d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0a14d362535b0fef9f52d876174adbac9cacc79d", "message": "Merge branch 'master' into fssWithJitterAndChunking", "committedDate": "2020-08-20T21:35:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk2OTA3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r474969076", "bodyText": "nit: naming of the variables doesn't match the description\nMay not be the best idea, but I feel Chunkable is more like variablePayloadChunk consumer", "author": "hui-yang", "createdAt": "2020-08-21T21:02:52Z", "path": "src/main/java/com/aws/iot/evergreen/util/MqttChunkedPayloadPublisher.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *  SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util;\n+\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.mqtt.MqttClient;\n+import com.aws.iot.evergreen.mqtt.PublishRequest;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.Setter;\n+import software.amazon.awssdk.crt.mqtt.QualityOfService;\n+\n+import java.util.List;\n+\n+public class MqttChunkedPayloadPublisher<T> {\n+    private static final Logger logger = LogManager.getLogger(MqttChunkedPayloadPublisher.class);\n+    private final MqttClient mqttClient;\n+    private static final ObjectMapper SERIALIZER = new ObjectMapper();\n+    @Setter\n+    private String updateFssDataTopic;\n+    @Setter\n+    private int maxPayloadLengthBytes;\n+\n+    public MqttChunkedPayloadPublisher(MqttClient mqttClient) {\n+        this.mqttClient = mqttClient;\n+    }\n+\n+    /**\n+     * Publish the payload using MQTT.\n+     *\n+     * @param chunkablePayload  The common object payload included in all the messages\n+     * @param variablePayloads  The variable objects in the payload to chunk\n+     */", "originalCommit": "0a14d362535b0fef9f52d876174adbac9cacc79d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MTgzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/365#discussion_r474971836", "bodyText": "I feel the name doesn't match what the interface does. Also this interface is not generic beyond telemetry/logging use cases. Do you really need the interface?", "author": "hui-yang", "createdAt": "2020-08-21T21:10:54Z", "path": "src/main/java/com/aws/iot/evergreen/util/Chunkable.java", "diffHunk": "@@ -0,0 +1,10 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.util;\n+\n+import java.util.List;\n+\n+public interface Chunkable<T> {\n+    void setVariablePayload(List<T> variablePayload);", "originalCommit": "0a14d362535b0fef9f52d876174adbac9cacc79d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}