{"pr_number": 428, "pr_title": "Use Jackson instead of custom serializer in tlog", "pr_createdAt": "2020-09-11T01:47:30Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/428", "timeline": [{"oid": "bf467e14fbdb21949b7b1dee6d692ba7fc947170", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bf467e14fbdb21949b7b1dee6d692ba7fc947170", "message": "Use Jackson instead of custom serializer", "committedDate": "2020-09-11T01:58:39Z", "type": "forcePushed"}, {"oid": "a1faa509a8abb6e7d4b9bf73f6f3fad4b6016161", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a1faa509a8abb6e7d4b9bf73f6f3fad4b6016161", "message": "Use Jackson instead of custom serializer", "committedDate": "2020-09-14T22:13:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyNjMyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/428#discussion_r488326321", "bodyText": "reuse objectmapper from utils?", "author": "hui-yang", "createdAt": "2020-09-15T01:23:46Z", "path": "src/main/java/com/aws/iot/evergreen/util/Coerce.java", "diffHunk": "@@ -4,32 +4,23 @@\n package com.aws.iot.evergreen.util;\n \n import com.aws.iot.evergreen.config.Topic;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n \n import java.io.IOException;\n import java.lang.reflect.Array;\n import java.util.Arrays;\n import java.util.List;\n-import java.util.Map;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n import static com.aws.iot.evergreen.util.Utils.isEmpty;\n \n public final class Coerce {\n-    public static final Object removed = new Object() {\n-        @Override\n-        public String toString() {\n-            return \"removed\";\n-        }\n-    };\n-    private static final Map<String, Object> specials =\n-            Utils.immutableMap(\"true\", true, \"false\", false, \"removed\", removed, \"Inf\", Double.POSITIVE_INFINITY,\n-                    \"+Inf\", Double.POSITIVE_INFINITY, \"-Inf\", Double.NEGATIVE_INFINITY, \"Nan\", Double.NaN, \"NaN\",\n-                    Double.NaN, \"inf\", Double.POSITIVE_INFINITY, \"+inf\", Double.POSITIVE_INFINITY, \"-inf\",\n-                    Double.NEGATIVE_INFINITY, \"nan\", Double.NaN);\n-    private static final char[] hex = \"0123456789ABCDEF\".toCharArray();\n-    private static final Pattern seperators = Pattern.compile(\" *, *\");\n+    private static final Pattern SEPARATORS = Pattern.compile(\" *, *\");\n     private static final Pattern unwrap = Pattern.compile(\" *\\\\[ *(.*) *\\\\] *\");\n+    private static final ObjectMapper MAPPER = new ObjectMapper();", "originalCommit": "a1faa509a8abb6e7d4b9bf73f6f3fad4b6016161", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyNjUwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/428#discussion_r488326503", "bodyText": "Why do we still use comma separated line?", "author": "hui-yang", "createdAt": "2020-09-15T01:24:21Z", "path": "src/main/java/com/aws/iot/evergreen/config/Tlogline.java", "diffHunk": "@@ -49,16 +55,25 @@ static Tlogline fromStringInput(String l) throws InvalidLogException {\n         if (!m.matches()) {\n             throw new InvalidLogException(\"unrecognized log format: \" + l);\n         }\n-        long timestamp = parseLong(m.group(1));\n-        String topicString = m.group(2);\n         WhatHappened action = WhatHappened.valueOf(m.group(3).toLowerCase());", "originalCommit": "a1faa509a8abb6e7d4b9bf73f6f3fad4b6016161", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyNzM2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/428#discussion_r488327360", "bodyText": "Because the whole line isn't json encoded, so we still need a field separator. We should probably switch to jackson for the whole thing.", "author": "MikeDombo", "createdAt": "2020-09-15T01:26:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyNjUwMw=="}], "type": "inlineReview"}, {"oid": "e68d0af088e8a523180bfb2511c294c8bd9f9869", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e68d0af088e8a523180bfb2511c294c8bd9f9869", "message": "Use Jackson instead of custom serializer", "committedDate": "2020-09-16T04:13:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMjk0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/428#discussion_r489602947", "bodyText": "Is this platform-safe?", "author": "hui-yang", "createdAt": "2020-09-16T17:26:41Z", "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java", "diffHunk": "@@ -119,7 +120,8 @@ public synchronized void childChanged(WhatHappened what, Node n) {\n         }\n \n         try {\n-            tlogline.outputTo(out);\n+            Coerce.appendParseableString(tlogline, out);\n+            out.write('\\n');", "originalCommit": "e68d0af088e8a523180bfb2511c294c8bd9f9869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwNDgzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/428#discussion_r489604836", "bodyText": "Doesn't need to be, we just need to be consistent.", "author": "MikeDombo", "createdAt": "2020-09-16T17:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMjk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwNDkzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/428#discussion_r489604935", "bodyText": "And it passes on Windows, so yes.", "author": "MikeDombo", "createdAt": "2020-09-16T17:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMjk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MTEyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/428#discussion_r489691126", "bodyText": "Will this corrupt the tlog if out.write('\\n') takes an exception?", "author": "jbutler", "createdAt": "2020-09-16T19:14:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMjk0Nw=="}], "type": "inlineReview"}, {"oid": "32e9d01389004a745d1f8b39f605dcacc21ee499", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/32e9d01389004a745d1f8b39f605dcacc21ee499", "message": "Use Jackson instead of custom serializer", "committedDate": "2020-09-16T19:43:05Z", "type": "commit"}, {"oid": "32e9d01389004a745d1f8b39f605dcacc21ee499", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/32e9d01389004a745d1f8b39f605dcacc21ee499", "message": "Use Jackson instead of custom serializer", "committedDate": "2020-09-16T19:43:05Z", "type": "forcePushed"}, {"oid": "27f2d3f70c7a00f7406fbe8406688d7b63212acf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/27f2d3f70c7a00f7406fbe8406688d7b63212acf", "message": "Move E2E tests to separate workflow, add IamException as retryable for e2e failures", "committedDate": "2020-09-16T20:21:39Z", "type": "forcePushed"}, {"oid": "18a004644dd3708289548f0b50c1a5e9d9a01c35", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/18a004644dd3708289548f0b50c1a5e9d9a01c35", "message": "Move E2E tests to separate workflow, add IamException as retryable for e2e failures", "committedDate": "2020-09-16T20:34:32Z", "type": "commit"}, {"oid": "18a004644dd3708289548f0b50c1a5e9d9a01c35", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/18a004644dd3708289548f0b50c1a5e9d9a01c35", "message": "Move E2E tests to separate workflow, add IamException as retryable for e2e failures", "committedDate": "2020-09-16T20:34:32Z", "type": "forcePushed"}]}