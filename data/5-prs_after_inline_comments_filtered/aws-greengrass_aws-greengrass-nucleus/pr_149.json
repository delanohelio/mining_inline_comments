{"pr_number": 149, "pr_title": "Package store cleanup", "pr_createdAt": "2020-04-02T02:34:44Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149", "timeline": [{"oid": "f383ca5c0ca0811db3c3366b8360fa1a03f303f3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f383ca5c0ca0811db3c3366b8360fa1a03f303f3", "message": "save", "committedDate": "2020-04-02T01:50:35Z", "type": "commit"}, {"oid": "9c7a46a4f6bec7120e75fe4e725b1a1e23d3716d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9c7a46a4f6bec7120e75fe4e725b1a1e23d3716d", "message": "save", "committedDate": "2020-04-02T01:51:42Z", "type": "commit"}, {"oid": "5de30b4e44ee590a90ccde4867b9bdbc280f1eb0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5de30b4e44ee590a90ccde4867b9bdbc280f1eb0", "message": "all test passed", "committedDate": "2020-04-02T02:09:04Z", "type": "commit"}, {"oid": "01e4ccc11e656bd92266bda5a0617625518d672a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01e4ccc11e656bd92266bda5a0617625518d672a", "message": "done", "committedDate": "2020-04-02T02:10:47Z", "type": "commit"}, {"oid": "fa54b13d22fb9fc8052e8fd9e8031df274e12dba", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fa54b13d22fb9fc8052e8fd9e8031df274e12dba", "message": "Merge branch 'master' into package_store_cleanup", "committedDate": "2020-04-02T02:36:04Z", "type": "commit"}, {"oid": "2fd3ccec9f5612e93eab8f313d6e9226eb23a2cf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2fd3ccec9f5612e93eab8f313d6e9226eb23a2cf", "message": "Add copyright header to PackageStore", "committedDate": "2020-04-02T02:44:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyMDQwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#discussion_r402020406", "bodyText": "This needs to be injected from Config or something.", "author": "MikeDombo", "createdAt": "2020-04-02T02:42:16Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.aws.iot.evergreen.packagemanager.config.Constants;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackagingException;\n+import com.aws.iot.evergreen.packagemanager.exceptions.UnexpectedPackagingException;\n+import com.aws.iot.evergreen.packagemanager.exceptions.UnsupportedRecipeFormatException;\n+import com.aws.iot.evergreen.packagemanager.models.Package;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStoreDeprecated;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.SemverException;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Future;\n+\n+@SuppressWarnings({\"PMD.AvoidPrintStackTrace\", \"PMD.IdenticalCatchBranches\"})\n+public class PackageStore {\n+    private static final Path LOCAL_CACHE_PATH =", "originalCommit": "fa54b13d22fb9fc8052e8fd9e8031df274e12dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1MzMxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#discussion_r402053315", "bodyText": "Correct! That's the plan. Just keeping it as a local constant as is.", "author": "leaf94", "createdAt": "2020-04-02T05:04:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyMDQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyMTQ4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#discussion_r402021480", "bodyText": "Where did all this go? Looks like this hasn't been copied over to PackageStore. Feels like we still need it, or am I wrong?", "author": "MikeDombo", "createdAt": "2020-04-02T02:46:29Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageManager.java", "diffHunk": "@@ -1,282 +0,0 @@\n-/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0 */\n-\n-package com.aws.iot.evergreen.packagemanager;\n-\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackageVersionConflictException;\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackagingException;\n-import com.aws.iot.evergreen.packagemanager.models.Package;\n-import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n-import com.aws.iot.evergreen.packagemanager.models.PackageRegistryEntry;\n-import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n-import com.aws.iot.evergreen.packagemanager.plugins.PackageStore;\n-import com.vdurmont.semver4j.Semver;\n-\n-import java.io.IOException;\n-import java.nio.file.Path;\n-import java.nio.file.Paths;\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.LinkedList;\n-import java.util.Map;\n-import java.util.Optional;\n-import java.util.Queue;\n-import java.util.Set;\n-import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.Executors;\n-import java.util.concurrent.Future;\n-import java.util.function.Function;\n-import java.util.stream.Collectors;\n-\n-public class PackageManager {\n-\n-    // TODO: Temporary hard coding, this should be initialized from config\n-    private static final Path CACHE_DIRECTORY = Paths.get(System.getProperty(\"user.dir\")).resolve(\"artifact_cache\");\n-    private static final Path LOCAL_PACKAGE_SOURCE =\n-            Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n-\n-    private final ExecutorService executorService = Executors.newSingleThreadExecutor();\n-\n-    private final PackageRegistry packageRegistry;\n-\n-    private final PackageStore localCache;\n-\n-    // TODO: Temporary, should be list of stores\n-    private final PackageStore mockPackageRepository;\n-\n-    /**\n-     * Constructor with hardcoded local cache and mock source paths.\n-     */\n-    public PackageManager() {\n-        this.localCache = new LocalPackageStore(CACHE_DIRECTORY);\n-        this.mockPackageRepository = new LocalPackageStore(LOCAL_PACKAGE_SOURCE);\n-        this.packageRegistry = new PackageRegistryImpl();\n-    }\n-\n-    //TODO mock package store in unit tests, remove this constructor\n-    @Deprecated\n-    PackageManager(final PackageRegistry packageRegistry, final Path cacheDirPath, final Path mockDirPath) {\n-        this.localCache = new LocalPackageStore(cacheDirPath);\n-        this.mockPackageRepository = new LocalPackageStore(mockDirPath);\n-        this.packageRegistry = packageRegistry;\n-    }\n-\n-    PackageManager(final PackageRegistry packageRegistry, PackageStore localCache, PackageStore mockRepository) {\n-        this.localCache = localCache;\n-        this.packageRegistry = packageRegistry;\n-        this.mockPackageRepository = mockRepository;\n-    }\n-\n-    /**\n-     * Given a set of proposed package dependency trees.\n-     *\n-     * @param proposedPackages The set of proposed packages to resolve dependencies for\n-     * @return the local resolved dependency tress in the future\n-     */\n-    public Future<Set<Package>> resolvePackages(Set<PackageMetadata> proposedPackages) {\n-        return executorService.submit(() -> resolveDependencies(proposedPackages));\n-    }\n-\n-    private Set<Package> resolveDependencies(Set<PackageMetadata> proposedPackages)", "originalCommit": "2fd3ccec9f5612e93eab8f313d6e9226eb23a2cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1Mjc0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#discussion_r402052746", "bodyText": "I've synced with Jason and Feng and this is essentially get broken down into PackageStore + DependencyResolver so we don't need this class anymore... You are right that a small amount of code for downloading are not copied over. Jason will probably just refer to it when implementing the downloading functions.", "author": "leaf94", "createdAt": "2020-04-02T05:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyMTQ4MA=="}], "type": "inlineReview"}, {"oid": "54f3809eae99db16848d7d39b602c4c1103a1bfe", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/54f3809eae99db16848d7d39b602c4c1103a1bfe", "message": "checkstyle", "committedDate": "2020-04-02T04:53:57Z", "type": "commit"}, {"oid": "7c9ce7cbd3663ea7b73c777eed31c5357d02e329", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7c9ce7cbd3663ea7b73c777eed31c5357d02e329", "message": "Clean up used imports", "committedDate": "2020-04-02T17:00:42Z", "type": "commit"}, {"oid": "8bd7e30f2287d9f9d51bc116b7e0d1dd8e105f3d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8bd7e30f2287d9f9d51bc116b7e0d1dd8e105f3d", "message": "Clean up used imports", "committedDate": "2020-04-02T17:10:25Z", "type": "commit"}]}