{"pr_number": 716, "pr_title": "init nucleus boostrap script", "pr_createdAt": "2020-11-23T15:22:42Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716", "timeline": [{"oid": "2393e5092b5fd11c43839763a146ae9a3f127abc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2393e5092b5fd11c43839763a146ae9a3f127abc", "message": "init nucleus boostrap script", "committedDate": "2020-11-23T15:13:18Z", "type": "commit"}, {"oid": "c880f2d600e71513762f82d5dde02801d6743c5e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c880f2d600e71513762f82d5dde02801d6743c5e", "message": "code style", "committedDate": "2020-11-23T15:30:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc5NDU2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528794561", "bodyText": "We have a constant in Lifecycle.java with lower case \"requiresPrivilege\". However, actual deployment config has upper case.", "author": "tilo-chen", "createdAt": "2020-11-23T15:39:05Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -162,6 +175,19 @@ private void initPaths(String rootAbsolutePath) {\n             // Initialize file and directory managers after kernel root directory is set up\n             deploymentDirectoryManager = new DeploymentDirectoryManager(kernel, nucleusPaths);\n             kernel.getContext().put(DeploymentDirectoryManager.class, deploymentDirectoryManager);\n+\n+            // Initialize default nucleus bootstrap script with provided paths\n+            ComponentIdentifier nucleusComponentId =\n+                    new ComponentIdentifier(DEFAULT_NUCLEUS_COMPONENT_NAME, new Semver(KernelVersion.KERNEL_VERSION));\n+            String rootPath = nucleusPaths.rootPath().toAbsolutePath().toString();\n+            String unarchivePath = nucleusPaths.unarchiveArtifactPath(nucleusComponentId).toAbsolutePath().toString();\n+            String bootstrapScript = String.format(DEFAULT_NUCLEUS_BOOTSTRAP_TEMPLATE, rootPath, unarchivePath);\n+            kernel.getConfig()\n+                    .lookup(SERVICES_NAMESPACE_TOPIC, DEFAULT_NUCLEUS_COMPONENT_NAME, SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                            LIFECYCLE_BOOTSTRAP_NAMESPACE_TOPIC, \"script\").dflt(bootstrapScript);\n+            kernel.getConfig()\n+                    .lookup(SERVICES_NAMESPACE_TOPIC, DEFAULT_NUCLEUS_COMPONENT_NAME, SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                            LIFECYCLE_BOOTSTRAP_NAMESPACE_TOPIC, \"RequiresPrivilege\").dflt(true);", "originalCommit": "c880f2d600e71513762f82d5dde02801d6743c5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxNTE0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528815147", "bodyText": "It is case insensitive. Use the constant.", "author": "MikeDombo", "createdAt": "2020-11-23T16:02:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc5NDU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgyMDY0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528820642", "bodyText": "Unfortunately if the case don't match, this comparison fails and it still restarts: https://github.com/aws/aws-greengrass-nucleus/blob/master/src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java#L239", "author": "tilo-chen", "createdAt": "2020-11-23T16:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc5NDU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgyMjExMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528822110", "bodyText": "Since it is case insensitive, change the value of the const to be PascalCase", "author": "MikeDombo", "createdAt": "2020-11-23T16:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc5NDU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxNDY0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528814640", "bodyText": "why are we setting these heap values?", "author": "MikeDombo", "createdAt": "2020-11-23T16:01:54Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -56,6 +62,13 @@\n     private static final String deploymentsPathName = \"~root/deployments\";\n     private static final String cliIpcInfoPathName = \"~root/cli_ipc_info\";\n     private static final String binPathName = \"~root/bin\";\n+    public static final String DEFAULT_NUCLEUS_BOOTSTRAP_TEMPLATE = \"set -eu%n\"\n+            + \"KERNEL_ROOT=\\\"%s\\\"%n\"\n+            + \"UNPACK_DIR=\\\"%s/aws.greengrass.nucleus\\\"%n\"\n+            + \"# TODO: Use builtin unpack functionality with permission preserved if available%n\"\n+            + \"chmod +x \\\"$UNPACK_DIR/bin/loader\\\"%n\" + \"%n\" + \"rm -r \\\"$KERNEL_ROOT\\\"/alts/current/*%n%n\"\n+            + \"echo \\\"-Xms512m -Xmx512m\\\" > \\\"$KERNEL_ROOT/alts/current/launch.params\\\"%n\"", "originalCommit": "c880f2d600e71513762f82d5dde02801d6743c5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxNzk4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528817981", "bodyText": "This jvm option is getting deployed in UAT. And it's in this (default?) recipe https://github.com/aws/aws-greengrass-nucleus/blob/master/aws.greengrass.Nucleus.yaml", "author": "tilo-chen", "createdAt": "2020-11-23T16:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxNDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxOTUxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528819514", "bodyText": "That shouldn't be in the recipe. That should come from the configuration of the service and not by default", "author": "MikeDombo", "createdAt": "2020-11-23T16:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxNDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0OTkwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528949908", "bodyText": "I think Tilo did this because the recipe has defaults for these right now and in deployments if no values are set for these then the defaults will be used. If these are not the right defaults or should not have default values at all they should be removed from the recipe and the correct value in use at the time of launch should be used here. @hui-yang Can you comment on this?", "author": "shaguptashaikh", "createdAt": "2020-11-23T19:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxNDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5MTEyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r528991121", "bodyText": "This seems correct to me for the default value in recipe. But is it possible to get the actual settings from the current JVM?", "author": "hui-yang", "createdAt": "2020-11-23T20:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxNDY0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAyNDQ1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r529024452", "bodyText": "Can we extract this logic to a method?", "author": "shaguptashaikh", "createdAt": "2020-11-23T22:02:04Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -162,6 +175,19 @@ private void initPaths(String rootAbsolutePath) {\n             // Initialize file and directory managers after kernel root directory is set up\n             deploymentDirectoryManager = new DeploymentDirectoryManager(kernel, nucleusPaths);\n             kernel.getContext().put(DeploymentDirectoryManager.class, deploymentDirectoryManager);\n+\n+            // Initialize default nucleus bootstrap script with provided paths", "originalCommit": "c880f2d600e71513762f82d5dde02801d6743c5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwNzAxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r529207011", "bodyText": "\ud83d\udc4d", "author": "tilo-chen", "createdAt": "2020-11-24T05:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAyNDQ1Mg=="}], "type": "inlineReview"}, {"oid": "5a1b5d3efd3c0147fa6a876a62c37260d6a5f57d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5a1b5d3efd3c0147fa6a876a62c37260d6a5f57d", "message": "fixes", "committedDate": "2020-11-24T05:11:04Z", "type": "commit"}, {"oid": "d5d11816d9b27a4e330aa4341c33901b9f84d7e8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5d11816d9b27a4e330aa4341c33901b9f84d7e8", "message": "Merge branch 'master' into nuc-boot-script", "committedDate": "2020-11-24T05:11:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMjgzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r529802837", "bodyText": "Maybe remove this todo. I've removed it from recipes earlier https://github.com/aws/aws-greengrass-nucleus/blob/master/aws.greengrass.Nucleus.yaml", "author": "hui-yang", "createdAt": "2020-11-24T18:48:48Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -56,6 +65,13 @@\n     private static final String deploymentsPathName = \"~root/deployments\";\n     private static final String cliIpcInfoPathName = \"~root/cli_ipc_info\";\n     private static final String binPathName = \"~root/bin\";\n+    public static final String DEFAULT_NUCLEUS_BOOTSTRAP_TEMPLATE = \"set -eu%n\"\n+            + \"KERNEL_ROOT=\\\"%s\\\"%n\"\n+            + \"UNPACK_DIR=\\\"%s/aws.greengrass.nucleus\\\"%n\"\n+            + \"# TODO: Use builtin unpack functionality with permission preserved if available%n\"", "originalCommit": "d5d11816d9b27a4e330aa4341c33901b9f84d7e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMzAyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r529803027", "bodyText": "don't need +?", "author": "hui-yang", "createdAt": "2020-11-24T18:49:06Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -56,6 +65,13 @@\n     private static final String deploymentsPathName = \"~root/deployments\";\n     private static final String cliIpcInfoPathName = \"~root/cli_ipc_info\";\n     private static final String binPathName = \"~root/bin\";\n+    public static final String DEFAULT_NUCLEUS_BOOTSTRAP_TEMPLATE = \"set -eu%n\"\n+            + \"KERNEL_ROOT=\\\"%s\\\"%n\"\n+            + \"UNPACK_DIR=\\\"%s/aws.greengrass.nucleus\\\"%n\"\n+            + \"# TODO: Use builtin unpack functionality with permission preserved if available%n\"\n+            + \"chmod +x \\\"$UNPACK_DIR/bin/loader\\\"%n\" + \"%n\" + \"rm -r \\\"$KERNEL_ROOT\\\"/alts/current/*%n%n\"", "originalCommit": "d5d11816d9b27a4e330aa4341c33901b9f84d7e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMzI5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r529803298", "bodyText": "don't need +?", "author": "hui-yang", "createdAt": "2020-11-24T18:49:32Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -56,6 +65,13 @@\n     private static final String deploymentsPathName = \"~root/deployments\";\n     private static final String cliIpcInfoPathName = \"~root/cli_ipc_info\";\n     private static final String binPathName = \"~root/bin\";\n+    public static final String DEFAULT_NUCLEUS_BOOTSTRAP_TEMPLATE = \"set -eu%n\"\n+            + \"KERNEL_ROOT=\\\"%s\\\"%n\"\n+            + \"UNPACK_DIR=\\\"%s/aws.greengrass.nucleus\\\"%n\"\n+            + \"# TODO: Use builtin unpack functionality with permission preserved if available%n\"\n+            + \"chmod +x \\\"$UNPACK_DIR/bin/loader\\\"%n\" + \"%n\" + \"rm -r \\\"$KERNEL_ROOT\\\"/alts/current/*%n%n\"\n+            + \"echo \\\"%s\\\" > \\\"$KERNEL_ROOT/alts/current/launch.params\\\"%n\"\n+            + \"ln -sf \\\"$UNPACK_DIR\\\" \\\"$KERNEL_ROOT/alts/current/distro\\\"%n\" + \"exit 100\";", "originalCommit": "d5d11816d9b27a4e330aa4341c33901b9f84d7e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9000382e09b86a0882e93ebbf1f5b00b05fea811", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9000382e09b86a0882e93ebbf1f5b00b05fea811", "message": "comments", "committedDate": "2020-11-24T20:13:08Z", "type": "commit"}, {"oid": "aab5f94794531446675741719c0efe4a081c96ab", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aab5f94794531446675741719c0efe4a081c96ab", "message": "Merge branch 'master' into nuc-boot-script", "committedDate": "2020-11-24T20:13:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxODc2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r530018762", "bodyText": "If we initialize with these options, which is definitely right, do we still need defaults in the recipe? Won't the next deployment try to reevaluate the bootstrap script topic with those defaults and restart if they're different from what you get here?", "author": "shaguptashaikh", "createdAt": "2020-11-24T23:52:09Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -177,6 +196,23 @@ private void initPaths(String rootAbsolutePath) {\n         kernel.getContext().get(KernelAlternatives.class);\n     }\n \n+    private void initNucleusBootstrapScript() throws IOException {\n+        // get current jvm options. sorted so that the order is consistent\n+        String jvmOptions = ManagementFactory.getRuntimeMXBean().getInputArguments().stream().sorted()", "originalCommit": "aab5f94794531446675741719c0efe4a081c96ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxOTIxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r530019219", "bodyText": "If that is a problem, should we also add the jvmOptions configuration topic with these values that actually gets used during launch?", "author": "shaguptashaikh", "createdAt": "2020-11-24T23:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAyNDM4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r530024385", "bodyText": "Yeah if we already launched it with the default jvmOptions (maybe when the user copies the install command from cloud console or via other methods), then no need to put it in recipe unless we intend to change it. As long as we're consistent it shouldn't cause unexpected restart.\nBTW jvmOptions is not in DeviceConfigurations right now. This needs to be added right?", "author": "tilo-chen", "createdAt": "2020-11-25T00:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxODc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0NDg4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/716#discussion_r530644884", "bodyText": "If you make a nucleus component deployment and have a value for this config (default or set by customer) it will end up creating a topic under services:aws.greengrass.Nucleus:configuration: anyway, so I don't see any harm in adding it, we probably don't need any getters etc because we don't need them anywhere else in the code", "author": "shaguptashaikh", "createdAt": "2020-11-25T21:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAxODc2Mg=="}], "type": "inlineReview"}, {"oid": "97aa2f3677aa39b7dd93e74eb6bb1b9516bf5019", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/97aa2f3677aa39b7dd93e74eb6bb1b9516bf5019", "message": "init in device config", "committedDate": "2020-11-27T14:14:03Z", "type": "commit"}, {"oid": "e28302cac6dc29cdc4d3707ab06b8b2cf5b0fb6c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e28302cac6dc29cdc4d3707ab06b8b2cf5b0fb6c", "message": "Merge branch 'master' into nuc-boot-script", "committedDate": "2020-11-27T14:17:07Z", "type": "commit"}, {"oid": "94a3361484691876ab9c68bea137e88783bfc827", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/94a3361484691876ab9c68bea137e88783bfc827", "message": "fix mainline merge", "committedDate": "2020-11-27T14:33:43Z", "type": "commit"}, {"oid": "4edd8c2879cccafc69a7e34e14b6ee2af79fbc46", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4edd8c2879cccafc69a7e34e14b6ee2af79fbc46", "message": "Merge branch 'master' into nuc-boot-script", "committedDate": "2020-11-30T16:00:59Z", "type": "commit"}, {"oid": "848bcbbb13ac98fd5252faf3a309df632ca46b7a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/848bcbbb13ac98fd5252faf3a309df632ca46b7a", "message": "Merge branch 'master' into nuc-boot-script", "committedDate": "2020-12-01T16:11:18Z", "type": "commit"}, {"oid": "4d20c4b2321864be13d51c260cc520416b88d6be", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4d20c4b2321864be13d51c260cc520416b88d6be", "message": "Merge branch 'master' into nuc-boot-script", "committedDate": "2020-12-01T18:17:28Z", "type": "commit"}]}