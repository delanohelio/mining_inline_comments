{"pr_number": 256, "pr_title": "Rewrite DeviceConfiguration to be dynamic and move configs under \"system\" namespace", "pr_createdAt": "2020-05-22T23:19:16Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256", "timeline": [{"oid": "4b21f3f95c65bf3e4545b919fb3a93b5823cb9af", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4b21f3f95c65bf3e4545b919fb3a93b5823cb9af", "message": "Clean DeviceConfiguration to be dynamic", "committedDate": "2020-05-23T00:00:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxODU1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430618555", "bodyText": "Why can't this return string directly? Same for the other fields. We can provide an API for topic update in this class, instead of exposing topics to Util", "author": "ShirleyZheng92", "createdAt": "2020-05-26T18:25:25Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *   SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment;\n+\n+import com.amazonaws.SdkClientException;\n+import com.amazonaws.regions.DefaultAwsRegionProviderChain;\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Validator;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import com.aws.iot.evergreen.util.Utils;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.inject.Inject;\n+\n+/**\n+ * Class for providing device configuration information.\n+ */\n+@SuppressWarnings(\"PMD.DataClass\")\n+@SuppressFBWarnings(\"IS2_INCONSISTENT_SYNC\")\n+public class DeviceConfiguration {\n+\n+    public static final String DEVICE_PARAM_THING_NAME = \"thingName\";\n+    public static final String DEVICE_PARAM_IOT_DATA_ENDPOINT = \"iotDataEndpoint\";\n+    public static final String DEVICE_PARAM_IOT_CRED_ENDPOINT = \"iotCredEndpoint\";\n+    public static final String DEVICE_PARAM_PRIVATE_KEY_PATH = \"privateKeyPath\";\n+    public static final String DEVICE_PARAM_CERTIFICATE_FILE_PATH = \"certificateFilePath\";\n+    public static final String DEVICE_PARAM_ROOT_CA_PATH = \"rootCaPath\";\n+    public static final String SYSTEM_NAMESPACE_KEY = \"system\";\n+    private static final String CANNOT_BE_EMPTY = \" cannot be empty\";\n+    private static final String DEVICE_PARAM_AWS_REGION = \"awsRegion\";\n+    private static final Logger logger = LogManager.getLogger(DeviceConfiguration.class);\n+    private static final String FALLBACK_DEFAULT_REGION = \"us-east-1\";\n+\n+    private final Kernel kernel;\n+\n+    private final Validator deTildeValidator;\n+    private final Validator regionValidator;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param kernel Kernel to get config from\n+     */\n+    @Inject\n+    @SuppressWarnings(\"PMD.NullAssignment\")\n+    public DeviceConfiguration(Kernel kernel) {\n+        this.kernel = kernel;\n+        deTildeValidator = (newV, old) -> kernel.deTilde(Coerce.toString(newV));\n+        regionValidator = (newV, old) -> {\n+            // If the region value is empty/null, then try to get the region from the SDK lookup path\n+            if (!(newV instanceof String) || Utils.isEmpty((String) newV)) {\n+                try {\n+                    newV = new DefaultAwsRegionProviderChain().getRegion();\n+                } catch (SdkClientException ex) {\n+                    newV = null;\n+                    logger.atWarn().log(\"Error looking up AWS region\", ex);\n+                }\n+            }\n+            if (Utils.isEmpty((String) newV)) {\n+                logger.atWarn().log(\"No AWS region found, falling back to default: {}\", FALLBACK_DEFAULT_REGION);\n+                newV = FALLBACK_DEFAULT_REGION;\n+            }\n+            return newV;\n+        };\n+        validate();\n+    }\n+\n+    public Topic getThingName() {\n+        return getTopic(DEVICE_PARAM_THING_NAME);\n+    }\n+\n+    public Topic getCertificateFilePath() {\n+        return getTopic(DEVICE_PARAM_CERTIFICATE_FILE_PATH).addValidator(deTildeValidator);\n+    }\n+\n+    public Topic getPrivateKeyFilePath() {", "originalCommit": "b5779c92ebdc77998fc19c35746fb7612bcb030c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYyMjE4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430622181", "bodyText": "I don't want to reinvent the subscription system that Topic already has.", "author": "MikeDombo", "createdAt": "2020-05-26T18:31:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxODU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzNDk0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430634946", "bodyText": "From the code it seems nothing is subscribing these topics. Will we have subscribers in the future?", "author": "ShirleyZheng92", "createdAt": "2020-05-26T18:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxODU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzNzUzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430637538", "bodyText": "Yes, future changes should switch to be subscribers.", "author": "MikeDombo", "createdAt": "2020-05-26T18:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxODU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYyMTI1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430621255", "bodyText": "Does this mean every time user call getAWSRegion() , a validator will be added? This may cause duplicated validators", "author": "ShirleyZheng92", "createdAt": "2020-05-26T18:29:48Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *   SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment;\n+\n+import com.amazonaws.SdkClientException;\n+import com.amazonaws.regions.DefaultAwsRegionProviderChain;\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Validator;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import com.aws.iot.evergreen.util.Utils;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.inject.Inject;\n+\n+/**\n+ * Class for providing device configuration information.\n+ */\n+@SuppressWarnings(\"PMD.DataClass\")\n+@SuppressFBWarnings(\"IS2_INCONSISTENT_SYNC\")\n+public class DeviceConfiguration {\n+\n+    public static final String DEVICE_PARAM_THING_NAME = \"thingName\";\n+    public static final String DEVICE_PARAM_IOT_DATA_ENDPOINT = \"iotDataEndpoint\";\n+    public static final String DEVICE_PARAM_IOT_CRED_ENDPOINT = \"iotCredEndpoint\";\n+    public static final String DEVICE_PARAM_PRIVATE_KEY_PATH = \"privateKeyPath\";\n+    public static final String DEVICE_PARAM_CERTIFICATE_FILE_PATH = \"certificateFilePath\";\n+    public static final String DEVICE_PARAM_ROOT_CA_PATH = \"rootCaPath\";\n+    public static final String SYSTEM_NAMESPACE_KEY = \"system\";\n+    private static final String CANNOT_BE_EMPTY = \" cannot be empty\";\n+    private static final String DEVICE_PARAM_AWS_REGION = \"awsRegion\";\n+    private static final Logger logger = LogManager.getLogger(DeviceConfiguration.class);\n+    private static final String FALLBACK_DEFAULT_REGION = \"us-east-1\";\n+\n+    private final Kernel kernel;\n+\n+    private final Validator deTildeValidator;\n+    private final Validator regionValidator;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param kernel Kernel to get config from\n+     */\n+    @Inject\n+    @SuppressWarnings(\"PMD.NullAssignment\")\n+    public DeviceConfiguration(Kernel kernel) {\n+        this.kernel = kernel;\n+        deTildeValidator = (newV, old) -> kernel.deTilde(Coerce.toString(newV));\n+        regionValidator = (newV, old) -> {\n+            // If the region value is empty/null, then try to get the region from the SDK lookup path\n+            if (!(newV instanceof String) || Utils.isEmpty((String) newV)) {\n+                try {\n+                    newV = new DefaultAwsRegionProviderChain().getRegion();\n+                } catch (SdkClientException ex) {\n+                    newV = null;\n+                    logger.atWarn().log(\"Error looking up AWS region\", ex);\n+                }\n+            }\n+            if (Utils.isEmpty((String) newV)) {\n+                logger.atWarn().log(\"No AWS region found, falling back to default: {}\", FALLBACK_DEFAULT_REGION);\n+                newV = FALLBACK_DEFAULT_REGION;\n+            }\n+            return newV;\n+        };\n+        validate();\n+    }\n+\n+    public Topic getThingName() {\n+        return getTopic(DEVICE_PARAM_THING_NAME);\n+    }\n+\n+    public Topic getCertificateFilePath() {\n+        return getTopic(DEVICE_PARAM_CERTIFICATE_FILE_PATH).addValidator(deTildeValidator);\n+    }\n+\n+    public Topic getPrivateKeyFilePath() {\n+        return getTopic(DEVICE_PARAM_PRIVATE_KEY_PATH).addValidator(deTildeValidator);\n+    }\n+\n+    public Topic getRootCAFilePath() {\n+        return getTopic(DEVICE_PARAM_ROOT_CA_PATH).addValidator(deTildeValidator);\n+    }\n+\n+    public Topic getIotDataEndpoint() {\n+        return getTopic(DEVICE_PARAM_IOT_DATA_ENDPOINT);\n+    }\n+\n+    public Topic getIotCredentialEndpoint() {\n+        return getTopic(DEVICE_PARAM_IOT_CRED_ENDPOINT);\n+    }\n+\n+    public Topic getAWSRegion() {\n+        return getTopic(DEVICE_PARAM_AWS_REGION).addValidator(regionValidator);", "originalCommit": "b5779c92ebdc77998fc19c35746fb7612bcb030c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYyMjUyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430622525", "bodyText": "no, it is a set so it won't be duplicated.", "author": "MikeDombo", "createdAt": "2020-05-26T18:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYyMTI1NQ=="}], "type": "inlineReview"}, {"oid": "01e312f120988e25fc3d76d8477b70ff24134da0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01e312f120988e25fc3d76d8477b70ff24134da0", "message": "Clean DeviceConfiguration to be dynamic", "committedDate": "2020-05-26T19:11:16Z", "type": "forcePushed"}, {"oid": "280a510dfa4b07c346e3b6fc4790f15f106cdb62", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/280a510dfa4b07c346e3b6fc4790f15f106cdb62", "message": "Clean DeviceConfiguration to be dynamic", "committedDate": "2020-05-26T19:42:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwMDExMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430700112", "bodyText": "Can we extract the region from endpoints?", "author": "hui-yang", "createdAt": "2020-05-26T20:50:42Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *   SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment;\n+\n+import com.amazonaws.SdkClientException;\n+import com.amazonaws.regions.DefaultAwsRegionProviderChain;\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Validator;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import com.aws.iot.evergreen.util.Utils;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.inject.Inject;\n+\n+/**\n+ * Class for providing device configuration information.\n+ */\n+@SuppressWarnings(\"PMD.DataClass\")\n+@SuppressFBWarnings(\"IS2_INCONSISTENT_SYNC\")\n+public class DeviceConfiguration {\n+\n+    public static final String DEVICE_PARAM_THING_NAME = \"thingName\";\n+    public static final String DEVICE_PARAM_IOT_DATA_ENDPOINT = \"iotDataEndpoint\";\n+    public static final String DEVICE_PARAM_IOT_CRED_ENDPOINT = \"iotCredEndpoint\";\n+    public static final String DEVICE_PARAM_PRIVATE_KEY_PATH = \"privateKeyPath\";\n+    public static final String DEVICE_PARAM_CERTIFICATE_FILE_PATH = \"certificateFilePath\";\n+    public static final String DEVICE_PARAM_ROOT_CA_PATH = \"rootCaPath\";\n+    public static final String SYSTEM_NAMESPACE_KEY = \"system\";\n+    private static final String CANNOT_BE_EMPTY = \" cannot be empty\";\n+    private static final String DEVICE_PARAM_AWS_REGION = \"awsRegion\";\n+    private static final Logger logger = LogManager.getLogger(DeviceConfiguration.class);\n+    private static final String FALLBACK_DEFAULT_REGION = \"us-east-1\";\n+\n+    private final Kernel kernel;\n+\n+    private final Validator deTildeValidator;\n+    private final Validator regionValidator;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param kernel Kernel to get config from\n+     */\n+    @Inject\n+    @SuppressWarnings(\"PMD.NullAssignment\")\n+    public DeviceConfiguration(Kernel kernel) {\n+        this.kernel = kernel;\n+        deTildeValidator = (newV, old) -> kernel.deTilde(Coerce.toString(newV));\n+        regionValidator = (newV, old) -> {\n+            // If the region value is empty/null, then try to get the region from the SDK lookup path\n+            if (!(newV instanceof String) || Utils.isEmpty((String) newV)) {\n+                try {\n+                    newV = new DefaultAwsRegionProviderChain().getRegion();\n+                } catch (SdkClientException ex) {\n+                    newV = null;\n+                    logger.atWarn().log(\"Error looking up AWS region\", ex);\n+                }\n+            }\n+            if (Utils.isEmpty((String) newV)) {", "originalCommit": "280a510dfa4b07c346e3b6fc4790f15f106cdb62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwMjMyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430702328", "bodyText": "I was thinking more like the other way around; build the endpoint URL from region + unique id, but in any case I think we'll get rid of this region eventually; once the Greengrass services get setup with proper endpoints and auth.\nBut not sure.\nAlso, we're not guaranteed to have those endpoints setup yet anyway, like if we use this method to get the region for the setup script.", "author": "MikeDombo", "createdAt": "2020-05-26T20:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwMDExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwNjUxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/256#discussion_r430706511", "bodyText": "nit:change the name of the argument to deviceConfiguration", "author": "abanthiy", "createdAt": "2020-05-26T21:03:26Z", "path": "src/main/java/com/aws/iot/evergreen/tes/IotConnectionManager.java", "diffHunk": "@@ -43,16 +43,15 @@\n      * @throws DeviceConfigurationException When unable to initialize this manager.\n      */\n     @Inject\n-    IotConnectionManager(final DeviceConfigurationHelper helper) throws DeviceConfigurationException {\n+    IotConnectionManager(final DeviceConfiguration helper) throws DeviceConfigurationException {", "originalCommit": "280a510dfa4b07c346e3b6fc4790f15f106cdb62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6064588975621042f4fad0c117aef04756a3352", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a6064588975621042f4fad0c117aef04756a3352", "message": "Clean DeviceConfiguration to be dynamic", "committedDate": "2020-05-26T21:51:45Z", "type": "commit"}, {"oid": "a6064588975621042f4fad0c117aef04756a3352", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a6064588975621042f4fad0c117aef04756a3352", "message": "Clean DeviceConfiguration to be dynamic", "committedDate": "2020-05-26T21:51:45Z", "type": "forcePushed"}]}