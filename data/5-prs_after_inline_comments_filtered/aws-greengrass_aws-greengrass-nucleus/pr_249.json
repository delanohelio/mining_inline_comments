{"pr_number": 249, "pr_title": "Fix race condition in run and shutdown which let zombies keep running", "pr_createdAt": "2020-05-19T23:40:47Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249", "timeline": [{"oid": "6f8f19c824afbb90e32ada1cd93aaeb38da928f4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f8f19c824afbb90e32ada1cd93aaeb38da928f4", "message": "Fix race condition in run and shutdown which let zombies", "committedDate": "2020-05-19T23:44:28Z", "type": "forcePushed"}, {"oid": "ee01a6a3e543c976392cb6ddab0eacfbbfdba1c4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ee01a6a3e543c976392cb6ddab0eacfbbfdba1c4", "message": "Fix race condition in run and shutdown which let zombies", "committedDate": "2020-05-19T23:49:55Z", "type": "forcePushed"}, {"oid": "7664e68040020ba08c3c0c8821efc872eb5f62e7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7664e68040020ba08c3c0c8821efc872eb5f62e7", "message": "Fix race condition in run and shutdown which let zombies", "committedDate": "2020-05-19T23:53:27Z", "type": "forcePushed"}, {"oid": "ef514274a2402f9373c96b5a96f7a765be1f13d4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ef514274a2402f9373c96b5a96f7a765be1f13d4", "message": "Fix race condition in run and shutdown which let zombies", "committedDate": "2020-05-19T23:56:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3MjIxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r427672211", "bodyText": "I feel this should be right before L350", "author": "ShirleyZheng92", "createdAt": "2020-05-20T00:18:13Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -327,6 +328,11 @@ public void handleError() throws InterruptedException {\n     @SuppressWarnings(\"PMD.CloseResource\")\n     protected Pair<RunStatus, Exec> run(Topic t, String cmd, IntConsumer background, List<Exec> trackingList)\n             throws InterruptedException {\n+        // Don't run anything if the current thread is currently interrupted\n+        if (Thread.currentThread().isInterrupted()) {\n+            throw new InterruptedException();\n+        }\n+", "originalCommit": "ef514274a2402f9373c96b5a96f7a765be1f13d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY5OTUxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r427699518", "bodyText": "Moved it all the way into Exec so that we check immediately before running.", "author": "MikeDombo", "createdAt": "2020-05-20T02:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3MjIxMQ=="}], "type": "inlineReview"}, {"oid": "c64f589885f74cfd386b7da078f2dbc0d944e932", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c64f589885f74cfd386b7da078f2dbc0d944e932", "message": "Fix race condition in run and shutdown which let zombies", "committedDate": "2020-05-20T02:03:22Z", "type": "commit"}, {"oid": "a5db55437208175b33530ab7e13252cc86652809", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a5db55437208175b33530ab7e13252cc86652809", "message": "Fix deadlock when service errors during shutdown", "committedDate": "2020-05-20T02:03:22Z", "type": "commit"}, {"oid": "1956067b7b4233e41370868d9553ee03900b2c34", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1956067b7b4233e41370868d9553ee03900b2c34", "message": "Address PR comments", "committedDate": "2020-05-20T02:03:26Z", "type": "forcePushed"}, {"oid": "2cdc2dd72a2886c87b877e4177289c6aef599f3f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2cdc2dd72a2886c87b877e4177289c6aef599f3f", "message": "Address PR comments", "committedDate": "2020-05-20T02:58:50Z", "type": "commit"}, {"oid": "2cdc2dd72a2886c87b877e4177289c6aef599f3f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2cdc2dd72a2886c87b877e4177289c6aef599f3f", "message": "Address PR comments", "committedDate": "2020-05-20T02:58:50Z", "type": "forcePushed"}, {"oid": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858", "message": "Try to fix tlog being closed and appended", "committedDate": "2020-05-20T06:10:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3MjU5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r428172599", "bodyText": "why separating logger and static logger?", "author": "ShirleyZheng92", "createdAt": "2020-05-20T17:06:52Z", "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -101,6 +101,7 @@\n     private Copier stdoutc;\n     private final AtomicBoolean isClosed = new AtomicBoolean(false);\n     AtomicInteger numberOfCopiers;\n+    private Logger logger = staticLogger;", "originalCommit": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE4MTQ0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r428181443", "bodyText": "Because there's a portion of code at the top of this class that needs a logger and that portion of code is static; so it isn't running on behalf of any other service.", "author": "MikeDombo", "createdAt": "2020-05-20T17:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3MjU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5OTEwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r428199103", "bodyText": "Exec is closed() when the timeout for the task is reached. Is cancelling the backing task the problem? Wouldn't InterruptedException be thrown for this scenario?", "author": "fahadmohammed01", "createdAt": "2020-05-20T17:51:37Z", "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -308,6 +314,12 @@ public Exec withErr(Consumer<CharSequence> o) {\n \n     @SuppressWarnings(\"PMD.AvoidRethrowingException\")\n     private void exec() throws InterruptedException, IOException {\n+        // Don't run anything if the current thread is currently interrupted", "originalCommit": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIwMTA5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r428201093", "bodyText": "Yes, it will be interrupted, but it will run the command before it gets interrupted. So, I\u2019m just adding another check so that we don\u2019t even run the command if it is interrupted", "author": "MikeDombo", "createdAt": "2020-05-20T17:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5OTEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5OTgxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r428199816", "bodyText": "Nice", "author": "fahadmohammed01", "createdAt": "2020-05-20T17:52:44Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -79,6 +82,25 @@ void GIVEN_service_with_timeout_WHEN_timeout_expires_THEN_move_service_to_errore\n         assertTrue(ServicesBErroredLatch.await(5, TimeUnit.SECONDS));\n     }\n \n+    @Test\n+    void GIVEN_service_shutdown_with_timeout_WHEN_timeout_expires_THEN_service_still_closes()", "originalCommit": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}