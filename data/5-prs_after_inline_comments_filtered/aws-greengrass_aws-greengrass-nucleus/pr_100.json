{"pr_number": 100, "pr_title": " Move services under \"services\" keyword", "pr_createdAt": "2020-03-07T00:03:35Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMDM2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389200365", "bodyText": "Did you look at Crashable? James added that a little while back for having functions which can throw exceptions.", "author": "MikeDombo", "createdAt": "2020-03-07T00:07:11Z", "path": "src/main/java/com/aws/iot/evergreen/dependency/Context.java", "diffHunk": "@@ -400,7 +401,7 @@ public final synchronized T put(T v) {\n             }\n         }\n \n-        public final synchronized T computeIfEmpty(Function<Value, T> s) {\n+        public final synchronized <E extends Exception> T computeIfEmpty(ThrowsFunction<Value, T, E> s) throws E {", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDkyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389210922", "bodyText": "Just took a look. Crashable doesn't return a value which we need to put into the map", "author": "ShirleyZheng92", "createdAt": "2020-03-07T01:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMDM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTA0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201040", "bodyText": "Delete all references to this search url list if we're not going to look anything up from it.", "author": "MikeDombo", "createdAt": "2020-03-07T00:10:27Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -155,54 +157,38 @@ public synchronized void reportState(State newState) {\n      * @param context context to lookup the name in\n      * @param name    name of the service to find\n      * @return found service or null\n+     * @throws ServiceLoadException\n      */\n     @SuppressWarnings({\"checkstyle:emptycatchblock\"})\n-    public static EvergreenService locate(Context context, String name) {\n+    public static EvergreenService locate(Context context, String name) throws ServiceLoadException {\n         return context.getv(EvergreenService.class, name).computeIfEmpty(v -> {\n             Configuration configuration = context.get(Configuration.class);\n-            Topics topics = configuration.lookupTopics(Configuration.splitPath(name));\n-            assert (topics != null);\n-            if (topics.isEmpty()) {\n-                // No definition of this service was found in the config file.\n-                // weave config fragments in from elsewhere...\n-                Kernel kernel = context.get(Kernel.class);\n-                for (String serverUrl : kernel.getServiceServerURLList()) {", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDk1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389210951", "bodyText": "Sure", "author": "ShirleyZheng92", "createdAt": "2020-03-07T01:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTI3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201276", "bodyText": "You have a duplicate setCause", "author": "MikeDombo", "createdAt": "2020-03-07T00:11:30Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -213,59 +199,41 @@ public static EvergreenService locate(Context context, String name) {\n                     clazz = si.get(name);\n                 }\n             }\n+            // If found class, try to load service class from plugins.\n             if (clazz != null) {\n                 try {\n                     Constructor<?> ctor = clazz.getConstructor(Topics.class);\n-                    ret = (EvergreenService) ctor.newInstance(topics);\n+                    ret = (EvergreenService) ctor.newInstance(serviceRootTopics);\n                     if (clazz.getAnnotation(Singleton.class) != null) {\n                         context.put(ret.getClass(), v);\n                     }\n                     staticLogger.atInfo().setEventType(\"evergreen-service-loaded\")\n                             .addKeyValue(\"serviceName\", ret.getName()).log();\n                 } catch (Throwable ex) {\n-                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\")\n+                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\").setCause(ex)", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDk2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389210965", "bodyText": "Ooops.", "author": "ShirleyZheng92", "createdAt": "2020-03-07T01:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTQ4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201483", "bodyText": "This comment is misplaced, should be on 223. Here it should be \"if class not found and nothing found in config, then throw\"", "author": "MikeDombo", "createdAt": "2020-03-07T00:12:38Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -213,59 +199,41 @@ public static EvergreenService locate(Context context, String name) {\n                     clazz = si.get(name);\n                 }\n             }\n+            // If found class, try to load service class from plugins.\n             if (clazz != null) {\n                 try {\n                     Constructor<?> ctor = clazz.getConstructor(Topics.class);\n-                    ret = (EvergreenService) ctor.newInstance(topics);\n+                    ret = (EvergreenService) ctor.newInstance(serviceRootTopics);\n                     if (clazz.getAnnotation(Singleton.class) != null) {\n                         context.put(ret.getClass(), v);\n                     }\n                     staticLogger.atInfo().setEventType(\"evergreen-service-loaded\")\n                             .addKeyValue(\"serviceName\", ret.getName()).log();\n                 } catch (Throwable ex) {\n-                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\")\n+                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\").setCause(ex)\n                             .addKeyValue(\"className\", clazz.getName()).log(\"Can't create Evergreen Service instance\");\n-                    ret = errNode(context, name, \"Can't create code-backed service from \" + clazz.getSimpleName(), ex);\n+                    throw new ServiceLoadException(\"Can't create code-backed service from \" + clazz.getSimpleName());\n                 }\n-            } else if (topics.isEmpty()) {\n+            // if not found, initialize GenericExternalService", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTc4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201780", "bodyText": "This log won't do any good since you haven't provided placeholders {}. This should be\nlogger.error(\"Unable to load service {}\", s, se), or use addKeyValue", "author": "MikeDombo", "createdAt": "2020-03-07T00:14:09Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -284,6 +285,8 @@ public Kernel launch() {\n             autostart.forEach(s -> {\n                 try {\n                     main.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                } catch (ServiceLoadException se) {\n+                    logger.atError().setCause(se).log(\"Unable to load service\", s, se);", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTg4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201889", "bodyText": "Should we be throwing from here? I think so.", "author": "MikeDombo", "createdAt": "2020-03-07T00:14:49Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -326,7 +329,11 @@ private boolean ensureCreated(Path p) {\n     public EvergreenService getMain() {\n         EvergreenService m = mainService;\n         if (m == null) {\n-            m = mainService = EvergreenService.locate(context, mainServiceName);\n+            try {\n+                m = mainService = EvergreenService.locate(context, mainServiceName);\n+            } catch (ServiceLoadException e) {\n+                logger.atError().log(\"Cannot get main service\");", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjE4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389202184", "bodyText": "Can we fail/succeed faster here instead of doing if-else? Otherwise it is hard to keep track of what is null and what that means.\nNeed to make sure that the future gets completed in this case.", "author": "MikeDombo", "createdAt": "2020-03-07T00:16:15Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -576,37 +583,50 @@ private void addServiceSearchURL(Object url) {\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n-        Map<String, CountDownLatch> latches = new HashMap<>();\n-        newConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n-\n-        EvergreenService.GlobalStateChangeListener listener = (service, was) -> {\n-            if (newConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n-                latches.get(service.getName()).countDown();\n-            }\n-            if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n-                totallyCompleteFuture.complete(null);\n-            }\n-        };\n-\n-        totallyCompleteFuture.thenRun(() -> {\n-            context.removeGlobalStateChangeListener(listener);\n-        });\n+        final EvergreenService.GlobalStateChangeListener listener;\n+        final Map<String, Object> serviceConfig;\n+\n+        if (newConfig.get(\"services\") == null) {\n+            listener = null;\n+            serviceConfig = null;", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMTAzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389211035", "bodyText": "I don't know if it's valid if readMerge takes an empty Map", "author": "ShirleyZheng92", "createdAt": "2020-03-07T01:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NzA1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389987059", "bodyText": "Instead of setting to null, just return the completed future immediately.", "author": "MikeDombo", "createdAt": "2020-03-09T22:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjMwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389202308", "bodyText": "Remove system outs.", "author": "MikeDombo", "createdAt": "2020-03-07T00:17:03Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -576,37 +583,50 @@ private void addServiceSearchURL(Object url) {\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n-        Map<String, CountDownLatch> latches = new HashMap<>();\n-        newConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n-\n-        EvergreenService.GlobalStateChangeListener listener = (service, was) -> {\n-            if (newConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n-                latches.get(service.getName()).countDown();\n-            }\n-            if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n-                totallyCompleteFuture.complete(null);\n-            }\n-        };\n-\n-        totallyCompleteFuture.thenRun(() -> {\n-            context.removeGlobalStateChangeListener(listener);\n-        });\n+        final EvergreenService.GlobalStateChangeListener listener;\n+        final Map<String, Object> serviceConfig;\n+\n+        if (newConfig.get(\"services\") == null) {\n+            listener = null;\n+            serviceConfig = null;\n+        } else {\n+            serviceConfig = (Map<String, Object>) newConfig.get(\"services\");\n+            Map<String, CountDownLatch> latches = new HashMap<>();\n+            serviceConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n+\n+            listener = (service, was) -> {\n+                System.err.println(String.format(\"get service %s update to %s\", service.getName(), service.getState()));", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjc0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389202747", "bodyText": "This TODO doesn't match the behavior since you don't have requestRestart here, but requestStart, so something needs to change.", "author": "MikeDombo", "createdAt": "2020-03-07T00:19:21Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -576,37 +583,50 @@ private void addServiceSearchURL(Object url) {\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n-        Map<String, CountDownLatch> latches = new HashMap<>();\n-        newConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n-\n-        EvergreenService.GlobalStateChangeListener listener = (service, was) -> {\n-            if (newConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n-                latches.get(service.getName()).countDown();\n-            }\n-            if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n-                totallyCompleteFuture.complete(null);\n-            }\n-        };\n-\n-        totallyCompleteFuture.thenRun(() -> {\n-            context.removeGlobalStateChangeListener(listener);\n-        });\n+        final EvergreenService.GlobalStateChangeListener listener;\n+        final Map<String, Object> serviceConfig;\n+\n+        if (newConfig.get(\"services\") == null) {\n+            listener = null;\n+            serviceConfig = null;\n+        } else {\n+            serviceConfig = (Map<String, Object>) newConfig.get(\"services\");\n+            Map<String, CountDownLatch> latches = new HashMap<>();\n+            serviceConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n+\n+            listener = (service, was) -> {\n+                System.err.println(String.format(\"get service %s update to %s\", service.getName(), service.getState()));\n+                if (serviceConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n+                    latches.get(service.getName()).countDown();\n+                }\n+                if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n+                    totallyCompleteFuture.complete(null);\n+                }\n+            };\n+            totallyCompleteFuture.thenRun(() -> {\n+                context.removeGlobalStateChangeListener(listener);\n+            });\n+        }\n \n         context.get(UpdateSystemSafelyService.class).addUpdateAction(deploymentId, () -> {\n             context.runOnPublishQueueAndWait(() -> {\n                 try {\n                     mergeMap(timestamp, newConfig);\n-                    context.addGlobalStateChangeListener(listener);\n-\n-                    newConfig.keySet().forEach(serviceName -> {\n-                        EvergreenService eg = EvergreenService.locate(context, (String) serviceName);\n-                        if (eg == null) {\n-                            logger.error(\"Could not locate EvergreenService for modified service {}\", serviceName);\n-                        } else if (State.NEW.equals(eg.getState())) {\n-                            eg.requestStart();\n-                        }\n-                    });\n-\n+                    if (listener != null) {\n+                        context.addGlobalStateChangeListener(listener);\n+                        serviceConfig.keySet().forEach(serviceName -> {\n+                            try {\n+                                EvergreenService eg = EvergreenService.locate(context, serviceName);\n+                                // TODO: remove requestRestart here as each service will handle update behavior based on", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjkzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389202938", "bodyText": "What is up with this link? Just use @link FunctionalInterface?", "author": "MikeDombo", "createdAt": "2020-03-07T00:20:22Z", "path": "src/main/java/com/aws/iot/evergreen/util/ThrowsFunction.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.aws.iot.evergreen.util;\n+\n+import java.util.Objects;\n+\n+\n+/**\n+ * Represents a function that accepts one argument and produces a result.\n+ *\n+ * <p>This is a <a href=\"package-summary.html\">functional interface</a>", "originalCommit": "cf2c6ed80b13c90819027629e7e7f5a39812655d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMjExNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389212117", "bodyText": "Yeah I just copied from FunctionalInterface. Will remove", "author": "ShirleyZheng92", "createdAt": "2020-03-07T01:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjkzOA=="}], "type": "inlineReview"}, {"oid": "c7ab1849687501cf0f3c6be7cf54bea7502a2745", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c7ab1849687501cf0f3c6be7cf54bea7502a2745", "message": "Draft CR to move services under \"services\" keyword\n\n1. Move services under \"services\" keyword\n1. Make EvergreenService.locate() throw Exception on unable to load service\n\nTested on KernelTest.java", "committedDate": "2020-03-07T01:57:36Z", "type": "forcePushed"}, {"oid": "32b2257f53b23a5fd6a7df453d393867edc4ccfa", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/32b2257f53b23a5fd6a7df453d393867edc4ccfa", "message": "Move services under \"services\" keyword\n\n1. Move services under \"services\" keyword\n1. Make EvergreenService.locate() throw Exception on unable to load service", "committedDate": "2020-03-09T23:32:09Z", "type": "forcePushed"}, {"oid": "cd808fe437b413dcdd9e4a937f9755f2890b6ec9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cd808fe437b413dcdd9e4a937f9755f2890b6ec9", "message": "Move services under \"services\" keyword\n\n1. Move services under \"services\" keyword\n1. Make EvergreenService.locate() throw Exception on unable to load service", "committedDate": "2020-03-09T23:40:57Z", "type": "forcePushed"}, {"oid": "54a88529518d03779edc96b718af575dcd16296f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/54a88529518d03779edc96b718af575dcd16296f", "message": "Move services under \"services\" keyword\n\n1. Move services under \"services\" keyword\n1. Make EvergreenService.locate() throw Exception on unable to load service", "committedDate": "2020-03-10T00:00:32Z", "type": "forcePushed"}, {"oid": "86faf38aa7c45a4e9ae1e5c16f9209805d5fc6d0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/86faf38aa7c45a4e9ae1e5c16f9209805d5fc6d0", "message": "Move services under \"services\" keyword\n\n1. Move services under \"services\" keyword\n1. Make EvergreenService.locate() throw Exception on unable to load service", "committedDate": "2020-03-10T00:20:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU3NTI3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r390575276", "bodyText": "This is expected? Why have both name and full name in that case?", "author": "chaurah", "createdAt": "2020-03-10T19:58:57Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -47,7 +47,7 @@\n     void beforeEach() {\n         Mockito.when(config.createLeafChild(eq(\"_State\"))).thenReturn(stateTopic);\n         Mockito.when(config.createLeafChild(eq(\"requires\"))).thenReturn(requiresTopic);\n-        Mockito.when(config.getFullName()).thenReturn(EVERGREEN_SERVICE_FULL_NAME);\n+        Mockito.when(config.getName()).thenReturn(EVERGREEN_SERVICE_FULL_NAME);", "originalCommit": "bc8822632c7287f4184651370c08dcb33276e186", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU5NTU5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r390595595", "bodyText": "Full name is services.foo , name is foo", "author": "ShirleyZheng92", "createdAt": "2020-03-10T20:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU3NTI3Ng=="}], "type": "inlineReview"}, {"oid": "c816b7c0aa898193c237b61a07213d66113b6586", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c816b7c0aa898193c237b61a07213d66113b6586", "message": "Move services under \"services\" keyword\n\n1. Move services under \"services\" keyword\n1. Make EvergreenService.locate() throw Exception on unable to load service", "committedDate": "2020-03-10T23:27:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NjAzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391146032", "bodyText": "I'd say the name isn't descriptive enough... Also Load is very generic... What kind of error are we trying to throw here? Unable to locate?", "author": "leaf94", "createdAt": "2020-03-11T17:35:53Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/exceptions/ServiceLoadException.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.kernel.exceptions;\n+\n+public class ServiceLoadException extends Exception {", "originalCommit": "c816b7c0aa898193c237b61a07213d66113b6586", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1NTk3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391155970", "bodyText": "Unable to locate service, unable to find class, etc. Let's discuss the candidate names", "author": "ShirleyZheng92", "createdAt": "2020-03-11T17:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NjAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NzM2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391147365", "bodyText": "I did notice the strange restarting behavior of SafeSystemUpdate service. Is this related to the flakiness of MergeConfigTest?\nAlso do we have a plan forward for the TODO? I think this one has high priority.", "author": "leaf94", "createdAt": "2020-03-11T17:37:55Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -280,10 +281,19 @@ public Kernel launch() {\n             context.put(ShellRunner.class, context.get(ShellRunner.Dryrun.class));\n         }\n         try {\n-            EvergreenService main = getMain(); // Trigger boot  (!?!?)\n+            mainService = getMain();\n             autostart.forEach(s -> {\n                 try {\n-                    main.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    if (!s.contains(\"SafeSystemUpdate\")) {\n+                        mainService.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    } else {\n+                        // SafeSystemUpdate will reset to Installed after update.\n+                        // This is a hacky way to avoid restarting depending services.\n+                        // TODO: Find a proper way handle this situation.\n+                        mainService.addDependency(EvergreenService.locate(context, s), State.INSTALLED);", "originalCommit": "c816b7c0aa898193c237b61a07213d66113b6586", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1NTM1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391155354", "bodyText": "Probably not in this Sprint. This line remove unnecessary restarting services . I'm working on a separate PR on fixing config merge", "author": "ShirleyZheng92", "createdAt": "2020-03-11T17:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NzM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0ODc0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391148743", "bodyText": "If root service isn't found, should this be an error?", "author": "leaf94", "createdAt": "2020-03-11T17:39:49Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -155,117 +160,87 @@ public synchronized void reportState(State newState) {\n      * @param context context to lookup the name in\n      * @param name    name of the service to find\n      * @return found service or null\n+     * @throws ServiceLoadException if service cannot load\n      */\n     @SuppressWarnings({\"checkstyle:emptycatchblock\"})\n-    public static EvergreenService locate(Context context, String name) {\n+    public static EvergreenService locate(Context context, String name) throws ServiceLoadException {\n         return context.getv(EvergreenService.class, name).computeIfEmpty(v -> {\n             Configuration configuration = context.get(Configuration.class);\n-            Topics topics = configuration.lookupTopics(Configuration.splitPath(name));\n-            assert (topics != null);\n-            if (topics.isEmpty()) {\n-                // No definition of this service was found in the config file.\n-                // weave config fragments in from elsewhere...\n-                Kernel kernel = context.get(Kernel.class);\n-                for (String serverUrl : kernel.getServiceServerURLList()) {\n-                    if (topics.isEmpty()) {\n-                        try {\n-                            // TODO: should probably think hard about what file extension to use\n-                            // TODO: allow the file to be a zip package?\n-                            URL configUrl = new URL(serverUrl + name + \".evg\");\n-                            kernel.read(configUrl, false);\n-                            if (!topics.isEmpty()) {\n-                                staticLogger.atInfo().setEventType(\"service-config-found\")\n-                                        .addKeyValue(\"configURL\", configUrl).log(\"Found external service definition\");\n-                            }\n-                        } catch (IOException ignored) {\n-                        }\n-                    } else {\n-                        break;\n-                    }\n-                }\n-                if (topics.isEmpty()) {\n-                    topics.createLeafChild(\"run\").dflt(\"echo No definition found for \" + name + \";exit -1\");\n-                    staticLogger.atWarn().setEventType(\"service-config-not-found\").addKeyValue(\"serviceName\", name)\n-                            .log();\n-                }\n+            Topics serviceRootTopics = configuration.lookupTopics(SERVICES_NAMESPACE_TOPIC, name);\n+            if (serviceRootTopics == null || serviceRootTopics.isEmpty()) {\n+                staticLogger.atWarn().setEventType(\"service-config-not-found\").addKeyValue(\"serviceName\", name);", "originalCommit": "c816b7c0aa898193c237b61a07213d66113b6586", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1NzA1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391157058", "bodyText": "It's not an error, because some services like \"ipc\" or \" SafeSystemUpdate\" doesn't have config in the yaml file", "author": "ShirleyZheng92", "createdAt": "2020-03-11T17:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0ODc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0OTAyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391149022", "bodyText": "Love this!!!", "author": "leaf94", "createdAt": "2020-03-11T17:40:15Z", "path": "src/main/java/com/aws/iot/evergreen/config/Node.java", "diffHunk": "@@ -57,6 +57,10 @@ public String getFullName() {\n         return fnc;\n     }\n \n+    public String getName() {\n+        return name;", "originalCommit": "c816b7c0aa898193c237b61a07213d66113b6586", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1MTc0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391151748", "bodyText": "Does newConfig has a services key? Is that change made to the UpdatingKernelState in deployment?", "author": "fahadmohammed01", "createdAt": "2020-03-11T17:44:23Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -573,21 +587,29 @@ private void addServiceSearchURL(Object url) {\n      * @param newConfig    the map of new configuration\n      * @return future which completes only once the config is merged and all the services in the config are running\n      */\n+    @SuppressFBWarnings(\"NP_NONNULL_PARAM_VIOLATION\") // https://github.com/findbugsproject/findbugs/issues/79\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n+\n+        if (newConfig.get(\"services\") == null) {", "originalCommit": "c816b7c0aa898193c237b61a07213d66113b6586", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMwNzU5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391307598", "bodyText": "Updated", "author": "ShirleyZheng92", "createdAt": "2020-03-11T22:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1MTc0OA=="}], "type": "inlineReview"}, {"oid": "1c3392d7f0112d5101769ca9329051d50f1aade3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1c3392d7f0112d5101769ca9329051d50f1aade3", "message": "Move services under \"services\" keyword\n\n1. Move services under \"services\" keyword\n1. Make EvergreenService.locate() throw Exception on unable to load service", "committedDate": "2020-03-11T19:31:11Z", "type": "forcePushed"}, {"oid": "8c83256bbd3ce138094b4b7cf3f1283abbe821f1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8c83256bbd3ce138094b4b7cf3f1283abbe821f1", "message": "Move services under \"services\" keyword\n\n1. Move services under \"services\" keyword\n1. Make EvergreenService.locate() throw Exception on unable to load service", "committedDate": "2020-03-12T00:02:26Z", "type": "commit"}, {"oid": "8b7e46b43cce07ce43ad99b4cc576398c3d61b85", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b7e46b43cce07ce43ad99b4cc576398c3d61b85", "message": "Address comments", "committedDate": "2020-03-12T00:02:26Z", "type": "commit"}, {"oid": "8b7e46b43cce07ce43ad99b4cc576398c3d61b85", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b7e46b43cce07ce43ad99b4cc576398c3d61b85", "message": "Address comments", "committedDate": "2020-03-12T00:02:26Z", "type": "forcePushed"}]}