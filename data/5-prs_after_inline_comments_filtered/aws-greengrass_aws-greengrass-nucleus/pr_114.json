{"pr_number": 114, "pr_title": "Move lifecycle keywords for services from config root to under 'lifecycle' key", "pr_createdAt": "2020-03-14T01:37:55Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTcyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392545727", "bodyText": "Let's make anything new private and we need to go back and make all the other public stuff private as well.", "author": "MikeDombo", "createdAt": "2020-03-14T01:44:08Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -82,6 +83,9 @@\n     // Service logger instance\n     protected final Logger logger;\n \n+    // Service lifecycle Topics\n+    public final Topics lifecycle;", "originalCommit": "88c498ac50e856c163262c6c4cac67c2207b9809", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjUzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392546538", "bodyText": "Makes sense. Also thinking I should make a method to return name/object for lifecycle as needed similar to what we added for the new services keyword. Thoughts?", "author": "chaurah", "createdAt": "2020-03-14T01:55:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0Njc0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392546746", "bodyText": "Not too sure what that would look like. Can you put a little example snippet here?", "author": "MikeDombo", "createdAt": "2020-03-14T01:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NzE3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392547179", "bodyText": "Just a getter for both the Topics object and the lifecycle keyword itself. Nothing fancy :)\nBasically avoid having \"lifecycle\" hardcoded everywhere. Whichever component needs access to the lifecycle Topics object should get it directly from the service.\nAlthough I will say, outside of the Service classes, so far only found a couple of tests where it is directly being accessed. Still looking through the code.", "author": "chaurah", "createdAt": "2020-03-14T02:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NzMzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392547339", "bodyText": "Oh, ok. Making \"lifecycle\" public is fine, but I don't think we need or want a getter for the topic. Only the service it self should need access.", "author": "MikeDombo", "createdAt": "2020-03-14T02:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTkzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392545937", "bodyText": "Instead of wrapping this as a list, use the set and fix the cast. Changing the cast to Iterable should resolve our casting issues. I already checked and we're not using it as a list, we only iterate so it is a simple change to make.", "author": "MikeDombo", "createdAt": "2020-03-14T01:46:48Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -85,8 +90,7 @@\n         // Generate dependencies\n         // TODO : Only platform specific dependencies should be added once deployment document and\n         // package recipe format supports platform wise dependency specification\n-        Set<String> dependencyServiceNames = pkg.getDependencies().keySet();\n-        resolvedServiceConfig.put(SERVICE_DEPENDENCIES_CONFIG_KEY, String.join(\", \", dependencyServiceNames));\n+        resolvedServiceConfig.put(SERVICE_DEPENDENCIES_CONFIG_KEY, new ArrayList<>(pkg.getDependencies().keySet()));", "originalCommit": "88c498ac50e856c163262c6c4cac67c2207b9809", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0Njc3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392546770", "bodyText": "Can do for now, if we start doing other operations later on though, it may be a problem.", "author": "chaurah", "createdAt": "2020-03-14T01:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU1MjUxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392552512", "bodyText": "Updated and moved to a different PR for separation of concerns since it was more than a couple of lines of diff.", "author": "chaurah", "createdAt": "2020-03-14T03:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTk1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392545959", "bodyText": "All these can stay as sets.", "author": "MikeDombo", "createdAt": "2020-03-14T01:47:23Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -130,15 +134,15 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n      */\n     private Map<Object, Object> getUpdatedMainConfig(Set<PackageIdentifier> rootPackagesToRemove,\n                                                      DeploymentDocument document) {\n-        Set<String> kernelDependencies =\n+        List<String> kernelDependencies =", "originalCommit": "88c498ac50e856c163262c6c4cac67c2207b9809", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjA0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392546046", "bodyText": "This is not necessarily a string. Our lifecycle keys will have subkeys themselves", "author": "MikeDombo", "createdAt": "2020-03-14T01:48:33Z", "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -282,13 +283,13 @@ private String getServiceInstallCommand(String serviceName, Map<Object, Object>\n         return getValueForLifecycleKey(LIFECYCLE_INSTALL_KEY, serviceName, config);\n     }\n \n-    private Set<String> getServiceDependencies(String serviceName, Map<Object, Object> config) {\n-        return new HashSet<>(Arrays.asList(\n-                getValueForLifecycleKey(KERNEL_CONFIG_SERVICE_DEPENDENCIES_KEY, serviceName, config).split(\", \")));\n+    private List<String> getServiceDependencies(String serviceName, Map<Object, Object> config) {\n+        return (List<String>)getLifecycleConfig(serviceName, config).get(KERNEL_CONFIG_SERVICE_DEPENDENCIES_KEY);\n     }\n \n-    private String getValueForLifecycleKey(String key, String servicename, Map<Object, Object> config) {\n-        return (String) getLifecycleConfig(servicename, config).get(key);\n+    private String getValueForLifecycleKey(String key, String serviceName, Map<Object, Object> config) {\n+        Map<Object, Object> map = getLifecycleConfig(serviceName, config);\n+        return (String)((Map<Object, Object>)map.get(LIFECYCLE_CONFIG_ROOT_KEY)).get(key);\n     }", "originalCommit": "88c498ac50e856c163262c6c4cac67c2207b9809", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjY4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392546680", "bodyText": "The test is using the String for validation at the moment. Should be easy enough to change but let me see what Amit's branch has as fixes for this section. Will update accordingly.", "author": "chaurah", "createdAt": "2020-03-14T01:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjgwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392546804", "bodyText": "Looking at Shirley's dox we have subkeys for script and timeout, etc", "author": "MikeDombo", "createdAt": "2020-03-14T01:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NzM4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392547386", "bodyText": "Good point, just going to add a test for that I think. Should make sure it's captured.", "author": "chaurah", "createdAt": "2020-03-14T02:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODk0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392548940", "bodyText": "Oh this is in a test, didn't see that. That's fine then.", "author": "MikeDombo", "createdAt": "2020-03-14T02:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjA0Ng=="}], "type": "inlineReview"}, {"oid": "7e8f995d1d4a66ab12dd14d4ef7d684a88253b40", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7e8f995d1d4a66ab12dd14d4ef7d684a88253b40", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key", "committedDate": "2020-03-14T01:51:31Z", "type": "forcePushed"}, {"oid": "cbb736f86770aefe794f9f235b8156d2dcb45163", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cbb736f86770aefe794f9f235b8156d2dcb45163", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key", "committedDate": "2020-03-14T03:07:24Z", "type": "forcePushed"}, {"oid": "b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key", "committedDate": "2020-03-14T03:25:20Z", "type": "commit"}, {"oid": "b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key", "committedDate": "2020-03-14T03:25:20Z", "type": "forcePushed"}]}