{"pr_number": 561, "pr_title": "Add timestamp to UpdateBehaviorTree to fix multi-group deployment", "pr_createdAt": "2020-10-23T03:26:54Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561", "timeline": [{"oid": "8b1bb72a1f2c1320a29c195daba8903530352267", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b1bb72a1f2c1320a29c195daba8903530352267", "message": "Add test cases for timestamp merge, force overwrite the timestamp", "committedDate": "2020-10-26T16:19:52Z", "type": "forcePushed"}, {"oid": "414ae01b14d8556f3972885a786f70d1a05b72cb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/414ae01b14d8556f3972885a786f70d1a05b72cb", "message": "Add test cases for timestamp merge, force overwrite the timestamp", "committedDate": "2020-10-26T16:59:18Z", "type": "forcePushed"}, {"oid": "af903f7a385c34191d7b9586c88a2e4aa9a54d73", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/af903f7a385c34191d7b9586c88a2e4aa9a54d73", "message": "Add test cases for timestamp merge, force overwrite the timestamp", "committedDate": "2020-10-26T17:00:21Z", "type": "forcePushed"}, {"oid": "5c809e879cc414701ce0d2bc1a36cbbd91a2bfda", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c809e879cc414701ce0d2bc1a36cbbd91a2bfda", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T17:18:38Z", "type": "forcePushed"}, {"oid": "4ca55335fff97e131b6590e4cdcd86d43344e52f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ca55335fff97e131b6590e4cdcd86d43344e52f", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T17:56:05Z", "type": "forcePushed"}, {"oid": "712776d269d7e7031a27b81fcf241e8968f6143c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/712776d269d7e7031a27b81fcf241e8968f6143c", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T19:00:33Z", "type": "forcePushed"}, {"oid": "424f9ac8e5b500c22e87b6f9740c30f8c4920bf4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/424f9ac8e5b500c22e87b6f9740c30f8c4920bf4", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T19:06:54Z", "type": "forcePushed"}, {"oid": "a1f4d5b18e6c5b49e6a379be9e41d3443f8701c1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a1f4d5b18e6c5b49e6a379be9e41d3443f8701c1", "message": "Merge branch 'master' into timestamp", "committedDate": "2020-10-26T20:30:47Z", "type": "forcePushed"}, {"oid": "814ab182f100906a9c052f001f015c842d75270b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/814ab182f100906a9c052f001f015c842d75270b", "message": "Merge branch 'master' into timestamp", "committedDate": "2020-10-26T21:02:14Z", "type": "forcePushed"}, {"oid": "d01cb76acd1de8b94d5b34b718f1e5fb74569222", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d01cb76acd1de8b94d5b34b718f1e5fb74569222", "message": "Merge branch 'master' into timestamp", "committedDate": "2020-10-26T21:22:43Z", "type": "forcePushed"}, {"oid": "9c76e41d9077072c9cbb6c91cbdcce56514a69a2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9c76e41d9077072c9cbb6c91cbdcce56514a69a2", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T21:23:35Z", "type": "forcePushed"}, {"oid": "b302df91536e2dc351d4af11b8da8ae3f749d292", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b302df91536e2dc351d4af11b8da8ae3f749d292", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T21:27:25Z", "type": "forcePushed"}, {"oid": "4860dffa387a66e9b1c35ebf66486d3a93e249ce", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4860dffa387a66e9b1c35ebf66486d3a93e249ce", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T21:29:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODA0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512288047", "bodyText": "do you need the proposed == null && value == null? Objects.equals(null, null) is true so the first predicate should match", "author": "rbattle", "createdAt": "2020-10-26T21:44:53Z", "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -147,24 +147,47 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);\n+    }\n+\n     /**\n      * Set the value of this topic to a new value.\n      *\n      * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value\n      *                       unless this is forced\n      * @param proposed        new value.\n-     * @param forceTimestamp indicate if the proposed time should be forced.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @param allowTimestampToIncrease allow the timestamp to go forward in time without changing the value\n      * @return this.\n      */\n-    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean forceTimestamp) {\n+    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease,\n+                                      boolean allowTimestampToIncrease) {\n         final Object currentValue = value;\n-        final long currentModtime = modtime;\n-        if (Objects.equals(proposed, currentValue) || !forceTimestamp && (proposedModtime < currentModtime)) {\n+        final long currentModTime = modtime;\n+        boolean timestampWouldIncrease = allowTimestampToIncrease && proposedModtime > currentModTime;\n+\n+        if ((Objects.equals(proposed, currentValue)\n+                || !allowTimestampToDecrease && (proposedModtime < currentModTime))\n+                && !timestampWouldIncrease || proposed == null && value == null) {", "originalCommit": "4860dffa387a66e9b1c35ebf66486d3a93e249ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MDMyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512290321", "bodyText": "Yes, but !timestampWouldIncrease won't necessarily match", "author": "MikeDombo", "createdAt": "2020-10-26T21:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MDQxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512290418", "bodyText": "This matters for setting the dflt case", "author": "MikeDombo", "createdAt": "2020-10-26T21:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NTY1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512295655", "bodyText": "gotcha - I misread the parens. The null/null case is a fall through", "author": "rbattle", "createdAt": "2020-10-26T22:01:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzOTczOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512339739", "bodyText": "when do we allow timestamp to decrease?", "author": "fahadmohammed01", "createdAt": "2020-10-27T00:03:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0MjI1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512342255", "bodyText": "That's the replacement for the old behavior of \"forceTimestamp\"", "author": "MikeDombo", "createdAt": "2020-10-27T00:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODQ1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512288454", "bodyText": "why do you not want to allowTimestampToIncrease here? It seems contradictory in a method called withNewerValue?", "author": "rbattle", "createdAt": "2020-10-26T21:45:42Z", "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -147,24 +147,47 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);", "originalCommit": "4860dffa387a66e9b1c35ebf66486d3a93e249ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MDY1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512290652", "bodyText": "The name of allowTimestampToIncrease isn't quite right is is more accurately allowTimestampToIncreaseWhenValueHasntChanged", "author": "MikeDombo", "createdAt": "2020-10-26T21:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5OTc2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512299769", "bodyText": "can you update the javadoc for allowTimeStampToIncrease. What you wrote here: when the value hasn't changed is easier for me to grok than without changing the value\nMaybe something like allow the timestamp to go forward in time even if the proposed value is the same as the current value?", "author": "rbattle", "createdAt": "2020-10-26T22:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMwMDY3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512300676", "bodyText": "Sure, do you have a better name for that argument as well?", "author": "MikeDombo", "createdAt": "2020-10-26T22:13:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODg4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512288887", "bodyText": "should you use a clock here instead of System.currentTimeMillis() ? It could make it easier to mock/test", "author": "rbattle", "createdAt": "2020-10-26T21:46:45Z", "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -373,8 +366,8 @@ public void remove(Node n) {\n      */\n     public void replaceAndWait(Map<String, Object> newValue) {\n         context.runOnPublishQueueAndWait(() ->\n-                updateFromMap(System.currentTimeMillis(), newValue,\n-                        new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.REPLACE))\n+                updateFromMap(newValue,\n+                        new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.REPLACE, System.currentTimeMillis()))", "originalCommit": "4860dffa387a66e9b1c35ebf66486d3a93e249ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMwMjE3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512302173", "bodyText": "It has been this way since day 1 and making that change is a bit non-trivial due to the long legacy now. We haven't seen a need to mock this bit so far", "author": "MikeDombo", "createdAt": "2020-10-26T22:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODg4Nw=="}], "type": "inlineReview"}, {"oid": "6f142aa5719dbc283f8918dd1327910d27d32c3a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f142aa5719dbc283f8918dd1327910d27d32c3a", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T22:22:34Z", "type": "forcePushed"}, {"oid": "6166d44c72d9eb006aa38ac164839b806987a1e4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6166d44c72d9eb006aa38ac164839b806987a1e4", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-26T22:25:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzA1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512363054", "bodyText": "are there any unit tests on this class or is it all \"covered\" by other tests?", "author": "rbattle", "createdAt": "2020-10-27T01:30:27Z", "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -147,24 +147,49 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);\n+    }\n+\n     /**\n      * Set the value of this topic to a new value.\n      *\n      * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value\n      *                       unless this is forced\n      * @param proposed        new value.\n-     * @param forceTimestamp indicate if the proposed time should be forced.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @param allowTimestampToIncreaseWhenValueHasntChanged allow the timestamp to go forward in time even if the\n+     *                                                      proposed value is the same as the current value\n      * @return this.\n      */\n-    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean forceTimestamp) {\n+    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease,", "originalCommit": "6166d44c72d9eb006aa38ac164839b806987a1e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzcxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512363719", "bodyText": "it has ConfigurationTest class as well as being covered quite a lot by all the other tests too since configuration is so core to what we do.", "author": "MikeDombo", "createdAt": "2020-10-27T01:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3NjAxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512376012", "bodyText": "Right - it does seem a bit odd that we don't have simple unit tests for this class though given it is so important", "author": "rbattle", "createdAt": "2020-10-27T02:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3NjQ0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512376447", "bodyText": "That's what I'm saying, it is part of ConfigurationTest you can't have a Topic or Topics without a Configuration", "author": "MikeDombo", "createdAt": "2020-10-27T02:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2NjYyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512466622", "bodyText": "why do we need allowTimestampToDecrease? when does timestamp value decrease", "author": "fahadmohammed01", "createdAt": "2020-10-27T07:31:45Z", "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -149,24 +149,49 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);\n+    }\n+\n     /**\n      * Set the value of this topic to a new value.\n      *\n      * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value\n      *                       unless this is forced\n      * @param proposed        new value.\n-     * @param forceTimestamp indicate if the proposed time should be forced.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @param allowTimestampToIncreaseWhenValueHasntChanged allow the timestamp to go forward in time even if the\n+     *                                                      proposed value is the same as the current value\n      * @return this.\n      */\n-    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean forceTimestamp) {\n+    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease,", "originalCommit": "5ca8fa934f7cae5b38cea994f75fa2dc66f4b29e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgyODMwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512828305", "bodyText": "This is the exact same behavior as forceTimestamp used to have, it only allowed the timestamp to decrease since by default a newer timestamp would be preferred anyway.", "author": "MikeDombo", "createdAt": "2020-10-27T16:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2NjYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2ODIzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512468237", "bodyText": "Can you explain the different conditions handled here or break this if condition?", "author": "fahadmohammed01", "createdAt": "2020-10-27T07:35:22Z", "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -149,24 +149,49 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);\n+    }\n+\n     /**\n      * Set the value of this topic to a new value.\n      *\n      * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value\n      *                       unless this is forced\n      * @param proposed        new value.\n-     * @param forceTimestamp indicate if the proposed time should be forced.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @param allowTimestampToIncreaseWhenValueHasntChanged allow the timestamp to go forward in time even if the\n+     *                                                      proposed value is the same as the current value\n      * @return this.\n      */\n-    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean forceTimestamp) {\n+    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease,\n+                                      boolean allowTimestampToIncreaseWhenValueHasntChanged) {\n         final Object currentValue = value;\n-        final long currentModtime = modtime;\n-        if (Objects.equals(proposed, currentValue) || !forceTimestamp && (proposedModtime < currentModtime)) {\n+        final long currentModTime = modtime;\n+        boolean timestampWouldIncrease =\n+                allowTimestampToIncreaseWhenValueHasntChanged && proposedModtime > currentModTime;\n+\n+        if ((Objects.equals(proposed, currentValue)", "originalCommit": "5ca8fa934f7cae5b38cea994f75fa2dc66f4b29e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0ODMwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512848305", "bodyText": "It has the same conditions as before + the idea that it will not break if the timestamp should be increased and the value isn't null. We use null for defaults and our defaults should not have their timestamps advanced otherwise our call to dflt fails because it uses a timestamp of 1 which would be in the past, so it would never apply.", "author": "MikeDombo", "createdAt": "2020-10-27T16:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2ODIzNw=="}], "type": "inlineReview"}, {"oid": "77179b556316c9e856f09d1e9e83346e53187993", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77179b556316c9e856f09d1e9e83346e53187993", "message": "Save updated timestamp to tlog", "committedDate": "2020-10-27T16:33:37Z", "type": "forcePushed"}, {"oid": "b5891e1379b2679e9af7466def3c4c9807c751e6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5891e1379b2679e9af7466def3c4c9807c751e6", "message": "Save updated timestamp to tlog", "committedDate": "2020-10-27T16:57:09Z", "type": "forcePushed"}, {"oid": "079726da3a903884e2c673cb0cd9fef43ffc4e9d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/079726da3a903884e2c673cb0cd9fef43ffc4e9d", "message": "Add timestamp to UpdateBehaviorTree to fix multi-group deployment", "committedDate": "2020-10-27T17:03:00Z", "type": "commit"}, {"oid": "ad3fc21774e01e8ec14a9808189cc90bc4b49380", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ad3fc21774e01e8ec14a9808189cc90bc4b49380", "message": "Add test cases for timestamp merge, force overwrite the timestamp", "committedDate": "2020-10-27T17:03:00Z", "type": "commit"}, {"oid": "b8b3772c4a39425e73fa5b9858d4c2e9f7ae3b45", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b8b3772c4a39425e73fa5b9858d4c2e9f7ae3b45", "message": "Remove old API to fix build broken by SDK", "committedDate": "2020-10-27T17:03:00Z", "type": "commit"}, {"oid": "6884d9b7dc0ab62367045602399ccf884710089d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6884d9b7dc0ab62367045602399ccf884710089d", "message": "Save updated timestamp to tlog", "committedDate": "2020-10-27T17:03:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3NjUzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512876537", "bodyText": "can you give some more context on when you would want to be notified that the timestamp is updated?", "author": "rbattle", "createdAt": "2020-10-27T17:14:39Z", "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -179,7 +210,11 @@ synchronized Topic withNewerValue(long proposedModtime, final Object proposed, b\n \n         value = validated;\n         modtime = proposedModtime;\n-        context.runOnPublishQueue(() -> this.fire(WhatHappened.changed));\n+        if (changed) {\n+            context.runOnPublishQueue(() -> this.fire(WhatHappened.changed));\n+        } else {\n+            context.runOnPublishQueue(() -> this.fire(WhatHappened.timestampUpdated));", "originalCommit": "6884d9b7dc0ab62367045602399ccf884710089d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3NzIwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512877205", "bodyText": "We generally don't, but this is required for the tlog to pick it up. The tlog only attaches as a listener", "author": "MikeDombo", "createdAt": "2020-10-27T17:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3NjUzNw=="}], "type": "inlineReview"}, {"oid": "1b861e40c945e3b5176ce79c56b117c4d9a99750", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1b861e40c945e3b5176ce79c56b117c4d9a99750", "message": "Save updated timestamp to tlog", "committedDate": "2020-10-27T17:41:26Z", "type": "commit"}, {"oid": "1b861e40c945e3b5176ce79c56b117c4d9a99750", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1b861e40c945e3b5176ce79c56b117c4d9a99750", "message": "Save updated timestamp to tlog", "committedDate": "2020-10-27T17:41:26Z", "type": "forcePushed"}]}