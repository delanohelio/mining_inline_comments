{"pr_number": 330, "pr_title": "Add random suffix in e2e test component name", "pr_createdAt": "2020-07-27T17:02:10Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzODQxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330#discussion_r461038411", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nThe result of deleting a file on this line should be checked and failure should be logged. java.io.File.delete() will simply return false if it fails to delete the file, for example, when the file does not exist. It will not throw unless there is a security exception.", "author": "MikeDombo", "createdAt": "2020-07-27T17:05:06Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -228,6 +274,11 @@ protected void cleanup() {\n         createdThingGroups.clear();\n         createdIotJobIds.forEach(jobId -> IotJobsUtils.cleanJob(iotClient, jobId));\n         createdIotJobIds.clear();\n+        if (kernel != null && kernel.getConfigPath() != null) {\n+            for (File subFile : kernel.getConfigPath().toFile().listFiles()) {\n+                subFile.delete();", "originalCommit": "bfd196d5c9bfede10768e8cb5597ecc4d513d687", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA0MjI3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330#discussion_r461042278", "bodyText": "Great job CodeGuru \ud83d\udc4d", "author": "ShirleyZheng92", "createdAt": "2020-07-27T17:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzODQxMQ=="}], "type": "inlineReview"}, {"oid": "451182e06f55f0b1f5a24bbc0d5b960fa5b7866c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/451182e06f55f0b1f5a24bbc0d5b960fa5b7866c", "message": "Add random suffix in e2e test component name\n\nAdd random suffix in e2e test component name so that the test runs don't\ninterfere with each other", "committedDate": "2020-07-27T17:10:33Z", "type": "forcePushed"}, {"oid": "103cc27bc6bfc27cf6d2a6e860a4f5703e19c940", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/103cc27bc6bfc27cf6d2a6e860a4f5703e19c940", "message": "Add random suffix in e2e test component name\n\nAdd random suffix in e2e test component name so that the test runs don't\ninterfere with each other", "committedDate": "2020-07-27T17:23:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0Mjc2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330#discussion_r461142763", "bodyText": "Why do we copy the content in a private method, every invoker will repeat copying?\nAlso is it a good idea to instantiate an instance variable in private method? Do we have better choice?", "author": "wikimonkey", "createdAt": "2020-07-27T20:14:56Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -146,6 +164,13 @@ protected void initKernel() throws IOException {\n      */\n     private static void uploadTestComponentsToCms(boolean commit, PackageIdentifier... pkgIds)\n             throws IOException, PackagingException {\n+        Path localStoreContentPath = Paths.get(BaseE2ETestCase.class.getResource(\"local_store_content\").getPath());", "originalCommit": "103cc27bc6bfc27cf6d2a6e860a4f5703e19c940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1MjUzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330#discussion_r461152532", "bodyText": "uploadTestComponentsToCms() is a one time call in @BeforeAll , and removed in @afterall\nI can check if it's possible to initialize once in global class initialization, the cleanup might be a little hard", "author": "ShirleyZheng92", "createdAt": "2020-07-27T20:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0Mjc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMjU5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330#discussion_r461222596", "bodyText": "It would be good if the field can use final modifier. But at least it's a static method that indicates it should be invokes @BeforeAll. Got it.", "author": "wikimonkey", "createdAt": "2020-07-27T23:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0Mjc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NTA0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330#discussion_r461145049", "bodyText": "Understand what you are trying to do here, but doing a text replacement in recipe seems hacky to me.\nI'd like to probe if randomizing is the best option. Can independent cloud service stage help? such as device development using their gamma stage. Can the test cases manage the deletion of uploaded components? Can the test cases increment component version for every test run?", "author": "wikimonkey", "createdAt": "2020-07-27T20:19:21Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -170,26 +195,41 @@ private static void uploadTestComponentsToCms(boolean commit, PackageIdentifier.\n         }\n     }\n \n-    private static void draftComponent(PackageIdentifier pkgId) throws PackagingException, IOException {\n-        Path localStoreContentPath = Paths.get(BaseE2ETestCase.class.getResource(\"local_store_content\").getPath());\n-        PackageStore e2eTestPackageStore = new PackageStore(localStoreContentPath);\n+    private static void draftComponent(PackageIdentifier pkgIdCloud) throws IOException {\n+\n+        PackageIdentifier pkgIdLocal = new PackageIdentifier(removeTestComponentNameCloudSuffix(pkgIdCloud.getName()),\n+                pkgIdCloud.getVersion(), pkgIdCloud.getScope());\n+\n+        Path testRecipePath = e2eTestPackageStore.resolveRecipePath(pkgIdLocal);\n+\n+        // update recipe\n+        String content = new String(Files.readAllBytes(testRecipePath), StandardCharsets.UTF_8);\n+        Set<String> componentNameSet = Arrays.stream(testComponents)\n+                .map(component -> component.getName()).collect(Collectors.toSet());\n+\n+        for (String cloudPkgName: componentNameSet) {\n+            String localPkgName = removeTestComponentNameCloudSuffix(cloudPkgName);\n+            content = content.replaceAll(localPkgName + \"\\n\", cloudPkgName + \"\\n\");\n+            content = content.replaceAll(localPkgName + \":\", cloudPkgName + \":\");\n+        }", "originalCommit": "103cc27bc6bfc27cf6d2a6e860a4f5703e19c940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE2Mjk3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330#discussion_r461162977", "bodyText": "I feel the other options will have the same problem. We want the same code to run on different cloud stages, and Our test cases hard code version in recipe as well, so the string replacement is needed anyways. I think package name String replacement is easier than others. I can add placeholder mark like {{}} so the replacement is more obvious.", "author": "ShirleyZheng92", "createdAt": "2020-07-27T20:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NTA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMDc4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/330#discussion_r461220782", "bodyText": "It makes sense. Then it needs to make sure replacement consistently without side effects. Either can be deserialized to model then reset the name or using special placeholder marks.", "author": "wikimonkey", "createdAt": "2020-07-27T23:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NTA0OQ=="}], "type": "inlineReview"}, {"oid": "e9fbe415fd1e54941279ed7a57cc92415be5ae28", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e9fbe415fd1e54941279ed7a57cc92415be5ae28", "message": "Add random suffix in e2e test component name\n\nAdd random suffix in e2e test component name so that the test runs don't\ninterfere with each other", "committedDate": "2020-07-27T22:37:29Z", "type": "commit"}, {"oid": "89d5a2fe3c2587741a6039b12bdfc68ecc41033e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/89d5a2fe3c2587741a6039b12bdfc68ecc41033e", "message": "Address comments", "committedDate": "2020-07-27T23:16:17Z", "type": "commit"}, {"oid": "89d5a2fe3c2587741a6039b12bdfc68ecc41033e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/89d5a2fe3c2587741a6039b12bdfc68ecc41033e", "message": "Address comments", "committedDate": "2020-07-27T23:16:17Z", "type": "forcePushed"}, {"oid": "9507cb396c9b76bb9739958707115d7e7c86514d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9507cb396c9b76bb9739958707115d7e7c86514d", "message": "e2e test fix", "committedDate": "2020-07-28T07:02:45Z", "type": "forcePushed"}, {"oid": "686072d5f5cf73d6f59e43ba08599771488a9fcc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/686072d5f5cf73d6f59e43ba08599771488a9fcc", "message": "e2e test fix", "committedDate": "2020-07-28T19:47:54Z", "type": "forcePushed"}, {"oid": "f6c9e3a1aa5a9be2ffb3b7c0d0248058afd67a09", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f6c9e3a1aa5a9be2ffb3b7c0d0248058afd67a09", "message": "e2e test fix", "committedDate": "2020-07-28T20:15:37Z", "type": "commit"}, {"oid": "f6c9e3a1aa5a9be2ffb3b7c0d0248058afd67a09", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f6c9e3a1aa5a9be2ffb3b7c0d0248058afd67a09", "message": "e2e test fix", "committedDate": "2020-07-28T20:15:37Z", "type": "forcePushed"}]}