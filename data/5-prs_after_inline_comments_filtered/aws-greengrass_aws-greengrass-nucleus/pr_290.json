{"pr_number": 290, "pr_title": "replace the old mqtt client from awssdk with the new one", "pr_createdAt": "2020-06-25T03:44:06Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5MjEwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r445292108", "bodyText": "[nit]\nJust throw the new exception instead of storing it as a variable first.", "author": "MikeDombo", "createdAt": "2020-06-25T03:53:19Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/WrapperMqttClientConnection.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnection;\n+import software.amazon.awssdk.crt.mqtt.MqttConnectionConfig;\n+import software.amazon.awssdk.crt.mqtt.MqttMessage;\n+import software.amazon.awssdk.crt.mqtt.QualityOfService;\n+\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeoutException;\n+import java.util.function.Consumer;\n+import javax.inject.Inject;\n+\n+\n+public class WrapperMqttClientConnection extends MqttClientConnection {\n+\n+     private final MqttClient mqttClient;\n+     private final Map<String, UnsubscribeRequest> unsubscriptions = new ConcurrentHashMap<>();\n+     private static final String errMsg = \"The operation is not supported by the class of WrapperMqttClientConnection\";\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param mqttClient is from package of com.aws.iot.evergreen.mqtt to replace\n+     *                   the old MqttClient from software.amazon.awssdk.crt.mqtt.MqttClient\n+     */\n+    @Inject\n+    public WrapperMqttClientConnection(MqttClient mqttClient) {\n+        super(getMqttConnectionConfig());\n+        this.mqttClient = mqttClient;\n+    }\n+\n+    /*\n+     * This is to initialize a valid MqttConnectionConfig which could be used\n+     * in the WrapperMqttClientConnection\n+     *\n+     * @return MqttConnectionConfig\n+     */\n+    private static MqttConnectionConfig getMqttConnectionConfig() {\n+        try (EventLoopGroup eventLoopGroup = new EventLoopGroup(0);\n+            HostResolver resolver = new HostResolver(eventLoopGroup);\n+            ClientBootstrap clientBootstrap = new ClientBootstrap(eventLoopGroup, resolver);\n+            software.amazon.awssdk.crt.mqtt.MqttClient oldMqttClient =\n+                     new software.amazon.awssdk.crt.mqtt.MqttClient(clientBootstrap);) {\n+            String clientId = \"fakeClientId\";\n+            String endpoint = \"fakeEndpoint\";\n+            int portNumber = 1;\n+            MqttConnectionConfig fakeConfig = new MqttConnectionConfig();\n+            fakeConfig.setMqttClient(oldMqttClient);\n+            fakeConfig.setPort(portNumber);\n+            fakeConfig.setClientId(clientId);\n+            fakeConfig.setEndpoint(endpoint);\n+            return fakeConfig;\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<Integer> subscribe(String topic, QualityOfService qos, Consumer<MqttMessage> handler) {\n+        CompletableFuture<Integer> future = new CompletableFuture<>();\n+        SubscribeRequest request = SubscribeRequest.builder()\n+                .topic(topic).qos(qos).callback(handler).build();\n+        UnsubscribeRequest unsubscribeRequest = UnsubscribeRequest.builder()\n+                .topic(request.getTopic()).callback(request.getCallback()).build();\n+        unsubscriptions.put(request.getTopic(), unsubscribeRequest);\n+        try {\n+            mqttClient.subscribe(request);\n+            future.complete(0);\n+            return future;\n+        } catch (ExecutionException | InterruptedException | TimeoutException e) {\n+            unsubscriptions.remove(request.getTopic());\n+            future.completeExceptionally(e);\n+            return future;\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<Integer> subscribe(String topic, QualityOfService qos) {\n+        UnsupportedOperationException e = new UnsupportedOperationException(errMsg);\n+        throw e;", "originalCommit": "2833de2597b3b5b62f2678f35ccabe49ff9c5d6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d87b1933c69c648f548cc939f01929facb8bfd87", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d87b1933c69c648f548cc939f01929facb8bfd87", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T18:43:33Z", "type": "forcePushed"}, {"oid": "ee5bd2e5f47b79dffd5a8b911b336e46915748d3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ee5bd2e5f47b79dffd5a8b911b336e46915748d3", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T18:47:56Z", "type": "forcePushed"}, {"oid": "387954e527d5e7594471f8b06fd8fd2a167c6e89", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/387954e527d5e7594471f8b06fd8fd2a167c6e89", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T19:42:10Z", "type": "forcePushed"}, {"oid": "0f0094c08ac07558826cc4b2e9a2da2efbd51f22", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0f0094c08ac07558826cc4b2e9a2da2efbd51f22", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T19:45:40Z", "type": "forcePushed"}, {"oid": "0792b7a21c8315eae57af29e12ba9488b3226a47", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0792b7a21c8315eae57af29e12ba9488b3226a47", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T19:51:32Z", "type": "forcePushed"}, {"oid": "3a1f058b1efcd1e6983dda7c5960434e6e958a8b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3a1f058b1efcd1e6983dda7c5960434e6e958a8b", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T20:18:44Z", "type": "forcePushed"}, {"oid": "c85d4d7262f47b85bd9a513b7fc2523a0a19b621", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c85d4d7262f47b85bd9a513b7fc2523a0a19b621", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T20:21:52Z", "type": "forcePushed"}, {"oid": "4ab54f62adf3637be409a97b35857e9da1d1dad5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ab54f62adf3637be409a97b35857e9da1d1dad5", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T23:09:48Z", "type": "forcePushed"}, {"oid": "1fa02dff99c2de66259e64de6f87cabe957ffb48", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1fa02dff99c2de66259e64de6f87cabe957ffb48", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T23:24:33Z", "type": "forcePushed"}, {"oid": "93567495f6f557b8ab745e6e039e890d17875c43", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/93567495f6f557b8ab745e6e039e890d17875c43", "message": "Move unsubscribe out of callback and *always* unsubscribe from job updates", "committedDate": "2020-06-25T23:26:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MTc1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r446461755", "bodyText": "This is a breaking change. This functionality exists in the current implementation. If you plan to do this in separate PR, add a sim task for it, so it is not missed.", "author": "abanthiy", "createdAt": "2020-06-27T00:37:00Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -84,27 +83,28 @@ void afterEach() {\n         cleanup();\n     }\n \n+    // Disabled until we have spooling for offline messaging", "originalCommit": "93567495f6f557b8ab745e6e039e890d17875c43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNTgxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453735813", "bodyText": "Remove this comment @awszztt since it is no longer disabled.", "author": "MikeDombo", "createdAt": "2020-07-13T15:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MTc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MjU3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r446462571", "bodyText": "We need equivalent of this code in the new client.", "author": "abanthiy", "createdAt": "2020-06-27T00:43:27Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -209,198 +193,45 @@\n         }\n     };\n \n-    @Getter\n-    private MqttClientConnectionEvents callbacks = new MqttClientConnectionEvents() {\n-        @Override\n-        public void onConnectionInterrupted(int errorCode) {\n-            //TODO: what about error code 0\n-            if (errorCode != 0) {\n-                logger.atWarn().kv(\"error\", CRT.awsErrorString(errorCode)).log(\"Connection interrupted\");\n-                //TODO: Detect this using secondary mechanisms like checking if internet is availalble\n-                // instead of using ping to Mqtt server. Mqtt ping is expensive and should be used as the last resort.\n-            }\n-        }\n-\n-        @Override\n-        @SuppressFBWarnings\n-        public void onConnectionResumed(boolean sessionPresent) {\n-            logger.atInfo().kv(\"sessionPresent\", sessionPresent).log(\"Connection resumed\");\n-            executorService.submit(() -> {\n-                subscribeToJobsTopics();\n-                deploymentStatusKeeper.publishPersistedStatusUpdates(DeploymentType.IOT_JOBS);", "originalCommit": "93567495f6f557b8ab745e6e039e890d17875c43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MTE2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447281168", "bodyText": "I put a similar part of code into the function of \"postInject()\". The real change I made to there lines is to move out the code inside executorService.submit(() -> { } and then remove the executorService. Do you mean the executorService is required?", "author": "awszztt", "createdAt": "2020-06-29T22:05:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MTk0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447281948", "bodyText": "No, the key difference is that this is in onConnectionResumed so when the internet connection comes back it will try sending updates again. We could add this callback to our MQTT client and then this should work again.", "author": "MikeDombo", "createdAt": "2020-06-29T22:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI5NTI5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447295291", "bodyText": "I saw there is a callback blocks - onConnectionResumed - in the AwsIotMqttClient, in which all the subscriptions would be resubscribed. If this callback session is added, will it do some duplicate work?", "author": "awszztt", "createdAt": "2020-06-29T22:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI5NjI1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447296259", "bodyText": "No, this isn't duplicate (as long as you don't do the resubscribe). What is somewhat duplicated is the re-publish, but this will only be a duplicate once we actually have the cloud spooler.", "author": "MikeDombo", "createdAt": "2020-06-29T22:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MjU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2NDE4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r446464180", "bodyText": "Do both TimeoutException blocks need to exist? Sync with michael on this, he said both are possible.", "author": "abanthiy", "createdAt": "2020-06-27T00:55:43Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -418,14 +249,18 @@ private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n                 logger.atWarn().setCause(e).kv(STATUS_LOG_KEY_NAME, status)\n                         .log(UPDATE_DEPLOYMENT_STATUS_MQTT_ERROR_LOG);\n                 return false;\n+            } else if (e.getCause() instanceof TimeoutException) {\n+                // assuming this is due to network issue\n+                logger.info(UPDATE_DEPLOYMENT_STATUS_TIMEOUT_ERROR_LOG);\n+                return false;\n             }\n-            //This happens when job status update gets rejected from the Iot Cloud\n-            //Want to remove this job from the list and continue updating others\n+            // This happens when job status update gets rejected from the Iot Cloud\n+            // Want to remove this job from the list and continue updating others\n             logger.atError().kv(STATUS_LOG_KEY_NAME, status).kv(JOB_ID_LOG_KEY_NAME, jobId).setCause(e)\n                     .log(\"Job status update rejected\");\n             return true;\n         } catch (TimeoutException e) {", "originalCommit": "93567495f6f557b8ab745e6e039e890d17875c43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2NzM4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447267385", "bodyText": "I do not think we need the fake config. Read the comment above about using the connection in the AwsIotMqttClient", "author": "abanthiy", "createdAt": "2020-06-29T21:34:22Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/WrapperMqttClientConnection.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnection;\n+import software.amazon.awssdk.crt.mqtt.MqttConnectionConfig;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.crt.mqtt.MqttMessage;\n+import software.amazon.awssdk.crt.mqtt.QualityOfService;\n+\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeoutException;\n+import java.util.function.Consumer;\n+import javax.inject.Inject;\n+\n+\n+public class WrapperMqttClientConnection extends MqttClientConnection {\n+\n+    private final MqttClient mqttClient;\n+    private final Map<String, UnsubscribeRequest> unsubscriptions = new ConcurrentHashMap<>();\n+    private static final String errMsg = \"The operation is not supported by the class of WrapperMqttClientConnection\";\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param mqttClient is from package of com.aws.iot.evergreen.mqtt to replace the old MqttClient from\n+     *                   software.amazon.awssdk.crt.mqtt.MqttClient\n+     */\n+    @Inject\n+    public WrapperMqttClientConnection(MqttClient mqttClient) {\n+        super(getMqttConnectionConfig());\n+        this.mqttClient = mqttClient;\n+    }\n+\n+    /*\n+     * This is to initialize a valid MqttConnectionConfig which could be used", "originalCommit": "93567495f6f557b8ab745e6e039e890d17875c43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MTU0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447271549", "bodyText": "Why does this need to extend MqttClientConnection? I believe you need MqttClientConnection to initialize the iotJobsHelper.\nThe MqttClient has a list of AwsIotMqttClient which represents the connection. So can you get that connection to initialize the JobHelper? This way you can avoid initializing fake config for the connection.", "author": "abanthiy", "createdAt": "2020-06-29T21:43:37Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/WrapperMqttClientConnection.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnection;\n+import software.amazon.awssdk.crt.mqtt.MqttConnectionConfig;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.crt.mqtt.MqttMessage;\n+import software.amazon.awssdk.crt.mqtt.QualityOfService;\n+\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeoutException;\n+import java.util.function.Consumer;\n+import javax.inject.Inject;\n+\n+\n+public class WrapperMqttClientConnection extends MqttClientConnection {", "originalCommit": "93567495f6f557b8ab745e6e039e890d17875c43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3NDM0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447274349", "bodyText": "It is needed to fake it out because they don't support an interface. I opened a PR on them to use an interface instead, but they haven't reviewed it yet.\nWe can't just give it a real connection because it will be creating subscriptions and publishing messages outside of our control. This means that we won't know when there are too many subscriptions, and it won't work with cloud spooler.", "author": "MikeDombo", "createdAt": "2020-06-29T21:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MTU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MjY1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447272651", "bodyText": "You can use the connection represented by the MqttClient in this wrapper for initializing the jobsHelper", "author": "abanthiy", "createdAt": "2020-06-29T21:45:56Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -209,198 +193,45 @@\n         }\n     };\n \n-    @Getter\n-    private MqttClientConnectionEvents callbacks = new MqttClientConnectionEvents() {\n-        @Override\n-        public void onConnectionInterrupted(int errorCode) {\n-            //TODO: what about error code 0\n-            if (errorCode != 0) {\n-                logger.atWarn().kv(\"error\", CRT.awsErrorString(errorCode)).log(\"Connection interrupted\");\n-                //TODO: Detect this using secondary mechanisms like checking if internet is availalble\n-                // instead of using ping to Mqtt server. Mqtt ping is expensive and should be used as the last resort.\n-            }\n-        }\n-\n-        @Override\n-        @SuppressFBWarnings\n-        public void onConnectionResumed(boolean sessionPresent) {\n-            logger.atInfo().kv(\"sessionPresent\", sessionPresent).log(\"Connection resumed\");\n-            executorService.submit(() -> {\n-                subscribeToJobsTopics();\n-                deploymentStatusKeeper.publishPersistedStatusUpdates(DeploymentType.IOT_JOBS);\n-            });\n-        }\n-    };\n-\n     /**\n      * Constructor for unit testing.\n      *\n      */\n     IotJobsHelper(DeviceConfiguration deviceConfiguration,\n-                  AWSIotMqttConnectionFactory awsIotMqttConnectionFactory,\n                   IotJobsClientFactory iotJobsClientFactory,\n                   LinkedBlockingQueue<Deployment> deploymentsQueue,\n                   DeploymentStatusKeeper deploymentStatusKeeper,\n                   ExecutorService executorService,\n-                  Kernel kernel) {\n+                  Kernel kernel,\n+                  WrapperMqttClientConnection connection) {\n         this.deviceConfiguration = deviceConfiguration;\n-        this.awsIotMqttConnectionFactory = awsIotMqttConnectionFactory;\n         this.iotJobsClientFactory = iotJobsClientFactory;\n         this.deploymentsQueue = deploymentsQueue;\n         this.deploymentStatusKeeper = deploymentStatusKeeper;\n         this.executorService = executorService;\n         this.kernel = kernel;\n+        this.connection = connection;\n     }\n \n     @Override\n     @SuppressFBWarnings\n     public void postInject() {\n-\n-        //TODO: once connectToAWSIot and closeConnection is removed from post inject\n-        // this check should be removed\n-        if (postInjectInProgress.get()) {\n-            return;\n-        }\n-        postInjectInProgress.set(true);\n-\n-        //TODO: remove establishing mqtt connection logic when when MQTT proxy is implemented.\n-        executorService.submit(() -> {\n-            try {\n-                connectToAWSIot();\n-            } catch (InterruptedException e) {\n-               //TODO: re-evaluate the retry strategy,\n-               // re-connection attempts are made only for ConnectionUnavailableException\n-               logger.error(\"Failed to connect to IoT cloud\");\n-            }\n-        });\n-\n-        //TODO: remove closing mqtt connection logic from iot jobs handler when MQTT proxy is implemented.\n-        Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n-            try {\n-                closeConnection();\n-            } catch (ExecutionException | InterruptedException e) {\n-                logger.atError().log(\"Error while closing IoT client\", e);\n-            }\n-        }));\n-\n+        // Mqtt Client would automatically connect to AWS Iot\n+        this.iotJobsClient = iotJobsClientFactory.getIotJobsClient(connection);\n+        logger.dfltKv(\"ThingName\", (Supplier<String>) () ->\n+                Coerce.toString(deviceConfiguration.getThingName()));\n+        subscribeToJobsTopics();\n+        logger.atInfo().log(\"Connection established to Iot cloud\");\n         deploymentStatusKeeper.registerDeploymentStatusConsumer(DeploymentType.IOT_JOBS,\n                 this::deploymentStatusChanged);\n     }\n \n-    private void connectToAWSIot() throws InterruptedException {\n-        // If a device is unable to connect to AWS Iot upon starting due to network availability,\n-        // the device will retry connecting to AWS Iot cloud. Retry frequency used is the same as frequency\n-        // used by deployment service to poll for new deployments.\n-        boolean shouldRetry = true;\n-        while (shouldRetry && !receivedShutdown.get()) {\n-            shouldRetry = false;\n-            try {\n-                //TODO: Separate out making MQTT connection and IotJobs helper when MQTT proxy is used.\n-                connect();\n-            } catch (DeviceConfigurationException e) {\n-                //Since there is no device configuration, device should still be able to perform local deploymentsQueue\n-                logger.atWarn().setCause(e).log(\"Device not configured to communicate with AWS Iot Cloud \"\n-                        + \"Device will now operate in offline mode\");\n-            } catch (ConnectionUnavailableException e) {\n-                logger.atWarn().setCause(e).log(\"Fail to connect to IoT cloud due to connectivity issue,\"\n-                        + \" will retry later. Device will now operate in offline mode\");\n-                shouldRetry = true;\n-                Thread.sleep(INITIAL_CONNECT_RETRY_FREQUENCY);\n-            } catch (AWSIotException e) {\n-                //This is a non transient exception and might require customer's attention\n-                logger.atError().setCause(e).log(\"Caught an exception from AWS Iot cloud\");\n-                //TODO: Revisit if we should error the service in this case\n-            }\n-        }\n-    }\n-\n-    public static class AWSIotMqttConnectionFactory {\n-        /**\n-         * Get the mqtt connection from device configuration.\n-         *\n-         * @param deviceConfiguration The device configuration {@link DeviceConfiguration}\n-         * @param callbacks           Mqtt callbacks invoked on connection events\n-         * @return {@link MqttClientConnection}\n-         */\n-        public MqttClientConnection getAwsIotMqttConnection(DeviceConfiguration deviceConfiguration,\n-                                                            MqttClientConnectionEvents callbacks) {\n-            try (EventLoopGroup eventLoopGroup = new EventLoopGroup(1);\n-                 HostResolver resolver = new HostResolver(eventLoopGroup);\n-                 ClientBootstrap clientBootstrap = new ClientBootstrap(eventLoopGroup, resolver);\n-                 AwsIotMqttConnectionBuilder builder = AwsIotMqttConnectionBuilder\n-                         .newMtlsBuilderFromPath(Coerce.toString(deviceConfiguration.getCertificateFilePath()),\n-                                 Coerce.toString(deviceConfiguration.getPrivateKeyFilePath()))) {\n-                builder.withCertificateAuthorityFromPath(null, Coerce.toString(deviceConfiguration.getRootCAFilePath()))\n-                        //TODO: With MQTT proxy this will change\n-                        .withEndpoint(Coerce.toString(deviceConfiguration.getIotDataEndpoint()))\n-                        .withClientId(UUID.randomUUID().toString()).withCleanSession(true)\n-                        .withBootstrap(clientBootstrap).withConnectionEventCallbacks(callbacks)\n-                        .withKeepAliveMs(MQTT_KEEP_ALIVE_TIMEOUT).withPingTimeoutMs(MQTT_PING_TIMEOUT);\n-                return builder.build();\n-            }\n-        }\n-    }\n-\n     public static class IotJobsClientFactory {\n-        public IotJobsClient getIotJobsClient(MqttClientConnection connection) {\n+        public IotJobsClient getIotJobsClient(WrapperMqttClientConnection connection) {\n             return new IotJobsClient(connection);", "originalCommit": "93567495f6f557b8ab745e6e039e890d17875c43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwMTgwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r447301809", "bodyText": "From my understanding, A Mqtt client is a manger to control multiple AwsIotMqttClient and a single AwsIotMqttClient is a MqttConnection. It is hard to use a specific connection for the IotJobsClient here.\nEach WrapperMqttClientConnection instance has exactly one MqttClient. All the works should be managed by the MqttClient. The MqttClient would provide the specific connection that the IotJobsClient needs.", "author": "awszztt", "createdAt": "2020-06-29T22:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MjY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2OTc0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r448669742", "bodyText": "You must not remove this.", "author": "MikeDombo", "createdAt": "2020-07-01T23:37:49Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClient.java", "diffHunk": "@@ -51,28 +49,6 @@\n     @SuppressFBWarnings(\"IS2_INCONSISTENT_SYNC\")\n     private MqttClientConnection connection;\n \n-    private final MqttClientConnectionEvents connectionEventCallback = new MqttClientConnectionEvents() {", "originalCommit": "dad88d7d2aaf700ef59997ebc172206e0cae738c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1MjE1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r449752158", "bodyText": "Added it back", "author": "awszztt", "createdAt": "2020-07-04T08:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2OTc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMDE0NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450220144", "bodyText": "Your recent changes should fix this test, please undo this change.", "author": "MikeDombo", "createdAt": "2020-07-06T13:28:31Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -84,27 +83,28 @@ void afterEach() {\n         cleanup();\n     }\n \n+    // Disabled until we have spooling for offline messaging\n     @Timeout(value = 10, unit = TimeUnit.MINUTES)\n-    @Test\n-    void GIVEN_new_deployment_while_device_online_WHEN_mqtt_disconnects_and_reconnects_THEN_job_executes_successfully(ExtensionContext context) throws Exception {\n+//    @Test", "originalCommit": "3645d71aaaeb556a2fa4e66d78b505d421cb327d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NTE5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450565191", "bodyText": "I will remove the comment label here.", "author": "awszztt", "createdAt": "2020-07-07T01:41:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMDE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMDg1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450220857", "bodyText": "Remove everything in this callback. It isn't doing anything useful.", "author": "MikeDombo", "createdAt": "2020-07-06T13:29:37Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -119,16 +111,39 @@\n     @Inject\n     private Kernel kernel;\n \n+    @Inject\n+    private MqttClient mqttClient;\n+\n     @Setter\n     @Inject\n     @Named(DEPLOYMENTS_QUEUE)\n     private LinkedBlockingQueue<Deployment> deploymentsQueue;\n \n-    private final AtomicBoolean receivedShutdown = new AtomicBoolean(false);\n-    private final AtomicBoolean postInjectInProgress = new AtomicBoolean(false);\n-\n     private IotJobsClient iotJobsClient;\n-    private MqttClientConnection connection;\n+    private WrapperMqttClientConnection connection;\n+\n+    @Getter\n+    public MqttClientConnectionEvents callbacks = new MqttClientConnectionEvents() {\n+        @Override\n+        public void onConnectionInterrupted(int errorCode) {\n+            //TODO: what about error code 0", "originalCommit": "3645d71aaaeb556a2fa4e66d78b505d421cb327d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NTE2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450565163", "bodyText": "Done.", "author": "awszztt", "createdAt": "2020-07-07T01:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMDg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMTE0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450221145", "bodyText": "Remove this log, the real callback already logs this information.", "author": "MikeDombo", "createdAt": "2020-07-06T13:30:02Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -119,16 +111,39 @@\n     @Inject\n     private Kernel kernel;\n \n+    @Inject\n+    private MqttClient mqttClient;\n+\n     @Setter\n     @Inject\n     @Named(DEPLOYMENTS_QUEUE)\n     private LinkedBlockingQueue<Deployment> deploymentsQueue;\n \n-    private final AtomicBoolean receivedShutdown = new AtomicBoolean(false);\n-    private final AtomicBoolean postInjectInProgress = new AtomicBoolean(false);\n-\n     private IotJobsClient iotJobsClient;\n-    private MqttClientConnection connection;\n+    private WrapperMqttClientConnection connection;\n+\n+    @Getter\n+    public MqttClientConnectionEvents callbacks = new MqttClientConnectionEvents() {\n+        @Override\n+        public void onConnectionInterrupted(int errorCode) {\n+            //TODO: what about error code 0\n+            if (errorCode != 0) {\n+                logger.atWarn().kv(\"error\", CRT.awsErrorString(errorCode)).log(\"Connection interrupted\");\n+                //TODO: Detect this using secondary mechanisms like checking if internet is availalble\n+                // instead of using ping to Mqtt server. Mqtt ping is expensive and should be used as the last resort.\n+            }\n+        }\n+\n+        @Override\n+        @SuppressFBWarnings\n+        public void onConnectionResumed(boolean sessionPresent) {\n+            logger.atInfo().kv(\"sessionPresent\", sessionPresent).log(\"Connection resumed\");", "originalCommit": "3645d71aaaeb556a2fa4e66d78b505d421cb327d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NTE1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450565158", "bodyText": "Done.", "author": "awszztt", "createdAt": "2020-07-07T01:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMTE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMjkxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450222919", "bodyText": "This needs to be a set because we need to support more than 1 callback", "author": "MikeDombo", "createdAt": "2020-07-06T13:33:04Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;\n+    MqttClientConnectionEvents callbacks;", "originalCommit": "3645d71aaaeb556a2fa4e66d78b505d421cb327d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NTE1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450565152", "bodyText": "Done.", "author": "awszztt", "createdAt": "2020-07-07T01:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMjkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMzEyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450223129", "bodyText": "Rename this. It should not be specific to deployment.\nAlso, take the sessionPresent as a parameter to this method, not as a field of the class.", "author": "MikeDombo", "createdAt": "2020-07-06T13:33:25Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;\n+    MqttClientConnectionEvents callbacks;\n+    @NonNull MqttClient mqttClient;\n+    @Builder.Default\n+    @NonNull boolean hasCallBacked = false;\n+\n+    /**\n+     *  A MqttClient may control multiple AwsIotMqttClient.\n+     *  When the connection is back, this deploymentCallback should only be triggered by\n+     *  only one AwsIotMqttClient.\n+     */\n+    public synchronized void deploymentCallback() {", "originalCommit": "3645d71aaaeb556a2fa4e66d78b505d421cb327d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NTE0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450565142", "bodyText": "Done both.", "author": "awszztt", "createdAt": "2020-07-07T01:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMzEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyNDAxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450224016", "bodyText": "Do not check for all connected. If one connection is back, they all are, even if they don't realize it yet.", "author": "MikeDombo", "createdAt": "2020-07-06T13:34:51Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;\n+    MqttClientConnectionEvents callbacks;\n+    @NonNull MqttClient mqttClient;\n+    @Builder.Default\n+    @NonNull boolean hasCallBacked = false;\n+\n+    /**\n+     *  A MqttClient may control multiple AwsIotMqttClient.\n+     *  When the connection is back, this deploymentCallback should only be triggered by\n+     *  only one AwsIotMqttClient.\n+     */\n+    public synchronized void deploymentCallback() {\n+        if (!hasCallBacked && !mqttClient.isAllConnectionConnected()) {", "originalCommit": "3645d71aaaeb556a2fa4e66d78b505d421cb327d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NTExMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450565111", "bodyText": "Remove the isAllConnectionConnected in either MqttClient.call or the CallbackEventManager.", "author": "awszztt", "createdAt": "2020-07-07T01:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyNDAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyODMwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450828304", "bodyText": "Remove it from both. You don't need it as a condition, you can just use the Boolean that you already have.", "author": "MikeDombo", "createdAt": "2020-07-07T12:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyNDAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY3OTE0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451679140", "bodyText": "There is a new commit that just use the boolean \"hasCallBacked\". dfae16c", "author": "awszztt", "createdAt": "2020-07-08T16:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyNDAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyNDQ4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450224486", "bodyText": "This should not be set here. It need to be set  by onConnectionInterrupted.", "author": "MikeDombo", "createdAt": "2020-07-06T13:35:37Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;\n+    MqttClientConnectionEvents callbacks;\n+    @NonNull MqttClient mqttClient;\n+    @Builder.Default\n+    @NonNull boolean hasCallBacked = false;\n+\n+    /**\n+     *  A MqttClient may control multiple AwsIotMqttClient.\n+     *  When the connection is back, this deploymentCallback should only be triggered by\n+     *  only one AwsIotMqttClient.\n+     */\n+    public synchronized void deploymentCallback() {\n+        if (!hasCallBacked && !mqttClient.isAllConnectionConnected()) {\n+            callbacks.onConnectionResumed(sessionPresent);\n+\n+            // If the deployment callBacked has been finished, set it to be true.\n+            hasCallBacked = true;\n+        }\n+\n+        // When all the AwsIotMqttClients are back online, the callBackEvent would not be called any more.\n+        // Set the hasCallBacked to the init state.\n+        if (mqttClient.isAllConnectionConnected()) {\n+            hasCallBacked = false;", "originalCommit": "3645d71aaaeb556a2fa4e66d78b505d421cb327d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NTA4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r450565088", "bodyText": "Set the hasCallBacked from in the onConnectionInterrupted.", "author": "awszztt", "createdAt": "2020-07-07T01:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyNDQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4NTY3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451685673", "bodyText": "Remove commented out code", "author": "MikeDombo", "createdAt": "2020-07-08T16:47:43Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -15,21 +14,18 @@\n import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.mqtt.MqttClient;\n+import com.aws.iot.evergreen.mqtt.WrapperMqttClientConnection;\n import com.aws.iot.evergreen.util.Coerce;\n import com.fasterxml.jackson.core.JsonProcessingException;\n import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n import lombok.Getter;\n import lombok.NoArgsConstructor;\n import lombok.Setter;\n-import software.amazon.awssdk.crt.CRT;\n-import software.amazon.awssdk.crt.io.ClientBootstrap;\n-import software.amazon.awssdk.crt.io.EventLoopGroup;\n-import software.amazon.awssdk.crt.io.HostResolver;\n-import software.amazon.awssdk.crt.mqtt.MqttClientConnection;\n+//import software.amazon.awssdk.crt.CRT;", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4NjUxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451686517", "bodyText": "I don't think you really need this comment at all. If you want to keep it, I'd recommend just saying that this method isn't needed in this use case.", "author": "MikeDombo", "createdAt": "2020-07-08T16:49:04Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -119,16 +111,33 @@\n     @Inject\n     private Kernel kernel;\n \n+    @Inject\n+    private MqttClient mqttClient;\n+\n     @Setter\n     @Inject\n     @Named(DEPLOYMENTS_QUEUE)\n     private LinkedBlockingQueue<Deployment> deploymentsQueue;\n \n-    private final AtomicBoolean receivedShutdown = new AtomicBoolean(false);\n-    private final AtomicBoolean postInjectInProgress = new AtomicBoolean(false);\n-\n     private IotJobsClient iotJobsClient;\n-    private MqttClientConnection connection;\n+    private WrapperMqttClientConnection connection;\n+\n+    @Getter\n+    public MqttClientConnectionEvents callbacks = new MqttClientConnectionEvents() {\n+        @Override\n+        public void onConnectionInterrupted(int errorCode) {\n+            // Even though it would do nothing here, but this method could not be removed.", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4NzI5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451687295", "bodyText": "Should not be public", "author": "MikeDombo", "createdAt": "2020-07-08T16:50:17Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClient.java", "diffHunk": "@@ -52,6 +52,7 @@\n     @SuppressFBWarnings(\"IS2_INCONSISTENT_SYNC\")\n     private MqttClientConnection connection;\n     private final AtomicBoolean currentlyConnected = new AtomicBoolean();\n+    public CallbackEventManager callbackEventManager;", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4NzcwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451687708", "bodyText": "Why are you doing this? The callbacks do not belong to these clients, the callbacks are global.", "author": "MikeDombo", "createdAt": "2020-07-08T16:50:53Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClient.java", "diffHunk": "@@ -131,7 +134,10 @@ private synchronized boolean connect() throws ExecutionException, InterruptedExc\n         // Always use the builder provider here so that the builder is updated with whatever\n         // the latest device config is\n         try (AwsIotMqttConnectionBuilder builder = builderProvider.get()) {\n-            builder.withConnectionEventCallbacks(connectionEventCallback);\n+            // To remove the customized callbacks that belongs to other AwsIotMqttClient.\n+            callbackEventManager.customizedCallbackEvents.clear();", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY5ODAyMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451698020", "bodyText": "I was wondering, if the previous one is not removed, the same global callback would be added to the callbackManager n times (n is the number of AwsIotMqttClient)", "author": "awszztt", "createdAt": "2020-07-08T17:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4NzcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcwMjAwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451702006", "bodyText": "There does need to be 1 callback per client though to properly handle errors and reconnection.", "author": "MikeDombo", "createdAt": "2020-07-08T17:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4NzcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4ODU3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451688571", "bodyText": "This must not be a field. It need to be a parameter of the callback.", "author": "MikeDombo", "createdAt": "2020-07-08T16:52:14Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;\n+    @Builder.Default\n+    Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();\n+    @Builder.Default\n+    Set<MqttClientConnectionEvents> customizedCallbackEvents = new HashSet<>();\n+    @NonNull AtomicBoolean hasCallBacked;\n+\n+    /**\n+     *  A MqttClient may control multiple AwsIotMqttClients\n+     *  and each AwsIotMqttClients may have multiple callback events.\n+     * @param curSessionPresent is specific for eacg AwsIotMqttClient controlled by the MqttClient.\n+     *                          If false, mqtt Client do the callback actions. Otherwise, do nothing.\n+     */\n+    public synchronized void runOnConnectionResumed(boolean curSessionPresent) {\n+        setSessionPresent(curSessionPresent);\n+        // This type of callback would only be triggered once by one of the AwsIotMqttClient.\n+        for (MqttClientConnectionEvents callback : oneTimeCallbackEvents) {\n+            if (!hasCallBacked.get()) {\n+                callback.onConnectionResumed(sessionPresent);\n+            }\n+        }\n+        // If all the one-time callbackEvents has been finished, hasCallbacked should be set to true.\n+        hasCallBacked.set(true);\n+\n+        // This type of callback is specific for each AwsIotMqttClient.\n+        for (MqttClientConnectionEvents callback : customizedCallbackEvents) {\n+            callback.onConnectionResumed(sessionPresent);\n+        }\n+    }\n+\n+    /**\n+     * To run method of OnConnectionInterrupted if the connections are dropped.\n+     * @param errorCode would shared by all the callbacks.\n+     */\n+    public synchronized void runOnConnectionInterrupted(int errorCode) {\n+        hasCallBacked.set(false);\n+        for (MqttClientConnectionEvents callback : oneTimeCallbackEvents) {\n+            callback.onConnectionInterrupted(errorCode);\n+        }\n+        for (MqttClientConnectionEvents callback : customizedCallbackEvents) {\n+            callback.onConnectionInterrupted(errorCode);\n+        }\n+    }\n+\n+    /**\n+     * To set up sessionPresent.\n+     * @param sessionPresent is set up based on the AwsIotMqttClient\n+     */\n+    public synchronized void setSessionPresent(boolean sessionPresent) {\n+        this.sessionPresent = sessionPresent;", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4OTQxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451689419", "bodyText": "The way to proper use this is to use compare And Set. You want to compare to false and set to true only if it was false.", "author": "MikeDombo", "createdAt": "2020-07-08T16:53:37Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;\n+    @Builder.Default\n+    Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();\n+    @Builder.Default\n+    Set<MqttClientConnectionEvents> customizedCallbackEvents = new HashSet<>();\n+    @NonNull AtomicBoolean hasCallBacked;\n+\n+    /**\n+     *  A MqttClient may control multiple AwsIotMqttClients\n+     *  and each AwsIotMqttClients may have multiple callback events.\n+     * @param curSessionPresent is specific for eacg AwsIotMqttClient controlled by the MqttClient.\n+     *                          If false, mqtt Client do the callback actions. Otherwise, do nothing.\n+     */\n+    public synchronized void runOnConnectionResumed(boolean curSessionPresent) {\n+        setSessionPresent(curSessionPresent);\n+        // This type of callback would only be triggered once by one of the AwsIotMqttClient.\n+        for (MqttClientConnectionEvents callback : oneTimeCallbackEvents) {\n+            if (!hasCallBacked.get()) {", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4OTYxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451689613", "bodyText": "Now that you're using atomic boolean, these don't need to be synchronized.", "author": "MikeDombo", "createdAt": "2020-07-08T16:54:00Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;\n+    @Builder.Default\n+    Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();\n+    @Builder.Default\n+    Set<MqttClientConnectionEvents> customizedCallbackEvents = new HashSet<>();\n+    @NonNull AtomicBoolean hasCallBacked;\n+\n+    /**\n+     *  A MqttClient may control multiple AwsIotMqttClients\n+     *  and each AwsIotMqttClients may have multiple callback events.\n+     * @param curSessionPresent is specific for eacg AwsIotMqttClient controlled by the MqttClient.\n+     *                          If false, mqtt Client do the callback actions. Otherwise, do nothing.\n+     */\n+    public synchronized void runOnConnectionResumed(boolean curSessionPresent) {", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4OTc1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451689758", "bodyText": "All these fields should be private.", "author": "MikeDombo", "createdAt": "2020-07-08T16:54:14Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY5MDY4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451690684", "bodyText": "This is not what I would do. Go back to what you had before. Keep the callbacks as normal in the aws IoT client and then call this method in the callback manager from the callback defined in the IoT client.", "author": "MikeDombo", "createdAt": "2020-07-08T16:55:45Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import lombok.Builder;\n+import lombok.NonNull;\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+@Builder\n+public class CallbackEventManager {\n+    boolean sessionPresent;\n+    @Builder.Default\n+    Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();\n+    @Builder.Default\n+    Set<MqttClientConnectionEvents> customizedCallbackEvents = new HashSet<>();\n+    @NonNull AtomicBoolean hasCallBacked;\n+\n+    /**\n+     *  A MqttClient may control multiple AwsIotMqttClients\n+     *  and each AwsIotMqttClients may have multiple callback events.\n+     * @param curSessionPresent is specific for eacg AwsIotMqttClient controlled by the MqttClient.\n+     *                          If false, mqtt Client do the callback actions. Otherwise, do nothing.\n+     */\n+    public synchronized void runOnConnectionResumed(boolean curSessionPresent) {\n+        setSessionPresent(curSessionPresent);\n+        // This type of callback would only be triggered once by one of the AwsIotMqttClient.\n+        for (MqttClientConnectionEvents callback : oneTimeCallbackEvents) {\n+            if (!hasCallBacked.get()) {\n+                callback.onConnectionResumed(sessionPresent);\n+            }\n+        }\n+        // If all the one-time callbackEvents has been finished, hasCallbacked should be set to true.\n+        hasCallBacked.set(true);\n+\n+        // This type of callback is specific for each AwsIotMqttClient.\n+        for (MqttClientConnectionEvents callback : customizedCallbackEvents) {", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY5MTU1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451691559", "bodyText": "A builder is really unnecessary. You can just create the atomic boolean in the field declaration.", "author": "MikeDombo", "createdAt": "2020-07-08T16:57:09Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/MqttClient.java", "diffHunk": "@@ -81,6 +84,10 @@\n     private final HostResolver hostResolver;\n     private final ClientBootstrap clientBootstrap;\n \n+    public AtomicBoolean hasCallbacked = new AtomicBoolean(false);\n+    public CallbackEventManager callbackEventManager =\n+            CallbackEventManager.builder().hasCallBacked(hasCallbacked).build();", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY5MjEyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451692124", "bodyText": "No * imports. Please use the intellij.xml file in the code style directory to apply our coding style to your intellij environment.", "author": "MikeDombo", "createdAt": "2020-07-08T16:58:04Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -18,11 +18,7 @@\n import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n import com.aws.iot.evergreen.logging.impl.Slf4jLogAdapter;\n import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n-import org.junit.jupiter.api.AfterEach;\n-import org.junit.jupiter.api.BeforeEach;\n-import org.junit.jupiter.api.Tag;\n-import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.*;", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY5MzM1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451693352", "bodyText": "I wouldn't do it this way, instead go back to how you had it before and just have the callback defined in this class call the callback manager.", "author": "MikeDombo", "createdAt": "2020-07-08T17:00:04Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClient.java", "diffHunk": "@@ -131,7 +134,10 @@ private synchronized boolean connect() throws ExecutionException, InterruptedExc\n         // Always use the builder provider here so that the builder is updated with whatever\n         // the latest device config is\n         try (AwsIotMqttConnectionBuilder builder = builderProvider.get()) {\n-            builder.withConnectionEventCallbacks(connectionEventCallback);\n+            // To remove the customized callbacks that belongs to other AwsIotMqttClient.\n+            callbackEventManager.customizedCallbackEvents.clear();\n+            callbackEventManager.addToCallbackEvents(false, connectionEventCallback);\n+            builder.withConnectionEventCallbacks(callbackEventManager.getCallbackEvents());", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY5Mzg5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451693898", "bodyText": "Rename this to add because it isn't setting but adding.", "author": "MikeDombo", "createdAt": "2020-07-08T17:00:59Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/MqttClient.java", "diffHunk": "@@ -352,4 +359,8 @@ public synchronized void close() {\n         hostResolver.close();\n         eventLoopGroup.close();\n     }\n+\n+    public void setMqttEventCallback(MqttClientConnectionEvents callbacks) {", "originalCommit": "d53877e8bf0ca8309500cec2cfb91270b823fedb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDUyMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451840520", "bodyText": "this check needs to go outside of the for loop, otherwise only the first one will be called, which isn't correct.", "author": "MikeDombo", "createdAt": "2020-07-08T21:39:31Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -1,98 +1,47 @@\n package com.aws.iot.evergreen.mqtt;\n \n-import lombok.Builder;\n-import lombok.NonNull;\n import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n \n import java.util.HashSet;\n import java.util.Set;\n import java.util.concurrent.atomic.AtomicBoolean;\n \n-@Builder\n public class CallbackEventManager {\n-    boolean sessionPresent;\n-    @Builder.Default\n-    Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();\n-    @Builder.Default\n-    Set<MqttClientConnectionEvents> customizedCallbackEvents = new HashSet<>();\n-    @NonNull AtomicBoolean hasCallBacked;\n+    private final Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();\n+    private final AtomicBoolean hasCallBacked = new AtomicBoolean(false);\n \n     /**\n      *  A MqttClient may control multiple AwsIotMqttClients\n      *  and each AwsIotMqttClients may have multiple callback events.\n-     * @param curSessionPresent is specific for eacg AwsIotMqttClient controlled by the MqttClient.\n+     * @param curSessionPresent is specific for each AwsIotMqttClient controlled by the MqttClient.\n      *                          If false, mqtt Client do the callback actions. Otherwise, do nothing.\n      */\n-    public synchronized void runOnConnectionResumed(boolean curSessionPresent) {\n-        setSessionPresent(curSessionPresent);\n+    public void runOnConnectionResumed(boolean curSessionPresent) {\n         // This type of callback would only be triggered once by one of the AwsIotMqttClient.\n         for (MqttClientConnectionEvents callback : oneTimeCallbackEvents) {\n-            if (!hasCallBacked.get()) {\n-                callback.onConnectionResumed(sessionPresent);\n+            if (!hasCallBacked.compareAndSet(false, true)) {", "originalCommit": "c244be16f9f28b426b4ab8eaf33a80bd1f5ef937", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDc1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451840758", "bodyText": "same here, this check needs to go outside of the for loop so that it calls all of the callbacks", "author": "MikeDombo", "createdAt": "2020-07-08T21:40:03Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -1,98 +1,47 @@\n package com.aws.iot.evergreen.mqtt;\n \n-import lombok.Builder;\n-import lombok.NonNull;\n import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n \n import java.util.HashSet;\n import java.util.Set;\n import java.util.concurrent.atomic.AtomicBoolean;\n \n-@Builder\n public class CallbackEventManager {\n-    boolean sessionPresent;\n-    @Builder.Default\n-    Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();\n-    @Builder.Default\n-    Set<MqttClientConnectionEvents> customizedCallbackEvents = new HashSet<>();\n-    @NonNull AtomicBoolean hasCallBacked;\n+    private final Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();\n+    private final AtomicBoolean hasCallBacked = new AtomicBoolean(false);\n \n     /**\n      *  A MqttClient may control multiple AwsIotMqttClients\n      *  and each AwsIotMqttClients may have multiple callback events.\n-     * @param curSessionPresent is specific for eacg AwsIotMqttClient controlled by the MqttClient.\n+     * @param curSessionPresent is specific for each AwsIotMqttClient controlled by the MqttClient.\n      *                          If false, mqtt Client do the callback actions. Otherwise, do nothing.\n      */\n-    public synchronized void runOnConnectionResumed(boolean curSessionPresent) {\n-        setSessionPresent(curSessionPresent);\n+    public void runOnConnectionResumed(boolean curSessionPresent) {\n         // This type of callback would only be triggered once by one of the AwsIotMqttClient.\n         for (MqttClientConnectionEvents callback : oneTimeCallbackEvents) {\n-            if (!hasCallBacked.get()) {\n-                callback.onConnectionResumed(sessionPresent);\n+            if (!hasCallBacked.compareAndSet(false, true)) {\n+                callback.onConnectionResumed(curSessionPresent);\n             }\n         }\n-        // If all the one-time callbackEvents has been finished, hasCallbacked should be set to true.\n-        hasCallBacked.set(true);\n-\n-        // This type of callback is specific for each AwsIotMqttClient.\n-        for (MqttClientConnectionEvents callback : customizedCallbackEvents) {\n-            callback.onConnectionResumed(sessionPresent);\n-        }\n     }\n \n     /**\n      * To run method of OnConnectionInterrupted if the connections are dropped.\n      * @param errorCode would shared by all the callbacks.\n      */\n-    public synchronized void runOnConnectionInterrupted(int errorCode) {\n-        hasCallBacked.set(false);\n+    public void runOnConnectionInterrupted(int errorCode) {\n         for (MqttClientConnectionEvents callback : oneTimeCallbackEvents) {\n-            callback.onConnectionInterrupted(errorCode);\n-        }\n-        for (MqttClientConnectionEvents callback : customizedCallbackEvents) {\n-            callback.onConnectionInterrupted(errorCode);\n+            if (!hasCallBacked.compareAndSet(true, false)) {", "originalCommit": "c244be16f9f28b426b4ab8eaf33a80bd1f5ef937", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0NTAxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r451845017", "bodyText": "Good catch! I have corrected this part and submitted a new commit.", "author": "awszztt", "createdAt": "2020-07-08T21:50:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNjI3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453736270", "bodyText": "what warning is being suppressed? Get rid of the warning if we can.", "author": "MikeDombo", "createdAt": "2020-07-13T15:31:10Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -119,16 +110,32 @@\n     @Inject\n     private Kernel kernel;\n \n+    @Inject\n+    private MqttClient mqttClient;\n+\n     @Setter\n     @Inject\n     @Named(DEPLOYMENTS_QUEUE)\n     private LinkedBlockingQueue<Deployment> deploymentsQueue;\n \n-    private final AtomicBoolean receivedShutdown = new AtomicBoolean(false);\n-    private final AtomicBoolean postInjectInProgress = new AtomicBoolean(false);\n-\n     private IotJobsClient iotJobsClient;\n-    private MqttClientConnection connection;\n+    private WrapperMqttClientConnection connection;\n+\n+    @Getter\n+    public MqttClientConnectionEvents callbacks = new MqttClientConnectionEvents() {\n+        @Override\n+        public void onConnectionInterrupted(int errorCode) {\n+        }\n+\n+        @Override\n+        @SuppressFBWarnings", "originalCommit": "07b3782f554d5fa9afbba1294a14b23add110f53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNzQ3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453737478", "bodyText": "Can you please move this log line up to the top of this method, so that the first thing it does is log.", "author": "MikeDombo", "createdAt": "2020-07-13T15:32:58Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClient.java", "diffHunk": "@@ -73,6 +76,8 @@ public void onConnectionResumed(boolean sessionPresent) {\n             if (!sessionPresent) {\n                 resubscribe();\n             }\n+            // To run the callbacks shared by the different AwsIotMqttClient.\n+            callbackEventManager.runOnConnectionResumed(sessionPresent);\n             logger.atInfo().kv(\"sessionPresent\", sessionPresent).log(\"Connection resumed\");", "originalCommit": "07b3782f554d5fa9afbba1294a14b23add110f53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NjY1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453796651", "bodyText": "ok.", "author": "awszztt", "createdAt": "2020-07-13T17:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNzQ3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNzY2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453737661", "bodyText": "get rid of this comment.", "author": "MikeDombo", "createdAt": "2020-07-13T15:33:13Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClient.java", "diffHunk": "@@ -131,6 +138,7 @@ private synchronized boolean connect() throws ExecutionException, InterruptedExc\n         // Always use the builder provider here so that the builder is updated with whatever\n         // the latest device config is\n         try (AwsIotMqttConnectionBuilder builder = builderProvider.get()) {\n+            // To remove the customized callbacks that belongs to other AwsIotMqttClient.", "originalCommit": "07b3782f554d5fa9afbba1294a14b23add110f53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAwMTYwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r454001608", "bodyText": "still applies.", "author": "MikeDombo", "createdAt": "2020-07-13T23:21:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNzY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNzg1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453737853", "bodyText": "change to CopyOnWriteSet.", "author": "MikeDombo", "createdAt": "2020-07-13T15:33:30Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/CallbackEventManager.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package com.aws.iot.evergreen.mqtt;\n+\n+import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+public class CallbackEventManager {\n+    private final Set<MqttClientConnectionEvents> oneTimeCallbackEvents = new HashSet<>();", "originalCommit": "07b3782f554d5fa9afbba1294a14b23add110f53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczODg1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453738859", "bodyText": "might want to use Inject here instead of directly creating it so tat we can mock it easier. Up to you.", "author": "MikeDombo", "createdAt": "2020-07-13T15:34:57Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/MqttClient.java", "diffHunk": "@@ -81,6 +83,8 @@\n     private final HostResolver hostResolver;\n     private final ClientBootstrap clientBootstrap;\n \n+    public CallbackEventManager callbackEventManager = new CallbackEventManager();", "originalCommit": "07b3782f554d5fa9afbba1294a14b23add110f53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc4MzQxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453783412", "bodyText": "does this need a getter?", "author": "MikeDombo", "createdAt": "2020-07-13T16:40:51Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClient.java", "diffHunk": "@@ -52,7 +52,9 @@\n     @SuppressFBWarnings(\"IS2_INCONSISTENT_SYNC\")\n     private MqttClientConnection connection;\n     private final AtomicBoolean currentlyConnected = new AtomicBoolean();\n+    private final CallbackEventManager callbackEventManager;\n \n+    @Getter", "originalCommit": "cc4f1d6010a92e05ee55e83e384cc13248be1e16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NzY0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453797641", "bodyText": "Yes.  The callbackconnectionEvents itself is private and could be retrieved from the Test. Thus, I followed the pattern from IotJobsHelper file and add @getter to it.", "author": "awszztt", "createdAt": "2020-07-13T17:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc4MzQxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgwNDE4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453804185", "bodyText": "Use @Getter(AccessLevel.Package) so that it stays somewhat private.", "author": "MikeDombo", "createdAt": "2020-07-13T17:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc4MzQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc4NDE0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453784146", "bodyText": "add the copyright header to your IntelliJ settings.", "author": "MikeDombo", "createdAt": "2020-07-13T16:42:03Z", "path": "src/test/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClientTest.java", "diffHunk": "@@ -1,85 +1,113 @@\n-/*\n- * Copyright Amazon.com Inc. or its affiliates.\n- * SPDX-License-Identifier: Apache-2.0\n- */", "originalCommit": "cc4f1d6010a92e05ee55e83e384cc13248be1e16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc4NDUwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r453784507", "bodyText": "Do not remove these extensions. Without them, the test will not work.", "author": "MikeDombo", "createdAt": "2020-07-13T16:42:39Z", "path": "src/test/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClientTest.java", "diffHunk": "@@ -1,85 +1,113 @@\n-/*\n- * Copyright Amazon.com Inc. or its affiliates.\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n package com.aws.iot.evergreen.mqtt;\n \n import com.aws.iot.evergreen.config.Topics;\n-import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import org.junit.jupiter.api.AfterEach;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.ExtendWith;\n-import org.mockito.ArgumentCaptor;\n-import org.mockito.Captor;\n import org.mockito.Mock;\n-import org.mockito.junit.jupiter.MockitoExtension;\n-import software.amazon.awssdk.crt.mqtt.MqttClientConnection;\n import software.amazon.awssdk.crt.mqtt.MqttClientConnectionEvents;\n-import software.amazon.awssdk.crt.mqtt.QualityOfService;\n+import software.amazon.awssdk.crt.mqtt.MqttMessage;\n import software.amazon.awssdk.iot.AwsIotMqttConnectionBuilder;\n \n-import java.util.concurrent.CompletableFuture;\n-import java.util.concurrent.ExecutionException;\n-import java.util.concurrent.TimeoutException;\n+import javax.inject.Provider;\n+import java.io.IOException;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n \n import static org.junit.jupiter.api.Assertions.assertFalse;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n-import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n import static org.mockito.Mockito.times;\n import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n \n-@SuppressWarnings(\"PMD.CloseResource\")\n-@ExtendWith({EGExtension.class, MockitoExtension.class})", "originalCommit": "cc4f1d6010a92e05ee55e83e384cc13248be1e16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAwMTU0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r454001548", "bodyText": "can you move this even before the resubscribe?", "author": "MikeDombo", "createdAt": "2020-07-13T23:21:06Z", "path": "src/main/java/com/aws/iot/evergreen/mqtt/AwsIotMqttClient.java", "diffHunk": "@@ -74,6 +78,8 @@ public void onConnectionResumed(boolean sessionPresent) {\n                 resubscribe();\n             }\n             logger.atInfo().kv(\"sessionPresent\", sessionPresent).log(\"Connection resumed\");", "originalCommit": "d9c35137f49402aa6702d11e36378ee798a64df6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyODAxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r454528011", "bodyText": "what is this file doing here? I think you did a bad merge.", "author": "MikeDombo", "createdAt": "2020-07-14T17:37:35Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.", "originalCommit": "6fdeb451d0c5a9649a688c25a51b3dfc9c6f14f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc0a231b4e26185716cd190d3f055b8edfe637f9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cc0a231b4e26185716cd190d3f055b8edfe637f9", "message": "mqtt replacement", "committedDate": "2020-07-14T21:49:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2ODEwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/290#discussion_r454668106", "bodyText": "this comment doesn't seem very necessary.", "author": "MikeDombo", "createdAt": "2020-07-14T21:54:31Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/IotJobsHelper.java", "diffHunk": "@@ -237,107 +226,41 @@ public void onConnectionResumed(boolean sessionPresent) {\n      *\n      */\n     IotJobsHelper(DeviceConfiguration deviceConfiguration,\n-                  AWSIotMqttConnectionFactory awsIotMqttConnectionFactory,\n                   IotJobsClientFactory iotJobsClientFactory,\n                   LinkedBlockingQueue<Deployment> deploymentsQueue,\n                   DeploymentStatusKeeper deploymentStatusKeeper,\n                   ExecutorService executorService,\n-                  Kernel kernel) {\n+                  Kernel kernel,\n+                  WrapperMqttConnectionFactory wrapperMqttConnectionFactory,\n+                  MqttClient mqttClient) {\n         this.deviceConfiguration = deviceConfiguration;\n-        this.awsIotMqttConnectionFactory = awsIotMqttConnectionFactory;\n         this.iotJobsClientFactory = iotJobsClientFactory;\n         this.deploymentsQueue = deploymentsQueue;\n         this.deploymentStatusKeeper = deploymentStatusKeeper;\n         this.executorService = executorService;\n         this.kernel = kernel;\n+        this.wrapperMqttConnectionFactory = wrapperMqttConnectionFactory;\n+        this.mqttClient = mqttClient;\n     }\n \n     @Override\n     @SuppressFBWarnings\n     public void postInject() {\n-\n-        //TODO: once connectToAWSIot and closeConnection is removed from post inject\n-        // this check should be removed\n-        if (postInjectInProgress.get()) {\n-            return;\n-        }\n-        postInjectInProgress.set(true);\n-\n-        //TODO: remove establishing mqtt connection logic when when MQTT proxy is implemented.\n-        executorService.submit(() -> {\n-            try {\n-                connectToAWSIot();\n-            } catch (InterruptedException e) {\n-               //TODO: re-evaluate the retry strategy,\n-               // re-connection attempts are made only for ConnectionUnavailableException\n-               logger.error(\"Failed to connect to IoT cloud\");\n-            }\n-        });\n-\n-        //TODO: remove closing mqtt connection logic from iot jobs handler when MQTT proxy is implemented.\n-        Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n-            try {\n-                closeConnection();\n-            } catch (ExecutionException | InterruptedException e) {\n-                logger.atError().log(\"Error while closing IoT client\", e);\n-            }\n-        }));\n-\n+        // Mqtt Client would automatically connect to AWS Iot", "originalCommit": "cc0a231b4e26185716cd190d3f055b8edfe637f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6d9bdae55b8c5be7f96a140d15229bd43236eed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a6d9bdae55b8c5be7f96a140d15229bd43236eed", "message": "mqtt replacement", "committedDate": "2020-07-15T22:07:12Z", "type": "commit"}, {"oid": "b5783e857b3e28082f0dc002e0c406b8f2251bc3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5783e857b3e28082f0dc002e0c406b8f2251bc3", "message": "Convert MqttClient to use futures instead of being sync", "committedDate": "2020-07-15T22:07:13Z", "type": "commit"}, {"oid": "7aba08c3a292a99e1f213b5d59d13fab9c7dcb29", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7aba08c3a292a99e1f213b5d59d13fab9c7dcb29", "message": "Only publish with completable future", "committedDate": "2020-07-15T22:07:13Z", "type": "commit"}, {"oid": "146acbae851a412c406d6cfc1e594a56d6b19131", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/146acbae851a412c406d6cfc1e594a56d6b19131", "message": "Comment out broken tests", "committedDate": "2020-07-15T22:07:13Z", "type": "forcePushed"}, {"oid": "b7dbd656a338ccd4eb01977cc9423eb8679fc7e9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b7dbd656a338ccd4eb01977cc9423eb8679fc7e9", "message": "Comment out broken tests", "committedDate": "2020-07-15T22:10:15Z", "type": "forcePushed"}, {"oid": "139c1e5a5f6f5e38ed808fcada96e82458e36173", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/139c1e5a5f6f5e38ed808fcada96e82458e36173", "message": "Comment out broken tests", "committedDate": "2020-07-15T22:20:38Z", "type": "commit"}, {"oid": "139c1e5a5f6f5e38ed808fcada96e82458e36173", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/139c1e5a5f6f5e38ed808fcada96e82458e36173", "message": "Comment out broken tests", "committedDate": "2020-07-15T22:20:38Z", "type": "forcePushed"}, {"oid": "19fcaaf93811c300b743f1ce1a8068c016ccf0ef", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19fcaaf93811c300b743f1ce1a8068c016ccf0ef", "message": "Temp: remove GIVEN_iot_role_alias_WHEN_tes_is_queried_THEN_valid_credentials_are_returned for testing", "committedDate": "2020-07-16T01:26:10Z", "type": "commit"}, {"oid": "69be11a5eb71982b7d9a666bbb6d3b918c6d0cdb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/69be11a5eb71982b7d9a666bbb6d3b918c6d0cdb", "message": "Revert \"Temp: remove GIVEN_iot_role_alias_WHEN_tes_is_queried_THEN_valid_credentials_are_returned for testing\"\n\nThis reverts commit 19fcaaf93811c300b743f1ce1a8068c016ccf0ef.", "committedDate": "2020-07-16T03:23:54Z", "type": "commit"}, {"oid": "73c925fb5d1ac8184a3b085249b571a1f5e396d6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73c925fb5d1ac8184a3b085249b571a1f5e396d6", "message": "Remove unnecessary variable and comments", "committedDate": "2020-07-16T03:53:24Z", "type": "commit"}, {"oid": "16009678debb2c05518529d873503737b759f591", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/16009678debb2c05518529d873503737b759f591", "message": "Merge branch 'master' into add_new_mqqt_client", "committedDate": "2020-07-16T06:19:47Z", "type": "commit"}, {"oid": "89506d3b5b5545891e68fdf7fff0b306cefa9774", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/89506d3b5b5545891e68fdf7fff0b306cefa9774", "message": "Merge branch 'master' into add_new_mqqt_client", "committedDate": "2020-07-21T02:45:41Z", "type": "commit"}]}