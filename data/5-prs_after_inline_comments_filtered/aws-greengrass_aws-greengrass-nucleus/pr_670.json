{"pr_number": 670, "pr_title": "React to nucleus config changes", "pr_createdAt": "2020-11-12T17:45:55Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670", "timeline": [{"oid": "3db931dfcc8d70a53a7cbdfa58577b3960cdaab8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3db931dfcc8d70a53a7cbdfa58577b3960cdaab8", "message": "React to nucleus config changes", "committedDate": "2020-11-12T18:17:25Z", "type": "commit"}, {"oid": "3db931dfcc8d70a53a7cbdfa58577b3960cdaab8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3db931dfcc8d70a53a7cbdfa58577b3960cdaab8", "message": "React to nucleus config changes", "committedDate": "2020-11-12T18:17:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMjIwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522332209", "bodyText": "let's get rid of this context crap. We can just use the device configuration or any of the many other methods to get the URL", "author": "MikeDombo", "createdAt": "2020-11-12T18:41:39Z", "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -24,54 +26,75 @@\n import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n \n import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.security.KeyStore;\n import java.security.PrivateKey;\n import java.security.cert.Certificate;\n import java.security.cert.X509Certificate;\n import java.util.List;\n import javax.inject.Inject;\n-import javax.inject.Named;\n import javax.net.ssl.KeyManager;\n import javax.net.ssl.KeyManagerFactory;\n import javax.net.ssl.SSLContext;\n import javax.net.ssl.TrustManager;\n import javax.net.ssl.TrustManagerFactory;\n import javax.security.auth.x500.X500Principal;\n \n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_AWS_REGION;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_ROOT_CA_PATH;\n+\n @Getter\n @SuppressWarnings(\"PMD.ConfusingTernary\")\n public class GreengrassComponentServiceClientFactory {\n \n     public static final String CONTEXT_COMPONENT_SERVICE_ENDPOINT = \"greengrassServiceEndpoint\";\n     private static final Logger logger = LogManager.getLogger(GreengrassComponentServiceClientFactory.class);\n \n-    private final AWSEvergreen cmsClient;\n+    private AWSEvergreen cmsClient;\n \n     /**\n      * Constructor with custom endpoint/region configuration.\n      *\n-     * @param greengrassServiceEndpoint String containing service endpoint\n+     * @param context Context object\n      * @param deviceConfiguration       Device configuration\n      */\n     @Inject\n-    public GreengrassComponentServiceClientFactory(\n-            @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration) {\n+    public GreengrassComponentServiceClientFactory(Context context, DeviceConfiguration deviceConfiguration) {\n+        configureClient((String) context.getvIfExists(CONTEXT_COMPONENT_SERVICE_ENDPOINT).get(), deviceConfiguration);", "originalCommit": "75ef437de2efa68c25c4d94f8fa3177936842a98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMzI5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522333296", "bodyText": "let's get rid of this.", "author": "MikeDombo", "createdAt": "2020-11-12T18:43:32Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java", "diffHunk": "@@ -554,10 +555,14 @@ private void setupCloudEndpoint() {\n             throw new RuntimeException(e);\n         }\n \n-        String region = Coerce.toString(deviceConfiguration.getAWSRegion());\n-        String endpoint = RegionUtils.getGreengrassDataPlaneEndpoint(region, stage);\n-        logger.atInfo().log(\"Configured to use Greengrass endpoint: {}\", endpoint);\n-        context.put(CONTEXT_COMPONENT_SERVICE_ENDPOINT, endpoint);\n+        deviceConfiguration.getAWSRegion().subscribe((what, node) -> {\n+            String region = Coerce.toString(node);\n+            if (Utils.isNotEmpty(region)) {\n+                String endpoint = RegionUtils.getGreengrassDataPlaneEndpoint(region, stage);\n+                logger.atInfo().log(\"Configured to use Greengrass endpoint: {}\", endpoint);\n+                context.put(CONTEXT_COMPONENT_SERVICE_ENDPOINT, endpoint);", "originalCommit": "75ef437de2efa68c25c4d94f8fa3177936842a98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9cde0c2c9bbc897a6a18aa3247c8a863ee15c46", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e9cde0c2c9bbc897a6a18aa3247c8a863ee15c46", "message": "Address comments", "committedDate": "2020-11-12T21:05:17Z", "type": "commit"}, {"oid": "e9cde0c2c9bbc897a6a18aa3247c8a863ee15c46", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e9cde0c2c9bbc897a6a18aa3247c8a863ee15c46", "message": "Address comments", "committedDate": "2020-11-12T21:05:17Z", "type": "forcePushed"}, {"oid": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5d2c5346522d345e4c6a0339285fd24cbd5dfeee", "message": "Merge branch 'master' into system-config", "committedDate": "2020-11-12T21:05:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ1NzgyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522457825", "bodyText": "Why || of validString? Is this trying to check if any of these settings changed and then validate those?", "author": "hui-yang", "createdAt": "2020-11-12T22:10:24Z", "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -11,70 +11,93 @@\n import com.amazonaws.client.builder.AwsClientBuilder.EndpointConfiguration;\n import com.amazonaws.services.evergreen.AWSEvergreen;\n import com.amazonaws.services.evergreen.AWSEvergreenClientBuilder;\n+import com.aws.greengrass.config.Node;\n import com.aws.greengrass.deployment.DeviceConfiguration;\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n import com.aws.greengrass.util.Coerce;\n import com.aws.greengrass.util.EncryptionUtils;\n+import com.aws.greengrass.util.IotSdkClientFactory;\n import com.aws.greengrass.util.ProxyUtils;\n+import com.aws.greengrass.util.RegionUtils;\n import com.aws.greengrass.util.Utils;\n+import com.aws.greengrass.util.exceptions.InvalidEnvironmentStageException;\n import com.aws.greengrass.util.exceptions.TLSAuthException;\n import lombok.Getter;\n import org.apache.http.conn.ssl.NoopHostnameVerifier;\n import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n \n import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.security.KeyStore;\n import java.security.PrivateKey;\n import java.security.cert.Certificate;\n import java.security.cert.X509Certificate;\n import java.util.List;\n import javax.inject.Inject;\n-import javax.inject.Named;\n import javax.net.ssl.KeyManager;\n import javax.net.ssl.KeyManagerFactory;\n import javax.net.ssl.SSLContext;\n import javax.net.ssl.TrustManager;\n import javax.net.ssl.TrustManagerFactory;\n import javax.security.auth.x500.X500Principal;\n \n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_AWS_REGION;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_ROOT_CA_PATH;\n+\n @Getter\n @SuppressWarnings(\"PMD.ConfusingTernary\")\n public class GreengrassComponentServiceClientFactory {\n \n-    public static final String CONTEXT_COMPONENT_SERVICE_ENDPOINT = \"greengrassServiceEndpoint\";\n     private static final Logger logger = LogManager.getLogger(GreengrassComponentServiceClientFactory.class);\n \n-    private final AWSEvergreen cmsClient;\n+    private AWSEvergreen cmsClient;\n \n     /**\n      * Constructor with custom endpoint/region configuration.\n      *\n-     * @param greengrassServiceEndpoint String containing service endpoint\n      * @param deviceConfiguration       Device configuration\n      */\n     @Inject\n-    public GreengrassComponentServiceClientFactory(\n-            @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration) {\n+    public GreengrassComponentServiceClientFactory(DeviceConfiguration deviceConfiguration) {\n+        configureClient(deviceConfiguration);\n+        deviceConfiguration.onAnyChange((what, node) -> {\n+            if (validString(node, DEVICE_PARAM_AWS_REGION) || validPath(node, DEVICE_PARAM_ROOT_CA_PATH) || validPath(", "originalCommit": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MDc5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522470791", "bodyText": "Sort of, our integ tests sometimes set these to empty strings or strings which are invalid paths and this subscriber gets invoked, this is not intended to be full fledged validation though because I think that will require much more effort", "author": "shaguptashaikh", "createdAt": "2020-11-12T22:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ1NzgyNQ=="}], "type": "inlineReview"}, {"oid": "22ac43cd9a990f69b3ccd9303e4b1550d042325f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/22ac43cd9a990f69b3ccd9303e4b1550d042325f", "message": "Merge branch 'master' into system-config", "committedDate": "2020-11-13T09:23:04Z", "type": "commit"}, {"oid": "d48fe66e3d6302e18f03a2f1929add36aba37ce1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d48fe66e3d6302e18f03a2f1929add36aba37ce1", "message": "Merge branch 'master' into system-config", "committedDate": "2020-11-13T20:55:29Z", "type": "commit"}]}