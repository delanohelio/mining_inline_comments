{"pr_number": 342, "pr_title": "Ku04 - Kernel can restart from the existing root directory and pick up previous configurations", "pr_createdAt": "2020-07-31T15:14:18Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342", "timeline": [{"oid": "c9075638843003489aeb991263202ac941feb7a3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c9075638843003489aeb991263202ac941feb7a3", "message": "Fix reading tlog for kernel restarting and add integ tests", "committedDate": "2020-07-31T06:26:54Z", "type": "commit"}, {"oid": "38eb711d9da22ab0f931e8c59d66015f4e593cb4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/38eb711d9da22ab0f931e8c59d66015f4e593cb4", "message": "comment update", "committedDate": "2020-07-31T06:32:07Z", "type": "commit"}, {"oid": "76f146fb629198bfb413296ded10ae6beb9bf29b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/76f146fb629198bfb413296ded10ae6beb9bf29b", "message": "add readme", "committedDate": "2020-07-31T07:22:18Z", "type": "commit"}, {"oid": "5fc86021a6e4f9f06f9b437cb527ada4d9aed167", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5fc86021a6e4f9f06f9b437cb527ada4d9aed167", "message": "Merge remote-tracking branch 'origin/master' into ku04", "committedDate": "2020-07-31T07:22:49Z", "type": "commit"}, {"oid": "76a8e9350e2f007a8b092a283cbfbab5abcd793d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/76a8e9350e2f007a8b092a283cbfbab5abcd793d", "message": "done", "committedDate": "2020-07-31T15:09:29Z", "type": "commit"}, {"oid": "fd8c1837ffef058df0a78cf3b03e4a5c03a4141b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd8c1837ffef058df0a78cf3b03e4a5c03a4141b", "message": "done", "committedDate": "2020-07-31T15:11:23Z", "type": "commit"}, {"oid": "0bfaf70f3c9da3e7b6a6fd97ca5bd2c3d992f960", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0bfaf70f3c9da3e7b6a6fd97ca5bd2c3d992f960", "message": "license", "committedDate": "2020-07-31T15:16:25Z", "type": "commit"}, {"oid": "96d05d6f0064dfe92b1507e4939d28cc0dd0ad7a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/96d05d6f0064dfe92b1507e4939d28cc0dd0ad7a", "message": "typo", "committedDate": "2020-07-31T15:17:42Z", "type": "commit"}, {"oid": "3447c9708afd75502d3ee4b939337f22f9173c5c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3447c9708afd75502d3ee4b939337f22f9173c5c", "message": "kerneltest", "committedDate": "2020-07-31T15:18:14Z", "type": "commit"}, {"oid": "627ef628ee5e2000392be1088e705fe931049c0b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/627ef628ee5e2000392be1088e705fe931049c0b", "message": "kerneltest", "committedDate": "2020-07-31T15:18:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NjI3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463676272", "bodyText": "Should we actually flip these, since that's the behavior when it is running; it reads the config then writes changes to tlog?", "author": "MikeDombo", "createdAt": "2020-07-31T15:24:22Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java", "diffHunk": "@@ -114,6 +91,42 @@ public void launch() {\n         startupAllServices();\n     }\n \n+    private void initConfigAndTlog() {\n+        Path transactionLogPath = kernel.getConfigPath().resolve(\"config.tlog\");\n+        Path configurationFile = kernel.getConfigPath().resolve(\"config.yaml\");\n+\n+\n+        try {\n+            if (Objects.nonNull(kernelCommandLine.getProvidedConfigPathName())) {\n+                // If a config file is provided, kernel will use the provided file as a new base\n+                // and ignore existing config and tlog files.\n+                // This ideally should only used for testing and not in production\n+                kernel.getConfig().read(kernelCommandLine.getProvidedConfigPathName());\n+            } else {\n+                // if tlog presents, read the tlog first, because the yaml config file may not be up to date\n+                if (Files.exists(transactionLogPath)) {\n+                    kernel.getConfig().read(transactionLogPath);\n+                }\n+\n+                // if configuration file is available, merge it. It will be merged with file's last modified timestamp\n+                if (Files.exists(configurationFile)) {\n+                    kernel.getConfig().read(configurationFile);\n+                }", "originalCommit": "627ef628ee5e2000392be1088e705fe931049c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4NTkyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463885929", "bodyText": "I thought about that as well. But I now think the order here doesn't really matter since we do timestamp merge... The result is going to be the same no matter which one we merge first, right? Maybe I should just update the comment.", "author": "leaf94", "createdAt": "2020-07-31T23:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NjI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NzcxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463677712", "bodyText": "get rid of effectiveConfig.evg? Since you're writing it into the main config file?", "author": "MikeDombo", "createdAt": "2020-07-31T15:26:51Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java", "diffHunk": "@@ -114,6 +91,42 @@ public void launch() {\n         startupAllServices();\n     }\n \n+    private void initConfigAndTlog() {\n+        Path transactionLogPath = kernel.getConfigPath().resolve(\"config.tlog\");\n+        Path configurationFile = kernel.getConfigPath().resolve(\"config.yaml\");\n+\n+\n+        try {\n+            if (Objects.nonNull(kernelCommandLine.getProvidedConfigPathName())) {\n+                // If a config file is provided, kernel will use the provided file as a new base\n+                // and ignore existing config and tlog files.\n+                // This ideally should only used for testing and not in production\n+                kernel.getConfig().read(kernelCommandLine.getProvidedConfigPathName());\n+            } else {\n+                // if tlog presents, read the tlog first, because the yaml config file may not be up to date\n+                if (Files.exists(transactionLogPath)) {\n+                    kernel.getConfig().read(transactionLogPath);\n+                }\n+\n+                // if configuration file is available, merge it. It will be merged with file's last modified timestamp\n+                if (Files.exists(configurationFile)) {\n+                    kernel.getConfig().read(configurationFile);\n+                }\n+            }\n+\n+            // write new tlog and config files\n+            kernel.writeEffectiveConfigAsTransactionLog(transactionLogPath);\n+            kernel.writeEffectiveConfig(configurationFile);", "originalCommit": "627ef628ee5e2000392be1088e705fe931049c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4NjIyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463886221", "bodyText": "Yeah... The effectiveConfig.evg is not really helpful now. Also I want to ask when should we update the main config file? Initially I thought we should always update the config file when in-memory config changes, just like Tlog.", "author": "leaf94", "createdAt": "2020-07-31T23:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NzcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4NjUxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463886511", "bodyText": "Definitely not all the time. Leave that for later.", "author": "MikeDombo", "createdAt": "2020-07-31T23:32:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NzcxMg=="}], "type": "inlineReview"}, {"oid": "acb4859272382824f4bd277bc4fb344a185d2511", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/acb4859272382824f4bd277bc4fb344a185d2511", "message": "fix tests", "committedDate": "2020-07-31T18:35:25Z", "type": "commit"}, {"oid": "689f4bb5f396572b10b9925dac2e5a1f1da6d902", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/689f4bb5f396572b10b9925dac2e5a1f1da6d902", "message": "change freq back to 15 sec", "committedDate": "2020-07-31T18:35:50Z", "type": "commit"}, {"oid": "c51f7672244d3ffab53b85898e7e632d3be77564", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c51f7672244d3ffab53b85898e7e632d3be77564", "message": "update test", "committedDate": "2020-07-31T18:58:14Z", "type": "commit"}, {"oid": "044dc0067c492d9c2a6a5047d894dc0798b18588", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/044dc0067c492d9c2a6a5047d894dc0798b18588", "message": "Fix E2E", "committedDate": "2020-07-31T20:10:08Z", "type": "commit"}, {"oid": "046ce5e5d0dee101c607970ef4885daadc047950", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/046ce5e5d0dee101c607970ef4885daadc047950", "message": "Merge branch 'master' into ku04", "committedDate": "2020-07-31T23:39:29Z", "type": "commit"}, {"oid": "c91040d41a470d0dbb626cc030b14abb24139054", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c91040d41a470d0dbb626cc030b14abb24139054", "message": "PR comments", "committedDate": "2020-07-31T23:44:52Z", "type": "commit"}, {"oid": "aca28159014ab1cd512cc566766e274158db30a0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aca28159014ab1cd512cc566766e274158db30a0", "message": "Merge branch 'master' into ku04", "committedDate": "2020-08-03T16:49:26Z", "type": "commit"}, {"oid": "31c906b1124334135b7a126b26bcb3403a537a6a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/31c906b1124334135b7a126b26bcb3403a537a6a", "message": "Merge branch 'master' into ku04", "committedDate": "2020-08-03T20:29:30Z", "type": "commit"}]}