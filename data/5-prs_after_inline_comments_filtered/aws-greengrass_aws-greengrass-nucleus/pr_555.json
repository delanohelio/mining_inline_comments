{"pr_number": 555, "pr_title": "Set the owner of artifacts for a service when commands are first run.", "pr_createdAt": "2020-10-21T21:29:46Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyMDQ3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509720474", "bodyText": "not really needed.\nBut definitely do call kernel.shutdown()", "author": "MikeDombo", "createdAt": "2020-10-21T21:37:04Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/GenericExternalServiceTest.java", "diffHunk": "@@ -52,6 +58,27 @@\n     @BeforeEach\n     void beforeEach() {\n         kernel = new Kernel();\n+        kernel.getContext().put(RunWithArtifactHandler.class, new NoOpArtifactHandler(kernel.getNucleusPaths()));\n+    }\n+\n+    @AfterEach\n+    void cleanup() {\n+        kernel.getContext().remove(RunWithArtifactHandler.class);", "originalCommit": "f506647854995fb10f5880fb5ad23f005ae813a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0NDI0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509744249", "bodyText": "There's stuff (artifacts and recipes) that seem to stay between tests so I wanted to explicitly clean up", "author": "rbattle", "createdAt": "2020-10-21T22:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyMDQ3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0NTA2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509745062", "bodyText": "How does calling \"remove\" do anything? It doesn't do anything.", "author": "MikeDombo", "createdAt": "2020-10-21T22:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyMDQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyMzIzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509723235", "bodyText": "formatting", "author": "MikeDombo", "createdAt": "2020-10-21T21:41:05Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java", "diffHunk": "@@ -350,23 +371,52 @@ public void handleError() throws InterruptedException {\n      * Store user, group, and shell that will be used to run the service. This should be used throughout the lifecycle.\n      * This information can change with a deployment, but service *must* execute the lifecycle steps with the same\n      * user/group/shell that was configured when it started.\n+     */\n+    protected boolean storeInitialRunWithConfiguration() {\n+        Optional<RunWith> opt = runWithGenerator.generate(config);\n+        if (opt.isPresent()) {\n+            runWith = opt.get();\n+\n+            LogEventBuilder logEvent  = logger.atDebug().kv(\"user\", runWith.getUser());", "originalCommit": "f506647854995fb10f5880fb5ad23f005ae813a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0NTA1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509745054", "bodyText": "not sure how that got through the checkstyle", "author": "rbattle", "createdAt": "2020-10-21T22:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyMzIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNDI2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509724264", "bodyText": "Why only Unix?", "author": "MikeDombo", "createdAt": "2020-10-21T21:42:18Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/RunWithArtifactHandler.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.lifecyclemanager;\n+\n+import com.aws.greengrass.componentmanager.models.ComponentIdentifier;\n+import com.aws.greengrass.util.CrashableFunction;\n+import com.aws.greengrass.util.Exec;\n+import com.aws.greengrass.util.FileSystemPermission;\n+import com.aws.greengrass.util.NucleusPaths;\n+import com.aws.greengrass.util.platforms.Platform;\n+import com.aws.greengrass.util.platforms.UnixPlatform;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import javax.inject.Inject;\n+\n+/**\n+ * Update artifact ownership based on service RunWith information.\n+ */\n+public class RunWithArtifactHandler {\n+\n+    final NucleusPaths nucleusPaths;\n+\n+    final UnixPlatform unixPlatform;", "originalCommit": "f506647854995fb10f5880fb5ad23f005ae813a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNDY5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509724697", "bodyText": "Even if we only support Unix, shouldn't this class take a Platform as the field?", "author": "MikeDombo", "createdAt": "2020-10-21T21:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyOTYwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509729608", "bodyText": "My preference would be to call into the Platform instance for any platform specific stuff. Everything which isn't inside of Platform shouldn't care (ideally).", "author": "MikeDombo", "createdAt": "2020-10-21T21:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0MDIzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509740233", "bodyText": "The windows stuff is going to be different, and I wanted to be able to mock so I didn't want to use Platform.getInstance()\nI'll see if I can abstract this away nicely", "author": "rbattle", "createdAt": "2020-10-21T22:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNDI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNjY3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509726674", "bodyText": "can we hoist this to the Platform class? That way we can implement it on windows eventually.", "author": "MikeDombo", "createdAt": "2020-10-21T21:45:09Z", "path": "src/main/java/com/aws/greengrass/util/platforms/UnixPlatform.java", "diffHunk": "@@ -184,8 +271,108 @@ public UserDecorator withGroup(String group) {\n     public void setPermissions(FileSystemPermission permission, Path path) throws IOException {\n         Files.setPosixFilePermissions(path, permission.toPosixFilePermissions());\n         if (permission.getOwnerUser() != null) {\n-            Files.setOwner(path, path.getFileSystem().getUserPrincipalLookupService()\n-                    .lookupPrincipalByName(permission.getOwnerUser()));\n+            setPathOwner(permission, path, false);\n+        }\n+    }\n+\n+\n+    @Override\n+    public Optional<String> lookupPrimaryGroup(String user) {\n+        // run `id` command to load group (-g) name (n)\n+        StringBuilder out = new StringBuilder();\n+        StringBuilder err = new StringBuilder();\n+        try (Exec exec = new Exec()) {\n+            exec.withExec(\"id\", \"-gn\", user)\n+                .withOut(out::append)\n+                .withErr(err::append)\n+                .exec();\n+        } catch (IOException | InterruptedException e) {\n+            logger.atError().setCause(e).setEventType(\"lookup-primary-group\")\n+                    .log(\"Error while looking up primary group for %s\", user);\n+            return Optional.empty();\n+        }\n+\n+        if (!err.toString().isEmpty()) {\n+            logger.atWarn().setEventType(\"lookup-primary-group\")\n+                    .log(\"Error while lookup up primary group for %s: '%s'\",\n+                    user, err.toString());\n+            return Optional.empty();\n+        }\n+\n+        String group = out.toString().trim();\n+        if (group.isEmpty()) {\n+            logger.atWarn().setEventType(\"lookup-primary-group\")\n+                    .log(\"Empty primary group returned for %s\", user);\n+            return Optional.empty();\n+        }\n+        return Optional.of(group);\n+    }\n+\n+    /**\n+     * Set the owner of a path.\n+     *\n+     * @param permission a permission object containing owner user/group\n+     * @param path the path to change.\n+     * @param recurse whether to recursively set owner for directory paths.\n+     * @throws IOException if an error occurs while updating the ownership.\n+     */\n+    public void setPathOwner(FileSystemPermission permission, Path path, boolean recurse) throws IOException {", "originalCommit": "f506647854995fb10f5880fb5ad23f005ae813a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTczOTk5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509739995", "bodyText": "yeah - I can have a noop implementation in Windows", "author": "rbattle", "createdAt": "2020-10-21T22:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNjY3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyNzM3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509727378", "bodyText": "hoist to Platform and call is isSuperUser or something like that. On windows we'd need to be Administrator.", "author": "MikeDombo", "createdAt": "2020-10-21T21:45:57Z", "path": "src/main/java/com/aws/greengrass/util/platforms/UnixPlatform.java", "diffHunk": "@@ -16,25 +18,106 @@\n import java.io.IOException;\n import java.io.InputStreamReader;\n import java.nio.charset.StandardCharsets;\n+import java.nio.file.FileVisitResult;\n+import java.nio.file.FileVisitor;\n import java.nio.file.Files;\n+import java.nio.file.LinkOption;\n import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.GroupPrincipal;\n+import java.nio.file.attribute.PosixFileAttributeView;\n+import java.nio.file.attribute.UserPrincipal;\n+import java.nio.file.attribute.UserPrincipalLookupService;\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n+import java.util.Optional;\n import java.util.concurrent.TimeUnit;\n+import java.util.function.Function;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n import static com.aws.greengrass.util.Utils.inputStreamToString;\n \n-public class UnixPlatform extends Platform {\n+public class UnixPlatform extends Platform implements PosixUserPlatform {\n     protected static final int SIGINT = 2;\n     protected static final int SIGKILL = 9;\n     public static final Pattern PS_PID_PATTERN = Pattern.compile(\"(\\\\d+)\\\\s+(\\\\d+)\");\n \n+    public static final String PRIVILEGED_USER = \"root\";\n+    public static final String STDOUT = \"stdout\";\n+    public static final String STDERR = \"stderr\";\n+    private static Boolean IS_ROOT;\n+\n+    /**\n+     * Check whether the current user is root or not.\n+     *\n+     * @return true if root.\n+     */\n+    private synchronized boolean checkIsRoot() {", "originalCommit": "f506647854995fb10f5880fb5ad23f005ae813a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyODI1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509728259", "bodyText": "We already log the command in shellrunner, so if this duplicates that, then I'd remove one of them.", "author": "MikeDombo", "createdAt": "2020-10-21T21:47:01Z", "path": "src/main/java/com/aws/greengrass/util/Exec.java", "diffHunk": "@@ -398,14 +400,23 @@ public Exec withErr(Consumer<CharSequence> o) {\n         return decorated;\n     }\n \n+    /**\n+     * Execute a command.\n+     *\n+     * @returns the process exit code.\n+     * @throws InterruptedException if the command is interrupted while running.\n+     * @throws IOException if an error occurs while executing.\n+     */\n     @SuppressWarnings(\"PMD.AvoidRethrowingException\")\n-    private void exec() throws InterruptedException, IOException {\n+    public Optional<Integer> exec() throws InterruptedException, IOException {\n         // Don't run anything if the current thread is currently interrupted\n         if (Thread.currentThread().isInterrupted()) {\n             logger.atWarn().kv(\"command\", this).log(\"Refusing to execute because the active thread is interrupted\");\n             throw new InterruptedException();\n         }\n-        process = Runtime.getRuntime().exec(getCommand(), environment, dir);\n+        final String[] command = getCommand();\n+        logger.atDebug().kv(\"command\", (Supplier<String>) () -> String.join(\" \", command)).log();", "originalCommit": "f506647854995fb10f5880fb5ad23f005ae813a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0MDUxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509740519", "bodyText": "ok - I'll remove the shellrunner one then because we exec in many other places", "author": "rbattle", "createdAt": "2020-10-21T22:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyODI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyNDA0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r510324040", "bodyText": "I've actually kept both and moved this one to trace - There are many places where exec is being called outside of the ShellRunner for services.\nThe ShellRunner logs the command the service wants to run behalf of the service.\nThe exec logs the full decorated command.", "author": "rbattle", "createdAt": "2020-10-22T17:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyODI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyOTE0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509729146", "bodyText": "any possibility to make this more generic than posix?", "author": "MikeDombo", "createdAt": "2020-10-21T21:48:27Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/RunWithGenerator.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.lifecyclemanager;\n+\n+import com.aws.greengrass.config.Topics;\n+import com.aws.greengrass.deployment.DeviceConfiguration;\n+import com.aws.greengrass.util.Coerce;\n+import com.aws.greengrass.util.Exec;\n+import com.aws.greengrass.util.Utils;\n+import com.aws.greengrass.util.platforms.Platform;\n+import com.aws.greengrass.util.platforms.PosixUserPlatform;\n+\n+import java.util.Optional;\n+import javax.inject.Inject;\n+\n+import static com.aws.greengrass.lifecyclemanager.GreengrassService.POSIX_GROUP_KEY;\n+import static com.aws.greengrass.lifecyclemanager.GreengrassService.POSIX_USER_KEY;\n+import static com.aws.greengrass.lifecyclemanager.GreengrassService.RUN_WITH_NAMESPACE_TOPIC;\n+\n+/**\n+ * Generate a {@link RunWith} from a service {@link Topics} configuration. This takes into account the configuration\n+ * from the service and the default configuration in the kernel.\n+ */\n+public class RunWithGenerator {\n+\n+    final DeviceConfiguration deviceConfig;\n+\n+    final PosixUserPlatform posixUserPlatform;", "originalCommit": "f506647854995fb10f5880fb5ad23f005ae813a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0MzUxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r509743518", "bodyText": "potentially:\nFor windows,\n\nusername -> user prinicipal name\nuid -> guid\n\nI'm not so sure about the primary group though", "author": "rbattle", "createdAt": "2020-10-21T22:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyOTE0Ng=="}], "type": "inlineReview"}, {"oid": "14cdb22d603d6317e0e7a7c49c3b6993468cf179", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/14cdb22d603d6317e0e7a7c49c3b6993468cf179", "message": "Set the owner of artifacts for a service when commands are first run.\n\nRefactored generation of the user/group to run a service with.\n\nArtifacts are set to the user/group running the service.\nThe run as user is set for a component in the deployment. If none is\nprovided, the default user/group is used. If no default is set, and\nthe kernel user is not root, the kernel user is used.\n\nArtifacts that are not \"run\" are left unchanged - they are owned by\nthe kernel user.", "committedDate": "2020-10-22T16:59:18Z", "type": "forcePushed"}, {"oid": "8b0c7c0d79c84a3ce99a10dac9d20bfa4414de2a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b0c7c0d79c84a3ce99a10dac9d20bfa4414de2a", "message": "Set the owner of artifacts for a service when commands are first run.\n\nRefactored generation of the user/group to run a service with.\n\nArtifacts are set to the user/group running the service.\nThe run as user is set for a component in the deployment. If none is\nprovided, the default user/group is used. If no default is set, and\nthe kernel user is not root, the kernel user is used.\n\nArtifacts that are not \"run\" are left unchanged - they are owned by\nthe kernel user.", "committedDate": "2020-10-22T17:07:26Z", "type": "commit"}, {"oid": "8b0c7c0d79c84a3ce99a10dac9d20bfa4414de2a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b0c7c0d79c84a3ce99a10dac9d20bfa4414de2a", "message": "Set the owner of artifacts for a service when commands are first run.\n\nRefactored generation of the user/group to run a service with.\n\nArtifacts are set to the user/group running the service.\nThe run as user is set for a component in the deployment. If none is\nprovided, the default user/group is used. If no default is set, and\nthe kernel user is not root, the kernel user is used.\n\nArtifacts that are not \"run\" are left unchanged - they are owned by\nthe kernel user.", "committedDate": "2020-10-22T17:07:26Z", "type": "forcePushed"}, {"oid": "eba68eb4bf97821d773ea456676bd7c3ac9d18ad", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eba68eb4bf97821d773ea456676bd7c3ac9d18ad", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-22T17:14:37Z", "type": "commit"}, {"oid": "43cd2943521e8371f61a9a9bc35758f955ca85c7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/43cd2943521e8371f61a9a9bc35758f955ca85c7", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-22T19:54:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyOTU5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r510429597", "bodyText": "[nit]\nUse Files.exists", "author": "MikeDombo", "createdAt": "2020-10-22T20:14:01Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/RunWithArtifactHandler.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.lifecyclemanager;\n+\n+import com.aws.greengrass.componentmanager.models.ComponentIdentifier;\n+import com.aws.greengrass.util.CrashableFunction;\n+import com.aws.greengrass.util.FileSystemPermission;\n+import com.aws.greengrass.util.NucleusPaths;\n+import com.aws.greengrass.util.platforms.Platform;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import javax.inject.Inject;\n+\n+import static com.aws.greengrass.util.FileSystemPermission.Option.IgnorePermission;\n+import static com.aws.greengrass.util.FileSystemPermission.Option.Recurse;\n+\n+/**\n+ * Update artifact ownership based on service RunWith information.\n+ */\n+public class RunWithArtifactHandler {\n+\n+    final NucleusPaths nucleusPaths;\n+\n+    final Platform platform;\n+\n+    /**\n+     * Construct a new handler.\n+     *\n+     * @param paths paths in the nucleus.\n+     */\n+    @Inject\n+    public RunWithArtifactHandler(NucleusPaths paths) {\n+        this(paths, Platform.getInstance());\n+    }\n+\n+    /**\n+     * Construct a new handler.\n+     *\n+     * @param paths paths in the nucleus.\n+     * @param platform the platform instance.\n+     */\n+    public RunWithArtifactHandler(NucleusPaths paths, Platform platform) {\n+        this.nucleusPaths = paths;\n+        this.platform = platform;\n+    }\n+\n+    /**\n+     * Update the owner of the artifacts in the component on the local filesystem. The user and group of from the\n+     * RunWith parameter are used.\n+     *\n+     * @param id      the component to update.\n+     * @param runWith the user/group that should own the files.\n+     * @throws IOException if an error occurs while updating. This can occur if the user running the kernel does not\n+     *                     have the correct permissions or capabilities to change file ownership to another user.\n+     */\n+    public void updateOwner(ComponentIdentifier id, RunWith runWith) throws IOException {\n+        Path artifacts = nucleusPaths.artifactPath(id);\n+        Path unarchived = nucleusPaths.unarchiveArtifactPath(id);\n+\n+        FileSystemPermission permission = FileSystemPermission.builder()\n+                .ownerUser(runWith.getUser())\n+                .ownerGroup(runWith.getGroup())\n+                .build();\n+\n+        CrashableFunction<Path, Void, IOException> f = (p) -> {\n+            if (p.toFile().exists()) {", "originalCommit": "43cd2943521e8371f61a9a9bc35758f955ca85c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1e0a9521e2dc4b78409910ada86f14a2f3b5f148", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1e0a9521e2dc4b78409910ada86f14a2f3b5f148", "message": "Fix tests to work on build machines and desktops\n\nSet the posixUser to 'nobody' - this is not good in production, but it is a user that exists on Linux and Macs without requiring a user to be created.\nFix tests to use random temp directory", "committedDate": "2020-10-23T21:53:58Z", "type": "commit"}, {"oid": "8333e6433f013b63e4cfff615f2df03c8d51be13", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8333e6433f013b63e4cfff615f2df03c8d51be13", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-23T22:48:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE4ODg0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r511188845", "bodyText": "remove the listener using try-finally", "author": "MikeDombo", "createdAt": "2020-10-23T22:55:51Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/GenericExternalServiceTest.java", "diffHunk": "@@ -308,20 +317,30 @@ void GIVEN_bootstrap_command_WHEN_runs_longer_than_5_sec_THEN_timeout_exception_\n     @EnabledOnOs({OS.LINUX, OS.MAC})\n     @ParameterizedTest\n     @MethodSource(\"posixTestUserConfig\")\n-    void GIVEN_posix_default_user_WHEN_runs_THEN_runs_with_default_user(String file, String expectedUid)\n+    void GIVEN_posix_default_user_WHEN_runs_THEN_runs_with_default_user(String file, String expectedInstallUid,\n+                                                                        String expectedRunUid)\n             throws Exception {\n+\n+        CountDownLatch countDownLatch = new CountDownLatch(2);\n+        // Set up stdout listener to capture stdout for verifying users\n+        List<String> stdouts = new CopyOnWriteArrayList<>();\n+        Consumer<GreengrassLogMessage> listener = m -> {\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if (messageOnStdout != null\n+                    && (messageOnStdout.contains(\"run as\")\n+                        || messageOnStdout.contains(\"install as\") )) {\n+                stdouts.add(messageOnStdout);\n+                countDownLatch.countDown();\n+            }\n+        };\n+        Slf4jLogAdapter.addGlobalListener(listener);", "originalCommit": "8333e6433f013b63e4cfff615f2df03c8d51be13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MDcwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r511190706", "bodyText": "this won't work unless passwordless sudo is there. Can you maybe try running the sudo version, and if that fails then run without sudo perhaps?", "author": "MikeDombo", "createdAt": "2020-10-23T23:04:07Z", "path": "src/test/java/com/aws/greengrass/testcommons/testutilities/SpawnedProcessProtector.java", "diffHunk": "@@ -54,7 +53,11 @@ public void afterAll(ExtensionContext context) throws Exception {\n                 }\n \n                 // Kill the stray process\n-                Processes.newPidProcess(Integer.parseInt(pid)).destroyForcefully();\n+                proc = new ProcessBuilder().command(\"sudo\", \"kill\", \"-9\", pid).start();", "originalCommit": "8333e6433f013b63e4cfff615f2df03c8d51be13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxNDcxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r511714710", "bodyText": "I added the \"-n\" so it fails immediately without passwordless sudo, and added a fallback to without sudo", "author": "rbattle", "createdAt": "2020-10-26T04:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MDcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTAwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r511191000", "bodyText": "you can implement both each and all with the same extension if you wanted", "author": "MikeDombo", "createdAt": "2020-10-23T23:05:11Z", "path": "src/test/java/com/aws/greengrass/testcommons/testutilities/UniqueRootPathBeforeAll.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *  SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.testcommons.testutilities;\n+\n+import org.junit.jupiter.api.extension.BeforeAllCallback;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.api.extension.ExtensionContext.Namespace;\n+\n+import static com.aws.greengrass.testcommons.testutilities.UniqueRootStoreHelper.KEY;\n+\n+public class UniqueRootPathBeforeAll implements BeforeAllCallback {", "originalCommit": "8333e6433f013b63e4cfff615f2df03c8d51be13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIwMzQ0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r511203442", "bodyText": "I had it separate because the path would change during test executin, but I suppose that doesn't actually matter. If the Kernel is created in a beforeAll, it doesn't care if the property changes for every test.", "author": "rbattle", "createdAt": "2020-10-24T00:08:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTIzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r511191237", "bodyText": "we have a utility already to recursively delete. Utils.deleteFileRecursively", "author": "MikeDombo", "createdAt": "2020-10-23T23:06:10Z", "path": "src/test/java/com/aws/greengrass/testcommons/testutilities/UniqueRootStoreHelper.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *  SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.testcommons.testutilities;\n+\n+import org.junit.jupiter.api.extension.ExtensionConfigurationException;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n+\n+import java.io.IOException;\n+import java.nio.file.FileVisitResult;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.SimpleFileVisitor;\n+import java.nio.file.attribute.BasicFileAttributes;\n+\n+import static java.nio.file.FileVisitResult.CONTINUE;\n+\n+final class UniqueRootStoreHelper {\n+    static final String KEY = \"root\";\n+\n+    private UniqueRootStoreHelper() {\n+        \n+    }\n+\n+    public static CloseableResource createPath(String key) {\n+        try {\n+            Path p = Files.createTempDirectory(\"greengrass-test\");\n+            System.setProperty(key, p.toAbsolutePath().toString());\n+            return new CloseableResource() {\n+                @Override\n+                public void close() throws Throwable {\n+                    System.clearProperty(key);\n+                    Files.walkFileTree(p, new SimpleFileVisitor<Path>() {", "originalCommit": "8333e6433f013b63e4cfff615f2df03c8d51be13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1341a816a498ab00a14463e11185cbbb3683bd89", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1341a816a498ab00a14463e11185cbbb3683bd89", "message": "Update Unix user/group attribute to parse UIDs/GIDs as long instead of int\nUIDs are generally unsigned ints\n\nUpdate test yaml files and add closable log utility\n\nWrap calls to add log listener in an auto closeable", "committedDate": "2020-10-26T04:07:13Z", "type": "commit"}, {"oid": "b26499d91d5f0b0f5819f6b398e83b640e12c9c1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b26499d91d5f0b0f5819f6b398e83b640e12c9c1", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-26T04:09:42Z", "type": "commit"}, {"oid": "c6d95c10912965a17c3202868b885ef540b65b04", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6d95c10912965a17c3202868b885ef540b65b04", "message": "For tests, attempt to kill with sudo and without", "committedDate": "2020-10-26T04:30:31Z", "type": "commit"}, {"oid": "4321b32203d9bb0378bca77ac689af793a632959", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4321b32203d9bb0378bca77ac689af793a632959", "message": "Add back a protected constructor in GenericExternalService", "committedDate": "2020-10-26T05:39:45Z", "type": "commit"}, {"oid": "ebbb077d4c41353aab9085725cf8fb398588ce3e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ebbb077d4c41353aab9085725cf8fb398588ce3e", "message": "Remove group for nobody", "committedDate": "2020-10-26T06:06:36Z", "type": "commit"}, {"oid": "4e0e99cd9dc6e0ddb88c4ae978ed4d9ef2660104", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4e0e99cd9dc6e0ddb88c4ae978ed4d9ef2660104", "message": "Add log messages when looking up user info fails. Fix yaml file config to set default user", "committedDate": "2020-10-26T07:31:57Z", "type": "commit"}, {"oid": "e0a9175fda160f197d918bdc28c0aee2f4766373", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e0a9175fda160f197d918bdc28c0aee2f4766373", "message": "Fix DeploymentConfigMergingTest to keep nucleus configuration", "committedDate": "2020-10-26T20:17:40Z", "type": "commit"}, {"oid": "449c812195ccefd7408ad0301ba8f03939bed545", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/449c812195ccefd7408ad0301ba8f03939bed545", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-26T20:20:03Z", "type": "commit"}, {"oid": "62141dd542de61c0700efd240e92b91f40a8d910", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/62141dd542de61c0700efd240e92b91f40a8d910", "message": "Remove a bogus instanceof", "committedDate": "2020-10-26T20:48:20Z", "type": "commit"}, {"oid": "acc2e031a23909cca5e65619125f97d96fce25e3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/acc2e031a23909cca5e65619125f97d96fce25e3", "message": "remove debug logging", "committedDate": "2020-10-26T20:53:50Z", "type": "commit"}, {"oid": "c192edc210524d39fa5f788d1f860ff75b64fe1b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c192edc210524d39fa5f788d1f860ff75b64fe1b", "message": "Set default user for e2e tests", "committedDate": "2020-10-27T00:41:40Z", "type": "commit"}, {"oid": "fac93219e960576c6fd8855a93c47bffac3e13a6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fac93219e960576c6fd8855a93c47bffac3e13a6", "message": "Merge remote-tracking branch 'origin/master' into set-owner", "committedDate": "2020-10-27T02:45:19Z", "type": "commit"}, {"oid": "6543de990b248ddacd5f7ed318dade976072fd2c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6543de990b248ddacd5f7ed318dade976072fd2c", "message": "Fix config merging test dependency order check", "committedDate": "2020-10-27T03:26:42Z", "type": "commit"}, {"oid": "6543de990b248ddacd5f7ed318dade976072fd2c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6543de990b248ddacd5f7ed318dade976072fd2c", "message": "Fix config merging test dependency order check", "committedDate": "2020-10-27T03:26:42Z", "type": "forcePushed"}, {"oid": "6393770b9b11f76061385fafdbaf0d3912fb6c38", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6393770b9b11f76061385fafdbaf0d3912fb6c38", "message": "Set artifact and artifact dir permissions\n\nPermissions will be set to world readable for artifacts - this is temporary until the component model change is consumed\n\nThe artifacts directories need to be globally readable and executable so any user can enter the directories - otherwise sharing artifacts does not work\n\nOwnership of artifacts directories is set to the nucleus user. Ownership of artifact files is set to the user running the component (or default user)\n\nUpdate Exec to remove some environment variables for HOME, USER, that do not and should not be set for components. These took the values of the user running the kernel (e.g. root)\n\nThe `cd()` method to change to the user home directory is also dangerous and unused so it has been removed. We do not want to start processes in the user home directory.", "committedDate": "2020-10-27T08:22:18Z", "type": "forcePushed"}, {"oid": "2b126b89975a9384ce37e93f0add6bdf2770db54", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2b126b89975a9384ce37e93f0add6bdf2770db54", "message": "Set artifact and artifact dir permissions\n\nPermissions will be set to world readable for artifacts - this is temporary until the component model change is consumed\n\nThe artifacts directories need to be globally readable and executable so any user can enter the directories - otherwise sharing artifacts does not work\n\nOwnership of artifacts directories is set to the nucleus user. Ownership of artifact files is set to the user running the component (or default user)\n\nUpdate Exec to remove some environment variables for HOME, USER, that do not and should not be set for components. These took the values of the user running the kernel (e.g. root)\n\nThe `cd()` method to change to the user home directory is also dangerous and unused so it has been removed. We do not want to start processes in the user home directory.", "committedDate": "2020-10-27T16:02:46Z", "type": "commit"}, {"oid": "2b126b89975a9384ce37e93f0add6bdf2770db54", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2b126b89975a9384ce37e93f0add6bdf2770db54", "message": "Set artifact and artifact dir permissions\n\nPermissions will be set to world readable for artifacts - this is temporary until the component model change is consumed\n\nThe artifacts directories need to be globally readable and executable so any user can enter the directories - otherwise sharing artifacts does not work\n\nOwnership of artifacts directories is set to the nucleus user. Ownership of artifact files is set to the user running the component (or default user)\n\nUpdate Exec to remove some environment variables for HOME, USER, that do not and should not be set for components. These took the values of the user running the kernel (e.g. root)\n\nThe `cd()` method to change to the user home directory is also dangerous and unused so it has been removed. We do not want to start processes in the user home directory.", "committedDate": "2020-10-27T16:02:46Z", "type": "forcePushed"}, {"oid": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7ca6989a9b0038ba03c9426a3790aedc131e04ee", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-27T18:13:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzYxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r512913613", "bodyText": "ooh nice improvement!", "author": "MikeDombo", "createdAt": "2020-10-27T18:01:20Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -170,35 +170,33 @@ void GIVEN_kernel_running_single_service_WHEN_merge_changes_service_THEN_service\n                 safeUpdateRegistered.set(true);\n             }\n         };\n-        Slf4jLogAdapter.addGlobalListener(listener);\n-\n-        kernel.launch();\n-        assertTrue(mainRunning.await(5, TimeUnit.SECONDS));\n-\n-        // WHEN\n-        CountDownLatch mainRestarted = new CountDownLatch(1);\n-        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n-            if (service.getName().equals(\"main\") && newState.equals(State.FINISHED) && oldState.equals(State.STARTING)) {\n-                mainRestarted.countDown();\n-            }\n-        });\n+        try (AutoCloseable l = TestUtils.createCloseableLogListener(listener)) {", "originalCommit": "2b126b89975a9384ce37e93f0add6bdf2770db54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2NDg1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513064856", "bodyText": "I wish we were using > Java 8, then you wouldn't need the silly assignment", "author": "rbattle", "createdAt": "2020-10-27T22:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMzcyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r512923722", "bodyText": "use enhanced for loop?", "author": "MikeDombo", "createdAt": "2020-10-27T18:14:46Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/RunWithArtifactHandler.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.lifecyclemanager;\n+\n+import com.aws.greengrass.componentmanager.models.ComponentIdentifier;\n+import com.aws.greengrass.util.CrashableFunction;\n+import com.aws.greengrass.util.FileSystemPermission;\n+import com.aws.greengrass.util.NucleusPaths;\n+import com.aws.greengrass.util.platforms.Platform;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.inject.Inject;\n+\n+import static com.aws.greengrass.util.FileSystemPermission.Option.IgnorePermission;\n+import static com.aws.greengrass.util.FileSystemPermission.Option.Recurse;\n+\n+/**\n+ * Update artifact ownership based on service RunWith information.\n+ */\n+public class RunWithArtifactHandler {\n+\n+    final NucleusPaths nucleusPaths;\n+\n+    final Platform platform;\n+\n+    /**\n+     * Construct a new handler.\n+     *\n+     * @param paths paths in the nucleus.\n+     */\n+    @Inject\n+    public RunWithArtifactHandler(NucleusPaths paths) {\n+        this(paths, Platform.getInstance());\n+    }\n+\n+    /**\n+     * Construct a new handler.\n+     *\n+     * @param paths paths in the nucleus.\n+     * @param platform the platform instance.\n+     */\n+    public RunWithArtifactHandler(NucleusPaths paths, Platform platform) {\n+        this.nucleusPaths = paths;\n+        this.platform = platform;\n+    }\n+\n+    /**\n+     * Update the owner of the artifacts in the component on the local filesystem. The user and group of from the\n+     * RunWith parameter are used.\n+     *\n+     * @param id      the component to update.\n+     * @param runWith the user/group that should own the files.\n+     * @throws IOException if an error occurs while updating. This can occur if the user running the kernel does not\n+     *                     have the correct permissions or capabilities to change file ownership to another user.\n+     */\n+    public void updateOwner(ComponentIdentifier id, RunWith runWith) throws IOException {\n+        Path artifacts = nucleusPaths.artifactPath(id);\n+        Path unarchived = nucleusPaths.unarchiveArtifactPath(id);\n+\n+        FileSystemPermission permission = FileSystemPermission.builder()\n+                .ownerUser(runWith.getUser())\n+                .ownerGroup(runWith.getGroup())\n+                .build();\n+\n+        // change ownership of files within the artifact dirs, but don't change the artifact dir itself as that would\n+        // make it writable to the user\n+        CrashableFunction<Path, Void, IOException> f = (p) -> {\n+            if (Files.exists(p)) {\n+                for (Iterator<Path> it = Files.list(p).iterator(); it.hasNext(); ) {", "originalCommit": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0MjMwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513042304", "bodyText": "setPermissions throws an IOException so I can't do\nFiles.list(p).forEach(x -> platform.setPermissions(permission, x));\nIterating seems more straightforward than this alternative:\n              Optional<IOException> e = Files.list(p).map(x -> {\n                    try {\n                        platform.setPermissions(permission, x);\n                    } catch (IOException ie) {\n                        return ie;\n                    }\n                    return null;\n                }).filter(Objects::nonNull).findFirst();\n                if (e.isPresent()) {\n                    throw e.get();\n                }", "author": "rbattle", "createdAt": "2020-10-27T21:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMzcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0Mjk1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513042951", "bodyText": "I mean \"for (Path p : Files.list(p))\"", "author": "MikeDombo", "createdAt": "2020-10-27T21:27:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMzcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0NzA1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513047055", "bodyText": "insert egg-on-face emoji here", "author": "rbattle", "createdAt": "2020-10-27T21:35:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMzcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0Nzc3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513047776", "bodyText": "ah - now I know why I didn't do that - it returns a stream, so I'd have to collect it:\n                for (Path x : Files.list(p).collect(Collectors.toList())) {", "author": "rbattle", "createdAt": "2020-10-27T21:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMzcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0ODkxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513048915", "bodyText": "Really, that ought to work, the enhanced for loop just works on any Iterable", "author": "MikeDombo", "createdAt": "2020-10-27T21:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMzcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0OTAwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513049005", "bodyText": "But whatever, doesn't really matter", "author": "MikeDombo", "createdAt": "2020-10-27T21:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMzcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2NjU1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513066553", "bodyText": "Yeah - the Stream interface isn't an Iterable so you end up having to dance around it.", "author": "rbattle", "createdAt": "2020-10-27T22:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMzcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyNTIwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r512925201", "bodyText": "this shouldn't be using setArtifactStorePermission should it? Since this path is the artifacts for a particular component.", "author": "MikeDombo", "createdAt": "2020-10-27T18:16:52Z", "path": "src/main/java/com/aws/greengrass/util/NucleusPaths.java", "diffHunk": "@@ -128,15 +132,18 @@ public Path unarchivePath() {\n     public Path unarchiveArtifactPath(ComponentIdentifier componentIdentifier, String artifactName) throws IOException {\n         Path p = unarchiveArtifactPath(componentIdentifier).resolve(artifactName);\n         Utils.createPaths(p);\n-        Permissions.setArtifactPermission(p);\n+        Permissions.setArtifactStorePermission(p);\n         return p;\n     }\n \n     public Path unarchiveArtifactPath(ComponentIdentifier componentIdentifier) throws IOException {\n-        Path p = unarchivePath().resolve(componentIdentifier.getName())\n-                .resolve(componentIdentifier.getVersion().getValue());\n+        Path p = unarchivePath().resolve(componentIdentifier.getName());\n+        Utils.createPaths(p);\n+        Permissions.setArtifactStorePermission(p);\n+\n+        p = p.resolve(componentIdentifier.getVersion().getValue());\n         Utils.createPaths(p);\n-        Permissions.setArtifactPermission(p);\n+        Permissions.setArtifactStorePermission(p);", "originalCommit": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0NjQ4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513046487", "bodyText": "this is for the path of the directory for the unarchived file\nso if you have foo.zip,\nthis would be the path to /packages/artifacts-unarchived/component/version/<foo.zip>/\nThe contents of this directory would be set to whatever is in the recipe to apply to the archive. Right now they get set to read only (unless it is a dir then it needs to be executable) as.\nIf an un-archived artifact path is referenced by another recipe, the directory needs to be world readable and world executable.\nThe writable is necessary on dirs because if the user is non-root, they need to be able to delete the directory when tests exit / artifacts are cleaned up. This bit could be cleaned up - but I'd like to wait until all the artifact permission setting is implemented.", "author": "rbattle", "createdAt": "2020-10-27T21:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyNTIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyNTkzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r512925938", "bodyText": "enhanced for loop?", "author": "MikeDombo", "createdAt": "2020-10-27T18:17:52Z", "path": "src/main/java/com/aws/greengrass/util/Permissions.java", "diffHunk": "@@ -8,19 +8,48 @@\n import com.aws.greengrass.util.platforms.Platform;\n \n import java.io.IOException;\n+import java.nio.file.Files;\n import java.nio.file.Path;\n+import java.util.Iterator;\n \n public final class Permissions {\n     private static final Platform platform = Platform.getInstance();\n-    private static final FileSystemPermission OWNER_RWX_ONLY =\n-            new FileSystemPermission(null, null, true, true, true, false, false, false, false, false, false);\n-    private static final FileSystemPermission OWNER_RWX_EVERYONE_RX =\n-            new FileSystemPermission(null, null, true, true, true, true, false, true, true, false, true);\n+    private static final FileSystemPermission OWNER_RWX_ONLY =  FileSystemPermission.builder()\n+            .ownerRead(true).ownerWrite(true).ownerExecute(true).build();\n+    private static final FileSystemPermission OWNER_RWX_EVERYONE_RX = FileSystemPermission.builder()\n+            .ownerRead(true).ownerWrite(true).ownerExecute(true)\n+            .groupRead(true).groupExecute(true)\n+            .otherRead(true).otherExecute(true)\n+            .build();\n+    private static final FileSystemPermission OWNER_R_ONLY = FileSystemPermission.builder().ownerRead(true).build();\n+    private static final FileSystemPermission EVERYONE_RX = FileSystemPermission.builder()\n+            .ownerRead(true).ownerExecute(true)\n+            .groupRead(true).groupExecute(true)\n+            .otherRead(true).otherExecute(true)\n+            .build();\n \n     private Permissions() {\n     }\n \n+    /**\n+     * Set default permissions on an artifact.\n+     *\n+     * @param p the artifact path.\n+     * @throws IOException if an error occurs.\n+     */\n     public static void setArtifactPermission(Path p) throws IOException {\n+        if (p == null || !Files.exists(p)) {\n+            return;\n+        }\n+        // default artifact permissions - readable by owner but everyone can access dirs\n+        if (Files.isDirectory(p)) {\n+            platform.setPermissions(OWNER_RWX_EVERYONE_RX, p);\n+            for (Iterator<Path> it = Files.list(p).iterator(); it.hasNext(); ) {", "originalCommit": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0NzE4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513147185", "bodyText": "nit: package -> component", "author": "fengwang666", "createdAt": "2020-10-28T02:47:04Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -306,7 +307,16 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n                 }\n             }\n             File artifactFile = downloader.getArtifactFile(packageArtifactDirectory, artifact, componentIdentifier);\n-\n+            if (artifactFile != null) {\n+                // TODO: Change permissions - set world readable until artifact permissions can be set via model\n+                try {\n+                    Permissions.setArtifactPermission(artifactFile.toPath());\n+                } catch (IOException e) {\n+                    throw new PackageDownloadException(\n+                            String.format(\"Failed to change permissions of package %s artifact %s\", componentIdentifier,", "originalCommit": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0NzMzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513147337", "bodyText": "What's this TODO about? Does it need to be resolved before re:Invent?", "author": "fengwang666", "createdAt": "2020-10-28T02:47:38Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -306,7 +307,16 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n                 }\n             }\n             File artifactFile = downloader.getArtifactFile(packageArtifactDirectory, artifact, componentIdentifier);\n-\n+            if (artifactFile != null) {\n+                // TODO: Change permissions - set world readable until artifact permissions can be set via model", "originalCommit": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE3MjI4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513172287", "bodyText": "yes - the artifact component model in the cloud has been updated to allow you to set permissions for artifacts. This needs to read those artifact permissions (e.g. readable to user, readable to everyone, executable to user, executable to everyone).\nfor instance, the lambda launcher will be able to specify that it is readable and executable to all. Then we don't need to have an install script that RequiresPrivilege to do a chmod\nThis needs to get updated to pick out the permissions and set them. If they are not specified, the coral model defaults to read only.", "author": "rbattle", "createdAt": "2020-10-28T04:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0NzMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0OTk0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513149948", "bodyText": "Why do we need to set runWith to null?", "author": "fengwang666", "createdAt": "2020-10-28T02:57:07Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java", "diffHunk": "@@ -326,6 +348,7 @@ protected synchronized void shutdown() {\n             stopAllLifecycleProcesses();\n             logger.atInfo().setEventType(\"generic-service-shutdown\").log();\n         }\n+        runWith = null; // reset runWith - a deployment can change user info", "originalCommit": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE3Mjg5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513172899", "bodyText": "The instance of the service is only loaded once.\nDuring the lifecycle we want to run all the commands with the same user.\nFor instance, if the component is launched with user A, we want to run all the commands as user A.\nWhen a deployment happens to change the user to B, the config store gets updated first. We don't want to shutdown the service as user B if it was started by A.\nOnce the service is shutdown, we can throw away the runWith info and pick it up again the next time a script runs. We don't know what script will actually run though -  it could be bootstrap, install, run, startup.", "author": "rbattle", "createdAt": "2020-10-28T04:26:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0OTk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE1OTcwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513159701", "bodyText": "Shouldn't this be logged as an Error? The IOException is logged as an error inside updateArtifactOwner. Also what would be the default owner and permission if updateArtifactOwner fails?", "author": "fengwang666", "createdAt": "2020-10-28T03:34:08Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java", "diffHunk": "@@ -406,8 +460,16 @@ protected void storeInitialRunWithConfiguration() {\n \n     @SuppressWarnings(\"PMD.CloseResource\")\n     protected Pair<RunStatus, Exec> run(Topic t, String cmd, IntConsumer background, List<Exec> trackingList,\n-                                        boolean requiresPrivilege)\n-            throws InterruptedException {\n+                                        boolean requiresPrivilege) throws InterruptedException {\n+        if (runWith == null) {\n+            if (!storeInitialRunWithConfiguration()) {\n+                return new Pair<>(RunStatus.Errored, null);\n+            }\n+            if (!updateArtifactOwner()) {\n+                logger.atWarn().log(\"Service artifacts may not be accessible to user\");", "originalCommit": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE3MDkxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513170914", "bodyText": "the default owner would be the user running the nucleus, or the previous user that was configured to run the component", "author": "rbattle", "createdAt": "2020-10-28T04:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE1OTcwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2MDQ5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513160496", "bodyText": "If setPermissions throws IOException, do we want to continue the for loop for the rest?", "author": "fengwang666", "createdAt": "2020-10-28T03:36:49Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/RunWithArtifactHandler.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.lifecyclemanager;\n+\n+import com.aws.greengrass.componentmanager.models.ComponentIdentifier;\n+import com.aws.greengrass.util.CrashableFunction;\n+import com.aws.greengrass.util.FileSystemPermission;\n+import com.aws.greengrass.util.NucleusPaths;\n+import com.aws.greengrass.util.platforms.Platform;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.inject.Inject;\n+\n+import static com.aws.greengrass.util.FileSystemPermission.Option.IgnorePermission;\n+import static com.aws.greengrass.util.FileSystemPermission.Option.Recurse;\n+\n+/**\n+ * Update artifact ownership based on service RunWith information.\n+ */\n+public class RunWithArtifactHandler {\n+\n+    final NucleusPaths nucleusPaths;\n+\n+    final Platform platform;\n+\n+    /**\n+     * Construct a new handler.\n+     *\n+     * @param paths paths in the nucleus.\n+     */\n+    @Inject\n+    public RunWithArtifactHandler(NucleusPaths paths) {\n+        this(paths, Platform.getInstance());\n+    }\n+\n+    /**\n+     * Construct a new handler.\n+     *\n+     * @param paths paths in the nucleus.\n+     * @param platform the platform instance.\n+     */\n+    public RunWithArtifactHandler(NucleusPaths paths, Platform platform) {\n+        this.nucleusPaths = paths;\n+        this.platform = platform;\n+    }\n+\n+    /**\n+     * Update the owner of the artifacts in the component on the local filesystem. The user and group of from the\n+     * RunWith parameter are used.\n+     *\n+     * @param id      the component to update.\n+     * @param runWith the user/group that should own the files.\n+     * @throws IOException if an error occurs while updating. This can occur if the user running the kernel does not\n+     *                     have the correct permissions or capabilities to change file ownership to another user.\n+     */\n+    public void updateOwner(ComponentIdentifier id, RunWith runWith) throws IOException {\n+        Path artifacts = nucleusPaths.artifactPath(id);\n+        Path unarchived = nucleusPaths.unarchiveArtifactPath(id);\n+\n+        FileSystemPermission permission = FileSystemPermission.builder()\n+                .ownerUser(runWith.getUser())\n+                .ownerGroup(runWith.getGroup())\n+                .build();\n+\n+        // change ownership of files within the artifact dirs, but don't change the artifact dir itself as that would\n+        // make it writable to the user\n+        CrashableFunction<Path, Void, IOException> f = (p) -> {\n+            if (Files.exists(p)) {\n+                for (Iterator<Path> it = Files.list(p).iterator(); it.hasNext(); ) {\n+                    platform.setPermissions(permission, it.next(), Recurse, IgnorePermission);", "originalCommit": "7ca6989a9b0038ba03c9426a3790aedc131e04ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE3NDE3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513174171", "bodyText": "if setting the permissions fails, the user may not be able to execute the commands. Throwing an exception would cause the service to move to a broken state and potentially fail a deployment.\nThe service is potentially broken if the artifact permissions are not set correctly. It may run fine, but it could also fail immediately because it can't execute a command or read a file - but the customer would have to tease apart the error to find out it is because the permissions couldn't be set correctly.\nThis happened when I was testing UATs and found some missing permissions on directories - the service may tell you it can't find an artifact, or get a permission denied on the artifact, but it's an execution error at that point", "author": "rbattle", "createdAt": "2020-10-28T04:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2MDQ5Ng=="}], "type": "inlineReview"}, {"oid": "04ca88f915c1010fb6c49a85e3ac0143409436b8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/04ca88f915c1010fb6c49a85e3ac0143409436b8", "message": "Add nucleus dependency for delta test", "committedDate": "2020-10-28T07:12:35Z", "type": "commit"}, {"oid": "0b0c1fcb2bd04c9ba32d80fec1fad8e6a9c61362", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0b0c1fcb2bd04c9ba32d80fec1fad8e6a9c61362", "message": "Fix loader bug; Update iot jobs dedupe (#573)\n\nCo-authored-by: Shagupta Shaikh <58999292+shaguptashaikh@users.noreply.github.com>", "committedDate": "2020-10-28T07:12:35Z", "type": "commit"}, {"oid": "8d47f5c988e70d71136e466a0483ddacd247ca85", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8d47f5c988e70d71136e466a0483ddacd247ca85", "message": "Fix permissions on temp directory when deleting, add logging for exec", "committedDate": "2020-10-28T07:12:35Z", "type": "commit"}, {"oid": "54be8ffc81cbf8ea223259118ca127eace266e38", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/54be8ffc81cbf8ea223259118ca127eace266e38", "message": "Merge remote-tracking branch 'origin/master' into set-owner", "committedDate": "2020-10-28T07:28:21Z", "type": "commit"}, {"oid": "7bf5d1a85b661253ed758fc3b423c370228e7fe9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7bf5d1a85b661253ed758fc3b423c370228e7fe9", "message": "Fixes so tests run as non-root user", "committedDate": "2020-10-28T08:35:31Z", "type": "commit"}, {"oid": "f9f9fa7b841d84c51e8ca6f55d52cbc693ec4fd2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f9f9fa7b841d84c51e8ca6f55d52cbc693ec4fd2", "message": "Change warn log to error for artifact ownership failure", "committedDate": "2020-10-28T08:39:51Z", "type": "commit"}, {"oid": "f9f9fa7b841d84c51e8ca6f55d52cbc693ec4fd2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f9f9fa7b841d84c51e8ca6f55d52cbc693ec4fd2", "message": "Change warn log to error for artifact ownership failure", "committedDate": "2020-10-28T08:39:51Z", "type": "forcePushed"}, {"oid": "c026838ad6d3d83c9973991d07b958acd355b0ec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c026838ad6d3d83c9973991d07b958acd355b0ec", "message": "set permissions and delete in visitor", "committedDate": "2020-10-28T08:44:38Z", "type": "commit"}, {"oid": "64e5dc0322bbd6253c6b405a9395d08f1f6d98bb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/64e5dc0322bbd6253c6b405a9395d08f1f6d98bb", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-28T15:01:50Z", "type": "commit"}, {"oid": "544afb1a681c09522cf61df525174202464d99a5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/544afb1a681c09522cf61df525174202464d99a5", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-28T20:27:18Z", "type": "commit"}, {"oid": "e3183479f8760efbf300cfe722652e0095ebc150", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e3183479f8760efbf300cfe722652e0095ebc150", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-28T20:41:49Z", "type": "commit"}, {"oid": "2fc8d297ed187042ba225b21daa983ab7bf52044", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2fc8d297ed187042ba225b21daa983ab7bf52044", "message": "Add default user to easy setup. Fix kernel command line user setup", "committedDate": "2020-10-29T01:03:32Z", "type": "commit"}, {"oid": "0863ff550db055febb27e609fdf2714797294a5e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0863ff550db055febb27e609fdf2714797294a5e", "message": "Merge remote-tracking branch 'origin/master' into set-owner", "committedDate": "2020-10-29T02:06:26Z", "type": "commit"}, {"oid": "5b4427043b8e77c21fa57a978c094aa3c265d131", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b4427043b8e77c21fa57a978c094aa3c265d131", "message": "Fix ezsetup arg", "committedDate": "2020-10-29T02:25:55Z", "type": "forcePushed"}, {"oid": "016fddca697dfcf3477109df6077112f3bd0e262", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/016fddca697dfcf3477109df6077112f3bd0e262", "message": "Fix ezsetup arg", "committedDate": "2020-10-29T02:27:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NTU3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513895576", "bodyText": "Does this need to get passed through the easy setup too?", "author": "MikeDombo", "createdAt": "2020-10-29T02:44:13Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -101,13 +103,37 @@ public void parseArgs(String... args) {\n                 case \"-es\":\n                     deviceConfiguration.getEnvironmentStage().withValue(getArg());\n                     break;\n+                case \"--component-default-user\":\n+                case \"-u\":\n+                    if (Exec.isWindows) {\n+                        deviceConfiguration.getRunWithDefaultWindowsUser().withValue(getArg());\n+                    } else {\n+                        deviceConfiguration.getRunWithDefaultPosixUser().withValue(getArg());\n+                    }\n+                    break;\n+                case \"--component-default-group\":", "originalCommit": "016fddca697dfcf3477109df6077112f3bd0e262", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk1NzEyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/555#discussion_r513957127", "bodyText": "That makes sense - I was trying to get the minimum done for the UATs but the group should be settable too", "author": "rbattle", "createdAt": "2020-10-29T04:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NTU3Ng=="}], "type": "inlineReview"}, {"oid": "a6f581068f50075fe05ede31655afb8b40cb5f9d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a6f581068f50075fe05ede31655afb8b40cb5f9d", "message": "Fix ezsetup arg", "committedDate": "2020-10-29T04:20:40Z", "type": "commit"}, {"oid": "a6f581068f50075fe05ede31655afb8b40cb5f9d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a6f581068f50075fe05ede31655afb8b40cb5f9d", "message": "Fix ezsetup arg", "committedDate": "2020-10-29T04:20:40Z", "type": "forcePushed"}, {"oid": "01403e89901333b81ea8d1fbfb91f99f12706807", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01403e89901333b81ea8d1fbfb91f99f12706807", "message": "Merge branch 'master' into set-owner", "committedDate": "2020-10-29T18:26:41Z", "type": "commit"}]}