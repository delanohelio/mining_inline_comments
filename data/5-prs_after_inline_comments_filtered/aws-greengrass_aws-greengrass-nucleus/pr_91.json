{"pr_number": 91, "pr_title": "Graceful shutdown of services in kernel shutdown", "pr_createdAt": "2020-03-03T04:41:59Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91", "timeline": [{"oid": "661c8439e7af428dd2d1d2df39ba202e08deb5f5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/661c8439e7af428dd2d1d2df39ba202e08deb5f5", "message": "changes for gracefull kernel shutdown", "committedDate": "2020-03-03T04:32:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5NzkwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r386797906", "bodyText": "Unused?", "author": "MikeDombo", "createdAt": "2020-03-03T04:50:29Z", "path": "src/main/java/com/aws/iot/evergreen/dependency/State.java", "diffHunk": "@@ -3,6 +3,9 @@\n \n package com.aws.iot.evergreen.dependency;\n \n+import javax.print.attribute.standard.Finishings;\n+import java.util.concurrent.BrokenBarrierException;", "originalCommit": "661c8439e7af428dd2d1d2df39ba202e08deb5f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5OTYyMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r386799620", "bodyText": "removed, you commented before i pushed the check style fixes", "author": "fahadmohammed01", "createdAt": "2020-03-03T04:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5NzkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5ODAxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r386798011", "bodyText": "Use log interpolation instead of concatenation.", "author": "MikeDombo", "createdAt": "2020-03-03T04:50:56Z", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/lifecycle/LifecycleIPCAgent.java", "diffHunk": "@@ -63,10 +67,12 @@ public void postInject() {\n      * @return response for setting state\n      */\n     public LifecycleGenericResponse reportState(StateChangeRequest stateChangeRequest, ConnectionContext context) {\n+\n         State s = State.valueOf(stateChangeRequest.getState());\n         Optional<EvergreenService> service =\n                 Optional.ofNullable(kernel.context.get(EvergreenService.class, context.getServiceName()));\n \n+        log.info(service.get().getName() + \" reported state :\" + s.toString());", "originalCommit": "661c8439e7af428dd2d1d2df39ba202e08deb5f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIzMzU3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387233579", "bodyText": "Changed", "author": "fahadmohammed01", "createdAt": "2020-03-03T19:10:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5ODAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5ODI2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r386798264", "bodyText": "Get rid of this and just use the keyset of the dependencies map.", "author": "MikeDombo", "createdAt": "2020-03-03T04:52:03Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -53,10 +53,12 @@\n \n     public final Topics config;\n     public Context context;\n-\n+    // Services that this service depend on\n     protected final ConcurrentHashMap<EvergreenService, State> dependencies = new ConcurrentHashMap<>();\n-\n+    // Services that depend on this service\n+    protected final List<EvergreenService> dependers = new CopyOnWriteArrayList<>();", "originalCommit": "661c8439e7af428dd2d1d2df39ba202e08deb5f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5OTkyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r386799927", "bodyText": "dependers       ->  Services that depend on this service\ndependencies  -> Services that this service depend on", "author": "fahadmohammed01", "createdAt": "2020-03-03T04:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5ODI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwMDcyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r386800723", "bodyText": "Ah, got it. Still not sure we want that instead of just relying on the ordered dependencies on kernel.", "author": "MikeDombo", "createdAt": "2020-03-03T05:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5ODI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI3MjkwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387272900", "bodyText": "Can you address this please? This is really my only concern. Maintaining the list of dependencies is difficult to keep in sync, so I'd really much prefer it if we can just use orderedDependencies() for that.", "author": "MikeDombo", "createdAt": "2020-03-03T20:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5ODI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5OTQxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387299417", "bodyText": "removed storing dependers in a list", "author": "fahadmohammed01", "createdAt": "2020-03-03T21:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5ODI2NA=="}], "type": "inlineReview"}, {"oid": "3de061042384b21b662deaed4a3d3780ccdfca97", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3de061042384b21b662deaed4a3d3780ccdfca97", "message": "fixed check-style issues", "committedDate": "2020-03-03T04:57:04Z", "type": "commit"}, {"oid": "3bb443a4a2a677a4d3db33bf4a833f9404243907", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3bb443a4a2a677a4d3db33bf4a833f9404243907", "message": "addressed PR comments", "committedDate": "2020-03-03T05:07:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTc4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387255783", "bodyText": "I feel this can be in L665 after requestStop()", "author": "ShirleyZheng92", "createdAt": "2020-03-03T19:51:26Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -651,12 +653,22 @@ protected void shutdown() {\n \n     @Override\n     public void close() {\n-        requestStop();\n         Periodicity t = periodicityInformation;\n         if (t != null) {\n             t.shutdown();\n         }\n+        try {\n+            waitForDependersToExit();\n+        } catch (InterruptedException e) {\n+            logger.error(\"Interrupted waiting for dependers to exit\");\n+        }\n+        requestStop();\n+    }\n \n+    /**\n+     * Shutdown the thread executing startStateTransition().\n+     */\n+    public void shutDownStateMachine() {", "originalCommit": "3bb443a4a2a677a4d3db33bf4a833f9404243907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1ODU1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387258553", "bodyText": "requestStop is asynchronous, shutting the state machine right after requestStop() does not ensure that the service can transition to a terminal state", "author": "fahadmohammed01", "createdAt": "2020-03-03T19:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1Nzc2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387357763", "bodyText": "You can have the while loop in lifecycleManager to condition on while(!(closed && getState == State.Finished))", "author": "ShirleyZheng92", "createdAt": "2020-03-03T23:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5OTk3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387399972", "bodyText": "Updated to   while (!(isClosed.get() && getState().isTerminalState())) {", "author": "fahadmohammed01", "createdAt": "2020-03-04T01:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Njc1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387256757", "bodyText": "Isn't this conflicting L738?", "author": "ShirleyZheng92", "createdAt": "2020-03-03T19:53:20Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -704,11 +716,46 @@ public synchronized void addDependency(EvergreenService dependentEvergreenServic\n         });\n     }\n \n+    private void addDepender(EvergreenService dependerEvergreenService) {\n+        dependers.add(dependerEvergreenService);\n+        dependerEvergreenService.getStateTopic().subscribe((WhatHappened what, Topic t) -> {\n+            synchronized (dependersExitedLock) {\n+                if (dependersExited()) {\n+                    dependersExitedLock.notifyAll();\n+                }\n+            }\n+        });\n+    }\n+\n     private String serializeDependencyList(ConcurrentHashMap<EvergreenService, State> dependencies) {\n         return dependencies.entrySet().stream().map((entry) -> entry.getKey().getName() + \":\" + entry.getValue())\n                 .collect(Collectors.joining(\",\"));\n     }\n \n+    private void waitForDependersToExit() throws InterruptedException {\n+        synchronized (dependersExitedLock) {\n+            while (!dependersExited()) {\n+                logger.atDebug().setEventType(\"service-waiting-for-depender-to-finish\").log();\n+                dependersExitedLock.wait();\n+            }\n+        }\n+    }\n+\n+    private boolean dependersExited() {\n+        Optional<EvergreenService> dependerService =\n+                dependers.stream().filter(d -> !dependerExited(d)).findAny();\n+        if (dependerService.isPresent()) {\n+            logger.atDebug().setEventType(\"continue-waiting-for-dependencies\")", "originalCommit": "3bb443a4a2a677a4d3db33bf4a833f9404243907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2MTI5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387261299", "bodyText": "No, if there is a dependerService not in terminal state dependersExited returns false. L737 makes the thread to wait till all dependers exit", "author": "fahadmohammed01", "createdAt": "2020-03-03T20:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Njc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NzUxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387257519", "bodyText": "No need to make change here. Given that close() will clean the wait all tasks on publishQueue exit, you can just call executorService.shutdown here()", "author": "ShirleyZheng92", "createdAt": "2020-03-03T19:54:47Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -460,30 +462,45 @@ public void shutdown() {\n      *\n      * @param timeoutSeconds Timeout in seconds\n      */\n+    @SuppressFBWarnings(value = \"RV_RETURN_VALUE_IGNORED\")\n     public void shutdown(int timeoutSeconds) {\n         if (broken) {\n             return;\n         }\n+        if (!isShutdownInitiated.compareAndSet(false, true)) {\n+            logger.info(\"Shutdown already initiated, returning...\");\n+            return;\n+        }\n         close(tlog);\n         try {\n             logger.atInfo().setEventType(\"system-shutdown\").addKeyValue(\"main\", getMain()).log();\n             EvergreenService[] d = orderedDependencies().toArray(new EvergreenService[0]);\n+            CountDownLatch allServicesExitedLatch = new CountDownLatch(d.length);\n+\n             for (int i = d.length; --i >= 0; ) { // shutdown in reverse order\n                 try {\n                     d[i].close();\n+                    d[i].getStateTopic().subscribe((WhatHappened what, Topic t) -> {\n+                        if (((State) t.getOnce()).isTerminalState()) {\n+                            allServicesExitedLatch.countDown();\n+                        }\n+                    });\n                 } catch (Throwable t) {\n                     logger.atError().setEventType(\"service-shutdown-error\").addKeyValue(\"serviceName\", d[i].getName())\n                             .setCause(t).log();\n                 }\n             }\n \n+            allServicesExitedLatch.await(timeoutSeconds, TimeUnit.SECONDS);\n             // Wait for tasks in the executor to end.\n             ExecutorService executorService = context.get(ExecutorService.class);\n             this.context.runOnPublishQueueAndWait(() -> {\n                 executorService.shutdown();\n                 logger.atInfo().setEventType(\"executor-service-shutdown-initiated\").log();\n             });", "originalCommit": "3bb443a4a2a677a4d3db33bf4a833f9404243907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwMDc1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387300756", "bodyText": "Discussed offline, we need to review the timeouts related to service state machine and this can be addressed then", "author": "fahadmohammed01", "createdAt": "2020-03-03T21:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NzUxOQ=="}], "type": "inlineReview"}, {"oid": "a49e3d042e11bd55e4d26052d22895c1c1565152", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a49e3d042e11bd55e4d26052d22895c1c1565152", "message": "removed storing dependers in a list", "committedDate": "2020-03-03T21:18:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MjExMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387372111", "bodyText": "[nit]\nYou don't need to call toString() yourself, you can just pass the object.", "author": "MikeDombo", "createdAt": "2020-03-04T00:17:40Z", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/lifecycle/LifecycleIPCAgent.java", "diffHunk": "@@ -63,10 +67,12 @@ public void postInject() {\n      * @return response for setting state\n      */\n     public LifecycleGenericResponse reportState(StateChangeRequest stateChangeRequest, ConnectionContext context) {\n+\n         State s = State.valueOf(stateChangeRequest.getState());\n         Optional<EvergreenService> service =\n                 Optional.ofNullable(kernel.context.get(EvergreenService.class, context.getServiceName()));\n \n+        log.info(\"{} reported state : {}\", service.get().getName(), s.toString());", "originalCommit": "a49e3d042e11bd55e4d26052d22895c1c1565152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5OTc1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387399750", "bodyText": "changed", "author": "fahadmohammed01", "createdAt": "2020-03-04T01:26:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MjExMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MjQ0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387372443", "bodyText": "Since this is only called from Kernel, can we have all this dependency ordering logic just be part of the kernel shutdown, instead of putting it into all the services? Since the services themselves will never use this.", "author": "MikeDombo", "createdAt": "2020-03-04T00:18:42Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -651,12 +652,22 @@ protected void shutdown() {\n \n     @Override\n     public void close() {\n-        requestStop();\n         Periodicity t = periodicityInformation;\n         if (t != null) {\n             t.shutdown();\n         }\n+        try {\n+            waitForDependersToExit();", "originalCommit": "a49e3d042e11bd55e4d26052d22895c1c1565152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMTcwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387401701", "bodyText": "waitForDependersToExit might be needed in other scenarios other than kernel shutdown, like deployment. Keeping it in evergreen service for now", "author": "fahadmohammed01", "createdAt": "2020-03-04T01:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MjQ0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzNjA2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387936069", "bodyText": "+1 on moving this logic out/up. I think it will simplify the control flow if we move this logic to an upper level. Each service just knows how to close itself while the controller, Kernel or DeploymentService, handles the ordering/waiting logic between calling close on each service, providing better isolation and independence.", "author": "leaf94", "createdAt": "2020-03-04T21:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MjQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MjgxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387372819", "bodyText": "public?", "author": "MikeDombo", "createdAt": "2020-03-04T00:20:01Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/KernelShutdownTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.WhatHappened;\n+import com.aws.iot.evergreen.dependency.State;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.LinkedList;\n+import java.util.Queue;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class KernelShutdownTest {\n+\n+    public static Kernel kernel;", "originalCommit": "a49e3d042e11bd55e4d26052d22895c1c1565152", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMDA2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387400063", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-03-04T01:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MjgxOQ=="}], "type": "inlineReview"}, {"oid": "98bb7853a29196dc2b524fdf19bdbabdf77a03c8", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/98bb7853a29196dc2b524fdf19bdbabdf77a03c8", "message": "addresses pr comments", "committedDate": "2020-03-04T01:26:09Z", "type": "commit"}, {"oid": "c85c1f17fe57d1bf606bdc043380f3cdb8a85c63", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c85c1f17fe57d1bf606bdc043380f3cdb8a85c63", "message": "updated test case", "committedDate": "2020-03-04T02:40:31Z", "type": "commit"}, {"oid": "462a67555cc18cfa345e4eb6349ace87eb0ca285", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/462a67555cc18cfa345e4eb6349ace87eb0ca285", "message": "Merge branch 'master' into gracefully_shutdown", "committedDate": "2020-03-04T02:50:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ3MTY4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387471689", "bodyText": "This worries me because we subscribe, but never delete the subscription. Running over a long period of time, our subscriber will pile up and that may be a difficult problem for us.", "author": "MikeDombo", "createdAt": "2020-03-04T06:33:28Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -709,6 +712,52 @@ private String serializeDependencyList(ConcurrentHashMap<EvergreenService, State\n                 .collect(Collectors.joining(\",\"));\n     }\n \n+    private List<EvergreenService> getDependers() {\n+        List<EvergreenService> dependers = new ArrayList<>();\n+        Kernel kernel = context.get(Kernel.class);\n+        for (EvergreenService evergreenService : kernel.orderedDependencies()) {\n+            boolean isDepender = evergreenService.dependencies.keySet().stream().anyMatch(d -> d.equals(this));\n+            if (isDepender) {\n+                dependers.add(evergreenService);\n+            }\n+            // orderedDependencies sorts services based on dependency order with main as last,\n+            // therefore all dependers will be present before the service itself in the list of orderedDependencies\n+            if (evergreenService.equals(this)) {\n+                break;\n+            }\n+        }\n+        return dependers;\n+    }\n+\n+    private void waitForDependersToExit() throws InterruptedException {\n+        getDependers().forEach(dependerEvergreenService ->\n+                dependerEvergreenService.getStateTopic().subscribe((WhatHappened what, Topic t) -> {\n+                    synchronized (dependersExitedLock) {", "originalCommit": "462a67555cc18cfa345e4eb6349ace87eb0ca285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1NjQ1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387856450", "bodyText": "we are using this pattern at few places, ex in waitForDependencyReady.\nChanged the behavior in waitForDependersToExit() to remove the subscriber. Another approach might be to do clean up when the state machine exits.", "author": "fahadmohammed01", "createdAt": "2020-03-04T18:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ3MTY4OQ=="}], "type": "inlineReview"}, {"oid": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/58dd58412d5f961815ea0b641b6d8929fbac81f9", "message": "addressed PR comments", "committedDate": "2020-03-04T18:35:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwNTY5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387905693", "bodyText": "Instead of using the state topic (which we can't unsubscribe from right now), can we use the global context listener, which does have an unsubscribe method?", "author": "MikeDombo", "createdAt": "2020-03-04T20:06:51Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -709,6 +713,56 @@ private String serializeDependencyList(ConcurrentHashMap<EvergreenService, State\n                 .collect(Collectors.joining(\",\"));\n     }\n \n+    private List<EvergreenService> getDependers() {\n+        List<EvergreenService> dependers = new ArrayList<>();\n+        Kernel kernel = context.get(Kernel.class);\n+        for (EvergreenService evergreenService : kernel.orderedDependencies()) {\n+            boolean isDepender = evergreenService.dependencies.keySet().stream().anyMatch(d -> d.equals(this));\n+            if (isDepender) {\n+                dependers.add(evergreenService);\n+            }\n+            // orderedDependencies sorts services based on dependency order with main as last,\n+            // therefore all dependers will be present before the service itself in the list of orderedDependencies\n+            if (evergreenService.equals(this)) {\n+                break;\n+            }\n+        }\n+        return dependers;\n+    }\n+\n+    private void waitForDependersToExit() throws InterruptedException {\n+        Subscriber dependerExitWatcher = (WhatHappened what, Topic t) -> {\n+            synchronized (dependersExitedLock) {\n+                if (dependersExited()) {\n+                    dependersExitedLock.notifyAll();\n+                }\n+            }\n+        };\n+        // subscribing to depender state changes\n+        getDependers().forEach(dependerEvergreenService ->\n+                dependerEvergreenService.getStateTopic().subscribe(dependerExitWatcher));", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwNzkxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387907914", "bodyText": "You can remove from a state topic\nex:\ngetDependers().forEach(dependerEvergreenService ->\ndependerEvergreenService.getStateTopic().remove(dependerExitWatcher));", "author": "fahadmohammed01", "createdAt": "2020-03-04T20:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwNTY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwODM4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387908381", "bodyText": "It's expensive to have getDependers() called every time in a listener's synchronized block. You should call getDependers() once in L742 and use the result listeners.", "author": "ShirleyZheng92", "createdAt": "2020-03-04T20:12:13Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -709,6 +713,56 @@ private String serializeDependencyList(ConcurrentHashMap<EvergreenService, State\n                 .collect(Collectors.joining(\",\"));\n     }\n \n+    private List<EvergreenService> getDependers() {\n+        List<EvergreenService> dependers = new ArrayList<>();\n+        Kernel kernel = context.get(Kernel.class);\n+        for (EvergreenService evergreenService : kernel.orderedDependencies()) {\n+            boolean isDepender = evergreenService.dependencies.keySet().stream().anyMatch(d -> d.equals(this));\n+            if (isDepender) {\n+                dependers.add(evergreenService);\n+            }\n+            // orderedDependencies sorts services based on dependency order with main as last,\n+            // therefore all dependers will be present before the service itself in the list of orderedDependencies\n+            if (evergreenService.equals(this)) {\n+                break;\n+            }\n+        }\n+        return dependers;\n+    }\n+\n+    private void waitForDependersToExit() throws InterruptedException {\n+        Subscriber dependerExitWatcher = (WhatHappened what, Topic t) -> {\n+            synchronized (dependersExitedLock) {\n+                if (dependersExited()) {\n+                    dependersExitedLock.notifyAll();\n+                }\n+            }\n+        };\n+        // subscribing to depender state changes\n+        getDependers().forEach(dependerEvergreenService ->\n+                dependerEvergreenService.getStateTopic().subscribe(dependerExitWatcher));\n+        synchronized (dependersExitedLock) {\n+            while (!dependersExited()) {\n+                logger.atDebug().setEventType(\"service-waiting-for-depender-to-finish\").log();\n+                dependersExitedLock.wait();\n+            }\n+        }\n+        // removing state change watchers\n+        getDependers().forEach(dependerEvergreenService ->\n+                dependerEvergreenService.getStateTopic().remove(dependerExitWatcher));\n+    }\n+\n+    private boolean dependersExited() {\n+        Optional<EvergreenService> dependerService =\n+                getDependers().stream().filter(d -> !d.getState().isTerminalState()).findAny();", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxMjU4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387912583", "bodyText": "I was using a cache before but changed to not utilizing it based on mike's comments. Lets sync offline", "author": "fahadmohammed01", "createdAt": "2020-03-04T20:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwODM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MTk1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387941950", "bodyText": "Changed", "author": "fahadmohammed01", "createdAt": "2020-03-04T21:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwODM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwOTg5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387909890", "bodyText": "NIT: close() is blocking on waitDependerQuit(). maybe you should either: 1. make close() unblocking . 2. put d[i].close(); in a separate thread", "author": "ShirleyZheng92", "createdAt": "2020-03-04T20:15:23Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -460,30 +462,44 @@ public void shutdown() {\n      *\n      * @param timeoutSeconds Timeout in seconds\n      */\n+    @SuppressFBWarnings(value = \"RV_RETURN_VALUE_IGNORED\")\n     public void shutdown(int timeoutSeconds) {\n         if (broken) {\n             return;\n         }\n+        if (!isShutdownInitiated.compareAndSet(false, true)) {\n+            logger.info(\"Shutdown already initiated, returning...\");\n+            return;\n+        }\n         close(tlog);\n         try {\n             logger.atInfo().setEventType(\"system-shutdown\").addKeyValue(\"main\", getMain()).log();\n             EvergreenService[] d = orderedDependencies().toArray(new EvergreenService[0]);\n+            CountDownLatch allServicesExitedLatch = new CountDownLatch(d.length);\n+\n             for (int i = d.length; --i >= 0; ) { // shutdown in reverse order\n                 try {\n                     d[i].close();", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxMDcwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387910705", "bodyText": "waitForDependersToExit() is blocking, but requestStop() doesn't block until lifecycle exit. Maybe add a logic here to wait until lifecycle thread exit.", "author": "ShirleyZheng92", "createdAt": "2020-03-04T20:17:12Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -651,13 +652,17 @@ protected void shutdown() {\n \n     @Override\n     public void close() {\n-        requestStop();\n         Periodicity t = periodicityInformation;\n         if (t != null) {\n             t.shutdown();\n         }\n-\n-        closed.set(true);\n+        try {\n+            waitForDependersToExit();\n+        } catch (InterruptedException e) {\n+            logger.error(\"Interrupted waiting for dependers to exit\");\n+        }\n+        requestStop();\n+        isClosed.set(true);", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89a110561b38fd813b8a9522e4a3b80a030ee0a1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/89a110561b38fd813b8a9522e4a3b80a030ee0a1", "message": "reduce calls to find dependers", "committedDate": "2020-03-04T21:18:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxMzE1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387913158", "bodyText": "static final?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Logger log = LogManager.getLogger(LifecycleIPCAgent.class);\n          \n          \n            \n                private static final Logger log = LogManager.getLogger(LifecycleIPCAgent.class);", "author": "leaf94", "createdAt": "2020-03-04T20:22:31Z", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/lifecycle/LifecycleIPCAgent.java", "diffHunk": "@@ -40,6 +42,8 @@\n     @Inject\n     private ExecutorService executor;\n \n+    private Logger log = LogManager.getLogger(LifecycleIPCAgent.class);", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MTUwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387971506", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-03-04T22:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxMzE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxNDA0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387914042", "bodyText": "Could empty Optional cause a problem here?", "author": "leaf94", "createdAt": "2020-03-04T20:24:21Z", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/lifecycle/LifecycleIPCAgent.java", "diffHunk": "@@ -63,10 +67,12 @@ public void postInject() {\n      * @return response for setting state\n      */\n     public LifecycleGenericResponse reportState(StateChangeRequest stateChangeRequest, ConnectionContext context) {\n+\n         State s = State.valueOf(stateChangeRequest.getState());\n         Optional<EvergreenService> service =\n                 Optional.ofNullable(kernel.context.get(EvergreenService.class, context.getServiceName()));\n \n+        log.info(\"{} reported state : {}\", service.get().getName(), s);", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2MzE4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387963181", "bodyText": "good catch, moved to within the if block", "author": "fahadmohammed01", "createdAt": "2020-03-04T22:06:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxNDA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyODczMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387928730", "bodyText": "Good catch!", "author": "leaf94", "createdAt": "2020-03-04T20:55:13Z", "path": "src/test/java/com/aws/iot/evergreen/ipc/IPCAwareServicesTest.java", "diffHunk": "@@ -18,8 +18,6 @@\n \n     @BeforeEach\n     public void setup() {\n-        // starting daemon\n-        CountDownLatch OK = new CountDownLatch(1);", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzNzU2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387937566", "bodyText": "[Minor] This adds up to 120 seconds if failing... We could fail faster I guess?", "author": "leaf94", "createdAt": "2020-03-04T21:13:11Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/KernelShutdownTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.WhatHappened;\n+import com.aws.iot.evergreen.dependency.State;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class KernelShutdownTest {\n+\n+    private static Kernel kernel;\n+\n+    @BeforeEach\n+    public void setup() {\n+        kernel = new Kernel();\n+        String tdir = System.getProperty(\"user.dir\");\n+        kernel.parseArgs(\"-r\", tdir, \"-log\", \"stdout\", \"-i\", KernelShutdownTest.class.getResource(\"long_running_services.yaml\").toString());\n+        kernel.launch();\n+    }\n+\n+    @Test\n+    public void WHEN_kernel_shutdown_THEN_services_are_shutdown_in_reverse_dependecy_order() throws InterruptedException {\n+\n+        CountDownLatch mainRunningLatch = new CountDownLatch(1);\n+        kernel.getMain().getStateTopic().subscribe((WhatHappened what, Topic t) -> {\n+            if (((State) t.getOnce()).isRunning()) {\n+                mainRunningLatch.countDown();\n+            }\n+        });\n+        //wait for main to run\n+        assertTrue(mainRunningLatch.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown(60);", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NzQ0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387967446", "bodyText": "first assert fails if 60 seconds is breached. The test doesn't take long on the dev machine but when run on git hub it takes longer. Hence the 60 seconds intervals", "author": "fahadmohammed01", "createdAt": "2020-03-04T22:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzNzU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MDAzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387940037", "bodyText": "This gave me the impression of State machine's Terminal State definition and Errored and Finished technically are not.\nI think what we need here is something like isClosable ?", "author": "leaf94", "createdAt": "2020-03-04T21:18:34Z", "path": "src/main/java/com/aws/iot/evergreen/dependency/State.java", "diffHunk": "@@ -92,4 +92,8 @@ public boolean preceeds(State other) {\n     public boolean preceedsOrEqual(State other) {\n         return ordinal() <= other.ordinal();\n     }\n+\n+    public boolean isTerminalState() {\n+        return this.equals(ERRORED) || this.equals(BROKEN) || this.equals(FINISHED);\n+    }", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NDgwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387964802", "bodyText": "renamed to isClosable", "author": "fahadmohammed01", "createdAt": "2020-03-04T22:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MDAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MTY0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/91#discussion_r387941643", "bodyText": "Very well verified! \ud83d\udc4d", "author": "leaf94", "createdAt": "2020-03-04T21:21:49Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/KernelShutdownTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.WhatHappened;\n+import com.aws.iot.evergreen.dependency.State;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class KernelShutdownTest {\n+\n+    private static Kernel kernel;\n+\n+    @BeforeEach\n+    public void setup() {\n+        kernel = new Kernel();\n+        String tdir = System.getProperty(\"user.dir\");\n+        kernel.parseArgs(\"-r\", tdir, \"-log\", \"stdout\", \"-i\", KernelShutdownTest.class.getResource(\"long_running_services.yaml\").toString());\n+        kernel.launch();\n+    }\n+\n+    @Test\n+    public void WHEN_kernel_shutdown_THEN_services_are_shutdown_in_reverse_dependecy_order() throws InterruptedException {\n+\n+        CountDownLatch mainRunningLatch = new CountDownLatch(1);\n+        kernel.getMain().getStateTopic().subscribe((WhatHappened what, Topic t) -> {\n+            if (((State) t.getOnce()).isRunning()) {\n+                mainRunningLatch.countDown();\n+            }\n+        });\n+        //wait for main to run\n+        assertTrue(mainRunningLatch.await(60, TimeUnit.SECONDS));\n+        kernel.shutdown(60);\n+\n+        List<EvergreenService> genericExternalServices = kernel.orderedDependencies().stream()\n+                .filter(e -> e instanceof GenericExternalService).collect(Collectors.toList());\n+\n+        assertTrue(genericExternalServices.stream().allMatch(e -> e.getState().isTerminalState()));\n+\n+        //sorting genericExternalServices in descending order based on when they reached terminal state\n+        Collections.sort(genericExternalServices, (s1, s2) ->\n+                Long.compare(s1.getStateTopic().getModtime(), s1.getStateTopic().getModtime()));\n+\n+        // service should moved to terminal state based on dependency order\n+        assertEquals(\"main\", genericExternalServices.get(2).getName());\n+        assertEquals(\"sleeperA\", genericExternalServices.get(1).getName());\n+        assertEquals(\"sleeperB\", genericExternalServices.get(0).getName());", "originalCommit": "58dd58412d5f961815ea0b641b6d8929fbac81f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7251fe87cb49cf2d4f205686b35fe31ec8013fbc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7251fe87cb49cf2d4f205686b35fe31ec8013fbc", "message": "minor refactoring", "committedDate": "2020-03-04T22:12:18Z", "type": "commit"}]}