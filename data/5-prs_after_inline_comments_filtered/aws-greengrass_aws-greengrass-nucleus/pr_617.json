{"pr_number": 617, "pr_title": "Add deployment ids to configuration and update deferrals", "pr_createdAt": "2020-11-04T00:01:38Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/617", "timeline": [{"oid": "2232fcb6e4c4ad0f692b3a0a2571a4d38f1a6904", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2232fcb6e4c4ad0f692b3a0a2571a4d38f1a6904", "message": "Add deployment ids to configuration and update deferrals", "committedDate": "2020-11-04T00:49:29Z", "type": "forcePushed"}, {"oid": "e963cc3e65c5c8bece5477e0b966b43468155104", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e963cc3e65c5c8bece5477e0b966b43468155104", "message": "Add deployment ids to configuration and update deferrals", "committedDate": "2020-11-04T01:03:24Z", "type": "forcePushed"}, {"oid": "76ba44102ae33d650628b339603e9f93bbb344c9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/76ba44102ae33d650628b339603e9f93bbb344c9", "message": "Add deployment ids to configuration and update deferrals", "committedDate": "2020-11-04T02:37:09Z", "type": "forcePushed"}, {"oid": "da0aac1c2a99cea1c45f905c4106fc7ea500d017", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da0aac1c2a99cea1c45f905c4106fc7ea500d017", "message": "Add deployment ids to configuration and update deferrals", "committedDate": "2020-11-04T19:19:35Z", "type": "commit"}, {"oid": "da0aac1c2a99cea1c45f905c4106fc7ea500d017", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da0aac1c2a99cea1c45f905c4106fc7ea500d017", "message": "Add deployment ids to configuration and update deferrals", "committedDate": "2020-11-04T19:19:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcyODkwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/617#discussion_r517728904", "bodyText": "Can we add a test where client does not specify deploymentId", "author": "abanthiy", "createdAt": "2020-11-05T01:30:04Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/ipc/IPCServicesTest.java", "diffHunk": "@@ -261,6 +261,7 @@ public void onStreamEvent(ValidateConfigurationUpdateEvents events) {\n                                     new SendConfigurationValidityReportRequest();\n                             ConfigurationValidityReport report = new ConfigurationValidityReport();\n                             report.setStatus(ConfigurationValidityStatus.ACCEPTED);\n+                            report.setDeploymentId(events.getValidateConfigurationUpdateEvent().getDeploymentId());", "originalCommit": "da0aac1c2a99cea1c45f905c4106fc7ea500d017", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzczNTUzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/617#discussion_r517735533", "bodyText": "Tried it, nothing happens. The handler is invoked with a null deployment ID which it won't find, so it ought send back an error that it couldn't find the validation request", "author": "MikeDombo", "createdAt": "2020-11-05T01:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcyODkwNA=="}], "type": "inlineReview"}, {"oid": "13383ba7da33f4644c3f762287efe04a6ea172e9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13383ba7da33f4644c3f762287efe04a6ea172e9", "message": "Add test to validate validation", "committedDate": "2020-11-05T03:35:23Z", "type": "forcePushed"}, {"oid": "2272d940f12276707c317b66012ae0051292d138", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2272d940f12276707c317b66012ae0051292d138", "message": "Add test to validate validation", "committedDate": "2020-11-05T03:35:54Z", "type": "forcePushed"}, {"oid": "1cce3dfd943968f665da3773f2e4204e9ad301e5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1cce3dfd943968f665da3773f2e4204e9ad301e5", "message": "Add test to validate validation", "committedDate": "2020-11-05T03:47:56Z", "type": "forcePushed"}, {"oid": "22c7ce684c91d0cf9e01cb2d0fb89ddb4e28832a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/22c7ce684c91d0cf9e01cb2d0fb89ddb4e28832a", "message": "Add test to validate validation", "committedDate": "2020-11-05T04:00:22Z", "type": "commit"}, {"oid": "22c7ce684c91d0cf9e01cb2d0fb89ddb4e28832a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/22c7ce684c91d0cf9e01cb2d0fb89ddb4e28832a", "message": "Add test to validate validation", "committedDate": "2020-11-05T04:00:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2ODA2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/617#discussion_r518268066", "bodyText": "Do we need this check here ? This should be handled at handleRequest() L206", "author": "fahadmohammed01", "createdAt": "2020-11-05T18:22:40Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateSystemSafelyService.java", "diffHunk": "@@ -211,13 +214,17 @@ private long getTimeToReCheck(long timeout, List<Future<DeferUpdateRequest>> def\n                 if (fut.isDone()) {\n                     try {\n                         DeferUpdateRequest deferRequest = fut.get();\n-                        long timeToRecheck = currentTimeMillis + deferRequest.getRecheckTimeInMs();\n-                        if (timeToRecheck > maxTimeToReCheck) {\n-                            maxTimeToReCheck = timeToRecheck;\n-                            logger.atInfo().setEventType(\"service-update-deferred\")\n-                                    .log(\"deferred for {} millis with message {}\",\n-                                            deferRequest.getRecheckTimeInMs(),\n-                                            deferRequest.getMessage());\n+                        if (deploymentId.equals(deferRequest.getDeploymentId())) {", "originalCommit": "22c7ce684c91d0cf9e01cb2d0fb89ddb4e28832a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2OTE5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/617#discussion_r518269199", "bodyText": "Handle request already found it, but now we need to make sure that the DeferUpdateRequest object is for the request that we're actually processing, otherwise this change will have done nothing and it will still defer some random request.", "author": "MikeDombo", "createdAt": "2020-11-05T18:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2ODA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3MzE0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/617#discussion_r518273140", "bodyText": "The futures for the previous deployments are cleared before sending out a PreComponentUpdateEvent.", "author": "fahadmohammed01", "createdAt": "2020-11-05T18:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2ODA2Ng=="}], "type": "inlineReview"}]}