{"pr_number": 327, "pr_title": "Service multi-instance support", "pr_createdAt": "2020-07-23T22:56:27Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327", "timeline": [{"oid": "b2d6eb69098045c87a5277a9024d37321c385d58", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b2d6eb69098045c87a5277a9024d37321c385d58", "message": "Initial multi instance support", "committedDate": "2020-07-23T23:05:40Z", "type": "forcePushed"}, {"oid": "e81befa30d7ab46479f4828741c316d18475d7a7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e81befa30d7ab46479f4828741c316d18475d7a7", "message": "Initial multi instance support", "committedDate": "2020-07-23T23:19:35Z", "type": "forcePushed"}, {"oid": "a337f6efe81b6f2cb0fc650796124fdbffef24ba", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a337f6efe81b6f2cb0fc650796124fdbffef24ba", "message": "Initial multi instance support", "committedDate": "2020-07-23T23:21:49Z", "type": "forcePushed"}, {"oid": "b5521e7b3b19fd6219275ea1b7d47a00e93ca4f2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5521e7b3b19fd6219275ea1b7d47a00e93ca4f2", "message": "Initial multi instance support", "committedDate": "2020-07-23T23:28:00Z", "type": "forcePushed"}, {"oid": "37e56f2623ae13e2f13204af2c7c8552af75817b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/37e56f2623ae13e2f13204af2c7c8552af75817b", "message": "Fix existing tests", "committedDate": "2020-07-23T23:54:13Z", "type": "forcePushed"}, {"oid": "a682f9c5ec1146f8ad9526db57ac11e5205e20a5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a682f9c5ec1146f8ad9526db57ac11e5205e20a5", "message": "Fix existing tests", "committedDate": "2020-07-24T00:09:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNDg1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460224853", "bodyText": "update the map instances?", "author": "hui-yang", "createdAt": "2020-07-24T18:39:11Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public abstract class MultiInstanceEvergreenService extends EvergreenService {\n+    protected static final int BASE_INSTANCE_ID = 0;\n+    public static final String INSTANCES_NAMESPACE_KEY = \"instances\";\n+    private AtomicInteger lastInstanceId;\n+    @Getter\n+    private final int instanceId;\n+    private Map<Integer, MultiInstanceEvergreenService> instances;\n+\n+    MultiInstanceEvergreenService(Topics topics, int instanceId) {\n+        super(topics);\n+        this.instanceId = instanceId;\n+\n+        // Only allocate these objects when they're needed, which is when this is the base instance\n+        if (instanceId == BASE_INSTANCE_ID) {\n+            lastInstanceId = new AtomicInteger(BASE_INSTANCE_ID);\n+            instances = new ConcurrentHashMap<>();\n+        }", "originalCommit": "a682f9c5ec1146f8ad9526db57ac11e5205e20a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzNDc5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460234790", "bodyText": "Not sure what you mean.", "author": "MikeDombo", "createdAt": "2020-07-24T19:00:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNDg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzOTI2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460239268", "bodyText": "The comment's outdated. Noticed it's updated in createInstance", "author": "hui-yang", "createdAt": "2020-07-24T19:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNDg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNTU4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460225584", "bodyText": "When to call MultiInstanceEvergreenService or createNewInstance? should this constructor be protected?", "author": "hui-yang", "createdAt": "2020-07-24T18:40:39Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public abstract class MultiInstanceEvergreenService extends EvergreenService {\n+    protected static final int BASE_INSTANCE_ID = 0;\n+    public static final String INSTANCES_NAMESPACE_KEY = \"instances\";\n+    private AtomicInteger lastInstanceId;\n+    @Getter\n+    private final int instanceId;\n+    private Map<Integer, MultiInstanceEvergreenService> instances;\n+\n+    MultiInstanceEvergreenService(Topics topics, int instanceId) {", "originalCommit": "a682f9c5ec1146f8ad9526db57ac11e5205e20a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzNDcwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460234707", "bodyText": "It shouldn't be called which is why it is package-private, but I need it available for unit testing.", "author": "MikeDombo", "createdAt": "2020-07-24T19:00:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNTU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNzY2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460227668", "bodyText": "If the keys are incremental integers, why not using list?", "author": "hui-yang", "createdAt": "2020-07-24T18:45:23Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public abstract class MultiInstanceEvergreenService extends EvergreenService {\n+    protected static final int BASE_INSTANCE_ID = 0;\n+    public static final String INSTANCES_NAMESPACE_KEY = \"instances\";\n+    private AtomicInteger lastInstanceId;\n+    @Getter\n+    private final int instanceId;\n+    private Map<Integer, MultiInstanceEvergreenService> instances;", "originalCommit": "a682f9c5ec1146f8ad9526db57ac11e5205e20a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMjkyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460232921", "bodyText": "Because a user can remove an instance at any time, so we can end up with holes, and a list will shift the elements to fill the holes which would screw up our indexing.", "author": "MikeDombo", "createdAt": "2020-07-24T18:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNzY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzODY0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460238642", "bodyText": "Is this a map for all instances but the base one?", "author": "hui-yang", "createdAt": "2020-07-24T19:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNzY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzOTM1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460239358", "bodyText": "Yes, that's right", "author": "MikeDombo", "createdAt": "2020-07-24T19:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNzY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMDE2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460230168", "bodyText": "Should check BASE_INSTANCE_ID here as well as in removeInstance/putDependenciesIntoSet?", "author": "hui-yang", "createdAt": "2020-07-24T18:50:54Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public abstract class MultiInstanceEvergreenService extends EvergreenService {\n+    protected static final int BASE_INSTANCE_ID = 0;\n+    public static final String INSTANCES_NAMESPACE_KEY = \"instances\";\n+    private AtomicInteger lastInstanceId;\n+    @Getter\n+    private final int instanceId;\n+    private Map<Integer, MultiInstanceEvergreenService> instances;\n+\n+    MultiInstanceEvergreenService(Topics topics, int instanceId) {\n+        super(topics);\n+        this.instanceId = instanceId;\n+\n+        // Only allocate these objects when they're needed, which is when this is the base instance\n+        if (instanceId == BASE_INSTANCE_ID) {\n+            lastInstanceId = new AtomicInteger(BASE_INSTANCE_ID);\n+            instances = new ConcurrentHashMap<>();\n+        }\n+        logger.dfltKv(\"serviceInstance\", String.valueOf(instanceId));\n+    }\n+\n+    /**\n+     * Create a new sub-instance of this service. Must be called on the \"base\" service instance.\n+     *\n+     * @return the newly created instance\n+     * @throws ServiceLoadException thrown if not called on the base instance, or if constructing the new instance\n+     *                              fails\n+     */\n+    public MultiInstanceEvergreenService createNewInstance() throws ServiceLoadException {\n+        if (instanceId != BASE_INSTANCE_ID) {\n+            throw new ServiceLoadException(\"New instances may only be created from the base instance\");\n+        }\n+        try {\n+            return getClass().getConstructor(Topics.class, int.class)\n+                    .newInstance(config, lastInstanceId.incrementAndGet());\n+        } catch (NoSuchMethodException | InstantiationException\n+                | IllegalAccessException | InvocationTargetException e) {\n+            throw new ServiceLoadException(\"Unable to create new instance of \" + getClass().getName(), e);\n+        }\n+    }\n+\n+    /**\n+     * Get an instance by ID.\n+     *\n+     * @param instanceId ID to lookup\n+     * @return instance or null if not found\n+     */\n+    @Nullable\n+    public MultiInstanceEvergreenService getInstance(int instanceId) {\n+        if (instances == null) {\n+            return null;", "originalCommit": "a682f9c5ec1146f8ad9526db57ac11e5205e20a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMzE0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460233142", "bodyText": "Not any point. The instances == null check is equivalent because it is only non-null for the base instance.", "author": "MikeDombo", "createdAt": "2020-07-24T18:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMDE2OA=="}], "type": "inlineReview"}, {"oid": "c9bba7e9e3cad7c02bd7a46b59c5af718bf31cbb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c9bba7e9e3cad7c02bd7a46b59c5af718bf31cbb", "message": "Fix multiinstance construction, add tests", "committedDate": "2020-07-24T18:59:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0MTc0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460341742", "bodyText": "Are there side effects of keeping state topic(and the rest of the private topics) in the runtime namespace? If Service A is listening to runtime config changes for Service B (serving the shared config requirement), it will get notified when state topic changes when it shouldn't, there is a way to filter those notifications in the IPC agent layer, but scattering this logic upto there doesn't sound like a good idea to me", "author": "shaguptashaikh", "createdAt": "2020-07-25T00:42:43Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -123,10 +123,11 @@\n      *\n      * @param evergreenService service that this is the lifecycle for\n      * @param logger           service's logger\n+     * @param topics           config namespace for storing the state topic\n      */\n-    public Lifecycle(EvergreenService evergreenService, Logger logger) {\n+    public Lifecycle(EvergreenService evergreenService, Logger logger, Topics topics) {\n         this.evergreenService = evergreenService;\n-        this.stateTopic = initStateTopic(evergreenService.getConfig());\n+        this.stateTopic = initStateTopic(topics);", "originalCommit": "049198e507791f7f0c9ddfb79e196b7c1568b6c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0MTk2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460341967", "bodyText": "The changes won't bubble up because the state topic is set to not notify the parent. Anything else private (which the only other thing is the auth token), is also set to not notify the parent of changes.", "author": "MikeDombo", "createdAt": "2020-07-25T00:44:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0MTc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM1MDk1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460350951", "bodyText": "I can create a new namespace for private stuff outside of runtime if you think that's better.", "author": "MikeDombo", "createdAt": "2020-07-25T02:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0MTc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0MzU3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460343573", "bodyText": "This logic really doesn't belong here, it should logically be inside the context get() and injectField() methods", "author": "shaguptashaikh", "createdAt": "2020-07-25T00:55:27Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public class MultiInstanceEvergreenService extends EvergreenService {\n+    protected static final int BASE_INSTANCE_ID = 0;\n+    public static final String INSTANCES_NAMESPACE_KEY = \"instances\";\n+    protected AtomicInteger lastInstanceId;\n+    @Getter\n+    private final int instanceId;\n+    private Map<Integer, MultiInstanceEvergreenService> instances;\n+\n+    MultiInstanceEvergreenService(Topics topics, int instanceId) {\n+        super(topics, topics.lookupTopics(RUNTIME_STORE_NAMESPACE_TOPIC, INSTANCES_NAMESPACE_KEY,\n+                String.valueOf(instanceId)));\n+        this.instanceId = instanceId;\n+\n+        // Only allocate these objects when they're needed, which is when this is the base instance\n+        if (instanceId == BASE_INSTANCE_ID) {\n+            lastInstanceId = new AtomicInteger(BASE_INSTANCE_ID);\n+            instances = new ConcurrentHashMap<>();\n+        }\n+        logger.dfltKv(\"serviceInstance\", String.valueOf(instanceId));\n+    }\n+\n+    /**\n+     * Create a new sub-instance of this service. Must be called on the \"base\" service instance. Subclasses can choose\n+     * to override this method if they have a different constructor than just {@link Topics} and {@code int}.\n+     *\n+     * @return the newly created instance\n+     * @throws ServiceLoadException thrown if not called on the base instance, or if constructing the new instance\n+     *                              fails\n+     */\n+    public MultiInstanceEvergreenService createNewInstance() throws ServiceLoadException {\n+        if (instanceId != BASE_INSTANCE_ID) {\n+            throw new ServiceLoadException(\"New instances may only be created from the base instance\");\n+        }\n+        try {\n+            int id = lastInstanceId.incrementAndGet();\n+            Constructor<? extends MultiInstanceEvergreenService> constructor =\n+                    getClass().getDeclaredConstructor(Topics.class, int.class);\n+            constructor.setAccessible(true);\n+            MultiInstanceEvergreenService newService = constructor.newInstance(config, id);\n+            context.injectFields(newService);", "originalCommit": "049198e507791f7f0c9ddfb79e196b7c1568b6c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0MzgxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460343810", "bodyText": "context can't do this because it doesn't know what to construct or what ID to use. This class is a special case and its logic shouldn't affect the context or anything else, as much as possible anyway. Additionally, we don't use context because I don't want the result to be stored in the context as that is just another thing that needs to be properly cleaned up when stopping/closing an instance of a service.", "author": "MikeDombo", "createdAt": "2020-07-25T00:57:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0MzU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0NDIzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460344232", "bodyText": "Do you need a utility method to return a list/set of all instances of an object of this class, currently the lambda manager will need to keep track of instances on its own when calling createNewInstance()", "author": "shaguptashaikh", "createdAt": "2020-07-25T01:00:38Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public class MultiInstanceEvergreenService extends EvergreenService {\n+    protected static final int BASE_INSTANCE_ID = 0;\n+    public static final String INSTANCES_NAMESPACE_KEY = \"instances\";\n+    protected AtomicInteger lastInstanceId;\n+    @Getter\n+    private final int instanceId;\n+    private Map<Integer, MultiInstanceEvergreenService> instances;\n+\n+    MultiInstanceEvergreenService(Topics topics, int instanceId) {\n+        super(topics, topics.lookupTopics(RUNTIME_STORE_NAMESPACE_TOPIC, INSTANCES_NAMESPACE_KEY,\n+                String.valueOf(instanceId)));\n+        this.instanceId = instanceId;\n+\n+        // Only allocate these objects when they're needed, which is when this is the base instance\n+        if (instanceId == BASE_INSTANCE_ID) {\n+            lastInstanceId = new AtomicInteger(BASE_INSTANCE_ID);\n+            instances = new ConcurrentHashMap<>();\n+        }\n+        logger.dfltKv(\"serviceInstance\", String.valueOf(instanceId));\n+    }\n+\n+    /**\n+     * Create a new sub-instance of this service. Must be called on the \"base\" service instance. Subclasses can choose\n+     * to override this method if they have a different constructor than just {@link Topics} and {@code int}.\n+     *\n+     * @return the newly created instance\n+     * @throws ServiceLoadException thrown if not called on the base instance, or if constructing the new instance\n+     *                              fails\n+     */\n+    public MultiInstanceEvergreenService createNewInstance() throws ServiceLoadException {", "originalCommit": "049198e507791f7f0c9ddfb79e196b7c1568b6c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0NDMwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460344308", "bodyText": "Not currently, though it wouldn't be hard to add given that we are keeping a map of all the instances.", "author": "MikeDombo", "createdAt": "2020-07-25T01:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM0NDIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4NzQ5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460987491", "bodyText": "Do you need to add a test case for remove instances as well?", "author": "fengwang666", "createdAt": "2020-07-27T15:45:40Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -248,4 +249,34 @@ void GIVEN_running_service_WHEN_setenv_config_changes_THEN_service_restarts() th\n \n         assertTrue(serviceRestarted.await(5, TimeUnit.SECONDS));\n     }\n+\n+    @Test\n+    void GIVEN_running_service_WHEN_createNewInstance_THEN_service_has_new_instance() throws Exception {\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"service_with_dynamic_config.yaml\").toString());\n+        CountDownLatch mainRunning = new CountDownLatch(1);\n+        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"main\") && newState.equals(State.RUNNING)) {\n+                mainRunning.countDown();\n+            }\n+        });\n+        kernel.launch();\n+\n+        assertTrue(mainRunning.await(5, TimeUnit.SECONDS));\n+\n+        GenericExternalService service = (GenericExternalService) kernel.locate(\"service_with_dynamic_config\");\n+        assertEquals(State.RUNNING, service.getState());\n+\n+        CountDownLatch clonedServiceRunning = new CountDownLatch(1);\n+        kernel.getContext().addGlobalStateChangeListener((serviceToListenTo, oldState, newState) -> {\n+            if (\"service_with_dynamic_config-1\".equals(serviceToListenTo.getName()) && State.RUNNING.equals(newState)) {\n+                clonedServiceRunning.countDown();\n+            }\n+        });\n+\n+        MultiInstanceEvergreenService clonedService = service.createNewInstance();", "originalCommit": "049198e507791f7f0c9ddfb79e196b7c1568b6c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwOTU4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461009588", "bodyText": "Remove is unit tested and given that all it is doing is removing it from the map, it doesn't seem necessary at all.", "author": "MikeDombo", "createdAt": "2020-07-27T16:19:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4NzQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4ODA5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r460988090", "bodyText": "What needs to be revisited?", "author": "fengwang666", "createdAt": "2020-07-27T15:46:36Z", "path": "src/main/java/com/aws/iot/evergreen/dependency/Context.java", "diffHunk": "@@ -300,6 +300,97 @@ private boolean onPublishThread() {\n         return Thread.currentThread() == publishThread;\n     }\n \n+    /**\n+     * Use to manually inject dependencies into the fields of a class using the values in the\n+     * current Context. Use with caution because you should not inject fields into a class multiple times\n+     * as it will trigger the pre and post lifecycle methods each time.\n+     *\n+     * @param object Object to inject fields into\n+     */\n+    @SuppressFBWarnings(\"DP_DO_INSIDE_DO_PRIVILEGED\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingThrowable\"})\n+    public void injectFields(Object object) {\n+        // TODO Revisit this method.", "originalCommit": "049198e507791f7f0c9ddfb79e196b7c1568b6c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwODMzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461008336", "bodyText": "Not sure, this was just moved as-is from the inside of the Value class", "author": "MikeDombo", "createdAt": "2020-07-27T16:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4ODA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzMTM3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461231372", "bodyText": "I added the revisit TODO - Other methods were revisited/refactored except this one was from james' original prototype stage...\nWhy are we moving it out to Context? Any method needs to call from Context?", "author": "leaf94", "createdAt": "2020-07-27T23:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4ODA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzNDQ4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461234482", "bodyText": "We need it in the lambda manager to create new instances of the service. Each instances has fields which need to get injected.", "author": "MikeDombo", "createdAt": "2020-07-27T23:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4ODA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzODc1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461238752", "bodyText": "I imagine that we could add a new method like context.getNewInstance(ObjectA.class) to provide prototype injection, over the current singleton injection capability.\nI bet you need the power of injectFields but I still think it's better to keep the InjectFields private since it mutates the object internals with reflections. Exposing this as a public method seems very dangerous...", "author": "leaf94", "createdAt": "2020-07-28T00:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4ODA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI0MDI0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461240241", "bodyText": "Can't do it because I need to give the constructor extra parameters that the context won't have.", "author": "MikeDombo", "createdAt": "2020-07-28T00:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4ODA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwMDYyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461000622", "bodyText": "Does this mean, for non-pinned lambdas, there will be always at least one service instance running? How would the base instance get started? Similar to other components?\nAlso, it's a bit wasteful if at least one instance of the non-pinned lambdas are always running. It kinda defeats the purpose of having non-pinned lambdas.", "author": "fengwang666", "createdAt": "2020-07-27T16:05:19Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public class MultiInstanceEvergreenService extends EvergreenService {", "originalCommit": "049198e507791f7f0c9ddfb79e196b7c1568b6c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwODY0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461008646", "bodyText": "No, if you don't want a service to run, then just requestStop.", "author": "MikeDombo", "createdAt": "2020-07-27T16:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwMDYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3OTgwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461079805", "bodyText": "As discussed offline this is still an issue, will resolve in follow-up PR.", "author": "MikeDombo", "createdAt": "2020-07-27T18:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwMDYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1NzA4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461057085", "bodyText": "Curious how does lifecycle work for the child instances?", "author": "ShirleyZheng92", "createdAt": "2020-07-27T17:36:59Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public class MultiInstanceEvergreenService extends EvergreenService {\n+    protected static final int BASE_INSTANCE_ID = 0;", "originalCommit": "049198e507791f7f0c9ddfb79e196b7c1568b6c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1NzgxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461057817", "bodyText": "Is it that all service instances share the same root topics ( and state topic) ?", "author": "ShirleyZheng92", "createdAt": "2020-07-27T17:38:21Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/MultiInstanceEvergreenService.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n+import lombok.Getter;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.annotation.Nullable;\n+\n+public class MultiInstanceEvergreenService extends EvergreenService {\n+    protected static final int BASE_INSTANCE_ID = 0;\n+    public static final String INSTANCES_NAMESPACE_KEY = \"instances\";\n+    protected AtomicInteger lastInstanceId;\n+    @Getter\n+    private final int instanceId;\n+    private Map<Integer, MultiInstanceEvergreenService> instances;\n+\n+    MultiInstanceEvergreenService(Topics topics, int instanceId) {\n+        super(topics, topics.lookupTopics(RUNTIME_STORE_NAMESPACE_TOPIC, INSTANCES_NAMESPACE_KEY,\n+                String.valueOf(instanceId)));", "originalCommit": "049198e507791f7f0c9ddfb79e196b7c1568b6c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f67c5c1ebe9c08113f80baca006b091ab0de11c0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f67c5c1ebe9c08113f80baca006b091ab0de11c0", "message": "Change runtime to private, move multi-instance out of kernel", "committedDate": "2020-07-27T18:12:37Z", "type": "forcePushed"}, {"oid": "e1548172bd213adaf9cc4a64e9dda0a2efb27fa7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e1548172bd213adaf9cc4a64e9dda0a2efb27fa7", "message": "Initial multi instance support", "committedDate": "2020-07-27T19:19:42Z", "type": "commit"}, {"oid": "af7c90bd31545bad04638712d088f471beae9fe4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/af7c90bd31545bad04638712d088f471beae9fe4", "message": "Fix existing tests", "committedDate": "2020-07-27T19:19:42Z", "type": "commit"}, {"oid": "19ea6f9ad04d145b2ee6b04f8368e77ec55bce6b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19ea6f9ad04d145b2ee6b04f8368e77ec55bce6b", "message": "Fix multiinstance construction, add tests", "committedDate": "2020-07-27T19:19:42Z", "type": "commit"}, {"oid": "070054fd001c5b7c5c5630bda13bc1a3bd0556f9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/070054fd001c5b7c5c5630bda13bc1a3bd0556f9", "message": "Change runtime to private, move multi-instance out of kernel", "committedDate": "2020-07-27T19:19:42Z", "type": "commit"}, {"oid": "070054fd001c5b7c5c5630bda13bc1a3bd0556f9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/070054fd001c5b7c5c5630bda13bc1a3bd0556f9", "message": "Change runtime to private, move multi-instance out of kernel", "committedDate": "2020-07-27T19:19:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0MTk0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461141942", "bodyText": "lifecycle can get privateConfig from EvergreenService.getPrivateConfig(), probably no need to pass everything around", "author": "ShirleyZheng92", "createdAt": "2020-07-27T20:13:14Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -68,27 +70,37 @@\n     // Service logger instance\n     protected final Logger logger;\n \n-\n     /**\n      * Constructor for EvergreenService.\n      *\n      * @param topics root Configuration topic for this service\n      */\n     public EvergreenService(Topics topics) {\n+        this(topics, topics.lookupTopics(PRIVATE_STORE_NAMESPACE_TOPIC));\n+    }\n+\n+    /**\n+     * Constructor for EvergreenService.\n+     *\n+     * @param topics        root Configuration topic for this service\n+     * @param privateConfig root configuration topic for the service's private config which must not be shared\n+     */\n+    public EvergreenService(Topics topics, Topics privateConfig) {\n         this.config = topics;\n+        this.privateConfig = privateConfig;\n         this.context = topics.getContext();\n \n         // TODO: Validate syntax for lifecycle keywords and fail early\n         // skipif will require validation for onpath/exists etc. keywords\n \n-        this.logger = LogManager.getLogger(getName());\n-        logger.dfltKv(SERVICE_NAME_KEY, getName());\n+        this.logger = LogManager.getLogger(getServiceName()).createChild();\n+        logger.dfltKv(SERVICE_NAME_KEY, getServiceName());\n         logger.dfltKv(CURRENT_STATE_METRIC_NAME, (Supplier<State>) this::getState);\n \n         this.externalDependenciesTopic =\n                 topics.createLeafChild(SERVICE_DEPENDENCIES_NAMESPACE_TOPIC).dflt(new ArrayList<String>());\n         this.externalDependenciesTopic.withParentNeedsToKnow(false);\n-        this.lifecycle = new Lifecycle(this, logger);\n+        this.lifecycle = new Lifecycle(this, logger, privateConfig);", "originalCommit": "070054fd001c5b7c5c5630bda13bc1a3bd0556f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NTE3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461145178", "bodyText": "shouldn't this be private store topic?", "author": "ShirleyZheng92", "createdAt": "2020-07-27T20:19:36Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -41,7 +41,7 @@ void GIVEN_a_config_WHEN_constructor_is_called_THEN_service_is_initialized() {\n         // THEN\n         // verify config\n         Assertions.assertSame(config, evergreenService.config);\n-        Mockito.verify(config).createLeafChild(STATE_TOPIC_NAME);\n+        Mockito.verify(runtimeStoreTopic).createLeafChild(STATE_TOPIC_NAME);", "originalCommit": "070054fd001c5b7c5c5630bda13bc1a3bd0556f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NjEwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461146103", "bodyText": "In  EvergreenService you initialize this.lifecycle = new Lifecycle(this, logger, privateConfig);", "author": "ShirleyZheng92", "createdAt": "2020-07-27T20:21:08Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/LifecycleTest.java", "diffHunk": "@@ -111,7 +113,7 @@ void stop() throws IOException {\n \n     @Test\n     public void GIVEN_state_new_WHEN_requestStart_called_THEN_install_invoked() throws InterruptedException {\n-        lifecycle = new Lifecycle(evergreenService, logger);\n+        lifecycle = new Lifecycle(evergreenService, logger, evergreenService.getRuntimeConfig());", "originalCommit": "070054fd001c5b7c5c5630bda13bc1a3bd0556f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ba8b5b172f3957478427c1f2f8cf1a85e8bbae45", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba8b5b172f3957478427c1f2f8cf1a85e8bbae45", "message": "Update merge behavior for private to be merged", "committedDate": "2020-07-27T20:34:12Z", "type": "forcePushed"}, {"oid": "56bf227e33e5fd44b1d28eddf16627810a5c94bd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/56bf227e33e5fd44b1d28eddf16627810a5c94bd", "message": "Update merge behavior for private to be merged", "committedDate": "2020-07-27T20:36:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1Nzc4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461157788", "bodyText": "NIT: i know tests can pass, but it'll be confusing later. Can you update this to privateConfigTopics?", "author": "ShirleyZheng92", "createdAt": "2020-07-27T20:43:06Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/ShellRunnerTest.java", "diffHunk": "@@ -41,9 +43,15 @@\n     void beforeEach() {\n         Topics config = initializeMockedConfig();\n         Topics serviceRuntimeTopics = mock(Topics.class);\n+        Topic mockTopic = mock(Topic.class);\n \n-        when(config.lookupTopics(EvergreenService.RUNTIME_STORE_NAMESPACE_TOPIC)).thenReturn(serviceRuntimeTopics);\n+        when(config.lookupTopics(EvergreenService.PRIVATE_STORE_NAMESPACE_TOPIC)).thenReturn(serviceRuntimeTopics);\n         when(serviceRuntimeTopics.findLeafChild(SERVICE_UNIQUE_ID_KEY)).thenReturn(uniqueId);", "originalCommit": "56bf227e33e5fd44b1d28eddf16627810a5c94bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2803f39be07bea18c4d9b65526ac12e84c7d0a51", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2803f39be07bea18c4d9b65526ac12e84c7d0a51", "message": "Update merge behavior for private to be merged", "committedDate": "2020-07-27T20:47:40Z", "type": "commit"}, {"oid": "2803f39be07bea18c4d9b65526ac12e84c7d0a51", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2803f39be07bea18c4d9b65526ac12e84c7d0a51", "message": "Update merge behavior for private to be merged", "committedDate": "2020-07-27T20:47:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5MTYzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461191630", "bodyText": "For lack of documentation elsewhere, update the comment at the top of this method to reflect the changes.", "author": "abanthiy", "createdAt": "2020-07-27T21:51:37Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -289,13 +289,17 @@ private static UpdateBehaviorTree createDeploymentMergeBehavior() {\n                 new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.REPLACE);\n         UpdateBehaviorTree serviceRuntimeMergeBehavior =\n                 new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.MERGE);\n+        UpdateBehaviorTree servicePrivateMergeBehavior =\n+                new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.MERGE);\n \n         rootMergeBehavior.getChildOverride().put(SERVICES_NAMESPACE_TOPIC, servicesMergeBehavior);\n         servicesMergeBehavior.getChildOverride().put(UpdateBehaviorTree.WILDCARD, insideServiceMergeBehavior);\n         servicesMergeBehavior.getChildOverride().put(AUTH_TOKEN_LOOKUP_KEY,\n                 new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.MERGE));\n         insideServiceMergeBehavior.getChildOverride().put(\n                 EvergreenService.RUNTIME_STORE_NAMESPACE_TOPIC, serviceRuntimeMergeBehavior);\n+        insideServiceMergeBehavior.getChildOverride().put(\n+                EvergreenService.PRIVATE_STORE_NAMESPACE_TOPIC, servicePrivateMergeBehavior);", "originalCommit": "2803f39be07bea18c4d9b65526ac12e84c7d0a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5ODM2Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461198367", "bodyText": "Updated", "author": "MikeDombo", "createdAt": "2020-07-27T22:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5MTYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTUwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461195509", "bodyText": "I believe this will be used for creating the 'main' instance of the service. Update the comments to highlight the same if it makes sense.", "author": "abanthiy", "createdAt": "2020-07-27T22:00:28Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -68,27 +70,37 @@\n     // Service logger instance\n     protected final Logger logger;\n \n-\n     /**\n      * Constructor for EvergreenService.\n      *\n      * @param topics root Configuration topic for this service\n      */\n     public EvergreenService(Topics topics) {\n+        this(topics, topics.lookupTopics(PRIVATE_STORE_NAMESPACE_TOPIC));", "originalCommit": "2803f39be07bea18c4d9b65526ac12e84c7d0a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5ODY0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461198641", "bodyText": "Yes and no. I moved the multi-instance stuff out of the kernel, so in theory the kernel has no knowledge about multiple instances, so I'd not necessarily want to update the comment to reflect something that the kernel doesn't actually do.", "author": "MikeDombo", "createdAt": "2020-07-27T22:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTg0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461195840", "bodyText": "Would it be better to call it instanceConfig?\nThat's what I understand this is being used to facilitate.", "author": "abanthiy", "createdAt": "2020-07-27T22:01:14Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -68,27 +70,37 @@\n     // Service logger instance\n     protected final Logger logger;\n \n-\n     /**\n      * Constructor for EvergreenService.\n      *\n      * @param topics root Configuration topic for this service\n      */\n     public EvergreenService(Topics topics) {\n+        this(topics, topics.lookupTopics(PRIVATE_STORE_NAMESPACE_TOPIC));\n+    }\n+\n+    /**\n+     * Constructor for EvergreenService.\n+     *\n+     * @param topics        root Configuration topic for this service\n+     * @param privateConfig root configuration topic for the service's private config which must not be shared\n+     */\n+    public EvergreenService(Topics topics, Topics privateConfig) {", "originalCommit": "2803f39be07bea18c4d9b65526ac12e84c7d0a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5ODgxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461198819", "bodyText": "Likewise here, kernel doesn't actually know about instances in theory. I can update it you think that makes more sense.", "author": "MikeDombo", "createdAt": "2020-07-27T22:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyNjczOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461226738", "bodyText": "If kernel does not know then why such a constructor? What is privateConfig from kernel perspective and how is it different from topics?", "author": "abanthiy", "createdAt": "2020-07-27T23:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyNzY0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461227648", "bodyText": "\"Why such a constructor\" because there's no other way to do this given the way Java constructs classes.\nIdeally this change wouldn't have been necessary, but it was. So, I think that \"privateConfig\" is more clear that these topics are entirely private vs. \"instanceConfig\" which brings in an idea which is outside of the kernel.\nThe primary use for the private config is that that is where the state topic is stored for the Lifecycle class.", "author": "MikeDombo", "createdAt": "2020-07-27T23:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzMzIxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461233212", "bodyText": "Could privateConfig store things other than the data for instanceConfig?", "author": "leaf94", "createdAt": "2020-07-27T23:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzNTAyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/327#discussion_r461235024", "bodyText": "It should store anything that can't be shared between 2 instances of the same service, which I'm considering private in the kernel.", "author": "MikeDombo", "createdAt": "2020-07-27T23:51:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTg0MA=="}], "type": "inlineReview"}]}