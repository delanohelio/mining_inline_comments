{"pr_number": 6155, "pr_title": "Hide units to place collapsible panel during placement", "pr_createdAt": "2020-04-07T07:35:27Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6155", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5OTE4NQ==", "url": "https://github.com/triplea-game/triplea/pull/6155#discussion_r404599185", "bodyText": "Method stepIsAfterPurchaseAndBeforePlacement has a Cognitive Complexity of 6 (exceeds 5 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-04-07T07:37:54Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/PlacementUnitsCollapsiblePanel.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package games.strategy.triplea.ui;\n+\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.GameDataEvent;\n+import games.strategy.engine.data.GamePlayer;\n+import games.strategy.engine.data.GameStep;\n+import games.strategy.triplea.util.UnitSeparator;\n+import javax.swing.SwingUtilities;\n+import lombok.Getter;\n+import org.triplea.swing.CollapsiblePanel;\n+\n+class PlacementUnitsCollapsiblePanel {\n+  private final SimpleUnitPanel unitsToPlacePanel;\n+\n+  @Getter private final CollapsiblePanel panel;\n+  private final GameData gameData;\n+\n+  PlacementUnitsCollapsiblePanel(final GameData gameData, final UiContext uiContext) {\n+    this.gameData = gameData;\n+    unitsToPlacePanel =\n+        new SimpleUnitPanel(\n+            uiContext, SimpleUnitPanel.Style.SMALL_ICONS_WRAPPED_WITH_LABEL_WHEN_EMPTY);\n+    panel = new CollapsiblePanel(unitsToPlacePanel, \"\");\n+    panel.setVisible(false);\n+    gameData.addGameDataEventListener(GameDataEvent.GAME_STEP_CHANGED, this::updateStep);\n+  }\n+\n+  private void updateStep() {\n+    final GameStep step = gameData.getSequence().getStep();\n+\n+    SwingUtilities.invokeLater(\n+        () -> {\n+          if (GameStep.isPlaceStep(step.getName()) || isInitializationStep(step)) {\n+            panel.setVisible(false);\n+            return;\n+          }\n+\n+          final boolean hasUnitsToPlace = !step.getPlayerId().getUnits().isEmpty();\n+\n+          if (hasUnitsToPlace || stepIsAfterPurchaseAndBeforePlacement(step)) {\n+            panel.setTitle(\"Units To Place (\" + step.getPlayerId().getUnits().size() + \")\");\n+            unitsToPlacePanel.setUnitsFromCategories(\n+                UnitSeparator.categorize(step.getPlayerId().getUnits()));\n+            panel.setVisible(true);\n+          } else {\n+            panel.setVisible(false);\n+          }\n+        });\n+  }\n+\n+  private static boolean isInitializationStep(final GameStep gameStep) {\n+    return gameStep.getPlayerId() == null;\n+  }\n+\n+  private boolean stepIsAfterPurchaseAndBeforePlacement(final GameStep step) {", "originalCommit": "42674629a3124f8d2aad365e1ab81eacd2de5ad2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5OTE5MA==", "url": "https://github.com/triplea-game/triplea/pull/6155#discussion_r404599190", "bodyText": "TODO found", "author": "codeclimate", "createdAt": "2020-04-07T07:37:54Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/AbstractMovePanel.java", "diffHunk": "@@ -104,6 +104,7 @@ private void disableCancelButton() {\n     cancelMoveButton.setEnabled(false);\n   }\n \n+  // TODO: rename this to 'getGameDataFromPlayerBridge'", "originalCommit": "42674629a3124f8d2aad365e1ab81eacd2de5ad2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "21b5f6bec5be2add4f222f755c5ac6c7ae4e7bd5", "url": "https://github.com/triplea-game/triplea/commit/21b5f6bec5be2add4f222f755c5ac6c7ae4e7bd5", "message": "Update PlacePanel to mostly have 1.9 behavior when placing units", "committedDate": "2020-04-07T07:43:23Z", "type": "commit"}, {"oid": "93accbb8fbb6d464cb6d01b51f59dc2f56654254", "url": "https://github.com/triplea-game/triplea/commit/93accbb8fbb6d464cb6d01b51f59dc2f56654254", "message": "Formatting", "committedDate": "2020-04-07T07:43:27Z", "type": "forcePushed"}, {"oid": "87e3a05cf3e53d0892bee1c4bc44837d71ebb4a3", "url": "https://github.com/triplea-game/triplea/commit/87e3a05cf3e53d0892bee1c4bc44837d71ebb4a3", "message": "Extract placement collapsible panel to be its own panel.\n\n- Show the panel if we have units to place, or if we are after\n  a placement phase and should be showing a \"None\" label.", "committedDate": "2020-04-07T07:44:38Z", "type": "commit"}, {"oid": "865a72e0cfe1c629936b2ec49a029cfd2dee8f83", "url": "https://github.com/triplea-game/triplea/commit/865a72e0cfe1c629936b2ec49a029cfd2dee8f83", "message": "Remove placements panel empty label now that we have unit count in the title", "committedDate": "2020-04-07T07:44:41Z", "type": "commit"}, {"oid": "7b69942b418decedbe5701bfcaabb71ec23bd2e0", "url": "https://github.com/triplea-game/triplea/commit/7b69942b418decedbe5701bfcaabb71ec23bd2e0", "message": "Place unit scroller below placements panel", "committedDate": "2020-04-07T07:44:41Z", "type": "commit"}, {"oid": "cf12f9d279954a66e0d53bc40aa1249687876321", "url": "https://github.com/triplea-game/triplea/commit/cf12f9d279954a66e0d53bc40aa1249687876321", "message": "Formatting", "committedDate": "2020-04-07T07:44:41Z", "type": "commit"}, {"oid": "cf12f9d279954a66e0d53bc40aa1249687876321", "url": "https://github.com/triplea-game/triplea/commit/cf12f9d279954a66e0d53bc40aa1249687876321", "message": "Formatting", "committedDate": "2020-04-07T07:44:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDc5Nw==", "url": "https://github.com/triplea-game/triplea/pull/6155#discussion_r404820797", "bodyText": "Is there any specific reason why we iterate backwards over the steps?", "author": "RoiEXLab", "createdAt": "2020-04-07T13:45:40Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/PlacementUnitsCollapsiblePanel.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package games.strategy.triplea.ui;\n+\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.GameDataEvent;\n+import games.strategy.engine.data.GamePlayer;\n+import games.strategy.engine.data.GameStep;\n+import games.strategy.triplea.util.UnitSeparator;\n+import javax.swing.SwingUtilities;\n+import lombok.Getter;\n+import org.triplea.swing.CollapsiblePanel;\n+\n+class PlacementUnitsCollapsiblePanel {\n+  private final SimpleUnitPanel unitsToPlacePanel;\n+\n+  @Getter private final CollapsiblePanel panel;\n+  private final GameData gameData;\n+\n+  PlacementUnitsCollapsiblePanel(final GameData gameData, final UiContext uiContext) {\n+    this.gameData = gameData;\n+    unitsToPlacePanel =\n+        new SimpleUnitPanel(\n+            uiContext, SimpleUnitPanel.Style.SMALL_ICONS_WRAPPED_WITH_LABEL_WHEN_EMPTY);\n+    panel = new CollapsiblePanel(unitsToPlacePanel, \"\");\n+    panel.setVisible(false);\n+    gameData.addGameDataEventListener(GameDataEvent.GAME_STEP_CHANGED, this::updateStep);\n+  }\n+\n+  private void updateStep() {\n+    final GameStep step = gameData.getSequence().getStep();\n+\n+    SwingUtilities.invokeLater(\n+        () -> {\n+          if (GameStep.isPlaceStep(step.getName()) || isInitializationStep(step)) {\n+            panel.setVisible(false);\n+            return;\n+          }\n+\n+          final boolean hasUnitsToPlace = !step.getPlayerId().getUnits().isEmpty();\n+\n+          if (hasUnitsToPlace || stepIsAfterPurchaseAndBeforePlacement(step)) {\n+            panel.setTitle(\"Units To Place (\" + step.getPlayerId().getUnits().size() + \")\");\n+            unitsToPlacePanel.setUnitsFromCategories(\n+                UnitSeparator.categorize(step.getPlayerId().getUnits()));\n+            panel.setVisible(true);\n+          } else {\n+            panel.setVisible(false);\n+          }\n+        });\n+  }\n+\n+  private static boolean isInitializationStep(final GameStep gameStep) {\n+    return gameStep.getPlayerId() == null;\n+  }\n+\n+  private boolean stepIsAfterPurchaseAndBeforePlacement(final GameStep step) {\n+    final GamePlayer currentPlayer = step.getPlayerId();\n+\n+    for (int i = gameData.getSequence().getStepIndex() - 1; i >= 0; i--) {", "originalCommit": "cf12f9d279954a66e0d53bc40aa1249687876321", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEyNDY0MA==", "url": "https://github.com/triplea-game/triplea/pull/6155#discussion_r405124640", "bodyText": "Yes, we're trying to see if given a current step, that within the same turn if a player has passed through a purchase phase. Some maps have a combat move before purchase, so we can't just check if we are in a combat move.\nI'll note as well, there's still an assumption that there will be only one place phase, that it has a specific name too, all of which is already a bit brittle.", "author": "DanVanAtta", "createdAt": "2020-04-07T21:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzMjUwOA==", "url": "https://github.com/triplea-game/triplea/pull/6155#discussion_r405132508", "bodyText": "Ok, but why is the order important then?\nWouldn't it be sufficient to iterate from 0 to step index over the elements?", "author": "RoiEXLab", "createdAt": "2020-04-07T21:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NjM2OA==", "url": "https://github.com/triplea-game/triplea/pull/6155#discussion_r405146368", "bodyText": "Perhaps important to keep in mind that steps is all steps across a full round of play, it has a length of around 70. If we go from 0, we will iterate more, but more importantly it's harder to know when we've dropped to the previously players turn.", "author": "DanVanAtta", "createdAt": "2020-04-07T22:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDc5Nw=="}], "type": "inlineReview"}]}