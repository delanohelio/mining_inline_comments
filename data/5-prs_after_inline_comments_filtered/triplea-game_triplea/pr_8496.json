{"pr_number": 8496, "pr_title": "Move some matches to use relationshiptracker instead of game state", "pr_createdAt": "2020-12-22T16:44:07Z", "pr_url": "https://github.com/triplea-game/triplea/pull/8496", "timeline": [{"oid": "e50956adaeeda98070847344b2cd4e26f7f5cbce", "url": "https://github.com/triplea-game/triplea/commit/e50956adaeeda98070847344b2cd4e26f7f5cbce", "message": "Change Matches.unitIsEnemyOf to take RelationshipTracker", "committedDate": "2020-12-22T16:29:04Z", "type": "commit"}, {"oid": "00be5e9311a155b4af9f51d4f3855a7c499ae86c", "url": "https://github.com/triplea-game/triplea/commit/00be5e9311a155b4af9f51d4f3855a7c499ae86c", "message": "Change Matches.unitIsAlliedCarrier to take RelationshipTracker", "committedDate": "2020-12-22T16:31:33Z", "type": "commit"}, {"oid": "095209fc3afb219f70372a1d6a3af7f468add093", "url": "https://github.com/triplea-game/triplea/commit/095209fc3afb219f70372a1d6a3af7f468add093", "message": "Change Matches.isTerritoryAllies to take RelationshipTracker", "committedDate": "2020-12-22T16:36:56Z", "type": "commit"}, {"oid": "9f8aa75f858b537e57ce78977d654538aca0dae8", "url": "https://github.com/triplea-game/triplea/commit/9f8aa75f858b537e57ce78977d654538aca0dae8", "message": "Change Matches#territoryHasAlliedIsFactoryOrCanProduceUnits to take RelationshipTracker", "committedDate": "2020-12-22T16:42:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM5OTY3MQ==", "url": "https://github.com/triplea-game/triplea/pull/8496#discussion_r547399671", "bodyText": "For consideration, this might not be the right way remove GameData from Matches. It could make more sense to instead to inline this match altogether. In that case we'd want the object invoking this to not only have the match inlined, but also for that object to keep a reference to relationship tracker and not GameData.\nI think any one-line matcher needs to be really questions. The Matches API is a DIY java8 Predicate that was created before Java8 came out. We are now re-inventing a java built-in here.\nEG:\n.filter(unitIsEnemyOf(relationshipTracker, player))\n\nvs:\n.filter(unit -> relationshipTracker.isAtWar(unit.getOwner(), player))\n\nI think we need to consider how we are going to update Matches, whether it really is a nicer API for such cases. If so, this update makes sense, if not, then the update here is churn.", "author": "DanVanAtta", "createdAt": "2020-12-22T17:17:21Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/Matches.java", "diffHunk": "@@ -245,8 +245,9 @@ private Matches() {}\n     return unit -> UnitAttachment.get(unit.getType()).getDefense(unit.getOwner()) >= defendValue;\n   }\n \n-  public static Predicate<Unit> unitIsEnemyOf(final GameState data, final GamePlayer player) {\n-    return unit -> data.getRelationshipTracker().isAtWar(unit.getOwner(), player);\n+  public static Predicate<Unit> unitIsEnemyOf(", "originalCommit": "9f8aa75f858b537e57ce78977d654538aca0dae8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMTg5Nw==", "url": "https://github.com/triplea-game/triplea/pull/8496#discussion_r547401897", "bodyText": "I'm fine with inlining Matches, if that is the direction we want to go.  Should I only inline small, one line matches?\nAnd, yes the caller should also not be keeping a reference to GameData.  I'm trying to make these changes in pieces so that the PR is fairly small.  I'm first focusing on removing GameState from Matches as much as possible.  Then I'll work on other parts of the code that use GameState and try and replace it with the actual data (relationship tracker, unitlist, etc).", "author": "trevan", "createdAt": "2020-12-22T17:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM5OTY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMjQ5NQ==", "url": "https://github.com/triplea-game/triplea/pull/8496#discussion_r547402495", "bodyText": "It's very much posing a question, it's an open consideration. I'm not sure of the answer and I'd rather not create a mandate based on only my opinion alone.", "author": "DanVanAtta", "createdAt": "2020-12-22T17:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM5OTY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMzcwNA==", "url": "https://github.com/triplea-game/triplea/pull/8496#discussion_r547403704", "bodyText": "To answer the other question, yes, I think small & one line matches are the most obvious candidates for inlining. The more complex ones, perhaps those are good candidates to move to the class that owns the data about them? For example let's say there were a complex matcher that used relationshipTracker, it could make sense to move that matcher to be a method in relationshipTracker. (After all, who is to say that isAtWar is not a complex matcher itself).", "author": "DanVanAtta", "createdAt": "2020-12-22T17:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM5OTY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwNzQ1Ng==", "url": "https://github.com/triplea-game/triplea/pull/8496#discussion_r547407456", "bodyText": "The more complex ones, perhaps those are good candidates to move to the class that owns the data about them?\n\nI think that sounds like a good idea.  Though, some of the complex matchers use data from multiple objects.  Let me do more conversions and we'll be able to really see which objects the Matches really do use.", "author": "trevan", "createdAt": "2020-12-22T17:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM5OTY3MQ=="}], "type": "inlineReview"}]}