{"pr_number": 7767, "pr_title": "Fix: Casualty OOL handles amphibious and non-amphibious units in same battle", "pr_createdAt": "2020-09-26T03:03:24Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7767", "timeline": [{"oid": "0e8964c122f54f9734ff676b3608dbf266df3980", "url": "https://github.com/triplea-game/triplea/commit/0e8964c122f54f9734ff676b3608dbf266df3980", "message": "Fix: Casualty OOL handles amphibious and non-amphibious units in same battle", "committedDate": "2020-09-26T02:58:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwMzEwMQ==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495403101", "bodyText": "I don't know why the armor is the last unit.  This test has the same units as the improvedArtillery test except that one of the marines isn't amphibious.  I expected the tank to be below the amphibious marine like in the improvedArtillery but for some reason it is above.  I'm not entirely sure if this is correct behavior or some bug.", "author": "trevan", "createdAt": "2020-09-26T03:05:28Z", "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/casualty/CasualtyOrderOfLossesTestOnBigWorldV3.java", "diffHunk": "@@ -165,4 +161,115 @@ void infantryAndArtillery() {\n     assertThat(\n         \"Artillery has the better total power\", result.get(1).getType(), is(testData.artillery));\n   }\n+\n+  @Test\n+  void nonAmphibiousMarineWithAmphibiousAssault() {\n+    testData.addTech(new ImprovedArtillerySupportAdvance(testData.gameData));\n+\n+    final List<Unit> amphibUnits = new ArrayList<>();\n+    amphibUnits.addAll(testData.tank(1));\n+    amphibUnits.addAll(testData.artillery(1));\n+    amphibUnits.addAll(testData.marine(1));\n+\n+    amphibUnits.forEach(\n+        unit -> {\n+          unit.getProperty(Unit.UNLOADED_AMPHIBIOUS)\n+              .ifPresent(\n+                  property -> {\n+                    try {\n+                      property.setValue(true);\n+                    } catch (final MutableProperty.InvalidValueException e) {\n+                      // should not happen\n+                    }\n+                  });\n+        });\n+\n+    final List<Unit> attackingUnits = new ArrayList<>(amphibUnits);\n+    attackingUnits.addAll(testData.marine(1));\n+\n+    final List<Unit> result =\n+        CasualtyOrderOfLosses.sortUnitsForCasualtiesWithSupport(\n+            CasualtyOrderOfLosses.Parameters.builder()\n+                .targetsToPickFrom(attackingUnits)\n+                .combatModifiers(\n+                    CombatModifiers.builder().defending(false).territoryEffects(List.of()).build())\n+                .player(testData.british)\n+                .enemyUnits(List.of())\n+                .battlesite(testData.france)\n+                .costs(testData.costMap)\n+                .data(testData.gameData)\n+                .build());\n+\n+    assertThat(result, hasSize(4));\n+    assertThat(\n+        \"Non amphibious marine only has attack of 2 since it doesn't get marine bonus\",\n+        result.get(0),\n+        is(attackingUnits.get(3)));\n+    assertThat(result.get(1), is(attackingUnits.get(1)));\n+    assertThat(\"Amphibious marine has attack of 3\", result.get(2), is(attackingUnits.get(2)));\n+    assertThat(result.get(3), is(attackingUnits.get(0)));", "originalCommit": "0e8964c122f54f9734ff676b3608dbf266df3980", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwOTc3MQ==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495409771", "bodyText": "1st Casualty\nThe first casualty is clear to remove the non-amphib.\n2nd Casualty\nThis leaves the follow powers (where the +1 is support bonus):\ntank      3\nmarine    3 +1\nartillery 2\n\nf the artillery is taken, leaves total of 6\ntank 3\nmarine 3\n\nif the marine is taken, leaves total of 5\ntank 3\nartillery 2\n\nif the tank is taken, leaves total of 6\nmarine 3+1\nartillery 2\n\nRemoving the marine is a bad choice. This leaves a choice between artillery and tank with the same remaining power. Tank is more expensive and has better defensive power, so the choice is to remove artillery.\n3rd Casualty\nWe are left with this choice:\ntank 3\nmarine 3\n\nTank is more expensive and has better defensive value, so marine is the choice\n4th casualty\nTrivial case as we are left with only the tank.\nFinal ordering\nmarine, artillery, marine, tank", "author": "DanVanAtta", "createdAt": "2020-09-26T03:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwMzEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwMzc5Mw==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495403793", "bodyText": "I'd really like to test that the cache was used and that the rest of the code was skipped, but it is all static based so I can't spy on method calls to see what is called or not.  I manually stepped through the code for this test to verify that the cache was being used.", "author": "trevan", "createdAt": "2020-09-26T03:07:11Z", "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/casualty/CasualtyOrderOfLossesTestOnBigWorldV3.java", "diffHunk": "@@ -165,4 +161,115 @@ void infantryAndArtillery() {\n     assertThat(\n         \"Artillery has the better total power\", result.get(1).getType(), is(testData.artillery));\n   }\n+\n+  @Test\n+  void nonAmphibiousMarineWithAmphibiousAssault() {\n+    testData.addTech(new ImprovedArtillerySupportAdvance(testData.gameData));\n+\n+    final List<Unit> amphibUnits = new ArrayList<>();\n+    amphibUnits.addAll(testData.tank(1));\n+    amphibUnits.addAll(testData.artillery(1));\n+    amphibUnits.addAll(testData.marine(1));\n+\n+    amphibUnits.forEach(\n+        unit -> {\n+          unit.getProperty(Unit.UNLOADED_AMPHIBIOUS)\n+              .ifPresent(\n+                  property -> {\n+                    try {\n+                      property.setValue(true);\n+                    } catch (final MutableProperty.InvalidValueException e) {\n+                      // should not happen\n+                    }\n+                  });\n+        });\n+\n+    final List<Unit> attackingUnits = new ArrayList<>(amphibUnits);\n+    attackingUnits.addAll(testData.marine(1));\n+\n+    final List<Unit> result =\n+        CasualtyOrderOfLosses.sortUnitsForCasualtiesWithSupport(\n+            CasualtyOrderOfLosses.Parameters.builder()\n+                .targetsToPickFrom(attackingUnits)\n+                .combatModifiers(\n+                    CombatModifiers.builder().defending(false).territoryEffects(List.of()).build())\n+                .player(testData.british)\n+                .enemyUnits(List.of())\n+                .battlesite(testData.france)\n+                .costs(testData.costMap)\n+                .data(testData.gameData)\n+                .build());\n+\n+    assertThat(result, hasSize(4));\n+    assertThat(\n+        \"Non amphibious marine only has attack of 2 since it doesn't get marine bonus\",\n+        result.get(0),\n+        is(attackingUnits.get(3)));\n+    assertThat(result.get(1), is(attackingUnits.get(1)));\n+    assertThat(\"Amphibious marine has attack of 3\", result.get(2), is(attackingUnits.get(2)));\n+    assertThat(result.get(3), is(attackingUnits.get(0)));\n+  }\n+\n+  @Test\n+  void amphibiousAndNonAmphibiousCaching() {\n+    testData.addTech(new ImprovedArtillerySupportAdvance(testData.gameData));\n+\n+    final List<Unit> amphibUnits = new ArrayList<>();\n+    amphibUnits.addAll(testData.tank(1));\n+    amphibUnits.addAll(testData.artillery(1));\n+    amphibUnits.addAll(testData.marine(1));\n+\n+    amphibUnits.forEach(\n+        unit -> {\n+          unit.getProperty(Unit.UNLOADED_AMPHIBIOUS)\n+              .ifPresent(\n+                  property -> {\n+                    try {\n+                      property.setValue(true);\n+                    } catch (final MutableProperty.InvalidValueException e) {\n+                      // should not happen\n+                    }\n+                  });\n+        });\n+\n+    final List<Unit> attackingUnits = new ArrayList<>(amphibUnits);\n+    attackingUnits.addAll(testData.marine(1));\n+\n+    final List<Unit> result =\n+        CasualtyOrderOfLosses.sortUnitsForCasualtiesWithSupport(\n+            CasualtyOrderOfLosses.Parameters.builder()\n+                .targetsToPickFrom(attackingUnits)\n+                .combatModifiers(\n+                    CombatModifiers.builder().defending(false).territoryEffects(List.of()).build())\n+                .player(testData.british)\n+                .enemyUnits(List.of())\n+                .battlesite(testData.france)\n+                .costs(testData.costMap)\n+                .data(testData.gameData)\n+                .build());\n+\n+    assertThat(\n+        \"Non amphibious marine only has attack of 2 since it doesn't get marine bonus\",\n+        result.get(0),\n+        is(attackingUnits.get(3)));\n+    assertThat(\"Amphibious marine has attack of 3\", result.get(2), is(attackingUnits.get(2)));\n+\n+    final List<Unit> result2 =\n+        CasualtyOrderOfLosses.sortUnitsForCasualtiesWithSupport(\n+            CasualtyOrderOfLosses.Parameters.builder()\n+                .targetsToPickFrom(attackingUnits.subList(0, 3))\n+                .combatModifiers(\n+                    CombatModifiers.builder().defending(false).territoryEffects(List.of()).build())\n+                .player(testData.british)\n+                .enemyUnits(List.of())\n+                .battlesite(testData.france)\n+                .costs(testData.costMap)\n+                .data(testData.gameData)\n+                .build());\n+\n+    assertThat(result2, hasSize(3));", "originalCommit": "0e8964c122f54f9734ff676b3608dbf266df3980", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDEyMA==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495410120", "bodyText": "IMO that is good enough. Though I think the cache is actually only used once. All of this code is called to determine where units are to be placed on the combat board, and then later we go through this path with cache when computing supports.\nI took a deep look at calculating supports some time ago but the performance was not super easy to match. If you're ever interested I could go over you where I left and what I think is a simple algorithm for this.", "author": "DanVanAtta", "createdAt": "2020-09-26T03:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwMzc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDIwMQ==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495410201", "bodyText": "Would it be just as well to do set the property for just the marine rather than all units? That would remove the forEach loop", "author": "DanVanAtta", "createdAt": "2020-09-26T03:47:16Z", "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/casualty/CasualtyOrderOfLossesTestOnBigWorldV3.java", "diffHunk": "@@ -165,4 +161,115 @@ void infantryAndArtillery() {\n     assertThat(\n         \"Artillery has the better total power\", result.get(1).getType(), is(testData.artillery));\n   }\n+\n+  @Test\n+  void nonAmphibiousMarineWithAmphibiousAssault() {\n+    testData.addTech(new ImprovedArtillerySupportAdvance(testData.gameData));\n+\n+    final List<Unit> amphibUnits = new ArrayList<>();\n+    amphibUnits.addAll(testData.tank(1));\n+    amphibUnits.addAll(testData.artillery(1));\n+    amphibUnits.addAll(testData.marine(1));\n+\n+    amphibUnits.forEach(", "originalCommit": "0e8964c122f54f9734ff676b3608dbf266df3980", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDI5Mw==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495410293", "bodyText": "Complete side note, I think we got an error report stating that this comparator is invalid. The error message was \"contract violated\". If the following are units, { u1, u2, u3}, and if {u1 < u2}, and {u2 < u3}, then the following should be true {u1 < u3}. Apparently it was not and we got an exception for that.", "author": "DanVanAtta", "createdAt": "2020-09-26T03:49:07Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/UnitBattleComparator.java", "diffHunk": "@@ -48,7 +47,7 @@ public UnitBattleComparator(\n       final Collection<TerritoryEffect> territoryEffects,\n       final GameData data,\n       final boolean bonus) {\n-    this(defending, costs, territoryEffects, data, bonus, false, false);\n+    this(defending, costs, territoryEffects, data, bonus, false);\n   }\n \n   public UnitBattleComparator(", "originalCommit": "0e8964c122f54f9734ff676b3608dbf266df3980", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495410636", "bodyText": "I do suspect the cache will be incorrect here. If we fight a battle with non-amphib units, then later those units are amphib, the cache will have a value when we would have preferred to have had a cache miss.\nThere were already some problems here, and this code is certainly not fully correct, very complicated, and performance optimized (a really bad combination).\nAny thoughts @trevan ? I suspect that this is a consideration we are building in that just breaks this cache. We would not want a new cache value for every permutation of possibly amphib unit, that really blows it up in size.", "author": "DanVanAtta", "createdAt": "2020-09-26T03:53:26Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/casualty/CasualtyOrderOfLosses.java", "diffHunk": "@@ -239,29 +237,34 @@ void clearOolCache() {\n     }\n     sortedWellEnoughUnitsList.addAll(sortedUnitsList);\n     // Cache result and all subsets of the result\n-    final List<UnitType> unitTypes = new ArrayList<>();\n+    final List<AmphibType> unitTypes = new ArrayList<>();\n     for (final Unit u : sortedWellEnoughUnitsList) {\n-      unitTypes.add(u.getType());\n+      unitTypes.add(AmphibType.of(u.getType(), u.getWasAmphibious()));\n     }\n-    for (final Iterator<UnitType> it = unitTypes.iterator(); it.hasNext(); ) {\n+    for (final Iterator<AmphibType> it = unitTypes.iterator(); it.hasNext(); ) {\n       oolCache.put(key, new ArrayList<>(unitTypes));\n-      final UnitType unitTypeToRemove = it.next();\n+      final AmphibType unitTypeToRemove = it.next();\n       targetTypes.remove(unitTypeToRemove);\n       key = computeOolCacheKey(parameters, targetTypes);\n       it.remove();\n     }\n     return sortedWellEnoughUnitsList;\n   }\n \n-  static String computeOolCacheKey(final Parameters parameters, final List<UnitType> targetTypes) {\n+  @Value(staticConstructor = \"of\")\n+  static class AmphibType {\n+    UnitType type;\n+    boolean isAmphibious;\n+  }\n+\n+  static String computeOolCacheKey(\n+      final Parameters parameters, final List<AmphibType> targetTypes) {\n     return parameters.player.getName()\n         + \"|\"\n         + parameters.battlesite.getName()\n         + \"|\"\n         + parameters.combatModifiers.isDefending()\n         + \"|\"\n-        + parameters.combatModifiers.isAmphibious()", "originalCommit": "0e8964c122f54f9734ff676b3608dbf266df3980", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDY2Ng==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495410666", "bodyText": "It's possibly an option to just allow the cache to be incorrect for amphib units.. though not ideal.", "author": "DanVanAtta", "createdAt": "2020-09-26T03:54:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMzk5Mw==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495413993", "bodyText": "The cache key includes whether the unit type is amphibious or not.  A non-amphibious marine would create a different cache key than an amphibious marine.  The AmphibType keeps track of amphibious or not.", "author": "trevan", "createdAt": "2020-09-26T04:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxNDE5Nw==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495414197", "bodyText": "I'll change the cache key to also check if there is a marine bonus.  If a unit type doesn't have a marine bonus, then there is no need to care if the unit is amphibious or not.", "author": "trevan", "createdAt": "2020-09-26T04:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxNTIzNw==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495415237", "bodyText": "I'm afraid you'll need to check the cache performance before and after and make sure the size of the cache doesn't blow up too much. Maps where this is an issue are world at war or NWO where you can have very large numbers of units.", "author": "DanVanAtta", "createdAt": "2020-09-26T04:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyMTY4MQ==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495421681", "bodyText": "I ran one round of world of war with hard ai.  I printed out the size of the ool cache right before it was cleared.  In case you don't know, the ool cache is cleared after each step, such as combat, production, non-combat move, etc.\nThe numbers were roughly the same.  In some cases, this new code had more entries and in other cases it had less.\nI think the main reason for that is the old code added the amphibiousLandAttackers to the cache key.  This new code doesn't use that and instead uses getWasAmphibious but it is roughly the same affect.", "author": "trevan", "createdAt": "2020-09-26T06:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyMzE5NQ==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495423195", "bodyText": "My recollection is faulty, I though it was kept around for longer. That kinda makes it less useful than I had thought.. I really regret I did not stick longer with the rewrite of this code, much of it was deleted... Ah well, one day maybe.\nI was thinking for a test to do something like a 300 vs 300 unit battle. We get a cache entry for each unit in the battle per side, but it's no different really as the amphib entry does not really blow that up. The WaW case is significant around round 10-20 of that map, a save game at that location is best, the army stacks get to be pretty outragous with outragous bship stacks (like 30-40 ships, similar number of carriers etc)...", "author": "DanVanAtta", "createdAt": "2020-09-26T06:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ3MDQ4NQ==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495470485", "bodyText": "I ran WaW with fast ai until I got to the middle of round 10.  I save it and then ran hard ai for a little under a round with the old code and the new code.  I summed up the maximum number of cache entries before each clearing.  With the old code, there were 66,495 cache entries.  With the new code, there were 69,573 cache entries.  So it does add more cache entries but not significantly.\nI ran two large scale battles with WaW that I created using edit mode.  Both battles had 100 armored cars, artillery, elites, infantry, marines, mech. infantry, mot. infantry, and tanks.  One battle had a 50/50 split between amphibious and not.  The other battle had 51/49 split between amphibious and not.  I ran the 50/50 battle first.  WaW is low luck so the outcomes of the battles should be fairly deterministic.  With the old code, there were 3566 cache entries after both battles were finished.  With the new code, there were 2199 cache entries.", "author": "trevan", "createdAt": "2020-09-26T16:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ4MDgzOA==", "url": "https://github.com/triplea-game/triplea/pull/7767#discussion_r495480838", "bodyText": "Thank you for the detailed check", "author": "DanVanAtta", "createdAt": "2020-09-26T18:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMDYzNg=="}], "type": "inlineReview"}, {"oid": "67ee40c0c5cc75e057273987637529dd5873d6df", "url": "https://github.com/triplea-game/triplea/commit/67ee40c0c5cc75e057273987637529dd5873d6df", "message": "Only add amphibious to the cache key if the unit is a marine", "committedDate": "2020-09-26T05:34:35Z", "type": "commit"}]}