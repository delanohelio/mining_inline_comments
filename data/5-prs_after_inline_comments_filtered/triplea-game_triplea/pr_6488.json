{"pr_number": 6488, "pr_title": "Add Lobby Right Click Menus: Show Players in Host & List Player Games", "pr_createdAt": "2020-05-18T00:33:04Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6488", "timeline": [{"oid": "8d8aacdb78c72708578590d0e542332287f61c47", "url": "https://github.com/triplea-game/triplea/commit/8d8aacdb78c72708578590d0e542332287f61c47", "message": "Rename 'PlayerSummaryForModerator' -> 'PlayerSummary'", "committedDate": "2020-05-17T01:09:33Z", "type": "commit"}, {"oid": "340035e0e1e53946bfb104bff2e8bce5668ba14d", "url": "https://github.com/triplea-game/triplea/commit/340035e0e1e53946bfb104bff2e8bce5668ba14d", "message": "Update PlayerSummary to have nullable sensitive data\n\nOnly moderators will see IP, system-id, bans and aliases; update PlayerSummary\nto allow this data to be nullable and update usages.", "committedDate": "2020-05-17T01:09:33Z", "type": "commit"}, {"oid": "345cf697e9dc9343eaf534fde19792a687c252c0", "url": "https://github.com/triplea-game/triplea/commit/345cf697e9dc9343eaf534fde19792a687c252c0", "message": "Allow showPlayerInfo right click menu to all players", "committedDate": "2020-05-17T01:09:33Z", "type": "commit"}, {"oid": "68b5c4faa5f84ce0630ed1a539a49bc78210849c", "url": "https://github.com/triplea-game/triplea/commit/68b5c4faa5f84ce0630ed1a539a49bc78210849c", "message": "Move fetchPlayerInfo client call to its own client (no longer associated with moderator)", "committedDate": "2020-05-17T03:04:59Z", "type": "commit"}, {"oid": "55fdda55d544a45434d7d3b535b22b91db0c9930", "url": "https://github.com/triplea-game/triplea/commit/55fdda55d544a45434d7d3b535b22b91db0c9930", "message": "Update backend player info fetch to allow players\n\n- Allow some data to be returned when non-moderators request\n  player info. Notably do not send aliases or bans information", "committedDate": "2020-05-17T03:07:01Z", "type": "commit"}, {"oid": "497264c6a76aea4cc39e44d215f1a2ea16c62213", "url": "https://github.com/triplea-game/triplea/commit/497264c6a76aea4cc39e44d215f1a2ea16c62213", "message": "Remove playerName from PlayerInfo lookup (front-end already has this information)", "committedDate": "2020-05-17T03:11:22Z", "type": "commit"}, {"oid": "865c8b757ab93d7476ffc0abd63da6089a7a88cb", "url": "https://github.com/triplea-game/triplea/commit/865c8b757ab93d7476ffc0abd63da6089a7a88cb", "message": "Update player info to list current games for a given user", "committedDate": "2020-05-17T03:32:20Z", "type": "commit"}, {"oid": "daa56853fbcaa3e53c2aca422816787a2713f5a7", "url": "https://github.com/triplea-game/triplea/commit/daa56853fbcaa3e53c2aca422816787a2713f5a7", "message": "Implement GameListing datastructure to track the games a player is in.", "committedDate": "2020-05-17T19:35:10Z", "type": "commit"}, {"oid": "e9f82d35977ce33ed9d452027ef371e1e5a72cc6", "url": "https://github.com/triplea-game/triplea/commit/e9f82d35977ce33ed9d452027ef371e1e5a72cc6", "message": "Fix player summary no longer has player name (front-end wiring)", "committedDate": "2020-05-17T19:35:24Z", "type": "commit"}, {"oid": "ccf1453f9c85ffda36f4cad64d908e744afe37aa", "url": "https://github.com/triplea-game/triplea/commit/ccf1453f9c85ffda36f4cad64d908e744afe37aa", "message": "PostGame sends connected player information to backend", "committedDate": "2020-05-17T19:35:45Z", "type": "commit"}, {"oid": "0bcac7ed74441d46619110260ee68f557ff71b1b", "url": "https://github.com/triplea-game/triplea/commit/0bcac7ed74441d46619110260ee68f557ff71b1b", "message": "Update front-end to notify back-end of player joined and player left", "committedDate": "2020-05-17T19:36:38Z", "type": "commit"}, {"oid": "f8c9df2b4b78e000b4a33155897b72c5b41a3f60", "url": "https://github.com/triplea-game/triplea/commit/f8c9df2b4b78e000b4a33155897b72c5b41a3f60", "message": "Backend implementation for players joining and leaving, and handle nullable player list", "committedDate": "2020-05-17T20:00:05Z", "type": "commit"}, {"oid": "ab0bbd6ce8509f52094b37d7d37527c3d47dfcaf", "url": "https://github.com/triplea-game/triplea/commit/ab0bbd6ce8509f52094b37d7d37527c3d47dfcaf", "message": "Update wire-mock test to skip serialization of nulls", "committedDate": "2020-05-17T20:13:47Z", "type": "commit"}, {"oid": "0b31cf7785277ed5e91473b721fabae429a585a1", "url": "https://github.com/triplea-game/triplea/commit/0b31cf7785277ed5e91473b721fabae429a585a1", "message": "ChattersTest - couple quick fixes", "committedDate": "2020-05-17T20:36:28Z", "type": "commit"}, {"oid": "0690822c1ded65fdeaceee4e9d4f331b17f4950c", "url": "https://github.com/triplea-game/triplea/commit/0690822c1ded65fdeaceee4e9d4f331b17f4950c", "message": "Close PlayerInfo window when escape key is pressed", "committedDate": "2020-05-17T20:38:58Z", "type": "commit"}, {"oid": "01131c18e23578feec1ee87ecd4f700a963a39ee", "url": "https://github.com/triplea-game/triplea/commit/01131c18e23578feec1ee87ecd4f700a963a39ee", "message": "Implement front-end for 'show players in game' lobby right-click menu", "committedDate": "2020-05-17T21:14:51Z", "type": "commit"}, {"oid": "e77e8bbd4eef4fafc728825c3b578a45169c78ef", "url": "https://github.com/triplea-game/triplea/commit/e77e8bbd4eef4fafc728825c3b578a45169c78ef", "message": "Backend implementation for fetching players in game", "committedDate": "2020-05-17T23:00:16Z", "type": "commit"}, {"oid": "1348583152f632637ec821286f43772ec19cd72c", "url": "https://github.com/triplea-game/triplea/commit/1348583152f632637ec821286f43772ec19cd72c", "message": "Add escape key listener and close buttons to show players and show info dialogs.", "committedDate": "2020-05-17T23:31:55Z", "type": "commit"}, {"oid": "a941898f128a56c16e184645505abfe3c62212aa", "url": "https://github.com/triplea-game/triplea/commit/a941898f128a56c16e184645505abfe3c62212aa", "message": "Move PlayerInfoController up a package, out of 'moderator' package", "committedDate": "2020-05-18T00:01:10Z", "type": "commit"}, {"oid": "c985ff13e1f9752bcf1ee5b54bb616a89b42a8f5", "url": "https://github.com/triplea-game/triplea/commit/c985ff13e1f9752bcf1ee5b54bb616a89b42a8f5", "message": "Improve javadoc and make GamePostingRequest.playerNames non-nullable", "committedDate": "2020-05-18T00:01:13Z", "type": "commit"}, {"oid": "083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "url": "https://github.com/triplea-game/triplea/commit/083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "message": "Auto-Formatting", "committedDate": "2020-05-18T00:03:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzg1NQ==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426323855", "bodyText": "Similar blocks of code found in 3 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-05-18T00:34:37Z", "path": "http-clients/src/main/java/org/triplea/http/client/lobby/player/PlayerLobbyActionsFeignClient.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package org.triplea.http.client.lobby.player;", "originalCommit": "083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzg1Ng==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426323856", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-05-18T00:34:38Z", "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/client/connections/GameToLobbyConnection.java", "diffHunk": "@@ -89,4 +91,14 @@ public void close() {\n   public void sendChatMessageToLobby(final ChatUploadParams chatUploadParams) {\n     lobbyWatcherClient.uploadChatMessage(lobbyClient.getApiKey(), chatUploadParams);\n   }\n+\n+  public void playerJoined(final String gameId, final UserName playerName) {", "originalCommit": "083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzg1Nw==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426323857", "bodyText": "Method lobbyPlayerRightClickMenuActions has 38 lines of code (exceeds 30 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-05-18T00:34:38Z", "path": "game-core/src/main/java/games/strategy/engine/lobby/client/ui/LobbyFrame.java", "diffHunk": "@@ -95,41 +95,44 @@ public void windowClosing(final WindowEvent e) {\n         });\n   }\n \n-  private List<Action> newModeratorActions(final ChatParticipant clickedOn) {\n-    if (!lobbyClient.isModerator()) {\n-      return List.of();\n-    }\n-\n+  private List<Action> lobbyPlayerRightClickMenuActions(final ChatParticipant clickedOn) {", "originalCommit": "083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzg1OA==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426323858", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-05-18T00:34:38Z", "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/client/connections/GameToLobbyConnection.java", "diffHunk": "@@ -89,4 +91,14 @@ public void close() {\n   public void sendChatMessageToLobby(final ChatUploadParams chatUploadParams) {\n     lobbyWatcherClient.uploadChatMessage(lobbyClient.getApiKey(), chatUploadParams);\n   }\n+\n+  public void playerJoined(final String gameId, final UserName playerName) {\n+    AsyncRunner.runAsync(() -> lobbyWatcherClient.playerJoined(gameId, playerName))\n+        .exceptionally(e -> log.log(Level.INFO, \"Failed to notify lobby a player connected\", e));\n+  }\n+\n+  public void playerLeft(final String gameId, final UserName playerName) {", "originalCommit": "083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYxMzEyOQ==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426613129", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .flatMap(lobbyConnection -> Optional.ofNullable(lobbyWatcherThread))\n          \n          \n            \n                    .map(lobbyConnection -> lobbyWatcherThread)", "author": "RoiEXLab", "createdAt": "2020-05-18T13:09:40Z", "path": "game-core/src/main/java/games/strategy/engine/framework/startup/mc/ServerModel.java", "diffHunk": "@@ -595,7 +596,23 @@ public IServerMessenger getMessenger() {\n   }\n \n   @Override\n-  public void connectionAdded(final INode to) {}\n+  public void connectionAdded(final INode to) {\n+    notifyLobby(\n+        (lobbyConnection, gameId) -> lobbyConnection.playerJoined(gameId, to.getPlayerName()));\n+  }\n+\n+  /**\n+   * If there is a connection to lobby, and we have established a lobby watcher, and that lobby\n+   * watcher has a game-id, then the provided parameter is executed passing to it as arguments the\n+   * lobby connection and game-id.\n+   */\n+  private void notifyLobby(\n+      final BiConsumer<GameToLobbyConnection, String> connectionAndGameIdAction) {\n+    Optional.ofNullable(gameToLobbyConnection)\n+        .flatMap(lobbyConnection -> Optional.ofNullable(lobbyWatcherThread))", "originalCommit": "083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3Nzk5MA==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426977990", "bodyText": "Valid suggestion. I opted to rewrite this with some if not null checks. What is bothersome to me is that we rely on gameToLobbyConnection not being null for the flatmaps to do anything and then we use the original gameToLobbyConnection value later, relying not on the return value of the optional chains but the fact that the flatMaps would not have done anything. This strikes me as non-idiomatic, generally the result of an optional 'chain' is used directly in the next statements, in this case it's not. I think it's probably just easier to check for not null values here: 8907173", "author": "DanVanAtta", "createdAt": "2020-05-19T01:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYxMzEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxOTU5Ng==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426919596", "bodyText": "This is something that concerns me a bit. It becomes the client's responsibility to change the online status.\nIn case the bot loses its internet connection, does the server clear out the entries correctly?\nI think it does, but I'd like to be sure I didn't misinterpret something", "author": "RoiEXLab", "createdAt": "2020-05-18T22:09:59Z", "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/client/connections/GameToLobbyConnection.java", "diffHunk": "@@ -89,4 +91,14 @@ public void close() {\n   public void sendChatMessageToLobby(final ChatUploadParams chatUploadParams) {\n     lobbyWatcherClient.uploadChatMessage(lobbyClient.getApiKey(), chatUploadParams);\n   }\n+\n+  public void playerJoined(final String gameId, final UserName playerName) {\n+    AsyncRunner.runAsync(() -> lobbyWatcherClient.playerJoined(gameId, playerName))\n+        .exceptionally(e -> log.log(Level.INFO, \"Failed to notify lobby a player connected\", e));", "originalCommit": "083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkyNDgwNw==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426924807", "bodyText": "Also I'm curious why you decided to make it the lobbies resposibility to keep track of the users.\nIs there anything that speaks against making the lobby \"ask\" the current users for some bot every time this menu is clicked via websocket or something?", "author": "RoiEXLab", "createdAt": "2020-05-18T22:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxOTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk4MDk3NA==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426980974", "bodyText": "RemoveGame will remove players from a game: https://github.com/triplea-game/triplea/pull/6488/files#diff-33a1ee87da31c0aeb9cecfd5deeff19cR133\nRecall that RemoveGame is called on exit of any lobby-connected game. This functionality is not just for bots, but for any lobby-connected game.\nSecond, if a game dies without invoking RemoveGame, we the game listing in GameListing will expire from cache. We check for expired cache entries when computing player game participation and will update the server side model when that happens:\nhttps://github.com/triplea-game/triplea/pull/6488/files#diff-33a1ee87da31c0aeb9cecfd5deeff19cR216\nWith that said, there is possibility for the server to \"miss\" \"player-join\" and \"player-left\" messages. It'd be nice to have 100% accuracy, but this feature can tolerate some degree of inaccuracy, it does not have to be 100%.", "author": "DanVanAtta", "createdAt": "2020-05-19T01:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxOTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk4MjcxNg==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426982716", "bodyText": "Is there anything that speaks against making the lobby \"ask\" the current users for some bot every time this menu is clicked via websocket or something?\n\nI suppose ideally we'd have direct communication from the client to the server. Going a websocket route is a bit indirect. The lobby would have to keep track of in-flight requests, ask bot servers to tell them their participants, receive that back, then flush any requests back to a client when the request could be computed. If any server does not respond in a timely way (EG: CPU busy), we could see unexpected issues. We also take an efficiency hit, if every player requested the current games of other players then for each request the lobby would be making a request to every game. With 50 players, making 3 requests to know which games a player is in, that would be 150 requests to each game that is open. The 'which players are in this game' makes sense for it to be direct to a server, but the 'which games is a player is in' is more difficult to answer that way.", "author": "DanVanAtta", "createdAt": "2020-05-19T01:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxOTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyMjc4OA==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r427122788", "bodyText": "Thanks for your explanation, makes sense", "author": "RoiEXLab", "createdAt": "2020-05-19T08:30:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxOTU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkyMDk4Ng==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426920986", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return entry -> entry.getValue().stream().anyMatch(id -> id.getId().equals(gameId));\n          \n          \n            \n                return entry -> entry.getValue().stream().map(GameId::getId).anyMatch(gameId::equals);", "author": "RoiEXLab", "createdAt": "2020-05-18T22:13:35Z", "path": "http-server/src/main/java/org/triplea/modules/game/listing/GameListing.java", "diffHunk": "@@ -167,4 +194,41 @@ void bootGame(final int moderatorId, final String id) {\n             lobbyGame ->\n                 new InetSocketAddress(lobbyGame.getHostAddress(), lobbyGame.getHostPort()));\n   }\n+\n+  public void addPlayerToGame(final UserName userName, final ApiKey apiKey, final String gameId) {\n+    playerIsInGames.put(userName, new GameId(apiKey, gameId));\n+  }\n+\n+  public void removePlayerFromGame(\n+      final UserName userName, final ApiKey apiKey, final String gameId) {\n+    playerIsInGames.remove(userName, new GameId(apiKey, gameId));\n+  }\n+\n+  /**\n+   * Gets the collection of active games (identified by hostname) that a player is playing in or has\n+   * joined as an observer.\n+   */\n+  public Collection<String> getGameNamesPlayerHasJoined(final UserName userName) {\n+    final Collection<GameId> expiredGames =\n+        playerIsInGames.get(userName).stream()\n+            .filter(gameId -> games.get(gameId).isEmpty())\n+            .collect(Collectors.toList());\n+    expiredGames.forEach(gameId -> playerIsInGames.remove(userName, gameId));\n+\n+    return playerIsInGames.get(userName).stream()\n+        .map(gameId -> games.get(gameId).map(LobbyGame::getHostName).orElse(null))\n+        .collect(Collectors.toList());\n+  }\n+\n+  public Collection<String> getPlayersInGame(final String gameId) {\n+    return playerIsInGames.asMap().entrySet().stream()\n+        .filter(playerIsInGame(gameId))\n+        .map(Map.Entry::getKey)\n+        .map(UserName::getValue)\n+        .collect(Collectors.toList());\n+  }\n+\n+  private Predicate<Map.Entry<UserName, Collection<GameId>>> playerIsInGame(final String gameId) {\n+    return entry -> entry.getValue().stream().anyMatch(id -> id.getId().equals(gameId));", "originalCommit": "083bc7a8b39830723b2ab35e0e9bfe080e96d47a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3ODc0MQ==", "url": "https://github.com/triplea-game/triplea/pull/6488#discussion_r426978741", "bodyText": "\ud83d\udc4d   090166f", "author": "DanVanAtta", "createdAt": "2020-05-19T01:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkyMDk4Ng=="}], "type": "inlineReview"}, {"oid": "89071730bfa7d9b7c8f2fb84cdf9bbb0b07b4542", "url": "https://github.com/triplea-game/triplea/commit/89071730bfa7d9b7c8f2fb84cdf9bbb0b07b4542", "message": "Re-write ServerModel chained optional logic to have an if not null check", "committedDate": "2020-05-19T01:24:03Z", "type": "commit"}, {"oid": "090166f741648a2f3ae6b7e615efa9a187ad8de8", "url": "https://github.com/triplea-game/triplea/commit/090166f741648a2f3ae6b7e615efa9a187ad8de8", "message": "Simplify: update GameListing.java to use method references", "committedDate": "2020-05-19T01:28:43Z", "type": "commit"}]}