{"pr_number": 7405, "pr_title": "Add sub-project dropwizard common", "pr_createdAt": "2020-08-21T02:49:24Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7405", "timeline": [{"oid": "cf0776853892291252da5989441fe5fa3fcba278", "url": "https://github.com/triplea-game/triplea/commit/cf0776853892291252da5989441fe5fa3fcba278", "message": "Add sub-project dropwizard common\n\nThe sub-project is to allow for easier configuration\nof a drop wizard server and to reduce redundancy for when\nwe have multiple drop wizard servers", "committedDate": "2020-08-21T02:48:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MjM2NQ==", "url": "https://github.com/triplea-game/triplea/pull/7405#discussion_r474782365", "bodyText": "That's a weird side-effect I didn't see coming. Maybe renaming the method to document this bahaviour in some way?", "author": "RoiEXLab", "createdAt": "2020-08-21T15:49:41Z", "path": "dropwizard-common/src/main/java/org/triplea/dropwizard/common/ServerConfiguration.java", "diffHunk": "@@ -0,0 +1,139 @@\n+package org.triplea.dropwizard.common;\n+\n+import es.moki.ratelimij.dropwizard.RateLimitBundle;\n+import es.moki.ratelimitj.inmemory.InMemoryRateLimiterFactory;\n+import io.dropwizard.Configuration;\n+import io.dropwizard.configuration.EnvironmentVariableSubstitutor;\n+import io.dropwizard.configuration.SubstitutingSourceProvider;\n+import io.dropwizard.jdbi3.bundles.JdbiExceptionsBundle;\n+import io.dropwizard.setup.Bootstrap;\n+import io.dropwizard.setup.Environment;\n+import io.dropwizard.websockets.WebsocketBundle;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import javax.websocket.server.ServerEndpointConfig;\n+import javax.ws.rs.container.ContainerRequestFilter;\n+import lombok.AllArgsConstructor;\n+import org.glassfish.jersey.logging.LoggingFeature;\n+import org.glassfish.jersey.server.filter.RolesAllowedDynamicFeature;\n+\n+/**\n+ * Facilitates configuration for a dropwizard server Application class.\n+ *\n+ * @param <T> Configuration class type of the server.\n+ */\n+public class ServerConfiguration<T extends Configuration> {\n+\n+  private final Bootstrap<T> bootstrap;\n+  private final Map<Class<?>, ServerEndpointConfig> websockets = new HashMap<>();\n+\n+  @AllArgsConstructor\n+  public static class WebsocketConfig {\n+    private final Class<?> websocketClass;\n+    private final String path;\n+  }\n+\n+  public ServerConfiguration(\n+      final Bootstrap<T> bootstrap, final WebsocketConfig... websocketConfigs) {\n+    this.bootstrap = bootstrap;\n+\n+    final ServerEndpointConfig[] websockets = buildWebsockets(websocketConfigs);\n+    bootstrap.addBundle(new WebsocketBundle(websockets));\n+  }\n+\n+  private ServerEndpointConfig[] buildWebsockets(final WebsocketConfig... websocketConfigs) {\n+    return Arrays.stream(websocketConfigs)\n+        .map(\n+            websocketConfig -> {\n+              final var serverEndpointConfig =\n+                  ServerEndpointConfig.Builder.create(\n+                          websocketConfig.websocketClass, websocketConfig.path)\n+                      .build();\n+              websockets.put(websocketConfig.websocketClass, serverEndpointConfig);", "originalCommit": "cf0776853892291252da5989441fe5fa3fcba278", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxMjk5Nw==", "url": "https://github.com/triplea-game/triplea/pull/7405#discussion_r475012997", "bodyText": "\"addWebsockets\" might be better. I'll note that the method is not static precisely because it has such a side-effect (IMO it's a bit sad that the keyword is considered optional, even bad practice, as the omission of the static keyword could otherwise be used to derive pretty useful information).", "author": "DanVanAtta", "createdAt": "2020-08-21T23:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MjM2NQ=="}], "type": "inlineReview"}, {"oid": "6a5e9da0bd4c2271093926ac75a7f6f678323bd7", "url": "https://github.com/triplea-game/triplea/commit/6a5e9da0bd4c2271093926ac75a7f6f678323bd7", "message": "Update method name 'buildWebsocket' -> 'addWebsocket'", "committedDate": "2020-08-22T00:33:50Z", "type": "commit"}]}