{"pr_number": 6466, "pr_title": "Mute complete", "pr_createdAt": "2020-05-13T06:06:30Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6466", "timeline": [{"oid": "0ade3278b4bbfdd8443d3c2169fd7331f2a725db", "url": "https://github.com/triplea-game/triplea/commit/0ade3278b4bbfdd8443d3c2169fd7331f2a725db", "message": "Add TimeManager convenience utility to get an Instant at UTC by year/month/day/hour/minute", "committedDate": "2020-05-13T02:58:16Z", "type": "commit"}, {"oid": "9ba6a3add4d9bf7ad3a1f18eeb9dba62176b2f88", "url": "https://github.com/triplea-game/triplea/commit/9ba6a3add4d9bf7ad3a1f18eeb9dba62176b2f88", "message": "Suppress muted-chatter messages, send them a message that they are muted", "committedDate": "2020-05-13T03:27:50Z", "type": "commit"}, {"oid": "3bc3a2b484a536f21fa88f909ca35c6a45c3a42a", "url": "https://github.com/triplea-game/triplea/commit/3bc3a2b484a536f21fa88f909ca35c6a45c3a42a", "message": "Rename class: TimeManager->DateTimeUtil", "committedDate": "2020-05-13T03:54:33Z", "type": "commit"}, {"oid": "b3566e4c6b8fabb9188672e3dea568272397faf1", "url": "https://github.com/triplea-game/triplea/commit/b3566e4c6b8fabb9188672e3dea568272397faf1", "message": "Move method 'toDateString' from DateTimeUtil to DateTimeFormatterUtil", "committedDate": "2020-05-13T03:59:48Z", "type": "commit"}, {"oid": "d11b4b0575c3c91057a8ff77e0846038d50b31ba", "url": "https://github.com/triplea-game/triplea/commit/d11b4b0575c3c91057a8ff77e0846038d50b31ba", "message": "Update server mute controller to send mute requests to chatters backend data model", "committedDate": "2020-05-13T04:08:48Z", "type": "commit"}, {"oid": "641b79d733de44e0f597124644ed793abb3074a7", "url": "https://github.com/triplea-game/triplea/commit/641b79d733de44e0f597124644ed793abb3074a7", "message": "Convert mutes from player-chat-id based to IP address based\n\n- Requires attaching IP addresses to chatter sessions so we can identify\n  chatters by IP.", "committedDate": "2020-05-13T05:08:56Z", "type": "commit"}, {"oid": "87e6db938277a9f868dc3eaf08e3a45efd992f51", "url": "https://github.com/triplea-game/triplea/commit/87e6db938277a9f868dc3eaf08e3a45efd992f51", "message": "Send broadcast message to lobby informating everyone of mute.", "committedDate": "2020-05-13T05:37:53Z", "type": "commit"}, {"oid": "060da64cfffe04e66e81a6d9ef66b14c0734fede", "url": "https://github.com/triplea-game/triplea/commit/060da64cfffe04e66e81a6d9ef66b14c0734fede", "message": "Remove right click menu mute confirmation prompt, lobby broadcast message is confirmation.", "committedDate": "2020-05-13T05:38:19Z", "type": "commit"}, {"oid": "f54ba778754dc1dba196a2953e66e247bb76982f", "url": "https://github.com/triplea-game/triplea/commit/f54ba778754dc1dba196a2953e66e247bb76982f", "message": "Test fixes", "committedDate": "2020-05-13T06:02:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE5MjkxNg==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424192916", "bodyText": "Method utcInstantOf has 5 arguments (exceeds 4 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-05-13T06:08:58Z", "path": "java-extras/src/main/java/org/triplea/java/DateTimeUtil.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.triplea.java;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import java.time.Clock;\n+import java.time.Instant;\n+import java.time.LocalDateTime;\n+import java.time.ZoneId;\n+import java.time.ZoneOffset;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.format.FormatStyle;\n+import java.util.Locale;\n+import java.util.Locale.Category;\n+import lombok.experimental.UtilityClass;\n+\n+/** Provides methods for getting time and date instances. */\n+@UtilityClass\n+public final class DateTimeUtil {\n+  @VisibleForTesting static ZoneId defaultZoneId = ZoneId.systemDefault();\n+  @VisibleForTesting static Clock clock = Clock.system(defaultZoneId);\n+  @VisibleForTesting static Locale defaultLocale = Locale.getDefault(Category.FORMAT);\n+\n+  /**\n+   * Returns a String representing the current {@link LocalDateTime}. Based on where you live this\n+   * might be either for example 13:45 or 1:45pm.\n+   *\n+   * @return The formatted String\n+   */\n+  public static String getLocalizedTime() {\n+    return new DateTimeFormatterBuilder()\n+        .appendLocalized(null, FormatStyle.MEDIUM)\n+        .toFormatter(defaultLocale)\n+        .format(LocalDateTime.ofInstant(clock.instant(), defaultZoneId));\n+  }\n+\n+  /** Returns an {@code Instant} in UTC with a specified year, month, day, hour and minute. */\n+  public static Instant utcInstantOf(\n+      final int year, final int month, final int day, final int hour, final int minute) {", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1Mjk0MQ==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424752941", "bodyText": "Looks like this test is failing on travis.\nIt seems to be a typo, but I could imagine it's a locale issue. Looking at the code those tests may fail when executed in a different part of the world, where the default date format looks different (or simply is in a different language).", "author": "RoiEXLab", "createdAt": "2020-05-13T21:53:30Z", "path": "java-extras/src/test/java/org/triplea/java/DateTimeFormatterUtilTest.java", "diffHunk": "@@ -35,4 +38,12 @@ void verifyFormattingNoTimeZone() {\n             DEC_FIRST_EPOCH_MILLIS, FormatOption.WITHOUT_TIMEZONE);\n     assertThat(result, is(\"2000-12-1 15:59\"));\n   }\n+\n+  @Test\n+  void toDateString() {\n+    assertThat(\n+        DateTimeFormatterUtil.toDateString(\n+            LocalDateTime.ofInstant(JAN_FIRST_INSTANT, ZoneOffset.UTC)),\n+        is(\"Wed. Jan. 01 14:30:00 UTC 2020\"));", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxMzQwMQ==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424813401", "bodyText": "Ah, this is a bug of me moving this test from DateTimeUtil to this class. The DateTimeUtil has a capability to inject locale, that was done in the other test but not in this one.", "author": "DanVanAtta", "createdAt": "2020-05-14T01:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1Mjk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxNjkwMg==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424816902", "bodyText": "Turns out, we need to set the locale explicitly with the formatter for it to be used.\n0694e3c", "author": "DanVanAtta", "createdAt": "2020-05-14T01:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1Mjk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1Mzk4Mg==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424753982", "bodyText": "Judging by the other map in this class:\nShouldn't we use a Thread-Safe implementation here?", "author": "RoiEXLab", "createdAt": "2020-05-13T21:56:00Z", "path": "http-server/src/main/java/org/triplea/modules/chat/Chatters.java", "diffHunk": "@@ -24,6 +32,8 @@\n   @Getter(value = AccessLevel.PACKAGE, onMethod_ = @VisibleForTesting)\n   private final Map<String, ChatterSession> participants = new ConcurrentHashMap<>();\n \n+  private final Map<InetAddress, Instant> playerMutes = new HashMap<>();", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxMTY3MQ==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424811671", "bodyText": "I'm not sure it really helps, could be potentially cargo-culting to make it concurrent without a need.\nIn essence, the concurrency problem is not important enough to properly solve. For example, let's say we get a concurrent chat and mute at the same time. The ordering of which one will land first can be left non-deterministic.  In theory we'd have to create a lock whenever a request enters to mute and block any chat messages until that lock is clear. Simply ensuring concurrent access to the map therefore is just not enough to get proper ordering, and even then if you take an even larger perspective then network latency comes into play. On another perspective, if multiple moderators mute at the same time, one will overwrite each other, that overwrite will be non-deterministic whether we use a concurrent map or not.", "author": "DanVanAtta", "createdAt": "2020-05-14T00:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1Mzk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NzA5NA==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424757094", "bodyText": "This sounds like a good candidate for Map#computeIfPresent:\nreturn Optional.ofNullable(playerMutes.computeIfPresent(inetAddress, (key, muteInstant) -> {\n  if (muteInstant.isAfter(clock.instant())) {\n    return muteInstant;\n  }\n  return null;\n}));\nNote that I haven't actually tested this code, but it should have the exact same behaviour if the javadocs are accurate", "author": "RoiEXLab", "createdAt": "2020-05-13T22:03:19Z", "path": "http-server/src/main/java/org/triplea/modules/chat/Chatters.java", "diffHunk": "@@ -97,4 +107,73 @@ public boolean disconnectPlayerSessions(final UserName userName, final String di\n         });\n     return !sessions.isEmpty();\n   }\n+\n+  /**\n+   * Checks if a given chatter is muted, if so returns the {@code Instant} when the mute expires\n+   * otherwise returns an empty optional\n+   */\n+  public Optional<Instant> getPlayerMuteExpiration(final InetAddress inetAddress) {\n+    return getPlayerMuteExpiration(inetAddress, Clock.systemUTC());\n+  }\n+\n+  @VisibleForTesting\n+  Optional<Instant> getPlayerMuteExpiration(final InetAddress inetAddress, final Clock clock) {\n+    return Optional.ofNullable(playerMutes.get(inetAddress))\n+        .map(\n+            muteInstant -> {\n+              if (muteInstant.isAfter(clock.instant())) {\n+                return muteInstant;\n+              } else {\n+                playerMutes.remove(inetAddress);\n+                return null;\n+              }\n+            });", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxMTg3Mg==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424811872", "bodyText": "Does that remove expired mutes? The final return null seems like we might be setting a null value, it would be better though to remove the entire entry.", "author": "DanVanAtta", "createdAt": "2020-05-14T00:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NzA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkzMjcwNw==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424932707", "bodyText": "According to the Javadoc I linked it does.", "author": "RoiEXLab", "createdAt": "2020-05-14T07:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NzA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUzMzU5OQ==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r425533599", "bodyText": "Cool, I did not know that. We can also use a ternary here as well to simplify further.\nUpdated: 53b4f70", "author": "DanVanAtta", "createdAt": "2020-05-15T02:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NzA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4OTI2NQ==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r426089265", "bodyText": "I didn't know that until yesterday either, but I finally found a use-case for this method ^^", "author": "RoiEXLab", "createdAt": "2020-05-15T23:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NzA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1OTQyOQ==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424759429", "bodyText": "Thoughts on using a simple static method instead of a lambda edxpression?", "author": "RoiEXLab", "createdAt": "2020-05-13T22:08:53Z", "path": "http-server/src/main/java/org/triplea/modules/chat/event/processing/PlayerIsMutedMessage.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.triplea.modules.chat.event.processing;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import java.time.Clock;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.function.BiFunction;\n+import lombok.experimental.UtilityClass;\n+\n+@UtilityClass\n+class PlayerIsMutedMessage {\n+\n+  @VisibleForTesting\n+  static final BiFunction<Clock, Instant, String> muteDurationRemainingToString =\n+      (clock, muteExpiry) -> {\n+        final long minutes = Duration.between(clock.instant(), muteExpiry).toMinutes();\n+        return minutes > 0\n+            ? minutes + \" minutes\"\n+            : Duration.between(clock.instant(), muteExpiry).toSeconds() + \" seconds\";\n+      };", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxMjE5NA==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424812194", "bodyText": "I think this was done to be able to override and mock the function, looks like that relic. I'll look into the test cases, this probably can be a 'simple' method. On the other hand, static @VisibleForTesting methods are a code smell, likely better to make this be injected behavior.", "author": "DanVanAtta", "createdAt": "2020-05-14T00:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMzY3NA==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424823674", "bodyText": "Improved this a bit by making the bi-function to be a static inner class: b8ef3f6", "author": "DanVanAtta", "createdAt": "2020-05-14T01:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1OTQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MDExMg==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424760112", "bodyText": "I don't think it's a good thing to get different values from test cases that we make special cases for in non-test code.", "author": "RoiEXLab", "createdAt": "2020-05-13T22:10:32Z", "path": "http-server/src/main/java/org/triplea/web/socket/InetExtractor.java", "diffHunk": "@@ -15,11 +15,16 @@\n \n   @SuppressWarnings(\"UnstableApiUsage\")\n   public static InetAddress extract(final Map<String, Object> userSession) {\n-    // expected format '/127.0.0.1:42840'\n-    final String ipString = String.valueOf(userSession.get(IP_ADDRESS_KEY)).substring(1);\n+    // expected format '/127.0.0.1:42840' or (for test-cases) '127.0.0.1'", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxMjYzNw==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424812637", "bodyText": "Generally agree. I'm on the fence as it's a huge PITA for test code to inject values in the right format and creates a lot of coupling to a specific format. Probably better to create a test utility method for less coupling; So for sure this is hack, but the cost of the hack vs ROI of better test utility method is not clear.", "author": "DanVanAtta", "createdAt": "2020-05-14T00:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MDExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MTgyOA==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424761828", "bodyText": "If for some reason this test will take longer than a minute to execute we might run into a failure \ud83d\ude1b", "author": "RoiEXLab", "createdAt": "2020-05-13T22:15:00Z", "path": "http-server/src/test/java/org/triplea/modules/chat/event/processing/PlayerIsMutedMessageTest.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.triplea.modules.chat.event.processing;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.core.Is.is;\n+import static org.triplea.java.DateTimeUtil.utcInstantOf;\n+\n+import java.time.Clock;\n+import java.time.Instant;\n+import java.time.ZoneOffset;\n+import java.time.temporal.ChronoUnit;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class PlayerIsMutedMessageTest {\n+  private static final Instant CURRENT_TIME = utcInstantOf(2020, 11, 1, 2, 20);\n+\n+  @Test\n+  @DisplayName(\"Verify an example mute message calculation with 10 minutes remaining\")\n+  void verifyTimeDurationComputation() {\n+    final Instant banExpiry = CURRENT_TIME.plus(10, ChronoUnit.MINUTES);\n+\n+    final String result =\n+        PlayerIsMutedMessage.muteDurationRemainingToString.apply(\n+            Clock.fixed(CURRENT_TIME, ZoneOffset.UTC), banExpiry);\n+\n+    assertThat(result, is(\"10 minutes\"));", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxMjkxMA==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424812910", "bodyText": "Note the presence of the fixed clocks: Clock.fixed(CURRENT_TIME, ZoneOffset.UTC); that should keep this fully deterministic.", "author": "DanVanAtta", "createdAt": "2020-05-14T00:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MTgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkzMjk4Ng==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424932986", "bodyText": "Ah, missed that detail", "author": "RoiEXLab", "createdAt": "2020-05-14T07:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MTgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MjI1OA==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424762258", "bodyText": "1 second is a tight time window.\nLet's hope we never run into any issues with that. \ud83d\ude4f", "author": "RoiEXLab", "createdAt": "2020-05-13T22:16:06Z", "path": "http-server/src/test/java/org/triplea/modules/chat/event/processing/PlayerIsMutedMessageTest.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.triplea.modules.chat.event.processing;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.core.Is.is;\n+import static org.triplea.java.DateTimeUtil.utcInstantOf;\n+\n+import java.time.Clock;\n+import java.time.Instant;\n+import java.time.ZoneOffset;\n+import java.time.temporal.ChronoUnit;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class PlayerIsMutedMessageTest {\n+  private static final Instant CURRENT_TIME = utcInstantOf(2020, 11, 1, 2, 20);\n+\n+  @Test\n+  @DisplayName(\"Verify an example mute message calculation with 10 minutes remaining\")\n+  void verifyTimeDurationComputation() {\n+    final Instant banExpiry = CURRENT_TIME.plus(10, ChronoUnit.MINUTES);\n+\n+    final String result =\n+        PlayerIsMutedMessage.muteDurationRemainingToString.apply(\n+            Clock.fixed(CURRENT_TIME, ZoneOffset.UTC), banExpiry);\n+\n+    assertThat(result, is(\"10 minutes\"));\n+  }\n+\n+  @Test\n+  @DisplayName(\"Verify an example mute message calculation with seconds remaining\")\n+  void verifyTimeDurationComputationWithSecondsRemaining() {\n+    final Instant banExpiry = CURRENT_TIME.plus(20, ChronoUnit.SECONDS);\n+\n+    final String result =\n+        PlayerIsMutedMessage.muteDurationRemainingToString.apply(\n+            Clock.fixed(CURRENT_TIME, ZoneOffset.UTC), banExpiry);", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxMzA3MA==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424813070", "bodyText": "Ditto on fixed clocks, the chrono never changes.", "author": "DanVanAtta", "createdAt": "2020-05-14T00:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MjI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MjczNQ==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r424762735", "bodyText": "Thanks for merging the classes \ud83d\udc4d", "author": "RoiEXLab", "createdAt": "2020-05-13T22:17:23Z", "path": "java-extras/src/main/java/org/triplea/java/TimeManager.java", "diffHunk": "@@ -1,38 +0,0 @@\n-package org.triplea.java;", "originalCommit": "f54ba778754dc1dba196a2953e66e247bb76982f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0694e3c1b2b805b1a46b53a3e26d2266bf81d58c", "url": "https://github.com/triplea-game/triplea/commit/0694e3c1b2b805b1a46b53a3e26d2266bf81d58c", "message": "Explicitly set locale in DateTimeFormatterUtil", "committedDate": "2020-05-14T01:12:12Z", "type": "commit"}, {"oid": "3acb6493545e19cffa10631c135d4802a862f78f", "url": "https://github.com/triplea-game/triplea/commit/3acb6493545e19cffa10631c135d4802a862f78f", "message": "Update expected format string", "committedDate": "2020-05-14T01:28:06Z", "type": "commit"}, {"oid": "b8ef3f6636d9b0a1635e318665174fbb712906ae", "url": "https://github.com/triplea-game/triplea/commit/b8ef3f6636d9b0a1635e318665174fbb712906ae", "message": "Convert formatting function to be an inner class", "committedDate": "2020-05-14T01:40:03Z", "type": "commit"}, {"oid": "53b4f70e21c7b27d439300dc10db6a711d2c6888", "url": "https://github.com/triplea-game/triplea/commit/53b4f70e21c7b27d439300dc10db6a711d2c6888", "message": "Simplify, use computeIfPresent to purge expired mutes", "committedDate": "2020-05-15T02:35:31Z", "type": "commit"}, {"oid": "72b4fc7f884f22f5e24cff487991356fffcc62ef", "url": "https://github.com/triplea-game/triplea/commit/72b4fc7f884f22f5e24cff487991356fffcc62ef", "message": "Fix typo/formatting", "committedDate": "2020-05-15T04:54:22Z", "type": "commit"}, {"oid": "4140e9ea1b7b967236ef55fddfe5d18842dfe5a4", "url": "https://github.com/triplea-game/triplea/commit/4140e9ea1b7b967236ef55fddfe5d18842dfe5a4", "message": "Add @Override", "committedDate": "2020-05-15T05:10:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4ODgyOA==", "url": "https://github.com/triplea-game/triplea/pull/6466#discussion_r426088828", "bodyText": "side-note: We could store the result of Duration.between(clock.instant(), muteExpiry) in a variable instead of potentially calculating it twice, but just a minor detail", "author": "RoiEXLab", "createdAt": "2020-05-15T23:36:00Z", "path": "http-server/src/main/java/org/triplea/modules/chat/event/processing/PlayerIsMutedMessage.java", "diffHunk": "@@ -4,23 +4,34 @@\n import java.time.Clock;\n import java.time.Duration;\n import java.time.Instant;\n-import java.util.function.BiFunction;\n+import java.util.function.Function;\n+import lombok.Builder;\n import lombok.experimental.UtilityClass;\n \n @UtilityClass\n class PlayerIsMutedMessage {\n+  private static Function<Instant, String> muteDurationFormatter =\n+      MuteDurationRemainingCalculator.builder().build();\n \n+  String build(final Instant muteExpiry) {\n+    return \"You have been muted, expiring in: \" + muteDurationFormatter.apply(muteExpiry);\n+  }\n+\n+  /**\n+   * Calculates a string of how many minutes are remaining in a mute until expired, or if less than\n+   * a minute then how many seconds are left.\n+   */\n   @VisibleForTesting\n-  static final BiFunction<Clock, Instant, String> muteDurationRemainingToString =\n-      (clock, muteExpiry) -> {\n-        final long minutes = Duration.between(clock.instant(), muteExpiry).toMinutes();\n-        return minutes > 0\n-            ? minutes + \" minutes\"\n-            : Duration.between(clock.instant(), muteExpiry).toSeconds() + \" seconds\";\n-      };\n+  @Builder\n+  static class MuteDurationRemainingCalculator implements Function<Instant, String> {\n+    @Builder.Default private Clock clock = Clock.systemUTC();\n \n-  String build(final Instant muteExpiry) {\n-    return \"You have been muted, expiring in: \"\n-        + muteDurationRemainingToString.apply(Clock.systemUTC(), muteExpiry);\n+    @Override\n+    public String apply(final Instant muteExpiry) {\n+      final long minutes = Duration.between(clock.instant(), muteExpiry).toMinutes();\n+      return minutes > 0\n+          ? minutes + \" minutes\"\n+          : Duration.between(clock.instant(), muteExpiry).toSeconds() + \" seconds\";", "originalCommit": "4140e9ea1b7b967236ef55fddfe5d18842dfe5a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}