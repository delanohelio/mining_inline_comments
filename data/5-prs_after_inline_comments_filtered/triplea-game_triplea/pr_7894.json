{"pr_number": 7894, "pr_title": "Option to load any save", "pr_createdAt": "2020-10-13T02:14:53Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7894", "timeline": [{"oid": "ba1c2a5f5776a7133dbeed9fda8fd3728aebc73a", "url": "https://github.com/triplea-game/triplea/commit/ba1c2a5f5776a7133dbeed9fda8fd3728aebc73a", "message": "Refactor, extract save-game loading compatibility check to its own method", "committedDate": "2020-10-13T01:21:29Z", "type": "commit"}, {"oid": "c0c629d88be96d28e35da78f71b29bb57a4ac07d", "url": "https://github.com/triplea-game/triplea/commit/c0c629d88be96d28e35da78f71b29bb57a4ac07d", "message": "Add an override setting to 'force' load any save game regardless of version", "committedDate": "2020-10-13T02:13:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYyOTQ4OQ==", "url": "https://github.com/triplea-game/triplea/pull/7894#discussion_r503629489", "bodyText": "Avoid too many return statements within this method.", "author": "codeclimate", "createdAt": "2020-10-13T02:22:13Z", "path": "game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java", "diffHunk": "@@ -61,62 +62,70 @@ private GameDataManager() {}\n    *     closing this stream; it will not be closed when this method returns.\n    * @return The loaded game data, or an empty optional if an error occurs.\n    */\n-  @SuppressWarnings(\"deprecation\")\n   public static Optional<GameData> loadGame(final InputStream is) {\n     try (ObjectInputStream input = new ObjectInputStream(new GZIPInputStream(is))) {\n       final Object version = input.readObject();\n \n-      if (version instanceof games.strategy.util.Version) {\n-        log.warn(\n-            String.format(\n-                \"Incompatible engine versions. We are: %s<br>\"\n-                    + \"Trying to load incompatible save game version: %s<br>\"\n-                    + \"To download an older version of TripleA,<br>\"\n-                    + \"please visit: <a href=\\\"%s\\\">%s</a>\",\n-                ClientContext.engineVersion(),\n-                ((games.strategy.util.Version) version).getExactVersion(),\n-                UrlConstants.OLD_DOWNLOADS_WEBSITE,\n-                UrlConstants.OLD_DOWNLOADS_WEBSITE));\n-        return Optional.empty();\n-      } else if (!(version instanceof Version)) {\n-        log.warn(\n-            \"Incompatible engine version with save game, \"\n-                + \"unable to determine version of the save game\");\n-        return Optional.empty();\n-      } else if (ClientContext.engineVersion().getMajor() != ((Version) version).getMajor()) {\n-        log.warn(\n-            String.format(\n-                \"Incompatible engine versions. We are: %s<br>\"\n-                    + \"Trying to load game created with: %s<br>\"\n-                    + \"To download the latest version of TripleA,<br>\"\n-                    + \"please visit: <a href=\\\"%s\\\">%s</a>\",\n-                ClientContext.engineVersion(),\n-                version,\n-                UrlConstants.DOWNLOAD_WEBSITE,\n-                UrlConstants.DOWNLOAD_WEBSITE));\n-        return Optional.empty();\n-      } else if (!HeadlessGameServer.headless()\n-          && ((Version) version).getMinor() > ClientContext.engineVersion().getMinor()) {\n-        // Prompt the user to upgrade\n-        log.warn(\n-            \"This save was made by a newer version of TripleA.<br>\"\n-                + \"To load this save, download the latest version of TripleA: \"\n-                + \"<a href=\\\"{}\\\">{}</a>\",\n-            UrlConstants.DOWNLOAD_WEBSITE,\n-            UrlConstants.DOWNLOAD_WEBSITE);\n-        return Optional.empty();\n-      } else {\n+      if (isCompatibleVersion(version) || !ClientSetting.saveGameCompatibilityCheck.getSetting()) {\n         final GameData data = (GameData) input.readObject();\n         data.postDeSerialize();\n         loadDelegates(input, data);\n         return Optional.of(data);\n+      } else {\n+        return Optional.empty();\n       }\n     } catch (final ClassNotFoundException | IOException e) {\n       log.error(\"Error loading game data\", e);\n       return Optional.empty();\n     }\n   }\n \n+  @SuppressWarnings(\"deprecation\")\n+  private static boolean isCompatibleVersion(final Object version) {\n+    if (version instanceof games.strategy.util.Version) {\n+      log.warn(\n+          String.format(\n+              \"Incompatible engine versions. We are: %s<br>\"\n+                  + \"Trying to load incompatible save game version: %s<br>\"\n+                  + \"To download an older version of TripleA,<br>\"\n+                  + \"please visit: <a href=\\\"%s\\\">%s</a>\",\n+              ClientContext.engineVersion(),\n+              ((games.strategy.util.Version) version).getExactVersion(),\n+              UrlConstants.OLD_DOWNLOADS_WEBSITE,\n+              UrlConstants.OLD_DOWNLOADS_WEBSITE));\n+      return false;", "originalCommit": "c0c629d88be96d28e35da78f71b29bb57a4ac07d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}