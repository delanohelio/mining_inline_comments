{"pr_number": 8510, "pr_title": "Fix concurrent modification exception when setting player colors", "pr_createdAt": "2020-12-25T18:37:34Z", "pr_url": "https://github.com/triplea-game/triplea/pull/8510", "timeline": [{"oid": "80488cf0194359b2e47314329d62c4f271cd6474", "url": "https://github.com/triplea-game/triplea/commit/80488cf0194359b2e47314329d62c4f271cd6474", "message": "Fix concurrent modification exception when setting player colors\n\nWhen launching the game, we can get a 'ConcurrentModificationException'\nwhen player colors are assigned.\n\nThis fix reverts to using a non-atomic add to the player color map\nand removes usage of 'computeIfAbsent' (which is not thread-safe).\n\nBecause we set the player color to the same value, but possibly doing\nso concurrently, we do not need a thread-safe nor atomic add of the\nplayer color (we just need it to work). By going to a non-atomic\nversion, we avoid code that would otherwise throw a\n'ConcurrentModificationException' on concurrent adds.", "committedDate": "2020-12-25T18:34:29Z", "type": "commit"}, {"oid": "9aaabc346cddbad19e6d8b276b6361e13da50757", "url": "https://github.com/triplea-game/triplea/commit/9aaabc346cddbad19e6d8b276b6361e13da50757", "message": "Merge 80488cf0194359b2e47314329d62c4f271cd6474 into 000bd8e884c645fe8f69def1bfb89dc8e25286bf", "committedDate": "2020-12-25T18:37:35Z", "type": "commit"}, {"oid": "f647694b8c822c9d1a7b99df0ce46c90b39398e1", "url": "https://github.com/triplea-game/triplea/commit/f647694b8c822c9d1a7b99df0ce46c90b39398e1", "message": "Auto-Formatting", "committedDate": "2020-12-25T18:39:15Z", "type": "commit"}, {"oid": "7f1b90e23296be721cba7d8371e08e47a3cc79cf", "url": "https://github.com/triplea-game/triplea/commit/7f1b90e23296be721cba7d8371e08e47a3cc79cf", "message": "Merge remote-tracking branch 'origin/master' into fix-concurrent-player-color", "committedDate": "2020-12-26T19:08:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg4MjA0NA==", "url": "https://github.com/triplea-game/triplea/pull/8510#discussion_r550882044", "bodyText": "Feel free to correct me if I'm wrong but isn't a ConcurrentModificationException a more correct behaviour?\nIf for example 2 Threads try to query the player name at the same time, with this code no exception would be thrown, but it could happen that the code computes 2 different colors, which are both returned, but only one of them is stored in the map.\nUnlikely scenario, but we might want to consider using a synchronized/concurrent Map instead", "author": "RoiEXLab", "createdAt": "2021-01-02T13:28:35Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/PlayerColors.java", "diffHunk": "@@ -48,7 +48,14 @@ Color getPlayerColor(final String playerName) {\n         \"Illegal player name: %s, use the method 'getImpassableColor()' instead\",\n         playerName);\n \n-    return playerColors.computeIfAbsent(playerName, this::computePlayerColor);\n+    // NOTE: we do *not* use computeIfAbsent here to avoid\n+    // 'java.util.ConcurrentModificationException'\n+    Color playerColor = playerColors.get(playerName);\n+    if (playerColor == null) {\n+      playerColor = computePlayerColor(playerName);\n+      playerColors.put(playerName, playerColor);\n+    }\n+    return playerColor;", "originalCommit": "7f1b90e23296be721cba7d8371e08e47a3cc79cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkxMjQ5Mw==", "url": "https://github.com/triplea-game/triplea/pull/8510#discussion_r550912493", "bodyText": "This is an example of resolving the race condition by 'let it happen'.\nIn this case, the update is to the same value, we guaranteed that player color computation is deterministic.", "author": "DanVanAtta", "createdAt": "2021-01-02T19:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg4MjA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkxMjc3NA==", "url": "https://github.com/triplea-game/triplea/pull/8510#discussion_r550912774", "bodyText": "Let's also consider if we were to resolve the race condition via exception and that the colors were different. In this case one writer could write a value, the value then read by another reader. The other writer would come in and set the value to something else, meanwhile the other reader has the old value, and that would be incorrect. Having a concurrent exception does not solve the race condition as we need to be sure that any readers are going to get consistent results. So this is properly solved with deterministic player color computation (nonetheless it getting written multiple times is not clean).", "author": "DanVanAtta", "createdAt": "2021-01-02T19:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg4MjA0NA=="}], "type": "inlineReview"}]}