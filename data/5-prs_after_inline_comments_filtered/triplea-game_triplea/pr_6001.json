{"pr_number": 6001, "pr_title": "Game runner extract main frame", "pr_createdAt": "2020-03-04T04:15:00Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6001", "timeline": [{"oid": "44e96074eeb162f161794a6e89f6c8fda435d603", "url": "https://github.com/triplea-game/triplea/commit/44e96074eeb162f161794a6e89f6c8fda435d603", "message": "Move GameSelectorModel, colocate with GameSelectorPanel", "committedDate": "2020-03-04T02:23:36Z", "type": "commit"}, {"oid": "3553a098fa19a38fecaa0b5826a83995053c7aad", "url": "https://github.com/triplea-game/triplea/commit/3553a098fa19a38fecaa0b5826a83995053c7aad", "message": "Simplify GameRunner - Encapsulate MainFrame in its own class, migrate BackGroundTaskRunner usages", "committedDate": "2020-03-04T02:58:10Z", "type": "commit"}, {"oid": "321a066530ee09d63aa3835dbcb86d583b7be2e8", "url": "https://github.com/triplea-game/triplea/commit/321a066530ee09d63aa3835dbcb86d583b7be2e8", "message": "Simplify GameRunner - inline usages of JOptionPane, remove dependencies on mainFrame", "committedDate": "2020-03-04T03:19:47Z", "type": "commit"}, {"oid": "17d5462ef4c4623c4734f3a09c2640a027ce0aa9", "url": "https://github.com/triplea-game/triplea/commit/17d5462ef4c4623c4734f3a09c2640a027ce0aa9", "message": "Simplify GameRunner - Move more mainFrame dependencies", "committedDate": "2020-03-04T03:33:43Z", "type": "commit"}, {"oid": "1cb620733286f95bb0a47f0352ec7e7786f81304", "url": "https://github.com/triplea-game/triplea/commit/1cb620733286f95bb0a47f0352ec7e7786f81304", "message": "Show main frame fix", "committedDate": "2020-03-04T03:36:33Z", "type": "commit"}, {"oid": "87dfca2f84eda300cc7cde62c0d9a805758a8f3d", "url": "https://github.com/triplea-game/triplea/commit/87dfca2f84eda300cc7cde62c0d9a805758a8f3d", "message": "Formatting and remove commented out code", "committedDate": "2020-03-04T03:37:53Z", "type": "commit"}, {"oid": "0452f416debaa416d8f0d1e8923ad6edc59a792d", "url": "https://github.com/triplea-game/triplea/commit/0452f416debaa416d8f0d1e8923ad6edc59a792d", "message": "Style fix and javadoc MainFrame", "committedDate": "2020-03-04T03:50:09Z", "type": "commit"}, {"oid": "75787e250d801c6fcb2f8bffb9c1b0a988bc6cb6", "url": "https://github.com/triplea-game/triplea/commit/75787e250d801c6fcb2f8bffb9c1b0a988bc6cb6", "message": "Remove unnecessary private field", "committedDate": "2020-03-04T03:54:22Z", "type": "commit"}, {"oid": "dcbb5da7f7909f2240ccc2bf55abd5f01fd184a9", "url": "https://github.com/triplea-game/triplea/commit/dcbb5da7f7909f2240ccc2bf55abd5f01fd184a9", "message": "Move test to mirror prod class file move", "committedDate": "2020-03-04T04:01:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0MTAzNw==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387441037", "bodyText": "@RoiEXLab this was removed as it does not seem to belong in the JavaFx componentry. This invocation seemed like an intermediary step to get java fx working. I'm hoping we can circle back and get this fixed correctly and not have swing dependencies in JavaFx, all in part of fixing up the game startup models.\nI tried to test if this had an impact, and was getting an error launching this class:\n\nError: JavaFX runtime components are missing, and are required to run this application", "author": "DanVanAtta", "createdAt": "2020-03-04T04:16:51Z", "path": "game-headed-javafx/src/main/java/org/triplea/game/client/ui/javafx/TripleA.java", "diffHunk": "@@ -40,10 +37,6 @@ public void start(final Stage stage) {\n     navigationPane.switchScreen(FxmlManager.MAIN_MENU_PANE);\n \n     setupStage(stage, scene, loadedNode.getController());\n-    // Don't invoke Swing if headless (for example in tests)\n-    if (!GraphicsEnvironment.isHeadless()) {\n-      SwingUtilities.invokeLater(GameRunner::newMainFrame);\n-    }", "originalCommit": "dcbb5da7f7909f2240ccc2bf55abd5f01fd184a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUwNTIxMg==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387505212", "bodyText": "Did you launch this class via the new RunConfiguration?\nThere seems to be an issue with JavaFX where it can't find the components when the main class extends application and is not a module", "author": "RoiEXLab", "createdAt": "2020-03-04T08:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0MTAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUzMTM5OQ==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387531399", "bodyText": "Ah, thanks for pointing out the run configuration. \ud83d\udc4d\nThe JavaFx variant launches both before and after this update. Admittedly that was not a very thorough regression check.", "author": "DanVanAtta", "createdAt": "2020-03-04T09:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0MTAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1MjkzNQ==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387552935", "bodyText": "Try launching a game once.\nThe reason I introduced those 3 lines of code is because originally some swing code I invoke at some point actually expects this mainframe to exist, otherwise an NPE will be thrown.\nThe reason for the headless check was because we initially had some javafx integration tests that basically clicked through the screens, but this framework is only able to create dummy javafx components, so swing just crashed the test.", "author": "RoiEXLab", "createdAt": "2020-03-04T09:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0MTAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2Mjc2MA==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387762760", "bodyText": "This cyclic dependency is weird. I wonder if it's better to pass some sort of CompletableFuture<JFrame> to the constructor and \"complete\" it once the frame is ready.\nIn any case some sort of check that the ui isn't set more than once would be nice", "author": "RoiEXLab", "createdAt": "2020-03-04T15:58:41Z", "path": "game-core/src/main/java/games/strategy/engine/framework/startup/mc/SetupPanelModel.java", "diffHunk": "@@ -35,7 +35,7 @@\n   protected SetupPanel panel = null;\n \n   @Setter private Consumer<SetupPanel> panelChangeListener;\n-  @Nonnull private final JFrame ui;\n+  @Setter private JFrame ui;", "originalCommit": "dcbb5da7f7909f2240ccc2bf55abd5f01fd184a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzc1Mw==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387923753", "bodyText": "Generally agree, though I think we can skip that step. SetupPanelModel should not even have a reference to the UI other than an interface for the 'setupPanel', and certainly should not have a reference to the main frame. The dialogs that are displayed from this model class that need a 'parent' reference all do not belong.", "author": "DanVanAtta", "createdAt": "2020-03-04T20:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2Mjc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2Njg4Mg==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387766882", "bodyText": "One difference this is probably going to cause is that the dialogs now no longer share the icon with the main frame, this problem can be found in different places too though.\nAlso it might be no longer on top of the mainframe", "author": "RoiEXLab", "createdAt": "2020-03-04T16:04:29Z", "path": "game-core/src/main/java/games/strategy/engine/framework/startup/ui/posted/game/pbem/EmailSenderEditor.java", "diffHunk": "@@ -181,8 +180,8 @@ private void testEmail() {\n                 final int finalMessageType = messageType;\n                 SwingUtilities.invokeLater(\n                     () ->\n-                        GameRunner.showMessageDialog(\n-                            finalMessage, GameRunner.Title.of(\"Email Test\"), finalMessageType));\n+                        JOptionPane.showMessageDialog(\n+                            null, finalMessage, \"Email Test\", finalMessageType));", "originalCommit": "dcbb5da7f7909f2240ccc2bf55abd5f01fd184a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNDExMA==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387924110", "bodyText": "The icon is significant, though the number of dialogs impacts is limited and they are not used that often. For now decided to favor dis-entangling things.", "author": "DanVanAtta", "createdAt": "2020-03-04T20:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2Njg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2ODk2OQ==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387768969", "bodyText": "I think those static actions should be moved up one call layer:\nI'f this constructor is ever called tice this could result in weird problems", "author": "RoiEXLab", "createdAt": "2020-03-04T16:07:36Z", "path": "game-core/src/main/java/games/strategy/engine/framework/ui/MainFrame.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package games.strategy.engine.framework.ui;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.GameRunner;\n+import games.strategy.engine.framework.lookandfeel.LookAndFeelSwingFrameListener;\n+import games.strategy.engine.framework.startup.mc.SetupPanelModel;\n+import games.strategy.engine.framework.startup.ui.panels.main.MainPanelBuilder;\n+import games.strategy.engine.framework.startup.ui.panels.main.game.selector.GameSelectorModel;\n+import games.strategy.engine.framework.ui.background.BackgroundTaskRunner;\n+import java.awt.event.WindowEvent;\n+import javax.swing.JFrame;\n+import javax.swing.SwingUtilities;\n+import javax.swing.WindowConstants;\n+import org.triplea.swing.JFrameBuilder;\n+\n+/** Represents the outermost JFrame, maintains the reference to it and controls access. */\n+public class MainFrame {\n+\n+  private static MainFrame instance;\n+\n+  private JFrame mainFrame;\n+\n+  private MainFrame(\n+      final SetupPanelModel setupPanelModel, final GameSelectorModel gameSelectorModel) {\n+    mainFrame =\n+        JFrameBuilder.builder()\n+            .title(\"TripleA\")\n+            .windowClosedAction(GameRunner::exitGameIfFinished)\n+            .build();\n+    BackgroundTaskRunner.setMainFrame(mainFrame);\n+\n+    LookAndFeelSwingFrameListener.register(mainFrame);", "originalCommit": "dcbb5da7f7909f2240ccc2bf55abd5f01fd184a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNDg2Mw==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387924863", "bodyText": "The constructor is private, the factory method checks that the static instance is not yet set. One level higher is 'GameRunner', part of the goal is to remove anything UI or swing related out of GameRunner.", "author": "DanVanAtta", "createdAt": "2020-03-04T20:47:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2ODk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzMDUxMA==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387930510", "bodyText": "By \"one level higher\" I was actually reffering to the static method inside this class rather than the constructor", "author": "RoiEXLab", "createdAt": "2020-03-04T20:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2ODk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc3MjI2MA==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387772260", "bodyText": "Hmm I wonder if this really needs to be changed, would anything speak against the callers explicitly passing some sort of frame (not necessarily the main frame) and adding a deprecated getter for the singleton frame if needed?", "author": "RoiEXLab", "createdAt": "2020-03-04T16:12:34Z", "path": "game-core/src/main/java/games/strategy/engine/framework/ui/background/BackgroundTaskRunner.java", "diffHunk": "@@ -11,17 +12,17 @@\n import javax.swing.JFrame;\n import javax.swing.SwingUtilities;\n import javax.swing.SwingWorker;\n-import org.triplea.java.Interruptibles;\n+import lombok.experimental.UtilityClass;\n import org.triplea.java.function.ThrowingSupplier;\n \n /** Provides methods for running tasks in the background to avoid blocking the UI. */\n+@UtilityClass\n public final class BackgroundTaskRunner {\n-  private final JFrame frame;\n+  private static JFrame mainFrame;\n \n-  public BackgroundTaskRunner(final JFrame frame) {\n-    checkNotNull(frame);\n-\n-    this.frame = frame;\n+  public static void setMainFrame(final JFrame mainFrame) {\n+    Preconditions.checkState(BackgroundTaskRunner.mainFrame == null);\n+    BackgroundTaskRunner.mainFrame = mainFrame;\n   }", "originalCommit": "dcbb5da7f7909f2240ccc2bf55abd5f01fd184a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTgzNA==", "url": "https://github.com/triplea-game/triplea/pull/6001#discussion_r387925834", "bodyText": "Previously we always passed the main frame, so in part I'm not seeking to change too much at any one time. Passing other frames would be a really different type of change. The getter I'd like to avoid so that we have the 'mainFrame' pushing its reference and using 'setters' rather than other elements using 'getter' to get the reference (essentially an application of IOC, or the \"we'll call you, don't call us\" principle)", "author": "DanVanAtta", "createdAt": "2020-03-04T20:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc3MjI2MA=="}], "type": "inlineReview"}]}