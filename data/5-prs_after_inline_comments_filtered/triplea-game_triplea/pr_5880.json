{"pr_number": 5880, "pr_title": "MapData - find islands refactor", "pr_createdAt": "2020-01-25T12:10:07Z", "pr_url": "https://github.com/triplea-game/triplea/pull/5880", "timeline": [{"oid": "81542b9bf2c94ca3b0a36f10c6b084ec777afdb4", "url": "https://github.com/triplea-game/triplea/commit/81542b9bf2c94ca3b0a36f10c6b084ec777afdb4", "message": "Move 'initializeContains' method (breaking)", "committedDate": "2020-01-25T08:54:14Z", "type": "commit"}, {"oid": "89b227bb1b4b893113000fa6f6b2eac0a5689099", "url": "https://github.com/triplea-game/triplea/commit/89b227bb1b4b893113000fa6f6b2eac0a5689099", "message": "Fix 'initializeContains' and inject dependencies (fixing)", "committedDate": "2020-01-25T09:07:10Z", "type": "commit"}, {"oid": "e101dd02f4ec2fbb3487c8d0f96ac7fbc276da03", "url": "https://github.com/triplea-game/triplea/commit/e101dd02f4ec2fbb3487c8d0f96ac7fbc276da03", "message": "Rename method: initializeContains -> findIslands, and add javadoc", "committedDate": "2020-01-25T09:16:07Z", "type": "commit"}, {"oid": "327ecdb31762f81056c8a70bd79aa94788e9eb98", "url": "https://github.com/triplea-game/triplea/commit/327ecdb31762f81056c8a70bd79aa94788e9eb98", "message": "Rename class: TerritoryContainsTerritoryAnalyzer->IslandTerritoryFinder", "committedDate": "2020-01-25T09:24:13Z", "type": "commit"}, {"oid": "a75256b4b2f7f0ddca8946cadc1db4f813bddea1", "url": "https://github.com/triplea-game/triplea/commit/a75256b4b2f7f0ddca8946cadc1db4f813bddea1", "message": "Improve mapData encapsulation, change \"hasContainedTerritory(territory)\" to return polygons of contained territories", "committedDate": "2020-01-25T09:27:35Z", "type": "commit"}, {"oid": "753a7576c39b19710ead410fb1feb356a1f58543", "url": "https://github.com/triplea-game/triplea/commit/753a7576c39b19710ead410fb1feb356a1f58543", "message": "Move common if/else operation to outside of if/else branch", "committedDate": "2020-01-25T09:29:27Z", "type": "commit"}, {"oid": "26ec9aed1a2f49298388d2cea9f5c413da03f6d2", "url": "https://github.com/triplea-game/triplea/commit/26ec9aed1a2f49298388d2cea9f5c413da03f6d2", "message": "Replace assignment to \"points\" variable with ternary", "committedDate": "2020-01-25T09:30:27Z", "type": "commit"}, {"oid": "ff6abd8b7564617e56710716fe7d1d0cc9458c34", "url": "https://github.com/triplea-game/triplea/commit/ff6abd8b7564617e56710716fe7d1d0cc9458c34", "message": "Add a Unit test for IslandTerritoryFinder", "committedDate": "2020-01-25T10:36:39Z", "type": "commit"}, {"oid": "bc90a0b8c4840bf08adce9687eecc4c99a2aa894", "url": "https://github.com/triplea-game/triplea/commit/bc90a0b8c4840bf08adce9687eecc4c99a2aa894", "message": "Return Set of territories instead of List, extract sea and land territory computation", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "85873618ddc580cdb2a3ca7362aec836f6878600", "url": "https://github.com/triplea-game/triplea/commit/85873618ddc580cdb2a3ca7362aec836f6878600", "message": "Extract inner for loop, findIsland, to a method", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "797b9bd49e814f80df10a020271e034bc38f6e6d", "url": "https://github.com/triplea-game/triplea/commit/797b9bd49e814f80df10a020271e034bc38f6e6d", "message": "Convert extracted method for loop to a stream", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "2eb71cc80a7e15bf96e18500b2f697eff90cc091", "url": "https://github.com/triplea-game/triplea/commit/2eb71cc80a7e15bf96e18500b2f697eff90cc091", "message": "Convert predicate to an extracted method and add javadocs", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "ebcf987b4b92c33701144437fef76d685765c8ed", "url": "https://github.com/triplea-game/triplea/commit/ebcf987b4b92c33701144437fef76d685765c8ed", "message": "Rename variable \"contained\" -> \"islands\"", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "b3595058fd36f9b23ea8f1e2013d8c582211fade", "url": "https://github.com/triplea-game/triplea/commit/b3595058fd36f9b23ea8f1e2013d8c582211fade", "message": "Use named helper methods to do territory filtering", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "5254cd8a5b725c42a22f0f45eaf40ef1d4f24c08", "url": "https://github.com/triplea-game/triplea/commit/5254cd8a5b725c42a22f0f45eaf40ef1d4f24c08", "message": "Replace null indicating no islands with empty list, remove null check.", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "f0fd924cee4c74b2e0c869f5e4dc87dc660088b9", "url": "https://github.com/triplea-game/triplea/commit/f0fd924cee4c74b2e0c869f5e4dc87dc660088b9", "message": "Rewrite mapping for loop to a stream", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "02b70a10a99500fd3f167fb4cc04bb07fc36a54c", "url": "https://github.com/triplea-game/triplea/commit/02b70a10a99500fd3f167fb4cc04bb07fc36a54c", "message": "Formatting", "committedDate": "2020-01-25T11:46:11Z", "type": "commit"}, {"oid": "cdc4d2a908e617d501daa6c7cd1166c8d27b2550", "url": "https://github.com/triplea-game/triplea/commit/cdc4d2a908e617d501daa6c7cd1166c8d27b2550", "message": "Last refactor, push polygon function deeper into the call stack", "committedDate": "2020-01-25T12:06:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzNTAwMA==", "url": "https://github.com/triplea-game/triplea/pull/5880#discussion_r370935000", "bodyText": "I think it's worth explicitly clarifying that the land must be contained within a single sea territory and not just within 2 joined sea territories.\nIt does make sense from a code perspective, but from a real-world perspective this might be confusing.", "author": "RoiEXLab", "createdAt": "2020-01-25T13:59:10Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/IslandTerritoryFinder.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package games.strategy.triplea.ui.mapdata;\n+\n+import games.strategy.ui.Util;\n+import java.awt.Polygon;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import lombok.experimental.UtilityClass;\n+\n+@UtilityClass\n+class IslandTerritoryFinder {\n+\n+  /**\n+   * Finds all island territories given a set of territory names and their corresponding polygons.\n+   * An island is defined as a land territory that is contained within a sea territory.", "originalCommit": "cdc4d2a908e617d501daa6c7cd1166c8d27b2550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk1NjQzMQ==", "url": "https://github.com/triplea-game/triplea/pull/5880#discussion_r370956431", "bodyText": "Updated javadoc to be a bit more clear on this: 99fc238", "author": "DanVanAtta", "createdAt": "2020-01-25T21:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzNTAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzNTE4NQ==", "url": "https://github.com/triplea-game/triplea/pull/5880#discussion_r370935185", "bodyText": "Would Function.identity() work here?", "author": "RoiEXLab", "createdAt": "2020-01-25T14:02:39Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/IslandTerritoryFinder.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package games.strategy.triplea.ui.mapdata;\n+\n+import games.strategy.ui.Util;\n+import java.awt.Polygon;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import lombok.experimental.UtilityClass;\n+\n+@UtilityClass\n+class IslandTerritoryFinder {\n+\n+  /**\n+   * Finds all island territories given a set of territory names and their corresponding polygons.\n+   * An island is defined as a land territory that is contained within a sea territory.\n+   *\n+   * <p>Warning: territories may consist of multiple polygons, only the first polygon is checked.\n+   *\n+   * @param polygons Mapping of territory names to the polygons representing that territories.\n+   * @return A mapping of sea territory names to the name of land territories that are islands\n+   *     contained by each corresponding sea territory.\n+   */\n+  static Map<String, Set<String>> findIslands(final Map<String, List<Polygon>> polygons) {\n+    final Set<String> seaTerritories = filterSeaTerritories(polygons.keySet());\n+    final Set<String> landTerritories = filterNotSeaTerritories(polygons.keySet());\n+\n+    // map sea territories to: sea territory name -> islands contained by that sea territory\n+    return seaTerritories.stream()\n+        .collect(\n+            Collectors.toMap(sea -> sea, findIslandsForSeaTerritory(landTerritories, polygons)));", "originalCommit": "cdc4d2a908e617d501daa6c7cd1166c8d27b2550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk1NjUxOA==", "url": "https://github.com/triplea-game/triplea/pull/5880#discussion_r370956518", "bodyText": "It seems to, yes: 30db1cf", "author": "DanVanAtta", "createdAt": "2020-01-25T21:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzNTE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzNjU3MA==", "url": "https://github.com/triplea-game/triplea/pull/5880#discussion_r370936570", "bodyText": "2 things:\n\nThis is a map of lists, so instead of using list.iterator().next(), you could as well use list.get(0) directly\nDoes it make sense to check the size of the list before? If the lists was empty for some reason, this would result in an exception. If there are more than 1 polygon (which is mentioned somewhere in the javadocs) this would be silently ignore all the other polygons", "author": "RoiEXLab", "createdAt": "2020-01-25T14:35:19Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/IslandTerritoryFinder.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package games.strategy.triplea.ui.mapdata;\n+\n+import games.strategy.ui.Util;\n+import java.awt.Polygon;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import lombok.experimental.UtilityClass;\n+\n+@UtilityClass\n+class IslandTerritoryFinder {\n+\n+  /**\n+   * Finds all island territories given a set of territory names and their corresponding polygons.\n+   * An island is defined as a land territory that is contained within a sea territory.\n+   *\n+   * <p>Warning: territories may consist of multiple polygons, only the first polygon is checked.\n+   *\n+   * @param polygons Mapping of territory names to the polygons representing that territories.\n+   * @return A mapping of sea territory names to the name of land territories that are islands\n+   *     contained by each corresponding sea territory.\n+   */\n+  static Map<String, Set<String>> findIslands(final Map<String, List<Polygon>> polygons) {\n+    final Set<String> seaTerritories = filterSeaTerritories(polygons.keySet());\n+    final Set<String> landTerritories = filterNotSeaTerritories(polygons.keySet());\n+\n+    // map sea territories to: sea territory name -> islands contained by that sea territory\n+    return seaTerritories.stream()\n+        .collect(\n+            Collectors.toMap(sea -> sea, findIslandsForSeaTerritory(landTerritories, polygons)));\n+  }\n+\n+  private static Set<String> filterSeaTerritories(final Set<String> territoryNames) {\n+    return filterTerritories(territoryNames, Util::isTerritoryNameIndicatingWater);\n+  }\n+\n+  private static Set<String> filterNotSeaTerritories(final Set<String> territoryNames) {\n+    return filterTerritories(territoryNames, Predicate.not(Util::isTerritoryNameIndicatingWater));\n+  }\n+\n+  /** Returns a subset of territories matching a given filter. */\n+  private static Set<String> filterTerritories(\n+      final Set<String> territoryNames, final Predicate<String> territoryFilter) {\n+    return territoryNames.stream().filter(territoryFilter).collect(Collectors.toSet());\n+  }\n+\n+  /** Find all land territories contained by a given sea territory. */\n+  private static Function<String, Set<String>> findIslandsForSeaTerritory(\n+      final Set<String> landTerritories, final Map<String, List<Polygon>> polygons) {\n+\n+    return seaTerritory ->\n+        landTerritories.stream()\n+            .filter(landIsContainedBySeaTerritory(seaTerritory, polygons))\n+            .collect(Collectors.toSet());\n+  }\n+\n+  /** Checks that a given land territory would be contained by a given sea territory. */\n+  private Predicate<String> landIsContainedBySeaTerritory(\n+      final String seaTerritory, final Map<String, List<Polygon>> polygons) {\n+\n+    // Function where given a territory name, give us a polygon for that territory\n+    final Function<String, Polygon> polygonLookup =\n+        territoryName -> polygons.get(territoryName).iterator().next();", "originalCommit": "cdc4d2a908e617d501daa6c7cd1166c8d27b2550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk1NjU0OA==", "url": "https://github.com/triplea-game/triplea/pull/5880#discussion_r370956548", "bodyText": "Original implementation here; I think the polygon reader ensures that we get at least one polygon. I suspect there is further improvement to be had here.", "author": "DanVanAtta", "createdAt": "2020-01-25T21:15:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzNjU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzNzM0MQ==", "url": "https://github.com/triplea-game/triplea/pull/5880#discussion_r370937341", "bodyText": "Another quick thought:\nWhat about making this class non-static and make the polygon map an actual field?\nThis way a lot of lambdas could be turned into private methods and there would be no need to pass this map to almost every method.", "author": "RoiEXLab", "createdAt": "2020-01-25T14:51:31Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/IslandTerritoryFinder.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package games.strategy.triplea.ui.mapdata;\n+\n+import games.strategy.ui.Util;\n+import java.awt.Polygon;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import lombok.experimental.UtilityClass;\n+\n+@UtilityClass\n+class IslandTerritoryFinder {\n+\n+  /**\n+   * Finds all island territories given a set of territory names and their corresponding polygons.\n+   * An island is defined as a land territory that is contained within a sea territory.\n+   *\n+   * <p>Warning: territories may consist of multiple polygons, only the first polygon is checked.\n+   *\n+   * @param polygons Mapping of territory names to the polygons representing that territories.\n+   * @return A mapping of sea territory names to the name of land territories that are islands\n+   *     contained by each corresponding sea territory.\n+   */\n+  static Map<String, Set<String>> findIslands(final Map<String, List<Polygon>> polygons) {", "originalCommit": "cdc4d2a908e617d501daa6c7cd1166c8d27b2550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk1NjYwOA==", "url": "https://github.com/triplea-game/triplea/pull/5880#discussion_r370956608", "bodyText": "Not a bad thought, though I think that might be going the wrong direction. It's probably better to try and collapse methods where it makes sense rather than storing state.", "author": "DanVanAtta", "createdAt": "2020-01-25T21:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzNzM0MQ=="}], "type": "inlineReview"}, {"oid": "99fc238388954393f21e5bf4566f299171efadb9", "url": "https://github.com/triplea-game/triplea/commit/99fc238388954393f21e5bf4566f299171efadb9", "message": "Add javadoc clarification on sea to island relationship", "committedDate": "2020-01-25T20:54:57Z", "type": "commit"}, {"oid": "30db1cf9bbb5abcdae68b00cc6283f65c13fb9fb", "url": "https://github.com/triplea-game/triplea/commit/30db1cf9bbb5abcdae68b00cc6283f65c13fb9fb", "message": "Use function.identity", "committedDate": "2020-01-25T21:13:37Z", "type": "commit"}]}