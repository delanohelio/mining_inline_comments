{"pr_number": 3130, "pr_title": "Extract SettingsHelper from SearchHelper", "pr_createdAt": "2020-04-28T18:38:41Z", "pr_url": "https://github.com/oracle/opengrok/pull/3130", "timeline": [{"oid": "497eb8c94314a1bc20d5469acf5159e9b6904f21", "url": "https://github.com/oracle/opengrok/commit/497eb8c94314a1bc20d5469acf5159e9b6904f21", "message": "Extract SettingsHelper from SearchHelper", "committedDate": "2020-04-27T23:57:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNTk3Nw==", "url": "https://github.com/oracle/opengrok/pull/3130#discussion_r417115977", "bodyText": "k is not very descriptive", "author": "tulinkry", "createdAt": "2020-04-29T07:25:44Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/search/SettingsHelper.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.\n+ * Portions copyright (c) 2011 Jens Elkner.\n+ * Portions Copyright (c) 2017-2019, Chris Fraire <cfraire@me.com>.\n+ */\n+package org.opengrok.indexer.search;\n+\n+import org.apache.lucene.index.IndexReader;\n+import org.opengrok.indexer.configuration.Project;\n+import org.opengrok.indexer.index.IndexAnalysisSettings3;\n+import org.opengrok.indexer.index.IndexAnalysisSettingsAccessor;\n+import org.opengrok.indexer.index.IndexedSymlink;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+/**\n+ * Represents a helper class for accessing settings.\n+ * @author Jens Elkner\n+ */\n+public class SettingsHelper {\n+\n+    private final IndexReader reader;\n+\n+    /**\n+     * Key is Project name or empty string for null Project.\n+     */\n+    private Map<String, IndexAnalysisSettings3> mappedAnalysisSettings;\n+\n+    /**\n+     * Key is Project name or empty string for null Project. Map is ordered by\n+     * canonical length (ASC) and then canonical value (ASC).\n+     */\n+    private Map<String, Map<String, IndexedSymlink>> mappedIndexedSymlinks;\n+\n+    public SettingsHelper(IndexReader reader) {\n+        if (reader == null) {\n+            throw new IllegalArgumentException(\"reader is null\");\n+        }\n+        this.reader = reader;\n+    }\n+\n+    /**\n+     * Gets any mapped symlinks (after having called {@link #getSettings(String)}).\n+     * @return either a defined map or {@code null}\n+     */\n+    public Map<String, IndexedSymlink> getSymlinks(String projectName) {\n+        if (mappedIndexedSymlinks == null) {\n+            throw new IllegalStateException(\"getSettings() not yet called\");\n+        }\n+\n+        String k = projectName != null ? projectName : \"\";\n+        Map<String, IndexedSymlink> indexSymlinks = mappedIndexedSymlinks.get(k);\n+        if (indexSymlinks != null) {\n+            return Collections.unmodifiableMap(indexSymlinks);\n+        }\n+        return null;\n+    }\n+\n+    /**\n+     * Gets the persisted tabSize via {@link #getSettings(String)} if\n+     * available or returns the {@code proj} tabSize if available -- or zero.\n+     * @param proj a defined instance or {@code null} if no project is active\n+     * @return tabSize\n+     * @throws IOException if an I/O error occurs querying the initialized\n+     * reader\n+     */\n+    public int getTabSize(Project proj) throws IOException {\n+        String projectName = proj != null ? proj.getName() : null;\n+        IndexAnalysisSettings3 settings = getSettings(projectName);\n+        int tabSize;\n+        if (settings != null && settings.getTabSize() != null) {\n+            tabSize = settings.getTabSize();\n+        } else {\n+            tabSize = proj != null ? proj.getTabSize() : 0;\n+        }\n+        return tabSize;\n+    }\n+\n+    /**\n+     * Gets the settings for a specified project.\n+     * @param projectName a defined instance or {@code null} if no project is\n+     * active (or empty string to mean the same thing)\n+     * @return a defined instance or {@code null} if none is found\n+     * @throws IOException if an I/O error occurs querying the initialized reader\n+     */\n+    public IndexAnalysisSettings3 getSettings(String projectName) throws IOException {\n+        if (mappedAnalysisSettings == null) {\n+            IndexAnalysisSettingsAccessor dao = new IndexAnalysisSettingsAccessor();\n+            IndexAnalysisSettings3[] setts = dao.read(reader, Short.MAX_VALUE);\n+            map(setts);\n+        }\n+\n+        String k = projectName != null ? projectName : \"\";\n+        return mappedAnalysisSettings.get(k);", "originalCommit": "497eb8c94314a1bc20d5469acf5159e9b6904f21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcxODM2NQ==", "url": "https://github.com/oracle/opengrok/pull/3130#discussion_r417718365", "bodyText": "Revised", "author": "idodeclare", "createdAt": "2020-04-30T02:22:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNTk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNjIyOQ==", "url": "https://github.com/oracle/opengrok/pull/3130#discussion_r417116229", "bodyText": "is it problem to call it here getSettings()?", "author": "tulinkry", "createdAt": "2020-04-29T07:26:13Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/search/SettingsHelper.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.\n+ * Portions copyright (c) 2011 Jens Elkner.\n+ * Portions Copyright (c) 2017-2019, Chris Fraire <cfraire@me.com>.\n+ */\n+package org.opengrok.indexer.search;\n+\n+import org.apache.lucene.index.IndexReader;\n+import org.opengrok.indexer.configuration.Project;\n+import org.opengrok.indexer.index.IndexAnalysisSettings3;\n+import org.opengrok.indexer.index.IndexAnalysisSettingsAccessor;\n+import org.opengrok.indexer.index.IndexedSymlink;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+/**\n+ * Represents a helper class for accessing settings.\n+ * @author Jens Elkner\n+ */\n+public class SettingsHelper {\n+\n+    private final IndexReader reader;\n+\n+    /**\n+     * Key is Project name or empty string for null Project.\n+     */\n+    private Map<String, IndexAnalysisSettings3> mappedAnalysisSettings;\n+\n+    /**\n+     * Key is Project name or empty string for null Project. Map is ordered by\n+     * canonical length (ASC) and then canonical value (ASC).\n+     */\n+    private Map<String, Map<String, IndexedSymlink>> mappedIndexedSymlinks;\n+\n+    public SettingsHelper(IndexReader reader) {\n+        if (reader == null) {\n+            throw new IllegalArgumentException(\"reader is null\");\n+        }\n+        this.reader = reader;\n+    }\n+\n+    /**\n+     * Gets any mapped symlinks (after having called {@link #getSettings(String)}).\n+     * @return either a defined map or {@code null}\n+     */\n+    public Map<String, IndexedSymlink> getSymlinks(String projectName) {\n+        if (mappedIndexedSymlinks == null) {\n+            throw new IllegalStateException(\"getSettings() not yet called\");", "originalCommit": "497eb8c94314a1bc20d5469acf5159e9b6904f21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcxODA2Nw==", "url": "https://github.com/oracle/opengrok/pull/3130#discussion_r417718067", "bodyText": "No doesn't seem so", "author": "idodeclare", "createdAt": "2020-04-30T02:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNjIyOQ=="}], "type": "inlineReview"}, {"oid": "135114a6c892c3f2721a41a41d61c89a04d15c24", "url": "https://github.com/oracle/opengrok/commit/135114a6c892c3f2721a41a41d61c89a04d15c24", "message": "Tweak names and calls per review", "committedDate": "2020-04-30T02:19:57Z", "type": "commit"}]}