{"pr_number": 3328, "pr_title": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Open\u2026", "pr_createdAt": "2020-10-27T15:18:45Z", "pr_url": "https://github.com/oracle/opengrok/pull/3328", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgyNTMxMA==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r512825310", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Copyright (c) 2020 Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n          \n          \n            \n             * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.", "author": "ahornace", "createdAt": "2020-10-27T16:06:54Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/RepositoryLookup.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.", "originalCommit": "97ee3fdfa7bfd240064f861a98176d1c75969ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgyNTUyNw==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r512825527", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Copyright (c) 2020 Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n          \n          \n            \n             * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.", "author": "ahornace", "createdAt": "2020-10-27T16:07:09Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/RepositoryLookupCached.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.", "originalCommit": "97ee3fdfa7bfd240064f861a98176d1c75969ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgyNTY5Ng==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r512825696", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Copyright (c) 2020 Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n          \n          \n            \n             * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.", "author": "ahornace", "createdAt": "2020-10-27T16:07:23Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/RepositoryLookupUncached.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.", "originalCommit": "97ee3fdfa7bfd240064f861a98176d1c75969ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgyNTg1Nw==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r512825857", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Copyright (c) 2020 Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n          \n          \n            \n             * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.", "author": "ahornace", "createdAt": "2020-10-27T16:07:37Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/history/RepositoryLookupTest.java", "diffHunk": "@@ -0,0 +1,260 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.", "originalCommit": "97ee3fdfa7bfd240064f861a98176d1c75969ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3c2ac5936d4adb5824faba6e550c7c67b7b5dd26", "url": "https://github.com/oracle/opengrok/commit/3c2ac5936d4adb5824faba6e550c7c67b7b5dd26", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-10-27T16:10:58Z", "type": "forcePushed"}, {"oid": "2dac535755f27ce6b10976d9a53de924911c6631", "url": "https://github.com/oracle/opengrok/commit/2dac535755f27ce6b10976d9a53de924911c6631", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-10-27T16:15:43Z", "type": "forcePushed"}, {"oid": "2f8a1c82bc993f83d99e5db947282776c3eaa5ce", "url": "https://github.com/oracle/opengrok/commit/2f8a1c82bc993f83d99e5db947282776c3eaa5ce", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-10-27T17:01:14Z", "type": "forcePushed"}, {"oid": "0f18a7ef89c3c131e71055e1fec10a23e9b482e2", "url": "https://github.com/oracle/opengrok/commit/0f18a7ef89c3c131e71055e1fec10a23e9b482e2", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-10-27T17:38:35Z", "type": "forcePushed"}, {"oid": "c77154d054b61f6a49a3ed10497bafb7d5385214", "url": "https://github.com/oracle/opengrok/commit/c77154d054b61f6a49a3ed10497bafb7d5385214", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-10-27T18:46:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxMjQ2NQ==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r513012465", "bodyText": "this is perhaps a warning or HistoryException throw", "author": "tulinkry", "createdAt": "2020-10-27T20:34:21Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/search/context/HistoryContext.java", "diffHunk": "@@ -82,7 +82,12 @@ public boolean getContext(String filename, String path, List<Hit> hits) throws H\n             return false;\n         }\n         File f = new File(filename);\n-        return getHistoryContext(HistoryGuru.getInstance().getHistory(f), path, null, hits, null);\n+        History history = HistoryGuru.getInstance().getHistory(f);\n+        if (history == null) {\n+            LOGGER.log(Level.INFO, \"Null history got for {0}\", f);", "originalCommit": "c77154d054b61f6a49a3ed10497bafb7d5385214", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxNjMzNg==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r513016336", "bodyText": "I patterned it after the other method: \n  \n    \n      opengrok/opengrok-indexer/src/main/java/org/opengrok/indexer/search/context/HistoryContext.java\n    \n    \n        Lines 116 to 121\n      in\n      c77154d\n    \n    \n    \n    \n\n        \n          \n           History hist = HistoryGuru.getInstance().getHistory(src); \n        \n\n        \n          \n           if (hist == null) { \n        \n\n        \n          \n               LOGGER.log(Level.INFO, \"Null history got for {0}\", src); \n        \n\n        \n          \n               return false; \n        \n\n        \n          \n           } \n        \n\n        \n          \n           return getHistoryContext(hist, path, out, null, context);", "author": "azakkerman", "createdAt": "2020-10-27T20:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxMjQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxOTU0NQ==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r513019545", "bodyText": "I see, then it's probably ok.", "author": "tulinkry", "createdAt": "2020-10-27T20:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxMjQ2NQ=="}], "type": "inlineReview"}, {"oid": "fda849fdf325d0362d91b5de2768981cad571a46", "url": "https://github.com/oracle/opengrok/commit/fda849fdf325d0362d91b5de2768981cad571a46", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-10-28T14:46:47Z", "type": "forcePushed"}, {"oid": "81974384c2f4d18cc81b1d4f1b74d64852268c95", "url": "https://github.com/oracle/opengrok/commit/81974384c2f4d18cc81b1d4f1b74d64852268c95", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-10-28T17:59:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NzY2NQ==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r515477665", "bodyText": "is org.opengrok.indexer.condition.UnixPresent needed for this test?", "author": "tulinkry", "createdAt": "2020-10-31T09:31:44Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/history/RepositoryLookupTest.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n+ */\n+package org.opengrok.indexer.history;\n+\n+import com.google.common.jimfs.Configuration;\n+import com.google.common.jimfs.Jimfs;\n+import org.hamcrest.Matcher;\n+import org.hamcrest.Matchers;\n+import org.hamcrest.number.OrderingComparison;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.opengrok.indexer.util.PathUtils;\n+\n+import java.io.IOException;\n+import java.nio.file.FileSystem;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.AdditionalAnswers.delegatesTo;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.mockingDetails;\n+\n+public class RepositoryLookupTest {\n+    // Files to include into Repositories having short paths\n+    private static final String[] SHORT_PATH_CONTENTS = {\"foo/bar.txt\", \"foo/bla/barf.txt\", \"special/woops@\",\n+        \"special/veryveryverylongfilename_just_for_fun\"};\n+    // Files to include into Repositories having longer paths\n+    private static final String[] LONG_PATH_CONTENTS = {\"foo/bla/1/2/3/4/bar.txt\", \"foo/bla/1/2/3/4/5/barf.txt\"};\n+    Map<String, Repository> repositories;\n+    Set<String> repositoryRoots;\n+    // TODO: Parametrize this to run against windows(), unix() and macos()\n+    FileSystem fileSystem = Jimfs.newFileSystem(Configuration.unix());", "originalCommit": "81974384c2f4d18cc81b1d4f1b74d64852268c95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3ODIzMQ==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r515478231", "bodyText": "I see now, it is virtual filesystem.", "author": "tulinkry", "createdAt": "2020-10-31T09:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NzY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3Nzc1NQ==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r515477755", "bodyText": "private for consistent use?", "author": "tulinkry", "createdAt": "2020-10-31T09:32:51Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/history/RepositoryLookupTest.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n+ */\n+package org.opengrok.indexer.history;\n+\n+import com.google.common.jimfs.Configuration;\n+import com.google.common.jimfs.Jimfs;\n+import org.hamcrest.Matcher;\n+import org.hamcrest.Matchers;\n+import org.hamcrest.number.OrderingComparison;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.opengrok.indexer.util.PathUtils;\n+\n+import java.io.IOException;\n+import java.nio.file.FileSystem;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.AdditionalAnswers.delegatesTo;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.mockingDetails;\n+\n+public class RepositoryLookupTest {\n+    // Files to include into Repositories having short paths\n+    private static final String[] SHORT_PATH_CONTENTS = {\"foo/bar.txt\", \"foo/bla/barf.txt\", \"special/woops@\",\n+        \"special/veryveryverylongfilename_just_for_fun\"};\n+    // Files to include into Repositories having longer paths\n+    private static final String[] LONG_PATH_CONTENTS = {\"foo/bla/1/2/3/4/bar.txt\", \"foo/bla/1/2/3/4/5/barf.txt\"};\n+    Map<String, Repository> repositories;\n+    Set<String> repositoryRoots;\n+    // TODO: Parametrize this to run against windows(), unix() and macos()\n+    FileSystem fileSystem = Jimfs.newFileSystem(Configuration.unix());\n+    // Pick first root to resolve paths relative to it.\n+    // Windows Jimfs can only resolve absolute paths relative to a rootDir, not via fileSystem.get(\"/a/b/c\")\n+    Path rootDir = fileSystem.getRootDirectories().iterator().next();", "originalCommit": "81974384c2f4d18cc81b1d4f1b74d64852268c95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3Nzc1Nw==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r515477757", "bodyText": "private for consistent use?", "author": "tulinkry", "createdAt": "2020-10-31T09:32:54Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/history/RepositoryLookupTest.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n+ */\n+package org.opengrok.indexer.history;\n+\n+import com.google.common.jimfs.Configuration;\n+import com.google.common.jimfs.Jimfs;\n+import org.hamcrest.Matcher;\n+import org.hamcrest.Matchers;\n+import org.hamcrest.number.OrderingComparison;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.opengrok.indexer.util.PathUtils;\n+\n+import java.io.IOException;\n+import java.nio.file.FileSystem;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.AdditionalAnswers.delegatesTo;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.mockingDetails;\n+\n+public class RepositoryLookupTest {\n+    // Files to include into Repositories having short paths\n+    private static final String[] SHORT_PATH_CONTENTS = {\"foo/bar.txt\", \"foo/bla/barf.txt\", \"special/woops@\",\n+        \"special/veryveryverylongfilename_just_for_fun\"};\n+    // Files to include into Repositories having longer paths\n+    private static final String[] LONG_PATH_CONTENTS = {\"foo/bla/1/2/3/4/bar.txt\", \"foo/bla/1/2/3/4/5/barf.txt\"};\n+    Map<String, Repository> repositories;\n+    Set<String> repositoryRoots;\n+    // TODO: Parametrize this to run against windows(), unix() and macos()\n+    FileSystem fileSystem = Jimfs.newFileSystem(Configuration.unix());", "originalCommit": "81974384c2f4d18cc81b1d4f1b74d64852268c95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3Nzc2MQ==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r515477761", "bodyText": "private for consistent use?", "author": "tulinkry", "createdAt": "2020-10-31T09:32:59Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/history/RepositoryLookupTest.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n+ */\n+package org.opengrok.indexer.history;\n+\n+import com.google.common.jimfs.Configuration;\n+import com.google.common.jimfs.Jimfs;\n+import org.hamcrest.Matcher;\n+import org.hamcrest.Matchers;\n+import org.hamcrest.number.OrderingComparison;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.opengrok.indexer.util.PathUtils;\n+\n+import java.io.IOException;\n+import java.nio.file.FileSystem;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.AdditionalAnswers.delegatesTo;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.mockingDetails;\n+\n+public class RepositoryLookupTest {\n+    // Files to include into Repositories having short paths\n+    private static final String[] SHORT_PATH_CONTENTS = {\"foo/bar.txt\", \"foo/bla/barf.txt\", \"special/woops@\",\n+        \"special/veryveryverylongfilename_just_for_fun\"};\n+    // Files to include into Repositories having longer paths\n+    private static final String[] LONG_PATH_CONTENTS = {\"foo/bla/1/2/3/4/bar.txt\", \"foo/bla/1/2/3/4/5/barf.txt\"};\n+    Map<String, Repository> repositories;", "originalCommit": "81974384c2f4d18cc81b1d4f1b74d64852268c95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3Nzc2OQ==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r515477769", "bodyText": "private for consistent use?", "author": "tulinkry", "createdAt": "2020-10-31T09:33:03Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/history/RepositoryLookupTest.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n+ */\n+package org.opengrok.indexer.history;\n+\n+import com.google.common.jimfs.Configuration;\n+import com.google.common.jimfs.Jimfs;\n+import org.hamcrest.Matcher;\n+import org.hamcrest.Matchers;\n+import org.hamcrest.number.OrderingComparison;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.opengrok.indexer.util.PathUtils;\n+\n+import java.io.IOException;\n+import java.nio.file.FileSystem;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.AdditionalAnswers.delegatesTo;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.mockingDetails;\n+\n+public class RepositoryLookupTest {\n+    // Files to include into Repositories having short paths\n+    private static final String[] SHORT_PATH_CONTENTS = {\"foo/bar.txt\", \"foo/bla/barf.txt\", \"special/woops@\",\n+        \"special/veryveryverylongfilename_just_for_fun\"};\n+    // Files to include into Repositories having longer paths\n+    private static final String[] LONG_PATH_CONTENTS = {\"foo/bla/1/2/3/4/bar.txt\", \"foo/bla/1/2/3/4/5/barf.txt\"};\n+    Map<String, Repository> repositories;\n+    Set<String> repositoryRoots;", "originalCommit": "81974384c2f4d18cc81b1d4f1b74d64852268c95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3ODE2Ng==", "url": "https://github.com/oracle/opengrok/pull/3328#discussion_r515478166", "bodyText": "could be @ see so it jumps there automatically", "author": "tulinkry", "createdAt": "2020-10-31T09:37:21Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/RepositoryLookup.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Anatoly Akkerman <akkerman@gmail.com>, <anatoly.akkerman@twosigma.com>.\n+ */\n+package org.opengrok.indexer.history;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Interface for finding enclosing Repository for a given Path, used by HistoryGuru.\n+ * <p>\n+ * Two implementations exists\n+ * - uncached, (legacy behavior) extracted from HistoryGuru into a stand-alone impl\n+ * - cached, new implementation, which reduces number of expensive canonicalization calls\n+ * <p>\n+ * We preserve both cached and uncached implementations in order to verify correctness of the cached impl.\n+ */\n+public interface RepositoryLookup {\n+\n+    static RepositoryLookupCached cached() {\n+        return new RepositoryLookupCached();\n+    }\n+\n+    static RepositoryLookupUncached uncached() {\n+        return new RepositoryLookupUncached();\n+    }\n+\n+    /**\n+     * This interface allows intercepting PathUtils.getRelativeToCanonical in order to measure the impact of caching.\n+     *\n+     * In practice, PathUtils::getRelativeToCanonical is the implementation of this interface", "originalCommit": "81974384c2f4d18cc81b1d4f1b74d64852268c95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a34e3738ea24562a3cc8d7ddbc8e439c5f7f8e62", "url": "https://github.com/oracle/opengrok/commit/a34e3738ea24562a3cc8d7ddbc8e439c5f7f8e62", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-11-01T05:06:12Z", "type": "forcePushed"}, {"oid": "1d44bc343a6864f5d438c49fbc2b19ca1b5f3b48", "url": "https://github.com/oracle/opengrok/commit/1d44bc343a6864f5d438c49fbc2b19ca1b5f3b48", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-11-01T05:25:01Z", "type": "forcePushed"}, {"oid": "d30fd66cc3e656a27373be5c56b7be2da034d009", "url": "https://github.com/oracle/opengrok/commit/d30fd66cc3e656a27373be5c56b7be2da034d009", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-11-02T13:01:40Z", "type": "forcePushed"}, {"oid": "da0ea3292c5d91424dd5ddac94d70a4326a9af8f", "url": "https://github.com/oracle/opengrok/commit/da0ea3292c5d91424dd5ddac94d70a4326a9af8f", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-11-04T16:05:27Z", "type": "forcePushed"}, {"oid": "134f3f1f42a42b900b51609387d12a0583159d90", "url": "https://github.com/oracle/opengrok/commit/134f3f1f42a42b900b51609387d12a0583159d90", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-11-04T16:29:30Z", "type": "commit"}, {"oid": "134f3f1f42a42b900b51609387d12a0583159d90", "url": "https://github.com/oracle/opengrok/commit/134f3f1f42a42b900b51609387d12a0583159d90", "message": "Fix for #3306: Speed up HistoryGuru.getRepository(File) call for Opengrok installations with many Repositories\n   and deep file trees by caching previous lookup results for dir -> Repository.\n   Additional refactorings to make this new functionality testable against legacy implementation:\n      - Introduce Jimfs for testing which will allow testing Windows, MacOS or UNIX filesystem on any machine\n      - Refactor PathUtils to use Paths instead of Files (this is needed to use Jimfs)", "committedDate": "2020-11-04T16:29:30Z", "type": "forcePushed"}]}