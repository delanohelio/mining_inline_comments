{"pr_number": 3333, "pr_title": "Fix for #3307: Make GitRepository#isWorking synchronized to avoid read/write proble\u2026", "pr_createdAt": "2020-10-28T19:55:22Z", "pr_url": "https://github.com/oracle/opengrok/pull/3333", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3NDE0OA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r513874148", "bodyText": "How about double-locking inside the method (with proper volatile working) as the lowest-cost synchronization vs always synchronizing?\n(I would think this affects all RepositoryInfo sub-classes but as just a mostly-harmless, occasional redundant-run. Or am I misunderstanding?)", "author": "idodeclare", "createdAt": "2020-10-29T01:58:30Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -518,24 +528,32 @@ boolean isNestable() {\n         return true;\n     }\n \n+    private static boolean isGitWorking(String repoCommand) {\n+        Executor exec = new Executor(new String[]{repoCommand, \"--version\"});\n+        if (exec.exec(false) == 0) {\n+            final String outputVersion = exec.getOutputString();\n+            final String version = outputVersion.replaceAll(\".*? version (\\\\d+(\\\\.\\\\d+)*).*\", \"$1\");\n+            try {\n+                return Version.from(version).compareTo(MINIMUM_VERSION) >= 0;\n+            } catch (NumberFormatException ex) {\n+                LOGGER.log(Level.WARNING, String.format(\"Unable to detect git version from %s\", outputVersion), ex);\n+            }\n+        }\n+        return false;\n+    }\n+\n     @Override\n-    public boolean isWorking() {\n+    public synchronized boolean isWorking() {", "originalCommit": "c715d131d61e4d9eb39386ec290546c95ccdea72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg4MDM1NA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r513880354", "bodyText": "It seems that double-locking is an overkill here. Once GIT_IS_WORKING is initialized by one instance of GitRepository, the method will be very quick and lock contention is not likely to be an issue. Also, there are no other synchronized methods just yet. In general, inheritance from RepositoryInfo does not look like a good choice here, as it is mutable and not properly synchronized. Repository should be an interface, with, maybe a base abstract implementation class, allowing for more flexibility in how to make it thread-safe (immutability, etc)\nI have not looked closely at other Repository subclasses, iirc, some of them actually run commands pertaining to the actual repository in order to determine whether a given Repository instance is working. I am trying to contribute back to the community some of the optimizations I ended up doing for my employer where we use opengrok with git, hence, only fixing GitRepository. This fix is useful to improve indexing performance of installations with many (e.g. 10k) repositories, so it is harmless from correctness perspective but not from indexing speed perspective.", "author": "azakkerman", "createdAt": "2020-10-29T02:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg4Nzg2MQ==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r513887861", "bodyText": "Ah OK I'm clear now that you're striving for once-per-run initialization of Git is-working. The pattern in OpenGrok would be to add a static LazilyInstantiate<Boolean> that synchronizes until initialized and thereafter doesn't bother to synchronize at all.", "author": "idodeclare", "createdAt": "2020-10-29T02:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NzM3MQ==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r513897371", "bodyText": "@azakkerman, apologies if already answered, but you write the following:\n\n... trying to contribute back to the community some of the optimizations I ended up doing for my employer ....\n\nand on another issue:\n\nit requires some work to get past our corporate process for submitting OSS patches.\n\nWould these require your company copyright to be asserted in contributions?", "author": "idodeclare", "createdAt": "2020-10-29T02:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIwODUxMQ==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r514208511", "bodyText": "Ah OK I'm clear now that you're striving for once-per-run initialization of Git is-working. The pattern in OpenGrok would be to add a static LazilyInstantiate that synchronizes until initialized and thereafter doesn't bother to synchronize at all.\n\nUpdated the code\n\nWould these require your company copyright to be asserted in contributions?\n\nI received approval. They ask to include work email in addition to personal email. Will double-check if they want to add copyright as well. The issue is mostly about exporting patches from the internal network, but I chose to simply re-implement the code.", "author": "azakkerman", "createdAt": "2020-10-29T12:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYzMjkzMA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r514632930", "bodyText": "org.opengrok.indexer.util.LazilyInstantiate would do the synchronization. Would this method need to be synchronized?", "author": "idodeclare", "createdAt": "2020-10-29T23:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYzOTA3NA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r514639074", "bodyText": "LazilyInstantiate only synchronizes the static GIT_IS_WORKING, but not this.working. Java Memory Model does not guarantee any visibility for read after write across threads w/o use of synchronizing primitives to force memory barriers. My assertion is that synchronized here is needed for correctness, unless you want to make working field of RepositoryInfo volatile. If you insist, I will remove synchronized, as, in the worst case, this would result in an extra GIT_IS_WORKING.get(), so it should be idempotent.", "author": "azakkerman", "createdAt": "2020-10-30T00:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0NjE2MA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r514646160", "bodyText": "Indeed. I mean since the reliance now is on LazilyInstantiate for synchronization, and GIT_IS_WORKING.get() can only ever return the same value, there is no need to synchronize here (nor to make working volatile) because redundant get() or assignment to working are harmless.", "author": "idodeclare", "createdAt": "2020-10-30T00:46:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3NDE0OA=="}], "type": "inlineReview"}, {"oid": "84deb24387ba9cb7b1aeb0b1407f64a8b54719ca", "url": "https://github.com/oracle/opengrok/commit/84deb24387ba9cb7b1aeb0b1407f64a8b54719ca", "message": "Fix for #3307: Make isWorking synchronized to avoid read/write problems with mutable working field. Check whether git is working once per JVM run and don't recheck every time.", "committedDate": "2020-10-29T12:04:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYzMjM0MA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r514632340", "bodyText": "My meaning was org.opengrok.indexer.util.LazilyInstantiate, which is Jacob Zimmerman's tidy implementation that synchronizes until initialized and soon thereafter doesn't need to even test the state.", "author": "idodeclare", "createdAt": "2020-10-29T23:54:20Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -43,6 +43,8 @@\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n+import org.apache.commons.lang3.concurrent.ConcurrentException;\n+import org.apache.commons.lang3.concurrent.LazyInitializer;", "originalCommit": "84deb24387ba9cb7b1aeb0b1407f64a8b54719ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0NzI0NQ==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r514647245", "bodyText": "Please see how swapper() is synchronized, and analyze what happens if redundant calls occur", "author": "idodeclare", "createdAt": "2020-10-30T00:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYzMjM0MA=="}], "type": "inlineReview"}, {"oid": "b9ce159b1564824171abd8a37416a03ccfadded6", "url": "https://github.com/oracle/opengrok/commit/b9ce159b1564824171abd8a37416a03ccfadded6", "message": "Fix for #3307: Make isWorking synchronized to avoid read/write problems with mutable working field. Check whether git is working once per JVM run and don't recheck every time.", "committedDate": "2020-10-30T00:14:14Z", "type": "forcePushed"}, {"oid": "01daad534769caaccc71defb1adc436bdec7114a", "url": "https://github.com/oracle/opengrok/commit/01daad534769caaccc71defb1adc436bdec7114a", "message": "Fix for #3307: Make isWorking synchronized to avoid read/write problems with mutable working field. Check whether git is working once per JVM run and don't recheck every time.", "committedDate": "2020-10-30T00:50:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NTg4MA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r515475880", "bodyText": "I wouldn't mind a Class parameter instead of string. @vladak ?", "author": "tulinkry", "createdAt": "2020-10-31T09:09:36Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/Repository.java", "diffHunk": "@@ -548,6 +548,16 @@ static Boolean checkCmd(String... args) {\n         return exec.exec(false) == 0;\n     }\n \n+    protected static String getCommand(String className, String propertyKey, String fallbackCommand) {", "originalCommit": "01daad534769caaccc71defb1adc436bdec7114a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY0ODI4Mw==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r515648283", "bodyText": "I concur.", "author": "vladak", "createdAt": "2020-11-01T17:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NTg4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NjEyOA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r515476128", "bodyText": "As this is not used anywhere else it does not need to be generic (wrt to the repository command). You can get the command inside this function and do just\nLazilyInstantiate.using(GitRepository::isGitWorking);", "author": "tulinkry", "createdAt": "2020-10-31T09:12:25Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -95,6 +96,28 @@\n      */\n     private static final Version MINIMUM_VERSION = new Version(2, 1, 2);\n \n+    /**\n+     * This is a static replacement for 'working' field. Effectively, check if git is working once in a JVM\n+     * instead of calling it for every GitRepository instance.\n+     */\n+    private static final LazilyInstantiate<Boolean> GIT_IS_WORKING = LazilyInstantiate.using(\n+            () -> isGitWorking(getCommand(GitRepository.class.getCanonicalName(), CMD_PROPERTY_KEY, CMD_FALLBACK)));\n+\n+    private static boolean isGitWorking(String repoCommand) {", "originalCommit": "01daad534769caaccc71defb1adc436bdec7114a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NjE3NA==", "url": "https://github.com/oracle/opengrok/pull/3333#discussion_r515476174", "bodyText": "Would you mind moving this private static method below the constructor at least?", "author": "tulinkry", "createdAt": "2020-10-31T09:12:56Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -95,6 +96,28 @@\n      */\n     private static final Version MINIMUM_VERSION = new Version(2, 1, 2);\n \n+    /**\n+     * This is a static replacement for 'working' field. Effectively, check if git is working once in a JVM\n+     * instead of calling it for every GitRepository instance.\n+     */\n+    private static final LazilyInstantiate<Boolean> GIT_IS_WORKING = LazilyInstantiate.using(\n+            () -> isGitWorking(getCommand(GitRepository.class.getCanonicalName(), CMD_PROPERTY_KEY, CMD_FALLBACK)));\n+\n+    private static boolean isGitWorking(String repoCommand) {\n+        Executor exec = new Executor(new String[]{repoCommand, \"--version\"});\n+        if (exec.exec(false) == 0) {\n+            final String outputVersion = exec.getOutputString();\n+            final String version = outputVersion.replaceAll(\".*? version (\\\\d+(\\\\.\\\\d+)*).*\", \"$1\");\n+            try {\n+                return Version.from(version).compareTo(MINIMUM_VERSION) >= 0;\n+            } catch (NumberFormatException ex) {\n+                LOGGER.log(Level.WARNING, String.format(\"Unable to detect git version from %s\", outputVersion), ex);\n+            }\n+        }\n+        return false;\n+    }", "originalCommit": "01daad534769caaccc71defb1adc436bdec7114a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8e2d7e678c555b31383f67d5d861c59f853f8f0b", "url": "https://github.com/oracle/opengrok/commit/8e2d7e678c555b31383f67d5d861c59f853f8f0b", "message": "Fix for #3307: Make isWorking synchronized to avoid read/write problems with mutable working field. Check whether git is working once per JVM run and don't recheck every time.", "committedDate": "2020-11-01T04:54:48Z", "type": "forcePushed"}, {"oid": "1b333dffa5a49803dd3e2ba7b6192b1c7819566b", "url": "https://github.com/oracle/opengrok/commit/1b333dffa5a49803dd3e2ba7b6192b1c7819566b", "message": "Fix for #3307: Make isWorking synchronized to avoid read/write problems with mutable working field. Check whether git is working once per JVM run and don't recheck every time.", "committedDate": "2020-11-01T05:25:30Z", "type": "forcePushed"}, {"oid": "b700946dd78aedfc4a0dacc664753323f7b42154", "url": "https://github.com/oracle/opengrok/commit/b700946dd78aedfc4a0dacc664753323f7b42154", "message": "Fix for #3307: Make isWorking synchronized to avoid read/write problems with mutable working field. Check whether git is working once per JVM run and don't recheck every time.", "committedDate": "2020-11-01T17:31:38Z", "type": "commit"}, {"oid": "b700946dd78aedfc4a0dacc664753323f7b42154", "url": "https://github.com/oracle/opengrok/commit/b700946dd78aedfc4a0dacc664753323f7b42154", "message": "Fix for #3307: Make isWorking synchronized to avoid read/write problems with mutable working field. Check whether git is working once per JVM run and don't recheck every time.", "committedDate": "2020-11-01T17:31:38Z", "type": "forcePushed"}]}