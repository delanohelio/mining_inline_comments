{"pr_number": 3279, "pr_title": "use statsd for indexer monitoring", "pr_createdAt": "2020-10-14T13:26:19Z", "pr_url": "https://github.com/oracle/opengrok/pull/3279", "timeline": [{"oid": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "url": "https://github.com/oracle/opengrok/commit/4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "message": "introduce StatsdRegistry\n\nfixes #3245", "committedDate": "2020-10-14T13:10:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NTIzMA==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504685230", "bodyText": "Cannot we use io.micrometer.statsd.StatsdFlavor enum? E.g. RemoteSCM is an enum and used in configuration so we should be good to go, right?", "author": "ahornace", "createdAt": "2020-10-14T13:40:24Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/StatsdConfig.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.configuration;\n+\n+/**\n+ * Configuration for Statsd metrics emitted by the Indexer via {@link org.opengrok.indexer.util.Statistics}.\n+ */\n+public class StatsdConfig {\n+    private int port;\n+    private String host;\n+    private boolean enabled;\n+    private String flavor;", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1NTYxMg==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504755612", "bodyText": "That certainly works however it will make the configuration slightly more ugly:\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<java version=\"11.0.4\" class=\"java.beans.XMLDecoder\">\n <object class=\"org.opengrok.indexer.configuration.Configuration\" id=\"Configuration0\">\n\n  <void property=\"statsdConfig\">\n     <void property=\"port\">\n       <int>8125</int>\n     </void>\n     <void property=\"host\">\n       <string>localhost</string>\n     </void>\n<!--\n     <void property=\"flavor\">\n       <enum>etsy</enum>\n     </void>\n-->\n     <void property=\"flavor\">\n       <object class=\"java.lang.Enum\" method=\"valueOf\">\n         <class>io.micrometer.statsd.StatsdFlavor</class>\n         <string>ETSY</string>\n       </object>\n    </void>\n  </void>\n\n </object>\n</java>", "author": "vladak", "createdAt": "2020-10-14T15:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NTIzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4Njc5NQ==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504686795", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public ArrayList<String> getSubFiles() {\n          \n          \n            \n                public List<String> getSubFiles() {", "author": "ahornace", "createdAt": "2020-10-14T13:42:23Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/RuntimeEnvironment.java", "diffHunk": "@@ -123,6 +123,12 @@\n \n     public WatchDogService watchDog;\n \n+    public ArrayList<String> getSubFiles() {", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NjkxOQ==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504686919", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private ArrayList<String> subFiles = new ArrayList<>();\n          \n          \n            \n                private List<String> subFiles = new ArrayList<>();", "author": "ahornace", "createdAt": "2020-10-14T13:42:35Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/RuntimeEnvironment.java", "diffHunk": "@@ -123,6 +123,12 @@\n \n     public WatchDogService watchDog;\n \n+    public ArrayList<String> getSubFiles() {\n+        return subFiles;\n+    }\n+\n+    private ArrayList<String> subFiles = new ArrayList<>();", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4Nzc4OQ==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504687789", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (subFiles.size() > 0) {\n          \n          \n            \n                        if (!subFiles.isEmpty()) {", "author": "ahornace", "createdAt": "2020-10-14T13:43:44Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/Metrics.java", "diffHunk": "@@ -22,19 +22,105 @@\n  */\n package org.opengrok.indexer;\n \n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Tag;\n import io.micrometer.core.instrument.binder.jvm.ClassLoaderMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmGcMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics;\n import io.micrometer.core.instrument.binder.system.ProcessorMetrics;\n import io.micrometer.prometheus.PrometheusConfig;\n import io.micrometer.prometheus.PrometheusMeterRegistry;\n+import io.micrometer.statsd.StatsdConfig;\n+import io.micrometer.statsd.StatsdMeterRegistry;\n+import io.micrometer.statsd.StatsdFlavor;\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+import org.opengrok.indexer.index.Indexer;\n+import org.opengrok.indexer.logger.LoggerFactory;\n \n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Encapsulates logic of meter registry setup and handling.\n+ * Generally, the web application publishes metrics to Prometheus and the Indexer to StatsD.\n+ */\n public final class Metrics {\n \n-    private static final PrometheusMeterRegistry registry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Metrics.class);\n+\n+    private static final StatsdConfig statsdConfig = new StatsdConfig() {\n+        @Override\n+        public String get(String k) {\n+            return null;\n+        }\n+\n+        @Override\n+        public StatsdFlavor flavor() {\n+            String flavor = RuntimeEnvironment.getInstance().getStatsdConfig().getFlavor().toLowerCase();\n+            switch (flavor) {\n+                case \"etsy\":\n+                    return StatsdFlavor.ETSY;\n+                case \"datadog\":\n+                    return StatsdFlavor.DATADOG;\n+                case \"sysdig\":\n+                    return StatsdFlavor.SYSDIG;\n+                case \"telegraf\":\n+                    return StatsdFlavor.TELEGRAF;\n+            }\n+\n+            return null;\n+        }\n+\n+        @Override\n+        public int port() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getPort();\n+        }\n+\n+        @Override\n+        public String host() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getHost();\n+        }\n+\n+        @Override\n+        public boolean buffered() {\n+            return true;\n+        }\n+    };\n+\n+    private static PrometheusMeterRegistry prometheusRegistry;\n+    private static StatsdMeterRegistry statsdRegistry;\n \n     static {\n+        MeterRegistry registry;\n+\n+        if (RuntimeEnvironment.getInstance().getStatsdConfig().isEnabled()) {\n+            LOGGER.log(Level.INFO, \"configuring StatsdRegistry\");\n+\n+            statsdRegistry = new StatsdMeterRegistry(statsdConfig, Clock.SYSTEM);\n+\n+            // Add tag for per-project reindex.\n+            ArrayList<String> subFiles = RuntimeEnvironment.getInstance().getSubFiles();\n+            if (subFiles.size() > 0) {", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4ODgzNg==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504688836", "bodyText": "You can create the joined String directly with Collectors.joining()", "author": "ahornace", "createdAt": "2020-10-14T13:44:44Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/Metrics.java", "diffHunk": "@@ -22,19 +22,105 @@\n  */\n package org.opengrok.indexer;\n \n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Tag;\n import io.micrometer.core.instrument.binder.jvm.ClassLoaderMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmGcMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics;\n import io.micrometer.core.instrument.binder.system.ProcessorMetrics;\n import io.micrometer.prometheus.PrometheusConfig;\n import io.micrometer.prometheus.PrometheusMeterRegistry;\n+import io.micrometer.statsd.StatsdConfig;\n+import io.micrometer.statsd.StatsdMeterRegistry;\n+import io.micrometer.statsd.StatsdFlavor;\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+import org.opengrok.indexer.index.Indexer;\n+import org.opengrok.indexer.logger.LoggerFactory;\n \n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Encapsulates logic of meter registry setup and handling.\n+ * Generally, the web application publishes metrics to Prometheus and the Indexer to StatsD.\n+ */\n public final class Metrics {\n \n-    private static final PrometheusMeterRegistry registry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Metrics.class);\n+\n+    private static final StatsdConfig statsdConfig = new StatsdConfig() {\n+        @Override\n+        public String get(String k) {\n+            return null;\n+        }\n+\n+        @Override\n+        public StatsdFlavor flavor() {\n+            String flavor = RuntimeEnvironment.getInstance().getStatsdConfig().getFlavor().toLowerCase();\n+            switch (flavor) {\n+                case \"etsy\":\n+                    return StatsdFlavor.ETSY;\n+                case \"datadog\":\n+                    return StatsdFlavor.DATADOG;\n+                case \"sysdig\":\n+                    return StatsdFlavor.SYSDIG;\n+                case \"telegraf\":\n+                    return StatsdFlavor.TELEGRAF;\n+            }\n+\n+            return null;\n+        }\n+\n+        @Override\n+        public int port() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getPort();\n+        }\n+\n+        @Override\n+        public String host() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getHost();\n+        }\n+\n+        @Override\n+        public boolean buffered() {\n+            return true;\n+        }\n+    };\n+\n+    private static PrometheusMeterRegistry prometheusRegistry;\n+    private static StatsdMeterRegistry statsdRegistry;\n \n     static {\n+        MeterRegistry registry;\n+\n+        if (RuntimeEnvironment.getInstance().getStatsdConfig().isEnabled()) {\n+            LOGGER.log(Level.INFO, \"configuring StatsdRegistry\");\n+\n+            statsdRegistry = new StatsdMeterRegistry(statsdConfig, Clock.SYSTEM);\n+\n+            // Add tag for per-project reindex.\n+            ArrayList<String> subFiles = RuntimeEnvironment.getInstance().getSubFiles();\n+            if (subFiles.size() > 0) {\n+                List<String> sList = subFiles.stream().\n+                        map(s -> s.startsWith(Indexer.PATH_SEPARATOR_STRING) ? s.substring(1) : s).\n+                        collect(Collectors.toList());", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxMDUwOQ==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504710509", "bodyText": "fixed, thanks", "author": "vladak", "createdAt": "2020-10-14T14:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4ODgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MDkzNw==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504690937", "bodyText": "Why not use RuntimeEnvironment.getInstance().isIndexer() here as well?", "author": "ahornace", "createdAt": "2020-10-14T13:46:23Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/Metrics.java", "diffHunk": "@@ -22,19 +22,105 @@\n  */\n package org.opengrok.indexer;\n \n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Tag;\n import io.micrometer.core.instrument.binder.jvm.ClassLoaderMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmGcMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics;\n import io.micrometer.core.instrument.binder.system.ProcessorMetrics;\n import io.micrometer.prometheus.PrometheusConfig;\n import io.micrometer.prometheus.PrometheusMeterRegistry;\n+import io.micrometer.statsd.StatsdConfig;\n+import io.micrometer.statsd.StatsdMeterRegistry;\n+import io.micrometer.statsd.StatsdFlavor;\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+import org.opengrok.indexer.index.Indexer;\n+import org.opengrok.indexer.logger.LoggerFactory;\n \n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Encapsulates logic of meter registry setup and handling.\n+ * Generally, the web application publishes metrics to Prometheus and the Indexer to StatsD.\n+ */\n public final class Metrics {\n \n-    private static final PrometheusMeterRegistry registry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Metrics.class);\n+\n+    private static final StatsdConfig statsdConfig = new StatsdConfig() {\n+        @Override\n+        public String get(String k) {\n+            return null;\n+        }\n+\n+        @Override\n+        public StatsdFlavor flavor() {\n+            String flavor = RuntimeEnvironment.getInstance().getStatsdConfig().getFlavor().toLowerCase();\n+            switch (flavor) {\n+                case \"etsy\":\n+                    return StatsdFlavor.ETSY;\n+                case \"datadog\":\n+                    return StatsdFlavor.DATADOG;\n+                case \"sysdig\":\n+                    return StatsdFlavor.SYSDIG;\n+                case \"telegraf\":\n+                    return StatsdFlavor.TELEGRAF;\n+            }\n+\n+            return null;\n+        }\n+\n+        @Override\n+        public int port() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getPort();\n+        }\n+\n+        @Override\n+        public String host() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getHost();\n+        }\n+\n+        @Override\n+        public boolean buffered() {\n+            return true;\n+        }\n+    };\n+\n+    private static PrometheusMeterRegistry prometheusRegistry;\n+    private static StatsdMeterRegistry statsdRegistry;\n \n     static {\n+        MeterRegistry registry;\n+\n+        if (RuntimeEnvironment.getInstance().getStatsdConfig().isEnabled()) {", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwNDU1OA==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504704558", "bodyText": "because statsd does not have to be configured. I don't want statsd export to be enabled by default.", "author": "vladak", "createdAt": "2020-10-14T14:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MDkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MTMyNw==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504691327", "bodyText": "Why use Metrics. prefix if the methods are in the same class?", "author": "ahornace", "createdAt": "2020-10-14T13:46:52Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/Metrics.java", "diffHunk": "@@ -45,8 +131,23 @@\n     private Metrics() {\n     }\n \n-    public static PrometheusMeterRegistry getRegistry() {\n-        return registry;\n+    public static PrometheusMeterRegistry getPrometheusRegistry() {\n+        return prometheusRegistry;\n+    }\n+\n+    private static StatsdMeterRegistry getStatsdRegistry() {\n+        return statsdRegistry;\n     }\n \n+    /**\n+     * Get registry based on running context.\n+     * @return MeterRegistry instance\n+     */\n+    public static MeterRegistry getRegistry() {\n+        if (RuntimeEnvironment.getInstance().isIndexer()) {\n+            return Metrics.getStatsdRegistry();\n+        } else {\n+            return Metrics.getPrometheusRegistry();", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwODMwNw==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504708307", "bodyText": "fixed", "author": "vladak", "createdAt": "2020-10-14T14:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MTMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MjQ3OQ==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504692479", "bodyText": "This can cause NPE if host or flavor will be null or it should not happen?", "author": "ahornace", "createdAt": "2020-10-14T13:48:23Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/StatsdConfig.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.configuration;\n+\n+/**\n+ * Configuration for Statsd metrics emitted by the Indexer via {@link org.opengrok.indexer.util.Statistics}.\n+ */\n+public class StatsdConfig {\n+    private int port;\n+    private String host;\n+    private boolean enabled;\n+    private String flavor;\n+\n+    public String getHost() {\n+        return host;\n+    }\n+\n+    public void setHost(String host) {\n+        this.host = host;\n+    }\n+\n+    public int getPort() {\n+        return port;\n+    }\n+\n+    public void setPort(int port) {\n+        this.port = port;\n+    }\n+\n+    public String getFlavor() {\n+        return flavor;\n+    }\n+\n+    public void setFlavor(String flavor) {\n+        this.flavor = flavor;\n+    }\n+\n+    public boolean isEnabled() {\n+        return port != 0 && !host.isEmpty() && !flavor.isEmpty();", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDA5MA==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504714090", "bodyText": "happens with no or incomplete StatsdConfig, fixed.", "author": "vladak", "createdAt": "2020-10-14T14:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MjQ3OQ=="}], "type": "inlineReview"}, {"oid": "210accdf2eb149c68007fe1e271a94719db8290d", "url": "https://github.com/oracle/opengrok/commit/210accdf2eb149c68007fe1e271a94719db8290d", "message": "use List\n\nCo-authored-by: Adam Horn\u00e1\u010dek <adam.hornacek@icloud.com>", "committedDate": "2020-10-14T14:02:51Z", "type": "commit"}, {"oid": "bcc39b00cb3538e54fc48caf147925e68f37bc00", "url": "https://github.com/oracle/opengrok/commit/bcc39b00cb3538e54fc48caf147925e68f37bc00", "message": "use isEmpty\n\nCo-authored-by: Adam Horn\u00e1\u010dek <adam.hornacek@icloud.com>", "committedDate": "2020-10-14T14:03:06Z", "type": "commit"}, {"oid": "d5a515039bb6d4737c34709730215a9f6d4f12ba", "url": "https://github.com/oracle/opengrok/commit/d5a515039bb6d4737c34709730215a9f6d4f12ba", "message": "use List\n\nCo-authored-by: Adam Horn\u00e1\u010dek <adam.hornacek@icloud.com>", "committedDate": "2020-10-14T14:05:26Z", "type": "commit"}, {"oid": "bc358e4c858ca81e0904de436a49e7a73bd4d5dc", "url": "https://github.com/oracle/opengrok/commit/bc358e4c858ca81e0904de436a49e7a73bd4d5dc", "message": "use List", "committedDate": "2020-10-14T14:07:51Z", "type": "commit"}, {"oid": "11ad8b13ebef622b01bb53de061956923d2d9353", "url": "https://github.com/oracle/opengrok/commit/11ad8b13ebef622b01bb53de061956923d2d9353", "message": "Metrics. prefix unnecessary", "committedDate": "2020-10-14T14:08:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTE3Nw==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504709177", "bodyText": "Let's say that statsd is disabled. What is the point of creating Prometheus registry if it cannot be accessed?", "author": "ahornace", "createdAt": "2020-10-14T14:10:02Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/Metrics.java", "diffHunk": "@@ -22,19 +22,105 @@\n  */\n package org.opengrok.indexer;\n \n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Tag;\n import io.micrometer.core.instrument.binder.jvm.ClassLoaderMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmGcMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics;\n import io.micrometer.core.instrument.binder.system.ProcessorMetrics;\n import io.micrometer.prometheus.PrometheusConfig;\n import io.micrometer.prometheus.PrometheusMeterRegistry;\n+import io.micrometer.statsd.StatsdConfig;\n+import io.micrometer.statsd.StatsdMeterRegistry;\n+import io.micrometer.statsd.StatsdFlavor;\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+import org.opengrok.indexer.index.Indexer;\n+import org.opengrok.indexer.logger.LoggerFactory;\n \n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Encapsulates logic of meter registry setup and handling.\n+ * Generally, the web application publishes metrics to Prometheus and the Indexer to StatsD.\n+ */\n public final class Metrics {\n \n-    private static final PrometheusMeterRegistry registry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Metrics.class);\n+\n+    private static final StatsdConfig statsdConfig = new StatsdConfig() {\n+        @Override\n+        public String get(String k) {\n+            return null;\n+        }\n+\n+        @Override\n+        public StatsdFlavor flavor() {\n+            String flavor = RuntimeEnvironment.getInstance().getStatsdConfig().getFlavor().toLowerCase();\n+            switch (flavor) {\n+                case \"etsy\":\n+                    return StatsdFlavor.ETSY;\n+                case \"datadog\":\n+                    return StatsdFlavor.DATADOG;\n+                case \"sysdig\":\n+                    return StatsdFlavor.SYSDIG;\n+                case \"telegraf\":\n+                    return StatsdFlavor.TELEGRAF;\n+            }\n+\n+            return null;\n+        }\n+\n+        @Override\n+        public int port() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getPort();\n+        }\n+\n+        @Override\n+        public String host() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getHost();\n+        }\n+\n+        @Override\n+        public boolean buffered() {\n+            return true;\n+        }\n+    };\n+\n+    private static PrometheusMeterRegistry prometheusRegistry;\n+    private static StatsdMeterRegistry statsdRegistry;\n \n     static {\n+        MeterRegistry registry;\n+\n+        if (RuntimeEnvironment.getInstance().getStatsdConfig().isEnabled()) {\n+            LOGGER.log(Level.INFO, \"configuring StatsdRegistry\");\n+\n+            statsdRegistry = new StatsdMeterRegistry(statsdConfig, Clock.SYSTEM);\n+\n+            // Add tag for per-project reindex.\n+            ArrayList<String> subFiles = RuntimeEnvironment.getInstance().getSubFiles();\n+            if (subFiles.size() > 0) {\n+                List<String> sList = subFiles.stream().\n+                        map(s -> s.startsWith(Indexer.PATH_SEPARATOR_STRING) ? s.substring(1) : s).\n+                        collect(Collectors.toList());\n+                statsdRegistry.config().commonTags(Collections.singleton(Tag.of(\"projects\",\n+                        String.join(\",\", sList))));\n+            }\n+\n+            registry = statsdRegistry;\n+        } else {\n+            LOGGER.log(Level.INFO, \"configuring PrometheusRegistry\");\n+            prometheusRegistry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNjEyNQ==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504716125", "bodyText": "right, fixed.", "author": "vladak", "createdAt": "2020-10-14T14:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTE3Nw=="}], "type": "inlineReview"}, {"oid": "726539bb723d3513dc4c3e03360663febd92086b", "url": "https://github.com/oracle/opengrok/commit/726539bb723d3513dc4c3e03360663febd92086b", "message": "use Collectors.joining()", "committedDate": "2020-10-14T14:11:24Z", "type": "commit"}, {"oid": "6b2d082d9d449cff08a0de96477d4bea01038ffe", "url": "https://github.com/oracle/opengrok/commit/6b2d082d9d449cff08a0de96477d4bea01038ffe", "message": "check host", "committedDate": "2020-10-14T14:15:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxMzM1OQ==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504713359", "bodyText": "This looks kind of iffy to me. We are filling subFiles in main method of Indexer. We are now basically counting on the fact that Metrics class won't be loaded by classloader before the list is filled.", "author": "ahornace", "createdAt": "2020-10-14T14:15:18Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/Metrics.java", "diffHunk": "@@ -22,19 +22,105 @@\n  */\n package org.opengrok.indexer;\n \n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Tag;\n import io.micrometer.core.instrument.binder.jvm.ClassLoaderMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmGcMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics;\n import io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics;\n import io.micrometer.core.instrument.binder.system.ProcessorMetrics;\n import io.micrometer.prometheus.PrometheusConfig;\n import io.micrometer.prometheus.PrometheusMeterRegistry;\n+import io.micrometer.statsd.StatsdConfig;\n+import io.micrometer.statsd.StatsdMeterRegistry;\n+import io.micrometer.statsd.StatsdFlavor;\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+import org.opengrok.indexer.index.Indexer;\n+import org.opengrok.indexer.logger.LoggerFactory;\n \n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Encapsulates logic of meter registry setup and handling.\n+ * Generally, the web application publishes metrics to Prometheus and the Indexer to StatsD.\n+ */\n public final class Metrics {\n \n-    private static final PrometheusMeterRegistry registry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Metrics.class);\n+\n+    private static final StatsdConfig statsdConfig = new StatsdConfig() {\n+        @Override\n+        public String get(String k) {\n+            return null;\n+        }\n+\n+        @Override\n+        public StatsdFlavor flavor() {\n+            String flavor = RuntimeEnvironment.getInstance().getStatsdConfig().getFlavor().toLowerCase();\n+            switch (flavor) {\n+                case \"etsy\":\n+                    return StatsdFlavor.ETSY;\n+                case \"datadog\":\n+                    return StatsdFlavor.DATADOG;\n+                case \"sysdig\":\n+                    return StatsdFlavor.SYSDIG;\n+                case \"telegraf\":\n+                    return StatsdFlavor.TELEGRAF;\n+            }\n+\n+            return null;\n+        }\n+\n+        @Override\n+        public int port() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getPort();\n+        }\n+\n+        @Override\n+        public String host() {\n+            return RuntimeEnvironment.getInstance().getStatsdConfig().getHost();\n+        }\n+\n+        @Override\n+        public boolean buffered() {\n+            return true;\n+        }\n+    };\n+\n+    private static PrometheusMeterRegistry prometheusRegistry;\n+    private static StatsdMeterRegistry statsdRegistry;\n \n     static {\n+        MeterRegistry registry;\n+\n+        if (RuntimeEnvironment.getInstance().getStatsdConfig().isEnabled()) {\n+            LOGGER.log(Level.INFO, \"configuring StatsdRegistry\");\n+\n+            statsdRegistry = new StatsdMeterRegistry(statsdConfig, Clock.SYSTEM);\n+\n+            // Add tag for per-project reindex.\n+            ArrayList<String> subFiles = RuntimeEnvironment.getInstance().getSubFiles();", "originalCommit": "4e518f99aa52b9c7664c9ad2bb87afe55cd48344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc3NDM1NQ==", "url": "https://github.com/oracle/opengrok/pull/3279#discussion_r504774355", "bodyText": "good catch. added a callback to main().", "author": "vladak", "createdAt": "2020-10-14T15:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxMzM1OQ=="}], "type": "inlineReview"}, {"oid": "adcded7ba15cbef60be1fe057dd10061634a72c2", "url": "https://github.com/oracle/opengrok/commit/adcded7ba15cbef60be1fe057dd10061634a72c2", "message": "check flavor", "committedDate": "2020-10-14T14:15:32Z", "type": "commit"}, {"oid": "b29d0efb9bca077d48972a1a49088915d0426ece", "url": "https://github.com/oracle/opengrok/commit/b29d0efb9bca077d48972a1a49088915d0426ece", "message": "do not create PrometheusRegistry when not indexer", "committedDate": "2020-10-14T14:18:27Z", "type": "commit"}, {"oid": "93cb06b6ec8e87c26c8aa13cd6c6c553a1039ff8", "url": "https://github.com/oracle/opengrok/commit/93cb06b6ec8e87c26c8aa13cd6c6c553a1039ff8", "message": "make sure registry is initialized", "committedDate": "2020-10-14T14:26:58Z", "type": "commit"}, {"oid": "72b65170fe78001aeb4d9d8d8f161f5e392de6ed", "url": "https://github.com/oracle/opengrok/commit/72b65170fe78001aeb4d9d8d8f161f5e392de6ed", "message": "use StatsdFlavor", "committedDate": "2020-10-14T15:06:03Z", "type": "commit"}, {"oid": "6abe1deea584d46f4575309866c170b81c2b2d73", "url": "https://github.com/oracle/opengrok/commit/6abe1deea584d46f4575309866c170b81c2b2d73", "message": "remove unused import", "committedDate": "2020-10-14T15:14:20Z", "type": "commit"}, {"oid": "7ec89ffc225dadb1345c58393ec7809c02f8416a", "url": "https://github.com/oracle/opengrok/commit/7ec89ffc225dadb1345c58393ec7809c02f8416a", "message": "add callback to set common tags", "committedDate": "2020-10-14T15:29:59Z", "type": "commit"}, {"oid": "88a39dd1101c5a47839b0889221bc1cbc00a3b68", "url": "https://github.com/oracle/opengrok/commit/88a39dd1101c5a47839b0889221bc1cbc00a3b68", "message": "simplify the condition", "committedDate": "2020-10-14T15:55:10Z", "type": "commit"}, {"oid": "6446b42abbea0491e061d6d56b2a4be8950592c1", "url": "https://github.com/oracle/opengrok/commit/6446b42abbea0491e061d6d56b2a4be8950592c1", "message": "add isEnabled() test", "committedDate": "2020-10-14T18:46:00Z", "type": "commit"}]}