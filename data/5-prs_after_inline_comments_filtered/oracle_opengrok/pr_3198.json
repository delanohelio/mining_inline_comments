{"pr_number": 3198, "pr_title": "LdapFacade to verify LDAP servers", "pr_createdAt": "2020-08-28T13:49:25Z", "pr_url": "https://github.com/oracle/opengrok/pull/3198", "timeline": [{"oid": "e06604ffb2e3ac322791878140c2e872c3a20b85", "url": "https://github.com/oracle/opengrok/commit/e06604ffb2e3ac322791878140c2e872c3a20b85", "message": "check reachability of all LDAP servers\n\nfixes #3196", "committedDate": "2020-08-28T12:10:52Z", "type": "commit"}, {"oid": "deb01d0812e25c312c4a0d0040a89d2521bdd8a7", "url": "https://github.com/oracle/opengrok/commit/deb01d0812e25c312c4a0d0040a89d2521bdd8a7", "message": "remove unused imports", "committedDate": "2020-08-28T12:45:52Z", "type": "commit"}, {"oid": "81bbe41328df42baa17ae73808ff301b2b1f3cdd", "url": "https://github.com/oracle/opengrok/commit/81bbe41328df42baa17ae73808ff301b2b1f3cdd", "message": "add unit test", "committedDate": "2020-08-28T13:11:19Z", "type": "commit"}, {"oid": "f1235a6bfcba8d46656c4fc4bdc5efc0be28af67", "url": "https://github.com/oracle/opengrok/commit/f1235a6bfcba8d46656c4fc4bdc5efc0be28af67", "message": "add another test", "committedDate": "2020-08-28T13:14:30Z", "type": "commit"}, {"oid": "d7c7f8a598fa9dba093a5ac5d15c61db68f84aa5", "url": "https://github.com/oracle/opengrok/commit/d7c7f8a598fa9dba093a5ac5d15c61db68f84aa5", "message": "remove unused import", "committedDate": "2020-08-28T13:15:52Z", "type": "commit"}, {"oid": "679bf7fbe3581aa8a6f75bccf618dcaeed0e2be5", "url": "https://github.com/oracle/opengrok/commit/679bf7fbe3581aa8a6f75bccf618dcaeed0e2be5", "message": "add negative test", "committedDate": "2020-08-28T14:51:25Z", "type": "commit"}, {"oid": "5f4e01458b3f986a5d1ad9fc8654c96a5a542047", "url": "https://github.com/oracle/opengrok/commit/5f4e01458b3f986a5d1ad9fc8654c96a5a542047", "message": "add negative reachability test", "committedDate": "2020-08-28T14:59:38Z", "type": "commit"}, {"oid": "c1205ea14d8ee3fcdebe30c4911d2201264eac7a", "url": "https://github.com/oracle/opengrok/commit/c1205ea14d8ee3fcdebe30c4911d2201264eac7a", "message": "remove double logging", "committedDate": "2020-08-28T14:59:48Z", "type": "commit"}, {"oid": "cbb8cd4cb81a89c27efb800f39b598a0663d2a83", "url": "https://github.com/oracle/opengrok/commit/cbb8cd4cb81a89c27efb800f39b598a0663d2a83", "message": "add username/password test", "committedDate": "2020-08-28T15:03:21Z", "type": "commit"}, {"oid": "233f3b65d96989da2fb1e36ba8fb66d6cf713d15", "url": "https://github.com/oracle/opengrok/commit/233f3b65d96989da2fb1e36ba8fb66d6cf713d15", "message": "fix logic", "committedDate": "2020-08-28T15:14:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM3MzIwNA==", "url": "https://github.com/oracle/opengrok/pull/3198#discussion_r479373204", "bodyText": "gotcha: cannot use java.net.URL since it does not recognize schemes other than http/https.", "author": "vladak", "createdAt": "2020-08-28T15:19:27Z", "path": "plugins/src/main/java/opengrok/auth/plugin/ldap/LdapServer.java", "diffHunk": "@@ -122,13 +129,89 @@ public void setInterval(int interval) {\n         this.interval = interval;\n     }\n \n+    private String urlToHostname(String urlStr) throws URISyntaxException {\n+        URI uri = new URI(urlStr);", "originalCommit": "233f3b65d96989da2fb1e36ba8fb66d6cf713d15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM3NDAxNw==", "url": "https://github.com/oracle/opengrok/pull/3198#discussion_r479374017", "bodyText": "There is no reasonable way to get the functionality of getservbyname() libc library call: https://stackoverflow.com/questions/3645405/get-port-number-for-service-name", "author": "vladak", "createdAt": "2020-08-28T15:20:57Z", "path": "plugins/src/main/java/opengrok/auth/plugin/ldap/LdapServer.java", "diffHunk": "@@ -122,13 +129,89 @@ public void setInterval(int interval) {\n         this.interval = interval;\n     }\n \n+    private String urlToHostname(String urlStr) throws URISyntaxException {\n+        URI uri = new URI(urlStr);\n+        return uri.getHost();\n+    }\n+\n+    /**\n+     * This method converts the scheme from URI to port number.\n+     * It is limited to the ldap/ldaps schemes.\n+     * The method could be static however then it cannot be easily mocked in testing.\n+     * @return port number\n+     * @throws URISyntaxException if the URI is not valid\n+     */\n+    public int getPort() throws URISyntaxException {", "originalCommit": "233f3b65d96989da2fb1e36ba8fb66d6cf713d15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM3NTA5OA==", "url": "https://github.com/oracle/opengrok/pull/3198#discussion_r479375098", "bodyText": "InetAddress.isReachable() is not really useful as it either uses ICMP echo or TCP echo service. The former is not usable out of the box on Linux due to limited privileges, the latter is useless in this case as we are interested in other ports (and the TCP echo service is very little used these days anyway, if at all).", "author": "vladak", "createdAt": "2020-08-28T15:23:01Z", "path": "plugins/src/main/java/opengrok/auth/plugin/ldap/LdapServer.java", "diffHunk": "@@ -122,13 +129,89 @@ public void setInterval(int interval) {\n         this.interval = interval;\n     }\n \n+    private String urlToHostname(String urlStr) throws URISyntaxException {\n+        URI uri = new URI(urlStr);\n+        return uri.getHost();\n+    }\n+\n+    /**\n+     * This method converts the scheme from URI to port number.\n+     * It is limited to the ldap/ldaps schemes.\n+     * The method could be static however then it cannot be easily mocked in testing.\n+     * @return port number\n+     * @throws URISyntaxException if the URI is not valid\n+     */\n+    public int getPort() throws URISyntaxException {\n+        URI uri = new URI(getUrl());\n+        switch (uri.getScheme()) {\n+            case \"ldaps\":\n+                return 636;\n+            case \"ldap\":\n+                return 389;\n+        }\n+\n+        return -1;\n+    }\n+\n+    private boolean isReachable(InetAddress addr, int port, int timeOutMillis) {\n+        try {\n+            try (Socket soc = new Socket()) {\n+                soc.connect(new InetSocketAddress(addr, port), timeOutMillis);", "originalCommit": "233f3b65d96989da2fb1e36ba8fb66d6cf713d15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM3NzA3OA==", "url": "https://github.com/oracle/opengrok/pull/3198#discussion_r479377078", "bodyText": "Any way to make reliable or at least to await a finite time. E.g. what if new ServerSocket throws, and latch is never decremented.", "author": "idodeclare", "createdAt": "2020-08-28T15:26:37Z", "path": "plugins/src/test/java/opengrok/auth/plugin/LdapServerTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package opengrok.auth.plugin;\n+\n+import opengrok.auth.plugin.ldap.LdapServer;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n+import java.net.URISyntaxException;\n+import java.net.UnknownHostException;\n+import java.util.concurrent.CountDownLatch;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class LdapServerTest {\n+\n+    @Test\n+    public void testInvalidURI() {\n+        LdapServer server = new LdapServer(\"foo:/\\\\/\\\\foo.bar\");\n+        assertFalse(server.isReachable());\n+    }\n+\n+    @Test\n+    public void testGetPort() throws URISyntaxException {\n+        LdapServer server = new LdapServer(\"ldaps://foo.bar\");\n+        assertEquals(636, server.getPort());\n+\n+        server = new LdapServer(\"ldap://foo.bar\");\n+        assertEquals(389, server.getPort());\n+\n+        server = new LdapServer(\"crumble://foo.bar\");\n+        assertEquals(-1, server.getPort());\n+    }\n+\n+    @Test\n+    public void testSetGetUsername() {\n+        LdapServer server = new LdapServer();\n+\n+        assertNull(server.getUsername());\n+        assertNull(server.getPassword());\n+\n+        final String testUsername = \"foo\";\n+        server.setUsername(testUsername);\n+        assertEquals(testUsername, server.getUsername());\n+\n+        final String testPassword = \"bar\";\n+        server.setPassword(testPassword);\n+        assertEquals(testPassword, server.getPassword());\n+    }\n+\n+    @Test\n+    public void testIsReachable() throws UnknownHostException, InterruptedException, URISyntaxException {\n+        // Start simple TCP server on port 6336. It has to be > 1024 to avoid BindException\n+        // due to permission denied.\n+        int testPort = 6336;\n+        InetAddress localhostAddr = InetAddress.getLocalHost();\n+        final CountDownLatch startLatch = new CountDownLatch(1);\n+        Thread thread = new Thread(() -> {\n+            try {\n+                ServerSocket socket = new ServerSocket(testPort, 1, localhostAddr);\n+                startLatch.countDown();\n+                Socket client = socket.accept();\n+                client.close();\n+                socket.close();\n+            } catch (IOException e) {\n+                e.printStackTrace();\n+            }\n+        });\n+\n+        // TODO:\n+        //  There is still a tiny window between when the latch unblocks and the server actually starts accept().", "originalCommit": "233f3b65d96989da2fb1e36ba8fb66d6cf713d15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5MTYxNQ==", "url": "https://github.com/oracle/opengrok/pull/3198#discussion_r479391615", "bodyText": "sure, good idea.", "author": "vladak", "createdAt": "2020-08-28T15:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM3NzA3OA=="}], "type": "inlineReview"}, {"oid": "56d39e439d4069ffe134e330d7e788432bc58857", "url": "https://github.com/oracle/opengrok/commit/56d39e439d4069ffe134e330d7e788432bc58857", "message": "fix javadoc", "committedDate": "2020-08-28T15:49:43Z", "type": "commit"}, {"oid": "e2975c3386587d6b8cbe6ddeb86b22e83bc57ccc", "url": "https://github.com/oracle/opengrok/commit/e2975c3386587d6b8cbe6ddeb86b22e83bc57ccc", "message": "add timeout", "committedDate": "2020-08-28T15:52:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzMDYwMA==", "url": "https://github.com/oracle/opengrok/pull/3198#discussion_r479430600", "bodyText": "Could getAddresses() be empty, and would true be correct then?", "author": "idodeclare", "createdAt": "2020-08-28T17:06:22Z", "path": "plugins/src/main/java/opengrok/auth/plugin/ldap/LdapServer.java", "diffHunk": "@@ -122,13 +129,89 @@ public void setInterval(int interval) {\n         this.interval = interval;\n     }\n \n+    private String urlToHostname(String urlStr) throws URISyntaxException {\n+        URI uri = new URI(urlStr);\n+        return uri.getHost();\n+    }\n+\n+    /**\n+     * This method converts the scheme from URI to port number.\n+     * It is limited to the ldap/ldaps schemes.\n+     * The method could be static however then it cannot be easily mocked in testing.\n+     * @return port number or -1 if the scheme in given URI is not known\n+     * @throws URISyntaxException if the URI is not valid\n+     */\n+    public int getPort() throws URISyntaxException {\n+        URI uri = new URI(getUrl());\n+        switch (uri.getScheme()) {\n+            case \"ldaps\":\n+                return 636;\n+            case \"ldap\":\n+                return 389;\n+        }\n+\n+        return -1;\n+    }\n+\n+    private boolean isReachable(InetAddress addr, int port, int timeOutMillis) {\n+        try {\n+            try (Socket soc = new Socket()) {\n+                soc.connect(new InetSocketAddress(addr, port), timeOutMillis);\n+            }\n+            return true;\n+        } catch (IOException e) {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Wraps InetAddress.getAllByName() so that it can be mocked in testing.\n+     * (mocking static methods is not really possible with Mockito)\n+     * @param hostname hostname string\n+     * @return array of InetAddress objects\n+     * @throws UnknownHostException if the host cannot be resolved to any IP address\n+     */\n+    public InetAddress[] getAddresses(String hostname) throws UnknownHostException {\n+        return InetAddress.getAllByName(hostname);\n+    }\n+\n+    /**\n+     * Go through all IP addresses and find out if they are reachable.\n+     * @return true if all IP addresses are reachable, false otherwise\n+     */\n+    public boolean isReachable() {\n+        try {\n+            for (InetAddress addr : getAddresses(urlToHostname(getUrl()))) {\n+                // InetAddr.isReachable() is not sufficient as it can only check ICMP and TCP echo.\n+                int port = getPort();\n+                if (!isReachable(addr, port, getConnectTimeout())) {\n+                    LOGGER.log(Level.WARNING, \"LDAP server {0} is not reachable on {1}:{2}\",\n+                            new Object[]{this, addr, Integer.toString(port)});\n+                    return false;\n+                }\n+            }\n+        } catch (UnknownHostException e) {\n+            LOGGER.log(Level.SEVERE, String.format(\"cannot get IP addresses for LDAP server %s\", this), e);\n+            return false;\n+        } catch (URISyntaxException e) {\n+            LOGGER.log(Level.SEVERE, String.format(\"not a valid URI: %s\", getUrl()), e);\n+            return false;\n+        }\n+\n+        return true;", "originalCommit": "e2975c3386587d6b8cbe6ddeb86b22e83bc57ccc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1NDczMg==", "url": "https://github.com/oracle/opengrok/pull/3198#discussion_r479454732", "bodyText": "I noticed this too. Thanks for reminding me.", "author": "vladak", "createdAt": "2020-08-28T17:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzMDYwMA=="}], "type": "inlineReview"}, {"oid": "d7db41ef7d37f371e56de78951b98bd34d3208d8", "url": "https://github.com/oracle/opengrok/commit/d7db41ef7d37f371e56de78951b98bd34d3208d8", "message": "check length of address array", "committedDate": "2020-08-28T17:55:42Z", "type": "commit"}, {"oid": "840ab1e46a7ffd12723ca2ee98c646f273c2dac8", "url": "https://github.com/oracle/opengrok/commit/840ab1e46a7ffd12723ca2ee98c646f273c2dac8", "message": "add test for the empty array case", "committedDate": "2020-08-28T18:01:05Z", "type": "commit"}, {"oid": "504603b7f59cd9a48d6f469fbb0cf8b078f3015e", "url": "https://github.com/oracle/opengrok/commit/504603b7f59cd9a48d6f469fbb0cf8b078f3015e", "message": "add negative check for prepareServers()", "committedDate": "2020-08-28T18:13:01Z", "type": "commit"}, {"oid": "05019111b9c874a75105f6bb5a44299bab5a41d5", "url": "https://github.com/oracle/opengrok/commit/05019111b9c874a75105f6bb5a44299bab5a41d5", "message": "replace CountDownLatch with connect loop", "committedDate": "2020-08-28T18:36:58Z", "type": "commit"}, {"oid": "a5a817a7db5e61e3d03ec7af8cb8bd05e8c312d7", "url": "https://github.com/oracle/opengrok/commit/a5a817a7db5e61e3d03ec7af8cb8bd05e8c312d7", "message": "fix style", "committedDate": "2020-08-28T19:24:37Z", "type": "commit"}]}