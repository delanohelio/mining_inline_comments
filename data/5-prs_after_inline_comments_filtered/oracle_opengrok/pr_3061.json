{"pr_number": 3061, "pr_title": "Bugfix/perforce", "pr_createdAt": "2020-03-04T01:16:03Z", "pr_url": "https://github.com/oracle/opengrok/pull/3061", "timeline": [{"oid": "760f2eb601778a757723ca6caa1d1ef2e2a36cab", "url": "https://github.com/oracle/opengrok/commit/760f2eb601778a757723ca6caa1d1ef2e2a36cab", "message": "Reorder repositories by cost and popularity", "committedDate": "2020-03-03T03:28:04Z", "type": "commit"}, {"oid": "36201ddc5c7bf322fa1e2cc406827245f65182eb", "url": "https://github.com/oracle/opengrok/commit/36201ddc5c7bf322fa1e2cc406827245f65182eb", "message": "Fix #2919 Fix #2797 Fix #981 Fix #878 Fix #502 Perforce refactoring\n\n- Run a p4-changes and p4-filelog, and integrate\n  the results, so only two p4 commands are needed\n  for History for a directory tree.\n- Parse file names from p4 commands so that\n  HistoryEntry instances have defined files.\n- Recognize binary file log for annotations.", "committedDate": "2020-03-04T01:13:24Z", "type": "commit"}, {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3", "url": "https://github.com/oracle/opengrok/commit/f916bde247d3958e7eae0cc86504cdc0f670c4d3", "message": "Avoid IllegalArgumentException, and log condition\n\nAccommodate a repository that can transiently\nreturn errors, such as Perforce when a login\nexpires.", "committedDate": "2020-03-04T01:14:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyMzE5Ng==", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r387523196", "bodyText": "I assume this needs some setup steps to populate the root somehow. Could you perhaps update the test case with the steps ?", "author": "vladak", "createdAt": "2020-03-04T08:52:29Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/history/PerforceRepositoryTest.java", "diffHunk": "@@ -40,36 +41,38 @@\n \n import static org.junit.Assert.assertNotNull;\n import static org.junit.Assert.assertEquals;\n-import org.opengrok.indexer.configuration.RuntimeEnvironment;\n import static org.opengrok.indexer.history.PerforceRepository.protectPerforceFilename;\n+import static org.opengrok.indexer.history.PerforceRepository.unprotectPerforceFilename;\n \n /**\n  * Do basic testing of the Perforce support\n  *\n  * @author Trond Norbye\n  */\n-@ConditionalRun(RepositoryInstalled.PerforceInstalled.class)\n public class PerforceRepositoryTest {\n \n     @Rule\n     public ConditionalRunRule rule = new ConditionalRunRule();\n     \n     private static boolean skip;\n     private static List<File> files;\n-    private static final File root = new File(\"/export/opengrok_p4_test\");\n+    private static final File root = new File(\"/var/opengrok/src/p4foo\");", "originalCommit": "f916bde247d3958e7eae0cc86504cdc0f670c4d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzNTE1MA==", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r388035150", "bodyText": "OK done", "author": "idodeclare", "createdAt": "2020-03-05T01:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyMzE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyNDQzNw==", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r387524437", "bodyText": "good idea !", "author": "vladak", "createdAt": "2020-03-04T08:55:01Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/RepositoryFactory.java", "diffHunk": "@@ -51,21 +51,30 @@\n     private static final Logger LOGGER = LoggerFactory.getLogger(RepositoryFactory.class);\n \n     private static final Repository[] repositories = {\n-        new BitKeeperRepository(),\n-        new MercurialRepository(),\n-        new AccuRevRepository(),\n-        new BazaarRepository(),\n-        new GitRepository(),\n-        new MonotoneRepository(),\n-        new SubversionRepository(),\n-        new SCCSRepository(),\n-        new RazorRepository(),\n-        new ClearCaseRepository(),\n-        new PerforceRepository(),\n-        new RCSRepository(),\n-        new CVSRepository(),\n-        new RepoRepository(),\n-        new SSCMRepository()\n+            /*\n+             * The following do cheap checks to determine isRepositoryFor(),\n+             * but still put the most popular at the head of the repositories\n+             * array.\n+             */\n+            new GitRepository(),\n+            new MercurialRepository(),\n+            new RepoRepository(),\n+            new BitKeeperRepository(),\n+            new BazaarRepository(),\n+            new MonotoneRepository(),\n+            new SubversionRepository(),\n+            new SCCSRepository(),\n+            new RazorRepository(),\n+            new RCSRepository(),\n+            new CVSRepository(),\n+            new SSCMRepository(),\n+            /*\n+             * The following do expensive checks to determine isRepositoryFor(),\n+             * so put them at the end of the repositories array.\n+             */\n+            new AccuRevRepository(),", "originalCommit": "f916bde247d3958e7eae0cc86504cdc0f670c4d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyNTMwMw==", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r387525303", "bodyText": "use isLoggable() also here ?", "author": "vladak", "createdAt": "2020-03-04T08:56:41Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/PerforceRepository.java", "diffHunk": "@@ -78,18 +78,31 @@ static String protectPerforceFilename(String name) {\n         return t;\n     }\n \n+    static String unprotectPerforceFilename(String name) {\n+        String t = name.replace(\"%40\", \"@\");\n+        t = t.replace(\"%23\", \"#\");\n+        t = t.replace(\"%2A\", \"*\");\n+        t = t.replace(\"%25\", \"%\");\n+        if (!name.equals(t)) {\n+            LOGGER.log(Level.FINEST,", "originalCommit": "f916bde247d3958e7eae0cc86504cdc0f670c4d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzNTE3OA==", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r388035178", "bodyText": "Yes", "author": "idodeclare", "createdAt": "2020-03-05T01:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyNTMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyOTAxOA==", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r387529018", "bodyText": "what does Lede stand for ?", "author": "vladak", "createdAt": "2020-03-04T09:03:49Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/PerforceHistoryParser.java", "diffHunk": "@@ -271,4 +304,56 @@ private static Date newDate(int year, int month, int day, int hour, int minute,\n         cal.set(year, month - 1, day, hour, minute, second);\n         return cal.getTime();\n     }\n+\n+    private static HistoryEntry parseLedeLine(List<HistoryEntry> entries, HistoryEntry entry,", "originalCommit": "f916bde247d3958e7eae0cc86504cdc0f670c4d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzNTI1Ng==", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r388035256", "bodyText": "I renamed as parseEntryLine().", "author": "idodeclare", "createdAt": "2020-03-05T01:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyOTAxOA=="}], "type": "inlineReview"}, {"oid": "665789e2b25f4b055561183cfd661b9d51d37d97", "url": "https://github.com/oracle/opengrok/commit/665789e2b25f4b055561183cfd661b9d51d37d97", "message": "Revise after review", "committedDate": "2020-03-05T01:41:23Z", "type": "commit"}, {"oid": "c573aab51dc1b5d3ca9931bc2851b336a2a3b8d8", "url": "https://github.com/oracle/opengrok/commit/c573aab51dc1b5d3ca9931bc2851b336a2a3b8d8", "message": "Fix to escape > in JavaDoc", "committedDate": "2020-03-05T04:45:39Z", "type": "commit"}]}