{"pr_number": 3238, "pr_title": "make all OpenGrok cookies use the SameSite attribute", "pr_createdAt": "2020-09-22T21:16:58Z", "pr_url": "https://github.com/oracle/opengrok/pull/3238", "timeline": [{"oid": "513308de57832882856648f768a34ba2cf3fa6f6", "url": "https://github.com/oracle/opengrok/commit/513308de57832882856648f768a34ba2cf3fa6f6", "message": "initial ability to manipulate cookies", "committedDate": "2020-09-22T20:01:10Z", "type": "commit"}, {"oid": "977a9d1587d23da06ee876ebba6f7dc1dd3cf049", "url": "https://github.com/oracle/opengrok/commit/977a9d1587d23da06ee876ebba6f7dc1dd3cf049", "message": "add PageConfig.addCookie() to set cookies with common set of attributes", "committedDate": "2020-09-22T21:10:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI0NDk3Mg==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r493244972", "bodyText": "Even though I did not see repeating headers in the response maybe this should just record the cookie in a map and the actual headers will be added in a filter.", "author": "vladak", "createdAt": "2020-09-23T07:06:53Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/web/PageConfig.java", "diffHunk": "@@ -861,6 +862,16 @@ private static void splitByComma(String value, List<String> result) {\n         }\n     }\n \n+    /**\n+     * Add cookie header to the response along with extra attributes.\n+     * @param response servlet response\n+     * @param name name of the cookie\n+     * @param value value of the cookie\n+     */\n+    public static void addCookie(HttpServletResponse response, String name, String value) {\n+        response.addHeader(\"Set-cookie\", name + \"=\" + value + \"; SameSite=Strict; Secure\");", "originalCommit": "31a722b622be55e86c9fff2b22f49d23f00cc5f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI2MDU5MA==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r493260590", "bodyText": "found a solution to this in https://stackoverflow.com/a/51576089/11582827", "author": "vladak", "createdAt": "2020-09-23T07:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI0NDk3Mg=="}], "type": "inlineReview"}, {"oid": "fe3e793f86bdeeeaaaa8a49d3dce676fa956964d", "url": "https://github.com/oracle/opengrok/commit/fe3e793f86bdeeeaaaa8a49d3dce676fa956964d", "message": "Revert \"add PageConfig.addCookie() to set cookies with common set of attributes\"\n\nThis reverts commit 977a9d1587d23da06ee876ebba6f7dc1dd3cf049.", "committedDate": "2020-09-23T07:21:33Z", "type": "commit"}, {"oid": "f46e74e8cc6dd3dfa2510c3425ea62f038c2cfce", "url": "https://github.com/oracle/opengrok/commit/f46e74e8cc6dd3dfa2510c3425ea62f038c2cfce", "message": "use the filter after all", "committedDate": "2020-09-23T07:32:42Z", "type": "forcePushed"}, {"oid": "6b8fbc6a461d2a6db18b440dcb10e8b13b4a417b", "url": "https://github.com/oracle/opengrok/commit/6b8fbc6a461d2a6db18b440dcb10e8b13b4a417b", "message": "use the filter after all\n\nfixes #3164", "committedDate": "2020-09-23T07:35:37Z", "type": "commit"}, {"oid": "6b8fbc6a461d2a6db18b440dcb10e8b13b4a417b", "url": "https://github.com/oracle/opengrok/commit/6b8fbc6a461d2a6db18b440dcb10e8b13b4a417b", "message": "use the filter after all\n\nfixes #3164", "committedDate": "2020-09-23T07:35:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4NTgwMA==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r493685800", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                FilterConfig fc;\n          \n          \n            \n                private FilterConfig fc;", "author": "ahornace", "createdAt": "2020-09-23T15:27:25Z", "path": "opengrok-web/src/main/java/org/opengrok/web/CookieFilter.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.\n+ */\n+package org.opengrok.web;\n+\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.FilterConfig;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.HttpHeaders;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Enumeration;\n+\n+/**\n+ * Makes sure that all cookies originating from the web application have the Same-site attribute set.\n+ */\n+public class CookieFilter implements Filter {\n+    FilterConfig fc;", "originalCommit": "6b8fbc6a461d2a6db18b440dcb10e8b13b4a417b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4Njg5OA==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r493686898", "bodyText": "Is this necessary? It indicates that the whole filter will be taken out of service (I assume garbage collected) so this is not needed, right?", "author": "ahornace", "createdAt": "2020-09-23T15:28:46Z", "path": "opengrok-web/src/main/java/org/opengrok/web/CookieFilter.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.\n+ */\n+package org.opengrok.web;\n+\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.FilterConfig;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.HttpHeaders;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Enumeration;\n+\n+/**\n+ * Makes sure that all cookies originating from the web application have the Same-site attribute set.\n+ */\n+public class CookieFilter implements Filter {\n+    FilterConfig fc;\n+\n+    @Override\n+    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)\n+            throws IOException, ServletException {\n+\n+        HttpServletResponse response = (HttpServletResponse) res;\n+\n+        chain.doFilter(req, response);\n+\n+        // Change the existing cookies to use the attributes and values from the configuration.\n+        Collection<String> headers = response.getHeaders(HttpHeaders.SET_COOKIE);\n+        boolean firstHeader = true;\n+        for (String header : headers) { // there can be multiple Set-Cookie attributes\n+            if (firstHeader) {\n+                response.setHeader(HttpHeaders.SET_COOKIE, String.format(\"%s; %s\", header, getSuffix(response)));\n+                firstHeader = false;\n+                continue;\n+            }\n+            response.addHeader(HttpHeaders.SET_COOKIE, String.format(\"%s; %s\", header, getSuffix(response)));\n+        }\n+    }\n+\n+    private String getSuffix(HttpServletResponse response) {\n+        StringBuilder sb = new StringBuilder();\n+\n+        for (Enumeration<String> e = fc.getInitParameterNames(); e.hasMoreElements();) {\n+            String attributeName = e.nextElement();\n+            if (sb.length() > 0) {\n+                sb.append(\"; \");\n+            }\n+            sb.append(attributeName);\n+            String attributeValue = fc.getInitParameter(attributeName);\n+            if (!attributeValue.isEmpty()) {\n+                sb.append(\"=\");\n+                sb.append(attributeValue);\n+            }\n+        }\n+        return sb.toString();\n+    }\n+\n+    @Override\n+    public void init(FilterConfig filterConfig) {\n+        this.fc = filterConfig;\n+    }\n+\n+    @Override\n+    public void destroy() {\n+        this.fc = null;", "originalCommit": "6b8fbc6a461d2a6db18b440dcb10e8b13b4a417b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcxNzI1Ng==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r493717256", "bodyText": "most probably not, will remove.", "author": "vladak", "createdAt": "2020-09-23T16:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4Njg5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA3MDM1OQ==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r494070359", "bodyText": "It probably needs to be overridden but empty:\n[ERROR] /home/travis/build/oracle/opengrok/opengrok-web/src/main/java/org/opengrok/web/CookieFilter.java:[40,8] org.opengrok.web.CookieFilter is not abstract and does not override abstract method destroy() in javax.servlet.Filter", "author": "ahornace", "createdAt": "2020-09-24T06:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4Njg5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA5NTk2MA==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r494095960", "bodyText": "fixed", "author": "vladak", "createdAt": "2020-09-24T07:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4Njg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4Nzg3OQ==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r493687879", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String getSuffix(HttpServletResponse response) {\n          \n          \n            \n                private String getSuffix() {", "author": "ahornace", "createdAt": "2020-09-23T15:30:03Z", "path": "opengrok-web/src/main/java/org/opengrok/web/CookieFilter.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.\n+ */\n+package org.opengrok.web;\n+\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.FilterConfig;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.HttpHeaders;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Enumeration;\n+\n+/**\n+ * Makes sure that all cookies originating from the web application have the Same-site attribute set.\n+ */\n+public class CookieFilter implements Filter {\n+    FilterConfig fc;\n+\n+    @Override\n+    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)\n+            throws IOException, ServletException {\n+\n+        HttpServletResponse response = (HttpServletResponse) res;\n+\n+        chain.doFilter(req, response);\n+\n+        // Change the existing cookies to use the attributes and values from the configuration.\n+        Collection<String> headers = response.getHeaders(HttpHeaders.SET_COOKIE);\n+        boolean firstHeader = true;\n+        for (String header : headers) { // there can be multiple Set-Cookie attributes\n+            if (firstHeader) {\n+                response.setHeader(HttpHeaders.SET_COOKIE, String.format(\"%s; %s\", header, getSuffix(response)));\n+                firstHeader = false;\n+                continue;\n+            }\n+            response.addHeader(HttpHeaders.SET_COOKIE, String.format(\"%s; %s\", header, getSuffix(response)));\n+        }\n+    }\n+\n+    private String getSuffix(HttpServletResponse response) {", "originalCommit": "6b8fbc6a461d2a6db18b440dcb10e8b13b4a417b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY5NTg0OQ==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r493695849", "bodyText": "Would this work?\nStreamSupport.stream(Spliterators.spliteratorUnknownSize(fc.getInitParameterNames(), Spliterator.NONNULL), false)\n        .map(attributeName -> {\n            String attributeValue = fc.getInitParameter(attributeName);\n            if (!attributeValue.isEmpty()) {\n                return attributeName + \"=\" + attributeValue;\n            } else {\n                return attributeName;\n            }\n        }).collect(Collectors.joining(\"; \"));", "author": "ahornace", "createdAt": "2020-09-23T15:41:07Z", "path": "opengrok-web/src/main/java/org/opengrok/web/CookieFilter.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.\n+ */\n+package org.opengrok.web;\n+\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.FilterConfig;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.HttpHeaders;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Enumeration;\n+\n+/**\n+ * Makes sure that all cookies originating from the web application have the Same-site attribute set.\n+ */\n+public class CookieFilter implements Filter {\n+    FilterConfig fc;\n+\n+    @Override\n+    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)\n+            throws IOException, ServletException {\n+\n+        HttpServletResponse response = (HttpServletResponse) res;\n+\n+        chain.doFilter(req, response);\n+\n+        // Change the existing cookies to use the attributes and values from the configuration.\n+        Collection<String> headers = response.getHeaders(HttpHeaders.SET_COOKIE);\n+        boolean firstHeader = true;\n+        for (String header : headers) { // there can be multiple Set-Cookie attributes\n+            if (firstHeader) {\n+                response.setHeader(HttpHeaders.SET_COOKIE, String.format(\"%s; %s\", header, getSuffix(response)));\n+                firstHeader = false;\n+                continue;\n+            }\n+            response.addHeader(HttpHeaders.SET_COOKIE, String.format(\"%s; %s\", header, getSuffix(response)));\n+        }\n+    }\n+\n+    private String getSuffix(HttpServletResponse response) {\n+        StringBuilder sb = new StringBuilder();\n+\n+        for (Enumeration<String> e = fc.getInitParameterNames(); e.hasMoreElements();) {", "originalCommit": "6b8fbc6a461d2a6db18b440dcb10e8b13b4a417b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc1NDA5MQ==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r493754091", "bodyText": "The first argument of spliteratorUnknownSize has to be either primitive number type or Iterator which is not available in JDK 8. Also, this sort of conversion to stream seems, uh, unnatural.", "author": "vladak", "createdAt": "2020-09-23T17:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY5NTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2OTEzNw==", "url": "https://github.com/oracle/opengrok/pull/3238#discussion_r494069137", "bodyText": "Yes, however, there are helper methods for this in Guava and maybe apache-commons -> if we have one of them on the classpath then we could leverage that. If not, then creating a simple toStream util method would make this nicer.\nBut you are right, https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Enumeration.html#asIterator() is available since JDK9", "author": "ahornace", "createdAt": "2020-09-24T06:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY5NTg0OQ=="}], "type": "inlineReview"}, {"oid": "18bc89de801dca38cfabc6192fd657c71c5cf844", "url": "https://github.com/oracle/opengrok/commit/18bc89de801dca38cfabc6192fd657c71c5cf844", "message": "make FilterConfig private\n\nCo-authored-by: Adam Horn\u00e1\u010dek <adam.hornacek@icloud.com>", "committedDate": "2020-09-23T16:09:41Z", "type": "commit"}, {"oid": "4f0287b6d816c4e09bcc3b7715d4e30c72dcbb24", "url": "https://github.com/oracle/opengrok/commit/4f0287b6d816c4e09bcc3b7715d4e30c72dcbb24", "message": "remove unnecessary parameter\n\nCo-authored-by: Adam Horn\u00e1\u010dek <adam.hornacek@icloud.com>", "committedDate": "2020-09-23T16:10:42Z", "type": "commit"}, {"oid": "6f9faf93ba15677c7d63206c5f68760ba61811b7", "url": "https://github.com/oracle/opengrok/commit/6f9faf93ba15677c7d63206c5f68760ba61811b7", "message": "destroy is not needed", "committedDate": "2020-09-23T16:12:04Z", "type": "commit"}, {"oid": "29a85cd22a30386bfab59ed2591ac93111670b7e", "url": "https://github.com/oracle/opengrok/commit/29a85cd22a30386bfab59ed2591ac93111670b7e", "message": "empty destroy", "committedDate": "2020-09-24T07:24:14Z", "type": "commit"}, {"oid": "215e1519272ad6ab6828f619f1beeacdb6ab0422", "url": "https://github.com/oracle/opengrok/commit/215e1519272ad6ab6828f619f1beeacdb6ab0422", "message": "fix calls to getSuffix()", "committedDate": "2020-09-24T07:26:26Z", "type": "commit"}]}