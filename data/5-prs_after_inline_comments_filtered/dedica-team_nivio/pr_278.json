{"pr_number": 278, "pr_title": "[#277] refactor: separate hex code better from svg code", "pr_createdAt": "2020-09-14T20:35:34Z", "pr_url": "https://github.com/dedica-team/nivio/pull/278", "timeline": [{"oid": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "url": "https://github.com/dedica-team/nivio/commit/e508eac0f3540edc1e0b086ade2b3e45e3f44044", "message": "[#277] refactor: separate hex code better from svg code", "committedDate": "2020-09-14T20:34:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0ODM3Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488748373", "bodyText": "Small formatting problem.", "author": "Matthimatiker", "createdAt": "2020-09-15T15:13:15Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+/**\n+ * Collects all hexes close to group item hexes to create an area.\n+ */\n+public class GroupAreaFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GroupAreaFactory.class);\n+\n+    /**\n+     * Builds an areas of hex tiles belonging to a group.\n+     *  @param occupied    tiles occupied by items", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NDIyNw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488754227", "bodyText": "I guess the check could be extracted into a separate method, e.g. isInGroup():\n.filter(rel -> rel.getTarget().isInGroup(group.getIdentifier())", "author": "Matthimatiker", "createdAt": "2020-09-15T15:20:49Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+/**\n+ * Collects all hexes close to group item hexes to create an area.\n+ */\n+public class GroupAreaFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GroupAreaFactory.class);\n+\n+    /**\n+     * Builds an areas of hex tiles belonging to a group.\n+     *  @param occupied    tiles occupied by items\n+     * @param group       the group\n+     * @param vertexHexes a mapping from item to its hex\n+     * @param relationPaths   existing paths\n+     * @return\n+     */\n+    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> relationPaths) {\n+\n+        Set<Item> items = group.getItems();\n+        Set<Hex> inArea = new HashSet<>();\n+\n+        //surround each item\n+        items.forEach(item -> {\n+            Hex hex = vertexHexes.get(item);\n+            inArea.add(hex);\n+            hex.neighbours().forEach(neigh -> {\n+                if (!occupied.contains(neigh))\n+                    inArea.add(neigh);\n+            });\n+\n+            //add all \"inner\" relations (paths)\n+            relationPaths.stream()\n+                    .filter(rel -> rel.getSource().equals(item))\n+                    .filter(rel -> rel.getTarget().getGroup() != null)\n+                    .filter(rel -> rel.getTarget().getGroup().equals(group.getIdentifier()))", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwODA1MA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488908050", "bodyText": "The solution is now that only matching paths are passed as parameter, so filtering is not necessary here anymore.", "author": "bonndan", "createdAt": "2020-09-15T19:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NDIyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NjA2Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488756063", "bodyText": "I do not know how this works in detail. But is it expected to always terminate in 2 iterations?", "author": "Matthimatiker", "createdAt": "2020-09-15T15:23:24Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+/**\n+ * Collects all hexes close to group item hexes to create an area.\n+ */\n+public class GroupAreaFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GroupAreaFactory.class);\n+\n+    /**\n+     * Builds an areas of hex tiles belonging to a group.\n+     *  @param occupied    tiles occupied by items\n+     * @param group       the group\n+     * @param vertexHexes a mapping from item to its hex\n+     * @param relationPaths   existing paths\n+     * @return\n+     */\n+    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> relationPaths) {\n+\n+        Set<Item> items = group.getItems();\n+        Set<Hex> inArea = new HashSet<>();\n+\n+        //surround each item\n+        items.forEach(item -> {\n+            Hex hex = vertexHexes.get(item);\n+            inArea.add(hex);\n+            hex.neighbours().forEach(neigh -> {\n+                if (!occupied.contains(neigh))\n+                    inArea.add(neigh);\n+            });\n+\n+            //add all \"inner\" relations (paths)\n+            relationPaths.stream()\n+                    .filter(rel -> rel.getSource().equals(item))\n+                    .filter(rel -> rel.getTarget().getGroup() != null)\n+                    .filter(rel -> rel.getTarget().getGroup().equals(group.getIdentifier()))\n+                    .forEach(rel -> inArea.addAll(rel.getHexes()));\n+        });\n+\n+        Set<Hex> bridges = getBridges(inArea);\n+        inArea.addAll(bridges);\n+\n+        //2nd pass fills gaps\n+        bridges = getBridges(inArea);\n+        inArea.addAll(bridges);", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTAzMA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488851030", "bodyText": "It works as follows: first we circumnavigate all hexes of items and add their neighbours immediately. Then we iterate over all one-hex gaps and add them. This iteration is repeated, so that effectively a few two-hex gaps were filled.\nThere is clearly much room for improvement here. It's only that I haven't found a bettter approach so far.", "author": "bonndan", "createdAt": "2020-09-15T17:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NjA2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4NDYzNg==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488884636", "bodyText": "That explanation would be a greate code comment.", "author": "Matthimatiker", "createdAt": "2020-09-15T18:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NjA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTM1Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488761353", "bodyText": "What are bridges? Empty gaps between 2 Hexes?\nA brief description would help here.", "author": "Matthimatiker", "createdAt": "2020-09-15T15:30:19Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+/**\n+ * Collects all hexes close to group item hexes to create an area.\n+ */\n+public class GroupAreaFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GroupAreaFactory.class);\n+\n+    /**\n+     * Builds an areas of hex tiles belonging to a group.\n+     *  @param occupied    tiles occupied by items\n+     * @param group       the group\n+     * @param vertexHexes a mapping from item to its hex\n+     * @param relationPaths   existing paths\n+     * @return\n+     */\n+    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> relationPaths) {\n+\n+        Set<Item> items = group.getItems();\n+        Set<Hex> inArea = new HashSet<>();\n+\n+        //surround each item\n+        items.forEach(item -> {\n+            Hex hex = vertexHexes.get(item);\n+            inArea.add(hex);\n+            hex.neighbours().forEach(neigh -> {\n+                if (!occupied.contains(neigh))\n+                    inArea.add(neigh);\n+            });\n+\n+            //add all \"inner\" relations (paths)\n+            relationPaths.stream()\n+                    .filter(rel -> rel.getSource().equals(item))\n+                    .filter(rel -> rel.getTarget().getGroup() != null)\n+                    .filter(rel -> rel.getTarget().getGroup().equals(group.getIdentifier()))\n+                    .forEach(rel -> inArea.addAll(rel.getHexes()));\n+        });\n+\n+        Set<Hex> bridges = getBridges(inArea);\n+        inArea.addAll(bridges);\n+\n+        //2nd pass fills gaps\n+        bridges = getBridges(inArea);\n+        inArea.addAll(bridges);\n+\n+        return inArea;\n+    }\n+\n+    static Set<Hex> getBridges(Set<Hex> inArea) {", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTI3OA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488851278", "bodyText": "correct. I've added an explanation.", "author": "bonndan", "createdAt": "2020-09-15T17:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MjM3Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488762373", "bodyText": "I guess this is nullable?", "author": "Matthimatiker", "createdAt": "2020-09-15T15:31:44Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/Hex.java", "diffHunk": "@@ -39,6 +41,7 @@\n     public final int r;\n     public final int s;\n     public String id;\n+    public Item item;", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwODE0Mg==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488908142", "bodyText": "has been removed", "author": "bonndan", "createdAt": "2020-09-15T19:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MjM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MzMyNw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488763327", "bodyText": "Naming is so important...", "author": "Matthimatiker", "createdAt": "2020-09-15T15:33:01Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/Hex.java", "diffHunk": "@@ -39,6 +41,7 @@\n     public final int r;\n     public final int s;", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyOTI4MQ==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488829281", "bodyText": "These are common names for hex coordinates. I've added field descriptions.", "author": "bonndan", "createdAt": "2020-09-15T17:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MzMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2Mzg2Ng==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488763866", "bodyText": "This could also be final.", "author": "Matthimatiker", "createdAt": "2020-09-15T15:33:47Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.layout.LayoutedComponent;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.springframework.lang.Nullable;\n+\n+import java.util.*;\n+\n+/**\n+ * Representation of a hex map.\n+ *\n+ *\n+ *\n+ */\n+public class HexMap {\n+\n+    private final Set<Hex> occupied = new HashSet<>();\n+    private final boolean debug;\n+    private final Map<LandscapeItem, Hex> vertexHexes = new HashMap<>();\n+    private final PathFinder pathFinder;\n+    private List<HexPath> paths = new ArrayList<>();", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NTQ3Mg==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488765472", "bodyText": "Why is this obsolete? Can it be removed?", "author": "Matthimatiker", "createdAt": "2020-09-15T15:36:08Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.layout.LayoutedComponent;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.springframework.lang.Nullable;\n+\n+import java.util.*;\n+\n+/**\n+ * Representation of a hex map.\n+ *\n+ *\n+ *\n+ */\n+public class HexMap {\n+\n+    private final Set<Hex> occupied = new HashSet<>();\n+    private final boolean debug;\n+    private final Map<LandscapeItem, Hex> vertexHexes = new HashMap<>();\n+    private final PathFinder pathFinder;\n+    private List<HexPath> paths = new ArrayList<>();\n+\n+    public HexMap(boolean debug) {\n+        this.debug = debug;\n+        // find and render relations\n+        pathFinder = new PathFinder(occupied);\n+        pathFinder.debug = this.debug;\n+    }\n+\n+    public void add(LayoutedComponent layoutedItem) {\n+        Hex hex = null;\n+        int i = 0;\n+        while (hex == null || occupied.contains(hex)) {\n+            hex = Hex.of(Math.round(layoutedItem.getX()) - i, Math.round(layoutedItem.getY()) - i);\n+            i++;\n+        }\n+\n+        Item item = (Item) layoutedItem.getComponent();\n+        hex.id = item.getFullyQualifiedIdentifier().jsonValue();\n+        hex.item = item;\n+        vertexHexes.put(item, hex); //this is obsolete", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzMDg2Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488830863", "bodyText": "This is the mapping between landscape items and hexes on the map. If we store Item inside Hex, this mapping is obsolete. However, as you pointed out below, Item is pushed deeper and deeper into the hex package.", "author": "bonndan", "createdAt": "2020-09-15T17:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwODU1NA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488908554", "bodyText": "not obsolete anymore", "author": "bonndan", "createdAt": "2020-09-15T19:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NTQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NjY0NA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488766644", "bodyText": "What is collect? The path? The hexes between startHex and destHex?", "author": "Matthimatiker", "createdAt": "2020-09-15T15:37:40Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java", "diffHunk": "@@ -187,7 +187,7 @@ public HexPath getPath(Hex startHex, Hex destHex) {\n             return null;\n \n         List<Hex> collect = path.stream().map(tile -> tile.hex).collect(Collectors.toList());", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc5MjYzMA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488792630", "bodyText": "This pushes domain objects down into the view level.\nAt least that looks like the wrong abstraction level for Items.", "author": "Matthimatiker", "createdAt": "2020-09-15T16:14:26Z", "path": "src/main/java/de/bonndan/nivio/output/map/svg/HexPath.java", "diffHunk": "@@ -13,13 +14,19 @@\n  */\n public class HexPath {\n \n+    private final Item source;\n+    private final Item target;", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwODYzNw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488908637", "bodyText": "Removed", "author": "bonndan", "createdAt": "2020-09-15T19:18:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc5MjYzMA=="}], "type": "inlineReview"}, {"oid": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "url": "https://github.com/dedica-team/nivio/commit/64d1a0707e87ebaada8c22ad15edaaae226806ad", "message": "[#277] added comments", "committedDate": "2020-09-15T17:22:00Z", "type": "commit"}, {"oid": "95f0f655f473a46efe6639533a43723007e8c54f", "url": "https://github.com/dedica-team/nivio/commit/95f0f655f473a46efe6639533a43723007e8c54f", "message": "[#277] added comments, different solution for in-group paths being added to group area", "committedDate": "2020-09-15T19:11:49Z", "type": "commit"}, {"oid": "cf4912b7d4bbb308ec678661943c927c6f21f883", "url": "https://github.com/dedica-team/nivio/commit/cf4912b7d4bbb308ec678661943c927c6f21f883", "message": "[#277] npe fix", "committedDate": "2020-09-15T19:12:59Z", "type": "commit"}, {"oid": "a1b223a7f6179154bb8170af9afa67ffec0f4a33", "url": "https://github.com/dedica-team/nivio/commit/a1b223a7f6179154bb8170af9afa67ffec0f4a33", "message": "[#277] added comments", "committedDate": "2020-09-15T19:15:02Z", "type": "commit"}, {"oid": "2559b5170fa42f8d2ec52b9a2353b5024062e7e9", "url": "https://github.com/dedica-team/nivio/commit/2559b5170fa42f8d2ec52b9a2353b5024062e7e9", "message": "[#277] removed Hex.item field", "committedDate": "2020-09-15T19:16:21Z", "type": "commit"}, {"oid": "463e24d3e6e28f7b1329e0bacef6d19126be2609", "url": "https://github.com/dedica-team/nivio/commit/463e24d3e6e28f7b1329e0bacef6d19126be2609", "message": "[#277] hexmap returns optional path", "committedDate": "2020-09-15T19:25:35Z", "type": "commit"}]}