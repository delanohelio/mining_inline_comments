{"pr_number": 7118, "pr_title": "6918 locking improvements", "pr_createdAt": "2020-07-23T13:27:50Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7118", "timeline": [{"oid": "1ff747e03059765d8244399d2fac1c30c2f45cf1", "url": "https://github.com/IQSS/dataverse/commit/1ff747e03059765d8244399d2fac1c30c2f45cf1", "message": "The new iteration of the patch for the Singleton locking, and related conditions.\nMUCH SIMPLIFIED, in terms of the number of files that had to be modified; but should be\neven more effective in ensuring that the service should never become locked under\nnormal operating conditions. (#6918)", "committedDate": "2020-07-20T00:49:20Z", "type": "commit"}, {"oid": "4765cbd3dc8bae422a87bdce50f951e0be8b4f8c", "url": "https://github.com/IQSS/dataverse/commit/4765cbd3dc8bae422a87bdce50f951e0be8b4f8c", "message": "the remaining parts of the #6918 patch (changes to the publishing process, etc.)", "committedDate": "2020-07-23T12:47:59Z", "type": "commit"}, {"oid": "9faedbc7a4ff5a0769f773b02746fb243f040c6b", "url": "https://github.com/IQSS/dataverse/commit/9faedbc7a4ff5a0769f773b02746fb243f040c6b", "message": "typo", "committedDate": "2020-07-23T13:44:22Z", "type": "commit"}, {"oid": "a4c961ec99d69a1642eb4ee26bfb74df8f552596", "url": "https://github.com/IQSS/dataverse/commit/a4c961ec99d69a1642eb4ee26bfb74df8f552596", "message": "\"bnackground\" (#6918)", "committedDate": "2020-07-23T16:06:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Njk4Ng==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r459666986", "bodyText": "I thought I understood why the in transaction version of sendNotification was needed (to send the email even if the command transaction was rolling back), but this looks like the opposite - is it correct as is? (If so, what am I missing?)", "author": "qqmyers", "createdAt": "2020-07-23T19:06:20Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/FinalizeDatasetPublicationCommand.java", "diffHunk": "@@ -399,16 +436,17 @@ private void notifyUsersFileDownload(CommandContext ctxt, DvObject subject) {\n             .filter(  ra -> ra.getRole().permissions().contains(Permission.DownloadFile) )\n             .flatMap( ra -> ctxt.roleAssignees().getExplicitUsers(ctxt.roleAssignees().getRoleAssignee(ra.getAssigneeIdentifier())).stream() )\n             .distinct() // prevent double-send\n-            .forEach( au -> ctxt.notifications().sendNotification(au, getTimestamp(), UserNotification.Type.GRANTFILEACCESS, getDataset().getId()) );\n+            .forEach( au -> ctxt.notifications().sendNotificationInTransaction(au, getTimestamp(), UserNotification.Type.GRANTFILEACCESS, getDataset().getId()) );\n     }\n     \n-    private void notifyUsersDatasetPublish(CommandContext ctxt, DvObject subject) {\n+    private void notifyUsersDatasetPublishStatus(CommandContext ctxt, DvObject subject, UserNotification.Type type) {", "originalCommit": "a4c961ec99d69a1642eb4ee26bfb74df8f552596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4NTY5OA==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r459685698", "bodyText": "No, you were right. Since the notification needs to be saved in the database, rolling back the transaction un-saves it. And now that, in addition to the success notification, I am also sending notifications in situations when something goes bad and the transaction is going to be rolled back, I need to save the notification in a transaction of its own.\nOf course I should probably  only be using the \"InTransaction\" method when it is an on-failure notification; and stick with the normal, old way of doing it when it's the \"success\" notification at the end of the command. When nothing is expected to be rolled back that is.\nThe extra parameter - type - identifies the type of the notification that needs to be sent;  \"dataset's been published\" vs \"failed on account of registration error\" ...", "author": "landreev", "createdAt": "2020-07-23T19:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Njk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5MDUyNQ==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r459690525", "bodyText": "Right - but notifyUserDatasetPublishStatus is the one being used for the failure message, and it's using sendNotification inside and not sendNotificationInTransaction - that means the notification won't get saved in the db for the failure? Or?", "author": "qqmyers", "createdAt": "2020-07-23T19:52:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Njk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5MzU2MQ==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r459693561", "bodyText": "Did I check in the wrong version of it? - hold on...", "author": "landreev", "createdAt": "2020-07-23T19:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Njk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5NDQxMA==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r459694410", "bodyText": "Of course I did. (I was messing with renaming the methods at the last moment - and did mess it up). Thank you.", "author": "landreev", "createdAt": "2020-07-23T19:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Njk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5NTc5MQ==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r459695791", "bodyText": "been there, done that!", "author": "qqmyers", "createdAt": "2020-07-23T20:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Njk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5NjA1NA==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r459696054", "bodyText": "I was only looking at the line your comment was immediately referencing and got confused.\nOK, fixed - thanks again.\nOtherwise Kevin would run into this during QA, with no notification showing in the UI.", "author": "landreev", "createdAt": "2020-07-23T20:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Njk4Ng=="}], "type": "inlineReview"}, {"oid": "e734dd88f209bb4b52965fbb7e8838ea48c420e4", "url": "https://github.com/IQSS/dataverse/commit/e734dd88f209bb4b52965fbb7e8838ea48c420e4", "message": "Fixed the notification method in the finalize publish command. #6918", "committedDate": "2020-07-23T20:00:26Z", "type": "commit"}, {"oid": "05794883bdf63149721f0ee5ed8dc8b8c924aa33", "url": "https://github.com/IQSS/dataverse/commit/05794883bdf63149721f0ee5ed8dc8b8c924aa33", "message": "fixed \"Global Identifer\" (#6918)", "committedDate": "2020-07-27T15:14:15Z", "type": "commit"}, {"oid": "8b3d0cca6c98cdf1f7fa66192392ff5f73a86f25", "url": "https://github.com/IQSS/dataverse/commit/8b3d0cca6c98cdf1f7fa66192392ff5f73a86f25", "message": "fixed another \"Global Identifer\" (#6918)", "committedDate": "2020-07-27T15:18:26Z", "type": "commit"}, {"oid": "4ca896f3d952e9d1f16925cfdf805e2ff842457f", "url": "https://github.com/IQSS/dataverse/commit/4ca896f3d952e9d1f16925cfdf805e2ff842457f", "message": "Publish notification, as displayed in the UI, was adding \"version=DRAFT\" to the url (?).\nWas pre-existing - but why not. (#6918)", "committedDate": "2020-07-27T16:47:24Z", "type": "commit"}, {"oid": "1751379b0c02f71d6acfdf6b74cd838470933c43", "url": "https://github.com/IQSS/dataverse/commit/1751379b0c02f71d6acfdf6b74cd838470933c43", "message": "there's never a reason not to redirect to the draft explicitly after publishing is initiated (#6918)", "committedDate": "2020-07-27T19:11:45Z", "type": "commit"}, {"oid": "840d290d155410c13ab0b0bc640dc056ea35513b", "url": "https://github.com/IQSS/dataverse/commit/840d290d155410c13ab0b0bc640dc056ea35513b", "message": "removed a deprecated setting from the guide. #6918", "committedDate": "2020-07-28T13:56:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNzY2MQ==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r462517661", "bodyText": "minor quibble, but maybe name of method should be \"sendNotificationInNewTransaction\" -  at least that's the naming scheme we used for, e.g., indexDataverseInNewTransaction.", "author": "scolapasta", "createdAt": "2020-07-29T18:56:11Z", "path": "src/main/java/edu/harvard/iq/dataverse/UserNotificationServiceBean.java", "diffHunk": "@@ -83,6 +85,11 @@ public void delete(UserNotification userNotification) {\n         em.remove(em.merge(userNotification));\n     }\n \n+    @TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)\n+    public void sendNotificationInTransaction(AuthenticatedUser dataverseUser, Timestamp sendDate, Type type, Long objectId) {", "originalCommit": "840d290d155410c13ab0b0bc640dc056ea35513b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxODkxOQ==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r462518919", "bodyText": "minor type", "author": "scolapasta", "createdAt": "2020-07-29T18:58:33Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/FinalizeDatasetPublicationCommand.java", "diffHunk": "@@ -149,10 +159,14 @@ public Dataset execute(CommandContext ctxt) throws CommandException {\n         \n \tif (theDataset.getLatestVersion().getVersionState() != RELEASED) {\n             // some imported datasets may already be released.\n-\n+            \n             if (!datasetExternallyReleased) {\n                 publicizeExternalIdentifier(theDataset, ctxt);\n-                // (will throw a CommandException, unless successful)\n+                // Will throw a CommandException, unless successful.\n+                // This will end the exucition of the command, but the method ", "originalCommit": "840d290d155410c13ab0b0bc640dc056ea35513b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTQ5MA==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r462519490", "bodyText": "possibly, out of scope, but should we move export into onSuccess?", "author": "scolapasta", "createdAt": "2020-07-29T18:59:34Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/FinalizeDatasetPublicationCommand.java", "diffHunk": "@@ -220,7 +235,7 @@ private void exportMetadata(Dataset dataset, SettingsServiceBean settingsService\n             ExportService instance = ExportService.getInstance(settingsServiceBean);", "originalCommit": "840d290d155410c13ab0b0bc640dc056ea35513b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMzM2Ng==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r462613366", "bodyText": "I don't see why not; maybe handle it in the same issue that you have opened for moving the indexing into onSuccess?\nOtherwise, I made that exception catch more general (that appeared to be the reason a recent problem with OpenAire export was resulting in a fatal error when publishing... and the code below suggested we never wanted to treat a failure to export as fatal).", "author": "landreev", "createdAt": "2020-07-29T21:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxNzQwMA==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r462617400", "bodyText": "I feel like export actually already is in onSuccess anyway? so are we exporting twice?? I think it's fine to handle in the other issue.", "author": "scolapasta", "createdAt": "2020-07-29T22:06:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3ODAyMQ==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r463278021", "bodyText": "Uh, you're right - it appears to already be in onSuccess.\nSo, what were you proposing then?\n(are you still waiting for something from me for this PR?)", "author": "landreev", "createdAt": "2020-07-30T21:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4MzE1Mw==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r463283153", "bodyText": "If we're sure the onsuccess export does everything the same, I would remove from here. If we're not, we can leave and add as a comment to the other issue to review and clean up then.\n(other than that, can move to QA)", "author": "scolapasta", "createdAt": "2020-07-30T21:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4ODYxMw==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r463288613", "bodyText": "But, this is the method that's called from onSuccess. And it doesn't seem to be called from anywhere else... It's entirely possible that I'm missing something obvious.", "author": "landreev", "createdAt": "2020-07-30T21:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5Mjg2Mw==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r463292863", "bodyText": "Oh. Not you, me --- the way it was truncated in github, it looked to me as if it were in execute. My mistake. (After expanding, yes, it is in onSuccess - which is good, since it's what we expected. Sorry for the noise.", "author": "scolapasta", "createdAt": "2020-07-30T21:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTg1NA==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r462519854", "bodyText": "I already opened a separate issue for this, but index should be moved to onSuccess.", "author": "scolapasta", "createdAt": "2020-07-29T19:00:12Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/FinalizeDatasetPublicationCommand.java", "diffHunk": "@@ -237,10 +252,24 @@ private void updateParentDataversesSubjectsField(Dataset savedDataset, CommandCo\n             if (dsf.getDatasetFieldType().getName().equals(DatasetFieldConstant.subject)) {\n                 Dataverse dv = savedDataset.getOwner();\n                 while (dv != null) {\n-                    if (dv.getDataverseSubjects().addAll(dsf.getControlledVocabularyValues())) {\n+                    boolean newSubjectsAdded = false;\n+                    for (ControlledVocabularyValue cvv : dsf.getControlledVocabularyValues()) {\n+                    \n+                        if (!dv.getDataverseSubjects().contains(cvv)) {\n+                            logger.fine(\"dv \"+dv.getAlias()+\" does not have subject \"+cvv.getStrValue());\n+                            newSubjectsAdded = true;\n+                            dv.getDataverseSubjects().add(cvv);\n+                        } else {\n+                            logger.fine(\"dv \"+dv.getAlias()+\" already has subject \"+cvv.getStrValue());\n+                        }\n+                    }\n+                    if (newSubjectsAdded) {\n+                        logger.fine(\"new dataverse subjects added - saving and reindexing\");\n                         Dataverse dvWithSubjectJustAdded = ctxt.em().merge(dv);\n                         ctxt.em().flush();\n                         ctxt.index().indexDataverse(dvWithSubjectJustAdded); // need to reindex to capture the new subjects", "originalCommit": "840d290d155410c13ab0b0bc640dc056ea35513b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMzUxOA==", "url": "https://github.com/IQSS/dataverse/pull/7118#discussion_r462613518", "bodyText": "Makes sense.", "author": "landreev", "createdAt": "2020-07-29T21:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTg1NA=="}], "type": "inlineReview"}, {"oid": "b5a37d19eccb9a0591e064a204f5a4df669a0f06", "url": "https://github.com/IQSS/dataverse/commit/b5a37d19eccb9a0591e064a204f5a4df669a0f06", "message": "renamed a method - \"...InNewTransaction(...)\" #6918", "committedDate": "2020-07-29T21:50:30Z", "type": "commit"}, {"oid": "e9d3e74e66ef5f2d077cf81ee0efbfcc55378b93", "url": "https://github.com/IQSS/dataverse/commit/e9d3e74e66ef5f2d077cf81ee0efbfcc55378b93", "message": "typo. #6918", "committedDate": "2020-07-29T21:53:13Z", "type": "commit"}]}