{"pr_number": 6968, "pr_title": "allow changes to file metadata via API #6962", "pr_createdAt": "2020-06-05T20:20:22Z", "pr_url": "https://github.com/IQSS/dataverse/pull/6968", "timeline": [{"oid": "809643a9bb72b8faf6fecd7d6e3ad1d52e9c4058", "url": "https://github.com/IQSS/dataverse/commit/809643a9bb72b8faf6fecd7d6e3ad1d52e9c4058", "message": "allow changes to file metadata via API #6962", "committedDate": "2020-06-05T20:14:27Z", "type": "commit"}, {"oid": "508e95c6b9b7e999b40dea4f903424a1afb8da71", "url": "https://github.com/IQSS/dataverse/commit/508e95c6b9b7e999b40dea4f903424a1afb8da71", "message": "allow file metadata changes if passing existing path/name #6962", "committedDate": "2020-06-08T16:27:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MjQ1Ng==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436962456", "bodyText": "does this do weird things if either one is null? i.e I would expect if you only passed on in, and it was the same, then there should be no labelChange, but I think the code for the equals would be false.", "author": "scolapasta", "createdAt": "2020-06-08T19:53:03Z", "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,14 +392,26 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {\n+                    labelChange = false;\n+                }\n+                String oldLabel = df.getFileMetadata().getLabel();\n+                String oldDirectoryLabel = df.getFileMetadata().getDirectoryLabel();\n+                String oldPathPlusName = oldDirectoryLabel + oldLabel;\n+                String incomingPathPlusName = directoryLabel + label;", "originalCommit": "508e95c6b9b7e999b40dea4f903424a1afb8da71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NDE1NA==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436974154", "bodyText": "I figured what matters in terms of if there was a change or not is if the \"path + filename\" is different, so that's what I'm comparing. No, weird things do not happen if one is null, according to my testing.", "author": "pdurbin", "createdAt": "2020-06-08T20:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MjQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk4MjMxNQ==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436982315", "bodyText": "Sorry, maybe what I wrote wasn't clear, so let me use an example:\noldDirectory = \"directory\" and old label = \"label\"\nIf I only path in a label as \"label\" (i.e. no directory), I would expect it to allow it, as I am not changing anything. But the label check would compare \"directorylabel\" with \"nulllabel\" and so would run the check when it shouldn't.\nAlso if (for some reason) for new values you passed directory = \"director\" and label = \"ylabel\", the check would find them equal and so not check names, even though you are changing the names.\nSo the check also needs to have a \"/\" in there.", "author": "scolapasta", "createdAt": "2020-06-08T20:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MjQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU1MDU4OQ==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r437550589", "bodyText": "Good catch. I fixed both of these.", "author": "pdurbin", "createdAt": "2020-06-09T16:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MjQ1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MzEyNg==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436963126", "bodyText": "if directoryLabel is not passed in, do we want path to be \"\"? or keep the old value (as you do with label)?", "author": "scolapasta", "createdAt": "2020-06-08T19:54:20Z", "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,14 +392,26 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {\n+                    labelChange = false;\n+                }\n+                String oldLabel = df.getFileMetadata().getLabel();\n+                String oldDirectoryLabel = df.getFileMetadata().getDirectoryLabel();\n+                String oldPathPlusName = oldDirectoryLabel + oldLabel;\n+                String incomingPathPlusName = directoryLabel + label;\n+                if (oldPathPlusName.equals(incomingPathPlusName)) {\n+                    labelChange = false;\n+                }\n                 String path = \"\";\n                 if (directoryLabel != null) {\n                     path = directoryLabel + \"/\";\n                 }\n                 if (label == null) {\n-                    label = df.getFileMetadata().getLabel();\n+                    label = oldLabel;\n                 }\n-                if (IngestUtil.conflictsWithExistingFilenames(label, directoryLabel, fmdList, df)) {", "originalCommit": "508e95c6b9b7e999b40dea4f903424a1afb8da71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3MjQzNw==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436972437", "bodyText": "path is only used in the error message...\n\n\"Filename already exists at README.md\"\n\"Filename already exists at code/README.md\"\n\n... and I'm happy with how it works. So yes, I think leaving it as \"\" (empty string) is fine.", "author": "pdurbin", "createdAt": "2020-06-08T20:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MzEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk4NDgyMQ==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436984821", "bodyText": "Sorry path confused me here, what I'm getting it is:\nWhy don't we have have a\nif (directoryLabel == null) { directoryLabel = oldDrectorylLabel; }\nlike with label, otherwise null gets passed into the directory+name check, no? (and if we did this, we could really get rid of path altogether and just use directoryLabel + /. And this way if directorLabel were null, we would get a more accurate message anyway:\n\"Filename already exists at code/README.md\", when \"Filename already exists at README.md\" isn't accurate?", "author": "scolapasta", "createdAt": "2020-06-08T20:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MzEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU1MTA0Nw==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r437551047", "bodyText": "I got rid of the extra path variable and made sure the messages are accurate.", "author": "pdurbin", "createdAt": "2020-06-09T16:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MzEyNg=="}], "type": "inlineReview"}, {"oid": "9954220a37fda04f5864fae9fbdfa9c77e558314", "url": "https://github.com/IQSS/dataverse/commit/9954220a37fda04f5864fae9fbdfa9c77e558314", "message": "allow changes if dir exists and label passed, formatting #6962", "committedDate": "2020-06-09T15:59:23Z", "type": "commit"}, {"oid": "e5ec9bc3648a6521c0cf99401ce88704fad91645", "url": "https://github.com/IQSS/dataverse/commit/e5ec9bc3648a6521c0cf99401ce88704fad91645", "message": "avoid dir1 + file1 == dir + 1file1 (add \"/\") #6962", "committedDate": "2020-06-09T16:06:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzNjE2Nw==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r437636167", "bodyText": "Last suggested change - we can remove this check since it's handled by the code below (if both are null, they get populated with their old values). Simplifies the code for minimal \"cost\".", "author": "scolapasta", "createdAt": "2020-06-09T18:32:12Z", "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,16 +392,32 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n-                String path = \"\";\n-                if (directoryLabel != null) {\n-                    path = directoryLabel + \"/\";\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {", "originalCommit": "e5ec9bc3648a6521c0cf99401ce88704fad91645", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwNTk4Nw==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r437705987", "bodyText": "Good idea. Removed in 491caff.", "author": "pdurbin", "createdAt": "2020-06-09T20:43:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzNjE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzOTk3NQ==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r437639975", "bodyText": "I know this is just for the error message, but why not just use \"incomingPathPlusName\" here?", "author": "scolapasta", "createdAt": "2020-06-09T18:39:10Z", "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,16 +392,32 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n-                String path = \"\";\n-                if (directoryLabel != null) {\n-                    path = directoryLabel + \"/\";\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {\n+                    labelChange = false;\n+                }\n+                String oldLabel = df.getFileMetadata().getLabel();\n+                String oldDirectoryLabel = df.getFileMetadata().getDirectoryLabel();\n+                String oldPathPlusName = oldDirectoryLabel + \"/\" + oldLabel;\n+                if (directoryLabel == null) {\n+                    directoryLabel = oldDirectoryLabel;\n                 }\n                 if (label == null) {\n-                    label = df.getFileMetadata().getLabel();\n+                    label = oldLabel;\n+                }\n+                String incomingPathPlusName = directoryLabel + \"/\" + label;\n+                if (oldPathPlusName.equals(incomingPathPlusName)) {\n+                    labelChange = false;\n                 }\n-                if (IngestUtil.conflictsWithExistingFilenames(label, directoryLabel, fmdList, df)) {\n-                    String incomingPathPlusFileName = path + label;\n-                    return error(BAD_REQUEST, BundleUtil.getStringFromBundle(\"files.api.metadata.update.duplicateFile\", Arrays.asList(incomingPathPlusFileName)));\n+                if (labelChange && IngestUtil.conflictsWithExistingFilenames(label, directoryLabel, fmdList, df)) {\n+                    String pathPlusFilename = \"\";", "originalCommit": "e5ec9bc3648a6521c0cf99401ce88704fad91645", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwMjA5Ng==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r437702096", "bodyText": "Because if we do (I just tried), we get \"null/\" as part of the output. Tests fail with messages like this:\nExpected: Filename already exists at README.md\n  Actual: Filename already exists at null/README.md\n\nThat is to say, that code (below) is there to make sure there's no \"null/\" in the output, like above.\nString pathPlusFilename = \"\";\nif (directoryLabel != null) {\n    pathPlusFilename = directoryLabel + \"/\" + label;\n} else {\n    pathPlusFilename = label;\n}", "author": "pdurbin", "createdAt": "2020-06-09T20:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzOTk3NQ=="}], "type": "inlineReview"}, {"oid": "491caff845882885c084498890d0ab0fc7336a32", "url": "https://github.com/IQSS/dataverse/commit/491caff845882885c084498890d0ab0fc7336a32", "message": "eliminate code we don't need, handled elsewhere #6962\n\nIf null, populated by old values anyway.", "committedDate": "2020-06-09T20:41:04Z", "type": "commit"}, {"oid": "a34d7c1a76d283fe195bcad57215ea12b920e340", "url": "https://github.com/IQSS/dataverse/commit/a34d7c1a76d283fe195bcad57215ea12b920e340", "message": "ensure passing \"\" as directoryLabel doesn't cause problems #6962", "committedDate": "2020-06-10T15:16:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1NTM1Ng==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r438855356", "bodyText": "The issue here is that if it gets to the conflictswithexisting stage and that returns false, I think we have a problem:\nif conflictswithexisting filenames returns false, it\u2019s because it\u2019s treating \u2018\u2019 and null differently, since the name is the same). So if you did the same thing, but actually changed the name of the file to a different file name that does exist? Wouldn\u2019t conflictswithexisting still return false then and allow you to rename to an already existing file.\nThe use case is you have two files:\n\u2022 the existing values are null for directory for both, names are file1 and file2\n\u2022 call the api to edit file1 with \u201c\u201d as directoryLabel and label as \u201cfile2\"\n\u2022 I\u2019m concerned that labelChange would be true and conflictswithexisting would be false and that would allow you to have the same null/file2 for both.", "author": "scolapasta", "createdAt": "2020-06-11T15:06:50Z", "path": "src/test/java/edu/harvard/iq/dataverse/api/DuplicateFilesIT.java", "diffHunk": "@@ -419,4 +420,77 @@ public void existingDirectoryPassLabelChangeDescription() throws IOException {\n \n     }\n \n+    /**\n+     * This test is for the following scenario.\n+     *\n+     * What if the database has null for the directoryLabel? What if you pass in\n+     * directory as \u201c\u201d (because you don\u2019t realize you can just not pass it).\n+     * when it check and compares, the old directory is null. so will that mean\n+     * labelChange = true and it will fail even though you didn\u2019t really change\n+     * the directory?\n+     *\n+     * While \"labelChange\" does end up being true,\n+     * IngestUtil.conflictsWithExistingFilenames returns false, so the change is\n+     * allowed to go through. The description is allowed to be changed and the\n+     * directoryLabel remains null even though the user passed in an empty\n+     * string, which is what we want.", "originalCommit": "a34d7c1a76d283fe195bcad57215ea12b920e340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNjMyMQ==", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r438906321", "bodyText": "I'll add, one solution could be to not store null for directoryLabel ever. We could either store \"\" or even \"/\". This would also help in adding a unique constraint, since unique constraints are problematic with nulls.", "author": "scolapasta", "createdAt": "2020-06-11T16:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1NTM1Ng=="}], "type": "inlineReview"}, {"oid": "2debed2d9cc0ee0996d9b53fa4dde0b0f13dbb11", "url": "https://github.com/IQSS/dataverse/commit/2debed2d9cc0ee0996d9b53fa4dde0b0f13dbb11", "message": "simply conflict-checking code #6962", "committedDate": "2020-06-15T16:08:31Z", "type": "commit"}]}