{"pr_number": 7337, "pr_title": "Allow replacing a draft file", "pr_createdAt": "2020-10-16T19:20:45Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7337", "timeline": [{"oid": "17c343fcee69a6f39275e4be6d734d4dd95321a1", "url": "https://github.com/IQSS/dataverse/commit/17c343fcee69a6f39275e4be6d734d4dd95321a1", "message": "Allow replacing a draft file", "committedDate": "2020-10-16T19:02:45Z", "type": "commit"}, {"oid": "279002dbaaeaf82bfc12ba2905f9e0697386237a", "url": "https://github.com/IQSS/dataverse/commit/279002dbaaeaf82bfc12ba2905f9e0697386237a", "message": "per @scolopasta - set previous datafileId when needed\n\nwhen replacing a draft-only file that was already a replacement itself", "committedDate": "2020-10-19T16:32:55Z", "type": "commit"}, {"oid": "2cd3d3a39387ef57d27b9e8f4568b270a39cf7a5", "url": "https://github.com/IQSS/dataverse/commit/2cd3d3a39387ef57d27b9e8f4568b270a39cf7a5", "message": "typo", "committedDate": "2020-10-20T14:25:28Z", "type": "commit"}, {"oid": "5ecb64c89406bd07e014a3be328035d45effb9dc", "url": "https://github.com/IQSS/dataverse/commit/5ecb64c89406bd07e014a3be328035d45effb9dc", "message": "adding release note", "committedDate": "2020-10-20T14:29:41Z", "type": "commit"}, {"oid": "d0f039f8b3354224709166f13a36e247451fc977", "url": "https://github.com/IQSS/dataverse/commit/d0f039f8b3354224709166f13a36e247451fc977", "message": "return 400 with bad json", "committedDate": "2020-10-20T17:54:41Z", "type": "commit"}, {"oid": "87e2d99e23bd1dae8123d88b06cdf459fa4525de", "url": "https://github.com/IQSS/dataverse/commit/87e2d99e23bd1dae8123d88b06cdf459fa4525de", "message": "Merge branch 'IQSS/7149-Replace_file_in_draft' of https://github.com/QualitativeDataRepository/dataverse.git into IQSS/7149-Replace_file_in_draft", "committedDate": "2020-10-20T17:57:17Z", "type": "commit"}, {"oid": "83eab44d3692648179dfd8e600e034cc28c278aa", "url": "https://github.com/IQSS/dataverse/commit/83eab44d3692648179dfd8e600e034cc28c278aa", "message": "check fail on bad json in tests, use Bundle", "committedDate": "2020-10-20T19:21:05Z", "type": "commit"}, {"oid": "04d36ae0572c33309a175ed2989d1191bdbc6710", "url": "https://github.com/IQSS/dataverse/commit/04d36ae0572c33309a175ed2989d1191bdbc6710", "message": "adding lock sleeps", "committedDate": "2020-10-20T20:11:04Z", "type": "commit"}, {"oid": "77c6bdf8451b9eff3b174aed41bc81413dc7e8b9", "url": "https://github.com/IQSS/dataverse/commit/77c6bdf8451b9eff3b174aed41bc81413dc7e8b9", "message": "fix merge issue", "committedDate": "2020-10-21T15:15:25Z", "type": "commit"}, {"oid": "8727c209f0db21e7c8270c93eb7263b826e03b64", "url": "https://github.com/IQSS/dataverse/commit/8727c209f0db21e7c8270c93eb7263b826e03b64", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/7149-Replace_file_in_draft", "committedDate": "2020-10-21T15:16:47Z", "type": "commit"}, {"oid": "ff47892a8f7609b582448397ccd7e147c5eed7b9", "url": "https://github.com/IQSS/dataverse/commit/ff47892a8f7609b582448397ccd7e147c5eed7b9", "message": "debugging: only remove fmd when deleting from draft", "committedDate": "2020-10-21T18:15:32Z", "type": "commit"}, {"oid": "be1026f9fcf664573c6cff224de59d853dd072e2", "url": "https://github.com/IQSS/dataverse/commit/be1026f9fcf664573c6cff224de59d853dd072e2", "message": "resolved merge issues - simplifying tbd", "committedDate": "2020-10-22T21:44:30Z", "type": "commit"}, {"oid": "e6a403339fa744a247dd562850628bd84dcb859a", "url": "https://github.com/IQSS/dataverse/commit/e6a403339fa744a247dd562850628bd84dcb859a", "message": "support null lock type in sleep", "committedDate": "2020-10-23T00:05:54Z", "type": "commit"}, {"oid": "d16b3cbf7f937f5b0b6525e587a5e6444f743244", "url": "https://github.com/IQSS/dataverse/commit/d16b3cbf7f937f5b0b6525e587a5e6444f743244", "message": "hopefully cleanup and documentation - no functional change", "committedDate": "2020-10-23T18:28:15Z", "type": "commit"}, {"oid": "72475d3db290df2b3b0be673f3b8581324a70639", "url": "https://github.com/IQSS/dataverse/commit/72475d3db290df2b3b0be673f3b8581324a70639", "message": "fix duplicate replace button", "committedDate": "2020-10-28T13:26:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc0ODI4OA==", "url": "https://github.com/IQSS/dataverse/pull/7337#discussion_r513748288", "bodyText": "Getting a null pointer here when I try to delete a file via the EditDataFilesPage from the Dataset Page. Will investigate further.", "author": "sekmiller", "createdAt": "2020-10-28T20:44:46Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/UpdateDatasetVersionCommand.java", "diffHunk": "@@ -165,38 +167,77 @@ public Dataset execute(CommandContext ctxt) throws CommandException {\n             }\n             // we have to merge to update the database but not flush because\n             // we don't want to create two draft versions!\n-            // Dataset tempDataset = ctxt.em().merge(theDataset);\n-            //SEK 5/30/2019\n-            // This interim merge is causing:\n-            // java.lang.IllegalArgumentException: Cannot merge an entity that has been removed: edu.harvard.iq.dvn.core.study.FileMetadata\n-            // at the merge at line 177\n-            //Is this merge needed to add the lock?  - seems to be 'no' so what is it needed for?\n-            \n-        //    theDataset = ctxt.em().merge(theDataset);\n+            // Although not completely tested, it looks like this merge handles the\n+            // thumbnail case - if the filemetadata is removed from the context below and\n+            // the dataset still references it, that could cause an issue. Merging here\n+            // avoids any reference from it being the dataset thumbnail\n+            theDataset = ctxt.em().merge(theDataset);\n \n+            /*\n+             * This code has to handle many cases, and anyone making changes should\n+             * carefully check tests and basic methods that update the dataset version. The\n+             * differences between the cases stem primarily from differences in whether the\n+             * files to add, and there filemetadata, and files to delete, and their\n+             * filemetadata have been persisted at this point, which manifests itself as to\n+             * whether they have id numbers or not, and apparently, whether or not they\n+             * exists in lists, e.g. the getFileMetadatas() list of a datafile.\n+             *\n+             * To handle this, the code is carefully checking to make sure that deletions\n+             * are deleting the right things and not, for example, doing a remove(fmd) when\n+             * the fmd.getId() is null, which just removes the first element found.\n+             */\n             for (FileMetadata fmd : filesToDelete) {\n+                logger.fine(\"Deleting fmd: \" + fmd.getId() + \" for file: \" + fmd.getDataFile().getId());\n+                // if file is draft (ie. new to this version), delete it. Otherwise just remove\n+                // filemetadata object)\n+                // There are a few cases to handle:\n+                // * the fmd has an id (has been persisted) and is the one in the current\n+                // (draft) version\n+                // * the fmd has an id (has been persisted) but it is from a published version\n+                // so we need the corresponding one from the draft version (i.e. created during\n+                // a getEditVersion call)\n+                // * the fmd has no id (hasn't been persisted) so we have to use non-id based\n+                // means to identify it and remove it from lists\n+\n+                if (fmd.getId() != null) {\n+                    // If the datasetversion doesn't match, we have the fmd from a published version\n+                    // and we need to remove the one for the newly created draft instead, so we find\n+                    // it here\n+                    if (theDataset.getEditVersion() != fmd.getDatasetVersion()) {\n+                        fmd = FileMetadataUtil.getFmdForFileInEditVersion(fmd, theDataset.getEditVersion());\n+                    }\n+                } else {\n+                    // Not sure if this is needed now that there is a dataset merge above, but we\n+                    // need to assure it is on the context\n+                    fmd = ctxt.em().merge(fmd);\n+                }\n+                // There are two datafile cases as well - the file has been released, so we're\n+                // jsut removing it from the current draft version or it is only in the draft\n+                // version and we completely remove the file.\n                 if (!fmd.getDataFile().isReleased()) {", "originalCommit": "d16b3cbf7f937f5b0b6525e587a5e6444f743244", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE1NDA0Ng==", "url": "https://github.com/IQSS/dataverse/pull/7337#discussion_r515154046", "bodyText": "@sekmiller - The new commits should fix this - the test of the two dataset versions in line 208 needed to use ! .equals() instead of !=, and then an fmd merge was needed (removing the else around line 212.", "author": "qqmyers", "createdAt": "2020-10-30T14:51:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc0ODI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwNjQ2Ng==", "url": "https://github.com/IQSS/dataverse/pull/7337#discussion_r515206466", "bodyText": "Ok. i'm able to delete a file from a draft version. Thanks!", "author": "sekmiller", "createdAt": "2020-10-30T16:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc0ODI4OA=="}], "type": "inlineReview"}, {"oid": "e7f38f3d1780f38512907ad1493427b939082569", "url": "https://github.com/IQSS/dataverse/commit/e7f38f3d1780f38512907ad1493427b939082569", "message": "!= to .equals()\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/engine/command/impl/UpdateDatasetVersionCommand.java", "committedDate": "2020-10-30T14:48:08Z", "type": "commit"}, {"oid": "64c9e8838b2049053d3fc2c454cf76714bd4414b", "url": "https://github.com/IQSS/dataverse/commit/64c9e8838b2049053d3fc2c454cf76714bd4414b", "message": "always merge", "committedDate": "2020-10-30T14:48:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwMDc5Ng==", "url": "https://github.com/IQSS/dataverse/pull/7337#discussion_r515200796", "bodyText": "Getting a null pointer here when I try the uncommon, but previously supported, action of uploading a number of files, but then deleting one before saving the rest to the draft version", "author": "sekmiller", "createdAt": "2020-10-30T15:53:11Z", "path": "src/main/java/edu/harvard/iq/dataverse/util/FileMetadataUtil.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+   Copyright (C) 2005-2012, by the President and Fellows of Harvard College.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+         http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+\n+   Dataverse Network - A web application to share, preserve and analyze research data.\n+   Developed at the Institute for Quantitative Social Science, Harvard University.\n+   Version 3.0.\n+*/\n+\n+package edu.harvard.iq.dataverse.util;\n+\n+import edu.harvard.iq.dataverse.DataFile;\n+import edu.harvard.iq.dataverse.DatasetVersion;\n+import edu.harvard.iq.dataverse.FileMetadata;\n+\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.logging.Logger;\n+\n+public class FileMetadataUtil implements java.io.Serializable {\n+    private static final Logger logger = Logger.getLogger(FileMetadataUtil.class.getCanonicalName());\n+\n+    //Delete the filemetadata from the list if and only if it is in the list\n+    public static void removeFileMetadataFromList(Collection<FileMetadata> collection, FileMetadata fmToDelete) {\n+        // With an id, the standard remove will work\n+        if (fmToDelete.getId() != null) {\n+            collection.remove(fmToDelete);\n+        } else {\n+            Iterator<FileMetadata> fmit = collection.iterator();\n+            while (fmit.hasNext()) {\n+                FileMetadata fmd = fmit.next();\n+                // If not, we can remove based on a match based on the id of the related\n+                // datafile\n+                if (fmToDelete.getDataFile().getStorageIdentifier().equals(fmd.getDataFile().getStorageIdentifier())) {\n+                    // and a match on the datasetversion\n+                    if (fmToDelete.getDatasetVersion().getId() == null) {", "originalCommit": "64c9e8838b2049053d3fc2c454cf76714bd4414b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNzU5NA==", "url": "https://github.com/IQSS/dataverse/pull/7337#discussion_r515237594", "bodyText": "Resolved - the new util method assumed that an fmd would always have an associated datasetversion which is not true for this case. - BTW - thanks for the thorough testing!", "author": "qqmyers", "createdAt": "2020-10-30T16:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwMDc5Ng=="}], "type": "inlineReview"}, {"oid": "c5772febf3ba743856f863d05c3de74ece8fdd85", "url": "https://github.com/IQSS/dataverse/commit/c5772febf3ba743856f863d05c3de74ece8fdd85", "message": "fix delete during upload", "committedDate": "2020-10-30T16:51:01Z", "type": "commit"}, {"oid": "75f5871e07458120af51af9c83caca28e4d1ea48", "url": "https://github.com/IQSS/dataverse/commit/75f5871e07458120af51af9c83caca28e4d1ea48", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/7149-Replace_file_in_draft", "committedDate": "2020-11-03T20:27:20Z", "type": "commit"}, {"oid": "c3b4b944d77d4818a00d8ef46f1cca462bd2c825", "url": "https://github.com/IQSS/dataverse/commit/c3b4b944d77d4818a00d8ef46f1cca462bd2c825", "message": "Merge remote-tracking branch 'IQSS/develop' into\n\nIQSS/7149-Replace_file_in_draft\n\nConflicts:\n\tsrc/main/webapp/file.xhtml", "committedDate": "2020-11-10T19:50:13Z", "type": "commit"}, {"oid": "4a0279d5bf4f0d547cf3876df38e781798734db4", "url": "https://github.com/IQSS/dataverse/commit/4a0279d5bf4f0d547cf3876df38e781798734db4", "message": "grammar", "committedDate": "2020-11-10T20:01:18Z", "type": "commit"}, {"oid": "4ba10809c62b01032a6377089a2e4535937b2fc1", "url": "https://github.com/IQSS/dataverse/commit/4ba10809c62b01032a6377089a2e4535937b2fc1", "message": "Merge remote-tracking branch 'IQSS/develop' into\nIQSS/7149-Replace_file_in_draft\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/EditDatafilesPage.java", "committedDate": "2021-01-08T19:59:53Z", "type": "commit"}, {"oid": "d09e94599484272aa1bb4f1d8610b787993e81cd", "url": "https://github.com/IQSS/dataverse/commit/d09e94599484272aa1bb4f1d8610b787993e81cd", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/7149-Replace_file_in_draft", "committedDate": "2021-01-29T18:54:49Z", "type": "commit"}, {"oid": "5eb55ce192eb7d3f9088dd3b840d58e31b31a817", "url": "https://github.com/IQSS/dataverse/commit/5eb55ce192eb7d3f9088dd3b840d58e31b31a817", "message": "Merge remote-tracking branch 'IQSS/develop' into\nIQSS/7149-Replace_file_in_draft\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/datasetutility/FileReplacePageHelper.java\n\tsrc/main/java/propertyFiles/Bundle.properties", "committedDate": "2021-02-23T18:03:19Z", "type": "commit"}, {"oid": "740c3f91353438243871f18af73171110bb874cc", "url": "https://github.com/IQSS/dataverse/commit/740c3f91353438243871f18af73171110bb874cc", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/7149-Replace_file_in_draft", "committedDate": "2021-03-07T17:13:55Z", "type": "commit"}, {"oid": "518e9eec415f5fc3a0b8e829f50987158d354b2d", "url": "https://github.com/IQSS/dataverse/commit/518e9eec415f5fc3a0b8e829f50987158d354b2d", "message": "add checksumtype support", "committedDate": "2021-03-07T17:18:36Z", "type": "commit"}]}