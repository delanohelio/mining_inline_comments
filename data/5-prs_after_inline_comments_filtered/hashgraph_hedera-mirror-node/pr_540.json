{"pr_number": 540, "pr_title": "Set maxConcurrentCallsPerConnection to prevent excessive calls ", "pr_createdAt": "2020-02-15T00:05:30Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/540", "timeline": [{"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f0b23f10cd58c0468fa7deb59eb87aab1c6f6198", "message": "Set maxConcurrentCallsPerConnection to prevent excessive calls from single connection\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-14T23:57:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NjkyOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r379696929", "bodyText": "Since this variable is static and there are multiple threads setting it, this needs to be protected by a synchronized block", "author": "steven-sheehy", "createdAt": "2020-02-15T00:09:34Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/client/SingleTopicHCSClient.java", "diffHunk": "@@ -66,11 +70,23 @@ public void setupTest(JavaSamplerContext context) {\n             builder.setLimit(limit);\n         }\n \n-        hcsTopicSampler = new HCSTopicSampler(host, port, builder.build());\n+        setSampler(sharedChannel, host, port, builder.build());\n \n         super.setupTest(context);\n     }\n \n+    private void setSampler(boolean sharedChannel, String host, int port, ConsensusTopicQuery consensusTopicQuery) {\n+        if (sharedChannel) {", "originalCommit": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0NzE3MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r380847170", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2020-02-18T18:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NjkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5ODU1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r379698558", "bodyText": "I think 5 would be better. Min should be 1.", "author": "steven-sheehy", "createdAt": "2020-02-15T00:20:09Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.hedera.mirror.grpc.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.Min;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@ConfigurationProperties(\"hedera.mirror.grpc.netty\")\n+public class NettyProperties {\n+    @Min(5)\n+    private int maxConcurrentCallsPerConnection = 10;", "originalCommit": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0NzIyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r380847225", "bodyText": "Changed", "author": "Nana-EC", "createdAt": "2020-02-18T18:13:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5ODU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5ODc0NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r379698744", "bodyText": "I think we should take this time to see if the other settings that HAPI use that can be utilized here.", "author": "steven-sheehy", "createdAt": "2020-02-15T00:21:08Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java", "diffHunk": "@@ -46,4 +50,10 @@ CompositeHealthContributor grpcServices(GrpcServiceDiscoverer grpcServiceDiscove\n \n         return CompositeHealthContributor.fromMap(healthIndicators);\n     }\n+\n+    @Bean\n+    public GrpcServerConfigurer grpcServerConfigurer(NettyProperties nettyProperties) {\n+        return serverBuilder -> ((NettyServerBuilder) serverBuilder)\n+                .maxConcurrentCallsPerConnection(nettyProperties.getMaxConcurrentCallsPerConnection());", "originalCommit": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgyMzY5Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r380823696", "bodyText": "Agreed. Looking at some of the other properties. Per your overall feedback I'll break further properties out into a separate PR.", "author": "Nana-EC", "createdAt": "2020-02-18T17:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5ODc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkyMjA3Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r380922077", "bodyText": "Agreed to defer to follow up PR", "author": "steven-sheehy", "createdAt": "2020-02-18T20:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5ODc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTcwMjY0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r379702648", "bodyText": "it would be good if all  hedera.mirror.grpc.*  properties can reference back to single place GrpcProperties.\nAdding private NettyProperties netty = new NettyProperties() to  GrpcProperties would be sufficient. @ConfigurationProperties can be removed then.\nhttps://github.com/spring-projects/spring-boot/wiki/Spring-Boot-Configuration-Binding#nested-property", "author": "apeksharma", "createdAt": "2020-02-15T00:47:49Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.hedera.mirror.grpc.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.Min;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@ConfigurationProperties(\"hedera.mirror.grpc.netty\")", "originalCommit": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0Njc2OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r380846768", "bodyText": "Good idea. Will move it there so references will follow the GrpcProperties.Netty. format", "author": "Nana-EC", "createdAt": "2020-02-18T18:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTcwMjY0OA=="}], "type": "inlineReview"}, {"oid": "a7d8ba80772d5a86ec1be584fd2440ffc39ee8c4", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a7d8ba80772d5a86ec1be584fd2440ffc39ee8c4", "message": "Updated maxConcurrentCallsPerConnection default and validation. Nested NettyProperties into GrpcProperties\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-18T18:12:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1NzE3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r380857172", "bodyText": "probably should be if (channel == null) { channel = ...; } inside synchronized.\nI'm guessing this is the standard case of initializing variable shared by multiple threads. I haven't seen rest of the code, so the suggestion maybe wrong.", "author": "apeksharma", "createdAt": "2020-02-18T18:32:46Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/client/SingleTopicHCSClient.java", "diffHunk": "@@ -78,7 +78,9 @@ public void setupTest(JavaSamplerContext context) {\n     private void setSampler(boolean sharedChannel, String host, int port, ConsensusTopicQuery consensusTopicQuery) {\n         if (sharedChannel) {\n             if (channel == null) {\n-                channel = ManagedChannelBuilder.forAddress(host, port).usePlaintext(true).build();\n+                synchronized (this) {\n+                    channel = ManagedChannelBuilder.forAddress(host, port).usePlaintext(true).build();", "originalCommit": "a7d8ba80772d5a86ec1be584fd2440ffc39ee8c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1NzYzMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r380857632", "bodyText": "Yep actually moving this out into a separate method and doing exactly this", "author": "Nana-EC", "createdAt": "2020-02-18T18:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1NzE3Mg=="}], "type": "inlineReview"}, {"oid": "8af99c6217079a2708864bfffe23ff1c8bd4042f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8af99c6217079a2708864bfffe23ff1c8bd4042f", "message": "Addressed synchronized feedback and added Netty_MaxConcurrentCallsPerConnection.jmx test plan to verify\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-18T20:12:06Z", "type": "commit"}]}