{"pr_number": 857, "pr_title": "Add download latency metrics", "pr_createdAt": "2020-07-09T02:52:12Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/857", "timeline": [{"oid": "ddb2269e557befa9d674757215f03afb00821a9f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ddb2269e557befa9d674757215f03afb00821a9f", "message": "Add download latency metrics\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-09T02:51:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNzMzNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/857#discussion_r451937334", "bodyText": "q: Wouldn't this time always be smaller than the timing for the 1st transaction?\nThe 1st transaction would wait longer than the rest to be downloaded and verified.\nIn that case shouldn't we go with the 1st transaction so we always get a sense of the worst case scenario and future efforts will look to get that latency down?", "author": "Nana-EC", "createdAt": "2020-07-09T03:04:07Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -96,13 +97,19 @@ public Downloader(S3AsyncClient s3Client, ApplicationStatusRepository applicatio\n         signatureDownloadThreadPool = Executors.newFixedThreadPool(downloaderProperties.getThreads());\n         Runtime.getRuntime().addShutdownHook(new Thread(signatureDownloadThreadPool::shutdown));\n \n-        signatureVerificationMetric = Counter.builder(\"hedera.mirror.signature.verification\")\n+        signatureVerificationMetric = Counter.builder(\"hedera.mirror.download.signature.verification\")\n                 .description(\"The number of signatures verified from a particular node\")\n                 .tag(\"type\", downloaderProperties.getStreamType().toString());\n \n-        streamVerificationMetric = Timer.builder(\"hedera.mirror.stream.verification\")\n+        streamVerificationMetric = Timer.builder(\"hedera.mirror.download.stream.verification\")\n                 .description(\"The duration in seconds it took to verify consensus and hash chain of a stream file\")\n                 .tag(\"type\", downloaderProperties.getStreamType().toString());\n+\n+        downloadLatencyMetric = Timer.builder(\"hedera.mirror.download.latency\")", "originalCommit": "ddb2269e557befa9d674757215f03afb00821a9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI5NTg1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/857#discussion_r452295852", "bodyText": "No, we're trying to track latencies of the mirror node itself with these metrics not end to end latencies. Specifically with this metric we're trying to track how quick does the downloader retrieve and verify the files after it's available in S3. If we track the first transaction the value would vary greatly depending upon how often transactions flow through that network and trigger the file to close. For example, in perfnet this value would always be above 10s except during perf tests since that's how often the pinger runs, making the metric useless most of the time. Since we don't have S3 timestamps, using the last timestamp in the file gives us the most consistent and accurate answer to this question.\nBut this question did make me think of another useful metric to add. I added a metric to track the latency between the first and last timestamp in the record file. This number is of course out of our control to improve but useful to track to see if the file is closing every 2s.", "author": "steven-sheehy", "createdAt": "2020-07-09T15:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNzMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMwNzQ5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/857#discussion_r452307493", "bodyText": "Perfect, yeah that confirms some of my thoughts and I agree with your points. I like the addition of the latency between 1st and last transaction.", "author": "Nana-EC", "createdAt": "2020-07-09T15:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNzMzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNzg3OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/857#discussion_r451937878", "bodyText": "Same thought as above. Wouldn't the 1st transaction and therefore recordFile.getConsensusStart be better?", "author": "Nana-EC", "createdAt": "2020-07-09T03:06:02Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/record/RecordFileDownloader.java", "diffHunk": "@@ -78,6 +80,9 @@ protected boolean verifyDataFile(File file, byte[] verifiedHash) {\n             if (!recordFile.getFileHash().contentEquals(Hex.encodeHexString(verifiedHash))) {\n                 return false;\n             }\n+\n+            Instant consensusEnd = Instant.ofEpochSecond(0, recordFile.getConsensusEnd());", "originalCommit": "ddb2269e557befa9d674757215f03afb00821a9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzOTE4MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/857#discussion_r451939180", "bodyText": "I pondered this back when I was adding hedera.mirror.parse.delay but wasn't sure. Is we switch to 1st transaction that should also be updated.", "author": "Nana-EC", "createdAt": "2020-07-09T03:11:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNzg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMwNzcwNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/857#discussion_r452307705", "bodyText": "Addressed by other response", "author": "Nana-EC", "createdAt": "2020-07-09T15:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNzg3OA=="}], "type": "inlineReview"}, {"oid": "89841137827817cc7bf19e2024a26e86ccc1fcdb", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/89841137827817cc7bf19e2024a26e86ccc1fcdb", "message": "Add hedera.mirror.stream.close.latency metric\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-09T15:09:22Z", "type": "commit"}]}