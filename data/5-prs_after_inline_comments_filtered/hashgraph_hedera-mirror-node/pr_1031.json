{"pr_number": 1031, "pr_title": "Clear topic notifications on error", "pr_createdAt": "2020-09-10T21:56:24Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1031", "timeline": [{"oid": "bde1f0e321cdc6975cd39bae55b924c0f60437d9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bde1f0e321cdc6975cd39bae55b924c0f60437d9", "message": "Clear topic notifications on error\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-09-10T21:56:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxMTI4NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1031#discussion_r486711285", "bodyText": "nit: have you considered adding try... finally.. and move topicMessage.clear to the finally block? that way, we don't need the onCleanup listener", "author": "xin-hedera", "createdAt": "2020-09-11T00:52:44Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/notify/NotifyingEntityListener.java", "diffHunk": "@@ -66,9 +83,17 @@ public void onTopicMessage(TopicMessage topicMessage) throws ImporterException {\n     }\n \n     @EventListener\n-    public void onBatch(EntityBatchEvent event) {\n-        jdbcTemplate.execute(SQL, callback(topicMessages));\n-        log.info(\"Finished notifying {} messages\", topicMessages.size());\n+    public void onSave(EntityBatchSaveEvent event) {\n+        if (isEnabled()) {\n+            Stopwatch stopwatch = Stopwatch.createStarted();\n+            timer.record(() -> jdbcTemplate.execute(SQL, callback(topicMessages)));\n+            log.info(\"Finished notifying {} messages in {}\", topicMessages.size(), stopwatch);", "originalCommit": "bde1f0e321cdc6975cd39bae55b924c0f60437d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxMzEwMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1031#discussion_r486713103", "bodyText": "We still need onCleanup for rollback of sqlentitylistener scenario. onSave is only called after pgcopy batch is successful but if it's not then we need to clear the buffer.", "author": "steven-sheehy", "createdAt": "2020-09-11T00:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxMTI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MDU5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1031#discussion_r487080593", "bodyText": "I see, missed the case that rollback is needed when exception happens before onSave is called", "author": "xin-hedera", "createdAt": "2020-09-11T14:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxMTI4NQ=="}], "type": "inlineReview"}]}