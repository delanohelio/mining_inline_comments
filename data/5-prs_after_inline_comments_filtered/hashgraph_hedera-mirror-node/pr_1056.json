{"pr_number": 1056, "pr_title": "Bump hedera-protobuf to 0.9.0-alpha2 and support new fields", "pr_createdAt": "2020-09-17T02:55:49Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056", "timeline": [{"oid": "5f93e7f724473d36eebffa3bb45ca3965d6d0e3c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5f93e7f724473d36eebffa3bb45ca3965d6d0e3c", "message": "Bump hedera protobuf to 0.9.0-alpha2\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-17T02:05:08Z", "type": "commit"}, {"oid": "6d6131e3043b827f96b8b443693f6c4b281e45ac", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6d6131e3043b827f96b8b443693f6c4b281e45ac", "message": "Correct format issues\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-17T03:01:48Z", "type": "commit"}, {"oid": "45793bdd1f59c2cbdcd1caf2ec51d53ab6b33f40", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/45793bdd1f59c2cbdcd1caf2ec51d53ab6b33f40", "message": "Add a RecordItem test to ensure old format of Transaction is able to be parsed\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-18T04:23:36Z", "type": "commit"}, {"oid": "8f20e4acd9b93104f9aed4b8bb829216b97b640b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8f20e4acd9b93104f9aed4b8bb829216b97b640b", "message": "Change RecordItem proto test to hold the Base64 encoding of the proto\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-18T04:35:47Z", "type": "commit"}, {"oid": "60b2260d7ded03552f3ffa6455bfaa40aceb81ff", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/60b2260d7ded03552f3ffa6455bfaa40aceb81ff", "message": "Force pub sub messages to use new SignedTransactionBytes field for transaction body\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-18T05:40:09Z", "type": "commit"}, {"oid": "f23425d96379b0532a48f3259139a4a26d93a428", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f23425d96379b0532a48f3259139a4a26d93a428", "message": "Force tests to follow new Transaction proto standards\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-18T07:38:52Z", "type": "commit"}, {"oid": "9cc2c596d92b06f44925d89ae8bbd650a976e1ae", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9cc2c596d92b06f44925d89ae8bbd650a976e1ae", "message": "Change pubsub integration test to reflect new Transaction proto format\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-18T07:56:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3MzQ0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r490773449", "bodyText": "Not sure how this should be formatted, it's a bit ugly any way I put it.", "author": "ijungmann", "createdAt": "2020-09-18T08:04:49Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/domain/PubSubMessageTest.java", "diffHunk": "@@ -117,69 +118,43 @@ void testSerializationWithNullFields() throws Exception {\n \n     private static Transaction getTransaction() {\n         return Transaction.newBuilder()\n-                .setBody(TransactionBody.newBuilder()\n-                        .setTransactionID(TransactionID.newBuilder()\n-                                .setTransactionValidStart(TIMESTAMP)\n-                                .setAccountID(ACCOUNT_ID)\n-                                .build())\n-                        .setNodeAccountID(ACCOUNT_ID)\n-                        .setTransactionFee(INT64_VALUE)\n-                        .setTransactionValidDuration(Duration.newBuilder().setSeconds(INT64_VALUE).build())\n-                        .setMemoBytes(BYTE_STRING)\n-                        .setConsensusSubmitMessage(ConsensusSubmitMessageTransactionBody.newBuilder()\n-                                .setTopicID(TOPIC_ID)\n-                                .setMessage(BYTE_STRING)\n-                                .build())\n-                        .build())\n-                .setSigMap(SignatureMap.newBuilder()\n-                        .addSigPair(SignaturePair.newBuilder()\n-                                .setEd25519(BYTE_STRING)\n-                                .setPubKeyPrefix(BYTE_STRING)\n-                                .build())\n-                        .build())\n+                .setSignedTransactionBytes(\n+                        SignedTransaction.newBuilder()\n+                                .setBodyBytes(\n+                                        TransactionBody.newBuilder()\n+                                                .setTransactionID(TransactionID.newBuilder()\n+                                                        .setTransactionValidStart(TIMESTAMP)\n+                                                        .setAccountID(ACCOUNT_ID)\n+                                                        .build())\n+                                                .setNodeAccountID(ACCOUNT_ID)\n+                                                .setTransactionFee(INT64_VALUE)\n+                                                .setTransactionValidDuration(Duration.newBuilder()\n+                                                        .setSeconds(INT64_VALUE).build())\n+                                                .setMemoBytes(BYTE_STRING)\n+                                                .setConsensusSubmitMessage(ConsensusSubmitMessageTransactionBody\n+                                                        .newBuilder()\n+                                                        .setTopicID(TOPIC_ID)\n+                                                        .setMessage(BYTE_STRING)\n+                                                        .build())\n+                                                .build()\n+                                                .toByteString())\n+                                .setSigMap(SignatureMap.newBuilder()\n+                                        .addSigPair(SignaturePair.newBuilder()\n+                                                .setEd25519(BYTE_STRING)\n+                                                .setPubKeyPrefix(BYTE_STRING)\n+                                                .build())\n+                                        .build())\n+                                .build()\n+                                .toByteString()\n+                )\n                 .build();\n     }\n \n     private static String getExpectedTransactionJson() {\n         return \"\\\"transaction\\\" : {\" +\n-                \"  \\\"body\\\": {\" +\n-                \"    \\\"transactionID\\\": {\" +\n-                \"      \\\"transactionValidStart\\\": {\" +\n-                \"        \\\"seconds\\\": \\\"0\\\",\" +\n-                \"        \\\"nanos\\\": 123456789\" +\n-                \"      },\" +\n-                \"      \\\"accountID\\\": {\" +\n-                \"        \\\"shardNum\\\": \\\"0\\\",\" +\n-                \"        \\\"realmNum\\\": \\\"0\\\",\" +\n-                \"        \\\"accountNum\\\": \\\"10\\\"\" +\n-                \"      }\" +\n-                \"    },\" +\n-                \"    \\\"nodeAccountID\\\": {\" +\n-                \"      \\\"shardNum\\\": \\\"0\\\",\" +\n-                \"      \\\"realmNum\\\": \\\"0\\\",\" +\n-                \"      \\\"accountNum\\\": \\\"10\\\"\" +\n-                \"    },\" +\n-                \"    \\\"transactionFee\\\": \\\"100000000\\\",\" +\n-                \"    \\\"transactionValidDuration\\\": {\" +\n-                \"      \\\"seconds\\\": \\\"100000000\\\"\" +\n-                \"    },\" +\n-                \"    \\\"generateRecord\\\": false,\" +\n-                \"    \\\"memo\\\": \\\"abcdef\\\",\" +\n-                \"    \\\"consensusSubmitMessage\\\": {\" +\n-                \"      \\\"topicID\\\": {\" +\n-                \"        \\\"shardNum\\\": \\\"0\\\",\" +\n-                \"        \\\"realmNum\\\": \\\"0\\\",\" +\n-                \"        \\\"topicNum\\\": \\\"20\\\"\" +\n-                \"      },\" +\n-                \"      \\\"message\\\": \\\"YWJjZGVm\\\"\" +\n-                \"    }\" +\n-                \"  },\" +\n-                \"  \\\"sigMap\\\": {\" +\n-                \"    \\\"sigPair\\\": [{\" +\n-                \"      \\\"pubKeyPrefix\\\": \\\"YWJjZGVm\\\",\" +\n-                \"      \\\"ed25519\\\": \\\"YWJjZGVm\\\"\" +\n-                \"    }]\" +\n-                \"  }\" +\n+                \"  \\\"bodyBytes\\\":\\\"\\\",\" +\n+                \"  \\\"signedTransactionBytes\\\": \" +\n+                \"\\\"CjQKCwoFEJWa7zoSAhgKEgIYChiAwtcvIgUIgMLXLzIGYWJjZGVm2gEMCgIYFBIGYWJjZGVmEhIKEAoGYWJjZGVmGgZhYmNkZWY=\\\"\" +", "originalCommit": "9cc2c596d92b06f44925d89ae8bbd650a976e1ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjcxOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491196719", "bodyText": "This is wrong, base64 output is not queryable in Google BigQuery. It needs to be json throughout like the old output.", "author": "steven-sheehy", "createdAt": "2020-09-18T21:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3MzQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3Mzc3NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r490773774", "bodyText": "This seems like it will be problematic.", "author": "ijungmann", "createdAt": "2020-09-18T08:05:25Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/domain/RecordItem.java", "diffHunk": "@@ -124,8 +128,8 @@ private static int getTransactionType(TransactionBody body) {\n             Set<Integer> unknownFields = body.getUnknownFields().asMap().keySet();\n \n             if (unknownFields.size() != 1) {", "originalCommit": "9cc2c596d92b06f44925d89ae8bbd650a976e1ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwNTA3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491205073", "bodyText": "Should be fine as it's the unknown fields set in a different class.", "author": "steven-sheehy", "createdAt": "2020-09-18T21:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3Mzc3NA=="}], "type": "inlineReview"}, {"oid": "2eedf58b12a0065d3a25f7ebb852d0a6f5de232d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2eedf58b12a0065d3a25f7ebb852d0a6f5de232d", "message": "Organize static final attributes for the record item test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-18T08:07:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3NjE3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r490776176", "bodyText": "Is it still appropriate to check the unknown fields (in place of doing getBody()) before looking at getBodyBytes, or should these two be flipped now?", "author": "ijungmann", "createdAt": "2020-09-18T08:09:48Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/domain/RecordItem.java", "diffHunk": "@@ -95,20 +96,23 @@ public RecordItem(Transaction transaction, TransactionRecord record) {\n     }\n \n     private static TransactionBody parseTransactionBody(Transaction transaction) {\n-        if (transaction.hasBody()) {\n-            return transaction.getBody();\n-        } else {\n-            // Not possible to check existence of bodyBytes field since there is no 'hasBodyBytes()'.\n-            // If unset, getBodyBytes() returns empty ByteString which always parses successfully to \"empty\"\n-            //TransactionBody. However, every transaction should have a valid (non \"empty\") TransactionBody.\n-            if (transaction.getBodyBytes() == ByteString.EMPTY) {\n-                throw new ParserException(BAD_TRANSACTION_BODY_BYTES_MESSAGE);\n-            }\n-            try {\n+        try {\n+            if (transaction.getSignedTransactionBytes() != ByteString.EMPTY) {\n+                return TransactionBody\n+                        .parseFrom(SignedTransaction.parseFrom(transaction.getSignedTransactionBytes()).getBodyBytes());\n+            } else if (transaction.getUnknownFields().hasField(1)) {", "originalCommit": "2eedf58b12a0065d3a25f7ebb852d0a6f5de232d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1ODg1MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491158851", "bodyText": "Flip it. Especially since unknownFields probably requires reflection.", "author": "steven-sheehy", "createdAt": "2020-09-18T19:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3NjE3Ng=="}], "type": "inlineReview"}, {"oid": "443a436dd2621e285f8dcad6534fff3f1a50e3ec", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/443a436dd2621e285f8dcad6534fff3f1a50e3ec", "message": "Merge branch 'master' into protobuf_0.9.0_changes", "committedDate": "2020-09-18T16:01:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1ODQxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491158415", "bodyText": "Please make the magic number 1 a static constant.", "author": "steven-sheehy", "createdAt": "2020-09-18T19:49:46Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/domain/RecordItem.java", "diffHunk": "@@ -95,20 +96,23 @@ public RecordItem(Transaction transaction, TransactionRecord record) {\n     }\n \n     private static TransactionBody parseTransactionBody(Transaction transaction) {\n-        if (transaction.hasBody()) {\n-            return transaction.getBody();\n-        } else {\n-            // Not possible to check existence of bodyBytes field since there is no 'hasBodyBytes()'.\n-            // If unset, getBodyBytes() returns empty ByteString which always parses successfully to \"empty\"\n-            //TransactionBody. However, every transaction should have a valid (non \"empty\") TransactionBody.\n-            if (transaction.getBodyBytes() == ByteString.EMPTY) {\n-                throw new ParserException(BAD_TRANSACTION_BODY_BYTES_MESSAGE);\n-            }\n-            try {\n+        try {\n+            if (transaction.getSignedTransactionBytes() != ByteString.EMPTY) {\n+                return TransactionBody\n+                        .parseFrom(SignedTransaction.parseFrom(transaction.getSignedTransactionBytes()).getBodyBytes());\n+            } else if (transaction.getUnknownFields().hasField(1)) {", "originalCommit": "443a436dd2621e285f8dcad6534fff3f1a50e3ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491196411", "bodyText": "I think this was done since body is a real object that can be converted to json automatically using Jackson. SignedTransactionBytes is an object but contains the raw body bytes inside it. So converting everything to SignedTransactionBytes doesn't really help conversion due to Jackson still not understanding that inner raw byte array.\nWe should probably remove this conversion hack, keep the fields exactly where they are and register a custom serializer with Jackson that can convert the body bytes no matter which of the three places it shows up as.", "author": "steven-sheehy", "createdAt": "2020-09-18T21:21:35Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/pubsub/PubSubRecordItemListener.java", "diffHunk": "@@ -117,10 +119,19 @@ private void sendPubSubMessage(PubSubMessage pubSubMessage) {\n     }\n \n     private PubSubMessage buildPubSubMessage(long consensusTimestamp, EntityId entity, RecordItem recordItem) {\n-        Transaction transaction = recordItem.getTransaction().toBuilder()\n-                .clearBodyBytes()\n-                .setBody(recordItem.getTransactionBody()) // setting deprecated field makes json conversion easier\n-                .build();\n+        Transaction transaction = recordItem.getTransaction();\n+        if (transaction.getSignedTransactionBytes() == ByteString.EMPTY) {", "originalCommit": "443a436dd2621e285f8dcad6534fff3f1a50e3ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIzOTg0MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r492239841", "bodyText": "Just to make sure I understand, you're looking for a Jackson serializer that takes the SignedTransaction or the BodyBytes if those are set and serializes them into readable JSON objects?  And then remove this logic and update the pub-sub project to deserialize that.", "author": "ijungmann", "createdAt": "2020-09-21T17:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0NTQ1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r492245459", "bodyText": "Yes, and ensure the unknown field TransactionBody is also passed through as JSON. Not necessarily a Jackson Serializer, but somehow configure Jackson to be made aware of how to encode these byte arrays into a JSON object that represents a TransactionBody.", "author": "steven-sheehy", "createdAt": "2020-09-21T17:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0NjIwMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r492246203", "bodyText": "Makes sense, can do.", "author": "ijungmann", "createdAt": "2020-09-21T17:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5OTU0MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493199540", "bodyText": "Based on my testing this isn't a Jackson issue, it's an issue with the JsonFormat printer used in the ProtoJsonSerializer, and I have not found a way yet to customize that.  This issue implies this was an intended effect.", "author": "ijungmann", "createdAt": "2020-09-23T05:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYzNzczMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493637733", "bodyText": "I don't believe it uses protobuf's JsonFormat, it uses Jackson to  encode to json. You can see the config here.\nYou might be able to use mix-ins to do custom serialization.", "author": "steven-sheehy", "createdAt": "2020-09-23T14:26:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2NDI2NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493664264", "bodyText": "And if for some reason it's truly not using Jackson despite being configured to do so, that should be addressed first.", "author": "steven-sheehy", "createdAt": "2020-09-23T14:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY5NzgzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493697833", "bodyText": "Just saw that we use Jackson but then have a custom ProtoJsonSerializer that encodes the entire message to JSON. \ud83e\udd26  There's no point in using Jackson at all if you're going to write the whole message using protobuf JsonFormat.\nJackson has built-in support for protobuf, so not sure why Appy didn't use it. I don't see any related comments on the PR that added it. We can attempt to use that and get it working, but might be a bigger effort.\nOther option is to go back to normalizing to the single field body even if it's not in the protobuf definition. We can clear the body bytes and signedTransactionBytes and always write a hidden field body=1. That might be the simplest option to do now.", "author": "steven-sheehy", "createdAt": "2020-09-23T15:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcwMjk1Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493702956", "bodyText": "Yeah, that's definitely what I was running into, I had the debugger set in the integration test and it was definitely hitting the message converter and then going to that custom serializer.\nI like that approach, I'll see if the Jackson protobuf option plays ball without too much effort, if that's looking like a bigger issue I'll do the unknown body field approach.", "author": "ijungmann", "createdAt": "2020-09-23T15:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1MTAyNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493851026", "bodyText": "I think the same issue is going to occur when using the unknown field body, you cannot add a message to the unknown field set (or at least I haven't seen it), you have to turn it into a ByteString and set it as a length-delimited value, which means it's going to encode that as Base64 bytes as well.\nUnknownFieldSet.Field.newBuilder().addLengthDelimited(TRANSACTION_BODY.toByteString()).build())", "author": "ijungmann", "createdAt": "2020-09-23T19:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2MTA1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493861054", "bodyText": "Ok, other option is to change PubSubMessage.transaction to be a custom pojo with proto fields that match Transaction proto instead of the actual Transaction proto.", "author": "steven-sheehy", "createdAt": "2020-09-23T20:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2MTAxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493961013", "bodyText": "Easy enough, is there a particular mapping tool/framework you use to map to pojos, or just write the logic as needed?", "author": "ijungmann", "createdAt": "2020-09-23T23:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxNTM5Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494015392", "bodyText": "Transaction pojo has been added to the PubSubMessage class, expecting some comments/refactoring on that, but the tests do confirm that it is now serializing to the object, so the big issue is resolved.", "author": "ijungmann", "createdAt": "2020-09-24T03:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NjQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5Njg0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491196849", "bodyText": "Not used?", "author": "steven-sheehy", "createdAt": "2020-09-18T21:22:51Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/domain/RecordItemTest.java", "diffHunk": "@@ -20,40 +20,42 @@\n  * \u200d\n  */\n \n-import com.hederahashgraph.api.proto.java.CryptoTransferTransactionBody;\n-import org.apache.commons.codec.binary.Hex;\n-\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.assertj.core.api.Assertions.assertThatThrownBy;\n \n import com.google.protobuf.ByteString;\n+import com.google.protobuf.UnknownFieldSet;\n+import com.hederahashgraph.api.proto.java.CryptoTransferTransactionBody;\n import com.hederahashgraph.api.proto.java.SignatureMap;\n import com.hederahashgraph.api.proto.java.SignaturePair;\n+import com.hederahashgraph.api.proto.java.SignedTransaction;\n import com.hederahashgraph.api.proto.java.Transaction;\n import com.hederahashgraph.api.proto.java.TransactionBody;\n import com.hederahashgraph.api.proto.java.TransactionReceipt;\n import com.hederahashgraph.api.proto.java.TransactionRecord;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import org.apache.commons.codec.binary.Base64;\n+import org.apache.commons.codec.binary.Hex;\n import org.junit.jupiter.api.Test;\n \n import com.hedera.mirror.importer.exception.ParserException;\n \n class RecordItemTest {\n \n+    private static final Path transactionProtoPath = Paths.get(\"data\", \"protoExamples\", \"transaction\");", "originalCommit": "443a436dd2621e285f8dcad6534fff3f1a50e3ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NzM3MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491197371", "bodyText": "Use constant", "author": "steven-sheehy", "createdAt": "2020-09-18T21:24:21Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/domain/RecordItemTest.java", "diffHunk": "@@ -62,11 +64,31 @@\n             .setCryptoTransfer(CryptoTransferTransactionBody.getDefaultInstance())\n             .build();\n \n+    private static final SignatureMap SIGNATURE_MAP = SignatureMap.newBuilder()\n+            .addSigPair(\n+                    SignaturePair.newBuilder()\n+                            .setEd25519(ByteString.copyFromUtf8(\"ed25519\"))\n+                            .setPubKeyPrefix(ByteString.copyFromUtf8(\"pubKeyPrefix\"))\n+                            .build()\n+            ).build();\n+\n+    private static final SignedTransaction SIGNED_TRANSACTION = SignedTransaction.newBuilder()\n+            .setBodyBytes(TRANSACTION_BODY.toByteString())\n+            .setSigMap(SIGNATURE_MAP)\n+            .build();\n+\n     private static final TransactionRecord TRANSACTION_RECORD = TransactionRecord.newBuilder()\n             .setReceipt(TransactionReceipt.newBuilder().setStatusValue(22).build())\n             .setMemo(\"memo\")\n             .build();\n \n+    private static final UnknownFieldSet UNKNOWN_FIELD_SET = UnknownFieldSet.newBuilder()\n+            .addField(1,", "originalCommit": "443a436dd2621e285f8dcad6534fff3f1a50e3ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM5MDk1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494390954", "bodyText": "Still not resolved", "author": "steven-sheehy", "createdAt": "2020-09-24T15:00:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NzM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ0MjA5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494442094", "bodyText": "Fixed now", "author": "ijungmann", "createdAt": "2020-09-24T16:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NzM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMjk2NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491202965", "bodyText": "This field no longer useful since it has nothing set on it. Would be clearer to just Transaction.newBuilder() in each test.", "author": "steven-sheehy", "createdAt": "2020-09-18T21:41:19Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/domain/RecordItemTest.java", "diffHunk": "@@ -20,40 +20,42 @@\n  * \u200d\n  */\n \n-import com.hederahashgraph.api.proto.java.CryptoTransferTransactionBody;\n-import org.apache.commons.codec.binary.Hex;\n-\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.assertj.core.api.Assertions.assertThatThrownBy;\n \n import com.google.protobuf.ByteString;\n+import com.google.protobuf.UnknownFieldSet;\n+import com.hederahashgraph.api.proto.java.CryptoTransferTransactionBody;\n import com.hederahashgraph.api.proto.java.SignatureMap;\n import com.hederahashgraph.api.proto.java.SignaturePair;\n+import com.hederahashgraph.api.proto.java.SignedTransaction;\n import com.hederahashgraph.api.proto.java.Transaction;\n import com.hederahashgraph.api.proto.java.TransactionBody;\n import com.hederahashgraph.api.proto.java.TransactionReceipt;\n import com.hederahashgraph.api.proto.java.TransactionRecord;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import org.apache.commons.codec.binary.Base64;\n+import org.apache.commons.codec.binary.Hex;\n import org.junit.jupiter.api.Test;\n \n import com.hedera.mirror.importer.exception.ParserException;\n \n class RecordItemTest {\n \n+    private static final Path transactionProtoPath = Paths.get(\"data\", \"protoExamples\", \"transaction\");\n+\n     private static final Transaction DEFAULT_TRANSACTION = Transaction.newBuilder()\n-            .setBodyBytes(TransactionBody.getDefaultInstance().toByteString())\n+            .setSignedTransactionBytes(\n+                    SignedTransaction.getDefaultInstance().getBodyBytes())\n             .build();\n     private static final byte[] DEFAULT_TRANSACTION_BYTES = DEFAULT_TRANSACTION.toByteArray();\n     private static final TransactionRecord DEFAULT_RECORD = TransactionRecord.getDefaultInstance();\n     private static final byte[] DEFAULT_RECORD_BYTES = DEFAULT_RECORD.toByteArray();\n \n     // 'body' and 'bodyBytes' feilds left empty\n     private static final Transaction TRANSACTION = Transaction.newBuilder()", "originalCommit": "443a436dd2621e285f8dcad6534fff3f1a50e3ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMzc0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r491203749", "bodyText": "A helper method TransactionBody getTransactionBody(Transaction transaction) in parent would help future proof this and reduce duplication.", "author": "steven-sheehy", "createdAt": "2020-09-18T21:43:53Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListenerContractTest.java", "diffHunk": "@@ -66,7 +67,8 @@ void before() throws Exception {\n     @Test\n     void contractCreate() throws Exception {\n         Transaction transaction = contractCreateTransaction();\n-        TransactionBody transactionBody = TransactionBody.parseFrom(transaction.getBodyBytes());\n+        TransactionBody transactionBody = TransactionBody.parseFrom(", "originalCommit": "443a436dd2621e285f8dcad6534fff3f1a50e3ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkxNTQ4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r492915486", "bodyText": "Agreed, our tests are notorious for small product changes causing huge test changes", "author": "Nana-EC", "createdAt": "2020-09-22T17:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMzc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwNzE5MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r493207190", "bodyText": "Good idea, I have done just that.", "author": "ijungmann", "createdAt": "2020-09-23T05:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMzc0OQ=="}], "type": "inlineReview"}, {"oid": "8157c7346db84d3785807b1a1b71af4917b73582", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8157c7346db84d3785807b1a1b71af4917b73582", "message": "Address PR comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-21T16:13:14Z", "type": "commit"}, {"oid": "d65037ea208b9810ce0eb672f452d1edb5de4f97", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d65037ea208b9810ce0eb672f452d1edb5de4f97", "message": "Address PR comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-21T17:17:09Z", "type": "commit"}, {"oid": "af8d266f40a3eb254f3bbc18f315fd9a9fdae4b0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/af8d266f40a3eb254f3bbc18f315fd9a9fdae4b0", "message": "Bump hedera-protobuf to 0.9.0-alpha3\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-22T15:35:14Z", "type": "commit"}, {"oid": "db36fc4dcbc65d65d44527b4b45a94081855a379", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/db36fc4dcbc65d65d44527b4b45a94081855a379", "message": "Refacto record listener test to have getTransactionBody method\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-23T05:29:09Z", "type": "commit"}, {"oid": "cef78a6bcb2f4183d9025be641e8d23fd03ae7f2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cef78a6bcb2f4183d9025be641e8d23fd03ae7f2", "message": "Bump hedera-protobuf to 0.9.0-alpha4, target java 8\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-23T14:48:41Z", "type": "commit"}, {"oid": "68ad50e4190ecc5617ead9048ec734875b8e8f47", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/68ad50e4190ecc5617ead9048ec734875b8e8f47", "message": "Create Transaction pojo for PubSubMessage to get around serialization issues\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-24T03:03:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxMjQ5OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494012499", "bodyText": "Added this so that we don't need to do more proto parsing when building the PubSubMessage.", "author": "ijungmann", "createdAt": "2020-09-24T03:11:12Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/domain/RecordItem.java", "diffHunk": "@@ -40,11 +42,13 @@\n public class RecordItem implements StreamItem {\n     static final String BAD_TRANSACTION_BYTES_MESSAGE = \"Failed to parse transaction bytes\";\n     static final String BAD_RECORD_BYTES_MESSAGE = \"Failed to parse record bytes\";\n-    static final String BAD_TRANSACTION_BODY_BYTES_MESSAGE = \"Error parsing transactionBody from bodyBytes\";\n+    static final String BAD_TRANSACTION_BODY_BYTES_MESSAGE = \"Error parsing transactionBody from transaction\";\n+    static final int TRANSACTION_BODY_PROTOBUF_TAG = 1;\n \n     private final Transaction transaction;\n     private final TransactionBody transactionBody;\n     private final TransactionRecord record;\n+    private final SignatureMap signatureMap;", "originalCommit": "68ad50e4190ecc5617ead9048ec734875b8e8f47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2478cace7a3a28765eeaf26ee6bf5ce7ae24465f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2478cace7a3a28765eeaf26ee6bf5ce7ae24465f", "message": "Fix missing return on RecordItem and adjust test to confirm\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-24T03:18:46Z", "type": "commit"}, {"oid": "1e45cf53f18278f3077f722295ade4ed2961989b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1e45cf53f18278f3077f722295ade4ed2961989b", "message": "Merge with master\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-24T03:20:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxNDkyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494014923", "bodyText": "I'm not a huge fan of parsing the SignedTransaction twice, but I have not come up with a way to refactor it yet.", "author": "ijungmann", "createdAt": "2020-09-24T03:21:36Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/domain/RecordItem.java", "diffHunk": "@@ -88,28 +93,43 @@ public RecordItem(byte[] transactionBytes, byte[] recordBytes) {\n     public RecordItem(Transaction transaction, TransactionRecord record) {\n         this.transaction = transaction;\n         transactionBody = parseTransactionBody(transaction);\n+        signatureMap = parseSignatureMap(transaction);\n         transactionType = getTransactionType(transactionBody);\n         this.record = record;\n         transactionBytes = null;\n         recordBytes = null;\n     }\n \n     private static TransactionBody parseTransactionBody(Transaction transaction) {\n-        if (transaction.hasBody()) {\n-            return transaction.getBody();\n-        } else {\n-            // Not possible to check existence of bodyBytes field since there is no 'hasBodyBytes()'.\n-            // If unset, getBodyBytes() returns empty ByteString which always parses successfully to \"empty\"\n-            //TransactionBody. However, every transaction should have a valid (non \"empty\") TransactionBody.\n-            if (transaction.getBodyBytes() == ByteString.EMPTY) {\n-                throw new ParserException(BAD_TRANSACTION_BODY_BYTES_MESSAGE);\n+        try {\n+            if (transaction.getSignedTransactionBytes() != ByteString.EMPTY) {\n+                return TransactionBody\n+                        .parseFrom(SignedTransaction.parseFrom(transaction.getSignedTransactionBytes()).getBodyBytes());\n+            } else if (transaction.getBodyBytes() != ByteString.EMPTY) {\n+                // Not possible to check existence of bodyBytes field since there is no 'hasBodyBytes()'.\n+                // If unset, getBodyBytes() returns empty ByteString which always parses successfully to \"empty\"\n+                //TransactionBody. However, every transaction should have a valid (non \"empty\") TransactionBody.\n+                return TransactionBody.parseFrom(transaction.getBodyBytes());\n+            } else if (transaction.getUnknownFields().hasField(TRANSACTION_BODY_PROTOBUF_TAG)) {\n+                return TransactionBody.parseFrom(transaction.getUnknownFields().getField(1).getLengthDelimitedList()\n+                        .get(0));\n             }\n+            throw new ParserException(BAD_TRANSACTION_BODY_BYTES_MESSAGE);\n+        } catch (\n+                InvalidProtocolBufferException e) {\n+            throw new ParserException(BAD_TRANSACTION_BODY_BYTES_MESSAGE, e);\n+        }\n+    }\n+\n+    private static SignatureMap parseSignatureMap(Transaction transaction) {\n+        if (transaction.getSignedTransactionBytes() != ByteString.EMPTY) {\n             try {\n-                return TransactionBody.parseFrom(transaction.getBodyBytes());\n+                return SignedTransaction.parseFrom(transaction.getSignedTransactionBytes()).getSigMap();", "originalCommit": "1e45cf53f18278f3077f722295ade4ed2961989b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4NzE1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494387158", "bodyText": "I would say combine the two into a single parse method that returns a wrapper object that is only used internally:\n@Value\nprivate class TransactionWrapper {\n  private final TransactionBody transactionBody;\n  private final SignatureMap signatureMap;\n}\n\nprivate static TransactionWrapper parseTransaction(Transaction transaction) {\n}", "author": "steven-sheehy", "createdAt": "2020-09-24T14:55:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxNDkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ0MzEzNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494443135", "bodyText": "The two have been combined into a TransactionBodyAndSignatureMap wrapper class.", "author": "ijungmann", "createdAt": "2020-09-24T16:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxNDkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4ODkxMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494388912", "bodyText": "This should work as it was used before, but just to be extra safe let's use .equals(ByteString.EMPTY) in this method.", "author": "steven-sheehy", "createdAt": "2020-09-24T14:58:14Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/domain/RecordItem.java", "diffHunk": "@@ -88,28 +93,43 @@ public RecordItem(byte[] transactionBytes, byte[] recordBytes) {\n     public RecordItem(Transaction transaction, TransactionRecord record) {\n         this.transaction = transaction;\n         transactionBody = parseTransactionBody(transaction);\n+        signatureMap = parseSignatureMap(transaction);\n         transactionType = getTransactionType(transactionBody);\n         this.record = record;\n         transactionBytes = null;\n         recordBytes = null;\n     }\n \n     private static TransactionBody parseTransactionBody(Transaction transaction) {\n-        if (transaction.hasBody()) {\n-            return transaction.getBody();\n-        } else {\n-            // Not possible to check existence of bodyBytes field since there is no 'hasBodyBytes()'.\n-            // If unset, getBodyBytes() returns empty ByteString which always parses successfully to \"empty\"\n-            //TransactionBody. However, every transaction should have a valid (non \"empty\") TransactionBody.\n-            if (transaction.getBodyBytes() == ByteString.EMPTY) {\n-                throw new ParserException(BAD_TRANSACTION_BODY_BYTES_MESSAGE);\n+        try {\n+            if (transaction.getSignedTransactionBytes() != ByteString.EMPTY) {", "originalCommit": "1e45cf53f18278f3077f722295ade4ed2961989b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ0MzY1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1056#discussion_r494443659", "bodyText": "All != have been swapped to ! .equals(ByteString.EMPTY) in this class", "author": "ijungmann", "createdAt": "2020-09-24T16:13:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4ODkxMg=="}], "type": "inlineReview"}, {"oid": "036bc9aef00fe99f56f985740beddcd7efbe6b83", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/036bc9aef00fe99f56f985740beddcd7efbe6b83", "message": "Address PR comments for RecordItem and test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-09-24T16:10:35Z", "type": "commit"}]}