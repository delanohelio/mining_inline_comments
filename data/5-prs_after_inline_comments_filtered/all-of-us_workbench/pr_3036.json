{"pr_number": 3036, "pr_title": "[RW-4322][risk=low] Implement describe-cluster debug tool", "pr_createdAt": "2020-01-24T03:44:22Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3036", "timeline": [{"oid": "592402f73700fb7e872a53f93b5f75904b3b7d96", "url": "https://github.com/all-of-us/workbench/commit/592402f73700fb7e872a53f93b5f75904b3b7d96", "message": "Implement describe-cluster", "committedDate": "2020-01-24T03:41:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2NzQ4Ng==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r370667486", "bodyText": "nit: I might name these arguments, even the null ones, for readability.", "author": "jaycarlton", "createdAt": "2020-01-24T14:41:04Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ManageClusters.java", "diffHunk": "@@ -91,6 +101,42 @@ private static void listClusters(String apiUrl) throws IOException, ApiException\n     System.out.println(String.format(\"listed %d clusters\", count.get()));\n   }\n \n+  private static void describeCluster(\n+      String apiUrl, String workbenchProjectId, String workbenchServiceAccount, String clusterId)\n+      throws IOException, ApiException {\n+    String[] parts = clusterId.split(\"/\");\n+    if (parts.length != 2) {\n+      System.err.println(\n+          String.format(\n+              \"given cluster ID '%s' is invalid, wanted format 'project/clusterName'\", clusterId));\n+      return;\n+    }\n+\n+    // Leo's getCluster API swagger tends to be outdated; issue a raw getCluster request to ensure\n+    // we get all available information for debugging.\n+    ClusterApi client = newApiClient(apiUrl);\n+    com.squareup.okhttp.Call call = client.getClusterCall(parts[0], parts[1], null, null);", "originalCommit": "592402f73700fb7e872a53f93b5f75904b3b7d96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4MzI0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r370883246", "bodyText": "Done for parts[0], parts[1]. For the nulls, I prefer to comment rather than having placeholder variables.", "author": "calbach", "createdAt": "2020-01-24T23:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2NzQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2ODE0NQ==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r370668145", "bodyText": "nit: why not allow the caller to specify an output stream?", "author": "jaycarlton", "createdAt": "2020-01-24T14:42:09Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ManageClusters.java", "diffHunk": "@@ -91,6 +101,42 @@ private static void listClusters(String apiUrl) throws IOException, ApiException\n     System.out.println(String.format(\"listed %d clusters\", count.get()));\n   }\n \n+  private static void describeCluster(\n+      String apiUrl, String workbenchProjectId, String workbenchServiceAccount, String clusterId)\n+      throws IOException, ApiException {\n+    String[] parts = clusterId.split(\"/\");\n+    if (parts.length != 2) {\n+      System.err.println(\n+          String.format(\n+              \"given cluster ID '%s' is invalid, wanted format 'project/clusterName'\", clusterId));\n+      return;\n+    }\n+\n+    // Leo's getCluster API swagger tends to be outdated; issue a raw getCluster request to ensure\n+    // we get all available information for debugging.\n+    ClusterApi client = newApiClient(apiUrl);\n+    com.squareup.okhttp.Call call = client.getClusterCall(parts[0], parts[1], null, null);\n+    ApiResponse<Object> resp = client.getApiClient().execute(call, Object.class);\n+\n+    // Parse the response as well so we can log specific structured fields.\n+    Cluster cluster = PRETTY_GSON.fromJson(PRETTY_GSON.toJson(resp.getData()), Cluster.class);\n+\n+    System.out.println(PRETTY_GSON.toJson(resp.getData()));", "originalCommit": "592402f73700fb7e872a53f93b5f75904b3b7d96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4MzU3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r370883576", "bodyText": "Why? Use of this function is pretty tightly scoped to just this CLI in this file, probably indefinitely - I don't see an advantage to generalizing this.", "author": "calbach", "createdAt": "2020-01-24T23:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2ODE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5Nzc2Mw==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371597763", "bodyText": "System.out calls won't go to stackdriver logging, right? I guess that's what was curious. Maybe it needn't, since this is just for inspection. There might be a requirement for auditing administrative exploration of a cluster eventually though.", "author": "jaycarlton", "createdAt": "2020-01-28T03:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2ODE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk4Njc0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371986749", "bodyText": "This is running on a dev workstation, none of these logs are going to Stackdriver. As of now we have audit logging of any remote actions such as the creation of the key and calls to GCS etc. It would be nice to have audit logging in these tools as well - definitely outside the scope of this PR.", "author": "calbach", "createdAt": "2020-01-28T18:43:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2ODE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTAxNA==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r370669014", "bodyText": "should this specify that you should run this on your cluster?", "author": "jaycarlton", "createdAt": "2020-01-24T14:43:49Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ManageClusters.java", "diffHunk": "@@ -91,6 +101,42 @@ private static void listClusters(String apiUrl) throws IOException, ApiException\n     System.out.println(String.format(\"listed %d clusters\", count.get()));\n   }\n \n+  private static void describeCluster(\n+      String apiUrl, String workbenchProjectId, String workbenchServiceAccount, String clusterId)\n+      throws IOException, ApiException {\n+    String[] parts = clusterId.split(\"/\");\n+    if (parts.length != 2) {\n+      System.err.println(\n+          String.format(\n+              \"given cluster ID '%s' is invalid, wanted format 'project/clusterName'\", clusterId));\n+      return;\n+    }\n+\n+    // Leo's getCluster API swagger tends to be outdated; issue a raw getCluster request to ensure\n+    // we get all available information for debugging.\n+    ClusterApi client = newApiClient(apiUrl);\n+    com.squareup.okhttp.Call call = client.getClusterCall(parts[0], parts[1], null, null);\n+    ApiResponse<Object> resp = client.getApiClient().execute(call, Object.class);\n+\n+    // Parse the response as well so we can log specific structured fields.\n+    Cluster cluster = PRETTY_GSON.fromJson(PRETTY_GSON.toJson(resp.getData()), Cluster.class);\n+\n+    System.out.println(PRETTY_GSON.toJson(resp.getData()));\n+    System.out.printf(\"\\n\\nTo inspect logs in cloud storage, run the following:\\n\\n\");", "originalCommit": "592402f73700fb7e872a53f93b5f75904b3b7d96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4NDExMA==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r370884110", "bodyText": "No - you aren't supposed to do that (and permissions wise, this should probably be impossible to run on a workbench Leo cluster). This is intended for execution on a dev workstation.", "author": "calbach", "createdAt": "2020-01-24T23:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4NTAzMg==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371385032", "bodyText": "Oh, then I missed the point of why we're printing out stuff to be copied and executed later. The idea is that the logs are protected at a higher level than you necessarily have when you're running this, and/or they're too voluminous to dump to the terminal.", "author": "jaycarlton", "createdAt": "2020-01-27T17:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQwOTUzMg==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371409532", "bodyText": "I've added a bit more instruction to this output. If you decide to run them, these commands get you to effectively a debug session. Human decisions are required because there are multiple log files you might want to look at, and we don't want to depend on the Leo-specific directory structure / naming.\nAfter typing this out, it would good to automate more of this. Once I have https://precisionmedicineinitiative.atlassian.net/browse/PD-4740, I'll revisit this and glob out all the files in the directory, then give a simple commandline someone could use to copy/cat the logs if desired.", "author": "calbach", "createdAt": "2020-01-27T18:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5ODIwMg==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371598202", "bodyText": "Oh that's interesting about the SA tokens.\nDo you think it would make sense to define a group for all the developers who need to go on-call? I know they tend not to want to do that unless there are ~3 or more accounts that need whatever access it might be. It just seems like managing the next person to join the team would be much simpler if it were just adding them to an oncall group.", "author": "jaycarlton", "createdAt": "2020-01-28T03:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNDgyMw==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r372004823", "bodyText": "Groups have been disallowed for IAM policy control by security, as I understand it. I'm going to ask about this on the security call to get clearer rationale on why that's the case since it is very limiting (tried today but ran out of time).", "author": "calbach", "createdAt": "2020-01-28T19:19:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTMzNA==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r370669334", "bodyText": "aside: Do we not yet have an argument parser for Java like we do in Ruby?", "author": "jaycarlton", "createdAt": "2020-01-24T14:44:31Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ManageClusters.java", "diffHunk": "@@ -140,13 +186,23 @@ private static void deleteClusters(\n   public CommandLineRunner run() {\n     return (args) -> {", "originalCommit": "592402f73700fb7e872a53f93b5f75904b3b7d96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4NDQ0Nw==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r370884447", "bodyText": "We do, but it hasn't been backfilled to these older CLIs yet. I've filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4340 for that. This situation could also use some more thought - having a ruby layer of flag parsing feeding into a duplicate Java layer of flag parsing is a sad state of affairs.", "author": "calbach", "createdAt": "2020-01-24T23:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4Nzc2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371387761", "bodyText": "I'd be interested to chat. we're looking at the same issue with ops tooling.", "author": "jaycarlton", "createdAt": "2020-01-27T17:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2OTMzNA=="}], "type": "inlineReview"}, {"oid": "dbef989506747b01c7102ced7b7affd35deed049", "url": "https://github.com/all-of-us/workbench/commit/dbef989506747b01c7102ced7b7affd35deed049", "message": "PR fixes", "committedDate": "2020-01-24T23:25:57Z", "type": "commit"}, {"oid": "dbef989506747b01c7102ced7b7affd35deed049", "url": "https://github.com/all-of-us/workbench/commit/dbef989506747b01c7102ced7b7affd35deed049", "message": "PR fixes", "committedDate": "2020-01-24T23:25:57Z", "type": "forcePushed"}, {"oid": "fcd6e319c5a1e6191e255e6c6b2d5c421b5c8705", "url": "https://github.com/all-of-us/workbench/commit/fcd6e319c5a1e6191e255e6c6b2d5c421b5c8705", "message": "Update SA ctx usage and usage logs", "committedDate": "2020-01-27T18:17:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NjY2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371596661", "bodyText": "nit: This looks like the kind of list you might want in an Enum, so that you can add description, friendly name, or whatever other metadata you like to the arguments. It also lets you be a bit more type-safe, so no one can pass in an unsupported argument.", "author": "jaycarlton", "createdAt": "2020-01-28T03:40:19Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ManageClusters.java", "diffHunk": "@@ -41,6 +46,11 @@\n         \"https://www.googleapis.com/auth/userinfo.profile\",\n         \"https://www.googleapis.com/auth/userinfo.email\"\n       };\n+  private static final List<String> DESCRIBE_ARG_NAMES =", "originalCommit": "fcd6e319c5a1e6191e255e6c6b2d5c421b5c8705", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk3ODg2MA==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371978860", "bodyText": "I'd rather just use flags here, as I referenced in the ticket I filed.", "author": "calbach", "createdAt": "2020-01-28T18:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NjY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NzAzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371597031", "bodyText": "I wonder if it's worth making a shell command in devstart that's just a straight pass-through. If the args are only going to have one source of truth, I'd probably want that to be the code that responds to them, i.e. this file. Plus, ideally we should be able to run this just as easily from outside a ruby dispatching system; we needn't depend on it.", "author": "jaycarlton", "createdAt": "2020-01-28T03:42:38Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ManageClusters.java", "diffHunk": "@@ -155,9 +219,11 @@ public CommandLineRunner run() {\n         case \"delete\":\n           // User-friendly command-line parsing is done in devstart.rb, so we do only simple", "originalCommit": "fcd6e319c5a1e6191e255e6c6b2d5c421b5c8705", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwMzI1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r372003256", "bodyText": "The ruby layer currently handles authenticating as any necessary SA and/or setting up cloud SQL proxy. This requires some degree of flag parsing. The rest could potentially be pass-through, if the options parser allowed that.\nBeyond that, it also handles entering into a docker context (or not).", "author": "calbach", "createdAt": "2020-01-28T19:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NzAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NzQ0MA==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371597440", "bodyText": "nit: this logic seems like it should be in a utility class so that services can use it if they need to. You wouldn't want those to depend on tools I wouldn't think.", "author": "jaycarlton", "createdAt": "2020-01-28T03:45:02Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ManageClusters.java", "diffHunk": "@@ -91,6 +101,50 @@ private static void listClusters(String apiUrl) throws IOException, ApiException\n     System.out.println(String.format(\"listed %d clusters\", count.get()));\n   }\n \n+  private static void describeCluster(\n+      String apiUrl, String workbenchProjectId, String workbenchServiceAccount, String clusterId)\n+      throws IOException, ApiException {\n+    String[] parts = clusterId.split(\"/\");", "originalCommit": "fcd6e319c5a1e6191e255e6c6b2d5c421b5c8705", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNTY3Mg==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r372005672", "bodyText": "It's an idiosyncrasy of the ID format accepted by the command-line tool, it doesn't have any kind of broader significance, unless we decide to use this format in other CLIs (currently, this is the only one that cares about clusters).", "author": "calbach", "createdAt": "2020-01-28T19:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NzQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwMDA1MQ==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371600051", "bodyText": "If I'm reading this right, you can set an explicit expiration time by passing validBeforeTime, but I think it's only for the REST API and not the gcloud command.", "author": "jaycarlton", "createdAt": "2020-01-28T04:00:15Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ManageClusters.java", "diffHunk": "@@ -91,6 +101,50 @@ private static void listClusters(String apiUrl) throws IOException, ApiException\n     System.out.println(String.format(\"listed %d clusters\", count.get()));\n   }\n \n+  private static void describeCluster(\n+      String apiUrl, String workbenchProjectId, String workbenchServiceAccount, String clusterId)\n+      throws IOException, ApiException {\n+    String[] parts = clusterId.split(\"/\");\n+    if (parts.length != 2) {\n+      System.err.println(\n+          String.format(\n+              \"given cluster ID '%s' is invalid, wanted format 'project/clusterName'\", clusterId));\n+      return;\n+    }\n+    String clusterProject = parts[0];\n+    String clusterName = parts[1];\n+\n+    // Leo's getCluster API swagger tends to be outdated; issue a raw getCluster request to ensure\n+    // we get all available information for debugging.\n+    ClusterApi client = newApiClient(apiUrl);\n+    com.squareup.okhttp.Call call =\n+        client.getClusterCall(\n+            clusterProject,\n+            clusterName,\n+            /* progressListener */ null,\n+            /* progressRequestListener */ null);\n+    ApiResponse<Object> resp = client.getApiClient().execute(call, Object.class);\n+\n+    // Parse the response as well so we can log specific structured fields.\n+    Cluster cluster = PRETTY_GSON.fromJson(PRETTY_GSON.toJson(resp.getData()), Cluster.class);\n+\n+    System.out.println(PRETTY_GSON.toJson(resp.getData()));\n+    System.out.printf(\"\\n\\nTo inspect logs in cloud storage, run the following:\\n\\n\");\n+\n+    // TODO(PD-4740): Use impersonation here instead.\n+    String keyPath = String.format(\"/tmp/%s-key.json\", workbenchProjectId);\n+    System.out.printf(\n+        \"    gcloud iam service-accounts keys create %s --iam-account %s\\n\",\n+        keyPath, workbenchServiceAccount);\n+    System.out.printf(\"    gcloud auth activate-service-account --key-file %s\\n\\n\", keyPath);\n+    System.out.printf(\"    gsutil ls gs://%s/**\\n\", cluster.getStagingBucket());\n+    System.out.printf(\"    gsutil cat ... # inspect or copy logs\\n\\n\");\n+    System.out.printf(\"    # Delete the key when done\\n\");", "originalCommit": "fcd6e319c5a1e6191e255e6c6b2d5c421b5c8705", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk4NTg0Mg==", "url": "https://github.com/all-of-us/workbench/pull/3036#discussion_r371985842", "bodyText": "Nice find, but yes - I don't see this supported by the gcloud command. Per above PD-4740 the plan is to switch this to impersonation anyways so its moot.", "author": "calbach", "createdAt": "2020-01-28T18:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwMDA1MQ=="}], "type": "inlineReview"}, {"oid": "bd7596df038cb2dd7405a5af361cfd0a46364321", "url": "https://github.com/all-of-us/workbench/commit/bd7596df038cb2dd7405a5af361cfd0a46364321", "message": "Update utils submodule", "committedDate": "2020-01-28T23:26:26Z", "type": "commit"}, {"oid": "bdb811d827c1e0887cce0817a5a58ccbf3f58ef2", "url": "https://github.com/all-of-us/workbench/commit/bdb811d827c1e0887cce0817a5a58ccbf3f58ef2", "message": "handl local", "committedDate": "2020-01-28T23:36:35Z", "type": "commit"}]}