{"pr_number": 3296, "pr_title": "[RW-4445][risk=low] Add OpsGenieService to create alerts on inbound high-egress events.", "pr_createdAt": "2020-03-24T13:57:39Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3296", "timeline": [{"oid": "12ff4f41e122067f1a52514e6622bbfd7fba0863", "url": "https://github.com/all-of-us/workbench/commit/12ff4f41e122067f1a52514e6622bbfd7fba0863", "message": "Add OpsGenieService to create alerts on inbound high-egress events.", "committedDate": "2020-03-24T13:47:19Z", "type": "commit"}, {"oid": "295c37a88b84c1e8f1a0d85755bce811d26037fc", "url": "https://github.com/all-of-us/workbench/commit/295c37a88b84c1e8f1a0d85755bce811d26037fc", "message": "Add missing build.gradle changes.", "committedDate": "2020-03-24T14:03:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE4NzA0NQ==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397187045", "bodyText": "I was a little surprised that we didn't have this in our backend config already. I think it's distinct enough from the API base URL (they're different App Engine services with different base paths) that it's worth including here. I'm open to alternative suggestions, though.", "author": "gjuggler", "createdAt": "2020-03-24T14:18:17Z", "path": "api/src/main/java/org/pmiops/workbench/config/WorkbenchConfig.java", "diffHunk": "@@ -141,6 +141,9 @@ public String freeTierBillingAccountName() {\n   }\n \n   public static class ServerConfig {\n+    // Base URL for the webapp (e.g. client / ui service).", "originalCommit": "295c37a88b84c1e8f1a0d85755bce811d26037fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "url": "https://github.com/all-of-us/workbench/commit/08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "message": "Fix Sumo controller tests.", "committedDate": "2020-03-24T14:23:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMzNzk5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397337997", "bodyText": "It still seems odd for this to be named SumoLogicController, since it doesn't directly depend on or control SumoLogic at all. Maybe EgressEventController?", "author": "jaycarlton", "createdAt": "2020-03-24T17:33:53Z", "path": "api/src/main/java/org/pmiops/workbench/api/SumoLogicController.java", "diffHunk": "@@ -26,15 +27,18 @@\n   private static final Logger log = Logger.getLogger(SumoLogicController.class.getName());\n   private final EgressEventAuditor egressEventAuditor;\n   private final CloudStorageService cloudStorageService;\n+  private final OpsGenieService opsGenieService;\n   private final Provider<WorkbenchConfig> workbenchConfigProvider;\n \n   @Autowired\n   SumoLogicController(", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA1MTI5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398051291", "bodyText": "I added some class-level comments addressing this. This controller is an inbound API that is very much tied to SumoLogic's data export structure, so it is absolutely Sumo-specific.", "author": "gjuggler", "createdAt": "2020-03-25T17:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMzNzk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0MDUyOA==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398140528", "bodyText": "Good point.", "author": "jaycarlton", "createdAt": "2020-03-25T20:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMzNzk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMzOTIzOA==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397339238", "bodyText": "nit: it might help to organize all the file names in this bucket into a CedentialFile enum so you can ensure that you don't accidentally reuse one. I guess the bigger benefit is containing all these strings into one class that knows what to do with them.", "author": "jaycarlton", "createdAt": "2020-03-24T17:35:44Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieConfig.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.OpsGenieClient;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.config.ConfigurableBeanFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Scope;\n+\n+@Configuration\n+public class OpsGenieConfig {\n+\n+  static final String OPSGENIE_API_KEY_FILENAME = \"opsgenie-key.txt\";", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA4OTEyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398089121", "bodyText": "I'll punt on this, it might be a nice cleanup though \u2013\u00a0filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4661 to track.", "author": "gjuggler", "createdAt": "2020-03-25T18:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMzOTIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MDM0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397340349", "bodyText": "TOL: I think it would be good to have a policy here for what kinds of changes should be dynamic vs requiring a restart. I agree that a credential rotation shouldn't require a restart.", "author": "jaycarlton", "createdAt": "2020-03-24T17:37:23Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieConfig.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.OpsGenieClient;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.config.ConfigurableBeanFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Scope;\n+\n+@Configuration\n+public class OpsGenieConfig {\n+\n+  static final String OPSGENIE_API_KEY_FILENAME = \"opsgenie-key.txt\";\n+\n+  // This bean is prototype-scoped, so a Cloud Storage API call will be made every time a new\n+  // instance is injected. This is okay since we expect alert API requests to be rare; the benefit\n+  // is that API key changes will be reflected immediately rather than requiring a restart of all\n+  // App Engine tasks.", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MDkzMg==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397340932", "bodyText": "Not your fault, but this is a pretty awkward way to set up the constructor/builder.", "author": "jaycarlton", "createdAt": "2020-03-24T17:38:15Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieConfig.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.OpsGenieClient;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.config.ConfigurableBeanFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Scope;\n+\n+@Configuration\n+public class OpsGenieConfig {\n+\n+  static final String OPSGENIE_API_KEY_FILENAME = \"opsgenie-key.txt\";\n+\n+  // This bean is prototype-scoped, so a Cloud Storage API call will be made every time a new\n+  // instance is injected. This is okay since we expect alert API requests to be rare; the benefit\n+  // is that API key changes will be reflected immediately rather than requiring a restart of all\n+  // App Engine tasks.\n+  @Bean\n+  @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)\n+  public AlertApi getAlertApi(CloudStorageService cloudStorageService) {\n+    AlertApi client = new OpsGenieClient().alertV2();\n+    client", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NDAwNg==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397344006", "bodyText": "One thing to think about would be making one service for sending things to OpsGenie (that traffics in that libraries objects, like CreateAlertRequest), and a slightly higher-level service for handling egress events (that, among possibly other things, would make one of those requests and call the OpsGenieService to send it).\nIn other words, even though this is small and readable, there's a minor smell I think in OpsGenieServiceImpl, because it knows about a workbench-specific concept (i.e. the EgressEvent).\nThere are potentially some testing advantages to this split as well (such as mocking the lower service), and we can add another alert trigger later with less tear-up. Though I realize you don't want this to become a pattern.", "author": "jaycarlton", "createdAt": "2020-03-24T17:42:52Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieService.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import org.pmiops.workbench.model.EgressEvent;\n+\n+public interface OpsGenieService {\n+\n+  // Creates an Opsgenie alert for a high-egress event detected in the Workbench system.\n+  public void createEgressEventAlert(EgressEvent egressEvent);", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA2NjA5Mg==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398066092", "bodyText": "I'm treating the OpsGenie client as the lower-level library that we're trusting is well-tested enough to use for our higher-level needs (and which is mocked out in unit tests).\nAnd since we're talking about ~dozens of lines of code here, I'm not too worried about not having the perfect / optimal structure. This can be easily changed as our needs shift over time.", "author": "gjuggler", "createdAt": "2020-03-25T18:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NDAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NTMyMw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397345323", "bodyText": "With the void return here, you won't be able to distinguish easily which Egress Alert maps to which OG alert if there are many happening at once. I'd try to provide bi-directional traceability if possible.", "author": "jaycarlton", "createdAt": "2020-03-24T17:44:55Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieServiceImpl.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.swagger.ApiException;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import com.ifountain.opsgenie.client.swagger.model.CreateAlertRequest;\n+import java.util.logging.Logger;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.EgressEvent;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class OpsGenieServiceImpl implements OpsGenieService {\n+  private static final Logger logger = Logger.getLogger(OpsGenieServiceImpl.class.getName());\n+\n+  private Provider<AlertApi> alertApiProvider;\n+  private Provider<WorkbenchConfig> workbenchConfigProvider;\n+\n+  @Autowired\n+  public OpsGenieServiceImpl(\n+      Provider<AlertApi> alertApiProvider, Provider<WorkbenchConfig> workbenchConfigProvider) {\n+    this.alertApiProvider = alertApiProvider;\n+    this.workbenchConfigProvider = workbenchConfigProvider;\n+  }\n+\n+  private CreateAlertRequest egressEventToOpsGenieAlert(\n+      EgressEvent egressEvent, WorkbenchConfig workbenchConfig) {\n+    CreateAlertRequest request = new CreateAlertRequest();\n+    request.setMessage(String.format(\"High-egress event (%s)\", egressEvent.getProjectName()));\n+    request.setDescription(\n+        new StringBuilder()\n+            .append(String.format(\"Workspace project: %s\\n\", egressEvent.getProjectName()))\n+            .append(String.format(\"VM name: %s\\n\", egressEvent.getVmName()))\n+            .append(String.format(\"Egress amount: %.2f Mib\\n\\n\", egressEvent.getEgressMib()))\n+            .append(\n+                String.format(\n+                    \"Admin link (PMI-Ops): %s/admin/workspaces/%s/\\n\",\n+                    workbenchConfig.server.clientBaseUrl, egressEvent.getProjectName()))\n+            .append(\"Playbook: https://broad.io/aou-high-egress-event\")\n+            .toString());\n+    // Add a note with some more specific details about the alerting criteria and threshold. Notes\n+    // are appended to an existing Opsgenie ticket if this request is de-duplicated against an\n+    // existing ticket, so they're a helpful way to summarize temporal updates to the status of\n+    // an incident.\n+    request.setNote(\n+        String.format(\n+            \"Time window: %d secs, threshold: %.2f Mib, observed: %.2f Mib\",\n+            egressEvent.getTimeWindowDuration(),\n+            egressEvent.getEgressMibThreshold(),\n+            egressEvent.getEgressMib()));\n+    // Set the alias, which is Opsgenie's string key for alert de-duplication. See\n+    // https://docs.opsgenie.com/docs/alert-deduplication\n+    request.setAlias(egressEvent.getProjectName() + \" - \" + egressEvent.getVmName());\n+    return request;\n+  }\n+\n+  @Override\n+  public void createEgressEventAlert(EgressEvent egressEvent) {", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NjgxMw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398076813", "bodyText": "I'm not sure quite what you're getting at. Traceability from where to where? I'm not sure this would be needed, or I'd at least like to validate the need / requirement in practice before potentially over-building here.", "author": "gjuggler", "createdAt": "2020-03-25T18:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NTMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NjI4Nw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397346287", "bodyText": "You don't strictly need this yet, but I'm a bit surprised there's no cancelAlert endpoint here. For testing, etc, it would be nice to have a button or script to kill the alert after it's created. Plus, we could be sure that we have a good handle on the alert we've created with the create API.", "author": "jaycarlton", "createdAt": "2020-03-24T17:46:21Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieService.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import org.pmiops.workbench.model.EgressEvent;\n+\n+public interface OpsGenieService {\n+\n+  // Creates an Opsgenie alert for a high-egress event detected in the Workbench system.\n+  public void createEgressEventAlert(EgressEvent egressEvent);\n+}", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA2Njk4NA==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398066984", "bodyText": "It would be a YAGNI smell \u2013 for now, there is no active flow where the Workbench should close a high-egress alert. It can only open a new alert or add a note to an existing alert.\nI could imagine such a thing being useful for an end-to-end test of the high-egress alerting functionality; it will be trivial to add at that point.", "author": "gjuggler", "createdAt": "2020-03-25T18:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NjI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NzE0Mw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397347143", "bodyText": "I would log this (at least as a warning) in the main application logs. I guess it's already in the audit log.", "author": "jaycarlton", "createdAt": "2020-03-24T17:47:37Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieServiceImpl.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.swagger.ApiException;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import com.ifountain.opsgenie.client.swagger.model.CreateAlertRequest;\n+import java.util.logging.Logger;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.EgressEvent;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class OpsGenieServiceImpl implements OpsGenieService {\n+  private static final Logger logger = Logger.getLogger(OpsGenieServiceImpl.class.getName());\n+\n+  private Provider<AlertApi> alertApiProvider;\n+  private Provider<WorkbenchConfig> workbenchConfigProvider;\n+\n+  @Autowired\n+  public OpsGenieServiceImpl(\n+      Provider<AlertApi> alertApiProvider, Provider<WorkbenchConfig> workbenchConfigProvider) {\n+    this.alertApiProvider = alertApiProvider;\n+    this.workbenchConfigProvider = workbenchConfigProvider;\n+  }\n+\n+  private CreateAlertRequest egressEventToOpsGenieAlert(\n+      EgressEvent egressEvent, WorkbenchConfig workbenchConfig) {\n+    CreateAlertRequest request = new CreateAlertRequest();\n+    request.setMessage(String.format(\"High-egress event (%s)\", egressEvent.getProjectName()));", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA2NzMxMw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398067313", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-03-25T18:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NzE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NzQxMw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397347413", "bodyText": "nit: is there a more precise term that amount?", "author": "jaycarlton", "createdAt": "2020-03-24T17:48:00Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieServiceImpl.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.swagger.ApiException;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import com.ifountain.opsgenie.client.swagger.model.CreateAlertRequest;\n+import java.util.logging.Logger;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.EgressEvent;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class OpsGenieServiceImpl implements OpsGenieService {\n+  private static final Logger logger = Logger.getLogger(OpsGenieServiceImpl.class.getName());\n+\n+  private Provider<AlertApi> alertApiProvider;\n+  private Provider<WorkbenchConfig> workbenchConfigProvider;\n+\n+  @Autowired\n+  public OpsGenieServiceImpl(\n+      Provider<AlertApi> alertApiProvider, Provider<WorkbenchConfig> workbenchConfigProvider) {\n+    this.alertApiProvider = alertApiProvider;\n+    this.workbenchConfigProvider = workbenchConfigProvider;\n+  }\n+\n+  private CreateAlertRequest egressEventToOpsGenieAlert(\n+      EgressEvent egressEvent, WorkbenchConfig workbenchConfig) {\n+    CreateAlertRequest request = new CreateAlertRequest();\n+    request.setMessage(String.format(\"High-egress event (%s)\", egressEvent.getProjectName()));\n+    request.setDescription(\n+        new StringBuilder()\n+            .append(String.format(\"Workspace project: %s\\n\", egressEvent.getProjectName()))\n+            .append(String.format(\"VM name: %s\\n\", egressEvent.getVmName()))\n+            .append(String.format(\"Egress amount: %.2f Mib\\n\\n\", egressEvent.getEgressMib()))", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NTEwMg==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398075102", "bodyText": "Not really, but I tried re-wording and adding the time window.", "author": "gjuggler", "createdAt": "2020-03-25T18:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NzQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0ODM1MA==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397348350", "bodyText": "TOL: This would be a good excuse to try using handlebars/moustache.\nIt's too bad we can't just put a getDescription field on EgressEvent.", "author": "jaycarlton", "createdAt": "2020-03-24T17:49:31Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieServiceImpl.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.swagger.ApiException;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import com.ifountain.opsgenie.client.swagger.model.CreateAlertRequest;\n+import java.util.logging.Logger;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.EgressEvent;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class OpsGenieServiceImpl implements OpsGenieService {\n+  private static final Logger logger = Logger.getLogger(OpsGenieServiceImpl.class.getName());\n+\n+  private Provider<AlertApi> alertApiProvider;\n+  private Provider<WorkbenchConfig> workbenchConfigProvider;\n+\n+  @Autowired\n+  public OpsGenieServiceImpl(\n+      Provider<AlertApi> alertApiProvider, Provider<WorkbenchConfig> workbenchConfigProvider) {\n+    this.alertApiProvider = alertApiProvider;\n+    this.workbenchConfigProvider = workbenchConfigProvider;\n+  }\n+\n+  private CreateAlertRequest egressEventToOpsGenieAlert(\n+      EgressEvent egressEvent, WorkbenchConfig workbenchConfig) {\n+    CreateAlertRequest request = new CreateAlertRequest();\n+    request.setMessage(String.format(\"High-egress event (%s)\", egressEvent.getProjectName()));\n+    request.setDescription(\n+        new StringBuilder()", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0OTAyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397349025", "bodyText": "This is neat. If an alert is closed but then another one is fired with that same alias, is it a new alert or a reopened one?", "author": "jaycarlton", "createdAt": "2020-03-24T17:50:34Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieServiceImpl.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.swagger.ApiException;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import com.ifountain.opsgenie.client.swagger.model.CreateAlertRequest;\n+import java.util.logging.Logger;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.EgressEvent;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class OpsGenieServiceImpl implements OpsGenieService {\n+  private static final Logger logger = Logger.getLogger(OpsGenieServiceImpl.class.getName());\n+\n+  private Provider<AlertApi> alertApiProvider;\n+  private Provider<WorkbenchConfig> workbenchConfigProvider;\n+\n+  @Autowired\n+  public OpsGenieServiceImpl(\n+      Provider<AlertApi> alertApiProvider, Provider<WorkbenchConfig> workbenchConfigProvider) {\n+    this.alertApiProvider = alertApiProvider;\n+    this.workbenchConfigProvider = workbenchConfigProvider;\n+  }\n+\n+  private CreateAlertRequest egressEventToOpsGenieAlert(\n+      EgressEvent egressEvent, WorkbenchConfig workbenchConfig) {\n+    CreateAlertRequest request = new CreateAlertRequest();\n+    request.setMessage(String.format(\"High-egress event (%s)\", egressEvent.getProjectName()));\n+    request.setDescription(\n+        new StringBuilder()\n+            .append(String.format(\"Workspace project: %s\\n\", egressEvent.getProjectName()))\n+            .append(String.format(\"VM name: %s\\n\", egressEvent.getVmName()))\n+            .append(String.format(\"Egress amount: %.2f Mib\\n\\n\", egressEvent.getEgressMib()))\n+            .append(\n+                String.format(\n+                    \"Admin link (PMI-Ops): %s/admin/workspaces/%s/\\n\",\n+                    workbenchConfig.server.clientBaseUrl, egressEvent.getProjectName()))\n+            .append(\"Playbook: https://broad.io/aou-high-egress-event\")\n+            .toString());\n+    // Add a note with some more specific details about the alerting criteria and threshold. Notes\n+    // are appended to an existing Opsgenie ticket if this request is de-duplicated against an\n+    // existing ticket, so they're a helpful way to summarize temporal updates to the status of\n+    // an incident.\n+    request.setNote(\n+        String.format(\n+            \"Time window: %d secs, threshold: %.2f Mib, observed: %.2f Mib\",\n+            egressEvent.getTimeWindowDuration(),\n+            egressEvent.getEgressMibThreshold(),\n+            egressEvent.getEgressMib()));\n+    // Set the alias, which is Opsgenie's string key for alert de-duplication. See\n+    // https://docs.opsgenie.com/docs/alert-deduplication\n+    request.setAlias(egressEvent.getProjectName() + \" - \" + egressEvent.getVmName());", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NjIzNQ==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398076235", "bodyText": "I haven't tested. My reading of the Opsgenie docs is that it will create a new alert.", "author": "gjuggler", "createdAt": "2020-03-25T18:24:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0OTAyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1MzAzMw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397353033", "bodyText": "nit: why not just make this static final?", "author": "jaycarlton", "createdAt": "2020-03-24T17:56:27Z", "path": "api/src/test/java/org/pmiops/workbench/opsgenie/OpsGenieServiceTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Mockito.verify;\n+\n+import com.ifountain.opsgenie.client.swagger.ApiException;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import com.ifountain.opsgenie.client.swagger.model.CreateAlertRequest;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.EgressEvent;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.config.ConfigurableBeanFactory;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Import;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+@RunWith(SpringRunner.class)\n+public class OpsGenieServiceTest {\n+  private static WorkbenchConfig workbenchConfig;\n+  private EgressEvent egressEvent;\n+\n+  @MockBean private AlertApi mockAlertApi;\n+  @Captor private ArgumentCaptor<CreateAlertRequest> alertRequestCaptor;\n+  @Autowired private OpsGenieService opsGenieService;\n+\n+  @TestConfiguration\n+  @Import({OpsGenieServiceImpl.class})\n+  static class Configuration {\n+    @Bean\n+    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)\n+    WorkbenchConfig getWorkbenchConfig() {\n+      return workbenchConfig;\n+    }\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    workbenchConfig = WorkbenchConfig.createEmptyConfig();\n+    workbenchConfig.server.clientBaseUrl = \"https://workbench.researchallofus.org\";\n+\n+    egressEvent =", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3ODQ4MA==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398078480", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-03-25T18:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1MzAzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1Mzc5Ng==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397353796", "bodyText": "Can we also fetch information about the user like username, email, and institution?", "author": "jaycarlton", "createdAt": "2020-03-24T17:57:34Z", "path": "api/src/main/java/org/pmiops/workbench/opsgenie/OpsGenieServiceImpl.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import com.ifountain.opsgenie.client.swagger.ApiException;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import com.ifountain.opsgenie.client.swagger.model.CreateAlertRequest;\n+import java.util.logging.Logger;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.EgressEvent;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class OpsGenieServiceImpl implements OpsGenieService {\n+  private static final Logger logger = Logger.getLogger(OpsGenieServiceImpl.class.getName());\n+\n+  private Provider<AlertApi> alertApiProvider;\n+  private Provider<WorkbenchConfig> workbenchConfigProvider;\n+\n+  @Autowired\n+  public OpsGenieServiceImpl(\n+      Provider<AlertApi> alertApiProvider, Provider<WorkbenchConfig> workbenchConfigProvider) {\n+    this.alertApiProvider = alertApiProvider;\n+    this.workbenchConfigProvider = workbenchConfigProvider;\n+  }\n+\n+  private CreateAlertRequest egressEventToOpsGenieAlert(\n+      EgressEvent egressEvent, WorkbenchConfig workbenchConfig) {\n+    CreateAlertRequest request = new CreateAlertRequest();\n+    request.setMessage(String.format(\"High-egress event (%s)\", egressEvent.getProjectName()));\n+    request.setDescription(\n+        new StringBuilder()\n+            .append(String.format(\"Workspace project: %s\\n\", egressEvent.getProjectName()))", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MzMzMw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398073333", "bodyText": "I considered this, but it turns out programmatically looking up the username / email / etc is a bit more complicated (effectively, we'd have to extract this method body into a central service of some sort). I'm not sure the value is huge, since that info is presented directly in the workspace admin landing page which is the clear alert call-to-action.", "author": "gjuggler", "createdAt": "2020-03-25T18:20:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1Mzc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEzOTgxMw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398139813", "bodyText": "OK. Can we link directly to that page in the description?\nFrom a belt-and-suspenders standpoint, there's a slight chance that the person receiving the alert won't be able to get to the admin console or that it isn't working for some reason. So it would still be spiffy to have that info in the alert. Likewise, if you've got a stack of closed egress alerts, it would be easier to flip through them afterwards without leaving OpsGenie.\nThat could be follow-on work though.", "author": "jaycarlton", "createdAt": "2020-03-25T20:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1Mzc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0NDY4OQ==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398144689", "bodyText": "Yep \u2013\u00a0I don't disagree it will be nice, but I wanted to hold off from getting too fancy so we have at least something running in prod to start working with.\nAnd see 2 lines below this, we do have a direct link to the admin page.", "author": "gjuggler", "createdAt": "2020-03-25T20:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1Mzc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NDU0Mw==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r397354543", "bodyText": "for the format here, the hyphens in each token and - between them is tough on my brain. I.e. if they're a word character, it's hard to use them as a separator. I bet you could just do\n\"{project=aou-rw-test-c7dec260, vm=aou-rw-1}\"", "author": "jaycarlton", "createdAt": "2020-03-24T17:58:45Z", "path": "api/src/test/java/org/pmiops/workbench/opsgenie/OpsGenieServiceTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.pmiops.workbench.opsgenie;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Mockito.verify;\n+\n+import com.ifountain.opsgenie.client.swagger.ApiException;\n+import com.ifountain.opsgenie.client.swagger.api.AlertApi;\n+import com.ifountain.opsgenie.client.swagger.model.CreateAlertRequest;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.EgressEvent;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.config.ConfigurableBeanFactory;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Import;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+@RunWith(SpringRunner.class)\n+public class OpsGenieServiceTest {\n+  private static WorkbenchConfig workbenchConfig;\n+  private EgressEvent egressEvent;\n+\n+  @MockBean private AlertApi mockAlertApi;\n+  @Captor private ArgumentCaptor<CreateAlertRequest> alertRequestCaptor;\n+  @Autowired private OpsGenieService opsGenieService;\n+\n+  @TestConfiguration\n+  @Import({OpsGenieServiceImpl.class})\n+  static class Configuration {\n+    @Bean\n+    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)\n+    WorkbenchConfig getWorkbenchConfig() {\n+      return workbenchConfig;\n+    }\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    workbenchConfig = WorkbenchConfig.createEmptyConfig();\n+    workbenchConfig.server.clientBaseUrl = \"https://workbench.researchallofus.org\";\n+\n+    egressEvent =\n+        new EgressEvent()\n+            .projectName(\"aou-rw-test-c7dec260\")\n+            .vmName(\"aou-rw-1\")\n+            .egressMib(120.7)\n+            .egressMibThreshold(100.0)\n+            .timeWindowDuration(600L);\n+  }\n+\n+  @Test\n+  public void createEgressEventAlert() throws ApiException {\n+    opsGenieService.createEgressEventAlert(egressEvent);\n+    verify(mockAlertApi).createAlert(alertRequestCaptor.capture());\n+\n+    CreateAlertRequest request = alertRequestCaptor.getValue();\n+    assertThat(request.getDescription()).contains(\"Workspace project: aou-rw-test-c7dec260\");\n+    assertThat(request.getDescription())\n+        .contains(\"https://workbench.researchallofus.org/admin/workspaces/aou-rw-test-c7dec260/\");\n+    assertThat(request.getAlias()).isEqualTo(\"aou-rw-test-c7dec260 - aou-rw-1\");", "originalCommit": "08a3d806f4a5108a45aaa296b23d8f9d4ccad1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3OTUzNg==", "url": "https://github.com/all-of-us/workbench/pull/3296#discussion_r398079536", "bodyText": "I'll use a pipe separator, should be clearer.", "author": "gjuggler", "createdAt": "2020-03-25T18:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NDU0Mw=="}], "type": "inlineReview"}, {"oid": "f03a6feb6ff46fc1222288894ac9537548606c38", "url": "https://github.com/all-of-us/workbench/commit/f03a6feb6ff46fc1222288894ac9537548606c38", "message": "PR feedback.", "committedDate": "2020-03-25T18:33:51Z", "type": "commit"}, {"oid": "092fc85cbd50a6058191104cd50d5b3bddfe53af", "url": "https://github.com/all-of-us/workbench/commit/092fc85cbd50a6058191104cd50d5b3bddfe53af", "message": "Add alert tag.", "committedDate": "2020-03-25T20:28:01Z", "type": "commit"}]}