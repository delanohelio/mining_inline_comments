{"pr_number": 3108, "pr_title": "[RW-4315][risk=no] Distribution metrics and timing functions using Logs-based metrics", "pr_createdAt": "2020-02-09T22:31:53Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3108", "timeline": [{"oid": "e9ecba49f88353095f4735bafd400dcce37b181f", "url": "https://github.com/all-of-us/workbench/commit/e9ecba49f88353095f4735bafd400dcce37b181f", "message": "distribution stuff", "committedDate": "2020-01-28T17:45:35Z", "type": "commit"}, {"oid": "c558810c3ba6f04f628bc205fcf2c37e549660de", "url": "https://github.com/all-of-us/workbench/commit/c558810c3ba6f04f628bc205fcf2c37e549660de", "message": "typo & spt", "committedDate": "2020-01-28T18:01:45Z", "type": "commit"}, {"oid": "26266d4f45b4649de6e0e91d530dd1cc63681027", "url": "https://github.com/all-of-us/workbench/commit/26266d4f45b4649de6e0e91d530dd1cc63681027", "message": "start recording all workspaces api methods", "committedDate": "2020-01-28T19:56:52Z", "type": "commit"}, {"oid": "a2007eb7c9dbb74db93dbcd500db4b5cea992522", "url": "https://github.com/all-of-us/workbench/commit/a2007eb7c9dbb74db93dbcd500db4b5cea992522", "message": "refactoring some  more", "committedDate": "2020-01-28T21:58:55Z", "type": "commit"}, {"oid": "1d1e71c0f5d3f117399cb37f7a20bb7181d113b7", "url": "https://github.com/all-of-us/workbench/commit/1d1e71c0f5d3f117399cb37f7a20bb7181d113b7", "message": "some more instrumentation", "committedDate": "2020-01-28T22:29:56Z", "type": "commit"}, {"oid": "b4c0d81d54b0ed97828dfcef0fd713f1530b770b", "url": "https://github.com/all-of-us/workbench/commit/b4c0d81d54b0ed97828dfcef0fd713f1530b770b", "message": "more timings and spotless", "committedDate": "2020-01-28T22:36:31Z", "type": "commit"}, {"oid": "c425152678f3df93c86d3764df5a31ff162fb035", "url": "https://github.com/all-of-us/workbench/commit/c425152678f3df93c86d3764df5a31ff162fb035", "message": "add timings to cohort controller", "committedDate": "2020-01-28T22:44:19Z", "type": "commit"}, {"oid": "d5edf7cee5db10ebb910d4bba9e61d3809e9b09b", "url": "https://github.com/all-of-us/workbench/commit/d5edf7cee5db10ebb910d4bba9e61d3809e9b09b", "message": "debug code", "committedDate": "2020-01-29T03:15:42Z", "type": "commit"}, {"oid": "a309953a3be03555aea41482a9397a35148148f8", "url": "https://github.com/all-of-us/workbench/commit/a309953a3be03555aea41482a9397a35148148f8", "message": "some  renames", "committedDate": "2020-01-29T14:45:28Z", "type": "commit"}, {"oid": "6041d3eba630f1120f0f306271d3c4b08dc29cad", "url": "https://github.com/all-of-us/workbench/commit/6041d3eba630f1120f0f306271d3c4b08dc29cad", "message": "merge & fixup", "committedDate": "2020-01-29T21:59:30Z", "type": "commit"}, {"oid": "1b4cf8b7a9474de5a8e19c4ac46ab10462992231", "url": "https://github.com/all-of-us/workbench/commit/1b4cf8b7a9474de5a8e19c4ac46ab10462992231", "message": "mismerge - sort out later", "committedDate": "2020-02-07T16:11:06Z", "type": "commit"}, {"oid": "d120f33671681fe59759651cdc25f71a871d7727", "url": "https://github.com/all-of-us/workbench/commit/d120f33671681fe59759651cdc25f71a871d7727", "message": "cleanup merge && spotless", "committedDate": "2020-02-07T16:19:39Z", "type": "commit"}, {"oid": "18f50e3e448d311b74211e5a87642c776bbc79a0", "url": "https://github.com/all-of-us/workbench/commit/18f50e3e448d311b74211e5a87642c776bbc79a0", "message": "delete temp merge files", "committedDate": "2020-02-07T16:23:29Z", "type": "commit"}, {"oid": "d05dbedddcfb3afabf5196dd2c84239caa324131", "url": "https://github.com/all-of-us/workbench/commit/d05dbedddcfb3afabf5196dd2c84239caa324131", "message": "more merge fixes", "committedDate": "2020-02-07T16:48:35Z", "type": "commit"}, {"oid": "df41bcc5018d21e49f45381e8944374978fd4ebc", "url": "https://github.com/all-of-us/workbench/commit/df41bcc5018d21e49f45381e8944374978fd4ebc", "message": "progress", "committedDate": "2020-02-07T20:04:01Z", "type": "commit"}, {"oid": "cb3314159d4247a910314678c4c88ff993187186", "url": "https://github.com/all-of-us/workbench/commit/cb3314159d4247a910314678c4c88ff993187186", "message": "some changes", "committedDate": "2020-02-08T00:05:39Z", "type": "commit"}, {"oid": "cbdf296209a9d6b83b2b543e2ca6b97b06df0b6e", "url": "https://github.com/all-of-us/workbench/commit/cbdf296209a9d6b83b2b543e2ca6b97b06df0b6e", "message": "tests", "committedDate": "2020-02-09T14:19:49Z", "type": "commit"}, {"oid": "7a25b93a2a4ae84acd6d10458939321b4dc0da03", "url": "https://github.com/all-of-us/workbench/commit/7a25b93a2a4ae84acd6d10458939321b4dc0da03", "message": "test fixes & merge fixes", "committedDate": "2020-02-09T20:26:48Z", "type": "commit"}, {"oid": "e98130c2079bd68c4734a392a050626b84971634", "url": "https://github.com/all-of-us/workbench/commit/e98130c2079bd68c4734a392a050626b84971634", "message": "more tests", "committedDate": "2020-02-10T14:21:31Z", "type": "commit"}, {"oid": "4f89bdc0ae20b72df9b56c4554f5a543ec008515", "url": "https://github.com/all-of-us/workbench/commit/4f89bdc0ae20b72df9b56c4554f5a543ec008515", "message": "restore status ctrlr", "committedDate": "2020-02-10T14:48:55Z", "type": "commit"}, {"oid": "541f5bad9892ecbbcc968e563d195683fa810f45", "url": "https://github.com/all-of-us/workbench/commit/541f5bad9892ecbbcc968e563d195683fa810f45", "message": "restore cohorts stuff", "committedDate": "2020-02-10T14:53:01Z", "type": "commit"}, {"oid": "027db8bc5acd31adb67da4bd4fb28a191370bcd4", "url": "https://github.com/all-of-us/workbench/commit/027db8bc5acd31adb67da4bd4fb28a191370bcd4", "message": "restore .gitignore", "committedDate": "2020-02-10T14:53:33Z", "type": "commit"}, {"oid": "359f813f5e741d5e3097cee648a32164e412398f", "url": "https://github.com/all-of-us/workbench/commit/359f813f5e741d5e3097cee648a32164e412398f", "message": "log levels", "committedDate": "2020-02-10T20:30:15Z", "type": "commit"}, {"oid": "dac70bc595aaa2cc35172928901e28d673fbb425", "url": "https://github.com/all-of-us/workbench/commit/dac70bc595aaa2cc35172928901e28d673fbb425", "message": "cleanup", "committedDate": "2020-02-11T02:05:22Z", "type": "commit"}, {"oid": "a163259fbbd47ede8f25f0ea80994984ce7b1fa4", "url": "https://github.com/all-of-us/workbench/commit/a163259fbbd47ede8f25f0ea80994984ce7b1fa4", "message": "mock fixes", "committedDate": "2020-02-11T02:43:08Z", "type": "commit"}, {"oid": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "url": "https://github.com/all-of-us/workbench/commit/78171accb6e37a5939b7cb97beafffb9288ba1ee", "message": "pull out implementation  methods to go to service & minimize diff", "committedDate": "2020-02-11T12:33:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwOTI3MQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377609271", "bodyText": "todo: return just the workspaceResponse here and build OK at outer level. same below.", "author": "jaycarlton", "createdAt": "2020-02-11T12:40:11Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -359,27 +386,45 @@ private void setDbWorkspaceFields(\n     dbWorkspace = workspaceService.saveWithLastModified(dbWorkspace);\n     workspaceService.maybeDeleteRecentWorkspace(dbWorkspace.getWorkspaceId());\n     workspaceAuditor.fireDeleteAction(dbWorkspace);\n-    return ResponseEntity.ok(new EmptyResponse());\n   }\n \n   @Override\n   public ResponseEntity<WorkspaceResponse> getWorkspace(\n       String workspaceNamespace, String workspaceId) {\n-    return ResponseEntity.ok(workspaceService.getWorkspace(workspaceNamespace, workspaceId));\n+    final WorkspaceResponse workspaceResponse =\n+        logsBasedMetricService.recordElapsedTime(\n+            MeasurementBundle.builder().addTag(MetricLabel.OPERATION_NAME, \"getWorkspace\"),\n+            DistributionMetric.WORKSPACE_OPERATION_TIME,\n+            () -> workspaceService.getWorkspace(workspaceNamespace, workspaceId));\n+    return ResponseEntity.ok(workspaceResponse);", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NzA0NA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377947044", "bodyText": "Maybe as part of a future refactoring of these to a Service?  not sure it makes sense in this PR - let's keep this one focused.", "author": "jmthibault79", "createdAt": "2020-02-11T22:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwOTI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI3MDQ0NQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378270445", "bodyText": "for consistency with the other lambdas, the  impl functions I pulled out are exactly what would go into the service (returning an API object instead of a ResponseEntity, which is controller business). You can use these methods without doing (with a big lambda), but it made the diff huge.", "author": "jaycarlton", "createdAt": "2020-02-12T14:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwOTI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNTU1OQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377935559", "bodyText": "Is there a need for both?", "author": "jmthibault79", "createdAt": "2020-02-11T22:23:08Z", "path": "api/src/main/java/org/pmiops/workbench/monitoring/LogsBasedMetricService.java", "diffHunk": "@@ -28,4 +31,30 @@\n   default void recordEvent(EventMetric eventMetric) {\n     record(MeasurementBundle.builder().addEvent(eventMetric).build());\n   }\n+  /**\n+   * Use a Stopwatch to time the supplied operation, then add a measurement to the supplied\n+   * measurementBundleBuilder and record the associated DistributionMetric.\n+   *\n+   * @param measurementBundleBuilder - Builder for a MeasurementBundle to be recorded. Typically\n+   *     only has tags.\n+   * @param distributionMetric - Metric to be recorded. Always a distribution, as gauge and count\n+   *     don't make sense for timings\n+   * @param operation - Code to be run, e.g. () -> myService.computeThings()\n+   */\n+  void recordElapsedTime(\n+      Builder measurementBundleBuilder, DistributionMetric distributionMetric, Runnable operation);\n+\n+  /**\n+   * Same as above, but returns the result of the operation", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI2NzIxNA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378267214", "bodyText": "Yes, AFAICT, the compiler won't allow a Supplier to have its value returned.\nYou could argue it shouldn't be an overload, to make it more obvious which one is used.", "author": "jaycarlton", "createdAt": "2020-02-12T14:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMxNjk1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378316956", "bodyText": "Confirmed by commenting out the Runnable version. You can't have a void-valued argument passed in as a runnable.", "author": "jaycarlton", "createdAt": "2020-02-12T15:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNTU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzOTE0Mw==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377939143", "bodyText": "Please add comments describing what this enum is and what its values mean", "author": "jmthibault79", "createdAt": "2020-02-11T22:31:29Z", "path": "api/src/main/java/org/pmiops/workbench/monitoring/views/DistributionAggregation.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package org.pmiops.workbench.monitoring.views;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.stats.Aggregation;\n+import io.opencensus.stats.Aggregation.Distribution;\n+import io.opencensus.stats.BucketBoundaries;\n+\n+public enum DistributionAggregation {", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyMTg1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378321853", "bodyText": "\ud83d\udc4d", "author": "jaycarlton", "createdAt": "2020-02-12T15:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzOTE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzOTk1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377939956", "bodyText": "Same comment as DistributionAggregation", "author": "jmthibault79", "createdAt": "2020-02-11T22:33:29Z", "path": "api/src/main/java/org/pmiops/workbench/monitoring/views/DistributionMetric.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package org.pmiops.workbench.monitoring.views;\n+\n+import io.opencensus.stats.Aggregation;\n+import io.opencensus.stats.Measure.MeasureDouble;\n+import io.opencensus.stats.Measure.MeasureLong;\n+import java.util.Collections;\n+import java.util.List;\n+import org.pmiops.workbench.monitoring.labels.MetricLabel;\n+\n+public enum DistributionMetric implements Metric {", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MDI5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377940291", "bodyText": "why 2?", "author": "jmthibault79", "createdAt": "2020-02-11T22:34:15Z", "path": "api/src/main/java/org/pmiops/workbench/monitoring/views/DistributionMetric.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package org.pmiops.workbench.monitoring.views;\n+\n+import io.opencensus.stats.Aggregation;\n+import io.opencensus.stats.Measure.MeasureDouble;\n+import io.opencensus.stats.Measure.MeasureLong;\n+import java.util.Collections;\n+import java.util.List;\n+import org.pmiops.workbench.monitoring.labels.MetricLabel;\n+\n+public enum DistributionMetric implements Metric {\n+  COHORT_OPERATION_TIME(\n+      \"cohort_operation_time\",\n+      \"Time to complete Cohort-related operation.\",\n+      Collections.singletonList(MetricLabel.OPERATION_NAME),\n+      DistributionAggregation.OPERATION_TIME,\n+      MeasureLong.class),\n+  UNIFORM_RANDOM_SAMPLE(\n+      \"random_sample_2\",", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI2NzcxNA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378267714", "bodyText": "We have to \"burn\" old metric names when making structural changes, so my convention is to add a number suffix. Definitely something to. put in the docs.", "author": "jaycarlton", "createdAt": "2020-02-12T14:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MDI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzM5NQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377943395", "bodyText": "Do we want callers to have to think about MeasurementBundle.Builder?  I'd prefer an interface like one of these:\nlogsBasedMetricService.recordElapsedTime(\n            \"createWorkspace\",\n            DistributionMetric.WORKSPACE_OPERATION_TIME,\n            () -> createWorkspaceImpl(workspace));\n\nor\nlogsBasedMetricService.recordElapsedTime(\n            MeasurementBundle.operationTag(\"createWorkspace\"),\n            DistributionMetric.WORKSPACE_OPERATION_TIME,\n            () -> createWorkspaceImpl(workspace));", "author": "jmthibault79", "createdAt": "2020-02-11T22:41:27Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -246,6 +253,17 @@ private void maybeFileZendeskReviewRequest(Workspace workspace) {\n \n   @Override\n   public ResponseEntity<Workspace> createWorkspace(Workspace workspace) throws BadRequestException {\n+    final Workspace result =\n+        logsBasedMetricService.recordElapsedTime(\n+            MeasurementBundle.builder().addTag(MetricLabel.OPERATION_NAME, \"createWorkspace\"),", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI2ODkyNw==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378268927", "bodyText": "This was done for consistency with all the other metric recording calls. Operation tags aren't a concept the MeasurementBundle knows about. It just knows about labels.\nGoal is to move almost all such calls into. generated code.", "author": "jaycarlton", "createdAt": "2020-02-12T14:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzUzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377943531", "bodyText": "Preach!", "author": "jmthibault79", "createdAt": "2020-02-11T22:41:49Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -246,6 +253,17 @@ private void maybeFileZendeskReviewRequest(Workspace workspace) {\n \n   @Override\n   public ResponseEntity<Workspace> createWorkspace(Workspace workspace) throws BadRequestException {\n+    final Workspace result =\n+        logsBasedMetricService.recordElapsedTime(\n+            MeasurementBundle.builder().addTag(MetricLabel.OPERATION_NAME, \"createWorkspace\"),\n+            DistributionMetric.WORKSPACE_OPERATION_TIME,\n+            () -> createWorkspaceImpl(workspace));\n+    return ResponseEntity.ok(result);\n+  }\n+\n+  // TODO(jaycarlton): migrate this and other \"impl\" methods to WorkspaceService &", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxODU5OA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378418598", "bodyText": "Still not really sold on this. This is only useful if this controller plays a role that's different from WorkspaceService, and isn't just passing through every method call. If that's what's happening (e.g. if this change here exemplifies the expected division of labor), then WorkspacesController may as well become WorkspaceService. Unless there are Spring reasons to want to use WorkspaceService over WorkspaceController in other places.", "author": "calbach", "createdAt": "2020-02-12T18:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2NDk0NA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378464944", "bodyText": "What's the difference between a Controller and a service then? I like controllers to be dumb, and to be the place the request \"takes its shoes off\" and we call a regular old method that works with POJOs, then puts them on again by donning a response entity.\nLet's take this into another channel.", "author": "jaycarlton", "createdAt": "2020-02-12T19:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDAwNg==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377944006", "bodyText": "if you're going to reflow this text, keep going :)", "author": "jmthibault79", "createdAt": "2020-02-11T22:43:00Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -266,7 +284,8 @@ private void maybeFileZendeskReviewRequest(Workspace workspace) {\n     Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n     DbWorkspace dbWorkspace = new DbWorkspace();\n     // A little unintuitive but setting this here reflects the current state of the workspace\n-    // while it was in the billing buffer. Setting this value will inform the update billing code to\n+    // while it was in the billing buffer. Setting this value will inform the update billing\n+    // code to", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMzMDQyNA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378330424", "bodyText": "Oh \ud83d\udca1, it moved when I had this whole block inside the lamda.", "author": "jaycarlton", "createdAt": "2020-02-12T15:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDE1NA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377944154", "bodyText": "same", "author": "jmthibault79", "createdAt": "2020-02-11T22:43:20Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -295,11 +314,11 @@ private void maybeFileZendeskReviewRequest(Workspace workspace) {\n     } catch (Exception e) {\n       throw new ServerErrorException(\"Could not update the workspace's billing account\", e);\n     }\n-\n     try {\n       dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n     } catch (Exception e) {\n-      // Tell Google to set the billing account back to the free tier if the workspace creation\n+      // Tell Google to set the billing account back to the free tier if the workspace\n+      // creation", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDk3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377944976", "bodyText": "restore", "author": "jmthibault79", "createdAt": "2020-02-11T22:45:24Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -408,8 +453,6 @@ private void setDbWorkspaceFields(\n     }\n     ResearchPurpose researchPurpose = request.getWorkspace().getResearchPurpose();\n     if (researchPurpose != null) {\n-      // Note: this utility does not set the \"review requested\" bit or time. This is currently", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2Nzk2MA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r379167960", "bodyText": "Please restore this comment or explain why it was removed", "author": "jmthibault79", "createdAt": "2020-02-13T23:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNTgzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r379225839", "bodyText": "Good catch. I had \"hide unimportant differences\" checked in my diff/merge tool (Beyond Compare), so it didn't flag the comment change.", "author": "jaycarlton", "createdAt": "2020-02-14T02:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NTA3Mw==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377945073", "bodyText": "flow issue again", "author": "jmthibault79", "createdAt": "2020-02-11T22:45:37Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -421,13 +464,13 @@ private void setDbWorkspaceFields(\n         throw new ServerErrorException(\"Could not update the workspace's billing account\", e);\n       }\n     }\n-\n     try {\n       // The version asserted on save is the same as the one we read via\n       // getRequired() above, see RW-215 for details.\n       dbWorkspace = workspaceService.saveWithLastModified(dbWorkspace);\n     } catch (Exception e) {\n-      // Tell Google Cloud to set the billing account back to the original one since our update\n+      // Tell Google Cloud to set the billing account back to the original one since our\n+      // update", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NjIwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377946205", "bodyText": "since the metric is the same for all of these, can you add a little helper method that takes care of it? Something like recordElapsedWorkspaceOperation(\"cloneWorkspace\", () -> cloneWorkspaceImpl(...))", "author": "jmthibault79", "createdAt": "2020-02-11T22:48:18Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -438,13 +481,21 @@ private void setDbWorkspaceFields(\n \n     workspaceAuditor.fireEditAction(\n         originalWorkspace, editedWorkspace, dbWorkspace.getWorkspaceId());\n-    return ResponseEntity.ok(manualWorkspaceMapper.toApiWorkspace(dbWorkspace, fcWorkspace));\n+    return manualWorkspaceMapper.toApiWorkspace(dbWorkspace, fcWorkspace);\n   }\n \n   @Override\n   public ResponseEntity<CloneWorkspaceResponse> cloneWorkspace(\n       String fromWorkspaceNamespace, String fromWorkspaceId, CloneWorkspaceRequest body)\n       throws BadRequestException, TooManyRequestsException {\n+    return logsBasedMetricService.recordElapsedTime(\n+        MeasurementBundle.builder().addTag(MetricLabel.OPERATION_NAME, \"cloneWorkspace\"),\n+        DistributionMetric.WORKSPACE_OPERATION_TIME,", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI2OTI2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378269265", "bodyText": "Great idea! Might need two of them though \ud83e\udd14", "author": "jaycarlton", "createdAt": "2020-02-12T14:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NjIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM0MTM5NA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378341394", "bodyText": "An even bigger win here is that when I switch over the services, I only have to change 5 lines (including imports).", "author": "jaycarlton", "createdAt": "2020-02-12T15:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NjIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUxNTQ1Mg==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378515452", "bodyText": "This supercedes my \"Do we want WorskapceController to know about MeausurementBundle.Builder\" comment - if we're localizing that knowledge to a single location, that works for me.", "author": "jmthibault79", "createdAt": "2020-02-12T21:13:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NjIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NzUxNA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377947514", "bodyText": "This change seems unrelated", "author": "jmthibault79", "createdAt": "2020-02-11T22:51:21Z", "path": "api/src/test/java/org/pmiops/workbench/api/DataSetControllerTest.java", "diffHunk": "@@ -236,8 +237,10 @@\n   @Autowired WorkspaceMapper workspaceMapper;\n \n   @Autowired ManualWorkspaceMapper manualWorkspaceMapper;\n+  @Autowired LogsBasedMetricService logsBasedMetricService;\n \n-  @Autowired Provider<Zendesk> mockZendeskProvider;\n+  @MockBean Provider<Zendesk> mockZendeskProvider;", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2NTE5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378365191", "bodyText": "It's. general style fix. The free-standing form is preferred when there's a named member variabler for the. mock. If no name is needed, then putting. it in the list on the ctrlr is better. It's a non-functional cleanup change. If we don't. do those in test files as we go, things will deteriorate quickly.", "author": "jaycarlton", "createdAt": "2020-02-12T16:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NzUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQyNjgzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378426839", "bodyText": "This change is the correct local optimization. I'd rather not have to make this distinction though, the reason we had to here is that we're hand-constructing the controllers in setUp, resulting in all the above verbosity. The better goal here would be to autowire them all.\n(not for this PR)", "author": "calbach", "createdAt": "2020-02-12T18:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NzUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0ODU3Mg==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377948572", "bodyText": "is there a nice const or other value you can use here that shows why 4 is correct?  Is it PayloadKey.values().size()?", "author": "jmthibault79", "createdAt": "2020-02-11T22:53:58Z", "path": "api/src/test/java/org/pmiops/workbench/monitoring/LogsBasedMetricsServiceTest.java", "diffHunk": "@@ -79,20 +92,18 @@ public void testRecordMeasurementBundle_writes() {\n     assertThat(logEntry.getSeverity()).isEqualTo(Severity.INFO);\n \n     final Map<String, Object> payloadMap = logEntry.<JsonPayload>getPayload().getDataAsMap();\n-    assertThat(payloadMap).hasSize(3);\n+    assertThat(payloadMap).hasSize(4);", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI3MDc3Nw==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378270777", "bodyText": "now that i have the. enum, yes.", "author": "jaycarlton", "createdAt": "2020-02-12T14:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0ODU3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUxNjE5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378516197", "bodyText": "Could you make that update please?  :)", "author": "jmthibault79", "createdAt": "2020-02-12T21:15:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0ODU3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNzY3MQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r379227671", "bodyText": "It's fixed locally in a couple places.", "author": "jaycarlton", "createdAt": "2020-02-14T02:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0ODU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MTY2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r377951665", "bodyText": "worth making some asserts on the logs here?", "author": "jmthibault79", "createdAt": "2020-02-11T23:02:08Z", "path": "api/src/test/java/org/pmiops/workbench/monitoring/LogsBasedMetricsServiceTest.java", "diffHunk": "@@ -121,12 +132,103 @@ public void testRecord_handlesMultipleMeasurements() {\n         sentEntries.stream()\n             .map(e -> (JsonPayload) e.getPayload())\n             .map(JsonPayload::getDataAsMap)\n-            .map(m -> (String) m.get(LogsBasedMetricService.METRIC_NAME_KEY))\n+            .map(m -> (String) m.get(PayloadKey.NAME.getKeyName()))\n             .filter(Objects::nonNull)\n             .collect(ImmutableSet.toImmutableSet());\n     assertThat(metricNames)\n         .containsAllIn(\n             ImmutableSet.of(\n                 EventMetric.NOTEBOOK_CLONE.getName(), EventMetric.NOTEBOOK_DELETE.getName()));\n   }\n+\n+  @Test\n+  public void testTimeAndRecordWithRunnable() {\n+    Set<Integer> sideEffectSet = new HashSet<>();\n+    logsBasedMetricService.recordElapsedTime(\n+        MeasurementBundle.builder().addTag(MetricLabel.OPERATION_NAME, \"test1\"),\n+        DistributionMetric.WORKSPACE_OPERATION_TIME,\n+        () -> {\n+          int innerInt = 2;\n+          sideEffectSet.add(3);\n+          innerInt -= 3;\n+          assertThat(innerInt).isEqualTo(-1);\n+        });\n+    assertThat(sideEffectSet).contains(3);\n+    verify(mockLogging).write(logEntriesCaptor.capture());\n+    final Map<String, Object> entryData =\n+        StreamSupport.stream(logEntriesCaptor.getValue().spliterator(), false)\n+            .map(LogEntry::getPayload)\n+            .map(p -> (JsonPayload) p)\n+            .map(JsonPayload::getDataAsMap)\n+            .findFirst()\n+            .orElse(Collections.emptyMap());\n+    assertThat(entryData).hasSize(4);\n+    assertThat(entryData.get(PayloadKey.NAME.getKeyName()))\n+        .isEqualTo(DistributionMetric.WORKSPACE_OPERATION_TIME.getName());\n+    assertThat((double) entryData.get(PayloadKey.VALUE.getKeyName()))\n+        .isEqualTo((double) OPERATION_DURATION.toMillis());\n+  }\n+\n+  public void testTimeAndRecordWithSupplier() {\n+    Set<Integer> aSet = new HashSet<>();\n+    final int result =\n+        logsBasedMetricService.recordElapsedTime(\n+            MeasurementBundle.builder().addTag(MetricLabel.OPERATION_NAME, \"test1\"),\n+            DistributionMetric.WORKSPACE_OPERATION_TIME,\n+            () -> {\n+              return 99;\n+            });\n+    assertThat(aSet).contains(3);\n+    assertThat(result).isEqualTo(99);\n+\n+    verify(mockLogging).write(logEntriesCaptor.capture());\n+    final Map<String, Object> entryData =\n+        StreamSupport.stream(logEntriesCaptor.getValue().spliterator(), false)\n+            .map(LogEntry::getPayload)\n+            .map(p -> (JsonPayload) p)\n+            .map(JsonPayload::getDataAsMap)\n+            .findFirst()\n+            .orElse(Collections.emptyMap());\n+    assertThat(entryData).hasSize(4);\n+    assertThat(entryData.get(PayloadKey.NAME.getKeyName()))\n+        .isEqualTo(DistributionMetric.WORKSPACE_OPERATION_TIME.getName());\n+    assertThat(entryData.get(PayloadKey.UNIT.getKeyName()))\n+        .isEqualTo(UnitOfMeasure.MILLISECOND.getUcmSymbol());\n+\n+    assertThat((Double) entryData.get(PayloadKey.VALUE.getKeyName()))\n+        .isEqualTo(OPERATION_DURATION.toMillis());\n+  }\n+\n+  @Test(expected = IllegalAccessError.class)\n+  public void testRecordElapsedTime_throws() {\n+    logsBasedMetricService.recordElapsedTime(\n+        MeasurementBundle.builder(),\n+        DistributionMetric.COHORT_OPERATION_TIME,\n+        () -> {\n+          throw new IllegalAccessError(\"Boo!\");\n+        });\n+  }\n+\n+  @Test\n+  public void testRecordElapsedTime_nestedWorks() {", "originalCommit": "78171accb6e37a5939b7cb97beafffb9288ba1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI3MTA2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378271062", "bodyText": "Not sure if I can mock the stopwatch to give ttwo different times.  I'll see what I can do.", "author": "jaycarlton", "createdAt": "2020-02-12T14:07:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MTY2NQ=="}], "type": "inlineReview"}, {"oid": "ccbec34e063fc0896f6d515df8f75ad1991ac176", "url": "https://github.com/all-of-us/workbench/commit/ccbec34e063fc0896f6d515df8f75ad1991ac176", "message": "cleanup  w/ helper methods", "committedDate": "2020-02-12T16:24:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNDYyOA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378414628", "bodyText": "Really like this pattern.", "author": "calbach", "createdAt": "2020-02-12T17:52:45Z", "path": "api/src/main/java/org/pmiops/workbench/monitoring/LogsBasedMetricServiceFakeImpl.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.pmiops.workbench.monitoring;\n+\n+import java.util.function.Supplier;\n+import org.pmiops.workbench.monitoring.MeasurementBundle.Builder;\n+import org.pmiops.workbench.monitoring.views.DistributionMetric;\n+import org.pmiops.workbench.monitoring.views.EventMetric;\n+import org.springframework.stereotype.Service;\n+\n+/**\n+ * While it's possible to mock this service correctly, it's much less intrusive to simply provide a\n+ * no-op implementation. If you're curious on what the stubbing looks like, see\n+ * https://stackoverflow.com/questions/60138415/which-breaks-first-mockito-or-java-generics for\n+ * details on how to mock the generic supplier matcher.\n+ */\n+@Service(\"LOGS_BASED_METRIC_SERVICE_FAKE\")\n+public class LogsBasedMetricServiceFakeImpl implements LogsBasedMetricService {", "originalCommit": "ccbec34e063fc0896f6d515df8f75ad1991ac176", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNTY2OA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378415668", "bodyText": "spelling: manually", "author": "calbach", "createdAt": "2020-02-12T17:54:43Z", "path": "api/src/main/java/org/pmiops/workbench/monitoring/LogsBasedMetricServiceImpl.java", "diffHunk": "@@ -79,4 +121,41 @@ private LogEntry payloadToLogEntry(JsonPayload jsonPayload) {\n         .setResource(stackdriverStatsExporterService.getLoggingMonitoredResource())\n         .build();\n   }\n+\n+  /**\n+   * Allowed labels for the JsonPayload are here.\n+   *\n+   * <p>NAME: name of the metric, to show up in the Metric Explorer. Should be snake_case. Existing\n+   * EventMetric class's getName() method works.\n+   *\n+   * <p>VALUE: double value for the metric for this sample. Either 1.0 for count metrics, or some\n+   * number in the distribution for a distribution metric. For cumulative metrics, just use a value\n+   * to be summed, and choose the right aggregation on the Stackdriver side. That is, there's no\n+   * separate option for it.\n+   *\n+   * <p>LABELS: String-String map of label to value. Should only contain keys and discrete values\n+   * allowed by the EventMetric and MetricLabel classes, respectively. (Using a MeasurementBundle\n+   * ensures this).\n+   *\n+   * <p>UNIT: Official unit of measure. It looks like you still have to set this up manuaally when", "originalCommit": "ccbec34e063fc0896f6d515df8f75ad1991ac176", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNjMxNg==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378416316", "bodyText": "spelling: OpenCensus here and below", "author": "calbach", "createdAt": "2020-02-12T17:55:54Z", "path": "api/src/main/java/org/pmiops/workbench/monitoring/views/DistributionAggregation.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package org.pmiops.workbench.monitoring.views;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.stats.Aggregation;\n+import io.opencensus.stats.Aggregation.Distribution;\n+import io.opencensus.stats.BucketBoundaries;\n+\n+/**\n+ * Aggregation values to use with OpenCensus Distribution metrics. The bucket bounadries are inner\n+ * boundaries, so a list of [0.25, 0.50, 0.75] would actually make 5 buckets, with the lowest being\n+ * [0.0, 0.25), [0.25, 0.5), [0.5, 0.75), [0.75, MAX_DOUBLE].\n+ *\n+ * <p>Note: These buckets are provided for use with OpenCenss distribution metrics, which are not", "originalCommit": "ccbec34e063fc0896f6d515df8f75ad1991ac176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NzY3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378447676", "bodyText": "thanks. my keyboard is dying.", "author": "jaycarlton", "createdAt": "2020-02-12T18:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNjMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNjM4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378416385", "bodyText": "currently", "author": "calbach", "createdAt": "2020-02-12T17:56:02Z", "path": "api/src/main/java/org/pmiops/workbench/monitoring/views/DistributionAggregation.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package org.pmiops.workbench.monitoring.views;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.stats.Aggregation;\n+import io.opencensus.stats.Aggregation.Distribution;\n+import io.opencensus.stats.BucketBoundaries;\n+\n+/**\n+ * Aggregation values to use with OpenCensus Distribution metrics. The bucket bounadries are inner\n+ * boundaries, so a list of [0.25, 0.50, 0.75] would actually make 5 buckets, with the lowest being\n+ * [0.0, 0.25), [0.25, 0.5), [0.5, 0.75), [0.75, MAX_DOUBLE].\n+ *\n+ * <p>Note: These buckets are provided for use with OpenCenss distribution metrics, which are not\n+ * currenlty in service. Since every MetricBase needs an Aggregation anyway, and I wanted the", "originalCommit": "ccbec34e063fc0896f6d515df8f75ad1991ac176", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzQ4NA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378417484", "bodyText": "This doesn't exactly match the pattern you've added in the log service, but I think it would be less intrusive to handle method-level timing in an interceptor, e.g. https://github.com/all-of-us/workbench/blob/8541d09075b0bbc3e4ad786212a4fea8c84aee54/api/src/main/java/org/pmiops/workbench/interceptors/TracingInterceptor.java", "author": "calbach", "createdAt": "2020-02-12T17:58:08Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -246,6 +254,13 @@ private void maybeFileZendeskReviewRequest(Workspace workspace) {\n \n   @Override\n   public ResponseEntity<Workspace> createWorkspace(Workspace workspace) throws BadRequestException {\n+    return ResponseEntity.ok(\n+        recordOperationTime(() -> createWorkspaceImpl(workspace), \"createWorkspace\"));", "originalCommit": "ccbec34e063fc0896f6d515df8f75ad1991ac176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1MTA1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378451055", "bodyText": "I had hoped to be able to pull live latency distributions from the traces to use. with Alerting. @blrubenstein looked into whether we could alert on Traces. and said the systems were basically totally separate.\nI do see they have alerting, but it appears to be more limited to the number of Stackdriver Trace spans ingested per month, your quota usage, and your rate of span ingestion\nIt looks like they do expose a handful of metrics, but so far I'm only seeing builtin GCP services represented.\n\nFor my purposes here, I basically needed quantities to send to verify the service is working for distributions.", "author": "jaycarlton", "createdAt": "2020-02-12T19:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1NzY0MA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378457640", "bodyText": "Ignore StackDriver tracing for now, I'm asking whether you can implement recording a request's latency using an interceptor, similar to the approach used in the code I linked, instead of writing new code on every method.", "author": "calbach", "createdAt": "2020-02-12T19:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2NjA2OA==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378466068", "bodyText": "Drive-by comment here: for some reason I'd been thinking we wouldn't be able to use an interceptor for logging per-inbound-request latency, but it looks to me like it would totally work.\nThe fancy stuff I'd done in #2901 editing Swagger templates was important for instrumenting outbound API requests where RW acts as a client to Firecloud, but for inbound APIs an interceptor does seem to have most of the information we'd need.", "author": "gjuggler", "createdAt": "2020-02-12T19:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUyODQxMg==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r378528412", "bodyText": "Oh you're saying to hack a trace interceptor to record the request latency. Sure.\nThis isn't intended to be a pattern for every method.  Just a handful of things that are of major perf importance like workspaces and cohorts.\nI don't have a story for that yet.", "author": "jaycarlton", "createdAt": "2020-02-12T21:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1Nzc3Mg==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r379157772", "bodyText": "No. I regret linking the TraceInterceptor, I used it as an example because it's the most similar to what you'd need to do.\nInterceptors are a standard spring concept where you can install some pre and post-processing hook on a set of controller endpoitns. We have several such interceptors defined here: https://github.com/all-of-us/workbench/tree/2599364f3f32bacb1878854dae47ec8c61d08970/api/src/main/java/org/pmiops/workbench/interceptors\nWhy would we not want to record a general purpose latency metric split out by method name?", "author": "calbach", "createdAt": "2020-02-13T22:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1OTE0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3108#discussion_r379159141", "bodyText": "We do want to do that. Until very recently we thought we had to hack swagger-codegen to do it. I'm happy and eager to do that on a later ticket.\nThe priority with this branch is integrating and demonstrating distribution metrics, and elapsed time was an easy starting point.", "author": "jaycarlton", "createdAt": "2020-02-13T22:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzQ4NA=="}], "type": "inlineReview"}, {"oid": "8c61a455cdfc68380560b8cfb9cbbaea06e92504", "url": "https://github.com/all-of-us/workbench/commit/8c61a455cdfc68380560b8cfb9cbbaea06e92504", "message": "pr fixes", "committedDate": "2020-02-12T21:24:21Z", "type": "commit"}, {"oid": "edc30030f149600010e063b707184f51c37f3e23", "url": "https://github.com/all-of-us/workbench/commit/edc30030f149600010e063b707184f51c37f3e23", "message": "spt", "committedDate": "2020-02-12T21:24:43Z", "type": "commit"}, {"oid": "c2262a94c235dd7e61e871b0e209fcc773fe7bf0", "url": "https://github.com/all-of-us/workbench/commit/c2262a94c235dd7e61e871b0e209fcc773fe7bf0", "message": "add assertions at  both levels  in nested ttest", "committedDate": "2020-02-12T21:36:26Z", "type": "commit"}, {"oid": "4ba37882a3d9a382afc1a5ac48cf8c49a9599d0f", "url": "https://github.com/all-of-us/workbench/commit/4ba37882a3d9a382afc1a5ac48cf8c49a9599d0f", "message": "merge master", "committedDate": "2020-02-13T17:31:55Z", "type": "commit"}, {"oid": "7ca640f668ec2443f55de1d7c3d7ed095a867cea", "url": "https://github.com/all-of-us/workbench/commit/7ca640f668ec2443f55de1d7c3d7ed095a867cea", "message": "record gauge collection times", "committedDate": "2020-02-13T22:17:00Z", "type": "commit"}, {"oid": "a9c23b8fdd4d3b1ea05544735cbf6656c8f65a2b", "url": "https://github.com/all-of-us/workbench/commit/a9c23b8fdd4d3b1ea05544735cbf6656c8f65a2b", "message": "merge master", "committedDate": "2020-02-13T23:08:22Z", "type": "commit"}, {"oid": "70adc47133f6171c974ac16bf3ba2e725d76197e", "url": "https://github.com/all-of-us/workbench/commit/70adc47133f6171c974ac16bf3ba2e725d76197e", "message": "cleanup", "committedDate": "2020-02-14T02:47:50Z", "type": "commit"}, {"oid": "47bdf13e28b582c2e2dbf7848e4828183a0d805c", "url": "https://github.com/all-of-us/workbench/commit/47bdf13e28b582c2e2dbf7848e4828183a0d805c", "message": "simplifyu", "committedDate": "2020-02-14T02:54:33Z", "type": "commit"}, {"oid": "1f70c38b62d26f516a479536658008eda9134a46", "url": "https://github.com/all-of-us/workbench/commit/1f70c38b62d26f516a479536658008eda9134a46", "message": "remove extraneous tmp file", "committedDate": "2020-02-14T03:01:31Z", "type": "commit"}, {"oid": "00af4bfdd30bfd01550a0b72b5ad73e6d098d21a", "url": "https://github.com/all-of-us/workbench/commit/00af4bfdd30bfd01550a0b72b5ad73e6d098d21a", "message": "dep", "committedDate": "2020-02-14T03:16:20Z", "type": "commit"}, {"oid": "4daf118079db199673ac3363255076071519e53d", "url": "https://github.com/all-of-us/workbench/commit/4daf118079db199673ac3363255076071519e53d", "message": "spotless", "committedDate": "2020-02-14T15:38:31Z", "type": "commit"}]}