{"pr_number": 3103, "pr_title": "[RW-3790][RW-3587][Risk=low] Remove named params and move to bigrquery", "pr_createdAt": "2020-02-07T20:51:00Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3103", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxNzk5MA==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376617990", "bodyText": "Is this going to handle strings vs numbers properly? Wouldn't strings need to be quoted?", "author": "calbach", "createdAt": "2020-02-07T21:33:57Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -664,14 +664,58 @@ public static String capitalizeFirstCharacterOnly(String text) {\n     return StringUtils.capitalize(text.toLowerCase());\n   }\n \n+  private static String generateSqlWithEnvironmentVariables(\n+      String query, KernelTypeEnum kernelTypeEnum) {\n+    switch (kernelTypeEnum) {\n+      case PYTHON:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\"\\\"\\\" + os.environ[\\\"WORKSPACE_CDR\\\"] + \\\"\\\"\\\"\");\n+      case R:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\", Sys.getenv(\\\"WORKSPACE_CDR\\\"), \\\"\");\n+      default:\n+        return query;\n+    }\n+  }\n+\n+  private static String fillInQueryParams(\n+      String query, Map<String, QueryParameterValue> queryParameterValueMap) {\n+    StringBuilder stringBuilder = new StringBuilder(query);\n+    queryParameterValueMap.forEach(\n+        (key, value) -> {\n+          if (StandardSQLTypeName.ARRAY.equals(value.getType())) {\n+            String stringToReplace = \"unnest(@\".concat(key.concat(\")\"));\n+            int startingIndex = stringBuilder.indexOf(stringToReplace);\n+            stringBuilder.replace(\n+                startingIndex,\n+                startingIndex + stringToReplace.length(),\n+                \"(\"\n+                    .concat(\n+                        nullableListToEmpty(value.getArrayValues()).stream()\n+                            .map(QueryParameterValue::getValue)\n+                            .collect(Collectors.joining(\", \")))\n+                    .concat(\")\"));\n+          } else {\n+            String stringToReplace = \"@\".concat(key);", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEyMTE5MA==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377121190", "bodyText": "I think the key is always @key_name, so this should work?", "author": "s-rubenstein", "createdAt": "2020-02-10T15:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxNzk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIyMTc0Mw==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377221743", "bodyText": "Sorry, I should have highlighted the code block. I meant to refer to the value with this comment, not the key, i.e. line 704", "author": "calbach", "createdAt": "2020-02-10T17:55:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxNzk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0MTE4NA==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377241184", "bodyText": "I will take a look at that.", "author": "s-rubenstein", "createdAt": "2020-02-10T18:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxNzk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MTkwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377991905", "bodyText": "What was the outcome here?", "author": "calbach", "createdAt": "2020-02-12T01:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxNzk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxODUxMg==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376618512", "bodyText": "Did you look at str_glue as Nicole suggested? I think it would be more readable to declare variables then substitute them into the templated SQL as is done in the snippets. Note: it would require setting up an additional package", "author": "calbach", "createdAt": "2020-02-07T21:35:25Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -664,14 +664,58 @@ public static String capitalizeFirstCharacterOnly(String text) {\n     return StringUtils.capitalize(text.toLowerCase());\n   }\n \n+  private static String generateSqlWithEnvironmentVariables(\n+      String query, KernelTypeEnum kernelTypeEnum) {\n+    switch (kernelTypeEnum) {\n+      case PYTHON:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\"\\\"\\\" + os.environ[\\\"WORKSPACE_CDR\\\"] + \\\"\\\"\\\"\");", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NzI2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376787265", "bodyText": "+1 . I get scared seeing system calls in the middle of a complex string operation. We need to have the cleanest, earliest error code we can if one of those values is missing or malformed.\nAlso, I'll give you a dollar for every string or regex replacement we can kill in this class. \ud83d\ude09 I believe we can build almost everything up in one direction, and that's much easier to reason about and test. Later PR of course.", "author": "jaycarlton", "createdAt": "2020-02-09T14:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxODUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEyNDk0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377124949", "bodyText": "Where is the str_glue comment? I didn't see that in the email I got.\nI do hate the amount of string replacement we're doing, but we would need to go into the cohort builder sql builder to change it too much. (Unfortunately we're using the same SQL building code that they use.)", "author": "s-rubenstein", "createdAt": "2020-02-10T15:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxODUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIyMDM4OA==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377220388", "bodyText": "Sorry I'm not sure if she explicitly suggested this, I was more thinking you were basing the approach on the code she had already written for the snippets menu. Here's an example of str_glue: https://github.com/all-of-us/workbench-snippets/blob/f6e714328ba8c0d3ff11387944fccb0df5ba7ab5/sql-snippets/snippets_setup.R#L30 ; see more complicated variants by inserting from the snippets SQL menu. The relevant thing here is that it lets you interpolate variables into a string.", "author": "calbach", "createdAt": "2020-02-10T17:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxODUxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxODkxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376618919", "bodyText": "I don't love inlining these into the SQL itself. I think string substitution within the notebook code would be more reusable / understandable / readable. In R: str_glue, in Py f\"\"\nAlternatively, the parameterized queries in Python were perhaps an ideal way to show how to properly use BigQuery, but understood that diverging this much between R and Python could be a problem.", "author": "calbach", "createdAt": "2020-02-07T21:36:30Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -664,14 +664,58 @@ public static String capitalizeFirstCharacterOnly(String text) {\n     return StringUtils.capitalize(text.toLowerCase());\n   }\n \n+  private static String generateSqlWithEnvironmentVariables(\n+      String query, KernelTypeEnum kernelTypeEnum) {\n+    switch (kernelTypeEnum) {\n+      case PYTHON:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\"\\\"\\\" + os.environ[\\\"WORKSPACE_CDR\\\"] + \\\"\\\"\\\"\");\n+      case R:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\", Sys.getenv(\\\"WORKSPACE_CDR\\\"), \\\"\");\n+      default:\n+        return query;\n+    }\n+  }\n+\n+  private static String fillInQueryParams(\n+      String query, Map<String, QueryParameterValue> queryParameterValueMap) {\n+    StringBuilder stringBuilder = new StringBuilder(query);\n+    queryParameterValueMap.forEach(\n+        (key, value) -> {\n+          if (StandardSQLTypeName.ARRAY.equals(value.getType())) {", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEyNjgwMw==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377126803", "bodyText": "I am happy using str_glue or f\"\", but honestly, I'm unsure what benefit it gives over the config or query parameters (They're both variables that get substitutions in)\nI can revert back to that if we like. BigRQuery does just have it use a parameter option instead of a configuration option, so it does trim a lot of boilerplate and just make it basically a substitution.", "author": "s-rubenstein", "createdAt": "2020-02-10T15:19:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxODkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIyMDk4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377220985", "bodyText": "The benefit is that it can work with arrays in R, otherwise I'd prefer config/query parameters.", "author": "calbach", "createdAt": "2020-02-10T17:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxODkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxOTk0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376619949", "bodyText": "This deserves a comment, it seems like you're trying to replace the {project}.{dataset} templates within the query parameters at this step. But I'm not very clear on why", "author": "calbach", "createdAt": "2020-02-07T21:39:12Z", "path": "api/src/main/java/org/pmiops/workbench/api/DataSetController.java", "diffHunk": "@@ -324,7 +324,14 @@ private DataSetRequest generateDataSetRequestFromPreviewRequest(\n     DataSetPreviewResponse previewQueryResponse = new DataSetPreviewResponse();\n     DataSetRequest dataSetRequest = generateDataSetRequestFromPreviewRequest(dataSetPreviewRequest);\n     Map<String, QueryJobConfiguration> bigQueryJobConfig =\n-        dataSetService.generateQueryJobConfigurationsByDomainName(dataSetRequest);\n+        dataSetService.generateQueryJobConfigurationsByDomainName(dataSetRequest).entrySet()\n+            .stream()\n+            .collect(\n+                Collectors.toMap(\n+                    Map.Entry::getKey,\n+                    stringQueryJobConfigurationEntry ->\n+                        bigQueryService.filterBigQueryConfig(", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NTcxNQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376785715", "bodyText": "nit: just use e for entry in an inline lambda. The extra-descriptive name is great for a class method or function name, but for single-arg lambdas I tend to expect the other extreme.", "author": "jaycarlton", "createdAt": "2020-02-09T13:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxOTk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE1NjAxMg==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377156012", "bodyText": "I tried checking this and it appears to be nonsense, so I removed it", "author": "s-rubenstein", "createdAt": "2020-02-10T16:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxOTk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYyMTI4NA==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376621284", "bodyText": "There should probably be at least one test which incorporates parameters", "author": "calbach", "createdAt": "2020-02-07T21:42:37Z", "path": "api/src/test/java/org/pmiops/workbench/api/DataSetControllerTest.java", "diffHunk": "@@ -692,7 +692,7 @@ public void testGetPythonQuery() {\n     String prefix = \"dataset_00000000_condition_\";\n     assertThat(response.getCode())\n         .isEqualTo(\n-            \"import pandas\\n\\n\"\n+            \"import pandas\\nimport os\\n\\n\"", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NTc4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376785782", "bodyText": "nit: maybe name this like domainToBigQueryConfig.", "author": "jaycarlton", "createdAt": "2020-02-09T13:52:46Z", "path": "api/src/main/java/org/pmiops/workbench/api/DataSetController.java", "diffHunk": "@@ -324,7 +324,14 @@ private DataSetRequest generateDataSetRequestFromPreviewRequest(\n     DataSetPreviewResponse previewQueryResponse = new DataSetPreviewResponse();\n     DataSetRequest dataSetRequest = generateDataSetRequestFromPreviewRequest(dataSetPreviewRequest);\n     Map<String, QueryJobConfiguration> bigQueryJobConfig =\n-        dataSetService.generateQueryJobConfigurationsByDomainName(dataSetRequest);\n+        dataSetService.generateQueryJobConfigurationsByDomainName(dataSetRequest).entrySet()", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NTk0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376785946", "bodyText": "nit, naming: This was confusing to read. I don't see where \"project information\" comes in. I suspect there's a better name.", "author": "jaycarlton", "createdAt": "2020-02-09T13:55:05Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -496,11 +497,16 @@ private boolean supportsConceptSets(Domain domain) {\n \n   private QueryJobConfiguration buildQueryJobConfiguration(\n       Map<String, QueryParameterValue> namedCohortParameters, String query) {\n+    return QueryJobConfiguration.newBuilder(query)\n+        .setNamedParameters(namedCohortParameters)\n+        .setUseLegacySql(false)\n+        .build();\n+  }\n+\n+  private QueryJobConfiguration buildQueryJobConfigurationWithProjectInformation(", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjE3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376786179", "bodyText": "nit: I feel like just having the builder inline would be more readable than calling this helper, since you're really only assigning the legacy Sql. You could also have a function that returns a builder with the default arg set, like return QueryJobConfiguration.newBuilder().setUseLegacySql(false);. That's if it lets you make a builder without the query. \ud83e\udd37\u200d\u2642", "author": "jaycarlton", "createdAt": "2020-02-09T13:58:32Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -496,11 +497,16 @@ private boolean supportsConceptSets(Domain domain) {\n \n   private QueryJobConfiguration buildQueryJobConfiguration(\n       Map<String, QueryParameterValue> namedCohortParameters, String query) {\n+    return QueryJobConfiguration.newBuilder(query)", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE2MDYwNg==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377160606", "bodyText": "I can do the function that returns a builder with the arg set, that seems reasonable to me. Because its in two places, I would prefer having the default args change in both with one change.", "author": "s-rubenstein", "createdAt": "2020-02-10T16:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIzNTQ4Nw==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377235487", "bodyText": "Talked offline:\nI tried to address the comment here https://github.com/all-of-us/workbench/pull/3103/files#diff-5324f051d4e486d6f33e30b9f6bebd92R500 but it looks like all the builder methods that don't require a query up front are private methods. \ud83d\ude22\nI could have it build each time it is used, but that ends up with a bunch of repeated boilerplate for the defaults.\n11:20\n(I could maybe build with an empty string literal and then set the query later?) (edited)\n11:20\nDo you have a preference?\nJay Carlton  11:26 AM\nit's not a huge win to do what I think I was saying\n11:26\njust pointing out that builders smaller than ~5 lines are all right inline unless there's lots of repeated fields", "author": "s-rubenstein", "createdAt": "2020-02-10T18:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjIzNQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376786235", "bodyText": "nit: it would be more robust to have a list of things to import,  roll over it to make import statements, and then join that with a newline.", "author": "jaycarlton", "createdAt": "2020-02-09T13:59:27Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -533,16 +539,10 @@ private String getQualifiedColumnName(Domain currentDomain, String columnName) {\n     String prerequisites;\n     switch (kernelTypeEnum) {\n       case R:\n-        prerequisites =\n-            // RW-4241 workaround: update when the Jupyter image with the reticulate fix is fully\n-            // rolled out\n-            \"require(devtools)\\n\"\n-                + \"devtools::install_github(\\\"rstudio/reticulate\\\", ref=\\\"00172079\\\")\\n\"\n-                + \"library(reticulate)\\n\"\n-                + \"pd <- reticulate::import(\\\"pandas\\\")\";\n+        prerequisites = \"library(bigrquery)\";\n         break;\n       case PYTHON:\n-        prerequisites = \"import pandas\";\n+        prerequisites = \"import pandas\\n\" + \"import os\";", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjM0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376786346", "bodyText": "nit: I generally don't want to see three languages in one function.Can we wrap the bodies of these case clauses into their own functions?", "author": "jaycarlton", "createdAt": "2020-02-09T14:00:56Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -664,14 +664,58 @@ public static String capitalizeFirstCharacterOnly(String text) {\n     return StringUtils.capitalize(text.toLowerCase());\n   }\n \n+  private static String generateSqlWithEnvironmentVariables(\n+      String query, KernelTypeEnum kernelTypeEnum) {\n+    switch (kernelTypeEnum) {\n+      case PYTHON:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\"\\\"\\\" + os.environ[\\\"WORKSPACE_CDR\\\"] + \\\"\\\"\\\"\");\n+      case R:\n+        return query.replaceAll(", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE1NjM5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377156391", "bodyText": "Sure, will do.", "author": "s-rubenstein", "createdAt": "2020-02-10T16:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjQ4Ng==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376786486", "bodyText": "Too much is happening here to test effectively or to really understand. Please do put comments at the top of this function and split up the string operations.", "author": "jaycarlton", "createdAt": "2020-02-09T14:02:59Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -664,14 +664,58 @@ public static String capitalizeFirstCharacterOnly(String text) {\n     return StringUtils.capitalize(text.toLowerCase());\n   }\n \n+  private static String generateSqlWithEnvironmentVariables(\n+      String query, KernelTypeEnum kernelTypeEnum) {\n+    switch (kernelTypeEnum) {\n+      case PYTHON:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\"\\\"\\\" + os.environ[\\\"WORKSPACE_CDR\\\"] + \\\"\\\"\\\"\");\n+      case R:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\", Sys.getenv(\\\"WORKSPACE_CDR\\\"), \\\"\");\n+      default:\n+        return query;\n+    }\n+  }\n+\n+  private static String fillInQueryParams(\n+      String query, Map<String, QueryParameterValue> queryParameterValueMap) {\n+    StringBuilder stringBuilder = new StringBuilder(query);\n+    queryParameterValueMap.forEach(\n+        (key, value) -> {\n+          if (StandardSQLTypeName.ARRAY.equals(value.getType())) {\n+            String stringToReplace = \"unnest(@\".concat(key.concat(\")\"));\n+            int startingIndex = stringBuilder.indexOf(stringToReplace);", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE1NjUzMg==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377156532", "bodyText": "Will do.", "author": "s-rubenstein", "createdAt": "2020-02-10T16:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NjcyOA==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376786728", "bodyText": "I'd make a helper function like  formatArrayValueStringValuesOrWhatever(QueryParameterValue queryParameterValue) that gives you everything you're concatenating here.", "author": "jaycarlton", "createdAt": "2020-02-09T14:06:50Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -664,14 +664,58 @@ public static String capitalizeFirstCharacterOnly(String text) {\n     return StringUtils.capitalize(text.toLowerCase());\n   }\n \n+  private static String generateSqlWithEnvironmentVariables(\n+      String query, KernelTypeEnum kernelTypeEnum) {\n+    switch (kernelTypeEnum) {\n+      case PYTHON:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\"\\\"\\\" + os.environ[\\\"WORKSPACE_CDR\\\"] + \\\"\\\"\\\"\");\n+      case R:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\", Sys.getenv(\\\"WORKSPACE_CDR\\\"), \\\"\");\n+      default:\n+        return query;\n+    }\n+  }\n+\n+  private static String fillInQueryParams(\n+      String query, Map<String, QueryParameterValue> queryParameterValueMap) {\n+    StringBuilder stringBuilder = new StringBuilder(query);\n+    queryParameterValueMap.forEach(\n+        (key, value) -> {\n+          if (StandardSQLTypeName.ARRAY.equals(value.getType())) {\n+            String stringToReplace = \"unnest(@\".concat(key.concat(\")\"));\n+            int startingIndex = stringBuilder.indexOf(stringToReplace);\n+            stringBuilder.replace(\n+                startingIndex,\n+                startingIndex + stringToReplace.length(),\n+                \"(\"", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4Njg1Nw==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376786857", "bodyText": "nit: I think this reads better with Optional.ofNullable(...).ifPresent(v -> stringBuilder.replace(..., v)\nBut also, I'm not used to seeing replace used on a stringBuilder. It's generally expected that you build up the correct string from the beginning. Is there a way to do the swapping earlier?", "author": "jaycarlton", "createdAt": "2020-02-09T14:08:36Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -664,14 +664,58 @@ public static String capitalizeFirstCharacterOnly(String text) {\n     return StringUtils.capitalize(text.toLowerCase());\n   }\n \n+  private static String generateSqlWithEnvironmentVariables(\n+      String query, KernelTypeEnum kernelTypeEnum) {\n+    switch (kernelTypeEnum) {\n+      case PYTHON:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\"\\\"\\\" + os.environ[\\\"WORKSPACE_CDR\\\"] + \\\"\\\"\\\"\");\n+      case R:\n+        return query.replaceAll(\n+            \"\\\\$\\\\{projectId}.\\\\$\\\\{dataSetId}\", \"\\\", Sys.getenv(\\\"WORKSPACE_CDR\\\"), \\\"\");\n+      default:\n+        return query;\n+    }\n+  }\n+\n+  private static String fillInQueryParams(\n+      String query, Map<String, QueryParameterValue> queryParameterValueMap) {\n+    StringBuilder stringBuilder = new StringBuilder(query);\n+    queryParameterValueMap.forEach(\n+        (key, value) -> {\n+          if (StandardSQLTypeName.ARRAY.equals(value.getType())) {\n+            String stringToReplace = \"unnest(@\".concat(key.concat(\")\"));\n+            int startingIndex = stringBuilder.indexOf(stringToReplace);\n+            stringBuilder.replace(\n+                startingIndex,\n+                startingIndex + stringToReplace.length(),\n+                \"(\"\n+                    .concat(\n+                        nullableListToEmpty(value.getArrayValues()).stream()\n+                            .map(QueryParameterValue::getValue)\n+                            .collect(Collectors.joining(\", \")))\n+                    .concat(\")\"));\n+          } else {\n+            String stringToReplace = \"@\".concat(key);\n+            int startingIndex = stringBuilder.indexOf(stringToReplace);\n+            stringBuilder.replace(\n+                startingIndex,\n+                startingIndex + stringToReplace.length(),\n+                Optional.ofNullable(value.getValue()).orElse(\"\"));", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIzMDI0NA==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377230244", "bodyText": "Not without changing the Cohort Builder SQL building code, unfortunately. Will change to the Optional.ofNullable method though.", "author": "s-rubenstein", "createdAt": "2020-02-10T18:12:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4Njg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczNTIxNw==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377735217", "bodyText": "OK, I really want to get to tinkering on a new third party query builder.", "author": "jaycarlton", "createdAt": "2020-02-11T16:08:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4Njg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NzE0NA==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r376787144", "bodyText": "We need to have test cases for all the edge cases,  like when things that are expected to be there are missing. We should be failing the operation early instead of sending a broken query to the notebook if anything is amiss. (We don't have a great automatic way to find all the notebooks with queries for a given release yet from what I remember.)", "author": "jaycarlton", "createdAt": "2020-02-09T14:12:49Z", "path": "api/src/test/java/org/pmiops/workbench/api/DataSetControllerTest.java", "diffHunk": "@@ -771,23 +755,12 @@ public void testGetRQuery() {\n                 + \"AND (c_occurrence.PERSON_ID IN (SELECT * FROM person_id from `\"\n                 + TEST_CDR_TABLE\n                 + \".person` person)) \\n\"\n-                + \"LIMIT \\\", max_number_of_rows)\\n\"\n-                + \"\\n\"\n-                + prefix\n-                + \"query_config <- list(\\n\"\n-                + \"  query = list(\\n\"\n-                + \"    parameterMode = 'NAMED',\\n\"\n-                + \"    queryParameters = list(\\n\\n\"\n-                + \"    )\\n\"\n-                + \"  )\\n\"\n-                + \")\\n\"\n+                + \"LIMIT \\\", max_number_of_rows, sep=\\\"\\\")\\n\"", "originalCommit": "eb66e337eb437d0a659dd4b28fa2c028810615d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI1NzEzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377257131", "bodyText": "Do we need to upgrade our notebook docker image to include bigrquery?", "author": "jmthibault79", "createdAt": "2020-02-10T19:04:29Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -533,16 +544,10 @@ private String getQualifiedColumnName(Domain currentDomain, String columnName) {\n     String prerequisites;\n     switch (kernelTypeEnum) {\n       case R:\n-        prerequisites =\n-            // RW-4241 workaround: update when the Jupyter image with the reticulate fix is fully\n-            // rolled out\n-            \"require(devtools)\\n\"\n-                + \"devtools::install_github(\\\"rstudio/reticulate\\\", ref=\\\"00172079\\\")\\n\"\n-                + \"library(reticulate)\\n\"\n-                + \"pd <- reticulate::import(\\\"pandas\\\")\";\n+        prerequisites = \"library(bigrquery)\";", "originalCommit": "cf32337c0cc628728fafc4bf125ceaf5d9c453e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMwMTM0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377301346", "bodyText": "I think the ticket said we don't have to in this case... Don't quote me on that.", "author": "jaycarlton", "createdAt": "2020-02-10T20:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI1NzEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4OTQxNw==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377689417", "bodyText": "It functions without it, so we should be good. My guess is Leo includes it by default?", "author": "s-rubenstein", "createdAt": "2020-02-11T15:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI1NzEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyNjA4Nw==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377726087", "bodyText": "Great.  I'll add it to my sanity-checking notebook.", "author": "jmthibault79", "createdAt": "2020-02-11T15:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI1NzEzMQ=="}], "type": "inlineReview"}, {"oid": "ae40291e7820f49d7c3eb2b80a19e7163566a472", "url": "https://github.com/all-of-us/workbench/commit/ae40291e7820f49d7c3eb2b80a19e7163566a472", "message": "Remove named params and move to bigrquery", "committedDate": "2020-02-11T15:02:25Z", "type": "commit"}, {"oid": "3b986f983f5f00153b5dd61e8bfe40c63743b389", "url": "https://github.com/all-of-us/workbench/commit/3b986f983f5f00153b5dd61e8bfe40c63743b389", "message": "Fix tests", "committedDate": "2020-02-11T15:02:25Z", "type": "commit"}, {"oid": "23dfb07026a5f7ef77e21d6b57bcd639015154fb", "url": "https://github.com/all-of-us/workbench/commit/23dfb07026a5f7ef77e21d6b57bcd639015154fb", "message": "First round of PR feedback", "committedDate": "2020-02-11T15:02:25Z", "type": "commit"}, {"oid": "3c74b9cee25f9c971980e62ffae7430eb13702bb", "url": "https://github.com/all-of-us/workbench/commit/3c74b9cee25f9c971980e62ffae7430eb13702bb", "message": "PR feedback without str_glue or additional tests", "committedDate": "2020-02-11T15:02:25Z", "type": "commit"}, {"oid": "3c74b9cee25f9c971980e62ffae7430eb13702bb", "url": "https://github.com/all-of-us/workbench/commit/3c74b9cee25f9c971980e62ffae7430eb13702bb", "message": "PR feedback without str_glue or additional tests", "committedDate": "2020-02-11T15:02:25Z", "type": "forcePushed"}, {"oid": "4e799136682e8af21c4b4375242bd03a7d05db77", "url": "https://github.com/all-of-us/workbench/commit/4e799136682e8af21c4b4375242bd03a7d05db77", "message": "Add test for named parameters", "committedDate": "2020-02-11T17:35:49Z", "type": "commit"}, {"oid": "ed0d826df6ffd829addb22bb4b715b3730ff3f72", "url": "https://github.com/all-of-us/workbench/commit/ed0d826df6ffd829addb22bb4b715b3730ff3f72", "message": "Fix linting", "committedDate": "2020-02-11T18:23:39Z", "type": "commit"}, {"oid": "a9e0bb849c6410cc153dac7624ac9b4d9edea093", "url": "https://github.com/all-of-us/workbench/commit/a9e0bb849c6410cc153dac7624ac9b4d9edea093", "message": "PR feedback", "committedDate": "2020-02-11T20:09:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MDM3Mw==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r377990373", "bodyText": "If I'm reading this correctly, this turns into: WHERE ICD9 IN (2, 5). This doesn't seem right", "author": "calbach", "createdAt": "2020-02-12T01:07:32Z", "path": "api/src/test/java/org/pmiops/workbench/api/DataSetControllerTest.java", "diffHunk": "@@ -716,27 +728,16 @@ public void testGetPythonQuery() {\n                 + \"condition_source_concept_id IN (123)) \\n\"\n                 + \"AND (c_occurrence.PERSON_ID IN (SELECT * FROM person_id from `\"\n                 + TEST_CDR_TABLE\n-                + \".person` person)) \"\n+                + \".person` person WHERE \"\n+                + NAMED_PARAMETER_VALUE.getValue()", "originalCommit": "a9e0bb849c6410cc153dac7624ac9b4d9edea093", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMwNjgzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r378306839", "bodyText": "In this case, I just threw some random text in. In truth, it is more likely to be something like WHERE concept_id IN (132543, 2135643...)", "author": "s-rubenstein", "createdAt": "2020-02-12T15:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MDM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5NDc0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3103#discussion_r378394741", "bodyText": "Could you change it to be a more realistic value? I think future editors will find this confusing", "author": "calbach", "createdAt": "2020-02-12T17:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MDM3Mw=="}], "type": "inlineReview"}, {"oid": "0a3f79a2db6b631dc2b66eda2bbc82b2c09b3f74", "url": "https://github.com/all-of-us/workbench/commit/0a3f79a2db6b631dc2b66eda2bbc82b2c09b3f74", "message": "Fix linting and add integer64 typing", "committedDate": "2020-02-12T14:57:15Z", "type": "commit"}, {"oid": "aee7485d46161552bf7d0bab82e81135e05fa1a2", "url": "https://github.com/all-of-us/workbench/commit/aee7485d46161552bf7d0bab82e81135e05fa1a2", "message": "Fix tests", "committedDate": "2020-02-12T15:15:06Z", "type": "commit"}]}