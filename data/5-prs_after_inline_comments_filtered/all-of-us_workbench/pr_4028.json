{"pr_number": 4028, "pr_title": "[risk=medium][RW-5471][RW-5472] List workspace files on admin page", "pr_createdAt": "2020-09-18T20:26:42Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4028", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE3NjU4Mw==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r491176583", "bodyText": "alt: FileDetailMapper?", "author": "jmthibault79", "createdAt": "2020-09-18T20:32:09Z", "path": "api/src/main/java/org/pmiops/workbench/google/CloudStorageService.java", "diffHunk": "@@ -56,4 +57,14 @@ ServiceAccountCredentials getGarbageCollectionServiceAccountCredentials(\n   String getMoodleApiKey();\n \n   String getCaptchaServerKey();\n+\n+  default FileDetail blobToFileDetail(Blob blob, String bucketName) {", "originalCommit": "980cb23becdaf572402ff5ad672ac06ff1231bcb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b32e41ea10724f941cf3bd47865b0145f5fbe00e", "url": "https://github.com/all-of-us/workbench/commit/b32e41ea10724f941cf3bd47865b0145f5fbe00e", "message": "restyle workspaceInfoField and reword a few entries", "committedDate": "2020-09-22T12:26:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMTQxMg==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r492701412", "bodyText": "This line is the only addition.  The rest was moved as-is from NotebooksServiceImpl.", "author": "jmthibault79", "createdAt": "2020-09-22T12:42:46Z", "path": "api/src/main/java/org/pmiops/workbench/google/CloudStorageService.java", "diffHunk": "@@ -56,4 +57,14 @@ ServiceAccountCredentials getGarbageCollectionServiceAccountCredentials(\n   String getMoodleApiKey();\n \n   String getCaptchaServerKey();\n+\n+  default FileDetail blobToFileDetail(Blob blob, String bucketName) {\n+    String[] parts = blob.getName().split(\"/\");\n+    FileDetail fileDetail = new FileDetail();\n+    fileDetail.setName(parts[parts.length - 1]);\n+    fileDetail.setPath(\"gs://\" + bucketName + \"/\" + blob.getName());\n+    fileDetail.setLastModifiedTime(blob.getUpdateTime());\n+    fileDetail.setSize(blob.getSize());", "originalCommit": "b32e41ea10724f941cf3bd47865b0145f5fbe00e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMTcwNw==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r492701707", "bodyText": "alt name: listFiles?", "author": "jmthibault79", "createdAt": "2020-09-22T12:43:16Z", "path": "api/src/main/java/org/pmiops/workbench/api/WorkspaceAdminController.java", "diffHunk": "@@ -64,4 +66,10 @@ public WorkspaceAdminController(WorkspaceAdminService workspaceAdminService) {\n         workspaceAdminService.getReadOnlyNotebook(workspaceNamespace, notebookName, accessReason);\n     return ResponseEntity.ok(new ReadOnlyNotebookResponse().html(notebookHtml));\n   }\n+\n+  @Override\n+  @AuthorityRequired({Authority.RESEARCHER_DATA_VIEW})\n+  public ResponseEntity<List<FileDetail>> getFiles(String workspaceNamespace) {", "originalCommit": "b32e41ea10724f941cf3bd47865b0145f5fbe00e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1Nzg4OA==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r492957888", "bodyText": "I like listFiles", "author": "calbach", "createdAt": "2020-09-22T18:46:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMTcwNw=="}], "type": "inlineReview"}, {"oid": "b8acfd2170ffb82364a89d071b0c974cb390c826", "url": "https://github.com/all-of-us/workbench/commit/b8acfd2170ffb82364a89d071b0c974cb390c826", "message": "List workspace files on admin page", "committedDate": "2020-09-22T17:03:13Z", "type": "commit"}, {"oid": "45b81e62250281ccd4609005a3b201e4e1c483e3", "url": "https://github.com/all-of-us/workbench/commit/45b81e62250281ccd4609005a3b201e4e1c483e3", "message": "restyle workspaceInfoField and reword a few entries", "committedDate": "2020-09-22T17:03:14Z", "type": "commit"}, {"oid": "2f3ce99c606ca3fb8eb267fcd33ac59fb195d389", "url": "https://github.com/all-of-us/workbench/commit/2f3ce99c606ca3fb8eb267fcd33ac59fb195d389", "message": "Display file size in MB", "committedDate": "2020-09-22T17:03:14Z", "type": "commit"}, {"oid": "c1b2fb9f8a50f784cbe9ac1d9c1bcab183423382", "url": "https://github.com/all-of-us/workbench/commit/c1b2fb9f8a50f784cbe9ac1d9c1bcab183423382", "message": "test fix", "committedDate": "2020-09-22T17:03:14Z", "type": "commit"}, {"oid": "3f0089cba882b00a8f5b401a7d7284be71f0251c", "url": "https://github.com/all-of-us/workbench/commit/3f0089cba882b00a8f5b401a7d7284be71f0251c", "message": "test fix", "committedDate": "2020-09-22T17:03:15Z", "type": "commit"}, {"oid": "400dd699e8ceca70ee6b352b0a924a0a3c82c69a", "url": "https://github.com/all-of-us/workbench/commit/400dd699e8ceca70ee6b352b0a924a0a3c82c69a", "message": "getFiles() test", "committedDate": "2020-09-22T17:03:15Z", "type": "commit"}, {"oid": "400dd699e8ceca70ee6b352b0a924a0a3c82c69a", "url": "https://github.com/all-of-us/workbench/commit/400dd699e8ceca70ee6b352b0a924a0a3c82c69a", "message": "getFiles() test", "committedDate": "2020-09-22T17:03:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg5OTc0NQ==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r492899745", "bodyText": "unused here.  useful for the other test, so I moved it there.", "author": "jmthibault79", "createdAt": "2020-09-22T17:09:24Z", "path": "api/src/test/java/org/pmiops/workbench/api/WorkspacesControllerTest.java", "diffHunk": "@@ -471,15 +475,6 @@ private void mockBillingProjectBuffer(String projectName) {\n     doReturn(entry).when(billingProjectBufferService).assignBillingProject(any());\n   }\n \n-  private Blob mockBlob(String bucket, String path) {", "originalCommit": "400dd699e8ceca70ee6b352b0a924a0a3c82c69a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5570472a5f9c303d8fb24c931a2804375aef0931", "url": "https://github.com/all-of-us/workbench/commit/5570472a5f9c303d8fb24c931a2804375aef0931", "message": "rebase fix", "committedDate": "2020-09-22T17:10:40Z", "type": "commit"}, {"oid": "743b4d780c19a67c6b05871efdab6cba13494c9a", "url": "https://github.com/all-of-us/workbench/commit/743b4d780c19a67c6b05871efdab6cba13494c9a", "message": "Rename FileDetail.size to sizeInBytes", "committedDate": "2020-09-22T17:21:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzUwMg==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r492963502", "bodyText": "It's worth noting that the implementation for getBlobList is flawed - it only returns the first page of results. This is probably acceptable for your use case here, though it would be ideal to communicate whether there are more files or not back to the admin page. I think it will present more of a problem for us on the admin page - more so than on the user-facing page, since people may have a large number of object files living outside of the main notebooks/ directory.\nDo you mind adding a disclaimer to this method? Ideally the admin method would also communicate storage.get(bucketName).list().hasNextPage() back to the client.", "author": "calbach", "createdAt": "2020-09-22T18:55:17Z", "path": "api/src/main/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminServiceImpl.java", "diffHunk": "@@ -241,6 +242,21 @@ public String getReadOnlyNotebook(\n     return notebooksService.adminGetReadOnlyHtml(workspaceNamespace, workspaceName, notebookName);\n   }\n \n+  @Override\n+  public List<FileDetail> getFiles(String workspaceNamespace) {\n+    final String workspaceName =\n+        getWorkspaceByNamespaceOrThrow(workspaceNamespace).getFirecloudName();\n+    final String bucketName =\n+        fireCloudService\n+            .getWorkspaceAsService(workspaceNamespace, workspaceName)\n+            .getWorkspace()\n+            .getBucketName();\n+\n+    return cloudStorageService.getBlobList(bucketName).stream()", "originalCommit": "743b4d780c19a67c6b05871efdab6cba13494c9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyMDgwNg==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r493020806", "bodyText": "whoa - I was not aware, thanks.  Is there a getBlobList ticket?  We should probably address this more generally.  Maybe with new names as a first step - getFirst100Blobs maybe?", "author": "jmthibault79", "createdAt": "2020-09-22T20:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NTY3MA==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r493065670", "bodyText": "I don't think there's a ticket - I just noticed this when I looked at the implementation during review. I fixed one similar issue around cloning a while back, but forgot to check this.", "author": "calbach", "createdAt": "2020-09-22T22:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NTk3OQ==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r493065979", "bodyText": "And yea - updating the name make sense. I highly doubt the current behavior was intentional, devs often miss that these list APIs are (of course), paginated.", "author": "calbach", "createdAt": "2020-09-22T22:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA4MDAyOA==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r493080028", "bodyText": "Welp.  It's crappy but it's honest.", "author": "jmthibault79", "createdAt": "2020-09-22T23:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA4MDIyNQ==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r493080225", "bodyText": "Added a bunch of Javadoc and code comments as well.  I'll file a ticket to come back to this.", "author": "jmthibault79", "createdAt": "2020-09-22T23:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY3Njc0MQ==", "url": "https://github.com/all-of-us/workbench/pull/4028#discussion_r493676741", "bodyText": "https://precisionmedicineinitiative.atlassian.net/browse/RW-5633", "author": "jmthibault79", "createdAt": "2020-09-23T15:15:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzUwMg=="}], "type": "inlineReview"}, {"oid": "5b936ed8cef4a7abac836b5100522f87419f13df", "url": "https://github.com/all-of-us/workbench/commit/5b936ed8cef4a7abac836b5100522f87419f13df", "message": "renamed to parseLocation", "committedDate": "2020-09-22T19:36:00Z", "type": "commit"}, {"oid": "6e4a902d6bf84c2159a0328b05699bafe1f5c2f0", "url": "https://github.com/all-of-us/workbench/commit/6e4a902d6bf84c2159a0328b05699bafe1f5c2f0", "message": "getFiles -> listFiles", "committedDate": "2020-09-22T19:41:01Z", "type": "commit"}, {"oid": "3bb6621fc5942c99b80d655edd9154679c050e3e", "url": "https://github.com/all-of-us/workbench/commit/3bb6621fc5942c99b80d655edd9154679c050e3e", "message": "apply formatMB() to total storage", "committedDate": "2020-09-22T19:43:04Z", "type": "commit"}, {"oid": "38c31fc1245d2f48479c374f318ca46801d15013", "url": "https://github.com/all-of-us/workbench/commit/38c31fc1245d2f48479c374f318ca46801d15013", "message": "convert workspaceInfoField to a functional component", "committedDate": "2020-09-22T20:07:59Z", "type": "commit"}, {"oid": "2e508a1f0038e6e6d79cdf2ca02902072bc3825b", "url": "https://github.com/all-of-us/workbench/commit/2e508a1f0038e6e6d79cdf2ca02902072bc3825b", "message": "right-align file size", "committedDate": "2020-09-22T20:33:45Z", "type": "commit"}, {"oid": "93ffd446896b820913843855636a852f8a988631", "url": "https://github.com/all-of-us/workbench/commit/93ffd446896b820913843855636a852f8a988631", "message": "parseLocation() using substring()", "committedDate": "2020-09-22T20:58:02Z", "type": "commit"}, {"oid": "6c1aa9e878f5c745ec8c8ea8ce977b27c6fe2900", "url": "https://github.com/all-of-us/workbench/commit/6c1aa9e878f5c745ec8c8ea8ce977b27c6fe2900", "message": "Split getBlobList/ForPrefix into Iterable and Page versions", "committedDate": "2020-09-22T22:38:51Z", "type": "commit"}, {"oid": "7b0ca5683ee3e31ff962c6abf15a6f869b438797", "url": "https://github.com/all-of-us/workbench/commit/7b0ca5683ee3e31ff962c6abf15a6f869b438797", "message": "add blob page undercount notes", "committedDate": "2020-09-22T22:44:39Z", "type": "commit"}, {"oid": "18fd87a30d470d9a4e14e116e226b2195ce5dc4a", "url": "https://github.com/all-of-us/workbench/commit/18fd87a30d470d9a4e14e116e226b2195ce5dc4a", "message": "undercount note in UI", "committedDate": "2020-09-22T22:59:55Z", "type": "commit"}, {"oid": "2bc028889a68dca064120f8a130eb79cc31d6cbb", "url": "https://github.com/all-of-us/workbench/commit/2bc028889a68dca064120f8a130eb79cc31d6cbb", "message": "lint", "committedDate": "2020-09-22T23:43:09Z", "type": "commit"}, {"oid": "c0638b6683da71cca99291457e120b55252fd1ee", "url": "https://github.com/all-of-us/workbench/commit/c0638b6683da71cca99291457e120b55252fd1ee", "message": "rm getBlobs/getBlobsForPrefix", "committedDate": "2020-09-23T21:22:40Z", "type": "commit"}, {"oid": "9aedbefa2c7bedf65d9a5579b9893996a5805573", "url": "https://github.com/all-of-us/workbench/commit/9aedbefa2c7bedf65d9a5579b9893996a5805573", "message": "string props don't need squiggle brackets", "committedDate": "2020-09-23T21:33:14Z", "type": "commit"}, {"oid": "8d97f4e1ef35d623ff099738e760b99f5686383f", "url": "https://github.com/all-of-us/workbench/commit/8d97f4e1ef35d623ff099738e760b99f5686383f", "message": "1000 files text", "committedDate": "2020-09-23T21:34:41Z", "type": "commit"}, {"oid": "131edf85e0de2cbb0dde713db562cc8491867994", "url": "https://github.com/all-of-us/workbench/commit/131edf85e0de2cbb0dde713db562cc8491867994", "message": "add note about the table too", "committedDate": "2020-09-23T21:36:58Z", "type": "commit"}, {"oid": "7cb0cdff0ff46af089c9f501f40bfaea481be59b", "url": "https://github.com/all-of-us/workbench/commit/7cb0cdff0ff46af089c9f501f40bfaea481be59b", "message": "combine warnings", "committedDate": "2020-09-23T21:49:49Z", "type": "commit"}]}