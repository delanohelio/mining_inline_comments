{"pr_number": 3058, "pr_title": "[RW-4348][risk=low] Disable some notebook related actions for inactive billing workspaces", "pr_createdAt": "2020-01-29T20:49:15Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3058", "timeline": [{"oid": "3643153a854882c29e447fa2bd78df67b9bbb3ac", "url": "https://github.com/all-of-us/workbench/commit/3643153a854882c29e447fa2bd78df67b9bbb3ac", "message": "WIP - disabled create notebook and edit/playground mode. clone still needs tooltip trigger", "committedDate": "2020-01-28T23:11:03Z", "type": "commit"}, {"oid": "22a27fe24763ff18d89817909f5a221a07b7a851", "url": "https://github.com/all-of-us/workbench/commit/22a27fe24763ff18d89817909f5a221a07b7a851", "message": "disabled export to notebook from new dataset", "committedDate": "2020-01-29T00:08:37Z", "type": "commit"}, {"oid": "f338c3394b0299f3e517bcfffa7a0af6dc3823cf", "url": "https://github.com/all-of-us/workbench/commit/f338c3394b0299f3e517bcfffa7a0af6dc3823cf", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-4348", "committedDate": "2020-01-29T17:33:07Z", "type": "commit"}, {"oid": "27ad0a49453ccd88e4465182ba25950952e9ec62", "url": "https://github.com/all-of-us/workbench/commit/27ad0a49453ccd88e4465182ba25950952e9ec62", "message": "disable export to notebook", "committedDate": "2020-01-29T18:22:52Z", "type": "commit"}, {"oid": "fb34d9307c27c06f7385a3098913589a9e0f3bae", "url": "https://github.com/all-of-us/workbench/commit/fb34d9307c27c06f7385a3098913589a9e0f3bae", "message": "add hover text to actions", "committedDate": "2020-01-29T18:49:40Z", "type": "commit"}, {"oid": "7460f2d529789ace49628c5aa4e1e3e1d50fbafc", "url": "https://github.com/all-of-us/workbench/commit/7460f2d529789ace49628c5aa4e1e3e1d50fbafc", "message": "lint", "committedDate": "2020-01-29T18:53:06Z", "type": "commit"}, {"oid": "57dfd4aa5c968bba141f6431dac70be65fad3bc1", "url": "https://github.com/all-of-us/workbench/commit/57dfd4aa5c968bba141f6431dac70be65fad3bc1", "message": "fix test, sending incorrect check state", "committedDate": "2020-01-29T20:37:16Z", "type": "commit"}, {"oid": "5339adfac69ef57a09a150b6dd9199a3003e4ce4", "url": "https://github.com/all-of-us/workbench/commit/5339adfac69ef57a09a150b6dd9199a3003e4ce4", "message": "return BillingStatus.ACTIVE if billing lockout feature is not enableD", "committedDate": "2020-01-29T21:44:15Z", "type": "commit"}, {"oid": "1b90e2ade9aa56ddce2ad3353111e8cfaf35821b", "url": "https://github.com/all-of-us/workbench/commit/1b90e2ade9aa56ddce2ad3353111e8cfaf35821b", "message": "remove unused interface", "committedDate": "2020-01-29T21:44:25Z", "type": "commit"}, {"oid": "3fa40e641242a90c4f26b6d5cd13886f2fe1c044", "url": "https://github.com/all-of-us/workbench/commit/3fa40e641242a90c4f26b6d5cd13886f2fe1c044", "message": "fix test failures. probs some more", "committedDate": "2020-01-29T22:02:11Z", "type": "commit"}, {"oid": "d8f8f42d045a527beac9bd9dc0025cd7bfc7714d", "url": "https://github.com/all-of-us/workbench/commit/d8f8f42d045a527beac9bd9dc0025cd7bfc7714d", "message": "fix more tests", "committedDate": "2020-01-29T22:27:13Z", "type": "commit"}, {"oid": "ae1b2cf27eb3200e01254eabe4b7ed95f068e68f", "url": "https://github.com/all-of-us/workbench/commit/ae1b2cf27eb3200e01254eabe4b7ed95f068e68f", "message": "fix bq test:", "committedDate": "2020-01-29T22:38:08Z", "type": "commit"}, {"oid": "8db2a58d6b84e74d5528e94895e7e20a2fd9110d", "url": "https://github.com/all-of-us/workbench/commit/8db2a58d6b84e74d5528e94895e7e20a2fd9110d", "message": "relax type", "committedDate": "2020-01-29T22:47:02Z", "type": "commit"}, {"oid": "ca6c12534a514455b16688e52fad2ed30a2c6f97", "url": "https://github.com/all-of-us/workbench/commit/ca6c12534a514455b16688e52fad2ed30a2c6f97", "message": "spotless", "committedDate": "2020-01-29T23:05:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjA5Mw==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r372716093", "bodyText": "I'm not opposed to using immutables. This was in the interest of using the least strict type which in this case is Map. IMO, immutability is an implementation detail.", "author": "ericsong", "createdAt": "2020-01-30T01:13:36Z", "path": "api/src/main/java/org/pmiops/workbench/api/UserMetricsController.java", "diffHunk": "@@ -174,7 +181,7 @@ public void setDistinctWorkspaceLimit(int limit) {\n             .limit(distinctWorkspacelimit)\n             .collect(Collectors.toList());\n \n-    final ImmutableMap<Long, FirecloudWorkspaceResponse> idToLiveWorkspace =\n+    final Map<Long, DbWorkspace> idToDbWorkspace =", "originalCommit": "ca6c12534a514455b16688e52fad2ed30a2c6f97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjczMDkxMw==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r372730913", "bodyText": "In the case of the Immutable variants, the general preferred style is actually to use the more specific Immutable type where possible. The reason is that it has a semantically meaningful distinction in its interface - it's not just an implementation detail. Code using this variable might need to know it's immutable, i.e. that certain methods will just fail.\nHere's the guidance from the Guava library (see: \"interfaces\", not implementations):\nhttps://guava.dev/releases/19.0/api/docs/com/google/common/collect/ImmutableCollection.html\nNote that since this is just a local variable, this guidance is not super meaningful, and arguably Map<> is also acceptable (or maybe correct?) in this case since it doesn't need to be immutable (that's probably how I would have written it, TBH).", "author": "calbach", "createdAt": "2020-01-30T02:20:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjczMTU1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r372731555", "bodyText": "Sorry, I should reword \"where possible\" to \"where relevant\". In this particular instance, I could see an argument either way, but this is at least to point out that there are legitimate cases where you should be using the ImmutableMap type over Map.", "author": "calbach", "createdAt": "2020-01-30T02:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxNzQ2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r373017465", "bodyText": "Got it, that makes sense. I've definitely run into cases where I had collection methods fail on me.", "author": "ericsong", "createdAt": "2020-01-30T15:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjA5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjQ3MA==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r372716470", "bodyText": "I decided to return this value as part of the RecentResource API model because the response object is used to construct UI resource cards which needs this info. The alternative was to make a getWorkspaces() call for each workspace in the response list and that seemed too heavy handed.", "author": "ericsong", "createdAt": "2020-01-30T01:15:08Z", "path": "api/src/main/java/org/pmiops/workbench/api/UserMetricsController.java", "diffHunk": "@@ -247,12 +260,21 @@ public boolean hasValidBlobIdIfNotebookNamePresent(DbUserRecentResource dbUserRe\n   }\n \n   private RecentResource buildRecentResource(\n-      ImmutableMap<Long, FirecloudWorkspaceResponse> idToFcWorkspaceResponse,\n+      Map<Long, DbWorkspace> idToDbWorkspace,\n+      Map<Long, FirecloudWorkspaceResponse> idToFcWorkspaceResponse,\n       DbUserRecentResource dbUserRecentResource) {\n     RecentResource resource = TO_CLIENT.apply(dbUserRecentResource);\n     FirecloudWorkspaceResponse workspaceDetails =\n         idToFcWorkspaceResponse.get(dbUserRecentResource.getWorkspaceId());\n-    resource.setPermission(workspaceDetails.getAccessLevel());\n+    if (workbenchConfigProvider.get().featureFlags.enableBillingLockout) {\n+      resource.setWorkspaceBillingStatus(\n+          idToDbWorkspace.get(dbUserRecentResource.getWorkspaceId()).getBillingStatus());", "originalCommit": "ca6c12534a514455b16688e52fad2ed30a2c6f97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4MzIwMg==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r373183202", "bodyText": "Another alternative would be to change RecentResource to include the entire workspace, but then I think you're still calling out to firecloud on each request... just not returning as much.", "author": "als364", "createdAt": "2020-01-30T20:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIzMzMwNA==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r373233304", "bodyText": "yeah... adding the entire workspace feels cleaner but it would defeat the purpose of this change which is to improve performance", "author": "ericsong", "createdAt": "2020-01-30T22:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjgyNg==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r372716826", "bodyText": "I made this injectable so I can pull in the WorkbenchConfig provider.\nGood example of why static utility classes can be hard to refactor.\nI am guilty of writing this one heh.\nAlso, the name is intentionally a bit crude to draw attention to the need to migrate this class to the Mapstruct supported WorkspaceMapper.", "author": "ericsong", "createdAt": "2020-01-30T01:16:34Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/ManualWorkspaceMapper.java", "diffHunk": "@@ -6,22 +6,34 @@\n import java.util.List;\n import java.util.Map;\n import java.util.stream.Collectors;\n+import javax.inject.Provider;\n import org.pmiops.workbench.api.Etags;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n import org.pmiops.workbench.db.model.DbStorageEnums;\n import org.pmiops.workbench.db.model.DbUser;\n import org.pmiops.workbench.db.model.DbUserRecentWorkspace;\n import org.pmiops.workbench.db.model.DbWorkspace;\n import org.pmiops.workbench.db.model.DbWorkspace.FirecloudWorkspaceId;\n import org.pmiops.workbench.firecloud.model.FirecloudWorkspace;\n import org.pmiops.workbench.firecloud.model.FirecloudWorkspaceAccessEntry;\n+import org.pmiops.workbench.model.BillingStatus;\n import org.pmiops.workbench.model.RecentWorkspace;\n import org.pmiops.workbench.model.ResearchPurpose;\n import org.pmiops.workbench.model.SpecificPopulationEnum;\n import org.pmiops.workbench.model.UserRole;\n import org.pmiops.workbench.model.Workspace;\n import org.pmiops.workbench.model.WorkspaceAccessLevel;\n+import org.springframework.stereotype.Service;\n \n-public class WorkspaceConversionUtils {\n+// We should migrate over to the Mapstruct supported WorkspaceMapper\n+@Service\n+public class ManualWorkspaceMapper {", "originalCommit": "ca6c12534a514455b16688e52fad2ed30a2c6f97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1MjM3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r373152379", "bodyText": "Is there a ticket to migrate this to Mapstruct, and if there isn't, can you please make one?", "author": "als364", "createdAt": "2020-01-30T19:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIzMjAzNA==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r373232034", "bodyText": "Done - https://precisionmedicineinitiative.atlassian.net/browse/RW-4367", "author": "ericsong", "createdAt": "2020-01-30T22:38:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNjgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNzU0NA==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r372717544", "bodyText": "AFAICS, we're using the @Autowired constructor so I removed this comment.", "author": "ericsong", "createdAt": "2020-01-30T01:19:41Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -75,16 +75,15 @@\n   protected static final int RECENT_WORKSPACE_COUNT = 4;\n   private static final Logger log = Logger.getLogger(WorkspaceService.class.getName());\n \n-  // Note: Cannot use an @Autowired constructor with this version of Spring", "originalCommit": "ca6c12534a514455b16688e52fad2ed30a2c6f97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NjA2MA==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r373066060", "bodyText": "I know the LiveWorkspace name predates this change but I still find it a bit confusing. Can you change it to idToFirecloudWorkspace or something along those lines?", "author": "als364", "createdAt": "2020-01-30T16:47:45Z", "path": "api/src/main/java/org/pmiops/workbench/api/UserMetricsController.java", "diffHunk": "@@ -185,6 +192,12 @@ public void setDistinctWorkspaceLimit(int limit) {\n                                 new AbstractMap.SimpleImmutableEntry<>(\n                                     dbWorkspace.getWorkspaceId(), dbWorkspace)))\n             .flatMap(Streams::stream)\n+            .collect(\n+                ImmutableMap.toImmutableMap(\n+                    SimpleImmutableEntry::getKey, SimpleImmutableEntry::getValue));\n+\n+    final Map<Long, FirecloudWorkspaceResponse> idToLiveWorkspace =", "originalCommit": "ca6c12534a514455b16688e52fad2ed30a2c6f97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIzMjU2NA==", "url": "https://github.com/all-of-us/workbench/pull/3058#discussion_r373232564", "bodyText": "Agreed, I felt the same. I'll change it", "author": "ericsong", "createdAt": "2020-01-30T22:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NjA2MA=="}], "type": "inlineReview"}, {"oid": "43b39c1df29aa858479e3e78019a807babbb757e", "url": "https://github.com/all-of-us/workbench/commit/43b39c1df29aa858479e3e78019a807babbb757e", "message": "merge master", "committedDate": "2020-01-30T22:58:00Z", "type": "commit"}, {"oid": "be06d52810c9c34e122469eb0fa85dd7feeaf198", "url": "https://github.com/all-of-us/workbench/commit/be06d52810c9c34e122469eb0fa85dd7feeaf198", "message": "spotless", "committedDate": "2020-01-30T22:58:24Z", "type": "commit"}]}