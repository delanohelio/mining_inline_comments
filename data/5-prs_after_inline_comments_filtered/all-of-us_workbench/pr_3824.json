{"pr_number": 3824, "pr_title": "[RW-3389][risk=no] Avoid increasing query count for each user when fetching Profiles", "pr_createdAt": "2020-07-23T15:03:15Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3824", "timeline": [{"oid": "07b64351d2fb9ebfd54455d1f8a214f7451bdcc7", "url": "https://github.com/all-of-us/workbench/commit/07b64351d2fb9ebfd54455d1f8a214f7451bdcc7", "message": "initial work", "committedDate": "2020-07-22T18:19:29Z", "type": "commit"}, {"oid": "4d769581a92a890d5abf48ea5145a7b53714f087", "url": "https://github.com/all-of-us/workbench/commit/4d769581a92a890d5abf48ea5145a7b53714f087", "message": "progress maybe", "committedDate": "2020-07-23T03:18:00Z", "type": "commit"}, {"oid": "c8d221df92b5edf6d51491d8e501571efa4bbcc0", "url": "https://github.com/all-of-us/workbench/commit/c8d221df92b5edf6d51491d8e501571efa4bbcc0", "message": "progress I think. simplified the mapper", "committedDate": "2020-07-23T03:33:42Z", "type": "commit"}, {"oid": "51424b21b22e3d4e22c06c4061b1628cbad4266f", "url": "https://github.com/all-of-us/workbench/commit/51424b21b22e3d4e22c06c4061b1628cbad4266f", "message": "only one query per table", "committedDate": "2020-07-23T14:24:24Z", "type": "commit"}, {"oid": "6aa6c748437da286e2a6ff82f29aa110b12ec9ff", "url": "https://github.com/all-of-us/workbench/commit/6aa6c748437da286e2a6ff82f29aa110b12ec9ff", "message": "progress", "committedDate": "2020-07-23T14:59:38Z", "type": "commit"}, {"oid": "000d686bbd7b2c529caccc1f05cb46ba4c49f685", "url": "https://github.com/all-of-us/workbench/commit/000d686bbd7b2c529caccc1f05cb46ba4c49f685", "message": "remove unneeded changes", "committedDate": "2020-07-23T15:06:57Z", "type": "commit"}, {"oid": "e102e3808780fce769aa3375e80749a24eecda7d", "url": "https://github.com/all-of-us/workbench/commit/e102e3808780fce769aa3375e80749a24eecda7d", "message": "fixup tests", "committedDate": "2020-07-23T17:07:40Z", "type": "commit"}, {"oid": "0cec3fa436dc55f1af0a939567f88f2b5a911b04", "url": "https://github.com/all-of-us/workbench/commit/0cec3fa436dc55f1af0a939567f88f2b5a911b04", "message": "use set instead of list", "committedDate": "2020-07-24T13:21:13Z", "type": "commit"}, {"oid": "f30d82248aae6b81a4d0e11c9d11e385303df1d2", "url": "https://github.com/all-of-us/workbench/commit/f30d82248aae6b81a4d0e11c9d11e385303df1d2", "message": "Merge branch 'master' into jaycarlton/RW-3389", "committedDate": "2020-07-24T13:21:33Z", "type": "commit"}, {"oid": "f3822f21d42c30540faf54967b5c7eee1224528b", "url": "https://github.com/all-of-us/workbench/commit/f3822f21d42c30540faf54967b5c7eee1224528b", "message": "restore properties file", "committedDate": "2020-07-24T13:22:06Z", "type": "commit"}, {"oid": "450a49c76f8d62abbb81f7f6e034192be23bd11d", "url": "https://github.com/all-of-us/workbench/commit/450a49c76f8d62abbb81f7f6e034192be23bd11d", "message": "deprecate things", "committedDate": "2020-07-27T14:06:13Z", "type": "commit"}, {"oid": "a15783382117d79aa16946a5a862257a02166435", "url": "https://github.com/all-of-us/workbench/commit/a15783382117d79aa16946a5a862257a02166435", "message": "merge  & resolve conflicts", "committedDate": "2020-07-31T18:14:54Z", "type": "commit"}, {"oid": "67e18289a1bd6ac1c0c5a8ec78ee025feb6a5334", "url": "https://github.com/all-of-us/workbench/commit/67e18289a1bd6ac1c0c5a8ec78ee025feb6a5334", "message": "fix tests", "committedDate": "2020-07-31T19:10:25Z", "type": "commit"}, {"oid": "30b0f7cc0a720622a950cb496565fa895fc7d1ef", "url": "https://github.com/all-of-us/workbench/commit/30b0f7cc0a720622a950cb496565fa895fc7d1ef", "message": "remove redundant  mapping", "committedDate": "2020-07-31T19:13:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMjk0NA==", "url": "https://github.com/all-of-us/workbench/pull/3824#discussion_r465202944", "bodyText": "nit: I'm not sure the heavy suffix helps clarify anything here. Is this important to a reader, and/or does it map to any well-defined concept or pattern in the codebase?", "author": "gjuggler", "createdAt": "2020-08-04T17:11:26Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -501,10 +506,44 @@ public void validateNewProfile(Profile profile) throws BadRequestException {\n     validateProfileForCorrectness(dummyProfile, profile);\n   }\n \n+  // Get all the profiles. Best we can do without surgery on the entity classes is to do one query\n+  // per table and join them in code.\n   public List<Profile> listAllProfiles() {\n-    return userService.getAllUsers().stream().map(this::getProfile).collect(Collectors.toList());\n+    final Set<DbUser> usersHeavy = userService.findAllUsersWithAuthoritiesAndPageVisits();", "originalCommit": "30b0f7cc0a720622a950cb496565fa895fc7d1ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI4ODkxMQ==", "url": "https://github.com/all-of-us/workbench/pull/3824#discussion_r465288911", "bodyText": "We don't have an established convention, but I thought it important to indicate that this set of users had more fields populated than the default DbUser. The convention at HubSpot would be hydratedUsers.", "author": "jaycarlton", "createdAt": "2020-08-04T19:44:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMjk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkyMzI3Mw==", "url": "https://github.com/all-of-us/workbench/pull/3824#discussion_r467923273", "bodyText": "Why change this?  The linter-required formatting makes this version harder to follow", "author": "jmthibault79", "createdAt": "2020-08-10T13:59:16Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -393,15 +397,16 @@ private boolean fieldChanged(Diff diff, String field) {\n    * @return true if the Profile is new\n    */\n   private boolean isNewProfile(Diff diff) {\n-    final Predicate<Change> newProfilePred =\n-        change ->\n-            change instanceof NewObject\n-                && change\n-                    .getAffectedGlobalId()\n-                    .getTypeName()\n-                    .equals(Profile.class.getCanonicalName());\n \n-    return diff.getChanges(newProfilePred).size() > 0;\n+    return diff.getChanges(", "originalCommit": "30b0f7cc0a720622a950cb496565fa895fc7d1ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYwNDgyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3824#discussion_r468604825", "bodyText": "I thought lambdas were preferred in this kind of usage and thought you might not have realized you can use a lambda instead of declaring a predicate. Arguably we could improve it by  declaring the list of changes and then taking its size. I believe  IntelliJ suggested this change as well.", "author": "jaycarlton", "createdAt": "2020-08-11T14:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkyMzI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4MjIyMw==", "url": "https://github.com/all-of-us/workbench/pull/3824#discussion_r468682223", "bodyText": "Makes sense.  Lambda + separated size check sounds like the best option here.  Thanks.\nIt's certainly not a priority to make that change.", "author": "jmthibault79", "createdAt": "2020-08-11T15:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkyMzI3Mw=="}], "type": "inlineReview"}]}